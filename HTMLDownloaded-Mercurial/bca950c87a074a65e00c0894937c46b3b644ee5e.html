<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26421:bca950c87a074a65e00c0894937c46b3b644ee5e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ bca950c87a074a65e00c0894937c46b3b644ee5e" />
<meta property="og:url" content="/comm-central/rev/bca950c87a074a65e00c0894937c46b3b644ee5e" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/mime. rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / bca950c87a074a65e00c0894937c46b3b644ee5e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/bca950c87a074a65e00c0894937c46b3b644ee5e">shortlog</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/bca950c87a074a65e00c0894937c46b3b644ee5e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e">files</a> |
changeset |
<a href="/comm-central/raw-rev/bca950c87a074a65e00c0894937c46b3b644ee5e">raw</a>  | <a href="/comm-central/archive/bca950c87a074a65e00c0894937c46b3b644ee5e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/mime. rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 24 Apr 2019 10:01:40 +0200</td></tr>

<tr>
 <td>changeset 26421</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/bca950c87a074a65e00c0894937c46b3b644ee5e">bca950c87a074a65e00c0894937c46b3b644ee5e</a></td>
</tr>



<tr>
<td>parent 26420</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4d5ec0d7a32c6002e26b1b807bfa2796a292c9b1">4d5ec0d7a32c6002e26b1b807bfa2796a292c9b1</a>
</td>
</tr>

<tr>
<td>child 26422</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9d2f71d5e74d14a10a5432b7a17fe6949964ca90">9d2f71d5e74d14a10a5432b7a17fe6949964ca90</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=bca950c87a074a65e00c0894937c46b3b644ee5e">15829</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 24 Apr 2019 08:37:09 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4965f8d61f03 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4965f8d61f03bad242a90df92454e5fd52763f4f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4965f8d61f03bad242a90df92454e5fd52763f4f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4965f8d61f03bad242a90df92454e5fd52763f4f&newProject=comm-central&newRevision=a7efaecb39ccf179d84a3375da8609698435ef58&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4965f8d61f03bad242a90df92454e5fd52763f4f&newProject=comm-central&newRevision=a7efaecb39ccf179d84a3375da8609698435ef58&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4965f8d61f03bad242a90df92454e5fd52763f4f&newProject=comm-central&newRevision=a7efaecb39ccf179d84a3375da8609698435ef58&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/mime. rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/mimexpcom.cpp">mailnews/mime/cthandlers/glue/mimexpcom.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/mimexpcom.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/mimexpcom.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/mimexpcom.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/mimexpcom.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/mimexpcom.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/mimexpcom.h">mailnews/mime/cthandlers/glue/mimexpcom.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/mimexpcom.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/mimexpcom.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/mimexpcom.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/mimexpcom.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/mimexpcom.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.cpp">mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.h">mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.cpp">mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.h">mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/vcard/mimevcrd.cpp">mailnews/mime/cthandlers/vcard/mimevcrd.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/vcard/mimevcrd.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/vcard/mimevcrd.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/vcard/mimevcrd.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/vcard/mimevcrd.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/vcard/mimevcrd.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/vcard/mimevcrd.h">mailnews/mime/cthandlers/vcard/mimevcrd.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/vcard/mimevcrd.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/vcard/mimevcrd.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/vcard/mimevcrd.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/vcard/mimevcrd.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/cthandlers/vcard/mimevcrd.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsEmitterUtils.cpp">mailnews/mime/emitters/nsEmitterUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsEmitterUtils.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsEmitterUtils.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsEmitterUtils.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsEmitterUtils.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsEmitterUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsEmitterUtils.h">mailnews/mime/emitters/nsEmitterUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsEmitterUtils.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsEmitterUtils.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsEmitterUtils.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsEmitterUtils.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsEmitterUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">mailnews/mime/emitters/nsMimeBaseEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeBaseEmitter.h">mailnews/mime/emitters/nsMimeBaseEmitter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeBaseEmitter.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeBaseEmitter.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeBaseEmitter.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeBaseEmitter.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeBaseEmitter.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeEmitterCID.h">mailnews/mime/emitters/nsMimeEmitterCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeEmitterCID.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeEmitterCID.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeEmitterCID.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeEmitterCID.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeEmitterCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeHtmlEmitter.cpp">mailnews/mime/emitters/nsMimeHtmlEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeHtmlEmitter.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeHtmlEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeHtmlEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeHtmlEmitter.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeHtmlEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeHtmlEmitter.h">mailnews/mime/emitters/nsMimeHtmlEmitter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeHtmlEmitter.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeHtmlEmitter.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeHtmlEmitter.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeHtmlEmitter.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeHtmlEmitter.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimePlainEmitter.cpp">mailnews/mime/emitters/nsMimePlainEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimePlainEmitter.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimePlainEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimePlainEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimePlainEmitter.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimePlainEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimePlainEmitter.h">mailnews/mime/emitters/nsMimePlainEmitter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimePlainEmitter.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimePlainEmitter.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimePlainEmitter.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimePlainEmitter.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimePlainEmitter.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRawEmitter.cpp">mailnews/mime/emitters/nsMimeRawEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRawEmitter.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRawEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRawEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRawEmitter.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRawEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRawEmitter.h">mailnews/mime/emitters/nsMimeRawEmitter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRawEmitter.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRawEmitter.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRawEmitter.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRawEmitter.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRawEmitter.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRebuffer.cpp">mailnews/mime/emitters/nsMimeRebuffer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRebuffer.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRebuffer.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRebuffer.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRebuffer.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRebuffer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRebuffer.h">mailnews/mime/emitters/nsMimeRebuffer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRebuffer.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRebuffer.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRebuffer.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRebuffer.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeRebuffer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeXmlEmitter.cpp">mailnews/mime/emitters/nsMimeXmlEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeXmlEmitter.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeXmlEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeXmlEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeXmlEmitter.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeXmlEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeXmlEmitter.h">mailnews/mime/emitters/nsMimeXmlEmitter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeXmlEmitter.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeXmlEmitter.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeXmlEmitter.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeXmlEmitter.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/emitters/nsMimeXmlEmitter.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/MimeEncoder.h">mailnews/mime/public/MimeEncoder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/MimeEncoder.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/MimeEncoder.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/MimeEncoder.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/MimeEncoder.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/MimeEncoder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/MimeHeaderParser.h">mailnews/mime/public/MimeHeaderParser.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/MimeHeaderParser.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/MimeHeaderParser.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/MimeHeaderParser.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/MimeHeaderParser.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/MimeHeaderParser.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsIMimeContentTypeHandler.h">mailnews/mime/public/nsIMimeContentTypeHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsIMimeContentTypeHandler.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsIMimeContentTypeHandler.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsIMimeContentTypeHandler.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsIMimeContentTypeHandler.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsIMimeContentTypeHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsIMimeObjectClassAccess.h">mailnews/mime/public/nsIMimeObjectClassAccess.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsIMimeObjectClassAccess.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsIMimeObjectClassAccess.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsIMimeObjectClassAccess.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsIMimeObjectClassAccess.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsIMimeObjectClassAccess.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsMailHeaders.h">mailnews/mime/public/nsMailHeaders.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsMailHeaders.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsMailHeaders.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsMailHeaders.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsMailHeaders.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsMailHeaders.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsMsgMimeCID.h">mailnews/mime/public/nsMsgMimeCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsMsgMimeCID.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsMsgMimeCID.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsMsgMimeCID.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsMsgMimeCID.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/public/nsMsgMimeCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/MimeHeaderParser.cpp">mailnews/mime/src/MimeHeaderParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/MimeHeaderParser.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/MimeHeaderParser.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/MimeHeaderParser.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/MimeHeaderParser.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/MimeHeaderParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/comi18n.cpp">mailnews/mime/src/comi18n.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/comi18n.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/comi18n.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/comi18n.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/comi18n.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/comi18n.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/comi18n.h">mailnews/mime/src/comi18n.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/comi18n.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/comi18n.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/comi18n.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/comi18n.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/comi18n.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeTextHTMLParsed.cpp">mailnews/mime/src/mimeTextHTMLParsed.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeTextHTMLParsed.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeTextHTMLParsed.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeTextHTMLParsed.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeTextHTMLParsed.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeTextHTMLParsed.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeTextHTMLParsed.h">mailnews/mime/src/mimeTextHTMLParsed.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeTextHTMLParsed.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeTextHTMLParsed.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeTextHTMLParsed.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeTextHTMLParsed.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeTextHTMLParsed.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimebuf.cpp">mailnews/mime/src/mimebuf.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimebuf.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimebuf.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimebuf.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimebuf.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimebuf.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimebuf.h">mailnews/mime/src/mimebuf.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimebuf.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimebuf.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimebuf.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimebuf.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimebuf.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecms.cpp">mailnews/mime/src/mimecms.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecms.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecms.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecms.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecms.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecms.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecms.h">mailnews/mime/src/mimecms.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecms.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecms.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecms.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecms.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecms.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecom.cpp">mailnews/mime/src/mimecom.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecom.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecom.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecom.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecom.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecom.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecom.h">mailnews/mime/src/mimecom.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecom.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecom.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecom.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecom.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecom.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecont.cpp">mailnews/mime/src/mimecont.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecont.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecont.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecont.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecont.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecont.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecont.h">mailnews/mime/src/mimecont.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecont.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecont.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecont.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecont.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecont.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecryp.cpp">mailnews/mime/src/mimecryp.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecryp.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecryp.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecryp.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecryp.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecryp.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecryp.h">mailnews/mime/src/mimecryp.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecryp.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecryp.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecryp.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecryp.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecryp.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecth.cpp">mailnews/mime/src/mimecth.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecth.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecth.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecth.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecth.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecth.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecth.h">mailnews/mime/src/mimecth.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecth.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecth.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecth.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecth.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimecth.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimedrft.cpp">mailnews/mime/src/mimedrft.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimedrft.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimedrft.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimedrft.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimedrft.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimedrft.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeebod.cpp">mailnews/mime/src/mimeebod.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeebod.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeebod.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeebod.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeebod.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeebod.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeebod.h">mailnews/mime/src/mimeebod.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeebod.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeebod.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeebod.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeebod.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeebod.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeenc.cpp">mailnews/mime/src/mimeenc.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeenc.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeenc.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeenc.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeenc.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeenc.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeeobj.cpp">mailnews/mime/src/mimeeobj.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeeobj.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeeobj.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeeobj.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeeobj.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeeobj.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeeobj.h">mailnews/mime/src/mimeeobj.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeeobj.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeeobj.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeeobj.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeeobj.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeeobj.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimefilt.cpp">mailnews/mime/src/mimefilt.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimefilt.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimefilt.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimefilt.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimefilt.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimefilt.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimehdrs.cpp">mailnews/mime/src/mimehdrs.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimehdrs.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimehdrs.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimehdrs.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimehdrs.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimehdrs.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimehdrs.h">mailnews/mime/src/mimehdrs.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimehdrs.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimehdrs.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimehdrs.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimehdrs.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimehdrs.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimei.cpp">mailnews/mime/src/mimei.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimei.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimei.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimei.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimei.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimei.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimei.h">mailnews/mime/src/mimei.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimei.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimei.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimei.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimei.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimei.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeiimg.cpp">mailnews/mime/src/mimeiimg.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeiimg.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeiimg.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeiimg.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeiimg.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeiimg.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeiimg.h">mailnews/mime/src/mimeiimg.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeiimg.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeiimg.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeiimg.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeiimg.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeiimg.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeleaf.cpp">mailnews/mime/src/mimeleaf.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeleaf.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeleaf.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeleaf.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeleaf.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeleaf.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeleaf.h">mailnews/mime/src/mimeleaf.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeleaf.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeleaf.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeleaf.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeleaf.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeleaf.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemalt.cpp">mailnews/mime/src/mimemalt.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemalt.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemalt.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemalt.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemalt.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemalt.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemalt.h">mailnews/mime/src/mimemalt.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemalt.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemalt.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemalt.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemalt.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemalt.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemapl.cpp">mailnews/mime/src/mimemapl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemapl.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemapl.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemapl.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemapl.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemapl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemapl.h">mailnews/mime/src/mimemapl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemapl.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemapl.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemapl.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemapl.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemapl.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemcms.cpp">mailnews/mime/src/mimemcms.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemcms.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemcms.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemcms.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemcms.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemcms.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemcms.h">mailnews/mime/src/mimemcms.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemcms.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemcms.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemcms.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemcms.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemcms.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemdig.cpp">mailnews/mime/src/mimemdig.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemdig.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemdig.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemdig.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemdig.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemdig.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemdig.h">mailnews/mime/src/mimemdig.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemdig.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemdig.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemdig.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemdig.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemdig.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemmix.cpp">mailnews/mime/src/mimemmix.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemmix.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemmix.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemmix.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemmix.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemmix.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemmix.h">mailnews/mime/src/mimemmix.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemmix.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemmix.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemmix.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemmix.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemmix.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemoz2.cpp">mailnews/mime/src/mimemoz2.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemoz2.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemoz2.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemoz2.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemoz2.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemoz2.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemoz2.h">mailnews/mime/src/mimemoz2.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemoz2.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemoz2.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemoz2.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemoz2.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemoz2.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimempar.cpp">mailnews/mime/src/mimempar.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimempar.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimempar.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimempar.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimempar.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimempar.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimempar.h">mailnews/mime/src/mimempar.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimempar.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimempar.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimempar.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimempar.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimempar.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemrel.cpp">mailnews/mime/src/mimemrel.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemrel.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemrel.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemrel.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemrel.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemrel.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemrel.h">mailnews/mime/src/mimemrel.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemrel.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemrel.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemrel.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemrel.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemrel.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsg.cpp">mailnews/mime/src/mimemsg.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsg.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsg.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsg.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsg.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsg.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsg.h">mailnews/mime/src/mimemsg.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsg.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsg.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsg.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsg.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsg.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsig.cpp">mailnews/mime/src/mimemsig.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsig.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsig.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsig.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsig.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsig.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsig.h">mailnews/mime/src/mimemsig.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsig.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsig.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsig.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsig.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemsig.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemult.cpp">mailnews/mime/src/mimemult.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemult.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemult.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemult.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemult.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemult.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemult.h">mailnews/mime/src/mimemult.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemult.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemult.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemult.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemult.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimemult.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeobj.cpp">mailnews/mime/src/mimeobj.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeobj.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeobj.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeobj.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeobj.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeobj.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeobj.h">mailnews/mime/src/mimeobj.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeobj.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeobj.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeobj.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeobj.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeobj.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimepbuf.cpp">mailnews/mime/src/mimepbuf.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimepbuf.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimepbuf.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimepbuf.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimepbuf.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimepbuf.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimepbuf.h">mailnews/mime/src/mimepbuf.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimepbuf.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimepbuf.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimepbuf.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimepbuf.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimepbuf.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimesun.cpp">mailnews/mime/src/mimesun.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimesun.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimesun.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimesun.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimesun.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimesun.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimesun.h">mailnews/mime/src/mimesun.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimesun.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimesun.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimesun.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimesun.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimesun.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetenr.cpp">mailnews/mime/src/mimetenr.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetenr.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetenr.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetenr.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetenr.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetenr.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetenr.h">mailnews/mime/src/mimetenr.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetenr.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetenr.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetenr.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetenr.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetenr.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetext.cpp">mailnews/mime/src/mimetext.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetext.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetext.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetext.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetext.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetext.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetext.h">mailnews/mime/src/mimetext.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetext.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetext.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetext.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetext.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetext.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethpl.cpp">mailnews/mime/src/mimethpl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethpl.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethpl.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethpl.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethpl.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethpl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethpl.h">mailnews/mime/src/mimethpl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethpl.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethpl.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethpl.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethpl.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethpl.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethsa.cpp">mailnews/mime/src/mimethsa.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethsa.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethsa.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethsa.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethsa.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethsa.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethsa.h">mailnews/mime/src/mimethsa.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethsa.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethsa.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethsa.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethsa.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethsa.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethtm.cpp">mailnews/mime/src/mimethtm.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethtm.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethtm.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethtm.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethtm.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethtm.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethtm.h">mailnews/mime/src/mimethtm.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethtm.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethtm.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethtm.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethtm.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimethtm.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpfl.cpp">mailnews/mime/src/mimetpfl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpfl.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpfl.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpfl.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpfl.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpfl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpfl.h">mailnews/mime/src/mimetpfl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpfl.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpfl.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpfl.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpfl.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpfl.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpla.cpp">mailnews/mime/src/mimetpla.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpla.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpla.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpla.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpla.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpla.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpla.h">mailnews/mime/src/mimetpla.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpla.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpla.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpla.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpla.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetpla.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetric.cpp">mailnews/mime/src/mimetric.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetric.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetric.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetric.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetric.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetric.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetric.h">mailnews/mime/src/mimetric.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetric.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetric.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetric.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetric.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimetric.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeunty.cpp">mailnews/mime/src/mimeunty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeunty.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeunty.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeunty.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeunty.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeunty.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeunty.h">mailnews/mime/src/mimeunty.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeunty.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeunty.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeunty.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeunty.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/mimeunty.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/modlmime.h">mailnews/mime/src/modlmime.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/modlmime.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/modlmime.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/modlmime.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/modlmime.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/modlmime.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/modmimee.h">mailnews/mime/src/modmimee.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/modmimee.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/modmimee.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/modmimee.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/modmimee.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/modmimee.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMS.cpp">mailnews/mime/src/nsCMS.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMS.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMS.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMS.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMS.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMS.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMS.h">mailnews/mime/src/nsCMS.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMS.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMS.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMS.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMS.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMS.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMSSecureMessage.cpp">mailnews/mime/src/nsCMSSecureMessage.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMSSecureMessage.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMSSecureMessage.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMSSecureMessage.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMSSecureMessage.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMSSecureMessage.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMSSecureMessage.h">mailnews/mime/src/nsCMSSecureMessage.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMSSecureMessage.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMSSecureMessage.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMSSecureMessage.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMSSecureMessage.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsCMSSecureMessage.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeObjectClassAccess.cpp">mailnews/mime/src/nsMimeObjectClassAccess.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeObjectClassAccess.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeObjectClassAccess.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeObjectClassAccess.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeObjectClassAccess.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeObjectClassAccess.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeObjectClassAccess.h">mailnews/mime/src/nsMimeObjectClassAccess.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeObjectClassAccess.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeObjectClassAccess.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeObjectClassAccess.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeObjectClassAccess.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeObjectClassAccess.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeStringResources.h">mailnews/mime/src/nsMimeStringResources.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeStringResources.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeStringResources.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeStringResources.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeStringResources.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsMimeStringResources.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsSimpleMimeConverterStub.cpp">mailnews/mime/src/nsSimpleMimeConverterStub.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsSimpleMimeConverterStub.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsSimpleMimeConverterStub.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsSimpleMimeConverterStub.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsSimpleMimeConverterStub.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsSimpleMimeConverterStub.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsSimpleMimeConverterStub.h">mailnews/mime/src/nsSimpleMimeConverterStub.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsSimpleMimeConverterStub.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsSimpleMimeConverterStub.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsSimpleMimeConverterStub.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsSimpleMimeConverterStub.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsSimpleMimeConverterStub.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsStreamConverter.cpp">mailnews/mime/src/nsStreamConverter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsStreamConverter.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsStreamConverter.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsStreamConverter.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsStreamConverter.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsStreamConverter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsStreamConverter.h">mailnews/mime/src/nsStreamConverter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsStreamConverter.h">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsStreamConverter.h">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsStreamConverter.h">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsStreamConverter.h">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/src/nsStreamConverter.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/test/TestMimeCrash.cpp">mailnews/mime/test/TestMimeCrash.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/test/TestMimeCrash.cpp">file</a> |
<a href="/comm-central/annotate/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/test/TestMimeCrash.cpp">annotate</a> |
<a href="/comm-central/diff/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/test/TestMimeCrash.cpp">diff</a> |
<a href="/comm-central/comparison/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/test/TestMimeCrash.cpp">comparison</a> |
<a href="/comm-central/log/bca950c87a074a65e00c0894937c46b3b644ee5e/mailnews/mime/test/TestMimeCrash.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/mime/cthandlers/glue/mimexpcom.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/mime/cthandlers/glue/mimexpcom.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3,129 +3,109 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.5"></a><span id="l1.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsIMimeObjectClassAccess.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-static NS_DEFINE_CID(kMimeObjectClassAccessCID, NS_MIME_OBJECT_CLASS_ACCESS_CID);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+static NS_DEFINE_CID(kMimeObjectClassAccessCID,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+                     NS_MIME_OBJECT_CLASS_ACCESS_CID);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> /*</span>
<a href="#l1.17"></a><span id="l1.17">  * These calls are necessary to expose the object class hierarchy</span>
<a href="#l1.18"></a><span id="l1.18">  * to externally developed content type handlers.</span>
<a href="#l1.19"></a><span id="l1.19">  */</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-COM_GetmimeInlineTextClass(void)</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-{</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+extern &quot;C&quot; void *COM_GetmimeInlineTextClass(void) {</span>
<a href="#l1.24"></a><span id="l1.24">   void *ptr = NULL;</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">   nsresult res;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-  nsCOMPtr&lt;nsIMimeObjectClassAccess&gt;  objAccess =</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+  nsCOMPtr&lt;nsIMimeObjectClassAccess&gt; objAccess =</span>
<a href="#l1.29"></a><span id="l1.29">       do_CreateInstance(kMimeObjectClassAccessCID, &amp;res);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-  if (NS_SUCCEEDED(res) &amp;&amp; objAccess)</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    objAccess-&gt;GetmimeInlineTextClass(&amp;ptr);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  if (NS_SUCCEEDED(res) &amp;&amp; objAccess) objAccess-&gt;GetmimeInlineTextClass(&amp;ptr);</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34">   return ptr;</span>
<a href="#l1.35"></a><span id="l1.35"> }</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-COM_GetmimeLeafClass(void)</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-{</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+extern &quot;C&quot; void *COM_GetmimeLeafClass(void) {</span>
<a href="#l1.41"></a><span id="l1.41">   void *ptr = NULL;</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43">   nsresult res;</span>
<a href="#l1.44"></a><span id="l1.44">   nsCOMPtr&lt;nsIMimeObjectClassAccess&gt; objAccess =</span>
<a href="#l1.45"></a><span id="l1.45">       do_CreateInstance(kMimeObjectClassAccessCID, &amp;res);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-  if (NS_SUCCEEDED(res) &amp;&amp; objAccess)</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-    objAccess-&gt;GetmimeLeafClass(&amp;ptr);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  if (NS_SUCCEEDED(res) &amp;&amp; objAccess) objAccess-&gt;GetmimeLeafClass(&amp;ptr);</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50">   return ptr;</span>
<a href="#l1.51"></a><span id="l1.51"> }</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-COM_GetmimeObjectClass(void)</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-{</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+extern &quot;C&quot; void *COM_GetmimeObjectClass(void) {</span>
<a href="#l1.57"></a><span id="l1.57">   void *ptr = NULL;</span>
<a href="#l1.58"></a><span id="l1.58"> </span>
<a href="#l1.59"></a><span id="l1.59">   nsresult res;</span>
<a href="#l1.60"></a><span id="l1.60">   nsCOMPtr&lt;nsIMimeObjectClassAccess&gt; objAccess =</span>
<a href="#l1.61"></a><span id="l1.61">       do_CreateInstance(kMimeObjectClassAccessCID, &amp;res);</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-  if (NS_SUCCEEDED(res) &amp;&amp; objAccess)</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-    objAccess-&gt;GetmimeObjectClass(&amp;ptr);</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+  if (NS_SUCCEEDED(res) &amp;&amp; objAccess) objAccess-&gt;GetmimeObjectClass(&amp;ptr);</span>
<a href="#l1.65"></a><span id="l1.65"> </span>
<a href="#l1.66"></a><span id="l1.66">   return ptr;</span>
<a href="#l1.67"></a><span id="l1.67"> }</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-COM_GetmimeContainerClass(void)</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-{</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+extern &quot;C&quot; void *COM_GetmimeContainerClass(void) {</span>
<a href="#l1.73"></a><span id="l1.73">   void *ptr = NULL;</span>
<a href="#l1.74"></a><span id="l1.74"> </span>
<a href="#l1.75"></a><span id="l1.75">   nsresult res;</span>
<a href="#l1.76"></a><span id="l1.76">   nsCOMPtr&lt;nsIMimeObjectClassAccess&gt; objAccess =</span>
<a href="#l1.77"></a><span id="l1.77">       do_CreateInstance(kMimeObjectClassAccessCID, &amp;res);</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-  if (NS_SUCCEEDED(res) &amp;&amp; objAccess)</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-    objAccess-&gt;GetmimeContainerClass(&amp;ptr);</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+  if (NS_SUCCEEDED(res) &amp;&amp; objAccess) objAccess-&gt;GetmimeContainerClass(&amp;ptr);</span>
<a href="#l1.81"></a><span id="l1.81"> </span>
<a href="#l1.82"></a><span id="l1.82">   return ptr;</span>
<a href="#l1.83"></a><span id="l1.83"> }</span>
<a href="#l1.84"></a><span id="l1.84"> </span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-COM_GetmimeMultipartClass(void)</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-{</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+extern &quot;C&quot; void *COM_GetmimeMultipartClass(void) {</span>
<a href="#l1.89"></a><span id="l1.89">   void *ptr = NULL;</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91">   nsresult res;</span>
<a href="#l1.92"></a><span id="l1.92">   nsCOMPtr&lt;nsIMimeObjectClassAccess&gt; objAccess =</span>
<a href="#l1.93"></a><span id="l1.93">       do_CreateInstance(kMimeObjectClassAccessCID, &amp;res);</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-  if (NS_SUCCEEDED(res) &amp;&amp; objAccess)</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-    objAccess-&gt;GetmimeMultipartClass(&amp;ptr);</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+  if (NS_SUCCEEDED(res) &amp;&amp; objAccess) objAccess-&gt;GetmimeMultipartClass(&amp;ptr);</span>
<a href="#l1.97"></a><span id="l1.97"> </span>
<a href="#l1.98"></a><span id="l1.98">   return ptr;</span>
<a href="#l1.99"></a><span id="l1.99"> }</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-COM_GetmimeMultipartSignedClass(void)</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-{</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+extern &quot;C&quot; void *COM_GetmimeMultipartSignedClass(void) {</span>
<a href="#l1.105"></a><span id="l1.105">   void *ptr = NULL;</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107">   nsresult res;</span>
<a href="#l1.108"></a><span id="l1.108">   nsCOMPtr&lt;nsIMimeObjectClassAccess&gt; objAccess =</span>
<a href="#l1.109"></a><span id="l1.109">       do_CreateInstance(kMimeObjectClassAccessCID, &amp;res);</span>
<a href="#l1.110"></a><span id="l1.110">   if (NS_SUCCEEDED(res) &amp;&amp; objAccess)</span>
<a href="#l1.111"></a><span id="l1.111">     objAccess-&gt;GetmimeMultipartSignedClass(&amp;ptr);</span>
<a href="#l1.112"></a><span id="l1.112"> </span>
<a href="#l1.113"></a><span id="l1.113">   return ptr;</span>
<a href="#l1.114"></a><span id="l1.114"> }</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-extern &quot;C&quot; int</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-COM_MimeObject_write(void *mimeObject, char *data, int32_t length,</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-                     bool user_visible_p)</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-{</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+extern &quot;C&quot; int COM_MimeObject_write(void *mimeObject, char *data,</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+                                    int32_t length, bool user_visible_p) {</span>
<a href="#l1.122"></a><span id="l1.122">   int32_t rc = -1;</span>
<a href="#l1.123"></a><span id="l1.123"> </span>
<a href="#l1.124"></a><span id="l1.124">   nsresult res;</span>
<a href="#l1.125"></a><span id="l1.125">   nsCOMPtr&lt;nsIMimeObjectClassAccess&gt; objAccess =</span>
<a href="#l1.126"></a><span id="l1.126">       do_CreateInstance(kMimeObjectClassAccessCID, &amp;res);</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-  if (NS_SUCCEEDED(res) &amp;&amp; objAccess)</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-  {</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-    if (NS_SUCCEEDED(objAccess-&gt;MimeObjectWrite(mimeObject, data, length, user_visible_p)))</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+  if (NS_SUCCEEDED(res) &amp;&amp; objAccess) {</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+    if (NS_SUCCEEDED(objAccess-&gt;MimeObjectWrite(mimeObject, data, length,</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+                                                user_visible_p)))</span>
<a href="#l1.133"></a><span id="l1.133">       rc = length;</span>
<a href="#l1.134"></a><span id="l1.134">     else</span>
<a href="#l1.135"></a><span id="l1.135">       rc = -1;</span>
<a href="#l1.136"></a><span id="l1.136">   }</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138">   return rc;</span>
<a href="#l1.139"></a><span id="l1.139"> }</span>
<a href="#l1.140"></a><span id="l1.140"> </span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-COM_MimeCreate(char * content_type, void * hdrs, void * opts)</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-{</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+extern &quot;C&quot; void *COM_MimeCreate(char *content_type, void *hdrs, void *opts) {</span>
<a href="#l1.145"></a><span id="l1.145">   void *ptr = NULL;</span>
<a href="#l1.146"></a><span id="l1.146"> </span>
<a href="#l1.147"></a><span id="l1.147">   nsresult res;</span>
<a href="#l1.148"></a><span id="l1.148">   nsCOMPtr&lt;nsIMimeObjectClassAccess&gt; objAccess =</span>
<a href="#l1.149"></a><span id="l1.149">       do_CreateInstance(kMimeObjectClassAccessCID, &amp;res);</span>
<a href="#l1.150"></a><span id="l1.150">   if (NS_SUCCEEDED(res) &amp;&amp; objAccess)</span>
<a href="#l1.151"></a><span id="l1.151">     objAccess-&gt;MimeCreate(content_type, hdrs, opts, &amp;ptr);</span>
<a href="#l1.152"></a><span id="l1.152"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/mime/cthandlers/glue/mimexpcom.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/mime/cthandlers/glue/mimexpcom.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -69,25 +69,24 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> /*</span>
<a href="#l2.6"></a><span id="l2.6">  * These functions are exposed by libmime to be used by content type</span>
<a href="#l2.7"></a><span id="l2.7">  * handler plugins for processing stream data.</span>
<a href="#l2.8"></a><span id="l2.8">  */</span>
<a href="#l2.9"></a><span id="l2.9"> /*</span>
<a href="#l2.10"></a><span id="l2.10">  * This is the write call for outputting processed stream data.</span>
<a href="#l2.11"></a><span id="l2.11">  */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-extern &quot;C&quot; int  COM_MimeObject_write(void *mimeObject, const char *data,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                                      int32_t length,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-                                      bool user_visible_p);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+extern &quot;C&quot; int COM_MimeObject_write(void *mimeObject, const char *data,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+                                    int32_t length, bool user_visible_p);</span>
<a href="#l2.17"></a><span id="l2.17"> /*</span>
<a href="#l2.18"></a><span id="l2.18">  * The following group of calls expose the pointers for the object</span>
<a href="#l2.19"></a><span id="l2.19">  * system within libmime.</span>
<a href="#l2.20"></a><span id="l2.20">  */</span>
<a href="#l2.21"></a><span id="l2.21"> extern &quot;C&quot; void *COM_GetmimeInlineTextClass(void);</span>
<a href="#l2.22"></a><span id="l2.22"> extern &quot;C&quot; void *COM_GetmimeLeafClass(void);</span>
<a href="#l2.23"></a><span id="l2.23"> extern &quot;C&quot; void *COM_GetmimeObjectClass(void);</span>
<a href="#l2.24"></a><span id="l2.24"> extern &quot;C&quot; void *COM_GetmimeContainerClass(void);</span>
<a href="#l2.25"></a><span id="l2.25"> extern &quot;C&quot; void *COM_GetmimeMultipartClass(void);</span>
<a href="#l2.26"></a><span id="l2.26"> extern &quot;C&quot; void *COM_GetmimeMultipartSignedClass(void);</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-extern &quot;C&quot; void *COM_MimeCreate(char * content_type, void * hdrs, void * opts);</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+extern &quot;C&quot; void *COM_MimeCreate(char *content_type, void *hdrs, void *opts);</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31"> #endif /* _MIMEXPCOM_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -12,49 +12,44 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * The following macros actually implement addref, release and</span>
<a href="#l3.5"></a><span id="l3.5">  * query interface for our component.</span>
<a href="#l3.6"></a><span id="l3.6">  */</span>
<a href="#l3.7"></a><span id="l3.7"> NS_IMPL_ISUPPORTS(nsMimeContentTypeHandler, nsIMimeContentTypeHandler)</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> /*</span>
<a href="#l3.10"></a><span id="l3.10">  * nsIMimeEmitter definitions....</span>
<a href="#l3.11"></a><span id="l3.11">  */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-nsMimeContentTypeHandler::nsMimeContentTypeHandler(const char *aMimeType,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                                                   MCTHCreateCTHClass callback)</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-{</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  NS_ASSERTION(aMimeType, &quot;nsMimeContentTypeHandler should be initialized with non-null mime type&quot;);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-  NS_ASSERTION(callback, &quot;nsMimeContentTypeHandler should be initialized with non-null callback&quot;);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+nsMimeContentTypeHandler::nsMimeContentTypeHandler(</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    const char *aMimeType, MCTHCreateCTHClass callback) {</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  NS_ASSERTION(</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+      aMimeType,</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+      &quot;nsMimeContentTypeHandler should be initialized with non-null mime type&quot;);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  NS_ASSERTION(</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+      callback,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+      &quot;nsMimeContentTypeHandler should be initialized with non-null callback&quot;);</span>
<a href="#l3.25"></a><span id="l3.25">   mimeType = PL_strdup(aMimeType);</span>
<a href="#l3.26"></a><span id="l3.26">   realCreateContentTypeHandlerClass = callback;</span>
<a href="#l3.27"></a><span id="l3.27"> }</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-nsMimeContentTypeHandler::~nsMimeContentTypeHandler(void)</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-{</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+nsMimeContentTypeHandler::~nsMimeContentTypeHandler(void) {</span>
<a href="#l3.32"></a><span id="l3.32">   if (mimeType) {</span>
<a href="#l3.33"></a><span id="l3.33">     free(mimeType);</span>
<a href="#l3.34"></a><span id="l3.34">     mimeType = 0;</span>
<a href="#l3.35"></a><span id="l3.35">   }</span>
<a href="#l3.36"></a><span id="l3.36">   realCreateContentTypeHandlerClass = 0;</span>
<a href="#l3.37"></a><span id="l3.37"> }</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39"> // Get the content type if necessary</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-nsresult</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-nsMimeContentTypeHandler::GetContentType(char **contentType)</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-{</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+nsresult nsMimeContentTypeHandler::GetContentType(char **contentType) {</span>
<a href="#l3.44"></a><span id="l3.44">   *contentType = PL_strdup(mimeType);</span>
<a href="#l3.45"></a><span id="l3.45">   return NS_OK;</span>
<a href="#l3.46"></a><span id="l3.46"> }</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48"> // Set the output stream for processed data.</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-nsresult</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-nsMimeContentTypeHandler::CreateContentTypeHandlerClass(const char *content_type,</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-                                                contentTypeHandlerInitStruct *initStruct,</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-                                                MimeObjectClass **objClass)</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-{</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+nsresult nsMimeContentTypeHandler::CreateContentTypeHandlerClass(</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    const char *content_type, contentTypeHandlerInitStruct *initStruct,</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    MimeObjectClass **objClass) {</span>
<a href="#l3.57"></a><span id="l3.57">   *objClass = realCreateContentTypeHandlerClass(content_type, initStruct);</span>
<a href="#l3.58"></a><span id="l3.58">   if (!*objClass)</span>
<a href="#l3.59"></a><span id="l3.59">     return NS_ERROR_OUT_OF_MEMORY; /* we couldn't allocate the object */</span>
<a href="#l3.60"></a><span id="l3.60">   else</span>
<a href="#l3.61"></a><span id="l3.61">     return NS_OK;</span>
<a href="#l3.62"></a><span id="l3.62"> }</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/mime/cthandlers/glue/nsMimeContentTypeHandler.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -16,32 +16,31 @@</span>
<a href="#l4.4"></a><span id="l4.4">  *       locate the appropriate Content Type handler</span>
<a href="#l4.5"></a><span id="l4.5">  */</span>
<a href="#l4.6"></a><span id="l4.6"> #ifndef nsMimeContentTypeHandler_h_</span>
<a href="#l4.7"></a><span id="l4.7"> #define nsMimeContentTypeHandler_h_</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsIMimeContentTypeHandler.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-typedef MimeObjectClass  *</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-(* MCTHCreateCTHClass)(const char *content_type,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-                       contentTypeHandlerInitStruct *initStruct);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+typedef MimeObjectClass *(*MCTHCreateCTHClass)(</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+    const char *content_type, contentTypeHandlerInitStruct *initStruct);</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> class nsMimeContentTypeHandler : public nsIMimeContentTypeHandler {</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-public:</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-    nsMimeContentTypeHandler (const char *aMimeType,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-                              MCTHCreateCTHClass callback);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ public:</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  nsMimeContentTypeHandler(const char *aMimeType, MCTHCreateCTHClass callback);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-    /* this macro defines QueryInterface, AddRef and Release for this class */</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+  /* this macro defines QueryInterface, AddRef and Release for this class */</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  NS_IMETHOD GetContentType(char **contentType) override;</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-    NS_IMETHOD    GetContentType(char **contentType) override;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  NS_IMETHOD CreateContentTypeHandlerClass(</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+      const char *content_type, contentTypeHandlerInitStruct *initStruct,</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+      MimeObjectClass **objClass) override;</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-    NS_IMETHOD    CreateContentTypeHandlerClass(const char *content_type,</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-                                                contentTypeHandlerInitStruct *initStruct,</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-                                                MimeObjectClass **objClass) override;</span>
<a href="#l4.40"></a><span id="l4.40">  private:</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-    virtual ~nsMimeContentTypeHandler();</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-    char *mimeType;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-    MCTHCreateCTHClass realCreateContentTypeHandlerClass;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  virtual ~nsMimeContentTypeHandler();</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  char *mimeType;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  MCTHCreateCTHClass realCreateContentTypeHandlerClass;</span>
<a href="#l4.47"></a><span id="l4.47"> };</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49"> #endif /* nsMimeContentTypeHandler_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -24,663 +24,560 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;plstr.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIPgpMimeProxy.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> /**</span>
<a href="#l5.9"></a><span id="l5.9">  * Overall description</span>
<a href="#l5.10"></a><span id="l5.10">  * ===================</span>
<a href="#l5.11"></a><span id="l5.11">  *</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">- * There are three components involved here: MIME, a proxy object (nsPgpMimeProxy)</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">- * and Enigmail (or any other add-on that registered a decryption object with</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+ * There are three components involved here: MIME, a proxy object</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+ * (nsPgpMimeProxy) and Enigmail (or any other add-on that registered a</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+ * decryption object with</span>
<a href="#l5.17"></a><span id="l5.17">  * &quot;@mozilla.org/mime/pgp-mime-js-decrypt;1&quot;).</span>
<a href="#l5.18"></a><span id="l5.18">  *</span>
<a href="#l5.19"></a><span id="l5.19">  * MIME creates and initialises the proxy object in nsPgpMimeProxy::Init(). This</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">- * creates a decryption object, for example EnigmailMimeDecrypt. When MIME wants to</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">- * decode something, it calls the Write() method of the proxy, which in turn calls</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">- * OnDataAvailable() on the decryptor. The decryptor optains the encrypted data</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">- * form the proxy via the proxy's Read() method. The decryptor decrypts the data and</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">- * passes the result back to the proxy, using the OutputDecryptedData() method</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">- * or by passing a stream to the proxy's OnDataAvailable() method, in which</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">- * the proxy will read from that stream.</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">- * The proxy knows how to interface with MIME and passes the data on using</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">- * some function pointers it got given via nsPgpMimeProxy::SetMimeCallback().</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+ * creates a decryption object, for example EnigmailMimeDecrypt. When MIME wants</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+ * to decode something, it calls the Write() method of the proxy, which in turn</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+ * calls OnDataAvailable() on the decryptor. The decryptor optains the encrypted</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+ * data form the proxy via the proxy's Read() method. The decryptor decrypts the</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+ * data and passes the result back to the proxy, using the OutputDecryptedData()</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+ * method or by passing a stream to the proxy's OnDataAvailable() method, in</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+ * which the proxy will read from that stream. The proxy knows how to interface</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+ * with MIME and passes the data on using some function pointers it got given</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+ * via nsPgpMimeProxy::SetMimeCallback().</span>
<a href="#l5.38"></a><span id="l5.38">  */</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-</span>
<a href="#l5.41"></a><span id="l5.41"> #define MIME_SUPERCLASS mimeEncryptedClass</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-MimeDefClass(MimeEncryptedPgp, MimeEncryptedPgpClass,</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-             mimeEncryptedPgpClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+MimeDefClass(MimeEncryptedPgp, MimeEncryptedPgpClass, mimeEncryptedPgpClass,</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+             &amp;MIME_SUPERCLASS);</span>
<a href="#l5.46"></a><span id="l5.46"> </span>
<a href="#l5.47"></a><span id="l5.47"> #define kCharMax 1024</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-extern &quot;C&quot; MimeObjectClass *</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-MIME_PgpMimeCreateContentTypeHandlerClass(</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-                                    const char *content_type,</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-                                    contentTypeHandlerInitStruct *initStruct)</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-{</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-  MimeObjectClass *objClass = (MimeObjectClass *) &amp;mimeEncryptedPgpClass;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+extern &quot;C&quot; MimeObjectClass *MIME_PgpMimeCreateContentTypeHandlerClass(</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+    const char *content_type, contentTypeHandlerInitStruct *initStruct) {</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  MimeObjectClass *objClass = (MimeObjectClass *)&amp;mimeEncryptedPgpClass;</span>
<a href="#l5.58"></a><span id="l5.58"> </span>
<a href="#l5.59"></a><span id="l5.59">   initStruct-&gt;force_inline_display = false;</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61">   return objClass;</span>
<a href="#l5.62"></a><span id="l5.62"> }</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64"> static void *MimePgpe_init(MimeObject *,</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-                           int (*output_fn) (const char *, int32_t, void *),</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+                           int (*output_fn)(const char *, int32_t, void *),</span>
<a href="#l5.67"></a><span id="l5.67">                            void *);</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-static int MimePgpe_write (const char *, int32_t, void *);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-static int MimePgpe_eof (void *, bool);</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-static char* MimePgpe_generate (void *);</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-static void MimePgpe_free (void *);</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+static int MimePgpe_write(const char *, int32_t, void *);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+static int MimePgpe_eof(void *, bool);</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+static char *MimePgpe_generate(void *);</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+static void MimePgpe_free(void *);</span>
<a href="#l5.76"></a><span id="l5.76"> </span>
<a href="#l5.77"></a><span id="l5.77"> /* Returns a string describing the location of the part (like &quot;2.5.3&quot;).</span>
<a href="#l5.78"></a><span id="l5.78">    This is not a full URL, just a part-number.</span>
<a href="#l5.79"></a><span id="l5.79">  */</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-static nsCString determineMimePart(MimeObject* obj);</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+static nsCString determineMimePart(MimeObject *obj);</span>
<a href="#l5.83"></a><span id="l5.83"> </span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-#define PGPMIME_PROPERTIES_URL        &quot;chrome://messenger/locale/pgpmime.properties&quot;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-#define PGPMIME_STR_NOT_SUPPORTED_ID  &quot;pgpMimeNeedsAddon&quot;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-#define PGPMIME_URL_PREF              &quot;mail.pgpmime.addon_url&quot;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+#define PGPMIME_PROPERTIES_URL &quot;chrome://messenger/locale/pgpmime.properties&quot;</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+#define PGPMIME_STR_NOT_SUPPORTED_ID &quot;pgpMimeNeedsAddon&quot;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+#define PGPMIME_URL_PREF &quot;mail.pgpmime.addon_url&quot;</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-static void PgpMimeGetNeedsAddonString(nsCString &amp;aResult)</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-{</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+static void PgpMimeGetNeedsAddonString(nsCString &amp;aResult) {</span>
<a href="#l5.94"></a><span id="l5.94">   aResult.AssignLiteral(&quot;???&quot;);</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96">   nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleService =</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l5.99"></a><span id="l5.99"> </span>
<a href="#l5.100"></a><span id="l5.100">   nsCOMPtr&lt;nsIStringBundle&gt; stringBundle;</span>
<a href="#l5.101"></a><span id="l5.101">   nsresult rv = stringBundleService-&gt;CreateBundle(PGPMIME_PROPERTIES_URL,</span>
<a href="#l5.102"></a><span id="l5.102">                                                   getter_AddRefs(stringBundle));</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-    return;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l5.106"></a><span id="l5.106"> </span>
<a href="#l5.107"></a><span id="l5.107">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-    return;</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l5.111"></a><span id="l5.111"> </span>
<a href="#l5.112"></a><span id="l5.112">   nsCString url;</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-  if (NS_FAILED(prefs-&gt;GetCharPref(&quot;mail.pgpmime.addon_url&quot;, url)))</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-    return;</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+  if (NS_FAILED(prefs-&gt;GetCharPref(&quot;mail.pgpmime.addon_url&quot;, url))) return;</span>
<a href="#l5.116"></a><span id="l5.116"> </span>
<a href="#l5.117"></a><span id="l5.117">   NS_ConvertUTF8toUTF16 url16(url);</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-  const char16_t *formatStrings[] = { url16.get() };</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+  const char16_t *formatStrings[] = {url16.get()};</span>
<a href="#l5.120"></a><span id="l5.120"> </span>
<a href="#l5.121"></a><span id="l5.121">   nsString result;</span>
<a href="#l5.122"></a><span id="l5.122">   rv = stringBundle-&gt;FormatStringFromName(PGPMIME_STR_NOT_SUPPORTED_ID,</span>
<a href="#l5.123"></a><span id="l5.123">                                           formatStrings, 1, result);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-    return;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l5.127"></a><span id="l5.127">   aResult = NS_ConvertUTF16toUTF8(result);</span>
<a href="#l5.128"></a><span id="l5.128"> }</span>
<a href="#l5.129"></a><span id="l5.129"> </span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-static int</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-MimeEncryptedPgpClassInitialize(MimeEncryptedPgpClass *clazz)</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-{</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-  mozilla::DebugOnly&lt;MimeObjectClass *&gt; oclass = (MimeObjectClass *) clazz;</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+static int MimeEncryptedPgpClassInitialize(MimeEncryptedPgpClass *clazz) {</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+  mozilla::DebugOnly&lt;MimeObjectClass *&gt; oclass = (MimeObjectClass *)clazz;</span>
<a href="#l5.136"></a><span id="l5.136">   NS_ASSERTION(!oclass-&gt;class_initialized, &quot;oclass is not initialized&quot;);</span>
<a href="#l5.137"></a><span id="l5.137"> </span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-  MimeEncryptedClass *eclass = (MimeEncryptedClass *) clazz;</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+  MimeEncryptedClass *eclass = (MimeEncryptedClass *)clazz;</span>
<a href="#l5.140"></a><span id="l5.140"> </span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-  eclass-&gt;crypto_init          = MimePgpe_init;</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-  eclass-&gt;crypto_write         = MimePgpe_write;</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-  eclass-&gt;crypto_eof           = MimePgpe_eof;</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+  eclass-&gt;crypto_init = MimePgpe_init;</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+  eclass-&gt;crypto_write = MimePgpe_write;</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+  eclass-&gt;crypto_eof = MimePgpe_eof;</span>
<a href="#l5.147"></a><span id="l5.147">   eclass-&gt;crypto_generate_html = MimePgpe_generate;</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-  eclass-&gt;crypto_free          = MimePgpe_free;</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+  eclass-&gt;crypto_free = MimePgpe_free;</span>
<a href="#l5.150"></a><span id="l5.150"> </span>
<a href="#l5.151"></a><span id="l5.151">   return 0;</span>
<a href="#l5.152"></a><span id="l5.152"> }</span>
<a href="#l5.153"></a><span id="l5.153"> </span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-class MimePgpeData : public nsISupports</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-{</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-public:</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+class MimePgpeData : public nsISupports {</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+ public:</span>
<a href="#l5.159"></a><span id="l5.159">   NS_DECL_ISUPPORTS</span>
<a href="#l5.160"></a><span id="l5.160"> </span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-  int (*output_fn) (const char *buf, int32_t buf_size, void *output_closure);</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+  int (*output_fn)(const char *buf, int32_t buf_size, void *output_closure);</span>
<a href="#l5.163"></a><span id="l5.163">   void *output_closure;</span>
<a href="#l5.164"></a><span id="l5.164">   MimeObject *self;</span>
<a href="#l5.165"></a><span id="l5.165"> </span>
<a href="#l5.166"></a><span id="l5.166">   nsCOMPtr&lt;nsIPgpMimeProxy&gt; mimeDecrypt;</span>
<a href="#l5.167"></a><span id="l5.167"> </span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-  MimePgpeData()</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-    : output_fn(nullptr),</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-      output_closure(nullptr)</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-  {</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-  }</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+  MimePgpeData() : output_fn(nullptr), output_closure(nullptr) {}</span>
<a href="#l5.174"></a><span id="l5.174"> </span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-private:</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-  virtual ~MimePgpeData()</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-  {</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-  }</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+ private:</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+  virtual ~MimePgpeData() {}</span>
<a href="#l5.181"></a><span id="l5.181"> };</span>
<a href="#l5.182"></a><span id="l5.182"> </span>
<a href="#l5.183"></a><span id="l5.183"> NS_IMPL_ISUPPORTS0(MimePgpeData)</span>
<a href="#l5.184"></a><span id="l5.184"> </span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-static void*</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-MimePgpe_init(MimeObject *obj,</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-              int (*output_fn) (const char *buf, int32_t buf_size,</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-                                void *output_closure),</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-              void *output_closure)</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-{</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-  if (!(obj &amp;&amp; obj-&gt;options &amp;&amp; output_fn))</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-    return nullptr;</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+static void *MimePgpe_init(MimeObject *obj,</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+                           int (*output_fn)(const char *buf, int32_t buf_size,</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+                                            void *output_closure),</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+                           void *output_closure) {</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+  if (!(obj &amp;&amp; obj-&gt;options &amp;&amp; output_fn)) return nullptr;</span>
<a href="#l5.198"></a><span id="l5.198"> </span>
<a href="#l5.199"></a><span id="l5.199" class="difflineminus">-  MimePgpeData* data = new MimePgpeData();</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+  MimePgpeData *data = new MimePgpeData();</span>
<a href="#l5.201"></a><span id="l5.201">   NS_ENSURE_TRUE(data, nullptr);</span>
<a href="#l5.202"></a><span id="l5.202"> </span>
<a href="#l5.203"></a><span id="l5.203">   data-&gt;self = obj;</span>
<a href="#l5.204"></a><span id="l5.204">   data-&gt;output_fn = output_fn;</span>
<a href="#l5.205"></a><span id="l5.205">   data-&gt;output_closure = output_closure;</span>
<a href="#l5.206"></a><span id="l5.206">   data-&gt;mimeDecrypt = nullptr;</span>
<a href="#l5.207"></a><span id="l5.207"> </span>
<a href="#l5.208"></a><span id="l5.208">   // Create proxy object.</span>
<a href="#l5.209"></a><span id="l5.209">   nsresult rv;</span>
<a href="#l5.210"></a><span id="l5.210">   data-&gt;mimeDecrypt = do_CreateInstance(NS_PGPMIMEPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-    return data;</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+  if (NS_FAILED(rv)) return data;</span>
<a href="#l5.214"></a><span id="l5.214"> </span>
<a href="#l5.215"></a><span id="l5.215">   char *ct = MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l5.216"></a><span id="l5.216"> </span>
<a href="#l5.217"></a><span id="l5.217">   rv = (ct ? data-&gt;mimeDecrypt-&gt;SetContentType(nsDependentCString(ct))</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-        : data-&gt;mimeDecrypt-&gt;SetContentType(EmptyCString()));</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+           : data-&gt;mimeDecrypt-&gt;SetContentType(EmptyCString()));</span>
<a href="#l5.220"></a><span id="l5.220"> </span>
<a href="#l5.221"></a><span id="l5.221">   PR_Free(ct);</span>
<a href="#l5.222"></a><span id="l5.222"> </span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-    return nullptr;</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+  if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l5.226"></a><span id="l5.226"> </span>
<a href="#l5.227"></a><span id="l5.227">   nsCString mimePart = determineMimePart(obj);</span>
<a href="#l5.228"></a><span id="l5.228"> </span>
<a href="#l5.229"></a><span id="l5.229">   rv = data-&gt;mimeDecrypt-&gt;SetMimePart(mimePart);</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-    return nullptr;</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+  if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l5.233"></a><span id="l5.233"> </span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-  mime_stream_data *msd = (mime_stream_data *) (data-&gt;self-&gt;options-&gt;stream_closure);</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+  mime_stream_data *msd =</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+      (mime_stream_data *)(data-&gt;self-&gt;options-&gt;stream_closure);</span>
<a href="#l5.237"></a><span id="l5.237">   nsIChannel *channel = msd-&gt;channel;</span>
<a href="#l5.238"></a><span id="l5.238"> </span>
<a href="#l5.239"></a><span id="l5.239">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-  if (channel)</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-    channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+  if (channel) channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l5.243"></a><span id="l5.243"> </span>
<a href="#l5.244"></a><span id="l5.244">   // Initialise proxy object with MIME's output function, object and URI.</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-  if (NS_FAILED(data-&gt;mimeDecrypt-&gt;SetMimeCallback(output_fn, output_closure, uri)))</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+  if (NS_FAILED(</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+          data-&gt;mimeDecrypt-&gt;SetMimeCallback(output_fn, output_closure, uri)))</span>
<a href="#l5.248"></a><span id="l5.248">     return nullptr;</span>
<a href="#l5.249"></a><span id="l5.249"> </span>
<a href="#l5.250"></a><span id="l5.250">   return data;</span>
<a href="#l5.251"></a><span id="l5.251"> }</span>
<a href="#l5.252"></a><span id="l5.252"> </span>
<a href="#l5.253"></a><span id="l5.253" class="difflineminus">-static int</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-MimePgpe_write(const char *buf, int32_t buf_size, void *output_closure)</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-{</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-  MimePgpeData* data = (MimePgpeData *) output_closure;</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+static int MimePgpe_write(const char *buf, int32_t buf_size,</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+                          void *output_closure) {</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+  MimePgpeData *data = (MimePgpeData *)output_closure;</span>
<a href="#l5.260"></a><span id="l5.260"> </span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-  if (!data || !data-&gt;output_fn)</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-    return -1;</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+  if (!data || !data-&gt;output_fn) return -1;</span>
<a href="#l5.264"></a><span id="l5.264"> </span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-  if (!data-&gt;mimeDecrypt)</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineminus">-    return 0;</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+  if (!data-&gt;mimeDecrypt) return 0;</span>
<a href="#l5.268"></a><span id="l5.268"> </span>
<a href="#l5.269"></a><span id="l5.269">   return (NS_SUCCEEDED(data-&gt;mimeDecrypt-&gt;Write(buf, buf_size)) ? 0 : -1);</span>
<a href="#l5.270"></a><span id="l5.270"> }</span>
<a href="#l5.271"></a><span id="l5.271"> </span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-static int</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineminus">-MimePgpe_eof(void* output_closure, bool abort_p)</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineminus">-{</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineminus">-  MimePgpeData* data = (MimePgpeData *) output_closure;</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+static int MimePgpe_eof(void *output_closure, bool abort_p) {</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+  MimePgpeData *data = (MimePgpeData *)output_closure;</span>
<a href="#l5.278"></a><span id="l5.278"> </span>
<a href="#l5.279"></a><span id="l5.279" class="difflineminus">-  if (!data || !data-&gt;output_fn)</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineminus">-    return -1;</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+  if (!data || !data-&gt;output_fn) return -1;</span>
<a href="#l5.282"></a><span id="l5.282"> </span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-  if (NS_FAILED(data-&gt;mimeDecrypt-&gt;Finish()))</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineminus">-    return -1;</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+  if (NS_FAILED(data-&gt;mimeDecrypt-&gt;Finish())) return -1;</span>
<a href="#l5.286"></a><span id="l5.286"> </span>
<a href="#l5.287"></a><span id="l5.287">   data-&gt;mimeDecrypt = nullptr;</span>
<a href="#l5.288"></a><span id="l5.288">   return 0;</span>
<a href="#l5.289"></a><span id="l5.289"> }</span>
<a href="#l5.290"></a><span id="l5.290"> </span>
<a href="#l5.291"></a><span id="l5.291" class="difflineminus">-static char*</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineminus">-MimePgpe_generate(void *output_closure)</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineminus">-{</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+static char *MimePgpe_generate(void *output_closure) {</span>
<a href="#l5.295"></a><span id="l5.295">   const char htmlMsg[] = &quot;&lt;html&gt;&lt;body&gt;&lt;b&gt;GEN MSG&lt;b&gt;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-  char* msg = (char *) PR_MALLOC(strlen(htmlMsg) + 1);</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-  if (msg)</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-    PL_strcpy(msg, htmlMsg);</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+  char *msg = (char *)PR_MALLOC(strlen(htmlMsg) + 1);</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+  if (msg) PL_strcpy(msg, htmlMsg);</span>
<a href="#l5.301"></a><span id="l5.301"> </span>
<a href="#l5.302"></a><span id="l5.302">   return msg;</span>
<a href="#l5.303"></a><span id="l5.303"> }</span>
<a href="#l5.304"></a><span id="l5.304"> </span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-static void</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineminus">-MimePgpe_free(void *output_closure)</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineminus">-{</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineminus">-}</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+static void MimePgpe_free(void *output_closure) {}</span>
<a href="#l5.310"></a><span id="l5.310"> </span>
<a href="#l5.311"></a><span id="l5.311"> /* Returns a string describing the location of the part (like &quot;2.5.3&quot;).</span>
<a href="#l5.312"></a><span id="l5.312">    This is not a full URL, just a part-number.</span>
<a href="#l5.313"></a><span id="l5.313">  */</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-static nsCString</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineminus">-determineMimePart(MimeObject* obj)</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineminus">-{</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+static nsCString determineMimePart(MimeObject *obj) {</span>
<a href="#l5.318"></a><span id="l5.318">   char mimePartNum[20];</span>
<a href="#l5.319"></a><span id="l5.319">   MimeObject *kid;</span>
<a href="#l5.320"></a><span id="l5.320">   MimeContainer *cont;</span>
<a href="#l5.321"></a><span id="l5.321">   int32_t i;</span>
<a href="#l5.322"></a><span id="l5.322"> </span>
<a href="#l5.323"></a><span id="l5.323">   nsCString mimePart;</span>
<a href="#l5.324"></a><span id="l5.324"> </span>
<a href="#l5.325"></a><span id="l5.325">   while (obj-&gt;parent) {</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineminus">-    cont = (MimeContainer *) obj-&gt;parent;</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+    cont = (MimeContainer *)obj-&gt;parent;</span>
<a href="#l5.328"></a><span id="l5.328">     for (i = 0; i &lt; cont-&gt;nchildren; i++) {</span>
<a href="#l5.329"></a><span id="l5.329">       kid = cont-&gt;children[i];</span>
<a href="#l5.330"></a><span id="l5.330">       if (kid == obj) {</span>
<a href="#l5.331"></a><span id="l5.331">         sprintf(mimePartNum, &quot;.%d&quot;, i + 1);</span>
<a href="#l5.332"></a><span id="l5.332">         mimePart.Insert(mimePartNum, 0);</span>
<a href="#l5.333"></a><span id="l5.333">       }</span>
<a href="#l5.334"></a><span id="l5.334">     }</span>
<a href="#l5.335"></a><span id="l5.335">     obj = obj-&gt;parent;</span>
<a href="#l5.336"></a><span id="l5.336">   }</span>
<a href="#l5.337"></a><span id="l5.337"> </span>
<a href="#l5.338"></a><span id="l5.338">   // remove leading &quot;.&quot;</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineminus">-  if (mimePart.Length() &gt; 0)</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineminus">-    mimePart.Cut(0, 1);</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+  if (mimePart.Length() &gt; 0) mimePart.Cut(0, 1);</span>
<a href="#l5.342"></a><span id="l5.342"> </span>
<a href="#l5.343"></a><span id="l5.343">   return mimePart;</span>
<a href="#l5.344"></a><span id="l5.344"> }</span>
<a href="#l5.345"></a><span id="l5.345"> </span>
<a href="#l5.346"></a><span id="l5.346" class="difflineminus">-</span>
<a href="#l5.347"></a><span id="l5.347"> ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineminus">-NS_IMPL_ISUPPORTS(nsPgpMimeProxy,</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-                              nsIPgpMimeProxy,</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineminus">-                              nsIRequestObserver,</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineminus">-                              nsIStreamListener,</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineminus">-                              nsIRequest,</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineminus">-                              nsIInputStream)</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+NS_IMPL_ISUPPORTS(nsPgpMimeProxy, nsIPgpMimeProxy, nsIRequestObserver,</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+                  nsIStreamListener, nsIRequest, nsIInputStream)</span>
<a href="#l5.356"></a><span id="l5.356"> </span>
<a href="#l5.357"></a><span id="l5.357"> // nsPgpMimeProxy implementation</span>
<a href="#l5.358"></a><span id="l5.358"> nsPgpMimeProxy::nsPgpMimeProxy()</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineminus">-  : mInitialized(false),</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineminus">-    mLoadFlags(LOAD_NORMAL),</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineminus">-    mCancelStatus(NS_OK)</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineminus">-{</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineminus">-}</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+    : mInitialized(false), mLoadFlags(LOAD_NORMAL), mCancelStatus(NS_OK) {}</span>
<a href="#l5.365"></a><span id="l5.365"> </span>
<a href="#l5.366"></a><span id="l5.366" class="difflineminus">-nsPgpMimeProxy::~nsPgpMimeProxy()</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineminus">-{</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-  Finalize();</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineminus">-}</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+nsPgpMimeProxy::~nsPgpMimeProxy() { Finalize(); }</span>
<a href="#l5.371"></a><span id="l5.371"> </span>
<a href="#l5.372"></a><span id="l5.372" class="difflineminus">-nsresult</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">-nsPgpMimeProxy::Finalize()</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineminus">-{</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineminus">-}</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+nsresult nsPgpMimeProxy::Finalize() { return NS_OK; }</span>
<a href="#l5.378"></a><span id="l5.378"> </span>
<a href="#l5.379"></a><span id="l5.379"> NS_IMETHODIMP</span>
<a href="#l5.380"></a><span id="l5.380"> nsPgpMimeProxy::SetMimeCallback(MimeDecodeCallbackFun outputFun,</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineminus">-                        void* outputClosure,</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineminus">-                        nsIURI* myUri)</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-{</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineminus">-  if (!outputFun || !outputClosure)</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+                                void *outputClosure, nsIURI *myUri) {</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+  if (!outputFun || !outputClosure) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.388"></a><span id="l5.388"> </span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-  mOutputFun     = outputFun;</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+  mOutputFun = outputFun;</span>
<a href="#l5.391"></a><span id="l5.391">   mOutputClosure = outputClosure;</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-  mInitialized   = true;</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineminus">-  mMessageURI    = myUri;</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+  mInitialized = true;</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+  mMessageURI = myUri;</span>
<a href="#l5.396"></a><span id="l5.396"> </span>
<a href="#l5.397"></a><span id="l5.397">   mStreamOffset = 0;</span>
<a href="#l5.398"></a><span id="l5.398">   mByteBuf.Truncate();</span>
<a href="#l5.399"></a><span id="l5.399"> </span>
<a href="#l5.400"></a><span id="l5.400" class="difflineminus">-  if (mDecryptor)</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineminus">-    return mDecryptor-&gt;OnStartRequest((nsIRequest*) this);</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+  if (mDecryptor) return mDecryptor-&gt;OnStartRequest((nsIRequest *)this);</span>
<a href="#l5.403"></a><span id="l5.403"> </span>
<a href="#l5.404"></a><span id="l5.404">   return NS_OK;</span>
<a href="#l5.405"></a><span id="l5.405"> }</span>
<a href="#l5.406"></a><span id="l5.406"> </span>
<a href="#l5.407"></a><span id="l5.407"> NS_IMETHODIMP</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineminus">-nsPgpMimeProxy::Init()</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineminus">-{</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+nsPgpMimeProxy::Init() {</span>
<a href="#l5.411"></a><span id="l5.411">   mByteBuf.Truncate();</span>
<a href="#l5.412"></a><span id="l5.412"> </span>
<a href="#l5.413"></a><span id="l5.413">   // Create add-on supplied decryption object.</span>
<a href="#l5.414"></a><span id="l5.414">   nsresult rv;</span>
<a href="#l5.415"></a><span id="l5.415">   mDecryptor = do_CreateInstance(PGPMIME_JS_DECRYPTOR_CONTRACTID, &amp;rv);</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineminus">-    mDecryptor = nullptr;</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+  if (NS_FAILED(rv)) mDecryptor = nullptr;</span>
<a href="#l5.419"></a><span id="l5.419"> </span>
<a href="#l5.420"></a><span id="l5.420">   return NS_OK;</span>
<a href="#l5.421"></a><span id="l5.421"> }</span>
<a href="#l5.422"></a><span id="l5.422"> </span>
<a href="#l5.423"></a><span id="l5.423"> NS_IMETHODIMP</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineminus">-nsPgpMimeProxy::Write(const char *buf, uint32_t buf_size)</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineminus">-{</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+nsPgpMimeProxy::Write(const char *buf, uint32_t buf_size) {</span>
<a href="#l5.427"></a><span id="l5.427">   NS_ENSURE_TRUE(mInitialized, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.428"></a><span id="l5.428"> </span>
<a href="#l5.429"></a><span id="l5.429">   mByteBuf.Assign(buf, buf_size);</span>
<a href="#l5.430"></a><span id="l5.430">   mStreamOffset = 0;</span>
<a href="#l5.431"></a><span id="l5.431"> </span>
<a href="#l5.432"></a><span id="l5.432">   // Pass data to the decryption object for decryption.</span>
<a href="#l5.433"></a><span id="l5.433">   // The result is returned via OutputDecryptedData().</span>
<a href="#l5.434"></a><span id="l5.434">   if (mDecryptor)</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineminus">-    return mDecryptor-&gt;OnDataAvailable((nsIRequest*) this, (nsIInputStream*) this,</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineminus">-                                      0, buf_size);</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+    return mDecryptor-&gt;OnDataAvailable((nsIRequest *)this,</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+                                       (nsIInputStream *)this, 0, buf_size);</span>
<a href="#l5.439"></a><span id="l5.439"> </span>
<a href="#l5.440"></a><span id="l5.440">   return NS_OK;</span>
<a href="#l5.441"></a><span id="l5.441"> }</span>
<a href="#l5.442"></a><span id="l5.442"> </span>
<a href="#l5.443"></a><span id="l5.443"> NS_IMETHODIMP</span>
<a href="#l5.444"></a><span id="l5.444"> nsPgpMimeProxy::Finish() {</span>
<a href="#l5.445"></a><span id="l5.445">   NS_ENSURE_TRUE(mInitialized, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.446"></a><span id="l5.446"> </span>
<a href="#l5.447"></a><span id="l5.447">   if (mDecryptor) {</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineminus">-    return mDecryptor-&gt;OnStopRequest((nsIRequest*) this, NS_OK);</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineminus">-  }</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineminus">-  else {</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineminus">-</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineminus">-    if (!mOutputFun)</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+    return mDecryptor-&gt;OnStopRequest((nsIRequest *)this, NS_OK);</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+  } else {</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+    if (!mOutputFun) return NS_ERROR_FAILURE;</span>
<a href="#l5.457"></a><span id="l5.457"> </span>
<a href="#l5.458"></a><span id="l5.458">     nsCString temp;</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineminus">-    temp.AppendLiteral(&quot;Content-Type: text/html; Charset=utf-8\r\n\r\n&lt;html&gt;&lt;body&gt;&quot;);</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineminus">-    temp.AppendLiteral(&quot;&lt;BR&gt;&lt;text=\&quot;#000000\&quot; bgcolor=\&quot;#FFFFFF\&quot; link=\&quot;#FF0000\&quot; vlink=\&quot;#800080\&quot; alink=\&quot;#0000FF\&quot;&gt;&quot;);</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+    temp.AppendLiteral(</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineplus">+        &quot;Content-Type: text/html; Charset=utf-8\r\n\r\n&lt;html&gt;&lt;body&gt;&quot;);</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineplus">+    temp.AppendLiteral(</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineplus">+        &quot;&lt;BR&gt;&lt;text=\&quot;#000000\&quot; bgcolor=\&quot;#FFFFFF\&quot; link=\&quot;#FF0000\&quot; &quot;</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineplus">+        &quot;vlink=\&quot;#800080\&quot; alink=\&quot;#0000FF\&quot;&gt;&quot;);</span>
<a href="#l5.466"></a><span id="l5.466">     temp.AppendLiteral(&quot;&lt;center&gt;&lt;table BORDER=1 &gt;&lt;tr&gt;&lt;td&gt;&lt;CENTER&gt;&quot;);</span>
<a href="#l5.467"></a><span id="l5.467"> </span>
<a href="#l5.468"></a><span id="l5.468">     nsCString tString;</span>
<a href="#l5.469"></a><span id="l5.469">     PgpMimeGetNeedsAddonString(tString);</span>
<a href="#l5.470"></a><span id="l5.470">     temp.Append(tString);</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineminus">-    temp.AppendLiteral(&quot;&lt;/CENTER&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/center&gt;&lt;BR&gt;&lt;/body&gt;&lt;/html&gt;\r\n&quot;);</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+    temp.AppendLiteral(</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+        &quot;&lt;/CENTER&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/center&gt;&lt;BR&gt;&lt;/body&gt;&lt;/html&gt;\r\n&quot;);</span>
<a href="#l5.474"></a><span id="l5.474"> </span>
<a href="#l5.475"></a><span id="l5.475" class="difflineminus">-    PR_SetError(0,0);</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+    PR_SetError(0, 0);</span>
<a href="#l5.477"></a><span id="l5.477">     int status = mOutputFun(temp.get(), temp.Length(), mOutputClosure);</span>
<a href="#l5.478"></a><span id="l5.478">     if (status &lt; 0) {</span>
<a href="#l5.479"></a><span id="l5.479">       PR_SetError(status, 0);</span>
<a href="#l5.480"></a><span id="l5.480">       mOutputFun = nullptr;</span>
<a href="#l5.481"></a><span id="l5.481">       return NS_ERROR_FAILURE;</span>
<a href="#l5.482"></a><span id="l5.482">     }</span>
<a href="#l5.483"></a><span id="l5.483">   }</span>
<a href="#l5.484"></a><span id="l5.484"> </span>
<a href="#l5.485"></a><span id="l5.485">   return NS_OK;</span>
<a href="#l5.486"></a><span id="l5.486"> }</span>
<a href="#l5.487"></a><span id="l5.487"> </span>
<a href="#l5.488"></a><span id="l5.488"> NS_IMETHODIMP</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineminus">-nsPgpMimeProxy::GetDecryptor(nsIStreamListener **aDecryptor)</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineminus">-{</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+nsPgpMimeProxy::GetDecryptor(nsIStreamListener **aDecryptor) {</span>
<a href="#l5.492"></a><span id="l5.492">   NS_IF_ADDREF(*aDecryptor = mDecryptor);</span>
<a href="#l5.493"></a><span id="l5.493">   return NS_OK;</span>
<a href="#l5.494"></a><span id="l5.494"> }</span>
<a href="#l5.495"></a><span id="l5.495"> </span>
<a href="#l5.496"></a><span id="l5.496"> NS_IMETHODIMP</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineminus">-nsPgpMimeProxy::SetDecryptor(nsIStreamListener *aDecryptor)</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineminus">-{</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+nsPgpMimeProxy::SetDecryptor(nsIStreamListener *aDecryptor) {</span>
<a href="#l5.500"></a><span id="l5.500">   mDecryptor = aDecryptor;</span>
<a href="#l5.501"></a><span id="l5.501"> </span>
<a href="#l5.502"></a><span id="l5.502">   return NS_OK;</span>
<a href="#l5.503"></a><span id="l5.503"> }</span>
<a href="#l5.504"></a><span id="l5.504"> </span>
<a href="#l5.505"></a><span id="l5.505" class="difflineminus">-</span>
<a href="#l5.506"></a><span id="l5.506"> NS_IMETHODIMP</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineminus">-nsPgpMimeProxy::GetContentType(nsACString &amp;aContentType)</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineminus">-{</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+nsPgpMimeProxy::GetContentType(nsACString &amp;aContentType) {</span>
<a href="#l5.510"></a><span id="l5.510">   aContentType = mContentType;</span>
<a href="#l5.511"></a><span id="l5.511">   return NS_OK;</span>
<a href="#l5.512"></a><span id="l5.512"> }</span>
<a href="#l5.513"></a><span id="l5.513"> </span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-</span>
<a href="#l5.515"></a><span id="l5.515"> NS_IMETHODIMP</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineminus">-nsPgpMimeProxy::SetContentType(const nsACString &amp;aContentType)</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineminus">-{</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+nsPgpMimeProxy::SetContentType(const nsACString &amp;aContentType) {</span>
<a href="#l5.519"></a><span id="l5.519">   mContentType = aContentType;</span>
<a href="#l5.520"></a><span id="l5.520"> </span>
<a href="#l5.521"></a><span id="l5.521">   return NS_OK;</span>
<a href="#l5.522"></a><span id="l5.522"> }</span>
<a href="#l5.523"></a><span id="l5.523"> </span>
<a href="#l5.524"></a><span id="l5.524" class="difflineminus">-</span>
<a href="#l5.525"></a><span id="l5.525"> NS_IMETHODIMP</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineminus">-nsPgpMimeProxy::GetMessageURI(nsIURI **aMessageURI)</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineminus">-{</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineplus">+nsPgpMimeProxy::GetMessageURI(nsIURI **aMessageURI) {</span>
<a href="#l5.529"></a><span id="l5.529">   NS_IF_ADDREF(*aMessageURI = mMessageURI);</span>
<a href="#l5.530"></a><span id="l5.530">   return NS_OK;</span>
<a href="#l5.531"></a><span id="l5.531"> }</span>
<a href="#l5.532"></a><span id="l5.532"> </span>
<a href="#l5.533"></a><span id="l5.533" class="difflineminus">-</span>
<a href="#l5.534"></a><span id="l5.534"> NS_IMETHODIMP</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineminus">-nsPgpMimeProxy::GetMimePart(nsACString &amp;aMimePart)</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-{</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+nsPgpMimeProxy::GetMimePart(nsACString &amp;aMimePart) {</span>
<a href="#l5.538"></a><span id="l5.538">   aMimePart = mMimePart;</span>
<a href="#l5.539"></a><span id="l5.539">   return NS_OK;</span>
<a href="#l5.540"></a><span id="l5.540"> }</span>
<a href="#l5.541"></a><span id="l5.541"> </span>
<a href="#l5.542"></a><span id="l5.542" class="difflineminus">-</span>
<a href="#l5.543"></a><span id="l5.543"> NS_IMETHODIMP</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineminus">-nsPgpMimeProxy::SetMimePart(const nsACString &amp;aMimePart)</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineminus">-{</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+nsPgpMimeProxy::SetMimePart(const nsACString &amp;aMimePart) {</span>
<a href="#l5.547"></a><span id="l5.547">   mMimePart = aMimePart;</span>
<a href="#l5.548"></a><span id="l5.548">   return NS_OK;</span>
<a href="#l5.549"></a><span id="l5.549"> }</span>
<a href="#l5.550"></a><span id="l5.550"> </span>
<a href="#l5.551"></a><span id="l5.551"> /**</span>
<a href="#l5.552"></a><span id="l5.552">  * This method is called by the add-on-supplied decryption object.</span>
<a href="#l5.553"></a><span id="l5.553">  * It passes the decrypted data back to the proxy which calls the</span>
<a href="#l5.554"></a><span id="l5.554">  * output function is was initialised with.</span>
<a href="#l5.555"></a><span id="l5.555">  */</span>
<a href="#l5.556"></a><span id="l5.556"> NS_IMETHODIMP</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineminus">-nsPgpMimeProxy::OutputDecryptedData(const char *buf, uint32_t buf_size)</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineminus">-{</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineplus">+nsPgpMimeProxy::OutputDecryptedData(const char *buf, uint32_t buf_size) {</span>
<a href="#l5.560"></a><span id="l5.560">   NS_ENSURE_TRUE(mInitialized, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.561"></a><span id="l5.561"> </span>
<a href="#l5.562"></a><span id="l5.562">   NS_ENSURE_ARG(buf);</span>
<a href="#l5.563"></a><span id="l5.563"> </span>
<a href="#l5.564"></a><span id="l5.564" class="difflineminus">-  if (!mOutputFun)</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+  if (!mOutputFun) return NS_ERROR_FAILURE;</span>
<a href="#l5.567"></a><span id="l5.567"> </span>
<a href="#l5.568"></a><span id="l5.568">   int status = mOutputFun(buf, buf_size, mOutputClosure);</span>
<a href="#l5.569"></a><span id="l5.569">   if (status &lt; 0) {</span>
<a href="#l5.570"></a><span id="l5.570">     PR_SetError(status, 0);</span>
<a href="#l5.571"></a><span id="l5.571">     mOutputFun = nullptr;</span>
<a href="#l5.572"></a><span id="l5.572">     return NS_ERROR_FAILURE;</span>
<a href="#l5.573"></a><span id="l5.573">   }</span>
<a href="#l5.574"></a><span id="l5.574"> </span>
<a href="#l5.575"></a><span id="l5.575">   return NS_OK;</span>
<a href="#l5.576"></a><span id="l5.576"> }</span>
<a href="#l5.577"></a><span id="l5.577"> </span>
<a href="#l5.578"></a><span id="l5.578"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.579"></a><span id="l5.579"> // nsIRequest methods</span>
<a href="#l5.580"></a><span id="l5.580"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.581"></a><span id="l5.581"> </span>
<a href="#l5.582"></a><span id="l5.582"> NS_IMETHODIMP</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineminus">-nsPgpMimeProxy::GetName(nsACString &amp;result)</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineminus">-{</span>
<a href="#l5.585"></a><span id="l5.585" class="difflineplus">+nsPgpMimeProxy::GetName(nsACString &amp;result) {</span>
<a href="#l5.586"></a><span id="l5.586">   result = &quot;pgpmimeproxy&quot;;</span>
<a href="#l5.587"></a><span id="l5.587">   return NS_OK;</span>
<a href="#l5.588"></a><span id="l5.588"> }</span>
<a href="#l5.589"></a><span id="l5.589"> </span>
<a href="#l5.590"></a><span id="l5.590"> NS_IMETHODIMP</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineminus">-nsPgpMimeProxy::IsPending(bool *result)</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineminus">-{</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineplus">+nsPgpMimeProxy::IsPending(bool *result) {</span>
<a href="#l5.594"></a><span id="l5.594">   NS_ENSURE_TRUE(mInitialized, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.595"></a><span id="l5.595"> </span>
<a href="#l5.596"></a><span id="l5.596">   *result = NS_SUCCEEDED(mCancelStatus);</span>
<a href="#l5.597"></a><span id="l5.597">   return NS_OK;</span>
<a href="#l5.598"></a><span id="l5.598"> }</span>
<a href="#l5.599"></a><span id="l5.599"> </span>
<a href="#l5.600"></a><span id="l5.600"> NS_IMETHODIMP</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineminus">-nsPgpMimeProxy::GetStatus(nsresult *status)</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineminus">-{</span>
<a href="#l5.603"></a><span id="l5.603" class="difflineplus">+nsPgpMimeProxy::GetStatus(nsresult *status) {</span>
<a href="#l5.604"></a><span id="l5.604">   NS_ENSURE_TRUE(mInitialized, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.605"></a><span id="l5.605"> </span>
<a href="#l5.606"></a><span id="l5.606">   *status = mCancelStatus;</span>
<a href="#l5.607"></a><span id="l5.607">   return NS_OK;</span>
<a href="#l5.608"></a><span id="l5.608"> }</span>
<a href="#l5.609"></a><span id="l5.609"> </span>
<a href="#l5.610"></a><span id="l5.610"> // NOTE: We assume that OnStopRequest should not be called if</span>
<a href="#l5.611"></a><span id="l5.611"> // request is canceled. This may be wrong!</span>
<a href="#l5.612"></a><span id="l5.612"> NS_IMETHODIMP</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineminus">-nsPgpMimeProxy::Cancel(nsresult status)</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineminus">-{</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineplus">+nsPgpMimeProxy::Cancel(nsresult status) {</span>
<a href="#l5.616"></a><span id="l5.616">   NS_ENSURE_TRUE(mInitialized, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.617"></a><span id="l5.617"> </span>
<a href="#l5.618"></a><span id="l5.618">   // Need a non-zero status code to cancel</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineminus">-  if (NS_SUCCEEDED(status))</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineplus">+  if (NS_SUCCEEDED(status)) return NS_ERROR_FAILURE;</span>
<a href="#l5.622"></a><span id="l5.622"> </span>
<a href="#l5.623"></a><span id="l5.623" class="difflineminus">-  if (NS_SUCCEEDED(mCancelStatus))</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineminus">-    mCancelStatus = status;</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineplus">+  if (NS_SUCCEEDED(mCancelStatus)) mCancelStatus = status;</span>
<a href="#l5.626"></a><span id="l5.626"> </span>
<a href="#l5.627"></a><span id="l5.627">   return NS_OK;</span>
<a href="#l5.628"></a><span id="l5.628"> }</span>
<a href="#l5.629"></a><span id="l5.629"> </span>
<a href="#l5.630"></a><span id="l5.630"> NS_IMETHODIMP</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineminus">-nsPgpMimeProxy::Suspend(void)</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineminus">-{</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineminus">-}</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineplus">+nsPgpMimeProxy::Suspend(void) { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l5.636"></a><span id="l5.636"> </span>
<a href="#l5.637"></a><span id="l5.637"> NS_IMETHODIMP</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineminus">-nsPgpMimeProxy::Resume(void)</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineminus">-{</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.641"></a><span id="l5.641" class="difflineminus">-}</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineplus">+nsPgpMimeProxy::Resume(void) { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l5.643"></a><span id="l5.643"> </span>
<a href="#l5.644"></a><span id="l5.644"> NS_IMETHODIMP</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineminus">-nsPgpMimeProxy::GetLoadGroup(nsILoadGroup * *aLoadGroup)</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineminus">-{</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineplus">+nsPgpMimeProxy::GetLoadGroup(nsILoadGroup **aLoadGroup) {</span>
<a href="#l5.648"></a><span id="l5.648">   NS_IF_ADDREF(*aLoadGroup = mLoadGroup);</span>
<a href="#l5.649"></a><span id="l5.649">   return NS_OK;</span>
<a href="#l5.650"></a><span id="l5.650"> }</span>
<a href="#l5.651"></a><span id="l5.651"> </span>
<a href="#l5.652"></a><span id="l5.652"> NS_IMETHODIMP</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineminus">-nsPgpMimeProxy::SetLoadGroup(nsILoadGroup* aLoadGroup)</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineminus">-{</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineplus">+nsPgpMimeProxy::SetLoadGroup(nsILoadGroup *aLoadGroup) {</span>
<a href="#l5.656"></a><span id="l5.656">   mLoadGroup = aLoadGroup;</span>
<a href="#l5.657"></a><span id="l5.657">   return NS_OK;</span>
<a href="#l5.658"></a><span id="l5.658"> }</span>
<a href="#l5.659"></a><span id="l5.659"> </span>
<a href="#l5.660"></a><span id="l5.660"> NS_IMETHODIMP</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineminus">-nsPgpMimeProxy::GetLoadFlags(nsLoadFlags *aLoadFlags)</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineminus">-{</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineplus">+nsPgpMimeProxy::GetLoadFlags(nsLoadFlags *aLoadFlags) {</span>
<a href="#l5.664"></a><span id="l5.664">   *aLoadFlags = mLoadFlags;</span>
<a href="#l5.665"></a><span id="l5.665">   return NS_OK;</span>
<a href="#l5.666"></a><span id="l5.666"> }</span>
<a href="#l5.667"></a><span id="l5.667"> </span>
<a href="#l5.668"></a><span id="l5.668"> NS_IMETHODIMP</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineminus">-nsPgpMimeProxy::SetLoadFlags(nsLoadFlags aLoadFlags)</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineminus">-{</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineplus">+nsPgpMimeProxy::SetLoadFlags(nsLoadFlags aLoadFlags) {</span>
<a href="#l5.672"></a><span id="l5.672">   mLoadFlags = aLoadFlags;</span>
<a href="#l5.673"></a><span id="l5.673">   return NS_OK;</span>
<a href="#l5.674"></a><span id="l5.674"> }</span>
<a href="#l5.675"></a><span id="l5.675"> </span>
<a href="#l5.676"></a><span id="l5.676"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.677"></a><span id="l5.677"> // nsIInputStream methods</span>
<a href="#l5.678"></a><span id="l5.678"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.679"></a><span id="l5.679"> </span>
<a href="#l5.680"></a><span id="l5.680"> NS_IMETHODIMP</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineminus">-nsPgpMimeProxy::Available(uint64_t* _retval)</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineminus">-{</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineplus">+nsPgpMimeProxy::Available(uint64_t *_retval) {</span>
<a href="#l5.684"></a><span id="l5.684">   NS_ENSURE_ARG(_retval);</span>
<a href="#l5.685"></a><span id="l5.685"> </span>
<a href="#l5.686"></a><span id="l5.686">   NS_ENSURE_TRUE(mInitialized, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.687"></a><span id="l5.687"> </span>
<a href="#l5.688"></a><span id="l5.688" class="difflineminus">-  *_retval = (mByteBuf.Length() &gt; mStreamOffset) ?</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineminus">-              mByteBuf.Length() - mStreamOffset : 0;</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineplus">+  *_retval = (mByteBuf.Length() &gt; mStreamOffset)</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineplus">+                 ? mByteBuf.Length() - mStreamOffset</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineplus">+                 : 0;</span>
<a href="#l5.693"></a><span id="l5.693"> </span>
<a href="#l5.694"></a><span id="l5.694">   return NS_OK;</span>
<a href="#l5.695"></a><span id="l5.695"> }</span>
<a href="#l5.696"></a><span id="l5.696"> </span>
<a href="#l5.697"></a><span id="l5.697"> NS_IMETHODIMP</span>
<a href="#l5.698"></a><span id="l5.698" class="difflineminus">-nsPgpMimeProxy::Read(char* buf, uint32_t count, uint32_t *readCount)</span>
<a href="#l5.699"></a><span id="l5.699" class="difflineminus">-{</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineplus">+nsPgpMimeProxy::Read(char *buf, uint32_t count, uint32_t *readCount) {</span>
<a href="#l5.701"></a><span id="l5.701">   NS_ENSURE_TRUE(mInitialized, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.702"></a><span id="l5.702"> </span>
<a href="#l5.703"></a><span id="l5.703" class="difflineminus">-  if (!buf || !readCount)</span>
<a href="#l5.704"></a><span id="l5.704" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineplus">+  if (!buf || !readCount) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.706"></a><span id="l5.706"> </span>
<a href="#l5.707"></a><span id="l5.707" class="difflineminus">-  int32_t avail = (mByteBuf.Length() &gt; mStreamOffset) ?</span>
<a href="#l5.708"></a><span id="l5.708" class="difflineminus">-                   mByteBuf.Length() - mStreamOffset : 0;</span>
<a href="#l5.709"></a><span id="l5.709" class="difflineplus">+  int32_t avail = (mByteBuf.Length() &gt; mStreamOffset)</span>
<a href="#l5.710"></a><span id="l5.710" class="difflineplus">+                      ? mByteBuf.Length() - mStreamOffset</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineplus">+                      : 0;</span>
<a href="#l5.712"></a><span id="l5.712"> </span>
<a href="#l5.713"></a><span id="l5.713" class="difflineminus">-  uint32_t readyCount = ((uint32_t) avail &gt; count) ? count : avail;</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineplus">+  uint32_t readyCount = ((uint32_t)avail &gt; count) ? count : avail;</span>
<a href="#l5.715"></a><span id="l5.715"> </span>
<a href="#l5.716"></a><span id="l5.716">   if (readyCount) {</span>
<a href="#l5.717"></a><span id="l5.717" class="difflineminus">-    memcpy(buf, mByteBuf.get()+mStreamOffset, readyCount);</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineplus">+    memcpy(buf, mByteBuf.get() + mStreamOffset, readyCount);</span>
<a href="#l5.719"></a><span id="l5.719">     *readCount = readyCount;</span>
<a href="#l5.720"></a><span id="l5.720">   }</span>
<a href="#l5.721"></a><span id="l5.721"> </span>
<a href="#l5.722"></a><span id="l5.722">   mStreamOffset += *readCount;</span>
<a href="#l5.723"></a><span id="l5.723"> </span>
<a href="#l5.724"></a><span id="l5.724">   return NS_OK;</span>
<a href="#l5.725"></a><span id="l5.725"> }</span>
<a href="#l5.726"></a><span id="l5.726"> </span>
<a href="#l5.727"></a><span id="l5.727"> NS_IMETHODIMP</span>
<a href="#l5.728"></a><span id="l5.728" class="difflineminus">-nsPgpMimeProxy::ReadSegments(nsWriteSegmentFun writer,</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineminus">-                             void * aClosure, uint32_t count,</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineminus">-                             uint32_t *readCount)</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineminus">-{</span>
<a href="#l5.732"></a><span id="l5.732" class="difflineplus">+nsPgpMimeProxy::ReadSegments(nsWriteSegmentFun writer, void *aClosure,</span>
<a href="#l5.733"></a><span id="l5.733" class="difflineplus">+                             uint32_t count, uint32_t *readCount) {</span>
<a href="#l5.734"></a><span id="l5.734">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.735"></a><span id="l5.735"> }</span>
<a href="#l5.736"></a><span id="l5.736"> </span>
<a href="#l5.737"></a><span id="l5.737"> NS_IMETHODIMP</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineminus">-nsPgpMimeProxy::IsNonBlocking(bool *aNonBlocking)</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineminus">-{</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineplus">+nsPgpMimeProxy::IsNonBlocking(bool *aNonBlocking) {</span>
<a href="#l5.741"></a><span id="l5.741">   NS_ENSURE_TRUE(mInitialized, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.742"></a><span id="l5.742"> </span>
<a href="#l5.743"></a><span id="l5.743">   *aNonBlocking = true;</span>
<a href="#l5.744"></a><span id="l5.744">   return NS_OK;</span>
<a href="#l5.745"></a><span id="l5.745"> }</span>
<a href="#l5.746"></a><span id="l5.746"> </span>
<a href="#l5.747"></a><span id="l5.747"> NS_IMETHODIMP</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineminus">-nsPgpMimeProxy::Close()</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineminus">-{</span>
<a href="#l5.750"></a><span id="l5.750" class="difflineplus">+nsPgpMimeProxy::Close() {</span>
<a href="#l5.751"></a><span id="l5.751">   NS_ENSURE_TRUE(mInitialized, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.752"></a><span id="l5.752"> </span>
<a href="#l5.753"></a><span id="l5.753">   mStreamOffset = 0;</span>
<a href="#l5.754"></a><span id="l5.754">   mByteBuf.Truncate();</span>
<a href="#l5.755"></a><span id="l5.755"> </span>
<a href="#l5.756"></a><span id="l5.756">   return NS_OK;</span>
<a href="#l5.757"></a><span id="l5.757"> }</span>
<a href="#l5.758"></a><span id="l5.758"> </span>
<a href="#l5.759"></a><span id="l5.759"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.760"></a><span id="l5.760"> // nsIStreamListener methods</span>
<a href="#l5.761"></a><span id="l5.761"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.762"></a><span id="l5.762"> </span>
<a href="#l5.763"></a><span id="l5.763"> NS_IMETHODIMP</span>
<a href="#l5.764"></a><span id="l5.764" class="difflineminus">-nsPgpMimeProxy::OnStartRequest(nsIRequest *aRequest)</span>
<a href="#l5.765"></a><span id="l5.765" class="difflineminus">-{</span>
<a href="#l5.766"></a><span id="l5.766" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.767"></a><span id="l5.767" class="difflineminus">-}</span>
<a href="#l5.768"></a><span id="l5.768" class="difflineplus">+nsPgpMimeProxy::OnStartRequest(nsIRequest *aRequest) { return NS_OK; }</span>
<a href="#l5.769"></a><span id="l5.769"> </span>
<a href="#l5.770"></a><span id="l5.770"> NS_IMETHODIMP</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineminus">-nsPgpMimeProxy::OnStopRequest(nsIRequest* aRequest, nsresult aStatus)</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineminus">-{</span>
<a href="#l5.773"></a><span id="l5.773" class="difflineplus">+nsPgpMimeProxy::OnStopRequest(nsIRequest *aRequest, nsresult aStatus) {</span>
<a href="#l5.774"></a><span id="l5.774">   return NS_OK;</span>
<a href="#l5.775"></a><span id="l5.775"> }</span>
<a href="#l5.776"></a><span id="l5.776"> </span>
<a href="#l5.777"></a><span id="l5.777"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.778"></a><span id="l5.778"> // nsIStreamListener method</span>
<a href="#l5.779"></a><span id="l5.779"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.780"></a><span id="l5.780"> </span>
<a href="#l5.781"></a><span id="l5.781"> NS_IMETHODIMP</span>
<a href="#l5.782"></a><span id="l5.782" class="difflineminus">-nsPgpMimeProxy::OnDataAvailable(nsIRequest* aRequest,</span>
<a href="#l5.783"></a><span id="l5.783" class="difflineminus">-                              nsIInputStream *aInputStream,</span>
<a href="#l5.784"></a><span id="l5.784" class="difflineminus">-                              uint64_t aSourceOffset,</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineminus">-                              uint32_t aLength)</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineminus">-{</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineplus">+nsPgpMimeProxy::OnDataAvailable(nsIRequest *aRequest,</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineplus">+                                nsIInputStream *aInputStream,</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineplus">+                                uint64_t aSourceOffset, uint32_t aLength) {</span>
<a href="#l5.790"></a><span id="l5.790">   NS_ENSURE_TRUE(mInitialized, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l5.791"></a><span id="l5.791">   NS_ENSURE_ARG(aInputStream);</span>
<a href="#l5.792"></a><span id="l5.792"> </span>
<a href="#l5.793"></a><span id="l5.793" class="difflineminus">-  if (!mOutputFun)</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineplus">+  if (!mOutputFun) return NS_ERROR_FAILURE;</span>
<a href="#l5.796"></a><span id="l5.796"> </span>
<a href="#l5.797"></a><span id="l5.797">   char buf[kCharMax];</span>
<a href="#l5.798"></a><span id="l5.798">   uint32_t readCount, readMax;</span>
<a href="#l5.799"></a><span id="l5.799"> </span>
<a href="#l5.800"></a><span id="l5.800">   while (aLength &gt; 0) {</span>
<a href="#l5.801"></a><span id="l5.801">     readMax = (aLength &lt; kCharMax) ? aLength : kCharMax;</span>
<a href="#l5.802"></a><span id="l5.802"> </span>
<a href="#l5.803"></a><span id="l5.803">     nsresult rv;</span>
<a href="#l5.804"></a><span id="l5.804" class="difflineminus">-    rv = aInputStream-&gt;Read((char *) buf, readMax, &amp;readCount);</span>
<a href="#l5.805"></a><span id="l5.805" class="difflineplus">+    rv = aInputStream-&gt;Read((char *)buf, readMax, &amp;readCount);</span>
<a href="#l5.806"></a><span id="l5.806">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.807"></a><span id="l5.807"> </span>
<a href="#l5.808"></a><span id="l5.808">     int status = mOutputFun(buf, readCount, mOutputClosure);</span>
<a href="#l5.809"></a><span id="l5.809">     if (status &lt; 0) {</span>
<a href="#l5.810"></a><span id="l5.810">       PR_SetError(status, 0);</span>
<a href="#l5.811"></a><span id="l5.811">       mOutputFun = nullptr;</span>
<a href="#l5.812"></a><span id="l5.812">       return NS_ERROR_FAILURE;</span>
<a href="#l5.813"></a><span id="l5.813">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/mime/cthandlers/pgpmime/nsPgpMimeProxy.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -7,64 +7,63 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;mimecth.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsIPgpMimeProxy.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> #include &quot;nsILoadGroup.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-#define PGPMIME_JS_DECRYPTOR_CONTRACTID &quot;@mozilla.org/mime/pgp-mime-js-decrypt;1&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+#define PGPMIME_JS_DECRYPTOR_CONTRACTID \</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  &quot;@mozilla.org/mime/pgp-mime-js-decrypt;1&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> typedef struct MimeEncryptedPgpClass MimeEncryptedPgpClass;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-typedef struct MimeEncryptedPgp      MimeEncryptedPgp;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+typedef struct MimeEncryptedPgp MimeEncryptedPgp;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> struct MimeEncryptedPgpClass {</span>
<a href="#l6.21"></a><span id="l6.21">   MimeEncryptedClass encrypted;</span>
<a href="#l6.22"></a><span id="l6.22"> };</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24"> struct MimeEncryptedPgp {</span>
<a href="#l6.25"></a><span id="l6.25">   MimeEncrypted encrypted;</span>
<a href="#l6.26"></a><span id="l6.26"> };</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28"> class nsPgpMimeProxy : public nsIPgpMimeProxy,</span>
<a href="#l6.29"></a><span id="l6.29">                        public nsIRequest,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-                       public nsIInputStream</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-{</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-public:</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+                       public nsIInputStream {</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+ public:</span>
<a href="#l6.35"></a><span id="l6.35">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l6.36"></a><span id="l6.36">   NS_DECL_NSIPGPMIMEPROXY</span>
<a href="#l6.37"></a><span id="l6.37">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l6.38"></a><span id="l6.38">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l6.39"></a><span id="l6.39">   NS_DECL_NSIREQUEST</span>
<a href="#l6.40"></a><span id="l6.40">   NS_DECL_NSIINPUTSTREAM</span>
<a href="#l6.41"></a><span id="l6.41"> </span>
<a href="#l6.42"></a><span id="l6.42">   nsPgpMimeProxy();</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44">   // Define a Create method to be used with a factory:</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-  static nsresult</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-  Create(nsISupports *aOuter, REFNSIID aIID, void **aResult);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+  static nsresult Create(nsISupports *aOuter, REFNSIID aIID, void **aResult);</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-protected:</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+ protected:</span>
<a href="#l6.51"></a><span id="l6.51">   virtual ~nsPgpMimeProxy();</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-  bool                          mInitialized;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-  nsCOMPtr&lt;nsIStreamListener&gt;   mDecryptor;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  bool mInitialized;</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+  nsCOMPtr&lt;nsIStreamListener&gt; mDecryptor;</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  MimeDecodeCallbackFun         mOutputFun;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  void*                         mOutputClosure;</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  MimeDecodeCallbackFun mOutputFun;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  void *mOutputClosure;</span>
<a href="#l6.61"></a><span id="l6.61"> </span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-  nsCOMPtr&lt;nsILoadGroup&gt;        mLoadGroup;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-  nsLoadFlags                   mLoadFlags;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-  nsresult                      mCancelStatus;</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+  nsCOMPtr&lt;nsILoadGroup&gt; mLoadGroup;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  nsLoadFlags mLoadFlags;</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  nsresult mCancelStatus;</span>
<a href="#l6.68"></a><span id="l6.68"> </span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-  uint32_t                      mStreamOffset;</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-  nsCString                     mByteBuf;</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-  nsCString                     mContentType;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-  nsCString                     mMimePart;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  uint32_t mStreamOffset;</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  nsCString mByteBuf;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+  nsCString mContentType;</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+  nsCString mMimePart;</span>
<a href="#l6.77"></a><span id="l6.77"> </span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt;              mMessageURI;</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; mMessageURI;</span>
<a href="#l6.80"></a><span id="l6.80">   nsresult Finalize();</span>
<a href="#l6.81"></a><span id="l6.81"> };</span>
<a href="#l6.82"></a><span id="l6.82"> </span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-#define MimeEncryptedPgpClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-  { MimeEncryptedClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+#define MimeEncryptedPgpClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  { MimeEncryptedClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l6.87"></a><span id="l6.87"> </span>
<a href="#l6.88"></a><span id="l6.88"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/mime/cthandlers/vcard/mimevcrd.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/mime/cthandlers/vcard/mimevcrd.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -9,370 +9,358 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;mimexpcom.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsIMsgVCardService.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsINetUtil.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;prmem.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;prprf.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-static int MimeInlineTextVCard_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-static int MimeInlineTextVCard_parse_eof (MimeObject *, bool);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-static int MimeInlineTextVCard_parse_begin (MimeObject *obj);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+static int MimeInlineTextVCard_parse_line(const char *, int32_t, MimeObject *);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+static int MimeInlineTextVCard_parse_eof(MimeObject *, bool);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+static int MimeInlineTextVCard_parse_begin(MimeObject *obj);</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> static int s_unique = 0;</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-static int BeginVCard (MimeObject *obj);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-static int EndVCard (MimeObject *obj);</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-static int WriteOutVCard (MimeObject *obj, VObject* v);</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+static int BeginVCard(MimeObject *obj);</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+static int EndVCard(MimeObject *obj);</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+static int WriteOutVCard(MimeObject *obj, VObject *v);</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-static int GenerateVCardData(MimeObject * aMimeObj, VObject* aVcard);</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-static int OutputVcardAttribute(MimeObject *aMimeObj, VObject *aVcard, const char* id, nsACString&amp; vCardOutput);</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-static int OutputBasicVcard(MimeObject *aMimeObj, VObject *aVcard, nsACString&amp; vCardOutput);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+static int GenerateVCardData(MimeObject *aMimeObj, VObject *aVcard);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+static int OutputVcardAttribute(MimeObject *aMimeObj, VObject *aVcard,</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+                                const char *id, nsACString &amp;vCardOutput);</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+static int OutputBasicVcard(MimeObject *aMimeObj, VObject *aVcard,</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+                            nsACString &amp;vCardOutput);</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-typedef struct</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  {</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-    const char *attributeName;</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-    int resourceId;</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-  } AttributeName;</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+typedef struct {</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+  const char *attributeName;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+  int resourceId;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+} AttributeName;</span>
<a href="#l7.46"></a><span id="l7.46"> </span>
<a href="#l7.47"></a><span id="l7.47"> #define kNumAttributes 12</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-#define     MSGVCARDSERVICE_CONTRACT_ID &quot;@mozilla.org/addressbook/msgvcardservice;1&quot;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+#define MSGVCARDSERVICE_CONTRACT_ID &quot;@mozilla.org/addressbook/msgvcardservice;1&quot;</span>
<a href="#l7.51"></a><span id="l7.51"> </span>
<a href="#l7.52"></a><span id="l7.52"> /* This is the object definition. Note: we will set the superclass</span>
<a href="#l7.53"></a><span id="l7.53">    to NULL and manually set this on the class creation */</span>
<a href="#l7.54"></a><span id="l7.54"> MimeDefClass(MimeInlineTextVCard, MimeInlineTextVCardClass,</span>
<a href="#l7.55"></a><span id="l7.55">              mimeInlineTextVCardClass, NULL);</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-extern &quot;C&quot; MimeObjectClass *</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-MIME_VCardCreateContentTypeHandlerClass(const char *content_type,</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-                                   contentTypeHandlerInitStruct *initStruct)</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-{</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+extern &quot;C&quot; MimeObjectClass *MIME_VCardCreateContentTypeHandlerClass(</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+    const char *content_type, contentTypeHandlerInitStruct *initStruct) {</span>
<a href="#l7.63"></a><span id="l7.63">   MimeObjectClass *clazz = (MimeObjectClass *)&amp;mimeInlineTextVCardClass;</span>
<a href="#l7.64"></a><span id="l7.64">   /*</span>
<a href="#l7.65"></a><span id="l7.65">    * Must set the superclass by hand.</span>
<a href="#l7.66"></a><span id="l7.66">    */</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-  if (!COM_GetmimeInlineTextClass())</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    return NULL;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  if (!COM_GetmimeInlineTextClass()) return NULL;</span>
<a href="#l7.70"></a><span id="l7.70"> </span>
<a href="#l7.71"></a><span id="l7.71">   clazz-&gt;superclass = (MimeObjectClass *)COM_GetmimeInlineTextClass();</span>
<a href="#l7.72"></a><span id="l7.72">   initStruct-&gt;force_inline_display = true;</span>
<a href="#l7.73"></a><span id="l7.73">   return clazz;</span>
<a href="#l7.74"></a><span id="l7.74"> }</span>
<a href="#l7.75"></a><span id="l7.75"> </span>
<a href="#l7.76"></a><span id="l7.76"> /*</span>
<a href="#l7.77"></a><span id="l7.77">  * Implementation of VCard clazz</span>
<a href="#l7.78"></a><span id="l7.78">  */</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-static int</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-MimeInlineTextVCardClassInitialize(MimeInlineTextVCardClass *clazz)</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-{</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-  NS_ASSERTION(!oclass-&gt;class_initialized, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:11&quot;);</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+static int MimeInlineTextVCardClassInitialize(MimeInlineTextVCardClass *clazz) {</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+  NS_ASSERTION(!oclass-&gt;class_initialized,</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:11&quot;);</span>
<a href="#l7.88"></a><span id="l7.88">   oclass-&gt;parse_begin = MimeInlineTextVCard_parse_begin;</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-  oclass-&gt;parse_line  = MimeInlineTextVCard_parse_line;</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-  oclass-&gt;parse_eof   = MimeInlineTextVCard_parse_eof;</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+  oclass-&gt;parse_line = MimeInlineTextVCard_parse_line;</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  oclass-&gt;parse_eof = MimeInlineTextVCard_parse_eof;</span>
<a href="#l7.93"></a><span id="l7.93">   return 0;</span>
<a href="#l7.94"></a><span id="l7.94"> }</span>
<a href="#l7.95"></a><span id="l7.95"> </span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-static int</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-MimeInlineTextVCard_parse_begin (MimeObject *obj)</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-{</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-  int status = ((MimeObjectClass*)COM_GetmimeLeafClass())-&gt;parse_begin(obj);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+static int MimeInlineTextVCard_parse_begin(MimeObject *obj) {</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+  int status = ((MimeObjectClass *)COM_GetmimeLeafClass())-&gt;parse_begin(obj);</span>
<a href="#l7.102"></a><span id="l7.102">   MimeInlineTextVCardClass *clazz;</span>
<a href="#l7.103"></a><span id="l7.103">   if (status &lt; 0) return status;</span>
<a href="#l7.104"></a><span id="l7.104"> </span>
<a href="#l7.105"></a><span id="l7.105">   if (!obj-&gt;output_p) return 0;</span>
<a href="#l7.106"></a><span id="l7.106">   if (!obj-&gt;options || !obj-&gt;options-&gt;write_html_p) return 0;</span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108">   /* This is a fine place to write out any HTML before the real meat begins.</span>
<a href="#l7.109"></a><span id="l7.109">   In this sample code, we tell it to start a table. */</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-  clazz = ((MimeInlineTextVCardClass *) obj-&gt;clazz);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  clazz = ((MimeInlineTextVCardClass *)obj-&gt;clazz);</span>
<a href="#l7.113"></a><span id="l7.113">   /* initialize vcard string to empty; */</span>
<a href="#l7.114"></a><span id="l7.114">   NS_MsgSACopy(&amp;(clazz-&gt;vCardString), &quot;&quot;);</span>
<a href="#l7.115"></a><span id="l7.115"> </span>
<a href="#l7.116"></a><span id="l7.116">   obj-&gt;options-&gt;state-&gt;separator_suppressed_p = true;</span>
<a href="#l7.117"></a><span id="l7.117">   return 0;</span>
<a href="#l7.118"></a><span id="l7.118"> }</span>
<a href="#l7.119"></a><span id="l7.119"> </span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-char *strcpySafe (char *dest, const char *src, size_t destLength)</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-{</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-  char *result = strncpy (dest, src, --destLength);</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+char *strcpySafe(char *dest, const char *src, size_t destLength) {</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+  char *result = strncpy(dest, src, --destLength);</span>
<a href="#l7.125"></a><span id="l7.125">   dest[destLength] = '\0';</span>
<a href="#l7.126"></a><span id="l7.126">   return result;</span>
<a href="#l7.127"></a><span id="l7.127"> }</span>
<a href="#l7.128"></a><span id="l7.128"> </span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-static int</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-MimeInlineTextVCard_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-{</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+static int MimeInlineTextVCard_parse_line(const char *line, int32_t length,</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+                                          MimeObject *obj) {</span>
<a href="#l7.134"></a><span id="l7.134">   // This routine gets fed each line of data, one at a time.</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-  char* linestring;</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-  MimeInlineTextVCardClass *clazz = ((MimeInlineTextVCardClass *) obj-&gt;clazz);</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+  char *linestring;</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+  MimeInlineTextVCardClass *clazz = ((MimeInlineTextVCardClass *)obj-&gt;clazz);</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140">   if (!obj-&gt;output_p) return 0;</span>
<a href="#l7.141"></a><span id="l7.141">   if (!obj-&gt;options || !obj-&gt;options-&gt;output_fn) return 0;</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-  if (!obj-&gt;options-&gt;write_html_p)</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-  {</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  if (!obj-&gt;options-&gt;write_html_p) {</span>
<a href="#l7.145"></a><span id="l7.145">     return COM_MimeObject_write(obj, line, length, true);</span>
<a href="#l7.146"></a><span id="l7.146">   }</span>
<a href="#l7.147"></a><span id="l7.147"> </span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-  linestring = (char *) PR_MALLOC (length + 1);</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+  linestring = (char *)PR_MALLOC(length + 1);</span>
<a href="#l7.150"></a><span id="l7.150">   memset(linestring, 0, (length + 1));</span>
<a href="#l7.151"></a><span id="l7.151"> </span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-  if (linestring)</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-  {</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+  if (linestring) {</span>
<a href="#l7.155"></a><span id="l7.155">     strcpySafe((char *)linestring, line, length + 1);</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-    NS_MsgSACat (&amp;clazz-&gt;vCardString, linestring);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-    PR_Free (linestring);</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+    NS_MsgSACat(&amp;clazz-&gt;vCardString, linestring);</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+    PR_Free(linestring);</span>
<a href="#l7.160"></a><span id="l7.160">   }</span>
<a href="#l7.161"></a><span id="l7.161"> </span>
<a href="#l7.162"></a><span id="l7.162">   return 0;</span>
<a href="#l7.163"></a><span id="l7.163"> }</span>
<a href="#l7.164"></a><span id="l7.164"> </span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-</span>
<a href="#l7.166"></a><span id="l7.166"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-static int</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-MimeInlineTextVCard_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-{</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+static int MimeInlineTextVCard_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l7.171"></a><span id="l7.171">   nsCOMPtr&lt;nsIMsgVCardService&gt; vCardService =</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-             do_GetService(MSGVCARDSERVICE_CONTRACT_ID);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-  if (!vCardService)</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-      return -1;</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+      do_GetService(MSGVCARDSERVICE_CONTRACT_ID);</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+  if (!vCardService) return -1;</span>
<a href="#l7.177"></a><span id="l7.177"> </span>
<a href="#l7.178"></a><span id="l7.178">   int status = 0;</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-  MimeInlineTextVCardClass *clazz = ((MimeInlineTextVCardClass *) obj-&gt;clazz);</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+  MimeInlineTextVCardClass *clazz = ((MimeInlineTextVCardClass *)obj-&gt;clazz);</span>
<a href="#l7.181"></a><span id="l7.181"> </span>
<a href="#l7.182"></a><span id="l7.182">   VObject *t, *v;</span>
<a href="#l7.183"></a><span id="l7.183"> </span>
<a href="#l7.184"></a><span id="l7.184">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l7.185"></a><span id="l7.185"> </span>
<a href="#l7.186"></a><span id="l7.186">   /* Run parent method first, to flush out any buffered data. */</span>
<a href="#l7.187"></a><span id="l7.187">   //    status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-  status = ((MimeObjectClass*)COM_GetmimeInlineTextClass())-&gt;parse_eof(obj, abort_p);</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+  status = ((MimeObjectClass *)COM_GetmimeInlineTextClass())</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+               -&gt;parse_eof(obj, abort_p);</span>
<a href="#l7.191"></a><span id="l7.191">   if (status &lt; 0) return status;</span>
<a href="#l7.192"></a><span id="l7.192"> </span>
<a href="#l7.193"></a><span id="l7.193">   // Don't quote vCards...</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-  if (  (obj-&gt;options) &amp;&amp;</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-    ((obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting) ||</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-    (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting))</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-    )</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+  if ((obj-&gt;options) &amp;&amp;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+      ((obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting) ||</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting)))</span>
<a href="#l7.201"></a><span id="l7.201">     return 0;</span>
<a href="#l7.202"></a><span id="l7.202"> </span>
<a href="#l7.203"></a><span id="l7.203">   if (!clazz-&gt;vCardString) return 0;</span>
<a href="#l7.204"></a><span id="l7.204"> </span>
<a href="#l7.205"></a><span id="l7.205">   v = vCardService-&gt;Parse_MIME(clazz-&gt;vCardString, strlen(clazz-&gt;vCardString));</span>
<a href="#l7.206"></a><span id="l7.206">   NS_ASSERTION(v, &quot;parse of vCard failed&quot;);</span>
<a href="#l7.207"></a><span id="l7.207"> </span>
<a href="#l7.208"></a><span id="l7.208">   if (clazz-&gt;vCardString) {</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-    PR_Free ((char*) clazz-&gt;vCardString);</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+    PR_Free((char *)clazz-&gt;vCardString);</span>
<a href="#l7.211"></a><span id="l7.211">     clazz-&gt;vCardString = NULL;</span>
<a href="#l7.212"></a><span id="l7.212">   }</span>
<a href="#l7.213"></a><span id="l7.213"> </span>
<a href="#l7.214"></a><span id="l7.214">   if (obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-    obj-&gt;options-&gt;headers != MimeHeadersCitation) {</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+      obj-&gt;options-&gt;headers != MimeHeadersCitation) {</span>
<a href="#l7.217"></a><span id="l7.217">     /* This is a fine place to write any closing HTML.  In fact, you may</span>
<a href="#l7.218"></a><span id="l7.218">     want all the writing to be here, and all of the above would just</span>
<a href="#l7.219"></a><span id="l7.219">     collect data into datastructures, though that isn't very</span>
<a href="#l7.220"></a><span id="l7.220">     &quot;streaming&quot;. */</span>
<a href="#l7.221"></a><span id="l7.221">     t = v;</span>
<a href="#l7.222"></a><span id="l7.222">     while (v &amp;&amp; status &gt;= 0) {</span>
<a href="#l7.223"></a><span id="l7.223">       /* write out html */</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-      status = WriteOutVCard (obj, v);</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+      status = WriteOutVCard(obj, v);</span>
<a href="#l7.226"></a><span id="l7.226">       /* parse next vcard in case they're embedded */</span>
<a href="#l7.227"></a><span id="l7.227">       v = vCardService-&gt;NextVObjectInList(v);</span>
<a href="#l7.228"></a><span id="l7.228">     }</span>
<a href="#l7.229"></a><span id="l7.229"> </span>
<a href="#l7.230"></a><span id="l7.230">     (void)vCardService-&gt;CleanVObject(t);</span>
<a href="#l7.231"></a><span id="l7.231">   }</span>
<a href="#l7.232"></a><span id="l7.232"> </span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-    return status;</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l7.236"></a><span id="l7.236"> </span>
<a href="#l7.237"></a><span id="l7.237">   return 0;</span>
<a href="#l7.238"></a><span id="l7.238"> }</span>
<a href="#l7.239"></a><span id="l7.239"> </span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-static int EndVCard (MimeObject *obj)</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-{</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+static int EndVCard(MimeObject *obj) {</span>
<a href="#l7.243"></a><span id="l7.243">   int status = 0;</span>
<a href="#l7.244"></a><span id="l7.244"> </span>
<a href="#l7.245"></a><span id="l7.245">   /* Scribble HTML-ending stuff into the stream */</span>
<a href="#l7.246"></a><span id="l7.246">   char htmlFooters[32];</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-  PR_snprintf (htmlFooters, sizeof(htmlFooters), &quot;&lt;/BODY&gt;%s&lt;/HTML&gt;%s&quot;, MSG_LINEBREAK, MSG_LINEBREAK);</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+  PR_snprintf(htmlFooters, sizeof(htmlFooters), &quot;&lt;/BODY&gt;%s&lt;/HTML&gt;%s&quot;,</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+              MSG_LINEBREAK, MSG_LINEBREAK);</span>
<a href="#l7.250"></a><span id="l7.250">   status = COM_MimeObject_write(obj, htmlFooters, strlen(htmlFooters), false);</span>
<a href="#l7.251"></a><span id="l7.251"> </span>
<a href="#l7.252"></a><span id="l7.252">   if (status &lt; 0) return status;</span>
<a href="#l7.253"></a><span id="l7.253"> </span>
<a href="#l7.254"></a><span id="l7.254">   return 0;</span>
<a href="#l7.255"></a><span id="l7.255"> }</span>
<a href="#l7.256"></a><span id="l7.256"> </span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-static int BeginVCard (MimeObject *obj)</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-{</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+static int BeginVCard(MimeObject *obj) {</span>
<a href="#l7.260"></a><span id="l7.260">   int status = 0;</span>
<a href="#l7.261"></a><span id="l7.261"> </span>
<a href="#l7.262"></a><span id="l7.262">   /* Scribble HTML-starting stuff into the stream */</span>
<a href="#l7.263"></a><span id="l7.263">   char htmlHeaders[32];</span>
<a href="#l7.264"></a><span id="l7.264"> </span>
<a href="#l7.265"></a><span id="l7.265">   s_unique++;</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-  PR_snprintf (htmlHeaders, sizeof(htmlHeaders), &quot;&lt;HTML&gt;%s&lt;BODY&gt;%s&quot;, MSG_LINEBREAK, MSG_LINEBREAK);</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-    status = COM_MimeObject_write(obj, htmlHeaders, strlen(htmlHeaders), true);</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+  PR_snprintf(htmlHeaders, sizeof(htmlHeaders), &quot;&lt;HTML&gt;%s&lt;BODY&gt;%s&quot;,</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+              MSG_LINEBREAK, MSG_LINEBREAK);</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+  status = COM_MimeObject_write(obj, htmlHeaders, strlen(htmlHeaders), true);</span>
<a href="#l7.271"></a><span id="l7.271"> </span>
<a href="#l7.272"></a><span id="l7.272">   if (status &lt; 0) return status;</span>
<a href="#l7.273"></a><span id="l7.273"> </span>
<a href="#l7.274"></a><span id="l7.274">   return 0;</span>
<a href="#l7.275"></a><span id="l7.275"> }</span>
<a href="#l7.276"></a><span id="l7.276"> </span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-static int WriteOutVCard (MimeObject * aMimeObj, VObject* aVcard)</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-{</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-  BeginVCard (aMimeObj);</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+static int WriteOutVCard(MimeObject *aMimeObj, VObject *aVcard) {</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+  BeginVCard(aMimeObj);</span>
<a href="#l7.283"></a><span id="l7.283"> </span>
<a href="#l7.284"></a><span id="l7.284">   GenerateVCardData(aMimeObj, aVcard);</span>
<a href="#l7.285"></a><span id="l7.285"> </span>
<a href="#l7.286"></a><span id="l7.286" class="difflineminus">-  return EndVCard (aMimeObj);</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+  return EndVCard(aMimeObj);</span>
<a href="#l7.288"></a><span id="l7.288"> }</span>
<a href="#l7.289"></a><span id="l7.289"> </span>
<a href="#l7.290"></a><span id="l7.290" class="difflineminus">-</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-static int GenerateVCardData(MimeObject * aMimeObj, VObject* aVcard)</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-{</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+static int GenerateVCardData(MimeObject *aMimeObj, VObject *aVcard) {</span>
<a href="#l7.294"></a><span id="l7.294">   // style is driven from CSS not here. Just layout the minimal vCard data</span>
<a href="#l7.295"></a><span id="l7.295">   nsCString vCardOutput;</span>
<a href="#l7.296"></a><span id="l7.296"> </span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-  vCardOutput = &quot;&lt;table class=\&quot;moz-vcard-table\&quot;&gt; &lt;tr&gt; &quot;;  // outer table plus the first (and only row) we use for this table</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+  vCardOutput =</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+      &quot;&lt;table class=\&quot;moz-vcard-table\&quot;&gt; &lt;tr&gt; &quot;;  // outer table plus the first</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+                                                  // (and only row) we use for</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+                                                  // this table</span>
<a href="#l7.302"></a><span id="l7.302"> </span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-  // we need to get an escaped vCard url to bind to our add to address book button</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-  nsCOMPtr&lt;nsIMsgVCardService&gt; vCardService = do_GetService(MSGVCARDSERVICE_CONTRACT_ID);</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-  if (!vCardService)</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-      return -1;</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+  // we need to get an escaped vCard url to bind to our add to address book</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+  // button</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+  nsCOMPtr&lt;nsIMsgVCardService&gt; vCardService =</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+      do_GetService(MSGVCARDSERVICE_CONTRACT_ID);</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+  if (!vCardService) return -1;</span>
<a href="#l7.312"></a><span id="l7.312"> </span>
<a href="#l7.313"></a><span id="l7.313">   nsAutoCString vCard;</span>
<a href="#l7.314"></a><span id="l7.314">   nsAutoCString vEscCard;</span>
<a href="#l7.315"></a><span id="l7.315">   int len = 0;</span>
<a href="#l7.316"></a><span id="l7.316"> </span>
<a href="#l7.317"></a><span id="l7.317">   vCard.Adopt(vCardService-&gt;WriteMemoryVObjects(0, &amp;len, aVcard, false));</span>
<a href="#l7.318"></a><span id="l7.318">   MsgEscapeString(vCard, nsINetUtil::ESCAPE_XALPHAS, vEscCard);</span>
<a href="#l7.319"></a><span id="l7.319"> </span>
<a href="#l7.320"></a><span id="l7.320" class="difflineminus">-  // first cell in the outer table row is a clickable image which brings up the rich address book UI for the vcard</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineminus">-  vCardOutput += &quot;&lt;td valign=\&quot;top\&quot;&gt; &lt;a class=\&quot;moz-vcard-badge\&quot; href=\&quot;addbook:add?action=add?vcard=&quot;;</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineminus">-  vCardOutput += vEscCard; // the href is the vCard</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+  // first cell in the outer table row is a clickable image which brings up the</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+  // rich address book UI for the vcard</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+  vCardOutput +=</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+      &quot;&lt;td valign=\&quot;top\&quot;&gt; &lt;a class=\&quot;moz-vcard-badge\&quot; &quot;</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+      &quot;href=\&quot;addbook:add?action=add?vcard=&quot;;</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+  vCardOutput += vEscCard;  // the href is the vCard</span>
<a href="#l7.329"></a><span id="l7.329">   vCardOutput += &quot;\&quot;&gt;&lt;/a&gt;&lt;/td&gt;&quot;;</span>
<a href="#l7.330"></a><span id="l7.330"> </span>
<a href="#l7.331"></a><span id="l7.331" class="difflineminus">-  // the 2nd cell in the outer table row is a nested table containing the actual vCard properties</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+  // the 2nd cell in the outer table row is a nested table containing the actual</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+  // vCard properties</span>
<a href="#l7.334"></a><span id="l7.334">   vCardOutput += &quot;&lt;td&gt; &lt;table id=\&quot;moz-vcard-properties-table\&quot;&gt; &lt;tr&gt; &quot;;</span>
<a href="#l7.335"></a><span id="l7.335"> </span>
<a href="#l7.336"></a><span id="l7.336">   OutputBasicVcard(aMimeObj, aVcard, vCardOutput);</span>
<a href="#l7.337"></a><span id="l7.337"> </span>
<a href="#l7.338"></a><span id="l7.338">   // close the properties table</span>
<a href="#l7.339"></a><span id="l7.339">   vCardOutput += &quot;&lt;/table&gt; &lt;/td&gt; &quot;;</span>
<a href="#l7.340"></a><span id="l7.340"> </span>
<a href="#l7.341"></a><span id="l7.341">   // 2nd  cell in the outer table is our vCard image</span>
<a href="#l7.342"></a><span id="l7.342"> </span>
<a href="#l7.343"></a><span id="l7.343">   vCardOutput += &quot;&lt;/tr&gt; &lt;/table&gt;&quot;;</span>
<a href="#l7.344"></a><span id="l7.344"> </span>
<a href="#l7.345"></a><span id="l7.345">   // now write out the vCard</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-  return COM_MimeObject_write(aMimeObj, (char *) vCardOutput.get(), vCardOutput.Length(), true);</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+  return COM_MimeObject_write(aMimeObj, (char *)vCardOutput.get(),</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+                              vCardOutput.Length(), true);</span>
<a href="#l7.349"></a><span id="l7.349"> }</span>
<a href="#l7.350"></a><span id="l7.350"> </span>
<a href="#l7.351"></a><span id="l7.351" class="difflineminus">-</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineminus">-static int OutputBasicVcard(MimeObject *aMimeObj, VObject *aVcard, nsACString&amp; vCardOutput)</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-{</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+static int OutputBasicVcard(MimeObject *aMimeObj, VObject *aVcard,</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+                            nsACString &amp;vCardOutput) {</span>
<a href="#l7.356"></a><span id="l7.356">   VObject *prop = NULL;</span>
<a href="#l7.357"></a><span id="l7.357">   nsAutoCString urlstring;</span>
<a href="#l7.358"></a><span id="l7.358">   nsAutoCString namestring;</span>
<a href="#l7.359"></a><span id="l7.359">   nsAutoCString emailstring;</span>
<a href="#l7.360"></a><span id="l7.360"> </span>
<a href="#l7.361"></a><span id="l7.361" class="difflineminus">-  nsCOMPtr&lt;nsIMsgVCardService&gt; vCardService =  do_GetService(MSGVCARDSERVICE_CONTRACT_ID);</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-  if (!vCardService)</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-      return -1;</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineplus">+  nsCOMPtr&lt;nsIMsgVCardService&gt; vCardService =</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+      do_GetService(MSGVCARDSERVICE_CONTRACT_ID);</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineplus">+  if (!vCardService) return -1;</span>
<a href="#l7.367"></a><span id="l7.367"> </span>
<a href="#l7.368"></a><span id="l7.368">   /* get the name and email */</span>
<a href="#l7.369"></a><span id="l7.369">   prop = vCardService-&gt;IsAPropertyOf(aVcard, VCFullNameProp);</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-  if (prop)</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-  {</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-    if (VALUE_TYPE(prop))</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-    {</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+  if (prop) {</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineplus">+    if (VALUE_TYPE(prop)) {</span>
<a href="#l7.376"></a><span id="l7.376">       if (VALUE_TYPE(prop) != VCVT_RAW)</span>
<a href="#l7.377"></a><span id="l7.377">         namestring.Adopt(vCardService-&gt;FakeCString(prop));</span>
<a href="#l7.378"></a><span id="l7.378">       else</span>
<a href="#l7.379"></a><span id="l7.379">         namestring.Adopt(vCardService-&gt;VObjectAnyValue(prop));</span>
<a href="#l7.380"></a><span id="l7.380"> </span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-      if (!namestring.IsEmpty())</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-      {</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineplus">+      if (!namestring.IsEmpty()) {</span>
<a href="#l7.384"></a><span id="l7.384">         vCardOutput += &quot;&lt;td class=\&quot;moz-vcard-title-property\&quot;&gt; &quot;;</span>
<a href="#l7.385"></a><span id="l7.385"> </span>
<a href="#l7.386"></a><span id="l7.386">         prop = vCardService-&gt;IsAPropertyOf(aVcard, VCURLProp);</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-        if (prop)</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-        {</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+        if (prop) {</span>
<a href="#l7.390"></a><span id="l7.390">           urlstring.Adopt(vCardService-&gt;FakeCString(prop));</span>
<a href="#l7.391"></a><span id="l7.391">           if (urlstring.IsEmpty())</span>
<a href="#l7.392"></a><span id="l7.392">             vCardOutput += namestring;</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineminus">-          else</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineminus">-          {</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+          else {</span>
<a href="#l7.396"></a><span id="l7.396">             char buf[512];</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineminus">-            PR_snprintf(buf, 512, &quot;&lt;a href=&quot;&quot;%s&quot;&quot; private&gt;%s&lt;/a&gt;&quot;, urlstring.get(), namestring.get());</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+            PR_snprintf(buf, 512,</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+                        &quot;&lt;a href=&quot;</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+                        &quot;%s&quot;</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+                        &quot; private&gt;%s&lt;/a&gt;&quot;,</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+                        urlstring.get(), namestring.get());</span>
<a href="#l7.403"></a><span id="l7.403">             vCardOutput.Append(buf);</span>
<a href="#l7.404"></a><span id="l7.404">           }</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineminus">-        }</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineminus">-        else</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+        } else</span>
<a href="#l7.408"></a><span id="l7.408">           vCardOutput += namestring;</span>
<a href="#l7.409"></a><span id="l7.409"> </span>
<a href="#l7.410"></a><span id="l7.410">         /* get the email address */</span>
<a href="#l7.411"></a><span id="l7.411">         prop = vCardService-&gt;IsAPropertyOf(aVcard, VCEmailAddressProp);</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineminus">-        if (prop)</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineminus">-        {</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+        if (prop) {</span>
<a href="#l7.415"></a><span id="l7.415">           emailstring.Adopt(vCardService-&gt;FakeCString(prop));</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineminus">-          if (!emailstring.IsEmpty())</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineminus">-          {</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+          if (!emailstring.IsEmpty()) {</span>
<a href="#l7.419"></a><span id="l7.419">             char buf[512];</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineminus">-            PR_snprintf(buf, 512, &quot;&amp;nbsp;&amp;lt;&lt;a href=&quot;&quot;mailto:%s&quot;&quot; private&gt;%s&lt;/a&gt;&amp;gt;&quot;, emailstring.get(), emailstring.get());</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+            PR_snprintf(buf, 512,</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineplus">+                        &quot;&amp;nbsp;&amp;lt;&lt;a href=&quot;</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineplus">+                        &quot;mailto:%s&quot;</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineplus">+                        &quot; private&gt;%s&lt;/a&gt;&amp;gt;&quot;,</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineplus">+                        emailstring.get(), emailstring.get());</span>
<a href="#l7.426"></a><span id="l7.426">             vCardOutput.Append(buf);</span>
<a href="#l7.427"></a><span id="l7.427">           }</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-        } // if email address property</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+        }  // if email address property</span>
<a href="#l7.430"></a><span id="l7.430"> </span>
<a href="#l7.431"></a><span id="l7.431" class="difflineminus">-        vCardOutput += &quot;&lt;/td&gt; &lt;/tr&gt; &quot;; // end the cell for the name/email address</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-      } // if we have a name property</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineplus">+        vCardOutput +=</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineplus">+            &quot;&lt;/td&gt; &lt;/tr&gt; &quot;;  // end the cell for the name/email address</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineplus">+      }                      // if we have a name property</span>
<a href="#l7.436"></a><span id="l7.436">     }</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-  } // if full name property</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+  }  // if full name property</span>
<a href="#l7.439"></a><span id="l7.439"> </span>
<a href="#l7.440"></a><span id="l7.440">   // now each basic property goes on its own line</span>
<a href="#l7.441"></a><span id="l7.441"> </span>
<a href="#l7.442"></a><span id="l7.442">   // title</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineminus">-  (void) OutputVcardAttribute (aMimeObj, aVcard, VCTitleProp, vCardOutput);</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+  (void)OutputVcardAttribute(aMimeObj, aVcard, VCTitleProp, vCardOutput);</span>
<a href="#l7.445"></a><span id="l7.445"> </span>
<a href="#l7.446"></a><span id="l7.446">   // org name and company name</span>
<a href="#l7.447"></a><span id="l7.447">   prop = vCardService-&gt;IsAPropertyOf(aVcard, VCOrgProp);</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineminus">-  if (prop)</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineminus">-  {</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineminus">-    OutputVcardAttribute (aMimeObj, prop, VCOrgUnitProp, vCardOutput);</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineminus">-    OutputVcardAttribute (aMimeObj, prop, VCOrgNameProp, vCardOutput);</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineplus">+  if (prop) {</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+    OutputVcardAttribute(aMimeObj, prop, VCOrgUnitProp, vCardOutput);</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+    OutputVcardAttribute(aMimeObj, prop, VCOrgNameProp, vCardOutput);</span>
<a href="#l7.455"></a><span id="l7.455">   }</span>
<a href="#l7.456"></a><span id="l7.456"> </span>
<a href="#l7.457"></a><span id="l7.457">   return 0;</span>
<a href="#l7.458"></a><span id="l7.458"> }</span>
<a href="#l7.459"></a><span id="l7.459"> </span>
<a href="#l7.460"></a><span id="l7.460" class="difflineminus">-static int OutputVcardAttribute(MimeObject *aMimeObj, VObject *aVcard, const char* id, nsACString&amp; vCardOutput)</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineminus">-{</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+static int OutputVcardAttribute(MimeObject *aMimeObj, VObject *aVcard,</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+                                const char *id, nsACString &amp;vCardOutput) {</span>
<a href="#l7.464"></a><span id="l7.464">   VObject *prop = NULL;</span>
<a href="#l7.465"></a><span id="l7.465">   nsAutoCString string;</span>
<a href="#l7.466"></a><span id="l7.466"> </span>
<a href="#l7.467"></a><span id="l7.467" class="difflineminus">-  nsCOMPtr&lt;nsIMsgVCardService&gt; vCardService = do_GetService(MSGVCARDSERVICE_CONTRACT_ID);</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineminus">-  if (!vCardService)</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineminus">-      return -1;</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+  nsCOMPtr&lt;nsIMsgVCardService&gt; vCardService =</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineplus">+      do_GetService(MSGVCARDSERVICE_CONTRACT_ID);</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineplus">+  if (!vCardService) return -1;</span>
<a href="#l7.473"></a><span id="l7.473"> </span>
<a href="#l7.474"></a><span id="l7.474">   prop = vCardService-&gt;IsAPropertyOf(aVcard, id);</span>
<a href="#l7.475"></a><span id="l7.475">   if (prop)</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineminus">-    if (VALUE_TYPE(prop))</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineminus">-    {</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineplus">+    if (VALUE_TYPE(prop)) {</span>
<a href="#l7.479"></a><span id="l7.479">       if (VALUE_TYPE(prop) != VCVT_RAW)</span>
<a href="#l7.480"></a><span id="l7.480">         string.Adopt(vCardService-&gt;FakeCString(prop));</span>
<a href="#l7.481"></a><span id="l7.481">       else</span>
<a href="#l7.482"></a><span id="l7.482">         string.Adopt(vCardService-&gt;VObjectAnyValue(prop));</span>
<a href="#l7.483"></a><span id="l7.483"> </span>
<a href="#l7.484"></a><span id="l7.484" class="difflineminus">-      if (!string.IsEmpty())</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineminus">-      {</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+      if (!string.IsEmpty()) {</span>
<a href="#l7.487"></a><span id="l7.487">         vCardOutput += &quot;&lt;tr&gt; &lt;td class=\&quot;moz-vcard-property\&quot;&gt;&quot;;</span>
<a href="#l7.488"></a><span id="l7.488">         vCardOutput += string;</span>
<a href="#l7.489"></a><span id="l7.489">         vCardOutput += &quot;&lt;/td&gt; &lt;/tr&gt; &quot;;</span>
<a href="#l7.490"></a><span id="l7.490">       }</span>
<a href="#l7.491"></a><span id="l7.491">     }</span>
<a href="#l7.492"></a><span id="l7.492"> </span>
<a href="#l7.493"></a><span id="l7.493">   return 0;</span>
<a href="#l7.494"></a><span id="l7.494"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/mime/cthandlers/vcard/mimevcrd.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/mime/cthandlers/vcard/mimevcrd.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -9,25 +9,25 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;mimetext.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> /* The MimeInlineTextHTML class implements the text/x-vcard and (maybe?</span>
<a href="#l8.8"></a><span id="l8.8">    someday?) the application/directory MIME content types.</span>
<a href="#l8.9"></a><span id="l8.9">  */</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> typedef struct MimeInlineTextVCardClass MimeInlineTextVCardClass;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-typedef struct MimeInlineTextVCard      MimeInlineTextVCard;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+typedef struct MimeInlineTextVCard MimeInlineTextVCard;</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> struct MimeInlineTextVCardClass {</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-  MimeInlineTextClass         text;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-  char                        *vCardString;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+  MimeInlineTextClass text;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+  char *vCardString;</span>
<a href="#l8.20"></a><span id="l8.20"> };</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22"> extern MimeInlineTextVCardClass mimeInlineTextVCardClass;</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24"> struct MimeInlineTextVCard {</span>
<a href="#l8.25"></a><span id="l8.25">   MimeInlineText text;</span>
<a href="#l8.26"></a><span id="l8.26"> };</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-#define MimeInlineTextVCardClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-  { MimeInlineTextClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+#define MimeInlineTextVCardClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+  { MimeInlineTextClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33"> #endif /* _MIMEVCRD_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/mime/emitters/nsEmitterUtils.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsEmitterUtils.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -5,59 +5,44 @@</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;prmem.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;plstr.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsMailHeaders.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsIMimeEmitter.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;prprf.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-extern &quot;C&quot; bool</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-EmitThisHeaderForPrefSetting(int32_t dispType, const char *header)</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-{</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-  if (nsMimeHeaderDisplayTypes::AllHeaders == dispType)</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-    return true;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+extern &quot;C&quot; bool EmitThisHeaderForPrefSetting(int32_t dispType,</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+                                             const char *header) {</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+  if (nsMimeHeaderDisplayTypes::AllHeaders == dispType) return true;</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-  if ((!header) || (!*header))</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-    return false;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  if ((!header) || (!*header)) return false;</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-  if (nsMimeHeaderDisplayTypes::MicroHeaders == dispType)</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-  {</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-    if (</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-          (!strcmp(header, HEADER_SUBJECT)) ||</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-          (!strcmp(header, HEADER_FROM)) ||</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-          (!strcmp(header, HEADER_DATE))</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-       )</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  if (nsMimeHeaderDisplayTypes::MicroHeaders == dispType) {</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+    if ((!strcmp(header, HEADER_SUBJECT)) || (!strcmp(header, HEADER_FROM)) ||</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+        (!strcmp(header, HEADER_DATE)))</span>
<a href="#l9.35"></a><span id="l9.35">       return true;</span>
<a href="#l9.36"></a><span id="l9.36">     else</span>
<a href="#l9.37"></a><span id="l9.37">       return false;</span>
<a href="#l9.38"></a><span id="l9.38">   }</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-  if (nsMimeHeaderDisplayTypes::NormalHeaders == dispType)</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-  {</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-    if (</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-        (!strcmp(header, HEADER_DATE)) ||</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-        (!strcmp(header, HEADER_TO)) ||</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-        (!strcmp(header, HEADER_SUBJECT)) ||</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-        (!strcmp(header, HEADER_SENDER)) ||</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+  if (nsMimeHeaderDisplayTypes::NormalHeaders == dispType) {</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+    if ((!strcmp(header, HEADER_DATE)) || (!strcmp(header, HEADER_TO)) ||</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+        (!strcmp(header, HEADER_SUBJECT)) || (!strcmp(header, HEADER_SENDER)) ||</span>
<a href="#l9.50"></a><span id="l9.50">         (!strcmp(header, HEADER_RESENT_TO)) ||</span>
<a href="#l9.51"></a><span id="l9.51">         (!strcmp(header, HEADER_RESENT_SENDER)) ||</span>
<a href="#l9.52"></a><span id="l9.52">         (!strcmp(header, HEADER_RESENT_FROM)) ||</span>
<a href="#l9.53"></a><span id="l9.53">         (!strcmp(header, HEADER_RESENT_CC)) ||</span>
<a href="#l9.54"></a><span id="l9.54">         (!strcmp(header, HEADER_REPLY_TO)) ||</span>
<a href="#l9.55"></a><span id="l9.55">         (!strcmp(header, HEADER_REFERENCES)) ||</span>
<a href="#l9.56"></a><span id="l9.56">         (!strcmp(header, HEADER_NEWSGROUPS)) ||</span>
<a href="#l9.57"></a><span id="l9.57">         (!strcmp(header, HEADER_MESSAGE_ID)) ||</span>
<a href="#l9.58"></a><span id="l9.58">         (!strcmp(header, HEADER_FROM)) ||</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-        (!strcmp(header, HEADER_FOLLOWUP_TO)) ||</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-        (!strcmp(header, HEADER_CC)) ||</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+        (!strcmp(header, HEADER_FOLLOWUP_TO)) || (!strcmp(header, HEADER_CC)) ||</span>
<a href="#l9.62"></a><span id="l9.62">         (!strcmp(header, HEADER_ORGANIZATION)) ||</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-        (!strcmp(header, HEADER_REPLY_TO)) ||</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-        (!strcmp(header, HEADER_BCC))</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-       )</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-       return true;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+        (!strcmp(header, HEADER_REPLY_TO)) || (!strcmp(header, HEADER_BCC)))</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+      return true;</span>
<a href="#l9.69"></a><span id="l9.69">     else</span>
<a href="#l9.70"></a><span id="l9.70">       return false;</span>
<a href="#l9.71"></a><span id="l9.71">   }</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73">   return true;</span>
<a href="#l9.74"></a><span id="l9.74"> }</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/mime/emitters/nsEmitterUtils.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsEmitterUtils.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -3,12 +3,12 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.5"></a><span id="l10.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.6"></a><span id="l10.6"> #ifndef _nsEmitterUtils_h_</span>
<a href="#l10.7"></a><span id="l10.7"> #define _nsEmitterUtils_h_</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;prmem.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;plstr.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-extern &quot;C&quot; bool     EmitThisHeaderForPrefSetting(int32_t dispType, const char *header);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+extern &quot;C&quot; bool EmitThisHeaderForPrefSetting(int32_t dispType,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+                                             const char *header);</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-#endif // _nsEmitterUtils_h_</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+#endif  // _nsEmitterUtils_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeBaseEmitter.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeBaseEmitter.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -24,23 +24,22 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> static mozilla::LazyLogModule gMimeEmitterLogModule(&quot;MIME&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#define   MIME_HEADER_URL      &quot;chrome://messenger/locale/mimeheader.properties&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-#define   MIME_URL             &quot;chrome://messenger/locale/mime.properties&quot;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+#define MIME_HEADER_URL &quot;chrome://messenger/locale/mimeheader.properties&quot;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+#define MIME_URL &quot;chrome://messenger/locale/mime.properties&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> NS_IMPL_ISUPPORTS(nsMimeBaseEmitter, nsIMimeEmitter, nsIInterfaceRequestor)</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-nsMimeBaseEmitter::nsMimeBaseEmitter()</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-{</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+nsMimeBaseEmitter::nsMimeBaseEmitter() {</span>
<a href="#l11.22"></a><span id="l11.22">   // Initialize data output vars...</span>
<a href="#l11.23"></a><span id="l11.23">   mFirstHeaders = true;</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25">   mBufferMgr = nullptr;</span>
<a href="#l11.26"></a><span id="l11.26">   mTotalWritten = 0;</span>
<a href="#l11.27"></a><span id="l11.27">   mTotalRead = 0;</span>
<a href="#l11.28"></a><span id="l11.28">   mInputStream = nullptr;</span>
<a href="#l11.29"></a><span id="l11.29">   mOutStream = nullptr;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineat">@@ -49,105 +48,93 @@ nsMimeBaseEmitter::nsMimeBaseEmitter()</span>
<a href="#l11.31"></a><span id="l11.31">   // Display output control vars...</span>
<a href="#l11.32"></a><span id="l11.32">   mDocHeader = false;</span>
<a href="#l11.33"></a><span id="l11.33">   m_stringBundle = nullptr;</span>
<a href="#l11.34"></a><span id="l11.34">   mURL = nullptr;</span>
<a href="#l11.35"></a><span id="l11.35">   mHeaderDisplayType = nsMimeHeaderDisplayTypes::NormalHeaders;</span>
<a href="#l11.36"></a><span id="l11.36"> </span>
<a href="#l11.37"></a><span id="l11.37">   // Setup array for attachments</span>
<a href="#l11.38"></a><span id="l11.38">   mAttachCount = 0;</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  mAttachArray = new nsTArray&lt;attachmentInfoType*&gt;();</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+  mAttachArray = new nsTArray&lt;attachmentInfoType *&gt;();</span>
<a href="#l11.41"></a><span id="l11.41">   mCurrentAttachment = nullptr;</span>
<a href="#l11.42"></a><span id="l11.42"> </span>
<a href="#l11.43"></a><span id="l11.43">   // Header cache...</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-  mHeaderArray = new nsTArray&lt;headerInfoType*&gt;();</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+  mHeaderArray = new nsTArray&lt;headerInfoType *&gt;();</span>
<a href="#l11.46"></a><span id="l11.46"> </span>
<a href="#l11.47"></a><span id="l11.47">   // Embedded Header Cache...</span>
<a href="#l11.48"></a><span id="l11.48">   mEmbeddedHeaderArray = nullptr;</span>
<a href="#l11.49"></a><span id="l11.49"> </span>
<a href="#l11.50"></a><span id="l11.50">   // HTML Header Data...</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-//  mHTMLHeaders = &quot;&quot;;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-//  mCharset = &quot;&quot;;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  //  mHTMLHeaders = &quot;&quot;;</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+  //  mCharset = &quot;&quot;;</span>
<a href="#l11.55"></a><span id="l11.55"> </span>
<a href="#l11.56"></a><span id="l11.56">   // Init the body...</span>
<a href="#l11.57"></a><span id="l11.57">   mBodyStarted = false;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-//  mBody = &quot;&quot;;</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+  //  mBody = &quot;&quot;;</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61">   // This is needed for conversion of I18N Strings...</span>
<a href="#l11.62"></a><span id="l11.62">   mUnicodeConverter = do_GetService(NS_MIME_CONVERTER_CONTRACTID);</span>
<a href="#l11.63"></a><span id="l11.63"> </span>
<a href="#l11.64"></a><span id="l11.64">   // Do prefs last since we can live without this if it fails...</span>
<a href="#l11.65"></a><span id="l11.65">   nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l11.66"></a><span id="l11.66">   if (pPrefBranch)</span>
<a href="#l11.67"></a><span id="l11.67">     pPrefBranch-&gt;GetIntPref(&quot;mail.show_headers&quot;, &amp;mHeaderDisplayType);</span>
<a href="#l11.68"></a><span id="l11.68"> }</span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-nsMimeBaseEmitter::~nsMimeBaseEmitter(void)</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-{</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+nsMimeBaseEmitter::~nsMimeBaseEmitter(void) {</span>
<a href="#l11.73"></a><span id="l11.73">   // Delete the buffer manager...</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-  if (mBufferMgr)</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-  {</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+  if (mBufferMgr) {</span>
<a href="#l11.77"></a><span id="l11.77">     delete mBufferMgr;</span>
<a href="#l11.78"></a><span id="l11.78">     mBufferMgr = nullptr;</span>
<a href="#l11.79"></a><span id="l11.79">   }</span>
<a href="#l11.80"></a><span id="l11.80"> </span>
<a href="#l11.81"></a><span id="l11.81">   // Clean up the attachment array structures...</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-  if (mAttachArray)</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-  {</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-    for (size_t i = 0; i &lt; mAttachArray-&gt;Length(); i++)</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-    {</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+  if (mAttachArray) {</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+    for (size_t i = 0; i &lt; mAttachArray-&gt;Length(); i++) {</span>
<a href="#l11.88"></a><span id="l11.88">       attachmentInfoType *attachInfo = mAttachArray-&gt;ElementAt(i);</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-      if (!attachInfo)</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-        continue;</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+      if (!attachInfo) continue;</span>
<a href="#l11.92"></a><span id="l11.92"> </span>
<a href="#l11.93"></a><span id="l11.93">       PR_FREEIF(attachInfo-&gt;contentType);</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-      if (attachInfo-&gt;displayName)</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-        free(attachInfo-&gt;displayName);</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+      if (attachInfo-&gt;displayName) free(attachInfo-&gt;displayName);</span>
<a href="#l11.97"></a><span id="l11.97">       PR_FREEIF(attachInfo-&gt;urlSpec);</span>
<a href="#l11.98"></a><span id="l11.98">       PR_FREEIF(attachInfo);</span>
<a href="#l11.99"></a><span id="l11.99">     }</span>
<a href="#l11.100"></a><span id="l11.100">     delete mAttachArray;</span>
<a href="#l11.101"></a><span id="l11.101">   }</span>
<a href="#l11.102"></a><span id="l11.102"> </span>
<a href="#l11.103"></a><span id="l11.103">   // Cleanup allocated header arrays...</span>
<a href="#l11.104"></a><span id="l11.104">   CleanupHeaderArray(mHeaderArray);</span>
<a href="#l11.105"></a><span id="l11.105">   mHeaderArray = nullptr;</span>
<a href="#l11.106"></a><span id="l11.106"> </span>
<a href="#l11.107"></a><span id="l11.107">   CleanupHeaderArray(mEmbeddedHeaderArray);</span>
<a href="#l11.108"></a><span id="l11.108">   mEmbeddedHeaderArray = nullptr;</span>
<a href="#l11.109"></a><span id="l11.109"> }</span>
<a href="#l11.110"></a><span id="l11.110"> </span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-NS_IMETHODIMP nsMimeBaseEmitter::GetInterface(const nsIID &amp; aIID, void * *aInstancePtr)</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-{</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+NS_IMETHODIMP nsMimeBaseEmitter::GetInterface(const nsIID &amp;aIID,</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+                                              void **aInstancePtr) {</span>
<a href="#l11.115"></a><span id="l11.115">   NS_ENSURE_ARG_POINTER(aInstancePtr);</span>
<a href="#l11.116"></a><span id="l11.116">   return QueryInterface(aIID, aInstancePtr);</span>
<a href="#l11.117"></a><span id="l11.117"> }</span>
<a href="#l11.118"></a><span id="l11.118"> </span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-void</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-nsMimeBaseEmitter::CleanupHeaderArray(nsTArray&lt;headerInfoType*&gt; *aArray)</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-{</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-  if (!aArray)</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-    return;</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+void nsMimeBaseEmitter::CleanupHeaderArray(nsTArray&lt;headerInfoType *&gt; *aArray) {</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+  if (!aArray) return;</span>
<a href="#l11.126"></a><span id="l11.126"> </span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-  for (size_t i = 0; i &lt; aArray-&gt;Length(); i++)</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-  {</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+  for (size_t i = 0; i &lt; aArray-&gt;Length(); i++) {</span>
<a href="#l11.130"></a><span id="l11.130">     headerInfoType *headerInfo = aArray-&gt;ElementAt(i);</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-    if (!headerInfo)</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-      continue;</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+    if (!headerInfo) continue;</span>
<a href="#l11.134"></a><span id="l11.134"> </span>
<a href="#l11.135"></a><span id="l11.135">     PR_FREEIF(headerInfo-&gt;name);</span>
<a href="#l11.136"></a><span id="l11.136">     PR_FREEIF(headerInfo-&gt;value);</span>
<a href="#l11.137"></a><span id="l11.137">     PR_FREEIF(headerInfo);</span>
<a href="#l11.138"></a><span id="l11.138">   }</span>
<a href="#l11.139"></a><span id="l11.139"> </span>
<a href="#l11.140"></a><span id="l11.140">   delete aArray;</span>
<a href="#l11.141"></a><span id="l11.141"> }</span>
<a href="#l11.142"></a><span id="l11.142"> </span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-static int32_t MapHeaderNameToID(const char *header)</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-{</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+static int32_t MapHeaderNameToID(const char *header) {</span>
<a href="#l11.146"></a><span id="l11.146">   // emitter passes UPPERCASE for header names</span>
<a href="#l11.147"></a><span id="l11.147">   if (!strcmp(header, &quot;DATE&quot;))</span>
<a href="#l11.148"></a><span id="l11.148">     return MIME_MHTML_DATE;</span>
<a href="#l11.149"></a><span id="l11.149">   else if (!strcmp(header, &quot;FROM&quot;))</span>
<a href="#l11.150"></a><span id="l11.150">     return MIME_MHTML_FROM;</span>
<a href="#l11.151"></a><span id="l11.151">   else if (!strcmp(header, &quot;SUBJECT&quot;))</span>
<a href="#l11.152"></a><span id="l11.152">     return MIME_MHTML_SUBJECT;</span>
<a href="#l11.153"></a><span id="l11.153">   else if (!strcmp(header, &quot;TO&quot;))</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineat">@@ -177,131 +164,115 @@ static int32_t MapHeaderNameToID(const c</span>
<a href="#l11.155"></a><span id="l11.155">   else if (!strcmp(header, &quot;ORGANIZATION&quot;))</span>
<a href="#l11.156"></a><span id="l11.156">     return MIME_MHTML_ORGANIZATION;</span>
<a href="#l11.157"></a><span id="l11.157">   else if (!strcmp(header, &quot;BCC&quot;))</span>
<a href="#l11.158"></a><span id="l11.158">     return MIME_MHTML_BCC;</span>
<a href="#l11.159"></a><span id="l11.159"> </span>
<a href="#l11.160"></a><span id="l11.160">   return 0;</span>
<a href="#l11.161"></a><span id="l11.161"> }</span>
<a href="#l11.162"></a><span id="l11.162"> </span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-char *</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-nsMimeBaseEmitter::MimeGetStringByName(const char *aHeaderName)</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-{</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+char *nsMimeBaseEmitter::MimeGetStringByName(const char *aHeaderName) {</span>
<a href="#l11.167"></a><span id="l11.167">   nsresult res = NS_OK;</span>
<a href="#l11.168"></a><span id="l11.168"> </span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-  if (!m_headerStringBundle)</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-  {</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+  if (!m_headerStringBundle) {</span>
<a href="#l11.172"></a><span id="l11.172">     static const char propertyURL[] = MIME_HEADER_URL;</span>
<a href="#l11.173"></a><span id="l11.173"> </span>
<a href="#l11.174"></a><span id="l11.174">     nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-    if (sBundleService)</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-    {</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-      res = sBundleService-&gt;CreateBundle(propertyURL, getter_AddRefs(m_headerStringBundle));</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+    if (sBundleService) {</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+      res = sBundleService-&gt;CreateBundle(propertyURL,</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+                                         getter_AddRefs(m_headerStringBundle));</span>
<a href="#l11.183"></a><span id="l11.183">     }</span>
<a href="#l11.184"></a><span id="l11.184">   }</span>
<a href="#l11.185"></a><span id="l11.185"> </span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-  if (m_headerStringBundle)</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">-  {</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+  if (m_headerStringBundle) {</span>
<a href="#l11.189"></a><span id="l11.189">     nsString val;</span>
<a href="#l11.190"></a><span id="l11.190"> </span>
<a href="#l11.191"></a><span id="l11.191">     res = m_headerStringBundle-&gt;GetStringFromName(aHeaderName, val);</span>
<a href="#l11.192"></a><span id="l11.192"> </span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-    if (NS_FAILED(res))</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-      return nullptr;</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+    if (NS_FAILED(res)) return nullptr;</span>
<a href="#l11.196"></a><span id="l11.196"> </span>
<a href="#l11.197"></a><span id="l11.197">     // Here we need to return a new copy of the string</span>
<a href="#l11.198"></a><span id="l11.198">     // This returns a UTF-8 string so the caller needs to perform a conversion</span>
<a href="#l11.199"></a><span id="l11.199">     // if this is used as UCS-2 (e.g. cannot do nsString(utfStr);</span>
<a href="#l11.200"></a><span id="l11.200">     //</span>
<a href="#l11.201"></a><span id="l11.201">     return ToNewUTF8String(val);</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-  }</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-  else</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-  {</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+  } else {</span>
<a href="#l11.206"></a><span id="l11.206">     return nullptr;</span>
<a href="#l11.207"></a><span id="l11.207">   }</span>
<a href="#l11.208"></a><span id="l11.208"> }</span>
<a href="#l11.209"></a><span id="l11.209"> </span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-char *</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-nsMimeBaseEmitter::MimeGetStringByID(int32_t aID)</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-{</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+char *nsMimeBaseEmitter::MimeGetStringByID(int32_t aID) {</span>
<a href="#l11.214"></a><span id="l11.214">   nsresult res = NS_OK;</span>
<a href="#l11.215"></a><span id="l11.215"> </span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-  if (!m_stringBundle)</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-  {</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+  if (!m_stringBundle) {</span>
<a href="#l11.219"></a><span id="l11.219">     static const char propertyURL[] = MIME_URL;</span>
<a href="#l11.220"></a><span id="l11.220"> </span>
<a href="#l11.221"></a><span id="l11.221">     nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l11.224"></a><span id="l11.224">     if (sBundleService)</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-      res = sBundleService-&gt;CreateBundle(propertyURL, getter_AddRefs(m_stringBundle));</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+      res = sBundleService-&gt;CreateBundle(propertyURL,</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+                                         getter_AddRefs(m_stringBundle));</span>
<a href="#l11.228"></a><span id="l11.228">   }</span>
<a href="#l11.229"></a><span id="l11.229"> </span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-  if (m_stringBundle)</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-  {</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+  if (m_stringBundle) {</span>
<a href="#l11.233"></a><span id="l11.233">     nsString val;</span>
<a href="#l11.234"></a><span id="l11.234">     res = m_stringBundle-&gt;GetStringFromID(aID, val);</span>
<a href="#l11.235"></a><span id="l11.235"> </span>
<a href="#l11.236"></a><span id="l11.236" class="difflineminus">-    if (NS_FAILED(res))</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-      return nullptr;</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+    if (NS_FAILED(res)) return nullptr;</span>
<a href="#l11.239"></a><span id="l11.239"> </span>
<a href="#l11.240"></a><span id="l11.240">     return ToNewUTF8String(val);</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-  }</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-  else</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+  } else</span>
<a href="#l11.244"></a><span id="l11.244">     return nullptr;</span>
<a href="#l11.245"></a><span id="l11.245"> }</span>
<a href="#l11.246"></a><span id="l11.246"> </span>
<a href="#l11.247"></a><span id="l11.247"> //</span>
<a href="#l11.248"></a><span id="l11.248"> // This will search a string bundle (eventually) to find a descriptive header</span>
<a href="#l11.249"></a><span id="l11.249"> // name to match what was found in the mail message. aHeaderName is passed in</span>
<a href="#l11.250"></a><span id="l11.250"> // in all caps and a dropback default name is provided. The caller needs to free</span>
<a href="#l11.251"></a><span id="l11.251"> // the memory returned by this function.</span>
<a href="#l11.252"></a><span id="l11.252"> //</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-char *</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-nsMimeBaseEmitter::LocalizeHeaderName(const char *aHeaderName, const char *aDefaultName)</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-{</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+char *nsMimeBaseEmitter::LocalizeHeaderName(const char *aHeaderName,</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+                                            const char *aDefaultName) {</span>
<a href="#l11.258"></a><span id="l11.258">   char *retVal = nullptr;</span>
<a href="#l11.259"></a><span id="l11.259"> </span>
<a href="#l11.260"></a><span id="l11.260">   // prefer to use translated strings if not for quoting</span>
<a href="#l11.261"></a><span id="l11.261">   if (mFormat != nsMimeOutput::nsMimeMessageQuoting &amp;&amp;</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineminus">-      mFormat != nsMimeOutput::nsMimeMessageBodyQuoting)</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineminus">-  {</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+      mFormat != nsMimeOutput::nsMimeMessageBodyQuoting) {</span>
<a href="#l11.265"></a><span id="l11.265">     // map name to id and get the translated string</span>
<a href="#l11.266"></a><span id="l11.266">     int32_t id = MapHeaderNameToID(aHeaderName);</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-    if (id &gt; 0)</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineminus">-      retVal = MimeGetStringByID(id);</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+    if (id &gt; 0) retVal = MimeGetStringByID(id);</span>
<a href="#l11.270"></a><span id="l11.270">   }</span>
<a href="#l11.271"></a><span id="l11.271"> </span>
<a href="#l11.272"></a><span id="l11.272">   // get the string from the other bundle (usually not translated)</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineminus">-  if (!retVal)</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineminus">-    retVal = MimeGetStringByName(aHeaderName);</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+  if (!retVal) retVal = MimeGetStringByName(aHeaderName);</span>
<a href="#l11.276"></a><span id="l11.276"> </span>
<a href="#l11.277"></a><span id="l11.277">   if (retVal)</span>
<a href="#l11.278"></a><span id="l11.278">     return retVal;</span>
<a href="#l11.279"></a><span id="l11.279">   else</span>
<a href="#l11.280"></a><span id="l11.280">     return strdup(aDefaultName);</span>
<a href="#l11.281"></a><span id="l11.281"> }</span>
<a href="#l11.282"></a><span id="l11.282"> </span>
<a href="#l11.283"></a><span id="l11.283"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.284"></a><span id="l11.284"> // nsMimeBaseEmitter Interface</span>
<a href="#l11.285"></a><span id="l11.285"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.286"></a><span id="l11.286"> NS_IMETHODIMP</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineminus">-nsMimeBaseEmitter::SetPipe(nsIInputStream * aInputStream, nsIOutputStream *outStream)</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineminus">-{</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+nsMimeBaseEmitter::SetPipe(nsIInputStream *aInputStream,</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+                           nsIOutputStream *outStream) {</span>
<a href="#l11.291"></a><span id="l11.291">   mInputStream = aInputStream;</span>
<a href="#l11.292"></a><span id="l11.292">   mOutStream = outStream;</span>
<a href="#l11.293"></a><span id="l11.293">   return NS_OK;</span>
<a href="#l11.294"></a><span id="l11.294"> }</span>
<a href="#l11.295"></a><span id="l11.295"> </span>
<a href="#l11.296"></a><span id="l11.296"> // Note - these is setup only...you should not write</span>
<a href="#l11.297"></a><span id="l11.297"> // anything to the stream since these may be image data</span>
<a href="#l11.298"></a><span id="l11.298"> // output streams, etc...</span>
<a href="#l11.299"></a><span id="l11.299"> NS_IMETHODIMP</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-nsMimeBaseEmitter::Initialize(nsIURI *url, nsIChannel * aChannel, int32_t aFormat)</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineminus">-{</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+nsMimeBaseEmitter::Initialize(nsIURI *url, nsIChannel *aChannel,</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineplus">+                              int32_t aFormat) {</span>
<a href="#l11.304"></a><span id="l11.304">   // set the url</span>
<a href="#l11.305"></a><span id="l11.305">   mURL = url;</span>
<a href="#l11.306"></a><span id="l11.306">   mChannel = aChannel;</span>
<a href="#l11.307"></a><span id="l11.307"> </span>
<a href="#l11.308"></a><span id="l11.308">   // Create rebuffering object</span>
<a href="#l11.309"></a><span id="l11.309">   delete mBufferMgr;</span>
<a href="#l11.310"></a><span id="l11.310">   mBufferMgr = new MimeRebuffer();</span>
<a href="#l11.311"></a><span id="l11.311"> </span>
<a href="#l11.312"></a><span id="l11.312" class="difflineat">@@ -309,168 +280,148 @@ nsMimeBaseEmitter::Initialize(nsIURI *ur</span>
<a href="#l11.313"></a><span id="l11.313">   mTotalWritten = 0;</span>
<a href="#l11.314"></a><span id="l11.314">   mTotalRead = 0;</span>
<a href="#l11.315"></a><span id="l11.315">   mFormat = aFormat;</span>
<a href="#l11.316"></a><span id="l11.316"> </span>
<a href="#l11.317"></a><span id="l11.317">   return NS_OK;</span>
<a href="#l11.318"></a><span id="l11.318"> }</span>
<a href="#l11.319"></a><span id="l11.319"> </span>
<a href="#l11.320"></a><span id="l11.320"> NS_IMETHODIMP</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineminus">-nsMimeBaseEmitter::SetOutputListener(nsIStreamListener *listener)</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineminus">-{</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+nsMimeBaseEmitter::SetOutputListener(nsIStreamListener *listener) {</span>
<a href="#l11.324"></a><span id="l11.324">   mOutListener = listener;</span>
<a href="#l11.325"></a><span id="l11.325">   return NS_OK;</span>
<a href="#l11.326"></a><span id="l11.326"> }</span>
<a href="#l11.327"></a><span id="l11.327"> </span>
<a href="#l11.328"></a><span id="l11.328"> NS_IMETHODIMP</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineminus">-nsMimeBaseEmitter::GetOutputListener(nsIStreamListener **listener)</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-{</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineplus">+nsMimeBaseEmitter::GetOutputListener(nsIStreamListener **listener) {</span>
<a href="#l11.332"></a><span id="l11.332">   NS_ENSURE_ARG_POINTER(listener);</span>
<a href="#l11.333"></a><span id="l11.333"> </span>
<a href="#l11.334"></a><span id="l11.334">   NS_IF_ADDREF(*listener = mOutListener);</span>
<a href="#l11.335"></a><span id="l11.335">   return NS_OK;</span>
<a href="#l11.336"></a><span id="l11.336"> }</span>
<a href="#l11.337"></a><span id="l11.337"> </span>
<a href="#l11.338"></a><span id="l11.338" class="difflineminus">-</span>
<a href="#l11.339"></a><span id="l11.339"> // Attachment handling routines</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-nsresult</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineminus">-nsMimeBaseEmitter::StartAttachment(const nsACString &amp;name,</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineminus">-                                   const char *contentType,</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineminus">-                                   const char *url,</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineminus">-                                   bool aIsExternalAttachment)</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineminus">-{</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineplus">+nsresult nsMimeBaseEmitter::StartAttachment(const nsACString &amp;name,</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+                                            const char *contentType,</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineplus">+                                            const char *url,</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineplus">+                                            bool aIsExternalAttachment) {</span>
<a href="#l11.350"></a><span id="l11.350">   // Ok, now we will setup the attachment info</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineminus">-  mCurrentAttachment = (attachmentInfoType *) PR_NEWZAP(attachmentInfoType);</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineminus">-  if ( (mCurrentAttachment) &amp;&amp; mAttachArray)</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineminus">-  {</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+  mCurrentAttachment = (attachmentInfoType *)PR_NEWZAP(attachmentInfoType);</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineplus">+  if ((mCurrentAttachment) &amp;&amp; mAttachArray) {</span>
<a href="#l11.356"></a><span id="l11.356">     ++mAttachCount;</span>
<a href="#l11.357"></a><span id="l11.357"> </span>
<a href="#l11.358"></a><span id="l11.358">     mCurrentAttachment-&gt;displayName = ToNewCString(name);</span>
<a href="#l11.359"></a><span id="l11.359">     mCurrentAttachment-&gt;urlSpec = strdup(url);</span>
<a href="#l11.360"></a><span id="l11.360">     mCurrentAttachment-&gt;contentType = strdup(contentType);</span>
<a href="#l11.361"></a><span id="l11.361">     mCurrentAttachment-&gt;isExternalAttachment = aIsExternalAttachment;</span>
<a href="#l11.362"></a><span id="l11.362">   }</span>
<a href="#l11.363"></a><span id="l11.363"> </span>
<a href="#l11.364"></a><span id="l11.364">   return NS_OK;</span>
<a href="#l11.365"></a><span id="l11.365"> }</span>
<a href="#l11.366"></a><span id="l11.366"> </span>
<a href="#l11.367"></a><span id="l11.367" class="difflineminus">-nsresult</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineminus">-nsMimeBaseEmitter::EndAttachment()</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineminus">-{</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+nsresult nsMimeBaseEmitter::EndAttachment() {</span>
<a href="#l11.371"></a><span id="l11.371">   // Ok, add the attachment info to the attachment array...</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineminus">-  if ( (mCurrentAttachment) &amp;&amp; (mAttachArray) )</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineminus">-  {</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+  if ((mCurrentAttachment) &amp;&amp; (mAttachArray)) {</span>
<a href="#l11.375"></a><span id="l11.375">     mAttachArray-&gt;AppendElement(mCurrentAttachment);</span>
<a href="#l11.376"></a><span id="l11.376">     mCurrentAttachment = nullptr;</span>
<a href="#l11.377"></a><span id="l11.377">   }</span>
<a href="#l11.378"></a><span id="l11.378"> </span>
<a href="#l11.379"></a><span id="l11.379">   return NS_OK;</span>
<a href="#l11.380"></a><span id="l11.380"> }</span>
<a href="#l11.381"></a><span id="l11.381"> </span>
<a href="#l11.382"></a><span id="l11.382" class="difflineminus">-nsresult</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineminus">-nsMimeBaseEmitter::EndAllAttachments()</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineminus">-{</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineplus">+nsresult nsMimeBaseEmitter::EndAllAttachments() { return NS_OK; }</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineplus">+</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineplus">+nsMimeBaseEmitter::AddAttachmentField(const char *field, const char *value) {</span>
<a href="#l11.389"></a><span id="l11.389">   return NS_OK;</span>
<a href="#l11.390"></a><span id="l11.390"> }</span>
<a href="#l11.391"></a><span id="l11.391"> </span>
<a href="#l11.392"></a><span id="l11.392"> NS_IMETHODIMP</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineminus">-nsMimeBaseEmitter::AddAttachmentField(const char *field, const char *value)</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineminus">-{</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineminus">-}</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineminus">-</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineminus">-nsMimeBaseEmitter::UtilityWrite(const char *buf)</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineminus">-{</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineplus">+nsMimeBaseEmitter::UtilityWrite(const char *buf) {</span>
<a href="#l11.402"></a><span id="l11.402">   NS_ENSURE_ARG_POINTER(buf);</span>
<a href="#l11.403"></a><span id="l11.403"> </span>
<a href="#l11.404"></a><span id="l11.404" class="difflineminus">-  uint32_t    written;</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineplus">+  uint32_t written;</span>
<a href="#l11.406"></a><span id="l11.406">   Write(nsDependentCString(buf), &amp;written);</span>
<a href="#l11.407"></a><span id="l11.407">   return NS_OK;</span>
<a href="#l11.408"></a><span id="l11.408"> }</span>
<a href="#l11.409"></a><span id="l11.409"> </span>
<a href="#l11.410"></a><span id="l11.410"> NS_IMETHODIMP</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineminus">-nsMimeBaseEmitter::UtilityWrite(const nsACString &amp;buf)</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineminus">-{</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineminus">-  uint32_t    written;</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineplus">+nsMimeBaseEmitter::UtilityWrite(const nsACString &amp;buf) {</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineplus">+  uint32_t written;</span>
<a href="#l11.416"></a><span id="l11.416">   Write(buf, &amp;written);</span>
<a href="#l11.417"></a><span id="l11.417">   return NS_OK;</span>
<a href="#l11.418"></a><span id="l11.418"> }</span>
<a href="#l11.419"></a><span id="l11.419"> </span>
<a href="#l11.420"></a><span id="l11.420"> NS_IMETHODIMP</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineminus">-nsMimeBaseEmitter::UtilityWriteCRLF(const char *buf)</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineminus">-{</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineplus">+nsMimeBaseEmitter::UtilityWriteCRLF(const char *buf) {</span>
<a href="#l11.424"></a><span id="l11.424">   NS_ENSURE_ARG_POINTER(buf);</span>
<a href="#l11.425"></a><span id="l11.425"> </span>
<a href="#l11.426"></a><span id="l11.426" class="difflineminus">-  uint32_t    written;</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineplus">+  uint32_t written;</span>
<a href="#l11.428"></a><span id="l11.428">   Write(nsDependentCString(buf), &amp;written);</span>
<a href="#l11.429"></a><span id="l11.429">   Write(NS_LITERAL_CSTRING(CRLF), &amp;written);</span>
<a href="#l11.430"></a><span id="l11.430">   return NS_OK;</span>
<a href="#l11.431"></a><span id="l11.431"> }</span>
<a href="#l11.432"></a><span id="l11.432"> </span>
<a href="#l11.433"></a><span id="l11.433"> NS_IMETHODIMP</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineminus">-nsMimeBaseEmitter::Write(const nsACString &amp;buf, uint32_t *amountWritten)</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineminus">-{</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineminus">-  unsigned int        written = 0;</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineplus">+nsMimeBaseEmitter::Write(const nsACString &amp;buf, uint32_t *amountWritten) {</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineplus">+  unsigned int written = 0;</span>
<a href="#l11.439"></a><span id="l11.439">   nsresult rv = NS_OK;</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineminus">-  uint32_t            needToWrite;</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineplus">+  uint32_t needToWrite;</span>
<a href="#l11.442"></a><span id="l11.442"> </span>
<a href="#l11.443"></a><span id="l11.443"> #ifdef DEBUG_BenB</span>
<a href="#l11.444"></a><span id="l11.444">   // If you want to see libmime output...</span>
<a href="#l11.445"></a><span id="l11.445">   printf(&quot;%s&quot;, buf);</span>
<a href="#l11.446"></a><span id="l11.446"> #endif</span>
<a href="#l11.447"></a><span id="l11.447"> </span>
<a href="#l11.448"></a><span id="l11.448" class="difflineminus">-  MOZ_LOG(gMimeEmitterLogModule, mozilla::LogLevel::Info, (&quot;%s&quot;, PromiseFlatCString(buf).get()));</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineplus">+  MOZ_LOG(gMimeEmitterLogModule, mozilla::LogLevel::Info,</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineplus">+          (&quot;%s&quot;, PromiseFlatCString(buf).get()));</span>
<a href="#l11.451"></a><span id="l11.451">   //</span>
<a href="#l11.452"></a><span id="l11.452">   // Make sure that the buffer we are &quot;pushing&quot; into has enough room</span>
<a href="#l11.453"></a><span id="l11.453">   // for the write operation. If not, we have to buffer, return, and get</span>
<a href="#l11.454"></a><span id="l11.454">   // it on the next time through</span>
<a href="#l11.455"></a><span id="l11.455">   //</span>
<a href="#l11.456"></a><span id="l11.456">   *amountWritten = 0;</span>
<a href="#l11.457"></a><span id="l11.457"> </span>
<a href="#l11.458"></a><span id="l11.458">   needToWrite = mBufferMgr-&gt;GetSize();</span>
<a href="#l11.459"></a><span id="l11.459">   // First, handle any old buffer data...</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineminus">-  if (needToWrite &gt; 0)</span>
<a href="#l11.461"></a><span id="l11.461" class="difflineminus">-  {</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineplus">+  if (needToWrite &gt; 0) {</span>
<a href="#l11.463"></a><span id="l11.463">     rv = WriteHelper(mBufferMgr-&gt;GetBuffer(), &amp;written);</span>
<a href="#l11.464"></a><span id="l11.464"> </span>
<a href="#l11.465"></a><span id="l11.465">     mTotalWritten += written;</span>
<a href="#l11.466"></a><span id="l11.466">     mBufferMgr-&gt;ReduceBuffer(written);</span>
<a href="#l11.467"></a><span id="l11.467">     *amountWritten = written;</span>
<a href="#l11.468"></a><span id="l11.468"> </span>
<a href="#l11.469"></a><span id="l11.469">     // if we couldn't write all the old data, buffer the new data</span>
<a href="#l11.470"></a><span id="l11.470">     // and return</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineminus">-    if (mBufferMgr-&gt;GetSize() &gt; 0)</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineminus">-    {</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineplus">+    if (mBufferMgr-&gt;GetSize() &gt; 0) {</span>
<a href="#l11.474"></a><span id="l11.474">       mBufferMgr-&gt;IncreaseBuffer(buf);</span>
<a href="#l11.475"></a><span id="l11.475">       return rv;</span>
<a href="#l11.476"></a><span id="l11.476">     }</span>
<a href="#l11.477"></a><span id="l11.477">   }</span>
<a href="#l11.478"></a><span id="l11.478"> </span>
<a href="#l11.479"></a><span id="l11.479" class="difflineminus">-</span>
<a href="#l11.480"></a><span id="l11.480">   // if we get here, we are dealing with new data...try to write</span>
<a href="#l11.481"></a><span id="l11.481">   // and then do the right thing...</span>
<a href="#l11.482"></a><span id="l11.482">   rv = WriteHelper(buf, &amp;written);</span>
<a href="#l11.483"></a><span id="l11.483">   *amountWritten = written;</span>
<a href="#l11.484"></a><span id="l11.484">   mTotalWritten += written;</span>
<a href="#l11.485"></a><span id="l11.485"> </span>
<a href="#l11.486"></a><span id="l11.486">   if (written &lt; buf.Length()) {</span>
<a href="#l11.487"></a><span id="l11.487">     const nsACString &amp;remainder = Substring(buf, written);</span>
<a href="#l11.488"></a><span id="l11.488">     mBufferMgr-&gt;IncreaseBuffer(remainder);</span>
<a href="#l11.489"></a><span id="l11.489">   }</span>
<a href="#l11.490"></a><span id="l11.490"> </span>
<a href="#l11.491"></a><span id="l11.491">   return rv;</span>
<a href="#l11.492"></a><span id="l11.492"> }</span>
<a href="#l11.493"></a><span id="l11.493"> </span>
<a href="#l11.494"></a><span id="l11.494" class="difflineminus">-nsresult</span>
<a href="#l11.495"></a><span id="l11.495" class="difflineminus">-nsMimeBaseEmitter::WriteHelper(const nsACString &amp;buf, uint32_t *countWritten)</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineminus">-{</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineplus">+nsresult nsMimeBaseEmitter::WriteHelper(const nsACString &amp;buf,</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineplus">+                                        uint32_t *countWritten) {</span>
<a href="#l11.499"></a><span id="l11.499">   NS_ENSURE_TRUE(mOutStream, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l11.500"></a><span id="l11.500"> </span>
<a href="#l11.501"></a><span id="l11.501" class="difflineminus">-  nsresult rv = mOutStream-&gt;Write(buf.BeginReading(), buf.Length(), countWritten);</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineplus">+  nsresult rv =</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+      mOutStream-&gt;Write(buf.BeginReading(), buf.Length(), countWritten);</span>
<a href="#l11.504"></a><span id="l11.504">   if (rv == NS_BASE_STREAM_WOULD_BLOCK) {</span>
<a href="#l11.505"></a><span id="l11.505">     // pipe is full, push contents of pipe to listener...</span>
<a href="#l11.506"></a><span id="l11.506">     uint64_t avail;</span>
<a href="#l11.507"></a><span id="l11.507">     rv = mInputStream-&gt;Available(&amp;avail);</span>
<a href="#l11.508"></a><span id="l11.508">     if (NS_SUCCEEDED(rv) &amp;&amp; avail) {</span>
<a href="#l11.509"></a><span id="l11.509">       mOutListener-&gt;OnDataAvailable(mChannel, mInputStream, 0,</span>
<a href="#l11.510"></a><span id="l11.510">                                     std::min(avail, uint64_t(PR_UINT32_MAX)));</span>
<a href="#l11.511"></a><span id="l11.511"> </span>
<a href="#l11.512"></a><span id="l11.512" class="difflineat">@@ -479,103 +430,89 @@ nsMimeBaseEmitter::WriteHelper(const nsA</span>
<a href="#l11.513"></a><span id="l11.513">     }</span>
<a href="#l11.514"></a><span id="l11.514">   }</span>
<a href="#l11.515"></a><span id="l11.515">   return rv;</span>
<a href="#l11.516"></a><span id="l11.516"> }</span>
<a href="#l11.517"></a><span id="l11.517"> </span>
<a href="#l11.518"></a><span id="l11.518"> //</span>
<a href="#l11.519"></a><span id="l11.519"> // Find a cached header! Note: Do NOT free this value!</span>
<a href="#l11.520"></a><span id="l11.520"> //</span>
<a href="#l11.521"></a><span id="l11.521" class="difflineminus">-const char *</span>
<a href="#l11.522"></a><span id="l11.522" class="difflineminus">-nsMimeBaseEmitter::GetHeaderValue(const char  *aHeaderName)</span>
<a href="#l11.523"></a><span id="l11.523" class="difflineminus">-{</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineminus">-  char        *retVal = nullptr;</span>
<a href="#l11.525"></a><span id="l11.525" class="difflineminus">-  nsTArray&lt;headerInfoType*&gt; *array = mDocHeader? mHeaderArray : mEmbeddedHeaderArray;</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineplus">+const char *nsMimeBaseEmitter::GetHeaderValue(const char *aHeaderName) {</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineplus">+  char *retVal = nullptr;</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineplus">+  nsTArray&lt;headerInfoType *&gt; *array =</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineplus">+      mDocHeader ? mHeaderArray : mEmbeddedHeaderArray;</span>
<a href="#l11.530"></a><span id="l11.530"> </span>
<a href="#l11.531"></a><span id="l11.531" class="difflineminus">-  if (!array)</span>
<a href="#l11.532"></a><span id="l11.532" class="difflineminus">-    return nullptr;</span>
<a href="#l11.533"></a><span id="l11.533" class="difflineplus">+  if (!array) return nullptr;</span>
<a href="#l11.534"></a><span id="l11.534"> </span>
<a href="#l11.535"></a><span id="l11.535" class="difflineminus">-  for (size_t i = 0; i &lt; array-&gt;Length(); i++)</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineminus">-  {</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineplus">+  for (size_t i = 0; i &lt; array-&gt;Length(); i++) {</span>
<a href="#l11.538"></a><span id="l11.538">     headerInfoType *headerInfo = array-&gt;ElementAt(i);</span>
<a href="#l11.539"></a><span id="l11.539" class="difflineminus">-    if ( (!headerInfo) || (!headerInfo-&gt;name) || (!(*headerInfo-&gt;name)) )</span>
<a href="#l11.540"></a><span id="l11.540" class="difflineplus">+    if ((!headerInfo) || (!headerInfo-&gt;name) || (!(*headerInfo-&gt;name)))</span>
<a href="#l11.541"></a><span id="l11.541">       continue;</span>
<a href="#l11.542"></a><span id="l11.542"> </span>
<a href="#l11.543"></a><span id="l11.543" class="difflineminus">-    if (!PL_strcasecmp(aHeaderName, headerInfo-&gt;name))</span>
<a href="#l11.544"></a><span id="l11.544" class="difflineminus">-    {</span>
<a href="#l11.545"></a><span id="l11.545" class="difflineplus">+    if (!PL_strcasecmp(aHeaderName, headerInfo-&gt;name)) {</span>
<a href="#l11.546"></a><span id="l11.546">       retVal = headerInfo-&gt;value;</span>
<a href="#l11.547"></a><span id="l11.547">       break;</span>
<a href="#l11.548"></a><span id="l11.548">     }</span>
<a href="#l11.549"></a><span id="l11.549">   }</span>
<a href="#l11.550"></a><span id="l11.550"> </span>
<a href="#l11.551"></a><span id="l11.551">   return retVal;</span>
<a href="#l11.552"></a><span id="l11.552"> }</span>
<a href="#l11.553"></a><span id="l11.553"> </span>
<a href="#l11.554"></a><span id="l11.554"> //</span>
<a href="#l11.555"></a><span id="l11.555" class="difflineminus">-// This is called at the start of the header block for all header information in ANY</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineminus">-// AND ALL MESSAGES (yes, quoted, attached, etc...)</span>
<a href="#l11.557"></a><span id="l11.557" class="difflineplus">+// This is called at the start of the header block for all header information in</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineplus">+// ANY AND ALL MESSAGES (yes, quoted, attached, etc...)</span>
<a href="#l11.559"></a><span id="l11.559"> //</span>
<a href="#l11.560"></a><span id="l11.560"> // NOTE: This will be called even when headers are will not follow. This is</span>
<a href="#l11.561"></a><span id="l11.561"> // to allow us to be notified of the charset of the original message. This is</span>
<a href="#l11.562"></a><span id="l11.562"> // important for forward and reply operations</span>
<a href="#l11.563"></a><span id="l11.563"> //</span>
<a href="#l11.564"></a><span id="l11.564"> NS_IMETHODIMP</span>
<a href="#l11.565"></a><span id="l11.565" class="difflineminus">-nsMimeBaseEmitter::StartHeader(bool rootMailHeader, bool headerOnly, const char *msgID,</span>
<a href="#l11.566"></a><span id="l11.566" class="difflineminus">-                               const char *outCharset)</span>
<a href="#l11.567"></a><span id="l11.567" class="difflineminus">-{</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineplus">+nsMimeBaseEmitter::StartHeader(bool rootMailHeader, bool headerOnly,</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineplus">+                               const char *msgID, const char *outCharset) {</span>
<a href="#l11.570"></a><span id="l11.570">   NS_ENSURE_ARG_POINTER(outCharset);</span>
<a href="#l11.571"></a><span id="l11.571"> </span>
<a href="#l11.572"></a><span id="l11.572">   mDocHeader = rootMailHeader;</span>
<a href="#l11.573"></a><span id="l11.573"> </span>
<a href="#l11.574"></a><span id="l11.574">   // If this is not the mail messages header, then we need to create</span>
<a href="#l11.575"></a><span id="l11.575">   // the mEmbeddedHeaderArray structure for use with this internal header</span>
<a href="#l11.576"></a><span id="l11.576">   // structure.</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineminus">-  if (!mDocHeader)</span>
<a href="#l11.578"></a><span id="l11.578" class="difflineminus">-  {</span>
<a href="#l11.579"></a><span id="l11.579" class="difflineminus">-    if (mEmbeddedHeaderArray)</span>
<a href="#l11.580"></a><span id="l11.580" class="difflineminus">-      CleanupHeaderArray(mEmbeddedHeaderArray);</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineplus">+  if (!mDocHeader) {</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineplus">+    if (mEmbeddedHeaderArray) CleanupHeaderArray(mEmbeddedHeaderArray);</span>
<a href="#l11.583"></a><span id="l11.583"> </span>
<a href="#l11.584"></a><span id="l11.584" class="difflineminus">-    mEmbeddedHeaderArray = new nsTArray&lt;headerInfoType*&gt;();</span>
<a href="#l11.585"></a><span id="l11.585" class="difflineplus">+    mEmbeddedHeaderArray = new nsTArray&lt;headerInfoType *&gt;();</span>
<a href="#l11.586"></a><span id="l11.586">     NS_ENSURE_TRUE(mEmbeddedHeaderArray, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l11.587"></a><span id="l11.587">   }</span>
<a href="#l11.588"></a><span id="l11.588"> </span>
<a href="#l11.589"></a><span id="l11.589">   // If the main doc, check on updated character set</span>
<a href="#l11.590"></a><span id="l11.590" class="difflineminus">-  if (mDocHeader)</span>
<a href="#l11.591"></a><span id="l11.591" class="difflineminus">-    UpdateCharacterSet(outCharset);</span>
<a href="#l11.592"></a><span id="l11.592" class="difflineplus">+  if (mDocHeader) UpdateCharacterSet(outCharset);</span>
<a href="#l11.593"></a><span id="l11.593">   CopyASCIItoUTF16(nsDependentCString(outCharset), mCharset);</span>
<a href="#l11.594"></a><span id="l11.594">   return NS_OK;</span>
<a href="#l11.595"></a><span id="l11.595"> }</span>
<a href="#l11.596"></a><span id="l11.596"> </span>
<a href="#l11.597"></a><span id="l11.597"> // Ok, if we are here, and we have a aCharset passed in that is not</span>
<a href="#l11.598"></a><span id="l11.598"> // UTF-8 or US-ASCII, then we should tag the mChannel member with this</span>
<a href="#l11.599"></a><span id="l11.599"> // charset. This is because replying to messages with specified charset's</span>
<a href="#l11.600"></a><span id="l11.600"> // need to be tagged as that charset by default.</span>
<a href="#l11.601"></a><span id="l11.601"> //</span>
<a href="#l11.602"></a><span id="l11.602"> NS_IMETHODIMP</span>
<a href="#l11.603"></a><span id="l11.603" class="difflineminus">-nsMimeBaseEmitter::UpdateCharacterSet(const char *aCharset)</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineminus">-{</span>
<a href="#l11.605"></a><span id="l11.605" class="difflineminus">-  if (aCharset)</span>
<a href="#l11.606"></a><span id="l11.606" class="difflineminus">-  {</span>
<a href="#l11.607"></a><span id="l11.607" class="difflineplus">+nsMimeBaseEmitter::UpdateCharacterSet(const char *aCharset) {</span>
<a href="#l11.608"></a><span id="l11.608" class="difflineplus">+  if (aCharset) {</span>
<a href="#l11.609"></a><span id="l11.609">     nsAutoCString contentType;</span>
<a href="#l11.610"></a><span id="l11.610"> </span>
<a href="#l11.611"></a><span id="l11.611" class="difflineminus">-    if (NS_SUCCEEDED(mChannel-&gt;GetContentType(contentType)) &amp;&amp; !contentType.IsEmpty())</span>
<a href="#l11.612"></a><span id="l11.612" class="difflineminus">-    {</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineplus">+    if (NS_SUCCEEDED(mChannel-&gt;GetContentType(contentType)) &amp;&amp;</span>
<a href="#l11.614"></a><span id="l11.614" class="difflineplus">+        !contentType.IsEmpty()) {</span>
<a href="#l11.615"></a><span id="l11.615">       char *cBegin = contentType.BeginWriting();</span>
<a href="#l11.616"></a><span id="l11.616"> </span>
<a href="#l11.617"></a><span id="l11.617">       const char *cPtr = PL_strcasestr(cBegin, &quot;charset=&quot;);</span>
<a href="#l11.618"></a><span id="l11.618"> </span>
<a href="#l11.619"></a><span id="l11.619" class="difflineminus">-      if (cPtr)</span>
<a href="#l11.620"></a><span id="l11.620" class="difflineminus">-      {</span>
<a href="#l11.621"></a><span id="l11.621" class="difflineminus">-        char  *ptr = cBegin;</span>
<a href="#l11.622"></a><span id="l11.622" class="difflineminus">-        while (*ptr)</span>
<a href="#l11.623"></a><span id="l11.623" class="difflineminus">-        {</span>
<a href="#l11.624"></a><span id="l11.624" class="difflineminus">-          if ( (*ptr == ' ') || (*ptr == ';') )</span>
<a href="#l11.625"></a><span id="l11.625" class="difflineminus">-          {</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineminus">-            if ((ptr + 1) &gt;= cPtr)</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineminus">-            {</span>
<a href="#l11.628"></a><span id="l11.628" class="difflineplus">+      if (cPtr) {</span>
<a href="#l11.629"></a><span id="l11.629" class="difflineplus">+        char *ptr = cBegin;</span>
<a href="#l11.630"></a><span id="l11.630" class="difflineplus">+        while (*ptr) {</span>
<a href="#l11.631"></a><span id="l11.631" class="difflineplus">+          if ((*ptr == ' ') || (*ptr == ';')) {</span>
<a href="#l11.632"></a><span id="l11.632" class="difflineplus">+            if ((ptr + 1) &gt;= cPtr) {</span>
<a href="#l11.633"></a><span id="l11.633">               *ptr = '\0';</span>
<a href="#l11.634"></a><span id="l11.634">               break;</span>
<a href="#l11.635"></a><span id="l11.635">             }</span>
<a href="#l11.636"></a><span id="l11.636">           }</span>
<a href="#l11.637"></a><span id="l11.637"> </span>
<a href="#l11.638"></a><span id="l11.638">           ++ptr;</span>
<a href="#l11.639"></a><span id="l11.639">         }</span>
<a href="#l11.640"></a><span id="l11.640">       }</span>
<a href="#l11.641"></a><span id="l11.641" class="difflineat">@@ -593,253 +530,236 @@ nsMimeBaseEmitter::UpdateCharacterSet(co</span>
<a href="#l11.642"></a><span id="l11.642">   return NS_OK;</span>
<a href="#l11.643"></a><span id="l11.643"> }</span>
<a href="#l11.644"></a><span id="l11.644"> </span>
<a href="#l11.645"></a><span id="l11.645"> //</span>
<a href="#l11.646"></a><span id="l11.646"> // This will be called for every header field regardless if it is in an</span>
<a href="#l11.647"></a><span id="l11.647"> // internal body or the outer message.</span>
<a href="#l11.648"></a><span id="l11.648"> //</span>
<a href="#l11.649"></a><span id="l11.649"> NS_IMETHODIMP</span>
<a href="#l11.650"></a><span id="l11.650" class="difflineminus">-nsMimeBaseEmitter::AddHeaderField(const char *field, const char *value)</span>
<a href="#l11.651"></a><span id="l11.651" class="difflineminus">-{</span>
<a href="#l11.652"></a><span id="l11.652" class="difflineminus">-  if ( (!field) || (!value) )</span>
<a href="#l11.653"></a><span id="l11.653" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.654"></a><span id="l11.654" class="difflineplus">+nsMimeBaseEmitter::AddHeaderField(const char *field, const char *value) {</span>
<a href="#l11.655"></a><span id="l11.655" class="difflineplus">+  if ((!field) || (!value)) return NS_OK;</span>
<a href="#l11.656"></a><span id="l11.656"> </span>
<a href="#l11.657"></a><span id="l11.657" class="difflineminus">-  nsTArray&lt;headerInfoType*&gt;  *tPtr;</span>
<a href="#l11.658"></a><span id="l11.658" class="difflineplus">+  nsTArray&lt;headerInfoType *&gt; *tPtr;</span>
<a href="#l11.659"></a><span id="l11.659">   if (mDocHeader)</span>
<a href="#l11.660"></a><span id="l11.660">     tPtr = mHeaderArray;</span>
<a href="#l11.661"></a><span id="l11.661">   else</span>
<a href="#l11.662"></a><span id="l11.662">     tPtr = mEmbeddedHeaderArray;</span>
<a href="#l11.663"></a><span id="l11.663"> </span>
<a href="#l11.664"></a><span id="l11.664">   // This is a header so we need to cache and output later.</span>
<a href="#l11.665"></a><span id="l11.665">   // Ok, now we will setup the header info for the header array!</span>
<a href="#l11.666"></a><span id="l11.666" class="difflineminus">-  headerInfoType  *ptr = (headerInfoType *) PR_NEWZAP(headerInfoType);</span>
<a href="#l11.667"></a><span id="l11.667" class="difflineminus">-  if ( (ptr) &amp;&amp; tPtr)</span>
<a href="#l11.668"></a><span id="l11.668" class="difflineminus">-  {</span>
<a href="#l11.669"></a><span id="l11.669" class="difflineplus">+  headerInfoType *ptr = (headerInfoType *)PR_NEWZAP(headerInfoType);</span>
<a href="#l11.670"></a><span id="l11.670" class="difflineplus">+  if ((ptr) &amp;&amp; tPtr) {</span>
<a href="#l11.671"></a><span id="l11.671">     ptr-&gt;name = strdup(field);</span>
<a href="#l11.672"></a><span id="l11.672">     ptr-&gt;value = strdup(value);</span>
<a href="#l11.673"></a><span id="l11.673">     tPtr-&gt;AppendElement(ptr);</span>
<a href="#l11.674"></a><span id="l11.674">   }</span>
<a href="#l11.675"></a><span id="l11.675"> </span>
<a href="#l11.676"></a><span id="l11.676">   return NS_OK;</span>
<a href="#l11.677"></a><span id="l11.677"> }</span>
<a href="#l11.678"></a><span id="l11.678"> </span>
<a href="#l11.679"></a><span id="l11.679"> NS_IMETHODIMP</span>
<a href="#l11.680"></a><span id="l11.680" class="difflineminus">-nsMimeBaseEmitter::AddAllHeaders(const nsACString &amp;allheaders)</span>
<a href="#l11.681"></a><span id="l11.681" class="difflineminus">-{</span>
<a href="#l11.682"></a><span id="l11.682" class="difflineminus">-  if (mDocHeader) //We want to set only the main headers of a message, not the potentially embedded one</span>
<a href="#l11.683"></a><span id="l11.683" class="difflineplus">+nsMimeBaseEmitter::AddAllHeaders(const nsACString &amp;allheaders) {</span>
<a href="#l11.684"></a><span id="l11.684" class="difflineplus">+  if (mDocHeader)  // We want to set only the main headers of a message, not the</span>
<a href="#l11.685"></a><span id="l11.685" class="difflineplus">+                   // potentially embedded one</span>
<a href="#l11.686"></a><span id="l11.686">   {</span>
<a href="#l11.687"></a><span id="l11.687">     nsresult rv;</span>
<a href="#l11.688"></a><span id="l11.688" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(mURL));</span>
<a href="#l11.689"></a><span id="l11.689" class="difflineminus">-    if (msgurl)</span>
<a href="#l11.690"></a><span id="l11.690" class="difflineminus">-    {</span>
<a href="#l11.691"></a><span id="l11.691" class="difflineminus">-        nsCOMPtr&lt;nsIMimeHeaders&gt; mimeHeaders = do_CreateInstance(NS_IMIMEHEADERS_CONTRACTID, &amp;rv);</span>
<a href="#l11.692"></a><span id="l11.692" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.693"></a><span id="l11.693" class="difflineminus">-        mimeHeaders-&gt;Initialize(allheaders);</span>
<a href="#l11.694"></a><span id="l11.694" class="difflineminus">-        msgurl-&gt;SetMimeHeaders(mimeHeaders);</span>
<a href="#l11.695"></a><span id="l11.695" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(mURL));</span>
<a href="#l11.696"></a><span id="l11.696" class="difflineplus">+    if (msgurl) {</span>
<a href="#l11.697"></a><span id="l11.697" class="difflineplus">+      nsCOMPtr&lt;nsIMimeHeaders&gt; mimeHeaders =</span>
<a href="#l11.698"></a><span id="l11.698" class="difflineplus">+          do_CreateInstance(NS_IMIMEHEADERS_CONTRACTID, &amp;rv);</span>
<a href="#l11.699"></a><span id="l11.699" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.700"></a><span id="l11.700" class="difflineplus">+      mimeHeaders-&gt;Initialize(allheaders);</span>
<a href="#l11.701"></a><span id="l11.701" class="difflineplus">+      msgurl-&gt;SetMimeHeaders(mimeHeaders);</span>
<a href="#l11.702"></a><span id="l11.702">     }</span>
<a href="#l11.703"></a><span id="l11.703">   }</span>
<a href="#l11.704"></a><span id="l11.704">   return NS_OK;</span>
<a href="#l11.705"></a><span id="l11.705"> }</span>
<a href="#l11.706"></a><span id="l11.706"> </span>
<a href="#l11.707"></a><span id="l11.707"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.708"></a><span id="l11.708"> // The following code is responsible for formatting headers in a manner that is</span>
<a href="#l11.709"></a><span id="l11.709"> // identical to the normal XUL output.</span>
<a href="#l11.710"></a><span id="l11.710"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.711"></a><span id="l11.711"> </span>
<a href="#l11.712"></a><span id="l11.712" class="difflineminus">-nsresult</span>
<a href="#l11.713"></a><span id="l11.713" class="difflineminus">-nsMimeBaseEmitter::GenerateDateString(const char * dateString,</span>
<a href="#l11.714"></a><span id="l11.714" class="difflineminus">-                                      nsACString &amp;formattedDate,</span>
<a href="#l11.715"></a><span id="l11.715" class="difflineminus">-                                      bool showDateForToday)</span>
<a href="#l11.716"></a><span id="l11.716" class="difflineminus">-{</span>
<a href="#l11.717"></a><span id="l11.717" class="difflineplus">+nsresult nsMimeBaseEmitter::GenerateDateString(const char *dateString,</span>
<a href="#l11.718"></a><span id="l11.718" class="difflineplus">+                                               nsACString &amp;formattedDate,</span>
<a href="#l11.719"></a><span id="l11.719" class="difflineplus">+                                               bool showDateForToday) {</span>
<a href="#l11.720"></a><span id="l11.720">   nsresult rv = NS_OK;</span>
<a href="#l11.721"></a><span id="l11.721"> </span>
<a href="#l11.722"></a><span id="l11.722">   /**</span>
<a href="#l11.723"></a><span id="l11.723">    * See if the user wants to have the date displayed in the senders</span>
<a href="#l11.724"></a><span id="l11.724">    * timezone (including the timezone offset).</span>
<a href="#l11.725"></a><span id="l11.725">    * We also evaluate the pref original_date which was introduced</span>
<a href="#l11.726"></a><span id="l11.726">    * as makeshift in bug 118899.</span>
<a href="#l11.727"></a><span id="l11.727">    */</span>
<a href="#l11.728"></a><span id="l11.728">   bool displaySenderTimezone = false;</span>
<a href="#l11.729"></a><span id="l11.729">   bool displayOriginalDate = false;</span>
<a href="#l11.730"></a><span id="l11.730"> </span>
<a href="#l11.731"></a><span id="l11.731" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l11.732"></a><span id="l11.732" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefs =</span>
<a href="#l11.733"></a><span id="l11.733" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l11.734"></a><span id="l11.734">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.735"></a><span id="l11.735"> </span>
<a href="#l11.736"></a><span id="l11.736">   nsCOMPtr&lt;nsIPrefBranch&gt; dateFormatPrefs;</span>
<a href="#l11.737"></a><span id="l11.737">   rv = prefs-&gt;GetBranch(&quot;mailnews.display.&quot;, getter_AddRefs(dateFormatPrefs));</span>
<a href="#l11.738"></a><span id="l11.738">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.739"></a><span id="l11.739"> </span>
<a href="#l11.740"></a><span id="l11.740">   dateFormatPrefs-&gt;GetBoolPref(&quot;date_senders_timezone&quot;, &amp;displaySenderTimezone);</span>
<a href="#l11.741"></a><span id="l11.741">   dateFormatPrefs-&gt;GetBoolPref(&quot;original_date&quot;, &amp;displayOriginalDate);</span>
<a href="#l11.742"></a><span id="l11.742">   // migrate old pref to date_senders_timezone</span>
<a href="#l11.743"></a><span id="l11.743">   if (displayOriginalDate &amp;&amp; !displaySenderTimezone)</span>
<a href="#l11.744"></a><span id="l11.744">     dateFormatPrefs-&gt;SetBoolPref(&quot;date_senders_timezone&quot;, true);</span>
<a href="#l11.745"></a><span id="l11.745"> </span>
<a href="#l11.746"></a><span id="l11.746">   PRExplodedTime explodedMsgTime;</span>
<a href="#l11.747"></a><span id="l11.747"> </span>
<a href="#l11.748"></a><span id="l11.748">   // Bogus date string may leave some fields uninitialized, so take precaution.</span>
<a href="#l11.749"></a><span id="l11.749" class="difflineminus">-  memset(&amp;explodedMsgTime, 0, sizeof (PRExplodedTime));</span>
<a href="#l11.750"></a><span id="l11.750" class="difflineplus">+  memset(&amp;explodedMsgTime, 0, sizeof(PRExplodedTime));</span>
<a href="#l11.751"></a><span id="l11.751"> </span>
<a href="#l11.752"></a><span id="l11.752" class="difflineminus">-  if (PR_ParseTimeStringToExplodedTime(dateString, false, &amp;explodedMsgTime) != PR_SUCCESS)</span>
<a href="#l11.753"></a><span id="l11.753" class="difflineplus">+  if (PR_ParseTimeStringToExplodedTime(dateString, false, &amp;explodedMsgTime) !=</span>
<a href="#l11.754"></a><span id="l11.754" class="difflineplus">+      PR_SUCCESS)</span>
<a href="#l11.755"></a><span id="l11.755">     return NS_ERROR_FAILURE;</span>
<a href="#l11.756"></a><span id="l11.756"> </span>
<a href="#l11.757"></a><span id="l11.757">   /**</span>
<a href="#l11.758"></a><span id="l11.758">    * To determine the date format to use, comparison of current and message</span>
<a href="#l11.759"></a><span id="l11.759">    * time has to be made. If displaying in local time, both timestamps have</span>
<a href="#l11.760"></a><span id="l11.760">    * to be in local time. If displaying in senders time zone, leave the compare</span>
<a href="#l11.761"></a><span id="l11.761">    * time in that time zone.</span>
<a href="#l11.762"></a><span id="l11.762">    * Otherwise in TZ+0100 on 2009-03-12 a message from 2009-03-11T20:49-0700</span>
<a href="#l11.763"></a><span id="l11.763">    * would be displayed as &quot;20:49 -0700&quot; though it in fact is not from the</span>
<a href="#l11.764"></a><span id="l11.764">    * same day.</span>
<a href="#l11.765"></a><span id="l11.765">    */</span>
<a href="#l11.766"></a><span id="l11.766">   PRExplodedTime explodedCompTime;</span>
<a href="#l11.767"></a><span id="l11.767">   if (displaySenderTimezone)</span>
<a href="#l11.768"></a><span id="l11.768">     explodedCompTime = explodedMsgTime;</span>
<a href="#l11.769"></a><span id="l11.769">   else</span>
<a href="#l11.770"></a><span id="l11.770" class="difflineminus">-    PR_ExplodeTime(PR_ImplodeTime(&amp;explodedMsgTime), PR_LocalTimeParameters, &amp;explodedCompTime);</span>
<a href="#l11.771"></a><span id="l11.771" class="difflineplus">+    PR_ExplodeTime(PR_ImplodeTime(&amp;explodedMsgTime), PR_LocalTimeParameters,</span>
<a href="#l11.772"></a><span id="l11.772" class="difflineplus">+                   &amp;explodedCompTime);</span>
<a href="#l11.773"></a><span id="l11.773"> </span>
<a href="#l11.774"></a><span id="l11.774">   PRExplodedTime explodedCurrentTime;</span>
<a href="#l11.775"></a><span id="l11.775">   PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;explodedCurrentTime);</span>
<a href="#l11.776"></a><span id="l11.776"> </span>
<a href="#l11.777"></a><span id="l11.777">   // If we want short dates, check if the message is from today, and if so</span>
<a href="#l11.778"></a><span id="l11.778">   // only show the time (e.g. 3:15 pm).</span>
<a href="#l11.779"></a><span id="l11.779">   mozilla::nsDateFormatSelector dateFormat = mozilla::kDateFormatShort;</span>
<a href="#l11.780"></a><span id="l11.780">   if (!showDateForToday &amp;&amp;</span>
<a href="#l11.781"></a><span id="l11.781">       explodedCurrentTime.tm_year == explodedCompTime.tm_year &amp;&amp;</span>
<a href="#l11.782"></a><span id="l11.782">       explodedCurrentTime.tm_month == explodedCompTime.tm_month &amp;&amp;</span>
<a href="#l11.783"></a><span id="l11.783" class="difflineminus">-      explodedCurrentTime.tm_mday == explodedCompTime.tm_mday)</span>
<a href="#l11.784"></a><span id="l11.784" class="difflineminus">-  {</span>
<a href="#l11.785"></a><span id="l11.785" class="difflineplus">+      explodedCurrentTime.tm_mday == explodedCompTime.tm_mday) {</span>
<a href="#l11.786"></a><span id="l11.786">     // same day...</span>
<a href="#l11.787"></a><span id="l11.787">     dateFormat = mozilla::kDateFormatNone;</span>
<a href="#l11.788"></a><span id="l11.788">   }</span>
<a href="#l11.789"></a><span id="l11.789"> </span>
<a href="#l11.790"></a><span id="l11.790">   nsAutoString formattedDateString;</span>
<a href="#l11.791"></a><span id="l11.791"> </span>
<a href="#l11.792"></a><span id="l11.792" class="difflineminus">-  rv = mozilla::DateTimeFormat::FormatPRExplodedTime(dateFormat,</span>
<a href="#l11.793"></a><span id="l11.793" class="difflineminus">-                                                     mozilla::kTimeFormatNoSeconds,</span>
<a href="#l11.794"></a><span id="l11.794" class="difflineminus">-                                                     &amp;explodedCompTime,</span>
<a href="#l11.795"></a><span id="l11.795" class="difflineminus">-                                                     formattedDateString);</span>
<a href="#l11.796"></a><span id="l11.796" class="difflineplus">+  rv = mozilla::DateTimeFormat::FormatPRExplodedTime(</span>
<a href="#l11.797"></a><span id="l11.797" class="difflineplus">+      dateFormat, mozilla::kTimeFormatNoSeconds, &amp;explodedCompTime,</span>
<a href="#l11.798"></a><span id="l11.798" class="difflineplus">+      formattedDateString);</span>
<a href="#l11.799"></a><span id="l11.799"> </span>
<a href="#l11.800"></a><span id="l11.800" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l11.801"></a><span id="l11.801" class="difflineminus">-  {</span>
<a href="#l11.802"></a><span id="l11.802" class="difflineminus">-    if (displaySenderTimezone)</span>
<a href="#l11.803"></a><span id="l11.803" class="difflineminus">-    {</span>
<a href="#l11.804"></a><span id="l11.804" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.805"></a><span id="l11.805" class="difflineplus">+    if (displaySenderTimezone) {</span>
<a href="#l11.806"></a><span id="l11.806">       // offset of local time from UTC in minutes</span>
<a href="#l11.807"></a><span id="l11.807">       int32_t senderoffset = (explodedMsgTime.tm_params.tp_gmt_offset +</span>
<a href="#l11.808"></a><span id="l11.808" class="difflineminus">-                              explodedMsgTime.tm_params.tp_dst_offset) / 60;</span>
<a href="#l11.809"></a><span id="l11.809" class="difflineplus">+                              explodedMsgTime.tm_params.tp_dst_offset) /</span>
<a href="#l11.810"></a><span id="l11.810" class="difflineplus">+                             60;</span>
<a href="#l11.811"></a><span id="l11.811">       // append offset to date string</span>
<a href="#l11.812"></a><span id="l11.812">       nsString tzstring;</span>
<a href="#l11.813"></a><span id="l11.813" class="difflineminus">-      nsTextFormatter::ssprintf(tzstring, u&quot; %+05d&quot;,</span>
<a href="#l11.814"></a><span id="l11.814" class="difflineminus">-                                (senderoffset / 60 * 100) +</span>
<a href="#l11.815"></a><span id="l11.815" class="difflineminus">-                                (senderoffset % 60));</span>
<a href="#l11.816"></a><span id="l11.816" class="difflineplus">+      nsTextFormatter::ssprintf(</span>
<a href="#l11.817"></a><span id="l11.817" class="difflineplus">+          tzstring, u&quot; %+05d&quot;, (senderoffset / 60 * 100) + (senderoffset % 60));</span>
<a href="#l11.818"></a><span id="l11.818">       formattedDateString.Append(tzstring);</span>
<a href="#l11.819"></a><span id="l11.819">     }</span>
<a href="#l11.820"></a><span id="l11.820"> </span>
<a href="#l11.821"></a><span id="l11.821">     CopyUTF16toUTF8(formattedDateString, formattedDate);</span>
<a href="#l11.822"></a><span id="l11.822">   }</span>
<a href="#l11.823"></a><span id="l11.823"> </span>
<a href="#l11.824"></a><span id="l11.824">   return rv;</span>
<a href="#l11.825"></a><span id="l11.825"> }</span>
<a href="#l11.826"></a><span id="l11.826"> </span>
<a href="#l11.827"></a><span id="l11.827" class="difflineminus">-char*</span>
<a href="#l11.828"></a><span id="l11.828" class="difflineminus">-nsMimeBaseEmitter::GetLocalizedDateString(const char * dateString)</span>
<a href="#l11.829"></a><span id="l11.829" class="difflineminus">-{</span>
<a href="#l11.830"></a><span id="l11.830" class="difflineplus">+char *nsMimeBaseEmitter::GetLocalizedDateString(const char *dateString) {</span>
<a href="#l11.831"></a><span id="l11.831">   char *i18nValue = nullptr;</span>
<a href="#l11.832"></a><span id="l11.832"> </span>
<a href="#l11.833"></a><span id="l11.833">   bool displayOriginalDate = false;</span>
<a href="#l11.834"></a><span id="l11.834">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l11.835"></a><span id="l11.835"> </span>
<a href="#l11.836"></a><span id="l11.836">   if (prefBranch)</span>
<a href="#l11.837"></a><span id="l11.837">     prefBranch-&gt;GetBoolPref(&quot;mailnews.display.original_date&quot;,</span>
<a href="#l11.838"></a><span id="l11.838">                             &amp;displayOriginalDate);</span>
<a href="#l11.839"></a><span id="l11.839"> </span>
<a href="#l11.840"></a><span id="l11.840" class="difflineminus">-  if (!displayOriginalDate)</span>
<a href="#l11.841"></a><span id="l11.841" class="difflineminus">-  {</span>
<a href="#l11.842"></a><span id="l11.842" class="difflineplus">+  if (!displayOriginalDate) {</span>
<a href="#l11.843"></a><span id="l11.843">     nsAutoCString convertedDateString;</span>
<a href="#l11.844"></a><span id="l11.844">     nsresult rv = GenerateDateString(dateString, convertedDateString, true);</span>
<a href="#l11.845"></a><span id="l11.845">     if (NS_SUCCEEDED(rv))</span>
<a href="#l11.846"></a><span id="l11.846">       i18nValue = strdup(convertedDateString.get());</span>
<a href="#l11.847"></a><span id="l11.847">     else</span>
<a href="#l11.848"></a><span id="l11.848">       i18nValue = strdup(dateString);</span>
<a href="#l11.849"></a><span id="l11.849" class="difflineminus">-  }</span>
<a href="#l11.850"></a><span id="l11.850" class="difflineminus">-  else</span>
<a href="#l11.851"></a><span id="l11.851" class="difflineplus">+  } else</span>
<a href="#l11.852"></a><span id="l11.852">     i18nValue = strdup(dateString);</span>
<a href="#l11.853"></a><span id="l11.853"> </span>
<a href="#l11.854"></a><span id="l11.854">   return i18nValue;</span>
<a href="#l11.855"></a><span id="l11.855"> }</span>
<a href="#l11.856"></a><span id="l11.856"> </span>
<a href="#l11.857"></a><span id="l11.857" class="difflineminus">-nsresult</span>
<a href="#l11.858"></a><span id="l11.858" class="difflineminus">-nsMimeBaseEmitter::WriteHeaderFieldHTML(const char *field, const char *value)</span>
<a href="#l11.859"></a><span id="l11.859" class="difflineminus">-{</span>
<a href="#l11.860"></a><span id="l11.860" class="difflineplus">+nsresult nsMimeBaseEmitter::WriteHeaderFieldHTML(const char *field,</span>
<a href="#l11.861"></a><span id="l11.861" class="difflineplus">+                                                 const char *value) {</span>
<a href="#l11.862"></a><span id="l11.862">   nsCString newValue;</span>
<a href="#l11.863"></a><span id="l11.863">   char *i18nValue = nullptr;</span>
<a href="#l11.864"></a><span id="l11.864"> </span>
<a href="#l11.865"></a><span id="l11.865" class="difflineminus">-  if ( (!field) || (!value) )</span>
<a href="#l11.866"></a><span id="l11.866" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.867"></a><span id="l11.867" class="difflineplus">+  if ((!field) || (!value)) return NS_OK;</span>
<a href="#l11.868"></a><span id="l11.868"> </span>
<a href="#l11.869"></a><span id="l11.869">   //</span>
<a href="#l11.870"></a><span id="l11.870">   // This is a check to see what the pref is for header display. If</span>
<a href="#l11.871"></a><span id="l11.871">   // We should only output stuff that corresponds with that setting.</span>
<a href="#l11.872"></a><span id="l11.872">   //</span>
<a href="#l11.873"></a><span id="l11.873" class="difflineminus">-  if (!EmitThisHeaderForPrefSetting(mHeaderDisplayType, field))</span>
<a href="#l11.874"></a><span id="l11.874" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.875"></a><span id="l11.875" class="difflineplus">+  if (!EmitThisHeaderForPrefSetting(mHeaderDisplayType, field)) return NS_OK;</span>
<a href="#l11.876"></a><span id="l11.876"> </span>
<a href="#l11.877"></a><span id="l11.877">   //</span>
<a href="#l11.878"></a><span id="l11.878">   // If we encounter the 'Date' header we try to convert it's value</span>
<a href="#l11.879"></a><span id="l11.879">   // into localized format.</span>
<a href="#l11.880"></a><span id="l11.880">   //</span>
<a href="#l11.881"></a><span id="l11.881" class="difflineminus">-  if ( strcmp(field, &quot;Date&quot;) == 0 )</span>
<a href="#l11.882"></a><span id="l11.882" class="difflineplus">+  if (strcmp(field, &quot;Date&quot;) == 0)</span>
<a href="#l11.883"></a><span id="l11.883">     i18nValue = GetLocalizedDateString(value);</span>
<a href="#l11.884"></a><span id="l11.884">   else</span>
<a href="#l11.885"></a><span id="l11.885">     i18nValue = strdup(value);</span>
<a href="#l11.886"></a><span id="l11.886"> </span>
<a href="#l11.887"></a><span id="l11.887" class="difflineminus">-  if ( (mUnicodeConverter) &amp;&amp; (mFormat != nsMimeOutput::nsMimeMessageSaveAs) )</span>
<a href="#l11.888"></a><span id="l11.888" class="difflineminus">-  {</span>
<a href="#l11.889"></a><span id="l11.889" class="difflineplus">+  if ((mUnicodeConverter) &amp;&amp; (mFormat != nsMimeOutput::nsMimeMessageSaveAs)) {</span>
<a href="#l11.890"></a><span id="l11.890">     nsCString tValue;</span>
<a href="#l11.891"></a><span id="l11.891"> </span>
<a href="#l11.892"></a><span id="l11.892">     // we're going to need a converter to convert</span>
<a href="#l11.893"></a><span id="l11.893">     nsresult rv = mUnicodeConverter-&gt;DecodeMimeHeaderToUTF8(</span>
<a href="#l11.894"></a><span id="l11.894" class="difflineminus">-      nsDependentCString(i18nValue), nullptr, false, true, tValue);</span>
<a href="#l11.895"></a><span id="l11.895" class="difflineplus">+        nsDependentCString(i18nValue), nullptr, false, true, tValue);</span>
<a href="#l11.896"></a><span id="l11.896">     if (NS_SUCCEEDED(rv) &amp;&amp; !tValue.IsEmpty())</span>
<a href="#l11.897"></a><span id="l11.897">       nsAppendEscapedHTML(tValue, newValue);</span>
<a href="#l11.898"></a><span id="l11.898">     else</span>
<a href="#l11.899"></a><span id="l11.899">       nsAppendEscapedHTML(nsDependentCString(i18nValue), newValue);</span>
<a href="#l11.900"></a><span id="l11.900" class="difflineminus">-  }</span>
<a href="#l11.901"></a><span id="l11.901" class="difflineminus">-  else</span>
<a href="#l11.902"></a><span id="l11.902" class="difflineminus">-  {</span>
<a href="#l11.903"></a><span id="l11.903" class="difflineplus">+  } else {</span>
<a href="#l11.904"></a><span id="l11.904">     nsAppendEscapedHTML(nsDependentCString(i18nValue), newValue);</span>
<a href="#l11.905"></a><span id="l11.905">   }</span>
<a href="#l11.906"></a><span id="l11.906"> </span>
<a href="#l11.907"></a><span id="l11.907">   free(i18nValue);</span>
<a href="#l11.908"></a><span id="l11.908"> </span>
<a href="#l11.909"></a><span id="l11.909" class="difflineminus">-  if (newValue.IsEmpty())</span>
<a href="#l11.910"></a><span id="l11.910" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.911"></a><span id="l11.911" class="difflineplus">+  if (newValue.IsEmpty()) return NS_OK;</span>
<a href="#l11.912"></a><span id="l11.912"> </span>
<a href="#l11.913"></a><span id="l11.913">   mHTMLHeaders.AppendLiteral(&quot;&lt;tr&gt;&quot;);</span>
<a href="#l11.914"></a><span id="l11.914">   mHTMLHeaders.AppendLiteral(&quot;&lt;td&gt;&quot;);</span>
<a href="#l11.915"></a><span id="l11.915"> </span>
<a href="#l11.916"></a><span id="l11.916">   if (mFormat == nsMimeOutput::nsMimeMessageSaveAs)</span>
<a href="#l11.917"></a><span id="l11.917">     mHTMLHeaders.AppendLiteral(&quot;&lt;b&gt;&quot;);</span>
<a href="#l11.918"></a><span id="l11.918">   else</span>
<a href="#l11.919"></a><span id="l11.919" class="difflineminus">-    mHTMLHeaders.AppendLiteral(&quot;&lt;div class=\&quot;headerdisplayname\&quot; style=\&quot;display:inline;\&quot;&gt;&quot;);</span>
<a href="#l11.920"></a><span id="l11.920" class="difflineplus">+    mHTMLHeaders.AppendLiteral(</span>
<a href="#l11.921"></a><span id="l11.921" class="difflineplus">+        &quot;&lt;div class=\&quot;headerdisplayname\&quot; style=\&quot;display:inline;\&quot;&gt;&quot;);</span>
<a href="#l11.922"></a><span id="l11.922"> </span>
<a href="#l11.923"></a><span id="l11.923">   // Here is where we are going to try to L10N the tagName so we will always</span>
<a href="#l11.924"></a><span id="l11.924">   // get a field name next to an emitted header value. Note: Default will always</span>
<a href="#l11.925"></a><span id="l11.925">   // be the name of the header itself.</span>
<a href="#l11.926"></a><span id="l11.926">   //</span>
<a href="#l11.927"></a><span id="l11.927">   nsCString newTagName(field);</span>
<a href="#l11.928"></a><span id="l11.928">   newTagName.StripWhitespace();</span>
<a href="#l11.929"></a><span id="l11.929">   ToUpperCase(newTagName);</span>
<a href="#l11.930"></a><span id="l11.930"> </span>
<a href="#l11.931"></a><span id="l11.931">   char *l10nTagName = LocalizeHeaderName(newTagName.get(), field);</span>
<a href="#l11.932"></a><span id="l11.932" class="difflineminus">-  if ( (!l10nTagName) || (!*l10nTagName) )</span>
<a href="#l11.933"></a><span id="l11.933" class="difflineplus">+  if ((!l10nTagName) || (!*l10nTagName))</span>
<a href="#l11.934"></a><span id="l11.934">     mHTMLHeaders.Append(field);</span>
<a href="#l11.935"></a><span id="l11.935" class="difflineminus">-  else</span>
<a href="#l11.936"></a><span id="l11.936" class="difflineminus">-  {</span>
<a href="#l11.937"></a><span id="l11.937" class="difflineplus">+  else {</span>
<a href="#l11.938"></a><span id="l11.938">     mHTMLHeaders.Append(l10nTagName);</span>
<a href="#l11.939"></a><span id="l11.939">     PR_FREEIF(l10nTagName);</span>
<a href="#l11.940"></a><span id="l11.940">   }</span>
<a href="#l11.941"></a><span id="l11.941"> </span>
<a href="#l11.942"></a><span id="l11.942">   mHTMLHeaders.AppendLiteral(&quot;: &quot;);</span>
<a href="#l11.943"></a><span id="l11.943">   if (mFormat == nsMimeOutput::nsMimeMessageSaveAs)</span>
<a href="#l11.944"></a><span id="l11.944">     mHTMLHeaders.AppendLiteral(&quot;&lt;/b&gt;&quot;);</span>
<a href="#l11.945"></a><span id="l11.945">   else</span>
<a href="#l11.946"></a><span id="l11.946" class="difflineat">@@ -850,49 +770,43 @@ nsMimeBaseEmitter::WriteHeaderFieldHTML(</span>
<a href="#l11.947"></a><span id="l11.947">   mHTMLHeaders.Append(newValue);</span>
<a href="#l11.948"></a><span id="l11.948">   mHTMLHeaders.AppendLiteral(&quot;&lt;/td&gt;&quot;);</span>
<a href="#l11.949"></a><span id="l11.949"> </span>
<a href="#l11.950"></a><span id="l11.950">   mHTMLHeaders.AppendLiteral(&quot;&lt;/tr&gt;&quot;);</span>
<a href="#l11.951"></a><span id="l11.951"> </span>
<a href="#l11.952"></a><span id="l11.952">   return NS_OK;</span>
<a href="#l11.953"></a><span id="l11.953"> }</span>
<a href="#l11.954"></a><span id="l11.954"> </span>
<a href="#l11.955"></a><span id="l11.955" class="difflineminus">-nsresult</span>
<a href="#l11.956"></a><span id="l11.956" class="difflineminus">-nsMimeBaseEmitter::WriteHeaderFieldHTMLPrefix(const nsACString &amp;name)</span>
<a href="#l11.957"></a><span id="l11.957" class="difflineminus">-{</span>
<a href="#l11.958"></a><span id="l11.958" class="difflineminus">-  if (</span>
<a href="#l11.959"></a><span id="l11.959" class="difflineminus">-      ( (mFormat == nsMimeOutput::nsMimeMessageSaveAs) &amp;&amp; (mFirstHeaders) ) ||</span>
<a href="#l11.960"></a><span id="l11.960" class="difflineminus">-      ( (mFormat == nsMimeOutput::nsMimeMessagePrintOutput) &amp;&amp; (mFirstHeaders) )</span>
<a href="#l11.961"></a><span id="l11.961" class="difflineminus">-     )</span>
<a href="#l11.962"></a><span id="l11.962" class="difflineminus">-     /* DO NOTHING */ ;   // rhp: Do nothing...leaving the conditional like this so its</span>
<a href="#l11.963"></a><span id="l11.963" class="difflineminus">-                          //      easier to see the logic of what is going on.</span>
<a href="#l11.964"></a><span id="l11.964" class="difflineplus">+nsresult nsMimeBaseEmitter::WriteHeaderFieldHTMLPrefix(const nsACString &amp;name) {</span>
<a href="#l11.965"></a><span id="l11.965" class="difflineplus">+  if (((mFormat == nsMimeOutput::nsMimeMessageSaveAs) &amp;&amp; (mFirstHeaders)) ||</span>
<a href="#l11.966"></a><span id="l11.966" class="difflineplus">+      ((mFormat == nsMimeOutput::nsMimeMessagePrintOutput) &amp;&amp; (mFirstHeaders)))</span>
<a href="#l11.967"></a><span id="l11.967" class="difflineplus">+    /* DO NOTHING */;  // rhp: Do nothing...leaving the conditional like this so</span>
<a href="#l11.968"></a><span id="l11.968" class="difflineplus">+                       // its</span>
<a href="#l11.969"></a><span id="l11.969" class="difflineplus">+                       //      easier to see the logic of what is going on.</span>
<a href="#l11.970"></a><span id="l11.970">   else {</span>
<a href="#l11.971"></a><span id="l11.971">     mHTMLHeaders.AppendLiteral(&quot;&lt;br&gt;&lt;fieldset class=\&quot;mimeAttachmentHeader\&quot;&gt;&quot;);</span>
<a href="#l11.972"></a><span id="l11.972">     if (!name.IsEmpty()) {</span>
<a href="#l11.973"></a><span id="l11.973">       mHTMLHeaders.AppendLiteral(&quot;&lt;legend class=\&quot;mimeAttachmentHeaderName\&quot;&gt;&quot;);</span>
<a href="#l11.974"></a><span id="l11.974">       nsAppendEscapedHTML(name, mHTMLHeaders);</span>
<a href="#l11.975"></a><span id="l11.975">       mHTMLHeaders.AppendLiteral(&quot;&lt;/legend&gt;&quot;);</span>
<a href="#l11.976"></a><span id="l11.976">     }</span>
<a href="#l11.977"></a><span id="l11.977">     mHTMLHeaders.AppendLiteral(&quot;&lt;/fieldset&gt;&quot;);</span>
<a href="#l11.978"></a><span id="l11.978">   }</span>
<a href="#l11.979"></a><span id="l11.979"> </span>
<a href="#l11.980"></a><span id="l11.980">   mFirstHeaders = false;</span>
<a href="#l11.981"></a><span id="l11.981">   return NS_OK;</span>
<a href="#l11.982"></a><span id="l11.982"> }</span>
<a href="#l11.983"></a><span id="l11.983"> </span>
<a href="#l11.984"></a><span id="l11.984" class="difflineminus">-nsresult</span>
<a href="#l11.985"></a><span id="l11.985" class="difflineminus">-nsMimeBaseEmitter::WriteHeaderFieldHTMLPostfix()</span>
<a href="#l11.986"></a><span id="l11.986" class="difflineminus">-{</span>
<a href="#l11.987"></a><span id="l11.987" class="difflineplus">+nsresult nsMimeBaseEmitter::WriteHeaderFieldHTMLPostfix() {</span>
<a href="#l11.988"></a><span id="l11.988">   mHTMLHeaders.AppendLiteral(&quot;&lt;br&gt;&quot;);</span>
<a href="#l11.989"></a><span id="l11.989">   return NS_OK;</span>
<a href="#l11.990"></a><span id="l11.990"> }</span>
<a href="#l11.991"></a><span id="l11.991"> </span>
<a href="#l11.992"></a><span id="l11.992"> NS_IMETHODIMP</span>
<a href="#l11.993"></a><span id="l11.993" class="difflineminus">-nsMimeBaseEmitter::WriteHTMLHeaders(const nsACString &amp;name)</span>
<a href="#l11.994"></a><span id="l11.994" class="difflineminus">-{</span>
<a href="#l11.995"></a><span id="l11.995" class="difflineplus">+nsMimeBaseEmitter::WriteHTMLHeaders(const nsACString &amp;name) {</span>
<a href="#l11.996"></a><span id="l11.996">   WriteHeaderFieldHTMLPrefix(name);</span>
<a href="#l11.997"></a><span id="l11.997"> </span>
<a href="#l11.998"></a><span id="l11.998">   // Start with the subject, from date info!</span>
<a href="#l11.999"></a><span id="l11.999">   DumpSubjectFromDate();</span>
<a href="#l11.1000"></a><span id="l11.1000"> </span>
<a href="#l11.1001"></a><span id="l11.1001">   // Continue with the to and cc headers</span>
<a href="#l11.1002"></a><span id="l11.1002">   DumpToCC();</span>
<a href="#l11.1003"></a><span id="l11.1003"> </span>
<a href="#l11.1004"></a><span id="l11.1004" class="difflineat">@@ -907,101 +821,93 @@ nsMimeBaseEmitter::WriteHTMLHeaders(cons</span>
<a href="#l11.1005"></a><span id="l11.1005">   // overall body or output to the stream.</span>
<a href="#l11.1006"></a><span id="l11.1006">   UtilityWriteCRLF(mHTMLHeaders.get());</span>
<a href="#l11.1007"></a><span id="l11.1007"> </span>
<a href="#l11.1008"></a><span id="l11.1008">   mHTMLHeaders = &quot;&quot;;</span>
<a href="#l11.1009"></a><span id="l11.1009"> </span>
<a href="#l11.1010"></a><span id="l11.1010">   return NS_OK;</span>
<a href="#l11.1011"></a><span id="l11.1011"> }</span>
<a href="#l11.1012"></a><span id="l11.1012"> </span>
<a href="#l11.1013"></a><span id="l11.1013" class="difflineminus">-nsresult</span>
<a href="#l11.1014"></a><span id="l11.1014" class="difflineminus">-nsMimeBaseEmitter::DumpSubjectFromDate()</span>
<a href="#l11.1015"></a><span id="l11.1015" class="difflineminus">-{</span>
<a href="#l11.1016"></a><span id="l11.1016" class="difflineminus">-  mHTMLHeaders.AppendLiteral(&quot;&lt;table border=0 cellspacing=0 cellpadding=0 width=\&quot;100%\&quot; class=\&quot;header-part1\&quot;&gt;&quot;);</span>
<a href="#l11.1017"></a><span id="l11.1017" class="difflineplus">+nsresult nsMimeBaseEmitter::DumpSubjectFromDate() {</span>
<a href="#l11.1018"></a><span id="l11.1018" class="difflineplus">+  mHTMLHeaders.AppendLiteral(</span>
<a href="#l11.1019"></a><span id="l11.1019" class="difflineplus">+      &quot;&lt;table border=0 cellspacing=0 cellpadding=0 width=\&quot;100%\&quot; &quot;</span>
<a href="#l11.1020"></a><span id="l11.1020" class="difflineplus">+      &quot;class=\&quot;header-part1\&quot;&gt;&quot;);</span>
<a href="#l11.1021"></a><span id="l11.1021"> </span>
<a href="#l11.1022"></a><span id="l11.1022" class="difflineminus">-    // This is the envelope information</span>
<a href="#l11.1023"></a><span id="l11.1023" class="difflineminus">-    OutputGenericHeader(HEADER_SUBJECT);</span>
<a href="#l11.1024"></a><span id="l11.1024" class="difflineminus">-    OutputGenericHeader(HEADER_FROM);</span>
<a href="#l11.1025"></a><span id="l11.1025" class="difflineminus">-    OutputGenericHeader(HEADER_DATE);</span>
<a href="#l11.1026"></a><span id="l11.1026" class="difflineplus">+  // This is the envelope information</span>
<a href="#l11.1027"></a><span id="l11.1027" class="difflineplus">+  OutputGenericHeader(HEADER_SUBJECT);</span>
<a href="#l11.1028"></a><span id="l11.1028" class="difflineplus">+  OutputGenericHeader(HEADER_FROM);</span>
<a href="#l11.1029"></a><span id="l11.1029" class="difflineplus">+  OutputGenericHeader(HEADER_DATE);</span>
<a href="#l11.1030"></a><span id="l11.1030"> </span>
<a href="#l11.1031"></a><span id="l11.1031" class="difflineminus">-    // If we are Quoting a message, then we should dump the To: also</span>
<a href="#l11.1032"></a><span id="l11.1032" class="difflineminus">-    if ( ( mFormat == nsMimeOutput::nsMimeMessageQuoting ) ||</span>
<a href="#l11.1033"></a><span id="l11.1033" class="difflineminus">-         ( mFormat == nsMimeOutput::nsMimeMessageBodyQuoting ) )</span>
<a href="#l11.1034"></a><span id="l11.1034" class="difflineminus">-      OutputGenericHeader(HEADER_TO);</span>
<a href="#l11.1035"></a><span id="l11.1035" class="difflineplus">+  // If we are Quoting a message, then we should dump the To: also</span>
<a href="#l11.1036"></a><span id="l11.1036" class="difflineplus">+  if ((mFormat == nsMimeOutput::nsMimeMessageQuoting) ||</span>
<a href="#l11.1037"></a><span id="l11.1037" class="difflineplus">+      (mFormat == nsMimeOutput::nsMimeMessageBodyQuoting))</span>
<a href="#l11.1038"></a><span id="l11.1038" class="difflineplus">+    OutputGenericHeader(HEADER_TO);</span>
<a href="#l11.1039"></a><span id="l11.1039"> </span>
<a href="#l11.1040"></a><span id="l11.1040">   mHTMLHeaders.AppendLiteral(&quot;&lt;/table&gt;&quot;);</span>
<a href="#l11.1041"></a><span id="l11.1041"> </span>
<a href="#l11.1042"></a><span id="l11.1042">   return NS_OK;</span>
<a href="#l11.1043"></a><span id="l11.1043"> }</span>
<a href="#l11.1044"></a><span id="l11.1044"> </span>
<a href="#l11.1045"></a><span id="l11.1045" class="difflineminus">-nsresult</span>
<a href="#l11.1046"></a><span id="l11.1046" class="difflineminus">-nsMimeBaseEmitter::DumpToCC()</span>
<a href="#l11.1047"></a><span id="l11.1047" class="difflineminus">-{</span>
<a href="#l11.1048"></a><span id="l11.1048" class="difflineminus">-  const char * toField = GetHeaderValue(HEADER_TO);</span>
<a href="#l11.1049"></a><span id="l11.1049" class="difflineminus">-  const char * ccField = GetHeaderValue(HEADER_CC);</span>
<a href="#l11.1050"></a><span id="l11.1050" class="difflineminus">-  const char * bccField = GetHeaderValue(HEADER_BCC);</span>
<a href="#l11.1051"></a><span id="l11.1051" class="difflineminus">-  const char * newsgroupField = GetHeaderValue(HEADER_NEWSGROUPS);</span>
<a href="#l11.1052"></a><span id="l11.1052" class="difflineplus">+nsresult nsMimeBaseEmitter::DumpToCC() {</span>
<a href="#l11.1053"></a><span id="l11.1053" class="difflineplus">+  const char *toField = GetHeaderValue(HEADER_TO);</span>
<a href="#l11.1054"></a><span id="l11.1054" class="difflineplus">+  const char *ccField = GetHeaderValue(HEADER_CC);</span>
<a href="#l11.1055"></a><span id="l11.1055" class="difflineplus">+  const char *bccField = GetHeaderValue(HEADER_BCC);</span>
<a href="#l11.1056"></a><span id="l11.1056" class="difflineplus">+  const char *newsgroupField = GetHeaderValue(HEADER_NEWSGROUPS);</span>
<a href="#l11.1057"></a><span id="l11.1057"> </span>
<a href="#l11.1058"></a><span id="l11.1058" class="difflineminus">-  // only dump these fields if we have at least one of them! When displaying news</span>
<a href="#l11.1059"></a><span id="l11.1059" class="difflineminus">-  // messages that didn't have a To or Cc field, we'd always get an empty box</span>
<a href="#l11.1060"></a><span id="l11.1060" class="difflineminus">-  // which looked weird.</span>
<a href="#l11.1061"></a><span id="l11.1061" class="difflineminus">-  if (toField || ccField || bccField || newsgroupField)</span>
<a href="#l11.1062"></a><span id="l11.1062" class="difflineminus">-  {</span>
<a href="#l11.1063"></a><span id="l11.1063" class="difflineminus">-    mHTMLHeaders.AppendLiteral(&quot;&lt;table border=0 cellspacing=0 cellpadding=0 width=\&quot;100%\&quot; class=\&quot;header-part2\&quot;&gt;&quot;);</span>
<a href="#l11.1064"></a><span id="l11.1064" class="difflineplus">+  // only dump these fields if we have at least one of them! When displaying</span>
<a href="#l11.1065"></a><span id="l11.1065" class="difflineplus">+  // news messages that didn't have a To or Cc field, we'd always get an empty</span>
<a href="#l11.1066"></a><span id="l11.1066" class="difflineplus">+  // box which looked weird.</span>
<a href="#l11.1067"></a><span id="l11.1067" class="difflineplus">+  if (toField || ccField || bccField || newsgroupField) {</span>
<a href="#l11.1068"></a><span id="l11.1068" class="difflineplus">+    mHTMLHeaders.AppendLiteral(</span>
<a href="#l11.1069"></a><span id="l11.1069" class="difflineplus">+        &quot;&lt;table border=0 cellspacing=0 cellpadding=0 width=\&quot;100%\&quot; &quot;</span>
<a href="#l11.1070"></a><span id="l11.1070" class="difflineplus">+        &quot;class=\&quot;header-part2\&quot;&gt;&quot;);</span>
<a href="#l11.1071"></a><span id="l11.1071"> </span>
<a href="#l11.1072"></a><span id="l11.1072" class="difflineminus">-    if (toField)</span>
<a href="#l11.1073"></a><span id="l11.1073" class="difflineminus">-      WriteHeaderFieldHTML(HEADER_TO, toField);</span>
<a href="#l11.1074"></a><span id="l11.1074" class="difflineminus">-    if (ccField)</span>
<a href="#l11.1075"></a><span id="l11.1075" class="difflineminus">-      WriteHeaderFieldHTML(HEADER_CC, ccField);</span>
<a href="#l11.1076"></a><span id="l11.1076" class="difflineminus">-    if (bccField)</span>
<a href="#l11.1077"></a><span id="l11.1077" class="difflineminus">-      WriteHeaderFieldHTML(HEADER_BCC, bccField);</span>
<a href="#l11.1078"></a><span id="l11.1078" class="difflineminus">-    if (newsgroupField)</span>
<a href="#l11.1079"></a><span id="l11.1079" class="difflineminus">-      WriteHeaderFieldHTML(HEADER_NEWSGROUPS, newsgroupField);</span>
<a href="#l11.1080"></a><span id="l11.1080" class="difflineplus">+    if (toField) WriteHeaderFieldHTML(HEADER_TO, toField);</span>
<a href="#l11.1081"></a><span id="l11.1081" class="difflineplus">+    if (ccField) WriteHeaderFieldHTML(HEADER_CC, ccField);</span>
<a href="#l11.1082"></a><span id="l11.1082" class="difflineplus">+    if (bccField) WriteHeaderFieldHTML(HEADER_BCC, bccField);</span>
<a href="#l11.1083"></a><span id="l11.1083" class="difflineplus">+    if (newsgroupField) WriteHeaderFieldHTML(HEADER_NEWSGROUPS, newsgroupField);</span>
<a href="#l11.1084"></a><span id="l11.1084"> </span>
<a href="#l11.1085"></a><span id="l11.1085">     mHTMLHeaders.AppendLiteral(&quot;&lt;/table&gt;&quot;);</span>
<a href="#l11.1086"></a><span id="l11.1086">   }</span>
<a href="#l11.1087"></a><span id="l11.1087"> </span>
<a href="#l11.1088"></a><span id="l11.1088">   return NS_OK;</span>
<a href="#l11.1089"></a><span id="l11.1089"> }</span>
<a href="#l11.1090"></a><span id="l11.1090"> </span>
<a href="#l11.1091"></a><span id="l11.1091" class="difflineminus">-nsresult</span>
<a href="#l11.1092"></a><span id="l11.1092" class="difflineminus">-nsMimeBaseEmitter::DumpRestOfHeaders()</span>
<a href="#l11.1093"></a><span id="l11.1093" class="difflineminus">-{</span>
<a href="#l11.1094"></a><span id="l11.1094" class="difflineminus">-  nsTArray&lt;headerInfoType*&gt; *array = mDocHeader? mHeaderArray : mEmbeddedHeaderArray;</span>
<a href="#l11.1095"></a><span id="l11.1095" class="difflineplus">+nsresult nsMimeBaseEmitter::DumpRestOfHeaders() {</span>
<a href="#l11.1096"></a><span id="l11.1096" class="difflineplus">+  nsTArray&lt;headerInfoType *&gt; *array =</span>
<a href="#l11.1097"></a><span id="l11.1097" class="difflineplus">+      mDocHeader ? mHeaderArray : mEmbeddedHeaderArray;</span>
<a href="#l11.1098"></a><span id="l11.1098"> </span>
<a href="#l11.1099"></a><span id="l11.1099" class="difflineminus">-  mHTMLHeaders.AppendLiteral(&quot;&lt;table border=0 cellspacing=0 cellpadding=0 width=\&quot;100%\&quot; class=\&quot;header-part3\&quot;&gt;&quot;);</span>
<a href="#l11.1100"></a><span id="l11.1100" class="difflineplus">+  mHTMLHeaders.AppendLiteral(</span>
<a href="#l11.1101"></a><span id="l11.1101" class="difflineplus">+      &quot;&lt;table border=0 cellspacing=0 cellpadding=0 width=\&quot;100%\&quot; &quot;</span>
<a href="#l11.1102"></a><span id="l11.1102" class="difflineplus">+      &quot;class=\&quot;header-part3\&quot;&gt;&quot;);</span>
<a href="#l11.1103"></a><span id="l11.1103"> </span>
<a href="#l11.1104"></a><span id="l11.1104" class="difflineminus">-  for (size_t i = 0; i &lt; array-&gt;Length(); i++)</span>
<a href="#l11.1105"></a><span id="l11.1105" class="difflineminus">-  {</span>
<a href="#l11.1106"></a><span id="l11.1106" class="difflineplus">+  for (size_t i = 0; i &lt; array-&gt;Length(); i++) {</span>
<a href="#l11.1107"></a><span id="l11.1107">     headerInfoType *headerInfo = array-&gt;ElementAt(i);</span>
<a href="#l11.1108"></a><span id="l11.1108" class="difflineminus">-    if ( (!headerInfo) || (!headerInfo-&gt;name) || (!(*headerInfo-&gt;name)) ||</span>
<a href="#l11.1109"></a><span id="l11.1109" class="difflineminus">-      (!headerInfo-&gt;value) || (!(*headerInfo-&gt;value)))</span>
<a href="#l11.1110"></a><span id="l11.1110" class="difflineplus">+    if ((!headerInfo) || (!headerInfo-&gt;name) || (!(*headerInfo-&gt;name)) ||</span>
<a href="#l11.1111"></a><span id="l11.1111" class="difflineplus">+        (!headerInfo-&gt;value) || (!(*headerInfo-&gt;value)))</span>
<a href="#l11.1112"></a><span id="l11.1112">       continue;</span>
<a href="#l11.1113"></a><span id="l11.1113"> </span>
<a href="#l11.1114"></a><span id="l11.1114" class="difflineminus">-    if ( (!PL_strcasecmp(HEADER_SUBJECT, headerInfo-&gt;name)) ||</span>
<a href="#l11.1115"></a><span id="l11.1115" class="difflineminus">-      (!PL_strcasecmp(HEADER_DATE, headerInfo-&gt;name)) ||</span>
<a href="#l11.1116"></a><span id="l11.1116" class="difflineminus">-      (!PL_strcasecmp(HEADER_FROM, headerInfo-&gt;name)) ||</span>
<a href="#l11.1117"></a><span id="l11.1117" class="difflineminus">-      (!PL_strcasecmp(HEADER_TO, headerInfo-&gt;name)) ||</span>
<a href="#l11.1118"></a><span id="l11.1118" class="difflineminus">-      (!PL_strcasecmp(HEADER_CC, headerInfo-&gt;name)) )</span>
<a href="#l11.1119"></a><span id="l11.1119" class="difflineplus">+    if ((!PL_strcasecmp(HEADER_SUBJECT, headerInfo-&gt;name)) ||</span>
<a href="#l11.1120"></a><span id="l11.1120" class="difflineplus">+        (!PL_strcasecmp(HEADER_DATE, headerInfo-&gt;name)) ||</span>
<a href="#l11.1121"></a><span id="l11.1121" class="difflineplus">+        (!PL_strcasecmp(HEADER_FROM, headerInfo-&gt;name)) ||</span>
<a href="#l11.1122"></a><span id="l11.1122" class="difflineplus">+        (!PL_strcasecmp(HEADER_TO, headerInfo-&gt;name)) ||</span>
<a href="#l11.1123"></a><span id="l11.1123" class="difflineplus">+        (!PL_strcasecmp(HEADER_CC, headerInfo-&gt;name)))</span>
<a href="#l11.1124"></a><span id="l11.1124">       continue;</span>
<a href="#l11.1125"></a><span id="l11.1125"> </span>
<a href="#l11.1126"></a><span id="l11.1126">     WriteHeaderFieldHTML(headerInfo-&gt;name, headerInfo-&gt;value);</span>
<a href="#l11.1127"></a><span id="l11.1127">   }</span>
<a href="#l11.1128"></a><span id="l11.1128"> </span>
<a href="#l11.1129"></a><span id="l11.1129">   mHTMLHeaders.AppendLiteral(&quot;&lt;/table&gt;&quot;);</span>
<a href="#l11.1130"></a><span id="l11.1130">   return NS_OK;</span>
<a href="#l11.1131"></a><span id="l11.1131"> }</span>
<a href="#l11.1132"></a><span id="l11.1132"> </span>
<a href="#l11.1133"></a><span id="l11.1133" class="difflineminus">-nsresult</span>
<a href="#l11.1134"></a><span id="l11.1134" class="difflineminus">-nsMimeBaseEmitter::OutputGenericHeader(const char *aHeaderVal)</span>
<a href="#l11.1135"></a><span id="l11.1135" class="difflineminus">-{</span>
<a href="#l11.1136"></a><span id="l11.1136" class="difflineplus">+nsresult nsMimeBaseEmitter::OutputGenericHeader(const char *aHeaderVal) {</span>
<a href="#l11.1137"></a><span id="l11.1137">   const char *val = GetHeaderValue(aHeaderVal);</span>
<a href="#l11.1138"></a><span id="l11.1138"> </span>
<a href="#l11.1139"></a><span id="l11.1139" class="difflineminus">-  if (val)</span>
<a href="#l11.1140"></a><span id="l11.1140" class="difflineminus">-    return WriteHeaderFieldHTML(aHeaderVal, val);</span>
<a href="#l11.1141"></a><span id="l11.1141" class="difflineplus">+  if (val) return WriteHeaderFieldHTML(aHeaderVal, val);</span>
<a href="#l11.1142"></a><span id="l11.1142"> </span>
<a href="#l11.1143"></a><span id="l11.1143">   return NS_ERROR_FAILURE;</span>
<a href="#l11.1144"></a><span id="l11.1144"> }</span>
<a href="#l11.1145"></a><span id="l11.1145"> </span>
<a href="#l11.1146"></a><span id="l11.1146"> //////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.1147"></a><span id="l11.1147"> //////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.1148"></a><span id="l11.1148"> //////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.1149"></a><span id="l11.1149"> // These are the methods that should be implemented by the child class!</span>
<a href="#l11.1150"></a><span id="l11.1150" class="difflineat">@@ -1009,62 +915,54 @@ nsMimeBaseEmitter::OutputGenericHeader(c</span>
<a href="#l11.1151"></a><span id="l11.1151"> //////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.1152"></a><span id="l11.1152"> //////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.1153"></a><span id="l11.1153"> </span>
<a href="#l11.1154"></a><span id="l11.1154"> //</span>
<a href="#l11.1155"></a><span id="l11.1155"> // This should be implemented by the child class if special processing</span>
<a href="#l11.1156"></a><span id="l11.1156"> // needs to be done when the entire message is read.</span>
<a href="#l11.1157"></a><span id="l11.1157"> //</span>
<a href="#l11.1158"></a><span id="l11.1158"> NS_IMETHODIMP</span>
<a href="#l11.1159"></a><span id="l11.1159" class="difflineminus">-nsMimeBaseEmitter::Complete()</span>
<a href="#l11.1160"></a><span id="l11.1160" class="difflineminus">-{</span>
<a href="#l11.1161"></a><span id="l11.1161" class="difflineplus">+nsMimeBaseEmitter::Complete() {</span>
<a href="#l11.1162"></a><span id="l11.1162">   // If we are here and still have data to write, we should try</span>
<a href="#l11.1163"></a><span id="l11.1163">   // to flush it...if we try and fail, we should probably return</span>
<a href="#l11.1164"></a><span id="l11.1164">   // an error!</span>
<a href="#l11.1165"></a><span id="l11.1165" class="difflineminus">-  uint32_t      written;</span>
<a href="#l11.1166"></a><span id="l11.1166" class="difflineplus">+  uint32_t written;</span>
<a href="#l11.1167"></a><span id="l11.1167"> </span>
<a href="#l11.1168"></a><span id="l11.1168">   nsresult rv = NS_OK;</span>
<a href="#l11.1169"></a><span id="l11.1169" class="difflineminus">-  while ( NS_SUCCEEDED(rv) &amp;&amp; (mBufferMgr) &amp;&amp; (mBufferMgr-&gt;GetSize() &gt; 0))</span>
<a href="#l11.1170"></a><span id="l11.1170" class="difflineplus">+  while (NS_SUCCEEDED(rv) &amp;&amp; (mBufferMgr) &amp;&amp; (mBufferMgr-&gt;GetSize() &gt; 0))</span>
<a href="#l11.1171"></a><span id="l11.1171">     rv = Write(EmptyCString(), &amp;written);</span>
<a href="#l11.1172"></a><span id="l11.1172"> </span>
<a href="#l11.1173"></a><span id="l11.1173" class="difflineminus">-  if (mOutListener)</span>
<a href="#l11.1174"></a><span id="l11.1174" class="difflineminus">-  {</span>
<a href="#l11.1175"></a><span id="l11.1175" class="difflineplus">+  if (mOutListener) {</span>
<a href="#l11.1176"></a><span id="l11.1176">     uint64_t bytesInStream = 0;</span>
<a href="#l11.1177"></a><span id="l11.1177">     mozilla::DebugOnly&lt;nsresult&gt; rv2 = mInputStream-&gt;Available(&amp;bytesInStream);</span>
<a href="#l11.1178"></a><span id="l11.1178">     NS_ASSERTION(NS_SUCCEEDED(rv2), &quot;Available failed&quot;);</span>
<a href="#l11.1179"></a><span id="l11.1179" class="difflineminus">-    if (bytesInStream)</span>
<a href="#l11.1180"></a><span id="l11.1180" class="difflineminus">-    {</span>
<a href="#l11.1181"></a><span id="l11.1181" class="difflineminus">-      mOutListener-&gt;OnDataAvailable(mChannel, mInputStream, 0, std::min(bytesInStream, uint64_t(PR_UINT32_MAX)));</span>
<a href="#l11.1182"></a><span id="l11.1182" class="difflineplus">+    if (bytesInStream) {</span>
<a href="#l11.1183"></a><span id="l11.1183" class="difflineplus">+      mOutListener-&gt;OnDataAvailable(</span>
<a href="#l11.1184"></a><span id="l11.1184" class="difflineplus">+          mChannel, mInputStream, 0,</span>
<a href="#l11.1185"></a><span id="l11.1185" class="difflineplus">+          std::min(bytesInStream, uint64_t(PR_UINT32_MAX)));</span>
<a href="#l11.1186"></a><span id="l11.1186">     }</span>
<a href="#l11.1187"></a><span id="l11.1187">   }</span>
<a href="#l11.1188"></a><span id="l11.1188"> </span>
<a href="#l11.1189"></a><span id="l11.1189">   return NS_OK;</span>
<a href="#l11.1190"></a><span id="l11.1190"> }</span>
<a href="#l11.1191"></a><span id="l11.1191"> </span>
<a href="#l11.1192"></a><span id="l11.1192"> //</span>
<a href="#l11.1193"></a><span id="l11.1193"> // This needs to do the right thing with the stored information. It only</span>
<a href="#l11.1194"></a><span id="l11.1194"> // has to do the output functions, this base class will take care of the</span>
<a href="#l11.1195"></a><span id="l11.1195"> // memory cleanup</span>
<a href="#l11.1196"></a><span id="l11.1196"> //</span>
<a href="#l11.1197"></a><span id="l11.1197"> NS_IMETHODIMP</span>
<a href="#l11.1198"></a><span id="l11.1198" class="difflineminus">-nsMimeBaseEmitter::EndHeader(const nsACString &amp;name)</span>
<a href="#l11.1199"></a><span id="l11.1199" class="difflineminus">-{</span>
<a href="#l11.1200"></a><span id="l11.1200" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.1201"></a><span id="l11.1201" class="difflineminus">-}</span>
<a href="#l11.1202"></a><span id="l11.1202" class="difflineplus">+nsMimeBaseEmitter::EndHeader(const nsACString &amp;name) { return NS_OK; }</span>
<a href="#l11.1203"></a><span id="l11.1203"> </span>
<a href="#l11.1204"></a><span id="l11.1204"> // body handling routines</span>
<a href="#l11.1205"></a><span id="l11.1205"> NS_IMETHODIMP</span>
<a href="#l11.1206"></a><span id="l11.1206" class="difflineminus">-nsMimeBaseEmitter::StartBody(bool bodyOnly, const char *msgID, const char *outCharset)</span>
<a href="#l11.1207"></a><span id="l11.1207" class="difflineminus">-{</span>
<a href="#l11.1208"></a><span id="l11.1208" class="difflineplus">+nsMimeBaseEmitter::StartBody(bool bodyOnly, const char *msgID,</span>
<a href="#l11.1209"></a><span id="l11.1209" class="difflineplus">+                             const char *outCharset) {</span>
<a href="#l11.1210"></a><span id="l11.1210">   return NS_OK;</span>
<a href="#l11.1211"></a><span id="l11.1211"> }</span>
<a href="#l11.1212"></a><span id="l11.1212"> </span>
<a href="#l11.1213"></a><span id="l11.1213"> NS_IMETHODIMP</span>
<a href="#l11.1214"></a><span id="l11.1214" class="difflineminus">-nsMimeBaseEmitter::WriteBody(const nsACString &amp;buf, uint32_t *amountWritten)</span>
<a href="#l11.1215"></a><span id="l11.1215" class="difflineminus">-{</span>
<a href="#l11.1216"></a><span id="l11.1216" class="difflineplus">+nsMimeBaseEmitter::WriteBody(const nsACString &amp;buf, uint32_t *amountWritten) {</span>
<a href="#l11.1217"></a><span id="l11.1217">   return NS_OK;</span>
<a href="#l11.1218"></a><span id="l11.1218"> }</span>
<a href="#l11.1219"></a><span id="l11.1219"> </span>
<a href="#l11.1220"></a><span id="l11.1220"> NS_IMETHODIMP</span>
<a href="#l11.1221"></a><span id="l11.1221" class="difflineminus">-nsMimeBaseEmitter::EndBody()</span>
<a href="#l11.1222"></a><span id="l11.1222" class="difflineminus">-{</span>
<a href="#l11.1223"></a><span id="l11.1223" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.1224"></a><span id="l11.1224" class="difflineminus">-}</span>
<a href="#l11.1225"></a><span id="l11.1225" class="difflineplus">+nsMimeBaseEmitter::EndBody() { return NS_OK; }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeBaseEmitter.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeBaseEmitter.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -18,125 +18,124 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsTArray.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;DateTimeFormat.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> //</span>
<a href="#l12.10"></a><span id="l12.10"> // The base emitter will serve as the place to do all of the caching,</span>
<a href="#l12.11"></a><span id="l12.11"> // sorting, etc... of mail headers and bodies for this internally developed</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-// emitter library. The other emitter classes in this file (nsMimeHTMLEmitter, etc.)</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-// will only be concerned with doing output processing ONLY.</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+// emitter library. The other emitter classes in this file (nsMimeHTMLEmitter,</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+// etc.) will only be concerned with doing output processing ONLY.</span>
<a href="#l12.16"></a><span id="l12.16"> //</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> //</span>
<a href="#l12.19"></a><span id="l12.19"> // Used for keeping track of the attachment information...</span>
<a href="#l12.20"></a><span id="l12.20"> //</span>
<a href="#l12.21"></a><span id="l12.21"> typedef struct {</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-  char      *displayName;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-  char      *urlSpec;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-  char      *contentType;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-  bool      isExternalAttachment;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+  char *displayName;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+  char *urlSpec;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+  char *contentType;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+  bool isExternalAttachment;</span>
<a href="#l12.30"></a><span id="l12.30"> } attachmentInfoType;</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32"> //</span>
<a href="#l12.33"></a><span id="l12.33"> // For header info...</span>
<a href="#l12.34"></a><span id="l12.34"> //</span>
<a href="#l12.35"></a><span id="l12.35"> typedef struct {</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-  char      *name;</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-  char      *value;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+  char *name;</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+  char *value;</span>
<a href="#l12.40"></a><span id="l12.40"> } headerInfoType;</span>
<a href="#l12.41"></a><span id="l12.41"> </span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-class nsMimeBaseEmitter : public nsIMimeEmitter,</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-                          public nsIInterfaceRequestor</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-{</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-public:</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-  nsMimeBaseEmitter ();</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+class nsMimeBaseEmitter : public nsIMimeEmitter, public nsIInterfaceRequestor {</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+ public:</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+  nsMimeBaseEmitter();</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51">   // nsISupports interface</span>
<a href="#l12.52"></a><span id="l12.52">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l12.53"></a><span id="l12.53"> </span>
<a href="#l12.54"></a><span id="l12.54">   NS_DECL_NSIMIMEEMITTER</span>
<a href="#l12.55"></a><span id="l12.55">   NS_DECL_NSIINTERFACEREQUESTOR</span>
<a href="#l12.56"></a><span id="l12.56"> </span>
<a href="#l12.57"></a><span id="l12.57">   // Utility output functions...</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-  NS_IMETHOD          UtilityWrite(const nsACString &amp;buf);</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-  NS_IMETHOD          UtilityWriteCRLF(const char *buf);</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+  NS_IMETHOD UtilityWrite(const nsACString &amp;buf);</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+  NS_IMETHOD UtilityWriteCRLF(const char *buf);</span>
<a href="#l12.62"></a><span id="l12.62"> </span>
<a href="#l12.63"></a><span id="l12.63">   // For string bundle usage...</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-  char                *MimeGetStringByName(const char *aHeaderName);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-  char                *MimeGetStringByID(int32_t aID);</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-  char                *LocalizeHeaderName(const char *aHeaderName, const char *aDefaultName);</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+  char *MimeGetStringByName(const char *aHeaderName);</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+  char *MimeGetStringByID(int32_t aID);</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+  char *LocalizeHeaderName(const char *aHeaderName, const char *aDefaultName);</span>
<a href="#l12.70"></a><span id="l12.70"> </span>
<a href="#l12.71"></a><span id="l12.71">   // For header processing...</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-  const char          *GetHeaderValue(const char  *aHeaderName);</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+  const char *GetHeaderValue(const char *aHeaderName);</span>
<a href="#l12.74"></a><span id="l12.74"> </span>
<a href="#l12.75"></a><span id="l12.75">   // To write out a stored header array as HTML</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-  virtual nsresult            WriteHeaderFieldHTMLPrefix(const nsACString &amp;name);</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-  virtual nsresult            WriteHeaderFieldHTML(const char *field, const char *value);</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-  virtual nsresult            WriteHeaderFieldHTMLPostfix();</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+  virtual nsresult WriteHeaderFieldHTMLPrefix(const nsACString &amp;name);</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  virtual nsresult WriteHeaderFieldHTML(const char *field, const char *value);</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+  virtual nsresult WriteHeaderFieldHTMLPostfix();</span>
<a href="#l12.82"></a><span id="l12.82"> </span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-protected:</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+ protected:</span>
<a href="#l12.85"></a><span id="l12.85">   virtual ~nsMimeBaseEmitter();</span>
<a href="#l12.86"></a><span id="l12.86">   // Internal methods...</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-  void                CleanupHeaderArray(nsTArray&lt;headerInfoType*&gt; *aArray);</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+  void CleanupHeaderArray(nsTArray&lt;headerInfoType *&gt; *aArray);</span>
<a href="#l12.89"></a><span id="l12.89"> </span>
<a href="#l12.90"></a><span id="l12.90">   // For header output...</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-  nsresult            DumpSubjectFromDate();</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-  nsresult            DumpToCC();</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-  nsresult            DumpRestOfHeaders();</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-  nsresult            OutputGenericHeader(const char *aHeaderVal);</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+  nsresult DumpSubjectFromDate();</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+  nsresult DumpToCC();</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+  nsresult DumpRestOfHeaders();</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  nsresult OutputGenericHeader(const char *aHeaderVal);</span>
<a href="#l12.99"></a><span id="l12.99"> </span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-  nsresult            WriteHelper(const nsACString &amp;buf, uint32_t *countWritten);</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+  nsresult WriteHelper(const nsACString &amp;buf, uint32_t *countWritten);</span>
<a href="#l12.102"></a><span id="l12.102"> </span>
<a href="#l12.103"></a><span id="l12.103">   // For string bundle usage...</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt;  m_stringBundle;        // for translated strings</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt;  m_headerStringBundle;  // for non-translated header strings</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; m_stringBundle;  // for translated strings</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt;</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+      m_headerStringBundle;  // for non-translated header strings</span>
<a href="#l12.109"></a><span id="l12.109"> </span>
<a href="#l12.110"></a><span id="l12.110">   // For buffer management on output</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-  MimeRebuffer        *mBufferMgr;</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+  MimeRebuffer *mBufferMgr;</span>
<a href="#l12.113"></a><span id="l12.113"> </span>
<a href="#l12.114"></a><span id="l12.114">   // mscott</span>
<a href="#l12.115"></a><span id="l12.115">   // don't ref count the streams....the emitter is owned by the converter</span>
<a href="#l12.116"></a><span id="l12.116">   // which owns these streams...</span>
<a href="#l12.117"></a><span id="l12.117">   //</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-  nsIOutputStream     *mOutStream;</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-  nsIInputStream      *mInputStream;</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-  nsIStreamListener   *mOutListener;</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  nsIOutputStream *mOutStream;</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+  nsIInputStream *mInputStream;</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+  nsIStreamListener *mOutListener;</span>
<a href="#l12.124"></a><span id="l12.124">   nsCOMPtr&lt;nsIChannel&gt; mChannel;</span>
<a href="#l12.125"></a><span id="l12.125"> </span>
<a href="#l12.126"></a><span id="l12.126">   // For gathering statistics on processing...</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-  uint32_t            mTotalWritten;</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-  uint32_t            mTotalRead;</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+  uint32_t mTotalWritten;</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+  uint32_t mTotalRead;</span>
<a href="#l12.131"></a><span id="l12.131"> </span>
<a href="#l12.132"></a><span id="l12.132">   // Output control and info...</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineminus">-  bool                mDocHeader;         // For header determination...</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineminus">-  nsIURI              *mURL;              // the url for the data being processed...</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-  int32_t             mHeaderDisplayType; // The setting for header output...</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-  nsCString           mHTMLHeaders;       // HTML Header Data...</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+  bool mDocHeader;             // For header determination...</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+  nsIURI *mURL;                // the url for the data being processed...</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+  int32_t mHeaderDisplayType;  // The setting for header output...</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+  nsCString mHTMLHeaders;      // HTML Header Data...</span>
<a href="#l12.141"></a><span id="l12.141"> </span>
<a href="#l12.142"></a><span id="l12.142">   // For attachment processing...</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-  int32_t             mAttachCount;</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-  nsTArray&lt;attachmentInfoType*&gt;  *mAttachArray;</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-  attachmentInfoType  *mCurrentAttachment;</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+  int32_t mAttachCount;</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+  nsTArray&lt;attachmentInfoType *&gt; *mAttachArray;</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+  attachmentInfoType *mCurrentAttachment;</span>
<a href="#l12.149"></a><span id="l12.149"> </span>
<a href="#l12.150"></a><span id="l12.150">   // For header caching...</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-  nsTArray&lt;headerInfoType*&gt;  *mHeaderArray;</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-  nsTArray&lt;headerInfoType*&gt;  *mEmbeddedHeaderArray;</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+  nsTArray&lt;headerInfoType *&gt; *mHeaderArray;</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+  nsTArray&lt;headerInfoType *&gt; *mEmbeddedHeaderArray;</span>
<a href="#l12.155"></a><span id="l12.155"> </span>
<a href="#l12.156"></a><span id="l12.156">   // For body caching...</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-  bool                mBodyStarted;</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-  nsCString           mBody;</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineminus">-  bool                mFirstHeaders;</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+  bool mBodyStarted;</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+  nsCString mBody;</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+  bool mFirstHeaders;</span>
<a href="#l12.163"></a><span id="l12.163"> </span>
<a href="#l12.164"></a><span id="l12.164">   // For the format being used...</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-  int32_t             mFormat;</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+  int32_t mFormat;</span>
<a href="#l12.167"></a><span id="l12.167"> </span>
<a href="#l12.168"></a><span id="l12.168">   // For I18N Conversion...</span>
<a href="#l12.169"></a><span id="l12.169">   nsCOMPtr&lt;nsIMimeConverter&gt; mUnicodeConverter;</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineminus">-  nsString            mCharset;</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineminus">-  nsresult GenerateDateString(const char * dateString, nsACString&amp; formattedDate,</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+  nsString mCharset;</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+  nsresult GenerateDateString(const char *dateString, nsACString &amp;formattedDate,</span>
<a href="#l12.174"></a><span id="l12.174">                               bool showDateForToday);</span>
<a href="#l12.175"></a><span id="l12.175">   // The caller is expected to free the result of GetLocalizedDateString</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-  char* GetLocalizedDateString(const char * dateString);</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+  char *GetLocalizedDateString(const char *dateString);</span>
<a href="#l12.178"></a><span id="l12.178"> };</span>
<a href="#l12.179"></a><span id="l12.179"> </span>
<a href="#l12.180"></a><span id="l12.180"> #endif /* _nsMimeBaseEmitter_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeEmitterCID.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeEmitterCID.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -4,44 +4,58 @@</span>
<a href="#l13.4"></a><span id="l13.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> #ifndef nsMimeEmitterCID_h__</span>
<a href="#l13.7"></a><span id="l13.7"> #define nsMimeEmitterCID_h__</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> #define NS_MIME_EMITTER_CONTRACTID_PREFIX \</span>
<a href="#l13.10"></a><span id="l13.10">   &quot;@mozilla.org/messenger/mimeemitter;1?type=&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#define NS_HTML_MIME_EMITTER_CONTRACTID   \</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+#define NS_HTML_MIME_EMITTER_CONTRACTID \</span>
<a href="#l13.14"></a><span id="l13.14">   NS_MIME_EMITTER_CONTRACTID_PREFIX &quot;text/html&quot;</span>
<a href="#l13.15"></a><span id="l13.15"> // {F0A8AF16-DCCE-11d2-A411-00805F613C79}</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-#define NS_HTML_MIME_EMITTER_CID   \</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-    { 0xf0a8af16, 0xdcce, 0x11d2,         \</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-    { 0xa4, 0x11, 0x0, 0x80, 0x5f, 0x61, 0x3c, 0x79 } }</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+#define NS_HTML_MIME_EMITTER_CID                    \</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+  {                                                 \</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+    0xf0a8af16, 0xdcce, 0x11d2, {                   \</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+      0xa4, 0x11, 0x0, 0x80, 0x5f, 0x61, 0x3c, 0x79 \</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+    }                                               \</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+  }</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-#define NS_XML_MIME_EMITTER_CONTRACTID   \</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+#define NS_XML_MIME_EMITTER_CONTRACTID \</span>
<a href="#l13.28"></a><span id="l13.28">   NS_MIME_EMITTER_CONTRACTID_PREFIX &quot;text/xml&quot;</span>
<a href="#l13.29"></a><span id="l13.29"> // {977E418F-E392-11d2-A2AC-00A024A7D144}</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-#define NS_XML_MIME_EMITTER_CID   \</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-    { 0x977e418f, 0xe392, 0x11d2, \</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-    { 0xa2, 0xac, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 } }</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+#define NS_XML_MIME_EMITTER_CID                     \</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+  {                                                 \</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+    0x977e418f, 0xe392, 0x11d2, {                   \</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+      0xa2, 0xac, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 \</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+    }                                               \</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+  }</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-#define NS_RAW_MIME_EMITTER_CONTRACTID   \</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-  NS_MIME_EMITTER_CONTRACTID_PREFIX &quot;raw&quot;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+#define NS_RAW_MIME_EMITTER_CONTRACTID NS_MIME_EMITTER_CONTRACTID_PREFIX &quot;raw&quot;</span>
<a href="#l13.43"></a><span id="l13.43"> // {F0A8AF16-DCFF-11d2-A411-00805F613C79}</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-#define NS_RAW_MIME_EMITTER_CID   \</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-    { 0xf0a8af16, 0xdcff, 0x11d2,         \</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-    { 0xa4, 0x11, 0x0, 0x80, 0x5f, 0x61, 0x3c, 0x79 } }</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+#define NS_RAW_MIME_EMITTER_CID                     \</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+  {                                                 \</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+    0xf0a8af16, 0xdcff, 0x11d2, {                   \</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+      0xa4, 0x11, 0x0, 0x80, 0x5f, 0x61, 0x3c, 0x79 \</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+    }                                               \</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+  }</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-#define NS_XUL_MIME_EMITTER_CONTRACTID   \</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+#define NS_XUL_MIME_EMITTER_CONTRACTID \</span>
<a href="#l13.56"></a><span id="l13.56">   NS_MIME_EMITTER_CONTRACTID_PREFIX &quot;application/vnd.mozilla.xul+xml&quot;</span>
<a href="#l13.57"></a><span id="l13.57"> // {FAA8AF16-DCFF-11d2-A411-00805F613C19}</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-#define NS_XUL_MIME_EMITTER_CID   \</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-    { 0xfaa8af16, 0xdcff, 0x11d2,         \</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-    { 0xa4, 0x11, 0x0, 0x80, 0x5f, 0x61, 0x3c, 0x19 } }</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+#define NS_XUL_MIME_EMITTER_CID                     \</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+  {                                                 \</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+    0xfaa8af16, 0xdcff, 0x11d2, {                   \</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+      0xa4, 0x11, 0x0, 0x80, 0x5f, 0x61, 0x3c, 0x19 \</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+    }                                               \</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+  }</span>
<a href="#l13.67"></a><span id="l13.67"> </span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-#define NS_PLAIN_MIME_EMITTER_CONTRACTID   \</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+#define NS_PLAIN_MIME_EMITTER_CONTRACTID \</span>
<a href="#l13.70"></a><span id="l13.70">   NS_MIME_EMITTER_CONTRACTID_PREFIX &quot;text/plain&quot;</span>
<a href="#l13.71"></a><span id="l13.71"> // {E8892265-7653-46c5-A290-307F3404D0F3}</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-#define NS_PLAIN_MIME_EMITTER_CID   \</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-    { 0xe8892265, 0x7653, 0x46c5,         \</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-    { 0xa2, 0x90, 0x30, 0x7f, 0x34, 0x4, 0xd0, 0xf3 } }</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+#define NS_PLAIN_MIME_EMITTER_CID                   \</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+  {                                                 \</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+    0xe8892265, 0x7653, 0x46c5, {                   \</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+      0xa2, 0x90, 0x30, 0x7f, 0x34, 0x4, 0xd0, 0xf3 \</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+    }                                               \</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+  }</span>
<a href="#l13.81"></a><span id="l13.81"> </span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-#endif // nsMimeEmitterCID_h__</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+#endif  // nsMimeEmitterCID_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeHtmlEmitter.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeHtmlEmitter.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -31,354 +31,332 @@</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> #define VIEW_ALL_HEADERS 2</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> /**</span>
<a href="#l14.8"></a><span id="l14.8">  * A helper class to implement nsIUTF8StringEnumerator</span>
<a href="#l14.9"></a><span id="l14.9">  */</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> class nsMimeStringEnumerator final : public nsStringEnumeratorBase {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-public:</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+ public:</span>
<a href="#l14.14"></a><span id="l14.14">   NS_DECL_ISUPPORTS</span>
<a href="#l14.15"></a><span id="l14.15">   NS_DECL_NSIUTF8STRINGENUMERATOR</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17">   nsMimeStringEnumerator() : mCurrentIndex(0) {}</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-  template&lt;class T&gt;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-  nsCString* Append(T value) { return mValues.AppendElement(value); }</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+  template &lt;class T&gt;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+  nsCString *Append(T value) {</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+    return mValues.AppendElement(value);</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+  }</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26">   using nsStringEnumeratorBase::GetNext;</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-protected:</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+ protected:</span>
<a href="#l14.30"></a><span id="l14.30">   ~nsMimeStringEnumerator() {}</span>
<a href="#l14.31"></a><span id="l14.31">   nsTArray&lt;nsCString&gt; mValues;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-  uint32_t mCurrentIndex; // consumers expect first-in first-out enumeration</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+  uint32_t mCurrentIndex;  // consumers expect first-in first-out enumeration</span>
<a href="#l14.34"></a><span id="l14.34"> };</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMimeStringEnumerator, nsIUTF8StringEnumerator, nsIStringEnumerator)</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMimeStringEnumerator, nsIUTF8StringEnumerator,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+                  nsIStringEnumerator)</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40"> NS_IMETHODIMP</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-nsMimeStringEnumerator::HasMore(bool *result)</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-{</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+nsMimeStringEnumerator::HasMore(bool *result) {</span>
<a href="#l14.44"></a><span id="l14.44">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l14.45"></a><span id="l14.45">   *result = mCurrentIndex &lt; mValues.Length();</span>
<a href="#l14.46"></a><span id="l14.46">   return NS_OK;</span>
<a href="#l14.47"></a><span id="l14.47"> }</span>
<a href="#l14.48"></a><span id="l14.48"> </span>
<a href="#l14.49"></a><span id="l14.49"> NS_IMETHODIMP</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-nsMimeStringEnumerator::GetNext(nsACString&amp; result)</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-{</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-  if (mCurrentIndex &gt;= mValues.Length())</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+nsMimeStringEnumerator::GetNext(nsACString &amp;result) {</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  if (mCurrentIndex &gt;= mValues.Length()) return NS_ERROR_UNEXPECTED;</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57">   result = mValues[mCurrentIndex++];</span>
<a href="#l14.58"></a><span id="l14.58">   return NS_OK;</span>
<a href="#l14.59"></a><span id="l14.59"> }</span>
<a href="#l14.60"></a><span id="l14.60"> </span>
<a href="#l14.61"></a><span id="l14.61"> /*</span>
<a href="#l14.62"></a><span id="l14.62">  * nsMimeHtmlEmitter definitions....</span>
<a href="#l14.63"></a><span id="l14.63">  */</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-nsMimeHtmlDisplayEmitter::nsMimeHtmlDisplayEmitter() : nsMimeBaseEmitter()</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-{</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+nsMimeHtmlDisplayEmitter::nsMimeHtmlDisplayEmitter() : nsMimeBaseEmitter() {</span>
<a href="#l14.67"></a><span id="l14.67">   mFirst = true;</span>
<a href="#l14.68"></a><span id="l14.68">   mSkipAttachment = false;</span>
<a href="#l14.69"></a><span id="l14.69"> }</span>
<a href="#l14.70"></a><span id="l14.70"> </span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-nsMimeHtmlDisplayEmitter::~nsMimeHtmlDisplayEmitter(void)</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-{</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-}</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+nsMimeHtmlDisplayEmitter::~nsMimeHtmlDisplayEmitter(void) {}</span>
<a href="#l14.75"></a><span id="l14.75"> </span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-nsresult nsMimeHtmlDisplayEmitter::Init()</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-{</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-  return NS_OK;</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-}</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::Init() { return NS_OK; }</span>
<a href="#l14.81"></a><span id="l14.81"> </span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-bool nsMimeHtmlDisplayEmitter::BroadCastHeadersAndAttachments()</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-{</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+bool nsMimeHtmlDisplayEmitter::BroadCastHeadersAndAttachments() {</span>
<a href="#l14.85"></a><span id="l14.85">   // try to get a header sink if there is one....</span>
<a href="#l14.86"></a><span id="l14.86">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l14.87"></a><span id="l14.87">   nsresult rv = GetHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l14.88"></a><span id="l14.88">   if (NS_SUCCEEDED(rv) &amp;&amp; headerSink &amp;&amp; mDocHeader)</span>
<a href="#l14.89"></a><span id="l14.89">     return true;</span>
<a href="#l14.90"></a><span id="l14.90">   else</span>
<a href="#l14.91"></a><span id="l14.91">     return false;</span>
<a href="#l14.92"></a><span id="l14.92"> }</span>
<a href="#l14.93"></a><span id="l14.93"> </span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-nsresult</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-nsMimeHtmlDisplayEmitter::WriteHeaderFieldHTMLPrefix(const nsACString &amp;name)</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-{</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-  if (!BroadCastHeadersAndAttachments() || (mFormat == nsMimeOutput::nsMimeMessagePrintOutput))</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::WriteHeaderFieldHTMLPrefix(</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+    const nsACString &amp;name) {</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+  if (!BroadCastHeadersAndAttachments() ||</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+      (mFormat == nsMimeOutput::nsMimeMessagePrintOutput))</span>
<a href="#l14.102"></a><span id="l14.102">     return nsMimeBaseEmitter::WriteHeaderFieldHTMLPrefix(name);</span>
<a href="#l14.103"></a><span id="l14.103">   else</span>
<a href="#l14.104"></a><span id="l14.104">     return NS_OK;</span>
<a href="#l14.105"></a><span id="l14.105"> }</span>
<a href="#l14.106"></a><span id="l14.106"> </span>
<a href="#l14.107"></a><span id="l14.107" class="difflineminus">-nsresult</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-nsMimeHtmlDisplayEmitter::WriteHeaderFieldHTML(const char *field, const char *value)</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-{</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-  if (!BroadCastHeadersAndAttachments() || (mFormat == nsMimeOutput::nsMimeMessagePrintOutput))</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::WriteHeaderFieldHTML(const char *field,</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+                                                        const char *value) {</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+  if (!BroadCastHeadersAndAttachments() ||</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+      (mFormat == nsMimeOutput::nsMimeMessagePrintOutput))</span>
<a href="#l14.115"></a><span id="l14.115">     return nsMimeBaseEmitter::WriteHeaderFieldHTML(field, value);</span>
<a href="#l14.116"></a><span id="l14.116">   else</span>
<a href="#l14.117"></a><span id="l14.117">     return NS_OK;</span>
<a href="#l14.118"></a><span id="l14.118"> }</span>
<a href="#l14.119"></a><span id="l14.119"> </span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-nsresult</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineminus">-nsMimeHtmlDisplayEmitter::WriteHeaderFieldHTMLPostfix()</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">-{</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-  if (!BroadCastHeadersAndAttachments() || (mFormat == nsMimeOutput::nsMimeMessagePrintOutput))</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::WriteHeaderFieldHTMLPostfix() {</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+  if (!BroadCastHeadersAndAttachments() ||</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+      (mFormat == nsMimeOutput::nsMimeMessagePrintOutput))</span>
<a href="#l14.127"></a><span id="l14.127">     return nsMimeBaseEmitter::WriteHeaderFieldHTMLPostfix();</span>
<a href="#l14.128"></a><span id="l14.128">   else</span>
<a href="#l14.129"></a><span id="l14.129">     return NS_OK;</span>
<a href="#l14.130"></a><span id="l14.130"> }</span>
<a href="#l14.131"></a><span id="l14.131"> </span>
<a href="#l14.132"></a><span id="l14.132" class="difflineminus">-nsresult</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-nsMimeHtmlDisplayEmitter::GetHeaderSink(nsIMsgHeaderSink ** aHeaderSink)</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-{</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::GetHeaderSink(</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+    nsIMsgHeaderSink **aHeaderSink) {</span>
<a href="#l14.137"></a><span id="l14.137">   nsresult rv = NS_OK;</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineminus">-  if ( (mChannel) &amp;&amp; (!mHeaderSink) )</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineminus">-  {</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+  if ((mChannel) &amp;&amp; (!mHeaderSink)) {</span>
<a href="#l14.141"></a><span id="l14.141">     nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l14.142"></a><span id="l14.142">     mChannel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-    if (uri)</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineminus">-    {</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(uri));</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineminus">-      if (msgurl)</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineminus">-      {</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+    if (uri) {</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(uri));</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+      if (msgurl) {</span>
<a href="#l14.151"></a><span id="l14.151">         msgurl-&gt;GetMsgHeaderSink(getter_AddRefs(mHeaderSink));</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-        if (!mHeaderSink)  // if the url is not overriding the header sink, then just get the one from the msg window</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+        if (!mHeaderSink)  // if the url is not overriding the header sink, then</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+                           // just get the one from the msg window</span>
<a href="#l14.155"></a><span id="l14.155">         {</span>
<a href="#l14.156"></a><span id="l14.156">           nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l14.157"></a><span id="l14.157">           msgurl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l14.158"></a><span id="l14.158">           if (msgWindow)</span>
<a href="#l14.159"></a><span id="l14.159">             msgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(mHeaderSink));</span>
<a href="#l14.160"></a><span id="l14.160">         }</span>
<a href="#l14.161"></a><span id="l14.161">       }</span>
<a href="#l14.162"></a><span id="l14.162">     }</span>
<a href="#l14.163"></a><span id="l14.163">   }</span>
<a href="#l14.164"></a><span id="l14.164"> </span>
<a href="#l14.165"></a><span id="l14.165">   NS_IF_ADDREF(*aHeaderSink = mHeaderSink);</span>
<a href="#l14.166"></a><span id="l14.166">   return rv;</span>
<a href="#l14.167"></a><span id="l14.167"> }</span>
<a href="#l14.168"></a><span id="l14.168"> </span>
<a href="#l14.169"></a><span id="l14.169" class="difflineminus">-nsresult nsMimeHtmlDisplayEmitter::BroadcastHeaders(nsIMsgHeaderSink * aHeaderSink, int32_t aHeaderMode, bool aFromNewsgroup)</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-{</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::BroadcastHeaders(</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+    nsIMsgHeaderSink *aHeaderSink, int32_t aHeaderMode, bool aFromNewsgroup) {</span>
<a href="#l14.173"></a><span id="l14.173">   // two string enumerators to pass out to the header sink</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineminus">-  RefPtr&lt;nsMimeStringEnumerator&gt; headerNameEnumerator = new nsMimeStringEnumerator();</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+  RefPtr&lt;nsMimeStringEnumerator&gt; headerNameEnumerator =</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+      new nsMimeStringEnumerator();</span>
<a href="#l14.177"></a><span id="l14.177">   NS_ENSURE_TRUE(headerNameEnumerator, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineminus">-  RefPtr&lt;nsMimeStringEnumerator&gt; headerValueEnumerator = new nsMimeStringEnumerator();</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+  RefPtr&lt;nsMimeStringEnumerator&gt; headerValueEnumerator =</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+      new nsMimeStringEnumerator();</span>
<a href="#l14.181"></a><span id="l14.181">   NS_ENSURE_TRUE(headerValueEnumerator, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l14.182"></a><span id="l14.182"> </span>
<a href="#l14.183"></a><span id="l14.183">   nsCString extraExpandedHeaders;</span>
<a href="#l14.184"></a><span id="l14.184">   nsTArray&lt;nsCString&gt; extraExpandedHeadersArray;</span>
<a href="#l14.185"></a><span id="l14.185">   nsCString extraAddonHeaders;</span>
<a href="#l14.186"></a><span id="l14.186">   nsTArray&lt;nsCString&gt; extraAddonHeadersArray;</span>
<a href="#l14.187"></a><span id="l14.187">   nsAutoCString convertedDateString;</span>
<a href="#l14.188"></a><span id="l14.188">   bool pushAllHeaders = false;</span>
<a href="#l14.189"></a><span id="l14.189">   bool checkExtraHeaders = false;</span>
<a href="#l14.190"></a><span id="l14.190">   bool checkAddonHeaders = false;</span>
<a href="#l14.191"></a><span id="l14.191"> </span>
<a href="#l14.192"></a><span id="l14.192">   nsresult rv;</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineminus">-  if (pPrefBranch)</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineminus">-  {</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-    pPrefBranch-&gt;GetCharPref(&quot;mailnews.headers.extraExpandedHeaders&quot;, extraExpandedHeaders);</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-    if (!extraExpandedHeaders.IsEmpty())</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-    {</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+  if (pPrefBranch) {</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+    pPrefBranch-&gt;GetCharPref(&quot;mailnews.headers.extraExpandedHeaders&quot;,</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+                             extraExpandedHeaders);</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+    if (!extraExpandedHeaders.IsEmpty()) {</span>
<a href="#l14.205"></a><span id="l14.205">       ToLowerCase(extraExpandedHeaders);</span>
<a href="#l14.206"></a><span id="l14.206">       ParseString(extraExpandedHeaders, ' ', extraExpandedHeadersArray);</span>
<a href="#l14.207"></a><span id="l14.207">       checkExtraHeaders = true;</span>
<a href="#l14.208"></a><span id="l14.208">     }</span>
<a href="#l14.209"></a><span id="l14.209"> </span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-    pPrefBranch-&gt;GetCharPref(&quot;mailnews.headers.extraAddonHeaders&quot;, extraAddonHeaders);</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineminus">-    if (!extraAddonHeaders.IsEmpty())</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-    {</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+    pPrefBranch-&gt;GetCharPref(&quot;mailnews.headers.extraAddonHeaders&quot;,</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineplus">+                             extraAddonHeaders);</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+    if (!extraAddonHeaders.IsEmpty()) {</span>
<a href="#l14.216"></a><span id="l14.216">       // Push all headers if extraAddonHeaders is &quot;*&quot;.</span>
<a href="#l14.217"></a><span id="l14.217">       if (extraAddonHeaders.EqualsLiteral(&quot;*&quot;)) {</span>
<a href="#l14.218"></a><span id="l14.218">         pushAllHeaders = true;</span>
<a href="#l14.219"></a><span id="l14.219">       } else {</span>
<a href="#l14.220"></a><span id="l14.220">         ToLowerCase(extraAddonHeaders);</span>
<a href="#l14.221"></a><span id="l14.221">         ParseString(extraAddonHeaders, ' ', extraAddonHeadersArray);</span>
<a href="#l14.222"></a><span id="l14.222">         checkAddonHeaders = true;</span>
<a href="#l14.223"></a><span id="l14.223">       }</span>
<a href="#l14.224"></a><span id="l14.224">     }</span>
<a href="#l14.225"></a><span id="l14.225">   }</span>
<a href="#l14.226"></a><span id="l14.226"> </span>
<a href="#l14.227"></a><span id="l14.227" class="difflineminus">-  for (size_t i = 0; i &lt; mHeaderArray-&gt;Length(); i++)</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineminus">-  {</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-    headerInfoType * headerInfo = mHeaderArray-&gt;ElementAt(i);</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-    if ( (!headerInfo) || (!headerInfo-&gt;name) || (!(*headerInfo-&gt;name)) || (!headerInfo-&gt;value) || (!(*headerInfo-&gt;value)))</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+  for (size_t i = 0; i &lt; mHeaderArray-&gt;Length(); i++) {</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+    headerInfoType *headerInfo = mHeaderArray-&gt;ElementAt(i);</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+    if ((!headerInfo) || (!headerInfo-&gt;name) || (!(*headerInfo-&gt;name)) ||</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+        (!headerInfo-&gt;value) || (!(*headerInfo-&gt;value)))</span>
<a href="#l14.235"></a><span id="l14.235">       continue;</span>
<a href="#l14.236"></a><span id="l14.236"> </span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-    // optimization: if we aren't in view all header view mode, we only show a small set of the total # of headers.</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-    // don't waste time sending those out to the UI since the UI is going to ignore them anyway.</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineminus">-    if (aHeaderMode != VIEW_ALL_HEADERS &amp;&amp; (mFormat != nsMimeOutput::nsMimeMessageFilterSniffer))</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-    {</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+    // optimization: if we aren't in view all header view mode, we only show a</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+    // small set of the total # of headers. don't waste time sending those out</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineplus">+    // to the UI since the UI is going to ignore them anyway.</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineplus">+    if (aHeaderMode != VIEW_ALL_HEADERS &amp;&amp;</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+        (mFormat != nsMimeOutput::nsMimeMessageFilterSniffer)) {</span>
<a href="#l14.246"></a><span id="l14.246">       bool skip = true;</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineminus">-      const char * headerName = headerInfo-&gt;name;</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineplus">+      const char *headerName = headerInfo-&gt;name;</span>
<a href="#l14.249"></a><span id="l14.249">       if (pushAllHeaders) {</span>
<a href="#l14.250"></a><span id="l14.250">         skip = false;</span>
<a href="#l14.251"></a><span id="l14.251"> </span>
<a href="#l14.252"></a><span id="l14.252" class="difflineminus">-      // Accept the following:</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-      } else if (!PL_strcasecmp(&quot;to&quot;,           headerName) ||</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineminus">-                 !PL_strcasecmp(&quot;from&quot;,         headerName) ||</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-                 !PL_strcasecmp(&quot;cc&quot;,           headerName) ||</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-                 !PL_strcasecmp(&quot;newsgroups&quot;,   headerName) ||</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineminus">-                 !PL_strcasecmp(&quot;bcc&quot;,          headerName) ||</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineminus">-                 !PL_strcasecmp(&quot;followup-to&quot;,  headerName) ||</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-                 !PL_strcasecmp(&quot;reply-to&quot;,     headerName) ||</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-                 !PL_strcasecmp(&quot;subject&quot;,      headerName) ||</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+        // Accept the following:</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+      } else if (!PL_strcasecmp(&quot;to&quot;, headerName) ||</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+                 !PL_strcasecmp(&quot;from&quot;, headerName) ||</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+                 !PL_strcasecmp(&quot;cc&quot;, headerName) ||</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+                 !PL_strcasecmp(&quot;newsgroups&quot;, headerName) ||</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+                 !PL_strcasecmp(&quot;bcc&quot;, headerName) ||</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+                 !PL_strcasecmp(&quot;followup-to&quot;, headerName) ||</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+                 !PL_strcasecmp(&quot;reply-to&quot;, headerName) ||</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+                 !PL_strcasecmp(&quot;subject&quot;, headerName) ||</span>
<a href="#l14.270"></a><span id="l14.270">                  !PL_strcasecmp(&quot;organization&quot;, headerName) ||</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-                 !PL_strcasecmp(&quot;user-agent&quot;,   headerName) ||</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+                 !PL_strcasecmp(&quot;user-agent&quot;, headerName) ||</span>
<a href="#l14.273"></a><span id="l14.273">                  !PL_strcasecmp(&quot;content-base&quot;, headerName) ||</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineminus">-                 !PL_strcasecmp(&quot;sender&quot;,       headerName) ||</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineminus">-                 !PL_strcasecmp(&quot;date&quot;,         headerName) ||</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineminus">-                 !PL_strcasecmp(&quot;x-mailer&quot;,     headerName) ||</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+                 !PL_strcasecmp(&quot;sender&quot;, headerName) ||</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+                 !PL_strcasecmp(&quot;date&quot;, headerName) ||</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+                 !PL_strcasecmp(&quot;x-mailer&quot;, headerName) ||</span>
<a href="#l14.280"></a><span id="l14.280">                  !PL_strcasecmp(&quot;content-type&quot;, headerName) ||</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineminus">-                 !PL_strcasecmp(&quot;message-id&quot;,   headerName) ||</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+                 !PL_strcasecmp(&quot;message-id&quot;, headerName) ||</span>
<a href="#l14.283"></a><span id="l14.283">                  !PL_strcasecmp(&quot;x-newsreader&quot;, headerName) ||</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineminus">-                 !PL_strcasecmp(&quot;x-mimeole&quot;,    headerName) ||</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineminus">-                 !PL_strcasecmp(&quot;references&quot;,   headerName) ||</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineminus">-                 !PL_strcasecmp(&quot;in-reply-to&quot;,  headerName) ||</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineminus">-                 !PL_strcasecmp(&quot;list-post&quot;,    headerName) ||</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+                 !PL_strcasecmp(&quot;x-mimeole&quot;, headerName) ||</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+                 !PL_strcasecmp(&quot;references&quot;, headerName) ||</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+                 !PL_strcasecmp(&quot;in-reply-to&quot;, headerName) ||</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+                 !PL_strcasecmp(&quot;list-post&quot;, headerName) ||</span>
<a href="#l14.292"></a><span id="l14.292">                  !PL_strcasecmp(&quot;delivered-to&quot;, headerName)) {</span>
<a href="#l14.293"></a><span id="l14.293">         skip = false;</span>
<a href="#l14.294"></a><span id="l14.294"> </span>
<a href="#l14.295"></a><span id="l14.295">       } else if (checkExtraHeaders || checkAddonHeaders) {</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineminus">-        // Make headerStr lowercase because extraExpandedHeaders/extraAddonHeadersArray</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineminus">-        // was made lowercase above.</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineplus">+        // Make headerStr lowercase because</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineplus">+        // extraExpandedHeaders/extraAddonHeadersArray was made lowercase above.</span>
<a href="#l14.300"></a><span id="l14.300">         nsDependentCString headerStr(headerInfo-&gt;name);</span>
<a href="#l14.301"></a><span id="l14.301">         ToLowerCase(headerStr);</span>
<a href="#l14.302"></a><span id="l14.302">         // Accept if it's an &quot;extra&quot; header.</span>
<a href="#l14.303"></a><span id="l14.303">         if (checkExtraHeaders &amp;&amp; extraExpandedHeadersArray.Contains(headerStr))</span>
<a href="#l14.304"></a><span id="l14.304">           skip = false;</span>
<a href="#l14.305"></a><span id="l14.305">         if (checkAddonHeaders &amp;&amp; extraAddonHeadersArray.Contains(headerStr))</span>
<a href="#l14.306"></a><span id="l14.306">           skip = false;</span>
<a href="#l14.307"></a><span id="l14.307">       }</span>
<a href="#l14.308"></a><span id="l14.308"> </span>
<a href="#l14.309"></a><span id="l14.309" class="difflineminus">-      if (skip)</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineminus">-        continue;</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineplus">+      if (skip) continue;</span>
<a href="#l14.312"></a><span id="l14.312">     }</span>
<a href="#l14.313"></a><span id="l14.313"> </span>
<a href="#l14.314"></a><span id="l14.314" class="difflineminus">-    const char * headerValue = headerInfo-&gt;value;</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+    const char *headerValue = headerInfo-&gt;value;</span>
<a href="#l14.316"></a><span id="l14.316">     headerNameEnumerator-&gt;Append(headerInfo-&gt;name);</span>
<a href="#l14.317"></a><span id="l14.317">     headerValueEnumerator-&gt;Append(headerValue);</span>
<a href="#l14.318"></a><span id="l14.318"> </span>
<a href="#l14.319"></a><span id="l14.319">     // Add a localized version of the date header if we encounter it.</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineminus">-    if (!PL_strcasecmp(&quot;Date&quot;, headerInfo-&gt;name))</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineminus">-    {</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineplus">+    if (!PL_strcasecmp(&quot;Date&quot;, headerInfo-&gt;name)) {</span>
<a href="#l14.323"></a><span id="l14.323">       headerNameEnumerator-&gt;Append(&quot;X-Mozilla-LocalizedDate&quot;);</span>
<a href="#l14.324"></a><span id="l14.324">       GenerateDateString(headerValue, convertedDateString, false);</span>
<a href="#l14.325"></a><span id="l14.325">       headerValueEnumerator-&gt;Append(convertedDateString);</span>
<a href="#l14.326"></a><span id="l14.326">     }</span>
<a href="#l14.327"></a><span id="l14.327">   }</span>
<a href="#l14.328"></a><span id="l14.328"> </span>
<a href="#l14.329"></a><span id="l14.329" class="difflineminus">-  aHeaderSink-&gt;ProcessHeaders(headerNameEnumerator, headerValueEnumerator, aFromNewsgroup);</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineplus">+  aHeaderSink-&gt;ProcessHeaders(headerNameEnumerator, headerValueEnumerator,</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineplus">+                              aFromNewsgroup);</span>
<a href="#l14.332"></a><span id="l14.332">   return rv;</span>
<a href="#l14.333"></a><span id="l14.333"> }</span>
<a href="#l14.334"></a><span id="l14.334"> </span>
<a href="#l14.335"></a><span id="l14.335" class="difflineminus">-NS_IMETHODIMP nsMimeHtmlDisplayEmitter::WriteHTMLHeaders(const nsACString &amp;name)</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineminus">-{</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineplus">+NS_IMETHODIMP nsMimeHtmlDisplayEmitter::WriteHTMLHeaders(</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineplus">+    const nsACString &amp;name) {</span>
<a href="#l14.339"></a><span id="l14.339">   // if we aren't broadcasting headers OR printing...just do whatever</span>
<a href="#l14.340"></a><span id="l14.340">   // our base class does...</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineminus">-  if (mFormat == nsMimeOutput::nsMimeMessagePrintOutput)</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineminus">-  {</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineplus">+  if (mFormat == nsMimeOutput::nsMimeMessagePrintOutput) {</span>
<a href="#l14.344"></a><span id="l14.344">     return nsMimeBaseEmitter::WriteHTMLHeaders(name);</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineminus">-  }</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineminus">-  else if (!BroadCastHeadersAndAttachments() || !mDocHeader)</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineminus">-  {</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineplus">+  } else if (!BroadCastHeadersAndAttachments() || !mDocHeader) {</span>
<a href="#l14.349"></a><span id="l14.349">     // This needs to be here to correct the output format if we are</span>
<a href="#l14.350"></a><span id="l14.350">     // not going to broadcast headers to the XUL document.</span>
<a href="#l14.351"></a><span id="l14.351">     if (mFormat == nsMimeOutput::nsMimeMessageBodyDisplay)</span>
<a href="#l14.352"></a><span id="l14.352">       mFormat = nsMimeOutput::nsMimeMessagePrintOutput;</span>
<a href="#l14.353"></a><span id="l14.353"> </span>
<a href="#l14.354"></a><span id="l14.354">     return nsMimeBaseEmitter::WriteHTMLHeaders(name);</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineminus">-  }</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineminus">-  else</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineplus">+  } else</span>
<a href="#l14.358"></a><span id="l14.358">     mFirstHeaders = false;</span>
<a href="#l14.359"></a><span id="l14.359"> </span>
<a href="#l14.360"></a><span id="l14.360">   bool bFromNewsgroups = false;</span>
<a href="#l14.361"></a><span id="l14.361" class="difflineminus">-  for (size_t j = 0; j &lt; mHeaderArray-&gt;Length(); j++)</span>
<a href="#l14.362"></a><span id="l14.362" class="difflineminus">-  {</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineplus">+  for (size_t j = 0; j &lt; mHeaderArray-&gt;Length(); j++) {</span>
<a href="#l14.364"></a><span id="l14.364">     headerInfoType *headerInfo = mHeaderArray-&gt;ElementAt(j);</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineminus">-    if (!(headerInfo &amp;&amp; headerInfo-&gt;name &amp;&amp; *headerInfo-&gt;name))</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineminus">-      continue;</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineplus">+    if (!(headerInfo &amp;&amp; headerInfo-&gt;name &amp;&amp; *headerInfo-&gt;name)) continue;</span>
<a href="#l14.368"></a><span id="l14.368"> </span>
<a href="#l14.369"></a><span id="l14.369" class="difflineminus">-    if (!PL_strcasecmp(&quot;Newsgroups&quot;, headerInfo-&gt;name))</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineminus">-    {</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineplus">+    if (!PL_strcasecmp(&quot;Newsgroups&quot;, headerInfo-&gt;name)) {</span>
<a href="#l14.372"></a><span id="l14.372">       bFromNewsgroups = true;</span>
<a href="#l14.373"></a><span id="l14.373">       break;</span>
<a href="#l14.374"></a><span id="l14.374">     }</span>
<a href="#l14.375"></a><span id="l14.375">   }</span>
<a href="#l14.376"></a><span id="l14.376"> </span>
<a href="#l14.377"></a><span id="l14.377">   // try to get a header sink if there is one....</span>
<a href="#l14.378"></a><span id="l14.378">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l14.379"></a><span id="l14.379">   nsresult rv = GetHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l14.380"></a><span id="l14.380"> </span>
<a href="#l14.381"></a><span id="l14.381" class="difflineminus">-  if (headerSink)</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineminus">-  {</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineplus">+  if (headerSink) {</span>
<a href="#l14.384"></a><span id="l14.384">     int32_t viewMode = 0;</span>
<a href="#l14.385"></a><span id="l14.385" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l14.388"></a><span id="l14.388">     if (pPrefBranch)</span>
<a href="#l14.389"></a><span id="l14.389">       rv = pPrefBranch-&gt;GetIntPref(&quot;mail.show_headers&quot;, &amp;viewMode);</span>
<a href="#l14.390"></a><span id="l14.390"> </span>
<a href="#l14.391"></a><span id="l14.391">     rv = BroadcastHeaders(headerSink, viewMode, bFromNewsgroups);</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineminus">-  } // if header Sink</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineplus">+  }  // if header Sink</span>
<a href="#l14.394"></a><span id="l14.394"> </span>
<a href="#l14.395"></a><span id="l14.395">   return NS_OK;</span>
<a href="#l14.396"></a><span id="l14.396"> }</span>
<a href="#l14.397"></a><span id="l14.397"> </span>
<a href="#l14.398"></a><span id="l14.398" class="difflineminus">-nsresult</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineminus">-nsMimeHtmlDisplayEmitter::EndHeader(const nsACString &amp;name)</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineminus">-{</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineminus">-  if (mDocHeader &amp;&amp; (mFormat != nsMimeOutput::nsMimeMessageFilterSniffer))</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineminus">-  {</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::EndHeader(const nsACString &amp;name) {</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineplus">+  if (mDocHeader &amp;&amp; (mFormat != nsMimeOutput::nsMimeMessageFilterSniffer)) {</span>
<a href="#l14.405"></a><span id="l14.405">     UtilityWriteCRLF(&quot;&lt;html&gt;&quot;);</span>
<a href="#l14.406"></a><span id="l14.406">     UtilityWriteCRLF(&quot;&lt;head&gt;&quot;);</span>
<a href="#l14.407"></a><span id="l14.407"> </span>
<a href="#l14.408"></a><span id="l14.408" class="difflineminus">-    const char * val = GetHeaderValue(HEADER_SUBJECT); // do not free this value</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineminus">-    if (val)</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineminus">-    {</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineplus">+    const char *val = GetHeaderValue(HEADER_SUBJECT);  // do not free this value</span>
<a href="#l14.412"></a><span id="l14.412" class="difflineplus">+    if (val) {</span>
<a href="#l14.413"></a><span id="l14.413">       nsCString subject(&quot;&lt;title&gt;&quot;);</span>
<a href="#l14.414"></a><span id="l14.414">       nsAppendEscapedHTML(nsDependentCString(val), subject);</span>
<a href="#l14.415"></a><span id="l14.415">       subject.AppendLiteral(&quot;&lt;/title&gt;&quot;);</span>
<a href="#l14.416"></a><span id="l14.416">       UtilityWriteCRLF(subject.get());</span>
<a href="#l14.417"></a><span id="l14.417">     }</span>
<a href="#l14.418"></a><span id="l14.418"> </span>
<a href="#l14.419"></a><span id="l14.419">     // Stylesheet info!</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineminus">-    UtilityWriteCRLF(&quot;&lt;link rel=\&quot;important stylesheet\&quot; href=\&quot;chrome://messagebody/skin/messageBody.css\&quot;&gt;&quot;);</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineplus">+    UtilityWriteCRLF(</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineplus">+        &quot;&lt;link rel=\&quot;important stylesheet\&quot; &quot;</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineplus">+        &quot;href=\&quot;chrome://messagebody/skin/messageBody.css\&quot;&gt;&quot;);</span>
<a href="#l14.424"></a><span id="l14.424"> </span>
<a href="#l14.425"></a><span id="l14.425">     UtilityWriteCRLF(&quot;&lt;/head&gt;&quot;);</span>
<a href="#l14.426"></a><span id="l14.426">     UtilityWriteCRLF(&quot;&lt;body&gt;&quot;);</span>
<a href="#l14.427"></a><span id="l14.427">   }</span>
<a href="#l14.428"></a><span id="l14.428"> </span>
<a href="#l14.429"></a><span id="l14.429">   WriteHTMLHeaders(name);</span>
<a href="#l14.430"></a><span id="l14.430"> </span>
<a href="#l14.431"></a><span id="l14.431">   return NS_OK;</span>
<a href="#l14.432"></a><span id="l14.432"> }</span>
<a href="#l14.433"></a><span id="l14.433"> </span>
<a href="#l14.434"></a><span id="l14.434" class="difflineminus">-nsresult</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineminus">-nsMimeHtmlDisplayEmitter::StartAttachment(const nsACString &amp;name,</span>
<a href="#l14.436"></a><span id="l14.436" class="difflineminus">-                                          const char *contentType,</span>
<a href="#l14.437"></a><span id="l14.437" class="difflineminus">-                                          const char *url,</span>
<a href="#l14.438"></a><span id="l14.438" class="difflineminus">-                                          bool aIsExternalAttachment)</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineminus">-{</span>
<a href="#l14.440"></a><span id="l14.440" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::StartAttachment(const nsACString &amp;name,</span>
<a href="#l14.441"></a><span id="l14.441" class="difflineplus">+                                                   const char *contentType,</span>
<a href="#l14.442"></a><span id="l14.442" class="difflineplus">+                                                   const char *url,</span>
<a href="#l14.443"></a><span id="l14.443" class="difflineplus">+                                                   bool aIsExternalAttachment) {</span>
<a href="#l14.444"></a><span id="l14.444">   nsresult rv = NS_OK;</span>
<a href="#l14.445"></a><span id="l14.445">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l14.446"></a><span id="l14.446">   rv = GetHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l14.447"></a><span id="l14.447"> </span>
<a href="#l14.448"></a><span id="l14.448" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; headerSink)</span>
<a href="#l14.449"></a><span id="l14.449" class="difflineminus">-  {</span>
<a href="#l14.450"></a><span id="l14.450" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; headerSink) {</span>
<a href="#l14.451"></a><span id="l14.451">     nsCString uriString;</span>
<a href="#l14.452"></a><span id="l14.452"> </span>
<a href="#l14.453"></a><span id="l14.453" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgurl (do_QueryInterface(mURL, &amp;rv));</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l14.455"></a><span id="l14.455" class="difflineminus">-    {</span>
<a href="#l14.456"></a><span id="l14.456" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgurl(do_QueryInterface(mURL, &amp;rv));</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l14.458"></a><span id="l14.458">       // HACK: news urls require us to use the originalSpec. Everyone</span>
<a href="#l14.459"></a><span id="l14.459">       // else uses GetURI to get the RDF resource which describes the message.</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineminus">-      nsCOMPtr&lt;nsINntpUrl&gt; nntpUrl (do_QueryInterface(mURL, &amp;rv));</span>
<a href="#l14.461"></a><span id="l14.461" class="difflineplus">+      nsCOMPtr&lt;nsINntpUrl&gt; nntpUrl(do_QueryInterface(mURL, &amp;rv));</span>
<a href="#l14.462"></a><span id="l14.462">       if (NS_SUCCEEDED(rv) &amp;&amp; nntpUrl)</span>
<a href="#l14.463"></a><span id="l14.463">         rv = msgurl-&gt;GetOriginalSpec(getter_Copies(uriString));</span>
<a href="#l14.464"></a><span id="l14.464">       else</span>
<a href="#l14.465"></a><span id="l14.465">         rv = msgurl-&gt;GetUri(getter_Copies(uriString));</span>
<a href="#l14.466"></a><span id="l14.466">     }</span>
<a href="#l14.467"></a><span id="l14.467"> </span>
<a href="#l14.468"></a><span id="l14.468">     // we need to convert the attachment name from UTF-8 to unicode before</span>
<a href="#l14.469"></a><span id="l14.469">     // we emit it.  The attachment name has already been rfc2047 processed</span>
<a href="#l14.470"></a><span id="l14.470" class="difflineat">@@ -387,84 +365,74 @@ nsMimeHtmlDisplayEmitter::StartAttachmen</span>
<a href="#l14.471"></a><span id="l14.471">     nsString unicodeHeaderValue;</span>
<a href="#l14.472"></a><span id="l14.472">     CopyUTF8toUTF16(name, unicodeHeaderValue);</span>
<a href="#l14.473"></a><span id="l14.473"> </span>
<a href="#l14.474"></a><span id="l14.474">     headerSink-&gt;HandleAttachment(contentType, url /* was escapedUrl */,</span>
<a href="#l14.475"></a><span id="l14.475">                                  unicodeHeaderValue.get(), uriString.get(),</span>
<a href="#l14.476"></a><span id="l14.476">                                  aIsExternalAttachment);</span>
<a href="#l14.477"></a><span id="l14.477"> </span>
<a href="#l14.478"></a><span id="l14.478">     mSkipAttachment = false;</span>
<a href="#l14.479"></a><span id="l14.479" class="difflineminus">-  }</span>
<a href="#l14.480"></a><span id="l14.480" class="difflineminus">-  else if (mFormat == nsMimeOutput::nsMimeMessagePrintOutput)</span>
<a href="#l14.481"></a><span id="l14.481" class="difflineminus">-  {</span>
<a href="#l14.482"></a><span id="l14.482" class="difflineplus">+  } else if (mFormat == nsMimeOutput::nsMimeMessagePrintOutput) {</span>
<a href="#l14.483"></a><span id="l14.483">     // then we need to deal with the attachments in the body by inserting</span>
<a href="#l14.484"></a><span id="l14.484">     // them into a table..</span>
<a href="#l14.485"></a><span id="l14.485">     rv = StartAttachmentInBody(name, contentType, url);</span>
<a href="#l14.486"></a><span id="l14.486" class="difflineminus">-  }</span>
<a href="#l14.487"></a><span id="l14.487" class="difflineminus">-  else</span>
<a href="#l14.488"></a><span id="l14.488" class="difflineminus">-  {</span>
<a href="#l14.489"></a><span id="l14.489" class="difflineplus">+  } else {</span>
<a href="#l14.490"></a><span id="l14.490">     // If we don't need or cannot broadcast attachment info, just ignore it</span>
<a href="#l14.491"></a><span id="l14.491">     mSkipAttachment = true;</span>
<a href="#l14.492"></a><span id="l14.492">     rv = NS_OK;</span>
<a href="#l14.493"></a><span id="l14.493">   }</span>
<a href="#l14.494"></a><span id="l14.494"> </span>
<a href="#l14.495"></a><span id="l14.495">   return rv;</span>
<a href="#l14.496"></a><span id="l14.496"> }</span>
<a href="#l14.497"></a><span id="l14.497"> </span>
<a href="#l14.498"></a><span id="l14.498"> // Attachment handling routines</span>
<a href="#l14.499"></a><span id="l14.499" class="difflineminus">-// Ok, we are changing the way we handle these now...It used to be that we output</span>
<a href="#l14.500"></a><span id="l14.500" class="difflineminus">-// HTML to make a clickable link, etc... but now, this should just be informational</span>
<a href="#l14.501"></a><span id="l14.501" class="difflineminus">-// and only show up during printing</span>
<a href="#l14.502"></a><span id="l14.502" class="difflineplus">+// Ok, we are changing the way we handle these now...It used to be that we</span>
<a href="#l14.503"></a><span id="l14.503" class="difflineplus">+// output HTML to make a clickable link, etc... but now, this should just be</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineplus">+// informational and only show up during printing</span>
<a href="#l14.505"></a><span id="l14.505"> // XXX should they also show up during quoting?</span>
<a href="#l14.506"></a><span id="l14.506" class="difflineminus">-nsresult</span>
<a href="#l14.507"></a><span id="l14.507" class="difflineminus">-nsMimeHtmlDisplayEmitter::StartAttachmentInBody(const nsACString &amp;name,</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineminus">-                                                const char *contentType,</span>
<a href="#l14.509"></a><span id="l14.509" class="difflineminus">-                                                const char *url)</span>
<a href="#l14.510"></a><span id="l14.510" class="difflineminus">-{</span>
<a href="#l14.511"></a><span id="l14.511" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::StartAttachmentInBody(</span>
<a href="#l14.512"></a><span id="l14.512" class="difflineplus">+    const nsACString &amp;name, const char *contentType, const char *url) {</span>
<a href="#l14.513"></a><span id="l14.513">   mSkipAttachment = false;</span>
<a href="#l14.514"></a><span id="l14.514">   bool p7mExternal = false;</span>
<a href="#l14.515"></a><span id="l14.515"> </span>
<a href="#l14.516"></a><span id="l14.516">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l14.517"></a><span id="l14.517" class="difflineminus">-  if (prefs)</span>
<a href="#l14.518"></a><span id="l14.518" class="difflineminus">-    prefs-&gt;GetBoolPref(&quot;mailnews.p7m_external&quot;, &amp;p7mExternal);</span>
<a href="#l14.519"></a><span id="l14.519" class="difflineplus">+  if (prefs) prefs-&gt;GetBoolPref(&quot;mailnews.p7m_external&quot;, &amp;p7mExternal);</span>
<a href="#l14.520"></a><span id="l14.520"> </span>
<a href="#l14.521"></a><span id="l14.521" class="difflineminus">-  if ( (contentType) &amp;&amp;</span>
<a href="#l14.522"></a><span id="l14.522" class="difflineminus">-       ((!p7mExternal &amp;&amp; !strcmp(contentType, APPLICATION_XPKCS7_MIME)) ||</span>
<a href="#l14.523"></a><span id="l14.523" class="difflineminus">-        (!p7mExternal &amp;&amp; !strcmp(contentType, APPLICATION_PKCS7_MIME)) ||</span>
<a href="#l14.524"></a><span id="l14.524" class="difflineminus">-        (!strcmp(contentType, APPLICATION_XPKCS7_SIGNATURE)) ||</span>
<a href="#l14.525"></a><span id="l14.525" class="difflineminus">-        (!strcmp(contentType, APPLICATION_PKCS7_SIGNATURE)) ||</span>
<a href="#l14.526"></a><span id="l14.526" class="difflineminus">-        (!strcmp(contentType, TEXT_VCARD)))</span>
<a href="#l14.527"></a><span id="l14.527" class="difflineminus">-     )</span>
<a href="#l14.528"></a><span id="l14.528" class="difflineminus">-  {</span>
<a href="#l14.529"></a><span id="l14.529" class="difflineminus">-     mSkipAttachment = true;</span>
<a href="#l14.530"></a><span id="l14.530" class="difflineminus">-     return NS_OK;</span>
<a href="#l14.531"></a><span id="l14.531" class="difflineplus">+  if ((contentType) &amp;&amp;</span>
<a href="#l14.532"></a><span id="l14.532" class="difflineplus">+      ((!p7mExternal &amp;&amp; !strcmp(contentType, APPLICATION_XPKCS7_MIME)) ||</span>
<a href="#l14.533"></a><span id="l14.533" class="difflineplus">+       (!p7mExternal &amp;&amp; !strcmp(contentType, APPLICATION_PKCS7_MIME)) ||</span>
<a href="#l14.534"></a><span id="l14.534" class="difflineplus">+       (!strcmp(contentType, APPLICATION_XPKCS7_SIGNATURE)) ||</span>
<a href="#l14.535"></a><span id="l14.535" class="difflineplus">+       (!strcmp(contentType, APPLICATION_PKCS7_SIGNATURE)) ||</span>
<a href="#l14.536"></a><span id="l14.536" class="difflineplus">+       (!strcmp(contentType, TEXT_VCARD)))) {</span>
<a href="#l14.537"></a><span id="l14.537" class="difflineplus">+    mSkipAttachment = true;</span>
<a href="#l14.538"></a><span id="l14.538" class="difflineplus">+    return NS_OK;</span>
<a href="#l14.539"></a><span id="l14.539">   }</span>
<a href="#l14.540"></a><span id="l14.540"> </span>
<a href="#l14.541"></a><span id="l14.541" class="difflineminus">-  if (mFirst)</span>
<a href="#l14.542"></a><span id="l14.542" class="difflineminus">-  {</span>
<a href="#l14.543"></a><span id="l14.543" class="difflineplus">+  if (mFirst) {</span>
<a href="#l14.544"></a><span id="l14.544">     UtilityWrite(&quot;&lt;br&gt;&lt;fieldset class=\&quot;mimeAttachmentHeader\&quot;&gt;&quot;);</span>
<a href="#l14.545"></a><span id="l14.545" class="difflineminus">-    if (!name.IsEmpty())</span>
<a href="#l14.546"></a><span id="l14.546" class="difflineminus">-    {</span>
<a href="#l14.547"></a><span id="l14.547" class="difflineplus">+    if (!name.IsEmpty()) {</span>
<a href="#l14.548"></a><span id="l14.548">       nsresult rv;</span>
<a href="#l14.549"></a><span id="l14.549"> </span>
<a href="#l14.550"></a><span id="l14.550">       nsCOMPtr&lt;nsIStringBundleService&gt; bundleSvc =</span>
<a href="#l14.551"></a><span id="l14.551" class="difflineminus">-        mozilla::services::GetStringBundleService();</span>
<a href="#l14.552"></a><span id="l14.552" class="difflineplus">+          mozilla::services::GetStringBundleService();</span>
<a href="#l14.553"></a><span id="l14.553">       NS_ENSURE_TRUE(bundleSvc, NS_ERROR_UNEXPECTED);</span>
<a href="#l14.554"></a><span id="l14.554"> </span>
<a href="#l14.555"></a><span id="l14.555">       nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l14.556"></a><span id="l14.556" class="difflineminus">-      rv = bundleSvc-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l14.557"></a><span id="l14.557" class="difflineminus">-                                   getter_AddRefs(bundle));</span>
<a href="#l14.558"></a><span id="l14.558" class="difflineplus">+      rv = bundleSvc-&gt;CreateBundle(</span>
<a href="#l14.559"></a><span id="l14.559" class="difflineplus">+          &quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l14.560"></a><span id="l14.560" class="difflineplus">+          getter_AddRefs(bundle));</span>
<a href="#l14.561"></a><span id="l14.561">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.562"></a><span id="l14.562"> </span>
<a href="#l14.563"></a><span id="l14.563">       nsString attachmentsHeader;</span>
<a href="#l14.564"></a><span id="l14.564">       bundle-&gt;GetStringFromName(&quot;attachmentsPrintHeader&quot;, attachmentsHeader);</span>
<a href="#l14.565"></a><span id="l14.565"> </span>
<a href="#l14.566"></a><span id="l14.566">       UtilityWrite(&quot;&lt;legend class=\&quot;mimeAttachmentHeaderName\&quot;&gt;&quot;);</span>
<a href="#l14.567"></a><span id="l14.567">       nsCString escapedName;</span>
<a href="#l14.568"></a><span id="l14.568" class="difflineminus">-      nsAppendEscapedHTML(NS_ConvertUTF16toUTF8(attachmentsHeader), escapedName);</span>
<a href="#l14.569"></a><span id="l14.569" class="difflineplus">+      nsAppendEscapedHTML(NS_ConvertUTF16toUTF8(attachmentsHeader),</span>
<a href="#l14.570"></a><span id="l14.570" class="difflineplus">+                          escapedName);</span>
<a href="#l14.571"></a><span id="l14.571">       UtilityWrite(escapedName.get());</span>
<a href="#l14.572"></a><span id="l14.572">       UtilityWrite(&quot;&lt;/legend&gt;&quot;);</span>
<a href="#l14.573"></a><span id="l14.573">     }</span>
<a href="#l14.574"></a><span id="l14.574">     UtilityWrite(&quot;&lt;/fieldset&gt;&quot;);</span>
<a href="#l14.575"></a><span id="l14.575">     UtilityWrite(&quot;&lt;div class=\&quot;mimeAttachmentWrap\&quot;&gt;&quot;);</span>
<a href="#l14.576"></a><span id="l14.576">     UtilityWrite(&quot;&lt;table class=\&quot;mimeAttachmentTable\&quot;&gt;&quot;);</span>
<a href="#l14.577"></a><span id="l14.577">   }</span>
<a href="#l14.578"></a><span id="l14.578"> </span>
<a href="#l14.579"></a><span id="l14.579" class="difflineat">@@ -473,106 +441,81 @@ nsMimeHtmlDisplayEmitter::StartAttachmen</span>
<a href="#l14.580"></a><span id="l14.580">   UtilityWrite(&quot;&lt;td class=\&quot;mimeAttachmentFile\&quot;&gt;&quot;);</span>
<a href="#l14.581"></a><span id="l14.581">   UtilityWrite(name);</span>
<a href="#l14.582"></a><span id="l14.582">   UtilityWrite(&quot;&lt;/td&gt;&quot;);</span>
<a href="#l14.583"></a><span id="l14.583"> </span>
<a href="#l14.584"></a><span id="l14.584">   mFirst = false;</span>
<a href="#l14.585"></a><span id="l14.585">   return NS_OK;</span>
<a href="#l14.586"></a><span id="l14.586"> }</span>
<a href="#l14.587"></a><span id="l14.587"> </span>
<a href="#l14.588"></a><span id="l14.588" class="difflineminus">-nsresult</span>
<a href="#l14.589"></a><span id="l14.589" class="difflineminus">-nsMimeHtmlDisplayEmitter::AddAttachmentField(const char *field, const char *value)</span>
<a href="#l14.590"></a><span id="l14.590" class="difflineminus">-{</span>
<a href="#l14.591"></a><span id="l14.591" class="difflineminus">-  if (mSkipAttachment)</span>
<a href="#l14.592"></a><span id="l14.592" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.593"></a><span id="l14.593" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::AddAttachmentField(const char *field,</span>
<a href="#l14.594"></a><span id="l14.594" class="difflineplus">+                                                      const char *value) {</span>
<a href="#l14.595"></a><span id="l14.595" class="difflineplus">+  if (mSkipAttachment) return NS_OK;</span>
<a href="#l14.596"></a><span id="l14.596"> </span>
<a href="#l14.597"></a><span id="l14.597">   // Don't let bad things happen</span>
<a href="#l14.598"></a><span id="l14.598" class="difflineminus">-  if ( !value || !*value )</span>
<a href="#l14.599"></a><span id="l14.599" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.600"></a><span id="l14.600" class="difflineplus">+  if (!value || !*value) return NS_OK;</span>
<a href="#l14.601"></a><span id="l14.601"> </span>
<a href="#l14.602"></a><span id="l14.602">   // Don't output this ugly header...</span>
<a href="#l14.603"></a><span id="l14.603" class="difflineminus">-  if (!strcmp(field, HEADER_X_MOZILLA_PART_URL))</span>
<a href="#l14.604"></a><span id="l14.604" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.605"></a><span id="l14.605" class="difflineplus">+  if (!strcmp(field, HEADER_X_MOZILLA_PART_URL)) return NS_OK;</span>
<a href="#l14.606"></a><span id="l14.606"> </span>
<a href="#l14.607"></a><span id="l14.607">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l14.608"></a><span id="l14.608">   nsresult rv = GetHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l14.609"></a><span id="l14.609" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; headerSink)</span>
<a href="#l14.610"></a><span id="l14.610" class="difflineminus">-  {</span>
<a href="#l14.611"></a><span id="l14.611" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; headerSink) {</span>
<a href="#l14.612"></a><span id="l14.612">     headerSink-&gt;AddAttachmentField(field, value);</span>
<a href="#l14.613"></a><span id="l14.613" class="difflineminus">-  }</span>
<a href="#l14.614"></a><span id="l14.614" class="difflineminus">-  else</span>
<a href="#l14.615"></a><span id="l14.615" class="difflineminus">-  {</span>
<a href="#l14.616"></a><span id="l14.616" class="difflineplus">+  } else {</span>
<a href="#l14.617"></a><span id="l14.617">     // Currently, we only care about the part size.</span>
<a href="#l14.618"></a><span id="l14.618" class="difflineminus">-    if (strcmp(field, HEADER_X_MOZILLA_PART_SIZE))</span>
<a href="#l14.619"></a><span id="l14.619" class="difflineminus">-      return NS_OK;</span>
<a href="#l14.620"></a><span id="l14.620" class="difflineplus">+    if (strcmp(field, HEADER_X_MOZILLA_PART_SIZE)) return NS_OK;</span>
<a href="#l14.621"></a><span id="l14.621"> </span>
<a href="#l14.622"></a><span id="l14.622">     uint64_t size = atoi(value);</span>
<a href="#l14.623"></a><span id="l14.623">     nsAutoString sizeString;</span>
<a href="#l14.624"></a><span id="l14.624">     rv = FormatFileSize(size, false, sizeString);</span>
<a href="#l14.625"></a><span id="l14.625">     UtilityWrite(&quot;&lt;td class=\&quot;mimeAttachmentSize\&quot;&gt;&quot;);</span>
<a href="#l14.626"></a><span id="l14.626">     UtilityWrite(NS_ConvertUTF16toUTF8(sizeString).get());</span>
<a href="#l14.627"></a><span id="l14.627">     UtilityWrite(&quot;&lt;/td&gt;&quot;);</span>
<a href="#l14.628"></a><span id="l14.628">   }</span>
<a href="#l14.629"></a><span id="l14.629"> </span>
<a href="#l14.630"></a><span id="l14.630">   return NS_OK;</span>
<a href="#l14.631"></a><span id="l14.631"> }</span>
<a href="#l14.632"></a><span id="l14.632"> </span>
<a href="#l14.633"></a><span id="l14.633" class="difflineminus">-nsresult</span>
<a href="#l14.634"></a><span id="l14.634" class="difflineminus">-nsMimeHtmlDisplayEmitter::EndAttachment()</span>
<a href="#l14.635"></a><span id="l14.635" class="difflineminus">-{</span>
<a href="#l14.636"></a><span id="l14.636" class="difflineminus">-  if (mSkipAttachment)</span>
<a href="#l14.637"></a><span id="l14.637" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.638"></a><span id="l14.638" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::EndAttachment() {</span>
<a href="#l14.639"></a><span id="l14.639" class="difflineplus">+  if (mSkipAttachment) return NS_OK;</span>
<a href="#l14.640"></a><span id="l14.640"> </span>
<a href="#l14.641"></a><span id="l14.641" class="difflineminus">-  mSkipAttachment = false; // reset it for next attachment round</span>
<a href="#l14.642"></a><span id="l14.642" class="difflineplus">+  mSkipAttachment = false;  // reset it for next attachment round</span>
<a href="#l14.643"></a><span id="l14.643"> </span>
<a href="#l14.644"></a><span id="l14.644" class="difflineminus">-  if (BroadCastHeadersAndAttachments())</span>
<a href="#l14.645"></a><span id="l14.645" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.646"></a><span id="l14.646" class="difflineplus">+  if (BroadCastHeadersAndAttachments()) return NS_OK;</span>
<a href="#l14.647"></a><span id="l14.647"> </span>
<a href="#l14.648"></a><span id="l14.648" class="difflineminus">-  if (mFormat == nsMimeOutput::nsMimeMessagePrintOutput)</span>
<a href="#l14.649"></a><span id="l14.649" class="difflineminus">-    UtilityWrite(&quot;&lt;/tr&gt;&quot;);</span>
<a href="#l14.650"></a><span id="l14.650" class="difflineplus">+  if (mFormat == nsMimeOutput::nsMimeMessagePrintOutput) UtilityWrite(&quot;&lt;/tr&gt;&quot;);</span>
<a href="#l14.651"></a><span id="l14.651"> </span>
<a href="#l14.652"></a><span id="l14.652">   return NS_OK;</span>
<a href="#l14.653"></a><span id="l14.653"> }</span>
<a href="#l14.654"></a><span id="l14.654"> </span>
<a href="#l14.655"></a><span id="l14.655" class="difflineminus">-nsresult</span>
<a href="#l14.656"></a><span id="l14.656" class="difflineminus">-nsMimeHtmlDisplayEmitter::EndAllAttachments()</span>
<a href="#l14.657"></a><span id="l14.657" class="difflineminus">-{</span>
<a href="#l14.658"></a><span id="l14.658" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::EndAllAttachments() {</span>
<a href="#l14.659"></a><span id="l14.659">   nsresult rv = NS_OK;</span>
<a href="#l14.660"></a><span id="l14.660">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l14.661"></a><span id="l14.661">   rv = GetHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l14.662"></a><span id="l14.662" class="difflineminus">-  if (headerSink)</span>
<a href="#l14.663"></a><span id="l14.663" class="difflineminus">-    headerSink-&gt;OnEndAllAttachments();</span>
<a href="#l14.664"></a><span id="l14.664" class="difflineplus">+  if (headerSink) headerSink-&gt;OnEndAllAttachments();</span>
<a href="#l14.665"></a><span id="l14.665"> </span>
<a href="#l14.666"></a><span id="l14.666" class="difflineminus">-  if (mFormat == nsMimeOutput::nsMimeMessagePrintOutput)</span>
<a href="#l14.667"></a><span id="l14.667" class="difflineminus">-  {</span>
<a href="#l14.668"></a><span id="l14.668" class="difflineplus">+  if (mFormat == nsMimeOutput::nsMimeMessagePrintOutput) {</span>
<a href="#l14.669"></a><span id="l14.669">     UtilityWrite(&quot;&lt;/table&gt;&quot;);</span>
<a href="#l14.670"></a><span id="l14.670">     UtilityWrite(&quot;&lt;/div&gt;&quot;);</span>
<a href="#l14.671"></a><span id="l14.671">   }</span>
<a href="#l14.672"></a><span id="l14.672"> </span>
<a href="#l14.673"></a><span id="l14.673">   return rv;</span>
<a href="#l14.674"></a><span id="l14.674"> }</span>
<a href="#l14.675"></a><span id="l14.675"> </span>
<a href="#l14.676"></a><span id="l14.676" class="difflineminus">-nsresult</span>
<a href="#l14.677"></a><span id="l14.677" class="difflineminus">-nsMimeHtmlDisplayEmitter::WriteBody(const nsACString &amp;buf,</span>
<a href="#l14.678"></a><span id="l14.678" class="difflineminus">-                                    uint32_t *amountWritten)</span>
<a href="#l14.679"></a><span id="l14.679" class="difflineminus">-{</span>
<a href="#l14.680"></a><span id="l14.680" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::WriteBody(const nsACString &amp;buf,</span>
<a href="#l14.681"></a><span id="l14.681" class="difflineplus">+                                             uint32_t *amountWritten) {</span>
<a href="#l14.682"></a><span id="l14.682">   Write(buf, amountWritten);</span>
<a href="#l14.683"></a><span id="l14.683">   return NS_OK;</span>
<a href="#l14.684"></a><span id="l14.684"> }</span>
<a href="#l14.685"></a><span id="l14.685"> </span>
<a href="#l14.686"></a><span id="l14.686" class="difflineminus">-nsresult</span>
<a href="#l14.687"></a><span id="l14.687" class="difflineminus">-nsMimeHtmlDisplayEmitter::EndBody()</span>
<a href="#l14.688"></a><span id="l14.688" class="difflineminus">-{</span>
<a href="#l14.689"></a><span id="l14.689" class="difflineminus">-  if (mFormat != nsMimeOutput::nsMimeMessageFilterSniffer)</span>
<a href="#l14.690"></a><span id="l14.690" class="difflineminus">-  {</span>
<a href="#l14.691"></a><span id="l14.691" class="difflineplus">+nsresult nsMimeHtmlDisplayEmitter::EndBody() {</span>
<a href="#l14.692"></a><span id="l14.692" class="difflineplus">+  if (mFormat != nsMimeOutput::nsMimeMessageFilterSniffer) {</span>
<a href="#l14.693"></a><span id="l14.693">     UtilityWriteCRLF(&quot;&lt;/body&gt;&quot;);</span>
<a href="#l14.694"></a><span id="l14.694">     UtilityWriteCRLF(&quot;&lt;/html&gt;&quot;);</span>
<a href="#l14.695"></a><span id="l14.695">   }</span>
<a href="#l14.696"></a><span id="l14.696">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l14.697"></a><span id="l14.697">   nsresult rv = GetHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l14.698"></a><span id="l14.698" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl (do_QueryInterface(mURL, &amp;rv));</span>
<a href="#l14.699"></a><span id="l14.699" class="difflineminus">-  if (headerSink)</span>
<a href="#l14.700"></a><span id="l14.700" class="difflineminus">-    headerSink-&gt;OnEndMsgHeaders(mailnewsUrl);</span>
<a href="#l14.701"></a><span id="l14.701" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(mURL, &amp;rv));</span>
<a href="#l14.702"></a><span id="l14.702" class="difflineplus">+  if (headerSink) headerSink-&gt;OnEndMsgHeaders(mailnewsUrl);</span>
<a href="#l14.703"></a><span id="l14.703"> </span>
<a href="#l14.704"></a><span id="l14.704">   return NS_OK;</span>
<a href="#l14.705"></a><span id="l14.705"> }</span>
<a href="#l14.706"></a><span id="l14.706" class="difflineminus">-</span>
<a href="#l14.707"></a><span id="l14.707" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeHtmlEmitter.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeHtmlEmitter.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -6,52 +6,51 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #define _nsMimeHtmlEmitter_h_</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;prio.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsMimeBaseEmitter.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsIMimeMiscStatus.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> class nsMimeHtmlDisplayEmitter : public nsMimeBaseEmitter {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-public:</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-    nsMimeHtmlDisplayEmitter ();</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-    nsresult Init();</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+ public:</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+  nsMimeHtmlDisplayEmitter();</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+  nsresult Init();</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-    virtual       ~nsMimeHtmlDisplayEmitter (void);</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+  virtual ~nsMimeHtmlDisplayEmitter(void);</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-    // Header handling routines.</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-    NS_IMETHOD    EndHeader(const nsACString &amp;name) override;</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  // Header handling routines.</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+  NS_IMETHOD EndHeader(const nsACString &amp;name) override;</span>
<a href="#l15.26"></a><span id="l15.26"> </span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-    // Attachment handling routines</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-    NS_IMETHOD    StartAttachment(const nsACString &amp;name,</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-                                  const char *contentType, const char *url,</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-                                  bool aIsExternalAttachment) override;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-    NS_IMETHOD    AddAttachmentField(const char *field, const char *value) override;</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-    NS_IMETHOD    EndAttachment() override;</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-    NS_IMETHOD    EndAllAttachments() override;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+  // Attachment handling routines</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+  NS_IMETHOD StartAttachment(const nsACString &amp;name, const char *contentType,</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+                             const char *url,</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+                             bool aIsExternalAttachment) override;</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+  NS_IMETHOD AddAttachmentField(const char *field, const char *value) override;</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+  NS_IMETHOD EndAttachment() override;</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+  NS_IMETHOD EndAllAttachments() override;</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-    // Body handling routines</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-    NS_IMETHOD    WriteBody(const nsACString &amp;buf, uint32_t *amountWritten) override;</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-    NS_IMETHOD    EndBody() override;</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-    NS_IMETHOD    WriteHTMLHeaders(const nsACString &amp;name) override;</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+  // Body handling routines</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+  NS_IMETHOD WriteBody(const nsACString &amp;buf, uint32_t *amountWritten) override;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+  NS_IMETHOD EndBody() override;</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+  NS_IMETHOD WriteHTMLHeaders(const nsACString &amp;name) override;</span>
<a href="#l15.50"></a><span id="l15.50"> </span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-    virtual nsresult    WriteHeaderFieldHTMLPrefix(const nsACString &amp;name</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-                                                   ) override;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-    virtual nsresult    WriteHeaderFieldHTML(const char *field,</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-                                             const char *value) override;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-    virtual nsresult    WriteHeaderFieldHTMLPostfix() override;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+  virtual nsresult WriteHeaderFieldHTMLPrefix(const nsACString &amp;name) override;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+  virtual nsresult WriteHeaderFieldHTML(const char *field,</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+                                        const char *value) override;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+  virtual nsresult WriteHeaderFieldHTMLPostfix() override;</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-protected:</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-    bool          mFirst;  // Attachment flag...</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-    bool          mSkipAttachment;  // attachments we shouldn't show...</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+ protected:</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+  bool mFirst;           // Attachment flag...</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+  bool mSkipAttachment;  // attachments we shouldn't show...</span>
<a href="#l15.67"></a><span id="l15.67"> </span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-    nsCOMPtr&lt;nsIMsgHeaderSink&gt; mHeaderSink;</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+  nsCOMPtr&lt;nsIMsgHeaderSink&gt; mHeaderSink;</span>
<a href="#l15.70"></a><span id="l15.70"> </span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-    nsresult GetHeaderSink(nsIMsgHeaderSink ** aHeaderSink);</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-    bool BroadCastHeadersAndAttachments();</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-    nsresult StartAttachmentInBody(const nsACString &amp;name,</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-                                   const char *contentType, const char *url);</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  nsresult GetHeaderSink(nsIMsgHeaderSink **aHeaderSink);</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+  bool BroadCastHeadersAndAttachments();</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+  nsresult StartAttachmentInBody(const nsACString &amp;name,</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+                                 const char *contentType, const char *url);</span>
<a href="#l15.79"></a><span id="l15.79"> </span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-    nsresult BroadcastHeaders(nsIMsgHeaderSink * aHeaderSink, int32_t aHeaderMode, bool aFromNewsgroup);</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+  nsresult BroadcastHeaders(nsIMsgHeaderSink *aHeaderSink, int32_t aHeaderMode,</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+                            bool aFromNewsgroup);</span>
<a href="#l15.83"></a><span id="l15.83"> };</span>
<a href="#l15.84"></a><span id="l15.84"> </span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-</span>
<a href="#l15.86"></a><span id="l15.86"> #endif /* _nsMimeHtmlEmitter_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimePlainEmitter.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimePlainEmitter.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -11,53 +11,40 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;prmem.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsEmitterUtils.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> /*</span>
<a href="#l16.10"></a><span id="l16.10">  * nsMimePlainEmitter definitions....</span>
<a href="#l16.11"></a><span id="l16.11">  */</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-nsMimePlainEmitter::nsMimePlainEmitter()</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-{</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-}</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+nsMimePlainEmitter::nsMimePlainEmitter() {}</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-nsMimePlainEmitter::~nsMimePlainEmitter(void)</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-{</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-}</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+nsMimePlainEmitter::~nsMimePlainEmitter(void) {}</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24"> // Header handling routines.</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-nsresult</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-nsMimePlainEmitter::StartHeader(bool rootMailHeader, bool headerOnly, const char *msgID,</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-                           const char *outCharset)</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-{</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+nsresult nsMimePlainEmitter::StartHeader(bool rootMailHeader, bool headerOnly,</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+                                         const char *msgID,</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+                                         const char *outCharset) {</span>
<a href="#l16.32"></a><span id="l16.32">   mDocHeader = rootMailHeader;</span>
<a href="#l16.33"></a><span id="l16.33">   return NS_OK;</span>
<a href="#l16.34"></a><span id="l16.34"> }</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-nsresult</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-nsMimePlainEmitter::AddHeaderField(const char *field, const char *value)</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-{</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-  if ( (!field) || (!value) )</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-    return NS_OK;</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+nsresult nsMimePlainEmitter::AddHeaderField(const char *field,</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+                                            const char *value) {</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+  if ((!field) || (!value)) return NS_OK;</span>
<a href="#l16.44"></a><span id="l16.44"> </span>
<a href="#l16.45"></a><span id="l16.45">   UtilityWrite(field);</span>
<a href="#l16.46"></a><span id="l16.46">   UtilityWrite(&quot;:\t&quot;);</span>
<a href="#l16.47"></a><span id="l16.47">   UtilityWriteCRLF(value);</span>
<a href="#l16.48"></a><span id="l16.48">   return NS_OK;</span>
<a href="#l16.49"></a><span id="l16.49"> }</span>
<a href="#l16.50"></a><span id="l16.50"> </span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-nsresult</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-nsMimePlainEmitter::EndHeader(const nsACString &amp;name)</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-{</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+nsresult nsMimePlainEmitter::EndHeader(const nsACString &amp;name) {</span>
<a href="#l16.55"></a><span id="l16.55">   UtilityWriteCRLF(&quot;&quot;);</span>
<a href="#l16.56"></a><span id="l16.56">   return NS_OK;</span>
<a href="#l16.57"></a><span id="l16.57"> }</span>
<a href="#l16.58"></a><span id="l16.58"> </span>
<a href="#l16.59"></a><span id="l16.59"> NS_IMETHODIMP</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-nsMimePlainEmitter::WriteBody(const nsACString &amp;buf, uint32_t *amountWritten)</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-{</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+nsMimePlainEmitter::WriteBody(const nsACString &amp;buf, uint32_t *amountWritten) {</span>
<a href="#l16.63"></a><span id="l16.63">   Write(buf, amountWritten);</span>
<a href="#l16.64"></a><span id="l16.64">   return NS_OK;</span>
<a href="#l16.65"></a><span id="l16.65"> }</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimePlainEmitter.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimePlainEmitter.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -5,22 +5,22 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #ifndef _nsMimePlainEmitter_h_</span>
<a href="#l17.5"></a><span id="l17.5"> #define _nsMimePlainEmitter_h_</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;prio.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsMimeBaseEmitter.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> class nsMimePlainEmitter : public nsMimeBaseEmitter {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-public:</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-    nsMimePlainEmitter ();</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-    virtual       ~nsMimePlainEmitter (void);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ public:</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+  nsMimePlainEmitter();</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  virtual ~nsMimePlainEmitter(void);</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-    // Header handling routines.</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-    NS_IMETHOD    StartHeader(bool rootMailHeader, bool headerOnly, const char *msgID,</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-                              const char *outCharset) override;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-    NS_IMETHOD    AddHeaderField(const char *field, const char *value) override;</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-    NS_IMETHOD    EndHeader(const nsACString &amp;buf) override;</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+  // Header handling routines.</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+  NS_IMETHOD StartHeader(bool rootMailHeader, bool headerOnly,</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+                         const char *msgID, const char *outCharset) override;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  NS_IMETHOD AddHeaderField(const char *field, const char *value) override;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+  NS_IMETHOD EndHeader(const nsACString &amp;buf) override;</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-    NS_IMETHOD    WriteBody(const nsACString &amp;buf, uint32_t *amountWritten) override;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  NS_IMETHOD WriteBody(const nsACString &amp;buf, uint32_t *amountWritten) override;</span>
<a href="#l17.32"></a><span id="l17.32"> };</span>
<a href="#l17.33"></a><span id="l17.33"> </span>
<a href="#l17.34"></a><span id="l17.34"> #endif /* _nsMimePlainEmitter_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeRawEmitter.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeRawEmitter.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -8,24 +8,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsMimeRawEmitter.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;plstr.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nscore.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;prmem.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> /*</span>
<a href="#l18.10"></a><span id="l18.10">  * nsMimeRawEmitter definitions....</span>
<a href="#l18.11"></a><span id="l18.11">  */</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-nsMimeRawEmitter::nsMimeRawEmitter()</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-{</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-}</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+nsMimeRawEmitter::nsMimeRawEmitter() {}</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-nsMimeRawEmitter::~nsMimeRawEmitter(void)</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-{</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-}</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+nsMimeRawEmitter::~nsMimeRawEmitter(void) {}</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23"> NS_IMETHODIMP</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-nsMimeRawEmitter::WriteBody(const nsACString &amp;buf, uint32_t *amountWritten)</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-{</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+nsMimeRawEmitter::WriteBody(const nsACString &amp;buf, uint32_t *amountWritten) {</span>
<a href="#l18.27"></a><span id="l18.27">   Write(buf, amountWritten);</span>
<a href="#l18.28"></a><span id="l18.28">   return NS_OK;</span>
<a href="#l18.29"></a><span id="l18.29"> }</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeRawEmitter.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeRawEmitter.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -5,20 +5,18 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #ifndef _nsMimeRawEmitter_h_</span>
<a href="#l19.5"></a><span id="l19.5"> #define _nsMimeRawEmitter_h_</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;prio.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsMimeBaseEmitter.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11"> class nsMimeRawEmitter : public nsMimeBaseEmitter {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-public:</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-    nsMimeRawEmitter ();</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-    virtual       ~nsMimeRawEmitter (void);</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+ public:</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+  nsMimeRawEmitter();</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+  virtual ~nsMimeRawEmitter(void);</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-    NS_IMETHOD    WriteBody(const nsACString &amp;buf,</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-                            uint32_t *amountWritten) override;</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+  NS_IMETHOD WriteBody(const nsACString &amp;buf, uint32_t *amountWritten) override;</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-protected:</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+ protected:</span>
<a href="#l19.25"></a><span id="l19.25"> };</span>
<a href="#l19.26"></a><span id="l19.26"> </span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-</span>
<a href="#l19.28"></a><span id="l19.28"> #endif /* _nsMimeRawEmitter_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeRebuffer.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeRebuffer.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -2,50 +2,32 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> #include &lt;string.h&gt;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsMimeRebuffer.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;prmem.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-MimeRebuffer::MimeRebuffer(void)</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-{</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-}</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+MimeRebuffer::MimeRebuffer(void) {}</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-MimeRebuffer::~MimeRebuffer(void)</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-{</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-}</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+MimeRebuffer::~MimeRebuffer(void) {}</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-uint32_t</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-MimeRebuffer::GetSize()</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-{</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-  return mBuf.Length();</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-}</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+uint32_t MimeRebuffer::GetSize() { return mBuf.Length(); }</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-uint32_t</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-MimeRebuffer::IncreaseBuffer(const nsACString &amp;addBuf)</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-{</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+uint32_t MimeRebuffer::IncreaseBuffer(const nsACString &amp;addBuf) {</span>
<a href="#l20.33"></a><span id="l20.33">   mBuf.Append(addBuf);</span>
<a href="#l20.34"></a><span id="l20.34">   return mBuf.Length();</span>
<a href="#l20.35"></a><span id="l20.35"> }</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-uint32_t</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-MimeRebuffer::ReduceBuffer(uint32_t numBytes)</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-{</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-  if (numBytes == 0)</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-    return mBuf.Length();</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+uint32_t MimeRebuffer::ReduceBuffer(uint32_t numBytes) {</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+  if (numBytes == 0) return mBuf.Length();</span>
<a href="#l20.44"></a><span id="l20.44"> </span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-  if (numBytes &gt;= mBuf.Length())</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-  {</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+  if (numBytes &gt;= mBuf.Length()) {</span>
<a href="#l20.48"></a><span id="l20.48">     mBuf.Truncate();</span>
<a href="#l20.49"></a><span id="l20.49">     return 0;</span>
<a href="#l20.50"></a><span id="l20.50">   }</span>
<a href="#l20.51"></a><span id="l20.51"> </span>
<a href="#l20.52"></a><span id="l20.52">   mBuf.Cut(0, numBytes);</span>
<a href="#l20.53"></a><span id="l20.53">   return mBuf.Length();</span>
<a href="#l20.54"></a><span id="l20.54"> }</span>
<a href="#l20.55"></a><span id="l20.55"> </span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-nsACString &amp;</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-MimeRebuffer::GetBuffer()</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-{</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-  return mBuf;</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-}</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+nsACString &amp;MimeRebuffer::GetBuffer() { return mBuf; }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeRebuffer.h</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeRebuffer.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -8,22 +8,22 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &lt;stdint.h&gt;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;nsString.h&quot;</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7"> //////////////////////////////////////////////////////////////</span>
<a href="#l21.8"></a><span id="l21.8"> // A rebuffering class necessary for stream output buffering</span>
<a href="#l21.9"></a><span id="l21.9"> //////////////////////////////////////////////////////////////</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> class MimeRebuffer {</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-public:</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-    MimeRebuffer (void);</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-    virtual       ~MimeRebuffer (void);</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+ public:</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+  MimeRebuffer(void);</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+  virtual ~MimeRebuffer(void);</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-    uint32_t      GetSize();</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-    uint32_t      IncreaseBuffer(const nsACString &amp;addBuf);</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-    uint32_t      ReduceBuffer(uint32_t numBytes);</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-    nsACString &amp;  GetBuffer();</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+  uint32_t GetSize();</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+  uint32_t IncreaseBuffer(const nsACString &amp;addBuf);</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+  uint32_t ReduceBuffer(uint32_t numBytes);</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+  nsACString &amp;GetBuffer();</span>
<a href="#l21.27"></a><span id="l21.27"> </span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-protected:</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-    nsCString     mBuf;</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+ protected:</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+  nsCString mBuf;</span>
<a href="#l21.32"></a><span id="l21.32"> };</span>
<a href="#l21.33"></a><span id="l21.33"> </span>
<a href="#l21.34"></a><span id="l21.34"> #endif /* _rebuffer_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeXmlEmitter.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeXmlEmitter.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -12,74 +12,61 @@</span>
<a href="#l22.4"></a><span id="l22.4"> #include &quot;nsEmitterUtils.h&quot;</span>
<a href="#l22.5"></a><span id="l22.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l22.6"></a><span id="l22.6"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l22.7"></a><span id="l22.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9"> /*</span>
<a href="#l22.10"></a><span id="l22.10">  * nsMimeXmlEmitter definitions....</span>
<a href="#l22.11"></a><span id="l22.11">  */</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-nsMimeXmlEmitter::nsMimeXmlEmitter()</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-{</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-}</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+nsMimeXmlEmitter::nsMimeXmlEmitter() {}</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-nsMimeXmlEmitter::~nsMimeXmlEmitter(void)</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-{</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-}</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+nsMimeXmlEmitter::~nsMimeXmlEmitter(void) {}</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24"> // Note - this is teardown only...you should not write</span>
<a href="#l22.25"></a><span id="l22.25"> // anything to the stream since these may be image data</span>
<a href="#l22.26"></a><span id="l22.26"> // output streams, etc...</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-nsresult</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-nsMimeXmlEmitter::Complete()</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-{</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-  char  buf[16];</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+nsresult nsMimeXmlEmitter::Complete() {</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+  char buf[16];</span>
<a href="#l22.33"></a><span id="l22.33"> </span>
<a href="#l22.34"></a><span id="l22.34">   // Now write out the total count of attachments for this message</span>
<a href="#l22.35"></a><span id="l22.35">   UtilityWrite(&quot;&lt;mailattachcount&gt;&quot;);</span>
<a href="#l22.36"></a><span id="l22.36">   sprintf(buf, &quot;%d&quot;, mAttachCount);</span>
<a href="#l22.37"></a><span id="l22.37">   UtilityWrite(buf);</span>
<a href="#l22.38"></a><span id="l22.38">   UtilityWrite(&quot;&lt;/mailattachcount&gt;&quot;);</span>
<a href="#l22.39"></a><span id="l22.39"> </span>
<a href="#l22.40"></a><span id="l22.40">   UtilityWrite(&quot;&lt;/message&gt;&quot;);</span>
<a href="#l22.41"></a><span id="l22.41"> </span>
<a href="#l22.42"></a><span id="l22.42">   return nsMimeBaseEmitter::Complete();</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-</span>
<a href="#l22.44"></a><span id="l22.44"> }</span>
<a href="#l22.45"></a><span id="l22.45"> </span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-nsresult</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-nsMimeXmlEmitter::WriteXMLHeader(const char *msgID)</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-{</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-  if ( (!msgID) || (!*msgID) )</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-    msgID = &quot;none&quot;;</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+nsresult nsMimeXmlEmitter::WriteXMLHeader(const char *msgID) {</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+  if ((!msgID) || (!*msgID)) msgID = &quot;none&quot;;</span>
<a href="#l22.53"></a><span id="l22.53"> </span>
<a href="#l22.54"></a><span id="l22.54">   nsCString newValue;</span>
<a href="#l22.55"></a><span id="l22.55">   nsAppendEscapedHTML(nsDependentCString(msgID), newValue);</span>
<a href="#l22.56"></a><span id="l22.56"> </span>
<a href="#l22.57"></a><span id="l22.57">   UtilityWrite(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&quot;);</span>
<a href="#l22.58"></a><span id="l22.58"> </span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-  UtilityWriteCRLF(&quot;&lt;?xml-stylesheet href=\&quot;chrome://messagebody/skin/messageBody.css\&quot; type=\&quot;text/css\&quot;?&gt;&quot;);</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineplus">+  UtilityWriteCRLF(</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+      &quot;&lt;?xml-stylesheet href=\&quot;chrome://messagebody/skin/messageBody.css\&quot; &quot;</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+      &quot;type=\&quot;text/css\&quot;?&gt;&quot;);</span>
<a href="#l22.63"></a><span id="l22.63"> </span>
<a href="#l22.64"></a><span id="l22.64">   UtilityWrite(&quot;&lt;message id=\&quot;&quot;);</span>
<a href="#l22.65"></a><span id="l22.65">   UtilityWrite(newValue.get());</span>
<a href="#l22.66"></a><span id="l22.66">   UtilityWrite(&quot;\&quot;&gt;&quot;);</span>
<a href="#l22.67"></a><span id="l22.67"> </span>
<a href="#l22.68"></a><span id="l22.68">   mXMLHeaderStarted = true;</span>
<a href="#l22.69"></a><span id="l22.69">   return NS_OK;</span>
<a href="#l22.70"></a><span id="l22.70"> }</span>
<a href="#l22.71"></a><span id="l22.71"> </span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-nsresult</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-nsMimeXmlEmitter::WriteXMLTag(const char *tagName, const char *value)</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-{</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-  if ( (!value) || (!*value) )</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+nsresult nsMimeXmlEmitter::WriteXMLTag(const char *tagName, const char *value) {</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+  if ((!value) || (!*value)) return NS_OK;</span>
<a href="#l22.79"></a><span id="l22.79"> </span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-  char  *upCaseTag = NULL;</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineplus">+  char *upCaseTag = NULL;</span>
<a href="#l22.82"></a><span id="l22.82">   nsCString newValue;</span>
<a href="#l22.83"></a><span id="l22.83">   nsAppendEscapedHTML(nsDependentCString(value), newValue);</span>
<a href="#l22.84"></a><span id="l22.84"> </span>
<a href="#l22.85"></a><span id="l22.85">   nsCString newTagName(tagName);</span>
<a href="#l22.86"></a><span id="l22.86">   newTagName.StripWhitespace();</span>
<a href="#l22.87"></a><span id="l22.87">   ToUpperCase(newTagName);</span>
<a href="#l22.88"></a><span id="l22.88">   upCaseTag = ToNewCString(newTagName);</span>
<a href="#l22.89"></a><span id="l22.89"> </span>
<a href="#l22.90"></a><span id="l22.90" class="difflineat">@@ -88,20 +75,19 @@ nsMimeXmlEmitter::WriteXMLTag(const char</span>
<a href="#l22.91"></a><span id="l22.91">   UtilityWrite(&quot;\&quot;&gt;&quot;);</span>
<a href="#l22.92"></a><span id="l22.92"> </span>
<a href="#l22.93"></a><span id="l22.93">   // Here is where we are going to try to L10N the tagName so we will always</span>
<a href="#l22.94"></a><span id="l22.94">   // get a field name next to an emitted header value. Note: Default will always</span>
<a href="#l22.95"></a><span id="l22.95">   // be the name of the header itself.</span>
<a href="#l22.96"></a><span id="l22.96">   //</span>
<a href="#l22.97"></a><span id="l22.97">   UtilityWrite(&quot;&lt;headerdisplayname&gt;&quot;);</span>
<a href="#l22.98"></a><span id="l22.98">   char *l10nTagName = LocalizeHeaderName(upCaseTag, tagName);</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-  if ( (!l10nTagName) || (!*l10nTagName) )</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineplus">+  if ((!l10nTagName) || (!*l10nTagName))</span>
<a href="#l22.101"></a><span id="l22.101">     UtilityWrite(tagName);</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineminus">-  else</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineminus">-  {</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineplus">+  else {</span>
<a href="#l22.105"></a><span id="l22.105">     UtilityWrite(l10nTagName);</span>
<a href="#l22.106"></a><span id="l22.106">   }</span>
<a href="#l22.107"></a><span id="l22.107">   PR_FREEIF(l10nTagName);</span>
<a href="#l22.108"></a><span id="l22.108"> </span>
<a href="#l22.109"></a><span id="l22.109">   UtilityWrite(&quot;: &quot;);</span>
<a href="#l22.110"></a><span id="l22.110">   UtilityWrite(&quot;&lt;/headerdisplayname&gt;&quot;);</span>
<a href="#l22.111"></a><span id="l22.111"> </span>
<a href="#l22.112"></a><span id="l22.112">   // Now write out the actual value itself and move on!</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineat">@@ -110,70 +96,57 @@ nsMimeXmlEmitter::WriteXMLTag(const char</span>
<a href="#l22.114"></a><span id="l22.114">   UtilityWrite(&quot;&lt;/header&gt;&quot;);</span>
<a href="#l22.115"></a><span id="l22.115"> </span>
<a href="#l22.116"></a><span id="l22.116">   free(upCaseTag);</span>
<a href="#l22.117"></a><span id="l22.117"> </span>
<a href="#l22.118"></a><span id="l22.118">   return NS_OK;</span>
<a href="#l22.119"></a><span id="l22.119"> }</span>
<a href="#l22.120"></a><span id="l22.120"> </span>
<a href="#l22.121"></a><span id="l22.121"> // Header handling routines.</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineminus">-nsresult</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineminus">-nsMimeXmlEmitter::StartHeader(bool rootMailHeader, bool headerOnly, const char *msgID,</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-                           const char *outCharset)</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineminus">-{</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineplus">+nsresult nsMimeXmlEmitter::StartHeader(bool rootMailHeader, bool headerOnly,</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineplus">+                                       const char *msgID,</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineplus">+                                       const char *outCharset) {</span>
<a href="#l22.129"></a><span id="l22.129">   mDocHeader = rootMailHeader;</span>
<a href="#l22.130"></a><span id="l22.130">   WriteXMLHeader(msgID);</span>
<a href="#l22.131"></a><span id="l22.131">   UtilityWrite(&quot;&lt;mailheader&gt;&quot;);</span>
<a href="#l22.132"></a><span id="l22.132"> </span>
<a href="#l22.133"></a><span id="l22.133">   return NS_OK;</span>
<a href="#l22.134"></a><span id="l22.134"> }</span>
<a href="#l22.135"></a><span id="l22.135"> </span>
<a href="#l22.136"></a><span id="l22.136" class="difflineminus">-nsresult</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineminus">-nsMimeXmlEmitter::AddHeaderField(const char *field, const char *value)</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineminus">-{</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineminus">-  if ( (!field) || (!value) )</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineplus">+nsresult nsMimeXmlEmitter::AddHeaderField(const char *field,</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineplus">+                                          const char *value) {</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineplus">+  if ((!field) || (!value)) return NS_OK;</span>
<a href="#l22.144"></a><span id="l22.144"> </span>
<a href="#l22.145"></a><span id="l22.145">   WriteXMLTag(field, value);</span>
<a href="#l22.146"></a><span id="l22.146">   return NS_OK;</span>
<a href="#l22.147"></a><span id="l22.147"> }</span>
<a href="#l22.148"></a><span id="l22.148"> </span>
<a href="#l22.149"></a><span id="l22.149" class="difflineminus">-nsresult</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-nsMimeXmlEmitter::EndHeader(const nsACString &amp;name)</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineminus">-{</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineplus">+nsresult nsMimeXmlEmitter::EndHeader(const nsACString &amp;name) {</span>
<a href="#l22.153"></a><span id="l22.153">   UtilityWrite(&quot;&lt;/mailheader&gt;&quot;);</span>
<a href="#l22.154"></a><span id="l22.154">   return NS_OK;</span>
<a href="#l22.155"></a><span id="l22.155"> }</span>
<a href="#l22.156"></a><span id="l22.156"> </span>
<a href="#l22.157"></a><span id="l22.157" class="difflineminus">-</span>
<a href="#l22.158"></a><span id="l22.158"> // Attachment handling routines</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineminus">-nsresult</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineminus">-nsMimeXmlEmitter::StartAttachment(const nsACString &amp;name,</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineminus">-                                  const char *contentType,</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineminus">-                                  const char *url,</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineminus">-                                  bool aIsExternalAttachment)</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineminus">-{</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineminus">-  char    buf[128];</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineplus">+nsresult nsMimeXmlEmitter::StartAttachment(const nsACString &amp;name,</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineplus">+                                           const char *contentType,</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineplus">+                                           const char *url,</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineplus">+                                           bool aIsExternalAttachment) {</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineplus">+  char buf[128];</span>
<a href="#l22.171"></a><span id="l22.171"> </span>
<a href="#l22.172"></a><span id="l22.172">   ++mAttachCount;</span>
<a href="#l22.173"></a><span id="l22.173"> </span>
<a href="#l22.174"></a><span id="l22.174">   sprintf(buf, &quot;&lt;mailattachment id=\&quot;%d\&quot;&gt;&quot;, mAttachCount);</span>
<a href="#l22.175"></a><span id="l22.175">   UtilityWrite(buf);</span>
<a href="#l22.176"></a><span id="l22.176"> </span>
<a href="#l22.177"></a><span id="l22.177">   AddAttachmentField(HEADER_PARM_FILENAME, PromiseFlatCString(name).get());</span>
<a href="#l22.178"></a><span id="l22.178">   return NS_OK;</span>
<a href="#l22.179"></a><span id="l22.179"> }</span>
<a href="#l22.180"></a><span id="l22.180"> </span>
<a href="#l22.181"></a><span id="l22.181" class="difflineminus">-nsresult</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineminus">-nsMimeXmlEmitter::AddAttachmentField(const char *field, const char *value)</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineminus">-{</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineplus">+nsresult nsMimeXmlEmitter::AddAttachmentField(const char *field,</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineplus">+                                              const char *value) {</span>
<a href="#l22.186"></a><span id="l22.186">   WriteXMLTag(field, value);</span>
<a href="#l22.187"></a><span id="l22.187">   return NS_OK;</span>
<a href="#l22.188"></a><span id="l22.188"> }</span>
<a href="#l22.189"></a><span id="l22.189"> </span>
<a href="#l22.190"></a><span id="l22.190" class="difflineminus">-nsresult</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineminus">-nsMimeXmlEmitter::EndAttachment()</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineminus">-{</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineplus">+nsresult nsMimeXmlEmitter::EndAttachment() {</span>
<a href="#l22.194"></a><span id="l22.194">   UtilityWrite(&quot;&lt;/mailattachment&gt;&quot;);</span>
<a href="#l22.195"></a><span id="l22.195">   return NS_OK;</span>
<a href="#l22.196"></a><span id="l22.196"> }</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineminus">-</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeXmlEmitter.h</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeXmlEmitter.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -5,38 +5,37 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #ifndef _nsMimeXmlEmitter_h_</span>
<a href="#l23.5"></a><span id="l23.5"> #define _nsMimeXmlEmitter_h_</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l23.8"></a><span id="l23.8"> #include &quot;prio.h&quot;</span>
<a href="#l23.9"></a><span id="l23.9"> #include &quot;nsMimeBaseEmitter.h&quot;</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11"> class nsMimeXmlEmitter : public nsMimeBaseEmitter {</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-public:</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-    nsMimeXmlEmitter ();</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-    virtual       ~nsMimeXmlEmitter (void);</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+ public:</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+  nsMimeXmlEmitter();</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+  virtual ~nsMimeXmlEmitter(void);</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-    NS_IMETHOD    Complete() override;</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+  NS_IMETHOD Complete() override;</span>
<a href="#l23.21"></a><span id="l23.21"> </span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-    // Header handling routines.</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-    NS_IMETHOD    StartHeader(bool rootMailHeader, bool headerOnly, const char *msgID,</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-                              const char *outCharset) override;</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-    NS_IMETHOD    AddHeaderField(const char *field, const char *value) override;</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-    NS_IMETHOD    EndHeader(const nsACString &amp;buf) override;</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+  // Header handling routines.</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineplus">+  NS_IMETHOD StartHeader(bool rootMailHeader, bool headerOnly,</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+                         const char *msgID, const char *outCharset) override;</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+  NS_IMETHOD AddHeaderField(const char *field, const char *value) override;</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+  NS_IMETHOD EndHeader(const nsACString &amp;buf) override;</span>
<a href="#l23.32"></a><span id="l23.32"> </span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-    // Attachment handling routines</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-    NS_IMETHOD    StartAttachment(const nsACString &amp;name,</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-                                  const char *contentType, const char *url,</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-                                  bool aIsExternalAttachment) override;</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-    NS_IMETHOD    AddAttachmentField(const char *field, const char *value) override;</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-    NS_IMETHOD    EndAttachment() override;</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+  // Attachment handling routines</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+  NS_IMETHOD StartAttachment(const nsACString &amp;name, const char *contentType,</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+                             const char *url,</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+                             bool aIsExternalAttachment) override;</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+  NS_IMETHOD AddAttachmentField(const char *field, const char *value) override;</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+  NS_IMETHOD EndAttachment() override;</span>
<a href="#l23.45"></a><span id="l23.45"> </span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-    NS_IMETHOD    WriteXMLHeader(const char *msgID);</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-    NS_IMETHOD    WriteXMLTag(const char *tagName, const char *value);</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+  NS_IMETHOD WriteXMLHeader(const char *msgID);</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+  NS_IMETHOD WriteXMLTag(const char *tagName, const char *value);</span>
<a href="#l23.50"></a><span id="l23.50"> </span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-protected:</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-    // For header determination...</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineminus">-    bool                mXMLHeaderStarted;</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineminus">-    int32_t             mAttachCount;</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+ protected:</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineplus">+  // For header determination...</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+  bool mXMLHeaderStarted;</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+  int32_t mAttachCount;</span>
<a href="#l23.60"></a><span id="l23.60"> };</span>
<a href="#l23.61"></a><span id="l23.61"> </span>
<a href="#l23.62"></a><span id="l23.62"> #endif /* _nsMimeXmlEmitter_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/mime/public/MimeEncoder.h</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/mime/public/MimeEncoder.h</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -9,36 +9,36 @@</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5"> #include &quot;nscore.h&quot;</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7"> namespace mozilla {</span>
<a href="#l24.8"></a><span id="l24.8"> namespace mailnews {</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> /// A class for encoding the bodies of MIME parts.</span>
<a href="#l24.11"></a><span id="l24.11"> class MimeEncoder {</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-public:</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+ public:</span>
<a href="#l24.14"></a><span id="l24.14">   virtual ~MimeEncoder() {}</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16">   /// A callback for writing the encoded output</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-  typedef nsresult (*OutputCallback)</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-    (const char *buf, int32_t size, void *closure);</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+  typedef nsresult (*OutputCallback)(const char *buf, int32_t size,</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+                                     void *closure);</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22">   /// Encodes the string in the buffer and sends it to the callback</span>
<a href="#l24.23"></a><span id="l24.23">   virtual nsresult Write(const char *buffer, int32_t size) = 0;</span>
<a href="#l24.24"></a><span id="l24.24">   /// Flush all pending data when no more data exists</span>
<a href="#l24.25"></a><span id="l24.25">   virtual nsresult Flush() { return NS_OK; }</span>
<a href="#l24.26"></a><span id="l24.26"> </span>
<a href="#l24.27"></a><span id="l24.27">   /// Get an encoder that outputs Base64-encoded data</span>
<a href="#l24.28"></a><span id="l24.28">   static MimeEncoder *GetBase64Encoder(OutputCallback callback, void *closure);</span>
<a href="#l24.29"></a><span id="l24.29">   /// Get an encoder that outputs quoted-printable data</span>
<a href="#l24.30"></a><span id="l24.30">   static MimeEncoder *GetQPEncoder(OutputCallback callback, void *closure);</span>
<a href="#l24.31"></a><span id="l24.31"> </span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-protected:</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+ protected:</span>
<a href="#l24.34"></a><span id="l24.34">   MimeEncoder(OutputCallback callback, void *closure);</span>
<a href="#l24.35"></a><span id="l24.35">   OutputCallback mCallback;</span>
<a href="#l24.36"></a><span id="l24.36">   void *mClosure;</span>
<a href="#l24.37"></a><span id="l24.37">   uint32_t mCurrentColumn;</span>
<a href="#l24.38"></a><span id="l24.38"> };</span>
<a href="#l24.39"></a><span id="l24.39"> </span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-} // namespace mailnews</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-} // namespace mozilla</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+}  // namespace mailnews</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+}  // namespace mozilla</span>
<a href="#l24.44"></a><span id="l24.44"> </span>
<a href="#l24.45"></a><span id="l24.45"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/mime/public/MimeHeaderParser.h</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/mime/public/MimeHeaderParser.h</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -43,24 +43,24 @@ void DoConversion(const nsTArray&lt;nsStrin</span>
<a href="#l25.4"></a><span id="l25.4">  * an nsTArray&lt;nsCString&gt; into methods that expect nsTArray&lt;nsString&gt; for out</span>
<a href="#l25.5"></a><span id="l25.5">  * parameters (this does not work for in-parameters).</span>
<a href="#l25.6"></a><span id="l25.6">  *</span>
<a href="#l25.7"></a><span id="l25.7">  * It works by internally providing an nsTArray&lt;nsString&gt; which it uses for its</span>
<a href="#l25.8"></a><span id="l25.8">  * external API operations. If the user requests an array of nsCString elements</span>
<a href="#l25.9"></a><span id="l25.9">  * instead, it converts the UTF-16 array to a UTF-8 array on destruction.</span>
<a href="#l25.10"></a><span id="l25.10">  */</span>
<a href="#l25.11"></a><span id="l25.11"> template &lt;uint32_t N = 5&gt;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-class UTF16ArrayAdapter</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-{</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-public:</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+class UTF16ArrayAdapter {</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+ public:</span>
<a href="#l25.17"></a><span id="l25.17">   explicit UTF16ArrayAdapter(nsTArray&lt;nsCString&gt; &amp;aUTF8Array)</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-  : mUTF8Array(aUTF8Array) {}</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+      : mUTF8Array(aUTF8Array) {}</span>
<a href="#l25.20"></a><span id="l25.20">   ~UTF16ArrayAdapter() { detail::DoConversion(mUTF16Array, mUTF8Array); }</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-  operator nsTArray&lt;nsString&gt;&amp;() { return mUTF16Array; }</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-private:</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+  operator nsTArray&lt;nsString&gt; &amp;() { return mUTF16Array; }</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+ private:</span>
<a href="#l25.26"></a><span id="l25.26">   nsTArray&lt;nsCString&gt; &amp;mUTF8Array;</span>
<a href="#l25.27"></a><span id="l25.27">   AutoTArray&lt;nsString, N&gt; mUTF16Array;</span>
<a href="#l25.28"></a><span id="l25.28"> };</span>
<a href="#l25.29"></a><span id="l25.29"> </span>
<a href="#l25.30"></a><span id="l25.30"> /**</span>
<a href="#l25.31"></a><span id="l25.31">  * Given a name and an email, both encoded in UTF-8, produce a string suitable</span>
<a href="#l25.32"></a><span id="l25.32">  * for writing in an email header by quoting where necessary.</span>
<a href="#l25.33"></a><span id="l25.33">  *</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineat">@@ -167,12 +167,12 @@ void ExtractName(const nsCOMArray&lt;msgIAd</span>
<a href="#l25.35"></a><span id="l25.35"> /**</span>
<a href="#l25.36"></a><span id="l25.36">  * Given an RFC 2047-decoded message header value, extract the first display</span>
<a href="#l25.37"></a><span id="l25.37">  * name found in the header. If there is no display name, the email address is</span>
<a href="#l25.38"></a><span id="l25.38">  * returned instead.</span>
<a href="#l25.39"></a><span id="l25.39">  */</span>
<a href="#l25.40"></a><span id="l25.40"> void ExtractName(const nsCOMArray&lt;msgIAddressObject&gt; &amp;aDecodedHeader,</span>
<a href="#l25.41"></a><span id="l25.41">                  nsAString &amp;name);</span>
<a href="#l25.42"></a><span id="l25.42"> </span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-} // namespace mailnews</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-} // namespace mozilla</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+}  // namespace mailnews</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+}  // namespace mozilla</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/mime/public/nsIMimeContentTypeHandler.h</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/mime/public/nsIMimeContentTypeHandler.h</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -14,52 +14,66 @@</span>
<a href="#l26.4"></a><span id="l26.4">  *</span>
<a href="#l26.5"></a><span id="l26.5">  *       libmime will then use the XPCOM Component Manager to</span>
<a href="#l26.6"></a><span id="l26.6">  *       locate the appropriate Content Type handler</span>
<a href="#l26.7"></a><span id="l26.7">  */</span>
<a href="#l26.8"></a><span id="l26.8"> #ifndef nsIMimeContentTypeHandler_h_</span>
<a href="#l26.9"></a><span id="l26.9"> #define nsIMimeContentTypeHandler_h_</span>
<a href="#l26.10"></a><span id="l26.10"> </span>
<a href="#l26.11"></a><span id="l26.11"> typedef struct {</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-  bool        force_inline_display;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+  bool force_inline_display;</span>
<a href="#l26.14"></a><span id="l26.14"> } contentTypeHandlerInitStruct;</span>
<a href="#l26.15"></a><span id="l26.15"> </span>
<a href="#l26.16"></a><span id="l26.16"> #include &quot;nsISupports.h&quot;</span>
<a href="#l26.17"></a><span id="l26.17"> #include &quot;mimecth.h&quot;</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19"> // {20DABD99-F8B5-11d2-8EE0-00A024A7D144}</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-#define NS_IMIME_CONTENT_TYPE_HANDLER_IID \</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-      { 0x20dabd99, 0xf8b5, 0x11d2,   \</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-      { 0x8e, 0xe0, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 } }</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+#define NS_IMIME_CONTENT_TYPE_HANDLER_IID           \</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineplus">+  {                                                 \</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+    0x20dabd99, 0xf8b5, 0x11d2, {                   \</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+      0x8e, 0xe0, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 \</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+    }                                               \</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+  }</span>
<a href="#l26.29"></a><span id="l26.29"> </span>
<a href="#l26.30"></a><span id="l26.30"> // {20DABDA1-F8B5-11d2-8EE0-00A024A7D144}</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-#define NS_VCARD_CONTENT_TYPE_HANDLER_CID \</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-      { 0x20dabda1, 0xf8b5, 0x11d2, \</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-      { 0x8e, 0xe0, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 } }</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+#define NS_VCARD_CONTENT_TYPE_HANDLER_CID           \</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+  {                                                 \</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+    0x20dabda1, 0xf8b5, 0x11d2, {                   \</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+      0x8e, 0xe0, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 \</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+    }                                               \</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+  }</span>
<a href="#l26.40"></a><span id="l26.40"> </span>
<a href="#l26.41"></a><span id="l26.41" class="difflineminus">-#define NS_SMIME_CONTENT_TYPE_HANDLER_CID \</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-      { 0x20dabdac, 0xf8b5, 0x11d2, \</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-      { 0xFF, 0xe0, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 } }</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+#define NS_SMIME_CONTENT_TYPE_HANDLER_CID           \</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineplus">+  {                                                 \</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineplus">+    0x20dabdac, 0xf8b5, 0x11d2, {                   \</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineplus">+      0xFF, 0xe0, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 \</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+    }                                               \</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+  }</span>
<a href="#l26.50"></a><span id="l26.50"> </span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-#define NS_SIGNED_CONTENT_TYPE_HANDLER_CID \</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-      { 0x20dabdac, 0xf8b5, 0x11d2, \</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-      { 0xFF, 0xe0, 0x0, 0xaf, 0x19, 0xa7, 0xd1, 0x44 } }</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+#define NS_SIGNED_CONTENT_TYPE_HANDLER_CID          \</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineplus">+  {                                                 \</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+    0x20dabdac, 0xf8b5, 0x11d2, {                   \</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+      0xFF, 0xe0, 0x0, 0xaf, 0x19, 0xa7, 0xd1, 0x44 \</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+    }                                               \</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineplus">+  }</span>
<a href="#l26.60"></a><span id="l26.60"> </span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-#define NS_PGPMIME_CONTENT_TYPE_HANDLER_CID \</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-      { 0x212f415f, 0xf8b5, 0x11d2, \</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-      { 0xFF, 0xe0, 0x0, 0xaf, 0x19, 0xa7, 0xd1, 0x44 } }</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineminus">-</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineplus">+#define NS_PGPMIME_CONTENT_TYPE_HANDLER_CID         \</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+  {                                                 \</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+    0x212f415f, 0xf8b5, 0x11d2, {                   \</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+      0xFF, 0xe0, 0x0, 0xaf, 0x19, 0xa7, 0xd1, 0x44 \</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+    }                                               \</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+  }</span>
<a href="#l26.71"></a><span id="l26.71"> </span>
<a href="#l26.72"></a><span id="l26.72"> class nsIMimeContentTypeHandler : public nsISupports {</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineminus">-public:</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+ public:</span>
<a href="#l26.75"></a><span id="l26.75">   NS_DECLARE_STATIC_IID_ACCESSOR(NS_IMIME_CONTENT_TYPE_HANDLER_IID)</span>
<a href="#l26.76"></a><span id="l26.76"> </span>
<a href="#l26.77"></a><span id="l26.77" class="difflineminus">-  NS_IMETHOD    GetContentType(char **contentType) = 0;</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineplus">+  NS_IMETHOD GetContentType(char **contentType) = 0;</span>
<a href="#l26.79"></a><span id="l26.79"> </span>
<a href="#l26.80"></a><span id="l26.80" class="difflineminus">-  NS_IMETHOD    CreateContentTypeHandlerClass(const char *content_type,</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineminus">-                                              contentTypeHandlerInitStruct *initStruct,</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineminus">-                                              MimeObjectClass **objClass) = 0;</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineplus">+  NS_IMETHOD CreateContentTypeHandlerClass(</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineplus">+      const char *content_type, contentTypeHandlerInitStruct *initStruct,</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineplus">+      MimeObjectClass **objClass) = 0;</span>
<a href="#l26.86"></a><span id="l26.86"> };</span>
<a href="#l26.87"></a><span id="l26.87"> </span>
<a href="#l26.88"></a><span id="l26.88"> NS_DEFINE_STATIC_IID_ACCESSOR(nsIMimeContentTypeHandler,</span>
<a href="#l26.89"></a><span id="l26.89">                               NS_IMIME_CONTENT_TYPE_HANDLER_IID)</span>
<a href="#l26.90"></a><span id="l26.90"> </span>
<a href="#l26.91"></a><span id="l26.91"> #endif /* nsIMimeContentTypeHandler_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/mime/public/nsIMimeObjectClassAccess.h</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/mime/public/nsIMimeObjectClassAccess.h</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -8,44 +8,46 @@</span>
<a href="#l27.4"></a><span id="l27.4">  * a Content-Type handler &quot;Plug In&quot; (i.e. vCard) for accessing various</span>
<a href="#l27.5"></a><span id="l27.5">  * internal information about the object class system of libmime. When</span>
<a href="#l27.6"></a><span id="l27.6">  * libmime progresses to a C++ object class, this would probably change.</span>
<a href="#l27.7"></a><span id="l27.7">  */</span>
<a href="#l27.8"></a><span id="l27.8"> #ifndef nsIMimeObjectClassAccess_h_</span>
<a href="#l27.9"></a><span id="l27.9"> #define nsIMimeObjectClassAccess_h_</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11"> // {C09EDB23-B7AF-11d2-B35E-525400E2D63A}</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-#define NS_IMIME_OBJECT_CLASS_ACCESS_IID \</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-      { 0xc09edb23, 0xb7af, 0x11d2,   \</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-      { 0xb3, 0x5e, 0x52, 0x54, 0x0, 0xe2, 0xd6, 0x3a } }</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+#define NS_IMIME_OBJECT_CLASS_ACCESS_IID            \</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+  {                                                 \</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+    0xc09edb23, 0xb7af, 0x11d2, {                   \</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+      0xb3, 0x5e, 0x52, 0x54, 0x0, 0xe2, 0xd6, 0x3a \</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+    }                                               \</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+  }</span>
<a href="#l27.21"></a><span id="l27.21"> </span>
<a href="#l27.22"></a><span id="l27.22"> #include &quot;nsISupports.h&quot;</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24"> class nsIMimeObjectClassAccess : public nsISupports {</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineminus">-public:</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+ public:</span>
<a href="#l27.27"></a><span id="l27.27">   NS_DECLARE_STATIC_IID_ACCESSOR(NS_IMIME_OBJECT_CLASS_ACCESS_IID)</span>
<a href="#l27.28"></a><span id="l27.28"> </span>
<a href="#l27.29"></a><span id="l27.29">   // These methods are all implemented by libmime to be used by</span>
<a href="#l27.30"></a><span id="l27.30">   // content type handler plugins for processing stream data.</span>
<a href="#l27.31"></a><span id="l27.31"> </span>
<a href="#l27.32"></a><span id="l27.32">   // This is the write call for outputting processed stream data.</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-  NS_IMETHOD    MimeObjectWrite(void *mimeObject,</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-                                char *data,</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-                                int32_t length,</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-                                bool user_visible_p) = 0;</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+  NS_IMETHOD MimeObjectWrite(void *mimeObject, char *data, int32_t length,</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+                             bool user_visible_p) = 0;</span>
<a href="#l27.39"></a><span id="l27.39"> </span>
<a href="#l27.40"></a><span id="l27.40">   // The following group of calls expose the pointers for the object</span>
<a href="#l27.41"></a><span id="l27.41">   // system within libmime.</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-  NS_IMETHOD    GetmimeInlineTextClass(void **ptr) = 0;</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-  NS_IMETHOD    GetmimeLeafClass(void **ptr) = 0;</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-  NS_IMETHOD    GetmimeObjectClass(void **ptr) = 0;</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-  NS_IMETHOD    GetmimeContainerClass(void **ptr) = 0;</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-  NS_IMETHOD    GetmimeMultipartClass(void **ptr) = 0;</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-  NS_IMETHOD    GetmimeMultipartSignedClass(void **ptr) = 0;</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-  NS_IMETHOD    GetmimeEncryptedClass(void **ptr) = 0;</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineplus">+  NS_IMETHOD GetmimeInlineTextClass(void **ptr) = 0;</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+  NS_IMETHOD GetmimeLeafClass(void **ptr) = 0;</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+  NS_IMETHOD GetmimeObjectClass(void **ptr) = 0;</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+  NS_IMETHOD GetmimeContainerClass(void **ptr) = 0;</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+  NS_IMETHOD GetmimeMultipartClass(void **ptr) = 0;</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+  NS_IMETHOD GetmimeMultipartSignedClass(void **ptr) = 0;</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineplus">+  NS_IMETHOD GetmimeEncryptedClass(void **ptr) = 0;</span>
<a href="#l27.56"></a><span id="l27.56"> </span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-  NS_IMETHOD    MimeCreate(char* content_type, void * hdrs, void * opts, void **ptr) = 0;</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+  NS_IMETHOD MimeCreate(char *content_type, void *hdrs, void *opts,</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineplus">+                        void **ptr) = 0;</span>
<a href="#l27.60"></a><span id="l27.60"> };</span>
<a href="#l27.61"></a><span id="l27.61"> </span>
<a href="#l27.62"></a><span id="l27.62"> NS_DEFINE_STATIC_IID_ACCESSOR(nsIMimeObjectClassAccess,</span>
<a href="#l27.63"></a><span id="l27.63">                               NS_IMIME_OBJECT_CLASS_ACCESS_IID)</span>
<a href="#l27.64"></a><span id="l27.64"> </span>
<a href="#l27.65"></a><span id="l27.65"> #endif /* nsIMimeObjectClassAccess_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/mime/public/nsMailHeaders.h</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/mime/public/nsMailHeaders.h</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -9,82 +9,82 @@</span>
<a href="#l28.4"></a><span id="l28.4">  * to call on these routines.</span>
<a href="#l28.5"></a><span id="l28.5">  */</span>
<a href="#l28.6"></a><span id="l28.6"> #ifndef nsMailHeaders_h_</span>
<a href="#l28.7"></a><span id="l28.7"> #define nsMailHeaders_h_</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9"> /*</span>
<a href="#l28.10"></a><span id="l28.10">  * These are the defines for standard header field names.</span>
<a href="#l28.11"></a><span id="l28.11">  */</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-#define HEADER_BCC                          &quot;BCC&quot;</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-#define HEADER_CC                            &quot;CC&quot;</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-#define HEADER_CONTENT_BASE                  &quot;Content-Base&quot;</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-#define HEADER_CONTENT_LOCATION              &quot;Content-Location&quot;</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-#define HEADER_CONTENT_ID                    &quot;Content-ID&quot;</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-#define HEADER_CONTENT_DESCRIPTION          &quot;Content-Description&quot;</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-#define HEADER_CONTENT_DISPOSITION          &quot;Content-Disposition&quot;</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-#define HEADER_CONTENT_ENCODING              &quot;Content-Encoding&quot;</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-#define HEADER_CONTENT_LANGUAGE              &quot;Content-Language&quot;</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineminus">-#define HEADER_CONTENT_LENGTH                &quot;Content-Length&quot;</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineminus">-#define HEADER_CONTENT_NAME                  &quot;Content-Name&quot;</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-#define HEADER_CONTENT_TRANSFER_ENCODING    &quot;Content-Transfer-Encoding&quot;</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-#define HEADER_CONTENT_TYPE                  &quot;Content-Type&quot;</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">-#define HEADER_DATE                          &quot;Date&quot;</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-#define HEADER_DISTRIBUTION                  &quot;Distribution&quot;</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineminus">-#define HEADER_FCC                          &quot;FCC&quot;</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-#define HEADER_FOLLOWUP_TO                  &quot;Followup-To&quot;</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-#define HEADER_FROM                          &quot;From&quot;</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">-#define HEADER_STATUS                          &quot;Status&quot;</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-#define HEADER_LINES                        &quot;Lines&quot;</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">-#define HEADER_LIST_POST                    &quot;List-Post&quot;</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineminus">-#define HEADER_MAIL_FOLLOWUP_TO              &quot;Mail-Followup-To&quot;</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineminus">-#define HEADER_MAIL_REPLY_TO               &quot;Mail-Reply-To&quot;</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-#define HEADER_MESSAGE_ID                    &quot;Message-ID&quot;</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineminus">-#define HEADER_MIME_VERSION                  &quot;MIME-Version&quot;</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineminus">-#define HEADER_NEWSGROUPS                    &quot;Newsgroups&quot;</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineminus">-#define HEADER_ORGANIZATION                  &quot;Organization&quot;</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineminus">-#define HEADER_REFERENCES                    &quot;References&quot;</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineminus">-#define HEADER_REPLY_TO                      &quot;Reply-To&quot;</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineminus">-#define HEADER_RESENT_COMMENTS              &quot;Resent-Comments&quot;</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-#define HEADER_RESENT_DATE                  &quot;Resent-Date&quot;</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-#define HEADER_RESENT_FROM                  &quot;Resent-From&quot;</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-#define HEADER_RESENT_MESSAGE_ID            &quot;Resent-Message-ID&quot;</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-#define HEADER_RESENT_SENDER                &quot;Resent-Sender&quot;</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-#define HEADER_RESENT_TO                    &quot;Resent-To&quot;</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-#define HEADER_RESENT_CC                    &quot;Resent-CC&quot;</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineminus">-#define HEADER_SENDER                        &quot;Sender&quot;</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-#define HEADER_SUBJECT                      &quot;Subject&quot;</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineminus">-#define HEADER_TO                            &quot;To&quot;</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineminus">-#define HEADER_APPROVED_BY                  &quot;Approved-By&quot;</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-#define HEADER_X_MAILER                      &quot;X-Mailer&quot;</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-#define HEADER_USER_AGENT                    &quot;User-Agent&quot;</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-#define HEADER_X_NEWSREADER                  &quot;X-Newsreader&quot;</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-#define HEADER_X_POSTING_SOFTWARE            &quot;X-Posting-Software&quot;</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-#define HEADER_X_MOZILLA_STATUS               &quot;X-Mozilla-Status&quot;</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-#define HEADER_X_MOZILLA_STATUS2             &quot;X-Mozilla-Status2&quot;</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-#define HEADER_X_MOZILLA_NEWSHOST            &quot;X-Mozilla-News-Host&quot;</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-#define HEADER_X_MOZILLA_DRAFT_INFO          &quot;X-Mozilla-Draft-Info&quot;</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineminus">-#define HEADER_X_UIDL                        &quot;X-UIDL&quot;</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-#define HEADER_XREF                          &quot;XREF&quot;</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-#define HEADER_X_SUN_CHARSET                &quot;X-Sun-Charset&quot;</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-#define HEADER_X_SUN_CONTENT_LENGTH          &quot;X-Sun-Content-Length&quot;</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineminus">-#define HEADER_X_SUN_CONTENT_LINES          &quot;X-Sun-Content-Lines&quot;</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-#define HEADER_X_SUN_DATA_DESCRIPTION        &quot;X-Sun-Data-Description&quot;</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-#define HEADER_X_SUN_DATA_NAME              &quot;X-Sun-Data-Name&quot;</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-#define HEADER_X_SUN_DATA_TYPE              &quot;X-Sun-Data-Type&quot;</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-#define HEADER_X_SUN_ENCODING_INFO          &quot;X-Sun-Encoding-Info&quot;</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineminus">-#define HEADER_X_PRIORITY                   &quot;X-Priority&quot;</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+#define HEADER_BCC &quot;BCC&quot;</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineplus">+#define HEADER_CC &quot;CC&quot;</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+#define HEADER_CONTENT_BASE &quot;Content-Base&quot;</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+#define HEADER_CONTENT_LOCATION &quot;Content-Location&quot;</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+#define HEADER_CONTENT_ID &quot;Content-ID&quot;</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineplus">+#define HEADER_CONTENT_DESCRIPTION &quot;Content-Description&quot;</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineplus">+#define HEADER_CONTENT_DISPOSITION &quot;Content-Disposition&quot;</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineplus">+#define HEADER_CONTENT_ENCODING &quot;Content-Encoding&quot;</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineplus">+#define HEADER_CONTENT_LANGUAGE &quot;Content-Language&quot;</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineplus">+#define HEADER_CONTENT_LENGTH &quot;Content-Length&quot;</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineplus">+#define HEADER_CONTENT_NAME &quot;Content-Name&quot;</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineplus">+#define HEADER_CONTENT_TRANSFER_ENCODING &quot;Content-Transfer-Encoding&quot;</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineplus">+#define HEADER_CONTENT_TYPE &quot;Content-Type&quot;</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineplus">+#define HEADER_DATE &quot;Date&quot;</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineplus">+#define HEADER_DISTRIBUTION &quot;Distribution&quot;</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineplus">+#define HEADER_FCC &quot;FCC&quot;</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineplus">+#define HEADER_FOLLOWUP_TO &quot;Followup-To&quot;</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineplus">+#define HEADER_FROM &quot;From&quot;</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineplus">+#define HEADER_STATUS &quot;Status&quot;</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineplus">+#define HEADER_LINES &quot;Lines&quot;</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineplus">+#define HEADER_LIST_POST &quot;List-Post&quot;</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineplus">+#define HEADER_MAIL_FOLLOWUP_TO &quot;Mail-Followup-To&quot;</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+#define HEADER_MAIL_REPLY_TO &quot;Mail-Reply-To&quot;</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+#define HEADER_MESSAGE_ID &quot;Message-ID&quot;</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+#define HEADER_MIME_VERSION &quot;MIME-Version&quot;</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+#define HEADER_NEWSGROUPS &quot;Newsgroups&quot;</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineplus">+#define HEADER_ORGANIZATION &quot;Organization&quot;</span>
<a href="#l28.97"></a><span id="l28.97" class="difflineplus">+#define HEADER_REFERENCES &quot;References&quot;</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineplus">+#define HEADER_REPLY_TO &quot;Reply-To&quot;</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineplus">+#define HEADER_RESENT_COMMENTS &quot;Resent-Comments&quot;</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineplus">+#define HEADER_RESENT_DATE &quot;Resent-Date&quot;</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineplus">+#define HEADER_RESENT_FROM &quot;Resent-From&quot;</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineplus">+#define HEADER_RESENT_MESSAGE_ID &quot;Resent-Message-ID&quot;</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineplus">+#define HEADER_RESENT_SENDER &quot;Resent-Sender&quot;</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineplus">+#define HEADER_RESENT_TO &quot;Resent-To&quot;</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineplus">+#define HEADER_RESENT_CC &quot;Resent-CC&quot;</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineplus">+#define HEADER_SENDER &quot;Sender&quot;</span>
<a href="#l28.107"></a><span id="l28.107" class="difflineplus">+#define HEADER_SUBJECT &quot;Subject&quot;</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineplus">+#define HEADER_TO &quot;To&quot;</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineplus">+#define HEADER_APPROVED_BY &quot;Approved-By&quot;</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineplus">+#define HEADER_X_MAILER &quot;X-Mailer&quot;</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineplus">+#define HEADER_USER_AGENT &quot;User-Agent&quot;</span>
<a href="#l28.112"></a><span id="l28.112" class="difflineplus">+#define HEADER_X_NEWSREADER &quot;X-Newsreader&quot;</span>
<a href="#l28.113"></a><span id="l28.113" class="difflineplus">+#define HEADER_X_POSTING_SOFTWARE &quot;X-Posting-Software&quot;</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineplus">+#define HEADER_X_MOZILLA_STATUS &quot;X-Mozilla-Status&quot;</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineplus">+#define HEADER_X_MOZILLA_STATUS2 &quot;X-Mozilla-Status2&quot;</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineplus">+#define HEADER_X_MOZILLA_NEWSHOST &quot;X-Mozilla-News-Host&quot;</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineplus">+#define HEADER_X_MOZILLA_DRAFT_INFO &quot;X-Mozilla-Draft-Info&quot;</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineplus">+#define HEADER_X_UIDL &quot;X-UIDL&quot;</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineplus">+#define HEADER_XREF &quot;XREF&quot;</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineplus">+#define HEADER_X_SUN_CHARSET &quot;X-Sun-Charset&quot;</span>
<a href="#l28.121"></a><span id="l28.121" class="difflineplus">+#define HEADER_X_SUN_CONTENT_LENGTH &quot;X-Sun-Content-Length&quot;</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineplus">+#define HEADER_X_SUN_CONTENT_LINES &quot;X-Sun-Content-Lines&quot;</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineplus">+#define HEADER_X_SUN_DATA_DESCRIPTION &quot;X-Sun-Data-Description&quot;</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineplus">+#define HEADER_X_SUN_DATA_NAME &quot;X-Sun-Data-Name&quot;</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineplus">+#define HEADER_X_SUN_DATA_TYPE &quot;X-Sun-Data-Type&quot;</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineplus">+#define HEADER_X_SUN_ENCODING_INFO &quot;X-Sun-Encoding-Info&quot;</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineplus">+#define HEADER_X_PRIORITY &quot;X-Priority&quot;</span>
<a href="#l28.128"></a><span id="l28.128"> </span>
<a href="#l28.129"></a><span id="l28.129" class="difflineminus">-#define HEADER_PARM_CHARSET                 &quot;charset&quot;</span>
<a href="#l28.130"></a><span id="l28.130" class="difflineminus">-#define HEADER_PARM_START                   &quot;start&quot;</span>
<a href="#l28.131"></a><span id="l28.131" class="difflineminus">-#define HEADER_PARM_BOUNDARY                &quot;BOUNDARY&quot;</span>
<a href="#l28.132"></a><span id="l28.132" class="difflineminus">-#define HEADER_PARM_FILENAME                &quot;FILENAME&quot;</span>
<a href="#l28.133"></a><span id="l28.133" class="difflineminus">-#define HEADER_PARM_NAME                    &quot;NAME&quot;</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineminus">-#define HEADER_PARM_TYPE                    &quot;TYPE&quot;</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineplus">+#define HEADER_PARM_CHARSET &quot;charset&quot;</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+#define HEADER_PARM_START &quot;start&quot;</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineplus">+#define HEADER_PARM_BOUNDARY &quot;BOUNDARY&quot;</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineplus">+#define HEADER_PARM_FILENAME &quot;FILENAME&quot;</span>
<a href="#l28.139"></a><span id="l28.139" class="difflineplus">+#define HEADER_PARM_NAME &quot;NAME&quot;</span>
<a href="#l28.140"></a><span id="l28.140" class="difflineplus">+#define HEADER_PARM_TYPE &quot;TYPE&quot;</span>
<a href="#l28.141"></a><span id="l28.141"> </span>
<a href="#l28.142"></a><span id="l28.142" class="difflineminus">-#define HEADER_X_MOZILLA_PART_URL           &quot;X-Mozilla-PartURL&quot;</span>
<a href="#l28.143"></a><span id="l28.143" class="difflineminus">-#define HEADER_X_MOZILLA_PART_SIZE          &quot;X-Mozilla-PartSize&quot;</span>
<a href="#l28.144"></a><span id="l28.144" class="difflineminus">-#define HEADER_X_MOZILLA_PART_DOWNLOADED    &quot;X-Mozilla-PartDownloaded&quot;</span>
<a href="#l28.145"></a><span id="l28.145" class="difflineminus">-#define HEADER_X_MOZILLA_CLOUD_PART          &quot;X-Mozilla-Cloud-Part&quot;</span>
<a href="#l28.146"></a><span id="l28.146" class="difflineminus">-#define HEADER_X_MOZILLA_IDENTITY_KEY       &quot;X-Identity-Key&quot;</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineminus">-#define HEADER_X_MOZILLA_ACCOUNT_KEY       &quot;X-Account-Key&quot;</span>
<a href="#l28.148"></a><span id="l28.148" class="difflineminus">-#define HEADER_X_MOZILLA_KEYWORDS          &quot;X-Mozilla-Keys&quot;</span>
<a href="#l28.149"></a><span id="l28.149" class="difflineplus">+#define HEADER_X_MOZILLA_PART_URL &quot;X-Mozilla-PartURL&quot;</span>
<a href="#l28.150"></a><span id="l28.150" class="difflineplus">+#define HEADER_X_MOZILLA_PART_SIZE &quot;X-Mozilla-PartSize&quot;</span>
<a href="#l28.151"></a><span id="l28.151" class="difflineplus">+#define HEADER_X_MOZILLA_PART_DOWNLOADED &quot;X-Mozilla-PartDownloaded&quot;</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineplus">+#define HEADER_X_MOZILLA_CLOUD_PART &quot;X-Mozilla-Cloud-Part&quot;</span>
<a href="#l28.153"></a><span id="l28.153" class="difflineplus">+#define HEADER_X_MOZILLA_IDENTITY_KEY &quot;X-Identity-Key&quot;</span>
<a href="#l28.154"></a><span id="l28.154" class="difflineplus">+#define HEADER_X_MOZILLA_ACCOUNT_KEY &quot;X-Account-Key&quot;</span>
<a href="#l28.155"></a><span id="l28.155" class="difflineplus">+#define HEADER_X_MOZILLA_KEYWORDS &quot;X-Mozilla-Keys&quot;</span>
<a href="#l28.156"></a><span id="l28.156"> #endif /* nsMailHeaders_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/mime/public/nsMsgMimeCID.h</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/mime/public/nsMsgMimeCID.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -2,32 +2,37 @@</span>
<a href="#l29.4"></a><span id="l29.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.5"></a><span id="l29.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.6"></a><span id="l29.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8"> #ifndef nsMessageMimeCID_h__</span>
<a href="#l29.9"></a><span id="l29.9"> #define nsMessageMimeCID_h__</span>
<a href="#l29.10"></a><span id="l29.10"> </span>
<a href="#l29.11"></a><span id="l29.11"> #define NS_MAILNEWS_MIME_STREAM_CONVERTER_CONTRACTID \</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-  NS_ISTREAMCONVERTER_KEY &quot;?from=message/rfc822&amp;to=application/vnd.mozilla.xul+xml&quot;</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+  NS_ISTREAMCONVERTER_KEY                            \</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+      &quot;?from=message/rfc822&amp;to=application/vnd.mozilla.xul+xml&quot;</span>
<a href="#l29.15"></a><span id="l29.15"> </span>
<a href="#l29.16"></a><span id="l29.16"> #define NS_MAILNEWS_MIME_STREAM_CONVERTER_CONTRACTID1 \</span>
<a href="#l29.17"></a><span id="l29.17">   NS_ISTREAMCONVERTER_KEY &quot;?from=message/rfc822&amp;to=text/html&quot;</span>
<a href="#l29.18"></a><span id="l29.18"> </span>
<a href="#l29.19"></a><span id="l29.19"> #define NS_MAILNEWS_MIME_STREAM_CONVERTER_CONTRACTID2 \</span>
<a href="#l29.20"></a><span id="l29.20">   NS_ISTREAMCONVERTER_KEY &quot;?from=message/rfc822&amp;to=*/*&quot;</span>
<a href="#l29.21"></a><span id="l29.21"> </span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-#define NS_MAILNEWS_MIME_STREAM_CONVERTER_CID                    \</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-{ /* FAF4F9A6-60AD-11d3-989A-001083010E9B */         \</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">- 0xfaf4f9a6, 0x60ad, 0x11d3, { 0x98, 0x9a, 0x0, 0x10, 0x83, 0x1, 0xe, 0x9b } }</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+#define NS_MAILNEWS_MIME_STREAM_CONVERTER_CID     \</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+  { /* FAF4F9A6-60AD-11d3-989A-001083010E9B */    \</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+    0xfaf4f9a6, 0x60ad, 0x11d3, {                 \</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+      0x98, 0x9a, 0x0, 0x10, 0x83, 0x1, 0xe, 0x9b \</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+    }                                             \</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+  }</span>
<a href="#l29.31"></a><span id="l29.31"> </span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-#define NS_MIME_CONVERTER_CONTRACTID \</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-  &quot;@mozilla.org/messenger/mimeconverter;1&quot;</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+#define NS_MIME_CONVERTER_CONTRACTID &quot;@mozilla.org/messenger/mimeconverter;1&quot;</span>
<a href="#l29.35"></a><span id="l29.35"> </span>
<a href="#l29.36"></a><span id="l29.36"> // {403B0540-B7C3-11d2-B35E-525400E2D63A}</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-#define NS_MIME_OBJECT_CLASS_ACCESS_CID   \</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-        { 0x403b0540, 0xb7c3, 0x11d2,         \</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineminus">-        { 0xb3, 0x5e, 0x52, 0x54, 0x0, 0xe2, 0xd6, 0x3a } }</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineplus">+#define NS_MIME_OBJECT_CLASS_ACCESS_CID             \</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+  {                                                 \</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+    0x403b0540, 0xb7c3, 0x11d2, {                   \</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineplus">+      0xb3, 0x5e, 0x52, 0x54, 0x0, 0xe2, 0xd6, 0x3a \</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+    }                                               \</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+  }</span>
<a href="#l29.46"></a><span id="l29.46"> </span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-#define NS_MIME_OBJECT_CONTRACTID \</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-  &quot;@mozilla.org/messenger/mimeobject;1&quot;</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+#define NS_MIME_OBJECT_CONTRACTID &quot;@mozilla.org/messenger/mimeobject;1&quot;</span>
<a href="#l29.50"></a><span id="l29.50"> </span>
<a href="#l29.51"></a><span id="l29.51" class="difflineminus">-#endif // nsMessageMimeCID_h__</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineplus">+#endif  // nsMessageMimeCID_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/mime/src/MimeHeaderParser.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/mime/src/MimeHeaderParser.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -11,109 +11,101 @@</span>
<a href="#l30.4"></a><span id="l30.4"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l30.5"></a><span id="l30.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l30.6"></a><span id="l30.6"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> namespace mozilla {</span>
<a href="#l30.9"></a><span id="l30.9"> namespace mailnews {</span>
<a href="#l30.10"></a><span id="l30.10"> </span>
<a href="#l30.11"></a><span id="l30.11"> void detail::DoConversion(const nsTArray&lt;nsString&gt; &amp;aUTF16Array,</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-                          nsTArray&lt;nsCString&gt; &amp;aUTF8Array)</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-{</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+                          nsTArray&lt;nsCString&gt; &amp;aUTF8Array) {</span>
<a href="#l30.15"></a><span id="l30.15">   uint32_t count = aUTF16Array.Length();</span>
<a href="#l30.16"></a><span id="l30.16">   aUTF8Array.SetLength(count);</span>
<a href="#l30.17"></a><span id="l30.17">   for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l30.18"></a><span id="l30.18">     CopyUTF16toUTF8(aUTF16Array[i], aUTF8Array[i]);</span>
<a href="#l30.19"></a><span id="l30.19"> }</span>
<a href="#l30.20"></a><span id="l30.20"> </span>
<a href="#l30.21"></a><span id="l30.21"> void MakeMimeAddress(const nsACString &amp;aName, const nsACString &amp;aEmail,</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-                     nsACString &amp;full)</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-{</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+                     nsACString &amp;full) {</span>
<a href="#l30.25"></a><span id="l30.25">   nsAutoString utf16Address;</span>
<a href="#l30.26"></a><span id="l30.26">   MakeMimeAddress(NS_ConvertUTF8toUTF16(aName), NS_ConvertUTF8toUTF16(aEmail),</span>
<a href="#l30.27"></a><span id="l30.27">                   utf16Address);</span>
<a href="#l30.28"></a><span id="l30.28"> </span>
<a href="#l30.29"></a><span id="l30.29">   CopyUTF16toUTF8(utf16Address, full);</span>
<a href="#l30.30"></a><span id="l30.30"> }</span>
<a href="#l30.31"></a><span id="l30.31"> </span>
<a href="#l30.32"></a><span id="l30.32"> void MakeMimeAddress(const nsAString &amp;aName, const nsAString &amp;aEmail,</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-                     nsAString &amp;full)</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-{</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+                     nsAString &amp;full) {</span>
<a href="#l30.36"></a><span id="l30.36">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; headerParser(services::GetHeaderParser());</span>
<a href="#l30.37"></a><span id="l30.37"> </span>
<a href="#l30.38"></a><span id="l30.38">   nsCOMPtr&lt;msgIAddressObject&gt; address;</span>
<a href="#l30.39"></a><span id="l30.39">   headerParser-&gt;MakeMailboxObject(aName, aEmail, getter_AddRefs(address));</span>
<a href="#l30.40"></a><span id="l30.40">   msgIAddressObject *obj = address;</span>
<a href="#l30.41"></a><span id="l30.41">   headerParser-&gt;MakeMimeHeader(&amp;obj, 1, full);</span>
<a href="#l30.42"></a><span id="l30.42"> }</span>
<a href="#l30.43"></a><span id="l30.43"> </span>
<a href="#l30.44"></a><span id="l30.44"> void MakeDisplayAddress(const nsAString &amp;aName, const nsAString &amp;aEmail,</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineminus">-                        nsAString &amp;full)</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-{</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+                        nsAString &amp;full) {</span>
<a href="#l30.48"></a><span id="l30.48">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; headerParser(services::GetHeaderParser());</span>
<a href="#l30.49"></a><span id="l30.49"> </span>
<a href="#l30.50"></a><span id="l30.50">   nsCOMPtr&lt;msgIAddressObject&gt; object;</span>
<a href="#l30.51"></a><span id="l30.51">   headerParser-&gt;MakeMailboxObject(aName, aEmail, getter_AddRefs(object));</span>
<a href="#l30.52"></a><span id="l30.52">   object-&gt;ToString(full);</span>
<a href="#l30.53"></a><span id="l30.53"> }</span>
<a href="#l30.54"></a><span id="l30.54"> </span>
<a href="#l30.55"></a><span id="l30.55"> void RemoveDuplicateAddresses(const nsACString &amp;aHeader,</span>
<a href="#l30.56"></a><span id="l30.56">                               const nsACString &amp;aOtherEmails,</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineminus">-                              nsACString &amp;result)</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">-{</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+                              nsACString &amp;result) {</span>
<a href="#l30.60"></a><span id="l30.60">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; headerParser(services::GetHeaderParser());</span>
<a href="#l30.61"></a><span id="l30.61"> </span>
<a href="#l30.62"></a><span id="l30.62">   headerParser-&gt;RemoveDuplicateAddresses(aHeader, aOtherEmails, result);</span>
<a href="#l30.63"></a><span id="l30.63"> }</span>
<a href="#l30.64"></a><span id="l30.64"> </span>
<a href="#l30.65"></a><span id="l30.65"> /////////////////////////////////////////////</span>
<a href="#l30.66"></a><span id="l30.66"> // These are the core shim methods we need //</span>
<a href="#l30.67"></a><span id="l30.67"> /////////////////////////////////////////////</span>
<a href="#l30.68"></a><span id="l30.68"> </span>
<a href="#l30.69"></a><span id="l30.69" class="difflineminus">-nsCOMArray&lt;msgIAddressObject&gt; DecodedHeader(const nsAString &amp;aHeader)</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineminus">-{</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineplus">+nsCOMArray&lt;msgIAddressObject&gt; DecodedHeader(const nsAString &amp;aHeader) {</span>
<a href="#l30.72"></a><span id="l30.72">   nsCOMArray&lt;msgIAddressObject&gt; retval;</span>
<a href="#l30.73"></a><span id="l30.73">   if (aHeader.IsEmpty()) {</span>
<a href="#l30.74"></a><span id="l30.74">     return retval;</span>
<a href="#l30.75"></a><span id="l30.75">   }</span>
<a href="#l30.76"></a><span id="l30.76">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; headerParser(services::GetHeaderParser());</span>
<a href="#l30.77"></a><span id="l30.77">   NS_ENSURE_TRUE(headerParser, retval);</span>
<a href="#l30.78"></a><span id="l30.78">   msgIAddressObject **addresses = nullptr;</span>
<a href="#l30.79"></a><span id="l30.79">   uint32_t length;</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">-  nsresult rv = headerParser-&gt;ParseDecodedHeader(aHeader, false,</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-    &amp;length, &amp;addresses);</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+  nsresult rv =</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+      headerParser-&gt;ParseDecodedHeader(aHeader, false, &amp;length, &amp;addresses);</span>
<a href="#l30.84"></a><span id="l30.84">   MOZ_ASSERT(NS_SUCCEEDED(rv), &quot;Javascript jsmime returned an error!&quot;);</span>
<a href="#l30.85"></a><span id="l30.85">   if (NS_SUCCEEDED(rv) &amp;&amp; length &gt; 0 &amp;&amp; addresses) {</span>
<a href="#l30.86"></a><span id="l30.86">     retval.Adopt(addresses, length);</span>
<a href="#l30.87"></a><span id="l30.87">   }</span>
<a href="#l30.88"></a><span id="l30.88">   return retval;</span>
<a href="#l30.89"></a><span id="l30.89"> }</span>
<a href="#l30.90"></a><span id="l30.90"> </span>
<a href="#l30.91"></a><span id="l30.91"> nsCOMArray&lt;msgIAddressObject&gt; EncodedHeader(const nsACString &amp;aHeader,</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineminus">-                                            const char *aCharset)</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineminus">-{</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+                                            const char *aCharset) {</span>
<a href="#l30.95"></a><span id="l30.95">   nsCOMArray&lt;msgIAddressObject&gt; retval;</span>
<a href="#l30.96"></a><span id="l30.96">   if (aHeader.IsEmpty()) {</span>
<a href="#l30.97"></a><span id="l30.97">     return retval;</span>
<a href="#l30.98"></a><span id="l30.98">   }</span>
<a href="#l30.99"></a><span id="l30.99">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; headerParser(services::GetHeaderParser());</span>
<a href="#l30.100"></a><span id="l30.100">   NS_ENSURE_TRUE(headerParser, retval);</span>
<a href="#l30.101"></a><span id="l30.101">   msgIAddressObject **addresses = nullptr;</span>
<a href="#l30.102"></a><span id="l30.102">   uint32_t length;</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineminus">-  nsresult rv = headerParser-&gt;ParseEncodedHeader(aHeader, aCharset,</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">-    false, &amp;length, &amp;addresses);</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineplus">+  nsresult rv = headerParser-&gt;ParseEncodedHeader(aHeader, aCharset, false,</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineplus">+                                                 &amp;length, &amp;addresses);</span>
<a href="#l30.107"></a><span id="l30.107">   MOZ_ASSERT(NS_SUCCEEDED(rv), &quot;This should never fail!&quot;);</span>
<a href="#l30.108"></a><span id="l30.108">   if (NS_SUCCEEDED(rv) &amp;&amp; length &gt; 0 &amp;&amp; addresses) {</span>
<a href="#l30.109"></a><span id="l30.109">     retval.Adopt(addresses, length);</span>
<a href="#l30.110"></a><span id="l30.110">   }</span>
<a href="#l30.111"></a><span id="l30.111">   return retval;</span>
<a href="#l30.112"></a><span id="l30.112"> }</span>
<a href="#l30.113"></a><span id="l30.113"> </span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-nsCOMArray&lt;msgIAddressObject&gt; EncodedHeaderW(const nsAString &amp;aHeader)</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineminus">-{</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineplus">+nsCOMArray&lt;msgIAddressObject&gt; EncodedHeaderW(const nsAString &amp;aHeader) {</span>
<a href="#l30.117"></a><span id="l30.117">   nsCOMArray&lt;msgIAddressObject&gt; retval;</span>
<a href="#l30.118"></a><span id="l30.118">   if (aHeader.IsEmpty()) {</span>
<a href="#l30.119"></a><span id="l30.119">     return retval;</span>
<a href="#l30.120"></a><span id="l30.120">   }</span>
<a href="#l30.121"></a><span id="l30.121">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; headerParser(services::GetHeaderParser());</span>
<a href="#l30.122"></a><span id="l30.122">   NS_ENSURE_TRUE(headerParser, retval);</span>
<a href="#l30.123"></a><span id="l30.123">   msgIAddressObject **addresses = nullptr;</span>
<a href="#l30.124"></a><span id="l30.124">   uint32_t length;</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineat">@@ -121,128 +113,109 @@ nsCOMArray&lt;msgIAddressObject&gt; EncodedHea</span>
<a href="#l30.126"></a><span id="l30.126">   MOZ_ASSERT(NS_SUCCEEDED(rv), &quot;This should never fail!&quot;);</span>
<a href="#l30.127"></a><span id="l30.127">   if (NS_SUCCEEDED(rv) &amp;&amp; length &gt; 0 &amp;&amp; addresses) {</span>
<a href="#l30.128"></a><span id="l30.128">     retval.Adopt(addresses, length);</span>
<a href="#l30.129"></a><span id="l30.129">   }</span>
<a href="#l30.130"></a><span id="l30.130">   return retval;</span>
<a href="#l30.131"></a><span id="l30.131"> }</span>
<a href="#l30.132"></a><span id="l30.132"> </span>
<a href="#l30.133"></a><span id="l30.133"> void ExtractAllAddresses(const nsCOMArray&lt;msgIAddressObject&gt; &amp;aHeader,</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineminus">-                         nsTArray&lt;nsString&gt; &amp;names, nsTArray&lt;nsString&gt; &amp;emails)</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineminus">-{</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineplus">+                         nsTArray&lt;nsString&gt; &amp;names,</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+                         nsTArray&lt;nsString&gt; &amp;emails) {</span>
<a href="#l30.138"></a><span id="l30.138">   uint32_t count = aHeader.Length();</span>
<a href="#l30.139"></a><span id="l30.139"> </span>
<a href="#l30.140"></a><span id="l30.140">   // Prefill arrays before we start</span>
<a href="#l30.141"></a><span id="l30.141">   names.SetLength(count);</span>
<a href="#l30.142"></a><span id="l30.142">   emails.SetLength(count);</span>
<a href="#l30.143"></a><span id="l30.143"> </span>
<a href="#l30.144"></a><span id="l30.144" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineminus">-  {</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l30.147"></a><span id="l30.147">     aHeader[i]-&gt;GetName(names[i]);</span>
<a href="#l30.148"></a><span id="l30.148">     aHeader[i]-&gt;GetEmail(emails[i]);</span>
<a href="#l30.149"></a><span id="l30.149">   }</span>
<a href="#l30.150"></a><span id="l30.150"> </span>
<a href="#l30.151"></a><span id="l30.151" class="difflineminus">-  if (count == 1 &amp;&amp; names[0].IsEmpty() &amp;&amp; emails[0].IsEmpty())</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineminus">-  {</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineplus">+  if (count == 1 &amp;&amp; names[0].IsEmpty() &amp;&amp; emails[0].IsEmpty()) {</span>
<a href="#l30.154"></a><span id="l30.154">     names.Clear();</span>
<a href="#l30.155"></a><span id="l30.155">     emails.Clear();</span>
<a href="#l30.156"></a><span id="l30.156">   }</span>
<a href="#l30.157"></a><span id="l30.157"> }</span>
<a href="#l30.158"></a><span id="l30.158"> </span>
<a href="#l30.159"></a><span id="l30.159"> void ExtractDisplayAddresses(const nsCOMArray&lt;msgIAddressObject&gt; &amp;aHeader,</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineminus">-                             nsTArray&lt;nsString&gt; &amp;displayAddrs)</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineminus">-{</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineplus">+                             nsTArray&lt;nsString&gt; &amp;displayAddrs) {</span>
<a href="#l30.163"></a><span id="l30.163">   uint32_t count = aHeader.Length();</span>
<a href="#l30.164"></a><span id="l30.164"> </span>
<a href="#l30.165"></a><span id="l30.165">   displayAddrs.SetLength(count);</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineminus">-    aHeader[i]-&gt;ToString(displayAddrs[i]);</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) aHeader[i]-&gt;ToString(displayAddrs[i]);</span>
<a href="#l30.169"></a><span id="l30.169"> </span>
<a href="#l30.170"></a><span id="l30.170" class="difflineminus">-  if (count == 1 &amp;&amp; displayAddrs[0].IsEmpty())</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineminus">-    displayAddrs.Clear();</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineplus">+  if (count == 1 &amp;&amp; displayAddrs[0].IsEmpty()) displayAddrs.Clear();</span>
<a href="#l30.173"></a><span id="l30.173"> }</span>
<a href="#l30.174"></a><span id="l30.174"> </span>
<a href="#l30.175"></a><span id="l30.175"> /////////////////////////////////////////////////</span>
<a href="#l30.176"></a><span id="l30.176"> // All of these are based on the above methods //</span>
<a href="#l30.177"></a><span id="l30.177"> /////////////////////////////////////////////////</span>
<a href="#l30.178"></a><span id="l30.178"> </span>
<a href="#l30.179"></a><span id="l30.179"> void ExtractEmails(const nsCOMArray&lt;msgIAddressObject&gt; &amp;aHeader,</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineminus">-                   nsTArray&lt;nsString&gt; &amp;emails)</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineminus">-{</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineplus">+                   nsTArray&lt;nsString&gt; &amp;emails) {</span>
<a href="#l30.183"></a><span id="l30.183">   nsTArray&lt;nsString&gt; names;</span>
<a href="#l30.184"></a><span id="l30.184">   ExtractAllAddresses(aHeader, names, emails);</span>
<a href="#l30.185"></a><span id="l30.185"> }</span>
<a href="#l30.186"></a><span id="l30.186"> </span>
<a href="#l30.187"></a><span id="l30.187"> void ExtractEmail(const nsCOMArray&lt;msgIAddressObject&gt; &amp;aHeader,</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineminus">-                  nsACString &amp;email)</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineminus">-{</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineplus">+                  nsACString &amp;email) {</span>
<a href="#l30.191"></a><span id="l30.191">   AutoTArray&lt;nsString, 1&gt; names;</span>
<a href="#l30.192"></a><span id="l30.192">   AutoTArray&lt;nsString, 1&gt; emails;</span>
<a href="#l30.193"></a><span id="l30.193">   ExtractAllAddresses(aHeader, names, emails);</span>
<a href="#l30.194"></a><span id="l30.194"> </span>
<a href="#l30.195"></a><span id="l30.195">   if (emails.Length() &gt; 0)</span>
<a href="#l30.196"></a><span id="l30.196">     CopyUTF16toUTF8(emails[0], email);</span>
<a href="#l30.197"></a><span id="l30.197">   else</span>
<a href="#l30.198"></a><span id="l30.198">     email.Truncate();</span>
<a href="#l30.199"></a><span id="l30.199"> }</span>
<a href="#l30.200"></a><span id="l30.200"> </span>
<a href="#l30.201"></a><span id="l30.201"> void ExtractFirstAddress(const nsCOMArray&lt;msgIAddressObject&gt; &amp;aHeader,</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineminus">-                         nsACString &amp;name, nsACString &amp;email)</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineminus">-{</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineplus">+                         nsACString &amp;name, nsACString &amp;email) {</span>
<a href="#l30.205"></a><span id="l30.205">   AutoTArray&lt;nsString, 1&gt; names, emails;</span>
<a href="#l30.206"></a><span id="l30.206">   ExtractAllAddresses(aHeader, names, emails);</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineminus">-  if (names.Length() &gt; 0)</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineminus">-  {</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineplus">+  if (names.Length() &gt; 0) {</span>
<a href="#l30.210"></a><span id="l30.210">     CopyUTF16toUTF8(names[0], name);</span>
<a href="#l30.211"></a><span id="l30.211">     CopyUTF16toUTF8(emails[0], email);</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineminus">-  }</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineminus">-  else</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineminus">-  {</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineplus">+  } else {</span>
<a href="#l30.216"></a><span id="l30.216">     name.Truncate();</span>
<a href="#l30.217"></a><span id="l30.217">     email.Truncate();</span>
<a href="#l30.218"></a><span id="l30.218">   }</span>
<a href="#l30.219"></a><span id="l30.219"> }</span>
<a href="#l30.220"></a><span id="l30.220"> </span>
<a href="#l30.221"></a><span id="l30.221"> void ExtractFirstAddress(const nsCOMArray&lt;msgIAddressObject&gt; &amp;aHeader,</span>
<a href="#l30.222"></a><span id="l30.222" class="difflineminus">-                         nsAString &amp;name, nsACString &amp;email)</span>
<a href="#l30.223"></a><span id="l30.223" class="difflineminus">-{</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineplus">+                         nsAString &amp;name, nsACString &amp;email) {</span>
<a href="#l30.225"></a><span id="l30.225">   AutoTArray&lt;nsString, 1&gt; names, emails;</span>
<a href="#l30.226"></a><span id="l30.226">   ExtractAllAddresses(aHeader, names, emails);</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineminus">-  if (names.Length() &gt; 0)</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineminus">-  {</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineplus">+  if (names.Length() &gt; 0) {</span>
<a href="#l30.230"></a><span id="l30.230">     name = names[0];</span>
<a href="#l30.231"></a><span id="l30.231">     CopyUTF16toUTF8(emails[0], email);</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineminus">-  }</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineminus">-  else</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineminus">-  {</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineplus">+  } else {</span>
<a href="#l30.236"></a><span id="l30.236">     name.Truncate();</span>
<a href="#l30.237"></a><span id="l30.237">     email.Truncate();</span>
<a href="#l30.238"></a><span id="l30.238">   }</span>
<a href="#l30.239"></a><span id="l30.239"> }</span>
<a href="#l30.240"></a><span id="l30.240"> </span>
<a href="#l30.241"></a><span id="l30.241" class="difflineminus">-void ExtractName(const nsCOMArray&lt;msgIAddressObject&gt; &amp;aHeader, nsACString &amp;name)</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineminus">-{</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineplus">+void ExtractName(const nsCOMArray&lt;msgIAddressObject&gt; &amp;aHeader,</span>
<a href="#l30.244"></a><span id="l30.244" class="difflineplus">+                 nsACString &amp;name) {</span>
<a href="#l30.245"></a><span id="l30.245">   nsCString email;</span>
<a href="#l30.246"></a><span id="l30.246">   ExtractFirstAddress(aHeader, name, email);</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineminus">-  if (name.IsEmpty())</span>
<a href="#l30.248"></a><span id="l30.248" class="difflineminus">-    name = email;</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineplus">+  if (name.IsEmpty()) name = email;</span>
<a href="#l30.250"></a><span id="l30.250"> }</span>
<a href="#l30.251"></a><span id="l30.251"> </span>
<a href="#l30.252"></a><span id="l30.252" class="difflineminus">-void ExtractName(const nsCOMArray&lt;msgIAddressObject&gt; &amp;aHeader, nsAString &amp;name)</span>
<a href="#l30.253"></a><span id="l30.253" class="difflineminus">-{</span>
<a href="#l30.254"></a><span id="l30.254" class="difflineplus">+void ExtractName(const nsCOMArray&lt;msgIAddressObject&gt; &amp;aHeader,</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineplus">+                 nsAString &amp;name) {</span>
<a href="#l30.256"></a><span id="l30.256">   AutoTArray&lt;nsString, 1&gt; names;</span>
<a href="#l30.257"></a><span id="l30.257">   AutoTArray&lt;nsString, 1&gt; emails;</span>
<a href="#l30.258"></a><span id="l30.258">   ExtractAllAddresses(aHeader, names, emails);</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineminus">-  if (names.Length() &gt; 0)</span>
<a href="#l30.260"></a><span id="l30.260" class="difflineminus">-  {</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineplus">+  if (names.Length() &gt; 0) {</span>
<a href="#l30.262"></a><span id="l30.262">     if (names[0].IsEmpty())</span>
<a href="#l30.263"></a><span id="l30.263">       name = emails[0];</span>
<a href="#l30.264"></a><span id="l30.264">     else</span>
<a href="#l30.265"></a><span id="l30.265">       name = names[0];</span>
<a href="#l30.266"></a><span id="l30.266" class="difflineminus">-  }</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineminus">-  else</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineminus">-  {</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineplus">+  } else {</span>
<a href="#l30.270"></a><span id="l30.270">     name.Truncate();</span>
<a href="#l30.271"></a><span id="l30.271">   }</span>
<a href="#l30.272"></a><span id="l30.272"> }</span>
<a href="#l30.273"></a><span id="l30.273"> </span>
<a href="#l30.274"></a><span id="l30.274" class="difflineminus">-} // namespace mailnews</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineminus">-} // namespace mozilla</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineplus">+}  // namespace mailnews</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineplus">+}  // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/mime/src/comi18n.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/mime/src/comi18n.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -16,58 +16,53 @@</span>
<a href="#l31.4"></a><span id="l31.4"> #include &quot;mozilla/Preferences.h&quot;</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6"> using namespace mozilla;</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.9"></a><span id="l31.9"> // BEGIN PUBLIC INTERFACE</span>
<a href="#l31.10"></a><span id="l31.10"> extern &quot;C&quot; {</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-</span>
<a href="#l31.13"></a><span id="l31.13"> void MIME_DecodeMimeHeader(const char *header, const char *default_charset,</span>
<a href="#l31.14"></a><span id="l31.14">                            bool override_charset, bool eatContinuations,</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-                           nsACString &amp;result)</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-{</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+                           nsACString &amp;result) {</span>
<a href="#l31.18"></a><span id="l31.18">   nsresult rv;</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-  nsCOMPtr &lt;nsIMimeConverter&gt; mimeConverter =</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineminus">-    do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+  nsCOMPtr&lt;nsIMimeConverter&gt; mimeConverter =</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+      do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l31.23"></a><span id="l31.23">   if (NS_FAILED(rv)) {</span>
<a href="#l31.24"></a><span id="l31.24">     result.Truncate();</span>
<a href="#l31.25"></a><span id="l31.25">     return;</span>
<a href="#l31.26"></a><span id="l31.26">   }</span>
<a href="#l31.27"></a><span id="l31.27">   mimeConverter-&gt;DecodeMimeHeaderToUTF8(nsDependentCString(header),</span>
<a href="#l31.28"></a><span id="l31.28">                                         default_charset, override_charset,</span>
<a href="#l31.29"></a><span id="l31.29">                                         eatContinuations, result);</span>
<a href="#l31.30"></a><span id="l31.30"> }</span>
<a href="#l31.31"></a><span id="l31.31"> </span>
<a href="#l31.32"></a><span id="l31.32"> // UTF-8 utility functions.</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-//detect charset soly based on aBuf. return in aCharset</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-class CharsetDetectionObserver : public nsICharsetDetectionObserver</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-{</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineminus">-public:</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+// detect charset soly based on aBuf. return in aCharset</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+class CharsetDetectionObserver : public nsICharsetDetectionObserver {</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+ public:</span>
<a href="#l31.40"></a><span id="l31.40">   NS_DECL_ISUPPORTS</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineminus">-  CharsetDetectionObserver() {};</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineminus">-  NS_IMETHOD Notify(const char* aCharset, nsDetectionConfident aConf) override</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineminus">-  {</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+  CharsetDetectionObserver(){};</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+  NS_IMETHOD Notify(const char *aCharset, nsDetectionConfident aConf) override {</span>
<a href="#l31.46"></a><span id="l31.46">     mCharset.AssignASCII(aCharset);</span>
<a href="#l31.47"></a><span id="l31.47">     mConf = aConf;</span>
<a href="#l31.48"></a><span id="l31.48">     return NS_OK;</span>
<a href="#l31.49"></a><span id="l31.49">   };</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineminus">-  void GetDetectedCharset(nsACString&amp; aCharset) { aCharset = mCharset; }</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+  void GetDetectedCharset(nsACString &amp;aCharset) { aCharset = mCharset; }</span>
<a href="#l31.52"></a><span id="l31.52">   nsDetectionConfident GetDetectionConfident() { return mConf; }</span>
<a href="#l31.53"></a><span id="l31.53"> </span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-private:</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineplus">+ private:</span>
<a href="#l31.56"></a><span id="l31.56">   virtual ~CharsetDetectionObserver() {}</span>
<a href="#l31.57"></a><span id="l31.57">   nsCString mCharset;</span>
<a href="#l31.58"></a><span id="l31.58">   nsDetectionConfident mConf;</span>
<a href="#l31.59"></a><span id="l31.59"> };</span>
<a href="#l31.60"></a><span id="l31.60"> </span>
<a href="#l31.61"></a><span id="l31.61" class="difflineminus">-nsresult</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-MIME_detect_charset(const char *aBuf, int32_t aLength, nsACString&amp; aCharset)</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-{</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+nsresult MIME_detect_charset(const char *aBuf, int32_t aLength,</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineplus">+                             nsACString &amp;aCharset) {</span>
<a href="#l31.66"></a><span id="l31.66">   nsresult rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l31.67"></a><span id="l31.67">   nsCOMPtr&lt;nsICharsetDetector&gt; detector;</span>
<a href="#l31.68"></a><span id="l31.68">   nsAutoCString detectorName;</span>
<a href="#l31.69"></a><span id="l31.69">   Preferences::GetLocalizedCString(&quot;intl.charset.detector&quot;, detectorName);</span>
<a href="#l31.70"></a><span id="l31.70"> </span>
<a href="#l31.71"></a><span id="l31.71">   if (!detectorName.IsEmpty()) {</span>
<a href="#l31.72"></a><span id="l31.72">     // We recognize one of the three magic strings for the following languages.</span>
<a href="#l31.73"></a><span id="l31.73">     if (detectorName.EqualsLiteral(&quot;ruprob&quot;)) {</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineat">@@ -103,9 +98,8 @@ MIME_detect_charset(const char *aBuf, in</span>
<a href="#l31.75"></a><span id="l31.75">       }</span>
<a href="#l31.76"></a><span id="l31.76">     }</span>
<a href="#l31.77"></a><span id="l31.77">   }</span>
<a href="#l31.78"></a><span id="l31.78">   return rv;</span>
<a href="#l31.79"></a><span id="l31.79"> }</span>
<a href="#l31.80"></a><span id="l31.80"> </span>
<a href="#l31.81"></a><span id="l31.81"> } /* end of extern &quot;C&quot; */</span>
<a href="#l31.82"></a><span id="l31.82"> // END PUBLIC INTERFACE</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/mime/src/comi18n.h</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/mime/src/comi18n.h</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -13,25 +13,27 @@ extern &quot;C&quot; {</span>
<a href="#l32.4"></a><span id="l32.4"> #endif /* __cplusplus */</span>
<a href="#l32.5"></a><span id="l32.5"> </span>
<a href="#l32.6"></a><span id="l32.6"> /**</span>
<a href="#l32.7"></a><span id="l32.7">  * Decode MIME header to UTF-8.</span>
<a href="#l32.8"></a><span id="l32.8">  * Uses MIME_ConvertCharset if the decoded string needs a conversion.</span>
<a href="#l32.9"></a><span id="l32.9">  *</span>
<a href="#l32.10"></a><span id="l32.10">  *</span>
<a href="#l32.11"></a><span id="l32.11">  * @param header      [IN] A header to decode.</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">- * @param default_charset     [IN] Default charset to apply to ulabeled non-UTF-8 8bit data</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">- * @param override_charset    [IN] If true, default_charset used instead of any charset labeling other than UTF-8</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+ * @param default_charset     [IN] Default charset to apply to ulabeled</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+ * non-UTF-8 8bit data</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+ * @param override_charset    [IN] If true, default_charset used instead of any</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+ * charset labeling other than UTF-8</span>
<a href="#l32.18"></a><span id="l32.18">  * @param eatContinuations    [IN] If true, unfold headers</span>
<a href="#l32.19"></a><span id="l32.19">  * @param result      [OUT] Decoded buffer</span>
<a href="#l32.20"></a><span id="l32.20">  */</span>
<a href="#l32.21"></a><span id="l32.21"> void MIME_DecodeMimeHeader(const char *header, const char *default_charset,</span>
<a href="#l32.22"></a><span id="l32.22">                            bool override_charset, bool eatContinuations,</span>
<a href="#l32.23"></a><span id="l32.23">                            nsACString &amp;result);</span>
<a href="#l32.24"></a><span id="l32.24"> </span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">-nsresult MIME_detect_charset(const char *aBuf, int32_t aLength, nsACString&amp; aCharset);</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+nsresult MIME_detect_charset(const char *aBuf, int32_t aLength,</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+                             nsACString &amp;aCharset);</span>
<a href="#l32.28"></a><span id="l32.28"> </span>
<a href="#l32.29"></a><span id="l32.29"> #ifdef __cplusplus</span>
<a href="#l32.30"></a><span id="l32.30"> } /* extern &quot;C&quot; */</span>
<a href="#l32.31"></a><span id="l32.31"> #endif /* __cplusplus */</span>
<a href="#l32.32"></a><span id="l32.32"> </span>
<a href="#l32.33"></a><span id="l32.33" class="difflineminus">-#endif // _COMI18N_LOADED_H_</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineminus">-</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+#endif  // _COMI18N_LOADED_H_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/mime/src/mimeTextHTMLParsed.cpp</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/mime/src/mimeTextHTMLParsed.cpp</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -1,26 +1,28 @@</span>
<a href="#l33.4"></a><span id="l33.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l33.5"></a><span id="l33.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.6"></a><span id="l33.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.7"></a><span id="l33.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9" class="difflineminus">-/* Most of this code is copied from mimethsa. If you find a bug here, check that class, too. */</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineplus">+/* Most of this code is copied from mimethsa. If you find a bug here, check that</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+ * class, too. */</span>
<a href="#l33.12"></a><span id="l33.12"> </span>
<a href="#l33.13"></a><span id="l33.13"> /* This runs the entire HTML document through the Mozilla HTML parser, and</span>
<a href="#l33.14"></a><span id="l33.14">    then outputs it as string again. This ensures that the HTML document is</span>
<a href="#l33.15"></a><span id="l33.15">    syntactically correct and complete and all tags and attributes are closed.</span>
<a href="#l33.16"></a><span id="l33.16"> </span>
<a href="#l33.17"></a><span id="l33.17">    That prevents &quot;MIME in the middle&quot; attacks like efail.de.</span>
<a href="#l33.18"></a><span id="l33.18">    The base problem is that we concatenate different MIME parts in the output</span>
<a href="#l33.19"></a><span id="l33.19">    and render them all together as a single HTML document in the display.</span>
<a href="#l33.20"></a><span id="l33.20"> </span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-   The better solution would be to put each MIME part into its own &lt;iframe type=&quot;content&quot;&gt;.</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-   during rendering. Unfortunately, we'd need &lt;iframe seamless&gt; for that.</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">-   That would remove the need for this workaround, and stop even more attack classes.</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+   The better solution would be to put each MIME part into its own &lt;iframe</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+   type=&quot;content&quot;&gt;. during rendering. Unfortunately, we'd need &lt;iframe seamless&gt;</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+   for that. That would remove the need for this workaround, and stop even more</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+   attack classes.</span>
<a href="#l33.28"></a><span id="l33.28"> */</span>
<a href="#l33.29"></a><span id="l33.29"> </span>
<a href="#l33.30"></a><span id="l33.30"> #include &quot;mimeTextHTMLParsed.h&quot;</span>
<a href="#l33.31"></a><span id="l33.31"> #include &quot;prmem.h&quot;</span>
<a href="#l33.32"></a><span id="l33.32"> #include &quot;prlog.h&quot;</span>
<a href="#l33.33"></a><span id="l33.33"> #include &quot;msgCore.h&quot;</span>
<a href="#l33.34"></a><span id="l33.34"> #include &quot;mozilla/dom/DOMParser.h&quot;</span>
<a href="#l33.35"></a><span id="l33.35"> #include &quot;mozilla/dom/Document.h&quot;</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineat">@@ -33,118 +35,100 @@ MimeDefClass(MimeInlineTextHTMLParsed, M</span>
<a href="#l33.37"></a><span id="l33.37">              mimeInlineTextHTMLParsedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l33.38"></a><span id="l33.38"> </span>
<a href="#l33.39"></a><span id="l33.39"> static int MimeInlineTextHTMLParsed_parse_line(const char *, int32_t,</span>
<a href="#l33.40"></a><span id="l33.40">                                                MimeObject *);</span>
<a href="#l33.41"></a><span id="l33.41"> static int MimeInlineTextHTMLParsed_parse_begin(MimeObject *obj);</span>
<a href="#l33.42"></a><span id="l33.42"> static int MimeInlineTextHTMLParsed_parse_eof(MimeObject *, bool);</span>
<a href="#l33.43"></a><span id="l33.43"> static void MimeInlineTextHTMLParsed_finalize(MimeObject *obj);</span>
<a href="#l33.44"></a><span id="l33.44"> </span>
<a href="#l33.45"></a><span id="l33.45" class="difflineminus">-static int</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineminus">-MimeInlineTextHTMLParsedClassInitialize(MimeInlineTextHTMLParsedClass *clazz)</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineminus">-{</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+static int MimeInlineTextHTMLParsedClassInitialize(</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+    MimeInlineTextHTMLParsedClass *clazz) {</span>
<a href="#l33.50"></a><span id="l33.50">   MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l33.51"></a><span id="l33.51">   NS_ASSERTION(!oclass-&gt;class_initialized, &quot;problem with superclass&quot;);</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineminus">-  oclass-&gt;parse_line  = MimeInlineTextHTMLParsed_parse_line;</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+  oclass-&gt;parse_line = MimeInlineTextHTMLParsed_parse_line;</span>
<a href="#l33.54"></a><span id="l33.54">   oclass-&gt;parse_begin = MimeInlineTextHTMLParsed_parse_begin;</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineminus">-  oclass-&gt;parse_eof   = MimeInlineTextHTMLParsed_parse_eof;</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineminus">-  oclass-&gt;finalize    = MimeInlineTextHTMLParsed_finalize;</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+  oclass-&gt;parse_eof = MimeInlineTextHTMLParsed_parse_eof;</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+  oclass-&gt;finalize = MimeInlineTextHTMLParsed_finalize;</span>
<a href="#l33.59"></a><span id="l33.59"> </span>
<a href="#l33.60"></a><span id="l33.60">   return 0;</span>
<a href="#l33.61"></a><span id="l33.61"> }</span>
<a href="#l33.62"></a><span id="l33.62"> </span>
<a href="#l33.63"></a><span id="l33.63" class="difflineminus">-static int</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineminus">-MimeInlineTextHTMLParsed_parse_begin(MimeObject *obj)</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineminus">-{</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+static int MimeInlineTextHTMLParsed_parse_begin(MimeObject *obj) {</span>
<a href="#l33.67"></a><span id="l33.67">   MimeInlineTextHTMLParsed *me = (MimeInlineTextHTMLParsed *)obj;</span>
<a href="#l33.68"></a><span id="l33.68">   me-&gt;complete_buffer = new nsString();</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineminus">-  int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineminus">-    return status;</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+  int status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l33.74"></a><span id="l33.74"> </span>
<a href="#l33.75"></a><span id="l33.75">   return 0;</span>
<a href="#l33.76"></a><span id="l33.76"> }</span>
<a href="#l33.77"></a><span id="l33.77"> </span>
<a href="#l33.78"></a><span id="l33.78" class="difflineminus">-static int</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineminus">-MimeInlineTextHTMLParsed_parse_eof(MimeObject *obj, bool abort_p)</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineminus">-{</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineminus">-</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineminus">-  if (obj-&gt;closed_p)</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineminus">-    return 0;</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineminus">-  int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineminus">-    return status;</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+static int MimeInlineTextHTMLParsed_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+  if (obj-&gt;closed_p) return 0;</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+  int status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l33.91"></a><span id="l33.91">   MimeInlineTextHTMLParsed *me = (MimeInlineTextHTMLParsed *)obj;</span>
<a href="#l33.92"></a><span id="l33.92"> </span>
<a href="#l33.93"></a><span id="l33.93">   // We have to cache all lines and parse the whole document at once.</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineminus">-  // There's a useful sounding function parseFromStream(), but it only allows XML</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineminus">-  // mimetypes, not HTML. Methinks that's because the HTML soup parser</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineminus">-  // needs the entire doc to make sense of the gibberish that people write.</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineminus">-  if (!me || !me-&gt;complete_buffer)</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineminus">-    return 0;</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+  // There's a useful sounding function parseFromStream(), but it only allows</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+  // XML mimetypes, not HTML. Methinks that's because the HTML soup parser needs</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+  // the entire doc to make sense of the gibberish that people write.</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+  if (!me || !me-&gt;complete_buffer) return 0;</span>
<a href="#l33.103"></a><span id="l33.103"> </span>
<a href="#l33.104"></a><span id="l33.104" class="difflineminus">-  nsString&amp; rawHTML = *(me-&gt;complete_buffer);</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineminus">-  if (rawHTML.IsEmpty())</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineminus">-    return 0;</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+  nsString &amp;rawHTML = *(me-&gt;complete_buffer);</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineplus">+  if (rawHTML.IsEmpty()) return 0;</span>
<a href="#l33.109"></a><span id="l33.109">   nsString parsed;</span>
<a href="#l33.110"></a><span id="l33.110">   nsresult rv;</span>
<a href="#l33.111"></a><span id="l33.111"> </span>
<a href="#l33.112"></a><span id="l33.112">   // Parse the HTML source.</span>
<a href="#l33.113"></a><span id="l33.113">   mozilla::ErrorResult rv2;</span>
<a href="#l33.114"></a><span id="l33.114">   RefPtr&lt;mozilla::dom::DOMParser&gt; parser =</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineminus">-    mozilla::dom::DOMParser::CreateWithoutGlobal(rv2);</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineplus">+      mozilla::dom::DOMParser::CreateWithoutGlobal(rv2);</span>
<a href="#l33.117"></a><span id="l33.117">   nsCOMPtr&lt;mozilla::dom::Document&gt; document = parser-&gt;ParseFromString(</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineminus">-    rawHTML, mozilla::dom::SupportedType::Text_html, rv2);</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineminus">-  if (rv2.Failed())</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineminus">-    return -1;</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineplus">+      rawHTML, mozilla::dom::SupportedType::Text_html, rv2);</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineplus">+  if (rv2.Failed()) return -1;</span>
<a href="#l33.123"></a><span id="l33.123"> </span>
<a href="#l33.124"></a><span id="l33.124">   // Serialize it back to HTML source again.</span>
<a href="#l33.125"></a><span id="l33.125">   nsCOMPtr&lt;nsIDocumentEncoder&gt; encoder = do_createDocumentEncoder(&quot;text/html&quot;);</span>
<a href="#l33.126"></a><span id="l33.126">   NS_ENSURE_TRUE(encoder, -1);</span>
<a href="#l33.127"></a><span id="l33.127">   uint32_t aFlags = nsIDocumentEncoder::OutputRaw |</span>
<a href="#l33.128"></a><span id="l33.128">                     nsIDocumentEncoder::OutputDisallowLineBreaking;</span>
<a href="#l33.129"></a><span id="l33.129">   rv = encoder-&gt;Init(document, NS_LITERAL_STRING(&quot;text/html&quot;), aFlags);</span>
<a href="#l33.130"></a><span id="l33.130">   NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l33.131"></a><span id="l33.131">   rv = encoder-&gt;EncodeToString(parsed);</span>
<a href="#l33.132"></a><span id="l33.132">   NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l33.133"></a><span id="l33.133"> </span>
<a href="#l33.134"></a><span id="l33.134">   // Write it out.</span>
<a href="#l33.135"></a><span id="l33.135">   NS_ConvertUTF16toUTF8 resultCStr(parsed);</span>
<a href="#l33.136"></a><span id="l33.136">   MimeInlineTextHTML_insert_lang_div(obj, resultCStr);</span>
<a href="#l33.137"></a><span id="l33.137">   MimeInlineTextHTML_remove_plaintext_tag(obj, resultCStr);</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_line(</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineminus">-    resultCStr.BeginWriting(), resultCStr.Length(), obj);</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineplus">+  status =</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineplus">+      ((MimeObjectClass *)&amp;MIME_SUPERCLASS)</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineplus">+          -&gt;parse_line(resultCStr.BeginWriting(), resultCStr.Length(), obj);</span>
<a href="#l33.143"></a><span id="l33.143">   rawHTML.Truncate();</span>
<a href="#l33.144"></a><span id="l33.144">   return status;</span>
<a href="#l33.145"></a><span id="l33.145"> }</span>
<a href="#l33.146"></a><span id="l33.146"> </span>
<a href="#l33.147"></a><span id="l33.147" class="difflineminus">-void</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineminus">-MimeInlineTextHTMLParsed_finalize(MimeObject *obj)</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineminus">-{</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineplus">+void MimeInlineTextHTMLParsed_finalize(MimeObject *obj) {</span>
<a href="#l33.151"></a><span id="l33.151">   MimeInlineTextHTMLParsed *me = (MimeInlineTextHTMLParsed *)obj;</span>
<a href="#l33.152"></a><span id="l33.152"> </span>
<a href="#l33.153"></a><span id="l33.153" class="difflineminus">-  if (me &amp;&amp; me-&gt;complete_buffer)</span>
<a href="#l33.154"></a><span id="l33.154" class="difflineminus">-  {</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineplus">+  if (me &amp;&amp; me-&gt;complete_buffer) {</span>
<a href="#l33.156"></a><span id="l33.156">     obj-&gt;clazz-&gt;parse_eof(obj, false);</span>
<a href="#l33.157"></a><span id="l33.157">     delete me-&gt;complete_buffer;</span>
<a href="#l33.158"></a><span id="l33.158">     me-&gt;complete_buffer = NULL;</span>
<a href="#l33.159"></a><span id="l33.159">   }</span>
<a href="#l33.160"></a><span id="l33.160"> </span>
<a href="#l33.161"></a><span id="l33.161" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l33.162"></a><span id="l33.162" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l33.163"></a><span id="l33.163"> }</span>
<a href="#l33.164"></a><span id="l33.164"> </span>
<a href="#l33.165"></a><span id="l33.165" class="difflineminus">-static int</span>
<a href="#l33.166"></a><span id="l33.166" class="difflineminus">-MimeInlineTextHTMLParsed_parse_line(const char *line, int32_t length,</span>
<a href="#l33.167"></a><span id="l33.167" class="difflineminus">-                                    MimeObject *obj)</span>
<a href="#l33.168"></a><span id="l33.168" class="difflineminus">-{</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineplus">+static int MimeInlineTextHTMLParsed_parse_line(const char *line, int32_t length,</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineplus">+                                               MimeObject *obj) {</span>
<a href="#l33.171"></a><span id="l33.171">   MimeInlineTextHTMLParsed *me = (MimeInlineTextHTMLParsed *)obj;</span>
<a href="#l33.172"></a><span id="l33.172"> </span>
<a href="#l33.173"></a><span id="l33.173" class="difflineminus">-  if (!me || !(me-&gt;complete_buffer))</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineminus">-    return -1;</span>
<a href="#l33.175"></a><span id="l33.175" class="difflineplus">+  if (!me || !(me-&gt;complete_buffer)) return -1;</span>
<a href="#l33.176"></a><span id="l33.176"> </span>
<a href="#l33.177"></a><span id="l33.177">   nsCString linestr(line, length);</span>
<a href="#l33.178"></a><span id="l33.178">   NS_ConvertUTF8toUTF16 line_ucs2(linestr.get());</span>
<a href="#l33.179"></a><span id="l33.179" class="difflineminus">-  if (length &amp;&amp; line_ucs2.IsEmpty())</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineminus">-    CopyASCIItoUTF16(linestr, line_ucs2);</span>
<a href="#l33.181"></a><span id="l33.181" class="difflineplus">+  if (length &amp;&amp; line_ucs2.IsEmpty()) CopyASCIItoUTF16(linestr, line_ucs2);</span>
<a href="#l33.182"></a><span id="l33.182">   (me-&gt;complete_buffer)-&gt;Append(line_ucs2);</span>
<a href="#l33.183"></a><span id="l33.183"> </span>
<a href="#l33.184"></a><span id="l33.184">   return 0;</span>
<a href="#l33.185"></a><span id="l33.185"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/mime/src/mimeTextHTMLParsed.h</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/mime/src/mimeTextHTMLParsed.h</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -4,25 +4,25 @@</span>
<a href="#l34.4"></a><span id="l34.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.5"></a><span id="l34.5"> </span>
<a href="#l34.6"></a><span id="l34.6"> #ifndef _MIMETEXTHTMLPARSED_H_</span>
<a href="#l34.7"></a><span id="l34.7"> #define _MIMETEXTHTMLPARSED_H_</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9"> #include &quot;mimethtm.h&quot;</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11"> typedef struct MimeInlineTextHTMLParsedClass MimeInlineTextHTMLParsedClass;</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-typedef struct MimeInlineTextHTMLParsed      MimeInlineTextHTMLParsed;</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+typedef struct MimeInlineTextHTMLParsed MimeInlineTextHTMLParsed;</span>
<a href="#l34.14"></a><span id="l34.14"> </span>
<a href="#l34.15"></a><span id="l34.15"> struct MimeInlineTextHTMLParsedClass {</span>
<a href="#l34.16"></a><span id="l34.16">   MimeInlineTextHTMLClass html;</span>
<a href="#l34.17"></a><span id="l34.17"> };</span>
<a href="#l34.18"></a><span id="l34.18"> </span>
<a href="#l34.19"></a><span id="l34.19"> extern MimeInlineTextHTMLParsedClass mimeInlineTextHTMLParsedClass;</span>
<a href="#l34.20"></a><span id="l34.20"> </span>
<a href="#l34.21"></a><span id="l34.21"> struct MimeInlineTextHTMLParsed {</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineminus">-  MimeInlineTextHTML    html;</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-  nsString             *complete_buffer;  // Gecko parser expects wide strings</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+  MimeInlineTextHTML html;</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+  nsString *complete_buffer;  // Gecko parser expects wide strings</span>
<a href="#l34.26"></a><span id="l34.26"> };</span>
<a href="#l34.27"></a><span id="l34.27"> </span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-#define MimeInlineTextHTMLParsedClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineminus">-  { MimeInlineTextHTMLClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+#define MimeInlineTextHTMLParsedClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+  { MimeInlineTextHTMLClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l34.32"></a><span id="l34.32"> </span>
<a href="#l34.33"></a><span id="l34.33"> #endif /* _MIMETEXTHTMLPARSED_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/mime/src/mimebuf.cpp</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/mime/src/mimebuf.cpp</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -1,249 +1,216 @@</span>
<a href="#l35.4"></a><span id="l35.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l35.5"></a><span id="l35.5">  *</span>
<a href="#l35.6"></a><span id="l35.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l35.7"></a><span id="l35.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l35.8"></a><span id="l35.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineminus">- * This Original Code has been modified by IBM Corporation. Modifications made by IBM</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineminus">- * described herein are Copyright (c) International Business Machines Corporation, 2000.</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineminus">- * Modifications to Mozilla code or documentation identified per MPL Section 3.3</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+ * This Original Code has been modified by IBM Corporation. Modifications made</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+ * by IBM described herein are Copyright (c) International Business Machines</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+ * Corporation, 2000. Modifications to Mozilla code or documentation identified</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+ * per MPL Section 3.3</span>
<a href="#l35.16"></a><span id="l35.16">  *</span>
<a href="#l35.17"></a><span id="l35.17">  * Date             Modified by     Description of modification</span>
<a href="#l35.18"></a><span id="l35.18">  * 04/20/2000       IBM Corp.      OS/2 VisualAge build.</span>
<a href="#l35.19"></a><span id="l35.19">  */</span>
<a href="#l35.20"></a><span id="l35.20"> /*</span>
<a href="#l35.21"></a><span id="l35.21">  * mimebuf.c -  libmsg like buffer handling routines for libmime</span>
<a href="#l35.22"></a><span id="l35.22">  */</span>
<a href="#l35.23"></a><span id="l35.23"> #include &quot;prmem.h&quot;</span>
<a href="#l35.24"></a><span id="l35.24"> #include &quot;plstr.h&quot;</span>
<a href="#l35.25"></a><span id="l35.25"> #include &quot;prlog.h&quot;</span>
<a href="#l35.26"></a><span id="l35.26"> #include &quot;msgCore.h&quot;</span>
<a href="#l35.27"></a><span id="l35.27"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l35.28"></a><span id="l35.28"> </span>
<a href="#l35.29"></a><span id="l35.29" class="difflineminus">-extern &quot;C&quot; int</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineminus">-mime_GrowBuffer (uint32_t desired_size, uint32_t element_size, uint32_t quantum,</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-        char **buffer, int32_t *size)</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-{</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-  if ((uint32_t) *size &lt;= desired_size)</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">-  {</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+extern &quot;C&quot; int mime_GrowBuffer(uint32_t desired_size, uint32_t element_size,</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+                               uint32_t quantum, char **buffer, int32_t *size) {</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+  if ((uint32_t)*size &lt;= desired_size) {</span>
<a href="#l35.38"></a><span id="l35.38">     char *new_buf;</span>
<a href="#l35.39"></a><span id="l35.39">     uint32_t increment = desired_size - *size;</span>
<a href="#l35.40"></a><span id="l35.40">     if (increment &lt; quantum) /* always grow by a minimum of N bytes */</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineminus">-    increment = quantum;</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+      increment = quantum;</span>
<a href="#l35.43"></a><span id="l35.43"> </span>
<a href="#l35.44"></a><span id="l35.44" class="difflineminus">-    new_buf = (*buffer</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineminus">-         ? (char *) PR_Realloc (*buffer, (*size + increment)</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineminus">-                    * (element_size / sizeof(char)))</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineminus">-         : (char *) PR_MALLOC ((*size + increment)</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineminus">-                    * (element_size / sizeof(char))));</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineminus">-    if (! new_buf)</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineminus">-      return MIME_OUT_OF_MEMORY;</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+    new_buf =</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+        (*buffer</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+             ? (char *)PR_Realloc(</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+                   *buffer, (*size + increment) * (element_size / sizeof(char)))</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineplus">+             : (char *)PR_MALLOC((*size + increment) *</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+                                 (element_size / sizeof(char))));</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineplus">+    if (!new_buf) return MIME_OUT_OF_MEMORY;</span>
<a href="#l35.58"></a><span id="l35.58">     *buffer = new_buf;</span>
<a href="#l35.59"></a><span id="l35.59">     *size += increment;</span>
<a href="#l35.60"></a><span id="l35.60">   }</span>
<a href="#l35.61"></a><span id="l35.61">   return 0;</span>
<a href="#l35.62"></a><span id="l35.62"> }</span>
<a href="#l35.63"></a><span id="l35.63"> </span>
<a href="#l35.64"></a><span id="l35.64"> /* The opposite of mime_LineBuffer(): takes small buffers and packs them</span>
<a href="#l35.65"></a><span id="l35.65">    up into bigger buffers before passing them along.</span>
<a href="#l35.66"></a><span id="l35.66"> </span>
<a href="#l35.67"></a><span id="l35.67">    Pass in a desired_buffer_size 0 to tell it to flush (for example, in</span>
<a href="#l35.68"></a><span id="l35.68">    in the very last call to this function.)</span>
<a href="#l35.69"></a><span id="l35.69">  */</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineminus">-extern &quot;C&quot; int</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineminus">-mime_ReBuffer (const char *net_buffer, int32_t net_buffer_size,</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineminus">-        uint32_t desired_buffer_size,</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineminus">-        char **bufferP, int32_t *buffer_sizeP, uint32_t *buffer_fpP,</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineminus">-        int32_t (*per_buffer_fn) (char *buffer, uint32_t buffer_size,</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineminus">-                    void *closure),</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineminus">-        void *closure)</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineminus">-{</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+extern &quot;C&quot; int mime_ReBuffer(const char *net_buffer, int32_t net_buffer_size,</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+                             uint32_t desired_buffer_size, char **bufferP,</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+                             int32_t *buffer_sizeP, uint32_t *buffer_fpP,</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+                             int32_t (*per_buffer_fn)(char *buffer,</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+                                                      uint32_t buffer_size,</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+                                                      void *closure),</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+                             void *closure) {</span>
<a href="#l35.85"></a><span id="l35.85">   int status = 0;</span>
<a href="#l35.86"></a><span id="l35.86"> </span>
<a href="#l35.87"></a><span id="l35.87" class="difflineminus">-  if (desired_buffer_size &gt;= (uint32_t) (*buffer_sizeP))</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineminus">-  {</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineminus">-    status = mime_GrowBuffer (desired_buffer_size, sizeof(char), 1024,</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineminus">-                 bufferP, buffer_sizeP);</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+  if (desired_buffer_size &gt;= (uint32_t)(*buffer_sizeP)) {</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+    status = mime_GrowBuffer(desired_buffer_size, sizeof(char), 1024, bufferP,</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineplus">+                             buffer_sizeP);</span>
<a href="#l35.94"></a><span id="l35.94">     if (status &lt; 0) return status;</span>
<a href="#l35.95"></a><span id="l35.95">   }</span>
<a href="#l35.96"></a><span id="l35.96"> </span>
<a href="#l35.97"></a><span id="l35.97" class="difflineminus">-  do</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineminus">-  {</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineplus">+  do {</span>
<a href="#l35.100"></a><span id="l35.100">     int32_t size = *buffer_sizeP - *buffer_fpP;</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineminus">-    if (size &gt; net_buffer_size)</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineminus">-    size = net_buffer_size;</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineminus">-    if (size &gt; 0)</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineminus">-    {</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineminus">-      memcpy ((*bufferP) + (*buffer_fpP), net_buffer, size);</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+    if (size &gt; net_buffer_size) size = net_buffer_size;</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+    if (size &gt; 0) {</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+      memcpy((*bufferP) + (*buffer_fpP), net_buffer, size);</span>
<a href="#l35.109"></a><span id="l35.109">       (*buffer_fpP) += size;</span>
<a href="#l35.110"></a><span id="l35.110">       net_buffer += size;</span>
<a href="#l35.111"></a><span id="l35.111">       net_buffer_size -= size;</span>
<a href="#l35.112"></a><span id="l35.112">     }</span>
<a href="#l35.113"></a><span id="l35.113"> </span>
<a href="#l35.114"></a><span id="l35.114" class="difflineminus">-    if (*buffer_fpP &gt; 0 &amp;&amp;</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineminus">-      *buffer_fpP &gt;= desired_buffer_size)</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineminus">-    {</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineminus">-      status = (*per_buffer_fn) ((*bufferP), (*buffer_fpP), closure);</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+    if (*buffer_fpP &gt; 0 &amp;&amp; *buffer_fpP &gt;= desired_buffer_size) {</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+      status = (*per_buffer_fn)((*bufferP), (*buffer_fpP), closure);</span>
<a href="#l35.120"></a><span id="l35.120">       *buffer_fpP = 0;</span>
<a href="#l35.121"></a><span id="l35.121">       if (status &lt; 0) return status;</span>
<a href="#l35.122"></a><span id="l35.122">     }</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineminus">-  }</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineminus">-  while (net_buffer_size &gt; 0);</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+  } while (net_buffer_size &gt; 0);</span>
<a href="#l35.126"></a><span id="l35.126"> </span>
<a href="#l35.127"></a><span id="l35.127">   return 0;</span>
<a href="#l35.128"></a><span id="l35.128"> }</span>
<a href="#l35.129"></a><span id="l35.129"> </span>
<a href="#l35.130"></a><span id="l35.130" class="difflineminus">-static int</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineminus">-convert_and_send_buffer(char* buf, int length, bool convert_newlines_p,</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineminus">-              int32_t (* per_line_fn) (char *line,</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineminus">-                          uint32_t line_length,</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineminus">-                          void *closure),</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineminus">-              void *closure)</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineminus">-{</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+static int convert_and_send_buffer(</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+    char *buf, int length, bool convert_newlines_p,</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+    int32_t (*per_line_fn)(char *line, uint32_t line_length, void *closure),</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+    void *closure) {</span>
<a href="#l35.141"></a><span id="l35.141">   /* Convert the line terminator to the native form.</span>
<a href="#l35.142"></a><span id="l35.142">    */</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineminus">-  char* newline;</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineplus">+  char *newline;</span>
<a href="#l35.145"></a><span id="l35.145"> </span>
<a href="#l35.146"></a><span id="l35.146"> #if (MSG_LINEBREAK_LEN == 2)</span>
<a href="#l35.147"></a><span id="l35.147">   /***</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineminus">-  * This is a patch to support a mail DB corruption cause by earlier version that lead to a crash.</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineminus">-  * What happened is that the line terminator is CR+NULL+LF. Therefore, we first process a line</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineminus">-  * terminated by CR then a second line that contains only NULL+LF. We need to ignore this second</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineminus">-  * line. See bug http://bugzilla.mozilla.org/show_bug.cgi?id=61412 for more information.</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineminus">-  ***/</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineminus">-  if (length == 2 &amp;&amp; buf[0] == 0x00 &amp;&amp; buf[1] == '\n')</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineminus">-    return 0;</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+   * This is a patch to support a mail DB corruption cause by earlier version</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+   *that lead to a crash. What happened is that the line terminator is</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+   *CR+NULL+LF. Therefore, we first process a line terminated by CR then a</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+   *second line that contains only NULL+LF. We need to ignore this second line.</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+   *See bug http://bugzilla.mozilla.org/show_bug.cgi?id=61412 for more</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+   *information.</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+   ***/</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+  if (length == 2 &amp;&amp; buf[0] == 0x00 &amp;&amp; buf[1] == '\n') return 0;</span>
<a href="#l35.163"></a><span id="l35.163"> #endif</span>
<a href="#l35.164"></a><span id="l35.164"> </span>
<a href="#l35.165"></a><span id="l35.165">   NS_ASSERTION(buf &amp;&amp; length &gt; 0, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l35.166"></a><span id="l35.166">   if (!buf || length &lt;= 0) return -1;</span>
<a href="#l35.167"></a><span id="l35.167">   newline = buf + length;</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineminus">-  NS_ASSERTION(newline[-1] == '\r' || newline[-1] == '\n', &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineplus">+  NS_ASSERTION(newline[-1] == '\r' || newline[-1] == '\n',</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l35.171"></a><span id="l35.171">   if (newline[-1] != '\r' &amp;&amp; newline[-1] != '\n') return -1;</span>
<a href="#l35.172"></a><span id="l35.172"> </span>
<a href="#l35.173"></a><span id="l35.173" class="difflineminus">-  if (!convert_newlines_p)</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineminus">-  {</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+  if (!convert_newlines_p) {</span>
<a href="#l35.176"></a><span id="l35.176">   }</span>
<a href="#l35.177"></a><span id="l35.177"> #if (MSG_LINEBREAK_LEN == 1)</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineminus">-  else if ((newline - buf) &gt;= 2 &amp;&amp;</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineminus">-       newline[-2] == '\r' &amp;&amp;</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineminus">-       newline[-1] == '\n')</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineminus">-  {</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineplus">+  else if ((newline - buf) &gt;= 2 &amp;&amp; newline[-2] == '\r' &amp;&amp; newline[-1] == '\n') {</span>
<a href="#l35.183"></a><span id="l35.183">     /* CRLF -&gt; CR or LF */</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineminus">-    buf [length - 2] = MSG_LINEBREAK[0];</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineplus">+    buf[length - 2] = MSG_LINEBREAK[0];</span>
<a href="#l35.186"></a><span id="l35.186">     length--;</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineminus">-  }</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineminus">-  else if (newline &gt; buf + 1 &amp;&amp;</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineminus">-       newline[-1] != MSG_LINEBREAK[0])</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineminus">-  {</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineplus">+  } else if (newline &gt; buf + 1 &amp;&amp; newline[-1] != MSG_LINEBREAK[0]) {</span>
<a href="#l35.192"></a><span id="l35.192">     /* CR -&gt; LF or LF -&gt; CR */</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineminus">-    buf [length - 1] = MSG_LINEBREAK[0];</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineplus">+    buf[length - 1] = MSG_LINEBREAK[0];</span>
<a href="#l35.195"></a><span id="l35.195">   }</span>
<a href="#l35.196"></a><span id="l35.196"> #else</span>
<a href="#l35.197"></a><span id="l35.197">   else if (((newline - buf) &gt;= 2 &amp;&amp; newline[-2] != '\r') ||</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineminus">-       ((newline - buf) &gt;= 1 &amp;&amp; newline[-1] != '\n'))</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineminus">-  {</span>
<a href="#l35.200"></a><span id="l35.200" class="difflineplus">+           ((newline - buf) &gt;= 1 &amp;&amp; newline[-1] != '\n')) {</span>
<a href="#l35.201"></a><span id="l35.201">     /* LF -&gt; CRLF or CR -&gt; CRLF */</span>
<a href="#l35.202"></a><span id="l35.202">     length++;</span>
<a href="#l35.203"></a><span id="l35.203">     buf[length - 2] = MSG_LINEBREAK[0];</span>
<a href="#l35.204"></a><span id="l35.204">     buf[length - 1] = MSG_LINEBREAK[1];</span>
<a href="#l35.205"></a><span id="l35.205">   }</span>
<a href="#l35.206"></a><span id="l35.206"> #endif</span>
<a href="#l35.207"></a><span id="l35.207"> </span>
<a href="#l35.208"></a><span id="l35.208">   return (*per_line_fn)(buf, length, closure);</span>
<a href="#l35.209"></a><span id="l35.209"> }</span>
<a href="#l35.210"></a><span id="l35.210"> </span>
<a href="#l35.211"></a><span id="l35.211" class="difflineminus">-extern &quot;C&quot; int</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineminus">-mime_LineBuffer (const char *net_buffer, int32_t net_buffer_size,</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineminus">-        char **bufferP, int32_t *buffer_sizeP, uint32_t *buffer_fpP,</span>
<a href="#l35.214"></a><span id="l35.214" class="difflineminus">-        bool convert_newlines_p,</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineminus">-        int32_t (* per_line_fn) (char *line, uint32_t line_length,</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineminus">-                    void *closure),</span>
<a href="#l35.217"></a><span id="l35.217" class="difflineminus">-        void *closure)</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineminus">-{</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineplus">+extern &quot;C&quot; int mime_LineBuffer(</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineplus">+    const char *net_buffer, int32_t net_buffer_size, char **bufferP,</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineplus">+    int32_t *buffer_sizeP, uint32_t *buffer_fpP, bool convert_newlines_p,</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineplus">+    int32_t (*per_line_fn)(char *line, uint32_t line_length, void *closure),</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineplus">+    void *closure) {</span>
<a href="#l35.224"></a><span id="l35.224">   int status = 0;</span>
<a href="#l35.225"></a><span id="l35.225">   if (*buffer_fpP &gt; 0 &amp;&amp; *bufferP &amp;&amp; (*bufferP)[*buffer_fpP - 1] == '\r' &amp;&amp;</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineminus">-    net_buffer_size &gt; 0 &amp;&amp; net_buffer[0] != '\n') {</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineminus">-  /* The last buffer ended with a CR.  The new buffer does not start</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineminus">-     with a LF.  This old buffer should be shipped out and discarded. */</span>
<a href="#l35.229"></a><span id="l35.229" class="difflineminus">-  NS_ASSERTION((uint32_t) *buffer_sizeP &gt; *buffer_fpP, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l35.230"></a><span id="l35.230" class="difflineminus">-  if ((uint32_t) *buffer_sizeP &lt;= *buffer_fpP) return -1;</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineminus">-  status = convert_and_send_buffer(*bufferP, *buffer_fpP,</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineminus">-                     convert_newlines_p,</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineminus">-                     per_line_fn, closure);</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineminus">-  if (status &lt; 0) return status;</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineminus">-  *buffer_fpP = 0;</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineplus">+      net_buffer_size &gt; 0 &amp;&amp; net_buffer[0] != '\n') {</span>
<a href="#l35.237"></a><span id="l35.237" class="difflineplus">+    /* The last buffer ended with a CR.  The new buffer does not start</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineplus">+       with a LF.  This old buffer should be shipped out and discarded. */</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineplus">+    NS_ASSERTION((uint32_t)*buffer_sizeP &gt; *buffer_fpP,</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineplus">+                 &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineplus">+    if ((uint32_t)*buffer_sizeP &lt;= *buffer_fpP) return -1;</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineplus">+    status = convert_and_send_buffer(*bufferP, *buffer_fpP, convert_newlines_p,</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineplus">+                                     per_line_fn, closure);</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineplus">+    if (status &lt; 0) return status;</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineplus">+    *buffer_fpP = 0;</span>
<a href="#l35.246"></a><span id="l35.246">   }</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineminus">-  while (net_buffer_size &gt; 0)</span>
<a href="#l35.248"></a><span id="l35.248" class="difflineminus">-  {</span>
<a href="#l35.249"></a><span id="l35.249" class="difflineplus">+  while (net_buffer_size &gt; 0) {</span>
<a href="#l35.250"></a><span id="l35.250">     const char *net_buffer_end = net_buffer + net_buffer_size;</span>
<a href="#l35.251"></a><span id="l35.251">     const char *newline = 0;</span>
<a href="#l35.252"></a><span id="l35.252">     const char *s;</span>
<a href="#l35.253"></a><span id="l35.253"> </span>
<a href="#l35.254"></a><span id="l35.254" class="difflineminus">-</span>
<a href="#l35.255"></a><span id="l35.255" class="difflineminus">-    for (s = net_buffer; s &lt; net_buffer_end; s++)</span>
<a href="#l35.256"></a><span id="l35.256" class="difflineminus">-    {</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineplus">+    for (s = net_buffer; s &lt; net_buffer_end; s++) {</span>
<a href="#l35.258"></a><span id="l35.258">       /* Move forward in the buffer until the first newline.</span>
<a href="#l35.259"></a><span id="l35.259">        Stop when we see CRLF, CR, or LF, or the end of the buffer.</span>
<a href="#l35.260"></a><span id="l35.260">        *But*, if we see a lone CR at the *very end* of the buffer,</span>
<a href="#l35.261"></a><span id="l35.261">        treat this as if we had reached the end of the buffer without</span>
<a href="#l35.262"></a><span id="l35.262">        seeing a line terminator.  This is to catch the case of the</span>
<a href="#l35.263"></a><span id="l35.263">        buffers splitting a CRLF pair, as in &quot;FOO\r\nBAR\r&quot; &quot;\nBAZ\r\n&quot;.</span>
<a href="#l35.264"></a><span id="l35.264">        */</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineminus">-      if (*s == '\r' || *s == '\n')</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineminus">-      {</span>
<a href="#l35.267"></a><span id="l35.267" class="difflineplus">+      if (*s == '\r' || *s == '\n') {</span>
<a href="#l35.268"></a><span id="l35.268">         newline = s;</span>
<a href="#l35.269"></a><span id="l35.269" class="difflineminus">-        if (newline[0] == '\r')</span>
<a href="#l35.270"></a><span id="l35.270" class="difflineminus">-        {</span>
<a href="#l35.271"></a><span id="l35.271" class="difflineminus">-          if (s == net_buffer_end - 1)</span>
<a href="#l35.272"></a><span id="l35.272" class="difflineminus">-          {</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineplus">+        if (newline[0] == '\r') {</span>
<a href="#l35.274"></a><span id="l35.274" class="difflineplus">+          if (s == net_buffer_end - 1) {</span>
<a href="#l35.275"></a><span id="l35.275">             /* CR at end - wait for the next character. */</span>
<a href="#l35.276"></a><span id="l35.276">             newline = 0;</span>
<a href="#l35.277"></a><span id="l35.277">             break;</span>
<a href="#l35.278"></a><span id="l35.278" class="difflineminus">-          }</span>
<a href="#l35.279"></a><span id="l35.279" class="difflineminus">-          else if (newline[1] == '\n')</span>
<a href="#l35.280"></a><span id="l35.280" class="difflineminus">-          /* CRLF seen; swallow both. */</span>
<a href="#l35.281"></a><span id="l35.281" class="difflineminus">-          newline++;</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineplus">+          } else if (newline[1] == '\n')</span>
<a href="#l35.283"></a><span id="l35.283" class="difflineplus">+            /* CRLF seen; swallow both. */</span>
<a href="#l35.284"></a><span id="l35.284" class="difflineplus">+            newline++;</span>
<a href="#l35.285"></a><span id="l35.285">         }</span>
<a href="#l35.286"></a><span id="l35.286">         newline++;</span>
<a href="#l35.287"></a><span id="l35.287">         break;</span>
<a href="#l35.288"></a><span id="l35.288">       }</span>
<a href="#l35.289"></a><span id="l35.289">     }</span>
<a href="#l35.290"></a><span id="l35.290"> </span>
<a href="#l35.291"></a><span id="l35.291">     /* Ensure room in the net_buffer and append some or all of the current</span>
<a href="#l35.292"></a><span id="l35.292">      chunk of data to it. */</span>
<a href="#l35.293"></a><span id="l35.293">     {</span>
<a href="#l35.294"></a><span id="l35.294" class="difflineminus">-    const char *end = (newline ? newline : net_buffer_end);</span>
<a href="#l35.295"></a><span id="l35.295" class="difflineminus">-    uint32_t desired_size = (end - net_buffer) + (*buffer_fpP) + 1;</span>
<a href="#l35.296"></a><span id="l35.296" class="difflineplus">+      const char *end = (newline ? newline : net_buffer_end);</span>
<a href="#l35.297"></a><span id="l35.297" class="difflineplus">+      uint32_t desired_size = (end - net_buffer) + (*buffer_fpP) + 1;</span>
<a href="#l35.298"></a><span id="l35.298"> </span>
<a href="#l35.299"></a><span id="l35.299" class="difflineminus">-    if (desired_size &gt;= (uint32_t) (*buffer_sizeP))</span>
<a href="#l35.300"></a><span id="l35.300" class="difflineminus">-      {</span>
<a href="#l35.301"></a><span id="l35.301" class="difflineminus">-      status = mime_GrowBuffer (desired_size, sizeof(char), 1024,</span>
<a href="#l35.302"></a><span id="l35.302" class="difflineminus">-                   bufferP, buffer_sizeP);</span>
<a href="#l35.303"></a><span id="l35.303" class="difflineminus">-      if (status &lt; 0) return status;</span>
<a href="#l35.304"></a><span id="l35.304" class="difflineplus">+      if (desired_size &gt;= (uint32_t)(*buffer_sizeP)) {</span>
<a href="#l35.305"></a><span id="l35.305" class="difflineplus">+        status = mime_GrowBuffer(desired_size, sizeof(char), 1024, bufferP,</span>
<a href="#l35.306"></a><span id="l35.306" class="difflineplus">+                                 buffer_sizeP);</span>
<a href="#l35.307"></a><span id="l35.307" class="difflineplus">+        if (status &lt; 0) return status;</span>
<a href="#l35.308"></a><span id="l35.308">       }</span>
<a href="#l35.309"></a><span id="l35.309" class="difflineminus">-    memcpy ((*bufferP) + (*buffer_fpP), net_buffer, (end - net_buffer));</span>
<a href="#l35.310"></a><span id="l35.310" class="difflineminus">-    (*buffer_fpP) += (end - net_buffer);</span>
<a href="#l35.311"></a><span id="l35.311" class="difflineminus">-        (*bufferP)[*buffer_fpP] = '\0';</span>
<a href="#l35.312"></a><span id="l35.312" class="difflineplus">+      memcpy((*bufferP) + (*buffer_fpP), net_buffer, (end - net_buffer));</span>
<a href="#l35.313"></a><span id="l35.313" class="difflineplus">+      (*buffer_fpP) += (end - net_buffer);</span>
<a href="#l35.314"></a><span id="l35.314" class="difflineplus">+      (*bufferP)[*buffer_fpP] = '\0';</span>
<a href="#l35.315"></a><span id="l35.315">     }</span>
<a href="#l35.316"></a><span id="l35.316"> </span>
<a href="#l35.317"></a><span id="l35.317">     /* Now *bufferP contains either a complete line, or as complete</span>
<a href="#l35.318"></a><span id="l35.318">      a line as we have read so far.</span>
<a href="#l35.319"></a><span id="l35.319"> </span>
<a href="#l35.320"></a><span id="l35.320">      If we have a line, process it, and then remove it from `*bufferP'.</span>
<a href="#l35.321"></a><span id="l35.321">      Then go around the loop again, until we drain the incoming data.</span>
<a href="#l35.322"></a><span id="l35.322">      */</span>
<a href="#l35.323"></a><span id="l35.323" class="difflineminus">-    if (!newline)</span>
<a href="#l35.324"></a><span id="l35.324" class="difflineminus">-    return 0;</span>
<a href="#l35.325"></a><span id="l35.325" class="difflineplus">+    if (!newline) return 0;</span>
<a href="#l35.326"></a><span id="l35.326"> </span>
<a href="#l35.327"></a><span id="l35.327" class="difflineminus">-    status = convert_and_send_buffer(*bufferP, *buffer_fpP,</span>
<a href="#l35.328"></a><span id="l35.328" class="difflineminus">-                       convert_newlines_p,</span>
<a href="#l35.329"></a><span id="l35.329" class="difflineminus">-                       per_line_fn, closure);</span>
<a href="#l35.330"></a><span id="l35.330" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l35.331"></a><span id="l35.331" class="difflineminus">-      return status;</span>
<a href="#l35.332"></a><span id="l35.332" class="difflineplus">+    status = convert_and_send_buffer(*bufferP, *buffer_fpP, convert_newlines_p,</span>
<a href="#l35.333"></a><span id="l35.333" class="difflineplus">+                                     per_line_fn, closure);</span>
<a href="#l35.334"></a><span id="l35.334" class="difflineplus">+    if (status &lt; 0) return status;</span>
<a href="#l35.335"></a><span id="l35.335"> </span>
<a href="#l35.336"></a><span id="l35.336">     net_buffer_size -= (newline - net_buffer);</span>
<a href="#l35.337"></a><span id="l35.337">     net_buffer = newline;</span>
<a href="#l35.338"></a><span id="l35.338">     (*buffer_fpP) = 0;</span>
<a href="#l35.339"></a><span id="l35.339">   }</span>
<a href="#l35.340"></a><span id="l35.340">   return 0;</span>
<a href="#l35.341"></a><span id="l35.341"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/mime/src/mimebuf.h</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/mime/src/mimebuf.h</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -1,39 +1,35 @@</span>
<a href="#l36.4"></a><span id="l36.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l36.5"></a><span id="l36.5">  *</span>
<a href="#l36.6"></a><span id="l36.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.7"></a><span id="l36.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.8"></a><span id="l36.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineminus">- * This Original Code has been modified by IBM Corporation. Modifications made by IBM</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineminus">- * described herein are Copyright (c) International Business Machines Corporation, 2000.</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineminus">- * Modifications to Mozilla code or documentation identified per MPL Section 3.3</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+ * This Original Code has been modified by IBM Corporation. Modifications made</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+ * by IBM described herein are Copyright (c) International Business Machines</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+ * Corporation, 2000. Modifications to Mozilla code or documentation identified</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+ * per MPL Section 3.3</span>
<a href="#l36.16"></a><span id="l36.16">  *</span>
<a href="#l36.17"></a><span id="l36.17">  * Date             Modified by     Description of modification</span>
<a href="#l36.18"></a><span id="l36.18">  * 04/20/2000       IBM Corp.      OS/2 VisualAge build.</span>
<a href="#l36.19"></a><span id="l36.19">  */</span>
<a href="#l36.20"></a><span id="l36.20"> </span>
<a href="#l36.21"></a><span id="l36.21"> #ifndef _MIMEBUF_H_</span>
<a href="#l36.22"></a><span id="l36.22"> #define _MIMEBUF_H_</span>
<a href="#l36.23"></a><span id="l36.23"> </span>
<a href="#l36.24"></a><span id="l36.24" class="difflineminus">-extern &quot;C&quot; int mime_GrowBuffer (uint32_t desired_size,</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineminus">-               uint32_t element_size, uint32_t quantum,</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineminus">-               char **buffer, int32_t *size);</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+extern &quot;C&quot; int mime_GrowBuffer(uint32_t desired_size, uint32_t element_size,</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineplus">+                               uint32_t quantum, char **buffer, int32_t *size);</span>
<a href="#l36.29"></a><span id="l36.29"> </span>
<a href="#l36.30"></a><span id="l36.30" class="difflineminus">-extern &quot;C&quot; int mime_LineBuffer (const char *net_buffer, int32_t net_buffer_size,</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-               char **bufferP, int32_t *buffer_sizeP,</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineminus">-               int32_t *buffer_fpP,</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-               bool convert_newlines_p,</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineminus">-               int32_t (* per_line_fn) (char *line, int32_t</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineminus">-                         line_length, void *closure),</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineminus">-               void *closure);</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineplus">+extern &quot;C&quot; int mime_LineBuffer(</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineplus">+    const char *net_buffer, int32_t net_buffer_size, char **bufferP,</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineplus">+    int32_t *buffer_sizeP, int32_t *buffer_fpP, bool convert_newlines_p,</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineplus">+    int32_t (*per_line_fn)(char *line, int32_t line_length, void *closure),</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineplus">+    void *closure);</span>
<a href="#l36.42"></a><span id="l36.42"> </span>
<a href="#l36.43"></a><span id="l36.43" class="difflineminus">-extern &quot;C&quot; int mime_ReBuffer (const char *net_buffer, int32_t net_buffer_size,</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineminus">-             uint32_t desired_buffer_size,</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineminus">-             char **bufferP, uint32_t *buffer_sizeP,</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineminus">-             uint32_t *buffer_fpP,</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineminus">-             int32_t (*per_buffer_fn) (char *buffer,</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineminus">-                         uint32_t buffer_size,</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineminus">-                         void *closure),</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-             void *closure);</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineminus">-</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+extern &quot;C&quot; int mime_ReBuffer(const char *net_buffer, int32_t net_buffer_size,</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+                             uint32_t desired_buffer_size, char **bufferP,</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+                             uint32_t *buffer_sizeP, uint32_t *buffer_fpP,</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+                             int32_t (*per_buffer_fn)(char *buffer,</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+                                                      uint32_t buffer_size,</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineplus">+                                                      void *closure),</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+                             void *closure);</span>
<a href="#l36.59"></a><span id="l36.59"> </span>
<a href="#l36.60"></a><span id="l36.60"> #endif /* _MIMEBUF_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/mime/src/mimecms.cpp</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/mime/src/mimecms.cpp</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -22,205 +22,182 @@</span>
<a href="#l37.4"></a><span id="l37.4"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l37.5"></a><span id="l37.5"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l37.6"></a><span id="l37.6"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l37.7"></a><span id="l37.7"> #include &quot;nsProxyRelease.h&quot;</span>
<a href="#l37.8"></a><span id="l37.8"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10"> using namespace mozilla::mailnews;</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-</span>
<a href="#l37.13"></a><span id="l37.13"> #define MIME_SUPERCLASS mimeEncryptedClass</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineminus">-MimeDefClass(MimeEncryptedCMS, MimeEncryptedCMSClass,</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineminus">-       mimeEncryptedCMSClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+MimeDefClass(MimeEncryptedCMS, MimeEncryptedCMSClass, mimeEncryptedCMSClass,</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+             &amp;MIME_SUPERCLASS);</span>
<a href="#l37.18"></a><span id="l37.18"> </span>
<a href="#l37.19"></a><span id="l37.19" class="difflineminus">-static void *MimeCMS_init(MimeObject *, int (*output_fn) (const char *, int32_t, void *), void *);</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineminus">-static int MimeCMS_write (const char *, int32_t, void *);</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineminus">-static int MimeCMS_eof (void *, bool);</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineminus">-static char * MimeCMS_generate (void *);</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineminus">-static void MimeCMS_free (void *);</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineplus">+static void *MimeCMS_init(MimeObject *,</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+                          int (*output_fn)(const char *, int32_t, void *),</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+                          void *);</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+static int MimeCMS_write(const char *, int32_t, void *);</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineplus">+static int MimeCMS_eof(void *, bool);</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineplus">+static char *MimeCMS_generate(void *);</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineplus">+static void MimeCMS_free(void *);</span>
<a href="#l37.31"></a><span id="l37.31"> </span>
<a href="#l37.32"></a><span id="l37.32"> extern int SEC_ERROR_CERT_ADDR_MISMATCH;</span>
<a href="#l37.33"></a><span id="l37.33"> </span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">-static int MimeEncryptedCMSClassInitialize(MimeEncryptedCMSClass *clazz)</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-{</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+static int MimeEncryptedCMSClassInitialize(MimeEncryptedCMSClass *clazz) {</span>
<a href="#l37.37"></a><span id="l37.37"> #ifdef DEBUG</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineminus">-  MimeObjectClass    *oclass = (MimeObjectClass *)    clazz;</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineminus">-  NS_ASSERTION(!oclass-&gt;class_initialized, &quot;1.2 &lt;mscott@netscape.com&gt; 01 Nov 2001 17:59&quot;);</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineplus">+  NS_ASSERTION(!oclass-&gt;class_initialized,</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+               &quot;1.2 &lt;mscott@netscape.com&gt; 01 Nov 2001 17:59&quot;);</span>
<a href="#l37.43"></a><span id="l37.43"> #endif</span>
<a href="#l37.44"></a><span id="l37.44"> </span>
<a href="#l37.45"></a><span id="l37.45" class="difflineminus">-  MimeEncryptedClass *eclass = (MimeEncryptedClass *) clazz;</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineminus">-  eclass-&gt;crypto_init          = MimeCMS_init;</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineminus">-  eclass-&gt;crypto_write         = MimeCMS_write;</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineminus">-  eclass-&gt;crypto_eof           = MimeCMS_eof;</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+  MimeEncryptedClass *eclass = (MimeEncryptedClass *)clazz;</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineplus">+  eclass-&gt;crypto_init = MimeCMS_init;</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+  eclass-&gt;crypto_write = MimeCMS_write;</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+  eclass-&gt;crypto_eof = MimeCMS_eof;</span>
<a href="#l37.53"></a><span id="l37.53">   eclass-&gt;crypto_generate_html = MimeCMS_generate;</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineminus">-  eclass-&gt;crypto_free          = MimeCMS_free;</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+  eclass-&gt;crypto_free = MimeCMS_free;</span>
<a href="#l37.56"></a><span id="l37.56"> </span>
<a href="#l37.57"></a><span id="l37.57">   return 0;</span>
<a href="#l37.58"></a><span id="l37.58"> }</span>
<a href="#l37.59"></a><span id="l37.59"> </span>
<a href="#l37.60"></a><span id="l37.60" class="difflineminus">-</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineminus">-typedef struct MimeCMSdata</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineminus">-{</span>
<a href="#l37.63"></a><span id="l37.63" class="difflineminus">-  int (*output_fn) (const char *buf, int32_t buf_size, void *output_closure);</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineplus">+typedef struct MimeCMSdata {</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineplus">+  int (*output_fn)(const char *buf, int32_t buf_size, void *output_closure);</span>
<a href="#l37.66"></a><span id="l37.66">   void *output_closure;</span>
<a href="#l37.67"></a><span id="l37.67">   nsCOMPtr&lt;nsICMSDecoder&gt; decoder_context;</span>
<a href="#l37.68"></a><span id="l37.68">   nsCOMPtr&lt;nsICMSMessage&gt; content_info;</span>
<a href="#l37.69"></a><span id="l37.69">   bool ci_is_encrypted;</span>
<a href="#l37.70"></a><span id="l37.70">   char *sender_addr;</span>
<a href="#l37.71"></a><span id="l37.71">   bool decoding_failed;</span>
<a href="#l37.72"></a><span id="l37.72">   uint32_t decoded_bytes;</span>
<a href="#l37.73"></a><span id="l37.73">   MimeObject *self;</span>
<a href="#l37.74"></a><span id="l37.74">   bool parent_is_encrypted_p;</span>
<a href="#l37.75"></a><span id="l37.75">   bool parent_holds_stamp_p;</span>
<a href="#l37.76"></a><span id="l37.76">   nsCOMPtr&lt;nsIMsgSMIMEHeaderSink&gt; smimeHeaderSink;</span>
<a href="#l37.77"></a><span id="l37.77"> </span>
<a href="#l37.78"></a><span id="l37.78">   MimeCMSdata()</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineminus">-  :output_fn(nullptr),</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineminus">-  output_closure(nullptr),</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineminus">-  ci_is_encrypted(false),</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineminus">-  sender_addr(nullptr),</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineminus">-  decoding_failed(false),</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineminus">-  decoded_bytes(0),</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineminus">-  self(nullptr),</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineminus">-  parent_is_encrypted_p(false),</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineminus">-  parent_holds_stamp_p(false)</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineminus">-  {</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineminus">-  }</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineplus">+      : output_fn(nullptr),</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineplus">+        output_closure(nullptr),</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineplus">+        ci_is_encrypted(false),</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineplus">+        sender_addr(nullptr),</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineplus">+        decoding_failed(false),</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineplus">+        decoded_bytes(0),</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineplus">+        self(nullptr),</span>
<a href="#l37.97"></a><span id="l37.97" class="difflineplus">+        parent_is_encrypted_p(false),</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineplus">+        parent_holds_stamp_p(false) {}</span>
<a href="#l37.99"></a><span id="l37.99"> </span>
<a href="#l37.100"></a><span id="l37.100" class="difflineminus">-  ~MimeCMSdata()</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineminus">-  {</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineminus">-    if(sender_addr)</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineminus">-      PR_Free(sender_addr);</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineplus">+  ~MimeCMSdata() {</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineplus">+    if (sender_addr) PR_Free(sender_addr);</span>
<a href="#l37.106"></a><span id="l37.106"> </span>
<a href="#l37.107"></a><span id="l37.107">     // Do an orderly release of nsICMSDecoder and nsICMSMessage //</span>
<a href="#l37.108"></a><span id="l37.108" class="difflineminus">-    if (decoder_context)</span>
<a href="#l37.109"></a><span id="l37.109" class="difflineminus">-    {</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineplus">+    if (decoder_context) {</span>
<a href="#l37.111"></a><span id="l37.111">       nsCOMPtr&lt;nsICMSMessage&gt; cinfo;</span>
<a href="#l37.112"></a><span id="l37.112">       decoder_context-&gt;Finish(getter_AddRefs(cinfo));</span>
<a href="#l37.113"></a><span id="l37.113">     }</span>
<a href="#l37.114"></a><span id="l37.114">   }</span>
<a href="#l37.115"></a><span id="l37.115"> } MimeCMSdata;</span>
<a href="#l37.116"></a><span id="l37.116"> </span>
<a href="#l37.117"></a><span id="l37.117"> /*   SEC_PKCS7DecoderContentCallback for SEC_PKCS7DecoderStart() */</span>
<a href="#l37.118"></a><span id="l37.118" class="difflineminus">-static void MimeCMS_content_callback (void *arg, const char *buf, unsigned long length)</span>
<a href="#l37.119"></a><span id="l37.119" class="difflineminus">-{</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineplus">+static void MimeCMS_content_callback(void *arg, const char *buf,</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineplus">+                                     unsigned long length) {</span>
<a href="#l37.122"></a><span id="l37.122">   int status;</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineminus">-  MimeCMSdata *data = (MimeCMSdata *) arg;</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineplus">+  MimeCMSdata *data = (MimeCMSdata *)arg;</span>
<a href="#l37.125"></a><span id="l37.125">   if (!data) return;</span>
<a href="#l37.126"></a><span id="l37.126"> </span>
<a href="#l37.127"></a><span id="l37.127" class="difflineminus">-  if (!data-&gt;output_fn)</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineminus">-    return;</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineplus">+  if (!data-&gt;output_fn) return;</span>
<a href="#l37.130"></a><span id="l37.130"> </span>
<a href="#l37.131"></a><span id="l37.131" class="difflineminus">-  PR_SetError(0,0);</span>
<a href="#l37.132"></a><span id="l37.132" class="difflineminus">-  status = data-&gt;output_fn (buf, length, data-&gt;output_closure);</span>
<a href="#l37.133"></a><span id="l37.133" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l37.134"></a><span id="l37.134" class="difflineminus">-  {</span>
<a href="#l37.135"></a><span id="l37.135" class="difflineplus">+  PR_SetError(0, 0);</span>
<a href="#l37.136"></a><span id="l37.136" class="difflineplus">+  status = data-&gt;output_fn(buf, length, data-&gt;output_closure);</span>
<a href="#l37.137"></a><span id="l37.137" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l37.138"></a><span id="l37.138">     PR_SetError(status, 0);</span>
<a href="#l37.139"></a><span id="l37.139">     data-&gt;output_fn = 0;</span>
<a href="#l37.140"></a><span id="l37.140">     return;</span>
<a href="#l37.141"></a><span id="l37.141">   }</span>
<a href="#l37.142"></a><span id="l37.142"> </span>
<a href="#l37.143"></a><span id="l37.143">   data-&gt;decoded_bytes += length;</span>
<a href="#l37.144"></a><span id="l37.144"> }</span>
<a href="#l37.145"></a><span id="l37.145"> </span>
<a href="#l37.146"></a><span id="l37.146" class="difflineminus">-bool MimeEncryptedCMS_encrypted_p (MimeObject *obj)</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineminus">-{</span>
<a href="#l37.148"></a><span id="l37.148" class="difflineplus">+bool MimeEncryptedCMS_encrypted_p(MimeObject *obj) {</span>
<a href="#l37.149"></a><span id="l37.149">   bool encrypted;</span>
<a href="#l37.150"></a><span id="l37.150"> </span>
<a href="#l37.151"></a><span id="l37.151">   if (!obj) return false;</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineminus">-  if (mime_typep(obj, (MimeObjectClass *) &amp;mimeEncryptedCMSClass))</span>
<a href="#l37.153"></a><span id="l37.153" class="difflineminus">-  {</span>
<a href="#l37.154"></a><span id="l37.154" class="difflineminus">-    MimeEncrypted *enc = (MimeEncrypted *) obj;</span>
<a href="#l37.155"></a><span id="l37.155" class="difflineminus">-    MimeCMSdata *data = (MimeCMSdata *) enc-&gt;crypto_closure;</span>
<a href="#l37.156"></a><span id="l37.156" class="difflineplus">+  if (mime_typep(obj, (MimeObjectClass *)&amp;mimeEncryptedCMSClass)) {</span>
<a href="#l37.157"></a><span id="l37.157" class="difflineplus">+    MimeEncrypted *enc = (MimeEncrypted *)obj;</span>
<a href="#l37.158"></a><span id="l37.158" class="difflineplus">+    MimeCMSdata *data = (MimeCMSdata *)enc-&gt;crypto_closure;</span>
<a href="#l37.159"></a><span id="l37.159">     if (!data || !data-&gt;content_info) return false;</span>
<a href="#l37.160"></a><span id="l37.160" class="difflineminus">-                data-&gt;content_info-&gt;ContentIsEncrypted(&amp;encrypted);</span>
<a href="#l37.161"></a><span id="l37.161" class="difflineminus">-          return encrypted;</span>
<a href="#l37.162"></a><span id="l37.162" class="difflineplus">+    data-&gt;content_info-&gt;ContentIsEncrypted(&amp;encrypted);</span>
<a href="#l37.163"></a><span id="l37.163" class="difflineplus">+    return encrypted;</span>
<a href="#l37.164"></a><span id="l37.164">   }</span>
<a href="#l37.165"></a><span id="l37.165">   return false;</span>
<a href="#l37.166"></a><span id="l37.166"> }</span>
<a href="#l37.167"></a><span id="l37.167"> </span>
<a href="#l37.168"></a><span id="l37.168" class="difflineminus">-</span>
<a href="#l37.169"></a><span id="l37.169"> bool MimeCMSHeadersAndCertsMatch(nsICMSMessage *content_info,</span>
<a href="#l37.170"></a><span id="l37.170" class="difflineminus">-                                   nsIX509Cert *signerCert,</span>
<a href="#l37.171"></a><span id="l37.171" class="difflineminus">-                                   const char *from_addr,</span>
<a href="#l37.172"></a><span id="l37.172" class="difflineminus">-                                   const char *from_name,</span>
<a href="#l37.173"></a><span id="l37.173" class="difflineminus">-                                   const char *sender_addr,</span>
<a href="#l37.174"></a><span id="l37.174" class="difflineminus">-                                   const char *sender_name,</span>
<a href="#l37.175"></a><span id="l37.175" class="difflineminus">-                                   bool *signing_cert_without_email_address)</span>
<a href="#l37.176"></a><span id="l37.176" class="difflineminus">-{</span>
<a href="#l37.177"></a><span id="l37.177" class="difflineplus">+                                 nsIX509Cert *signerCert, const char *from_addr,</span>
<a href="#l37.178"></a><span id="l37.178" class="difflineplus">+                                 const char *from_name, const char *sender_addr,</span>
<a href="#l37.179"></a><span id="l37.179" class="difflineplus">+                                 const char *sender_name,</span>
<a href="#l37.180"></a><span id="l37.180" class="difflineplus">+                                 bool *signing_cert_without_email_address) {</span>
<a href="#l37.181"></a><span id="l37.181">   nsCString cert_addr;</span>
<a href="#l37.182"></a><span id="l37.182">   bool match = true;</span>
<a href="#l37.183"></a><span id="l37.183">   bool foundFrom = false;</span>
<a href="#l37.184"></a><span id="l37.184">   bool foundSender = false;</span>
<a href="#l37.185"></a><span id="l37.185"> </span>
<a href="#l37.186"></a><span id="l37.186">   /* Find the name and address in the cert.</span>
<a href="#l37.187"></a><span id="l37.187">    */</span>
<a href="#l37.188"></a><span id="l37.188" class="difflineminus">-  if (content_info)</span>
<a href="#l37.189"></a><span id="l37.189" class="difflineminus">-  {</span>
<a href="#l37.190"></a><span id="l37.190" class="difflineplus">+  if (content_info) {</span>
<a href="#l37.191"></a><span id="l37.191">     // Extract any address contained in the cert.</span>
<a href="#l37.192"></a><span id="l37.192" class="difflineminus">-    // This will be used for testing, whether the cert contains no addresses at all.</span>
<a href="#l37.193"></a><span id="l37.193" class="difflineminus">-    content_info-&gt;GetSignerEmailAddress (getter_Copies(cert_addr));</span>
<a href="#l37.194"></a><span id="l37.194" class="difflineplus">+    // This will be used for testing, whether the cert contains no addresses at</span>
<a href="#l37.195"></a><span id="l37.195" class="difflineplus">+    // all.</span>
<a href="#l37.196"></a><span id="l37.196" class="difflineplus">+    content_info-&gt;GetSignerEmailAddress(getter_Copies(cert_addr));</span>
<a href="#l37.197"></a><span id="l37.197">   }</span>
<a href="#l37.198"></a><span id="l37.198"> </span>
<a href="#l37.199"></a><span id="l37.199">   if (signing_cert_without_email_address)</span>
<a href="#l37.200"></a><span id="l37.200">     *signing_cert_without_email_address = cert_addr.IsEmpty();</span>
<a href="#l37.201"></a><span id="l37.201"> </span>
<a href="#l37.202"></a><span id="l37.202">   /* Now compare them --</span>
<a href="#l37.203"></a><span id="l37.203">    consider it a match if the address in the cert matches the</span>
<a href="#l37.204"></a><span id="l37.204">    address in the From field (or as a fallback, the Sender field)</span>
<a href="#l37.205"></a><span id="l37.205">    */</span>
<a href="#l37.206"></a><span id="l37.206"> </span>
<a href="#l37.207"></a><span id="l37.207">   /* If there is no addr in the cert at all, it can not match and we fail. */</span>
<a href="#l37.208"></a><span id="l37.208" class="difflineminus">-  if (cert_addr.IsEmpty())</span>
<a href="#l37.209"></a><span id="l37.209" class="difflineminus">-  {</span>
<a href="#l37.210"></a><span id="l37.210" class="difflineplus">+  if (cert_addr.IsEmpty()) {</span>
<a href="#l37.211"></a><span id="l37.211">     match = false;</span>
<a href="#l37.212"></a><span id="l37.212" class="difflineminus">-  }</span>
<a href="#l37.213"></a><span id="l37.213" class="difflineminus">-  else</span>
<a href="#l37.214"></a><span id="l37.214" class="difflineminus">-  {</span>
<a href="#l37.215"></a><span id="l37.215" class="difflineminus">-    if (signerCert)</span>
<a href="#l37.216"></a><span id="l37.216" class="difflineminus">-    {</span>
<a href="#l37.217"></a><span id="l37.217" class="difflineminus">-      if (from_addr &amp;&amp; *from_addr)</span>
<a href="#l37.218"></a><span id="l37.218" class="difflineminus">-      {</span>
<a href="#l37.219"></a><span id="l37.219" class="difflineplus">+  } else {</span>
<a href="#l37.220"></a><span id="l37.220" class="difflineplus">+    if (signerCert) {</span>
<a href="#l37.221"></a><span id="l37.221" class="difflineplus">+      if (from_addr &amp;&amp; *from_addr) {</span>
<a href="#l37.222"></a><span id="l37.222">         NS_ConvertASCIItoUTF16 ucs2From(from_addr);</span>
<a href="#l37.223"></a><span id="l37.223" class="difflineminus">-        if (NS_FAILED(signerCert-&gt;ContainsEmailAddress(ucs2From, &amp;foundFrom)))</span>
<a href="#l37.224"></a><span id="l37.224" class="difflineminus">-        {</span>
<a href="#l37.225"></a><span id="l37.225" class="difflineplus">+        if (NS_FAILED(signerCert-&gt;ContainsEmailAddress(ucs2From, &amp;foundFrom))) {</span>
<a href="#l37.226"></a><span id="l37.226">           foundFrom = false;</span>
<a href="#l37.227"></a><span id="l37.227">         }</span>
<a href="#l37.228"></a><span id="l37.228" class="difflineminus">-      }</span>
<a href="#l37.229"></a><span id="l37.229" class="difflineminus">-      else if (sender_addr &amp;&amp; *sender_addr)</span>
<a href="#l37.230"></a><span id="l37.230" class="difflineminus">-      {</span>
<a href="#l37.231"></a><span id="l37.231" class="difflineplus">+      } else if (sender_addr &amp;&amp; *sender_addr) {</span>
<a href="#l37.232"></a><span id="l37.232">         NS_ConvertASCIItoUTF16 ucs2Sender(sender_addr);</span>
<a href="#l37.233"></a><span id="l37.233" class="difflineminus">-        if (NS_FAILED(signerCert-&gt;ContainsEmailAddress(ucs2Sender, &amp;foundSender)))</span>
<a href="#l37.234"></a><span id="l37.234" class="difflineminus">-        {</span>
<a href="#l37.235"></a><span id="l37.235" class="difflineplus">+        if (NS_FAILED(</span>
<a href="#l37.236"></a><span id="l37.236" class="difflineplus">+                signerCert-&gt;ContainsEmailAddress(ucs2Sender, &amp;foundSender))) {</span>
<a href="#l37.237"></a><span id="l37.237">           foundSender = false;</span>
<a href="#l37.238"></a><span id="l37.238">         }</span>
<a href="#l37.239"></a><span id="l37.239">       }</span>
<a href="#l37.240"></a><span id="l37.240">     }</span>
<a href="#l37.241"></a><span id="l37.241"> </span>
<a href="#l37.242"></a><span id="l37.242" class="difflineminus">-    if (!foundSender &amp;&amp; !foundFrom)</span>
<a href="#l37.243"></a><span id="l37.243" class="difflineminus">-    {</span>
<a href="#l37.244"></a><span id="l37.244" class="difflineplus">+    if (!foundSender &amp;&amp; !foundFrom) {</span>
<a href="#l37.245"></a><span id="l37.245">       match = false;</span>
<a href="#l37.246"></a><span id="l37.246">     }</span>
<a href="#l37.247"></a><span id="l37.247">   }</span>
<a href="#l37.248"></a><span id="l37.248"> </span>
<a href="#l37.249"></a><span id="l37.249">   return match;</span>
<a href="#l37.250"></a><span id="l37.250"> }</span>
<a href="#l37.251"></a><span id="l37.251"> </span>
<a href="#l37.252"></a><span id="l37.252" class="difflineminus">-class nsSMimeVerificationListener : public nsISMimeVerificationListener</span>
<a href="#l37.253"></a><span id="l37.253" class="difflineminus">-{</span>
<a href="#l37.254"></a><span id="l37.254" class="difflineminus">-public:</span>
<a href="#l37.255"></a><span id="l37.255" class="difflineplus">+class nsSMimeVerificationListener : public nsISMimeVerificationListener {</span>
<a href="#l37.256"></a><span id="l37.256" class="difflineplus">+ public:</span>
<a href="#l37.257"></a><span id="l37.257">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l37.258"></a><span id="l37.258">   NS_DECL_NSISMIMEVERIFICATIONLISTENER</span>
<a href="#l37.259"></a><span id="l37.259"> </span>
<a href="#l37.260"></a><span id="l37.260">   nsSMimeVerificationListener(const char *aFromAddr, const char *aFromName,</span>
<a href="#l37.261"></a><span id="l37.261">                               const char *aSenderAddr, const char *aSenderName,</span>
<a href="#l37.262"></a><span id="l37.262" class="difflineminus">-                              nsIMsgSMIMEHeaderSink *aHeaderSink, int32_t aMimeNestingLevel);</span>
<a href="#l37.263"></a><span id="l37.263" class="difflineplus">+                              nsIMsgSMIMEHeaderSink *aHeaderSink,</span>
<a href="#l37.264"></a><span id="l37.264" class="difflineplus">+                              int32_t aMimeNestingLevel);</span>
<a href="#l37.265"></a><span id="l37.265"> </span>
<a href="#l37.266"></a><span id="l37.266" class="difflineminus">-protected:</span>
<a href="#l37.267"></a><span id="l37.267" class="difflineplus">+ protected:</span>
<a href="#l37.268"></a><span id="l37.268">   virtual ~nsSMimeVerificationListener() {}</span>
<a href="#l37.269"></a><span id="l37.269"> </span>
<a href="#l37.270"></a><span id="l37.270">   /**</span>
<a href="#l37.271"></a><span id="l37.271">    * It is safe to declare this implementation as thread safe,</span>
<a href="#l37.272"></a><span id="l37.272">    * despite not using a lock to protect the members.</span>
<a href="#l37.273"></a><span id="l37.273">    * Because of the way the object will be used, we don't expect a race.</span>
<a href="#l37.274"></a><span id="l37.274">    * After construction, the object is passed to another thread,</span>
<a href="#l37.275"></a><span id="l37.275">    * but will no longer be accessed on the original thread.</span>
<a href="#l37.276"></a><span id="l37.276" class="difflineat">@@ -235,154 +212,149 @@ protected:</span>
<a href="#l37.277"></a><span id="l37.277">   int32_t mMimeNestingLevel;</span>
<a href="#l37.278"></a><span id="l37.278"> </span>
<a href="#l37.279"></a><span id="l37.279">   nsCString mFromAddr;</span>
<a href="#l37.280"></a><span id="l37.280">   nsCString mFromName;</span>
<a href="#l37.281"></a><span id="l37.281">   nsCString mSenderAddr;</span>
<a href="#l37.282"></a><span id="l37.282">   nsCString mSenderName;</span>
<a href="#l37.283"></a><span id="l37.283"> };</span>
<a href="#l37.284"></a><span id="l37.284"> </span>
<a href="#l37.285"></a><span id="l37.285" class="difflineminus">-class SignedStatusRunnable : public mozilla::Runnable</span>
<a href="#l37.286"></a><span id="l37.286" class="difflineminus">-{</span>
<a href="#l37.287"></a><span id="l37.287" class="difflineminus">-public:</span>
<a href="#l37.288"></a><span id="l37.288" class="difflineminus">-  SignedStatusRunnable(const nsMainThreadPtrHandle&lt;nsIMsgSMIMEHeaderSink&gt; &amp;aSink, int32_t aNestingLevel,</span>
<a href="#l37.289"></a><span id="l37.289" class="difflineminus">-                       int32_t aSignatureStatus, nsIX509Cert *aSignerCert);</span>
<a href="#l37.290"></a><span id="l37.290" class="difflineplus">+class SignedStatusRunnable : public mozilla::Runnable {</span>
<a href="#l37.291"></a><span id="l37.291" class="difflineplus">+ public:</span>
<a href="#l37.292"></a><span id="l37.292" class="difflineplus">+  SignedStatusRunnable(</span>
<a href="#l37.293"></a><span id="l37.293" class="difflineplus">+      const nsMainThreadPtrHandle&lt;nsIMsgSMIMEHeaderSink&gt; &amp;aSink,</span>
<a href="#l37.294"></a><span id="l37.294" class="difflineplus">+      int32_t aNestingLevel, int32_t aSignatureStatus,</span>
<a href="#l37.295"></a><span id="l37.295" class="difflineplus">+      nsIX509Cert *aSignerCert);</span>
<a href="#l37.296"></a><span id="l37.296">   NS_DECL_NSIRUNNABLE</span>
<a href="#l37.297"></a><span id="l37.297">   nsresult mResult;</span>
<a href="#l37.298"></a><span id="l37.298"> </span>
<a href="#l37.299"></a><span id="l37.299" class="difflineminus">-protected:</span>
<a href="#l37.300"></a><span id="l37.300" class="difflineplus">+ protected:</span>
<a href="#l37.301"></a><span id="l37.301">   nsMainThreadPtrHandle&lt;nsIMsgSMIMEHeaderSink&gt; m_sink;</span>
<a href="#l37.302"></a><span id="l37.302">   int32_t m_nestingLevel;</span>
<a href="#l37.303"></a><span id="l37.303">   int32_t m_signatureStatus;</span>
<a href="#l37.304"></a><span id="l37.304">   nsCOMPtr&lt;nsIX509Cert&gt; m_signerCert;</span>
<a href="#l37.305"></a><span id="l37.305"> };</span>
<a href="#l37.306"></a><span id="l37.306"> </span>
<a href="#l37.307"></a><span id="l37.307" class="difflineminus">-SignedStatusRunnable::SignedStatusRunnable(const nsMainThreadPtrHandle&lt;nsIMsgSMIMEHeaderSink&gt; &amp;aSink,</span>
<a href="#l37.308"></a><span id="l37.308" class="difflineminus">-                                           int32_t aNestingLevel,</span>
<a href="#l37.309"></a><span id="l37.309" class="difflineminus">-                                           int32_t aSignatureStatus,</span>
<a href="#l37.310"></a><span id="l37.310" class="difflineminus">-                                           nsIX509Cert *aSignerCert) :</span>
<a href="#l37.311"></a><span id="l37.311" class="difflineminus">-  mozilla::Runnable(&quot;SignedStatusRunnable&quot;),</span>
<a href="#l37.312"></a><span id="l37.312" class="difflineminus">-  m_sink(aSink), m_nestingLevel(aNestingLevel),</span>
<a href="#l37.313"></a><span id="l37.313" class="difflineminus">-  m_signatureStatus(aSignatureStatus), m_signerCert(aSignerCert)</span>
<a href="#l37.314"></a><span id="l37.314" class="difflineminus">-{</span>
<a href="#l37.315"></a><span id="l37.315" class="difflineminus">-}</span>
<a href="#l37.316"></a><span id="l37.316" class="difflineplus">+SignedStatusRunnable::SignedStatusRunnable(</span>
<a href="#l37.317"></a><span id="l37.317" class="difflineplus">+    const nsMainThreadPtrHandle&lt;nsIMsgSMIMEHeaderSink&gt; &amp;aSink,</span>
<a href="#l37.318"></a><span id="l37.318" class="difflineplus">+    int32_t aNestingLevel, int32_t aSignatureStatus, nsIX509Cert *aSignerCert)</span>
<a href="#l37.319"></a><span id="l37.319" class="difflineplus">+    : mozilla::Runnable(&quot;SignedStatusRunnable&quot;),</span>
<a href="#l37.320"></a><span id="l37.320" class="difflineplus">+      m_sink(aSink),</span>
<a href="#l37.321"></a><span id="l37.321" class="difflineplus">+      m_nestingLevel(aNestingLevel),</span>
<a href="#l37.322"></a><span id="l37.322" class="difflineplus">+      m_signatureStatus(aSignatureStatus),</span>
<a href="#l37.323"></a><span id="l37.323" class="difflineplus">+      m_signerCert(aSignerCert) {}</span>
<a href="#l37.324"></a><span id="l37.324"> </span>
<a href="#l37.325"></a><span id="l37.325" class="difflineminus">-NS_IMETHODIMP SignedStatusRunnable::Run()</span>
<a href="#l37.326"></a><span id="l37.326" class="difflineminus">-{</span>
<a href="#l37.327"></a><span id="l37.327" class="difflineminus">-  mResult = m_sink-&gt;SignedStatus(m_nestingLevel, m_signatureStatus, m_signerCert);</span>
<a href="#l37.328"></a><span id="l37.328" class="difflineplus">+NS_IMETHODIMP SignedStatusRunnable::Run() {</span>
<a href="#l37.329"></a><span id="l37.329" class="difflineplus">+  mResult =</span>
<a href="#l37.330"></a><span id="l37.330" class="difflineplus">+      m_sink-&gt;SignedStatus(m_nestingLevel, m_signatureStatus, m_signerCert);</span>
<a href="#l37.331"></a><span id="l37.331">   return NS_OK;</span>
<a href="#l37.332"></a><span id="l37.332"> }</span>
<a href="#l37.333"></a><span id="l37.333"> </span>
<a href="#l37.334"></a><span id="l37.334" class="difflineminus">-</span>
<a href="#l37.335"></a><span id="l37.335" class="difflineminus">-nsresult ProxySignedStatus(const nsMainThreadPtrHandle&lt;nsIMsgSMIMEHeaderSink&gt; &amp;aSink,</span>
<a href="#l37.336"></a><span id="l37.336" class="difflineminus">-                           int32_t aNestingLevel,</span>
<a href="#l37.337"></a><span id="l37.337" class="difflineminus">-                           int32_t aSignatureStatus,</span>
<a href="#l37.338"></a><span id="l37.338" class="difflineminus">-                           nsIX509Cert *aSignerCert)</span>
<a href="#l37.339"></a><span id="l37.339" class="difflineminus">-{</span>
<a href="#l37.340"></a><span id="l37.340" class="difflineminus">-  RefPtr&lt;SignedStatusRunnable&gt; signedStatus =</span>
<a href="#l37.341"></a><span id="l37.341" class="difflineminus">-    new SignedStatusRunnable(aSink, aNestingLevel, aSignatureStatus, aSignerCert);</span>
<a href="#l37.342"></a><span id="l37.342" class="difflineplus">+nsresult ProxySignedStatus(</span>
<a href="#l37.343"></a><span id="l37.343" class="difflineplus">+    const nsMainThreadPtrHandle&lt;nsIMsgSMIMEHeaderSink&gt; &amp;aSink,</span>
<a href="#l37.344"></a><span id="l37.344" class="difflineplus">+    int32_t aNestingLevel, int32_t aSignatureStatus, nsIX509Cert *aSignerCert) {</span>
<a href="#l37.345"></a><span id="l37.345" class="difflineplus">+  RefPtr&lt;SignedStatusRunnable&gt; signedStatus = new SignedStatusRunnable(</span>
<a href="#l37.346"></a><span id="l37.346" class="difflineplus">+      aSink, aNestingLevel, aSignatureStatus, aSignerCert);</span>
<a href="#l37.347"></a><span id="l37.347">   nsresult rv = NS_DispatchToMainThread(signedStatus, NS_DISPATCH_SYNC);</span>
<a href="#l37.348"></a><span id="l37.348">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.349"></a><span id="l37.349">   return signedStatus-&gt;mResult;</span>
<a href="#l37.350"></a><span id="l37.350"> }</span>
<a href="#l37.351"></a><span id="l37.351"> </span>
<a href="#l37.352"></a><span id="l37.352"> NS_IMPL_ISUPPORTS(nsSMimeVerificationListener, nsISMimeVerificationListener)</span>
<a href="#l37.353"></a><span id="l37.353"> </span>
<a href="#l37.354"></a><span id="l37.354" class="difflineminus">-nsSMimeVerificationListener::nsSMimeVerificationListener(const char *aFromAddr, const char *aFromName,</span>
<a href="#l37.355"></a><span id="l37.355" class="difflineminus">-                                                         const char *aSenderAddr, const char *aSenderName,</span>
<a href="#l37.356"></a><span id="l37.356" class="difflineminus">-                                                         nsIMsgSMIMEHeaderSink *aHeaderSink, int32_t aMimeNestingLevel)</span>
<a href="#l37.357"></a><span id="l37.357" class="difflineminus">-{</span>
<a href="#l37.358"></a><span id="l37.358" class="difflineminus">-  mHeaderSink = new nsMainThreadPtrHolder&lt;nsIMsgSMIMEHeaderSink&gt;(&quot;nsSMimeVerificationListener::mHeaderSink&quot;, aHeaderSink);</span>
<a href="#l37.359"></a><span id="l37.359" class="difflineplus">+nsSMimeVerificationListener::nsSMimeVerificationListener(</span>
<a href="#l37.360"></a><span id="l37.360" class="difflineplus">+    const char *aFromAddr, const char *aFromName, const char *aSenderAddr,</span>
<a href="#l37.361"></a><span id="l37.361" class="difflineplus">+    const char *aSenderName, nsIMsgSMIMEHeaderSink *aHeaderSink,</span>
<a href="#l37.362"></a><span id="l37.362" class="difflineplus">+    int32_t aMimeNestingLevel) {</span>
<a href="#l37.363"></a><span id="l37.363" class="difflineplus">+  mHeaderSink = new nsMainThreadPtrHolder&lt;nsIMsgSMIMEHeaderSink&gt;(</span>
<a href="#l37.364"></a><span id="l37.364" class="difflineplus">+      &quot;nsSMimeVerificationListener::mHeaderSink&quot;, aHeaderSink);</span>
<a href="#l37.365"></a><span id="l37.365">   mSinkIsNull = !aHeaderSink;</span>
<a href="#l37.366"></a><span id="l37.366">   mMimeNestingLevel = aMimeNestingLevel;</span>
<a href="#l37.367"></a><span id="l37.367"> </span>
<a href="#l37.368"></a><span id="l37.368">   mFromAddr = aFromAddr;</span>
<a href="#l37.369"></a><span id="l37.369">   mFromName = aFromName;</span>
<a href="#l37.370"></a><span id="l37.370">   mSenderAddr = aSenderAddr;</span>
<a href="#l37.371"></a><span id="l37.371">   mSenderName = aSenderName;</span>
<a href="#l37.372"></a><span id="l37.372"> }</span>
<a href="#l37.373"></a><span id="l37.373"> </span>
<a href="#l37.374"></a><span id="l37.374" class="difflineminus">-NS_IMETHODIMP nsSMimeVerificationListener::Notify(nsICMSMessage *aVerifiedMessage,</span>
<a href="#l37.375"></a><span id="l37.375" class="difflineminus">-                                                  nsresult aVerificationResultCode)</span>
<a href="#l37.376"></a><span id="l37.376" class="difflineminus">-{</span>
<a href="#l37.377"></a><span id="l37.377" class="difflineplus">+NS_IMETHODIMP nsSMimeVerificationListener::Notify(</span>
<a href="#l37.378"></a><span id="l37.378" class="difflineplus">+    nsICMSMessage *aVerifiedMessage, nsresult aVerificationResultCode) {</span>
<a href="#l37.379"></a><span id="l37.379">   // Only continue if we have a valid pointer to the UI</span>
<a href="#l37.380"></a><span id="l37.380">   NS_ENSURE_FALSE(mSinkIsNull, NS_OK);</span>
<a href="#l37.381"></a><span id="l37.381"> </span>
<a href="#l37.382"></a><span id="l37.382">   NS_ENSURE_TRUE(aVerifiedMessage, NS_ERROR_FAILURE);</span>
<a href="#l37.383"></a><span id="l37.383"> </span>
<a href="#l37.384"></a><span id="l37.384">   nsCOMPtr&lt;nsIX509Cert&gt; signerCert;</span>
<a href="#l37.385"></a><span id="l37.385">   aVerifiedMessage-&gt;GetSignerCert(getter_AddRefs(signerCert));</span>
<a href="#l37.386"></a><span id="l37.386"> </span>
<a href="#l37.387"></a><span id="l37.387">   int32_t signature_status = nsICMSMessageErrors::GENERAL_ERROR;</span>
<a href="#l37.388"></a><span id="l37.388"> </span>
<a href="#l37.389"></a><span id="l37.389" class="difflineminus">-  if (NS_FAILED(aVerificationResultCode))</span>
<a href="#l37.390"></a><span id="l37.390" class="difflineminus">-  {</span>
<a href="#l37.391"></a><span id="l37.391" class="difflineminus">-    if (NS_ERROR_MODULE_SECURITY == NS_ERROR_GET_MODULE(aVerificationResultCode))</span>
<a href="#l37.392"></a><span id="l37.392" class="difflineplus">+  if (NS_FAILED(aVerificationResultCode)) {</span>
<a href="#l37.393"></a><span id="l37.393" class="difflineplus">+    if (NS_ERROR_MODULE_SECURITY ==</span>
<a href="#l37.394"></a><span id="l37.394" class="difflineplus">+        NS_ERROR_GET_MODULE(aVerificationResultCode))</span>
<a href="#l37.395"></a><span id="l37.395">       signature_status = NS_ERROR_GET_CODE(aVerificationResultCode);</span>
<a href="#l37.396"></a><span id="l37.396">     else if (NS_ERROR_NOT_IMPLEMENTED == aVerificationResultCode)</span>
<a href="#l37.397"></a><span id="l37.397">       signature_status = nsICMSMessageErrors::VERIFY_ERROR_PROCESSING;</span>
<a href="#l37.398"></a><span id="l37.398" class="difflineminus">-  }</span>
<a href="#l37.399"></a><span id="l37.399" class="difflineminus">-  else</span>
<a href="#l37.400"></a><span id="l37.400" class="difflineminus">-  {</span>
<a href="#l37.401"></a><span id="l37.401" class="difflineplus">+  } else {</span>
<a href="#l37.402"></a><span id="l37.402">     bool signing_cert_without_email_address;</span>
<a href="#l37.403"></a><span id="l37.403"> </span>
<a href="#l37.404"></a><span id="l37.404" class="difflineminus">-    bool good_p = MimeCMSHeadersAndCertsMatch(aVerifiedMessage, signerCert,</span>
<a href="#l37.405"></a><span id="l37.405" class="difflineminus">-                                              mFromAddr.get(), mFromName.get(),</span>
<a href="#l37.406"></a><span id="l37.406" class="difflineminus">-                                              mSenderAddr.get(), mSenderName.get(),</span>
<a href="#l37.407"></a><span id="l37.407" class="difflineminus">-                                              &amp;signing_cert_without_email_address);</span>
<a href="#l37.408"></a><span id="l37.408" class="difflineminus">-    if (!good_p)</span>
<a href="#l37.409"></a><span id="l37.409" class="difflineminus">-    {</span>
<a href="#l37.410"></a><span id="l37.410" class="difflineplus">+    bool good_p = MimeCMSHeadersAndCertsMatch(</span>
<a href="#l37.411"></a><span id="l37.411" class="difflineplus">+        aVerifiedMessage, signerCert, mFromAddr.get(), mFromName.get(),</span>
<a href="#l37.412"></a><span id="l37.412" class="difflineplus">+        mSenderAddr.get(), mSenderName.get(),</span>
<a href="#l37.413"></a><span id="l37.413" class="difflineplus">+        &amp;signing_cert_without_email_address);</span>
<a href="#l37.414"></a><span id="l37.414" class="difflineplus">+    if (!good_p) {</span>
<a href="#l37.415"></a><span id="l37.415">       if (signing_cert_without_email_address)</span>
<a href="#l37.416"></a><span id="l37.416">         signature_status = nsICMSMessageErrors::VERIFY_CERT_WITHOUT_ADDRESS;</span>
<a href="#l37.417"></a><span id="l37.417">       else</span>
<a href="#l37.418"></a><span id="l37.418">         signature_status = nsICMSMessageErrors::VERIFY_HEADER_MISMATCH;</span>
<a href="#l37.419"></a><span id="l37.419" class="difflineminus">-    }</span>
<a href="#l37.420"></a><span id="l37.420" class="difflineminus">-    else</span>
<a href="#l37.421"></a><span id="l37.421" class="difflineplus">+    } else</span>
<a href="#l37.422"></a><span id="l37.422">       signature_status = nsICMSMessageErrors::SUCCESS;</span>
<a href="#l37.423"></a><span id="l37.423">   }</span>
<a href="#l37.424"></a><span id="l37.424"> </span>
<a href="#l37.425"></a><span id="l37.425" class="difflineminus">-  ProxySignedStatus(mHeaderSink, mMimeNestingLevel, signature_status, signerCert);</span>
<a href="#l37.426"></a><span id="l37.426" class="difflineplus">+  ProxySignedStatus(mHeaderSink, mMimeNestingLevel, signature_status,</span>
<a href="#l37.427"></a><span id="l37.427" class="difflineplus">+                    signerCert);</span>
<a href="#l37.428"></a><span id="l37.428"> </span>
<a href="#l37.429"></a><span id="l37.429">   return NS_OK;</span>
<a href="#l37.430"></a><span id="l37.430"> }</span>
<a href="#l37.431"></a><span id="l37.431"> </span>
<a href="#l37.432"></a><span id="l37.432" class="difflineminus">-int MIMEGetRelativeCryptoNestLevel(MimeObject *obj)</span>
<a href="#l37.433"></a><span id="l37.433" class="difflineminus">-{</span>
<a href="#l37.434"></a><span id="l37.434" class="difflineplus">+int MIMEGetRelativeCryptoNestLevel(MimeObject *obj) {</span>
<a href="#l37.435"></a><span id="l37.435">   /*</span>
<a href="#l37.436"></a><span id="l37.436">     the part id of any mimeobj is mime_part_address(obj)</span>
<a href="#l37.437"></a><span id="l37.437">     our currently displayed crypto part is obj</span>
<a href="#l37.438"></a><span id="l37.438">     the part shown as the toplevel object in the current window is</span>
<a href="#l37.439"></a><span id="l37.439">         obj-&gt;options-&gt;part_to_load</span>
<a href="#l37.440"></a><span id="l37.440">         possibly stored in the toplevel object only ???</span>
<a href="#l37.441"></a><span id="l37.441">         but hopefully all nested mimeobject point to the same displayooptions</span>
<a href="#l37.442"></a><span id="l37.442"> </span>
<a href="#l37.443"></a><span id="l37.443" class="difflineminus">-    we need to find out the nesting level of our currently displayed crypto object</span>
<a href="#l37.444"></a><span id="l37.444" class="difflineminus">-    wrt the shown part in the toplevel window</span>
<a href="#l37.445"></a><span id="l37.445" class="difflineplus">+    we need to find out the nesting level of our currently displayed crypto</span>
<a href="#l37.446"></a><span id="l37.446" class="difflineplus">+    object wrt the shown part in the toplevel window</span>
<a href="#l37.447"></a><span id="l37.447">   */</span>
<a href="#l37.448"></a><span id="l37.448"> </span>
<a href="#l37.449"></a><span id="l37.449">   // if we are showing the toplevel message, aTopMessageNestLevel == 0</span>
<a href="#l37.450"></a><span id="l37.450">   int aTopMessageNestLevel = 0;</span>
<a href="#l37.451"></a><span id="l37.451">   MimeObject *aTopShownObject = nullptr;</span>
<a href="#l37.452"></a><span id="l37.452">   if (obj &amp;&amp; obj-&gt;options-&gt;part_to_load) {</span>
<a href="#l37.453"></a><span id="l37.453">     bool aAlreadyFoundTop = false;</span>
<a href="#l37.454"></a><span id="l37.454">     for (MimeObject *walker = obj; walker; walker = walker-&gt;parent) {</span>
<a href="#l37.455"></a><span id="l37.455">       if (aAlreadyFoundTop) {</span>
<a href="#l37.456"></a><span id="l37.456" class="difflineminus">-        if (!mime_typep(walker, (MimeObjectClass *) &amp;mimeEncryptedClass)</span>
<a href="#l37.457"></a><span id="l37.457" class="difflineminus">-            &amp;&amp; !mime_typep(walker, (MimeObjectClass *) &amp;mimeMultipartSignedClass)) {</span>
<a href="#l37.458"></a><span id="l37.458" class="difflineplus">+        if (!mime_typep(walker, (MimeObjectClass *)&amp;mimeEncryptedClass) &amp;&amp;</span>
<a href="#l37.459"></a><span id="l37.459" class="difflineplus">+            !mime_typep(walker, (MimeObjectClass *)&amp;mimeMultipartSignedClass)) {</span>
<a href="#l37.460"></a><span id="l37.460">           ++aTopMessageNestLevel;</span>
<a href="#l37.461"></a><span id="l37.461">         }</span>
<a href="#l37.462"></a><span id="l37.462">       }</span>
<a href="#l37.463"></a><span id="l37.463" class="difflineminus">-      if (!aAlreadyFoundTop &amp;&amp; !strcmp(mime_part_address(walker), walker-&gt;options-&gt;part_to_load)) {</span>
<a href="#l37.464"></a><span id="l37.464" class="difflineplus">+      if (!aAlreadyFoundTop &amp;&amp;</span>
<a href="#l37.465"></a><span id="l37.465" class="difflineplus">+          !strcmp(mime_part_address(walker), walker-&gt;options-&gt;part_to_load)) {</span>
<a href="#l37.466"></a><span id="l37.466">         aAlreadyFoundTop = true;</span>
<a href="#l37.467"></a><span id="l37.467">         aTopShownObject = walker;</span>
<a href="#l37.468"></a><span id="l37.468">       }</span>
<a href="#l37.469"></a><span id="l37.469">       if (!aAlreadyFoundTop &amp;&amp; !walker-&gt;parent) {</span>
<a href="#l37.470"></a><span id="l37.470">         // The mime part part_to_load is not a parent of the</span>
<a href="#l37.471"></a><span id="l37.471">         // the crypto mime part passed in to this function as parameter obj.</span>
<a href="#l37.472"></a><span id="l37.472" class="difflineminus">-        // That means the crypto part belongs to another branch of the mime tree.</span>
<a href="#l37.473"></a><span id="l37.473" class="difflineplus">+        // That means the crypto part belongs to another branch of the mime</span>
<a href="#l37.474"></a><span id="l37.474" class="difflineplus">+        // tree.</span>
<a href="#l37.475"></a><span id="l37.475">         return -1;</span>
<a href="#l37.476"></a><span id="l37.476">       }</span>
<a href="#l37.477"></a><span id="l37.477">     }</span>
<a href="#l37.478"></a><span id="l37.478">   }</span>
<a href="#l37.479"></a><span id="l37.479"> </span>
<a href="#l37.480"></a><span id="l37.480">   bool CryptoObjectIsChildOfTopShownObject = false;</span>
<a href="#l37.481"></a><span id="l37.481">   if (!aTopShownObject) {</span>
<a href="#l37.482"></a><span id="l37.482">     // no sub part specified, top message is displayed, and</span>
<a href="#l37.483"></a><span id="l37.483" class="difflineat">@@ -390,96 +362,90 @@ int MIMEGetRelativeCryptoNestLevel(MimeO</span>
<a href="#l37.484"></a><span id="l37.484">     CryptoObjectIsChildOfTopShownObject = true;</span>
<a href="#l37.485"></a><span id="l37.485">   }</span>
<a href="#l37.486"></a><span id="l37.486"> </span>
<a href="#l37.487"></a><span id="l37.487">   // if we are the child of the topmost message, aCryptoPartNestLevel == 1</span>
<a href="#l37.488"></a><span id="l37.488">   int aCryptoPartNestLevel = 0;</span>
<a href="#l37.489"></a><span id="l37.489">   if (obj) {</span>
<a href="#l37.490"></a><span id="l37.490">     for (MimeObject *walker = obj; walker; walker = walker-&gt;parent) {</span>
<a href="#l37.491"></a><span id="l37.491">       // Crypto mime objects are transparent wrt nesting.</span>
<a href="#l37.492"></a><span id="l37.492" class="difflineminus">-      if (!mime_typep(walker, (MimeObjectClass *) &amp;mimeEncryptedClass)</span>
<a href="#l37.493"></a><span id="l37.493" class="difflineminus">-          &amp;&amp; !mime_typep(walker, (MimeObjectClass *) &amp;mimeMultipartSignedClass)) {</span>
<a href="#l37.494"></a><span id="l37.494" class="difflineplus">+      if (!mime_typep(walker, (MimeObjectClass *)&amp;mimeEncryptedClass) &amp;&amp;</span>
<a href="#l37.495"></a><span id="l37.495" class="difflineplus">+          !mime_typep(walker, (MimeObjectClass *)&amp;mimeMultipartSignedClass)) {</span>
<a href="#l37.496"></a><span id="l37.496">         ++aCryptoPartNestLevel;</span>
<a href="#l37.497"></a><span id="l37.497">       }</span>
<a href="#l37.498"></a><span id="l37.498">       if (aTopShownObject &amp;&amp; walker-&gt;parent == aTopShownObject) {</span>
<a href="#l37.499"></a><span id="l37.499">         CryptoObjectIsChildOfTopShownObject = true;</span>
<a href="#l37.500"></a><span id="l37.500">       }</span>
<a href="#l37.501"></a><span id="l37.501">     }</span>
<a href="#l37.502"></a><span id="l37.502">   }</span>
<a href="#l37.503"></a><span id="l37.503"> </span>
<a href="#l37.504"></a><span id="l37.504">   if (!CryptoObjectIsChildOfTopShownObject) {</span>
<a href="#l37.505"></a><span id="l37.505">     return -1;</span>
<a href="#l37.506"></a><span id="l37.506">   }</span>
<a href="#l37.507"></a><span id="l37.507"> </span>
<a href="#l37.508"></a><span id="l37.508">   return aCryptoPartNestLevel - aTopMessageNestLevel;</span>
<a href="#l37.509"></a><span id="l37.509"> }</span>
<a href="#l37.510"></a><span id="l37.510"> </span>
<a href="#l37.511"></a><span id="l37.511"> static void *MimeCMS_init(MimeObject *obj,</span>
<a href="#l37.512"></a><span id="l37.512" class="difflineminus">-                          int (*output_fn) (const char *buf, int32_t buf_size, void *output_closure),</span>
<a href="#l37.513"></a><span id="l37.513" class="difflineminus">-                          void *output_closure)</span>
<a href="#l37.514"></a><span id="l37.514" class="difflineminus">-{</span>
<a href="#l37.515"></a><span id="l37.515" class="difflineplus">+                          int (*output_fn)(const char *buf, int32_t buf_size,</span>
<a href="#l37.516"></a><span id="l37.516" class="difflineplus">+                                           void *output_closure),</span>
<a href="#l37.517"></a><span id="l37.517" class="difflineplus">+                          void *output_closure) {</span>
<a href="#l37.518"></a><span id="l37.518">   MimeCMSdata *data;</span>
<a href="#l37.519"></a><span id="l37.519">   nsresult rv;</span>
<a href="#l37.520"></a><span id="l37.520"> </span>
<a href="#l37.521"></a><span id="l37.521">   if (!(obj &amp;&amp; obj-&gt;options &amp;&amp; output_fn)) return 0;</span>
<a href="#l37.522"></a><span id="l37.522"> </span>
<a href="#l37.523"></a><span id="l37.523">   data = new MimeCMSdata;</span>
<a href="#l37.524"></a><span id="l37.524">   if (!data) return 0;</span>
<a href="#l37.525"></a><span id="l37.525"> </span>
<a href="#l37.526"></a><span id="l37.526">   data-&gt;self = obj;</span>
<a href="#l37.527"></a><span id="l37.527">   data-&gt;output_fn = output_fn;</span>
<a href="#l37.528"></a><span id="l37.528">   data-&gt;output_closure = output_closure;</span>
<a href="#l37.529"></a><span id="l37.529">   PR_SetError(0, 0);</span>
<a href="#l37.530"></a><span id="l37.530">   data-&gt;decoder_context = do_CreateInstance(NS_CMSDECODER_CONTRACTID, &amp;rv);</span>
<a href="#l37.531"></a><span id="l37.531" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l37.532"></a><span id="l37.532" class="difflineminus">-  {</span>
<a href="#l37.533"></a><span id="l37.533" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l37.534"></a><span id="l37.534">     delete data;</span>
<a href="#l37.535"></a><span id="l37.535">     return 0;</span>
<a href="#l37.536"></a><span id="l37.536">   }</span>
<a href="#l37.537"></a><span id="l37.537"> </span>
<a href="#l37.538"></a><span id="l37.538">   rv = data-&gt;decoder_context-&gt;Start(MimeCMS_content_callback, data);</span>
<a href="#l37.539"></a><span id="l37.539" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l37.540"></a><span id="l37.540" class="difflineminus">-  {</span>
<a href="#l37.541"></a><span id="l37.541" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l37.542"></a><span id="l37.542">     delete data;</span>
<a href="#l37.543"></a><span id="l37.543">     return 0;</span>
<a href="#l37.544"></a><span id="l37.544">   }</span>
<a href="#l37.545"></a><span id="l37.545"> </span>
<a href="#l37.546"></a><span id="l37.546">   // XXX Fix later XXX //</span>
<a href="#l37.547"></a><span id="l37.547">   data-&gt;parent_holds_stamp_p =</span>
<a href="#l37.548"></a><span id="l37.548" class="difflineminus">-  (obj-&gt;parent &amp;&amp;</span>
<a href="#l37.549"></a><span id="l37.549" class="difflineminus">-   (mime_crypto_stamped_p(obj-&gt;parent) ||</span>
<a href="#l37.550"></a><span id="l37.550" class="difflineminus">-    mime_typep(obj-&gt;parent, (MimeObjectClass *) &amp;mimeEncryptedClass)));</span>
<a href="#l37.551"></a><span id="l37.551" class="difflineplus">+      (obj-&gt;parent &amp;&amp;</span>
<a href="#l37.552"></a><span id="l37.552" class="difflineplus">+       (mime_crypto_stamped_p(obj-&gt;parent) ||</span>
<a href="#l37.553"></a><span id="l37.553" class="difflineplus">+        mime_typep(obj-&gt;parent, (MimeObjectClass *)&amp;mimeEncryptedClass)));</span>
<a href="#l37.554"></a><span id="l37.554"> </span>
<a href="#l37.555"></a><span id="l37.555">   data-&gt;parent_is_encrypted_p =</span>
<a href="#l37.556"></a><span id="l37.556" class="difflineminus">-  (obj-&gt;parent &amp;&amp; MimeEncryptedCMS_encrypted_p (obj-&gt;parent));</span>
<a href="#l37.557"></a><span id="l37.557" class="difflineplus">+      (obj-&gt;parent &amp;&amp; MimeEncryptedCMS_encrypted_p(obj-&gt;parent));</span>
<a href="#l37.558"></a><span id="l37.558"> </span>
<a href="#l37.559"></a><span id="l37.559">   /* If the parent of this object is a crypto-blob, then it's the grandparent</span>
<a href="#l37.560"></a><span id="l37.560">    who would have written out the headers and prepared for a stamp...</span>
<a href="#l37.561"></a><span id="l37.561">    (This shit sucks.)</span>
<a href="#l37.562"></a><span id="l37.562">    */</span>
<a href="#l37.563"></a><span id="l37.563" class="difflineminus">-  if (data-&gt;parent_is_encrypted_p &amp;&amp;</span>
<a href="#l37.564"></a><span id="l37.564" class="difflineminus">-    !data-&gt;parent_holds_stamp_p &amp;&amp;</span>
<a href="#l37.565"></a><span id="l37.565" class="difflineminus">-    obj-&gt;parent &amp;&amp; obj-&gt;parent-&gt;parent)</span>
<a href="#l37.566"></a><span id="l37.566" class="difflineminus">-  data-&gt;parent_holds_stamp_p =</span>
<a href="#l37.567"></a><span id="l37.567" class="difflineminus">-    mime_crypto_stamped_p (obj-&gt;parent-&gt;parent);</span>
<a href="#l37.568"></a><span id="l37.568" class="difflineplus">+  if (data-&gt;parent_is_encrypted_p &amp;&amp; !data-&gt;parent_holds_stamp_p &amp;&amp;</span>
<a href="#l37.569"></a><span id="l37.569" class="difflineplus">+      obj-&gt;parent &amp;&amp; obj-&gt;parent-&gt;parent)</span>
<a href="#l37.570"></a><span id="l37.570" class="difflineplus">+    data-&gt;parent_holds_stamp_p = mime_crypto_stamped_p(obj-&gt;parent-&gt;parent);</span>
<a href="#l37.571"></a><span id="l37.571"> </span>
<a href="#l37.572"></a><span id="l37.572" class="difflineminus">-  mime_stream_data *msd = (mime_stream_data *) (data-&gt;self-&gt;options-&gt;stream_closure);</span>
<a href="#l37.573"></a><span id="l37.573" class="difflineminus">-  if (msd)</span>
<a href="#l37.574"></a><span id="l37.574" class="difflineminus">-  {</span>
<a href="#l37.575"></a><span id="l37.575" class="difflineplus">+  mime_stream_data *msd =</span>
<a href="#l37.576"></a><span id="l37.576" class="difflineplus">+      (mime_stream_data *)(data-&gt;self-&gt;options-&gt;stream_closure);</span>
<a href="#l37.577"></a><span id="l37.577" class="difflineplus">+  if (msd) {</span>
<a href="#l37.578"></a><span id="l37.578">     nsIChannel *channel = msd-&gt;channel;  // note the lack of ref counting...</span>
<a href="#l37.579"></a><span id="l37.579" class="difflineminus">-    if (channel)</span>
<a href="#l37.580"></a><span id="l37.580" class="difflineminus">-    {</span>
<a href="#l37.581"></a><span id="l37.581" class="difflineplus">+    if (channel) {</span>
<a href="#l37.582"></a><span id="l37.582">       nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l37.583"></a><span id="l37.583">       nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l37.584"></a><span id="l37.584">       nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l37.585"></a><span id="l37.585">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl;</span>
<a href="#l37.586"></a><span id="l37.586">       nsCOMPtr&lt;nsISupports&gt; securityInfo;</span>
<a href="#l37.587"></a><span id="l37.587">       channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l37.588"></a><span id="l37.588" class="difflineminus">-      if (uri)</span>
<a href="#l37.589"></a><span id="l37.589" class="difflineminus">-      {</span>
<a href="#l37.590"></a><span id="l37.590" class="difflineplus">+      if (uri) {</span>
<a href="#l37.591"></a><span id="l37.591">         nsAutoCString urlSpec;</span>
<a href="#l37.592"></a><span id="l37.592">         rv = uri-&gt;GetSpec(urlSpec);</span>
<a href="#l37.593"></a><span id="l37.593"> </span>
<a href="#l37.594"></a><span id="l37.594">         // We only want to update the UI if the current mime transaction</span>
<a href="#l37.595"></a><span id="l37.595">         // is intended for display.</span>
<a href="#l37.596"></a><span id="l37.596">         // If the current transaction is intended for background processing,</span>
<a href="#l37.597"></a><span id="l37.597">         // we can learn that by looking at the additional header=filter</span>
<a href="#l37.598"></a><span id="l37.598">         // string contained in the URI.</span>
<a href="#l37.599"></a><span id="l37.599" class="difflineat">@@ -488,108 +454,95 @@ static void *MimeCMS_init(MimeObject *ob</span>
<a href="#l37.600"></a><span id="l37.600">         // which will prevent us from giving UI feedback.</span>
<a href="#l37.601"></a><span id="l37.601">         //</span>
<a href="#l37.602"></a><span id="l37.602">         // If we do not find header=filter, we assume the result of the</span>
<a href="#l37.603"></a><span id="l37.603">         // processing will be shown in the UI.</span>
<a href="#l37.604"></a><span id="l37.604"> </span>
<a href="#l37.605"></a><span id="l37.605">         if (!strstr(urlSpec.get(), &quot;?header=filter&quot;) &amp;&amp;</span>
<a href="#l37.606"></a><span id="l37.606">             !strstr(urlSpec.get(), &quot;&amp;header=filter&quot;) &amp;&amp;</span>
<a href="#l37.607"></a><span id="l37.607">             !strstr(urlSpec.get(), &quot;?header=attach&quot;) &amp;&amp;</span>
<a href="#l37.608"></a><span id="l37.608" class="difflineminus">-            !strstr(urlSpec.get(), &quot;&amp;header=attach&quot;))</span>
<a href="#l37.609"></a><span id="l37.609" class="difflineminus">-        {</span>
<a href="#l37.610"></a><span id="l37.610" class="difflineplus">+            !strstr(urlSpec.get(), &quot;&amp;header=attach&quot;)) {</span>
<a href="#l37.611"></a><span id="l37.611">           msgurl = do_QueryInterface(uri);</span>
<a href="#l37.612"></a><span id="l37.612" class="difflineminus">-          if (msgurl)</span>
<a href="#l37.613"></a><span id="l37.613" class="difflineminus">-            msgurl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l37.614"></a><span id="l37.614" class="difflineplus">+          if (msgurl) msgurl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l37.615"></a><span id="l37.615">           if (msgWindow)</span>
<a href="#l37.616"></a><span id="l37.616">             msgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l37.617"></a><span id="l37.617">           if (headerSink)</span>
<a href="#l37.618"></a><span id="l37.618">             headerSink-&gt;GetSecurityInfo(getter_AddRefs(securityInfo));</span>
<a href="#l37.619"></a><span id="l37.619">           if (securityInfo)</span>
<a href="#l37.620"></a><span id="l37.620">             data-&gt;smimeHeaderSink = do_QueryInterface(securityInfo);</span>
<a href="#l37.621"></a><span id="l37.621">         }</span>
<a href="#l37.622"></a><span id="l37.622">       }</span>
<a href="#l37.623"></a><span id="l37.623" class="difflineminus">-    } // if channel</span>
<a href="#l37.624"></a><span id="l37.624" class="difflineminus">-  } // if msd</span>
<a href="#l37.625"></a><span id="l37.625" class="difflineplus">+    }  // if channel</span>
<a href="#l37.626"></a><span id="l37.626" class="difflineplus">+  }    // if msd</span>
<a href="#l37.627"></a><span id="l37.627"> </span>
<a href="#l37.628"></a><span id="l37.628">   return data;</span>
<a href="#l37.629"></a><span id="l37.629"> }</span>
<a href="#l37.630"></a><span id="l37.630"> </span>
<a href="#l37.631"></a><span id="l37.631" class="difflineminus">-static int</span>
<a href="#l37.632"></a><span id="l37.632" class="difflineminus">-MimeCMS_write (const char *buf, int32_t buf_size, void *closure)</span>
<a href="#l37.633"></a><span id="l37.633" class="difflineminus">-{</span>
<a href="#l37.634"></a><span id="l37.634" class="difflineminus">-  MimeCMSdata *data = (MimeCMSdata *) closure;</span>
<a href="#l37.635"></a><span id="l37.635" class="difflineplus">+static int MimeCMS_write(const char *buf, int32_t buf_size, void *closure) {</span>
<a href="#l37.636"></a><span id="l37.636" class="difflineplus">+  MimeCMSdata *data = (MimeCMSdata *)closure;</span>
<a href="#l37.637"></a><span id="l37.637">   nsresult rv;</span>
<a href="#l37.638"></a><span id="l37.638"> </span>
<a href="#l37.639"></a><span id="l37.639">   if (!data || !data-&gt;output_fn || !data-&gt;decoder_context) return -1;</span>
<a href="#l37.640"></a><span id="l37.640"> </span>
<a href="#l37.641"></a><span id="l37.641">   PR_SetError(0, 0);</span>
<a href="#l37.642"></a><span id="l37.642">   rv = data-&gt;decoder_context-&gt;Update(buf, buf_size);</span>
<a href="#l37.643"></a><span id="l37.643">   data-&gt;decoding_failed = NS_FAILED(rv);</span>
<a href="#l37.644"></a><span id="l37.644"> </span>
<a href="#l37.645"></a><span id="l37.645">   return 0;</span>
<a href="#l37.646"></a><span id="l37.646"> }</span>
<a href="#l37.647"></a><span id="l37.647"> </span>
<a href="#l37.648"></a><span id="l37.648" class="difflineminus">-void MimeCMSGetFromSender(MimeObject *obj,</span>
<a href="#l37.649"></a><span id="l37.649" class="difflineminus">-                          nsCString &amp;from_addr,</span>
<a href="#l37.650"></a><span id="l37.650" class="difflineminus">-                          nsCString &amp;from_name,</span>
<a href="#l37.651"></a><span id="l37.651" class="difflineminus">-                          nsCString &amp;sender_addr,</span>
<a href="#l37.652"></a><span id="l37.652" class="difflineminus">-                          nsCString &amp;sender_name)</span>
<a href="#l37.653"></a><span id="l37.653" class="difflineminus">-{</span>
<a href="#l37.654"></a><span id="l37.654" class="difflineplus">+void MimeCMSGetFromSender(MimeObject *obj, nsCString &amp;from_addr,</span>
<a href="#l37.655"></a><span id="l37.655" class="difflineplus">+                          nsCString &amp;from_name, nsCString &amp;sender_addr,</span>
<a href="#l37.656"></a><span id="l37.656" class="difflineplus">+                          nsCString &amp;sender_name) {</span>
<a href="#l37.657"></a><span id="l37.657">   MimeHeaders *msg_headers = 0;</span>
<a href="#l37.658"></a><span id="l37.658"> </span>
<a href="#l37.659"></a><span id="l37.659">   /* Find the headers of the MimeMessage which is the parent (or grandparent)</span>
<a href="#l37.660"></a><span id="l37.660">    of this object (remember, crypto objects nest.) */</span>
<a href="#l37.661"></a><span id="l37.661">   MimeObject *o2 = obj;</span>
<a href="#l37.662"></a><span id="l37.662">   msg_headers = o2-&gt;headers;</span>
<a href="#l37.663"></a><span id="l37.663" class="difflineminus">-  while (o2 &amp;&amp;</span>
<a href="#l37.664"></a><span id="l37.664" class="difflineminus">-       o2-&gt;parent &amp;&amp;</span>
<a href="#l37.665"></a><span id="l37.665" class="difflineminus">-       !mime_typep(o2-&gt;parent, (MimeObjectClass *) &amp;mimeMessageClass))</span>
<a href="#l37.666"></a><span id="l37.666" class="difflineminus">-    {</span>
<a href="#l37.667"></a><span id="l37.667" class="difflineplus">+  while (o2 &amp;&amp; o2-&gt;parent &amp;&amp;</span>
<a href="#l37.668"></a><span id="l37.668" class="difflineplus">+         !mime_typep(o2-&gt;parent, (MimeObjectClass *)&amp;mimeMessageClass)) {</span>
<a href="#l37.669"></a><span id="l37.669">     o2 = o2-&gt;parent;</span>
<a href="#l37.670"></a><span id="l37.670">     msg_headers = o2-&gt;headers;</span>
<a href="#l37.671"></a><span id="l37.671" class="difflineminus">-    }</span>
<a href="#l37.672"></a><span id="l37.672" class="difflineplus">+  }</span>
<a href="#l37.673"></a><span id="l37.673"> </span>
<a href="#l37.674"></a><span id="l37.674" class="difflineminus">-  if (!msg_headers)</span>
<a href="#l37.675"></a><span id="l37.675" class="difflineminus">-    return;</span>
<a href="#l37.676"></a><span id="l37.676" class="difflineplus">+  if (!msg_headers) return;</span>
<a href="#l37.677"></a><span id="l37.677"> </span>
<a href="#l37.678"></a><span id="l37.678">   /* Find the names and addresses in the From and/or Sender fields.</span>
<a href="#l37.679"></a><span id="l37.679">    */</span>
<a href="#l37.680"></a><span id="l37.680">   nsCString s;</span>
<a href="#l37.681"></a><span id="l37.681"> </span>
<a href="#l37.682"></a><span id="l37.682">   /* Extract the name and address of the &quot;From:&quot; field. */</span>
<a href="#l37.683"></a><span id="l37.683">   s.Adopt(MimeHeaders_get(msg_headers, HEADER_FROM, false, false));</span>
<a href="#l37.684"></a><span id="l37.684" class="difflineminus">-  if (!s.IsEmpty())</span>
<a href="#l37.685"></a><span id="l37.685" class="difflineminus">-    ExtractFirstAddress(EncodedHeader(s), from_name, from_addr);</span>
<a href="#l37.686"></a><span id="l37.686" class="difflineplus">+  if (!s.IsEmpty()) ExtractFirstAddress(EncodedHeader(s), from_name, from_addr);</span>
<a href="#l37.687"></a><span id="l37.687"> </span>
<a href="#l37.688"></a><span id="l37.688">   /* Extract the name and address of the &quot;Sender:&quot; field. */</span>
<a href="#l37.689"></a><span id="l37.689">   s.Adopt(MimeHeaders_get(msg_headers, HEADER_SENDER, false, false));</span>
<a href="#l37.690"></a><span id="l37.690">   if (!s.IsEmpty())</span>
<a href="#l37.691"></a><span id="l37.691">     ExtractFirstAddress(EncodedHeader(s), sender_name, sender_addr);</span>
<a href="#l37.692"></a><span id="l37.692"> }</span>
<a href="#l37.693"></a><span id="l37.693"> </span>
<a href="#l37.694"></a><span id="l37.694" class="difflineminus">-void MimeCMSRequestAsyncSignatureVerification(nsICMSMessage *aCMSMsg,</span>
<a href="#l37.695"></a><span id="l37.695" class="difflineminus">-                                              const char *aFromAddr, const char *aFromName,</span>
<a href="#l37.696"></a><span id="l37.696" class="difflineminus">-                                              const char *aSenderAddr, const char *aSenderName,</span>
<a href="#l37.697"></a><span id="l37.697" class="difflineminus">-                                              nsIMsgSMIMEHeaderSink *aHeaderSink, int32_t aMimeNestingLevel,</span>
<a href="#l37.698"></a><span id="l37.698" class="difflineminus">-                                              unsigned char* item_data, uint32_t item_len,</span>
<a href="#l37.699"></a><span id="l37.699" class="difflineminus">-                                              int16_t digest_type)</span>
<a href="#l37.700"></a><span id="l37.700" class="difflineminus">-{</span>
<a href="#l37.701"></a><span id="l37.701" class="difflineplus">+void MimeCMSRequestAsyncSignatureVerification(</span>
<a href="#l37.702"></a><span id="l37.702" class="difflineplus">+    nsICMSMessage *aCMSMsg, const char *aFromAddr, const char *aFromName,</span>
<a href="#l37.703"></a><span id="l37.703" class="difflineplus">+    const char *aSenderAddr, const char *aSenderName,</span>
<a href="#l37.704"></a><span id="l37.704" class="difflineplus">+    nsIMsgSMIMEHeaderSink *aHeaderSink, int32_t aMimeNestingLevel,</span>
<a href="#l37.705"></a><span id="l37.705" class="difflineplus">+    unsigned char *item_data, uint32_t item_len, int16_t digest_type) {</span>
<a href="#l37.706"></a><span id="l37.706">   RefPtr&lt;nsSMimeVerificationListener&gt; listener =</span>
<a href="#l37.707"></a><span id="l37.707" class="difflineminus">-    new nsSMimeVerificationListener(aFromAddr, aFromName, aSenderAddr, aSenderName,</span>
<a href="#l37.708"></a><span id="l37.708" class="difflineminus">-                                    aHeaderSink, aMimeNestingLevel);</span>
<a href="#l37.709"></a><span id="l37.709" class="difflineplus">+      new nsSMimeVerificationListener(aFromAddr, aFromName, aSenderAddr,</span>
<a href="#l37.710"></a><span id="l37.710" class="difflineplus">+                                      aSenderName, aHeaderSink,</span>
<a href="#l37.711"></a><span id="l37.711" class="difflineplus">+                                      aMimeNestingLevel);</span>
<a href="#l37.712"></a><span id="l37.712">   if (item_data)</span>
<a href="#l37.713"></a><span id="l37.713" class="difflineminus">-    aCMSMsg-&gt;AsyncVerifyDetachedSignature(listener, item_data, item_len, digest_type);</span>
<a href="#l37.714"></a><span id="l37.714" class="difflineplus">+    aCMSMsg-&gt;AsyncVerifyDetachedSignature(listener, item_data, item_len,</span>
<a href="#l37.715"></a><span id="l37.715" class="difflineplus">+                                          digest_type);</span>
<a href="#l37.716"></a><span id="l37.716">   else</span>
<a href="#l37.717"></a><span id="l37.717">     aCMSMsg-&gt;AsyncVerifySignature(listener);</span>
<a href="#l37.718"></a><span id="l37.718"> }</span>
<a href="#l37.719"></a><span id="l37.719"> </span>
<a href="#l37.720"></a><span id="l37.720" class="difflineminus">-static int</span>
<a href="#l37.721"></a><span id="l37.721" class="difflineminus">-MimeCMS_eof (void *crypto_closure, bool abort_p)</span>
<a href="#l37.722"></a><span id="l37.722" class="difflineminus">-{</span>
<a href="#l37.723"></a><span id="l37.723" class="difflineminus">-  MimeCMSdata *data = (MimeCMSdata *) crypto_closure;</span>
<a href="#l37.724"></a><span id="l37.724" class="difflineplus">+static int MimeCMS_eof(void *crypto_closure, bool abort_p) {</span>
<a href="#l37.725"></a><span id="l37.725" class="difflineplus">+  MimeCMSdata *data = (MimeCMSdata *)crypto_closure;</span>
<a href="#l37.726"></a><span id="l37.726">   nsresult rv;</span>
<a href="#l37.727"></a><span id="l37.727">   int32_t status = nsICMSMessageErrors::SUCCESS;</span>
<a href="#l37.728"></a><span id="l37.728"> </span>
<a href="#l37.729"></a><span id="l37.729">   if (!data || !data-&gt;output_fn || !data-&gt;decoder_context) {</span>
<a href="#l37.730"></a><span id="l37.730">     return -1;</span>
<a href="#l37.731"></a><span id="l37.731">   }</span>
<a href="#l37.732"></a><span id="l37.732"> </span>
<a href="#l37.733"></a><span id="l37.733">   int aRelativeNestLevel = MIMEGetRelativeCryptoNestLevel(data-&gt;self);</span>
<a href="#l37.734"></a><span id="l37.734" class="difflineat">@@ -599,114 +552,90 @@ MimeCMS_eof (void *crypto_closure, bool </span>
<a href="#l37.735"></a><span id="l37.735">    will be someday.)</span>
<a href="#l37.736"></a><span id="l37.736"> </span>
<a href="#l37.737"></a><span id="l37.737">    We save away the value returned and will use it later to emit a</span>
<a href="#l37.738"></a><span id="l37.738">    blurb about whether the signature validation was cool.</span>
<a href="#l37.739"></a><span id="l37.739">    */</span>
<a href="#l37.740"></a><span id="l37.740"> </span>
<a href="#l37.741"></a><span id="l37.741">   PR_SetError(0, 0);</span>
<a href="#l37.742"></a><span id="l37.742">   rv = data-&gt;decoder_context-&gt;Finish(getter_AddRefs(data-&gt;content_info));</span>
<a href="#l37.743"></a><span id="l37.743" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l37.744"></a><span id="l37.744" class="difflineminus">-    status = nsICMSMessageErrors::GENERAL_ERROR;</span>
<a href="#l37.745"></a><span id="l37.745" class="difflineplus">+  if (NS_FAILED(rv)) status = nsICMSMessageErrors::GENERAL_ERROR;</span>
<a href="#l37.746"></a><span id="l37.746"> </span>
<a href="#l37.747"></a><span id="l37.747">   data-&gt;decoder_context = nullptr;</span>
<a href="#l37.748"></a><span id="l37.748"> </span>
<a href="#l37.749"></a><span id="l37.749">   nsCOMPtr&lt;nsIX509Cert&gt; certOfInterest;</span>
<a href="#l37.750"></a><span id="l37.750"> </span>
<a href="#l37.751"></a><span id="l37.751" class="difflineminus">-  if (!data-&gt;smimeHeaderSink)</span>
<a href="#l37.752"></a><span id="l37.752" class="difflineminus">-    return 0;</span>
<a href="#l37.753"></a><span id="l37.753" class="difflineplus">+  if (!data-&gt;smimeHeaderSink) return 0;</span>
<a href="#l37.754"></a><span id="l37.754"> </span>
<a href="#l37.755"></a><span id="l37.755" class="difflineminus">-  if (aRelativeNestLevel &lt; 0)</span>
<a href="#l37.756"></a><span id="l37.756" class="difflineminus">-    return 0;</span>
<a href="#l37.757"></a><span id="l37.757" class="difflineplus">+  if (aRelativeNestLevel &lt; 0) return 0;</span>
<a href="#l37.758"></a><span id="l37.758"> </span>
<a href="#l37.759"></a><span id="l37.759">   int32_t maxNestLevel = 0;</span>
<a href="#l37.760"></a><span id="l37.760">   data-&gt;smimeHeaderSink-&gt;MaxWantedNesting(&amp;maxNestLevel);</span>
<a href="#l37.761"></a><span id="l37.761"> </span>
<a href="#l37.762"></a><span id="l37.762" class="difflineminus">-  if (aRelativeNestLevel &gt; maxNestLevel)</span>
<a href="#l37.763"></a><span id="l37.763" class="difflineminus">-    return 0;</span>
<a href="#l37.764"></a><span id="l37.764" class="difflineplus">+  if (aRelativeNestLevel &gt; maxNestLevel) return 0;</span>
<a href="#l37.765"></a><span id="l37.765"> </span>
<a href="#l37.766"></a><span id="l37.766" class="difflineminus">-  if (data-&gt;decoding_failed)</span>
<a href="#l37.767"></a><span id="l37.767" class="difflineminus">-    status = nsICMSMessageErrors::GENERAL_ERROR;</span>
<a href="#l37.768"></a><span id="l37.768" class="difflineplus">+  if (data-&gt;decoding_failed) status = nsICMSMessageErrors::GENERAL_ERROR;</span>
<a href="#l37.769"></a><span id="l37.769"> </span>
<a href="#l37.770"></a><span id="l37.770" class="difflineminus">-  if (!data-&gt;content_info)</span>
<a href="#l37.771"></a><span id="l37.771" class="difflineminus">-  {</span>
<a href="#l37.772"></a><span id="l37.772" class="difflineminus">-    if (!data-&gt;decoded_bytes)</span>
<a href="#l37.773"></a><span id="l37.773" class="difflineminus">-    {</span>
<a href="#l37.774"></a><span id="l37.774" class="difflineplus">+  if (!data-&gt;content_info) {</span>
<a href="#l37.775"></a><span id="l37.775" class="difflineplus">+    if (!data-&gt;decoded_bytes) {</span>
<a href="#l37.776"></a><span id="l37.776">       // We were unable to decode any data.</span>
<a href="#l37.777"></a><span id="l37.777">       status = nsICMSMessageErrors::GENERAL_ERROR;</span>
<a href="#l37.778"></a><span id="l37.778" class="difflineminus">-    }</span>
<a href="#l37.779"></a><span id="l37.779" class="difflineminus">-    else</span>
<a href="#l37.780"></a><span id="l37.780" class="difflineminus">-    {</span>
<a href="#l37.781"></a><span id="l37.781" class="difflineplus">+    } else {</span>
<a href="#l37.782"></a><span id="l37.782">       // Some content got decoded, but we failed to decode</span>
<a href="#l37.783"></a><span id="l37.783">       // the final summary, probably we got truncated data.</span>
<a href="#l37.784"></a><span id="l37.784">       status = nsICMSMessageErrors::ENCRYPT_INCOMPLETE;</span>
<a href="#l37.785"></a><span id="l37.785">     }</span>
<a href="#l37.786"></a><span id="l37.786"> </span>
<a href="#l37.787"></a><span id="l37.787">     // Although a CMS message could be either encrypted or opaquely signed,</span>
<a href="#l37.788"></a><span id="l37.788">     // what we see is most likely encrypted, because if it were</span>
<a href="#l37.789"></a><span id="l37.789">     // signed only, we probably would have been able to decode it.</span>
<a href="#l37.790"></a><span id="l37.790"> </span>
<a href="#l37.791"></a><span id="l37.791">     data-&gt;ci_is_encrypted = true;</span>
<a href="#l37.792"></a><span id="l37.792" class="difflineminus">-  }</span>
<a href="#l37.793"></a><span id="l37.793" class="difflineminus">-  else</span>
<a href="#l37.794"></a><span id="l37.794" class="difflineminus">-  {</span>
<a href="#l37.795"></a><span id="l37.795" class="difflineplus">+  } else {</span>
<a href="#l37.796"></a><span id="l37.796">     rv = data-&gt;content_info-&gt;ContentIsEncrypted(&amp;data-&gt;ci_is_encrypted);</span>
<a href="#l37.797"></a><span id="l37.797"> </span>
<a href="#l37.798"></a><span id="l37.798">     if (NS_SUCCEEDED(rv) &amp;&amp; data-&gt;ci_is_encrypted) {</span>
<a href="#l37.799"></a><span id="l37.799">       data-&gt;content_info-&gt;GetEncryptionCert(getter_AddRefs(certOfInterest));</span>
<a href="#l37.800"></a><span id="l37.800" class="difflineminus">-    }</span>
<a href="#l37.801"></a><span id="l37.801" class="difflineminus">-    else {</span>
<a href="#l37.802"></a><span id="l37.802" class="difflineminus">-      // Existing logic in mimei assumes, if !ci_is_encrypted, then it is signed.</span>
<a href="#l37.803"></a><span id="l37.803" class="difflineminus">-      // Make sure it indeed is signed.</span>
<a href="#l37.804"></a><span id="l37.804" class="difflineplus">+    } else {</span>
<a href="#l37.805"></a><span id="l37.805" class="difflineplus">+      // Existing logic in mimei assumes, if !ci_is_encrypted, then it is</span>
<a href="#l37.806"></a><span id="l37.806" class="difflineplus">+      // signed. Make sure it indeed is signed.</span>
<a href="#l37.807"></a><span id="l37.807"> </span>
<a href="#l37.808"></a><span id="l37.808">       bool testIsSigned;</span>
<a href="#l37.809"></a><span id="l37.809">       rv = data-&gt;content_info-&gt;ContentIsSigned(&amp;testIsSigned);</span>
<a href="#l37.810"></a><span id="l37.810"> </span>
<a href="#l37.811"></a><span id="l37.811">       if (NS_FAILED(rv) || !testIsSigned) {</span>
<a href="#l37.812"></a><span id="l37.812">         // Neither signed nor encrypted?</span>
<a href="#l37.813"></a><span id="l37.813" class="difflineminus">-        // We are unable to understand what we got, do not try to indicate S/Mime status.</span>
<a href="#l37.814"></a><span id="l37.814" class="difflineplus">+        // We are unable to understand what we got, do not try to indicate</span>
<a href="#l37.815"></a><span id="l37.815" class="difflineplus">+        // S/Mime status.</span>
<a href="#l37.816"></a><span id="l37.816">         return 0;</span>
<a href="#l37.817"></a><span id="l37.817">       }</span>
<a href="#l37.818"></a><span id="l37.818"> </span>
<a href="#l37.819"></a><span id="l37.819">       nsCString from_addr;</span>
<a href="#l37.820"></a><span id="l37.820">       nsCString from_name;</span>
<a href="#l37.821"></a><span id="l37.821">       nsCString sender_addr;</span>
<a href="#l37.822"></a><span id="l37.822">       nsCString sender_name;</span>
<a href="#l37.823"></a><span id="l37.823"> </span>
<a href="#l37.824"></a><span id="l37.824" class="difflineminus">-      MimeCMSGetFromSender(data-&gt;self,</span>
<a href="#l37.825"></a><span id="l37.825" class="difflineminus">-                           from_addr, from_name,</span>
<a href="#l37.826"></a><span id="l37.826" class="difflineminus">-                           sender_addr, sender_name);</span>
<a href="#l37.827"></a><span id="l37.827" class="difflineplus">+      MimeCMSGetFromSender(data-&gt;self, from_addr, from_name, sender_addr,</span>
<a href="#l37.828"></a><span id="l37.828" class="difflineplus">+                           sender_name);</span>
<a href="#l37.829"></a><span id="l37.829"> </span>
<a href="#l37.830"></a><span id="l37.830" class="difflineminus">-      MimeCMSRequestAsyncSignatureVerification(data-&gt;content_info,</span>
<a href="#l37.831"></a><span id="l37.831" class="difflineminus">-                                               from_addr.get(), from_name.get(),</span>
<a href="#l37.832"></a><span id="l37.832" class="difflineminus">-                                               sender_addr.get(), sender_name.get(),</span>
<a href="#l37.833"></a><span id="l37.833" class="difflineminus">-                                               data-&gt;smimeHeaderSink, aRelativeNestLevel,</span>
<a href="#l37.834"></a><span id="l37.834" class="difflineminus">-                                               nullptr, 0, 0);</span>
<a href="#l37.835"></a><span id="l37.835" class="difflineplus">+      MimeCMSRequestAsyncSignatureVerification(</span>
<a href="#l37.836"></a><span id="l37.836" class="difflineplus">+          data-&gt;content_info, from_addr.get(), from_name.get(),</span>
<a href="#l37.837"></a><span id="l37.837" class="difflineplus">+          sender_addr.get(), sender_name.get(), data-&gt;smimeHeaderSink,</span>
<a href="#l37.838"></a><span id="l37.838" class="difflineplus">+          aRelativeNestLevel, nullptr, 0, 0);</span>
<a href="#l37.839"></a><span id="l37.839">     }</span>
<a href="#l37.840"></a><span id="l37.840">   }</span>
<a href="#l37.841"></a><span id="l37.841"> </span>
<a href="#l37.842"></a><span id="l37.842" class="difflineminus">-  if (data-&gt;ci_is_encrypted)</span>
<a href="#l37.843"></a><span id="l37.843" class="difflineminus">-  {</span>
<a href="#l37.844"></a><span id="l37.844" class="difflineminus">-    data-&gt;smimeHeaderSink-&gt;EncryptionStatus(</span>
<a href="#l37.845"></a><span id="l37.845" class="difflineminus">-      aRelativeNestLevel,</span>
<a href="#l37.846"></a><span id="l37.846" class="difflineminus">-      status,</span>
<a href="#l37.847"></a><span id="l37.847" class="difflineminus">-      certOfInterest</span>
<a href="#l37.848"></a><span id="l37.848" class="difflineminus">-    );</span>
<a href="#l37.849"></a><span id="l37.849" class="difflineplus">+  if (data-&gt;ci_is_encrypted) {</span>
<a href="#l37.850"></a><span id="l37.850" class="difflineplus">+    data-&gt;smimeHeaderSink-&gt;EncryptionStatus(aRelativeNestLevel, status,</span>
<a href="#l37.851"></a><span id="l37.851" class="difflineplus">+                                            certOfInterest);</span>
<a href="#l37.852"></a><span id="l37.852">   }</span>
<a href="#l37.853"></a><span id="l37.853"> </span>
<a href="#l37.854"></a><span id="l37.854">   return 0;</span>
<a href="#l37.855"></a><span id="l37.855"> }</span>
<a href="#l37.856"></a><span id="l37.856"> </span>
<a href="#l37.857"></a><span id="l37.857" class="difflineminus">-static void</span>
<a href="#l37.858"></a><span id="l37.858" class="difflineminus">-MimeCMS_free (void *crypto_closure)</span>
<a href="#l37.859"></a><span id="l37.859" class="difflineminus">-{</span>
<a href="#l37.860"></a><span id="l37.860" class="difflineminus">-  MimeCMSdata *data = (MimeCMSdata *) crypto_closure;</span>
<a href="#l37.861"></a><span id="l37.861" class="difflineplus">+static void MimeCMS_free(void *crypto_closure) {</span>
<a href="#l37.862"></a><span id="l37.862" class="difflineplus">+  MimeCMSdata *data = (MimeCMSdata *)crypto_closure;</span>
<a href="#l37.863"></a><span id="l37.863">   if (!data) return;</span>
<a href="#l37.864"></a><span id="l37.864"> </span>
<a href="#l37.865"></a><span id="l37.865">   delete data;</span>
<a href="#l37.866"></a><span id="l37.866"> }</span>
<a href="#l37.867"></a><span id="l37.867"> </span>
<a href="#l37.868"></a><span id="l37.868" class="difflineminus">-static char *</span>
<a href="#l37.869"></a><span id="l37.869" class="difflineminus">-MimeCMS_generate (void *crypto_closure)</span>
<a href="#l37.870"></a><span id="l37.870" class="difflineminus">-{</span>
<a href="#l37.871"></a><span id="l37.871" class="difflineminus">-  return nullptr;</span>
<a href="#l37.872"></a><span id="l37.872" class="difflineminus">-}</span>
<a href="#l37.873"></a><span id="l37.873" class="difflineminus">-</span>
<a href="#l37.874"></a><span id="l37.874" class="difflineplus">+static char *MimeCMS_generate(void *crypto_closure) { return nullptr; }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/mime/src/mimecms.h</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/mime/src/mimecms.h</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -3,34 +3,34 @@</span>
<a href="#l38.4"></a><span id="l38.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l38.5"></a><span id="l38.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l38.6"></a><span id="l38.6"> </span>
<a href="#l38.7"></a><span id="l38.7"> #ifndef _MIMECMS_H_</span>
<a href="#l38.8"></a><span id="l38.8"> #define _MIMECMS_H_</span>
<a href="#l38.9"></a><span id="l38.9"> </span>
<a href="#l38.10"></a><span id="l38.10"> #include &quot;mimecryp.h&quot;</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-class nsICMSMessage; // for function arguments in mimecms.h</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+class nsICMSMessage;  // for function arguments in mimecms.h</span>
<a href="#l38.14"></a><span id="l38.14"> </span>
<a href="#l38.15"></a><span id="l38.15"> /* The MimeEncryptedCMS class implements a type of MIME object where the</span>
<a href="#l38.16"></a><span id="l38.16">    object is passed through a CMS decryption engine to decrypt or verify</span>
<a href="#l38.17"></a><span id="l38.17">    signatures.  That module returns a new MIME object, which is then presented</span>
<a href="#l38.18"></a><span id="l38.18">    to the user.  See mimecryp.h for details of the general mechanism on which</span>
<a href="#l38.19"></a><span id="l38.19">    this is built.</span>
<a href="#l38.20"></a><span id="l38.20">  */</span>
<a href="#l38.21"></a><span id="l38.21"> </span>
<a href="#l38.22"></a><span id="l38.22"> typedef struct MimeEncryptedCMSClass MimeEncryptedCMSClass;</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineminus">-typedef struct MimeEncryptedCMS      MimeEncryptedCMS;</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineplus">+typedef struct MimeEncryptedCMS MimeEncryptedCMS;</span>
<a href="#l38.25"></a><span id="l38.25"> </span>
<a href="#l38.26"></a><span id="l38.26"> struct MimeEncryptedCMSClass {</span>
<a href="#l38.27"></a><span id="l38.27">   MimeEncryptedClass encrypted;</span>
<a href="#l38.28"></a><span id="l38.28"> };</span>
<a href="#l38.29"></a><span id="l38.29"> </span>
<a href="#l38.30"></a><span id="l38.30"> extern MimeEncryptedCMSClass mimeEncryptedCMSClass;</span>
<a href="#l38.31"></a><span id="l38.31"> </span>
<a href="#l38.32"></a><span id="l38.32"> struct MimeEncryptedCMS {</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-  MimeEncrypted encrypted;    /* superclass variables */</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+  MimeEncrypted encrypted; /* superclass variables */</span>
<a href="#l38.35"></a><span id="l38.35"> };</span>
<a href="#l38.36"></a><span id="l38.36"> </span>
<a href="#l38.37"></a><span id="l38.37" class="difflineminus">-#define MimeEncryptedCMSClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineminus">-  { MimeEncryptedClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineplus">+#define MimeEncryptedCMSClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineplus">+  { MimeEncryptedClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l38.41"></a><span id="l38.41"> </span>
<a href="#l38.42"></a><span id="l38.42"> #endif /* _MIMEPKCS_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/mime/src/mimecom.cpp</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/mime/src/mimecom.cpp</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1,74 +1,53 @@</span>
<a href="#l39.4"></a><span id="l39.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l39.5"></a><span id="l39.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.6"></a><span id="l39.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.7"></a><span id="l39.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.8"></a><span id="l39.8"> #include &quot;mimei.h&quot;</span>
<a href="#l39.9"></a><span id="l39.9"> #include &quot;mimeobj.h&quot;  /*  MimeObject (abstract)              */</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineminus">-#include &quot;mimecont.h&quot;  /*   |--- MimeContainer (abstract)          */</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineminus">-#include &quot;mimemult.h&quot;  /*   |     |--- MimeMultipart (abstract)      */</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-#include &quot;mimemsig.h&quot;  /*   |     |     |--- MimeMultipartSigned (abstract)*/</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-#include &quot;mimetext.h&quot;  /*   |     |--- MimeInlineText (abstract)      */</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+#include &quot;mimecont.h&quot; /*   |--- MimeContainer (abstract)          */</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+#include &quot;mimemult.h&quot; /*   |     |--- MimeMultipart (abstract)      */</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+#include &quot;mimemsig.h&quot; /*   |     |     |--- MimeMultipartSigned (abstract)*/</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+#include &quot;mimetext.h&quot; /*   |     |--- MimeInlineText (abstract)      */</span>
<a href="#l39.18"></a><span id="l39.18"> #include &quot;mimecryp.h&quot;</span>
<a href="#l39.19"></a><span id="l39.19"> #include &quot;mimecth.h&quot;</span>
<a href="#l39.20"></a><span id="l39.20"> </span>
<a href="#l39.21"></a><span id="l39.21"> /*</span>
<a href="#l39.22"></a><span id="l39.22">  * These calls are necessary to expose the object class hierarchy</span>
<a href="#l39.23"></a><span id="l39.23">  * to externally developed content type handlers.</span>
<a href="#l39.24"></a><span id="l39.24">  */</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineminus">-XPCOM_GetmimeInlineTextClass(void)</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineminus">-{</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineminus">-  return (void *) &amp;mimeInlineTextClass;</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+extern &quot;C&quot; void *XPCOM_GetmimeInlineTextClass(void) {</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineplus">+  return (void *)&amp;mimeInlineTextClass;</span>
<a href="#l39.31"></a><span id="l39.31"> }</span>
<a href="#l39.32"></a><span id="l39.32"> </span>
<a href="#l39.33"></a><span id="l39.33" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineminus">-XPCOM_GetmimeLeafClass(void)</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineminus">-{</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineminus">-  return (void *) &amp;mimeLeafClass;</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineplus">+extern &quot;C&quot; void *XPCOM_GetmimeLeafClass(void) { return (void *)&amp;mimeLeafClass; }</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineplus">+</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineplus">+extern &quot;C&quot; void *XPCOM_GetmimeObjectClass(void) {</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineplus">+  return (void *)&amp;mimeObjectClass;</span>
<a href="#l39.41"></a><span id="l39.41"> }</span>
<a href="#l39.42"></a><span id="l39.42"> </span>
<a href="#l39.43"></a><span id="l39.43" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineminus">-XPCOM_GetmimeObjectClass(void)</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineminus">-{</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineminus">-  return (void *) &amp;mimeObjectClass;</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineplus">+extern &quot;C&quot; void *XPCOM_GetmimeContainerClass(void) {</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+  return (void *)&amp;mimeContainerClass;</span>
<a href="#l39.49"></a><span id="l39.49"> }</span>
<a href="#l39.50"></a><span id="l39.50"> </span>
<a href="#l39.51"></a><span id="l39.51" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineminus">-XPCOM_GetmimeContainerClass(void)</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineminus">-{</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineminus">-  return (void *) &amp;mimeContainerClass;</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineplus">+extern &quot;C&quot; void *XPCOM_GetmimeMultipartClass(void) {</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineplus">+  return (void *)&amp;mimeMultipartClass;</span>
<a href="#l39.57"></a><span id="l39.57"> }</span>
<a href="#l39.58"></a><span id="l39.58"> </span>
<a href="#l39.59"></a><span id="l39.59" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineminus">-XPCOM_GetmimeMultipartClass(void)</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineminus">-{</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineminus">-  return (void *) &amp;mimeMultipartClass;</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+extern &quot;C&quot; void *XPCOM_GetmimeMultipartSignedClass(void) {</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+  return (void *)&amp;mimeMultipartSignedClass;</span>
<a href="#l39.65"></a><span id="l39.65"> }</span>
<a href="#l39.66"></a><span id="l39.66"> </span>
<a href="#l39.67"></a><span id="l39.67" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineminus">-XPCOM_GetmimeMultipartSignedClass(void)</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineminus">-{</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineminus">-  return (void *) &amp;mimeMultipartSignedClass;</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineplus">+extern &quot;C&quot; void *XPCOM_GetmimeEncryptedClass(void) {</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineplus">+  return (void *)&amp;mimeEncryptedClass;</span>
<a href="#l39.73"></a><span id="l39.73"> }</span>
<a href="#l39.74"></a><span id="l39.74"> </span>
<a href="#l39.75"></a><span id="l39.75" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineminus">-XPCOM_GetmimeEncryptedClass(void)</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineminus">-{</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineminus">-  return (void *) &amp;mimeEncryptedClass;</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineplus">+extern &quot;C&quot; int XPCOM_MimeObject_write(void *mimeObject, char *data,</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineplus">+                                      int32_t length, bool user_visible_p) {</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineplus">+  return MIME_MimeObject_write((MimeObject *)mimeObject, data, length,</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineplus">+                               user_visible_p);</span>
<a href="#l39.83"></a><span id="l39.83"> }</span>
<a href="#l39.84"></a><span id="l39.84"> </span>
<a href="#l39.85"></a><span id="l39.85" class="difflineminus">-extern &quot;C&quot; int</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineminus">-XPCOM_MimeObject_write(void *mimeObject,</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineminus">-                       char *data,</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineminus">-                       int32_t length,</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineminus">-                       bool user_visible_p)</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineminus">-{</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineminus">-  return MIME_MimeObject_write((MimeObject *)mimeObject, data,</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineminus">-                                length, user_visible_p);</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineplus">+extern &quot;C&quot; void *XPCOM_Mime_create(char *content_type, void *hdrs, void *opts) {</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineplus">+  return mime_create(content_type, (MimeHeaders *)hdrs,</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineplus">+                     (MimeDisplayOptions *)opts);</span>
<a href="#l39.96"></a><span id="l39.96"> }</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineminus">-</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineminus">-extern &quot;C&quot; void *</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineminus">-XPCOM_Mime_create(char *content_type, void* hdrs, void* opts)</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineminus">-{</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineminus">-  return mime_create(content_type, (MimeHeaders *)hdrs, (MimeDisplayOptions *)opts);</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/mime/src/mimecom.h</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/mime/src/mimecom.h</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -13,26 +13,25 @@</span>
<a href="#l40.4"></a><span id="l40.4"> </span>
<a href="#l40.5"></a><span id="l40.5"> /*</span>
<a href="#l40.6"></a><span id="l40.6">  * These functions are exposed by libmime to be used by content type</span>
<a href="#l40.7"></a><span id="l40.7">  * handler plugins for processing stream data.</span>
<a href="#l40.8"></a><span id="l40.8">  */</span>
<a href="#l40.9"></a><span id="l40.9"> /*</span>
<a href="#l40.10"></a><span id="l40.10">  * This is the write call for outputting processed stream data.</span>
<a href="#l40.11"></a><span id="l40.11">  */</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-extern &quot;C&quot; int  XPCOM_MimeObject_write(void *mimeObject, const char *data,</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-                                  int32_t length,</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineminus">-                                  bool user_visible_p);</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+extern &quot;C&quot; int XPCOM_MimeObject_write(void *mimeObject, const char *data,</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineplus">+                                      int32_t length, bool user_visible_p);</span>
<a href="#l40.17"></a><span id="l40.17"> /*</span>
<a href="#l40.18"></a><span id="l40.18">  * The following group of calls expose the pointers for the object</span>
<a href="#l40.19"></a><span id="l40.19">  * system within libmime.</span>
<a href="#l40.20"></a><span id="l40.20">  */</span>
<a href="#l40.21"></a><span id="l40.21"> extern &quot;C&quot; void *XPCOM_GetmimeInlineTextClass(void);</span>
<a href="#l40.22"></a><span id="l40.22"> extern &quot;C&quot; void *XPCOM_GetmimeLeafClass(void);</span>
<a href="#l40.23"></a><span id="l40.23"> extern &quot;C&quot; void *XPCOM_GetmimeObjectClass(void);</span>
<a href="#l40.24"></a><span id="l40.24"> extern &quot;C&quot; void *XPCOM_GetmimeContainerClass(void);</span>
<a href="#l40.25"></a><span id="l40.25"> extern &quot;C&quot; void *XPCOM_GetmimeMultipartClass(void);</span>
<a href="#l40.26"></a><span id="l40.26"> extern &quot;C&quot; void *XPCOM_GetmimeMultipartSignedClass(void);</span>
<a href="#l40.27"></a><span id="l40.27"> extern &quot;C&quot; void *XPCOM_GetmimeEncryptedClass(void);</span>
<a href="#l40.28"></a><span id="l40.28"> </span>
<a href="#l40.29"></a><span id="l40.29" class="difflineminus">-extern &quot;C&quot; void *XPCOM_Mime_create(char *content_type, void* hdrs, void* opts);</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineplus">+extern &quot;C&quot; void *XPCOM_Mime_create(char *content_type, void *hdrs, void *opts);</span>
<a href="#l40.31"></a><span id="l40.31"> </span>
<a href="#l40.32"></a><span id="l40.32"> #endif /* _MIMECOM_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/mime/src/mimecont.cpp</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/mime/src/mimecont.cpp</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -5,160 +5,139 @@</span>
<a href="#l41.4"></a><span id="l41.4"> #include &quot;prmem.h&quot;</span>
<a href="#l41.5"></a><span id="l41.5"> #include &quot;plstr.h&quot;</span>
<a href="#l41.6"></a><span id="l41.6"> #include &quot;prlog.h&quot;</span>
<a href="#l41.7"></a><span id="l41.7"> #include &quot;prio.h&quot;</span>
<a href="#l41.8"></a><span id="l41.8"> #include &quot;mimecont.h&quot;</span>
<a href="#l41.9"></a><span id="l41.9"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l41.10"></a><span id="l41.10"> </span>
<a href="#l41.11"></a><span id="l41.11"> #define MIME_SUPERCLASS mimeObjectClass</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-MimeDefClass(MimeContainer, MimeContainerClass,</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineminus">-       mimeContainerClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+MimeDefClass(MimeContainer, MimeContainerClass, mimeContainerClass,</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+             &amp;MIME_SUPERCLASS);</span>
<a href="#l41.16"></a><span id="l41.16"> </span>
<a href="#l41.17"></a><span id="l41.17" class="difflineminus">-static int MimeContainer_initialize (MimeObject *);</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineminus">-static void MimeContainer_finalize (MimeObject *);</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineminus">-static int MimeContainer_add_child (MimeObject *, MimeObject *);</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineminus">-static int MimeContainer_parse_eof (MimeObject *, bool);</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineminus">-static int MimeContainer_parse_end (MimeObject *, bool);</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineminus">-static bool MimeContainer_displayable_inline_p (MimeObjectClass *clazz,</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineminus">-                           MimeHeaders *hdrs);</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineplus">+static int MimeContainer_initialize(MimeObject *);</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineplus">+static void MimeContainer_finalize(MimeObject *);</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineplus">+static int MimeContainer_add_child(MimeObject *, MimeObject *);</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineplus">+static int MimeContainer_parse_eof(MimeObject *, bool);</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineplus">+static int MimeContainer_parse_end(MimeObject *, bool);</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineplus">+static bool MimeContainer_displayable_inline_p(MimeObjectClass *clazz,</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+                                               MimeHeaders *hdrs);</span>
<a href="#l41.31"></a><span id="l41.31"> </span>
<a href="#l41.32"></a><span id="l41.32"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-static int MimeContainer_debug_print (MimeObject *, PRFileDesc *, int32_t depth);</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+static int MimeContainer_debug_print(MimeObject *, PRFileDesc *, int32_t depth);</span>
<a href="#l41.35"></a><span id="l41.35"> #endif</span>
<a href="#l41.36"></a><span id="l41.36"> </span>
<a href="#l41.37"></a><span id="l41.37" class="difflineminus">-static int</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineminus">-MimeContainerClassInitialize(MimeContainerClass *clazz)</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineminus">-{</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) &amp;clazz-&gt;object;</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineplus">+static int MimeContainerClassInitialize(MimeContainerClass *clazz) {</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)&amp;clazz-&gt;object;</span>
<a href="#l41.43"></a><span id="l41.43"> </span>
<a href="#l41.44"></a><span id="l41.44" class="difflineminus">-  NS_ASSERTION(!oclass-&gt;class_initialized, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineminus">-  oclass-&gt;initialize  = MimeContainer_initialize;</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineminus">-  oclass-&gt;finalize    = MimeContainer_finalize;</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineminus">-  oclass-&gt;parse_eof   = MimeContainer_parse_eof;</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineminus">-  oclass-&gt;parse_end   = MimeContainer_parse_end;</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineplus">+  NS_ASSERTION(!oclass-&gt;class_initialized,</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineplus">+  oclass-&gt;initialize = MimeContainer_initialize;</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineplus">+  oclass-&gt;finalize = MimeContainer_finalize;</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineplus">+  oclass-&gt;parse_eof = MimeContainer_parse_eof;</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineplus">+  oclass-&gt;parse_end = MimeContainer_parse_end;</span>
<a href="#l41.55"></a><span id="l41.55">   oclass-&gt;displayable_inline_p = MimeContainer_displayable_inline_p;</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineminus">-  clazz-&gt;add_child    = MimeContainer_add_child;</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineplus">+  clazz-&gt;add_child = MimeContainer_add_child;</span>
<a href="#l41.58"></a><span id="l41.58"> </span>
<a href="#l41.59"></a><span id="l41.59"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l41.60"></a><span id="l41.60">   oclass-&gt;debug_print = MimeContainer_debug_print;</span>
<a href="#l41.61"></a><span id="l41.61"> #endif</span>
<a href="#l41.62"></a><span id="l41.62">   return 0;</span>
<a href="#l41.63"></a><span id="l41.63"> }</span>
<a href="#l41.64"></a><span id="l41.64"> </span>
<a href="#l41.65"></a><span id="l41.65" class="difflineplus">+static int MimeContainer_initialize(MimeObject *object) {</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineplus">+  /* This is an abstract class; it shouldn't be directly instantiated. */</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineplus">+  NS_ASSERTION(object-&gt;clazz != (MimeObjectClass *)&amp;mimeContainerClass,</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l41.69"></a><span id="l41.69"> </span>
<a href="#l41.70"></a><span id="l41.70" class="difflineminus">-static int</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineminus">-MimeContainer_initialize (MimeObject *object)</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineminus">-{</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineminus">-  /* This is an abstract class; it shouldn't be directly instantiated. */</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineminus">-  NS_ASSERTION(object-&gt;clazz != (MimeObjectClass *) &amp;mimeContainerClass, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineminus">-</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l41.78"></a><span id="l41.78"> }</span>
<a href="#l41.79"></a><span id="l41.79"> </span>
<a href="#l41.80"></a><span id="l41.80" class="difflineminus">-static void</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineminus">-MimeContainer_finalize (MimeObject *object)</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineminus">-{</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) object;</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineplus">+static void MimeContainer_finalize(MimeObject *object) {</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)object;</span>
<a href="#l41.86"></a><span id="l41.86"> </span>
<a href="#l41.87"></a><span id="l41.87">   /* Do this first so that children have their parse_eof methods called</span>
<a href="#l41.88"></a><span id="l41.88">    in forward order (0-N) but are destroyed in backward order (N-0)</span>
<a href="#l41.89"></a><span id="l41.89">    */</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineminus">-  if (!object-&gt;closed_p)</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineminus">-  object-&gt;clazz-&gt;parse_eof (object, false);</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineminus">-  if (!object-&gt;parsed_p)</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineminus">-  object-&gt;clazz-&gt;parse_end (object, false);</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineplus">+  if (!object-&gt;closed_p) object-&gt;clazz-&gt;parse_eof(object, false);</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineplus">+  if (!object-&gt;parsed_p) object-&gt;clazz-&gt;parse_end(object, false);</span>
<a href="#l41.96"></a><span id="l41.96"> </span>
<a href="#l41.97"></a><span id="l41.97" class="difflineminus">-  if (cont-&gt;children)</span>
<a href="#l41.98"></a><span id="l41.98" class="difflineminus">-  {</span>
<a href="#l41.99"></a><span id="l41.99" class="difflineplus">+  if (cont-&gt;children) {</span>
<a href="#l41.100"></a><span id="l41.100">     int i;</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineminus">-    for (i = cont-&gt;nchildren-1; i &gt;= 0; i--)</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineminus">-    {</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineplus">+    for (i = cont-&gt;nchildren - 1; i &gt;= 0; i--) {</span>
<a href="#l41.104"></a><span id="l41.104">       MimeObject *kid = cont-&gt;children[i];</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineminus">-      if (kid)</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineminus">-      mime_free(kid);</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineplus">+      if (kid) mime_free(kid);</span>
<a href="#l41.108"></a><span id="l41.108">       cont-&gt;children[i] = 0;</span>
<a href="#l41.109"></a><span id="l41.109">     }</span>
<a href="#l41.110"></a><span id="l41.110">     PR_FREEIF(cont-&gt;children);</span>
<a href="#l41.111"></a><span id="l41.111">     cont-&gt;nchildren = 0;</span>
<a href="#l41.112"></a><span id="l41.112">   }</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l41.115"></a><span id="l41.115"> }</span>
<a href="#l41.116"></a><span id="l41.116"> </span>
<a href="#l41.117"></a><span id="l41.117" class="difflineminus">-static int</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineminus">-MimeContainer_parse_eof (MimeObject *object, bool abort_p)</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineminus">-{</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) object;</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineplus">+static int MimeContainer_parse_eof(MimeObject *object, bool abort_p) {</span>
<a href="#l41.122"></a><span id="l41.122" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)object;</span>
<a href="#l41.123"></a><span id="l41.123">   int status;</span>
<a href="#l41.124"></a><span id="l41.124"> </span>
<a href="#l41.125"></a><span id="l41.125">   /* We must run all of this object's parent methods first, to get all the</span>
<a href="#l41.126"></a><span id="l41.126">    data flushed down its stream, so that the children's parse_eof methods</span>
<a href="#l41.127"></a><span id="l41.127">    can access it.  We do not access *this* object again after doing this,</span>
<a href="#l41.128"></a><span id="l41.128">    only its children.</span>
<a href="#l41.129"></a><span id="l41.129">    */</span>
<a href="#l41.130"></a><span id="l41.130" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(object, abort_p);</span>
<a href="#l41.131"></a><span id="l41.131" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(object, abort_p);</span>
<a href="#l41.132"></a><span id="l41.132">   if (status &lt; 0) return status;</span>
<a href="#l41.133"></a><span id="l41.133"> </span>
<a href="#l41.134"></a><span id="l41.134" class="difflineminus">-  if (cont-&gt;children)</span>
<a href="#l41.135"></a><span id="l41.135" class="difflineminus">-  {</span>
<a href="#l41.136"></a><span id="l41.136" class="difflineplus">+  if (cont-&gt;children) {</span>
<a href="#l41.137"></a><span id="l41.137">     int i;</span>
<a href="#l41.138"></a><span id="l41.138" class="difflineminus">-    for (i = 0; i &lt; cont-&gt;nchildren; i++)</span>
<a href="#l41.139"></a><span id="l41.139" class="difflineminus">-    {</span>
<a href="#l41.140"></a><span id="l41.140" class="difflineplus">+    for (i = 0; i &lt; cont-&gt;nchildren; i++) {</span>
<a href="#l41.141"></a><span id="l41.141">       MimeObject *kid = cont-&gt;children[i];</span>
<a href="#l41.142"></a><span id="l41.142" class="difflineminus">-      if (kid &amp;&amp; !kid-&gt;closed_p)</span>
<a href="#l41.143"></a><span id="l41.143" class="difflineminus">-      {</span>
<a href="#l41.144"></a><span id="l41.144" class="difflineplus">+      if (kid &amp;&amp; !kid-&gt;closed_p) {</span>
<a href="#l41.145"></a><span id="l41.145">         int lstatus = kid-&gt;clazz-&gt;parse_eof(kid, abort_p);</span>
<a href="#l41.146"></a><span id="l41.146">         if (lstatus &lt; 0) return lstatus;</span>
<a href="#l41.147"></a><span id="l41.147">       }</span>
<a href="#l41.148"></a><span id="l41.148">     }</span>
<a href="#l41.149"></a><span id="l41.149">   }</span>
<a href="#l41.150"></a><span id="l41.150">   return 0;</span>
<a href="#l41.151"></a><span id="l41.151"> }</span>
<a href="#l41.152"></a><span id="l41.152"> </span>
<a href="#l41.153"></a><span id="l41.153" class="difflineminus">-static int</span>
<a href="#l41.154"></a><span id="l41.154" class="difflineminus">-MimeContainer_parse_end (MimeObject *object, bool abort_p)</span>
<a href="#l41.155"></a><span id="l41.155" class="difflineminus">-{</span>
<a href="#l41.156"></a><span id="l41.156" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) object;</span>
<a href="#l41.157"></a><span id="l41.157" class="difflineplus">+static int MimeContainer_parse_end(MimeObject *object, bool abort_p) {</span>
<a href="#l41.158"></a><span id="l41.158" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)object;</span>
<a href="#l41.159"></a><span id="l41.159">   int status;</span>
<a href="#l41.160"></a><span id="l41.160"> </span>
<a href="#l41.161"></a><span id="l41.161">   /* We must run all of this object's parent methods first, to get all the</span>
<a href="#l41.162"></a><span id="l41.162">    data flushed down its stream, so that the children's parse_eof methods</span>
<a href="#l41.163"></a><span id="l41.163">    can access it.  We do not access *this* object again after doing this,</span>
<a href="#l41.164"></a><span id="l41.164">    only its children.</span>
<a href="#l41.165"></a><span id="l41.165">    */</span>
<a href="#l41.166"></a><span id="l41.166" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_end(object, abort_p);</span>
<a href="#l41.167"></a><span id="l41.167" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_end(object, abort_p);</span>
<a href="#l41.168"></a><span id="l41.168">   if (status &lt; 0) return status;</span>
<a href="#l41.169"></a><span id="l41.169"> </span>
<a href="#l41.170"></a><span id="l41.170" class="difflineminus">-  if (cont-&gt;children)</span>
<a href="#l41.171"></a><span id="l41.171" class="difflineminus">-  {</span>
<a href="#l41.172"></a><span id="l41.172" class="difflineplus">+  if (cont-&gt;children) {</span>
<a href="#l41.173"></a><span id="l41.173">     int i;</span>
<a href="#l41.174"></a><span id="l41.174" class="difflineminus">-    for (i = 0; i &lt; cont-&gt;nchildren; i++)</span>
<a href="#l41.175"></a><span id="l41.175" class="difflineminus">-    {</span>
<a href="#l41.176"></a><span id="l41.176" class="difflineplus">+    for (i = 0; i &lt; cont-&gt;nchildren; i++) {</span>
<a href="#l41.177"></a><span id="l41.177">       MimeObject *kid = cont-&gt;children[i];</span>
<a href="#l41.178"></a><span id="l41.178" class="difflineminus">-      if (kid &amp;&amp; !kid-&gt;parsed_p)</span>
<a href="#l41.179"></a><span id="l41.179" class="difflineminus">-      {</span>
<a href="#l41.180"></a><span id="l41.180" class="difflineplus">+      if (kid &amp;&amp; !kid-&gt;parsed_p) {</span>
<a href="#l41.181"></a><span id="l41.181">         int lstatus = kid-&gt;clazz-&gt;parse_end(kid, abort_p);</span>
<a href="#l41.182"></a><span id="l41.182">         if (lstatus &lt; 0) return lstatus;</span>
<a href="#l41.183"></a><span id="l41.183">       }</span>
<a href="#l41.184"></a><span id="l41.184">     }</span>
<a href="#l41.185"></a><span id="l41.185">   }</span>
<a href="#l41.186"></a><span id="l41.186">   return 0;</span>
<a href="#l41.187"></a><span id="l41.187"> }</span>
<a href="#l41.188"></a><span id="l41.188"> </span>
<a href="#l41.189"></a><span id="l41.189" class="difflineminus">-static int</span>
<a href="#l41.190"></a><span id="l41.190" class="difflineminus">-MimeContainer_add_child (MimeObject *parent, MimeObject *child)</span>
<a href="#l41.191"></a><span id="l41.191" class="difflineminus">-{</span>
<a href="#l41.192"></a><span id="l41.192" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) parent;</span>
<a href="#l41.193"></a><span id="l41.193" class="difflineplus">+static int MimeContainer_add_child(MimeObject *parent, MimeObject *child) {</span>
<a href="#l41.194"></a><span id="l41.194" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)parent;</span>
<a href="#l41.195"></a><span id="l41.195">   MimeObject **old_kids, **new_kids;</span>
<a href="#l41.196"></a><span id="l41.196"> </span>
<a href="#l41.197"></a><span id="l41.197">   NS_ASSERTION(parent &amp;&amp; child, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l41.198"></a><span id="l41.198">   if (!parent || !child) return -1;</span>
<a href="#l41.199"></a><span id="l41.199"> </span>
<a href="#l41.200"></a><span id="l41.200">   old_kids = cont-&gt;children;</span>
<a href="#l41.201"></a><span id="l41.201" class="difflineminus">-  new_kids = (MimeObject **)PR_MALLOC(sizeof(MimeObject *) * (cont-&gt;nchildren + 1));</span>
<a href="#l41.202"></a><span id="l41.202" class="difflineplus">+  new_kids =</span>
<a href="#l41.203"></a><span id="l41.203" class="difflineplus">+      (MimeObject **)PR_MALLOC(sizeof(MimeObject *) * (cont-&gt;nchildren + 1));</span>
<a href="#l41.204"></a><span id="l41.204">   if (!new_kids) return MIME_OUT_OF_MEMORY;</span>
<a href="#l41.205"></a><span id="l41.205"> </span>
<a href="#l41.206"></a><span id="l41.206">   if (cont-&gt;nchildren &gt; 0)</span>
<a href="#l41.207"></a><span id="l41.207">     memcpy(new_kids, old_kids, sizeof(MimeObject *) * cont-&gt;nchildren);</span>
<a href="#l41.208"></a><span id="l41.208">   new_kids[cont-&gt;nchildren] = child;</span>
<a href="#l41.209"></a><span id="l41.209">   PR_Free(old_kids);</span>
<a href="#l41.210"></a><span id="l41.210">   cont-&gt;children = new_kids;</span>
<a href="#l41.211"></a><span id="l41.211">   cont-&gt;nchildren++;</span>
<a href="#l41.212"></a><span id="l41.212" class="difflineat">@@ -166,53 +145,48 @@ MimeContainer_add_child (MimeObject *par</span>
<a href="#l41.213"></a><span id="l41.213">   child-&gt;parent = parent;</span>
<a href="#l41.214"></a><span id="l41.214"> </span>
<a href="#l41.215"></a><span id="l41.215">   /* Copy this object's options into the child. */</span>
<a href="#l41.216"></a><span id="l41.216">   child-&gt;options = parent-&gt;options;</span>
<a href="#l41.217"></a><span id="l41.217"> </span>
<a href="#l41.218"></a><span id="l41.218">   return 0;</span>
<a href="#l41.219"></a><span id="l41.219"> }</span>
<a href="#l41.220"></a><span id="l41.220"> </span>
<a href="#l41.221"></a><span id="l41.221" class="difflineminus">-static bool</span>
<a href="#l41.222"></a><span id="l41.222" class="difflineminus">-MimeContainer_displayable_inline_p (MimeObjectClass *clazz, MimeHeaders *hdrs)</span>
<a href="#l41.223"></a><span id="l41.223" class="difflineminus">-{</span>
<a href="#l41.224"></a><span id="l41.224" class="difflineplus">+static bool MimeContainer_displayable_inline_p(MimeObjectClass *clazz,</span>
<a href="#l41.225"></a><span id="l41.225" class="difflineplus">+                                               MimeHeaders *hdrs) {</span>
<a href="#l41.226"></a><span id="l41.226">   return true;</span>
<a href="#l41.227"></a><span id="l41.227"> }</span>
<a href="#l41.228"></a><span id="l41.228"> </span>
<a href="#l41.229"></a><span id="l41.229" class="difflineminus">-</span>
<a href="#l41.230"></a><span id="l41.230"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l41.231"></a><span id="l41.231" class="difflineminus">-static int</span>
<a href="#l41.232"></a><span id="l41.232" class="difflineminus">-MimeContainer_debug_print (MimeObject *obj, PRFileDesc *stream, int32_t depth)</span>
<a href="#l41.233"></a><span id="l41.233" class="difflineminus">-{</span>
<a href="#l41.234"></a><span id="l41.234" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) obj;</span>
<a href="#l41.235"></a><span id="l41.235" class="difflineplus">+static int MimeContainer_debug_print(MimeObject *obj, PRFileDesc *stream,</span>
<a href="#l41.236"></a><span id="l41.236" class="difflineplus">+                                     int32_t depth) {</span>
<a href="#l41.237"></a><span id="l41.237" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l41.238"></a><span id="l41.238">   int i;</span>
<a href="#l41.239"></a><span id="l41.239">   char *addr = mime_part_address(obj);</span>
<a href="#l41.240"></a><span id="l41.240" class="difflineminus">-  for (i=0; i &lt; depth; i++)</span>
<a href="#l41.241"></a><span id="l41.241" class="difflineminus">-  PR_Write(stream, &quot;  &quot;, 2);</span>
<a href="#l41.242"></a><span id="l41.242" class="difflineplus">+  for (i = 0; i &lt; depth; i++) PR_Write(stream, &quot;  &quot;, 2);</span>
<a href="#l41.243"></a><span id="l41.243">   /*</span>
<a href="#l41.244"></a><span id="l41.244">   PR_Write(stream, &quot;&lt;%s %s (%d kid%s) 0x%08X&gt;\n&quot;,</span>
<a href="#l41.245"></a><span id="l41.245">       obj-&gt;clazz-&gt;class_name,</span>
<a href="#l41.246"></a><span id="l41.246">       addr ? addr : &quot;???&quot;,</span>
<a href="#l41.247"></a><span id="l41.247">       cont-&gt;nchildren, (cont-&gt;nchildren == 1 ? &quot;&quot; : &quot;s&quot;),</span>
<a href="#l41.248"></a><span id="l41.248">       (uint32_t) cont);</span>
<a href="#l41.249"></a><span id="l41.249">   */</span>
<a href="#l41.250"></a><span id="l41.250">   PR_FREEIF(addr);</span>
<a href="#l41.251"></a><span id="l41.251"> </span>
<a href="#l41.252"></a><span id="l41.252" class="difflineminus">-/*</span>
<a href="#l41.253"></a><span id="l41.253" class="difflineminus">-  if (cont-&gt;nchildren &gt; 0)</span>
<a href="#l41.254"></a><span id="l41.254" class="difflineminus">-  fprintf(stream, &quot;\n&quot;);</span>
<a href="#l41.255"></a><span id="l41.255" class="difflineminus">- */</span>
<a href="#l41.256"></a><span id="l41.256" class="difflineplus">+  /*</span>
<a href="#l41.257"></a><span id="l41.257" class="difflineplus">+    if (cont-&gt;nchildren &gt; 0)</span>
<a href="#l41.258"></a><span id="l41.258" class="difflineplus">+    fprintf(stream, &quot;\n&quot;);</span>
<a href="#l41.259"></a><span id="l41.259" class="difflineplus">+   */</span>
<a href="#l41.260"></a><span id="l41.260"> </span>
<a href="#l41.261"></a><span id="l41.261" class="difflineminus">-  for (i = 0; i &lt; cont-&gt;nchildren; i++)</span>
<a href="#l41.262"></a><span id="l41.262" class="difflineminus">-  {</span>
<a href="#l41.263"></a><span id="l41.263" class="difflineplus">+  for (i = 0; i &lt; cont-&gt;nchildren; i++) {</span>
<a href="#l41.264"></a><span id="l41.264">     MimeObject *kid = cont-&gt;children[i];</span>
<a href="#l41.265"></a><span id="l41.265" class="difflineminus">-    int status = kid-&gt;clazz-&gt;debug_print (kid, stream, depth+1);</span>
<a href="#l41.266"></a><span id="l41.266" class="difflineplus">+    int status = kid-&gt;clazz-&gt;debug_print(kid, stream, depth + 1);</span>
<a href="#l41.267"></a><span id="l41.267">     if (status &lt; 0) return status;</span>
<a href="#l41.268"></a><span id="l41.268">   }</span>
<a href="#l41.269"></a><span id="l41.269"> </span>
<a href="#l41.270"></a><span id="l41.270" class="difflineminus">-/*</span>
<a href="#l41.271"></a><span id="l41.271" class="difflineminus">-  if (cont-&gt;nchildren &gt; 0)</span>
<a href="#l41.272"></a><span id="l41.272" class="difflineminus">-  fprintf(stream, &quot;\n&quot;);</span>
<a href="#l41.273"></a><span id="l41.273" class="difflineminus">- */</span>
<a href="#l41.274"></a><span id="l41.274" class="difflineplus">+  /*</span>
<a href="#l41.275"></a><span id="l41.275" class="difflineplus">+    if (cont-&gt;nchildren &gt; 0)</span>
<a href="#l41.276"></a><span id="l41.276" class="difflineplus">+    fprintf(stream, &quot;\n&quot;);</span>
<a href="#l41.277"></a><span id="l41.277" class="difflineplus">+   */</span>
<a href="#l41.278"></a><span id="l41.278"> </span>
<a href="#l41.279"></a><span id="l41.279">   return 0;</span>
<a href="#l41.280"></a><span id="l41.280"> }</span>
<a href="#l41.281"></a><span id="l41.281"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/mime/src/mimecont.h</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/mime/src/mimecont.h</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -16,28 +16,28 @@</span>
<a href="#l42.4"></a><span id="l42.4"> </span>
<a href="#l42.5"></a><span id="l42.5">      Given a parent (a subclass of MimeContainer) this method adds the</span>
<a href="#l42.6"></a><span id="l42.6">      child (any MIME object) to the parent's list of children.</span>
<a href="#l42.7"></a><span id="l42.7"> </span>
<a href="#l42.8"></a><span id="l42.8">      The MimeContainer `finalize' method will finalize the children as well.</span>
<a href="#l42.9"></a><span id="l42.9">  */</span>
<a href="#l42.10"></a><span id="l42.10"> </span>
<a href="#l42.11"></a><span id="l42.11"> typedef struct MimeContainerClass MimeContainerClass;</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-typedef struct MimeContainer      MimeContainer;</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+typedef struct MimeContainer MimeContainer;</span>
<a href="#l42.14"></a><span id="l42.14"> </span>
<a href="#l42.15"></a><span id="l42.15"> struct MimeContainerClass {</span>
<a href="#l42.16"></a><span id="l42.16">   MimeObjectClass object;</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineminus">-  int (*add_child) (MimeObject *parent, MimeObject *child);</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+  int (*add_child)(MimeObject *parent, MimeObject *child);</span>
<a href="#l42.19"></a><span id="l42.19"> };</span>
<a href="#l42.20"></a><span id="l42.20"> </span>
<a href="#l42.21"></a><span id="l42.21"> extern MimeContainerClass mimeContainerClass;</span>
<a href="#l42.22"></a><span id="l42.22"> </span>
<a href="#l42.23"></a><span id="l42.23"> struct MimeContainer {</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineminus">-  MimeObject object;    /* superclass variables */</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineplus">+  MimeObject object; /* superclass variables */</span>
<a href="#l42.26"></a><span id="l42.26"> </span>
<a href="#l42.27"></a><span id="l42.27" class="difflineminus">-  MimeObject **children;  /* list of contained objects */</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineminus">-  int32_t nchildren;      /* how many */</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineplus">+  MimeObject **children; /* list of contained objects */</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineplus">+  int32_t nchildren;     /* how many */</span>
<a href="#l42.31"></a><span id="l42.31"> };</span>
<a href="#l42.32"></a><span id="l42.32"> </span>
<a href="#l42.33"></a><span id="l42.33" class="difflineminus">-#define MimeContainerClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineminus">-  { MimeObjectClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineplus">+#define MimeContainerClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+  { MimeObjectClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l42.37"></a><span id="l42.37"> </span>
<a href="#l42.38"></a><span id="l42.38"> #endif /* _MIMECONT_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/mime/src/mimecryp.cpp</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/mime/src/mimecryp.cpp</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -7,545 +7,467 @@</span>
<a href="#l43.4"></a><span id="l43.4"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l43.5"></a><span id="l43.5"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l43.6"></a><span id="l43.6"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l43.7"></a><span id="l43.7"> #include &quot;mimebuf.h&quot;</span>
<a href="#l43.8"></a><span id="l43.8"> #include &quot;prmem.h&quot;</span>
<a href="#l43.9"></a><span id="l43.9"> #include &quot;plstr.h&quot;</span>
<a href="#l43.10"></a><span id="l43.10"> #include &quot;prlog.h&quot;</span>
<a href="#l43.11"></a><span id="l43.11"> #include &quot;mimemult.h&quot;</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-#include &quot;modmimee.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+#include &quot;modmimee.h&quot;  // for MimeConverterOutputCallback</span>
<a href="#l43.14"></a><span id="l43.14"> </span>
<a href="#l43.15"></a><span id="l43.15"> #define MIME_SUPERCLASS mimeContainerClass</span>
<a href="#l43.16"></a><span id="l43.16"> MimeDefClass(MimeEncrypted, MimeEncryptedClass, mimeEncryptedClass,</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineminus">-       &amp;MIME_SUPERCLASS);</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+             &amp;MIME_SUPERCLASS);</span>
<a href="#l43.19"></a><span id="l43.19"> </span>
<a href="#l43.20"></a><span id="l43.20" class="difflineminus">-static int MimeEncrypted_initialize (MimeObject *);</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineminus">-static void MimeEncrypted_finalize (MimeObject *);</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineminus">-static int MimeEncrypted_parse_begin (MimeObject *);</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineminus">-static int MimeEncrypted_parse_buffer (const char *, int32_t, MimeObject *);</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineminus">-static int MimeEncrypted_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineminus">-static int MimeEncrypted_parse_decoded_buffer (const char *, int32_t, MimeObject *);</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineminus">-static int MimeEncrypted_parse_eof (MimeObject *, bool);</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineminus">-static int MimeEncrypted_parse_end (MimeObject *, bool);</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineminus">-static int MimeEncrypted_add_child (MimeObject *, MimeObject *);</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineplus">+static int MimeEncrypted_initialize(MimeObject *);</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineplus">+static void MimeEncrypted_finalize(MimeObject *);</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineplus">+static int MimeEncrypted_parse_begin(MimeObject *);</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+static int MimeEncrypted_parse_buffer(const char *, int32_t, MimeObject *);</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineplus">+static int MimeEncrypted_parse_line(const char *, int32_t, MimeObject *);</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+static int MimeEncrypted_parse_decoded_buffer(const char *, int32_t,</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineplus">+                                              MimeObject *);</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+static int MimeEncrypted_parse_eof(MimeObject *, bool);</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineplus">+static int MimeEncrypted_parse_end(MimeObject *, bool);</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineplus">+static int MimeEncrypted_add_child(MimeObject *, MimeObject *);</span>
<a href="#l43.39"></a><span id="l43.39"> </span>
<a href="#l43.40"></a><span id="l43.40" class="difflineminus">-static int MimeHandleDecryptedOutput (const char *, int32_t, void *);</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineminus">-static int MimeHandleDecryptedOutputLine (char *, int32_t, MimeObject *);</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineminus">-static int MimeEncrypted_close_headers (MimeObject *);</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineplus">+static int MimeHandleDecryptedOutput(const char *, int32_t, void *);</span>
<a href="#l43.44"></a><span id="l43.44" class="difflineplus">+static int MimeHandleDecryptedOutputLine(char *, int32_t, MimeObject *);</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineplus">+static int MimeEncrypted_close_headers(MimeObject *);</span>
<a href="#l43.46"></a><span id="l43.46"> static int MimeEncrypted_emit_buffered_child(MimeObject *);</span>
<a href="#l43.47"></a><span id="l43.47"> </span>
<a href="#l43.48"></a><span id="l43.48" class="difflineminus">-static int</span>
<a href="#l43.49"></a><span id="l43.49" class="difflineminus">-MimeEncryptedClassInitialize(MimeEncryptedClass *clazz)</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineminus">-{</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineminus">-  MimeObjectClass    *oclass = (MimeObjectClass *)    clazz;</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineminus">-  MimeContainerClass *cclass = (MimeContainerClass *) clazz;</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineplus">+static int MimeEncryptedClassInitialize(MimeEncryptedClass *clazz) {</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineplus">+  MimeContainerClass *cclass = (MimeContainerClass *)clazz;</span>
<a href="#l43.56"></a><span id="l43.56"> </span>
<a href="#l43.57"></a><span id="l43.57" class="difflineminus">-  NS_ASSERTION(!oclass-&gt;class_initialized, &quot;1.2 &lt;mscott@netscape.com&gt; 01 Nov 2001 17:59&quot;);</span>
<a href="#l43.58"></a><span id="l43.58" class="difflineminus">-  oclass-&gt;initialize   = MimeEncrypted_initialize;</span>
<a href="#l43.59"></a><span id="l43.59" class="difflineminus">-  oclass-&gt;finalize     = MimeEncrypted_finalize;</span>
<a href="#l43.60"></a><span id="l43.60" class="difflineminus">-  oclass-&gt;parse_begin  = MimeEncrypted_parse_begin;</span>
<a href="#l43.61"></a><span id="l43.61" class="difflineplus">+  NS_ASSERTION(!oclass-&gt;class_initialized,</span>
<a href="#l43.62"></a><span id="l43.62" class="difflineplus">+               &quot;1.2 &lt;mscott@netscape.com&gt; 01 Nov 2001 17:59&quot;);</span>
<a href="#l43.63"></a><span id="l43.63" class="difflineplus">+  oclass-&gt;initialize = MimeEncrypted_initialize;</span>
<a href="#l43.64"></a><span id="l43.64" class="difflineplus">+  oclass-&gt;finalize = MimeEncrypted_finalize;</span>
<a href="#l43.65"></a><span id="l43.65" class="difflineplus">+  oclass-&gt;parse_begin = MimeEncrypted_parse_begin;</span>
<a href="#l43.66"></a><span id="l43.66">   oclass-&gt;parse_buffer = MimeEncrypted_parse_buffer;</span>
<a href="#l43.67"></a><span id="l43.67" class="difflineminus">-  oclass-&gt;parse_line   = MimeEncrypted_parse_line;</span>
<a href="#l43.68"></a><span id="l43.68" class="difflineminus">-  oclass-&gt;parse_eof    = MimeEncrypted_parse_eof;</span>
<a href="#l43.69"></a><span id="l43.69" class="difflineminus">-  oclass-&gt;parse_end    = MimeEncrypted_parse_end;</span>
<a href="#l43.70"></a><span id="l43.70" class="difflineplus">+  oclass-&gt;parse_line = MimeEncrypted_parse_line;</span>
<a href="#l43.71"></a><span id="l43.71" class="difflineplus">+  oclass-&gt;parse_eof = MimeEncrypted_parse_eof;</span>
<a href="#l43.72"></a><span id="l43.72" class="difflineplus">+  oclass-&gt;parse_end = MimeEncrypted_parse_end;</span>
<a href="#l43.73"></a><span id="l43.73"> </span>
<a href="#l43.74"></a><span id="l43.74" class="difflineminus">-  cclass-&gt;add_child    = MimeEncrypted_add_child;</span>
<a href="#l43.75"></a><span id="l43.75" class="difflineplus">+  cclass-&gt;add_child = MimeEncrypted_add_child;</span>
<a href="#l43.76"></a><span id="l43.76"> </span>
<a href="#l43.77"></a><span id="l43.77">   clazz-&gt;parse_decoded_buffer = MimeEncrypted_parse_decoded_buffer;</span>
<a href="#l43.78"></a><span id="l43.78"> </span>
<a href="#l43.79"></a><span id="l43.79">   return 0;</span>
<a href="#l43.80"></a><span id="l43.80"> }</span>
<a href="#l43.81"></a><span id="l43.81"> </span>
<a href="#l43.82"></a><span id="l43.82" class="difflineminus">-</span>
<a href="#l43.83"></a><span id="l43.83" class="difflineminus">-static int</span>
<a href="#l43.84"></a><span id="l43.84" class="difflineminus">-MimeEncrypted_initialize (MimeObject *obj)</span>
<a href="#l43.85"></a><span id="l43.85" class="difflineminus">-{</span>
<a href="#l43.86"></a><span id="l43.86" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(obj);</span>
<a href="#l43.87"></a><span id="l43.87" class="difflineplus">+static int MimeEncrypted_initialize(MimeObject *obj) {</span>
<a href="#l43.88"></a><span id="l43.88" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(obj);</span>
<a href="#l43.89"></a><span id="l43.89"> }</span>
<a href="#l43.90"></a><span id="l43.90"> </span>
<a href="#l43.91"></a><span id="l43.91" class="difflineminus">-</span>
<a href="#l43.92"></a><span id="l43.92" class="difflineminus">-static int</span>
<a href="#l43.93"></a><span id="l43.93" class="difflineminus">-MimeEncrypted_parse_begin (MimeObject *obj)</span>
<a href="#l43.94"></a><span id="l43.94" class="difflineminus">-{</span>
<a href="#l43.95"></a><span id="l43.95" class="difflineminus">-  MimeEncrypted *enc = (MimeEncrypted *) obj;</span>
<a href="#l43.96"></a><span id="l43.96" class="difflineminus">-  MimeDecoderData *(*fn) (MimeConverterOutputCallback, void*) = 0;</span>
<a href="#l43.97"></a><span id="l43.97" class="difflineplus">+static int MimeEncrypted_parse_begin(MimeObject *obj) {</span>
<a href="#l43.98"></a><span id="l43.98" class="difflineplus">+  MimeEncrypted *enc = (MimeEncrypted *)obj;</span>
<a href="#l43.99"></a><span id="l43.99" class="difflineplus">+  MimeDecoderData *(*fn)(MimeConverterOutputCallback, void *) = 0;</span>
<a href="#l43.100"></a><span id="l43.100"> </span>
<a href="#l43.101"></a><span id="l43.101" class="difflineminus">-  if (enc-&gt;crypto_closure)</span>
<a href="#l43.102"></a><span id="l43.102" class="difflineminus">-  return -1;</span>
<a href="#l43.103"></a><span id="l43.103" class="difflineplus">+  if (enc-&gt;crypto_closure) return -1;</span>
<a href="#l43.104"></a><span id="l43.104"> </span>
<a href="#l43.105"></a><span id="l43.105" class="difflineminus">-  enc-&gt;crypto_closure = (((MimeEncryptedClass *) obj-&gt;clazz)-&gt;crypto_init) (obj, MimeHandleDecryptedOutput, obj);</span>
<a href="#l43.106"></a><span id="l43.106" class="difflineminus">-  if (!enc-&gt;crypto_closure)</span>
<a href="#l43.107"></a><span id="l43.107" class="difflineminus">-  return -1;</span>
<a href="#l43.108"></a><span id="l43.108" class="difflineminus">-</span>
<a href="#l43.109"></a><span id="l43.109" class="difflineplus">+  enc-&gt;crypto_closure = (((MimeEncryptedClass *)obj-&gt;clazz)-&gt;crypto_init)(</span>
<a href="#l43.110"></a><span id="l43.110" class="difflineplus">+      obj, MimeHandleDecryptedOutput, obj);</span>
<a href="#l43.111"></a><span id="l43.111" class="difflineplus">+  if (!enc-&gt;crypto_closure) return -1;</span>
<a href="#l43.112"></a><span id="l43.112"> </span>
<a href="#l43.113"></a><span id="l43.113">   /* (Mostly duplicated from MimeLeaf, see comments in mimecryp.h.)</span>
<a href="#l43.114"></a><span id="l43.114">      Initialize a decoder if necessary.</span>
<a href="#l43.115"></a><span id="l43.115">    */</span>
<a href="#l43.116"></a><span id="l43.116">   if (!obj-&gt;encoding)</span>
<a href="#l43.117"></a><span id="l43.117" class="difflineminus">-  ;</span>
<a href="#l43.118"></a><span id="l43.118" class="difflineplus">+    ;</span>
<a href="#l43.119"></a><span id="l43.119">   else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_BASE64))</span>
<a href="#l43.120"></a><span id="l43.120" class="difflineminus">-  fn = &amp;MimeB64DecoderInit;</span>
<a href="#l43.121"></a><span id="l43.121" class="difflineminus">-  else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l43.122"></a><span id="l43.122" class="difflineminus">-  {</span>
<a href="#l43.123"></a><span id="l43.123" class="difflineplus">+    fn = &amp;MimeB64DecoderInit;</span>
<a href="#l43.124"></a><span id="l43.124" class="difflineplus">+  else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_QUOTED_PRINTABLE)) {</span>
<a href="#l43.125"></a><span id="l43.125">     enc-&gt;decoder_data =</span>
<a href="#l43.126"></a><span id="l43.126" class="difflineminus">-    MimeQPDecoderInit (/* The (MimeConverterOutputCallback) cast is to turn the</span>
<a href="#l43.127"></a><span id="l43.127" class="difflineminus">-                          `void' argument into `MimeObject'. */</span>
<a href="#l43.128"></a><span id="l43.128" class="difflineminus">-      ((MimeConverterOutputCallback)</span>
<a href="#l43.129"></a><span id="l43.129" class="difflineminus">-       ((MimeEncryptedClass *)obj-&gt;clazz)-&gt;parse_decoded_buffer),</span>
<a href="#l43.130"></a><span id="l43.130" class="difflineminus">-      obj);</span>
<a href="#l43.131"></a><span id="l43.131" class="difflineplus">+        MimeQPDecoderInit(/* The (MimeConverterOutputCallback) cast is to turn</span>
<a href="#l43.132"></a><span id="l43.132" class="difflineplus">+                             the `void' argument into `MimeObject'. */</span>
<a href="#l43.133"></a><span id="l43.133" class="difflineplus">+                          ((MimeConverterOutputCallback)(</span>
<a href="#l43.134"></a><span id="l43.134" class="difflineplus">+                               (MimeEncryptedClass *)obj-&gt;clazz)</span>
<a href="#l43.135"></a><span id="l43.135" class="difflineplus">+                               -&gt;parse_decoded_buffer),</span>
<a href="#l43.136"></a><span id="l43.136" class="difflineplus">+                          obj);</span>
<a href="#l43.137"></a><span id="l43.137"> </span>
<a href="#l43.138"></a><span id="l43.138" class="difflineminus">-    if (!enc-&gt;decoder_data)</span>
<a href="#l43.139"></a><span id="l43.139" class="difflineminus">-    return MIME_OUT_OF_MEMORY;</span>
<a href="#l43.140"></a><span id="l43.140" class="difflineminus">-  }</span>
<a href="#l43.141"></a><span id="l43.141" class="difflineminus">-  else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE) ||</span>
<a href="#l43.142"></a><span id="l43.142" class="difflineminus">-       !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE2) ||</span>
<a href="#l43.143"></a><span id="l43.143" class="difflineminus">-       !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE3) ||</span>
<a href="#l43.144"></a><span id="l43.144" class="difflineminus">-       !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE4))</span>
<a href="#l43.145"></a><span id="l43.145" class="difflineminus">-  fn = &amp;MimeUUDecoderInit;</span>
<a href="#l43.146"></a><span id="l43.146" class="difflineplus">+    if (!enc-&gt;decoder_data) return MIME_OUT_OF_MEMORY;</span>
<a href="#l43.147"></a><span id="l43.147" class="difflineplus">+  } else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE) ||</span>
<a href="#l43.148"></a><span id="l43.148" class="difflineplus">+             !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE2) ||</span>
<a href="#l43.149"></a><span id="l43.149" class="difflineplus">+             !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE3) ||</span>
<a href="#l43.150"></a><span id="l43.150" class="difflineplus">+             !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE4))</span>
<a href="#l43.151"></a><span id="l43.151" class="difflineplus">+    fn = &amp;MimeUUDecoderInit;</span>
<a href="#l43.152"></a><span id="l43.152">   else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_YENCODE))</span>
<a href="#l43.153"></a><span id="l43.153">     fn = &amp;MimeYDecoderInit;</span>
<a href="#l43.154"></a><span id="l43.154" class="difflineminus">-  if (fn)</span>
<a href="#l43.155"></a><span id="l43.155" class="difflineminus">-  {</span>
<a href="#l43.156"></a><span id="l43.156" class="difflineplus">+  if (fn) {</span>
<a href="#l43.157"></a><span id="l43.157">     enc-&gt;decoder_data =</span>
<a href="#l43.158"></a><span id="l43.158" class="difflineminus">-    fn (/* The (MimeConverterOutputCallback) cast is to turn the `void'</span>
<a href="#l43.159"></a><span id="l43.159" class="difflineminus">-           argument into `MimeObject'. */</span>
<a href="#l43.160"></a><span id="l43.160" class="difflineminus">-      ((MimeConverterOutputCallback)</span>
<a href="#l43.161"></a><span id="l43.161" class="difflineminus">-       ((MimeEncryptedClass *)obj-&gt;clazz)-&gt;parse_decoded_buffer),</span>
<a href="#l43.162"></a><span id="l43.162" class="difflineminus">-      obj);</span>
<a href="#l43.163"></a><span id="l43.163" class="difflineplus">+        fn(/* The (MimeConverterOutputCallback) cast is to turn the `void'</span>
<a href="#l43.164"></a><span id="l43.164" class="difflineplus">+              argument into `MimeObject'. */</span>
<a href="#l43.165"></a><span id="l43.165" class="difflineplus">+           ((MimeConverterOutputCallback)((MimeEncryptedClass *)obj-&gt;clazz)</span>
<a href="#l43.166"></a><span id="l43.166" class="difflineplus">+                -&gt;parse_decoded_buffer),</span>
<a href="#l43.167"></a><span id="l43.167" class="difflineplus">+           obj);</span>
<a href="#l43.168"></a><span id="l43.168"> </span>
<a href="#l43.169"></a><span id="l43.169" class="difflineminus">-    if (!enc-&gt;decoder_data)</span>
<a href="#l43.170"></a><span id="l43.170" class="difflineminus">-    return MIME_OUT_OF_MEMORY;</span>
<a href="#l43.171"></a><span id="l43.171" class="difflineplus">+    if (!enc-&gt;decoder_data) return MIME_OUT_OF_MEMORY;</span>
<a href="#l43.172"></a><span id="l43.172">   }</span>
<a href="#l43.173"></a><span id="l43.173"> </span>
<a href="#l43.174"></a><span id="l43.174" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l43.175"></a><span id="l43.175" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l43.176"></a><span id="l43.176"> }</span>
<a href="#l43.177"></a><span id="l43.177"> </span>
<a href="#l43.178"></a><span id="l43.178" class="difflineminus">-</span>
<a href="#l43.179"></a><span id="l43.179" class="difflineminus">-static int</span>
<a href="#l43.180"></a><span id="l43.180" class="difflineminus">-MimeEncrypted_parse_buffer (const char *buffer, int32_t size, MimeObject *obj)</span>
<a href="#l43.181"></a><span id="l43.181" class="difflineminus">-{</span>
<a href="#l43.182"></a><span id="l43.182" class="difflineplus">+static int MimeEncrypted_parse_buffer(const char *buffer, int32_t size,</span>
<a href="#l43.183"></a><span id="l43.183" class="difflineplus">+                                      MimeObject *obj) {</span>
<a href="#l43.184"></a><span id="l43.184">   /* (Duplicated from MimeLeaf, see comments in mimecryp.h.)</span>
<a href="#l43.185"></a><span id="l43.185">    */</span>
<a href="#l43.186"></a><span id="l43.186"> </span>
<a href="#l43.187"></a><span id="l43.187" class="difflineminus">-  MimeEncrypted *enc = (MimeEncrypted *) obj;</span>
<a href="#l43.188"></a><span id="l43.188" class="difflineplus">+  MimeEncrypted *enc = (MimeEncrypted *)obj;</span>
<a href="#l43.189"></a><span id="l43.189"> </span>
<a href="#l43.190"></a><span id="l43.190">   if (obj-&gt;closed_p) return -1;</span>
<a href="#l43.191"></a><span id="l43.191"> </span>
<a href="#l43.192"></a><span id="l43.192">   /* Don't consult output_p here, since at this point we're behaving as a</span>
<a href="#l43.193"></a><span id="l43.193">    simple container object -- the output_p decision should be made by</span>
<a href="#l43.194"></a><span id="l43.194">    the child of this object. */</span>
<a href="#l43.195"></a><span id="l43.195"> </span>
<a href="#l43.196"></a><span id="l43.196">   if (enc-&gt;decoder_data)</span>
<a href="#l43.197"></a><span id="l43.197" class="difflineminus">-  return MimeDecoderWrite (enc-&gt;decoder_data, buffer, size, nullptr);</span>
<a href="#l43.198"></a><span id="l43.198" class="difflineplus">+    return MimeDecoderWrite(enc-&gt;decoder_data, buffer, size, nullptr);</span>
<a href="#l43.199"></a><span id="l43.199">   else</span>
<a href="#l43.200"></a><span id="l43.200" class="difflineminus">-  return ((MimeEncryptedClass *)obj-&gt;clazz)-&gt;parse_decoded_buffer (buffer,</span>
<a href="#l43.201"></a><span id="l43.201" class="difflineminus">-                                   size,</span>
<a href="#l43.202"></a><span id="l43.202" class="difflineminus">-                                   obj);</span>
<a href="#l43.203"></a><span id="l43.203" class="difflineplus">+    return ((MimeEncryptedClass *)obj-&gt;clazz)</span>
<a href="#l43.204"></a><span id="l43.204" class="difflineplus">+        -&gt;parse_decoded_buffer(buffer, size, obj);</span>
<a href="#l43.205"></a><span id="l43.205"> }</span>
<a href="#l43.206"></a><span id="l43.206"> </span>
<a href="#l43.207"></a><span id="l43.207" class="difflineminus">-</span>
<a href="#l43.208"></a><span id="l43.208" class="difflineminus">-static int</span>
<a href="#l43.209"></a><span id="l43.209" class="difflineminus">-MimeEncrypted_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l43.210"></a><span id="l43.210" class="difflineminus">-{</span>
<a href="#l43.211"></a><span id="l43.211" class="difflineplus">+static int MimeEncrypted_parse_line(const char *line, int32_t length,</span>
<a href="#l43.212"></a><span id="l43.212" class="difflineplus">+                                    MimeObject *obj) {</span>
<a href="#l43.213"></a><span id="l43.213">   NS_ERROR(&quot;This method shouldn't ever be called.&quot;);</span>
<a href="#l43.214"></a><span id="l43.214">   return -1;</span>
<a href="#l43.215"></a><span id="l43.215"> }</span>
<a href="#l43.216"></a><span id="l43.216"> </span>
<a href="#l43.217"></a><span id="l43.217" class="difflineminus">-static int</span>
<a href="#l43.218"></a><span id="l43.218" class="difflineminus">-MimeEncrypted_parse_decoded_buffer (const char *buffer, int32_t size, MimeObject *obj)</span>
<a href="#l43.219"></a><span id="l43.219" class="difflineminus">-{</span>
<a href="#l43.220"></a><span id="l43.220" class="difflineminus">-  MimeEncrypted *enc = (MimeEncrypted *) obj;</span>
<a href="#l43.221"></a><span id="l43.221" class="difflineminus">-  return</span>
<a href="#l43.222"></a><span id="l43.222" class="difflineminus">-  ((MimeEncryptedClass *) obj-&gt;clazz)-&gt;crypto_write (buffer, size,</span>
<a href="#l43.223"></a><span id="l43.223" class="difflineminus">-                             enc-&gt;crypto_closure);</span>
<a href="#l43.224"></a><span id="l43.224" class="difflineplus">+static int MimeEncrypted_parse_decoded_buffer(const char *buffer, int32_t size,</span>
<a href="#l43.225"></a><span id="l43.225" class="difflineplus">+                                              MimeObject *obj) {</span>
<a href="#l43.226"></a><span id="l43.226" class="difflineplus">+  MimeEncrypted *enc = (MimeEncrypted *)obj;</span>
<a href="#l43.227"></a><span id="l43.227" class="difflineplus">+  return ((MimeEncryptedClass *)obj-&gt;clazz)</span>
<a href="#l43.228"></a><span id="l43.228" class="difflineplus">+      -&gt;crypto_write(buffer, size, enc-&gt;crypto_closure);</span>
<a href="#l43.229"></a><span id="l43.229"> }</span>
<a href="#l43.230"></a><span id="l43.230"> </span>
<a href="#l43.231"></a><span id="l43.231" class="difflineminus">-</span>
<a href="#l43.232"></a><span id="l43.232" class="difflineminus">-static int</span>
<a href="#l43.233"></a><span id="l43.233" class="difflineminus">-MimeEncrypted_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l43.234"></a><span id="l43.234" class="difflineminus">-{</span>
<a href="#l43.235"></a><span id="l43.235" class="difflineplus">+static int MimeEncrypted_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l43.236"></a><span id="l43.236">   int status = 0;</span>
<a href="#l43.237"></a><span id="l43.237" class="difflineminus">-  MimeEncrypted *enc = (MimeEncrypted *) obj;</span>
<a href="#l43.238"></a><span id="l43.238" class="difflineplus">+  MimeEncrypted *enc = (MimeEncrypted *)obj;</span>
<a href="#l43.239"></a><span id="l43.239"> </span>
<a href="#l43.240"></a><span id="l43.240">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l43.241"></a><span id="l43.241">   NS_ASSERTION(!obj-&gt;parsed_p, &quot;1.2 &lt;mscott@netscape.com&gt; 01 Nov 2001 17:59&quot;);</span>
<a href="#l43.242"></a><span id="l43.242"> </span>
<a href="#l43.243"></a><span id="l43.243">   /* (Duplicated from MimeLeaf, see comments in mimecryp.h.)</span>
<a href="#l43.244"></a><span id="l43.244">      Close off the decoder, to cause it to give up any buffered data that</span>
<a href="#l43.245"></a><span id="l43.245">    it is still holding.</span>
<a href="#l43.246"></a><span id="l43.246">    */</span>
<a href="#l43.247"></a><span id="l43.247" class="difflineminus">-  if (enc-&gt;decoder_data)</span>
<a href="#l43.248"></a><span id="l43.248" class="difflineminus">-  {</span>
<a href="#l43.249"></a><span id="l43.249" class="difflineplus">+  if (enc-&gt;decoder_data) {</span>
<a href="#l43.250"></a><span id="l43.250">     int status = MimeDecoderDestroy(enc-&gt;decoder_data, false);</span>
<a href="#l43.251"></a><span id="l43.251">     enc-&gt;decoder_data = 0;</span>
<a href="#l43.252"></a><span id="l43.252">     if (status &lt; 0) return status;</span>
<a href="#l43.253"></a><span id="l43.253">   }</span>
<a href="#l43.254"></a><span id="l43.254"> </span>
<a href="#l43.255"></a><span id="l43.255" class="difflineminus">-</span>
<a href="#l43.256"></a><span id="l43.256">   /* If there is still data in the ibuffer, that means that the last</span>
<a href="#l43.257"></a><span id="l43.257">    *decrypted* line of this part didn't end in a newline; so push it out</span>
<a href="#l43.258"></a><span id="l43.258">    anyway (this means that the parse_line method will be called with a</span>
<a href="#l43.259"></a><span id="l43.259">    string with no trailing newline, which isn't the usual case.)  */</span>
<a href="#l43.260"></a><span id="l43.260" class="difflineminus">-  if (!abort_p &amp;&amp;</span>
<a href="#l43.261"></a><span id="l43.261" class="difflineminus">-    obj-&gt;ibuffer_fp &gt; 0)</span>
<a href="#l43.262"></a><span id="l43.262" class="difflineminus">-  {</span>
<a href="#l43.263"></a><span id="l43.263" class="difflineminus">-    int status = MimeHandleDecryptedOutputLine (obj-&gt;ibuffer,</span>
<a href="#l43.264"></a><span id="l43.264" class="difflineminus">-                          obj-&gt;ibuffer_fp, obj);</span>
<a href="#l43.265"></a><span id="l43.265" class="difflineplus">+  if (!abort_p &amp;&amp; obj-&gt;ibuffer_fp &gt; 0) {</span>
<a href="#l43.266"></a><span id="l43.266" class="difflineplus">+    int status =</span>
<a href="#l43.267"></a><span id="l43.267" class="difflineplus">+        MimeHandleDecryptedOutputLine(obj-&gt;ibuffer, obj-&gt;ibuffer_fp, obj);</span>
<a href="#l43.268"></a><span id="l43.268">     obj-&gt;ibuffer_fp = 0;</span>
<a href="#l43.269"></a><span id="l43.269" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l43.270"></a><span id="l43.270" class="difflineminus">-    {</span>
<a href="#l43.271"></a><span id="l43.271" class="difflineplus">+    if (status &lt; 0) {</span>
<a href="#l43.272"></a><span id="l43.272">       obj-&gt;closed_p = true;</span>
<a href="#l43.273"></a><span id="l43.273">       return status;</span>
<a href="#l43.274"></a><span id="l43.274">     }</span>
<a href="#l43.275"></a><span id="l43.275">   }</span>
<a href="#l43.276"></a><span id="l43.276"> </span>
<a href="#l43.277"></a><span id="l43.277" class="difflineminus">-</span>
<a href="#l43.278"></a><span id="l43.278">   /* Now run the superclass's parse_eof, which (because we've already taken</span>
<a href="#l43.279"></a><span id="l43.279">    care of ibuffer in a way appropriate for this class, immediately above)</span>
<a href="#l43.280"></a><span id="l43.280">    will only set closed_p to true.</span>
<a href="#l43.281"></a><span id="l43.281">    */</span>
<a href="#l43.282"></a><span id="l43.282" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof (obj, abort_p);</span>
<a href="#l43.283"></a><span id="l43.283" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l43.284"></a><span id="l43.284">   if (status &lt; 0) return status;</span>
<a href="#l43.285"></a><span id="l43.285"> </span>
<a href="#l43.286"></a><span id="l43.286" class="difflineminus">-</span>
<a href="#l43.287"></a><span id="l43.287">   /* Now close off the underlying crypto module.  At this point, the crypto</span>
<a href="#l43.288"></a><span id="l43.288">    module has all of the input.  (DecoderDestroy called parse_decoded_buffer</span>
<a href="#l43.289"></a><span id="l43.289">    which called crypto_write, with the last of the data.)</span>
<a href="#l43.290"></a><span id="l43.290">    */</span>
<a href="#l43.291"></a><span id="l43.291" class="difflineminus">-  if (enc-&gt;crypto_closure)</span>
<a href="#l43.292"></a><span id="l43.292" class="difflineminus">-  {</span>
<a href="#l43.293"></a><span id="l43.293" class="difflineminus">-    status =</span>
<a href="#l43.294"></a><span id="l43.294" class="difflineminus">-    ((MimeEncryptedClass *) obj-&gt;clazz)-&gt;crypto_eof (enc-&gt;crypto_closure,</span>
<a href="#l43.295"></a><span id="l43.295" class="difflineminus">-                             abort_p);</span>
<a href="#l43.296"></a><span id="l43.296" class="difflineminus">-    if (status &lt; 0 &amp;&amp; !abort_p)</span>
<a href="#l43.297"></a><span id="l43.297" class="difflineminus">-    return status;</span>
<a href="#l43.298"></a><span id="l43.298" class="difflineplus">+  if (enc-&gt;crypto_closure) {</span>
<a href="#l43.299"></a><span id="l43.299" class="difflineplus">+    status = ((MimeEncryptedClass *)obj-&gt;clazz)</span>
<a href="#l43.300"></a><span id="l43.300" class="difflineplus">+                 -&gt;crypto_eof(enc-&gt;crypto_closure, abort_p);</span>
<a href="#l43.301"></a><span id="l43.301" class="difflineplus">+    if (status &lt; 0 &amp;&amp; !abort_p) return status;</span>
<a href="#l43.302"></a><span id="l43.302">   }</span>
<a href="#l43.303"></a><span id="l43.303"> </span>
<a href="#l43.304"></a><span id="l43.304">   /* Now we have the entire child part in the part buffer.</span>
<a href="#l43.305"></a><span id="l43.305">    We are now able to verify its signature, emit a blurb, and then</span>
<a href="#l43.306"></a><span id="l43.306">    emit the part.</span>
<a href="#l43.307"></a><span id="l43.307">    */</span>
<a href="#l43.308"></a><span id="l43.308">   if (abort_p)</span>
<a href="#l43.309"></a><span id="l43.309" class="difflineminus">-  return 0;</span>
<a href="#l43.310"></a><span id="l43.310" class="difflineplus">+    return 0;</span>
<a href="#l43.311"></a><span id="l43.311">   else</span>
<a href="#l43.312"></a><span id="l43.312" class="difflineminus">-  return MimeEncrypted_emit_buffered_child (obj);</span>
<a href="#l43.313"></a><span id="l43.313" class="difflineplus">+    return MimeEncrypted_emit_buffered_child(obj);</span>
<a href="#l43.314"></a><span id="l43.314"> }</span>
<a href="#l43.315"></a><span id="l43.315"> </span>
<a href="#l43.316"></a><span id="l43.316" class="difflineminus">-</span>
<a href="#l43.317"></a><span id="l43.317" class="difflineminus">-static int</span>
<a href="#l43.318"></a><span id="l43.318" class="difflineminus">-MimeEncrypted_parse_end (MimeObject *obj, bool abort_p)</span>
<a href="#l43.319"></a><span id="l43.319" class="difflineminus">-{</span>
<a href="#l43.320"></a><span id="l43.320" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_end (obj, abort_p);</span>
<a href="#l43.321"></a><span id="l43.321" class="difflineplus">+static int MimeEncrypted_parse_end(MimeObject *obj, bool abort_p) {</span>
<a href="#l43.322"></a><span id="l43.322" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_end(obj, abort_p);</span>
<a href="#l43.323"></a><span id="l43.323"> }</span>
<a href="#l43.324"></a><span id="l43.324"> </span>
<a href="#l43.325"></a><span id="l43.325" class="difflineplus">+static void MimeEncrypted_cleanup(MimeObject *obj, bool finalizing_p) {</span>
<a href="#l43.326"></a><span id="l43.326" class="difflineplus">+  MimeEncrypted *enc = (MimeEncrypted *)obj;</span>
<a href="#l43.327"></a><span id="l43.327"> </span>
<a href="#l43.328"></a><span id="l43.328" class="difflineminus">-static void</span>
<a href="#l43.329"></a><span id="l43.329" class="difflineminus">-MimeEncrypted_cleanup (MimeObject *obj, bool finalizing_p)</span>
<a href="#l43.330"></a><span id="l43.330" class="difflineminus">-{</span>
<a href="#l43.331"></a><span id="l43.331" class="difflineminus">-  MimeEncrypted *enc = (MimeEncrypted *) obj;</span>
<a href="#l43.332"></a><span id="l43.332" class="difflineminus">-</span>
<a href="#l43.333"></a><span id="l43.333" class="difflineminus">-  if (enc-&gt;part_buffer)</span>
<a href="#l43.334"></a><span id="l43.334" class="difflineminus">-  {</span>
<a href="#l43.335"></a><span id="l43.335" class="difflineplus">+  if (enc-&gt;part_buffer) {</span>
<a href="#l43.336"></a><span id="l43.336">     MimePartBufferDestroy(enc-&gt;part_buffer);</span>
<a href="#l43.337"></a><span id="l43.337">     enc-&gt;part_buffer = 0;</span>
<a href="#l43.338"></a><span id="l43.338">   }</span>
<a href="#l43.339"></a><span id="l43.339"> </span>
<a href="#l43.340"></a><span id="l43.340" class="difflineminus">-  if (finalizing_p &amp;&amp; enc-&gt;crypto_closure)</span>
<a href="#l43.341"></a><span id="l43.341" class="difflineminus">-  {</span>
<a href="#l43.342"></a><span id="l43.342" class="difflineplus">+  if (finalizing_p &amp;&amp; enc-&gt;crypto_closure) {</span>
<a href="#l43.343"></a><span id="l43.343">     /* Don't free these until this object is really going away -- keep them</span>
<a href="#l43.344"></a><span id="l43.344">      around for the lifetime of the MIME object, so that we can get at the</span>
<a href="#l43.345"></a><span id="l43.345">      security info of sub-parts of the currently-displayed message. */</span>
<a href="#l43.346"></a><span id="l43.346" class="difflineminus">-    ((MimeEncryptedClass *) obj-&gt;clazz)-&gt;crypto_free (enc-&gt;crypto_closure);</span>
<a href="#l43.347"></a><span id="l43.347" class="difflineplus">+    ((MimeEncryptedClass *)obj-&gt;clazz)-&gt;crypto_free(enc-&gt;crypto_closure);</span>
<a href="#l43.348"></a><span id="l43.348">     enc-&gt;crypto_closure = 0;</span>
<a href="#l43.349"></a><span id="l43.349">   }</span>
<a href="#l43.350"></a><span id="l43.350"> </span>
<a href="#l43.351"></a><span id="l43.351">   /* (Duplicated from MimeLeaf, see comments in mimecryp.h.)</span>
<a href="#l43.352"></a><span id="l43.352">    Free the decoder data, if it's still around. */</span>
<a href="#l43.353"></a><span id="l43.353" class="difflineminus">-  if (enc-&gt;decoder_data)</span>
<a href="#l43.354"></a><span id="l43.354" class="difflineminus">-  {</span>
<a href="#l43.355"></a><span id="l43.355" class="difflineplus">+  if (enc-&gt;decoder_data) {</span>
<a href="#l43.356"></a><span id="l43.356">     MimeDecoderDestroy(enc-&gt;decoder_data, true);</span>
<a href="#l43.357"></a><span id="l43.357">     enc-&gt;decoder_data = 0;</span>
<a href="#l43.358"></a><span id="l43.358">   }</span>
<a href="#l43.359"></a><span id="l43.359"> </span>
<a href="#l43.360"></a><span id="l43.360" class="difflineminus">-  if (enc-&gt;hdrs)</span>
<a href="#l43.361"></a><span id="l43.361" class="difflineminus">-  {</span>
<a href="#l43.362"></a><span id="l43.362" class="difflineplus">+  if (enc-&gt;hdrs) {</span>
<a href="#l43.363"></a><span id="l43.363">     MimeHeaders_free(enc-&gt;hdrs);</span>
<a href="#l43.364"></a><span id="l43.364">     enc-&gt;hdrs = 0;</span>
<a href="#l43.365"></a><span id="l43.365">   }</span>
<a href="#l43.366"></a><span id="l43.366"> }</span>
<a href="#l43.367"></a><span id="l43.367"> </span>
<a href="#l43.368"></a><span id="l43.368" class="difflineminus">-</span>
<a href="#l43.369"></a><span id="l43.369" class="difflineminus">-static void</span>
<a href="#l43.370"></a><span id="l43.370" class="difflineminus">-MimeEncrypted_finalize (MimeObject *obj)</span>
<a href="#l43.371"></a><span id="l43.371" class="difflineminus">-{</span>
<a href="#l43.372"></a><span id="l43.372" class="difflineminus">-  MimeEncrypted_cleanup (obj, true);</span>
<a href="#l43.373"></a><span id="l43.373" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize (obj);</span>
<a href="#l43.374"></a><span id="l43.374" class="difflineplus">+static void MimeEncrypted_finalize(MimeObject *obj) {</span>
<a href="#l43.375"></a><span id="l43.375" class="difflineplus">+  MimeEncrypted_cleanup(obj, true);</span>
<a href="#l43.376"></a><span id="l43.376" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l43.377"></a><span id="l43.377"> }</span>
<a href="#l43.378"></a><span id="l43.378"> </span>
<a href="#l43.379"></a><span id="l43.379" class="difflineminus">-</span>
<a href="#l43.380"></a><span id="l43.380" class="difflineminus">-static int</span>
<a href="#l43.381"></a><span id="l43.381" class="difflineminus">-MimeHandleDecryptedOutput (const char *buf, int32_t buf_size,</span>
<a href="#l43.382"></a><span id="l43.382" class="difflineminus">-               void *output_closure)</span>
<a href="#l43.383"></a><span id="l43.383" class="difflineminus">-{</span>
<a href="#l43.384"></a><span id="l43.384" class="difflineplus">+static int MimeHandleDecryptedOutput(const char *buf, int32_t buf_size,</span>
<a href="#l43.385"></a><span id="l43.385" class="difflineplus">+                                     void *output_closure) {</span>
<a href="#l43.386"></a><span id="l43.386">   /* This method is invoked by the underlying decryption module.</span>
<a href="#l43.387"></a><span id="l43.387">    The module is assumed to return a MIME object, and its associated</span>
<a href="#l43.388"></a><span id="l43.388">    headers.  For example, if a text/plain document was encrypted,</span>
<a href="#l43.389"></a><span id="l43.389">    the encryption module would return the following data:</span>
<a href="#l43.390"></a><span id="l43.390"> </span>
<a href="#l43.391"></a><span id="l43.391">      Content-Type: text/plain</span>
<a href="#l43.392"></a><span id="l43.392"> </span>
<a href="#l43.393"></a><span id="l43.393">      Decrypted text goes here.</span>
<a href="#l43.394"></a><span id="l43.394"> </span>
<a href="#l43.395"></a><span id="l43.395">    This function will then extract a header block (up to the first</span>
<a href="#l43.396"></a><span id="l43.396">    blank line, as usual) and will then handle the included data as</span>
<a href="#l43.397"></a><span id="l43.397">    appropriate.</span>
<a href="#l43.398"></a><span id="l43.398">    */</span>
<a href="#l43.399"></a><span id="l43.399" class="difflineminus">-  MimeObject *obj = (MimeObject *) output_closure;</span>
<a href="#l43.400"></a><span id="l43.400" class="difflineplus">+  MimeObject *obj = (MimeObject *)output_closure;</span>
<a href="#l43.401"></a><span id="l43.401"> </span>
<a href="#l43.402"></a><span id="l43.402">   /* Is it truly safe to use ibuffer here?  I think so... */</span>
<a href="#l43.403"></a><span id="l43.403" class="difflineminus">-  return mime_LineBuffer (buf, buf_size,</span>
<a href="#l43.404"></a><span id="l43.404" class="difflineminus">-             &amp;obj-&gt;ibuffer, &amp;obj-&gt;ibuffer_size, &amp;obj-&gt;ibuffer_fp,</span>
<a href="#l43.405"></a><span id="l43.405" class="difflineminus">-             true,</span>
<a href="#l43.406"></a><span id="l43.406" class="difflineminus">-             ((int (*) (char *, int32_t, void *))</span>
<a href="#l43.407"></a><span id="l43.407" class="difflineminus">-              /* This cast is to turn void into MimeObject */</span>
<a href="#l43.408"></a><span id="l43.408" class="difflineminus">-              MimeHandleDecryptedOutputLine),</span>
<a href="#l43.409"></a><span id="l43.409" class="difflineminus">-             obj);</span>
<a href="#l43.410"></a><span id="l43.410" class="difflineplus">+  return mime_LineBuffer(buf, buf_size, &amp;obj-&gt;ibuffer, &amp;obj-&gt;ibuffer_size,</span>
<a href="#l43.411"></a><span id="l43.411" class="difflineplus">+                         &amp;obj-&gt;ibuffer_fp, true,</span>
<a href="#l43.412"></a><span id="l43.412" class="difflineplus">+                         ((int (*)(char *, int32_t, void *))</span>
<a href="#l43.413"></a><span id="l43.413" class="difflineplus">+                          /* This cast is to turn void into MimeObject */</span>
<a href="#l43.414"></a><span id="l43.414" class="difflineplus">+                          MimeHandleDecryptedOutputLine),</span>
<a href="#l43.415"></a><span id="l43.415" class="difflineplus">+                         obj);</span>
<a href="#l43.416"></a><span id="l43.416"> }</span>
<a href="#l43.417"></a><span id="l43.417"> </span>
<a href="#l43.418"></a><span id="l43.418" class="difflineminus">-static int</span>
<a href="#l43.419"></a><span id="l43.419" class="difflineminus">-MimeHandleDecryptedOutputLine (char *line, int32_t length, MimeObject *obj)</span>
<a href="#l43.420"></a><span id="l43.420" class="difflineminus">-{</span>
<a href="#l43.421"></a><span id="l43.421" class="difflineplus">+static int MimeHandleDecryptedOutputLine(char *line, int32_t length,</span>
<a href="#l43.422"></a><span id="l43.422" class="difflineplus">+                                         MimeObject *obj) {</span>
<a href="#l43.423"></a><span id="l43.423">   /* Largely the same as MimeMessage_parse_line (the other MIME container</span>
<a href="#l43.424"></a><span id="l43.424">    type which contains exactly one child.)</span>
<a href="#l43.425"></a><span id="l43.425">    */</span>
<a href="#l43.426"></a><span id="l43.426" class="difflineminus">-  MimeEncrypted *enc = (MimeEncrypted *) obj;</span>
<a href="#l43.427"></a><span id="l43.427" class="difflineplus">+  MimeEncrypted *enc = (MimeEncrypted *)obj;</span>
<a href="#l43.428"></a><span id="l43.428">   int status = 0;</span>
<a href="#l43.429"></a><span id="l43.429"> </span>
<a href="#l43.430"></a><span id="l43.430">   if (!line || !*line) return -1;</span>
<a href="#l43.431"></a><span id="l43.431"> </span>
<a href="#l43.432"></a><span id="l43.432">   /* If we're supposed to write this object, but aren't supposed to convert</span>
<a href="#l43.433"></a><span id="l43.433">    it to HTML, simply pass it through unaltered. */</span>
<a href="#l43.434"></a><span id="l43.434" class="difflineminus">-  if (obj-&gt;output_p &amp;&amp;</span>
<a href="#l43.435"></a><span id="l43.435" class="difflineminus">-    obj-&gt;options &amp;&amp;</span>
<a href="#l43.436"></a><span id="l43.436" class="difflineminus">-    !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l43.437"></a><span id="l43.437" class="difflineminus">-    obj-&gt;options-&gt;output_fn)</span>
<a href="#l43.438"></a><span id="l43.438" class="difflineminus">-  return MimeObject_write(obj, line, length, true);</span>
<a href="#l43.439"></a><span id="l43.439" class="difflineplus">+  if (obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l43.440"></a><span id="l43.440" class="difflineplus">+      obj-&gt;options-&gt;output_fn)</span>
<a href="#l43.441"></a><span id="l43.441" class="difflineplus">+    return MimeObject_write(obj, line, length, true);</span>
<a href="#l43.442"></a><span id="l43.442"> </span>
<a href="#l43.443"></a><span id="l43.443">   /* If we already have a child object in the buffer, then we're done parsing</span>
<a href="#l43.444"></a><span id="l43.444">    headers, and all subsequent lines get passed to the inferior object</span>
<a href="#l43.445"></a><span id="l43.445">    without further processing by us.  (Our parent will stop feeding us</span>
<a href="#l43.446"></a><span id="l43.446">    lines when this MimeMessage part is out of data.)</span>
<a href="#l43.447"></a><span id="l43.447">    */</span>
<a href="#l43.448"></a><span id="l43.448">   if (enc-&gt;part_buffer)</span>
<a href="#l43.449"></a><span id="l43.449" class="difflineminus">-  return MimePartBufferWrite (enc-&gt;part_buffer, line, length);</span>
<a href="#l43.450"></a><span id="l43.450" class="difflineplus">+    return MimePartBufferWrite(enc-&gt;part_buffer, line, length);</span>
<a href="#l43.451"></a><span id="l43.451"> </span>
<a href="#l43.452"></a><span id="l43.452">   /* Otherwise we don't yet have a child object in the buffer, which means</span>
<a href="#l43.453"></a><span id="l43.453">    we're not done parsing our headers yet.</span>
<a href="#l43.454"></a><span id="l43.454">    */</span>
<a href="#l43.455"></a><span id="l43.455" class="difflineminus">-  if (!enc-&gt;hdrs)</span>
<a href="#l43.456"></a><span id="l43.456" class="difflineminus">-  {</span>
<a href="#l43.457"></a><span id="l43.457" class="difflineplus">+  if (!enc-&gt;hdrs) {</span>
<a href="#l43.458"></a><span id="l43.458">     enc-&gt;hdrs = MimeHeaders_new();</span>
<a href="#l43.459"></a><span id="l43.459">     if (!enc-&gt;hdrs) return MIME_OUT_OF_MEMORY;</span>
<a href="#l43.460"></a><span id="l43.460">   }</span>
<a href="#l43.461"></a><span id="l43.461"> </span>
<a href="#l43.462"></a><span id="l43.462">   status = MimeHeaders_parse_line(line, length, enc-&gt;hdrs);</span>
<a href="#l43.463"></a><span id="l43.463">   if (status &lt; 0) return status;</span>
<a href="#l43.464"></a><span id="l43.464"> </span>
<a href="#l43.465"></a><span id="l43.465">   /* If this line is blank, we're now done parsing headers, and should</span>
<a href="#l43.466"></a><span id="l43.466">    examine our content-type to create our &quot;body&quot; part.</span>
<a href="#l43.467"></a><span id="l43.467">    */</span>
<a href="#l43.468"></a><span id="l43.468" class="difflineminus">-  if (*line == '\r' || *line == '\n')</span>
<a href="#l43.469"></a><span id="l43.469" class="difflineminus">-  {</span>
<a href="#l43.470"></a><span id="l43.470" class="difflineplus">+  if (*line == '\r' || *line == '\n') {</span>
<a href="#l43.471"></a><span id="l43.471">     status = MimeEncrypted_close_headers(obj);</span>
<a href="#l43.472"></a><span id="l43.472">     if (status &lt; 0) return status;</span>
<a href="#l43.473"></a><span id="l43.473">   }</span>
<a href="#l43.474"></a><span id="l43.474"> </span>
<a href="#l43.475"></a><span id="l43.475">   return 0;</span>
<a href="#l43.476"></a><span id="l43.476"> }</span>
<a href="#l43.477"></a><span id="l43.477"> </span>
<a href="#l43.478"></a><span id="l43.478" class="difflineminus">-static int</span>
<a href="#l43.479"></a><span id="l43.479" class="difflineminus">-MimeEncrypted_close_headers (MimeObject *obj)</span>
<a href="#l43.480"></a><span id="l43.480" class="difflineminus">-{</span>
<a href="#l43.481"></a><span id="l43.481" class="difflineminus">-  MimeEncrypted *enc = (MimeEncrypted *) obj;</span>
<a href="#l43.482"></a><span id="l43.482" class="difflineplus">+static int MimeEncrypted_close_headers(MimeObject *obj) {</span>
<a href="#l43.483"></a><span id="l43.483" class="difflineplus">+  MimeEncrypted *enc = (MimeEncrypted *)obj;</span>
<a href="#l43.484"></a><span id="l43.484"> </span>
<a href="#l43.485"></a><span id="l43.485">   // Notify the JS Mime Emitter that this was an encrypted part that it should</span>
<a href="#l43.486"></a><span id="l43.486">   // hopefully not analyze for indexing...</span>
<a href="#l43.487"></a><span id="l43.487">   if (obj-&gt;options-&gt;notify_nested_bodies)</span>
<a href="#l43.488"></a><span id="l43.488">     mimeEmitterAddHeaderField(obj-&gt;options, &quot;x-jsemitter-encrypted&quot;, &quot;1&quot;);</span>
<a href="#l43.489"></a><span id="l43.489"> </span>
<a href="#l43.490"></a><span id="l43.490">   if (enc-&gt;part_buffer) return -1;</span>
<a href="#l43.491"></a><span id="l43.491">   enc-&gt;part_buffer = MimePartBufferCreate();</span>
<a href="#l43.492"></a><span id="l43.492" class="difflineminus">-  if (!enc-&gt;part_buffer)</span>
<a href="#l43.493"></a><span id="l43.493" class="difflineminus">-  return MIME_OUT_OF_MEMORY;</span>
<a href="#l43.494"></a><span id="l43.494" class="difflineplus">+  if (!enc-&gt;part_buffer) return MIME_OUT_OF_MEMORY;</span>
<a href="#l43.495"></a><span id="l43.495"> </span>
<a href="#l43.496"></a><span id="l43.496">   return 0;</span>
<a href="#l43.497"></a><span id="l43.497"> }</span>
<a href="#l43.498"></a><span id="l43.498"> </span>
<a href="#l43.499"></a><span id="l43.499" class="difflineminus">-</span>
<a href="#l43.500"></a><span id="l43.500" class="difflineminus">-static int</span>
<a href="#l43.501"></a><span id="l43.501" class="difflineminus">-MimeEncrypted_add_child (MimeObject *parent, MimeObject *child)</span>
<a href="#l43.502"></a><span id="l43.502" class="difflineminus">-{</span>
<a href="#l43.503"></a><span id="l43.503" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) parent;</span>
<a href="#l43.504"></a><span id="l43.504" class="difflineplus">+static int MimeEncrypted_add_child(MimeObject *parent, MimeObject *child) {</span>
<a href="#l43.505"></a><span id="l43.505" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)parent;</span>
<a href="#l43.506"></a><span id="l43.506">   if (!parent || !child) return -1;</span>
<a href="#l43.507"></a><span id="l43.507"> </span>
<a href="#l43.508"></a><span id="l43.508">   /* Encryption containers can only have one child. */</span>
<a href="#l43.509"></a><span id="l43.509">   if (cont-&gt;nchildren != 0) return -1;</span>
<a href="#l43.510"></a><span id="l43.510"> </span>
<a href="#l43.511"></a><span id="l43.511" class="difflineminus">-  return ((MimeContainerClass*)&amp;MIME_SUPERCLASS)-&gt;add_child (parent, child);</span>
<a href="#l43.512"></a><span id="l43.512" class="difflineplus">+  return ((MimeContainerClass *)&amp;MIME_SUPERCLASS)-&gt;add_child(parent, child);</span>
<a href="#l43.513"></a><span id="l43.513"> }</span>
<a href="#l43.514"></a><span id="l43.514"> </span>
<a href="#l43.515"></a><span id="l43.515" class="difflineminus">-</span>
<a href="#l43.516"></a><span id="l43.516" class="difflineminus">-static int</span>
<a href="#l43.517"></a><span id="l43.517" class="difflineminus">-MimeEncrypted_emit_buffered_child(MimeObject *obj)</span>
<a href="#l43.518"></a><span id="l43.518" class="difflineminus">-{</span>
<a href="#l43.519"></a><span id="l43.519" class="difflineminus">-  MimeEncrypted *enc = (MimeEncrypted *) obj;</span>
<a href="#l43.520"></a><span id="l43.520" class="difflineplus">+static int MimeEncrypted_emit_buffered_child(MimeObject *obj) {</span>
<a href="#l43.521"></a><span id="l43.521" class="difflineplus">+  MimeEncrypted *enc = (MimeEncrypted *)obj;</span>
<a href="#l43.522"></a><span id="l43.522">   int status = 0;</span>
<a href="#l43.523"></a><span id="l43.523">   char *ct = 0;</span>
<a href="#l43.524"></a><span id="l43.524">   MimeObject *body;</span>
<a href="#l43.525"></a><span id="l43.525"> </span>
<a href="#l43.526"></a><span id="l43.526" class="difflineminus">-  NS_ASSERTION(enc-&gt;crypto_closure, &quot;1.2 &lt;mscott@netscape.com&gt; 01 Nov 2001 17:59&quot;);</span>
<a href="#l43.527"></a><span id="l43.527" class="difflineplus">+  NS_ASSERTION(enc-&gt;crypto_closure,</span>
<a href="#l43.528"></a><span id="l43.528" class="difflineplus">+               &quot;1.2 &lt;mscott@netscape.com&gt; 01 Nov 2001 17:59&quot;);</span>
<a href="#l43.529"></a><span id="l43.529"> </span>
<a href="#l43.530"></a><span id="l43.530">   /* Emit some HTML saying whether the signature was cool.</span>
<a href="#l43.531"></a><span id="l43.531">    But don't emit anything if in FO_QUOTE_MESSAGE mode.</span>
<a href="#l43.532"></a><span id="l43.532"> </span>
<a href="#l43.533"></a><span id="l43.533">    Also, don't emit anything if the enclosed object is itself a signed</span>
<a href="#l43.534"></a><span id="l43.534">    object -- in the case of an encrypted object which contains a signed</span>
<a href="#l43.535"></a><span id="l43.535">    object, we only emit the HTML once (since the normal way of encrypting</span>
<a href="#l43.536"></a><span id="l43.536">    and signing is to nest the signature inside the crypto envelope.)</span>
<a href="#l43.537"></a><span id="l43.537">    */</span>
<a href="#l43.538"></a><span id="l43.538" class="difflineminus">-  if (enc-&gt;crypto_closure &amp;&amp;</span>
<a href="#l43.539"></a><span id="l43.539" class="difflineminus">-    obj-&gt;options &amp;&amp;</span>
<a href="#l43.540"></a><span id="l43.540" class="difflineminus">-    obj-&gt;options-&gt;headers != MimeHeadersCitation &amp;&amp;</span>
<a href="#l43.541"></a><span id="l43.541" class="difflineminus">-    obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l43.542"></a><span id="l43.542" class="difflineminus">-    obj-&gt;options-&gt;output_fn)</span>
<a href="#l43.543"></a><span id="l43.543" class="difflineminus">-    // &amp;&amp; !mime_crypto_object_p(enc-&gt;hdrs, true, obj-&gt;options)) // XXX fix later XXX //</span>
<a href="#l43.544"></a><span id="l43.544" class="difflineplus">+  if (enc-&gt;crypto_closure &amp;&amp; obj-&gt;options &amp;&amp;</span>
<a href="#l43.545"></a><span id="l43.545" class="difflineplus">+      obj-&gt;options-&gt;headers != MimeHeadersCitation &amp;&amp;</span>
<a href="#l43.546"></a><span id="l43.546" class="difflineplus">+      obj-&gt;options-&gt;write_html_p &amp;&amp; obj-&gt;options-&gt;output_fn)</span>
<a href="#l43.547"></a><span id="l43.547" class="difflineplus">+  // &amp;&amp; !mime_crypto_object_p(enc-&gt;hdrs, true, obj-&gt;options)) // XXX fix later</span>
<a href="#l43.548"></a><span id="l43.548" class="difflineplus">+  // XXX //</span>
<a href="#l43.549"></a><span id="l43.549">   {</span>
<a href="#l43.550"></a><span id="l43.550">     char *html;</span>
<a href="#l43.551"></a><span id="l43.551" class="difflineminus">-#if 0 // XXX Fix this later XXX //</span>
<a href="#l43.552"></a><span id="l43.552" class="difflineplus">+#if 0  // XXX Fix this later XXX //</span>
<a href="#l43.553"></a><span id="l43.553">     char *html = (((MimeEncryptedClass *) obj-&gt;clazz)-&gt;crypto_generate_html</span>
<a href="#l43.554"></a><span id="l43.554">           (enc-&gt;crypto_closure));</span>
<a href="#l43.555"></a><span id="l43.555">     if (!html) return -1; /* MK_OUT_OF_MEMORY? */</span>
<a href="#l43.556"></a><span id="l43.556"> </span>
<a href="#l43.557"></a><span id="l43.557">     status = MimeObject_write(obj, html, strlen(html), false);</span>
<a href="#l43.558"></a><span id="l43.558">     PR_FREEIF(html);</span>
<a href="#l43.559"></a><span id="l43.559">     if (status &lt; 0) return status;</span>
<a href="#l43.560"></a><span id="l43.560"> #endif</span>
<a href="#l43.561"></a><span id="l43.561"> </span>
<a href="#l43.562"></a><span id="l43.562">     /* Now that we have written out the crypto stamp, the outermost header</span>
<a href="#l43.563"></a><span id="l43.563">      block is well and truly closed.  If this is in fact the outermost</span>
<a href="#l43.564"></a><span id="l43.564">      message, then run the post_header_html_fn now.</span>
<a href="#l43.565"></a><span id="l43.565">      */</span>
<a href="#l43.566"></a><span id="l43.566" class="difflineminus">-    if (obj-&gt;options &amp;&amp;</span>
<a href="#l43.567"></a><span id="l43.567" class="difflineminus">-      obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l43.568"></a><span id="l43.568" class="difflineminus">-      obj-&gt;options-&gt;generate_post_header_html_fn &amp;&amp;</span>
<a href="#l43.569"></a><span id="l43.569" class="difflineminus">-      !obj-&gt;options-&gt;state-&gt;post_header_html_run_p)</span>
<a href="#l43.570"></a><span id="l43.570" class="difflineminus">-    {</span>
<a href="#l43.571"></a><span id="l43.571" class="difflineplus">+    if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l43.572"></a><span id="l43.572" class="difflineplus">+        obj-&gt;options-&gt;generate_post_header_html_fn &amp;&amp;</span>
<a href="#l43.573"></a><span id="l43.573" class="difflineplus">+        !obj-&gt;options-&gt;state-&gt;post_header_html_run_p) {</span>
<a href="#l43.574"></a><span id="l43.574">       MimeHeaders *outer_headers = nullptr;</span>
<a href="#l43.575"></a><span id="l43.575">       MimeObject *p;</span>
<a href="#l43.576"></a><span id="l43.576" class="difflineminus">-      for (p = obj; p-&gt;parent; p = p-&gt;parent)</span>
<a href="#l43.577"></a><span id="l43.577" class="difflineminus">-        outer_headers = p-&gt;headers;</span>
<a href="#l43.578"></a><span id="l43.578" class="difflineminus">-      NS_ASSERTION(obj-&gt;options-&gt;state-&gt;first_data_written_p, &quot;1.2 &lt;mscott@netscape.com&gt; 01 Nov 2001 17:59&quot;);</span>
<a href="#l43.579"></a><span id="l43.579" class="difflineminus">-      html = obj-&gt;options-&gt;generate_post_header_html_fn(NULL,</span>
<a href="#l43.580"></a><span id="l43.580" class="difflineminus">-                          obj-&gt;options-&gt;html_closure,</span>
<a href="#l43.581"></a><span id="l43.581" class="difflineminus">-                              outer_headers);</span>
<a href="#l43.582"></a><span id="l43.582" class="difflineplus">+      for (p = obj; p-&gt;parent; p = p-&gt;parent) outer_headers = p-&gt;headers;</span>
<a href="#l43.583"></a><span id="l43.583" class="difflineplus">+      NS_ASSERTION(obj-&gt;options-&gt;state-&gt;first_data_written_p,</span>
<a href="#l43.584"></a><span id="l43.584" class="difflineplus">+                   &quot;1.2 &lt;mscott@netscape.com&gt; 01 Nov 2001 17:59&quot;);</span>
<a href="#l43.585"></a><span id="l43.585" class="difflineplus">+      html = obj-&gt;options-&gt;generate_post_header_html_fn(</span>
<a href="#l43.586"></a><span id="l43.586" class="difflineplus">+          NULL, obj-&gt;options-&gt;html_closure, outer_headers);</span>
<a href="#l43.587"></a><span id="l43.587">       obj-&gt;options-&gt;state-&gt;post_header_html_run_p = true;</span>
<a href="#l43.588"></a><span id="l43.588" class="difflineminus">-      if (html)</span>
<a href="#l43.589"></a><span id="l43.589" class="difflineminus">-      {</span>
<a href="#l43.590"></a><span id="l43.590" class="difflineplus">+      if (html) {</span>
<a href="#l43.591"></a><span id="l43.591">         status = MimeObject_write(obj, html, strlen(html), false);</span>
<a href="#l43.592"></a><span id="l43.592">         PR_FREEIF(html);</span>
<a href="#l43.593"></a><span id="l43.593">         if (status &lt; 0) return status;</span>
<a href="#l43.594"></a><span id="l43.594">       }</span>
<a href="#l43.595"></a><span id="l43.595">     }</span>
<a href="#l43.596"></a><span id="l43.596" class="difflineminus">-  }</span>
<a href="#l43.597"></a><span id="l43.597" class="difflineminus">-  else if (enc-&gt;crypto_closure &amp;&amp;</span>
<a href="#l43.598"></a><span id="l43.598" class="difflineminus">-       obj-&gt;options &amp;&amp;</span>
<a href="#l43.599"></a><span id="l43.599" class="difflineminus">-     obj-&gt;options-&gt;decrypt_p)</span>
<a href="#l43.600"></a><span id="l43.600" class="difflineminus">-  {</span>
<a href="#l43.601"></a><span id="l43.601" class="difflineplus">+  } else if (enc-&gt;crypto_closure &amp;&amp; obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decrypt_p) {</span>
<a href="#l43.602"></a><span id="l43.602">     /* Do this just to cause `mime_set_crypto_stamp' to be called, and to</span>
<a href="#l43.603"></a><span id="l43.603">      cause the various `decode_error' and `verify_error' slots to be set:</span>
<a href="#l43.604"></a><span id="l43.604">      we don't actually use the returned HTML, because we're not emitting</span>
<a href="#l43.605"></a><span id="l43.605">      HTML.  It's maybe not such a good thing that the determination of</span>
<a href="#l43.606"></a><span id="l43.606">      whether it was encrypted or not is tied up with generating HTML,</span>
<a href="#l43.607"></a><span id="l43.607">      but oh well. */</span>
<a href="#l43.608"></a><span id="l43.608" class="difflineminus">-    char *html = (((MimeEncryptedClass *) obj-&gt;clazz)-&gt;crypto_generate_html</span>
<a href="#l43.609"></a><span id="l43.609" class="difflineminus">-          (enc-&gt;crypto_closure));</span>
<a href="#l43.610"></a><span id="l43.610" class="difflineplus">+    char *html = (((MimeEncryptedClass *)obj-&gt;clazz)</span>
<a href="#l43.611"></a><span id="l43.611" class="difflineplus">+                      -&gt;crypto_generate_html(enc-&gt;crypto_closure));</span>
<a href="#l43.612"></a><span id="l43.612">     PR_FREEIF(html);</span>
<a href="#l43.613"></a><span id="l43.613">   }</span>
<a href="#l43.614"></a><span id="l43.614"> </span>
<a href="#l43.615"></a><span id="l43.615">   if (enc-&gt;hdrs)</span>
<a href="#l43.616"></a><span id="l43.616" class="difflineminus">-  ct = MimeHeaders_get (enc-&gt;hdrs, HEADER_CONTENT_TYPE, true, false);</span>
<a href="#l43.617"></a><span id="l43.617" class="difflineplus">+    ct = MimeHeaders_get(enc-&gt;hdrs, HEADER_CONTENT_TYPE, true, false);</span>
<a href="#l43.618"></a><span id="l43.618">   body = mime_create((ct ? ct : TEXT_PLAIN), enc-&gt;hdrs, obj-&gt;options);</span>
<a href="#l43.619"></a><span id="l43.619"> </span>
<a href="#l43.620"></a><span id="l43.620"> #ifdef MIME_DRAFTS</span>
<a href="#l43.621"></a><span id="l43.621">   if (obj-&gt;options-&gt;decompose_file_p) {</span>
<a href="#l43.622"></a><span id="l43.622" class="difflineminus">-  if (mime_typep (body, (MimeObjectClass*) &amp;mimeMultipartClass) )</span>
<a href="#l43.623"></a><span id="l43.623" class="difflineminus">-    obj-&gt;options-&gt;is_multipart_msg = true;</span>
<a href="#l43.624"></a><span id="l43.624" class="difflineminus">-  else if (obj-&gt;options-&gt;decompose_file_init_fn)</span>
<a href="#l43.625"></a><span id="l43.625" class="difflineminus">-    obj-&gt;options-&gt;decompose_file_init_fn(obj-&gt;options-&gt;stream_closure,</span>
<a href="#l43.626"></a><span id="l43.626" class="difflineminus">-                       enc-&gt;hdrs);</span>
<a href="#l43.627"></a><span id="l43.627" class="difflineplus">+    if (mime_typep(body, (MimeObjectClass *)&amp;mimeMultipartClass))</span>
<a href="#l43.628"></a><span id="l43.628" class="difflineplus">+      obj-&gt;options-&gt;is_multipart_msg = true;</span>
<a href="#l43.629"></a><span id="l43.629" class="difflineplus">+    else if (obj-&gt;options-&gt;decompose_file_init_fn)</span>
<a href="#l43.630"></a><span id="l43.630" class="difflineplus">+      obj-&gt;options-&gt;decompose_file_init_fn(obj-&gt;options-&gt;stream_closure,</span>
<a href="#l43.631"></a><span id="l43.631" class="difflineplus">+                                           enc-&gt;hdrs);</span>
<a href="#l43.632"></a><span id="l43.632">   }</span>
<a href="#l43.633"></a><span id="l43.633"> #endif /* MIME_DRAFTS */</span>
<a href="#l43.634"></a><span id="l43.634"> </span>
<a href="#l43.635"></a><span id="l43.635">   PR_FREEIF(ct);</span>
<a href="#l43.636"></a><span id="l43.636"> </span>
<a href="#l43.637"></a><span id="l43.637">   if (!body) return MIME_OUT_OF_MEMORY;</span>
<a href="#l43.638"></a><span id="l43.638" class="difflineminus">-  status = ((MimeContainerClass *) obj-&gt;clazz)-&gt;add_child (obj, body);</span>
<a href="#l43.639"></a><span id="l43.639" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l43.640"></a><span id="l43.640" class="difflineminus">-  {</span>
<a href="#l43.641"></a><span id="l43.641" class="difflineplus">+  status = ((MimeContainerClass *)obj-&gt;clazz)-&gt;add_child(obj, body);</span>
<a href="#l43.642"></a><span id="l43.642" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l43.643"></a><span id="l43.643">     mime_free(body);</span>
<a href="#l43.644"></a><span id="l43.644">     return status;</span>
<a href="#l43.645"></a><span id="l43.645">   }</span>
<a href="#l43.646"></a><span id="l43.646"> </span>
<a href="#l43.647"></a><span id="l43.647">   /* Now that we've added this new object to our list of children,</span>
<a href="#l43.648"></a><span id="l43.648">    start its parser going. */</span>
<a href="#l43.649"></a><span id="l43.649">   status = body-&gt;clazz-&gt;parse_begin(body);</span>
<a href="#l43.650"></a><span id="l43.650">   if (status &lt; 0) return status;</span>
<a href="#l43.651"></a><span id="l43.651"> </span>
<a href="#l43.652"></a><span id="l43.652">   /* If this object (or the parent) is being output, then by definition</span>
<a href="#l43.653"></a><span id="l43.653">    the child is as well.  (This is only necessary because this is such</span>
<a href="#l43.654"></a><span id="l43.654">    a funny sort of container...)</span>
<a href="#l43.655"></a><span id="l43.655">    */</span>
<a href="#l43.656"></a><span id="l43.656">   if (!body-&gt;output_p &amp;&amp;</span>
<a href="#l43.657"></a><span id="l43.657" class="difflineminus">-    (obj-&gt;output_p ||</span>
<a href="#l43.658"></a><span id="l43.658" class="difflineminus">-     (obj-&gt;parent &amp;&amp; obj-&gt;parent-&gt;output_p)))</span>
<a href="#l43.659"></a><span id="l43.659" class="difflineminus">-  body-&gt;output_p = true;</span>
<a href="#l43.660"></a><span id="l43.660" class="difflineplus">+      (obj-&gt;output_p || (obj-&gt;parent &amp;&amp; obj-&gt;parent-&gt;output_p)))</span>
<a href="#l43.661"></a><span id="l43.661" class="difflineplus">+    body-&gt;output_p = true;</span>
<a href="#l43.662"></a><span id="l43.662"> </span>
<a href="#l43.663"></a><span id="l43.663">   /* If the body is being written raw (not as HTML) then make sure to</span>
<a href="#l43.664"></a><span id="l43.664">    write its headers as well. */</span>
<a href="#l43.665"></a><span id="l43.665" class="difflineminus">-  if (body-&gt;output_p &amp;&amp; obj-&gt;output_p &amp;&amp; !obj-&gt;options-&gt;write_html_p)</span>
<a href="#l43.666"></a><span id="l43.666" class="difflineminus">-  {</span>
<a href="#l43.667"></a><span id="l43.667" class="difflineminus">-    status = MimeObject_write(body, &quot;&quot;, 0, false);  /* initialize */</span>
<a href="#l43.668"></a><span id="l43.668" class="difflineplus">+  if (body-&gt;output_p &amp;&amp; obj-&gt;output_p &amp;&amp; !obj-&gt;options-&gt;write_html_p) {</span>
<a href="#l43.669"></a><span id="l43.669" class="difflineplus">+    status = MimeObject_write(body, &quot;&quot;, 0, false); /* initialize */</span>
<a href="#l43.670"></a><span id="l43.670">     if (status &lt; 0) return status;</span>
<a href="#l43.671"></a><span id="l43.671" class="difflineminus">-    status = MimeHeaders_write_raw_headers(body-&gt;headers, obj-&gt;options,</span>
<a href="#l43.672"></a><span id="l43.672" class="difflineminus">-                       false);</span>
<a href="#l43.673"></a><span id="l43.673" class="difflineplus">+    status = MimeHeaders_write_raw_headers(body-&gt;headers, obj-&gt;options, false);</span>
<a href="#l43.674"></a><span id="l43.674">     if (status &lt; 0) return status;</span>
<a href="#l43.675"></a><span id="l43.675">   }</span>
<a href="#l43.676"></a><span id="l43.676"> </span>
<a href="#l43.677"></a><span id="l43.677" class="difflineminus">-  if (enc-&gt;part_buffer)  /* part_buffer is 0 for 0-length encrypted data. */</span>
<a href="#l43.678"></a><span id="l43.678" class="difflineplus">+  if (enc-&gt;part_buffer) /* part_buffer is 0 for 0-length encrypted data. */</span>
<a href="#l43.679"></a><span id="l43.679">   {</span>
<a href="#l43.680"></a><span id="l43.680"> #ifdef MIME_DRAFTS</span>
<a href="#l43.681"></a><span id="l43.681" class="difflineminus">-    if (obj-&gt;options-&gt;decompose_file_p &amp;&amp; !obj-&gt;options-&gt;is_multipart_msg)</span>
<a href="#l43.682"></a><span id="l43.682" class="difflineminus">-    {</span>
<a href="#l43.683"></a><span id="l43.683" class="difflineminus">-    status = MimePartBufferRead(enc-&gt;part_buffer,</span>
<a href="#l43.684"></a><span id="l43.684" class="difflineminus">-                /* The (MimeConverterOutputCallback) cast is to turn the `void'</span>
<a href="#l43.685"></a><span id="l43.685" class="difflineminus">-                   argument into `MimeObject'. */</span>
<a href="#l43.686"></a><span id="l43.686" class="difflineminus">-                 ((MimeConverterOutputCallback)</span>
<a href="#l43.687"></a><span id="l43.687" class="difflineminus">-                obj-&gt;options-&gt;decompose_file_output_fn),</span>
<a href="#l43.688"></a><span id="l43.688" class="difflineminus">-                obj-&gt;options-&gt;stream_closure);</span>
<a href="#l43.689"></a><span id="l43.689" class="difflineminus">-    }</span>
<a href="#l43.690"></a><span id="l43.690" class="difflineminus">-    else</span>
<a href="#l43.691"></a><span id="l43.691" class="difflineminus">-    {</span>
<a href="#l43.692"></a><span id="l43.692" class="difflineplus">+    if (obj-&gt;options-&gt;decompose_file_p &amp;&amp; !obj-&gt;options-&gt;is_multipart_msg) {</span>
<a href="#l43.693"></a><span id="l43.693" class="difflineplus">+      status = MimePartBufferRead(</span>
<a href="#l43.694"></a><span id="l43.694" class="difflineplus">+          enc-&gt;part_buffer,</span>
<a href="#l43.695"></a><span id="l43.695" class="difflineplus">+          /* The (MimeConverterOutputCallback) cast is to turn the `void'</span>
<a href="#l43.696"></a><span id="l43.696" class="difflineplus">+             argument into `MimeObject'. */</span>
<a href="#l43.697"></a><span id="l43.697" class="difflineplus">+          ((MimeConverterOutputCallback)obj-&gt;options-&gt;decompose_file_output_fn),</span>
<a href="#l43.698"></a><span id="l43.698" class="difflineplus">+          obj-&gt;options-&gt;stream_closure);</span>
<a href="#l43.699"></a><span id="l43.699" class="difflineplus">+    } else {</span>
<a href="#l43.700"></a><span id="l43.700"> #endif /* MIME_DRAFTS */</span>
<a href="#l43.701"></a><span id="l43.701"> </span>
<a href="#l43.702"></a><span id="l43.702" class="difflineminus">-  status = MimePartBufferRead(enc-&gt;part_buffer,</span>
<a href="#l43.703"></a><span id="l43.703" class="difflineminus">-                /* The (MimeConverterOutputCallback) cast is to turn the `void'</span>
<a href="#l43.704"></a><span id="l43.704" class="difflineminus">-                   argument into `MimeObject'. */</span>
<a href="#l43.705"></a><span id="l43.705" class="difflineminus">-                 ((MimeConverterOutputCallback) body-&gt;clazz-&gt;parse_buffer),</span>
<a href="#l43.706"></a><span id="l43.706" class="difflineminus">-                body);</span>
<a href="#l43.707"></a><span id="l43.707" class="difflineplus">+      status = MimePartBufferRead(</span>
<a href="#l43.708"></a><span id="l43.708" class="difflineplus">+          enc-&gt;part_buffer,</span>
<a href="#l43.709"></a><span id="l43.709" class="difflineplus">+          /* The (MimeConverterOutputCallback) cast is to turn the `void'</span>
<a href="#l43.710"></a><span id="l43.710" class="difflineplus">+             argument into `MimeObject'. */</span>
<a href="#l43.711"></a><span id="l43.711" class="difflineplus">+          ((MimeConverterOutputCallback)body-&gt;clazz-&gt;parse_buffer), body);</span>
<a href="#l43.712"></a><span id="l43.712"> #ifdef MIME_DRAFTS</span>
<a href="#l43.713"></a><span id="l43.713">     }</span>
<a href="#l43.714"></a><span id="l43.714"> #endif /* MIME_DRAFTS */</span>
<a href="#l43.715"></a><span id="l43.715">   }</span>
<a href="#l43.716"></a><span id="l43.716">   if (status &lt; 0) return status;</span>
<a href="#l43.717"></a><span id="l43.717"> </span>
<a href="#l43.718"></a><span id="l43.718">   /* The child has been fully processed.  Close it off.</span>
<a href="#l43.719"></a><span id="l43.719">    */</span>
<a href="#l43.720"></a><span id="l43.720" class="difflineat">@@ -559,12 +481,12 @@ MimeEncrypted_emit_buffered_child(MimeOb</span>
<a href="#l43.721"></a><span id="l43.721">   if (obj-&gt;options-&gt;decompose_file_p &amp;&amp; !obj-&gt;options-&gt;is_multipart_msg)</span>
<a href="#l43.722"></a><span id="l43.722">     obj-&gt;options-&gt;decompose_file_close_fn(obj-&gt;options-&gt;stream_closure);</span>
<a href="#l43.723"></a><span id="l43.723"> #endif /* MIME_DRAFTS */</span>
<a href="#l43.724"></a><span id="l43.724"> </span>
<a href="#l43.725"></a><span id="l43.725">   /* Put out a separator after every encrypted object. */</span>
<a href="#l43.726"></a><span id="l43.726">   status = MimeObject_write_separator(obj);</span>
<a href="#l43.727"></a><span id="l43.727">   if (status &lt; 0) return status;</span>
<a href="#l43.728"></a><span id="l43.728"> </span>
<a href="#l43.729"></a><span id="l43.729" class="difflineminus">-  MimeEncrypted_cleanup (obj, false);</span>
<a href="#l43.730"></a><span id="l43.730" class="difflineplus">+  MimeEncrypted_cleanup(obj, false);</span>
<a href="#l43.731"></a><span id="l43.731"> </span>
<a href="#l43.732"></a><span id="l43.732">   return 0;</span>
<a href="#l43.733"></a><span id="l43.733"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/mime/src/mimecryp.h</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/mime/src/mimecryp.h</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -94,47 +94,46 @@</span>
<a href="#l44.4"></a><span id="l44.4">    afforementioned leaf/container hybridization.  This method is invoked</span>
<a href="#l44.5"></a><span id="l44.5">    with the content-transfer-decoded body of this part (without line</span>
<a href="#l44.6"></a><span id="l44.6">    buffering.)  The default behavior of this method is to simply invoke</span>
<a href="#l44.7"></a><span id="l44.7">    `crypto_write' on the data with which it is called.  It's unlikely that</span>
<a href="#l44.8"></a><span id="l44.8">    a subclass will need to specialize this.</span>
<a href="#l44.9"></a><span id="l44.9">  */</span>
<a href="#l44.10"></a><span id="l44.10"> </span>
<a href="#l44.11"></a><span id="l44.11"> typedef struct MimeEncryptedClass MimeEncryptedClass;</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-typedef struct MimeEncrypted      MimeEncrypted;</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+typedef struct MimeEncrypted MimeEncrypted;</span>
<a href="#l44.14"></a><span id="l44.14"> </span>
<a href="#l44.15"></a><span id="l44.15"> struct MimeEncryptedClass {</span>
<a href="#l44.16"></a><span id="l44.16">   MimeContainerClass container;</span>
<a href="#l44.17"></a><span id="l44.17"> </span>
<a href="#l44.18"></a><span id="l44.18">   /* Duplicated from MimeLeaf, see comments above.</span>
<a href="#l44.19"></a><span id="l44.19">      This is the callback that is handed to the decoder. */</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineminus">-  int (*parse_decoded_buffer) (const char *buf, int32_t size, MimeObject *obj);</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineminus">-</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+  int (*parse_decoded_buffer)(const char *buf, int32_t size, MimeObject *obj);</span>
<a href="#l44.23"></a><span id="l44.23"> </span>
<a href="#l44.24"></a><span id="l44.24">   /* Callbacks used by decryption module. */</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineminus">-  void * (*crypto_init) (MimeObject *obj,</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineminus">-             int (*output_fn) (const char *data, int32_t data_size,</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineminus">-                       void *output_closure),</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineminus">-             void *output_closure);</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineminus">-  int (*crypto_write) (const char *data, int32_t data_size,</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineminus">-             void *crypto_closure);</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineminus">-  int (*crypto_eof) (void *crypto_closure, bool abort_p);</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineminus">-  char * (*crypto_generate_html) (void *crypto_closure);</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineminus">-  void (*crypto_free) (void *crypto_closure);</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+  void *(*crypto_init)(MimeObject *obj,</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineplus">+                       int (*output_fn)(const char *data, int32_t data_size,</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+                                        void *output_closure),</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+                       void *output_closure);</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+  int (*crypto_write)(const char *data, int32_t data_size,</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineplus">+                      void *crypto_closure);</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineplus">+  int (*crypto_eof)(void *crypto_closure, bool abort_p);</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineplus">+  char *(*crypto_generate_html)(void *crypto_closure);</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineplus">+  void (*crypto_free)(void *crypto_closure);</span>
<a href="#l44.43"></a><span id="l44.43"> };</span>
<a href="#l44.44"></a><span id="l44.44"> </span>
<a href="#l44.45"></a><span id="l44.45"> extern MimeEncryptedClass mimeEncryptedClass;</span>
<a href="#l44.46"></a><span id="l44.46"> </span>
<a href="#l44.47"></a><span id="l44.47"> struct MimeEncrypted {</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineminus">-  MimeContainer container;     /* superclass variables */</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineminus">-  void *crypto_closure;       /* Opaque data used by decryption module. */</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineminus">-  MimeDecoderData *decoder_data; /* Opaque data for the Transfer-Encoding</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineminus">-                  decoder. */</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineminus">-  MimeHeaders *hdrs;       /* Headers of the enclosed object (including</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineminus">-                  the type of the *decrypted* data.) */</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineminus">-  MimePartBufferData *part_buffer;  /* The data of the decrypted enclosed</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineminus">-                     object (see mimepbuf.h) */</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineplus">+  MimeContainer container;         /* superclass variables */</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineplus">+  void *crypto_closure;            /* Opaque data used by decryption module. */</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineplus">+  MimeDecoderData *decoder_data;   /* Opaque data for the Transfer-Encoding</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+                    decoder. */</span>
<a href="#l44.60"></a><span id="l44.60" class="difflineplus">+  MimeHeaders *hdrs;               /* Headers of the enclosed object (including</span>
<a href="#l44.61"></a><span id="l44.61" class="difflineplus">+                          the type of the *decrypted* data.) */</span>
<a href="#l44.62"></a><span id="l44.62" class="difflineplus">+  MimePartBufferData *part_buffer; /* The data of the decrypted enclosed</span>
<a href="#l44.63"></a><span id="l44.63" class="difflineplus">+                    object (see mimepbuf.h) */</span>
<a href="#l44.64"></a><span id="l44.64"> };</span>
<a href="#l44.65"></a><span id="l44.65"> </span>
<a href="#l44.66"></a><span id="l44.66" class="difflineminus">-#define MimeEncryptedClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l44.67"></a><span id="l44.67" class="difflineminus">-  { MimeContainerClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineplus">+#define MimeEncryptedClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineplus">+  { MimeContainerClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l44.70"></a><span id="l44.70"> </span>
<a href="#l44.71"></a><span id="l44.71"> #endif /* _MIMECRYP_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/mime/src/mimecth.cpp</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/mime/src/mimecth.cpp</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -3,49 +3,31 @@</span>
<a href="#l45.4"></a><span id="l45.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l45.5"></a><span id="l45.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l45.6"></a><span id="l45.6"> #include &quot;mimecth.h&quot;</span>
<a href="#l45.7"></a><span id="l45.7"> </span>
<a href="#l45.8"></a><span id="l45.8"> /*</span>
<a href="#l45.9"></a><span id="l45.9">  * These calls are necessary to expose the object class hierarchy</span>
<a href="#l45.10"></a><span id="l45.10">  * to externally developed content type handlers.</span>
<a href="#l45.11"></a><span id="l45.11">  */</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-MimeInlineTextClass *</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineminus">-MIME_GetmimeInlineTextClass(void)</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineminus">-{</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+MimeInlineTextClass* MIME_GetmimeInlineTextClass(void) {</span>
<a href="#l45.16"></a><span id="l45.16">   return &amp;mimeInlineTextClass;</span>
<a href="#l45.17"></a><span id="l45.17"> }</span>
<a href="#l45.18"></a><span id="l45.18"> </span>
<a href="#l45.19"></a><span id="l45.19" class="difflineminus">-MimeLeafClass *</span>
<a href="#l45.20"></a><span id="l45.20" class="difflineminus">-MIME_GetmimeLeafClass(void)</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineminus">-{</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineminus">-  return &amp;mimeLeafClass;</span>
<a href="#l45.23"></a><span id="l45.23" class="difflineminus">-}</span>
<a href="#l45.24"></a><span id="l45.24" class="difflineplus">+MimeLeafClass* MIME_GetmimeLeafClass(void) { return &amp;mimeLeafClass; }</span>
<a href="#l45.25"></a><span id="l45.25"> </span>
<a href="#l45.26"></a><span id="l45.26" class="difflineminus">-MimeObjectClass *</span>
<a href="#l45.27"></a><span id="l45.27" class="difflineminus">-MIME_GetmimeObjectClass(void)</span>
<a href="#l45.28"></a><span id="l45.28" class="difflineminus">-{</span>
<a href="#l45.29"></a><span id="l45.29" class="difflineminus">-  return &amp;mimeObjectClass;</span>
<a href="#l45.30"></a><span id="l45.30" class="difflineminus">-}</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineplus">+MimeObjectClass* MIME_GetmimeObjectClass(void) { return &amp;mimeObjectClass; }</span>
<a href="#l45.32"></a><span id="l45.32"> </span>
<a href="#l45.33"></a><span id="l45.33" class="difflineminus">-MimeContainerClass *</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineminus">-MIME_GetmimeContainerClass(void)</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineminus">-{</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineplus">+MimeContainerClass* MIME_GetmimeContainerClass(void) {</span>
<a href="#l45.37"></a><span id="l45.37">   return &amp;mimeContainerClass;</span>
<a href="#l45.38"></a><span id="l45.38"> }</span>
<a href="#l45.39"></a><span id="l45.39"> </span>
<a href="#l45.40"></a><span id="l45.40" class="difflineminus">-MimeMultipartClass *</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineminus">-MIME_GetmimeMultipartClass(void)</span>
<a href="#l45.42"></a><span id="l45.42" class="difflineminus">-{</span>
<a href="#l45.43"></a><span id="l45.43" class="difflineplus">+MimeMultipartClass* MIME_GetmimeMultipartClass(void) {</span>
<a href="#l45.44"></a><span id="l45.44">   return &amp;mimeMultipartClass;</span>
<a href="#l45.45"></a><span id="l45.45"> }</span>
<a href="#l45.46"></a><span id="l45.46"> </span>
<a href="#l45.47"></a><span id="l45.47" class="difflineminus">-MimeMultipartSignedClass *</span>
<a href="#l45.48"></a><span id="l45.48" class="difflineminus">-MIME_GetmimeMultipartSignedClass(void)</span>
<a href="#l45.49"></a><span id="l45.49" class="difflineminus">-{</span>
<a href="#l45.50"></a><span id="l45.50" class="difflineplus">+MimeMultipartSignedClass* MIME_GetmimeMultipartSignedClass(void) {</span>
<a href="#l45.51"></a><span id="l45.51">   return &amp;mimeMultipartSignedClass;</span>
<a href="#l45.52"></a><span id="l45.52"> }</span>
<a href="#l45.53"></a><span id="l45.53"> </span>
<a href="#l45.54"></a><span id="l45.54" class="difflineminus">-MimeEncryptedClass *</span>
<a href="#l45.55"></a><span id="l45.55" class="difflineminus">-MIME_GetmimeEncryptedClass(void)</span>
<a href="#l45.56"></a><span id="l45.56" class="difflineminus">-{</span>
<a href="#l45.57"></a><span id="l45.57" class="difflineplus">+MimeEncryptedClass* MIME_GetmimeEncryptedClass(void) {</span>
<a href="#l45.58"></a><span id="l45.58">   return &amp;mimeEncryptedClass;</span>
<a href="#l45.59"></a><span id="l45.59"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/mime/src/mimecth.h</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/mime/src/mimecth.h</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -10,20 +10,20 @@</span>
<a href="#l46.4"></a><span id="l46.4">  * HTML messages.</span>
<a href="#l46.5"></a><span id="l46.5">  */</span>
<a href="#l46.6"></a><span id="l46.6"> </span>
<a href="#l46.7"></a><span id="l46.7"> #ifndef _MIMECTH_H_</span>
<a href="#l46.8"></a><span id="l46.8"> #define _MIMECTH_H_</span>
<a href="#l46.9"></a><span id="l46.9"> </span>
<a href="#l46.10"></a><span id="l46.10"> #include &quot;mimei.h&quot;</span>
<a href="#l46.11"></a><span id="l46.11"> #include &quot;mimeobj.h&quot;  /*  MimeObject (abstract)              */</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-#include &quot;mimecont.h&quot;  /*   |--- MimeContainer (abstract)          */</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-#include &quot;mimemult.h&quot;  /*   |     |--- MimeMultipart (abstract)      */</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineminus">-#include &quot;mimemsig.h&quot;  /*   |     |     |--- MimeMultipartSigned (abstract)*/</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineminus">-#include &quot;mimetext.h&quot;  /*   |     |--- MimeInlineText (abstract)      */</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineplus">+#include &quot;mimecont.h&quot; /*   |--- MimeContainer (abstract)          */</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineplus">+#include &quot;mimemult.h&quot; /*   |     |--- MimeMultipart (abstract)      */</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineplus">+#include &quot;mimemsig.h&quot; /*   |     |     |--- MimeMultipartSigned (abstract)*/</span>
<a href="#l46.19"></a><span id="l46.19" class="difflineplus">+#include &quot;mimetext.h&quot; /*   |     |--- MimeInlineText (abstract)      */</span>
<a href="#l46.20"></a><span id="l46.20"> #include &quot;mimecryp.h&quot;</span>
<a href="#l46.21"></a><span id="l46.21"> </span>
<a href="#l46.22"></a><span id="l46.22"> /*</span>
<a href="#l46.23"></a><span id="l46.23">   This header exposes functions that are necessary to access the</span>
<a href="#l46.24"></a><span id="l46.24">   object hierarchy for the mime chart. The class hierarchy is:</span>
<a href="#l46.25"></a><span id="l46.25"> </span>
<a href="#l46.26"></a><span id="l46.26">      MimeObject (abstract)</span>
<a href="#l46.27"></a><span id="l46.27">       |</span>
<a href="#l46.28"></a><span id="l46.28" class="difflineat">@@ -82,54 +82,50 @@</span>
<a href="#l46.29"></a><span id="l46.29"> </span>
<a href="#l46.30"></a><span id="l46.30"> /*</span>
<a href="#l46.31"></a><span id="l46.31">  * These functions are exposed by libmime to be used by content type</span>
<a href="#l46.32"></a><span id="l46.32">  * handler plugins for processing stream data.</span>
<a href="#l46.33"></a><span id="l46.33">  */</span>
<a href="#l46.34"></a><span id="l46.34"> /*</span>
<a href="#l46.35"></a><span id="l46.35">  * This is the write call for outputting processed stream data.</span>
<a href="#l46.36"></a><span id="l46.36">  */</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineminus">-extern int                        MIME_MimeObject_write(MimeObject *,</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineminus">-                                                        const char *data,</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineminus">-                                                        int32_t length,</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineminus">-                                                        bool user_visible_p);</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineplus">+extern int MIME_MimeObject_write(MimeObject *, const char *data, int32_t length,</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineplus">+                                 bool user_visible_p);</span>
<a href="#l46.43"></a><span id="l46.43"> /*</span>
<a href="#l46.44"></a><span id="l46.44">  * The following group of calls expose the pointers for the object</span>
<a href="#l46.45"></a><span id="l46.45">  * system within libmime.</span>
<a href="#l46.46"></a><span id="l46.46">  */</span>
<a href="#l46.47"></a><span id="l46.47" class="difflineminus">-extern MimeInlineTextClass       *MIME_GetmimeInlineTextClass(void);</span>
<a href="#l46.48"></a><span id="l46.48" class="difflineminus">-extern MimeLeafClass             *MIME_GetmimeLeafClass(void);</span>
<a href="#l46.49"></a><span id="l46.49" class="difflineminus">-extern MimeObjectClass           *MIME_GetmimeObjectClass(void);</span>
<a href="#l46.50"></a><span id="l46.50" class="difflineminus">-extern MimeContainerClass        *MIME_GetmimeContainerClass(void);</span>
<a href="#l46.51"></a><span id="l46.51" class="difflineminus">-extern MimeMultipartClass        *MIME_GetmimeMultipartClass(void);</span>
<a href="#l46.52"></a><span id="l46.52" class="difflineminus">-extern MimeMultipartSignedClass  *MIME_GetmimeMultipartSignedClass(void);</span>
<a href="#l46.53"></a><span id="l46.53" class="difflineminus">-extern MimeEncryptedClass        *MIME_GetmimeEncryptedClass(void);</span>
<a href="#l46.54"></a><span id="l46.54" class="difflineplus">+extern MimeInlineTextClass *MIME_GetmimeInlineTextClass(void);</span>
<a href="#l46.55"></a><span id="l46.55" class="difflineplus">+extern MimeLeafClass *MIME_GetmimeLeafClass(void);</span>
<a href="#l46.56"></a><span id="l46.56" class="difflineplus">+extern MimeObjectClass *MIME_GetmimeObjectClass(void);</span>
<a href="#l46.57"></a><span id="l46.57" class="difflineplus">+extern MimeContainerClass *MIME_GetmimeContainerClass(void);</span>
<a href="#l46.58"></a><span id="l46.58" class="difflineplus">+extern MimeMultipartClass *MIME_GetmimeMultipartClass(void);</span>
<a href="#l46.59"></a><span id="l46.59" class="difflineplus">+extern MimeMultipartSignedClass *MIME_GetmimeMultipartSignedClass(void);</span>
<a href="#l46.60"></a><span id="l46.60" class="difflineplus">+extern MimeEncryptedClass *MIME_GetmimeEncryptedClass(void);</span>
<a href="#l46.61"></a><span id="l46.61"> </span>
<a href="#l46.62"></a><span id="l46.62"> /*</span>
<a href="#l46.63"></a><span id="l46.63">  * These are the functions that need to be implemented by the</span>
<a href="#l46.64"></a><span id="l46.64">  * content type handler plugin. They will be called by by libmime</span>
<a href="#l46.65"></a><span id="l46.65">  * when the module is loaded at runtime.</span>
<a href="#l46.66"></a><span id="l46.66">  */</span>
<a href="#l46.67"></a><span id="l46.67"> </span>
<a href="#l46.68"></a><span id="l46.68"> /*</span>
<a href="#l46.69"></a><span id="l46.69">  * MIME_GetContentType() is called by libmime to identify the content</span>
<a href="#l46.70"></a><span id="l46.70">  * type handled by this plugin.</span>
<a href="#l46.71"></a><span id="l46.71">  */</span>
<a href="#l46.72"></a><span id="l46.72" class="difflineminus">-extern &quot;C&quot;</span>
<a href="#l46.73"></a><span id="l46.73" class="difflineminus">-char            *MIME_GetContentType(void);</span>
<a href="#l46.74"></a><span id="l46.74" class="difflineplus">+extern &quot;C&quot; char *MIME_GetContentType(void);</span>
<a href="#l46.75"></a><span id="l46.75"> </span>
<a href="#l46.76"></a><span id="l46.76"> /*</span>
<a href="#l46.77"></a><span id="l46.77">  * This will create the MimeObjectClass object to be used by the libmime</span>
<a href="#l46.78"></a><span id="l46.78">  * object system.</span>
<a href="#l46.79"></a><span id="l46.79">  */</span>
<a href="#l46.80"></a><span id="l46.80" class="difflineminus">-extern &quot;C&quot;</span>
<a href="#l46.81"></a><span id="l46.81" class="difflineminus">-MimeObjectClass *MIME_CreateContentTypeHandlerClass(const char *content_type,</span>
<a href="#l46.82"></a><span id="l46.82" class="difflineminus">-                                   contentTypeHandlerInitStruct *initStruct);</span>
<a href="#l46.83"></a><span id="l46.83" class="difflineplus">+extern &quot;C&quot; MimeObjectClass *MIME_CreateContentTypeHandlerClass(</span>
<a href="#l46.84"></a><span id="l46.84" class="difflineplus">+    const char *content_type, contentTypeHandlerInitStruct *initStruct);</span>
<a href="#l46.85"></a><span id="l46.85"> </span>
<a href="#l46.86"></a><span id="l46.86"> /*</span>
<a href="#l46.87"></a><span id="l46.87">  * Typedefs for libmime to use when locating and calling the above</span>
<a href="#l46.88"></a><span id="l46.88">  * defined functions.</span>
<a href="#l46.89"></a><span id="l46.89">  */</span>
<a href="#l46.90"></a><span id="l46.90" class="difflineminus">-typedef char * (*mime_get_ct_fn_type)(void);</span>
<a href="#l46.91"></a><span id="l46.91" class="difflineminus">-typedef MimeObjectClass * (*mime_create_class_fn_type)</span>
<a href="#l46.92"></a><span id="l46.92" class="difflineminus">-                              (const char *, contentTypeHandlerInitStruct *);</span>
<a href="#l46.93"></a><span id="l46.93" class="difflineplus">+typedef char *(*mime_get_ct_fn_type)(void);</span>
<a href="#l46.94"></a><span id="l46.94" class="difflineplus">+typedef MimeObjectClass *(*mime_create_class_fn_type)(</span>
<a href="#l46.95"></a><span id="l46.95" class="difflineplus">+    const char *, contentTypeHandlerInitStruct *);</span>
<a href="#l46.96"></a><span id="l46.96"> </span>
<a href="#l46.97"></a><span id="l46.97"> #endif /* _MIMECTH_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l47.4"></a><span id="l47.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l47.5"></a><span id="l47.5">  *</span>
<a href="#l47.6"></a><span id="l47.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l47.7"></a><span id="l47.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l47.8"></a><span id="l47.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l47.9"></a><span id="l47.9" class="difflineminus">- * This Original Code has been modified by IBM Corporation. Modifications made by IBM</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineminus">- * described herein are Copyright (c) International Business Machines Corporation, 2000.</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineminus">- * Modifications to Mozilla code or documentation identified per MPL Section 3.3</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+ * This Original Code has been modified by IBM Corporation. Modifications made</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+ * by IBM described herein are Copyright (c) International Business Machines</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineplus">+ * Corporation, 2000. Modifications to Mozilla code or documentation identified</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+ * per MPL Section 3.3</span>
<a href="#l47.16"></a><span id="l47.16">  *</span>
<a href="#l47.17"></a><span id="l47.17">  * Date             Modified by     Description of modification</span>
<a href="#l47.18"></a><span id="l47.18">  * 04/20/2000       IBM Corp.      OS/2 VisualAge build.</span>
<a href="#l47.19"></a><span id="l47.19">  */</span>
<a href="#l47.20"></a><span id="l47.20"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l47.21"></a><span id="l47.21"> #include &quot;modmimee.h&quot;</span>
<a href="#l47.22"></a><span id="l47.22"> #include &quot;mimeobj.h&quot;</span>
<a href="#l47.23"></a><span id="l47.23"> #include &quot;modlmime.h&quot;</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineat">@@ -41,112 +42,112 @@</span>
<a href="#l47.25"></a><span id="l47.25"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l47.26"></a><span id="l47.26"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l47.27"></a><span id="l47.27"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l47.28"></a><span id="l47.28"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l47.29"></a><span id="l47.29"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l47.30"></a><span id="l47.30"> #include &quot;nsIMIMEService.h&quot;</span>
<a href="#l47.31"></a><span id="l47.31"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l47.32"></a><span id="l47.32"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineminus">-#include &quot;modmimee.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l47.34"></a><span id="l47.34" class="difflineplus">+#include &quot;modmimee.h&quot;  // for MimeConverterOutputCallback</span>
<a href="#l47.35"></a><span id="l47.35"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l47.36"></a><span id="l47.36"> </span>
<a href="#l47.37"></a><span id="l47.37"> using namespace mozilla::mailnews;</span>
<a href="#l47.38"></a><span id="l47.38"> </span>
<a href="#l47.39"></a><span id="l47.39"> //</span>
<a href="#l47.40"></a><span id="l47.40"> // Header strings...</span>
<a href="#l47.41"></a><span id="l47.41"> //</span>
<a href="#l47.42"></a><span id="l47.42" class="difflineminus">-#define HEADER_NNTP_POSTING_HOST      &quot;NNTP-Posting-Host&quot;</span>
<a href="#l47.43"></a><span id="l47.43" class="difflineminus">-#define MIME_HEADER_TABLE             &quot;&lt;TABLE CELLPADDING=0 CELLSPACING=0 BORDER=0 class=\&quot;moz-email-headers-table\&quot;&gt;&quot;</span>
<a href="#l47.44"></a><span id="l47.44" class="difflineminus">-#define HEADER_START_JUNK             &quot;&lt;TR&gt;&lt;TH VALIGN=BASELINE ALIGN=RIGHT NOWRAP&gt;&quot;</span>
<a href="#l47.45"></a><span id="l47.45" class="difflineminus">-#define HEADER_MIDDLE_JUNK            &quot;: &lt;/TH&gt;&lt;TD&gt;&quot;</span>
<a href="#l47.46"></a><span id="l47.46" class="difflineminus">-#define HEADER_END_JUNK               &quot;&lt;/TD&gt;&lt;/TR&gt;&quot;</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineplus">+#define HEADER_NNTP_POSTING_HOST &quot;NNTP-Posting-Host&quot;</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineplus">+#define MIME_HEADER_TABLE                        \</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineplus">+  &quot;&lt;TABLE CELLPADDING=0 CELLSPACING=0 BORDER=0 &quot; \</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineplus">+  &quot;class=\&quot;moz-email-headers-table\&quot;&gt;&quot;</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineplus">+#define HEADER_START_JUNK &quot;&lt;TR&gt;&lt;TH VALIGN=BASELINE ALIGN=RIGHT NOWRAP&gt;&quot;</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineplus">+#define HEADER_MIDDLE_JUNK &quot;: &lt;/TH&gt;&lt;TD&gt;&quot;</span>
<a href="#l47.53"></a><span id="l47.53" class="difflineplus">+#define HEADER_END_JUNK &quot;&lt;/TD&gt;&lt;/TR&gt;&quot;</span>
<a href="#l47.54"></a><span id="l47.54"> </span>
<a href="#l47.55"></a><span id="l47.55"> //</span>
<a href="#l47.56"></a><span id="l47.56"> // Forward declarations...</span>
<a href="#l47.57"></a><span id="l47.57"> //</span>
<a href="#l47.58"></a><span id="l47.58" class="difflineminus">-extern &quot;C&quot; char     *MIME_StripContinuations(char *original);</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineminus">-int                 mime_decompose_file_init_fn(void *stream_closure, MimeHeaders *headers);</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineminus">-int                 mime_decompose_file_output_fn(const char *buf, int32_t size, void *stream_closure);</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineminus">-int                 mime_decompose_file_close_fn(void *stream_closure);</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineminus">-extern int          MimeHeaders_build_heads_list(MimeHeaders *hdrs);</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineplus">+extern &quot;C&quot; char *MIME_StripContinuations(char *original);</span>
<a href="#l47.64"></a><span id="l47.64" class="difflineplus">+int mime_decompose_file_init_fn(void *stream_closure, MimeHeaders *headers);</span>
<a href="#l47.65"></a><span id="l47.65" class="difflineplus">+int mime_decompose_file_output_fn(const char *buf, int32_t size,</span>
<a href="#l47.66"></a><span id="l47.66" class="difflineplus">+                                  void *stream_closure);</span>
<a href="#l47.67"></a><span id="l47.67" class="difflineplus">+int mime_decompose_file_close_fn(void *stream_closure);</span>
<a href="#l47.68"></a><span id="l47.68" class="difflineplus">+extern int MimeHeaders_build_heads_list(MimeHeaders *hdrs);</span>
<a href="#l47.69"></a><span id="l47.69"> </span>
<a href="#l47.70"></a><span id="l47.70"> // CID's</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineminus">-static NS_DEFINE_CID(kCMsgComposeServiceCID,  NS_MSGCOMPOSESERVICE_CID);</span>
<a href="#l47.72"></a><span id="l47.72" class="difflineplus">+static NS_DEFINE_CID(kCMsgComposeServiceCID, NS_MSGCOMPOSESERVICE_CID);</span>
<a href="#l47.73"></a><span id="l47.73"> </span>
<a href="#l47.74"></a><span id="l47.74" class="difflineminus">-mime_draft_data::mime_draft_data() : url_name(nullptr), format_out(0),</span>
<a href="#l47.75"></a><span id="l47.75" class="difflineminus">-  stream(nullptr), obj(nullptr), options(nullptr), headers(nullptr),</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineminus">-  messageBody(nullptr), curAttachment(nullptr),</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineminus">-  decoder_data(nullptr), mailcharset(nullptr), forwardInline(false),</span>
<a href="#l47.78"></a><span id="l47.78" class="difflineminus">-  forwardInlineFilter(false), overrideComposeFormat(false),</span>
<a href="#l47.79"></a><span id="l47.79" class="difflineminus">-  originalMsgURI(nullptr)</span>
<a href="#l47.80"></a><span id="l47.80" class="difflineminus">-{</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineminus">-}</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineplus">+mime_draft_data::mime_draft_data()</span>
<a href="#l47.83"></a><span id="l47.83" class="difflineplus">+    : url_name(nullptr),</span>
<a href="#l47.84"></a><span id="l47.84" class="difflineplus">+      format_out(0),</span>
<a href="#l47.85"></a><span id="l47.85" class="difflineplus">+      stream(nullptr),</span>
<a href="#l47.86"></a><span id="l47.86" class="difflineplus">+      obj(nullptr),</span>
<a href="#l47.87"></a><span id="l47.87" class="difflineplus">+      options(nullptr),</span>
<a href="#l47.88"></a><span id="l47.88" class="difflineplus">+      headers(nullptr),</span>
<a href="#l47.89"></a><span id="l47.89" class="difflineplus">+      messageBody(nullptr),</span>
<a href="#l47.90"></a><span id="l47.90" class="difflineplus">+      curAttachment(nullptr),</span>
<a href="#l47.91"></a><span id="l47.91" class="difflineplus">+      decoder_data(nullptr),</span>
<a href="#l47.92"></a><span id="l47.92" class="difflineplus">+      mailcharset(nullptr),</span>
<a href="#l47.93"></a><span id="l47.93" class="difflineplus">+      forwardInline(false),</span>
<a href="#l47.94"></a><span id="l47.94" class="difflineplus">+      forwardInlineFilter(false),</span>
<a href="#l47.95"></a><span id="l47.95" class="difflineplus">+      overrideComposeFormat(false),</span>
<a href="#l47.96"></a><span id="l47.96" class="difflineplus">+      originalMsgURI(nullptr) {}</span>
<a href="#l47.97"></a><span id="l47.97"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.98"></a><span id="l47.98"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.99"></a><span id="l47.99"> // THIS SHOULD ALL MOVE TO ANOTHER FILE AFTER LANDING!</span>
<a href="#l47.100"></a><span id="l47.100"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.101"></a><span id="l47.101"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.102"></a><span id="l47.102"> </span>
<a href="#l47.103"></a><span id="l47.103"> // safe filename for all OSes</span>
<a href="#l47.104"></a><span id="l47.104"> #define SAFE_TMP_FILENAME &quot;nsmime.tmp&quot;</span>
<a href="#l47.105"></a><span id="l47.105"> </span>
<a href="#l47.106"></a><span id="l47.106"> //</span>
<a href="#l47.107"></a><span id="l47.107"> // Create a file for the a unique temp file</span>
<a href="#l47.108"></a><span id="l47.108"> // on the local machine. Caller must free memory</span>
<a href="#l47.109"></a><span id="l47.109"> //</span>
<a href="#l47.110"></a><span id="l47.110" class="difflineminus">-nsresult</span>
<a href="#l47.111"></a><span id="l47.111" class="difflineminus">-nsMsgCreateTempFile(const char *tFileName, nsIFile **tFile)</span>
<a href="#l47.112"></a><span id="l47.112" class="difflineminus">-{</span>
<a href="#l47.113"></a><span id="l47.113" class="difflineminus">-  if (!tFileName || !*tFileName)</span>
<a href="#l47.114"></a><span id="l47.114" class="difflineminus">-    tFileName = SAFE_TMP_FILENAME;</span>
<a href="#l47.115"></a><span id="l47.115" class="difflineplus">+nsresult nsMsgCreateTempFile(const char *tFileName, nsIFile **tFile) {</span>
<a href="#l47.116"></a><span id="l47.116" class="difflineplus">+  if (!tFileName || !*tFileName) tFileName = SAFE_TMP_FILENAME;</span>
<a href="#l47.117"></a><span id="l47.117"> </span>
<a href="#l47.118"></a><span id="l47.118" class="difflineminus">-  nsresult rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l47.119"></a><span id="l47.119" class="difflineminus">-                                                tFileName,</span>
<a href="#l47.120"></a><span id="l47.120" class="difflineminus">-                                                tFile);</span>
<a href="#l47.121"></a><span id="l47.121" class="difflineplus">+  nsresult rv =</span>
<a href="#l47.122"></a><span id="l47.122" class="difflineplus">+      GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR, tFileName, tFile);</span>
<a href="#l47.123"></a><span id="l47.123"> </span>
<a href="#l47.124"></a><span id="l47.124">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.125"></a><span id="l47.125"> </span>
<a href="#l47.126"></a><span id="l47.126">   rv = (*tFile)-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l47.127"></a><span id="l47.127" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l47.128"></a><span id="l47.128" class="difflineminus">-    NS_RELEASE(*tFile);</span>
<a href="#l47.129"></a><span id="l47.129" class="difflineplus">+  if (NS_FAILED(rv)) NS_RELEASE(*tFile);</span>
<a href="#l47.130"></a><span id="l47.130"> </span>
<a href="#l47.131"></a><span id="l47.131">   return rv;</span>
<a href="#l47.132"></a><span id="l47.132"> }</span>
<a href="#l47.133"></a><span id="l47.133"> </span>
<a href="#l47.134"></a><span id="l47.134" class="difflineminus">-</span>
<a href="#l47.135"></a><span id="l47.135"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.136"></a><span id="l47.136"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.137"></a><span id="l47.137"> // END OF - THIS SHOULD ALL MOVE TO ANOTHER FILE AFTER LANDING!</span>
<a href="#l47.138"></a><span id="l47.138"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.139"></a><span id="l47.139"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.140"></a><span id="l47.140"> </span>
<a href="#l47.141"></a><span id="l47.141"> typedef enum {</span>
<a href="#l47.142"></a><span id="l47.142">   nsMsg_RETURN_RECEIPT_BOOL_HEADER_MASK = 0,</span>
<a href="#l47.143"></a><span id="l47.143">   nsMsg_ENCRYPTED_BOOL_HEADER_MASK,</span>
<a href="#l47.144"></a><span id="l47.144">   nsMsg_SIGNED_BOOL_HEADER_MASK,</span>
<a href="#l47.145"></a><span id="l47.145">   nsMsg_UUENCODE_BINARY_BOOL_HEADER_MASK,</span>
<a href="#l47.146"></a><span id="l47.146">   nsMsg_ATTACH_VCARD_BOOL_HEADER_MASK,</span>
<a href="#l47.147"></a><span id="l47.147" class="difflineminus">-  nsMsg_LAST_BOOL_HEADER_MASK     // last boolean header mask; must be the last one</span>
<a href="#l47.148"></a><span id="l47.148" class="difflineminus">-                                  // DON'T remove.</span>
<a href="#l47.149"></a><span id="l47.149" class="difflineplus">+  nsMsg_LAST_BOOL_HEADER_MASK  // last boolean header mask; must be the last one</span>
<a href="#l47.150"></a><span id="l47.150" class="difflineplus">+                               // DON'T remove.</span>
<a href="#l47.151"></a><span id="l47.151"> } nsMsgBoolHeaderSet;</span>
<a href="#l47.152"></a><span id="l47.152"> </span>
<a href="#l47.153"></a><span id="l47.153"> #ifdef NS_DEBUG</span>
<a href="#l47.154"></a><span id="l47.154" class="difflineminus">-extern &quot;C&quot; void</span>
<a href="#l47.155"></a><span id="l47.155" class="difflineminus">-mime_dump_attachments(nsMsgAttachmentData *attachData)</span>
<a href="#l47.156"></a><span id="l47.156" class="difflineminus">-{</span>
<a href="#l47.157"></a><span id="l47.157" class="difflineminus">-  int32_t     i = 0;</span>
<a href="#l47.158"></a><span id="l47.158" class="difflineminus">-  class nsMsgAttachmentData  *tmp = attachData;</span>
<a href="#l47.159"></a><span id="l47.159" class="difflineplus">+extern &quot;C&quot; void mime_dump_attachments(nsMsgAttachmentData *attachData) {</span>
<a href="#l47.160"></a><span id="l47.160" class="difflineplus">+  int32_t i = 0;</span>
<a href="#l47.161"></a><span id="l47.161" class="difflineplus">+  class nsMsgAttachmentData *tmp = attachData;</span>
<a href="#l47.162"></a><span id="l47.162"> </span>
<a href="#l47.163"></a><span id="l47.163" class="difflineminus">-  while (tmp &amp;&amp; tmp-&gt;m_url)</span>
<a href="#l47.164"></a><span id="l47.164" class="difflineminus">-  {</span>
<a href="#l47.165"></a><span id="l47.165" class="difflineplus">+  while (tmp &amp;&amp; tmp-&gt;m_url) {</span>
<a href="#l47.166"></a><span id="l47.166">     printf(&quot;Real Name         : %s\n&quot;, tmp-&gt;m_realName.get());</span>
<a href="#l47.167"></a><span id="l47.167"> </span>
<a href="#l47.168"></a><span id="l47.168" class="difflineminus">-    if (tmp-&gt;m_url)</span>
<a href="#l47.169"></a><span id="l47.169" class="difflineminus">-    {</span>
<a href="#l47.170"></a><span id="l47.170" class="difflineplus">+    if (tmp-&gt;m_url) {</span>
<a href="#l47.171"></a><span id="l47.171">       ;</span>
<a href="#l47.172"></a><span id="l47.172">       printf(&quot;URL               : %s\n&quot;, tmp-&gt;m_url-&gt;GetSpecOrDefault().get());</span>
<a href="#l47.173"></a><span id="l47.173">     }</span>
<a href="#l47.174"></a><span id="l47.174"> </span>
<a href="#l47.175"></a><span id="l47.175">     printf(&quot;Desired Type      : %s\n&quot;, tmp-&gt;m_desiredType.get());</span>
<a href="#l47.176"></a><span id="l47.176">     printf(&quot;Real Type         : %s\n&quot;, tmp-&gt;m_realType.get());</span>
<a href="#l47.177"></a><span id="l47.177">     printf(&quot;Real Encoding     : %s\n&quot;, tmp-&gt;m_realEncoding.get());</span>
<a href="#l47.178"></a><span id="l47.178">     printf(&quot;Description       : %s\n&quot;, tmp-&gt;m_description.get());</span>
<a href="#l47.179"></a><span id="l47.179" class="difflineat">@@ -155,385 +156,347 @@ mime_dump_attachments(nsMsgAttachmentDat</span>
<a href="#l47.180"></a><span id="l47.180">     printf(&quot;Size in bytes     : %d\n&quot;, tmp-&gt;m_size);</span>
<a href="#l47.181"></a><span id="l47.181">     i++;</span>
<a href="#l47.182"></a><span id="l47.182">     tmp++;</span>
<a href="#l47.183"></a><span id="l47.183">   }</span>
<a href="#l47.184"></a><span id="l47.184"> }</span>
<a href="#l47.185"></a><span id="l47.185"> #endif</span>
<a href="#l47.186"></a><span id="l47.186"> </span>
<a href="#l47.187"></a><span id="l47.187"> nsresult CreateComposeParams(nsCOMPtr&lt;nsIMsgComposeParams&gt; &amp;pMsgComposeParams,</span>
<a href="#l47.188"></a><span id="l47.188" class="difflineminus">-                             nsIMsgCompFields * compFields,</span>
<a href="#l47.189"></a><span id="l47.189" class="difflineplus">+                             nsIMsgCompFields *compFields,</span>
<a href="#l47.190"></a><span id="l47.190">                              nsMsgAttachmentData *attachmentList,</span>
<a href="#l47.191"></a><span id="l47.191">                              MSG_ComposeType composeType,</span>
<a href="#l47.192"></a><span id="l47.192">                              MSG_ComposeFormat composeFormat,</span>
<a href="#l47.193"></a><span id="l47.193" class="difflineminus">-                             nsIMsgIdentity * identity,</span>
<a href="#l47.194"></a><span id="l47.194" class="difflineplus">+                             nsIMsgIdentity *identity,</span>
<a href="#l47.195"></a><span id="l47.195">                              const char *originalMsgURI,</span>
<a href="#l47.196"></a><span id="l47.196" class="difflineminus">-                             nsIMsgDBHdr *origMsgHdr)</span>
<a href="#l47.197"></a><span id="l47.197" class="difflineminus">-{</span>
<a href="#l47.198"></a><span id="l47.198" class="difflineplus">+                             nsIMsgDBHdr *origMsgHdr) {</span>
<a href="#l47.199"></a><span id="l47.199"> #ifdef NS_DEBUG</span>
<a href="#l47.200"></a><span id="l47.200">   mime_dump_attachments(attachmentList);</span>
<a href="#l47.201"></a><span id="l47.201"> #endif</span>
<a href="#l47.202"></a><span id="l47.202"> </span>
<a href="#l47.203"></a><span id="l47.203">   nsresult rv;</span>
<a href="#l47.204"></a><span id="l47.204">   nsMsgAttachmentData *curAttachment = attachmentList;</span>
<a href="#l47.205"></a><span id="l47.205" class="difflineminus">-  if (curAttachment)</span>
<a href="#l47.206"></a><span id="l47.206" class="difflineminus">-  {</span>
<a href="#l47.207"></a><span id="l47.207" class="difflineplus">+  if (curAttachment) {</span>
<a href="#l47.208"></a><span id="l47.208">     nsAutoCString spec;</span>
<a href="#l47.209"></a><span id="l47.209"> </span>
<a href="#l47.210"></a><span id="l47.210" class="difflineminus">-    while (curAttachment &amp;&amp; curAttachment-&gt;m_url)</span>
<a href="#l47.211"></a><span id="l47.211" class="difflineminus">-    {</span>
<a href="#l47.212"></a><span id="l47.212" class="difflineplus">+    while (curAttachment &amp;&amp; curAttachment-&gt;m_url) {</span>
<a href="#l47.213"></a><span id="l47.213">       rv = curAttachment-&gt;m_url-&gt;GetSpec(spec);</span>
<a href="#l47.214"></a><span id="l47.214" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l47.215"></a><span id="l47.215" class="difflineminus">-      {</span>
<a href="#l47.216"></a><span id="l47.216" class="difflineminus">-        nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l47.217"></a><span id="l47.217" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l47.218"></a><span id="l47.218" class="difflineminus">-        {</span>
<a href="#l47.219"></a><span id="l47.219" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l47.220"></a><span id="l47.220" class="difflineplus">+        nsCOMPtr&lt;nsIMsgAttachment&gt; attachment =</span>
<a href="#l47.221"></a><span id="l47.221" class="difflineplus">+            do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l47.222"></a><span id="l47.222" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; attachment) {</span>
<a href="#l47.223"></a><span id="l47.223">           nsAutoString nameStr;</span>
<a href="#l47.224"></a><span id="l47.224">           rv = nsMsgI18NConvertToUnicode(NS_LITERAL_CSTRING(&quot;UTF-8&quot;),</span>
<a href="#l47.225"></a><span id="l47.225" class="difflineminus">-                                         curAttachment-&gt;m_realName,</span>
<a href="#l47.226"></a><span id="l47.226" class="difflineminus">-                                         nameStr);</span>
<a href="#l47.227"></a><span id="l47.227" class="difflineplus">+                                         curAttachment-&gt;m_realName, nameStr);</span>
<a href="#l47.228"></a><span id="l47.228">           if (NS_FAILED(rv))</span>
<a href="#l47.229"></a><span id="l47.229">             CopyASCIItoUTF16(curAttachment-&gt;m_realName, nameStr);</span>
<a href="#l47.230"></a><span id="l47.230">           attachment-&gt;SetName(nameStr);</span>
<a href="#l47.231"></a><span id="l47.231">           attachment-&gt;SetUrl(spec);</span>
<a href="#l47.232"></a><span id="l47.232">           attachment-&gt;SetTemporary(true);</span>
<a href="#l47.233"></a><span id="l47.233">           attachment-&gt;SetContentType(curAttachment-&gt;m_realType.get());</span>
<a href="#l47.234"></a><span id="l47.234">           attachment-&gt;SetMacType(curAttachment-&gt;m_xMacType.get());</span>
<a href="#l47.235"></a><span id="l47.235">           attachment-&gt;SetMacCreator(curAttachment-&gt;m_xMacCreator.get());</span>
<a href="#l47.236"></a><span id="l47.236">           attachment-&gt;SetSize(curAttachment-&gt;m_size);</span>
<a href="#l47.237"></a><span id="l47.237" class="difflineminus">-          if (!curAttachment-&gt;m_cloudPartInfo.IsEmpty())</span>
<a href="#l47.238"></a><span id="l47.238" class="difflineminus">-          {</span>
<a href="#l47.239"></a><span id="l47.239" class="difflineplus">+          if (!curAttachment-&gt;m_cloudPartInfo.IsEmpty()) {</span>
<a href="#l47.240"></a><span id="l47.240">             nsCString provider;</span>
<a href="#l47.241"></a><span id="l47.241">             nsCString cloudUrl;</span>
<a href="#l47.242"></a><span id="l47.242">             attachment-&gt;SetSendViaCloud(true);</span>
<a href="#l47.243"></a><span id="l47.243">             provider.Adopt(</span>
<a href="#l47.244"></a><span id="l47.244" class="difflineminus">-              MimeHeaders_get_parameter(curAttachment-&gt;m_cloudPartInfo.get(),</span>
<a href="#l47.245"></a><span id="l47.245" class="difflineminus">-                                        &quot;provider&quot;, nullptr, nullptr));</span>
<a href="#l47.246"></a><span id="l47.246" class="difflineminus">-            cloudUrl.Adopt(</span>
<a href="#l47.247"></a><span id="l47.247" class="difflineminus">-              MimeHeaders_get_parameter(curAttachment-&gt;m_cloudPartInfo.get(),</span>
<a href="#l47.248"></a><span id="l47.248" class="difflineminus">-                                        &quot;url&quot;, nullptr, nullptr));</span>
<a href="#l47.249"></a><span id="l47.249" class="difflineplus">+                MimeHeaders_get_parameter(curAttachment-&gt;m_cloudPartInfo.get(),</span>
<a href="#l47.250"></a><span id="l47.250" class="difflineplus">+                                          &quot;provider&quot;, nullptr, nullptr));</span>
<a href="#l47.251"></a><span id="l47.251" class="difflineplus">+            cloudUrl.Adopt(MimeHeaders_get_parameter(</span>
<a href="#l47.252"></a><span id="l47.252" class="difflineplus">+                curAttachment-&gt;m_cloudPartInfo.get(), &quot;url&quot;, nullptr, nullptr));</span>
<a href="#l47.253"></a><span id="l47.253">             attachment-&gt;SetCloudProviderKey(provider);</span>
<a href="#l47.254"></a><span id="l47.254">             attachment-&gt;SetContentLocation(cloudUrl);</span>
<a href="#l47.255"></a><span id="l47.255">           }</span>
<a href="#l47.256"></a><span id="l47.256">           compFields-&gt;AddAttachment(attachment);</span>
<a href="#l47.257"></a><span id="l47.257">         }</span>
<a href="#l47.258"></a><span id="l47.258">       }</span>
<a href="#l47.259"></a><span id="l47.259">       curAttachment++;</span>
<a href="#l47.260"></a><span id="l47.260">     }</span>
<a href="#l47.261"></a><span id="l47.261">   }</span>
<a href="#l47.262"></a><span id="l47.262"> </span>
<a href="#l47.263"></a><span id="l47.263" class="difflineminus">-  MSG_ComposeFormat format = composeFormat; // Format to actually use.</span>
<a href="#l47.264"></a><span id="l47.264" class="difflineminus">-  if (identity &amp;&amp; composeType == nsIMsgCompType::ForwardInline)</span>
<a href="#l47.265"></a><span id="l47.265" class="difflineminus">-  {</span>
<a href="#l47.266"></a><span id="l47.266" class="difflineplus">+  MSG_ComposeFormat format = composeFormat;  // Format to actually use.</span>
<a href="#l47.267"></a><span id="l47.267" class="difflineplus">+  if (identity &amp;&amp; composeType == nsIMsgCompType::ForwardInline) {</span>
<a href="#l47.268"></a><span id="l47.268">     bool composeHtml = false;</span>
<a href="#l47.269"></a><span id="l47.269">     identity-&gt;GetComposeHtml(&amp;composeHtml);</span>
<a href="#l47.270"></a><span id="l47.270">     if (composeHtml)</span>
<a href="#l47.271"></a><span id="l47.271" class="difflineminus">-      format = (composeFormat == nsIMsgCompFormat::OppositeOfDefault) ?</span>
<a href="#l47.272"></a><span id="l47.272" class="difflineminus">-                 nsIMsgCompFormat::PlainText : nsIMsgCompFormat::HTML;</span>
<a href="#l47.273"></a><span id="l47.273" class="difflineplus">+      format = (composeFormat == nsIMsgCompFormat::OppositeOfDefault)</span>
<a href="#l47.274"></a><span id="l47.274" class="difflineplus">+                   ? nsIMsgCompFormat::PlainText</span>
<a href="#l47.275"></a><span id="l47.275" class="difflineplus">+                   : nsIMsgCompFormat::HTML;</span>
<a href="#l47.276"></a><span id="l47.276">     else</span>
<a href="#l47.277"></a><span id="l47.277" class="difflineminus">-      format = (composeFormat == nsIMsgCompFormat::OppositeOfDefault) ?</span>
<a href="#l47.278"></a><span id="l47.278" class="difflineminus">-                 nsIMsgCompFormat::HTML : nsIMsgCompFormat::PlainText;</span>
<a href="#l47.279"></a><span id="l47.279" class="difflineplus">+      format = (composeFormat == nsIMsgCompFormat::OppositeOfDefault)</span>
<a href="#l47.280"></a><span id="l47.280" class="difflineplus">+                   ? nsIMsgCompFormat::HTML</span>
<a href="#l47.281"></a><span id="l47.281" class="difflineplus">+                   : nsIMsgCompFormat::PlainText;</span>
<a href="#l47.282"></a><span id="l47.282">   }</span>
<a href="#l47.283"></a><span id="l47.283"> </span>
<a href="#l47.284"></a><span id="l47.284">   pMsgComposeParams = do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv);</span>
<a href="#l47.285"></a><span id="l47.285">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.286"></a><span id="l47.286"> </span>
<a href="#l47.287"></a><span id="l47.287">   pMsgComposeParams-&gt;SetType(composeType);</span>
<a href="#l47.288"></a><span id="l47.288">   pMsgComposeParams-&gt;SetFormat(format);</span>
<a href="#l47.289"></a><span id="l47.289">   pMsgComposeParams-&gt;SetIdentity(identity);</span>
<a href="#l47.290"></a><span id="l47.290">   pMsgComposeParams-&gt;SetComposeFields(compFields);</span>
<a href="#l47.291"></a><span id="l47.291" class="difflineminus">-  if (originalMsgURI)</span>
<a href="#l47.292"></a><span id="l47.292" class="difflineminus">-    pMsgComposeParams-&gt;SetOriginalMsgURI(originalMsgURI);</span>
<a href="#l47.293"></a><span id="l47.293" class="difflineminus">-  if (origMsgHdr)</span>
<a href="#l47.294"></a><span id="l47.294" class="difflineminus">-    pMsgComposeParams-&gt;SetOrigMsgHdr(origMsgHdr);</span>
<a href="#l47.295"></a><span id="l47.295" class="difflineplus">+  if (originalMsgURI) pMsgComposeParams-&gt;SetOriginalMsgURI(originalMsgURI);</span>
<a href="#l47.296"></a><span id="l47.296" class="difflineplus">+  if (origMsgHdr) pMsgComposeParams-&gt;SetOrigMsgHdr(origMsgHdr);</span>
<a href="#l47.297"></a><span id="l47.297">   return NS_OK;</span>
<a href="#l47.298"></a><span id="l47.298"> }</span>
<a href="#l47.299"></a><span id="l47.299"> </span>
<a href="#l47.300"></a><span id="l47.300" class="difflineminus">-nsresult</span>
<a href="#l47.301"></a><span id="l47.301" class="difflineminus">-CreateTheComposeWindow(nsIMsgCompFields *   compFields,</span>
<a href="#l47.302"></a><span id="l47.302" class="difflineminus">-                       nsMsgAttachmentData *attachmentList,</span>
<a href="#l47.303"></a><span id="l47.303" class="difflineminus">-                       MSG_ComposeType      composeType,</span>
<a href="#l47.304"></a><span id="l47.304" class="difflineminus">-                       MSG_ComposeFormat    composeFormat,</span>
<a href="#l47.305"></a><span id="l47.305" class="difflineminus">-                       nsIMsgIdentity *     identity,</span>
<a href="#l47.306"></a><span id="l47.306" class="difflineminus">-                       const char *         originalMsgURI,</span>
<a href="#l47.307"></a><span id="l47.307" class="difflineminus">-                       nsIMsgDBHdr *        origMsgHdr</span>
<a href="#l47.308"></a><span id="l47.308" class="difflineminus">-                      )</span>
<a href="#l47.309"></a><span id="l47.309" class="difflineminus">-{</span>
<a href="#l47.310"></a><span id="l47.310" class="difflineplus">+nsresult CreateTheComposeWindow(nsIMsgCompFields *compFields,</span>
<a href="#l47.311"></a><span id="l47.311" class="difflineplus">+                                nsMsgAttachmentData *attachmentList,</span>
<a href="#l47.312"></a><span id="l47.312" class="difflineplus">+                                MSG_ComposeType composeType,</span>
<a href="#l47.313"></a><span id="l47.313" class="difflineplus">+                                MSG_ComposeFormat composeFormat,</span>
<a href="#l47.314"></a><span id="l47.314" class="difflineplus">+                                nsIMsgIdentity *identity,</span>
<a href="#l47.315"></a><span id="l47.315" class="difflineplus">+                                const char *originalMsgURI,</span>
<a href="#l47.316"></a><span id="l47.316" class="difflineplus">+                                nsIMsgDBHdr *origMsgHdr) {</span>
<a href="#l47.317"></a><span id="l47.317">   nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams;</span>
<a href="#l47.318"></a><span id="l47.318">   nsresult rv = CreateComposeParams(pMsgComposeParams, compFields,</span>
<a href="#l47.319"></a><span id="l47.319" class="difflineminus">-                       attachmentList,</span>
<a href="#l47.320"></a><span id="l47.320" class="difflineminus">-                       composeType,</span>
<a href="#l47.321"></a><span id="l47.321" class="difflineminus">-                       composeFormat,</span>
<a href="#l47.322"></a><span id="l47.322" class="difflineminus">-                       identity,</span>
<a href="#l47.323"></a><span id="l47.323" class="difflineminus">-                       originalMsgURI,</span>
<a href="#l47.324"></a><span id="l47.324" class="difflineminus">-                       origMsgHdr);</span>
<a href="#l47.325"></a><span id="l47.325" class="difflineplus">+                                    attachmentList, composeType, composeFormat,</span>
<a href="#l47.326"></a><span id="l47.326" class="difflineplus">+                                    identity, originalMsgURI, origMsgHdr);</span>
<a href="#l47.327"></a><span id="l47.327">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.328"></a><span id="l47.328"> </span>
<a href="#l47.329"></a><span id="l47.329">   nsCOMPtr&lt;nsIMsgComposeService&gt; msgComposeService =</span>
<a href="#l47.330"></a><span id="l47.330" class="difflineminus">-           do_GetService(kCMsgComposeServiceCID, &amp;rv);</span>
<a href="#l47.331"></a><span id="l47.331" class="difflineplus">+      do_GetService(kCMsgComposeServiceCID, &amp;rv);</span>
<a href="#l47.332"></a><span id="l47.332">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.333"></a><span id="l47.333"> </span>
<a href="#l47.334"></a><span id="l47.334" class="difflineminus">-  return msgComposeService-&gt;OpenComposeWindowWithParams(nullptr /* default chrome */, pMsgComposeParams);</span>
<a href="#l47.335"></a><span id="l47.335" class="difflineplus">+  return msgComposeService-&gt;OpenComposeWindowWithParams(</span>
<a href="#l47.336"></a><span id="l47.336" class="difflineplus">+      nullptr /* default chrome */, pMsgComposeParams);</span>
<a href="#l47.337"></a><span id="l47.337"> }</span>
<a href="#l47.338"></a><span id="l47.338"> </span>
<a href="#l47.339"></a><span id="l47.339" class="difflineminus">-nsresult</span>
<a href="#l47.340"></a><span id="l47.340" class="difflineminus">-ForwardMsgInline(nsIMsgCompFields *compFields,</span>
<a href="#l47.341"></a><span id="l47.341" class="difflineminus">-                 nsMsgAttachmentData *attachmentList,</span>
<a href="#l47.342"></a><span id="l47.342" class="difflineminus">-                 MSG_ComposeFormat composeFormat,</span>
<a href="#l47.343"></a><span id="l47.343" class="difflineminus">-                 nsIMsgIdentity *identity,</span>
<a href="#l47.344"></a><span id="l47.344" class="difflineminus">-                 const char *originalMsgURI,</span>
<a href="#l47.345"></a><span id="l47.345" class="difflineminus">-                 nsIMsgDBHdr *origMsgHdr)</span>
<a href="#l47.346"></a><span id="l47.346" class="difflineminus">-{</span>
<a href="#l47.347"></a><span id="l47.347" class="difflineplus">+nsresult ForwardMsgInline(nsIMsgCompFields *compFields,</span>
<a href="#l47.348"></a><span id="l47.348" class="difflineplus">+                          nsMsgAttachmentData *attachmentList,</span>
<a href="#l47.349"></a><span id="l47.349" class="difflineplus">+                          MSG_ComposeFormat composeFormat,</span>
<a href="#l47.350"></a><span id="l47.350" class="difflineplus">+                          nsIMsgIdentity *identity, const char *originalMsgURI,</span>
<a href="#l47.351"></a><span id="l47.351" class="difflineplus">+                          nsIMsgDBHdr *origMsgHdr) {</span>
<a href="#l47.352"></a><span id="l47.352">   nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams;</span>
<a href="#l47.353"></a><span id="l47.353" class="difflineminus">-  nsresult rv = CreateComposeParams(pMsgComposeParams, compFields,</span>
<a href="#l47.354"></a><span id="l47.354" class="difflineminus">-                                    attachmentList,</span>
<a href="#l47.355"></a><span id="l47.355" class="difflineminus">-                                    nsIMsgCompType::ForwardInline,</span>
<a href="#l47.356"></a><span id="l47.356" class="difflineminus">-                                    composeFormat,</span>
<a href="#l47.357"></a><span id="l47.357" class="difflineminus">-                                    identity,</span>
<a href="#l47.358"></a><span id="l47.358" class="difflineminus">-                                    originalMsgURI,</span>
<a href="#l47.359"></a><span id="l47.359" class="difflineminus">-                                    origMsgHdr);</span>
<a href="#l47.360"></a><span id="l47.360" class="difflineplus">+  nsresult rv =</span>
<a href="#l47.361"></a><span id="l47.361" class="difflineplus">+      CreateComposeParams(pMsgComposeParams, compFields, attachmentList,</span>
<a href="#l47.362"></a><span id="l47.362" class="difflineplus">+                          nsIMsgCompType::ForwardInline, composeFormat,</span>
<a href="#l47.363"></a><span id="l47.363" class="difflineplus">+                          identity, originalMsgURI, origMsgHdr);</span>
<a href="#l47.364"></a><span id="l47.364">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.365"></a><span id="l47.365"> </span>
<a href="#l47.366"></a><span id="l47.366">   nsCOMPtr&lt;nsIMsgComposeService&gt; msgComposeService =</span>
<a href="#l47.367"></a><span id="l47.367" class="difflineminus">-           do_GetService(kCMsgComposeServiceCID, &amp;rv);</span>
<a href="#l47.368"></a><span id="l47.368" class="difflineplus">+      do_GetService(kCMsgComposeServiceCID, &amp;rv);</span>
<a href="#l47.369"></a><span id="l47.369">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.370"></a><span id="l47.370">   // create the nsIMsgCompose object to send the object</span>
<a href="#l47.371"></a><span id="l47.371" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose(do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l47.372"></a><span id="l47.372" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose(</span>
<a href="#l47.373"></a><span id="l47.373" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l47.374"></a><span id="l47.374">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.375"></a><span id="l47.375"> </span>
<a href="#l47.376"></a><span id="l47.376" class="difflineminus">-  /** initialize nsIMsgCompose, Send the message, wait for send completion response **/</span>
<a href="#l47.377"></a><span id="l47.377" class="difflineplus">+  /** initialize nsIMsgCompose, Send the message, wait for send completion</span>
<a href="#l47.378"></a><span id="l47.378" class="difflineplus">+   * response **/</span>
<a href="#l47.379"></a><span id="l47.379">   rv = pMsgCompose-&gt;Initialize(pMsgComposeParams, nullptr, nullptr);</span>
<a href="#l47.380"></a><span id="l47.380" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l47.381"></a><span id="l47.381" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.382"></a><span id="l47.382"> </span>
<a href="#l47.383"></a><span id="l47.383" class="difflineminus">-  rv = pMsgCompose-&gt;SendMsg(nsIMsgSend::nsMsgDeliverNow, identity, nullptr, nullptr, nullptr);</span>
<a href="#l47.384"></a><span id="l47.384" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l47.385"></a><span id="l47.385" class="difflineminus">-  {</span>
<a href="#l47.386"></a><span id="l47.386" class="difflineplus">+  rv = pMsgCompose-&gt;SendMsg(nsIMsgSend::nsMsgDeliverNow, identity, nullptr,</span>
<a href="#l47.387"></a><span id="l47.387" class="difflineplus">+                            nullptr, nullptr);</span>
<a href="#l47.388"></a><span id="l47.388" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l47.389"></a><span id="l47.389">     nsCOMPtr&lt;nsIMsgFolder&gt; origFolder;</span>
<a href="#l47.390"></a><span id="l47.390">     origMsgHdr-&gt;GetFolder(getter_AddRefs(origFolder));</span>
<a href="#l47.391"></a><span id="l47.391">     if (origFolder)</span>
<a href="#l47.392"></a><span id="l47.392">       origFolder-&gt;AddMessageDispositionState(</span>
<a href="#l47.393"></a><span id="l47.393" class="difflineminus">-                  origMsgHdr, nsIMsgFolder::nsMsgDispositionState_Forwarded);</span>
<a href="#l47.394"></a><span id="l47.394" class="difflineplus">+          origMsgHdr, nsIMsgFolder::nsMsgDispositionState_Forwarded);</span>
<a href="#l47.395"></a><span id="l47.395">   }</span>
<a href="#l47.396"></a><span id="l47.396">   return rv;</span>
<a href="#l47.397"></a><span id="l47.397"> }</span>
<a href="#l47.398"></a><span id="l47.398"> </span>
<a href="#l47.399"></a><span id="l47.399" class="difflineminus">-nsresult</span>
<a href="#l47.400"></a><span id="l47.400" class="difflineminus">-CreateCompositionFields(const char        *from,</span>
<a href="#l47.401"></a><span id="l47.401" class="difflineminus">-                        const char        *reply_to,</span>
<a href="#l47.402"></a><span id="l47.402" class="difflineminus">-                        const char        *to,</span>
<a href="#l47.403"></a><span id="l47.403" class="difflineminus">-                        const char        *cc,</span>
<a href="#l47.404"></a><span id="l47.404" class="difflineminus">-                        const char        *bcc,</span>
<a href="#l47.405"></a><span id="l47.405" class="difflineminus">-                        const char        *fcc,</span>
<a href="#l47.406"></a><span id="l47.406" class="difflineminus">-                        const char        *newsgroups,</span>
<a href="#l47.407"></a><span id="l47.407" class="difflineminus">-                        const char        *followup_to,</span>
<a href="#l47.408"></a><span id="l47.408" class="difflineminus">-                        const char        *organization,</span>
<a href="#l47.409"></a><span id="l47.409" class="difflineminus">-                        const char        *subject,</span>
<a href="#l47.410"></a><span id="l47.410" class="difflineminus">-                        const char        *references,</span>
<a href="#l47.411"></a><span id="l47.411" class="difflineminus">-                        const char        *priority,</span>
<a href="#l47.412"></a><span id="l47.412" class="difflineminus">-                        const char        *newspost_url,</span>
<a href="#l47.413"></a><span id="l47.413" class="difflineminus">-                        char              *charset,</span>
<a href="#l47.414"></a><span id="l47.414" class="difflineminus">-                        nsIMsgCompFields  **_retval)</span>
<a href="#l47.415"></a><span id="l47.415" class="difflineminus">-{</span>
<a href="#l47.416"></a><span id="l47.416" class="difflineplus">+nsresult CreateCompositionFields(</span>
<a href="#l47.417"></a><span id="l47.417" class="difflineplus">+    const char *from, const char *reply_to, const char *to, const char *cc,</span>
<a href="#l47.418"></a><span id="l47.418" class="difflineplus">+    const char *bcc, const char *fcc, const char *newsgroups,</span>
<a href="#l47.419"></a><span id="l47.419" class="difflineplus">+    const char *followup_to, const char *organization, const char *subject,</span>
<a href="#l47.420"></a><span id="l47.420" class="difflineplus">+    const char *references, const char *priority, const char *newspost_url,</span>
<a href="#l47.421"></a><span id="l47.421" class="difflineplus">+    char *charset, nsIMsgCompFields **_retval) {</span>
<a href="#l47.422"></a><span id="l47.422">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l47.423"></a><span id="l47.423"> </span>
<a href="#l47.424"></a><span id="l47.424">   nsresult rv;</span>
<a href="#l47.425"></a><span id="l47.425">   *_retval = nullptr;</span>
<a href="#l47.426"></a><span id="l47.426"> </span>
<a href="#l47.427"></a><span id="l47.427" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompFields&gt; cFields = do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l47.428"></a><span id="l47.428" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompFields&gt; cFields =</span>
<a href="#l47.429"></a><span id="l47.429" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l47.430"></a><span id="l47.430">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.431"></a><span id="l47.431">   NS_ENSURE_TRUE(cFields, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l47.432"></a><span id="l47.432"> </span>
<a href="#l47.433"></a><span id="l47.433">   // Now set all of the passed in stuff...</span>
<a href="#l47.434"></a><span id="l47.434" class="difflineminus">-  cFields-&gt;SetCharacterSet(!PL_strcasecmp(&quot;us-ascii&quot;, charset) ? &quot;ISO-8859-1&quot; : charset);</span>
<a href="#l47.435"></a><span id="l47.435" class="difflineplus">+  cFields-&gt;SetCharacterSet(!PL_strcasecmp(&quot;us-ascii&quot;, charset) ? &quot;ISO-8859-1&quot;</span>
<a href="#l47.436"></a><span id="l47.436" class="difflineplus">+                                                               : charset);</span>
<a href="#l47.437"></a><span id="l47.437"> </span>
<a href="#l47.438"></a><span id="l47.438">   nsAutoCString val;</span>
<a href="#l47.439"></a><span id="l47.439">   nsAutoString outString;</span>
<a href="#l47.440"></a><span id="l47.440"> </span>
<a href="#l47.441"></a><span id="l47.441">   if (from) {</span>
<a href="#l47.442"></a><span id="l47.442" class="difflineminus">-    nsMsgI18NConvertRawBytesToUTF16(nsDependentCString(from),</span>
<a href="#l47.443"></a><span id="l47.443" class="difflineminus">-                                    charset ? nsDependentCString(charset) : EmptyCString(),</span>
<a href="#l47.444"></a><span id="l47.444" class="difflineminus">-                                    outString);</span>
<a href="#l47.445"></a><span id="l47.445" class="difflineplus">+    nsMsgI18NConvertRawBytesToUTF16(</span>
<a href="#l47.446"></a><span id="l47.446" class="difflineplus">+        nsDependentCString(from),</span>
<a href="#l47.447"></a><span id="l47.447" class="difflineplus">+        charset ? nsDependentCString(charset) : EmptyCString(), outString);</span>
<a href="#l47.448"></a><span id="l47.448">     cFields-&gt;SetFrom(outString);</span>
<a href="#l47.449"></a><span id="l47.449">   }</span>
<a href="#l47.450"></a><span id="l47.450"> </span>
<a href="#l47.451"></a><span id="l47.451">   if (subject) {</span>
<a href="#l47.452"></a><span id="l47.452">     MIME_DecodeMimeHeader(subject, charset, false, true, val);</span>
<a href="#l47.453"></a><span id="l47.453" class="difflineminus">-    cFields-&gt;SetSubject(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : subject));</span>
<a href="#l47.454"></a><span id="l47.454" class="difflineplus">+    cFields-&gt;SetSubject(</span>
<a href="#l47.455"></a><span id="l47.455" class="difflineplus">+        NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : subject));</span>
<a href="#l47.456"></a><span id="l47.456">   }</span>
<a href="#l47.457"></a><span id="l47.457"> </span>
<a href="#l47.458"></a><span id="l47.458">   if (reply_to) {</span>
<a href="#l47.459"></a><span id="l47.459" class="difflineminus">-    nsMsgI18NConvertRawBytesToUTF16(nsDependentCString(reply_to),</span>
<a href="#l47.460"></a><span id="l47.460" class="difflineminus">-                                    charset ? nsDependentCString(charset) : EmptyCString(),</span>
<a href="#l47.461"></a><span id="l47.461" class="difflineminus">-                                    outString);</span>
<a href="#l47.462"></a><span id="l47.462" class="difflineplus">+    nsMsgI18NConvertRawBytesToUTF16(</span>
<a href="#l47.463"></a><span id="l47.463" class="difflineplus">+        nsDependentCString(reply_to),</span>
<a href="#l47.464"></a><span id="l47.464" class="difflineplus">+        charset ? nsDependentCString(charset) : EmptyCString(), outString);</span>
<a href="#l47.465"></a><span id="l47.465">     cFields-&gt;SetReplyTo(outString);</span>
<a href="#l47.466"></a><span id="l47.466">   }</span>
<a href="#l47.467"></a><span id="l47.467"> </span>
<a href="#l47.468"></a><span id="l47.468">   if (to) {</span>
<a href="#l47.469"></a><span id="l47.469" class="difflineminus">-    nsMsgI18NConvertRawBytesToUTF16(nsDependentCString(to),</span>
<a href="#l47.470"></a><span id="l47.470" class="difflineminus">-                                    charset ? nsDependentCString(charset) : EmptyCString(),</span>
<a href="#l47.471"></a><span id="l47.471" class="difflineminus">-                                    outString);</span>
<a href="#l47.472"></a><span id="l47.472" class="difflineplus">+    nsMsgI18NConvertRawBytesToUTF16(</span>
<a href="#l47.473"></a><span id="l47.473" class="difflineplus">+        nsDependentCString(to),</span>
<a href="#l47.474"></a><span id="l47.474" class="difflineplus">+        charset ? nsDependentCString(charset) : EmptyCString(), outString);</span>
<a href="#l47.475"></a><span id="l47.475">     cFields-&gt;SetTo(outString);</span>
<a href="#l47.476"></a><span id="l47.476">   }</span>
<a href="#l47.477"></a><span id="l47.477"> </span>
<a href="#l47.478"></a><span id="l47.478">   if (cc) {</span>
<a href="#l47.479"></a><span id="l47.479" class="difflineminus">-    nsMsgI18NConvertRawBytesToUTF16(nsDependentCString(cc),</span>
<a href="#l47.480"></a><span id="l47.480" class="difflineminus">-                                    charset ? nsDependentCString(charset) : EmptyCString(),</span>
<a href="#l47.481"></a><span id="l47.481" class="difflineminus">-                                    outString);</span>
<a href="#l47.482"></a><span id="l47.482" class="difflineplus">+    nsMsgI18NConvertRawBytesToUTF16(</span>
<a href="#l47.483"></a><span id="l47.483" class="difflineplus">+        nsDependentCString(cc),</span>
<a href="#l47.484"></a><span id="l47.484" class="difflineplus">+        charset ? nsDependentCString(charset) : EmptyCString(), outString);</span>
<a href="#l47.485"></a><span id="l47.485">     cFields-&gt;SetCc(outString);</span>
<a href="#l47.486"></a><span id="l47.486">   }</span>
<a href="#l47.487"></a><span id="l47.487"> </span>
<a href="#l47.488"></a><span id="l47.488">   if (bcc) {</span>
<a href="#l47.489"></a><span id="l47.489" class="difflineminus">-    nsMsgI18NConvertRawBytesToUTF16(nsDependentCString(bcc),</span>
<a href="#l47.490"></a><span id="l47.490" class="difflineminus">-                                    charset ? nsDependentCString(charset) : EmptyCString(),</span>
<a href="#l47.491"></a><span id="l47.491" class="difflineminus">-                                    outString);</span>
<a href="#l47.492"></a><span id="l47.492" class="difflineplus">+    nsMsgI18NConvertRawBytesToUTF16(</span>
<a href="#l47.493"></a><span id="l47.493" class="difflineplus">+        nsDependentCString(bcc),</span>
<a href="#l47.494"></a><span id="l47.494" class="difflineplus">+        charset ? nsDependentCString(charset) : EmptyCString(), outString);</span>
<a href="#l47.495"></a><span id="l47.495">     cFields-&gt;SetBcc(outString);</span>
<a href="#l47.496"></a><span id="l47.496">   }</span>
<a href="#l47.497"></a><span id="l47.497"> </span>
<a href="#l47.498"></a><span id="l47.498">   if (fcc) {</span>
<a href="#l47.499"></a><span id="l47.499">     MIME_DecodeMimeHeader(fcc, charset, false, true, val);</span>
<a href="#l47.500"></a><span id="l47.500">     cFields-&gt;SetFcc(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : fcc));</span>
<a href="#l47.501"></a><span id="l47.501">   }</span>
<a href="#l47.502"></a><span id="l47.502"> </span>
<a href="#l47.503"></a><span id="l47.503">   if (newsgroups) {</span>
<a href="#l47.504"></a><span id="l47.504">     // fixme: the newsgroups header had better be decoded using the server-side</span>
<a href="#l47.505"></a><span id="l47.505">     // character encoding,but this |charset| might be different from it.</span>
<a href="#l47.506"></a><span id="l47.506">     MIME_DecodeMimeHeader(newsgroups, charset, false, true, val);</span>
<a href="#l47.507"></a><span id="l47.507" class="difflineminus">-    cFields-&gt;SetNewsgroups(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : newsgroups));</span>
<a href="#l47.508"></a><span id="l47.508" class="difflineplus">+    cFields-&gt;SetNewsgroups(</span>
<a href="#l47.509"></a><span id="l47.509" class="difflineplus">+        NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : newsgroups));</span>
<a href="#l47.510"></a><span id="l47.510">   }</span>
<a href="#l47.511"></a><span id="l47.511"> </span>
<a href="#l47.512"></a><span id="l47.512">   if (followup_to) {</span>
<a href="#l47.513"></a><span id="l47.513">     MIME_DecodeMimeHeader(followup_to, charset, false, true, val);</span>
<a href="#l47.514"></a><span id="l47.514" class="difflineminus">-    cFields-&gt;SetFollowupTo(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : followup_to));</span>
<a href="#l47.515"></a><span id="l47.515" class="difflineplus">+    cFields-&gt;SetFollowupTo(</span>
<a href="#l47.516"></a><span id="l47.516" class="difflineplus">+        NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : followup_to));</span>
<a href="#l47.517"></a><span id="l47.517">   }</span>
<a href="#l47.518"></a><span id="l47.518"> </span>
<a href="#l47.519"></a><span id="l47.519">   if (organization) {</span>
<a href="#l47.520"></a><span id="l47.520">     MIME_DecodeMimeHeader(organization, charset, false, true, val);</span>
<a href="#l47.521"></a><span id="l47.521" class="difflineminus">-    cFields-&gt;SetOrganization(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : organization));</span>
<a href="#l47.522"></a><span id="l47.522" class="difflineplus">+    cFields-&gt;SetOrganization(</span>
<a href="#l47.523"></a><span id="l47.523" class="difflineplus">+        NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : organization));</span>
<a href="#l47.524"></a><span id="l47.524">   }</span>
<a href="#l47.525"></a><span id="l47.525"> </span>
<a href="#l47.526"></a><span id="l47.526">   if (references) {</span>
<a href="#l47.527"></a><span id="l47.527">     MIME_DecodeMimeHeader(references, charset, false, true, val);</span>
<a href="#l47.528"></a><span id="l47.528">     cFields-&gt;SetReferences(!val.IsEmpty() ? val.get() : references);</span>
<a href="#l47.529"></a><span id="l47.529">   }</span>
<a href="#l47.530"></a><span id="l47.530"> </span>
<a href="#l47.531"></a><span id="l47.531">   if (priority) {</span>
<a href="#l47.532"></a><span id="l47.532">     MIME_DecodeMimeHeader(priority, charset, false, true, val);</span>
<a href="#l47.533"></a><span id="l47.533">     nsMsgPriorityValue priorityValue;</span>
<a href="#l47.534"></a><span id="l47.534" class="difflineminus">-    NS_MsgGetPriorityFromString(!val.IsEmpty() ? val.get() : priority, priorityValue);</span>
<a href="#l47.535"></a><span id="l47.535" class="difflineplus">+    NS_MsgGetPriorityFromString(!val.IsEmpty() ? val.get() : priority,</span>
<a href="#l47.536"></a><span id="l47.536" class="difflineplus">+                                priorityValue);</span>
<a href="#l47.537"></a><span id="l47.537">     nsAutoCString priorityName;</span>
<a href="#l47.538"></a><span id="l47.538">     NS_MsgGetUntranslatedPriorityName(priorityValue, priorityName);</span>
<a href="#l47.539"></a><span id="l47.539">     cFields-&gt;SetPriority(priorityName.get());</span>
<a href="#l47.540"></a><span id="l47.540">   }</span>
<a href="#l47.541"></a><span id="l47.541"> </span>
<a href="#l47.542"></a><span id="l47.542">   if (newspost_url) {</span>
<a href="#l47.543"></a><span id="l47.543">     MIME_DecodeMimeHeader(newspost_url, charset, false, true, val);</span>
<a href="#l47.544"></a><span id="l47.544">     cFields-&gt;SetNewspostUrl(!val.IsEmpty() ? val.get() : newspost_url);</span>
<a href="#l47.545"></a><span id="l47.545">   }</span>
<a href="#l47.546"></a><span id="l47.546"> </span>
<a href="#l47.547"></a><span id="l47.547">   cFields.forget(_retval);</span>
<a href="#l47.548"></a><span id="l47.548"> </span>
<a href="#l47.549"></a><span id="l47.549">   return rv;</span>
<a href="#l47.550"></a><span id="l47.550"> }</span>
<a href="#l47.551"></a><span id="l47.551"> </span>
<a href="#l47.552"></a><span id="l47.552" class="difflineminus">-static int</span>
<a href="#l47.553"></a><span id="l47.553" class="difflineminus">-dummy_file_write(char *buf, int32_t size, void *fileHandle)</span>
<a href="#l47.554"></a><span id="l47.554" class="difflineminus">-{</span>
<a href="#l47.555"></a><span id="l47.555" class="difflineminus">-  if (!fileHandle)</span>
<a href="#l47.556"></a><span id="l47.556" class="difflineminus">-    return -1;</span>
<a href="#l47.557"></a><span id="l47.557" class="difflineplus">+static int dummy_file_write(char *buf, int32_t size, void *fileHandle) {</span>
<a href="#l47.558"></a><span id="l47.558" class="difflineplus">+  if (!fileHandle) return -1;</span>
<a href="#l47.559"></a><span id="l47.559"> </span>
<a href="#l47.560"></a><span id="l47.560" class="difflineminus">-  nsIOutputStream  *tStream = (nsIOutputStream *)fileHandle;</span>
<a href="#l47.561"></a><span id="l47.561" class="difflineplus">+  nsIOutputStream *tStream = (nsIOutputStream *)fileHandle;</span>
<a href="#l47.562"></a><span id="l47.562">   uint32_t bytesWritten;</span>
<a href="#l47.563"></a><span id="l47.563">   tStream-&gt;Write(buf, size, &amp;bytesWritten);</span>
<a href="#l47.564"></a><span id="l47.564">   return (int)bytesWritten;</span>
<a href="#l47.565"></a><span id="l47.565"> }</span>
<a href="#l47.566"></a><span id="l47.566"> </span>
<a href="#l47.567"></a><span id="l47.567" class="difflineminus">-static int</span>
<a href="#l47.568"></a><span id="l47.568" class="difflineminus">-mime_parse_stream_write(nsMIMESession *stream, const char *buf, int32_t size)</span>
<a href="#l47.569"></a><span id="l47.569" class="difflineminus">-{</span>
<a href="#l47.570"></a><span id="l47.570" class="difflineplus">+static int mime_parse_stream_write(nsMIMESession *stream, const char *buf,</span>
<a href="#l47.571"></a><span id="l47.571" class="difflineplus">+                                   int32_t size) {</span>
<a href="#l47.572"></a><span id="l47.572">   mime_draft_data *mdd = (mime_draft_data *)stream-&gt;data_object;</span>
<a href="#l47.573"></a><span id="l47.573">   NS_ASSERTION(mdd, &quot;null mime draft data!&quot;);</span>
<a href="#l47.574"></a><span id="l47.574"> </span>
<a href="#l47.575"></a><span id="l47.575" class="difflineminus">-  if (!mdd || !mdd-&gt;obj)</span>
<a href="#l47.576"></a><span id="l47.576" class="difflineminus">-    return -1;</span>
<a href="#l47.577"></a><span id="l47.577" class="difflineplus">+  if (!mdd || !mdd-&gt;obj) return -1;</span>
<a href="#l47.578"></a><span id="l47.578"> </span>
<a href="#l47.579"></a><span id="l47.579">   return mdd-&gt;obj-&gt;clazz-&gt;parse_buffer((char *)buf, size, mdd-&gt;obj);</span>
<a href="#l47.580"></a><span id="l47.580"> }</span>
<a href="#l47.581"></a><span id="l47.581"> </span>
<a href="#l47.582"></a><span id="l47.582" class="difflineminus">-static void</span>
<a href="#l47.583"></a><span id="l47.583" class="difflineminus">-mime_free_attachments(nsTArray&lt;nsMsgAttachedFile *&gt; &amp;attachments)</span>
<a href="#l47.584"></a><span id="l47.584" class="difflineminus">-{</span>
<a href="#l47.585"></a><span id="l47.585" class="difflineminus">-  if (attachments.Length() &lt;= 0)</span>
<a href="#l47.586"></a><span id="l47.586" class="difflineminus">-    return;</span>
<a href="#l47.587"></a><span id="l47.587" class="difflineplus">+static void mime_free_attachments(nsTArray&lt;nsMsgAttachedFile *&gt; &amp;attachments) {</span>
<a href="#l47.588"></a><span id="l47.588" class="difflineplus">+  if (attachments.Length() &lt;= 0) return;</span>
<a href="#l47.589"></a><span id="l47.589"> </span>
<a href="#l47.590"></a><span id="l47.590" class="difflineminus">-  for (uint32_t i = 0; i &lt; attachments.Length(); i++)</span>
<a href="#l47.591"></a><span id="l47.591" class="difflineminus">-  {</span>
<a href="#l47.592"></a><span id="l47.592" class="difflineminus">-    if (attachments[i]-&gt;m_tmpFile)</span>
<a href="#l47.593"></a><span id="l47.593" class="difflineminus">-    {</span>
<a href="#l47.594"></a><span id="l47.594" class="difflineplus">+  for (uint32_t i = 0; i &lt; attachments.Length(); i++) {</span>
<a href="#l47.595"></a><span id="l47.595" class="difflineplus">+    if (attachments[i]-&gt;m_tmpFile) {</span>
<a href="#l47.596"></a><span id="l47.596">       attachments[i]-&gt;m_tmpFile-&gt;Remove(false);</span>
<a href="#l47.597"></a><span id="l47.597">       attachments[i]-&gt;m_tmpFile = nullptr;</span>
<a href="#l47.598"></a><span id="l47.598">     }</span>
<a href="#l47.599"></a><span id="l47.599">     delete attachments[i];</span>
<a href="#l47.600"></a><span id="l47.600">   }</span>
<a href="#l47.601"></a><span id="l47.601"> }</span>
<a href="#l47.602"></a><span id="l47.602"> </span>
<a href="#l47.603"></a><span id="l47.603" class="difflineminus">-static nsMsgAttachmentData *</span>
<a href="#l47.604"></a><span id="l47.604" class="difflineminus">-mime_draft_process_attachments(mime_draft_data *mdd)</span>
<a href="#l47.605"></a><span id="l47.605" class="difflineminus">-{</span>
<a href="#l47.606"></a><span id="l47.606" class="difflineminus">-  if (!mdd)</span>
<a href="#l47.607"></a><span id="l47.607" class="difflineminus">-    return nullptr;</span>
<a href="#l47.608"></a><span id="l47.608" class="difflineplus">+static nsMsgAttachmentData *mime_draft_process_attachments(</span>
<a href="#l47.609"></a><span id="l47.609" class="difflineplus">+    mime_draft_data *mdd) {</span>
<a href="#l47.610"></a><span id="l47.610" class="difflineplus">+  if (!mdd) return nullptr;</span>
<a href="#l47.611"></a><span id="l47.611"> </span>
<a href="#l47.612"></a><span id="l47.612" class="difflineminus">-  nsMsgAttachmentData         *attachData = NULL, *tmp = NULL;</span>
<a href="#l47.613"></a><span id="l47.613" class="difflineminus">-  nsMsgAttachedFile           *tmpFile = NULL;</span>
<a href="#l47.614"></a><span id="l47.614" class="difflineplus">+  nsMsgAttachmentData *attachData = NULL, *tmp = NULL;</span>
<a href="#l47.615"></a><span id="l47.615" class="difflineplus">+  nsMsgAttachedFile *tmpFile = NULL;</span>
<a href="#l47.616"></a><span id="l47.616"> </span>
<a href="#l47.617"></a><span id="l47.617" class="difflineminus">-  //It's possible we must treat the message body as attachment!</span>
<a href="#l47.618"></a><span id="l47.618" class="difflineplus">+  // It's possible we must treat the message body as attachment!</span>
<a href="#l47.619"></a><span id="l47.619">   bool bodyAsAttachment = false;</span>
<a href="#l47.620"></a><span id="l47.620" class="difflineminus">-  if (mdd-&gt;messageBody &amp;&amp;</span>
<a href="#l47.621"></a><span id="l47.621" class="difflineminus">-      !mdd-&gt;messageBody-&gt;m_type.IsEmpty() &amp;&amp;</span>
<a href="#l47.622"></a><span id="l47.622" class="difflineminus">-      mdd-&gt;messageBody-&gt;m_type.Find(&quot;text/html&quot;, /* ignoreCase = */ true) == -1 &amp;&amp;</span>
<a href="#l47.623"></a><span id="l47.623" class="difflineminus">-      mdd-&gt;messageBody-&gt;m_type.Find(&quot;text/plain&quot;, /* ignoreCase = */ true) == -1 &amp;&amp;</span>
<a href="#l47.624"></a><span id="l47.624" class="difflineplus">+  if (mdd-&gt;messageBody &amp;&amp; !mdd-&gt;messageBody-&gt;m_type.IsEmpty() &amp;&amp;</span>
<a href="#l47.625"></a><span id="l47.625" class="difflineplus">+      mdd-&gt;messageBody-&gt;m_type.Find(&quot;text/html&quot;, /* ignoreCase = */ true) ==</span>
<a href="#l47.626"></a><span id="l47.626" class="difflineplus">+          -1 &amp;&amp;</span>
<a href="#l47.627"></a><span id="l47.627" class="difflineplus">+      mdd-&gt;messageBody-&gt;m_type.Find(&quot;text/plain&quot;, /* ignoreCase = */ true) ==</span>
<a href="#l47.628"></a><span id="l47.628" class="difflineplus">+          -1 &amp;&amp;</span>
<a href="#l47.629"></a><span id="l47.629">       !mdd-&gt;messageBody-&gt;m_type.LowerCaseEqualsLiteral(&quot;text&quot;))</span>
<a href="#l47.630"></a><span id="l47.630" class="difflineminus">-     bodyAsAttachment = true;</span>
<a href="#l47.631"></a><span id="l47.631" class="difflineplus">+    bodyAsAttachment = true;</span>
<a href="#l47.632"></a><span id="l47.632"> </span>
<a href="#l47.633"></a><span id="l47.633" class="difflineminus">-  if (!mdd-&gt;attachments.Length() &amp;&amp; !bodyAsAttachment)</span>
<a href="#l47.634"></a><span id="l47.634" class="difflineminus">-    return nullptr;</span>
<a href="#l47.635"></a><span id="l47.635" class="difflineplus">+  if (!mdd-&gt;attachments.Length() &amp;&amp; !bodyAsAttachment) return nullptr;</span>
<a href="#l47.636"></a><span id="l47.636"> </span>
<a href="#l47.637"></a><span id="l47.637">   int32_t totalCount = mdd-&gt;attachments.Length();</span>
<a href="#l47.638"></a><span id="l47.638" class="difflineminus">-  if (bodyAsAttachment)</span>
<a href="#l47.639"></a><span id="l47.639" class="difflineminus">-    totalCount++;</span>
<a href="#l47.640"></a><span id="l47.640" class="difflineplus">+  if (bodyAsAttachment) totalCount++;</span>
<a href="#l47.641"></a><span id="l47.641">   attachData = new nsMsgAttachmentData[totalCount + 1];</span>
<a href="#l47.642"></a><span id="l47.642" class="difflineminus">-  if (!attachData)</span>
<a href="#l47.643"></a><span id="l47.643" class="difflineminus">-    return nullptr;</span>
<a href="#l47.644"></a><span id="l47.644" class="difflineplus">+  if (!attachData) return nullptr;</span>
<a href="#l47.645"></a><span id="l47.645"> </span>
<a href="#l47.646"></a><span id="l47.646">   tmp = attachData;</span>
<a href="#l47.647"></a><span id="l47.647"> </span>
<a href="#l47.648"></a><span id="l47.648" class="difflineminus">-  for (int i = 0, attachmentsIndex = 0; i &lt; totalCount; i++, tmp++)</span>
<a href="#l47.649"></a><span id="l47.649" class="difflineminus">-  {</span>
<a href="#l47.650"></a><span id="l47.650" class="difflineplus">+  for (int i = 0, attachmentsIndex = 0; i &lt; totalCount; i++, tmp++) {</span>
<a href="#l47.651"></a><span id="l47.651">     if (bodyAsAttachment &amp;&amp; i == 0)</span>
<a href="#l47.652"></a><span id="l47.652">       tmpFile = mdd-&gt;messageBody;</span>
<a href="#l47.653"></a><span id="l47.653">     else</span>
<a href="#l47.654"></a><span id="l47.654">       tmpFile = mdd-&gt;attachments[attachmentsIndex++];</span>
<a href="#l47.655"></a><span id="l47.655"> </span>
<a href="#l47.656"></a><span id="l47.656">     if (tmpFile-&gt;m_type.LowerCaseEqualsLiteral(&quot;text/x-vcard&quot;))</span>
<a href="#l47.657"></a><span id="l47.657">       tmp-&gt;m_realName = tmpFile-&gt;m_description;</span>
<a href="#l47.658"></a><span id="l47.658"> </span>
<a href="#l47.659"></a><span id="l47.659" class="difflineminus">-    if (tmpFile-&gt;m_origUrl)</span>
<a href="#l47.660"></a><span id="l47.660" class="difflineminus">-    {</span>
<a href="#l47.661"></a><span id="l47.661" class="difflineplus">+    if (tmpFile-&gt;m_origUrl) {</span>
<a href="#l47.662"></a><span id="l47.662">       nsAutoCString tmpSpec;</span>
<a href="#l47.663"></a><span id="l47.663" class="difflineminus">-      if (NS_FAILED(tmpFile-&gt;m_origUrl-&gt;GetSpec(tmpSpec)))</span>
<a href="#l47.664"></a><span id="l47.664" class="difflineplus">+      if (NS_FAILED(tmpFile-&gt;m_origUrl-&gt;GetSpec(tmpSpec))) goto FAIL;</span>
<a href="#l47.665"></a><span id="l47.665" class="difflineplus">+</span>
<a href="#l47.666"></a><span id="l47.666" class="difflineplus">+      if (NS_FAILED(</span>
<a href="#l47.667"></a><span id="l47.667" class="difflineplus">+              nsMimeNewURI(getter_AddRefs(tmp-&gt;m_url), tmpSpec.get(), nullptr)))</span>
<a href="#l47.668"></a><span id="l47.668">         goto FAIL;</span>
<a href="#l47.669"></a><span id="l47.669"> </span>
<a href="#l47.670"></a><span id="l47.670" class="difflineminus">-      if (NS_FAILED(nsMimeNewURI(getter_AddRefs(tmp-&gt;m_url), tmpSpec.get(), nullptr)))</span>
<a href="#l47.671"></a><span id="l47.671" class="difflineminus">-        goto FAIL;</span>
<a href="#l47.672"></a><span id="l47.672" class="difflineminus">-</span>
<a href="#l47.673"></a><span id="l47.673" class="difflineminus">-      if (tmp-&gt;m_realName.IsEmpty())</span>
<a href="#l47.674"></a><span id="l47.674" class="difflineminus">-      {</span>
<a href="#l47.675"></a><span id="l47.675" class="difflineplus">+      if (tmp-&gt;m_realName.IsEmpty()) {</span>
<a href="#l47.676"></a><span id="l47.676">         if (!tmpFile-&gt;m_realName.IsEmpty())</span>
<a href="#l47.677"></a><span id="l47.677">           tmp-&gt;m_realName = tmpFile-&gt;m_realName;</span>
<a href="#l47.678"></a><span id="l47.678">         else {</span>
<a href="#l47.679"></a><span id="l47.679" class="difflineminus">-          if (tmpFile-&gt;m_type.Find(MESSAGE_RFC822, /* ignoreCase = */ true) != -1)</span>
<a href="#l47.680"></a><span id="l47.680" class="difflineplus">+          if (tmpFile-&gt;m_type.Find(MESSAGE_RFC822, /* ignoreCase = */ true) !=</span>
<a href="#l47.681"></a><span id="l47.681" class="difflineplus">+              -1)</span>
<a href="#l47.682"></a><span id="l47.682">             // we have the odd case of processing an e-mail that had an unnamed</span>
<a href="#l47.683"></a><span id="l47.683">             // eml message attached</span>
<a href="#l47.684"></a><span id="l47.684">             tmp-&gt;m_realName = &quot;ForwardedMessage.eml&quot;;</span>
<a href="#l47.685"></a><span id="l47.685"> </span>
<a href="#l47.686"></a><span id="l47.686">           else</span>
<a href="#l47.687"></a><span id="l47.687">             tmp-&gt;m_realName = tmpSpec.get();</span>
<a href="#l47.688"></a><span id="l47.688">         }</span>
<a href="#l47.689"></a><span id="l47.689">       }</span>
<a href="#l47.690"></a><span id="l47.690" class="difflineat">@@ -546,637 +509,548 @@ mime_draft_process_attachments(mime_draf</span>
<a href="#l47.691"></a><span id="l47.691">     tmp-&gt;m_cloudPartInfo = tmpFile-&gt;m_cloudPartInfo;</span>
<a href="#l47.692"></a><span id="l47.692">     tmp-&gt;m_xMacType = tmpFile-&gt;m_xMacType;</span>
<a href="#l47.693"></a><span id="l47.693">     tmp-&gt;m_xMacCreator = tmpFile-&gt;m_xMacCreator;</span>
<a href="#l47.694"></a><span id="l47.694">     tmp-&gt;m_size = tmpFile-&gt;m_size;</span>
<a href="#l47.695"></a><span id="l47.695">   }</span>
<a href="#l47.696"></a><span id="l47.696">   return attachData;</span>
<a href="#l47.697"></a><span id="l47.697"> </span>
<a href="#l47.698"></a><span id="l47.698"> FAIL:</span>
<a href="#l47.699"></a><span id="l47.699" class="difflineminus">-  delete [] attachData;</span>
<a href="#l47.700"></a><span id="l47.700" class="difflineplus">+  delete[] attachData;</span>
<a href="#l47.701"></a><span id="l47.701">   return nullptr;</span>
<a href="#l47.702"></a><span id="l47.702"> }</span>
<a href="#l47.703"></a><span id="l47.703"> </span>
<a href="#l47.704"></a><span id="l47.704" class="difflineminus">-static void</span>
<a href="#l47.705"></a><span id="l47.705" class="difflineminus">-mime_intl_insert_message_header_1(char        **body,</span>
<a href="#l47.706"></a><span id="l47.706" class="difflineminus">-                                  const char  *hdr_value,</span>
<a href="#l47.707"></a><span id="l47.707" class="difflineminus">-                                  const char  *hdr_str,</span>
<a href="#l47.708"></a><span id="l47.708" class="difflineminus">-                                  const char  *html_hdr_str,</span>
<a href="#l47.709"></a><span id="l47.709" class="difflineminus">-                                  const char  *mailcharset,</span>
<a href="#l47.710"></a><span id="l47.710" class="difflineminus">-                                  bool        htmlEdit)</span>
<a href="#l47.711"></a><span id="l47.711" class="difflineminus">-{</span>
<a href="#l47.712"></a><span id="l47.712" class="difflineminus">-  if (!body || !hdr_value || !hdr_str)</span>
<a href="#l47.713"></a><span id="l47.713" class="difflineminus">-    return;</span>
<a href="#l47.714"></a><span id="l47.714" class="difflineplus">+static void mime_intl_insert_message_header_1(</span>
<a href="#l47.715"></a><span id="l47.715" class="difflineplus">+    char **body, const char *hdr_value, const char *hdr_str,</span>
<a href="#l47.716"></a><span id="l47.716" class="difflineplus">+    const char *html_hdr_str, const char *mailcharset, bool htmlEdit) {</span>
<a href="#l47.717"></a><span id="l47.717" class="difflineplus">+  if (!body || !hdr_value || !hdr_str) return;</span>
<a href="#l47.718"></a><span id="l47.718"> </span>
<a href="#l47.719"></a><span id="l47.719" class="difflineminus">-  if (htmlEdit)</span>
<a href="#l47.720"></a><span id="l47.720" class="difflineminus">-  {</span>
<a href="#l47.721"></a><span id="l47.721" class="difflineplus">+  if (htmlEdit) {</span>
<a href="#l47.722"></a><span id="l47.722">     NS_MsgSACat(body, HEADER_START_JUNK);</span>
<a href="#l47.723"></a><span id="l47.723" class="difflineminus">-  }</span>
<a href="#l47.724"></a><span id="l47.724" class="difflineminus">-  else</span>
<a href="#l47.725"></a><span id="l47.725" class="difflineminus">-  {</span>
<a href="#l47.726"></a><span id="l47.726" class="difflineplus">+  } else {</span>
<a href="#l47.727"></a><span id="l47.727">     NS_MsgSACat(body, MSG_LINEBREAK);</span>
<a href="#l47.728"></a><span id="l47.728">   }</span>
<a href="#l47.729"></a><span id="l47.729" class="difflineminus">-  if (!html_hdr_str)</span>
<a href="#l47.730"></a><span id="l47.730" class="difflineminus">-    html_hdr_str = hdr_str;</span>
<a href="#l47.731"></a><span id="l47.731" class="difflineplus">+  if (!html_hdr_str) html_hdr_str = hdr_str;</span>
<a href="#l47.732"></a><span id="l47.732">   NS_MsgSACat(body, html_hdr_str);</span>
<a href="#l47.733"></a><span id="l47.733" class="difflineminus">-  if (htmlEdit)</span>
<a href="#l47.734"></a><span id="l47.734" class="difflineminus">-  {</span>
<a href="#l47.735"></a><span id="l47.735" class="difflineplus">+  if (htmlEdit) {</span>
<a href="#l47.736"></a><span id="l47.736">     NS_MsgSACat(body, HEADER_MIDDLE_JUNK);</span>
<a href="#l47.737"></a><span id="l47.737" class="difflineminus">-  }</span>
<a href="#l47.738"></a><span id="l47.738" class="difflineminus">-  else</span>
<a href="#l47.739"></a><span id="l47.739" class="difflineplus">+  } else</span>
<a href="#l47.740"></a><span id="l47.740">     NS_MsgSACat(body, &quot;: &quot;);</span>
<a href="#l47.741"></a><span id="l47.741"> </span>
<a href="#l47.742"></a><span id="l47.742">   // MIME decode header</span>
<a href="#l47.743"></a><span id="l47.743">   nsAutoCString utf8Value;</span>
<a href="#l47.744"></a><span id="l47.744">   MIME_DecodeMimeHeader(hdr_value, mailcharset, false, true, utf8Value);</span>
<a href="#l47.745"></a><span id="l47.745">   if (!utf8Value.IsEmpty()) {</span>
<a href="#l47.746"></a><span id="l47.746" class="difflineminus">-      if (htmlEdit) {</span>
<a href="#l47.747"></a><span id="l47.747" class="difflineminus">-        nsCString escaped;</span>
<a href="#l47.748"></a><span id="l47.748" class="difflineminus">-        nsAppendEscapedHTML(utf8Value, escaped);</span>
<a href="#l47.749"></a><span id="l47.749" class="difflineminus">-        NS_MsgSACat(body, escaped.get());</span>
<a href="#l47.750"></a><span id="l47.750" class="difflineminus">-      } else {</span>
<a href="#l47.751"></a><span id="l47.751" class="difflineminus">-        NS_MsgSACat(body, utf8Value.get());</span>
<a href="#l47.752"></a><span id="l47.752" class="difflineminus">-      }</span>
<a href="#l47.753"></a><span id="l47.753" class="difflineplus">+    if (htmlEdit) {</span>
<a href="#l47.754"></a><span id="l47.754" class="difflineplus">+      nsCString escaped;</span>
<a href="#l47.755"></a><span id="l47.755" class="difflineplus">+      nsAppendEscapedHTML(utf8Value, escaped);</span>
<a href="#l47.756"></a><span id="l47.756" class="difflineplus">+      NS_MsgSACat(body, escaped.get());</span>
<a href="#l47.757"></a><span id="l47.757" class="difflineplus">+    } else {</span>
<a href="#l47.758"></a><span id="l47.758" class="difflineplus">+      NS_MsgSACat(body, utf8Value.get());</span>
<a href="#l47.759"></a><span id="l47.759" class="difflineplus">+    }</span>
<a href="#l47.760"></a><span id="l47.760">   } else {</span>
<a href="#l47.761"></a><span id="l47.761" class="difflineminus">-      NS_MsgSACat(body, hdr_value); // raw MIME encoded string</span>
<a href="#l47.762"></a><span id="l47.762" class="difflineplus">+    NS_MsgSACat(body, hdr_value);  // raw MIME encoded string</span>
<a href="#l47.763"></a><span id="l47.763">   }</span>
<a href="#l47.764"></a><span id="l47.764"> </span>
<a href="#l47.765"></a><span id="l47.765" class="difflineminus">-  if (htmlEdit)</span>
<a href="#l47.766"></a><span id="l47.766" class="difflineminus">-      NS_MsgSACat(body, HEADER_END_JUNK);</span>
<a href="#l47.767"></a><span id="l47.767" class="difflineplus">+  if (htmlEdit) NS_MsgSACat(body, HEADER_END_JUNK);</span>
<a href="#l47.768"></a><span id="l47.768"> }</span>
<a href="#l47.769"></a><span id="l47.769"> </span>
<a href="#l47.770"></a><span id="l47.770" class="difflineminus">-char *</span>
<a href="#l47.771"></a><span id="l47.771" class="difflineminus">-MimeGetNamedString(int32_t id)</span>
<a href="#l47.772"></a><span id="l47.772" class="difflineminus">-{</span>
<a href="#l47.773"></a><span id="l47.773" class="difflineminus">-  static char   retString[256];</span>
<a href="#l47.774"></a><span id="l47.774" class="difflineplus">+char *MimeGetNamedString(int32_t id) {</span>
<a href="#l47.775"></a><span id="l47.775" class="difflineplus">+  static char retString[256];</span>
<a href="#l47.776"></a><span id="l47.776"> </span>
<a href="#l47.777"></a><span id="l47.777">   retString[0] = '\0';</span>
<a href="#l47.778"></a><span id="l47.778">   char *tString = MimeGetStringByID(id);</span>
<a href="#l47.779"></a><span id="l47.779" class="difflineminus">-  if (tString)</span>
<a href="#l47.780"></a><span id="l47.780" class="difflineminus">-  {</span>
<a href="#l47.781"></a><span id="l47.781" class="difflineplus">+  if (tString) {</span>
<a href="#l47.782"></a><span id="l47.782">     PL_strncpy(retString, tString, sizeof(retString));</span>
<a href="#l47.783"></a><span id="l47.783">     PR_Free(tString);</span>
<a href="#l47.784"></a><span id="l47.784">   }</span>
<a href="#l47.785"></a><span id="l47.785">   return retString;</span>
<a href="#l47.786"></a><span id="l47.786"> }</span>
<a href="#l47.787"></a><span id="l47.787"> </span>
<a href="#l47.788"></a><span id="l47.788" class="difflineminus">-void</span>
<a href="#l47.789"></a><span id="l47.789" class="difflineminus">-MimeGetForwardHeaderDelimiter(nsACString &amp;retString)</span>
<a href="#l47.790"></a><span id="l47.790" class="difflineminus">-{</span>
<a href="#l47.791"></a><span id="l47.791" class="difflineplus">+void MimeGetForwardHeaderDelimiter(nsACString &amp;retString) {</span>
<a href="#l47.792"></a><span id="l47.792">   nsCString defaultValue;</span>
<a href="#l47.793"></a><span id="l47.793">   defaultValue.Adopt(MimeGetStringByID(MIME_FORWARDED_MESSAGE_HTML_USER_WROTE));</span>
<a href="#l47.794"></a><span id="l47.794"> </span>
<a href="#l47.795"></a><span id="l47.795">   nsString tmpRetString;</span>
<a href="#l47.796"></a><span id="l47.796" class="difflineminus">-  NS_GetLocalizedUnicharPreferenceWithDefault(nullptr,</span>
<a href="#l47.797"></a><span id="l47.797" class="difflineminus">-    &quot;mailnews.forward_header_originalmessage&quot;,</span>
<a href="#l47.798"></a><span id="l47.798" class="difflineminus">-    NS_ConvertUTF8toUTF16(defaultValue),</span>
<a href="#l47.799"></a><span id="l47.799" class="difflineminus">-    tmpRetString);</span>
<a href="#l47.800"></a><span id="l47.800" class="difflineplus">+  NS_GetLocalizedUnicharPreferenceWithDefault(</span>
<a href="#l47.801"></a><span id="l47.801" class="difflineplus">+      nullptr, &quot;mailnews.forward_header_originalmessage&quot;,</span>
<a href="#l47.802"></a><span id="l47.802" class="difflineplus">+      NS_ConvertUTF8toUTF16(defaultValue), tmpRetString);</span>
<a href="#l47.803"></a><span id="l47.803"> </span>
<a href="#l47.804"></a><span id="l47.804">   CopyUTF16toUTF8(tmpRetString, retString);</span>
<a href="#l47.805"></a><span id="l47.805"> }</span>
<a href="#l47.806"></a><span id="l47.806"> </span>
<a href="#l47.807"></a><span id="l47.807" class="difflineminus">-/* given an address string passed though parameter &quot;address&quot;, this one will be converted</span>
<a href="#l47.808"></a><span id="l47.808" class="difflineminus">-   and returned through the same parameter. The original string will be destroyed</span>
<a href="#l47.809"></a><span id="l47.809" class="difflineplus">+/* given an address string passed though parameter &quot;address&quot;, this one will be</span>
<a href="#l47.810"></a><span id="l47.810" class="difflineplus">+   converted and returned through the same parameter. The original string will</span>
<a href="#l47.811"></a><span id="l47.811" class="difflineplus">+   be destroyed</span>
<a href="#l47.812"></a><span id="l47.812"> */</span>
<a href="#l47.813"></a><span id="l47.813" class="difflineminus">-static void UnquoteMimeAddress(nsACString &amp;mimeHeader, const char *charset)</span>
<a href="#l47.814"></a><span id="l47.814" class="difflineminus">-{</span>
<a href="#l47.815"></a><span id="l47.815" class="difflineminus">-  if (!mimeHeader.IsEmpty())</span>
<a href="#l47.816"></a><span id="l47.816" class="difflineminus">-  {</span>
<a href="#l47.817"></a><span id="l47.817" class="difflineplus">+static void UnquoteMimeAddress(nsACString &amp;mimeHeader, const char *charset) {</span>
<a href="#l47.818"></a><span id="l47.818" class="difflineplus">+  if (!mimeHeader.IsEmpty()) {</span>
<a href="#l47.819"></a><span id="l47.819">     nsTArray&lt;nsCString&gt; addresses;</span>
<a href="#l47.820"></a><span id="l47.820">     ExtractDisplayAddresses(EncodedHeader(mimeHeader, charset),</span>
<a href="#l47.821"></a><span id="l47.821" class="difflineminus">-      UTF16ArrayAdapter&lt;&gt;(addresses));</span>
<a href="#l47.822"></a><span id="l47.822" class="difflineplus">+                            UTF16ArrayAdapter&lt;&gt;(addresses));</span>
<a href="#l47.823"></a><span id="l47.823">     mimeHeader.Truncate();</span>
<a href="#l47.824"></a><span id="l47.824"> </span>
<a href="#l47.825"></a><span id="l47.825">     uint32_t count = addresses.Length();</span>
<a href="#l47.826"></a><span id="l47.826" class="difflineminus">-    for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l47.827"></a><span id="l47.827" class="difflineminus">-    {</span>
<a href="#l47.828"></a><span id="l47.828" class="difflineminus">-      if (i != 0)</span>
<a href="#l47.829"></a><span id="l47.829" class="difflineminus">-        mimeHeader.AppendASCII(&quot;, &quot;);</span>
<a href="#l47.830"></a><span id="l47.830" class="difflineplus">+    for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l47.831"></a><span id="l47.831" class="difflineplus">+      if (i != 0) mimeHeader.AppendASCII(&quot;, &quot;);</span>
<a href="#l47.832"></a><span id="l47.832">       mimeHeader += addresses[i];</span>
<a href="#l47.833"></a><span id="l47.833">     }</span>
<a href="#l47.834"></a><span id="l47.834">   }</span>
<a href="#l47.835"></a><span id="l47.835"> }</span>
<a href="#l47.836"></a><span id="l47.836"> </span>
<a href="#l47.837"></a><span id="l47.837" class="difflineminus">-static void</span>
<a href="#l47.838"></a><span id="l47.838" class="difflineminus">-mime_insert_all_headers(char            **body,</span>
<a href="#l47.839"></a><span id="l47.839" class="difflineminus">-                        MimeHeaders     *headers,</span>
<a href="#l47.840"></a><span id="l47.840" class="difflineminus">-                        MSG_ComposeFormat composeFormat,</span>
<a href="#l47.841"></a><span id="l47.841" class="difflineminus">-                        char            *mailcharset)</span>
<a href="#l47.842"></a><span id="l47.842" class="difflineminus">-{</span>
<a href="#l47.843"></a><span id="l47.843" class="difflineplus">+static void mime_insert_all_headers(char **body, MimeHeaders *headers,</span>
<a href="#l47.844"></a><span id="l47.844" class="difflineplus">+                                    MSG_ComposeFormat composeFormat,</span>
<a href="#l47.845"></a><span id="l47.845" class="difflineplus">+                                    char *mailcharset) {</span>
<a href="#l47.846"></a><span id="l47.846">   bool htmlEdit = (composeFormat == nsIMsgCompFormat::HTML);</span>
<a href="#l47.847"></a><span id="l47.847">   char *newBody = NULL;</span>
<a href="#l47.848"></a><span id="l47.848">   char *html_tag = nullptr;</span>
<a href="#l47.849"></a><span id="l47.849">   if (*body &amp;&amp; PL_strncasecmp(*body, &quot;&lt;HTML&quot;, 5) == 0)</span>
<a href="#l47.850"></a><span id="l47.850">     html_tag = PL_strchr(*body, '&gt;') + 1;</span>
<a href="#l47.851"></a><span id="l47.851">   int i;</span>
<a href="#l47.852"></a><span id="l47.852"> </span>
<a href="#l47.853"></a><span id="l47.853" class="difflineminus">-  if (!headers-&gt;done_p)</span>
<a href="#l47.854"></a><span id="l47.854" class="difflineminus">-  {</span>
<a href="#l47.855"></a><span id="l47.855" class="difflineplus">+  if (!headers-&gt;done_p) {</span>
<a href="#l47.856"></a><span id="l47.856">     MimeHeaders_build_heads_list(headers);</span>
<a href="#l47.857"></a><span id="l47.857">     headers-&gt;done_p = true;</span>
<a href="#l47.858"></a><span id="l47.858">   }</span>
<a href="#l47.859"></a><span id="l47.859"> </span>
<a href="#l47.860"></a><span id="l47.860">   nsCString replyHeader;</span>
<a href="#l47.861"></a><span id="l47.861">   MimeGetForwardHeaderDelimiter(replyHeader);</span>
<a href="#l47.862"></a><span id="l47.862" class="difflineminus">-  if (htmlEdit)</span>
<a href="#l47.863"></a><span id="l47.863" class="difflineminus">-  {</span>
<a href="#l47.864"></a><span id="l47.864" class="difflineplus">+  if (htmlEdit) {</span>
<a href="#l47.865"></a><span id="l47.865">     NS_MsgSACopy(&amp;(newBody), MIME_FORWARD_HTML_PREFIX);</span>
<a href="#l47.866"></a><span id="l47.866">     NS_MsgSACat(&amp;newBody, replyHeader.get());</span>
<a href="#l47.867"></a><span id="l47.867">     NS_MsgSACat(&amp;newBody, MIME_HEADER_TABLE);</span>
<a href="#l47.868"></a><span id="l47.868" class="difflineminus">-  }</span>
<a href="#l47.869"></a><span id="l47.869" class="difflineminus">-  else</span>
<a href="#l47.870"></a><span id="l47.870" class="difflineminus">-  {</span>
<a href="#l47.871"></a><span id="l47.871" class="difflineplus">+  } else {</span>
<a href="#l47.872"></a><span id="l47.872">     NS_MsgSACopy(&amp;(newBody), MSG_LINEBREAK MSG_LINEBREAK);</span>
<a href="#l47.873"></a><span id="l47.873">     NS_MsgSACat(&amp;newBody, replyHeader.get());</span>
<a href="#l47.874"></a><span id="l47.874">   }</span>
<a href="#l47.875"></a><span id="l47.875"> </span>
<a href="#l47.876"></a><span id="l47.876" class="difflineminus">-  for (i = 0; i &lt; headers-&gt;heads_size; i++)</span>
<a href="#l47.877"></a><span id="l47.877" class="difflineminus">-  {</span>
<a href="#l47.878"></a><span id="l47.878" class="difflineplus">+  for (i = 0; i &lt; headers-&gt;heads_size; i++) {</span>
<a href="#l47.879"></a><span id="l47.879">     char *head = headers-&gt;heads[i];</span>
<a href="#l47.880"></a><span id="l47.880" class="difflineminus">-    char *end = (i == headers-&gt;heads_size-1</span>
<a href="#l47.881"></a><span id="l47.881" class="difflineminus">-           ? headers-&gt;all_headers + headers-&gt;all_headers_fp</span>
<a href="#l47.882"></a><span id="l47.882" class="difflineminus">-           : headers-&gt;heads[i+1]);</span>
<a href="#l47.883"></a><span id="l47.883" class="difflineplus">+    char *end = (i == headers-&gt;heads_size - 1</span>
<a href="#l47.884"></a><span id="l47.884" class="difflineplus">+                     ? headers-&gt;all_headers + headers-&gt;all_headers_fp</span>
<a href="#l47.885"></a><span id="l47.885" class="difflineplus">+                     : headers-&gt;heads[i + 1]);</span>
<a href="#l47.886"></a><span id="l47.886">     char *colon, *ocolon;</span>
<a href="#l47.887"></a><span id="l47.887">     char *contents;</span>
<a href="#l47.888"></a><span id="l47.888">     char *name = 0;</span>
<a href="#l47.889"></a><span id="l47.889"> </span>
<a href="#l47.890"></a><span id="l47.890">     // Hack for BSD Mailbox delimiter.</span>
<a href="#l47.891"></a><span id="l47.891" class="difflineminus">-    if (i == 0 &amp;&amp; head[0] == 'F' &amp;&amp; !strncmp(head, &quot;From &quot;, 5))</span>
<a href="#l47.892"></a><span id="l47.892" class="difflineminus">-    {</span>
<a href="#l47.893"></a><span id="l47.893" class="difflineplus">+    if (i == 0 &amp;&amp; head[0] == 'F' &amp;&amp; !strncmp(head, &quot;From &quot;, 5)) {</span>
<a href="#l47.894"></a><span id="l47.894">       colon = head + 4;</span>
<a href="#l47.895"></a><span id="l47.895">       contents = colon + 1;</span>
<a href="#l47.896"></a><span id="l47.896" class="difflineminus">-    }</span>
<a href="#l47.897"></a><span id="l47.897" class="difflineminus">-    else</span>
<a href="#l47.898"></a><span id="l47.898" class="difflineminus">-    {</span>
<a href="#l47.899"></a><span id="l47.899" class="difflineplus">+    } else {</span>
<a href="#l47.900"></a><span id="l47.900">       /* Find the colon. */</span>
<a href="#l47.901"></a><span id="l47.901">       for (colon = head; colon &lt; end; colon++)</span>
<a href="#l47.902"></a><span id="l47.902" class="difflineminus">-      if (*colon == ':') break;</span>
<a href="#l47.903"></a><span id="l47.903" class="difflineplus">+        if (*colon == ':') break;</span>
<a href="#l47.904"></a><span id="l47.904"> </span>
<a href="#l47.905"></a><span id="l47.905" class="difflineminus">-      if (colon &gt;= end) continue;   /* junk */</span>
<a href="#l47.906"></a><span id="l47.906" class="difflineplus">+      if (colon &gt;= end) continue; /* junk */</span>
<a href="#l47.907"></a><span id="l47.907"> </span>
<a href="#l47.908"></a><span id="l47.908">       /* Back up over whitespace before the colon. */</span>
<a href="#l47.909"></a><span id="l47.909">       ocolon = colon;</span>
<a href="#l47.910"></a><span id="l47.910">       for (; colon &gt; head &amp;&amp; IS_SPACE(colon[-1]); colon--)</span>
<a href="#l47.911"></a><span id="l47.911" class="difflineminus">-      ;</span>
<a href="#l47.912"></a><span id="l47.912" class="difflineplus">+        ;</span>
<a href="#l47.913"></a><span id="l47.913"> </span>
<a href="#l47.914"></a><span id="l47.914">       contents = ocolon + 1;</span>
<a href="#l47.915"></a><span id="l47.915">     }</span>
<a href="#l47.916"></a><span id="l47.916"> </span>
<a href="#l47.917"></a><span id="l47.917">     /* Skip over whitespace after colon. */</span>
<a href="#l47.918"></a><span id="l47.918" class="difflineminus">-    while (contents &lt;= end &amp;&amp; IS_SPACE(*contents))</span>
<a href="#l47.919"></a><span id="l47.919" class="difflineminus">-    contents++;</span>
<a href="#l47.920"></a><span id="l47.920" class="difflineplus">+    while (contents &lt;= end &amp;&amp; IS_SPACE(*contents)) contents++;</span>
<a href="#l47.921"></a><span id="l47.921"> </span>
<a href="#l47.922"></a><span id="l47.922">     /* Take off trailing whitespace... */</span>
<a href="#l47.923"></a><span id="l47.923" class="difflineminus">-    while (end &gt; contents &amp;&amp; IS_SPACE(end[-1]))</span>
<a href="#l47.924"></a><span id="l47.924" class="difflineminus">-    end--;</span>
<a href="#l47.925"></a><span id="l47.925" class="difflineplus">+    while (end &gt; contents &amp;&amp; IS_SPACE(end[-1])) end--;</span>
<a href="#l47.926"></a><span id="l47.926"> </span>
<a href="#l47.927"></a><span id="l47.927">     name = (char *)PR_MALLOC(colon - head + 1);</span>
<a href="#l47.928"></a><span id="l47.928" class="difflineminus">-    if (!name)</span>
<a href="#l47.929"></a><span id="l47.929" class="difflineminus">-      return /* MIME_OUT_OF_MEMORY */;</span>
<a href="#l47.930"></a><span id="l47.930" class="difflineplus">+    if (!name) return /* MIME_OUT_OF_MEMORY */;</span>
<a href="#l47.931"></a><span id="l47.931">     memcpy(name, head, colon - head);</span>
<a href="#l47.932"></a><span id="l47.932">     name[colon - head] = 0;</span>
<a href="#l47.933"></a><span id="l47.933"> </span>
<a href="#l47.934"></a><span id="l47.934">     nsAutoCString headerValue;</span>
<a href="#l47.935"></a><span id="l47.935">     headerValue.Assign(contents, end - contents);</span>
<a href="#l47.936"></a><span id="l47.936"> </span>
<a href="#l47.937"></a><span id="l47.937">     /* Do not reveal bcc recipients when forwarding a message!</span>
<a href="#l47.938"></a><span id="l47.938">        See http://bugzilla.mozilla.org/show_bug.cgi?id=41150</span>
<a href="#l47.939"></a><span id="l47.939">     */</span>
<a href="#l47.940"></a><span id="l47.940" class="difflineminus">-    if (PL_strcasecmp(name, &quot;bcc&quot;) != 0)</span>
<a href="#l47.941"></a><span id="l47.941" class="difflineminus">-    {</span>
<a href="#l47.942"></a><span id="l47.942" class="difflineplus">+    if (PL_strcasecmp(name, &quot;bcc&quot;) != 0) {</span>
<a href="#l47.943"></a><span id="l47.943">       if (!PL_strcasecmp(name, &quot;resent-from&quot;) || !PL_strcasecmp(name, &quot;from&quot;) ||</span>
<a href="#l47.944"></a><span id="l47.944">           !PL_strcasecmp(name, &quot;resent-to&quot;) || !PL_strcasecmp(name, &quot;to&quot;) ||</span>
<a href="#l47.945"></a><span id="l47.945">           !PL_strcasecmp(name, &quot;resent-cc&quot;) || !PL_strcasecmp(name, &quot;cc&quot;) ||</span>
<a href="#l47.946"></a><span id="l47.946">           !PL_strcasecmp(name, &quot;reply-to&quot;))</span>
<a href="#l47.947"></a><span id="l47.947">         UnquoteMimeAddress(headerValue, mailcharset);</span>
<a href="#l47.948"></a><span id="l47.948"> </span>
<a href="#l47.949"></a><span id="l47.949">       mime_intl_insert_message_header_1(&amp;newBody, headerValue.get(), name, name,</span>
<a href="#l47.950"></a><span id="l47.950" class="difflineminus">-        mailcharset, htmlEdit);</span>
<a href="#l47.951"></a><span id="l47.951" class="difflineplus">+                                        mailcharset, htmlEdit);</span>
<a href="#l47.952"></a><span id="l47.952">     }</span>
<a href="#l47.953"></a><span id="l47.953">     PR_Free(name);</span>
<a href="#l47.954"></a><span id="l47.954">   }</span>
<a href="#l47.955"></a><span id="l47.955"> </span>
<a href="#l47.956"></a><span id="l47.956" class="difflineminus">-  if (htmlEdit)</span>
<a href="#l47.957"></a><span id="l47.957" class="difflineminus">-  {</span>
<a href="#l47.958"></a><span id="l47.958" class="difflineplus">+  if (htmlEdit) {</span>
<a href="#l47.959"></a><span id="l47.959">     NS_MsgSACat(&amp;newBody, &quot;&lt;/TABLE&gt;&quot;);</span>
<a href="#l47.960"></a><span id="l47.960">     NS_MsgSACat(&amp;newBody, MSG_LINEBREAK &quot;&lt;BR&gt;&lt;BR&gt;&quot;);</span>
<a href="#l47.961"></a><span id="l47.961">     if (html_tag)</span>
<a href="#l47.962"></a><span id="l47.962">       NS_MsgSACat(&amp;newBody, html_tag);</span>
<a href="#l47.963"></a><span id="l47.963">     else if (*body)</span>
<a href="#l47.964"></a><span id="l47.964" class="difflineminus">-        NS_MsgSACat(&amp;newBody, *body);</span>
<a href="#l47.965"></a><span id="l47.965" class="difflineminus">-  }</span>
<a href="#l47.966"></a><span id="l47.966" class="difflineminus">-  else</span>
<a href="#l47.967"></a><span id="l47.967" class="difflineminus">-  {</span>
<a href="#l47.968"></a><span id="l47.968" class="difflineplus">+      NS_MsgSACat(&amp;newBody, *body);</span>
<a href="#l47.969"></a><span id="l47.969" class="difflineplus">+  } else {</span>
<a href="#l47.970"></a><span id="l47.970">     NS_MsgSACat(&amp;newBody, MSG_LINEBREAK MSG_LINEBREAK);</span>
<a href="#l47.971"></a><span id="l47.971" class="difflineminus">-    if (*body)</span>
<a href="#l47.972"></a><span id="l47.972" class="difflineminus">-      NS_MsgSACat(&amp;newBody, *body);</span>
<a href="#l47.973"></a><span id="l47.973" class="difflineplus">+    if (*body) NS_MsgSACat(&amp;newBody, *body);</span>
<a href="#l47.974"></a><span id="l47.974">   }</span>
<a href="#l47.975"></a><span id="l47.975"> </span>
<a href="#l47.976"></a><span id="l47.976" class="difflineminus">-  if (newBody)</span>
<a href="#l47.977"></a><span id="l47.977" class="difflineminus">-  {</span>
<a href="#l47.978"></a><span id="l47.978" class="difflineplus">+  if (newBody) {</span>
<a href="#l47.979"></a><span id="l47.979">     PR_FREEIF(*body);</span>
<a href="#l47.980"></a><span id="l47.980">     *body = newBody;</span>
<a href="#l47.981"></a><span id="l47.981">   }</span>
<a href="#l47.982"></a><span id="l47.982"> }</span>
<a href="#l47.983"></a><span id="l47.983"> </span>
<a href="#l47.984"></a><span id="l47.984" class="difflineminus">-static void</span>
<a href="#l47.985"></a><span id="l47.985" class="difflineminus">-mime_insert_normal_headers(char             **body,</span>
<a href="#l47.986"></a><span id="l47.986" class="difflineminus">-                           MimeHeaders      *headers,</span>
<a href="#l47.987"></a><span id="l47.987" class="difflineminus">-                           MSG_ComposeFormat composeFormat,</span>
<a href="#l47.988"></a><span id="l47.988" class="difflineminus">-                           char             *mailcharset)</span>
<a href="#l47.989"></a><span id="l47.989" class="difflineminus">-{</span>
<a href="#l47.990"></a><span id="l47.990" class="difflineplus">+static void mime_insert_normal_headers(char **body, MimeHeaders *headers,</span>
<a href="#l47.991"></a><span id="l47.991" class="difflineplus">+                                       MSG_ComposeFormat composeFormat,</span>
<a href="#l47.992"></a><span id="l47.992" class="difflineplus">+                                       char *mailcharset) {</span>
<a href="#l47.993"></a><span id="l47.993">   char *newBody = nullptr;</span>
<a href="#l47.994"></a><span id="l47.994">   char *subject = MimeHeaders_get(headers, HEADER_SUBJECT, false, false);</span>
<a href="#l47.995"></a><span id="l47.995" class="difflineminus">-  char *resent_comments = MimeHeaders_get(headers, HEADER_RESENT_COMMENTS, false, false);</span>
<a href="#l47.996"></a><span id="l47.996" class="difflineplus">+  char *resent_comments =</span>
<a href="#l47.997"></a><span id="l47.997" class="difflineplus">+      MimeHeaders_get(headers, HEADER_RESENT_COMMENTS, false, false);</span>
<a href="#l47.998"></a><span id="l47.998">   char *resent_date = MimeHeaders_get(headers, HEADER_RESENT_DATE, false, true);</span>
<a href="#l47.999"></a><span id="l47.999" class="difflineminus">-  nsCString resent_from(MimeHeaders_get(headers, HEADER_RESENT_FROM, false, true));</span>
<a href="#l47.1000"></a><span id="l47.1000" class="difflineplus">+  nsCString resent_from(</span>
<a href="#l47.1001"></a><span id="l47.1001" class="difflineplus">+      MimeHeaders_get(headers, HEADER_RESENT_FROM, false, true));</span>
<a href="#l47.1002"></a><span id="l47.1002">   nsCString resent_to(MimeHeaders_get(headers, HEADER_RESENT_TO, false, true));</span>
<a href="#l47.1003"></a><span id="l47.1003">   nsCString resent_cc(MimeHeaders_get(headers, HEADER_RESENT_CC, false, true));</span>
<a href="#l47.1004"></a><span id="l47.1004">   char *date = MimeHeaders_get(headers, HEADER_DATE, false, true);</span>
<a href="#l47.1005"></a><span id="l47.1005">   nsCString from(MimeHeaders_get(headers, HEADER_FROM, false, true));</span>
<a href="#l47.1006"></a><span id="l47.1006">   nsCString reply_to(MimeHeaders_get(headers, HEADER_REPLY_TO, false, true));</span>
<a href="#l47.1007"></a><span id="l47.1007" class="difflineminus">-  char *organization = MimeHeaders_get(headers, HEADER_ORGANIZATION, false, false);</span>
<a href="#l47.1008"></a><span id="l47.1008" class="difflineplus">+  char *organization =</span>
<a href="#l47.1009"></a><span id="l47.1009" class="difflineplus">+      MimeHeaders_get(headers, HEADER_ORGANIZATION, false, false);</span>
<a href="#l47.1010"></a><span id="l47.1010">   nsCString to(MimeHeaders_get(headers, HEADER_TO, false, true));</span>
<a href="#l47.1011"></a><span id="l47.1011">   nsCString cc(MimeHeaders_get(headers, HEADER_CC, false, true));</span>
<a href="#l47.1012"></a><span id="l47.1012">   char *newsgroups = MimeHeaders_get(headers, HEADER_NEWSGROUPS, false, true);</span>
<a href="#l47.1013"></a><span id="l47.1013">   char *followup_to = MimeHeaders_get(headers, HEADER_FOLLOWUP_TO, false, true);</span>
<a href="#l47.1014"></a><span id="l47.1014">   char *references = MimeHeaders_get(headers, HEADER_REFERENCES, false, true);</span>
<a href="#l47.1015"></a><span id="l47.1015">   const char *html_tag = nullptr;</span>
<a href="#l47.1016"></a><span id="l47.1016">   if (*body &amp;&amp; PL_strncasecmp(*body, &quot;&lt;HTML&quot;, 5) == 0)</span>
<a href="#l47.1017"></a><span id="l47.1017">     html_tag = PL_strchr(*body, '&gt;') + 1;</span>
<a href="#l47.1018"></a><span id="l47.1018">   bool htmlEdit = composeFormat == nsIMsgCompFormat::HTML;</span>
<a href="#l47.1019"></a><span id="l47.1019"> </span>
<a href="#l47.1020"></a><span id="l47.1020">   if (from.IsEmpty())</span>
<a href="#l47.1021"></a><span id="l47.1021">     from.Adopt(MimeHeaders_get(headers, HEADER_SENDER, false, true));</span>
<a href="#l47.1022"></a><span id="l47.1022">   if (resent_from.IsEmpty())</span>
<a href="#l47.1023"></a><span id="l47.1023" class="difflineminus">-    resent_from.Adopt(MimeHeaders_get(headers, HEADER_RESENT_SENDER, false,</span>
<a href="#l47.1024"></a><span id="l47.1024" class="difflineminus">-      true));</span>
<a href="#l47.1025"></a><span id="l47.1025" class="difflineplus">+    resent_from.Adopt(</span>
<a href="#l47.1026"></a><span id="l47.1026" class="difflineplus">+        MimeHeaders_get(headers, HEADER_RESENT_SENDER, false, true));</span>
<a href="#l47.1027"></a><span id="l47.1027"> </span>
<a href="#l47.1028"></a><span id="l47.1028">   UnquoteMimeAddress(resent_from, mailcharset);</span>
<a href="#l47.1029"></a><span id="l47.1029">   UnquoteMimeAddress(resent_to, mailcharset);</span>
<a href="#l47.1030"></a><span id="l47.1030">   UnquoteMimeAddress(resent_cc, mailcharset);</span>
<a href="#l47.1031"></a><span id="l47.1031">   UnquoteMimeAddress(reply_to, mailcharset);</span>
<a href="#l47.1032"></a><span id="l47.1032">   UnquoteMimeAddress(from, mailcharset);</span>
<a href="#l47.1033"></a><span id="l47.1033">   UnquoteMimeAddress(to, mailcharset);</span>
<a href="#l47.1034"></a><span id="l47.1034">   UnquoteMimeAddress(cc, mailcharset);</span>
<a href="#l47.1035"></a><span id="l47.1035"> </span>
<a href="#l47.1036"></a><span id="l47.1036">   nsCString replyHeader;</span>
<a href="#l47.1037"></a><span id="l47.1037">   MimeGetForwardHeaderDelimiter(replyHeader);</span>
<a href="#l47.1038"></a><span id="l47.1038" class="difflineminus">-  if (htmlEdit)</span>
<a href="#l47.1039"></a><span id="l47.1039" class="difflineminus">-  {</span>
<a href="#l47.1040"></a><span id="l47.1040" class="difflineplus">+  if (htmlEdit) {</span>
<a href="#l47.1041"></a><span id="l47.1041">     NS_MsgSACopy(&amp;(newBody), MIME_FORWARD_HTML_PREFIX);</span>
<a href="#l47.1042"></a><span id="l47.1042">     NS_MsgSACat(&amp;newBody, replyHeader.get());</span>
<a href="#l47.1043"></a><span id="l47.1043">     NS_MsgSACat(&amp;newBody, MIME_HEADER_TABLE);</span>
<a href="#l47.1044"></a><span id="l47.1044" class="difflineminus">-  }</span>
<a href="#l47.1045"></a><span id="l47.1045" class="difflineminus">-  else</span>
<a href="#l47.1046"></a><span id="l47.1046" class="difflineminus">-  {</span>
<a href="#l47.1047"></a><span id="l47.1047" class="difflineplus">+  } else {</span>
<a href="#l47.1048"></a><span id="l47.1048">     NS_MsgSACopy(&amp;(newBody), MSG_LINEBREAK MSG_LINEBREAK);</span>
<a href="#l47.1049"></a><span id="l47.1049">     NS_MsgSACat(&amp;newBody, replyHeader.get());</span>
<a href="#l47.1050"></a><span id="l47.1050">   }</span>
<a href="#l47.1051"></a><span id="l47.1051">   if (subject)</span>
<a href="#l47.1052"></a><span id="l47.1052">     mime_intl_insert_message_header_1(&amp;newBody, subject, HEADER_SUBJECT,</span>
<a href="#l47.1053"></a><span id="l47.1053" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_SUBJECT),</span>
<a href="#l47.1054"></a><span id="l47.1054" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1055"></a><span id="l47.1055" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_SUBJECT),</span>
<a href="#l47.1056"></a><span id="l47.1056" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1057"></a><span id="l47.1057">   if (resent_comments)</span>
<a href="#l47.1058"></a><span id="l47.1058" class="difflineminus">-    mime_intl_insert_message_header_1(&amp;newBody, resent_comments,</span>
<a href="#l47.1059"></a><span id="l47.1059" class="difflineminus">-                      HEADER_RESENT_COMMENTS,</span>
<a href="#l47.1060"></a><span id="l47.1060" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_RESENT_COMMENTS),</span>
<a href="#l47.1061"></a><span id="l47.1061" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1062"></a><span id="l47.1062" class="difflineplus">+    mime_intl_insert_message_header_1(</span>
<a href="#l47.1063"></a><span id="l47.1063" class="difflineplus">+        &amp;newBody, resent_comments, HEADER_RESENT_COMMENTS,</span>
<a href="#l47.1064"></a><span id="l47.1064" class="difflineplus">+        MimeGetNamedString(MIME_MHTML_RESENT_COMMENTS), mailcharset, htmlEdit);</span>
<a href="#l47.1065"></a><span id="l47.1065">   if (resent_date)</span>
<a href="#l47.1066"></a><span id="l47.1066" class="difflineminus">-    mime_intl_insert_message_header_1(&amp;newBody, resent_date,</span>
<a href="#l47.1067"></a><span id="l47.1067" class="difflineminus">-                      HEADER_RESENT_DATE,</span>
<a href="#l47.1068"></a><span id="l47.1068" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_RESENT_DATE),</span>
<a href="#l47.1069"></a><span id="l47.1069" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1070"></a><span id="l47.1070" class="difflineminus">-  if (!resent_from.IsEmpty())</span>
<a href="#l47.1071"></a><span id="l47.1071" class="difflineminus">-  {</span>
<a href="#l47.1072"></a><span id="l47.1072" class="difflineminus">-    mime_intl_insert_message_header_1(&amp;newBody, resent_from.get(),</span>
<a href="#l47.1073"></a><span id="l47.1073" class="difflineminus">-                      HEADER_RESENT_FROM,</span>
<a href="#l47.1074"></a><span id="l47.1074" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_RESENT_FROM),</span>
<a href="#l47.1075"></a><span id="l47.1075" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1076"></a><span id="l47.1076" class="difflineplus">+    mime_intl_insert_message_header_1(</span>
<a href="#l47.1077"></a><span id="l47.1077" class="difflineplus">+        &amp;newBody, resent_date, HEADER_RESENT_DATE,</span>
<a href="#l47.1078"></a><span id="l47.1078" class="difflineplus">+        MimeGetNamedString(MIME_MHTML_RESENT_DATE), mailcharset, htmlEdit);</span>
<a href="#l47.1079"></a><span id="l47.1079" class="difflineplus">+  if (!resent_from.IsEmpty()) {</span>
<a href="#l47.1080"></a><span id="l47.1080" class="difflineplus">+    mime_intl_insert_message_header_1(</span>
<a href="#l47.1081"></a><span id="l47.1081" class="difflineplus">+        &amp;newBody, resent_from.get(), HEADER_RESENT_FROM,</span>
<a href="#l47.1082"></a><span id="l47.1082" class="difflineplus">+        MimeGetNamedString(MIME_MHTML_RESENT_FROM), mailcharset, htmlEdit);</span>
<a href="#l47.1083"></a><span id="l47.1083">   }</span>
<a href="#l47.1084"></a><span id="l47.1084" class="difflineminus">-  if (!resent_to.IsEmpty())</span>
<a href="#l47.1085"></a><span id="l47.1085" class="difflineminus">-  {</span>
<a href="#l47.1086"></a><span id="l47.1086" class="difflineminus">-    mime_intl_insert_message_header_1(&amp;newBody, resent_to.get(),</span>
<a href="#l47.1087"></a><span id="l47.1087" class="difflineminus">-                      HEADER_RESENT_TO,</span>
<a href="#l47.1088"></a><span id="l47.1088" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_RESENT_TO),</span>
<a href="#l47.1089"></a><span id="l47.1089" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1090"></a><span id="l47.1090" class="difflineplus">+  if (!resent_to.IsEmpty()) {</span>
<a href="#l47.1091"></a><span id="l47.1091" class="difflineplus">+    mime_intl_insert_message_header_1(</span>
<a href="#l47.1092"></a><span id="l47.1092" class="difflineplus">+        &amp;newBody, resent_to.get(), HEADER_RESENT_TO,</span>
<a href="#l47.1093"></a><span id="l47.1093" class="difflineplus">+        MimeGetNamedString(MIME_MHTML_RESENT_TO), mailcharset, htmlEdit);</span>
<a href="#l47.1094"></a><span id="l47.1094">   }</span>
<a href="#l47.1095"></a><span id="l47.1095" class="difflineminus">-  if (!resent_cc.IsEmpty())</span>
<a href="#l47.1096"></a><span id="l47.1096" class="difflineminus">-  {</span>
<a href="#l47.1097"></a><span id="l47.1097" class="difflineminus">-    mime_intl_insert_message_header_1(&amp;newBody, resent_cc.get(),</span>
<a href="#l47.1098"></a><span id="l47.1098" class="difflineminus">-                      HEADER_RESENT_CC,</span>
<a href="#l47.1099"></a><span id="l47.1099" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_RESENT_CC),</span>
<a href="#l47.1100"></a><span id="l47.1100" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1101"></a><span id="l47.1101" class="difflineplus">+  if (!resent_cc.IsEmpty()) {</span>
<a href="#l47.1102"></a><span id="l47.1102" class="difflineplus">+    mime_intl_insert_message_header_1(</span>
<a href="#l47.1103"></a><span id="l47.1103" class="difflineplus">+        &amp;newBody, resent_cc.get(), HEADER_RESENT_CC,</span>
<a href="#l47.1104"></a><span id="l47.1104" class="difflineplus">+        MimeGetNamedString(MIME_MHTML_RESENT_CC), mailcharset, htmlEdit);</span>
<a href="#l47.1105"></a><span id="l47.1105">   }</span>
<a href="#l47.1106"></a><span id="l47.1106">   if (date)</span>
<a href="#l47.1107"></a><span id="l47.1107">     mime_intl_insert_message_header_1(&amp;newBody, date, HEADER_DATE,</span>
<a href="#l47.1108"></a><span id="l47.1108" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_DATE),</span>
<a href="#l47.1109"></a><span id="l47.1109" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1110"></a><span id="l47.1110" class="difflineminus">-  if (!from.IsEmpty())</span>
<a href="#l47.1111"></a><span id="l47.1111" class="difflineminus">-  {</span>
<a href="#l47.1112"></a><span id="l47.1112" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_DATE),</span>
<a href="#l47.1113"></a><span id="l47.1113" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1114"></a><span id="l47.1114" class="difflineplus">+  if (!from.IsEmpty()) {</span>
<a href="#l47.1115"></a><span id="l47.1115">     mime_intl_insert_message_header_1(&amp;newBody, from.get(), HEADER_FROM,</span>
<a href="#l47.1116"></a><span id="l47.1116" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_FROM),</span>
<a href="#l47.1117"></a><span id="l47.1117" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1118"></a><span id="l47.1118" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_FROM),</span>
<a href="#l47.1119"></a><span id="l47.1119" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1120"></a><span id="l47.1120">   }</span>
<a href="#l47.1121"></a><span id="l47.1121" class="difflineminus">-  if (!reply_to.IsEmpty())</span>
<a href="#l47.1122"></a><span id="l47.1122" class="difflineminus">-  {</span>
<a href="#l47.1123"></a><span id="l47.1123" class="difflineplus">+  if (!reply_to.IsEmpty()) {</span>
<a href="#l47.1124"></a><span id="l47.1124">     mime_intl_insert_message_header_1(&amp;newBody, reply_to.get(), HEADER_REPLY_TO,</span>
<a href="#l47.1125"></a><span id="l47.1125" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_REPLY_TO),</span>
<a href="#l47.1126"></a><span id="l47.1126" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1127"></a><span id="l47.1127" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_REPLY_TO),</span>
<a href="#l47.1128"></a><span id="l47.1128" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1129"></a><span id="l47.1129">   }</span>
<a href="#l47.1130"></a><span id="l47.1130">   if (organization)</span>
<a href="#l47.1131"></a><span id="l47.1131" class="difflineminus">-    mime_intl_insert_message_header_1(&amp;newBody, organization,</span>
<a href="#l47.1132"></a><span id="l47.1132" class="difflineminus">-                      HEADER_ORGANIZATION,</span>
<a href="#l47.1133"></a><span id="l47.1133" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_ORGANIZATION),</span>
<a href="#l47.1134"></a><span id="l47.1134" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1135"></a><span id="l47.1135" class="difflineminus">-  if (!to.IsEmpty())</span>
<a href="#l47.1136"></a><span id="l47.1136" class="difflineminus">-  {</span>
<a href="#l47.1137"></a><span id="l47.1137" class="difflineplus">+    mime_intl_insert_message_header_1(</span>
<a href="#l47.1138"></a><span id="l47.1138" class="difflineplus">+        &amp;newBody, organization, HEADER_ORGANIZATION,</span>
<a href="#l47.1139"></a><span id="l47.1139" class="difflineplus">+        MimeGetNamedString(MIME_MHTML_ORGANIZATION), mailcharset, htmlEdit);</span>
<a href="#l47.1140"></a><span id="l47.1140" class="difflineplus">+  if (!to.IsEmpty()) {</span>
<a href="#l47.1141"></a><span id="l47.1141">     mime_intl_insert_message_header_1(&amp;newBody, to.get(), HEADER_TO,</span>
<a href="#l47.1142"></a><span id="l47.1142" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_TO),</span>
<a href="#l47.1143"></a><span id="l47.1143" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1144"></a><span id="l47.1144" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_TO),</span>
<a href="#l47.1145"></a><span id="l47.1145" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1146"></a><span id="l47.1146">   }</span>
<a href="#l47.1147"></a><span id="l47.1147" class="difflineminus">-  if (!cc.IsEmpty())</span>
<a href="#l47.1148"></a><span id="l47.1148" class="difflineminus">-  {</span>
<a href="#l47.1149"></a><span id="l47.1149" class="difflineplus">+  if (!cc.IsEmpty()) {</span>
<a href="#l47.1150"></a><span id="l47.1150">     mime_intl_insert_message_header_1(&amp;newBody, cc.get(), HEADER_CC,</span>
<a href="#l47.1151"></a><span id="l47.1151" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_CC),</span>
<a href="#l47.1152"></a><span id="l47.1152" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1153"></a><span id="l47.1153" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_CC),</span>
<a href="#l47.1154"></a><span id="l47.1154" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1155"></a><span id="l47.1155">   }</span>
<a href="#l47.1156"></a><span id="l47.1156" class="difflineminus">-    /*</span>
<a href="#l47.1157"></a><span id="l47.1157" class="difflineminus">-      Do not reveal bcc recipients when forwarding a message!</span>
<a href="#l47.1158"></a><span id="l47.1158" class="difflineminus">-      See http://bugzilla.mozilla.org/show_bug.cgi?id=41150</span>
<a href="#l47.1159"></a><span id="l47.1159" class="difflineminus">-    */</span>
<a href="#l47.1160"></a><span id="l47.1160" class="difflineplus">+  /*</span>
<a href="#l47.1161"></a><span id="l47.1161" class="difflineplus">+    Do not reveal bcc recipients when forwarding a message!</span>
<a href="#l47.1162"></a><span id="l47.1162" class="difflineplus">+    See http://bugzilla.mozilla.org/show_bug.cgi?id=41150</span>
<a href="#l47.1163"></a><span id="l47.1163" class="difflineplus">+  */</span>
<a href="#l47.1164"></a><span id="l47.1164">   if (newsgroups)</span>
<a href="#l47.1165"></a><span id="l47.1165">     mime_intl_insert_message_header_1(&amp;newBody, newsgroups, HEADER_NEWSGROUPS,</span>
<a href="#l47.1166"></a><span id="l47.1166" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_NEWSGROUPS),</span>
<a href="#l47.1167"></a><span id="l47.1167" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1168"></a><span id="l47.1168" class="difflineminus">-  if (followup_to)</span>
<a href="#l47.1169"></a><span id="l47.1169" class="difflineminus">-  {</span>
<a href="#l47.1170"></a><span id="l47.1170" class="difflineminus">-    mime_intl_insert_message_header_1(&amp;newBody, followup_to,</span>
<a href="#l47.1171"></a><span id="l47.1171" class="difflineminus">-                      HEADER_FOLLOWUP_TO,</span>
<a href="#l47.1172"></a><span id="l47.1172" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_FOLLOWUP_TO),</span>
<a href="#l47.1173"></a><span id="l47.1173" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1174"></a><span id="l47.1174" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_NEWSGROUPS),</span>
<a href="#l47.1175"></a><span id="l47.1175" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1176"></a><span id="l47.1176" class="difflineplus">+  if (followup_to) {</span>
<a href="#l47.1177"></a><span id="l47.1177" class="difflineplus">+    mime_intl_insert_message_header_1(</span>
<a href="#l47.1178"></a><span id="l47.1178" class="difflineplus">+        &amp;newBody, followup_to, HEADER_FOLLOWUP_TO,</span>
<a href="#l47.1179"></a><span id="l47.1179" class="difflineplus">+        MimeGetNamedString(MIME_MHTML_FOLLOWUP_TO), mailcharset, htmlEdit);</span>
<a href="#l47.1180"></a><span id="l47.1180">   }</span>
<a href="#l47.1181"></a><span id="l47.1181">   // only show references for newsgroups</span>
<a href="#l47.1182"></a><span id="l47.1182" class="difflineminus">-  if (newsgroups &amp;&amp; references)</span>
<a href="#l47.1183"></a><span id="l47.1183" class="difflineminus">-  {</span>
<a href="#l47.1184"></a><span id="l47.1184" class="difflineminus">-    mime_intl_insert_message_header_1(&amp;newBody, references,</span>
<a href="#l47.1185"></a><span id="l47.1185" class="difflineminus">-                      HEADER_REFERENCES,</span>
<a href="#l47.1186"></a><span id="l47.1186" class="difflineminus">-                      MimeGetNamedString(MIME_MHTML_REFERENCES),</span>
<a href="#l47.1187"></a><span id="l47.1187" class="difflineminus">-                      mailcharset, htmlEdit);</span>
<a href="#l47.1188"></a><span id="l47.1188" class="difflineplus">+  if (newsgroups &amp;&amp; references) {</span>
<a href="#l47.1189"></a><span id="l47.1189" class="difflineplus">+    mime_intl_insert_message_header_1(&amp;newBody, references, HEADER_REFERENCES,</span>
<a href="#l47.1190"></a><span id="l47.1190" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_REFERENCES),</span>
<a href="#l47.1191"></a><span id="l47.1191" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1192"></a><span id="l47.1192">   }</span>
<a href="#l47.1193"></a><span id="l47.1193" class="difflineminus">-  if (htmlEdit)</span>
<a href="#l47.1194"></a><span id="l47.1194" class="difflineminus">-  {</span>
<a href="#l47.1195"></a><span id="l47.1195" class="difflineplus">+  if (htmlEdit) {</span>
<a href="#l47.1196"></a><span id="l47.1196">     NS_MsgSACat(&amp;newBody, &quot;&lt;/TABLE&gt;&quot;);</span>
<a href="#l47.1197"></a><span id="l47.1197">     NS_MsgSACat(&amp;newBody, MSG_LINEBREAK &quot;&lt;BR&gt;&lt;BR&gt;&quot;);</span>
<a href="#l47.1198"></a><span id="l47.1198">     if (html_tag)</span>
<a href="#l47.1199"></a><span id="l47.1199">       NS_MsgSACat(&amp;newBody, html_tag);</span>
<a href="#l47.1200"></a><span id="l47.1200">     else if (*body)</span>
<a href="#l47.1201"></a><span id="l47.1201" class="difflineminus">-        NS_MsgSACat(&amp;newBody, *body);</span>
<a href="#l47.1202"></a><span id="l47.1202" class="difflineminus">-  }</span>
<a href="#l47.1203"></a><span id="l47.1203" class="difflineminus">-  else</span>
<a href="#l47.1204"></a><span id="l47.1204" class="difflineminus">-  {</span>
<a href="#l47.1205"></a><span id="l47.1205" class="difflineplus">+      NS_MsgSACat(&amp;newBody, *body);</span>
<a href="#l47.1206"></a><span id="l47.1206" class="difflineplus">+  } else {</span>
<a href="#l47.1207"></a><span id="l47.1207">     NS_MsgSACat(&amp;newBody, MSG_LINEBREAK MSG_LINEBREAK);</span>
<a href="#l47.1208"></a><span id="l47.1208" class="difflineminus">-    if (*body)</span>
<a href="#l47.1209"></a><span id="l47.1209" class="difflineminus">-      NS_MsgSACat(&amp;newBody, *body);</span>
<a href="#l47.1210"></a><span id="l47.1210" class="difflineplus">+    if (*body) NS_MsgSACat(&amp;newBody, *body);</span>
<a href="#l47.1211"></a><span id="l47.1211">   }</span>
<a href="#l47.1212"></a><span id="l47.1212" class="difflineminus">-  if (newBody)</span>
<a href="#l47.1213"></a><span id="l47.1213" class="difflineminus">-  {</span>
<a href="#l47.1214"></a><span id="l47.1214" class="difflineplus">+  if (newBody) {</span>
<a href="#l47.1215"></a><span id="l47.1215">     PR_FREEIF(*body);</span>
<a href="#l47.1216"></a><span id="l47.1216">     *body = newBody;</span>
<a href="#l47.1217"></a><span id="l47.1217">   }</span>
<a href="#l47.1218"></a><span id="l47.1218">   PR_FREEIF(subject);</span>
<a href="#l47.1219"></a><span id="l47.1219">   PR_FREEIF(resent_comments);</span>
<a href="#l47.1220"></a><span id="l47.1220">   PR_FREEIF(resent_date);</span>
<a href="#l47.1221"></a><span id="l47.1221">   PR_FREEIF(date);</span>
<a href="#l47.1222"></a><span id="l47.1222">   PR_FREEIF(organization);</span>
<a href="#l47.1223"></a><span id="l47.1223">   PR_FREEIF(newsgroups);</span>
<a href="#l47.1224"></a><span id="l47.1224">   PR_FREEIF(followup_to);</span>
<a href="#l47.1225"></a><span id="l47.1225">   PR_FREEIF(references);</span>
<a href="#l47.1226"></a><span id="l47.1226"> }</span>
<a href="#l47.1227"></a><span id="l47.1227"> </span>
<a href="#l47.1228"></a><span id="l47.1228" class="difflineminus">-static void</span>
<a href="#l47.1229"></a><span id="l47.1229" class="difflineminus">-mime_insert_micro_headers(char            **body,</span>
<a href="#l47.1230"></a><span id="l47.1230" class="difflineminus">-                          MimeHeaders     *headers,</span>
<a href="#l47.1231"></a><span id="l47.1231" class="difflineminus">-                          MSG_ComposeFormat composeFormat,</span>
<a href="#l47.1232"></a><span id="l47.1232" class="difflineminus">-                          char            *mailcharset)</span>
<a href="#l47.1233"></a><span id="l47.1233" class="difflineminus">-{</span>
<a href="#l47.1234"></a><span id="l47.1234" class="difflineplus">+static void mime_insert_micro_headers(char **body, MimeHeaders *headers,</span>
<a href="#l47.1235"></a><span id="l47.1235" class="difflineplus">+                                      MSG_ComposeFormat composeFormat,</span>
<a href="#l47.1236"></a><span id="l47.1236" class="difflineplus">+                                      char *mailcharset) {</span>
<a href="#l47.1237"></a><span id="l47.1237">   char *newBody = NULL;</span>
<a href="#l47.1238"></a><span id="l47.1238">   char *subject = MimeHeaders_get(headers, HEADER_SUBJECT, false, false);</span>
<a href="#l47.1239"></a><span id="l47.1239">   nsCString from(MimeHeaders_get(headers, HEADER_FROM, false, true));</span>
<a href="#l47.1240"></a><span id="l47.1240" class="difflineminus">-  nsCString resent_from(MimeHeaders_get(headers, HEADER_RESENT_FROM, false, true));</span>
<a href="#l47.1241"></a><span id="l47.1241" class="difflineplus">+  nsCString resent_from(</span>
<a href="#l47.1242"></a><span id="l47.1242" class="difflineplus">+      MimeHeaders_get(headers, HEADER_RESENT_FROM, false, true));</span>
<a href="#l47.1243"></a><span id="l47.1243">   char *date = MimeHeaders_get(headers, HEADER_DATE, false, true);</span>
<a href="#l47.1244"></a><span id="l47.1244">   nsCString to(MimeHeaders_get(headers, HEADER_TO, false, true));</span>
<a href="#l47.1245"></a><span id="l47.1245">   nsCString cc(MimeHeaders_get(headers, HEADER_CC, false, true));</span>
<a href="#l47.1246"></a><span id="l47.1246" class="difflineminus">-  char *newsgroups = MimeHeaders_get(headers, HEADER_NEWSGROUPS, false,</span>
<a href="#l47.1247"></a><span id="l47.1247" class="difflineminus">-                     true);</span>
<a href="#l47.1248"></a><span id="l47.1248" class="difflineplus">+  char *newsgroups = MimeHeaders_get(headers, HEADER_NEWSGROUPS, false, true);</span>
<a href="#l47.1249"></a><span id="l47.1249">   const char *html_tag = nullptr;</span>
<a href="#l47.1250"></a><span id="l47.1250">   if (*body &amp;&amp; PL_strncasecmp(*body, &quot;&lt;HTML&quot;, 5) == 0)</span>
<a href="#l47.1251"></a><span id="l47.1251">     html_tag = PL_strchr(*body, '&gt;') + 1;</span>
<a href="#l47.1252"></a><span id="l47.1252">   bool htmlEdit = composeFormat == nsIMsgCompFormat::HTML;</span>
<a href="#l47.1253"></a><span id="l47.1253"> </span>
<a href="#l47.1254"></a><span id="l47.1254">   if (from.IsEmpty())</span>
<a href="#l47.1255"></a><span id="l47.1255">     from.Adopt(MimeHeaders_get(headers, HEADER_SENDER, false, true));</span>
<a href="#l47.1256"></a><span id="l47.1256">   if (resent_from.IsEmpty())</span>
<a href="#l47.1257"></a><span id="l47.1257" class="difflineminus">-    resent_from.Adopt(MimeHeaders_get(headers, HEADER_RESENT_SENDER, false, true));</span>
<a href="#l47.1258"></a><span id="l47.1258" class="difflineminus">-  if (!date)</span>
<a href="#l47.1259"></a><span id="l47.1259" class="difflineminus">-    date = MimeHeaders_get(headers, HEADER_RESENT_DATE, false, true);</span>
<a href="#l47.1260"></a><span id="l47.1260" class="difflineplus">+    resent_from.Adopt(</span>
<a href="#l47.1261"></a><span id="l47.1261" class="difflineplus">+        MimeHeaders_get(headers, HEADER_RESENT_SENDER, false, true));</span>
<a href="#l47.1262"></a><span id="l47.1262" class="difflineplus">+  if (!date) date = MimeHeaders_get(headers, HEADER_RESENT_DATE, false, true);</span>
<a href="#l47.1263"></a><span id="l47.1263"> </span>
<a href="#l47.1264"></a><span id="l47.1264">   UnquoteMimeAddress(resent_from, mailcharset);</span>
<a href="#l47.1265"></a><span id="l47.1265">   UnquoteMimeAddress(from, mailcharset);</span>
<a href="#l47.1266"></a><span id="l47.1266">   UnquoteMimeAddress(to, mailcharset);</span>
<a href="#l47.1267"></a><span id="l47.1267">   UnquoteMimeAddress(cc, mailcharset);</span>
<a href="#l47.1268"></a><span id="l47.1268"> </span>
<a href="#l47.1269"></a><span id="l47.1269">   nsCString replyHeader;</span>
<a href="#l47.1270"></a><span id="l47.1270">   MimeGetForwardHeaderDelimiter(replyHeader);</span>
<a href="#l47.1271"></a><span id="l47.1271" class="difflineminus">-  if (htmlEdit)</span>
<a href="#l47.1272"></a><span id="l47.1272" class="difflineminus">-  {</span>
<a href="#l47.1273"></a><span id="l47.1273" class="difflineplus">+  if (htmlEdit) {</span>
<a href="#l47.1274"></a><span id="l47.1274">     NS_MsgSACopy(&amp;(newBody), MIME_FORWARD_HTML_PREFIX);</span>
<a href="#l47.1275"></a><span id="l47.1275">     NS_MsgSACat(&amp;newBody, replyHeader.get());</span>
<a href="#l47.1276"></a><span id="l47.1276">     NS_MsgSACat(&amp;newBody, MIME_HEADER_TABLE);</span>
<a href="#l47.1277"></a><span id="l47.1277" class="difflineminus">-  }</span>
<a href="#l47.1278"></a><span id="l47.1278" class="difflineminus">-  else</span>
<a href="#l47.1279"></a><span id="l47.1279" class="difflineminus">-  {</span>
<a href="#l47.1280"></a><span id="l47.1280" class="difflineplus">+  } else {</span>
<a href="#l47.1281"></a><span id="l47.1281">     NS_MsgSACopy(&amp;(newBody), MSG_LINEBREAK MSG_LINEBREAK);</span>
<a href="#l47.1282"></a><span id="l47.1282">     NS_MsgSACat(&amp;newBody, replyHeader.get());</span>
<a href="#l47.1283"></a><span id="l47.1283">   }</span>
<a href="#l47.1284"></a><span id="l47.1284"> </span>
<a href="#l47.1285"></a><span id="l47.1285" class="difflineminus">-  if (!from.IsEmpty())</span>
<a href="#l47.1286"></a><span id="l47.1286" class="difflineminus">-  {</span>
<a href="#l47.1287"></a><span id="l47.1287" class="difflineplus">+  if (!from.IsEmpty()) {</span>
<a href="#l47.1288"></a><span id="l47.1288">     mime_intl_insert_message_header_1(&amp;newBody, from.get(), HEADER_FROM,</span>
<a href="#l47.1289"></a><span id="l47.1289" class="difflineminus">-                    MimeGetNamedString(MIME_MHTML_FROM),</span>
<a href="#l47.1290"></a><span id="l47.1290" class="difflineminus">-                    mailcharset, htmlEdit);</span>
<a href="#l47.1291"></a><span id="l47.1291" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_FROM),</span>
<a href="#l47.1292"></a><span id="l47.1292" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1293"></a><span id="l47.1293">   }</span>
<a href="#l47.1294"></a><span id="l47.1294">   if (subject)</span>
<a href="#l47.1295"></a><span id="l47.1295">     mime_intl_insert_message_header_1(&amp;newBody, subject, HEADER_SUBJECT,</span>
<a href="#l47.1296"></a><span id="l47.1296" class="difflineminus">-                    MimeGetNamedString(MIME_MHTML_SUBJECT),</span>
<a href="#l47.1297"></a><span id="l47.1297" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_SUBJECT),</span>
<a href="#l47.1298"></a><span id="l47.1298" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1299"></a><span id="l47.1299" class="difflineplus">+  /*</span>
<a href="#l47.1300"></a><span id="l47.1300" class="difflineplus">+    if (date)</span>
<a href="#l47.1301"></a><span id="l47.1301" class="difflineplus">+      mime_intl_insert_message_header_1(&amp;newBody, date, HEADER_DATE,</span>
<a href="#l47.1302"></a><span id="l47.1302" class="difflineplus">+                      MimeGetNamedString(MIME_MHTML_DATE),</span>
<a href="#l47.1303"></a><span id="l47.1303">                       mailcharset, htmlEdit);</span>
<a href="#l47.1304"></a><span id="l47.1304" class="difflineminus">-/*</span>
<a href="#l47.1305"></a><span id="l47.1305" class="difflineminus">-  if (date)</span>
<a href="#l47.1306"></a><span id="l47.1306" class="difflineminus">-    mime_intl_insert_message_header_1(&amp;newBody, date, HEADER_DATE,</span>
<a href="#l47.1307"></a><span id="l47.1307" class="difflineminus">-                    MimeGetNamedString(MIME_MHTML_DATE),</span>
<a href="#l47.1308"></a><span id="l47.1308" class="difflineminus">-                    mailcharset, htmlEdit);</span>
<a href="#l47.1309"></a><span id="l47.1309" class="difflineminus">-*/</span>
<a href="#l47.1310"></a><span id="l47.1310" class="difflineminus">-  if (!resent_from.IsEmpty())</span>
<a href="#l47.1311"></a><span id="l47.1311" class="difflineminus">-  {</span>
<a href="#l47.1312"></a><span id="l47.1312" class="difflineminus">-    mime_intl_insert_message_header_1(&amp;newBody, resent_from.get(),</span>
<a href="#l47.1313"></a><span id="l47.1313" class="difflineminus">-                    HEADER_RESENT_FROM,</span>
<a href="#l47.1314"></a><span id="l47.1314" class="difflineminus">-                    MimeGetNamedString(MIME_MHTML_RESENT_FROM),</span>
<a href="#l47.1315"></a><span id="l47.1315" class="difflineminus">-                    mailcharset, htmlEdit);</span>
<a href="#l47.1316"></a><span id="l47.1316" class="difflineplus">+  */</span>
<a href="#l47.1317"></a><span id="l47.1317" class="difflineplus">+  if (!resent_from.IsEmpty()) {</span>
<a href="#l47.1318"></a><span id="l47.1318" class="difflineplus">+    mime_intl_insert_message_header_1(</span>
<a href="#l47.1319"></a><span id="l47.1319" class="difflineplus">+        &amp;newBody, resent_from.get(), HEADER_RESENT_FROM,</span>
<a href="#l47.1320"></a><span id="l47.1320" class="difflineplus">+        MimeGetNamedString(MIME_MHTML_RESENT_FROM), mailcharset, htmlEdit);</span>
<a href="#l47.1321"></a><span id="l47.1321">   }</span>
<a href="#l47.1322"></a><span id="l47.1322" class="difflineminus">-  if (!to.IsEmpty())</span>
<a href="#l47.1323"></a><span id="l47.1323" class="difflineminus">-  {</span>
<a href="#l47.1324"></a><span id="l47.1324" class="difflineplus">+  if (!to.IsEmpty()) {</span>
<a href="#l47.1325"></a><span id="l47.1325">     mime_intl_insert_message_header_1(&amp;newBody, to.get(), HEADER_TO,</span>
<a href="#l47.1326"></a><span id="l47.1326" class="difflineminus">-                    MimeGetNamedString(MIME_MHTML_TO),</span>
<a href="#l47.1327"></a><span id="l47.1327" class="difflineminus">-                    mailcharset, htmlEdit);</span>
<a href="#l47.1328"></a><span id="l47.1328" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_TO),</span>
<a href="#l47.1329"></a><span id="l47.1329" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1330"></a><span id="l47.1330">   }</span>
<a href="#l47.1331"></a><span id="l47.1331" class="difflineminus">-  if (!cc.IsEmpty())</span>
<a href="#l47.1332"></a><span id="l47.1332" class="difflineminus">-  {</span>
<a href="#l47.1333"></a><span id="l47.1333" class="difflineplus">+  if (!cc.IsEmpty()) {</span>
<a href="#l47.1334"></a><span id="l47.1334">     mime_intl_insert_message_header_1(&amp;newBody, cc.get(), HEADER_CC,</span>
<a href="#l47.1335"></a><span id="l47.1335" class="difflineminus">-                    MimeGetNamedString(MIME_MHTML_CC),</span>
<a href="#l47.1336"></a><span id="l47.1336" class="difflineminus">-                    mailcharset, htmlEdit);</span>
<a href="#l47.1337"></a><span id="l47.1337" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_CC),</span>
<a href="#l47.1338"></a><span id="l47.1338" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1339"></a><span id="l47.1339">   }</span>
<a href="#l47.1340"></a><span id="l47.1340">   /*</span>
<a href="#l47.1341"></a><span id="l47.1341">     Do not reveal bcc recipients when forwarding a message!</span>
<a href="#l47.1342"></a><span id="l47.1342">     See http://bugzilla.mozilla.org/show_bug.cgi?id=41150</span>
<a href="#l47.1343"></a><span id="l47.1343">   */</span>
<a href="#l47.1344"></a><span id="l47.1344">   if (newsgroups)</span>
<a href="#l47.1345"></a><span id="l47.1345">     mime_intl_insert_message_header_1(&amp;newBody, newsgroups, HEADER_NEWSGROUPS,</span>
<a href="#l47.1346"></a><span id="l47.1346" class="difflineminus">-                    MimeGetNamedString(MIME_MHTML_NEWSGROUPS),</span>
<a href="#l47.1347"></a><span id="l47.1347" class="difflineminus">-                    mailcharset, htmlEdit);</span>
<a href="#l47.1348"></a><span id="l47.1348" class="difflineminus">-  if (htmlEdit)</span>
<a href="#l47.1349"></a><span id="l47.1349" class="difflineminus">-  {</span>
<a href="#l47.1350"></a><span id="l47.1350" class="difflineplus">+                                      MimeGetNamedString(MIME_MHTML_NEWSGROUPS),</span>
<a href="#l47.1351"></a><span id="l47.1351" class="difflineplus">+                                      mailcharset, htmlEdit);</span>
<a href="#l47.1352"></a><span id="l47.1352" class="difflineplus">+  if (htmlEdit) {</span>
<a href="#l47.1353"></a><span id="l47.1353">     NS_MsgSACat(&amp;newBody, &quot;&lt;/TABLE&gt;&quot;);</span>
<a href="#l47.1354"></a><span id="l47.1354">     NS_MsgSACat(&amp;newBody, MSG_LINEBREAK &quot;&lt;BR&gt;&lt;BR&gt;&quot;);</span>
<a href="#l47.1355"></a><span id="l47.1355">     if (html_tag)</span>
<a href="#l47.1356"></a><span id="l47.1356">       NS_MsgSACat(&amp;newBody, html_tag);</span>
<a href="#l47.1357"></a><span id="l47.1357">     else if (*body)</span>
<a href="#l47.1358"></a><span id="l47.1358" class="difflineminus">-        NS_MsgSACat(&amp;newBody, *body);</span>
<a href="#l47.1359"></a><span id="l47.1359" class="difflineminus">-  }</span>
<a href="#l47.1360"></a><span id="l47.1360" class="difflineminus">-  else</span>
<a href="#l47.1361"></a><span id="l47.1361" class="difflineminus">-  {</span>
<a href="#l47.1362"></a><span id="l47.1362" class="difflineplus">+      NS_MsgSACat(&amp;newBody, *body);</span>
<a href="#l47.1363"></a><span id="l47.1363" class="difflineplus">+  } else {</span>
<a href="#l47.1364"></a><span id="l47.1364">     NS_MsgSACat(&amp;newBody, MSG_LINEBREAK MSG_LINEBREAK);</span>
<a href="#l47.1365"></a><span id="l47.1365" class="difflineminus">-    if (*body)</span>
<a href="#l47.1366"></a><span id="l47.1366" class="difflineminus">-      NS_MsgSACat(&amp;newBody, *body);</span>
<a href="#l47.1367"></a><span id="l47.1367" class="difflineplus">+    if (*body) NS_MsgSACat(&amp;newBody, *body);</span>
<a href="#l47.1368"></a><span id="l47.1368">   }</span>
<a href="#l47.1369"></a><span id="l47.1369" class="difflineminus">-  if (newBody)</span>
<a href="#l47.1370"></a><span id="l47.1370" class="difflineminus">-  {</span>
<a href="#l47.1371"></a><span id="l47.1371" class="difflineplus">+  if (newBody) {</span>
<a href="#l47.1372"></a><span id="l47.1372">     PR_FREEIF(*body);</span>
<a href="#l47.1373"></a><span id="l47.1373">     *body = newBody;</span>
<a href="#l47.1374"></a><span id="l47.1374">   }</span>
<a href="#l47.1375"></a><span id="l47.1375">   PR_FREEIF(subject);</span>
<a href="#l47.1376"></a><span id="l47.1376">   PR_FREEIF(date);</span>
<a href="#l47.1377"></a><span id="l47.1377">   PR_FREEIF(newsgroups);</span>
<a href="#l47.1378"></a><span id="l47.1378" class="difflineminus">-</span>
<a href="#l47.1379"></a><span id="l47.1379"> }</span>
<a href="#l47.1380"></a><span id="l47.1380"> </span>
<a href="#l47.1381"></a><span id="l47.1381"> // body has to be encoded in UTF-8</span>
<a href="#l47.1382"></a><span id="l47.1382" class="difflineminus">-static void</span>
<a href="#l47.1383"></a><span id="l47.1383" class="difflineminus">-mime_insert_forwarded_message_headers(char            **body,</span>
<a href="#l47.1384"></a><span id="l47.1384" class="difflineminus">-                                      MimeHeaders     *headers,</span>
<a href="#l47.1385"></a><span id="l47.1385" class="difflineminus">-                                      MSG_ComposeFormat composeFormat,</span>
<a href="#l47.1386"></a><span id="l47.1386" class="difflineminus">-                                      char            *mailcharset)</span>
<a href="#l47.1387"></a><span id="l47.1387" class="difflineminus">-{</span>
<a href="#l47.1388"></a><span id="l47.1388" class="difflineminus">-  if (!body || !headers)</span>
<a href="#l47.1389"></a><span id="l47.1389" class="difflineminus">-    return;</span>
<a href="#l47.1390"></a><span id="l47.1390" class="difflineplus">+static void mime_insert_forwarded_message_headers(</span>
<a href="#l47.1391"></a><span id="l47.1391" class="difflineplus">+    char **body, MimeHeaders *headers, MSG_ComposeFormat composeFormat,</span>
<a href="#l47.1392"></a><span id="l47.1392" class="difflineplus">+    char *mailcharset) {</span>
<a href="#l47.1393"></a><span id="l47.1393" class="difflineplus">+  if (!body || !headers) return;</span>
<a href="#l47.1394"></a><span id="l47.1394"> </span>
<a href="#l47.1395"></a><span id="l47.1395" class="difflineminus">-  int32_t     show_headers = 0;</span>
<a href="#l47.1396"></a><span id="l47.1396" class="difflineminus">-  nsresult    res;</span>
<a href="#l47.1397"></a><span id="l47.1397" class="difflineplus">+  int32_t show_headers = 0;</span>
<a href="#l47.1398"></a><span id="l47.1398" class="difflineplus">+  nsresult res;</span>
<a href="#l47.1399"></a><span id="l47.1399"> </span>
<a href="#l47.1400"></a><span id="l47.1400" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;res));</span>
<a href="#l47.1401"></a><span id="l47.1401" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l47.1402"></a><span id="l47.1402" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;res));</span>
<a href="#l47.1403"></a><span id="l47.1403">   if (NS_SUCCEEDED(res))</span>
<a href="#l47.1404"></a><span id="l47.1404">     prefBranch-&gt;GetIntPref(&quot;mail.show_headers&quot;, &amp;show_headers);</span>
<a href="#l47.1405"></a><span id="l47.1405"> </span>
<a href="#l47.1406"></a><span id="l47.1406" class="difflineminus">-  switch (show_headers)</span>
<a href="#l47.1407"></a><span id="l47.1407" class="difflineminus">-  {</span>
<a href="#l47.1408"></a><span id="l47.1408" class="difflineminus">-  case 0:</span>
<a href="#l47.1409"></a><span id="l47.1409" class="difflineminus">-    mime_insert_micro_headers(body, headers, composeFormat, mailcharset);</span>
<a href="#l47.1410"></a><span id="l47.1410" class="difflineminus">-    break;</span>
<a href="#l47.1411"></a><span id="l47.1411" class="difflineminus">-  default:</span>
<a href="#l47.1412"></a><span id="l47.1412" class="difflineminus">-  case 1:</span>
<a href="#l47.1413"></a><span id="l47.1413" class="difflineminus">-    mime_insert_normal_headers(body, headers, composeFormat, mailcharset);</span>
<a href="#l47.1414"></a><span id="l47.1414" class="difflineminus">-    break;</span>
<a href="#l47.1415"></a><span id="l47.1415" class="difflineminus">-  case 2:</span>
<a href="#l47.1416"></a><span id="l47.1416" class="difflineminus">-    mime_insert_all_headers(body, headers, composeFormat, mailcharset);</span>
<a href="#l47.1417"></a><span id="l47.1417" class="difflineminus">-    break;</span>
<a href="#l47.1418"></a><span id="l47.1418" class="difflineplus">+  switch (show_headers) {</span>
<a href="#l47.1419"></a><span id="l47.1419" class="difflineplus">+    case 0:</span>
<a href="#l47.1420"></a><span id="l47.1420" class="difflineplus">+      mime_insert_micro_headers(body, headers, composeFormat, mailcharset);</span>
<a href="#l47.1421"></a><span id="l47.1421" class="difflineplus">+      break;</span>
<a href="#l47.1422"></a><span id="l47.1422" class="difflineplus">+    default:</span>
<a href="#l47.1423"></a><span id="l47.1423" class="difflineplus">+    case 1:</span>
<a href="#l47.1424"></a><span id="l47.1424" class="difflineplus">+      mime_insert_normal_headers(body, headers, composeFormat, mailcharset);</span>
<a href="#l47.1425"></a><span id="l47.1425" class="difflineplus">+      break;</span>
<a href="#l47.1426"></a><span id="l47.1426" class="difflineplus">+    case 2:</span>
<a href="#l47.1427"></a><span id="l47.1427" class="difflineplus">+      mime_insert_all_headers(body, headers, composeFormat, mailcharset);</span>
<a href="#l47.1428"></a><span id="l47.1428" class="difflineplus">+      break;</span>
<a href="#l47.1429"></a><span id="l47.1429">   }</span>
<a href="#l47.1430"></a><span id="l47.1430"> }</span>
<a href="#l47.1431"></a><span id="l47.1431"> </span>
<a href="#l47.1432"></a><span id="l47.1432" class="difflineminus">-static void</span>
<a href="#l47.1433"></a><span id="l47.1433" class="difflineminus">-convert_plaintext_body_to_html(char **body)</span>
<a href="#l47.1434"></a><span id="l47.1434" class="difflineminus">-{</span>
<a href="#l47.1435"></a><span id="l47.1435" class="difflineminus">-  // We need to convert the plain/text to HTML in order to escape any HTML markup.</span>
<a href="#l47.1436"></a><span id="l47.1436" class="difflineplus">+static void convert_plaintext_body_to_html(char **body) {</span>
<a href="#l47.1437"></a><span id="l47.1437" class="difflineplus">+  // We need to convert the plain/text to HTML in order to escape any HTML</span>
<a href="#l47.1438"></a><span id="l47.1438" class="difflineplus">+  // markup.</span>
<a href="#l47.1439"></a><span id="l47.1439">   nsCString escapedBody;</span>
<a href="#l47.1440"></a><span id="l47.1440">   nsAppendEscapedHTML(nsDependentCString(*body), escapedBody);</span>
<a href="#l47.1441"></a><span id="l47.1441"> </span>
<a href="#l47.1442"></a><span id="l47.1442">   nsCString newBody;</span>
<a href="#l47.1443"></a><span id="l47.1443">   char *q = escapedBody.BeginWriting();</span>
<a href="#l47.1444"></a><span id="l47.1444">   char *p;</span>
<a href="#l47.1445"></a><span id="l47.1445">   int prevQuoteLevel = 0;</span>
<a href="#l47.1446"></a><span id="l47.1446">   bool isFlowed = false;</span>
<a href="#l47.1447"></a><span id="l47.1447">   bool haveSig = false;</span>
<a href="#l47.1448"></a><span id="l47.1448"> </span>
<a href="#l47.1449"></a><span id="l47.1449">   // First detect whether this appears to be flowed or not.</span>
<a href="#l47.1450"></a><span id="l47.1450">   p = q;</span>
<a href="#l47.1451"></a><span id="l47.1451">   while (*p) {</span>
<a href="#l47.1452"></a><span id="l47.1452">     // At worst we read the null byte terminator.</span>
<a href="#l47.1453"></a><span id="l47.1453" class="difflineminus">-    if (*p == ' ' &amp;&amp; (*(p+1) == '\r' || *(p+1) == '\n')) {</span>
<a href="#l47.1454"></a><span id="l47.1454" class="difflineplus">+    if (*p == ' ' &amp;&amp; (*(p + 1) == '\r' || *(p + 1) == '\n')) {</span>
<a href="#l47.1455"></a><span id="l47.1455">       // This looks flowed, but don't get fooled by a signature separator:</span>
<a href="#l47.1456"></a><span id="l47.1456">       // --space</span>
<a href="#l47.1457"></a><span id="l47.1457" class="difflineminus">-      if (p-3 &gt;= q &amp;&amp; (*(p-3) == '\r' || *(p-3) == '\n') &amp;&amp;</span>
<a href="#l47.1458"></a><span id="l47.1458" class="difflineminus">-          *(p-2) == '-' &amp;&amp; *(p-1) == '-') {</span>
<a href="#l47.1459"></a><span id="l47.1459" class="difflineplus">+      if (p - 3 &gt;= q &amp;&amp; (*(p - 3) == '\r' || *(p - 3) == '\n') &amp;&amp;</span>
<a href="#l47.1460"></a><span id="l47.1460" class="difflineplus">+          *(p - 2) == '-' &amp;&amp; *(p - 1) == '-') {</span>
<a href="#l47.1461"></a><span id="l47.1461">         p++;</span>
<a href="#l47.1462"></a><span id="l47.1462">         continue;</span>
<a href="#l47.1463"></a><span id="l47.1463">       }</span>
<a href="#l47.1464"></a><span id="l47.1464" class="difflineminus">-      if (p-2 == q &amp;&amp;</span>
<a href="#l47.1465"></a><span id="l47.1465" class="difflineminus">-          *(p-2) == '-' &amp;&amp; *(p-1) == '-') {</span>
<a href="#l47.1466"></a><span id="l47.1466" class="difflineplus">+      if (p - 2 == q &amp;&amp; *(p - 2) == '-' &amp;&amp; *(p - 1) == '-') {</span>
<a href="#l47.1467"></a><span id="l47.1467">         p++;</span>
<a href="#l47.1468"></a><span id="l47.1468">         continue;</span>
<a href="#l47.1469"></a><span id="l47.1469">       }</span>
<a href="#l47.1470"></a><span id="l47.1470">       isFlowed = true;</span>
<a href="#l47.1471"></a><span id="l47.1471">       break;</span>
<a href="#l47.1472"></a><span id="l47.1472">     }</span>
<a href="#l47.1473"></a><span id="l47.1473">     p++;</span>
<a href="#l47.1474"></a><span id="l47.1474">   }</span>
<a href="#l47.1475"></a><span id="l47.1475"> </span>
<a href="#l47.1476"></a><span id="l47.1476">   while (*q) {</span>
<a href="#l47.1477"></a><span id="l47.1477">     p = q;</span>
<a href="#l47.1478"></a><span id="l47.1478">     // Detect quotes. A quote character is a &quot;&gt;&quot; which was escaped to &amp;gt;.</span>
<a href="#l47.1479"></a><span id="l47.1479" class="difflineminus">-    // In non-flowed messages the quote character can be optionally followed by a space.</span>
<a href="#l47.1480"></a><span id="l47.1480" class="difflineminus">-    // Examples:</span>
<a href="#l47.1481"></a><span id="l47.1481" class="difflineminus">-    // Level 0</span>
<a href="#l47.1482"></a><span id="l47.1482" class="difflineplus">+    // In non-flowed messages the quote character can be optionally followed by</span>
<a href="#l47.1483"></a><span id="l47.1483" class="difflineplus">+    // a space. Examples: Level 0</span>
<a href="#l47.1484"></a><span id="l47.1484">     //  &gt; Level 0 (with leading space)</span>
<a href="#l47.1485"></a><span id="l47.1485">     // &gt; Level 1</span>
<a href="#l47.1486"></a><span id="l47.1486" class="difflineminus">-    // &gt;  &gt; Level 1 (with leading space, note the two spaces between the quote characters)</span>
<a href="#l47.1487"></a><span id="l47.1487" class="difflineplus">+    // &gt;  &gt; Level 1 (with leading space, note the two spaces between the quote</span>
<a href="#l47.1488"></a><span id="l47.1488" class="difflineplus">+    // characters)</span>
<a href="#l47.1489"></a><span id="l47.1489">     // &gt;&gt; Level 2</span>
<a href="#l47.1490"></a><span id="l47.1490">     // &gt; &gt; Level 2 (only when non-flowed, otherwise Level 1 with leading space)</span>
<a href="#l47.1491"></a><span id="l47.1491">     // &gt;&gt;&gt; Level 3</span>
<a href="#l47.1492"></a><span id="l47.1492" class="difflineminus">-    // &gt; &gt; &gt;  Level 3 (with leading space, only when non-flowed, otherwise Level 1)</span>
<a href="#l47.1493"></a><span id="l47.1493" class="difflineplus">+    // &gt; &gt; &gt;  Level 3 (with leading space, only when non-flowed, otherwise Level</span>
<a href="#l47.1494"></a><span id="l47.1494" class="difflineplus">+    // 1)</span>
<a href="#l47.1495"></a><span id="l47.1495">     int quoteLevel = 0;</span>
<a href="#l47.1496"></a><span id="l47.1496">     while (strncmp(p, &quot;&amp;gt;&quot;, 4) == 0) {</span>
<a href="#l47.1497"></a><span id="l47.1497">       p += 4;</span>
<a href="#l47.1498"></a><span id="l47.1498" class="difflineminus">-      if (!isFlowed &amp;&amp; *p == ' ')</span>
<a href="#l47.1499"></a><span id="l47.1499" class="difflineminus">-        p++;</span>
<a href="#l47.1500"></a><span id="l47.1500" class="difflineplus">+      if (!isFlowed &amp;&amp; *p == ' ') p++;</span>
<a href="#l47.1501"></a><span id="l47.1501">       quoteLevel++;</span>
<a href="#l47.1502"></a><span id="l47.1502">     }</span>
<a href="#l47.1503"></a><span id="l47.1503"> </span>
<a href="#l47.1504"></a><span id="l47.1504">     // Eat space following quote character, for non-flowed already eaten above.</span>
<a href="#l47.1505"></a><span id="l47.1505" class="difflineminus">-    if (quoteLevel &gt; 0 &amp;&amp; isFlowed &amp;&amp; *p == ' ')</span>
<a href="#l47.1506"></a><span id="l47.1506" class="difflineminus">-      p++;</span>
<a href="#l47.1507"></a><span id="l47.1507" class="difflineplus">+    if (quoteLevel &gt; 0 &amp;&amp; isFlowed &amp;&amp; *p == ' ') p++;</span>
<a href="#l47.1508"></a><span id="l47.1508"> </span>
<a href="#l47.1509"></a><span id="l47.1509" class="difflineminus">-    // Close any open signatures if we find a quote. Strange, that shouldn't happen.</span>
<a href="#l47.1510"></a><span id="l47.1510" class="difflineplus">+    // Close any open signatures if we find a quote. Strange, that shouldn't</span>
<a href="#l47.1511"></a><span id="l47.1511" class="difflineplus">+    // happen.</span>
<a href="#l47.1512"></a><span id="l47.1512">     if (quoteLevel &gt; 0 &amp;&amp; haveSig) {</span>
<a href="#l47.1513"></a><span id="l47.1513">       newBody.AppendLiteral(&quot;&lt;/pre&gt;&quot;);</span>
<a href="#l47.1514"></a><span id="l47.1514">       haveSig = false;</span>
<a href="#l47.1515"></a><span id="l47.1515">     }</span>
<a href="#l47.1516"></a><span id="l47.1516">     if (quoteLevel &gt; prevQuoteLevel) {</span>
<a href="#l47.1517"></a><span id="l47.1517">       while (prevQuoteLevel &lt; quoteLevel) {</span>
<a href="#l47.1518"></a><span id="l47.1518">         if (isFlowed)</span>
<a href="#l47.1519"></a><span id="l47.1519">           newBody.AppendLiteral(&quot;&lt;blockquote type=\&quot;cite\&quot;&gt;&quot;);</span>
<a href="#l47.1520"></a><span id="l47.1520">         else</span>
<a href="#l47.1521"></a><span id="l47.1521" class="difflineminus">-          newBody.AppendLiteral(&quot;&lt;blockquote type=\&quot;cite\&quot;&gt;&lt;pre wrap class=\&quot;moz-quote-pre\&quot;&gt;&quot;);</span>
<a href="#l47.1522"></a><span id="l47.1522" class="difflineplus">+          newBody.AppendLiteral(</span>
<a href="#l47.1523"></a><span id="l47.1523" class="difflineplus">+              &quot;&lt;blockquote type=\&quot;cite\&quot;&gt;&lt;pre wrap class=\&quot;moz-quote-pre\&quot;&gt;&quot;);</span>
<a href="#l47.1524"></a><span id="l47.1524">         prevQuoteLevel++;</span>
<a href="#l47.1525"></a><span id="l47.1525">       }</span>
<a href="#l47.1526"></a><span id="l47.1526">     } else if (quoteLevel &lt; prevQuoteLevel) {</span>
<a href="#l47.1527"></a><span id="l47.1527">       while (prevQuoteLevel &gt; quoteLevel) {</span>
<a href="#l47.1528"></a><span id="l47.1528">         if (isFlowed)</span>
<a href="#l47.1529"></a><span id="l47.1529">           newBody.AppendLiteral(&quot;&lt;/blockquote&gt;&quot;);</span>
<a href="#l47.1530"></a><span id="l47.1530">         else</span>
<a href="#l47.1531"></a><span id="l47.1531">           newBody.AppendLiteral(&quot;&lt;/pre&gt;&lt;/blockquote&gt;&quot;);</span>
<a href="#l47.1532"></a><span id="l47.1532" class="difflineat">@@ -1205,25 +1079,25 @@ convert_plaintext_body_to_html(char **bo</span>
<a href="#l47.1533"></a><span id="l47.1533">     if (!*p) {</span>
<a href="#l47.1534"></a><span id="l47.1534">       // We're at the end of the string.</span>
<a href="#l47.1535"></a><span id="l47.1535">       if (p &gt; q) {</span>
<a href="#l47.1536"></a><span id="l47.1536">         // Copy last bit over.</span>
<a href="#l47.1537"></a><span id="l47.1537">         newBody.Append(q);</span>
<a href="#l47.1538"></a><span id="l47.1538">       }</span>
<a href="#l47.1539"></a><span id="l47.1539">       break;</span>
<a href="#l47.1540"></a><span id="l47.1540">     }</span>
<a href="#l47.1541"></a><span id="l47.1541" class="difflineminus">-    if (*p == '\r' &amp;&amp; *(p+1) == '\n') { // At worst we read the null byte terminator.</span>
<a href="#l47.1542"></a><span id="l47.1542" class="difflineplus">+    if (*p == '\r' &amp;&amp;</span>
<a href="#l47.1543"></a><span id="l47.1543" class="difflineplus">+        *(p + 1) == '\n') {  // At worst we read the null byte terminator.</span>
<a href="#l47.1544"></a><span id="l47.1544">       // Skip the CR in CRLF.</span>
<a href="#l47.1545"></a><span id="l47.1545" class="difflineminus">-      *p = 0; // don't copy skipped \r.</span>
<a href="#l47.1546"></a><span id="l47.1546" class="difflineplus">+      *p = 0;  // don't copy skipped \r.</span>
<a href="#l47.1547"></a><span id="l47.1547">       p++;</span>
<a href="#l47.1548"></a><span id="l47.1548">     }</span>
<a href="#l47.1549"></a><span id="l47.1549">     *p = 0;</span>
<a href="#l47.1550"></a><span id="l47.1550">     newBody.Append(q);</span>
<a href="#l47.1551"></a><span id="l47.1551" class="difflineminus">-    if (!isFlowed || !seenSpace || forceBR)</span>
<a href="#l47.1552"></a><span id="l47.1552" class="difflineminus">-      newBody.AppendLiteral(&quot;&lt;br&gt;&quot;);</span>
<a href="#l47.1553"></a><span id="l47.1553" class="difflineplus">+    if (!isFlowed || !seenSpace || forceBR) newBody.AppendLiteral(&quot;&lt;br&gt;&quot;);</span>
<a href="#l47.1554"></a><span id="l47.1554">     q = p + 1;</span>
<a href="#l47.1555"></a><span id="l47.1555">   }</span>
<a href="#l47.1556"></a><span id="l47.1556"> </span>
<a href="#l47.1557"></a><span id="l47.1557">   // Close all open quotes.</span>
<a href="#l47.1558"></a><span id="l47.1558">   while (prevQuoteLevel &gt; 0) {</span>
<a href="#l47.1559"></a><span id="l47.1559">     if (isFlowed)</span>
<a href="#l47.1560"></a><span id="l47.1560">       newBody.AppendLiteral(&quot;&lt;/blockquote&gt;&quot;);</span>
<a href="#l47.1561"></a><span id="l47.1561">     else</span>
<a href="#l47.1562"></a><span id="l47.1562" class="difflineat">@@ -1236,19 +1110,17 @@ convert_plaintext_body_to_html(char **bo</span>
<a href="#l47.1563"></a><span id="l47.1563">     newBody.AppendLiteral(&quot;&lt;/pre&gt;&quot;);</span>
<a href="#l47.1564"></a><span id="l47.1564">     haveSig = false;</span>
<a href="#l47.1565"></a><span id="l47.1565">   }</span>
<a href="#l47.1566"></a><span id="l47.1566"> </span>
<a href="#l47.1567"></a><span id="l47.1567">   PR_Free(*body);</span>
<a href="#l47.1568"></a><span id="l47.1568">   *body = ToNewCString(newBody);</span>
<a href="#l47.1569"></a><span id="l47.1569"> }</span>
<a href="#l47.1570"></a><span id="l47.1570"> </span>
<a href="#l47.1571"></a><span id="l47.1571" class="difflineminus">-static void</span>
<a href="#l47.1572"></a><span id="l47.1572" class="difflineminus">-mime_parse_stream_complete(nsMIMESession *stream)</span>
<a href="#l47.1573"></a><span id="l47.1573" class="difflineminus">-{</span>
<a href="#l47.1574"></a><span id="l47.1574" class="difflineplus">+static void mime_parse_stream_complete(nsMIMESession *stream) {</span>
<a href="#l47.1575"></a><span id="l47.1575">   mime_draft_data *mdd = (mime_draft_data *)stream-&gt;data_object;</span>
<a href="#l47.1576"></a><span id="l47.1576">   nsCOMPtr&lt;nsIMsgCompFields&gt; fields;</span>
<a href="#l47.1577"></a><span id="l47.1577">   int htmlAction = 0;</span>
<a href="#l47.1578"></a><span id="l47.1578">   int lineWidth = 0;</span>
<a href="#l47.1579"></a><span id="l47.1579"> </span>
<a href="#l47.1580"></a><span id="l47.1580">   char *host = 0;</span>
<a href="#l47.1581"></a><span id="l47.1581">   char *news_host = 0;</span>
<a href="#l47.1582"></a><span id="l47.1582">   char *to_and_cc = 0;</span>
<a href="#l47.1583"></a><span id="l47.1583" class="difflineat">@@ -1274,512 +1146,466 @@ mime_parse_stream_complete(nsMIMESession</span>
<a href="#l47.1584"></a><span id="l47.1584">   bool forward_inline = false;</span>
<a href="#l47.1585"></a><span id="l47.1585">   bool bodyAsAttachment = false;</span>
<a href="#l47.1586"></a><span id="l47.1586">   bool charsetOverride = false;</span>
<a href="#l47.1587"></a><span id="l47.1587"> </span>
<a href="#l47.1588"></a><span id="l47.1588">   NS_ASSERTION(mdd, &quot;null mime draft data&quot;);</span>
<a href="#l47.1589"></a><span id="l47.1589"> </span>
<a href="#l47.1590"></a><span id="l47.1590">   if (!mdd) return;</span>
<a href="#l47.1591"></a><span id="l47.1591"> </span>
<a href="#l47.1592"></a><span id="l47.1592" class="difflineminus">-  if (mdd-&gt;obj)</span>
<a href="#l47.1593"></a><span id="l47.1593" class="difflineminus">-  {</span>
<a href="#l47.1594"></a><span id="l47.1594" class="difflineplus">+  if (mdd-&gt;obj) {</span>
<a href="#l47.1595"></a><span id="l47.1595">     int status;</span>
<a href="#l47.1596"></a><span id="l47.1596"> </span>
<a href="#l47.1597"></a><span id="l47.1597">     status = mdd-&gt;obj-&gt;clazz-&gt;parse_eof(mdd-&gt;obj, false);</span>
<a href="#l47.1598"></a><span id="l47.1598">     mdd-&gt;obj-&gt;clazz-&gt;parse_end(mdd-&gt;obj, status &lt; 0 ? true : false);</span>
<a href="#l47.1599"></a><span id="l47.1599"> </span>
<a href="#l47.1600"></a><span id="l47.1600">     // RICHIE</span>
<a href="#l47.1601"></a><span id="l47.1601">     // We need to figure out how to pass the forwarded flag along with this</span>
<a href="#l47.1602"></a><span id="l47.1602">     // operation.</span>
<a href="#l47.1603"></a><span id="l47.1603"> </span>
<a href="#l47.1604"></a><span id="l47.1604" class="difflineminus">-    //forward_inline = (mdd-&gt;format_out != FO_CMDLINE_ATTACHMENTS);</span>
<a href="#l47.1605"></a><span id="l47.1605" class="difflineplus">+    // forward_inline = (mdd-&gt;format_out != FO_CMDLINE_ATTACHMENTS);</span>
<a href="#l47.1606"></a><span id="l47.1606">     forward_inline = mdd-&gt;forwardInline;</span>
<a href="#l47.1607"></a><span id="l47.1607"> </span>
<a href="#l47.1608"></a><span id="l47.1608" class="difflineminus">-    NS_ASSERTION(mdd-&gt;options == mdd-&gt;obj-&gt;options, &quot;mime draft options not same as obj-&gt;options&quot;);</span>
<a href="#l47.1609"></a><span id="l47.1609" class="difflineplus">+    NS_ASSERTION(mdd-&gt;options == mdd-&gt;obj-&gt;options,</span>
<a href="#l47.1610"></a><span id="l47.1610" class="difflineplus">+                 &quot;mime draft options not same as obj-&gt;options&quot;);</span>
<a href="#l47.1611"></a><span id="l47.1611">     mime_free(mdd-&gt;obj);</span>
<a href="#l47.1612"></a><span id="l47.1612">     mdd-&gt;obj = 0;</span>
<a href="#l47.1613"></a><span id="l47.1613" class="difflineminus">-    if (mdd-&gt;options)</span>
<a href="#l47.1614"></a><span id="l47.1614" class="difflineminus">-    {</span>
<a href="#l47.1615"></a><span id="l47.1615" class="difflineplus">+    if (mdd-&gt;options) {</span>
<a href="#l47.1616"></a><span id="l47.1616">       // save the override flag before it's unavailable</span>
<a href="#l47.1617"></a><span id="l47.1617">       charsetOverride = mdd-&gt;options-&gt;override_charset;</span>
<a href="#l47.1618"></a><span id="l47.1618" class="difflineminus">-      if ((!mdd-&gt;mailcharset || charsetOverride) &amp;&amp; mdd-&gt;options-&gt;default_charset)</span>
<a href="#l47.1619"></a><span id="l47.1619" class="difflineminus">-      {</span>
<a href="#l47.1620"></a><span id="l47.1620" class="difflineplus">+      if ((!mdd-&gt;mailcharset || charsetOverride) &amp;&amp;</span>
<a href="#l47.1621"></a><span id="l47.1621" class="difflineplus">+          mdd-&gt;options-&gt;default_charset) {</span>
<a href="#l47.1622"></a><span id="l47.1622">         PR_Free(mdd-&gt;mailcharset);</span>
<a href="#l47.1623"></a><span id="l47.1623">         mdd-&gt;mailcharset = strdup(mdd-&gt;options-&gt;default_charset);</span>
<a href="#l47.1624"></a><span id="l47.1624">       }</span>
<a href="#l47.1625"></a><span id="l47.1625"> </span>
<a href="#l47.1626"></a><span id="l47.1626" class="difflineminus">-      // mscott: aren't we leaking a bunch of strings here like the charset strings and such?</span>
<a href="#l47.1627"></a><span id="l47.1627" class="difflineplus">+      // mscott: aren't we leaking a bunch of strings here like the charset</span>
<a href="#l47.1628"></a><span id="l47.1628" class="difflineplus">+      // strings and such?</span>
<a href="#l47.1629"></a><span id="l47.1629">       delete mdd-&gt;options;</span>
<a href="#l47.1630"></a><span id="l47.1630">       mdd-&gt;options = 0;</span>
<a href="#l47.1631"></a><span id="l47.1631">     }</span>
<a href="#l47.1632"></a><span id="l47.1632" class="difflineminus">-    if (mdd-&gt;stream)</span>
<a href="#l47.1633"></a><span id="l47.1633" class="difflineminus">-    {</span>
<a href="#l47.1634"></a><span id="l47.1634" class="difflineplus">+    if (mdd-&gt;stream) {</span>
<a href="#l47.1635"></a><span id="l47.1635">       mdd-&gt;stream-&gt;complete((nsMIMESession *)mdd-&gt;stream-&gt;data_object);</span>
<a href="#l47.1636"></a><span id="l47.1636">       PR_Free(mdd-&gt;stream);</span>
<a href="#l47.1637"></a><span id="l47.1637">       mdd-&gt;stream = 0;</span>
<a href="#l47.1638"></a><span id="l47.1638">     }</span>
<a href="#l47.1639"></a><span id="l47.1639">   }</span>
<a href="#l47.1640"></a><span id="l47.1640"> </span>
<a href="#l47.1641"></a><span id="l47.1641">   //</span>
<a href="#l47.1642"></a><span id="l47.1642">   // Now, process the attachments that we have gathered from the message</span>
<a href="#l47.1643"></a><span id="l47.1643">   // on disk</span>
<a href="#l47.1644"></a><span id="l47.1644">   //</span>
<a href="#l47.1645"></a><span id="l47.1645">   nsMsgAttachmentData *newAttachData = mime_draft_process_attachments(mdd);</span>
<a href="#l47.1646"></a><span id="l47.1646"> </span>
<a href="#l47.1647"></a><span id="l47.1647">   //</span>
<a href="#l47.1648"></a><span id="l47.1648">   // time to bring up the compose windows with all the info gathered</span>
<a href="#l47.1649"></a><span id="l47.1649">   //</span>
<a href="#l47.1650"></a><span id="l47.1650" class="difflineminus">-  if (mdd-&gt;headers)</span>
<a href="#l47.1651"></a><span id="l47.1651" class="difflineminus">-  {</span>
<a href="#l47.1652"></a><span id="l47.1652" class="difflineminus">-    subj = MimeHeaders_get(mdd-&gt;headers, HEADER_SUBJECT,  false, false);</span>
<a href="#l47.1653"></a><span id="l47.1653" class="difflineminus">-    if (forward_inline)</span>
<a href="#l47.1654"></a><span id="l47.1654" class="difflineminus">-    {</span>
<a href="#l47.1655"></a><span id="l47.1655" class="difflineminus">-      if (subj)</span>
<a href="#l47.1656"></a><span id="l47.1656" class="difflineminus">-      {</span>
<a href="#l47.1657"></a><span id="l47.1657" class="difflineplus">+  if (mdd-&gt;headers) {</span>
<a href="#l47.1658"></a><span id="l47.1658" class="difflineplus">+    subj = MimeHeaders_get(mdd-&gt;headers, HEADER_SUBJECT, false, false);</span>
<a href="#l47.1659"></a><span id="l47.1659" class="difflineplus">+    if (forward_inline) {</span>
<a href="#l47.1660"></a><span id="l47.1660" class="difflineplus">+      if (subj) {</span>
<a href="#l47.1661"></a><span id="l47.1661">         nsresult rv;</span>
<a href="#l47.1662"></a><span id="l47.1662" class="difflineminus">-        nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l47.1663"></a><span id="l47.1663" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l47.1664"></a><span id="l47.1664" class="difflineminus">-        {</span>
<a href="#l47.1665"></a><span id="l47.1665" class="difflineplus">+        nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l47.1666"></a><span id="l47.1666" class="difflineplus">+            do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l47.1667"></a><span id="l47.1667" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l47.1668"></a><span id="l47.1668">           nsAutoCString fwdPrefix;</span>
<a href="#l47.1669"></a><span id="l47.1669">           prefBranch-&gt;GetCharPref(&quot;mail.forward_subject_prefix&quot;, fwdPrefix);</span>
<a href="#l47.1670"></a><span id="l47.1670" class="difflineminus">-          char *newSubj = PR_smprintf(&quot;%s: %s&quot;, !fwdPrefix.IsEmpty() ?</span>
<a href="#l47.1671"></a><span id="l47.1671" class="difflineminus">-                                                fwdPrefix.get(): &quot;Fwd&quot;, subj);</span>
<a href="#l47.1672"></a><span id="l47.1672" class="difflineminus">-          if (newSubj)</span>
<a href="#l47.1673"></a><span id="l47.1673" class="difflineminus">-          {</span>
<a href="#l47.1674"></a><span id="l47.1674" class="difflineplus">+          char *newSubj = PR_smprintf(</span>
<a href="#l47.1675"></a><span id="l47.1675" class="difflineplus">+              &quot;%s: %s&quot;, !fwdPrefix.IsEmpty() ? fwdPrefix.get() : &quot;Fwd&quot;, subj);</span>
<a href="#l47.1676"></a><span id="l47.1676" class="difflineplus">+          if (newSubj) {</span>
<a href="#l47.1677"></a><span id="l47.1677">             PR_Free(subj);</span>
<a href="#l47.1678"></a><span id="l47.1678">             subj = newSubj;</span>
<a href="#l47.1679"></a><span id="l47.1679">           }</span>
<a href="#l47.1680"></a><span id="l47.1680">         }</span>
<a href="#l47.1681"></a><span id="l47.1681">       }</span>
<a href="#l47.1682"></a><span id="l47.1682" class="difflineminus">-    }</span>
<a href="#l47.1683"></a><span id="l47.1683" class="difflineminus">-    else</span>
<a href="#l47.1684"></a><span id="l47.1684" class="difflineminus">-    {</span>
<a href="#l47.1685"></a><span id="l47.1685" class="difflineminus">-      from = MimeHeaders_get(mdd-&gt;headers, HEADER_FROM,     false, false);</span>
<a href="#l47.1686"></a><span id="l47.1686" class="difflineplus">+    } else {</span>
<a href="#l47.1687"></a><span id="l47.1687" class="difflineplus">+      from = MimeHeaders_get(mdd-&gt;headers, HEADER_FROM, false, false);</span>
<a href="#l47.1688"></a><span id="l47.1688">       repl = MimeHeaders_get(mdd-&gt;headers, HEADER_REPLY_TO, false, false);</span>
<a href="#l47.1689"></a><span id="l47.1689" class="difflineminus">-      to   = MimeHeaders_get(mdd-&gt;headers, HEADER_TO,       false, true);</span>
<a href="#l47.1690"></a><span id="l47.1690" class="difflineminus">-      cc   = MimeHeaders_get(mdd-&gt;headers, HEADER_CC,       false, true);</span>
<a href="#l47.1691"></a><span id="l47.1691" class="difflineminus">-      bcc   = MimeHeaders_get(mdd-&gt;headers, HEADER_BCC,       false, true);</span>
<a href="#l47.1692"></a><span id="l47.1692" class="difflineplus">+      to = MimeHeaders_get(mdd-&gt;headers, HEADER_TO, false, true);</span>
<a href="#l47.1693"></a><span id="l47.1693" class="difflineplus">+      cc = MimeHeaders_get(mdd-&gt;headers, HEADER_CC, false, true);</span>
<a href="#l47.1694"></a><span id="l47.1694" class="difflineplus">+      bcc = MimeHeaders_get(mdd-&gt;headers, HEADER_BCC, false, true);</span>
<a href="#l47.1695"></a><span id="l47.1695"> </span>
<a href="#l47.1696"></a><span id="l47.1696">       /* These headers should not be RFC-1522-decoded. */</span>
<a href="#l47.1697"></a><span id="l47.1697" class="difflineminus">-      grps = MimeHeaders_get(mdd-&gt;headers, HEADER_NEWSGROUPS,  false, true);</span>
<a href="#l47.1698"></a><span id="l47.1698" class="difflineplus">+      grps = MimeHeaders_get(mdd-&gt;headers, HEADER_NEWSGROUPS, false, true);</span>
<a href="#l47.1699"></a><span id="l47.1699">       foll = MimeHeaders_get(mdd-&gt;headers, HEADER_FOLLOWUP_TO, false, true);</span>
<a href="#l47.1700"></a><span id="l47.1700"> </span>
<a href="#l47.1701"></a><span id="l47.1701" class="difflineminus">-      host = MimeHeaders_get(mdd-&gt;headers, HEADER_X_MOZILLA_NEWSHOST, false, false);</span>
<a href="#l47.1702"></a><span id="l47.1702" class="difflineplus">+      host = MimeHeaders_get(mdd-&gt;headers, HEADER_X_MOZILLA_NEWSHOST, false,</span>
<a href="#l47.1703"></a><span id="l47.1703" class="difflineplus">+                             false);</span>
<a href="#l47.1704"></a><span id="l47.1704">       if (!host)</span>
<a href="#l47.1705"></a><span id="l47.1705" class="difflineminus">-        host = MimeHeaders_get(mdd-&gt;headers, HEADER_NNTP_POSTING_HOST, false, false);</span>
<a href="#l47.1706"></a><span id="l47.1706" class="difflineplus">+        host = MimeHeaders_get(mdd-&gt;headers, HEADER_NNTP_POSTING_HOST, false,</span>
<a href="#l47.1707"></a><span id="l47.1707" class="difflineplus">+                               false);</span>
<a href="#l47.1708"></a><span id="l47.1708"> </span>
<a href="#l47.1709"></a><span id="l47.1709" class="difflineminus">-      id   = MimeHeaders_get(mdd-&gt;headers, HEADER_MESSAGE_ID,  false, false);</span>
<a href="#l47.1710"></a><span id="l47.1710" class="difflineminus">-      refs = MimeHeaders_get(mdd-&gt;headers, HEADER_REFERENCES,  false, true);</span>
<a href="#l47.1711"></a><span id="l47.1711" class="difflineplus">+      id = MimeHeaders_get(mdd-&gt;headers, HEADER_MESSAGE_ID, false, false);</span>
<a href="#l47.1712"></a><span id="l47.1712" class="difflineplus">+      refs = MimeHeaders_get(mdd-&gt;headers, HEADER_REFERENCES, false, true);</span>
<a href="#l47.1713"></a><span id="l47.1713">       priority = MimeHeaders_get(mdd-&gt;headers, HEADER_X_PRIORITY, false, false);</span>
<a href="#l47.1714"></a><span id="l47.1714"> </span>
<a href="#l47.1715"></a><span id="l47.1715" class="difflineminus">-</span>
<a href="#l47.1716"></a><span id="l47.1716" class="difflineminus">-      if (host)</span>
<a href="#l47.1717"></a><span id="l47.1717" class="difflineminus">-      {</span>
<a href="#l47.1718"></a><span id="l47.1718" class="difflineplus">+      if (host) {</span>
<a href="#l47.1719"></a><span id="l47.1719">         char *secure = NULL;</span>
<a href="#l47.1720"></a><span id="l47.1720"> </span>
<a href="#l47.1721"></a><span id="l47.1721">         secure = PL_strcasestr(host, &quot;secure&quot;);</span>
<a href="#l47.1722"></a><span id="l47.1722" class="difflineminus">-        if (secure)</span>
<a href="#l47.1723"></a><span id="l47.1723" class="difflineminus">-        {</span>
<a href="#l47.1724"></a><span id="l47.1724" class="difflineplus">+        if (secure) {</span>
<a href="#l47.1725"></a><span id="l47.1725">           *secure = 0;</span>
<a href="#l47.1726"></a><span id="l47.1726" class="difflineminus">-          news_host = PR_smprintf (&quot;snews://%s&quot;, host);</span>
<a href="#l47.1727"></a><span id="l47.1727" class="difflineminus">-        }</span>
<a href="#l47.1728"></a><span id="l47.1728" class="difflineminus">-        else</span>
<a href="#l47.1729"></a><span id="l47.1729" class="difflineminus">-        {</span>
<a href="#l47.1730"></a><span id="l47.1730" class="difflineminus">-          news_host = PR_smprintf (&quot;news://%s&quot;, host);</span>
<a href="#l47.1731"></a><span id="l47.1731" class="difflineplus">+          news_host = PR_smprintf(&quot;snews://%s&quot;, host);</span>
<a href="#l47.1732"></a><span id="l47.1732" class="difflineplus">+        } else {</span>
<a href="#l47.1733"></a><span id="l47.1733" class="difflineplus">+          news_host = PR_smprintf(&quot;news://%s&quot;, host);</span>
<a href="#l47.1734"></a><span id="l47.1734">         }</span>
<a href="#l47.1735"></a><span id="l47.1735">       }</span>
<a href="#l47.1736"></a><span id="l47.1736">     }</span>
<a href="#l47.1737"></a><span id="l47.1737"> </span>
<a href="#l47.1738"></a><span id="l47.1738" class="difflineplus">+    CreateCompositionFields(from, repl, to, cc, bcc, fcc, grps, foll, org, subj,</span>
<a href="#l47.1739"></a><span id="l47.1739" class="difflineplus">+                            refs, priority, news_host, mdd-&gt;mailcharset,</span>
<a href="#l47.1740"></a><span id="l47.1740" class="difflineplus">+                            getter_AddRefs(fields));</span>
<a href="#l47.1741"></a><span id="l47.1741"> </span>
<a href="#l47.1742"></a><span id="l47.1742" class="difflineminus">-    CreateCompositionFields(from, repl, to, cc, bcc, fcc, grps, foll,</span>
<a href="#l47.1743"></a><span id="l47.1743" class="difflineminus">-      org, subj, refs, priority, news_host,</span>
<a href="#l47.1744"></a><span id="l47.1744" class="difflineminus">-      mdd-&gt;mailcharset,</span>
<a href="#l47.1745"></a><span id="l47.1745" class="difflineminus">-      getter_AddRefs(fields));</span>
<a href="#l47.1746"></a><span id="l47.1746" class="difflineminus">-</span>
<a href="#l47.1747"></a><span id="l47.1747" class="difflineminus">-    contentLanguage = MimeHeaders_get(mdd-&gt;headers, HEADER_CONTENT_LANGUAGE, false, false);</span>
<a href="#l47.1748"></a><span id="l47.1748" class="difflineplus">+    contentLanguage =</span>
<a href="#l47.1749"></a><span id="l47.1749" class="difflineplus">+        MimeHeaders_get(mdd-&gt;headers, HEADER_CONTENT_LANGUAGE, false, false);</span>
<a href="#l47.1750"></a><span id="l47.1750">     if (contentLanguage) {</span>
<a href="#l47.1751"></a><span id="l47.1751">       fields-&gt;SetContentLanguage(contentLanguage);</span>
<a href="#l47.1752"></a><span id="l47.1752">     }</span>
<a href="#l47.1753"></a><span id="l47.1753"> </span>
<a href="#l47.1754"></a><span id="l47.1754" class="difflineminus">-    draftInfo = MimeHeaders_get(mdd-&gt;headers, HEADER_X_MOZILLA_DRAFT_INFO, false, false);</span>
<a href="#l47.1755"></a><span id="l47.1755" class="difflineplus">+    draftInfo = MimeHeaders_get(mdd-&gt;headers, HEADER_X_MOZILLA_DRAFT_INFO,</span>
<a href="#l47.1756"></a><span id="l47.1756" class="difflineplus">+                                false, false);</span>
<a href="#l47.1757"></a><span id="l47.1757"> </span>
<a href="#l47.1758"></a><span id="l47.1758" class="difflineminus">-    // We always preserve an existing message ID, if present, apart from some exceptions.</span>
<a href="#l47.1759"></a><span id="l47.1759" class="difflineplus">+    // We always preserve an existing message ID, if present, apart from some</span>
<a href="#l47.1760"></a><span id="l47.1760" class="difflineplus">+    // exceptions.</span>
<a href="#l47.1761"></a><span id="l47.1761">     bool keepID = fields != nullptr;</span>
<a href="#l47.1762"></a><span id="l47.1762"> </span>
<a href="#l47.1763"></a><span id="l47.1763">     // Don't keep ID when forwarding inline.</span>
<a href="#l47.1764"></a><span id="l47.1764" class="difflineminus">-    if (forward_inline)</span>
<a href="#l47.1765"></a><span id="l47.1765" class="difflineminus">-      keepID = false;</span>
<a href="#l47.1766"></a><span id="l47.1766" class="difflineplus">+    if (forward_inline) keepID = false;</span>
<a href="#l47.1767"></a><span id="l47.1767"> </span>
<a href="#l47.1768"></a><span id="l47.1768">     // nsMimeOutput::nsMimeMessageEditorTemplate is used for editing a message</span>
<a href="#l47.1769"></a><span id="l47.1769">     // &quot;as new&quot;, creating a message from a template or editing a template.</span>
<a href="#l47.1770"></a><span id="l47.1770">     // Only in the latter case we want to preserve the ID.</span>
<a href="#l47.1771"></a><span id="l47.1771">     if (mdd-&gt;format_out == nsMimeOutput::nsMimeMessageEditorTemplate &amp;&amp;</span>
<a href="#l47.1772"></a><span id="l47.1772">         !PL_strstr(mdd-&gt;url_name, &quot;&amp;edittempl=true&quot;))</span>
<a href="#l47.1773"></a><span id="l47.1773">       keepID = false;</span>
<a href="#l47.1774"></a><span id="l47.1774"> </span>
<a href="#l47.1775"></a><span id="l47.1775" class="difflineminus">-    if (keepID)</span>
<a href="#l47.1776"></a><span id="l47.1776" class="difflineminus">-      fields-&gt;SetMessageId(id);</span>
<a href="#l47.1777"></a><span id="l47.1777" class="difflineplus">+    if (keepID) fields-&gt;SetMessageId(id);</span>
<a href="#l47.1778"></a><span id="l47.1778"> </span>
<a href="#l47.1779"></a><span id="l47.1779" class="difflineminus">-    if (draftInfo &amp;&amp; fields &amp;&amp; !forward_inline)</span>
<a href="#l47.1780"></a><span id="l47.1780" class="difflineminus">-    {</span>
<a href="#l47.1781"></a><span id="l47.1781" class="difflineplus">+    if (draftInfo &amp;&amp; fields &amp;&amp; !forward_inline) {</span>
<a href="#l47.1782"></a><span id="l47.1782">       char *parm = 0;</span>
<a href="#l47.1783"></a><span id="l47.1783">       parm = MimeHeaders_get_parameter(draftInfo, &quot;vcard&quot;, NULL, NULL);</span>
<a href="#l47.1784"></a><span id="l47.1784">       fields-&gt;SetAttachVCard(parm &amp;&amp; !strcmp(parm, &quot;1&quot;));</span>
<a href="#l47.1785"></a><span id="l47.1785">       PR_FREEIF(parm);</span>
<a href="#l47.1786"></a><span id="l47.1786"> </span>
<a href="#l47.1787"></a><span id="l47.1787">       parm = MimeHeaders_get_parameter(draftInfo, &quot;receipt&quot;, NULL, NULL);</span>
<a href="#l47.1788"></a><span id="l47.1788">       if (!parm || !strcmp(parm, &quot;0&quot;))</span>
<a href="#l47.1789"></a><span id="l47.1789">         fields-&gt;SetReturnReceipt(false);</span>
<a href="#l47.1790"></a><span id="l47.1790" class="difflineminus">-      else</span>
<a href="#l47.1791"></a><span id="l47.1791" class="difflineminus">-      {</span>
<a href="#l47.1792"></a><span id="l47.1792" class="difflineplus">+      else {</span>
<a href="#l47.1793"></a><span id="l47.1793">         int receiptType = 0;</span>
<a href="#l47.1794"></a><span id="l47.1794">         fields-&gt;SetReturnReceipt(true);</span>
<a href="#l47.1795"></a><span id="l47.1795">         sscanf(parm, &quot;%d&quot;, &amp;receiptType);</span>
<a href="#l47.1796"></a><span id="l47.1796">         // slight change compared to 4.x; we used to use receipt= to tell</span>
<a href="#l47.1797"></a><span id="l47.1797">         // whether the draft/template has request for either MDN or DNS or both</span>
<a href="#l47.1798"></a><span id="l47.1798">         // return receipt; since the DNS is out of the picture we now use the</span>
<a href="#l47.1799"></a><span id="l47.1799">         // header type - 1 to tell whether user has requested the return receipt</span>
<a href="#l47.1800"></a><span id="l47.1800">         fields-&gt;SetReceiptHeaderType(((int32_t)receiptType) - 1);</span>
<a href="#l47.1801"></a><span id="l47.1801">       }</span>
<a href="#l47.1802"></a><span id="l47.1802">       PR_FREEIF(parm);</span>
<a href="#l47.1803"></a><span id="l47.1803">       parm = MimeHeaders_get_parameter(draftInfo, &quot;DSN&quot;, NULL, NULL);</span>
<a href="#l47.1804"></a><span id="l47.1804">       fields-&gt;SetDSN(parm &amp;&amp; !strcmp(parm, &quot;1&quot;));</span>
<a href="#l47.1805"></a><span id="l47.1805">       PR_Free(parm);</span>
<a href="#l47.1806"></a><span id="l47.1806">       parm = MimeHeaders_get_parameter(draftInfo, &quot;html&quot;, NULL, NULL);</span>
<a href="#l47.1807"></a><span id="l47.1807" class="difflineminus">-      if (parm)</span>
<a href="#l47.1808"></a><span id="l47.1808" class="difflineminus">-        sscanf(parm, &quot;%d&quot;, &amp;htmlAction);</span>
<a href="#l47.1809"></a><span id="l47.1809" class="difflineplus">+      if (parm) sscanf(parm, &quot;%d&quot;, &amp;htmlAction);</span>
<a href="#l47.1810"></a><span id="l47.1810">       PR_FREEIF(parm);</span>
<a href="#l47.1811"></a><span id="l47.1811">       parm = MimeHeaders_get_parameter(draftInfo, &quot;linewidth&quot;, NULL, NULL);</span>
<a href="#l47.1812"></a><span id="l47.1812" class="difflineminus">-      if (parm)</span>
<a href="#l47.1813"></a><span id="l47.1813" class="difflineminus">-        sscanf(parm, &quot;%d&quot;, &amp;lineWidth);</span>
<a href="#l47.1814"></a><span id="l47.1814" class="difflineplus">+      if (parm) sscanf(parm, &quot;%d&quot;, &amp;lineWidth);</span>
<a href="#l47.1815"></a><span id="l47.1815">       PR_FREEIF(parm);</span>
<a href="#l47.1816"></a><span id="l47.1816" class="difflineminus">-      parm = MimeHeaders_get_parameter(draftInfo, &quot;attachmentreminder&quot;, NULL, NULL);</span>
<a href="#l47.1817"></a><span id="l47.1817" class="difflineplus">+      parm = MimeHeaders_get_parameter(draftInfo, &quot;attachmentreminder&quot;, NULL,</span>
<a href="#l47.1818"></a><span id="l47.1818" class="difflineplus">+                                       NULL);</span>
<a href="#l47.1819"></a><span id="l47.1819">       if (parm &amp;&amp; !strcmp(parm, &quot;1&quot;))</span>
<a href="#l47.1820"></a><span id="l47.1820">         fields-&gt;SetAttachmentReminder(true);</span>
<a href="#l47.1821"></a><span id="l47.1821">       else</span>
<a href="#l47.1822"></a><span id="l47.1822">         fields-&gt;SetAttachmentReminder(false);</span>
<a href="#l47.1823"></a><span id="l47.1823">       PR_FREEIF(parm);</span>
<a href="#l47.1824"></a><span id="l47.1824">       parm = MimeHeaders_get_parameter(draftInfo, &quot;deliveryformat&quot;, NULL, NULL);</span>
<a href="#l47.1825"></a><span id="l47.1825">       if (parm) {</span>
<a href="#l47.1826"></a><span id="l47.1826">         int32_t deliveryFormat = nsIMsgCompSendFormat::AskUser;</span>
<a href="#l47.1827"></a><span id="l47.1827">         sscanf(parm, &quot;%d&quot;, &amp;deliveryFormat);</span>
<a href="#l47.1828"></a><span id="l47.1828">         fields-&gt;SetDeliveryFormat(deliveryFormat);</span>
<a href="#l47.1829"></a><span id="l47.1829">       }</span>
<a href="#l47.1830"></a><span id="l47.1830">       PR_FREEIF(parm);</span>
<a href="#l47.1831"></a><span id="l47.1831">     }</span>
<a href="#l47.1832"></a><span id="l47.1832"> </span>
<a href="#l47.1833"></a><span id="l47.1833" class="difflineminus">-  // identity to prefer when opening the message in the compose window?</span>
<a href="#l47.1834"></a><span id="l47.1834" class="difflineminus">-    identityKey = MimeHeaders_get(mdd-&gt;headers, HEADER_X_MOZILLA_IDENTITY_KEY, false, false);</span>
<a href="#l47.1835"></a><span id="l47.1835" class="difflineminus">-    if (identityKey &amp;&amp; *identityKey)</span>
<a href="#l47.1836"></a><span id="l47.1836" class="difflineminus">-    {</span>
<a href="#l47.1837"></a><span id="l47.1837" class="difflineminus">-        nsresult rv = NS_OK;</span>
<a href="#l47.1838"></a><span id="l47.1838" class="difflineminus">-        nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l47.1839"></a><span id="l47.1839" class="difflineminus">-                do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l47.1840"></a><span id="l47.1840" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; accountManager)</span>
<a href="#l47.1841"></a><span id="l47.1841" class="difflineminus">-        {</span>
<a href="#l47.1842"></a><span id="l47.1842" class="difflineminus">-            nsCOMPtr&lt;nsIMsgIdentity&gt; overrulingIdentity;</span>
<a href="#l47.1843"></a><span id="l47.1843" class="difflineminus">-            rv = accountManager-&gt;GetIdentity(nsDependentCString(identityKey), getter_AddRefs(overrulingIdentity));</span>
<a href="#l47.1844"></a><span id="l47.1844" class="difflineplus">+    // identity to prefer when opening the message in the compose window?</span>
<a href="#l47.1845"></a><span id="l47.1845" class="difflineplus">+    identityKey = MimeHeaders_get(mdd-&gt;headers, HEADER_X_MOZILLA_IDENTITY_KEY,</span>
<a href="#l47.1846"></a><span id="l47.1846" class="difflineplus">+                                  false, false);</span>
<a href="#l47.1847"></a><span id="l47.1847" class="difflineplus">+    if (identityKey &amp;&amp; *identityKey) {</span>
<a href="#l47.1848"></a><span id="l47.1848" class="difflineplus">+      nsresult rv = NS_OK;</span>
<a href="#l47.1849"></a><span id="l47.1849" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l47.1850"></a><span id="l47.1850" class="difflineplus">+          do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l47.1851"></a><span id="l47.1851" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; accountManager) {</span>
<a href="#l47.1852"></a><span id="l47.1852" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIdentity&gt; overrulingIdentity;</span>
<a href="#l47.1853"></a><span id="l47.1853" class="difflineplus">+        rv = accountManager-&gt;GetIdentity(nsDependentCString(identityKey),</span>
<a href="#l47.1854"></a><span id="l47.1854" class="difflineplus">+                                         getter_AddRefs(overrulingIdentity));</span>
<a href="#l47.1855"></a><span id="l47.1855"> </span>
<a href="#l47.1856"></a><span id="l47.1856" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; overrulingIdentity) {</span>
<a href="#l47.1857"></a><span id="l47.1857" class="difflineminus">-                mdd-&gt;identity = overrulingIdentity;</span>
<a href="#l47.1858"></a><span id="l47.1858" class="difflineminus">-                fields-&gt;SetCreatorIdentityKey(identityKey);</span>
<a href="#l47.1859"></a><span id="l47.1859" class="difflineminus">-            }</span>
<a href="#l47.1860"></a><span id="l47.1860" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; overrulingIdentity) {</span>
<a href="#l47.1861"></a><span id="l47.1861" class="difflineplus">+          mdd-&gt;identity = overrulingIdentity;</span>
<a href="#l47.1862"></a><span id="l47.1862" class="difflineplus">+          fields-&gt;SetCreatorIdentityKey(identityKey);</span>
<a href="#l47.1863"></a><span id="l47.1863">         }</span>
<a href="#l47.1864"></a><span id="l47.1864" class="difflineplus">+      }</span>
<a href="#l47.1865"></a><span id="l47.1865">     }</span>
<a href="#l47.1866"></a><span id="l47.1866"> </span>
<a href="#l47.1867"></a><span id="l47.1867" class="difflineminus">-    if (mdd-&gt;messageBody)</span>
<a href="#l47.1868"></a><span id="l47.1868" class="difflineminus">-    {</span>
<a href="#l47.1869"></a><span id="l47.1869" class="difflineplus">+    if (mdd-&gt;messageBody) {</span>
<a href="#l47.1870"></a><span id="l47.1870">       MSG_ComposeFormat composeFormat = nsIMsgCompFormat::Default;</span>
<a href="#l47.1871"></a><span id="l47.1871" class="difflineminus">-      if (!mdd-&gt;messageBody-&gt;m_type.IsEmpty())</span>
<a href="#l47.1872"></a><span id="l47.1872" class="difflineminus">-      {</span>
<a href="#l47.1873"></a><span id="l47.1873" class="difflineminus">-        if(mdd-&gt;messageBody-&gt;m_type.Find(&quot;text/html&quot;, /* ignoreCase = */ true) != -1)</span>
<a href="#l47.1874"></a><span id="l47.1874" class="difflineplus">+      if (!mdd-&gt;messageBody-&gt;m_type.IsEmpty()) {</span>
<a href="#l47.1875"></a><span id="l47.1875" class="difflineplus">+        if (mdd-&gt;messageBody-&gt;m_type.Find(&quot;text/html&quot;,</span>
<a href="#l47.1876"></a><span id="l47.1876" class="difflineplus">+                                          /* ignoreCase = */ true) != -1)</span>
<a href="#l47.1877"></a><span id="l47.1877">           composeFormat = nsIMsgCompFormat::HTML;</span>
<a href="#l47.1878"></a><span id="l47.1878" class="difflineminus">-        else if (mdd-&gt;messageBody-&gt;m_type.Find(&quot;text/plain&quot;, /* ignoreCase = */ true) != -1 ||</span>
<a href="#l47.1879"></a><span id="l47.1879" class="difflineplus">+        else if (mdd-&gt;messageBody-&gt;m_type.Find(&quot;text/plain&quot;,</span>
<a href="#l47.1880"></a><span id="l47.1880" class="difflineplus">+                                               /* ignoreCase = */ true) != -1 ||</span>
<a href="#l47.1881"></a><span id="l47.1881">                  mdd-&gt;messageBody-&gt;m_type.LowerCaseEqualsLiteral(&quot;text&quot;))</span>
<a href="#l47.1882"></a><span id="l47.1882">           composeFormat = nsIMsgCompFormat::PlainText;</span>
<a href="#l47.1883"></a><span id="l47.1883">         else</span>
<a href="#l47.1884"></a><span id="l47.1884" class="difflineminus">-          //We cannot use this kind of data for the message body! Therefore, move it as attachment</span>
<a href="#l47.1885"></a><span id="l47.1885" class="difflineplus">+          // We cannot use this kind of data for the message body! Therefore,</span>
<a href="#l47.1886"></a><span id="l47.1886" class="difflineplus">+          // move it as attachment</span>
<a href="#l47.1887"></a><span id="l47.1887">           bodyAsAttachment = true;</span>
<a href="#l47.1888"></a><span id="l47.1888" class="difflineminus">-      }</span>
<a href="#l47.1889"></a><span id="l47.1889" class="difflineminus">-      else</span>
<a href="#l47.1890"></a><span id="l47.1890" class="difflineplus">+      } else</span>
<a href="#l47.1891"></a><span id="l47.1891">         composeFormat = nsIMsgCompFormat::PlainText;</span>
<a href="#l47.1892"></a><span id="l47.1892"> </span>
<a href="#l47.1893"></a><span id="l47.1893">       char *body = nullptr;</span>
<a href="#l47.1894"></a><span id="l47.1894"> </span>
<a href="#l47.1895"></a><span id="l47.1895" class="difflineminus">-      if (!bodyAsAttachment &amp;&amp; mdd-&gt;messageBody-&gt;m_tmpFile)</span>
<a href="#l47.1896"></a><span id="l47.1896" class="difflineminus">-      {</span>
<a href="#l47.1897"></a><span id="l47.1897" class="difflineplus">+      if (!bodyAsAttachment &amp;&amp; mdd-&gt;messageBody-&gt;m_tmpFile) {</span>
<a href="#l47.1898"></a><span id="l47.1898">         int64_t fileSize;</span>
<a href="#l47.1899"></a><span id="l47.1899">         nsCOMPtr&lt;nsIFile&gt; tempFileCopy;</span>
<a href="#l47.1900"></a><span id="l47.1900">         mdd-&gt;messageBody-&gt;m_tmpFile-&gt;Clone(getter_AddRefs(tempFileCopy));</span>
<a href="#l47.1901"></a><span id="l47.1901">         mdd-&gt;messageBody-&gt;m_tmpFile = tempFileCopy;</span>
<a href="#l47.1902"></a><span id="l47.1902">         tempFileCopy = nullptr;</span>
<a href="#l47.1903"></a><span id="l47.1903">         mdd-&gt;messageBody-&gt;m_tmpFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l47.1904"></a><span id="l47.1904">         uint32_t bodyLen = 0;</span>
<a href="#l47.1905"></a><span id="l47.1905"> </span>
<a href="#l47.1906"></a><span id="l47.1906">         // The stream interface can only read up to 4GB (32bit uint).</span>
<a href="#l47.1907"></a><span id="l47.1907">         // It is highly unlikely to encounter a body lager than that limit,</span>
<a href="#l47.1908"></a><span id="l47.1908">         // so we just skip it instead of reading it in chunks.</span>
<a href="#l47.1909"></a><span id="l47.1909" class="difflineminus">-        if (fileSize &lt; UINT32_MAX)</span>
<a href="#l47.1910"></a><span id="l47.1910" class="difflineminus">-        {</span>
<a href="#l47.1911"></a><span id="l47.1911" class="difflineplus">+        if (fileSize &lt; UINT32_MAX) {</span>
<a href="#l47.1912"></a><span id="l47.1912">           bodyLen = fileSize;</span>
<a href="#l47.1913"></a><span id="l47.1913">           body = (char *)PR_MALLOC(bodyLen + 1);</span>
<a href="#l47.1914"></a><span id="l47.1914">         }</span>
<a href="#l47.1915"></a><span id="l47.1915" class="difflineminus">-        if (body)</span>
<a href="#l47.1916"></a><span id="l47.1916" class="difflineminus">-        {</span>
<a href="#l47.1917"></a><span id="l47.1917" class="difflineminus">-          memset(body, 0, bodyLen+1);</span>
<a href="#l47.1918"></a><span id="l47.1918" class="difflineplus">+        if (body) {</span>
<a href="#l47.1919"></a><span id="l47.1919" class="difflineplus">+          memset(body, 0, bodyLen + 1);</span>
<a href="#l47.1920"></a><span id="l47.1920"> </span>
<a href="#l47.1921"></a><span id="l47.1921">           uint32_t bytesRead;</span>
<a href="#l47.1922"></a><span id="l47.1922">           nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l47.1923"></a><span id="l47.1923"> </span>
<a href="#l47.1924"></a><span id="l47.1924" class="difflineminus">-          nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), mdd-&gt;messageBody-&gt;m_tmpFile);</span>
<a href="#l47.1925"></a><span id="l47.1925" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l47.1926"></a><span id="l47.1926" class="difflineminus">-            return;</span>
<a href="#l47.1927"></a><span id="l47.1927" class="difflineplus">+          nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream),</span>
<a href="#l47.1928"></a><span id="l47.1928" class="difflineplus">+                                                   mdd-&gt;messageBody-&gt;m_tmpFile);</span>
<a href="#l47.1929"></a><span id="l47.1929" class="difflineplus">+          if (NS_FAILED(rv)) return;</span>
<a href="#l47.1930"></a><span id="l47.1930"> </span>
<a href="#l47.1931"></a><span id="l47.1931">           inputStream-&gt;Read(body, bodyLen, &amp;bytesRead);</span>
<a href="#l47.1932"></a><span id="l47.1932"> </span>
<a href="#l47.1933"></a><span id="l47.1933">           inputStream-&gt;Close();</span>
<a href="#l47.1934"></a><span id="l47.1934"> </span>
<a href="#l47.1935"></a><span id="l47.1935">           // Convert the body to UTF-8</span>
<a href="#l47.1936"></a><span id="l47.1936">           char *mimeCharset = nullptr;</span>
<a href="#l47.1937"></a><span id="l47.1937">           // Get a charset from the header if no override is set.</span>
<a href="#l47.1938"></a><span id="l47.1938">           if (!charsetOverride)</span>
<a href="#l47.1939"></a><span id="l47.1939" class="difflineminus">-            mimeCharset = MimeHeaders_get_parameter(mdd-&gt;messageBody-&gt;m_type.get(), &quot;charset&quot;, nullptr, nullptr);</span>
<a href="#l47.1940"></a><span id="l47.1940" class="difflineplus">+            mimeCharset = MimeHeaders_get_parameter(</span>
<a href="#l47.1941"></a><span id="l47.1941" class="difflineplus">+                mdd-&gt;messageBody-&gt;m_type.get(), &quot;charset&quot;, nullptr, nullptr);</span>
<a href="#l47.1942"></a><span id="l47.1942">           // If no charset is specified in the header then use the default.</span>
<a href="#l47.1943"></a><span id="l47.1943">           char *bodyCharset = mimeCharset ? mimeCharset : mdd-&gt;mailcharset;</span>
<a href="#l47.1944"></a><span id="l47.1944" class="difflineminus">-          if (bodyCharset)</span>
<a href="#l47.1945"></a><span id="l47.1945" class="difflineminus">-          {</span>
<a href="#l47.1946"></a><span id="l47.1946" class="difflineplus">+          if (bodyCharset) {</span>
<a href="#l47.1947"></a><span id="l47.1947">             nsAutoString tmpUnicodeBody;</span>
<a href="#l47.1948"></a><span id="l47.1948">             rv = nsMsgI18NConvertToUnicode(nsDependentCString(bodyCharset),</span>
<a href="#l47.1949"></a><span id="l47.1949">                                            nsDependentCString(body),</span>
<a href="#l47.1950"></a><span id="l47.1950">                                            tmpUnicodeBody);</span>
<a href="#l47.1951"></a><span id="l47.1951" class="difflineminus">-            if (NS_FAILED(rv)) // Tough luck, ASCII/ISO-8859-1 then...</span>
<a href="#l47.1952"></a><span id="l47.1952" class="difflineplus">+            if (NS_FAILED(rv))  // Tough luck, ASCII/ISO-8859-1 then...</span>
<a href="#l47.1953"></a><span id="l47.1953">               CopyASCIItoUTF16(nsDependentCString(body), tmpUnicodeBody);</span>
<a href="#l47.1954"></a><span id="l47.1954"> </span>
<a href="#l47.1955"></a><span id="l47.1955">             char *newBody = ToNewUTF8String(tmpUnicodeBody);</span>
<a href="#l47.1956"></a><span id="l47.1956" class="difflineminus">-            if (newBody)</span>
<a href="#l47.1957"></a><span id="l47.1957" class="difflineminus">-            {</span>
<a href="#l47.1958"></a><span id="l47.1958" class="difflineplus">+            if (newBody) {</span>
<a href="#l47.1959"></a><span id="l47.1959">               PR_Free(body);</span>
<a href="#l47.1960"></a><span id="l47.1960">               body = newBody;</span>
<a href="#l47.1961"></a><span id="l47.1961">             }</span>
<a href="#l47.1962"></a><span id="l47.1962">           }</span>
<a href="#l47.1963"></a><span id="l47.1963">           PR_FREEIF(mimeCharset);</span>
<a href="#l47.1964"></a><span id="l47.1964">         }</span>
<a href="#l47.1965"></a><span id="l47.1965">       }</span>
<a href="#l47.1966"></a><span id="l47.1966"> </span>
<a href="#l47.1967"></a><span id="l47.1967">       bool convertToPlainText = false;</span>
<a href="#l47.1968"></a><span id="l47.1968" class="difflineminus">-      if (forward_inline)</span>
<a href="#l47.1969"></a><span id="l47.1969" class="difflineminus">-      {</span>
<a href="#l47.1970"></a><span id="l47.1970" class="difflineminus">-        if (mdd-&gt;identity)</span>
<a href="#l47.1971"></a><span id="l47.1971" class="difflineminus">-        {</span>
<a href="#l47.1972"></a><span id="l47.1972" class="difflineplus">+      if (forward_inline) {</span>
<a href="#l47.1973"></a><span id="l47.1973" class="difflineplus">+        if (mdd-&gt;identity) {</span>
<a href="#l47.1974"></a><span id="l47.1974">           bool identityComposeHTML;</span>
<a href="#l47.1975"></a><span id="l47.1975">           mdd-&gt;identity-&gt;GetComposeHtml(&amp;identityComposeHTML);</span>
<a href="#l47.1976"></a><span id="l47.1976">           if ((identityComposeHTML &amp;&amp; !mdd-&gt;overrideComposeFormat) ||</span>
<a href="#l47.1977"></a><span id="l47.1977" class="difflineminus">-              (!identityComposeHTML &amp;&amp; mdd-&gt;overrideComposeFormat))</span>
<a href="#l47.1978"></a><span id="l47.1978" class="difflineminus">-          {</span>
<a href="#l47.1979"></a><span id="l47.1979" class="difflineplus">+              (!identityComposeHTML &amp;&amp; mdd-&gt;overrideComposeFormat)) {</span>
<a href="#l47.1980"></a><span id="l47.1980">             // In the end, we're going to compose in HTML mode...</span>
<a href="#l47.1981"></a><span id="l47.1981"> </span>
<a href="#l47.1982"></a><span id="l47.1982" class="difflineminus">-            if (body &amp;&amp; composeFormat == nsIMsgCompFormat::PlainText)</span>
<a href="#l47.1983"></a><span id="l47.1983" class="difflineminus">-            {</span>
<a href="#l47.1984"></a><span id="l47.1984" class="difflineplus">+            if (body &amp;&amp; composeFormat == nsIMsgCompFormat::PlainText) {</span>
<a href="#l47.1985"></a><span id="l47.1985">               // ... but the message body is currently plain text.</span>
<a href="#l47.1986"></a><span id="l47.1986">               convert_plaintext_body_to_html(&amp;body);</span>
<a href="#l47.1987"></a><span id="l47.1987">             }</span>
<a href="#l47.1988"></a><span id="l47.1988">             // Body is now HTML, set the format too (so headers are inserted in</span>
<a href="#l47.1989"></a><span id="l47.1989">             // correct format).</span>
<a href="#l47.1990"></a><span id="l47.1990">             composeFormat = nsIMsgCompFormat::HTML;</span>
<a href="#l47.1991"></a><span id="l47.1991" class="difflineminus">-          }</span>
<a href="#l47.1992"></a><span id="l47.1992" class="difflineminus">-          else if ((identityComposeHTML &amp;&amp; mdd-&gt;overrideComposeFormat) || !identityComposeHTML)</span>
<a href="#l47.1993"></a><span id="l47.1993" class="difflineminus">-          {</span>
<a href="#l47.1994"></a><span id="l47.1994" class="difflineplus">+          } else if ((identityComposeHTML &amp;&amp; mdd-&gt;overrideComposeFormat) ||</span>
<a href="#l47.1995"></a><span id="l47.1995" class="difflineplus">+                     !identityComposeHTML) {</span>
<a href="#l47.1996"></a><span id="l47.1996">             // In the end, we're going to compose in plain text mode...</span>
<a href="#l47.1997"></a><span id="l47.1997"> </span>
<a href="#l47.1998"></a><span id="l47.1998" class="difflineminus">-            if (composeFormat == nsIMsgCompFormat::HTML)</span>
<a href="#l47.1999"></a><span id="l47.1999" class="difflineminus">-            {</span>
<a href="#l47.2000"></a><span id="l47.2000" class="difflineplus">+            if (composeFormat == nsIMsgCompFormat::HTML) {</span>
<a href="#l47.2001"></a><span id="l47.2001">               // ... but the message body is currently HTML.</span>
<a href="#l47.2002"></a><span id="l47.2002">               // We'll do the conversion later on when headers have been</span>
<a href="#l47.2003"></a><span id="l47.2003">               // inserted, body has been set and converted to unicode.</span>
<a href="#l47.2004"></a><span id="l47.2004">               convertToPlainText = true;</span>
<a href="#l47.2005"></a><span id="l47.2005">             }</span>
<a href="#l47.2006"></a><span id="l47.2006">           }</span>
<a href="#l47.2007"></a><span id="l47.2007">         }</span>
<a href="#l47.2008"></a><span id="l47.2008"> </span>
<a href="#l47.2009"></a><span id="l47.2009" class="difflineminus">-        mime_insert_forwarded_message_headers(&amp;body, mdd-&gt;headers, composeFormat,</span>
<a href="#l47.2010"></a><span id="l47.2010" class="difflineminus">-          mdd-&gt;mailcharset);</span>
<a href="#l47.2011"></a><span id="l47.2011" class="difflineminus">-</span>
<a href="#l47.2012"></a><span id="l47.2012" class="difflineplus">+        mime_insert_forwarded_message_headers(&amp;body, mdd-&gt;headers,</span>
<a href="#l47.2013"></a><span id="l47.2013" class="difflineplus">+                                              composeFormat, mdd-&gt;mailcharset);</span>
<a href="#l47.2014"></a><span id="l47.2014">       }</span>
<a href="#l47.2015"></a><span id="l47.2015"> </span>
<a href="#l47.2016"></a><span id="l47.2016">       MSG_ComposeType msgComposeType = 0;  // Keep compilers happy.</span>
<a href="#l47.2017"></a><span id="l47.2017" class="difflineminus">-      if (mdd-&gt;format_out == nsMimeOutput::nsMimeMessageEditorTemplate)</span>
<a href="#l47.2018"></a><span id="l47.2018" class="difflineminus">-      {</span>
<a href="#l47.2019"></a><span id="l47.2019" class="difflineplus">+      if (mdd-&gt;format_out == nsMimeOutput::nsMimeMessageEditorTemplate) {</span>
<a href="#l47.2020"></a><span id="l47.2020">         if (PL_strstr(mdd-&gt;url_name, &quot;&amp;redirect=true&quot;))</span>
<a href="#l47.2021"></a><span id="l47.2021">           msgComposeType = nsIMsgCompType::Redirect;</span>
<a href="#l47.2022"></a><span id="l47.2022">         else if (PL_strstr(mdd-&gt;url_name, &quot;&amp;editasnew=true&quot;))</span>
<a href="#l47.2023"></a><span id="l47.2023">           msgComposeType = nsIMsgCompType::EditAsNew;</span>
<a href="#l47.2024"></a><span id="l47.2024">         else if (PL_strstr(mdd-&gt;url_name, &quot;&amp;edittempl=true&quot;))</span>
<a href="#l47.2025"></a><span id="l47.2025">           msgComposeType = nsIMsgCompType::EditTemplate;</span>
<a href="#l47.2026"></a><span id="l47.2026">         else</span>
<a href="#l47.2027"></a><span id="l47.2027">           msgComposeType = nsIMsgCompType::Template;</span>
<a href="#l47.2028"></a><span id="l47.2028">       }</span>
<a href="#l47.2029"></a><span id="l47.2029"> </span>
<a href="#l47.2030"></a><span id="l47.2030" class="difflineminus">-      if (body &amp;&amp; msgComposeType == nsIMsgCompType::EditAsNew)</span>
<a href="#l47.2031"></a><span id="l47.2031" class="difflineminus">-      {</span>
<a href="#l47.2032"></a><span id="l47.2032" class="difflineplus">+      if (body &amp;&amp; msgComposeType == nsIMsgCompType::EditAsNew) {</span>
<a href="#l47.2033"></a><span id="l47.2033">         // When editing as new, we respect the identities preferred format</span>
<a href="#l47.2034"></a><span id="l47.2034">         // which can be overridden.</span>
<a href="#l47.2035"></a><span id="l47.2035" class="difflineminus">-        if (mdd-&gt;identity)</span>
<a href="#l47.2036"></a><span id="l47.2036" class="difflineminus">-        {</span>
<a href="#l47.2037"></a><span id="l47.2037" class="difflineplus">+        if (mdd-&gt;identity) {</span>
<a href="#l47.2038"></a><span id="l47.2038">           bool identityComposeHTML;</span>
<a href="#l47.2039"></a><span id="l47.2039">           mdd-&gt;identity-&gt;GetComposeHtml(&amp;identityComposeHTML);</span>
<a href="#l47.2040"></a><span id="l47.2040"> </span>
<a href="#l47.2041"></a><span id="l47.2041">           if (composeFormat == nsIMsgCompFormat::HTML &amp;&amp;</span>
<a href="#l47.2042"></a><span id="l47.2042" class="difflineminus">-              identityComposeHTML == mdd-&gt;overrideComposeFormat)</span>
<a href="#l47.2043"></a><span id="l47.2043" class="difflineminus">-          {</span>
<a href="#l47.2044"></a><span id="l47.2044" class="difflineplus">+              identityComposeHTML == mdd-&gt;overrideComposeFormat) {</span>
<a href="#l47.2045"></a><span id="l47.2045">             // We we have HTML:</span>
<a href="#l47.2046"></a><span id="l47.2046">             // If they want HTML and they want to override it (true == true)</span>
<a href="#l47.2047"></a><span id="l47.2047">             // or they don't want HTML and they don't want to override it</span>
<a href="#l47.2048"></a><span id="l47.2048">             // (false == false), then convert. Conversion happens below.</span>
<a href="#l47.2049"></a><span id="l47.2049">             convertToPlainText = true;</span>
<a href="#l47.2050"></a><span id="l47.2050">             composeFormat = nsIMsgCompFormat::PlainText;</span>
<a href="#l47.2051"></a><span id="l47.2051" class="difflineminus">-          }</span>
<a href="#l47.2052"></a><span id="l47.2052" class="difflineminus">-          else if (composeFormat == nsIMsgCompFormat::PlainText &amp;&amp;</span>
<a href="#l47.2053"></a><span id="l47.2053" class="difflineminus">-                   identityComposeHTML != mdd-&gt;overrideComposeFormat)</span>
<a href="#l47.2054"></a><span id="l47.2054" class="difflineminus">-          {</span>
<a href="#l47.2055"></a><span id="l47.2055" class="difflineplus">+          } else if (composeFormat == nsIMsgCompFormat::PlainText &amp;&amp;</span>
<a href="#l47.2056"></a><span id="l47.2056" class="difflineplus">+                     identityComposeHTML != mdd-&gt;overrideComposeFormat) {</span>
<a href="#l47.2057"></a><span id="l47.2057">             // We have plain text:</span>
<a href="#l47.2058"></a><span id="l47.2058" class="difflineminus">-            // If they want HTML and they don't want to override it (true != false)</span>
<a href="#l47.2059"></a><span id="l47.2059" class="difflineminus">-            // or they don't want HTML and they want to override it</span>
<a href="#l47.2060"></a><span id="l47.2060" class="difflineplus">+            // If they want HTML and they don't want to override it (true !=</span>
<a href="#l47.2061"></a><span id="l47.2061" class="difflineplus">+            // false) or they don't want HTML and they want to override it</span>
<a href="#l47.2062"></a><span id="l47.2062">             // (false != true), then convert.</span>
<a href="#l47.2063"></a><span id="l47.2063">             convert_plaintext_body_to_html(&amp;body);</span>
<a href="#l47.2064"></a><span id="l47.2064">             composeFormat = nsIMsgCompFormat::HTML;</span>
<a href="#l47.2065"></a><span id="l47.2065">           }</span>
<a href="#l47.2066"></a><span id="l47.2066">         }</span>
<a href="#l47.2067"></a><span id="l47.2067" class="difflineminus">-      }</span>
<a href="#l47.2068"></a><span id="l47.2068" class="difflineminus">-      else if (body &amp;&amp; mdd-&gt;overrideComposeFormat &amp;&amp;</span>
<a href="#l47.2069"></a><span id="l47.2069" class="difflineminus">-               (msgComposeType == nsIMsgCompType::Template ||</span>
<a href="#l47.2070"></a><span id="l47.2070" class="difflineminus">-                msgComposeType == nsIMsgCompType::EditTemplate ||</span>
<a href="#l47.2071"></a><span id="l47.2071" class="difflineminus">-                !mdd-&gt;forwardInline)) // Draft processing.</span>
<a href="#l47.2072"></a><span id="l47.2072" class="difflineplus">+      } else if (body &amp;&amp; mdd-&gt;overrideComposeFormat &amp;&amp;</span>
<a href="#l47.2073"></a><span id="l47.2073" class="difflineplus">+                 (msgComposeType == nsIMsgCompType::Template ||</span>
<a href="#l47.2074"></a><span id="l47.2074" class="difflineplus">+                  msgComposeType == nsIMsgCompType::EditTemplate ||</span>
<a href="#l47.2075"></a><span id="l47.2075" class="difflineplus">+                  !mdd-&gt;forwardInline))  // Draft processing.</span>
<a href="#l47.2076"></a><span id="l47.2076">       {</span>
<a href="#l47.2077"></a><span id="l47.2077">         // When using a template and overriding, the user gets the</span>
<a href="#l47.2078"></a><span id="l47.2078">         // &quot;other&quot; format.</span>
<a href="#l47.2079"></a><span id="l47.2079" class="difflineminus">-        if (composeFormat == nsIMsgCompFormat::PlainText)</span>
<a href="#l47.2080"></a><span id="l47.2080" class="difflineminus">-        {</span>
<a href="#l47.2081"></a><span id="l47.2081" class="difflineplus">+        if (composeFormat == nsIMsgCompFormat::PlainText) {</span>
<a href="#l47.2082"></a><span id="l47.2082">           convert_plaintext_body_to_html(&amp;body);</span>
<a href="#l47.2083"></a><span id="l47.2083">           composeFormat = nsIMsgCompFormat::HTML;</span>
<a href="#l47.2084"></a><span id="l47.2084" class="difflineminus">-        }</span>
<a href="#l47.2085"></a><span id="l47.2085" class="difflineminus">-        else</span>
<a href="#l47.2086"></a><span id="l47.2086" class="difflineminus">-        {</span>
<a href="#l47.2087"></a><span id="l47.2087" class="difflineplus">+        } else {</span>
<a href="#l47.2088"></a><span id="l47.2088">           // Conversion happens below.</span>
<a href="#l47.2089"></a><span id="l47.2089">           convertToPlainText = true;</span>
<a href="#l47.2090"></a><span id="l47.2090">           composeFormat = nsIMsgCompFormat::PlainText;</span>
<a href="#l47.2091"></a><span id="l47.2091">         }</span>
<a href="#l47.2092"></a><span id="l47.2092">       }</span>
<a href="#l47.2093"></a><span id="l47.2093"> </span>
<a href="#l47.2094"></a><span id="l47.2094">       // convert from UTF-8 to UTF-16</span>
<a href="#l47.2095"></a><span id="l47.2095" class="difflineminus">-      if (body)</span>
<a href="#l47.2096"></a><span id="l47.2096" class="difflineminus">-      {</span>
<a href="#l47.2097"></a><span id="l47.2097" class="difflineplus">+      if (body) {</span>
<a href="#l47.2098"></a><span id="l47.2098">         fields-&gt;SetBody(NS_ConvertUTF8toUTF16(body));</span>
<a href="#l47.2099"></a><span id="l47.2099">         PR_Free(body);</span>
<a href="#l47.2100"></a><span id="l47.2100">       }</span>
<a href="#l47.2101"></a><span id="l47.2101"> </span>
<a href="#l47.2102"></a><span id="l47.2102">       //</span>
<a href="#l47.2103"></a><span id="l47.2103">       // At this point, we need to create a message compose window or editor</span>
<a href="#l47.2104"></a><span id="l47.2104">       // window via XP-COM with the information that we have retrieved from</span>
<a href="#l47.2105"></a><span id="l47.2105">       // the message store.</span>
<a href="#l47.2106"></a><span id="l47.2106">       //</span>
<a href="#l47.2107"></a><span id="l47.2107" class="difflineminus">-      if (mdd-&gt;format_out == nsMimeOutput::nsMimeMessageEditorTemplate)</span>
<a href="#l47.2108"></a><span id="l47.2108" class="difflineminus">-      {</span>
<a href="#l47.2109"></a><span id="l47.2109" class="difflineplus">+      if (mdd-&gt;format_out == nsMimeOutput::nsMimeMessageEditorTemplate) {</span>
<a href="#l47.2110"></a><span id="l47.2110">         // Set the draft ID when editing a template so the original is</span>
<a href="#l47.2111"></a><span id="l47.2111">         // overwritten when saving the template again.</span>
<a href="#l47.2112"></a><span id="l47.2112">         // Note that always setting the draft ID here would cause drafts to be</span>
<a href="#l47.2113"></a><span id="l47.2113">         // overwritten when edited &quot;as new&quot;, which is undesired.</span>
<a href="#l47.2114"></a><span id="l47.2114">         if (msgComposeType == nsIMsgCompType::EditTemplate) {</span>
<a href="#l47.2115"></a><span id="l47.2115">           fields-&gt;SetDraftId(mdd-&gt;url_name);</span>
<a href="#l47.2116"></a><span id="l47.2116" class="difflineminus">-          fields-&gt;SetTemplateId(mdd-&gt;url_name);  // Remember original template ID.</span>
<a href="#l47.2117"></a><span id="l47.2117" class="difflineplus">+          fields-&gt;SetTemplateId(</span>
<a href="#l47.2118"></a><span id="l47.2118" class="difflineplus">+              mdd-&gt;url_name);  // Remember original template ID.</span>
<a href="#l47.2119"></a><span id="l47.2119">         }</span>
<a href="#l47.2120"></a><span id="l47.2120"> </span>
<a href="#l47.2121"></a><span id="l47.2121" class="difflineminus">-        if (convertToPlainText)</span>
<a href="#l47.2122"></a><span id="l47.2122" class="difflineminus">-          fields-&gt;ConvertBodyToPlainText();</span>
<a href="#l47.2123"></a><span id="l47.2123" class="difflineplus">+        if (convertToPlainText) fields-&gt;ConvertBodyToPlainText();</span>
<a href="#l47.2124"></a><span id="l47.2124"> </span>
<a href="#l47.2125"></a><span id="l47.2125">         CreateTheComposeWindow(fields, newAttachData, msgComposeType,</span>
<a href="#l47.2126"></a><span id="l47.2126">                                composeFormat, mdd-&gt;identity,</span>
<a href="#l47.2127"></a><span id="l47.2127">                                mdd-&gt;originalMsgURI, mdd-&gt;origMsgHdr);</span>
<a href="#l47.2128"></a><span id="l47.2128" class="difflineminus">-      }</span>
<a href="#l47.2129"></a><span id="l47.2129" class="difflineminus">-      else</span>
<a href="#l47.2130"></a><span id="l47.2130" class="difflineminus">-      {</span>
<a href="#l47.2131"></a><span id="l47.2131" class="difflineminus">-        if (mdd-&gt;forwardInline)</span>
<a href="#l47.2132"></a><span id="l47.2132" class="difflineminus">-        {</span>
<a href="#l47.2133"></a><span id="l47.2133" class="difflineminus">-          if (convertToPlainText)</span>
<a href="#l47.2134"></a><span id="l47.2134" class="difflineminus">-            fields-&gt;ConvertBodyToPlainText();</span>
<a href="#l47.2135"></a><span id="l47.2135" class="difflineplus">+      } else {</span>
<a href="#l47.2136"></a><span id="l47.2136" class="difflineplus">+        if (mdd-&gt;forwardInline) {</span>
<a href="#l47.2137"></a><span id="l47.2137" class="difflineplus">+          if (convertToPlainText) fields-&gt;ConvertBodyToPlainText();</span>
<a href="#l47.2138"></a><span id="l47.2138">           if (mdd-&gt;overrideComposeFormat)</span>
<a href="#l47.2139"></a><span id="l47.2139">             composeFormat = nsIMsgCompFormat::OppositeOfDefault;</span>
<a href="#l47.2140"></a><span id="l47.2140" class="difflineminus">-          if (mdd-&gt;forwardInlineFilter)</span>
<a href="#l47.2141"></a><span id="l47.2141" class="difflineminus">-          {</span>
<a href="#l47.2142"></a><span id="l47.2142" class="difflineplus">+          if (mdd-&gt;forwardInlineFilter) {</span>
<a href="#l47.2143"></a><span id="l47.2143">             fields-&gt;SetTo(mdd-&gt;forwardToAddress);</span>
<a href="#l47.2144"></a><span id="l47.2144">             ForwardMsgInline(fields, newAttachData, composeFormat,</span>
<a href="#l47.2145"></a><span id="l47.2145">                              mdd-&gt;identity, mdd-&gt;originalMsgURI,</span>
<a href="#l47.2146"></a><span id="l47.2146">                              mdd-&gt;origMsgHdr);</span>
<a href="#l47.2147"></a><span id="l47.2147" class="difflineminus">-          }</span>
<a href="#l47.2148"></a><span id="l47.2148" class="difflineminus">-          else</span>
<a href="#l47.2149"></a><span id="l47.2149" class="difflineplus">+          } else</span>
<a href="#l47.2150"></a><span id="l47.2150">             CreateTheComposeWindow(fields, newAttachData,</span>
<a href="#l47.2151"></a><span id="l47.2151">                                    nsIMsgCompType::ForwardInline, composeFormat,</span>
<a href="#l47.2152"></a><span id="l47.2152">                                    mdd-&gt;identity, mdd-&gt;originalMsgURI,</span>
<a href="#l47.2153"></a><span id="l47.2153">                                    mdd-&gt;origMsgHdr);</span>
<a href="#l47.2154"></a><span id="l47.2154" class="difflineminus">-        }</span>
<a href="#l47.2155"></a><span id="l47.2155" class="difflineminus">-        else</span>
<a href="#l47.2156"></a><span id="l47.2156" class="difflineminus">-        {</span>
<a href="#l47.2157"></a><span id="l47.2157" class="difflineminus">-          if (convertToPlainText)</span>
<a href="#l47.2158"></a><span id="l47.2158" class="difflineminus">-            fields-&gt;ConvertBodyToPlainText();</span>
<a href="#l47.2159"></a><span id="l47.2159" class="difflineplus">+        } else {</span>
<a href="#l47.2160"></a><span id="l47.2160" class="difflineplus">+          if (convertToPlainText) fields-&gt;ConvertBodyToPlainText();</span>
<a href="#l47.2161"></a><span id="l47.2161">           fields-&gt;SetDraftId(mdd-&gt;url_name);</span>
<a href="#l47.2162"></a><span id="l47.2162" class="difflineminus">-          CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::Draft, composeFormat, mdd-&gt;identity, mdd-&gt;originalMsgURI, mdd-&gt;origMsgHdr);</span>
<a href="#l47.2163"></a><span id="l47.2163" class="difflineplus">+          CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::Draft,</span>
<a href="#l47.2164"></a><span id="l47.2164" class="difflineplus">+                                 composeFormat, mdd-&gt;identity,</span>
<a href="#l47.2165"></a><span id="l47.2165" class="difflineplus">+                                 mdd-&gt;originalMsgURI, mdd-&gt;origMsgHdr);</span>
<a href="#l47.2166"></a><span id="l47.2166">         }</span>
<a href="#l47.2167"></a><span id="l47.2167">       }</span>
<a href="#l47.2168"></a><span id="l47.2168" class="difflineminus">-    }</span>
<a href="#l47.2169"></a><span id="l47.2169" class="difflineminus">-    else</span>
<a href="#l47.2170"></a><span id="l47.2170" class="difflineminus">-    {</span>
<a href="#l47.2171"></a><span id="l47.2171" class="difflineplus">+    } else {</span>
<a href="#l47.2172"></a><span id="l47.2172">       //</span>
<a href="#l47.2173"></a><span id="l47.2173">       // At this point, we need to create a message compose window via</span>
<a href="#l47.2174"></a><span id="l47.2174" class="difflineminus">-      // XP-COM with the information that we have retrieved from the message store.</span>
<a href="#l47.2175"></a><span id="l47.2175" class="difflineplus">+      // XP-COM with the information that we have retrieved from the message</span>
<a href="#l47.2176"></a><span id="l47.2176" class="difflineplus">+      // store.</span>
<a href="#l47.2177"></a><span id="l47.2177">       //</span>
<a href="#l47.2178"></a><span id="l47.2178" class="difflineminus">-      if (mdd-&gt;format_out == nsMimeOutput::nsMimeMessageEditorTemplate)</span>
<a href="#l47.2179"></a><span id="l47.2179" class="difflineminus">-      {</span>
<a href="#l47.2180"></a><span id="l47.2180" class="difflineplus">+      if (mdd-&gt;format_out == nsMimeOutput::nsMimeMessageEditorTemplate) {</span>
<a href="#l47.2181"></a><span id="l47.2181"> #ifdef NS_DEBUG</span>
<a href="#l47.2182"></a><span id="l47.2182" class="difflineminus">-        printf(&quot;RICHIE: Time to create the EDITOR with this template - NO body!!!!\n&quot;);</span>
<a href="#l47.2183"></a><span id="l47.2183" class="difflineplus">+        printf(</span>
<a href="#l47.2184"></a><span id="l47.2184" class="difflineplus">+            &quot;RICHIE: Time to create the EDITOR with this template - NO &quot;</span>
<a href="#l47.2185"></a><span id="l47.2185" class="difflineplus">+            &quot;body!!!!\n&quot;);</span>
<a href="#l47.2186"></a><span id="l47.2186"> #endif</span>
<a href="#l47.2187"></a><span id="l47.2187" class="difflineminus">-        CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::Template, nsIMsgCompFormat::Default, mdd-&gt;identity, nullptr, mdd-&gt;origMsgHdr);</span>
<a href="#l47.2188"></a><span id="l47.2188" class="difflineminus">-      }</span>
<a href="#l47.2189"></a><span id="l47.2189" class="difflineminus">-      else</span>
<a href="#l47.2190"></a><span id="l47.2190" class="difflineminus">-      {</span>
<a href="#l47.2191"></a><span id="l47.2191" class="difflineplus">+        CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::Template,</span>
<a href="#l47.2192"></a><span id="l47.2192" class="difflineplus">+                               nsIMsgCompFormat::Default, mdd-&gt;identity,</span>
<a href="#l47.2193"></a><span id="l47.2193" class="difflineplus">+                               nullptr, mdd-&gt;origMsgHdr);</span>
<a href="#l47.2194"></a><span id="l47.2194" class="difflineplus">+      } else {</span>
<a href="#l47.2195"></a><span id="l47.2195"> #ifdef NS_DEBUG</span>
<a href="#l47.2196"></a><span id="l47.2196">         printf(&quot;Time to create the composition window WITHOUT a body!!!!\n&quot;);</span>
<a href="#l47.2197"></a><span id="l47.2197"> #endif</span>
<a href="#l47.2198"></a><span id="l47.2198" class="difflineminus">-        if (mdd-&gt;forwardInline)</span>
<a href="#l47.2199"></a><span id="l47.2199" class="difflineminus">-        {</span>
<a href="#l47.2200"></a><span id="l47.2200" class="difflineminus">-          MSG_ComposeFormat composeFormat = (mdd-&gt;overrideComposeFormat) ?</span>
<a href="#l47.2201"></a><span id="l47.2201" class="difflineminus">-            nsIMsgCompFormat::OppositeOfDefault : nsIMsgCompFormat::Default;</span>
<a href="#l47.2202"></a><span id="l47.2202" class="difflineplus">+        if (mdd-&gt;forwardInline) {</span>
<a href="#l47.2203"></a><span id="l47.2203" class="difflineplus">+          MSG_ComposeFormat composeFormat =</span>
<a href="#l47.2204"></a><span id="l47.2204" class="difflineplus">+              (mdd-&gt;overrideComposeFormat) ? nsIMsgCompFormat::OppositeOfDefault</span>
<a href="#l47.2205"></a><span id="l47.2205" class="difflineplus">+                                           : nsIMsgCompFormat::Default;</span>
<a href="#l47.2206"></a><span id="l47.2206">           CreateTheComposeWindow(fields, newAttachData,</span>
<a href="#l47.2207"></a><span id="l47.2207">                                  nsIMsgCompType::ForwardInline, composeFormat,</span>
<a href="#l47.2208"></a><span id="l47.2208">                                  mdd-&gt;identity, mdd-&gt;originalMsgURI,</span>
<a href="#l47.2209"></a><span id="l47.2209">                                  mdd-&gt;origMsgHdr);</span>
<a href="#l47.2210"></a><span id="l47.2210" class="difflineminus">-        }</span>
<a href="#l47.2211"></a><span id="l47.2211" class="difflineminus">-        else</span>
<a href="#l47.2212"></a><span id="l47.2212" class="difflineminus">-        {</span>
<a href="#l47.2213"></a><span id="l47.2213" class="difflineplus">+        } else {</span>
<a href="#l47.2214"></a><span id="l47.2214">           fields-&gt;SetDraftId(mdd-&gt;url_name);</span>
<a href="#l47.2215"></a><span id="l47.2215" class="difflineminus">-          CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::Draft, nsIMsgCompFormat::Default, mdd-&gt;identity, nullptr, mdd-&gt;origMsgHdr);</span>
<a href="#l47.2216"></a><span id="l47.2216" class="difflineplus">+          CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::Draft,</span>
<a href="#l47.2217"></a><span id="l47.2217" class="difflineplus">+                                 nsIMsgCompFormat::Default, mdd-&gt;identity,</span>
<a href="#l47.2218"></a><span id="l47.2218" class="difflineplus">+                                 nullptr, mdd-&gt;origMsgHdr);</span>
<a href="#l47.2219"></a><span id="l47.2219">         }</span>
<a href="#l47.2220"></a><span id="l47.2220">       }</span>
<a href="#l47.2221"></a><span id="l47.2221">     }</span>
<a href="#l47.2222"></a><span id="l47.2222" class="difflineminus">-  }</span>
<a href="#l47.2223"></a><span id="l47.2223" class="difflineminus">-  else</span>
<a href="#l47.2224"></a><span id="l47.2224" class="difflineminus">-  {</span>
<a href="#l47.2225"></a><span id="l47.2225" class="difflineminus">-    CreateCompositionFields(from, repl, to, cc, bcc, fcc, grps, foll,</span>
<a href="#l47.2226"></a><span id="l47.2226" class="difflineminus">-      org, subj, refs, priority, news_host,</span>
<a href="#l47.2227"></a><span id="l47.2227" class="difflineminus">-      mdd-&gt;mailcharset,</span>
<a href="#l47.2228"></a><span id="l47.2228" class="difflineminus">-      getter_AddRefs(fields));</span>
<a href="#l47.2229"></a><span id="l47.2229" class="difflineplus">+  } else {</span>
<a href="#l47.2230"></a><span id="l47.2230" class="difflineplus">+    CreateCompositionFields(from, repl, to, cc, bcc, fcc, grps, foll, org, subj,</span>
<a href="#l47.2231"></a><span id="l47.2231" class="difflineplus">+                            refs, priority, news_host, mdd-&gt;mailcharset,</span>
<a href="#l47.2232"></a><span id="l47.2232" class="difflineplus">+                            getter_AddRefs(fields));</span>
<a href="#l47.2233"></a><span id="l47.2233">     if (fields)</span>
<a href="#l47.2234"></a><span id="l47.2234" class="difflineminus">-      CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::New, nsIMsgCompFormat::Default, mdd-&gt;identity, nullptr, mdd-&gt;origMsgHdr);</span>
<a href="#l47.2235"></a><span id="l47.2235" class="difflineplus">+      CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::New,</span>
<a href="#l47.2236"></a><span id="l47.2236" class="difflineplus">+                             nsIMsgCompFormat::Default, mdd-&gt;identity, nullptr,</span>
<a href="#l47.2237"></a><span id="l47.2237" class="difflineplus">+                             mdd-&gt;origMsgHdr);</span>
<a href="#l47.2238"></a><span id="l47.2238">   }</span>
<a href="#l47.2239"></a><span id="l47.2239"> </span>
<a href="#l47.2240"></a><span id="l47.2240" class="difflineminus">-  if (mdd-&gt;headers)</span>
<a href="#l47.2241"></a><span id="l47.2241" class="difflineminus">-    MimeHeaders_free(mdd-&gt;headers);</span>
<a href="#l47.2242"></a><span id="l47.2242" class="difflineplus">+  if (mdd-&gt;headers) MimeHeaders_free(mdd-&gt;headers);</span>
<a href="#l47.2243"></a><span id="l47.2243"> </span>
<a href="#l47.2244"></a><span id="l47.2244">   //</span>
<a href="#l47.2245"></a><span id="l47.2245">   // Free the original attachment structure...</span>
<a href="#l47.2246"></a><span id="l47.2246">   // Make sure we only cleanup the local copy of the memory and not kill</span>
<a href="#l47.2247"></a><span id="l47.2247">   // files we need on disk</span>
<a href="#l47.2248"></a><span id="l47.2248">   //</span>
<a href="#l47.2249"></a><span id="l47.2249">   if (bodyAsAttachment)</span>
<a href="#l47.2250"></a><span id="l47.2250">     mdd-&gt;messageBody-&gt;m_tmpFile = nullptr;</span>
<a href="#l47.2251"></a><span id="l47.2251" class="difflineat">@@ -1811,357 +1637,319 @@ mime_parse_stream_complete(nsMIMESession</span>
<a href="#l47.2252"></a><span id="l47.2252">   PR_FREEIF(to);</span>
<a href="#l47.2253"></a><span id="l47.2253">   PR_FREEIF(cc);</span>
<a href="#l47.2254"></a><span id="l47.2254">   PR_FREEIF(grps);</span>
<a href="#l47.2255"></a><span id="l47.2255">   PR_FREEIF(foll);</span>
<a href="#l47.2256"></a><span id="l47.2256">   PR_FREEIF(priority);</span>
<a href="#l47.2257"></a><span id="l47.2257">   PR_FREEIF(draftInfo);</span>
<a href="#l47.2258"></a><span id="l47.2258">   PR_Free(identityKey);</span>
<a href="#l47.2259"></a><span id="l47.2259"> </span>
<a href="#l47.2260"></a><span id="l47.2260" class="difflineminus">-  delete [] newAttachData;</span>
<a href="#l47.2261"></a><span id="l47.2261" class="difflineplus">+  delete[] newAttachData;</span>
<a href="#l47.2262"></a><span id="l47.2262"> }</span>
<a href="#l47.2263"></a><span id="l47.2263"> </span>
<a href="#l47.2264"></a><span id="l47.2264" class="difflineminus">-static void</span>
<a href="#l47.2265"></a><span id="l47.2265" class="difflineminus">-mime_parse_stream_abort(nsMIMESession *stream, int status)</span>
<a href="#l47.2266"></a><span id="l47.2266" class="difflineminus">-{</span>
<a href="#l47.2267"></a><span id="l47.2267" class="difflineplus">+static void mime_parse_stream_abort(nsMIMESession *stream, int status) {</span>
<a href="#l47.2268"></a><span id="l47.2268">   mime_draft_data *mdd = (mime_draft_data *)stream-&gt;data_object;</span>
<a href="#l47.2269"></a><span id="l47.2269">   NS_ASSERTION(mdd, &quot;null mime draft data&quot;);</span>
<a href="#l47.2270"></a><span id="l47.2270"> </span>
<a href="#l47.2271"></a><span id="l47.2271" class="difflineminus">-  if (!mdd)</span>
<a href="#l47.2272"></a><span id="l47.2272" class="difflineminus">-    return;</span>
<a href="#l47.2273"></a><span id="l47.2273" class="difflineplus">+  if (!mdd) return;</span>
<a href="#l47.2274"></a><span id="l47.2274"> </span>
<a href="#l47.2275"></a><span id="l47.2275" class="difflineminus">-  if (mdd-&gt;obj)</span>
<a href="#l47.2276"></a><span id="l47.2276" class="difflineminus">-  {</span>
<a href="#l47.2277"></a><span id="l47.2277" class="difflineminus">-    int status=0;</span>
<a href="#l47.2278"></a><span id="l47.2278" class="difflineplus">+  if (mdd-&gt;obj) {</span>
<a href="#l47.2279"></a><span id="l47.2279" class="difflineplus">+    int status = 0;</span>
<a href="#l47.2280"></a><span id="l47.2280"> </span>
<a href="#l47.2281"></a><span id="l47.2281">     if (!mdd-&gt;obj-&gt;closed_p)</span>
<a href="#l47.2282"></a><span id="l47.2282">       status = mdd-&gt;obj-&gt;clazz-&gt;parse_eof(mdd-&gt;obj, true);</span>
<a href="#l47.2283"></a><span id="l47.2283" class="difflineminus">-    if (!mdd-&gt;obj-&gt;parsed_p)</span>
<a href="#l47.2284"></a><span id="l47.2284" class="difflineminus">-      mdd-&gt;obj-&gt;clazz-&gt;parse_end(mdd-&gt;obj, true);</span>
<a href="#l47.2285"></a><span id="l47.2285" class="difflineplus">+    if (!mdd-&gt;obj-&gt;parsed_p) mdd-&gt;obj-&gt;clazz-&gt;parse_end(mdd-&gt;obj, true);</span>
<a href="#l47.2286"></a><span id="l47.2286"> </span>
<a href="#l47.2287"></a><span id="l47.2287" class="difflineminus">-    NS_ASSERTION(mdd-&gt;options == mdd-&gt;obj-&gt;options, &quot;draft display options not same as mime obj&quot;);</span>
<a href="#l47.2288"></a><span id="l47.2288" class="difflineminus">-    mime_free (mdd-&gt;obj);</span>
<a href="#l47.2289"></a><span id="l47.2289" class="difflineplus">+    NS_ASSERTION(mdd-&gt;options == mdd-&gt;obj-&gt;options,</span>
<a href="#l47.2290"></a><span id="l47.2290" class="difflineplus">+                 &quot;draft display options not same as mime obj&quot;);</span>
<a href="#l47.2291"></a><span id="l47.2291" class="difflineplus">+    mime_free(mdd-&gt;obj);</span>
<a href="#l47.2292"></a><span id="l47.2292">     mdd-&gt;obj = 0;</span>
<a href="#l47.2293"></a><span id="l47.2293" class="difflineminus">-    if (mdd-&gt;options)</span>
<a href="#l47.2294"></a><span id="l47.2294" class="difflineminus">-    {</span>
<a href="#l47.2295"></a><span id="l47.2295" class="difflineplus">+    if (mdd-&gt;options) {</span>
<a href="#l47.2296"></a><span id="l47.2296">       delete mdd-&gt;options;</span>
<a href="#l47.2297"></a><span id="l47.2297">       mdd-&gt;options = 0;</span>
<a href="#l47.2298"></a><span id="l47.2298">     }</span>
<a href="#l47.2299"></a><span id="l47.2299"> </span>
<a href="#l47.2300"></a><span id="l47.2300" class="difflineminus">-    if (mdd-&gt;stream)</span>
<a href="#l47.2301"></a><span id="l47.2301" class="difflineminus">-    {</span>
<a href="#l47.2302"></a><span id="l47.2302" class="difflineplus">+    if (mdd-&gt;stream) {</span>
<a href="#l47.2303"></a><span id="l47.2303">       mdd-&gt;stream-&gt;abort((nsMIMESession *)mdd-&gt;stream-&gt;data_object, status);</span>
<a href="#l47.2304"></a><span id="l47.2304">       PR_Free(mdd-&gt;stream);</span>
<a href="#l47.2305"></a><span id="l47.2305">       mdd-&gt;stream = 0;</span>
<a href="#l47.2306"></a><span id="l47.2306">     }</span>
<a href="#l47.2307"></a><span id="l47.2307">   }</span>
<a href="#l47.2308"></a><span id="l47.2308"> </span>
<a href="#l47.2309"></a><span id="l47.2309" class="difflineminus">-  if (mdd-&gt;headers)</span>
<a href="#l47.2310"></a><span id="l47.2310" class="difflineminus">-    MimeHeaders_free(mdd-&gt;headers);</span>
<a href="#l47.2311"></a><span id="l47.2311" class="difflineminus">-</span>
<a href="#l47.2312"></a><span id="l47.2312" class="difflineplus">+  if (mdd-&gt;headers) MimeHeaders_free(mdd-&gt;headers);</span>
<a href="#l47.2313"></a><span id="l47.2313"> </span>
<a href="#l47.2314"></a><span id="l47.2314">   mime_free_attachments(mdd-&gt;attachments);</span>
<a href="#l47.2315"></a><span id="l47.2315"> </span>
<a href="#l47.2316"></a><span id="l47.2316">   PR_FREEIF(mdd-&gt;mailcharset);</span>
<a href="#l47.2317"></a><span id="l47.2317"> </span>
<a href="#l47.2318"></a><span id="l47.2318">   PR_Free(mdd);</span>
<a href="#l47.2319"></a><span id="l47.2319"> }</span>
<a href="#l47.2320"></a><span id="l47.2320"> </span>
<a href="#l47.2321"></a><span id="l47.2321" class="difflineminus">-static int</span>
<a href="#l47.2322"></a><span id="l47.2322" class="difflineminus">-make_mime_headers_copy(void *closure, MimeHeaders *headers)</span>
<a href="#l47.2323"></a><span id="l47.2323" class="difflineminus">-{</span>
<a href="#l47.2324"></a><span id="l47.2324" class="difflineplus">+static int make_mime_headers_copy(void *closure, MimeHeaders *headers) {</span>
<a href="#l47.2325"></a><span id="l47.2325">   mime_draft_data *mdd = (mime_draft_data *)closure;</span>
<a href="#l47.2326"></a><span id="l47.2326"> </span>
<a href="#l47.2327"></a><span id="l47.2327">   NS_ASSERTION(mdd &amp;&amp; headers, &quot;null mime draft data and/or headers&quot;);</span>
<a href="#l47.2328"></a><span id="l47.2328"> </span>
<a href="#l47.2329"></a><span id="l47.2329" class="difflineminus">-  if (!mdd || ! headers)</span>
<a href="#l47.2330"></a><span id="l47.2330" class="difflineminus">-    return 0;</span>
<a href="#l47.2331"></a><span id="l47.2331" class="difflineplus">+  if (!mdd || !headers) return 0;</span>
<a href="#l47.2332"></a><span id="l47.2332"> </span>
<a href="#l47.2333"></a><span id="l47.2333" class="difflineminus">-  NS_ASSERTION(mdd-&gt;headers == NULL , &quot;non null mime draft data headers&quot;);</span>
<a href="#l47.2334"></a><span id="l47.2334" class="difflineplus">+  NS_ASSERTION(mdd-&gt;headers == NULL, &quot;non null mime draft data headers&quot;);</span>
<a href="#l47.2335"></a><span id="l47.2335"> </span>
<a href="#l47.2336"></a><span id="l47.2336">   mdd-&gt;headers = MimeHeaders_copy(headers);</span>
<a href="#l47.2337"></a><span id="l47.2337">   mdd-&gt;options-&gt;done_parsing_outer_headers = true;</span>
<a href="#l47.2338"></a><span id="l47.2338"> </span>
<a href="#l47.2339"></a><span id="l47.2339">   return 0;</span>
<a href="#l47.2340"></a><span id="l47.2340"> }</span>
<a href="#l47.2341"></a><span id="l47.2341"> </span>
<a href="#l47.2342"></a><span id="l47.2342" class="difflineminus">-int</span>
<a href="#l47.2343"></a><span id="l47.2343" class="difflineminus">-mime_decompose_file_init_fn(void *stream_closure, MimeHeaders *headers)</span>
<a href="#l47.2344"></a><span id="l47.2344" class="difflineminus">-{</span>
<a href="#l47.2345"></a><span id="l47.2345" class="difflineplus">+int mime_decompose_file_init_fn(void *stream_closure, MimeHeaders *headers) {</span>
<a href="#l47.2346"></a><span id="l47.2346">   mime_draft_data *mdd = (mime_draft_data *)stream_closure;</span>
<a href="#l47.2347"></a><span id="l47.2347">   nsMsgAttachedFile *newAttachment = 0;</span>
<a href="#l47.2348"></a><span id="l47.2348">   int nAttachments = 0;</span>
<a href="#l47.2349"></a><span id="l47.2349" class="difflineminus">-  //char *hdr_value = NULL;</span>
<a href="#l47.2350"></a><span id="l47.2350" class="difflineplus">+  // char *hdr_value = NULL;</span>
<a href="#l47.2351"></a><span id="l47.2351">   char *parm_value = NULL;</span>
<a href="#l47.2352"></a><span id="l47.2352">   bool creatingMsgBody = true;</span>
<a href="#l47.2353"></a><span id="l47.2353"> </span>
<a href="#l47.2354"></a><span id="l47.2354">   NS_ASSERTION(mdd &amp;&amp; headers, &quot;null mime draft data and/or headers&quot;);</span>
<a href="#l47.2355"></a><span id="l47.2355" class="difflineminus">-  if (!mdd || !headers)</span>
<a href="#l47.2356"></a><span id="l47.2356" class="difflineminus">-    return -1;</span>
<a href="#l47.2357"></a><span id="l47.2357" class="difflineplus">+  if (!mdd || !headers) return -1;</span>
<a href="#l47.2358"></a><span id="l47.2358"> </span>
<a href="#l47.2359"></a><span id="l47.2359" class="difflineminus">-  if (mdd-&gt;options-&gt;decompose_init_count)</span>
<a href="#l47.2360"></a><span id="l47.2360" class="difflineminus">-  {</span>
<a href="#l47.2361"></a><span id="l47.2361" class="difflineplus">+  if (mdd-&gt;options-&gt;decompose_init_count) {</span>
<a href="#l47.2362"></a><span id="l47.2362">     mdd-&gt;options-&gt;decompose_init_count++;</span>
<a href="#l47.2363"></a><span id="l47.2363" class="difflineminus">-    NS_ASSERTION(mdd-&gt;curAttachment, &quot;missing attachment in mime_decompose_file_init_fn&quot;);</span>
<a href="#l47.2364"></a><span id="l47.2364" class="difflineplus">+    NS_ASSERTION(mdd-&gt;curAttachment,</span>
<a href="#l47.2365"></a><span id="l47.2365" class="difflineplus">+                 &quot;missing attachment in mime_decompose_file_init_fn&quot;);</span>
<a href="#l47.2366"></a><span id="l47.2366">     if (mdd-&gt;curAttachment)</span>
<a href="#l47.2367"></a><span id="l47.2367" class="difflineminus">-      mdd-&gt;curAttachment-&gt;m_type.Adopt(MimeHeaders_get(headers,</span>
<a href="#l47.2368"></a><span id="l47.2368" class="difflineminus">-                                                       HEADER_CONTENT_TYPE,</span>
<a href="#l47.2369"></a><span id="l47.2369" class="difflineminus">-                                                       false, true));</span>
<a href="#l47.2370"></a><span id="l47.2370" class="difflineplus">+      mdd-&gt;curAttachment-&gt;m_type.Adopt(</span>
<a href="#l47.2371"></a><span id="l47.2371" class="difflineplus">+          MimeHeaders_get(headers, HEADER_CONTENT_TYPE, false, true));</span>
<a href="#l47.2372"></a><span id="l47.2372">     return 0;</span>
<a href="#l47.2373"></a><span id="l47.2373" class="difflineminus">-  }</span>
<a href="#l47.2374"></a><span id="l47.2374" class="difflineminus">-  else</span>
<a href="#l47.2375"></a><span id="l47.2375" class="difflineplus">+  } else</span>
<a href="#l47.2376"></a><span id="l47.2376">     mdd-&gt;options-&gt;decompose_init_count++;</span>
<a href="#l47.2377"></a><span id="l47.2377"> </span>
<a href="#l47.2378"></a><span id="l47.2378">   nAttachments = mdd-&gt;attachments.Length();</span>
<a href="#l47.2379"></a><span id="l47.2379"> </span>
<a href="#l47.2380"></a><span id="l47.2380" class="difflineminus">-  if (!nAttachments &amp;&amp; !mdd-&gt;messageBody)</span>
<a href="#l47.2381"></a><span id="l47.2381" class="difflineminus">-  {</span>
<a href="#l47.2382"></a><span id="l47.2382" class="difflineminus">-    // if we've been told to use an override charset then do so....otherwise use the charset</span>
<a href="#l47.2383"></a><span id="l47.2383" class="difflineminus">-    // inside the message header...</span>
<a href="#l47.2384"></a><span id="l47.2384" class="difflineplus">+  if (!nAttachments &amp;&amp; !mdd-&gt;messageBody) {</span>
<a href="#l47.2385"></a><span id="l47.2385" class="difflineplus">+    // if we've been told to use an override charset then do so....otherwise use</span>
<a href="#l47.2386"></a><span id="l47.2386" class="difflineplus">+    // the charset inside the message header...</span>
<a href="#l47.2387"></a><span id="l47.2387">     if (mdd-&gt;options &amp;&amp; mdd-&gt;options-&gt;override_charset)</span>
<a href="#l47.2388"></a><span id="l47.2388" class="difflineminus">-        mdd-&gt;mailcharset = strdup(mdd-&gt;options-&gt;default_charset);</span>
<a href="#l47.2389"></a><span id="l47.2389" class="difflineminus">-    else</span>
<a href="#l47.2390"></a><span id="l47.2390" class="difflineminus">-    {</span>
<a href="#l47.2391"></a><span id="l47.2391" class="difflineplus">+      mdd-&gt;mailcharset = strdup(mdd-&gt;options-&gt;default_charset);</span>
<a href="#l47.2392"></a><span id="l47.2392" class="difflineplus">+    else {</span>
<a href="#l47.2393"></a><span id="l47.2393">       char *contentType;</span>
<a href="#l47.2394"></a><span id="l47.2394">       contentType = MimeHeaders_get(headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l47.2395"></a><span id="l47.2395" class="difflineminus">-      if (contentType)</span>
<a href="#l47.2396"></a><span id="l47.2396" class="difflineminus">-      {</span>
<a href="#l47.2397"></a><span id="l47.2397" class="difflineminus">-        mdd-&gt;mailcharset = MimeHeaders_get_parameter(contentType, &quot;charset&quot;, NULL, NULL);</span>
<a href="#l47.2398"></a><span id="l47.2398" class="difflineplus">+      if (contentType) {</span>
<a href="#l47.2399"></a><span id="l47.2399" class="difflineplus">+        mdd-&gt;mailcharset =</span>
<a href="#l47.2400"></a><span id="l47.2400" class="difflineplus">+            MimeHeaders_get_parameter(contentType, &quot;charset&quot;, NULL, NULL);</span>
<a href="#l47.2401"></a><span id="l47.2401">         PR_FREEIF(contentType);</span>
<a href="#l47.2402"></a><span id="l47.2402">       }</span>
<a href="#l47.2403"></a><span id="l47.2403">     }</span>
<a href="#l47.2404"></a><span id="l47.2404"> </span>
<a href="#l47.2405"></a><span id="l47.2405">     mdd-&gt;messageBody = new nsMsgAttachedFile;</span>
<a href="#l47.2406"></a><span id="l47.2406" class="difflineminus">-    if (!mdd-&gt;messageBody)</span>
<a href="#l47.2407"></a><span id="l47.2407" class="difflineminus">-      return MIME_OUT_OF_MEMORY;</span>
<a href="#l47.2408"></a><span id="l47.2408" class="difflineplus">+    if (!mdd-&gt;messageBody) return MIME_OUT_OF_MEMORY;</span>
<a href="#l47.2409"></a><span id="l47.2409">     newAttachment = mdd-&gt;messageBody;</span>
<a href="#l47.2410"></a><span id="l47.2410">     creatingMsgBody = true;</span>
<a href="#l47.2411"></a><span id="l47.2411" class="difflineminus">-  }</span>
<a href="#l47.2412"></a><span id="l47.2412" class="difflineminus">-  else</span>
<a href="#l47.2413"></a><span id="l47.2413" class="difflineminus">-  {</span>
<a href="#l47.2414"></a><span id="l47.2414" class="difflineplus">+  } else {</span>
<a href="#l47.2415"></a><span id="l47.2415">     /* always allocate one more extra; don't ask me why */</span>
<a href="#l47.2416"></a><span id="l47.2416">     newAttachment = new nsMsgAttachedFile;</span>
<a href="#l47.2417"></a><span id="l47.2417" class="difflineminus">-    if (!newAttachment)</span>
<a href="#l47.2418"></a><span id="l47.2418" class="difflineminus">-      return MIME_OUT_OF_MEMORY;</span>
<a href="#l47.2419"></a><span id="l47.2419" class="difflineplus">+    if (!newAttachment) return MIME_OUT_OF_MEMORY;</span>
<a href="#l47.2420"></a><span id="l47.2420">     mdd-&gt;attachments.AppendElement(newAttachment);</span>
<a href="#l47.2421"></a><span id="l47.2421">   }</span>
<a href="#l47.2422"></a><span id="l47.2422"> </span>
<a href="#l47.2423"></a><span id="l47.2423">   char *workURLSpec = nullptr;</span>
<a href="#l47.2424"></a><span id="l47.2424">   char *contLoc = nullptr;</span>
<a href="#l47.2425"></a><span id="l47.2425"> </span>
<a href="#l47.2426"></a><span id="l47.2426">   newAttachment-&gt;m_realName.Adopt(MimeHeaders_get_name(headers, mdd-&gt;options));</span>
<a href="#l47.2427"></a><span id="l47.2427">   contLoc = MimeHeaders_get(headers, HEADER_CONTENT_LOCATION, false, false);</span>
<a href="#l47.2428"></a><span id="l47.2428">   if (!contLoc)</span>
<a href="#l47.2429"></a><span id="l47.2429" class="difflineminus">-      contLoc = MimeHeaders_get(headers, HEADER_CONTENT_BASE, false, false);</span>
<a href="#l47.2430"></a><span id="l47.2430" class="difflineplus">+    contLoc = MimeHeaders_get(headers, HEADER_CONTENT_BASE, false, false);</span>
<a href="#l47.2431"></a><span id="l47.2431"> </span>
<a href="#l47.2432"></a><span id="l47.2432">   if (!contLoc &amp;&amp; !newAttachment-&gt;m_realName.IsEmpty())</span>
<a href="#l47.2433"></a><span id="l47.2433">     workURLSpec = ToNewCString(newAttachment-&gt;m_realName);</span>
<a href="#l47.2434"></a><span id="l47.2434" class="difflineminus">-  if (contLoc &amp;&amp; !workURLSpec)</span>
<a href="#l47.2435"></a><span id="l47.2435" class="difflineminus">-    workURLSpec = strdup(contLoc);</span>
<a href="#l47.2436"></a><span id="l47.2436" class="difflineplus">+  if (contLoc &amp;&amp; !workURLSpec) workURLSpec = strdup(contLoc);</span>
<a href="#l47.2437"></a><span id="l47.2437"> </span>
<a href="#l47.2438"></a><span id="l47.2438">   PR_FREEIF(contLoc);</span>
<a href="#l47.2439"></a><span id="l47.2439"> </span>
<a href="#l47.2440"></a><span id="l47.2440">   mdd-&gt;curAttachment = newAttachment;</span>
<a href="#l47.2441"></a><span id="l47.2441" class="difflineminus">-  newAttachment-&gt;m_type.Adopt(MimeHeaders_get(headers, HEADER_CONTENT_TYPE, false, false));</span>
<a href="#l47.2442"></a><span id="l47.2442" class="difflineplus">+  newAttachment-&gt;m_type.Adopt(</span>
<a href="#l47.2443"></a><span id="l47.2443" class="difflineplus">+      MimeHeaders_get(headers, HEADER_CONTENT_TYPE, false, false));</span>
<a href="#l47.2444"></a><span id="l47.2444"> </span>
<a href="#l47.2445"></a><span id="l47.2445">   //</span>
<a href="#l47.2446"></a><span id="l47.2446">   // This is to handle the degenerated Apple Double attachment.</span>
<a href="#l47.2447"></a><span id="l47.2447">   //</span>
<a href="#l47.2448"></a><span id="l47.2448">   parm_value = MimeHeaders_get(headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l47.2449"></a><span id="l47.2449" class="difflineminus">-  if (parm_value)</span>
<a href="#l47.2450"></a><span id="l47.2450" class="difflineminus">-  {</span>
<a href="#l47.2451"></a><span id="l47.2451" class="difflineplus">+  if (parm_value) {</span>
<a href="#l47.2452"></a><span id="l47.2452">     char *boundary = NULL;</span>
<a href="#l47.2453"></a><span id="l47.2453">     char *tmp_value = NULL;</span>
<a href="#l47.2454"></a><span id="l47.2454">     boundary = MimeHeaders_get_parameter(parm_value, &quot;boundary&quot;, NULL, NULL);</span>
<a href="#l47.2455"></a><span id="l47.2455" class="difflineminus">-    if (boundary)</span>
<a href="#l47.2456"></a><span id="l47.2456" class="difflineminus">-      tmp_value = PR_smprintf(&quot;; boundary=\&quot;%s\&quot;&quot;, boundary);</span>
<a href="#l47.2457"></a><span id="l47.2457" class="difflineminus">-    if (tmp_value)</span>
<a href="#l47.2458"></a><span id="l47.2458" class="difflineminus">-      newAttachment-&gt;m_type = tmp_value;</span>
<a href="#l47.2459"></a><span id="l47.2459" class="difflineplus">+    if (boundary) tmp_value = PR_smprintf(&quot;; boundary=\&quot;%s\&quot;&quot;, boundary);</span>
<a href="#l47.2460"></a><span id="l47.2460" class="difflineplus">+    if (tmp_value) newAttachment-&gt;m_type = tmp_value;</span>
<a href="#l47.2461"></a><span id="l47.2461">     newAttachment-&gt;m_xMacType.Adopt(</span>
<a href="#l47.2462"></a><span id="l47.2462" class="difflineminus">-      MimeHeaders_get_parameter(parm_value, &quot;x-mac-type&quot;, NULL, NULL));</span>
<a href="#l47.2463"></a><span id="l47.2463" class="difflineplus">+        MimeHeaders_get_parameter(parm_value, &quot;x-mac-type&quot;, NULL, NULL));</span>
<a href="#l47.2464"></a><span id="l47.2464">     newAttachment-&gt;m_xMacCreator.Adopt(</span>
<a href="#l47.2465"></a><span id="l47.2465" class="difflineminus">-      MimeHeaders_get_parameter(parm_value, &quot;x-mac-creator&quot;, NULL, NULL));</span>
<a href="#l47.2466"></a><span id="l47.2466" class="difflineplus">+        MimeHeaders_get_parameter(parm_value, &quot;x-mac-creator&quot;, NULL, NULL));</span>
<a href="#l47.2467"></a><span id="l47.2467">     PR_FREEIF(parm_value);</span>
<a href="#l47.2468"></a><span id="l47.2468">     PR_FREEIF(boundary);</span>
<a href="#l47.2469"></a><span id="l47.2469">     PR_FREEIF(tmp_value);</span>
<a href="#l47.2470"></a><span id="l47.2470">   }</span>
<a href="#l47.2471"></a><span id="l47.2471"> </span>
<a href="#l47.2472"></a><span id="l47.2472">   newAttachment-&gt;m_size = 0;</span>
<a href="#l47.2473"></a><span id="l47.2473" class="difflineminus">-  newAttachment-&gt;m_encoding.Adopt(MimeHeaders_get(headers, HEADER_CONTENT_TRANSFER_ENCODING,</span>
<a href="#l47.2474"></a><span id="l47.2474" class="difflineminus">-                                                  false, false));</span>
<a href="#l47.2475"></a><span id="l47.2475" class="difflineminus">-  newAttachment-&gt;m_description.Adopt(MimeHeaders_get(headers, HEADER_CONTENT_DESCRIPTION,</span>
<a href="#l47.2476"></a><span id="l47.2476" class="difflineminus">-                                                     false, false));</span>
<a href="#l47.2477"></a><span id="l47.2477" class="difflineplus">+  newAttachment-&gt;m_encoding.Adopt(</span>
<a href="#l47.2478"></a><span id="l47.2478" class="difflineplus">+      MimeHeaders_get(headers, HEADER_CONTENT_TRANSFER_ENCODING, false, false));</span>
<a href="#l47.2479"></a><span id="l47.2479" class="difflineplus">+  newAttachment-&gt;m_description.Adopt(</span>
<a href="#l47.2480"></a><span id="l47.2480" class="difflineplus">+      MimeHeaders_get(headers, HEADER_CONTENT_DESCRIPTION, false, false));</span>
<a href="#l47.2481"></a><span id="l47.2481">   //</span>
<a href="#l47.2482"></a><span id="l47.2482" class="difflineminus">-  // If we came up empty for description or the orig URL, we should do something about it.</span>
<a href="#l47.2483"></a><span id="l47.2483" class="difflineplus">+  // If we came up empty for description or the orig URL, we should do something</span>
<a href="#l47.2484"></a><span id="l47.2484" class="difflineplus">+  // about it.</span>
<a href="#l47.2485"></a><span id="l47.2485">   //</span>
<a href="#l47.2486"></a><span id="l47.2486">   if (newAttachment-&gt;m_description.IsEmpty() &amp;&amp; workURLSpec)</span>
<a href="#l47.2487"></a><span id="l47.2487">     newAttachment-&gt;m_description = workURLSpec;</span>
<a href="#l47.2488"></a><span id="l47.2488"> </span>
<a href="#l47.2489"></a><span id="l47.2489" class="difflineminus">-  PR_FREEIF(workURLSpec);     // resource leak otherwise</span>
<a href="#l47.2490"></a><span id="l47.2490" class="difflineplus">+  PR_FREEIF(workURLSpec);  // resource leak otherwise</span>
<a href="#l47.2491"></a><span id="l47.2491"> </span>
<a href="#l47.2492"></a><span id="l47.2492" class="difflineminus">-  newAttachment-&gt;m_cloudPartInfo.Adopt(MimeHeaders_get(headers,</span>
<a href="#l47.2493"></a><span id="l47.2493" class="difflineminus">-                                       HEADER_X_MOZILLA_CLOUD_PART,</span>
<a href="#l47.2494"></a><span id="l47.2494" class="difflineminus">-                                       false, false));</span>
<a href="#l47.2495"></a><span id="l47.2495" class="difflineplus">+  newAttachment-&gt;m_cloudPartInfo.Adopt(</span>
<a href="#l47.2496"></a><span id="l47.2496" class="difflineplus">+      MimeHeaders_get(headers, HEADER_X_MOZILLA_CLOUD_PART, false, false));</span>
<a href="#l47.2497"></a><span id="l47.2497"> </span>
<a href="#l47.2498"></a><span id="l47.2498">   // There's no file in the message if it's a cloud part.</span>
<a href="#l47.2499"></a><span id="l47.2499" class="difflineminus">-  if (!newAttachment-&gt;m_cloudPartInfo.IsEmpty())</span>
<a href="#l47.2500"></a><span id="l47.2500" class="difflineminus">-  {</span>
<a href="#l47.2501"></a><span id="l47.2501" class="difflineplus">+  if (!newAttachment-&gt;m_cloudPartInfo.IsEmpty()) {</span>
<a href="#l47.2502"></a><span id="l47.2502">     nsAutoCString fileURL;</span>
<a href="#l47.2503"></a><span id="l47.2503" class="difflineminus">-    fileURL.Adopt(</span>
<a href="#l47.2504"></a><span id="l47.2504" class="difflineminus">-      MimeHeaders_get_parameter(newAttachment-&gt;m_cloudPartInfo.get(), &quot;file&quot;,</span>
<a href="#l47.2505"></a><span id="l47.2505" class="difflineminus">-                                nullptr, nullptr));</span>
<a href="#l47.2506"></a><span id="l47.2506" class="difflineplus">+    fileURL.Adopt(MimeHeaders_get_parameter(</span>
<a href="#l47.2507"></a><span id="l47.2507" class="difflineplus">+        newAttachment-&gt;m_cloudPartInfo.get(), &quot;file&quot;, nullptr, nullptr));</span>
<a href="#l47.2508"></a><span id="l47.2508">     if (!fileURL.IsEmpty())</span>
<a href="#l47.2509"></a><span id="l47.2509">       nsMimeNewURI(getter_AddRefs(newAttachment-&gt;m_origUrl), fileURL.get(),</span>
<a href="#l47.2510"></a><span id="l47.2510">                    nullptr);</span>
<a href="#l47.2511"></a><span id="l47.2511">     mdd-&gt;tmpFile = nullptr;</span>
<a href="#l47.2512"></a><span id="l47.2512">     return 0;</span>
<a href="#l47.2513"></a><span id="l47.2513">   }</span>
<a href="#l47.2514"></a><span id="l47.2514"> </span>
<a href="#l47.2515"></a><span id="l47.2515">   nsCOMPtr&lt;nsIFile&gt; tmpFile = nullptr;</span>
<a href="#l47.2516"></a><span id="l47.2516">   {</span>
<a href="#l47.2517"></a><span id="l47.2517" class="difflineminus">-    // Let's build a temp file with an extension based on the content-type: nsmail.&lt;extension&gt;</span>
<a href="#l47.2518"></a><span id="l47.2518" class="difflineplus">+    // Let's build a temp file with an extension based on the content-type:</span>
<a href="#l47.2519"></a><span id="l47.2519" class="difflineplus">+    // nsmail.&lt;extension&gt;</span>
<a href="#l47.2520"></a><span id="l47.2520"> </span>
<a href="#l47.2521"></a><span id="l47.2521">     nsAutoCString newAttachName(&quot;nsmail&quot;);</span>
<a href="#l47.2522"></a><span id="l47.2522">     bool extensionAdded = false;</span>
<a href="#l47.2523"></a><span id="l47.2523" class="difflineminus">-    // the content type may contain a charset. i.e. text/html; ISO-2022-JP...we want to strip off the charset</span>
<a href="#l47.2524"></a><span id="l47.2524" class="difflineminus">-    // before we ask the mime service for a mime info for this content type.</span>
<a href="#l47.2525"></a><span id="l47.2525" class="difflineplus">+    // the content type may contain a charset. i.e. text/html; ISO-2022-JP...we</span>
<a href="#l47.2526"></a><span id="l47.2526" class="difflineplus">+    // want to strip off the charset before we ask the mime service for a mime</span>
<a href="#l47.2527"></a><span id="l47.2527" class="difflineplus">+    // info for this content type.</span>
<a href="#l47.2528"></a><span id="l47.2528">     nsAutoCString contentType(newAttachment-&gt;m_type);</span>
<a href="#l47.2529"></a><span id="l47.2529">     int32_t pos = contentType.FindChar(';');</span>
<a href="#l47.2530"></a><span id="l47.2530" class="difflineminus">-    if (pos &gt; 0)</span>
<a href="#l47.2531"></a><span id="l47.2531" class="difflineminus">-      contentType.SetLength(pos);</span>
<a href="#l47.2532"></a><span id="l47.2532" class="difflineplus">+    if (pos &gt; 0) contentType.SetLength(pos);</span>
<a href="#l47.2533"></a><span id="l47.2533">     nsresult rv = NS_OK;</span>
<a href="#l47.2534"></a><span id="l47.2534" class="difflineminus">-    nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder(do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l47.2535"></a><span id="l47.2535" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder)</span>
<a href="#l47.2536"></a><span id="l47.2536" class="difflineminus">-    {</span>
<a href="#l47.2537"></a><span id="l47.2537" class="difflineplus">+    nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder(</span>
<a href="#l47.2538"></a><span id="l47.2538" class="difflineplus">+        do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l47.2539"></a><span id="l47.2539" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder) {</span>
<a href="#l47.2540"></a><span id="l47.2540">       nsAutoCString fileExtension;</span>
<a href="#l47.2541"></a><span id="l47.2541" class="difflineminus">-      rv = mimeFinder-&gt;GetPrimaryExtension(contentType, EmptyCString(), fileExtension);</span>
<a href="#l47.2542"></a><span id="l47.2542" class="difflineplus">+      rv = mimeFinder-&gt;GetPrimaryExtension(contentType, EmptyCString(),</span>
<a href="#l47.2543"></a><span id="l47.2543" class="difflineplus">+                                           fileExtension);</span>
<a href="#l47.2544"></a><span id="l47.2544"> </span>
<a href="#l47.2545"></a><span id="l47.2545" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !fileExtension.IsEmpty())</span>
<a href="#l47.2546"></a><span id="l47.2546" class="difflineminus">-      {</span>
<a href="#l47.2547"></a><span id="l47.2547" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; !fileExtension.IsEmpty()) {</span>
<a href="#l47.2548"></a><span id="l47.2548">         newAttachName.Append('.');</span>
<a href="#l47.2549"></a><span id="l47.2549">         newAttachName.Append(fileExtension);</span>
<a href="#l47.2550"></a><span id="l47.2550">         extensionAdded = true;</span>
<a href="#l47.2551"></a><span id="l47.2551">       }</span>
<a href="#l47.2552"></a><span id="l47.2552">     }</span>
<a href="#l47.2553"></a><span id="l47.2553"> </span>
<a href="#l47.2554"></a><span id="l47.2554" class="difflineminus">-    if (!extensionAdded)</span>
<a href="#l47.2555"></a><span id="l47.2555" class="difflineminus">-    {</span>
<a href="#l47.2556"></a><span id="l47.2556" class="difflineplus">+    if (!extensionAdded) {</span>
<a href="#l47.2557"></a><span id="l47.2557">       newAttachName.AppendLiteral(&quot;.tmp&quot;);</span>
<a href="#l47.2558"></a><span id="l47.2558">     }</span>
<a href="#l47.2559"></a><span id="l47.2559"> </span>
<a href="#l47.2560"></a><span id="l47.2560">     nsMsgCreateTempFile(newAttachName.get(), getter_AddRefs(tmpFile));</span>
<a href="#l47.2561"></a><span id="l47.2561">   }</span>
<a href="#l47.2562"></a><span id="l47.2562">   nsresult rv;</span>
<a href="#l47.2563"></a><span id="l47.2563"> </span>
<a href="#l47.2564"></a><span id="l47.2564">   // This needs to be done so the attachment structure has a handle</span>
<a href="#l47.2565"></a><span id="l47.2565">   // on the temp file for this attachment...</span>
<a href="#l47.2566"></a><span id="l47.2566" class="difflineminus">-  if (tmpFile)</span>
<a href="#l47.2567"></a><span id="l47.2567" class="difflineminus">-  {</span>
<a href="#l47.2568"></a><span id="l47.2568" class="difflineminus">-      nsAutoCString fileURL;</span>
<a href="#l47.2569"></a><span id="l47.2569" class="difflineminus">-      rv = NS_GetURLSpecFromFile(tmpFile, fileURL);</span>
<a href="#l47.2570"></a><span id="l47.2570" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l47.2571"></a><span id="l47.2571" class="difflineminus">-        nsMimeNewURI(getter_AddRefs(newAttachment-&gt;m_origUrl),</span>
<a href="#l47.2572"></a><span id="l47.2572" class="difflineminus">-                     fileURL.get(), nullptr);</span>
<a href="#l47.2573"></a><span id="l47.2573" class="difflineplus">+  if (tmpFile) {</span>
<a href="#l47.2574"></a><span id="l47.2574" class="difflineplus">+    nsAutoCString fileURL;</span>
<a href="#l47.2575"></a><span id="l47.2575" class="difflineplus">+    rv = NS_GetURLSpecFromFile(tmpFile, fileURL);</span>
<a href="#l47.2576"></a><span id="l47.2576" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l47.2577"></a><span id="l47.2577" class="difflineplus">+      nsMimeNewURI(getter_AddRefs(newAttachment-&gt;m_origUrl), fileURL.get(),</span>
<a href="#l47.2578"></a><span id="l47.2578" class="difflineplus">+                   nullptr);</span>
<a href="#l47.2579"></a><span id="l47.2579">   }</span>
<a href="#l47.2580"></a><span id="l47.2580"> </span>
<a href="#l47.2581"></a><span id="l47.2581" class="difflineminus">-  if (!tmpFile)</span>
<a href="#l47.2582"></a><span id="l47.2582" class="difflineminus">-    return MIME_OUT_OF_MEMORY;</span>
<a href="#l47.2583"></a><span id="l47.2583" class="difflineplus">+  if (!tmpFile) return MIME_OUT_OF_MEMORY;</span>
<a href="#l47.2584"></a><span id="l47.2584"> </span>
<a href="#l47.2585"></a><span id="l47.2585">   mdd-&gt;tmpFile = tmpFile;</span>
<a href="#l47.2586"></a><span id="l47.2586"> </span>
<a href="#l47.2587"></a><span id="l47.2587">   newAttachment-&gt;m_tmpFile = mdd-&gt;tmpFile;</span>
<a href="#l47.2588"></a><span id="l47.2588"> </span>
<a href="#l47.2589"></a><span id="l47.2589" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mdd-&gt;tmpFileStream), tmpFile,PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l47.2590"></a><span id="l47.2590" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l47.2591"></a><span id="l47.2591" class="difflineminus">-    return MIME_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l47.2592"></a><span id="l47.2592" class="difflineplus">+  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mdd-&gt;tmpFileStream),</span>
<a href="#l47.2593"></a><span id="l47.2593" class="difflineplus">+                                      tmpFile, PR_WRONLY | PR_CREATE_FILE,</span>
<a href="#l47.2594"></a><span id="l47.2594" class="difflineplus">+                                      00600);</span>
<a href="#l47.2595"></a><span id="l47.2595" class="difflineplus">+  if (NS_FAILED(rv)) return MIME_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l47.2596"></a><span id="l47.2596"> </span>
<a href="#l47.2597"></a><span id="l47.2597">   // For now, we are always going to decode all of the attachments</span>
<a href="#l47.2598"></a><span id="l47.2598">   // for the message. This way, we have native data</span>
<a href="#l47.2599"></a><span id="l47.2599" class="difflineminus">-  if (creatingMsgBody)</span>
<a href="#l47.2600"></a><span id="l47.2600" class="difflineminus">-  {</span>
<a href="#l47.2601"></a><span id="l47.2601" class="difflineminus">-    MimeDecoderData *(*fn) (MimeConverterOutputCallback, void*) = 0;</span>
<a href="#l47.2602"></a><span id="l47.2602" class="difflineplus">+  if (creatingMsgBody) {</span>
<a href="#l47.2603"></a><span id="l47.2603" class="difflineplus">+    MimeDecoderData *(*fn)(MimeConverterOutputCallback, void *) = 0;</span>
<a href="#l47.2604"></a><span id="l47.2604"> </span>
<a href="#l47.2605"></a><span id="l47.2605">     //</span>
<a href="#l47.2606"></a><span id="l47.2606">     // Initialize a decoder if necessary.</span>
<a href="#l47.2607"></a><span id="l47.2607">     //</span>
<a href="#l47.2608"></a><span id="l47.2608">     if (newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64))</span>
<a href="#l47.2609"></a><span id="l47.2609">       fn = &amp;MimeB64DecoderInit;</span>
<a href="#l47.2610"></a><span id="l47.2610" class="difflineminus">-    else if (newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l47.2611"></a><span id="l47.2611" class="difflineminus">-    {</span>
<a href="#l47.2612"></a><span id="l47.2612" class="difflineminus">-      mdd-&gt;decoder_data = MimeQPDecoderInit (/* The (MimeConverterOutputCallback) cast is to turn the `void' argument into `MimeObject'. */</span>
<a href="#l47.2613"></a><span id="l47.2613" class="difflineminus">-                              ((MimeConverterOutputCallback) dummy_file_write),</span>
<a href="#l47.2614"></a><span id="l47.2614" class="difflineminus">-                              mdd-&gt;tmpFileStream);</span>
<a href="#l47.2615"></a><span id="l47.2615" class="difflineminus">-      if (!mdd-&gt;decoder_data)</span>
<a href="#l47.2616"></a><span id="l47.2616" class="difflineminus">-        return MIME_OUT_OF_MEMORY;</span>
<a href="#l47.2617"></a><span id="l47.2617" class="difflineminus">-    }</span>
<a href="#l47.2618"></a><span id="l47.2618" class="difflineminus">-    else if (newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE) ||</span>
<a href="#l47.2619"></a><span id="l47.2619" class="difflineminus">-             newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE2) ||</span>
<a href="#l47.2620"></a><span id="l47.2620" class="difflineminus">-             newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE3) ||</span>
<a href="#l47.2621"></a><span id="l47.2621" class="difflineminus">-             newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE4))</span>
<a href="#l47.2622"></a><span id="l47.2622" class="difflineplus">+    else if (newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(</span>
<a href="#l47.2623"></a><span id="l47.2623" class="difflineplus">+                 ENCODING_QUOTED_PRINTABLE)) {</span>
<a href="#l47.2624"></a><span id="l47.2624" class="difflineplus">+      mdd-&gt;decoder_data =</span>
<a href="#l47.2625"></a><span id="l47.2625" class="difflineplus">+          MimeQPDecoderInit(/* The (MimeConverterOutputCallback) cast is to turn</span>
<a href="#l47.2626"></a><span id="l47.2626" class="difflineplus">+                               the `void' argument into `MimeObject'. */</span>
<a href="#l47.2627"></a><span id="l47.2627" class="difflineplus">+                            ((MimeConverterOutputCallback)dummy_file_write),</span>
<a href="#l47.2628"></a><span id="l47.2628" class="difflineplus">+                            mdd-&gt;tmpFileStream);</span>
<a href="#l47.2629"></a><span id="l47.2629" class="difflineplus">+      if (!mdd-&gt;decoder_data) return MIME_OUT_OF_MEMORY;</span>
<a href="#l47.2630"></a><span id="l47.2630" class="difflineplus">+    } else if (newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(</span>
<a href="#l47.2631"></a><span id="l47.2631" class="difflineplus">+                   ENCODING_UUENCODE) ||</span>
<a href="#l47.2632"></a><span id="l47.2632" class="difflineplus">+               newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(</span>
<a href="#l47.2633"></a><span id="l47.2633" class="difflineplus">+                   ENCODING_UUENCODE2) ||</span>
<a href="#l47.2634"></a><span id="l47.2634" class="difflineplus">+               newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(</span>
<a href="#l47.2635"></a><span id="l47.2635" class="difflineplus">+                   ENCODING_UUENCODE3) ||</span>
<a href="#l47.2636"></a><span id="l47.2636" class="difflineplus">+               newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(</span>
<a href="#l47.2637"></a><span id="l47.2637" class="difflineplus">+                   ENCODING_UUENCODE4))</span>
<a href="#l47.2638"></a><span id="l47.2638">       fn = &amp;MimeUUDecoderInit;</span>
<a href="#l47.2639"></a><span id="l47.2639">     else if (newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_YENCODE))</span>
<a href="#l47.2640"></a><span id="l47.2640">       fn = &amp;MimeYDecoderInit;</span>
<a href="#l47.2641"></a><span id="l47.2641"> </span>
<a href="#l47.2642"></a><span id="l47.2642" class="difflineminus">-    if (fn)</span>
<a href="#l47.2643"></a><span id="l47.2643" class="difflineminus">-    {</span>
<a href="#l47.2644"></a><span id="l47.2644" class="difflineminus">-      mdd-&gt;decoder_data = fn (/* The (MimeConverterOutputCallback) cast is to</span>
<a href="#l47.2645"></a><span id="l47.2645" class="difflineminus">-                                 turn the `void' argument into `MimeObject'. */</span>
<a href="#l47.2646"></a><span id="l47.2646" class="difflineminus">-                              ((MimeConverterOutputCallback)dummy_file_write),</span>
<a href="#l47.2647"></a><span id="l47.2647" class="difflineminus">-                              mdd-&gt;tmpFileStream);</span>
<a href="#l47.2648"></a><span id="l47.2648" class="difflineminus">-      if (!mdd-&gt;decoder_data)</span>
<a href="#l47.2649"></a><span id="l47.2649" class="difflineminus">-        return MIME_OUT_OF_MEMORY;</span>
<a href="#l47.2650"></a><span id="l47.2650" class="difflineplus">+    if (fn) {</span>
<a href="#l47.2651"></a><span id="l47.2651" class="difflineplus">+      mdd-&gt;decoder_data = fn(/* The (MimeConverterOutputCallback) cast is to</span>
<a href="#l47.2652"></a><span id="l47.2652" class="difflineplus">+                                turn the `void' argument into `MimeObject'. */</span>
<a href="#l47.2653"></a><span id="l47.2653" class="difflineplus">+                             ((MimeConverterOutputCallback)dummy_file_write),</span>
<a href="#l47.2654"></a><span id="l47.2654" class="difflineplus">+                             mdd-&gt;tmpFileStream);</span>
<a href="#l47.2655"></a><span id="l47.2655" class="difflineplus">+      if (!mdd-&gt;decoder_data) return MIME_OUT_OF_MEMORY;</span>
<a href="#l47.2656"></a><span id="l47.2656">     }</span>
<a href="#l47.2657"></a><span id="l47.2657">   }</span>
<a href="#l47.2658"></a><span id="l47.2658"> </span>
<a href="#l47.2659"></a><span id="l47.2659">   return 0;</span>
<a href="#l47.2660"></a><span id="l47.2660"> }</span>
<a href="#l47.2661"></a><span id="l47.2661"> </span>
<a href="#l47.2662"></a><span id="l47.2662" class="difflineminus">-int</span>
<a href="#l47.2663"></a><span id="l47.2663" class="difflineminus">-mime_decompose_file_output_fn(const char *buf,</span>
<a href="#l47.2664"></a><span id="l47.2664" class="difflineminus">-                              int32_t size,</span>
<a href="#l47.2665"></a><span id="l47.2665" class="difflineminus">-                              void *stream_closure)</span>
<a href="#l47.2666"></a><span id="l47.2666" class="difflineminus">-{</span>
<a href="#l47.2667"></a><span id="l47.2667" class="difflineplus">+int mime_decompose_file_output_fn(const char *buf, int32_t size,</span>
<a href="#l47.2668"></a><span id="l47.2668" class="difflineplus">+                                  void *stream_closure) {</span>
<a href="#l47.2669"></a><span id="l47.2669">   mime_draft_data *mdd = (mime_draft_data *)stream_closure;</span>
<a href="#l47.2670"></a><span id="l47.2670">   int ret = 0;</span>
<a href="#l47.2671"></a><span id="l47.2671"> </span>
<a href="#l47.2672"></a><span id="l47.2672">   NS_ASSERTION(mdd &amp;&amp; buf, &quot;missing mime draft data and/or buf&quot;);</span>
<a href="#l47.2673"></a><span id="l47.2673">   if (!mdd || !buf) return -1;</span>
<a href="#l47.2674"></a><span id="l47.2674">   if (!size) return 0;</span>
<a href="#l47.2675"></a><span id="l47.2675"> </span>
<a href="#l47.2676"></a><span id="l47.2676" class="difflineminus">-  if (!mdd-&gt;tmpFileStream)</span>
<a href="#l47.2677"></a><span id="l47.2677" class="difflineminus">-    return 0;</span>
<a href="#l47.2678"></a><span id="l47.2678" class="difflineplus">+  if (!mdd-&gt;tmpFileStream) return 0;</span>
<a href="#l47.2679"></a><span id="l47.2679"> </span>
<a href="#l47.2680"></a><span id="l47.2680">   if (mdd-&gt;decoder_data) {</span>
<a href="#l47.2681"></a><span id="l47.2681">     int32_t outsize;</span>
<a href="#l47.2682"></a><span id="l47.2682">     ret = MimeDecoderWrite(mdd-&gt;decoder_data, buf, size, &amp;outsize);</span>
<a href="#l47.2683"></a><span id="l47.2683">     if (ret == -1) return -1;</span>
<a href="#l47.2684"></a><span id="l47.2684">     mdd-&gt;curAttachment-&gt;m_size += outsize;</span>
<a href="#l47.2685"></a><span id="l47.2685" class="difflineminus">-  }</span>
<a href="#l47.2686"></a><span id="l47.2686" class="difflineminus">-  else</span>
<a href="#l47.2687"></a><span id="l47.2687" class="difflineminus">-  {</span>
<a href="#l47.2688"></a><span id="l47.2688" class="difflineplus">+  } else {</span>
<a href="#l47.2689"></a><span id="l47.2689">     uint32_t bytesWritten;</span>
<a href="#l47.2690"></a><span id="l47.2690">     mdd-&gt;tmpFileStream-&gt;Write(buf, size, &amp;bytesWritten);</span>
<a href="#l47.2691"></a><span id="l47.2691" class="difflineminus">-    if ((int32_t)bytesWritten &lt; size)</span>
<a href="#l47.2692"></a><span id="l47.2692" class="difflineminus">-      return MIME_ERROR_WRITING_FILE;</span>
<a href="#l47.2693"></a><span id="l47.2693" class="difflineplus">+    if ((int32_t)bytesWritten &lt; size) return MIME_ERROR_WRITING_FILE;</span>
<a href="#l47.2694"></a><span id="l47.2694">     mdd-&gt;curAttachment-&gt;m_size += size;</span>
<a href="#l47.2695"></a><span id="l47.2695">   }</span>
<a href="#l47.2696"></a><span id="l47.2696"> </span>
<a href="#l47.2697"></a><span id="l47.2697">   return 0;</span>
<a href="#l47.2698"></a><span id="l47.2698"> }</span>
<a href="#l47.2699"></a><span id="l47.2699"> </span>
<a href="#l47.2700"></a><span id="l47.2700" class="difflineminus">-int</span>
<a href="#l47.2701"></a><span id="l47.2701" class="difflineminus">-mime_decompose_file_close_fn(void *stream_closure)</span>
<a href="#l47.2702"></a><span id="l47.2702" class="difflineminus">-{</span>
<a href="#l47.2703"></a><span id="l47.2703" class="difflineplus">+int mime_decompose_file_close_fn(void *stream_closure) {</span>
<a href="#l47.2704"></a><span id="l47.2704">   mime_draft_data *mdd = (mime_draft_data *)stream_closure;</span>
<a href="#l47.2705"></a><span id="l47.2705"> </span>
<a href="#l47.2706"></a><span id="l47.2706" class="difflineminus">-  if (!mdd)</span>
<a href="#l47.2707"></a><span id="l47.2707" class="difflineminus">-    return -1;</span>
<a href="#l47.2708"></a><span id="l47.2708" class="difflineplus">+  if (!mdd) return -1;</span>
<a href="#l47.2709"></a><span id="l47.2709"> </span>
<a href="#l47.2710"></a><span id="l47.2710" class="difflineminus">-  if (--mdd-&gt;options-&gt;decompose_init_count &gt; 0)</span>
<a href="#l47.2711"></a><span id="l47.2711" class="difflineminus">-      return 0;</span>
<a href="#l47.2712"></a><span id="l47.2712" class="difflineplus">+  if (--mdd-&gt;options-&gt;decompose_init_count &gt; 0) return 0;</span>
<a href="#l47.2713"></a><span id="l47.2713"> </span>
<a href="#l47.2714"></a><span id="l47.2714">   if (mdd-&gt;decoder_data) {</span>
<a href="#l47.2715"></a><span id="l47.2715">     MimeDecoderDestroy(mdd-&gt;decoder_data, false);</span>
<a href="#l47.2716"></a><span id="l47.2716">     mdd-&gt;decoder_data = 0;</span>
<a href="#l47.2717"></a><span id="l47.2717">   }</span>
<a href="#l47.2718"></a><span id="l47.2718"> </span>
<a href="#l47.2719"></a><span id="l47.2719">   if (!mdd-&gt;tmpFileStream) {</span>
<a href="#l47.2720"></a><span id="l47.2720">     // it's ok to have a null tmpFileStream if there's no tmpFile.</span>
<a href="#l47.2721"></a><span id="l47.2721" class="difflineat">@@ -2173,130 +1961,113 @@ mime_decompose_file_close_fn(void *strea</span>
<a href="#l47.2722"></a><span id="l47.2722"> </span>
<a href="#l47.2723"></a><span id="l47.2723">   mdd-&gt;tmpFileStream = nullptr;</span>
<a href="#l47.2724"></a><span id="l47.2724"> </span>
<a href="#l47.2725"></a><span id="l47.2725">   mdd-&gt;tmpFile = nullptr;</span>
<a href="#l47.2726"></a><span id="l47.2726"> </span>
<a href="#l47.2727"></a><span id="l47.2727">   return 0;</span>
<a href="#l47.2728"></a><span id="l47.2728"> }</span>
<a href="#l47.2729"></a><span id="l47.2729"> </span>
<a href="#l47.2730"></a><span id="l47.2730" class="difflineminus">-extern &quot;C&quot; void  *</span>
<a href="#l47.2731"></a><span id="l47.2731" class="difflineminus">-mime_bridge_create_draft_stream(</span>
<a href="#l47.2732"></a><span id="l47.2732" class="difflineminus">-                          nsIMimeEmitter      *newEmitter,</span>
<a href="#l47.2733"></a><span id="l47.2733" class="difflineminus">-                          nsStreamConverter   *newPluginObj2,</span>
<a href="#l47.2734"></a><span id="l47.2734" class="difflineminus">-                          nsIURI              *uri,</span>
<a href="#l47.2735"></a><span id="l47.2735" class="difflineminus">-                          nsMimeOutputType    format_out)</span>
<a href="#l47.2736"></a><span id="l47.2736" class="difflineminus">-{</span>
<a href="#l47.2737"></a><span id="l47.2737" class="difflineminus">-  int                     status = 0;</span>
<a href="#l47.2738"></a><span id="l47.2738" class="difflineminus">-  nsMIMESession           *stream = nullptr;</span>
<a href="#l47.2739"></a><span id="l47.2739" class="difflineminus">-  mime_draft_data  *mdd = nullptr;</span>
<a href="#l47.2740"></a><span id="l47.2740" class="difflineminus">-  MimeObject              *obj = nullptr;</span>
<a href="#l47.2741"></a><span id="l47.2741" class="difflineplus">+extern &quot;C&quot; void *mime_bridge_create_draft_stream(</span>
<a href="#l47.2742"></a><span id="l47.2742" class="difflineplus">+    nsIMimeEmitter *newEmitter, nsStreamConverter *newPluginObj2, nsIURI *uri,</span>
<a href="#l47.2743"></a><span id="l47.2743" class="difflineplus">+    nsMimeOutputType format_out) {</span>
<a href="#l47.2744"></a><span id="l47.2744" class="difflineplus">+  int status = 0;</span>
<a href="#l47.2745"></a><span id="l47.2745" class="difflineplus">+  nsMIMESession *stream = nullptr;</span>
<a href="#l47.2746"></a><span id="l47.2746" class="difflineplus">+  mime_draft_data *mdd = nullptr;</span>
<a href="#l47.2747"></a><span id="l47.2747" class="difflineplus">+  MimeObject *obj = nullptr;</span>
<a href="#l47.2748"></a><span id="l47.2748"> </span>
<a href="#l47.2749"></a><span id="l47.2749" class="difflineminus">-  if (!uri)</span>
<a href="#l47.2750"></a><span id="l47.2750" class="difflineminus">-    return nullptr;</span>
<a href="#l47.2751"></a><span id="l47.2751" class="difflineplus">+  if (!uri) return nullptr;</span>
<a href="#l47.2752"></a><span id="l47.2752"> </span>
<a href="#l47.2753"></a><span id="l47.2753">   mdd = new mime_draft_data;</span>
<a href="#l47.2754"></a><span id="l47.2754" class="difflineminus">-  if (!mdd)</span>
<a href="#l47.2755"></a><span id="l47.2755" class="difflineminus">-    return nullptr;</span>
<a href="#l47.2756"></a><span id="l47.2756" class="difflineplus">+  if (!mdd) return nullptr;</span>
<a href="#l47.2757"></a><span id="l47.2757"> </span>
<a href="#l47.2758"></a><span id="l47.2758">   nsAutoCString turl;</span>
<a href="#l47.2759"></a><span id="l47.2759">   nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l47.2760"></a><span id="l47.2760">   nsCOMPtr&lt;nsIURI&gt; aURL;</span>
<a href="#l47.2761"></a><span id="l47.2761">   nsAutoCString urlString;</span>
<a href="#l47.2762"></a><span id="l47.2762">   nsresult rv;</span>
<a href="#l47.2763"></a><span id="l47.2763"> </span>
<a href="#l47.2764"></a><span id="l47.2764">   // first, convert the rdf msg uri into a url that represents the message...</span>
<a href="#l47.2765"></a><span id="l47.2765" class="difflineminus">-  if (NS_FAILED(uri-&gt;GetSpec(turl)))</span>
<a href="#l47.2766"></a><span id="l47.2766" class="difflineminus">-    goto FAIL;</span>
<a href="#l47.2767"></a><span id="l47.2767" class="difflineplus">+  if (NS_FAILED(uri-&gt;GetSpec(turl))) goto FAIL;</span>
<a href="#l47.2768"></a><span id="l47.2768"> </span>
<a href="#l47.2769"></a><span id="l47.2769">   rv = GetMessageServiceFromURI(turl, getter_AddRefs(msgService));</span>
<a href="#l47.2770"></a><span id="l47.2770" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l47.2771"></a><span id="l47.2771" class="difflineminus">-    goto FAIL;</span>
<a href="#l47.2772"></a><span id="l47.2772" class="difflineplus">+  if (NS_FAILED(rv)) goto FAIL;</span>
<a href="#l47.2773"></a><span id="l47.2773"> </span>
<a href="#l47.2774"></a><span id="l47.2774">   rv = msgService-&gt;GetUrlForUri(turl.get(), getter_AddRefs(aURL), nullptr);</span>
<a href="#l47.2775"></a><span id="l47.2775" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l47.2776"></a><span id="l47.2776" class="difflineminus">-    goto FAIL;</span>
<a href="#l47.2777"></a><span id="l47.2777" class="difflineplus">+  if (NS_FAILED(rv)) goto FAIL;</span>
<a href="#l47.2778"></a><span id="l47.2778"> </span>
<a href="#l47.2779"></a><span id="l47.2779" class="difflineminus">-  if (NS_SUCCEEDED(aURL-&gt;GetSpec(urlString)))</span>
<a href="#l47.2780"></a><span id="l47.2780" class="difflineminus">-  {</span>
<a href="#l47.2781"></a><span id="l47.2781" class="difflineplus">+  if (NS_SUCCEEDED(aURL-&gt;GetSpec(urlString))) {</span>
<a href="#l47.2782"></a><span id="l47.2782">     int32_t typeIndex = urlString.Find(&quot;&amp;type=application/x-message-display&quot;);</span>
<a href="#l47.2783"></a><span id="l47.2783">     if (typeIndex != -1)</span>
<a href="#l47.2784"></a><span id="l47.2784" class="difflineminus">-      urlString.Cut(typeIndex, sizeof(&quot;&amp;type=application/x-message-display&quot;) - 1);</span>
<a href="#l47.2785"></a><span id="l47.2785" class="difflineplus">+      urlString.Cut(typeIndex,</span>
<a href="#l47.2786"></a><span id="l47.2786" class="difflineplus">+                    sizeof(&quot;&amp;type=application/x-message-display&quot;) - 1);</span>
<a href="#l47.2787"></a><span id="l47.2787"> </span>
<a href="#l47.2788"></a><span id="l47.2788">     mdd-&gt;url_name = ToNewCString(urlString);</span>
<a href="#l47.2789"></a><span id="l47.2789" class="difflineminus">-    if (!(mdd-&gt;url_name))</span>
<a href="#l47.2790"></a><span id="l47.2790" class="difflineminus">-      goto FAIL;</span>
<a href="#l47.2791"></a><span id="l47.2791" class="difflineplus">+    if (!(mdd-&gt;url_name)) goto FAIL;</span>
<a href="#l47.2792"></a><span id="l47.2792">   }</span>
<a href="#l47.2793"></a><span id="l47.2793"> </span>
<a href="#l47.2794"></a><span id="l47.2794">   newPluginObj2-&gt;GetForwardInline(&amp;mdd-&gt;forwardInline);</span>
<a href="#l47.2795"></a><span id="l47.2795">   newPluginObj2-&gt;GetForwardInlineFilter(&amp;mdd-&gt;forwardInlineFilter);</span>
<a href="#l47.2796"></a><span id="l47.2796">   newPluginObj2-&gt;GetForwardToAddress(mdd-&gt;forwardToAddress);</span>
<a href="#l47.2797"></a><span id="l47.2797">   newPluginObj2-&gt;GetOverrideComposeFormat(&amp;mdd-&gt;overrideComposeFormat);</span>
<a href="#l47.2798"></a><span id="l47.2798">   newPluginObj2-&gt;GetIdentity(getter_AddRefs(mdd-&gt;identity));</span>
<a href="#l47.2799"></a><span id="l47.2799">   newPluginObj2-&gt;GetOriginalMsgURI(&amp;mdd-&gt;originalMsgURI);</span>
<a href="#l47.2800"></a><span id="l47.2800">   newPluginObj2-&gt;GetOrigMsgHdr(getter_AddRefs(mdd-&gt;origMsgHdr));</span>
<a href="#l47.2801"></a><span id="l47.2801">   mdd-&gt;format_out = format_out;</span>
<a href="#l47.2802"></a><span id="l47.2802" class="difflineminus">-  mdd-&gt;options = new MimeDisplayOptions ;</span>
<a href="#l47.2803"></a><span id="l47.2803" class="difflineminus">-  if (!mdd-&gt;options)</span>
<a href="#l47.2804"></a><span id="l47.2804" class="difflineminus">-    goto FAIL;</span>
<a href="#l47.2805"></a><span id="l47.2805" class="difflineplus">+  mdd-&gt;options = new MimeDisplayOptions;</span>
<a href="#l47.2806"></a><span id="l47.2806" class="difflineplus">+  if (!mdd-&gt;options) goto FAIL;</span>
<a href="#l47.2807"></a><span id="l47.2807"> </span>
<a href="#l47.2808"></a><span id="l47.2808">   mdd-&gt;options-&gt;url = strdup(mdd-&gt;url_name);</span>
<a href="#l47.2809"></a><span id="l47.2809" class="difflineminus">-  mdd-&gt;options-&gt;format_out = format_out;     // output format</span>
<a href="#l47.2810"></a><span id="l47.2810" class="difflineminus">-  mdd-&gt;options-&gt;decompose_file_p = true; /* new field in MimeDisplayOptions */</span>
<a href="#l47.2811"></a><span id="l47.2811" class="difflineplus">+  mdd-&gt;options-&gt;format_out = format_out;  // output format</span>
<a href="#l47.2812"></a><span id="l47.2812" class="difflineplus">+  mdd-&gt;options-&gt;decompose_file_p = true;  /* new field in MimeDisplayOptions */</span>
<a href="#l47.2813"></a><span id="l47.2813">   mdd-&gt;options-&gt;stream_closure = mdd;</span>
<a href="#l47.2814"></a><span id="l47.2814">   mdd-&gt;options-&gt;html_closure = mdd;</span>
<a href="#l47.2815"></a><span id="l47.2815">   mdd-&gt;options-&gt;decompose_headers_info_fn = make_mime_headers_copy;</span>
<a href="#l47.2816"></a><span id="l47.2816">   mdd-&gt;options-&gt;decompose_file_init_fn = mime_decompose_file_init_fn;</span>
<a href="#l47.2817"></a><span id="l47.2817">   mdd-&gt;options-&gt;decompose_file_output_fn = mime_decompose_file_output_fn;</span>
<a href="#l47.2818"></a><span id="l47.2818">   mdd-&gt;options-&gt;decompose_file_close_fn = mime_decompose_file_close_fn;</span>
<a href="#l47.2819"></a><span id="l47.2819"> </span>
<a href="#l47.2820"></a><span id="l47.2820">   mdd-&gt;options-&gt;m_prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l47.2821"></a><span id="l47.2821" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l47.2822"></a><span id="l47.2822" class="difflineminus">-    goto FAIL;</span>
<a href="#l47.2823"></a><span id="l47.2823" class="difflineplus">+  if (NS_FAILED(rv)) goto FAIL;</span>
<a href="#l47.2824"></a><span id="l47.2824"> </span>
<a href="#l47.2825"></a><span id="l47.2825"> #ifdef ENABLE_SMIME</span>
<a href="#l47.2826"></a><span id="l47.2826">   /* If we're attaching a message (for forwarding) then we must eradicate all</span>
<a href="#l47.2827"></a><span id="l47.2827">    traces of xlateion from it, since forwarding someone else a message</span>
<a href="#l47.2828"></a><span id="l47.2828">    that wasn't xlated for them doesn't work.  We have to dexlate it</span>
<a href="#l47.2829"></a><span id="l47.2829">    before sending it.</span>
<a href="#l47.2830"></a><span id="l47.2830">    */</span>
<a href="#l47.2831"></a><span id="l47.2831">   mdd-&gt;options-&gt;decrypt_p = true;</span>
<a href="#l47.2832"></a><span id="l47.2832"> #endif /* ENABLE_SMIME */</span>
<a href="#l47.2833"></a><span id="l47.2833"> </span>
<a href="#l47.2834"></a><span id="l47.2834" class="difflineminus">-  obj = mime_new((MimeObjectClass *)&amp;mimeMessageClass, (MimeHeaders *)NULL, MESSAGE_RFC822);</span>
<a href="#l47.2835"></a><span id="l47.2835" class="difflineminus">-  if (!obj)</span>
<a href="#l47.2836"></a><span id="l47.2836" class="difflineminus">-    goto FAIL;</span>
<a href="#l47.2837"></a><span id="l47.2837" class="difflineplus">+  obj = mime_new((MimeObjectClass *)&amp;mimeMessageClass, (MimeHeaders *)NULL,</span>
<a href="#l47.2838"></a><span id="l47.2838" class="difflineplus">+                 MESSAGE_RFC822);</span>
<a href="#l47.2839"></a><span id="l47.2839" class="difflineplus">+  if (!obj) goto FAIL;</span>
<a href="#l47.2840"></a><span id="l47.2840"> </span>
<a href="#l47.2841"></a><span id="l47.2841">   obj-&gt;options = mdd-&gt;options;</span>
<a href="#l47.2842"></a><span id="l47.2842">   mdd-&gt;obj = obj;</span>
<a href="#l47.2843"></a><span id="l47.2843"> </span>
<a href="#l47.2844"></a><span id="l47.2844">   stream = PR_NEWZAP(nsMIMESession);</span>
<a href="#l47.2845"></a><span id="l47.2845" class="difflineminus">-  if (!stream)</span>
<a href="#l47.2846"></a><span id="l47.2846" class="difflineminus">-    goto FAIL;</span>
<a href="#l47.2847"></a><span id="l47.2847" class="difflineplus">+  if (!stream) goto FAIL;</span>
<a href="#l47.2848"></a><span id="l47.2848"> </span>
<a href="#l47.2849"></a><span id="l47.2849">   stream-&gt;name = &quot;MIME To Draft Converter Stream&quot;;</span>
<a href="#l47.2850"></a><span id="l47.2850">   stream-&gt;complete = mime_parse_stream_complete;</span>
<a href="#l47.2851"></a><span id="l47.2851">   stream-&gt;abort = mime_parse_stream_abort;</span>
<a href="#l47.2852"></a><span id="l47.2852">   stream-&gt;put_block = mime_parse_stream_write;</span>
<a href="#l47.2853"></a><span id="l47.2853">   stream-&gt;data_object = mdd;</span>
<a href="#l47.2854"></a><span id="l47.2854"> </span>
<a href="#l47.2855"></a><span id="l47.2855">   status = obj-&gt;clazz-&gt;initialize(obj);</span>
<a href="#l47.2856"></a><span id="l47.2856" class="difflineminus">-  if (status &gt;= 0)</span>
<a href="#l47.2857"></a><span id="l47.2857" class="difflineminus">-    status = obj-&gt;clazz-&gt;parse_begin(obj);</span>
<a href="#l47.2858"></a><span id="l47.2858" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l47.2859"></a><span id="l47.2859" class="difflineminus">-    goto FAIL;</span>
<a href="#l47.2860"></a><span id="l47.2860" class="difflineplus">+  if (status &gt;= 0) status = obj-&gt;clazz-&gt;parse_begin(obj);</span>
<a href="#l47.2861"></a><span id="l47.2861" class="difflineplus">+  if (status &lt; 0) goto FAIL;</span>
<a href="#l47.2862"></a><span id="l47.2862"> </span>
<a href="#l47.2863"></a><span id="l47.2863">   return stream;</span>
<a href="#l47.2864"></a><span id="l47.2864"> </span>
<a href="#l47.2865"></a><span id="l47.2865"> FAIL:</span>
<a href="#l47.2866"></a><span id="l47.2866" class="difflineminus">-  if (mdd)</span>
<a href="#l47.2867"></a><span id="l47.2867" class="difflineminus">-  {</span>
<a href="#l47.2868"></a><span id="l47.2868" class="difflineplus">+  if (mdd) {</span>
<a href="#l47.2869"></a><span id="l47.2869">     PR_Free(mdd-&gt;url_name);</span>
<a href="#l47.2870"></a><span id="l47.2870">     PR_Free(mdd-&gt;originalMsgURI);</span>
<a href="#l47.2871"></a><span id="l47.2871" class="difflineminus">-    if (mdd-&gt;options)</span>
<a href="#l47.2872"></a><span id="l47.2872" class="difflineminus">-      delete mdd-&gt;options;</span>
<a href="#l47.2873"></a><span id="l47.2873" class="difflineplus">+    if (mdd-&gt;options) delete mdd-&gt;options;</span>
<a href="#l47.2874"></a><span id="l47.2874">     PR_Free(mdd);</span>
<a href="#l47.2875"></a><span id="l47.2875">   }</span>
<a href="#l47.2876"></a><span id="l47.2876">   PR_Free(stream);</span>
<a href="#l47.2877"></a><span id="l47.2877">   PR_Free(obj);</span>
<a href="#l47.2878"></a><span id="l47.2878"> </span>
<a href="#l47.2879"></a><span id="l47.2879">   return nullptr;</span>
<a href="#l47.2880"></a><span id="l47.2880"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/mime/src/mimeebod.cpp</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/mime/src/mimeebod.cpp</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -12,403 +12,345 @@</span>
<a href="#l48.4"></a><span id="l48.4"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l48.5"></a><span id="l48.5"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l48.6"></a><span id="l48.6"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l48.7"></a><span id="l48.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l48.8"></a><span id="l48.8"> #include &quot;nsINetUtil.h&quot;</span>
<a href="#l48.9"></a><span id="l48.9"> #include &lt;ctype.h&gt;</span>
<a href="#l48.10"></a><span id="l48.10"> </span>
<a href="#l48.11"></a><span id="l48.11"> #define MIME_SUPERCLASS mimeObjectClass</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-MimeDefClass(MimeExternalBody, MimeExternalBodyClass,</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-       mimeExternalBodyClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+MimeDefClass(MimeExternalBody, MimeExternalBodyClass, mimeExternalBodyClass,</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+             &amp;MIME_SUPERCLASS);</span>
<a href="#l48.16"></a><span id="l48.16"> </span>
<a href="#l48.17"></a><span id="l48.17"> #ifdef XP_MACOSX</span>
<a href="#l48.18"></a><span id="l48.18"> extern MimeObjectClass mimeMultipartAppleDoubleClass;</span>
<a href="#l48.19"></a><span id="l48.19"> #endif</span>
<a href="#l48.20"></a><span id="l48.20"> </span>
<a href="#l48.21"></a><span id="l48.21" class="difflineminus">-static int MimeExternalBody_initialize (MimeObject *);</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineminus">-static void MimeExternalBody_finalize (MimeObject *);</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineminus">-static int MimeExternalBody_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineminus">-static int MimeExternalBody_parse_eof (MimeObject *, bool);</span>
<a href="#l48.25"></a><span id="l48.25" class="difflineminus">-static bool MimeExternalBody_displayable_inline_p (MimeObjectClass *clazz,</span>
<a href="#l48.26"></a><span id="l48.26" class="difflineminus">-                            MimeHeaders *hdrs);</span>
<a href="#l48.27"></a><span id="l48.27" class="difflineplus">+static int MimeExternalBody_initialize(MimeObject *);</span>
<a href="#l48.28"></a><span id="l48.28" class="difflineplus">+static void MimeExternalBody_finalize(MimeObject *);</span>
<a href="#l48.29"></a><span id="l48.29" class="difflineplus">+static int MimeExternalBody_parse_line(const char *, int32_t, MimeObject *);</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineplus">+static int MimeExternalBody_parse_eof(MimeObject *, bool);</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineplus">+static bool MimeExternalBody_displayable_inline_p(MimeObjectClass *clazz,</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineplus">+                                                  MimeHeaders *hdrs);</span>
<a href="#l48.33"></a><span id="l48.33"> </span>
<a href="#l48.34"></a><span id="l48.34"> #if 0</span>
<a href="#l48.35"></a><span id="l48.35" class="difflineminus">-#if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l48.36"></a><span id="l48.36" class="difflineplus">+#  if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l48.37"></a><span id="l48.37"> static int MimeExternalBody_debug_print (MimeObject *, PRFileDesc *, int32_t);</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineminus">-#endif</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineplus">+#  endif</span>
<a href="#l48.40"></a><span id="l48.40"> #endif /* 0 */</span>
<a href="#l48.41"></a><span id="l48.41"> </span>
<a href="#l48.42"></a><span id="l48.42" class="difflineminus">-static int</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineminus">-MimeExternalBodyClassInitialize(MimeExternalBodyClass *clazz)</span>
<a href="#l48.44"></a><span id="l48.44" class="difflineminus">-{</span>
<a href="#l48.45"></a><span id="l48.45" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l48.46"></a><span id="l48.46" class="difflineplus">+static int MimeExternalBodyClassInitialize(MimeExternalBodyClass *clazz) {</span>
<a href="#l48.47"></a><span id="l48.47" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l48.48"></a><span id="l48.48"> </span>
<a href="#l48.49"></a><span id="l48.49" class="difflineminus">-  NS_ASSERTION(!oclass-&gt;class_initialized, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineminus">-  oclass-&gt;initialize  = MimeExternalBody_initialize;</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineminus">-  oclass-&gt;finalize    = MimeExternalBody_finalize;</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineminus">-  oclass-&gt;parse_line  = MimeExternalBody_parse_line;</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineminus">-  oclass-&gt;parse_eof  = MimeExternalBody_parse_eof;</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineplus">+  NS_ASSERTION(!oclass-&gt;class_initialized,</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineplus">+  oclass-&gt;initialize = MimeExternalBody_initialize;</span>
<a href="#l48.57"></a><span id="l48.57" class="difflineplus">+  oclass-&gt;finalize = MimeExternalBody_finalize;</span>
<a href="#l48.58"></a><span id="l48.58" class="difflineplus">+  oclass-&gt;parse_line = MimeExternalBody_parse_line;</span>
<a href="#l48.59"></a><span id="l48.59" class="difflineplus">+  oclass-&gt;parse_eof = MimeExternalBody_parse_eof;</span>
<a href="#l48.60"></a><span id="l48.60">   oclass-&gt;displayable_inline_p = MimeExternalBody_displayable_inline_p;</span>
<a href="#l48.61"></a><span id="l48.61"> </span>
<a href="#l48.62"></a><span id="l48.62"> #if 0</span>
<a href="#l48.63"></a><span id="l48.63" class="difflineminus">-#if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l48.64"></a><span id="l48.64" class="difflineplus">+#  if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l48.65"></a><span id="l48.65">   oclass-&gt;debug_print = MimeExternalBody_debug_print;</span>
<a href="#l48.66"></a><span id="l48.66" class="difflineminus">-#endif</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineplus">+#  endif</span>
<a href="#l48.68"></a><span id="l48.68"> #endif /* 0 */</span>
<a href="#l48.69"></a><span id="l48.69"> </span>
<a href="#l48.70"></a><span id="l48.70">   return 0;</span>
<a href="#l48.71"></a><span id="l48.71"> }</span>
<a href="#l48.72"></a><span id="l48.72"> </span>
<a href="#l48.73"></a><span id="l48.73" class="difflineminus">-</span>
<a href="#l48.74"></a><span id="l48.74" class="difflineminus">-static int</span>
<a href="#l48.75"></a><span id="l48.75" class="difflineminus">-MimeExternalBody_initialize (MimeObject *object)</span>
<a href="#l48.76"></a><span id="l48.76" class="difflineminus">-{</span>
<a href="#l48.77"></a><span id="l48.77" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l48.78"></a><span id="l48.78" class="difflineplus">+static int MimeExternalBody_initialize(MimeObject *object) {</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l48.80"></a><span id="l48.80"> }</span>
<a href="#l48.81"></a><span id="l48.81"> </span>
<a href="#l48.82"></a><span id="l48.82" class="difflineminus">-static void</span>
<a href="#l48.83"></a><span id="l48.83" class="difflineminus">-MimeExternalBody_finalize (MimeObject *object)</span>
<a href="#l48.84"></a><span id="l48.84" class="difflineminus">-{</span>
<a href="#l48.85"></a><span id="l48.85" class="difflineminus">-  MimeExternalBody *bod = (MimeExternalBody *) object;</span>
<a href="#l48.86"></a><span id="l48.86" class="difflineminus">-  if (bod-&gt;hdrs)</span>
<a href="#l48.87"></a><span id="l48.87" class="difflineminus">-  {</span>
<a href="#l48.88"></a><span id="l48.88" class="difflineplus">+static void MimeExternalBody_finalize(MimeObject *object) {</span>
<a href="#l48.89"></a><span id="l48.89" class="difflineplus">+  MimeExternalBody *bod = (MimeExternalBody *)object;</span>
<a href="#l48.90"></a><span id="l48.90" class="difflineplus">+  if (bod-&gt;hdrs) {</span>
<a href="#l48.91"></a><span id="l48.91">     MimeHeaders_free(bod-&gt;hdrs);</span>
<a href="#l48.92"></a><span id="l48.92">     bod-&gt;hdrs = 0;</span>
<a href="#l48.93"></a><span id="l48.93">   }</span>
<a href="#l48.94"></a><span id="l48.94">   PR_FREEIF(bod-&gt;body);</span>
<a href="#l48.95"></a><span id="l48.95"> </span>
<a href="#l48.96"></a><span id="l48.96" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l48.97"></a><span id="l48.97" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l48.98"></a><span id="l48.98"> }</span>
<a href="#l48.99"></a><span id="l48.99"> </span>
<a href="#l48.100"></a><span id="l48.100" class="difflineminus">-static int</span>
<a href="#l48.101"></a><span id="l48.101" class="difflineminus">-MimeExternalBody_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l48.102"></a><span id="l48.102" class="difflineminus">-{</span>
<a href="#l48.103"></a><span id="l48.103" class="difflineminus">-  MimeExternalBody *bod = (MimeExternalBody *) obj;</span>
<a href="#l48.104"></a><span id="l48.104" class="difflineplus">+static int MimeExternalBody_parse_line(const char *line, int32_t length,</span>
<a href="#l48.105"></a><span id="l48.105" class="difflineplus">+                                       MimeObject *obj) {</span>
<a href="#l48.106"></a><span id="l48.106" class="difflineplus">+  MimeExternalBody *bod = (MimeExternalBody *)obj;</span>
<a href="#l48.107"></a><span id="l48.107">   int status = 0;</span>
<a href="#l48.108"></a><span id="l48.108"> </span>
<a href="#l48.109"></a><span id="l48.109">   NS_ASSERTION(line &amp;&amp; *line, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l48.110"></a><span id="l48.110">   if (!line || !*line) return -1;</span>
<a href="#l48.111"></a><span id="l48.111"> </span>
<a href="#l48.112"></a><span id="l48.112">   if (!obj-&gt;output_p) return 0;</span>
<a href="#l48.113"></a><span id="l48.113"> </span>
<a href="#l48.114"></a><span id="l48.114">   /* If we're supposed to write this object, but aren't supposed to convert</span>
<a href="#l48.115"></a><span id="l48.115">    it to HTML, simply pass it through unaltered. */</span>
<a href="#l48.116"></a><span id="l48.116" class="difflineminus">-  if (obj-&gt;options &amp;&amp;</span>
<a href="#l48.117"></a><span id="l48.117" class="difflineminus">-    !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l48.118"></a><span id="l48.118" class="difflineminus">-    obj-&gt;options-&gt;output_fn)</span>
<a href="#l48.119"></a><span id="l48.119" class="difflineminus">-  return MimeObject_write(obj, line, length, true);</span>
<a href="#l48.120"></a><span id="l48.120" class="difflineminus">-</span>
<a href="#l48.121"></a><span id="l48.121" class="difflineplus">+  if (obj-&gt;options &amp;&amp; !obj-&gt;options-&gt;write_html_p &amp;&amp; obj-&gt;options-&gt;output_fn)</span>
<a href="#l48.122"></a><span id="l48.122" class="difflineplus">+    return MimeObject_write(obj, line, length, true);</span>
<a href="#l48.123"></a><span id="l48.123"> </span>
<a href="#l48.124"></a><span id="l48.124">   /* If we already have a `body' then we're done parsing headers, and all</span>
<a href="#l48.125"></a><span id="l48.125">    subsequent lines get tacked onto the body. */</span>
<a href="#l48.126"></a><span id="l48.126" class="difflineminus">-  if (bod-&gt;body)</span>
<a href="#l48.127"></a><span id="l48.127" class="difflineminus">-  {</span>
<a href="#l48.128"></a><span id="l48.128" class="difflineplus">+  if (bod-&gt;body) {</span>
<a href="#l48.129"></a><span id="l48.129">     int L = strlen(bod-&gt;body);</span>
<a href="#l48.130"></a><span id="l48.130">     char *new_str = (char *)PR_Realloc(bod-&gt;body, L + length + 1);</span>
<a href="#l48.131"></a><span id="l48.131">     if (!new_str) return MIME_OUT_OF_MEMORY;</span>
<a href="#l48.132"></a><span id="l48.132">     bod-&gt;body = new_str;</span>
<a href="#l48.133"></a><span id="l48.133">     memcpy(bod-&gt;body + L, line, length);</span>
<a href="#l48.134"></a><span id="l48.134">     bod-&gt;body[L + length] = 0;</span>
<a href="#l48.135"></a><span id="l48.135">     return 0;</span>
<a href="#l48.136"></a><span id="l48.136">   }</span>
<a href="#l48.137"></a><span id="l48.137"> </span>
<a href="#l48.138"></a><span id="l48.138">   /* Otherwise we don't yet have a body, which means we're not done parsing</span>
<a href="#l48.139"></a><span id="l48.139">    our headers.</span>
<a href="#l48.140"></a><span id="l48.140">    */</span>
<a href="#l48.141"></a><span id="l48.141" class="difflineminus">-  if (!bod-&gt;hdrs)</span>
<a href="#l48.142"></a><span id="l48.142" class="difflineminus">-  {</span>
<a href="#l48.143"></a><span id="l48.143" class="difflineplus">+  if (!bod-&gt;hdrs) {</span>
<a href="#l48.144"></a><span id="l48.144">     bod-&gt;hdrs = MimeHeaders_new();</span>
<a href="#l48.145"></a><span id="l48.145">     if (!bod-&gt;hdrs) return MIME_OUT_OF_MEMORY;</span>
<a href="#l48.146"></a><span id="l48.146">   }</span>
<a href="#l48.147"></a><span id="l48.147"> </span>
<a href="#l48.148"></a><span id="l48.148">   status = MimeHeaders_parse_line(line, length, bod-&gt;hdrs);</span>
<a href="#l48.149"></a><span id="l48.149">   if (status &lt; 0) return status;</span>
<a href="#l48.150"></a><span id="l48.150"> </span>
<a href="#l48.151"></a><span id="l48.151">   /* If this line is blank, we're now done parsing headers, and should</span>
<a href="#l48.152"></a><span id="l48.152">    create a dummy body to show that.  Gag.</span>
<a href="#l48.153"></a><span id="l48.153">    */</span>
<a href="#l48.154"></a><span id="l48.154" class="difflineminus">-  if (*line == '\r' || *line == '\n')</span>
<a href="#l48.155"></a><span id="l48.155" class="difflineminus">-  {</span>
<a href="#l48.156"></a><span id="l48.156" class="difflineplus">+  if (*line == '\r' || *line == '\n') {</span>
<a href="#l48.157"></a><span id="l48.157">     bod-&gt;body = strdup(&quot;&quot;);</span>
<a href="#l48.158"></a><span id="l48.158">     if (!bod-&gt;body) return MIME_OUT_OF_MEMORY;</span>
<a href="#l48.159"></a><span id="l48.159">   }</span>
<a href="#l48.160"></a><span id="l48.160"> </span>
<a href="#l48.161"></a><span id="l48.161">   return 0;</span>
<a href="#l48.162"></a><span id="l48.162"> }</span>
<a href="#l48.163"></a><span id="l48.163"> </span>
<a href="#l48.164"></a><span id="l48.164" class="difflineminus">-</span>
<a href="#l48.165"></a><span id="l48.165" class="difflineminus">-char *</span>
<a href="#l48.166"></a><span id="l48.166" class="difflineminus">-MimeExternalBody_make_url(const char *ct,</span>
<a href="#l48.167"></a><span id="l48.167" class="difflineminus">-              const char *at, const char *lexp, const char *size,</span>
<a href="#l48.168"></a><span id="l48.168" class="difflineminus">-              const char *perm, const char *dir, const char *mode,</span>
<a href="#l48.169"></a><span id="l48.169" class="difflineminus">-              const char *name, const char *url, const char *site,</span>
<a href="#l48.170"></a><span id="l48.170" class="difflineminus">-              const char *svr, const char *subj, const char *body)</span>
<a href="#l48.171"></a><span id="l48.171" class="difflineminus">-{</span>
<a href="#l48.172"></a><span id="l48.172" class="difflineplus">+char *MimeExternalBody_make_url(const char *ct, const char *at,</span>
<a href="#l48.173"></a><span id="l48.173" class="difflineplus">+                                const char *lexp, const char *size,</span>
<a href="#l48.174"></a><span id="l48.174" class="difflineplus">+                                const char *perm, const char *dir,</span>
<a href="#l48.175"></a><span id="l48.175" class="difflineplus">+                                const char *mode, const char *name,</span>
<a href="#l48.176"></a><span id="l48.176" class="difflineplus">+                                const char *url, const char *site,</span>
<a href="#l48.177"></a><span id="l48.177" class="difflineplus">+                                const char *svr, const char *subj,</span>
<a href="#l48.178"></a><span id="l48.178" class="difflineplus">+                                const char *body) {</span>
<a href="#l48.179"></a><span id="l48.179">   char *s;</span>
<a href="#l48.180"></a><span id="l48.180">   uint32_t slen;</span>
<a href="#l48.181"></a><span id="l48.181" class="difflineminus">-  if (!at)</span>
<a href="#l48.182"></a><span id="l48.182" class="difflineminus">-  {</span>
<a href="#l48.183"></a><span id="l48.183" class="difflineplus">+  if (!at) {</span>
<a href="#l48.184"></a><span id="l48.184">     return 0;</span>
<a href="#l48.185"></a><span id="l48.185" class="difflineminus">-  }</span>
<a href="#l48.186"></a><span id="l48.186" class="difflineminus">-  else if (!PL_strcasecmp(at, &quot;ftp&quot;) || !PL_strcasecmp(at, &quot;anon-ftp&quot;))</span>
<a href="#l48.187"></a><span id="l48.187" class="difflineminus">-  {</span>
<a href="#l48.188"></a><span id="l48.188" class="difflineminus">-    if (!site || !name)</span>
<a href="#l48.189"></a><span id="l48.189" class="difflineminus">-      return 0;</span>
<a href="#l48.190"></a><span id="l48.190" class="difflineplus">+  } else if (!PL_strcasecmp(at, &quot;ftp&quot;) || !PL_strcasecmp(at, &quot;anon-ftp&quot;)) {</span>
<a href="#l48.191"></a><span id="l48.191" class="difflineplus">+    if (!site || !name) return 0;</span>
<a href="#l48.192"></a><span id="l48.192"> </span>
<a href="#l48.193"></a><span id="l48.193">     slen = strlen(name) + strlen(site) + (dir ? strlen(dir) : 0) + 20;</span>
<a href="#l48.194"></a><span id="l48.194" class="difflineminus">-    s = (char *) PR_MALLOC(slen);</span>
<a href="#l48.195"></a><span id="l48.195" class="difflineplus">+    s = (char *)PR_MALLOC(slen);</span>
<a href="#l48.196"></a><span id="l48.196"> </span>
<a href="#l48.197"></a><span id="l48.197">     if (!s) return 0;</span>
<a href="#l48.198"></a><span id="l48.198">     PL_strncpyz(s, &quot;ftp://&quot;, slen);</span>
<a href="#l48.199"></a><span id="l48.199">     PL_strcatn(s, slen, site);</span>
<a href="#l48.200"></a><span id="l48.200">     PL_strcatn(s, slen, &quot;/&quot;);</span>
<a href="#l48.201"></a><span id="l48.201" class="difflineminus">-    if (dir) PL_strcatn(s, slen, (dir[0] == '/' ? dir+1 : dir));</span>
<a href="#l48.202"></a><span id="l48.202" class="difflineminus">-    if (s[strlen(s)-1] != '/')</span>
<a href="#l48.203"></a><span id="l48.203" class="difflineminus">-      PL_strcatn(s, slen, &quot;/&quot;);</span>
<a href="#l48.204"></a><span id="l48.204" class="difflineplus">+    if (dir) PL_strcatn(s, slen, (dir[0] == '/' ? dir + 1 : dir));</span>
<a href="#l48.205"></a><span id="l48.205" class="difflineplus">+    if (s[strlen(s) - 1] != '/') PL_strcatn(s, slen, &quot;/&quot;);</span>
<a href="#l48.206"></a><span id="l48.206">     PL_strcatn(s, slen, name);</span>
<a href="#l48.207"></a><span id="l48.207">     return s;</span>
<a href="#l48.208"></a><span id="l48.208" class="difflineminus">-  }</span>
<a href="#l48.209"></a><span id="l48.209" class="difflineminus">-  else if (!PL_strcasecmp(at, &quot;local-file&quot;) || !PL_strcasecmp(at, &quot;afs&quot;))</span>
<a href="#l48.210"></a><span id="l48.210" class="difflineminus">-  {</span>
<a href="#l48.211"></a><span id="l48.211" class="difflineminus">-    if (!name)</span>
<a href="#l48.212"></a><span id="l48.212" class="difflineminus">-      return 0;</span>
<a href="#l48.213"></a><span id="l48.213" class="difflineplus">+  } else if (!PL_strcasecmp(at, &quot;local-file&quot;) || !PL_strcasecmp(at, &quot;afs&quot;)) {</span>
<a href="#l48.214"></a><span id="l48.214" class="difflineplus">+    if (!name) return 0;</span>
<a href="#l48.215"></a><span id="l48.215"> </span>
<a href="#l48.216"></a><span id="l48.216"> #ifdef XP_UNIX</span>
<a href="#l48.217"></a><span id="l48.217" class="difflineminus">-    if (!PL_strcasecmp(at, &quot;afs&quot;))   /* only if there is a /afs/ directory */</span>
<a href="#l48.218"></a><span id="l48.218" class="difflineplus">+    if (!PL_strcasecmp(at, &quot;afs&quot;)) /* only if there is a /afs/ directory */</span>
<a href="#l48.219"></a><span id="l48.219">     {</span>
<a href="#l48.220"></a><span id="l48.220" class="difflineminus">-      nsCOMPtr &lt;nsIFile&gt; fs = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l48.221"></a><span id="l48.221" class="difflineplus">+      nsCOMPtr&lt;nsIFile&gt; fs = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l48.222"></a><span id="l48.222">       bool exists = false;</span>
<a href="#l48.223"></a><span id="l48.223" class="difflineminus">-      if (fs)</span>
<a href="#l48.224"></a><span id="l48.224" class="difflineminus">-      {</span>
<a href="#l48.225"></a><span id="l48.225" class="difflineplus">+      if (fs) {</span>
<a href="#l48.226"></a><span id="l48.226">         fs-&gt;InitWithNativePath(NS_LITERAL_CSTRING(&quot;/afs/.&quot;));</span>
<a href="#l48.227"></a><span id="l48.227">         fs-&gt;Exists(&amp;exists);</span>
<a href="#l48.228"></a><span id="l48.228">       }</span>
<a href="#l48.229"></a><span id="l48.229" class="difflineminus">-      if  (!exists)</span>
<a href="#l48.230"></a><span id="l48.230" class="difflineminus">-        return 0;</span>
<a href="#l48.231"></a><span id="l48.231" class="difflineplus">+      if (!exists) return 0;</span>
<a href="#l48.232"></a><span id="l48.232">     }</span>
<a href="#l48.233"></a><span id="l48.233"> #else  /* !XP_UNIX */</span>
<a href="#l48.234"></a><span id="l48.234" class="difflineminus">-    return 0;            /* never, if not Unix. */</span>
<a href="#l48.235"></a><span id="l48.235" class="difflineplus">+    return 0; /* never, if not Unix. */</span>
<a href="#l48.236"></a><span id="l48.236"> #endif /* !XP_UNIX */</span>
<a href="#l48.237"></a><span id="l48.237"> </span>
<a href="#l48.238"></a><span id="l48.238">     slen = (strlen(name) * 3 + 20);</span>
<a href="#l48.239"></a><span id="l48.239" class="difflineminus">-    s = (char *) PR_MALLOC(slen);</span>
<a href="#l48.240"></a><span id="l48.240" class="difflineplus">+    s = (char *)PR_MALLOC(slen);</span>
<a href="#l48.241"></a><span id="l48.241">     if (!s) return 0;</span>
<a href="#l48.242"></a><span id="l48.242">     PL_strncpyz(s, &quot;file:&quot;, slen);</span>
<a href="#l48.243"></a><span id="l48.243"> </span>
<a href="#l48.244"></a><span id="l48.244">     nsCString s2;</span>
<a href="#l48.245"></a><span id="l48.245">     MsgEscapeString(nsDependentCString(name), nsINetUtil::ESCAPE_URL_PATH, s2);</span>
<a href="#l48.246"></a><span id="l48.246">     PL_strcatn(s, slen, s2.get());</span>
<a href="#l48.247"></a><span id="l48.247">     return s;</span>
<a href="#l48.248"></a><span id="l48.248" class="difflineminus">-  }</span>
<a href="#l48.249"></a><span id="l48.249" class="difflineminus">-else if (!PL_strcasecmp(at, &quot;mail-server&quot;))</span>
<a href="#l48.250"></a><span id="l48.250" class="difflineminus">-{</span>
<a href="#l48.251"></a><span id="l48.251" class="difflineminus">-  if (!svr)</span>
<a href="#l48.252"></a><span id="l48.252" class="difflineminus">-    return 0;</span>
<a href="#l48.253"></a><span id="l48.253" class="difflineplus">+  } else if (!PL_strcasecmp(at, &quot;mail-server&quot;)) {</span>
<a href="#l48.254"></a><span id="l48.254" class="difflineplus">+    if (!svr) return 0;</span>
<a href="#l48.255"></a><span id="l48.255"> </span>
<a href="#l48.256"></a><span id="l48.256" class="difflineminus">-  slen =  (strlen(svr)*4 + (subj ? strlen(subj)*4 : 0) +</span>
<a href="#l48.257"></a><span id="l48.257" class="difflineminus">-                         (body ? strlen(body)*4 : 0) + 25); // dpv xxx: why 4x? %xx escaping should be 3x</span>
<a href="#l48.258"></a><span id="l48.258" class="difflineminus">-  s = (char *) PR_MALLOC(slen);</span>
<a href="#l48.259"></a><span id="l48.259" class="difflineminus">-  if (!s) return 0;</span>
<a href="#l48.260"></a><span id="l48.260" class="difflineminus">-  PL_strncpyz(s, &quot;mailto:&quot;, slen);</span>
<a href="#l48.261"></a><span id="l48.261" class="difflineplus">+    slen = (strlen(svr) * 4 + (subj ? strlen(subj) * 4 : 0) +</span>
<a href="#l48.262"></a><span id="l48.262" class="difflineplus">+            (body ? strlen(body) * 4 : 0) +</span>
<a href="#l48.263"></a><span id="l48.263" class="difflineplus">+            25);  // dpv xxx: why 4x? %xx escaping should be 3x</span>
<a href="#l48.264"></a><span id="l48.264" class="difflineplus">+    s = (char *)PR_MALLOC(slen);</span>
<a href="#l48.265"></a><span id="l48.265" class="difflineplus">+    if (!s) return 0;</span>
<a href="#l48.266"></a><span id="l48.266" class="difflineplus">+    PL_strncpyz(s, &quot;mailto:&quot;, slen);</span>
<a href="#l48.267"></a><span id="l48.267"> </span>
<a href="#l48.268"></a><span id="l48.268" class="difflineminus">-  nsCString s2;</span>
<a href="#l48.269"></a><span id="l48.269" class="difflineminus">-  MsgEscapeString(nsDependentCString(svr), nsINetUtil::ESCAPE_XALPHAS, s2);</span>
<a href="#l48.270"></a><span id="l48.270" class="difflineminus">-  PL_strcatn(s, slen, s2.get());</span>
<a href="#l48.271"></a><span id="l48.271" class="difflineplus">+    nsCString s2;</span>
<a href="#l48.272"></a><span id="l48.272" class="difflineplus">+    MsgEscapeString(nsDependentCString(svr), nsINetUtil::ESCAPE_XALPHAS, s2);</span>
<a href="#l48.273"></a><span id="l48.273" class="difflineplus">+    PL_strcatn(s, slen, s2.get());</span>
<a href="#l48.274"></a><span id="l48.274"> </span>
<a href="#l48.275"></a><span id="l48.275" class="difflineminus">-  if (subj)</span>
<a href="#l48.276"></a><span id="l48.276" class="difflineminus">-    {</span>
<a href="#l48.277"></a><span id="l48.277" class="difflineplus">+    if (subj) {</span>
<a href="#l48.278"></a><span id="l48.278">       MsgEscapeString(nsDependentCString(subj), nsINetUtil::ESCAPE_XALPHAS, s2);</span>
<a href="#l48.279"></a><span id="l48.279">       PL_strcatn(s, slen, &quot;?subject=&quot;);</span>
<a href="#l48.280"></a><span id="l48.280">       PL_strcatn(s, slen, s2.get());</span>
<a href="#l48.281"></a><span id="l48.281">     }</span>
<a href="#l48.282"></a><span id="l48.282" class="difflineminus">-  if (body)</span>
<a href="#l48.283"></a><span id="l48.283" class="difflineminus">-    {</span>
<a href="#l48.284"></a><span id="l48.284" class="difflineplus">+    if (body) {</span>
<a href="#l48.285"></a><span id="l48.285">       MsgEscapeString(nsDependentCString(body), nsINetUtil::ESCAPE_XALPHAS, s2);</span>
<a href="#l48.286"></a><span id="l48.286">       PL_strcatn(s, slen, (subj ? &quot;&amp;body=&quot; : &quot;?body=&quot;));</span>
<a href="#l48.287"></a><span id="l48.287">       PL_strcatn(s, slen, s2.get());</span>
<a href="#l48.288"></a><span id="l48.288">     }</span>
<a href="#l48.289"></a><span id="l48.289" class="difflineminus">-  return s;</span>
<a href="#l48.290"></a><span id="l48.290" class="difflineminus">-}</span>
<a href="#l48.291"></a><span id="l48.291" class="difflineminus">-else if (!PL_strcasecmp(at, &quot;url&quot;))      /* RFC 2017 */</span>
<a href="#l48.292"></a><span id="l48.292" class="difflineminus">-                            {</span>
<a href="#l48.293"></a><span id="l48.293" class="difflineminus">-  if (url)</span>
<a href="#l48.294"></a><span id="l48.294" class="difflineminus">-    return strdup(url);       /* it's already quoted and everything */</span>
<a href="#l48.295"></a><span id="l48.295" class="difflineminus">-  else</span>
<a href="#l48.296"></a><span id="l48.296" class="difflineplus">+    return s;</span>
<a href="#l48.297"></a><span id="l48.297" class="difflineplus">+  } else if (!PL_strcasecmp(at, &quot;url&quot;)) /* RFC 2017 */</span>
<a href="#l48.298"></a><span id="l48.298" class="difflineplus">+  {</span>
<a href="#l48.299"></a><span id="l48.299" class="difflineplus">+    if (url)</span>
<a href="#l48.300"></a><span id="l48.300" class="difflineplus">+      return strdup(url); /* it's already quoted and everything */</span>
<a href="#l48.301"></a><span id="l48.301" class="difflineplus">+    else</span>
<a href="#l48.302"></a><span id="l48.302" class="difflineplus">+      return 0;</span>
<a href="#l48.303"></a><span id="l48.303" class="difflineplus">+  } else</span>
<a href="#l48.304"></a><span id="l48.304">     return 0;</span>
<a href="#l48.305"></a><span id="l48.305" class="difflineminus">-                            }</span>
<a href="#l48.306"></a><span id="l48.306" class="difflineminus">-                            else</span>
<a href="#l48.307"></a><span id="l48.307" class="difflineminus">-                            return 0;</span>
<a href="#l48.308"></a><span id="l48.308"> }</span>
<a href="#l48.309"></a><span id="l48.309"> </span>
<a href="#l48.310"></a><span id="l48.310" class="difflineminus">-static int</span>
<a href="#l48.311"></a><span id="l48.311" class="difflineminus">-MimeExternalBody_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l48.312"></a><span id="l48.312" class="difflineminus">-{</span>
<a href="#l48.313"></a><span id="l48.313" class="difflineplus">+static int MimeExternalBody_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l48.314"></a><span id="l48.314">   int status = 0;</span>
<a href="#l48.315"></a><span id="l48.315" class="difflineminus">-  MimeExternalBody *bod = (MimeExternalBody *) obj;</span>
<a href="#l48.316"></a><span id="l48.316" class="difflineplus">+  MimeExternalBody *bod = (MimeExternalBody *)obj;</span>
<a href="#l48.317"></a><span id="l48.317"> </span>
<a href="#l48.318"></a><span id="l48.318">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l48.319"></a><span id="l48.319"> </span>
<a href="#l48.320"></a><span id="l48.320">   /* Run parent method first, to flush out any buffered data. */</span>
<a href="#l48.321"></a><span id="l48.321" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l48.322"></a><span id="l48.322" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l48.323"></a><span id="l48.323">   if (status &lt; 0) return status;</span>
<a href="#l48.324"></a><span id="l48.324"> </span>
<a href="#l48.325"></a><span id="l48.325"> #ifdef XP_MACOSX</span>
<a href="#l48.326"></a><span id="l48.326" class="difflineminus">-  if (obj-&gt;parent &amp;&amp; mime_typep(obj-&gt;parent,</span>
<a href="#l48.327"></a><span id="l48.327" class="difflineminus">-                                (MimeObjectClass*) &amp;mimeMultipartAppleDoubleClass))</span>
<a href="#l48.328"></a><span id="l48.328" class="difflineplus">+  if (obj-&gt;parent &amp;&amp;</span>
<a href="#l48.329"></a><span id="l48.329" class="difflineplus">+      mime_typep(obj-&gt;parent,</span>
<a href="#l48.330"></a><span id="l48.330" class="difflineplus">+                 (MimeObjectClass *)&amp;mimeMultipartAppleDoubleClass))</span>
<a href="#l48.331"></a><span id="l48.331">     goto done;</span>
<a href="#l48.332"></a><span id="l48.332"> #endif /* XP_MACOSX */</span>
<a href="#l48.333"></a><span id="l48.333"> </span>
<a href="#l48.334"></a><span id="l48.334" class="difflineminus">-  if (!abort_p &amp;&amp;</span>
<a href="#l48.335"></a><span id="l48.335" class="difflineminus">-      obj-&gt;output_p &amp;&amp;</span>
<a href="#l48.336"></a><span id="l48.336" class="difflineminus">-      obj-&gt;options &amp;&amp;</span>
<a href="#l48.337"></a><span id="l48.337" class="difflineminus">-      obj-&gt;options-&gt;write_html_p)</span>
<a href="#l48.338"></a><span id="l48.338" class="difflineminus">-  {</span>
<a href="#l48.339"></a><span id="l48.339" class="difflineplus">+  if (!abort_p &amp;&amp; obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; obj-&gt;options-&gt;write_html_p) {</span>
<a href="#l48.340"></a><span id="l48.340">     bool all_headers_p = obj-&gt;options-&gt;headers == MimeHeadersAll;</span>
<a href="#l48.341"></a><span id="l48.341" class="difflineminus">-    MimeDisplayOptions *newopt = obj-&gt;options;  /* copy it */</span>
<a href="#l48.342"></a><span id="l48.342" class="difflineplus">+    MimeDisplayOptions *newopt = obj-&gt;options; /* copy it */</span>
<a href="#l48.343"></a><span id="l48.343"> </span>
<a href="#l48.344"></a><span id="l48.344" class="difflineminus">-    char *ct = MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE,</span>
<a href="#l48.345"></a><span id="l48.345" class="difflineminus">-                               false, false);</span>
<a href="#l48.346"></a><span id="l48.346" class="difflineplus">+    char *ct = MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l48.347"></a><span id="l48.347">     char *at, *lexp, *size, *perm;</span>
<a href="#l48.348"></a><span id="l48.348">     char *url, *dir, *mode, *name, *site, *svr, *subj;</span>
<a href="#l48.349"></a><span id="l48.349">     char *h = 0, *lname = 0, *lurl = 0, *body = 0;</span>
<a href="#l48.350"></a><span id="l48.350">     MimeHeaders *hdrs = 0;</span>
<a href="#l48.351"></a><span id="l48.351"> </span>
<a href="#l48.352"></a><span id="l48.352">     if (!ct) return MIME_OUT_OF_MEMORY;</span>
<a href="#l48.353"></a><span id="l48.353"> </span>
<a href="#l48.354"></a><span id="l48.354" class="difflineminus">-    at   = MimeHeaders_get_parameter(ct, &quot;access-type&quot;, NULL, NULL);</span>
<a href="#l48.355"></a><span id="l48.355" class="difflineminus">-    lexp  = MimeHeaders_get_parameter(ct, &quot;expiration&quot;, NULL, NULL);</span>
<a href="#l48.356"></a><span id="l48.356" class="difflineplus">+    at = MimeHeaders_get_parameter(ct, &quot;access-type&quot;, NULL, NULL);</span>
<a href="#l48.357"></a><span id="l48.357" class="difflineplus">+    lexp = MimeHeaders_get_parameter(ct, &quot;expiration&quot;, NULL, NULL);</span>
<a href="#l48.358"></a><span id="l48.358">     size = MimeHeaders_get_parameter(ct, &quot;size&quot;, NULL, NULL);</span>
<a href="#l48.359"></a><span id="l48.359">     perm = MimeHeaders_get_parameter(ct, &quot;permission&quot;, NULL, NULL);</span>
<a href="#l48.360"></a><span id="l48.360" class="difflineminus">-    dir  = MimeHeaders_get_parameter(ct, &quot;directory&quot;, NULL, NULL);</span>
<a href="#l48.361"></a><span id="l48.361" class="difflineplus">+    dir = MimeHeaders_get_parameter(ct, &quot;directory&quot;, NULL, NULL);</span>
<a href="#l48.362"></a><span id="l48.362">     mode = MimeHeaders_get_parameter(ct, &quot;mode&quot;, NULL, NULL);</span>
<a href="#l48.363"></a><span id="l48.363">     name = MimeHeaders_get_parameter(ct, &quot;name&quot;, NULL, NULL);</span>
<a href="#l48.364"></a><span id="l48.364">     site = MimeHeaders_get_parameter(ct, &quot;site&quot;, NULL, NULL);</span>
<a href="#l48.365"></a><span id="l48.365" class="difflineminus">-    svr  = MimeHeaders_get_parameter(ct, &quot;server&quot;, NULL, NULL);</span>
<a href="#l48.366"></a><span id="l48.366" class="difflineplus">+    svr = MimeHeaders_get_parameter(ct, &quot;server&quot;, NULL, NULL);</span>
<a href="#l48.367"></a><span id="l48.367">     subj = MimeHeaders_get_parameter(ct, &quot;subject&quot;, NULL, NULL);</span>
<a href="#l48.368"></a><span id="l48.368" class="difflineminus">-    url  = MimeHeaders_get_parameter(ct, &quot;url&quot;, NULL, NULL);</span>
<a href="#l48.369"></a><span id="l48.369" class="difflineplus">+    url = MimeHeaders_get_parameter(ct, &quot;url&quot;, NULL, NULL);</span>
<a href="#l48.370"></a><span id="l48.370">     PR_FREEIF(ct);</span>
<a href="#l48.371"></a><span id="l48.371"> </span>
<a href="#l48.372"></a><span id="l48.372">     /* the *internal* content-type */</span>
<a href="#l48.373"></a><span id="l48.373" class="difflineminus">-    ct = MimeHeaders_get(bod-&gt;hdrs, HEADER_CONTENT_TYPE,</span>
<a href="#l48.374"></a><span id="l48.374" class="difflineminus">-                         true, false);</span>
<a href="#l48.375"></a><span id="l48.375" class="difflineplus">+    ct = MimeHeaders_get(bod-&gt;hdrs, HEADER_CONTENT_TYPE, true, false);</span>
<a href="#l48.376"></a><span id="l48.376"> </span>
<a href="#l48.377"></a><span id="l48.377" class="difflineminus">-    uint32_t hlen = ((at ? strlen(at) : 0) +</span>
<a href="#l48.378"></a><span id="l48.378" class="difflineminus">-                    (lexp ? strlen(lexp) : 0) +</span>
<a href="#l48.379"></a><span id="l48.379" class="difflineminus">-                    (size ? strlen(size) : 0) +</span>
<a href="#l48.380"></a><span id="l48.380" class="difflineminus">-                    (perm ? strlen(perm) : 0) +</span>
<a href="#l48.381"></a><span id="l48.381" class="difflineminus">-                    (dir ? strlen(dir) : 0) +</span>
<a href="#l48.382"></a><span id="l48.382" class="difflineminus">-                    (mode ? strlen(mode) : 0) +</span>
<a href="#l48.383"></a><span id="l48.383" class="difflineminus">-                    (name ? strlen(name) : 0) +</span>
<a href="#l48.384"></a><span id="l48.384" class="difflineminus">-                    (site ? strlen(site) : 0) +</span>
<a href="#l48.385"></a><span id="l48.385" class="difflineminus">-                    (svr ? strlen(svr) : 0) +</span>
<a href="#l48.386"></a><span id="l48.386" class="difflineminus">-                    (subj ? strlen(subj) : 0) +</span>
<a href="#l48.387"></a><span id="l48.387" class="difflineminus">-                    (ct ? strlen(ct) : 0) +</span>
<a href="#l48.388"></a><span id="l48.388" class="difflineminus">-                    (url ? strlen(url) : 0) + 100);</span>
<a href="#l48.389"></a><span id="l48.389" class="difflineplus">+    uint32_t hlen = ((at ? strlen(at) : 0) + (lexp ? strlen(lexp) : 0) +</span>
<a href="#l48.390"></a><span id="l48.390" class="difflineplus">+                     (size ? strlen(size) : 0) + (perm ? strlen(perm) : 0) +</span>
<a href="#l48.391"></a><span id="l48.391" class="difflineplus">+                     (dir ? strlen(dir) : 0) + (mode ? strlen(mode) : 0) +</span>
<a href="#l48.392"></a><span id="l48.392" class="difflineplus">+                     (name ? strlen(name) : 0) + (site ? strlen(site) : 0) +</span>
<a href="#l48.393"></a><span id="l48.393" class="difflineplus">+                     (svr ? strlen(svr) : 0) + (subj ? strlen(subj) : 0) +</span>
<a href="#l48.394"></a><span id="l48.394" class="difflineplus">+                     (ct ? strlen(ct) : 0) + (url ? strlen(url) : 0) + 100);</span>
<a href="#l48.395"></a><span id="l48.395"> </span>
<a href="#l48.396"></a><span id="l48.396" class="difflineminus">-    h = (char *) PR_MALLOC(hlen);</span>
<a href="#l48.397"></a><span id="l48.397" class="difflineminus">-    if (!h)</span>
<a href="#l48.398"></a><span id="l48.398" class="difflineminus">-    {</span>
<a href="#l48.399"></a><span id="l48.399" class="difflineplus">+    h = (char *)PR_MALLOC(hlen);</span>
<a href="#l48.400"></a><span id="l48.400" class="difflineplus">+    if (!h) {</span>
<a href="#l48.401"></a><span id="l48.401">       status = MIME_OUT_OF_MEMORY;</span>
<a href="#l48.402"></a><span id="l48.402">       goto FAIL;</span>
<a href="#l48.403"></a><span id="l48.403">     }</span>
<a href="#l48.404"></a><span id="l48.404"> </span>
<a href="#l48.405"></a><span id="l48.405">     /* If there's a URL parameter, remove all whitespace from it.</span>
<a href="#l48.406"></a><span id="l48.406">       (The URL parameter to one of these headers is stored with</span>
<a href="#l48.407"></a><span id="l48.407">        lines broken every 40 characters or less; it's assumed that</span>
<a href="#l48.408"></a><span id="l48.408">        all significant whitespace was URL-hex-encoded, and all the</span>
<a href="#l48.409"></a><span id="l48.409">        rest of it was inserted just to keep the lines short.)</span>
<a href="#l48.410"></a><span id="l48.410">       */</span>
<a href="#l48.411"></a><span id="l48.411" class="difflineminus">-    if (url)</span>
<a href="#l48.412"></a><span id="l48.412" class="difflineminus">-    {</span>
<a href="#l48.413"></a><span id="l48.413" class="difflineplus">+    if (url) {</span>
<a href="#l48.414"></a><span id="l48.414">       char *in, *out;</span>
<a href="#l48.415"></a><span id="l48.415">       for (in = url, out = url; *in; in++)</span>
<a href="#l48.416"></a><span id="l48.416" class="difflineminus">-        if (!IS_SPACE(*in))</span>
<a href="#l48.417"></a><span id="l48.417" class="difflineminus">-          *out++ = *in;</span>
<a href="#l48.418"></a><span id="l48.418" class="difflineplus">+        if (!IS_SPACE(*in)) *out++ = *in;</span>
<a href="#l48.419"></a><span id="l48.419">       *out = 0;</span>
<a href="#l48.420"></a><span id="l48.420">     }</span>
<a href="#l48.421"></a><span id="l48.421"> </span>
<a href="#l48.422"></a><span id="l48.422">     hdrs = MimeHeaders_new();</span>
<a href="#l48.423"></a><span id="l48.423" class="difflineminus">-    if (!hdrs)</span>
<a href="#l48.424"></a><span id="l48.424" class="difflineminus">-    {</span>
<a href="#l48.425"></a><span id="l48.425" class="difflineplus">+    if (!hdrs) {</span>
<a href="#l48.426"></a><span id="l48.426">       status = MIME_OUT_OF_MEMORY;</span>
<a href="#l48.427"></a><span id="l48.427">       goto FAIL;</span>
<a href="#l48.428"></a><span id="l48.428">     }</span>
<a href="#l48.429"></a><span id="l48.429"> </span>
<a href="#l48.430"></a><span id="l48.430" class="difflineminus">-# define FROB(STR,VAR) \</span>
<a href="#l48.431"></a><span id="l48.431" class="difflineminus">-    if (VAR) \</span>
<a href="#l48.432"></a><span id="l48.432" class="difflineminus">-    { \</span>
<a href="#l48.433"></a><span id="l48.433" class="difflineminus">-      PL_strncpyz(h, STR &quot;: &quot;, hlen); \</span>
<a href="#l48.434"></a><span id="l48.434" class="difflineminus">-        PL_strcatn(h, hlen, VAR); \</span>
<a href="#l48.435"></a><span id="l48.435" class="difflineminus">-          PL_strcatn(h, hlen, MSG_LINEBREAK); \</span>
<a href="#l48.436"></a><span id="l48.436" class="difflineminus">-            status = MimeHeaders_parse_line(h, strlen(h), hdrs); \</span>
<a href="#l48.437"></a><span id="l48.437" class="difflineminus">-              if (status &lt; 0) goto FAIL; \</span>
<a href="#l48.438"></a><span id="l48.438" class="difflineminus">-    }</span>
<a href="#l48.439"></a><span id="l48.439" class="difflineminus">-    FROB(&quot;Access-Type&quot;,  at);</span>
<a href="#l48.440"></a><span id="l48.440" class="difflineminus">-    FROB(&quot;URL&quot;,      url);</span>
<a href="#l48.441"></a><span id="l48.441" class="difflineminus">-    FROB(&quot;Site&quot;,      site);</span>
<a href="#l48.442"></a><span id="l48.442" class="difflineminus">-    FROB(&quot;Server&quot;,    svr);</span>
<a href="#l48.443"></a><span id="l48.443" class="difflineminus">-    FROB(&quot;Directory&quot;,    dir);</span>
<a href="#l48.444"></a><span id="l48.444" class="difflineminus">-    FROB(&quot;Name&quot;,      name);</span>
<a href="#l48.445"></a><span id="l48.445" class="difflineminus">-    FROB(&quot;Type&quot;,      ct);</span>
<a href="#l48.446"></a><span id="l48.446" class="difflineminus">-    FROB(&quot;Size&quot;,      size);</span>
<a href="#l48.447"></a><span id="l48.447" class="difflineminus">-    FROB(&quot;Mode&quot;,      mode);</span>
<a href="#l48.448"></a><span id="l48.448" class="difflineminus">-    FROB(&quot;Permission&quot;,  perm);</span>
<a href="#l48.449"></a><span id="l48.449" class="difflineminus">-    FROB(&quot;Expiration&quot;,  lexp);</span>
<a href="#l48.450"></a><span id="l48.450" class="difflineminus">-    FROB(&quot;Subject&quot;,    subj);</span>
<a href="#l48.451"></a><span id="l48.451" class="difflineminus">-# undef FROB</span>
<a href="#l48.452"></a><span id="l48.452" class="difflineplus">+#define FROB(STR, VAR)                                   \</span>
<a href="#l48.453"></a><span id="l48.453" class="difflineplus">+  if (VAR) {                                             \</span>
<a href="#l48.454"></a><span id="l48.454" class="difflineplus">+    PL_strncpyz(h, STR &quot;: &quot;, hlen);                      \</span>
<a href="#l48.455"></a><span id="l48.455" class="difflineplus">+    PL_strcatn(h, hlen, VAR);                            \</span>
<a href="#l48.456"></a><span id="l48.456" class="difflineplus">+    PL_strcatn(h, hlen, MSG_LINEBREAK);                  \</span>
<a href="#l48.457"></a><span id="l48.457" class="difflineplus">+    status = MimeHeaders_parse_line(h, strlen(h), hdrs); \</span>
<a href="#l48.458"></a><span id="l48.458" class="difflineplus">+    if (status &lt; 0) goto FAIL;                           \</span>
<a href="#l48.459"></a><span id="l48.459" class="difflineplus">+  }</span>
<a href="#l48.460"></a><span id="l48.460" class="difflineplus">+    FROB(&quot;Access-Type&quot;, at);</span>
<a href="#l48.461"></a><span id="l48.461" class="difflineplus">+    FROB(&quot;URL&quot;, url);</span>
<a href="#l48.462"></a><span id="l48.462" class="difflineplus">+    FROB(&quot;Site&quot;, site);</span>
<a href="#l48.463"></a><span id="l48.463" class="difflineplus">+    FROB(&quot;Server&quot;, svr);</span>
<a href="#l48.464"></a><span id="l48.464" class="difflineplus">+    FROB(&quot;Directory&quot;, dir);</span>
<a href="#l48.465"></a><span id="l48.465" class="difflineplus">+    FROB(&quot;Name&quot;, name);</span>
<a href="#l48.466"></a><span id="l48.466" class="difflineplus">+    FROB(&quot;Type&quot;, ct);</span>
<a href="#l48.467"></a><span id="l48.467" class="difflineplus">+    FROB(&quot;Size&quot;, size);</span>
<a href="#l48.468"></a><span id="l48.468" class="difflineplus">+    FROB(&quot;Mode&quot;, mode);</span>
<a href="#l48.469"></a><span id="l48.469" class="difflineplus">+    FROB(&quot;Permission&quot;, perm);</span>
<a href="#l48.470"></a><span id="l48.470" class="difflineplus">+    FROB(&quot;Expiration&quot;, lexp);</span>
<a href="#l48.471"></a><span id="l48.471" class="difflineplus">+    FROB(&quot;Subject&quot;, subj);</span>
<a href="#l48.472"></a><span id="l48.472" class="difflineplus">+#undef FROB</span>
<a href="#l48.473"></a><span id="l48.473">     PL_strncpyz(h, MSG_LINEBREAK, hlen);</span>
<a href="#l48.474"></a><span id="l48.474">     status = MimeHeaders_parse_line(h, strlen(h), hdrs);</span>
<a href="#l48.475"></a><span id="l48.475">     if (status &lt; 0) goto FAIL;</span>
<a href="#l48.476"></a><span id="l48.476"> </span>
<a href="#l48.477"></a><span id="l48.477" class="difflineminus">-    lurl = MimeExternalBody_make_url(ct, at, lexp, size, perm, dir, mode,</span>
<a href="#l48.478"></a><span id="l48.478" class="difflineminus">-                                     name, url, site, svr, subj, bod-&gt;body);</span>
<a href="#l48.479"></a><span id="l48.479" class="difflineminus">-    if (lurl)</span>
<a href="#l48.480"></a><span id="l48.480" class="difflineminus">-    {</span>
<a href="#l48.481"></a><span id="l48.481" class="difflineplus">+    lurl = MimeExternalBody_make_url(ct, at, lexp, size, perm, dir, mode, name,</span>
<a href="#l48.482"></a><span id="l48.482" class="difflineplus">+                                     url, site, svr, subj, bod-&gt;body);</span>
<a href="#l48.483"></a><span id="l48.483" class="difflineplus">+    if (lurl) {</span>
<a href="#l48.484"></a><span id="l48.484">       lname = MimeGetStringByID(MIME_MSG_LINK_TO_DOCUMENT);</span>
<a href="#l48.485"></a><span id="l48.485" class="difflineminus">-    }</span>
<a href="#l48.486"></a><span id="l48.486" class="difflineminus">-    else</span>
<a href="#l48.487"></a><span id="l48.487" class="difflineminus">-    {</span>
<a href="#l48.488"></a><span id="l48.488" class="difflineplus">+    } else {</span>
<a href="#l48.489"></a><span id="l48.489">       lname = MimeGetStringByID(MIME_MSG_DOCUMENT_INFO);</span>
<a href="#l48.490"></a><span id="l48.490">       all_headers_p = true;</span>
<a href="#l48.491"></a><span id="l48.491">     }</span>
<a href="#l48.492"></a><span id="l48.492"> </span>
<a href="#l48.493"></a><span id="l48.493" class="difflineminus">-    all_headers_p = true;  /* #### just do this all the time? */</span>
<a href="#l48.494"></a><span id="l48.494" class="difflineplus">+    all_headers_p = true; /* #### just do this all the time? */</span>
<a href="#l48.495"></a><span id="l48.495"> </span>
<a href="#l48.496"></a><span id="l48.496" class="difflineminus">-    if (bod-&gt;body &amp;&amp; all_headers_p)</span>
<a href="#l48.497"></a><span id="l48.497" class="difflineminus">-    {</span>
<a href="#l48.498"></a><span id="l48.498" class="difflineplus">+    if (bod-&gt;body &amp;&amp; all_headers_p) {</span>
<a href="#l48.499"></a><span id="l48.499">       char *s = bod-&gt;body;</span>
<a href="#l48.500"></a><span id="l48.500">       while (IS_SPACE(*s)) s++;</span>
<a href="#l48.501"></a><span id="l48.501" class="difflineminus">-      if (*s)</span>
<a href="#l48.502"></a><span id="l48.502" class="difflineminus">-      {</span>
<a href="#l48.503"></a><span id="l48.503" class="difflineplus">+      if (*s) {</span>
<a href="#l48.504"></a><span id="l48.504">         const char *pre = &quot;&lt;P&gt;&lt;PRE&gt;&quot;;</span>
<a href="#l48.505"></a><span id="l48.505">         const char *suf = &quot;&lt;/PRE&gt;&quot;;</span>
<a href="#l48.506"></a><span id="l48.506">         int32_t i;</span>
<a href="#l48.507"></a><span id="l48.507" class="difflineminus">-        for(i = strlen(s)-1; i &gt;= 0 &amp;&amp; IS_SPACE(s[i]); i--)</span>
<a href="#l48.508"></a><span id="l48.508" class="difflineminus">-          s[i] = 0;</span>
<a href="#l48.509"></a><span id="l48.509" class="difflineplus">+        for (i = strlen(s) - 1; i &gt;= 0 &amp;&amp; IS_SPACE(s[i]); i--) s[i] = 0;</span>
<a href="#l48.510"></a><span id="l48.510">         nsCString s2;</span>
<a href="#l48.511"></a><span id="l48.511">         nsAppendEscapedHTML(nsDependentCString(s), s2);</span>
<a href="#l48.512"></a><span id="l48.512" class="difflineminus">-        body = (char *) PR_MALLOC(strlen(pre) + s2.Length() +</span>
<a href="#l48.513"></a><span id="l48.513" class="difflineminus">-                                  strlen(suf) + 1);</span>
<a href="#l48.514"></a><span id="l48.514" class="difflineminus">-        if (!body)</span>
<a href="#l48.515"></a><span id="l48.515" class="difflineminus">-        {</span>
<a href="#l48.516"></a><span id="l48.516" class="difflineplus">+        body = (char *)PR_MALLOC(strlen(pre) + s2.Length() + strlen(suf) + 1);</span>
<a href="#l48.517"></a><span id="l48.517" class="difflineplus">+        if (!body) {</span>
<a href="#l48.518"></a><span id="l48.518">           goto FAIL;</span>
<a href="#l48.519"></a><span id="l48.519">         }</span>
<a href="#l48.520"></a><span id="l48.520">         PL_strcpy(body, pre);</span>
<a href="#l48.521"></a><span id="l48.521">         PL_strcat(body, s2.get());</span>
<a href="#l48.522"></a><span id="l48.522">         PL_strcat(body, suf);</span>
<a href="#l48.523"></a><span id="l48.523">       }</span>
<a href="#l48.524"></a><span id="l48.524">     }</span>
<a href="#l48.525"></a><span id="l48.525"> </span>
<a href="#l48.526"></a><span id="l48.526">     newopt-&gt;fancy_headers_p = true;</span>
<a href="#l48.527"></a><span id="l48.527">     newopt-&gt;headers = (all_headers_p ? MimeHeadersAll : MimeHeadersSome);</span>
<a href="#l48.528"></a><span id="l48.528"> </span>
<a href="#l48.529"></a><span id="l48.529" class="difflineminus">-FAIL:</span>
<a href="#l48.530"></a><span id="l48.530" class="difflineminus">-    if (hdrs)</span>
<a href="#l48.531"></a><span id="l48.531" class="difflineminus">-      MimeHeaders_free(hdrs);</span>
<a href="#l48.532"></a><span id="l48.532" class="difflineplus">+  FAIL:</span>
<a href="#l48.533"></a><span id="l48.533" class="difflineplus">+    if (hdrs) MimeHeaders_free(hdrs);</span>
<a href="#l48.534"></a><span id="l48.534">     PR_FREEIF(h);</span>
<a href="#l48.535"></a><span id="l48.535">     PR_FREEIF(lname);</span>
<a href="#l48.536"></a><span id="l48.536">     PR_FREEIF(lurl);</span>
<a href="#l48.537"></a><span id="l48.537">     PR_FREEIF(body);</span>
<a href="#l48.538"></a><span id="l48.538">     PR_FREEIF(ct);</span>
<a href="#l48.539"></a><span id="l48.539">     PR_FREEIF(at);</span>
<a href="#l48.540"></a><span id="l48.540">     PR_FREEIF(lexp);</span>
<a href="#l48.541"></a><span id="l48.541">     PR_FREEIF(size);</span>
<a href="#l48.542"></a><span id="l48.542" class="difflineat">@@ -421,21 +363,21 @@ FAIL:</span>
<a href="#l48.543"></a><span id="l48.543">     PR_FREEIF(svr);</span>
<a href="#l48.544"></a><span id="l48.544">     PR_FREEIF(subj);</span>
<a href="#l48.545"></a><span id="l48.545">   }</span>
<a href="#l48.546"></a><span id="l48.546"> </span>
<a href="#l48.547"></a><span id="l48.547"> #ifdef XP_MACOSX</span>
<a href="#l48.548"></a><span id="l48.548"> done:</span>
<a href="#l48.549"></a><span id="l48.549"> #endif</span>
<a href="#l48.550"></a><span id="l48.550"> </span>
<a href="#l48.551"></a><span id="l48.551" class="difflineminus">-    return status;</span>
<a href="#l48.552"></a><span id="l48.552" class="difflineplus">+  return status;</span>
<a href="#l48.553"></a><span id="l48.553"> }</span>
<a href="#l48.554"></a><span id="l48.554"> </span>
<a href="#l48.555"></a><span id="l48.555"> #if 0</span>
<a href="#l48.556"></a><span id="l48.556" class="difflineminus">-#if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l48.557"></a><span id="l48.557" class="difflineplus">+#  if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l48.558"></a><span id="l48.558"> static int</span>
<a href="#l48.559"></a><span id="l48.559"> MimeExternalBody_debug_print (MimeObject *obj, PRFileDesc *stream, int32_t depth)</span>
<a href="#l48.560"></a><span id="l48.560"> {</span>
<a href="#l48.561"></a><span id="l48.561">   MimeExternalBody *bod = (MimeExternalBody *) obj;</span>
<a href="#l48.562"></a><span id="l48.562">   int i;</span>
<a href="#l48.563"></a><span id="l48.563">   char *ct, *ct2;</span>
<a href="#l48.564"></a><span id="l48.564">   char *addr = mime_part_address(obj);</span>
<a href="#l48.565"></a><span id="l48.565"> </span>
<a href="#l48.566"></a><span id="l48.566" class="difflineat">@@ -459,47 +401,41 @@ MimeExternalBody_debug_print (MimeObject</span>
<a href="#l48.567"></a><span id="l48.567">       bod-&gt;body ? bod-&gt;body : &quot;&lt;none&gt;&quot;,</span>
<a href="#l48.568"></a><span id="l48.568">       (uint32_t) obj);</span>
<a href="#l48.569"></a><span id="l48.569"> ***/</span>
<a href="#l48.570"></a><span id="l48.570">   PR_FREEIF(addr);</span>
<a href="#l48.571"></a><span id="l48.571">   PR_FREEIF(ct);</span>
<a href="#l48.572"></a><span id="l48.572">   PR_FREEIF(ct2);</span>
<a href="#l48.573"></a><span id="l48.573">   return 0;</span>
<a href="#l48.574"></a><span id="l48.574"> }</span>
<a href="#l48.575"></a><span id="l48.575" class="difflineminus">-#endif</span>
<a href="#l48.576"></a><span id="l48.576" class="difflineplus">+#  endif</span>
<a href="#l48.577"></a><span id="l48.577"> #endif /* 0 */</span>
<a href="#l48.578"></a><span id="l48.578"> </span>
<a href="#l48.579"></a><span id="l48.579" class="difflineminus">-static bool</span>
<a href="#l48.580"></a><span id="l48.580" class="difflineminus">-MimeExternalBody_displayable_inline_p (MimeObjectClass *clazz,</span>
<a href="#l48.581"></a><span id="l48.581" class="difflineminus">-                     MimeHeaders *hdrs)</span>
<a href="#l48.582"></a><span id="l48.582" class="difflineminus">-{</span>
<a href="#l48.583"></a><span id="l48.583" class="difflineminus">-  char *ct = MimeHeaders_get (hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l48.584"></a><span id="l48.584" class="difflineplus">+static bool MimeExternalBody_displayable_inline_p(MimeObjectClass *clazz,</span>
<a href="#l48.585"></a><span id="l48.585" class="difflineplus">+                                                  MimeHeaders *hdrs) {</span>
<a href="#l48.586"></a><span id="l48.586" class="difflineplus">+  char *ct = MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l48.587"></a><span id="l48.587">   char *at = MimeHeaders_get_parameter(ct, &quot;access-type&quot;, NULL, NULL);</span>
<a href="#l48.588"></a><span id="l48.588">   bool inline_p = false;</span>
<a href="#l48.589"></a><span id="l48.589"> </span>
<a href="#l48.590"></a><span id="l48.590">   if (!at)</span>
<a href="#l48.591"></a><span id="l48.591" class="difflineminus">-  ;</span>
<a href="#l48.592"></a><span id="l48.592" class="difflineminus">-  else if (!PL_strcasecmp(at, &quot;ftp&quot;) ||</span>
<a href="#l48.593"></a><span id="l48.593" class="difflineminus">-       !PL_strcasecmp(at, &quot;anon-ftp&quot;) ||</span>
<a href="#l48.594"></a><span id="l48.594" class="difflineminus">-       !PL_strcasecmp(at, &quot;local-file&quot;) ||</span>
<a href="#l48.595"></a><span id="l48.595" class="difflineminus">-       !PL_strcasecmp(at, &quot;mail-server&quot;) ||</span>
<a href="#l48.596"></a><span id="l48.596" class="difflineminus">-       !PL_strcasecmp(at, &quot;url&quot;))</span>
<a href="#l48.597"></a><span id="l48.597" class="difflineminus">-  inline_p = true;</span>
<a href="#l48.598"></a><span id="l48.598" class="difflineplus">+    ;</span>
<a href="#l48.599"></a><span id="l48.599" class="difflineplus">+  else if (!PL_strcasecmp(at, &quot;ftp&quot;) || !PL_strcasecmp(at, &quot;anon-ftp&quot;) ||</span>
<a href="#l48.600"></a><span id="l48.600" class="difflineplus">+           !PL_strcasecmp(at, &quot;local-file&quot;) ||</span>
<a href="#l48.601"></a><span id="l48.601" class="difflineplus">+           !PL_strcasecmp(at, &quot;mail-server&quot;) || !PL_strcasecmp(at, &quot;url&quot;))</span>
<a href="#l48.602"></a><span id="l48.602" class="difflineplus">+    inline_p = true;</span>
<a href="#l48.603"></a><span id="l48.603"> #ifdef XP_UNIX</span>
<a href="#l48.604"></a><span id="l48.604" class="difflineminus">-  else if (!PL_strcasecmp(at, &quot;afs&quot;))   /* only if there is a /afs/ directory */</span>
<a href="#l48.605"></a><span id="l48.605" class="difflineplus">+  else if (!PL_strcasecmp(at, &quot;afs&quot;)) /* only if there is a /afs/ directory */</span>
<a href="#l48.606"></a><span id="l48.606">   {</span>
<a href="#l48.607"></a><span id="l48.607" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; fs = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l48.608"></a><span id="l48.608" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; fs = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l48.609"></a><span id="l48.609">     bool exists = false;</span>
<a href="#l48.610"></a><span id="l48.610" class="difflineminus">-    if (fs)</span>
<a href="#l48.611"></a><span id="l48.611" class="difflineminus">-    {</span>
<a href="#l48.612"></a><span id="l48.612" class="difflineplus">+    if (fs) {</span>
<a href="#l48.613"></a><span id="l48.613">       fs-&gt;InitWithNativePath(NS_LITERAL_CSTRING(&quot;/afs/.&quot;));</span>
<a href="#l48.614"></a><span id="l48.614">       fs-&gt;Exists(&amp;exists);</span>
<a href="#l48.615"></a><span id="l48.615">     }</span>
<a href="#l48.616"></a><span id="l48.616" class="difflineminus">-    if  (!exists)</span>
<a href="#l48.617"></a><span id="l48.617" class="difflineminus">-      return 0;</span>
<a href="#l48.618"></a><span id="l48.618" class="difflineplus">+    if (!exists) return 0;</span>
<a href="#l48.619"></a><span id="l48.619"> </span>
<a href="#l48.620"></a><span id="l48.620">     inline_p = true;</span>
<a href="#l48.621"></a><span id="l48.621">   }</span>
<a href="#l48.622"></a><span id="l48.622"> #endif /* XP_UNIX */</span>
<a href="#l48.623"></a><span id="l48.623"> </span>
<a href="#l48.624"></a><span id="l48.624">   PR_FREEIF(ct);</span>
<a href="#l48.625"></a><span id="l48.625">   PR_FREEIF(at);</span>
<a href="#l48.626"></a><span id="l48.626">   return inline_p;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/mime/src/mimeebod.h</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/mime/src/mimeebod.h</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -10,28 +10,28 @@</span>
<a href="#l49.4"></a><span id="l49.4"> </span>
<a href="#l49.5"></a><span id="l49.5"> /* The MimeExternalBody class implements the message/external-body MIME type.</span>
<a href="#l49.6"></a><span id="l49.6">    (This is not to be confused with MimeExternalObject, which implements the</span>
<a href="#l49.7"></a><span id="l49.7">    handler for application/octet-stream and other types with no more specific</span>
<a href="#l49.8"></a><span id="l49.8">    handlers.)</span>
<a href="#l49.9"></a><span id="l49.9">  */</span>
<a href="#l49.10"></a><span id="l49.10"> </span>
<a href="#l49.11"></a><span id="l49.11"> typedef struct MimeExternalBodyClass MimeExternalBodyClass;</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-typedef struct MimeExternalBody      MimeExternalBody;</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+typedef struct MimeExternalBody MimeExternalBody;</span>
<a href="#l49.14"></a><span id="l49.14"> </span>
<a href="#l49.15"></a><span id="l49.15"> struct MimeExternalBodyClass {</span>
<a href="#l49.16"></a><span id="l49.16">   MimeObjectClass object;</span>
<a href="#l49.17"></a><span id="l49.17"> };</span>
<a href="#l49.18"></a><span id="l49.18"> </span>
<a href="#l49.19"></a><span id="l49.19"> extern MimeExternalBodyClass mimeExternalBodyClass;</span>
<a href="#l49.20"></a><span id="l49.20"> </span>
<a href="#l49.21"></a><span id="l49.21"> struct MimeExternalBody {</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineminus">-  MimeObject object;      /* superclass variables */</span>
<a href="#l49.23"></a><span id="l49.23" class="difflineminus">-  MimeHeaders *hdrs;      /* headers within this external-body, which</span>
<a href="#l49.24"></a><span id="l49.24" class="difflineminus">-                   describe the network data which this body</span>
<a href="#l49.25"></a><span id="l49.25" class="difflineminus">-                   is a pointer to. */</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineminus">-  char *body;          /* The &quot;phantom body&quot; of this link. */</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineplus">+  MimeObject object; /* superclass variables */</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineplus">+  MimeHeaders *hdrs; /* headers within this external-body, which</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineplus">+              describe the network data which this body</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineplus">+              is a pointer to. */</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineplus">+  char *body;        /* The &quot;phantom body&quot; of this link. */</span>
<a href="#l49.32"></a><span id="l49.32"> };</span>
<a href="#l49.33"></a><span id="l49.33"> </span>
<a href="#l49.34"></a><span id="l49.34" class="difflineminus">-#define MimeExternalBodyClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l49.35"></a><span id="l49.35" class="difflineminus">-  { MimeObjectClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l49.36"></a><span id="l49.36" class="difflineplus">+#define MimeExternalBodyClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l49.37"></a><span id="l49.37" class="difflineplus">+  { MimeObjectClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l49.38"></a><span id="l49.38"> </span>
<a href="#l49.39"></a><span id="l49.39"> #endif /* _MIMEEBOD_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/mime/src/mimeenc.cpp</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/mime/src/mimeenc.cpp</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -3,462 +3,417 @@</span>
<a href="#l50.4"></a><span id="l50.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l50.5"></a><span id="l50.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l50.6"></a><span id="l50.6"> #include &lt;stdio.h&gt;</span>
<a href="#l50.7"></a><span id="l50.7"> #include &quot;mimei.h&quot;</span>
<a href="#l50.8"></a><span id="l50.8"> #include &quot;prmem.h&quot;</span>
<a href="#l50.9"></a><span id="l50.9"> #include &quot;mimeobj.h&quot;</span>
<a href="#l50.10"></a><span id="l50.10"> #include &quot;mozilla/RangedPtr.h&quot;</span>
<a href="#l50.11"></a><span id="l50.11"> #include &quot;mozilla/mailnews/MimeEncoder.h&quot;</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-#include &quot;modmimee.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+#include &quot;modmimee.h&quot;  // for MimeConverterOutputCallback</span>
<a href="#l50.14"></a><span id="l50.14"> </span>
<a href="#l50.15"></a><span id="l50.15"> typedef enum mime_encoding {</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineminus">-  mime_Base64, mime_QuotedPrintable, mime_uuencode, mime_yencode</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineplus">+  mime_Base64,</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineplus">+  mime_QuotedPrintable,</span>
<a href="#l50.19"></a><span id="l50.19" class="difflineplus">+  mime_uuencode,</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineplus">+  mime_yencode</span>
<a href="#l50.21"></a><span id="l50.21"> } mime_encoding;</span>
<a href="#l50.22"></a><span id="l50.22"> </span>
<a href="#l50.23"></a><span id="l50.23"> typedef enum mime_decoder_state {</span>
<a href="#l50.24"></a><span id="l50.24" class="difflineminus">-  DS_BEGIN, DS_BODY, DS_END</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineplus">+  DS_BEGIN,</span>
<a href="#l50.26"></a><span id="l50.26" class="difflineplus">+  DS_BODY,</span>
<a href="#l50.27"></a><span id="l50.27" class="difflineplus">+  DS_END</span>
<a href="#l50.28"></a><span id="l50.28"> } mime_decoder_state;</span>
<a href="#l50.29"></a><span id="l50.29"> </span>
<a href="#l50.30"></a><span id="l50.30"> struct MimeDecoderData {</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-  mime_encoding encoding;    /* Which encoding to use */</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+  mime_encoding encoding; /* Which encoding to use */</span>
<a href="#l50.33"></a><span id="l50.33"> </span>
<a href="#l50.34"></a><span id="l50.34">   /* A read-buffer used for QP and B64. */</span>
<a href="#l50.35"></a><span id="l50.35">   char token[4];</span>
<a href="#l50.36"></a><span id="l50.36">   int token_size;</span>
<a href="#l50.37"></a><span id="l50.37"> </span>
<a href="#l50.38"></a><span id="l50.38">   /* State and read-buffer used for uudecode and yencode. */</span>
<a href="#l50.39"></a><span id="l50.39">   mime_decoder_state ds_state;</span>
<a href="#l50.40"></a><span id="l50.40">   char *line_buffer;</span>
<a href="#l50.41"></a><span id="l50.41">   int line_buffer_size;</span>
<a href="#l50.42"></a><span id="l50.42"> </span>
<a href="#l50.43"></a><span id="l50.43" class="difflineminus">-  MimeObject *objectToDecode; // might be null, only used for QP currently</span>
<a href="#l50.44"></a><span id="l50.44" class="difflineplus">+  MimeObject *objectToDecode;  // might be null, only used for QP currently</span>
<a href="#l50.45"></a><span id="l50.45">   /* Where to write the decoded data */</span>
<a href="#l50.46"></a><span id="l50.46">   MimeConverterOutputCallback write_buffer;</span>
<a href="#l50.47"></a><span id="l50.47">   void *closure;</span>
<a href="#l50.48"></a><span id="l50.48"> };</span>
<a href="#l50.49"></a><span id="l50.49"> </span>
<a href="#l50.50"></a><span id="l50.50" class="difflineminus">-</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineminus">-static int</span>
<a href="#l50.52"></a><span id="l50.52" class="difflineminus">-mime_decode_qp_buffer (MimeDecoderData *data, const char *buffer,</span>
<a href="#l50.53"></a><span id="l50.53" class="difflineminus">-          int32_t length, int32_t *outSize)</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineminus">-{</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineplus">+static int mime_decode_qp_buffer(MimeDecoderData *data, const char *buffer,</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineplus">+                                 int32_t length, int32_t *outSize) {</span>
<a href="#l50.57"></a><span id="l50.57">   /* Warning, we are overwriting the buffer which was passed in.</span>
<a href="#l50.58"></a><span id="l50.58">    This is ok, because decoding these formats will never result</span>
<a href="#l50.59"></a><span id="l50.59">    in larger data than the input, only smaller. */</span>
<a href="#l50.60"></a><span id="l50.60" class="difflineminus">-  const char *in  = buffer;</span>
<a href="#l50.61"></a><span id="l50.61" class="difflineminus">-  char *out = (char *) buffer;</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineminus">-  char token [3];</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineplus">+  const char *in = buffer;</span>
<a href="#l50.64"></a><span id="l50.64" class="difflineplus">+  char *out = (char *)buffer;</span>
<a href="#l50.65"></a><span id="l50.65" class="difflineplus">+  char token[3];</span>
<a href="#l50.66"></a><span id="l50.66">   int i;</span>
<a href="#l50.67"></a><span id="l50.67"> </span>
<a href="#l50.68"></a><span id="l50.68" class="difflineminus">-  NS_ASSERTION(data-&gt;encoding == mime_QuotedPrintable, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineplus">+  NS_ASSERTION(data-&gt;encoding == mime_QuotedPrintable,</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.71"></a><span id="l50.71">   if (data-&gt;encoding != mime_QuotedPrintable) return -1;</span>
<a href="#l50.72"></a><span id="l50.72"> </span>
<a href="#l50.73"></a><span id="l50.73">   /* For the first pass, initialize the token from the unread-buffer. */</span>
<a href="#l50.74"></a><span id="l50.74">   i = 0;</span>
<a href="#l50.75"></a><span id="l50.75" class="difflineminus">-  while (i &lt; 3 &amp;&amp; data-&gt;token_size &gt; 0)</span>
<a href="#l50.76"></a><span id="l50.76" class="difflineminus">-  {</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineminus">-    token [i] = data-&gt;token[i];</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineplus">+  while (i &lt; 3 &amp;&amp; data-&gt;token_size &gt; 0) {</span>
<a href="#l50.79"></a><span id="l50.79" class="difflineplus">+    token[i] = data-&gt;token[i];</span>
<a href="#l50.80"></a><span id="l50.80">     data-&gt;token_size--;</span>
<a href="#l50.81"></a><span id="l50.81">     i++;</span>
<a href="#l50.82"></a><span id="l50.82">   }</span>
<a href="#l50.83"></a><span id="l50.83"> </span>
<a href="#l50.84"></a><span id="l50.84">   /* #### BUG: when decoding quoted-printable, we are required to</span>
<a href="#l50.85"></a><span id="l50.85">    strip trailing whitespace from lines -- since when encoding in</span>
<a href="#l50.86"></a><span id="l50.86">    qp, one is required to quote such trailing whitespace, any</span>
<a href="#l50.87"></a><span id="l50.87">    trailing whitespace which remains must have been introduced</span>
<a href="#l50.88"></a><span id="l50.88">    by a stupid gateway. */</span>
<a href="#l50.89"></a><span id="l50.89"> </span>
<a href="#l50.90"></a><span id="l50.90">   /* Treat null bytes as spaces when format_out is</span>
<a href="#l50.91"></a><span id="l50.91">    nsMimeOutput::nsMimeMessageBodyDisplay (see bug 243199 comment 7) */</span>
<a href="#l50.92"></a><span id="l50.92" class="difflineminus">-  bool treatNullAsSpace = data-&gt;objectToDecode &amp;&amp;</span>
<a href="#l50.93"></a><span id="l50.93" class="difflineminus">-                            data-&gt;objectToDecode-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay;</span>
<a href="#l50.94"></a><span id="l50.94" class="difflineplus">+  bool treatNullAsSpace =</span>
<a href="#l50.95"></a><span id="l50.95" class="difflineplus">+      data-&gt;objectToDecode &amp;&amp; data-&gt;objectToDecode-&gt;options-&gt;format_out ==</span>
<a href="#l50.96"></a><span id="l50.96" class="difflineplus">+                                  nsMimeOutput::nsMimeMessageBodyDisplay;</span>
<a href="#l50.97"></a><span id="l50.97"> </span>
<a href="#l50.98"></a><span id="l50.98" class="difflineminus">-  while (length &gt; 0 || i != 0)</span>
<a href="#l50.99"></a><span id="l50.99" class="difflineminus">-  {</span>
<a href="#l50.100"></a><span id="l50.100" class="difflineminus">-    while (i &lt; 3 &amp;&amp; length &gt; 0)</span>
<a href="#l50.101"></a><span id="l50.101" class="difflineminus">-    {</span>
<a href="#l50.102"></a><span id="l50.102" class="difflineminus">-      token [i++] = *in;</span>
<a href="#l50.103"></a><span id="l50.103" class="difflineplus">+  while (length &gt; 0 || i != 0) {</span>
<a href="#l50.104"></a><span id="l50.104" class="difflineplus">+    while (i &lt; 3 &amp;&amp; length &gt; 0) {</span>
<a href="#l50.105"></a><span id="l50.105" class="difflineplus">+      token[i++] = *in;</span>
<a href="#l50.106"></a><span id="l50.106">       in++;</span>
<a href="#l50.107"></a><span id="l50.107">       length--;</span>
<a href="#l50.108"></a><span id="l50.108">     }</span>
<a href="#l50.109"></a><span id="l50.109"> </span>
<a href="#l50.110"></a><span id="l50.110" class="difflineminus">-    if (i &lt; 3)</span>
<a href="#l50.111"></a><span id="l50.111" class="difflineminus">-    {</span>
<a href="#l50.112"></a><span id="l50.112" class="difflineplus">+    if (i &lt; 3) {</span>
<a href="#l50.113"></a><span id="l50.113">       /* Didn't get enough for a complete token.</span>
<a href="#l50.114"></a><span id="l50.114">        If it might be a token, unread it.</span>
<a href="#l50.115"></a><span id="l50.115">        Otherwise, just dump it.</span>
<a href="#l50.116"></a><span id="l50.116">        */</span>
<a href="#l50.117"></a><span id="l50.117" class="difflineminus">-      memcpy (data-&gt;token, token, i);</span>
<a href="#l50.118"></a><span id="l50.118" class="difflineplus">+      memcpy(data-&gt;token, token, i);</span>
<a href="#l50.119"></a><span id="l50.119">       data-&gt;token_size = i;</span>
<a href="#l50.120"></a><span id="l50.120">       i = 0;</span>
<a href="#l50.121"></a><span id="l50.121">       length = 0;</span>
<a href="#l50.122"></a><span id="l50.122">       break;</span>
<a href="#l50.123"></a><span id="l50.123">     }</span>
<a href="#l50.124"></a><span id="l50.124">     i = 0;</span>
<a href="#l50.125"></a><span id="l50.125"> </span>
<a href="#l50.126"></a><span id="l50.126" class="difflineminus">-    if (token [0] == '=')</span>
<a href="#l50.127"></a><span id="l50.127" class="difflineminus">-    {</span>
<a href="#l50.128"></a><span id="l50.128" class="difflineplus">+    if (token[0] == '=') {</span>
<a href="#l50.129"></a><span id="l50.129">       unsigned char c = 0;</span>
<a href="#l50.130"></a><span id="l50.130">       if (token[1] &gt;= '0' &amp;&amp; token[1] &lt;= '9')</span>
<a href="#l50.131"></a><span id="l50.131" class="difflineminus">-      c = token[1] - '0';</span>
<a href="#l50.132"></a><span id="l50.132" class="difflineplus">+        c = token[1] - '0';</span>
<a href="#l50.133"></a><span id="l50.133">       else if (token[1] &gt;= 'A' &amp;&amp; token[1] &lt;= 'F')</span>
<a href="#l50.134"></a><span id="l50.134" class="difflineminus">-      c = token[1] - ('A' - 10);</span>
<a href="#l50.135"></a><span id="l50.135" class="difflineplus">+        c = token[1] - ('A' - 10);</span>
<a href="#l50.136"></a><span id="l50.136">       else if (token[1] &gt;= 'a' &amp;&amp; token[1] &lt;= 'f')</span>
<a href="#l50.137"></a><span id="l50.137" class="difflineminus">-      c = token[1] - ('a' - 10);</span>
<a href="#l50.138"></a><span id="l50.138" class="difflineminus">-      else if (token[1] == '\r' || token[1] == '\n')</span>
<a href="#l50.139"></a><span id="l50.139" class="difflineminus">-      {</span>
<a href="#l50.140"></a><span id="l50.140" class="difflineplus">+        c = token[1] - ('a' - 10);</span>
<a href="#l50.141"></a><span id="l50.141" class="difflineplus">+      else if (token[1] == '\r' || token[1] == '\n') {</span>
<a href="#l50.142"></a><span id="l50.142">         /* =\n means ignore the newline. */</span>
<a href="#l50.143"></a><span id="l50.143">         if (token[1] == '\r' &amp;&amp; token[2] == '\n')</span>
<a href="#l50.144"></a><span id="l50.144" class="difflineminus">-        ;    /* swallow all three chars */</span>
<a href="#l50.145"></a><span id="l50.145" class="difflineminus">-        else</span>
<a href="#l50.146"></a><span id="l50.146" class="difflineminus">-        {</span>
<a href="#l50.147"></a><span id="l50.147" class="difflineminus">-          in--;  /* put the third char back */</span>
<a href="#l50.148"></a><span id="l50.148" class="difflineplus">+          ; /* swallow all three chars */</span>
<a href="#l50.149"></a><span id="l50.149" class="difflineplus">+        else {</span>
<a href="#l50.150"></a><span id="l50.150" class="difflineplus">+          in--; /* put the third char back */</span>
<a href="#l50.151"></a><span id="l50.151">           length++;</span>
<a href="#l50.152"></a><span id="l50.152">         }</span>
<a href="#l50.153"></a><span id="l50.153">         continue;</span>
<a href="#l50.154"></a><span id="l50.154" class="difflineminus">-      }</span>
<a href="#l50.155"></a><span id="l50.155" class="difflineminus">-      else</span>
<a href="#l50.156"></a><span id="l50.156" class="difflineminus">-      {</span>
<a href="#l50.157"></a><span id="l50.157" class="difflineplus">+      } else {</span>
<a href="#l50.158"></a><span id="l50.158">         /* = followed by something other than hex or newline -</span>
<a href="#l50.159"></a><span id="l50.159">          pass it through unaltered, I guess.  (But, if</span>
<a href="#l50.160"></a><span id="l50.160">          this bogus token happened to occur over a buffer</span>
<a href="#l50.161"></a><span id="l50.161">          boundary, we can't do this, since we don't have</span>
<a href="#l50.162"></a><span id="l50.162">          space for it.  Oh well.  Screw it.)  */</span>
<a href="#l50.163"></a><span id="l50.163">         if (in &gt; out) *out++ = token[0];</span>
<a href="#l50.164"></a><span id="l50.164">         if (in &gt; out) *out++ = token[1];</span>
<a href="#l50.165"></a><span id="l50.165">         if (in &gt; out) *out++ = token[2];</span>
<a href="#l50.166"></a><span id="l50.166">         continue;</span>
<a href="#l50.167"></a><span id="l50.167">       }</span>
<a href="#l50.168"></a><span id="l50.168"> </span>
<a href="#l50.169"></a><span id="l50.169">       /* Second hex digit */</span>
<a href="#l50.170"></a><span id="l50.170">       c = (c &lt;&lt; 4);</span>
<a href="#l50.171"></a><span id="l50.171">       if (token[2] &gt;= '0' &amp;&amp; token[2] &lt;= '9')</span>
<a href="#l50.172"></a><span id="l50.172" class="difflineminus">-      c += token[2] - '0';</span>
<a href="#l50.173"></a><span id="l50.173" class="difflineplus">+        c += token[2] - '0';</span>
<a href="#l50.174"></a><span id="l50.174">       else if (token[2] &gt;= 'A' &amp;&amp; token[2] &lt;= 'F')</span>
<a href="#l50.175"></a><span id="l50.175" class="difflineminus">-      c += token[2] - ('A' - 10);</span>
<a href="#l50.176"></a><span id="l50.176" class="difflineplus">+        c += token[2] - ('A' - 10);</span>
<a href="#l50.177"></a><span id="l50.177">       else if (token[2] &gt;= 'a' &amp;&amp; token[2] &lt;= 'f')</span>
<a href="#l50.178"></a><span id="l50.178" class="difflineminus">-      c += token[2] - ('a' - 10);</span>
<a href="#l50.179"></a><span id="l50.179" class="difflineminus">-      else</span>
<a href="#l50.180"></a><span id="l50.180" class="difflineminus">-      {</span>
<a href="#l50.181"></a><span id="l50.181" class="difflineplus">+        c += token[2] - ('a' - 10);</span>
<a href="#l50.182"></a><span id="l50.182" class="difflineplus">+      else {</span>
<a href="#l50.183"></a><span id="l50.183">         /* We got =xy where &quot;x&quot; was hex and &quot;y&quot; was not, so</span>
<a href="#l50.184"></a><span id="l50.184">          treat that as a literal &quot;=&quot;, x, and y.  (But, if</span>
<a href="#l50.185"></a><span id="l50.185">          this bogus token happened to occur over a buffer</span>
<a href="#l50.186"></a><span id="l50.186">          boundary, we can't do this, since we don't have</span>
<a href="#l50.187"></a><span id="l50.187">          space for it.  Oh well.  Screw it.) */</span>
<a href="#l50.188"></a><span id="l50.188">         if (in &gt; out) *out++ = token[0];</span>
<a href="#l50.189"></a><span id="l50.189">         if (in &gt; out) *out++ = token[1];</span>
<a href="#l50.190"></a><span id="l50.190">         if (in &gt; out) *out++ = token[2];</span>
<a href="#l50.191"></a><span id="l50.191">         continue;</span>
<a href="#l50.192"></a><span id="l50.192">       }</span>
<a href="#l50.193"></a><span id="l50.193"> </span>
<a href="#l50.194"></a><span id="l50.194" class="difflineminus">-      *out++ = c ? (char) c : ((treatNullAsSpace) ? ' ' : (char) c);</span>
<a href="#l50.195"></a><span id="l50.195" class="difflineminus">-    }</span>
<a href="#l50.196"></a><span id="l50.196" class="difflineminus">-    else</span>
<a href="#l50.197"></a><span id="l50.197" class="difflineminus">-    {</span>
<a href="#l50.198"></a><span id="l50.198" class="difflineplus">+      *out++ = c ? (char)c : ((treatNullAsSpace) ? ' ' : (char)c);</span>
<a href="#l50.199"></a><span id="l50.199" class="difflineplus">+    } else {</span>
<a href="#l50.200"></a><span id="l50.200">       *out++ = token[0];</span>
<a href="#l50.201"></a><span id="l50.201"> </span>
<a href="#l50.202"></a><span id="l50.202">       token[0] = token[1];</span>
<a href="#l50.203"></a><span id="l50.203">       token[1] = token[2];</span>
<a href="#l50.204"></a><span id="l50.204">       i = 2;</span>
<a href="#l50.205"></a><span id="l50.205">     }</span>
<a href="#l50.206"></a><span id="l50.206">   }</span>
<a href="#l50.207"></a><span id="l50.207"> </span>
<a href="#l50.208"></a><span id="l50.208">   // Fill the size</span>
<a href="#l50.209"></a><span id="l50.209" class="difflineminus">-  if (outSize)</span>
<a href="#l50.210"></a><span id="l50.210" class="difflineminus">-    *outSize = out - buffer;</span>
<a href="#l50.211"></a><span id="l50.211" class="difflineplus">+  if (outSize) *outSize = out - buffer;</span>
<a href="#l50.212"></a><span id="l50.212"> </span>
<a href="#l50.213"></a><span id="l50.213">   /* Now that we've altered the data in place, write it. */</span>
<a href="#l50.214"></a><span id="l50.214">   if (out &gt; buffer)</span>
<a href="#l50.215"></a><span id="l50.215" class="difflineminus">-  return data-&gt;write_buffer (buffer, (out - buffer), data-&gt;closure);</span>
<a href="#l50.216"></a><span id="l50.216" class="difflineplus">+    return data-&gt;write_buffer(buffer, (out - buffer), data-&gt;closure);</span>
<a href="#l50.217"></a><span id="l50.217">   else</span>
<a href="#l50.218"></a><span id="l50.218" class="difflineminus">-  return 1;</span>
<a href="#l50.219"></a><span id="l50.219" class="difflineplus">+    return 1;</span>
<a href="#l50.220"></a><span id="l50.220"> }</span>
<a href="#l50.221"></a><span id="l50.221"> </span>
<a href="#l50.222"></a><span id="l50.222" class="difflineminus">-</span>
<a href="#l50.223"></a><span id="l50.223" class="difflineminus">-static int</span>
<a href="#l50.224"></a><span id="l50.224" class="difflineminus">-mime_decode_base64_token (const char *in, char *out)</span>
<a href="#l50.225"></a><span id="l50.225" class="difflineminus">-{</span>
<a href="#l50.226"></a><span id="l50.226" class="difflineplus">+static int mime_decode_base64_token(const char *in, char *out) {</span>
<a href="#l50.227"></a><span id="l50.227">   /* reads 4, writes 0-3.  Returns bytes written.</span>
<a href="#l50.228"></a><span id="l50.228">    (Writes less than 3 only at EOF.) */</span>
<a href="#l50.229"></a><span id="l50.229">   int j;</span>
<a href="#l50.230"></a><span id="l50.230">   int eq_count = 0;</span>
<a href="#l50.231"></a><span id="l50.231">   unsigned long num = 0;</span>
<a href="#l50.232"></a><span id="l50.232"> </span>
<a href="#l50.233"></a><span id="l50.233" class="difflineminus">-  for (j = 0; j &lt; 4; j++)</span>
<a href="#l50.234"></a><span id="l50.234" class="difflineminus">-  {</span>
<a href="#l50.235"></a><span id="l50.235" class="difflineplus">+  for (j = 0; j &lt; 4; j++) {</span>
<a href="#l50.236"></a><span id="l50.236">     unsigned char c = 0;</span>
<a href="#l50.237"></a><span id="l50.237" class="difflineminus">-    if (in[j] &gt;= 'A' &amp;&amp; in[j] &lt;= 'Z')     c = in[j] - 'A';</span>
<a href="#l50.238"></a><span id="l50.238" class="difflineminus">-    else if (in[j] &gt;= 'a' &amp;&amp; in[j] &lt;= 'z') c = in[j] - ('a' - 26);</span>
<a href="#l50.239"></a><span id="l50.239" class="difflineminus">-    else if (in[j] &gt;= '0' &amp;&amp; in[j] &lt;= '9') c = in[j] - ('0' - 52);</span>
<a href="#l50.240"></a><span id="l50.240" class="difflineminus">-    else if (in[j] == '+')         c = 62;</span>
<a href="#l50.241"></a><span id="l50.241" class="difflineminus">-    else if (in[j] == '/')         c = 63;</span>
<a href="#l50.242"></a><span id="l50.242" class="difflineminus">-    else if (in[j] == '=')         { c = 0; eq_count++; }</span>
<a href="#l50.243"></a><span id="l50.243" class="difflineminus">-    else</span>
<a href="#l50.244"></a><span id="l50.244" class="difflineminus">-    NS_ERROR(&quot;Invalid character&quot;);</span>
<a href="#l50.245"></a><span id="l50.245" class="difflineplus">+    if (in[j] &gt;= 'A' &amp;&amp; in[j] &lt;= 'Z')</span>
<a href="#l50.246"></a><span id="l50.246" class="difflineplus">+      c = in[j] - 'A';</span>
<a href="#l50.247"></a><span id="l50.247" class="difflineplus">+    else if (in[j] &gt;= 'a' &amp;&amp; in[j] &lt;= 'z')</span>
<a href="#l50.248"></a><span id="l50.248" class="difflineplus">+      c = in[j] - ('a' - 26);</span>
<a href="#l50.249"></a><span id="l50.249" class="difflineplus">+    else if (in[j] &gt;= '0' &amp;&amp; in[j] &lt;= '9')</span>
<a href="#l50.250"></a><span id="l50.250" class="difflineplus">+      c = in[j] - ('0' - 52);</span>
<a href="#l50.251"></a><span id="l50.251" class="difflineplus">+    else if (in[j] == '+')</span>
<a href="#l50.252"></a><span id="l50.252" class="difflineplus">+      c = 62;</span>
<a href="#l50.253"></a><span id="l50.253" class="difflineplus">+    else if (in[j] == '/')</span>
<a href="#l50.254"></a><span id="l50.254" class="difflineplus">+      c = 63;</span>
<a href="#l50.255"></a><span id="l50.255" class="difflineplus">+    else if (in[j] == '=') {</span>
<a href="#l50.256"></a><span id="l50.256" class="difflineplus">+      c = 0;</span>
<a href="#l50.257"></a><span id="l50.257" class="difflineplus">+      eq_count++;</span>
<a href="#l50.258"></a><span id="l50.258" class="difflineplus">+    } else</span>
<a href="#l50.259"></a><span id="l50.259" class="difflineplus">+      NS_ERROR(&quot;Invalid character&quot;);</span>
<a href="#l50.260"></a><span id="l50.260">     num = (num &lt;&lt; 6) | c;</span>
<a href="#l50.261"></a><span id="l50.261">   }</span>
<a href="#l50.262"></a><span id="l50.262"> </span>
<a href="#l50.263"></a><span id="l50.263" class="difflineminus">-  *out++ = (char) (num &gt;&gt; 16);</span>
<a href="#l50.264"></a><span id="l50.264" class="difflineminus">-  *out++ = (char) ((num &gt;&gt; 8) &amp; 0xFF);</span>
<a href="#l50.265"></a><span id="l50.265" class="difflineminus">-  *out++ = (char) (num &amp; 0xFF);</span>
<a href="#l50.266"></a><span id="l50.266" class="difflineplus">+  *out++ = (char)(num &gt;&gt; 16);</span>
<a href="#l50.267"></a><span id="l50.267" class="difflineplus">+  *out++ = (char)((num &gt;&gt; 8) &amp; 0xFF);</span>
<a href="#l50.268"></a><span id="l50.268" class="difflineplus">+  *out++ = (char)(num &amp; 0xFF);</span>
<a href="#l50.269"></a><span id="l50.269"> </span>
<a href="#l50.270"></a><span id="l50.270">   if (eq_count == 0)</span>
<a href="#l50.271"></a><span id="l50.271" class="difflineminus">-  return 3;        /* No &quot;=&quot; padding means 4 bytes mapped to 3. */</span>
<a href="#l50.272"></a><span id="l50.272" class="difflineplus">+    return 3; /* No &quot;=&quot; padding means 4 bytes mapped to 3. */</span>
<a href="#l50.273"></a><span id="l50.273">   else if (eq_count == 1)</span>
<a href="#l50.274"></a><span id="l50.274" class="difflineminus">-  return 2;        /* &quot;xxx=&quot; means 3 bytes mapped to 2. */</span>
<a href="#l50.275"></a><span id="l50.275" class="difflineplus">+    return 2; /* &quot;xxx=&quot; means 3 bytes mapped to 2. */</span>
<a href="#l50.276"></a><span id="l50.276">   else if (eq_count == 2)</span>
<a href="#l50.277"></a><span id="l50.277" class="difflineminus">-  return 1;        /* &quot;xx==&quot; means 2 bytes mapped to 1. */</span>
<a href="#l50.278"></a><span id="l50.278" class="difflineminus">-  else</span>
<a href="#l50.279"></a><span id="l50.279" class="difflineminus">-  {</span>
<a href="#l50.280"></a><span id="l50.280" class="difflineplus">+    return 1; /* &quot;xx==&quot; means 2 bytes mapped to 1. */</span>
<a href="#l50.281"></a><span id="l50.281" class="difflineplus">+  else {</span>
<a href="#l50.282"></a><span id="l50.282">     // &quot;x===&quot; can't happen, because &quot;x&quot; would then be encoding only</span>
<a href="#l50.283"></a><span id="l50.283">     // 6 bits, not the min of 8.</span>
<a href="#l50.284"></a><span id="l50.284">     NS_ERROR(&quot;Count is 6 bits, should be at least 8&quot;);</span>
<a href="#l50.285"></a><span id="l50.285">     return 1;</span>
<a href="#l50.286"></a><span id="l50.286">   }</span>
<a href="#l50.287"></a><span id="l50.287"> }</span>
<a href="#l50.288"></a><span id="l50.288"> </span>
<a href="#l50.289"></a><span id="l50.289" class="difflineminus">-</span>
<a href="#l50.290"></a><span id="l50.290" class="difflineminus">-static int</span>
<a href="#l50.291"></a><span id="l50.291" class="difflineminus">-mime_decode_base64_buffer (MimeDecoderData *data,</span>
<a href="#l50.292"></a><span id="l50.292" class="difflineminus">-               const char *buffer, int32_t length, int32_t *outSize)</span>
<a href="#l50.293"></a><span id="l50.293" class="difflineminus">-{</span>
<a href="#l50.294"></a><span id="l50.294" class="difflineminus">-  if (outSize)</span>
<a href="#l50.295"></a><span id="l50.295" class="difflineminus">-    *outSize = 0;</span>
<a href="#l50.296"></a><span id="l50.296" class="difflineplus">+static int mime_decode_base64_buffer(MimeDecoderData *data, const char *buffer,</span>
<a href="#l50.297"></a><span id="l50.297" class="difflineplus">+                                     int32_t length, int32_t *outSize) {</span>
<a href="#l50.298"></a><span id="l50.298" class="difflineplus">+  if (outSize) *outSize = 0;</span>
<a href="#l50.299"></a><span id="l50.299"> </span>
<a href="#l50.300"></a><span id="l50.300">   // Without input there is nothing to do.</span>
<a href="#l50.301"></a><span id="l50.301" class="difflineminus">-  if (length == 0)</span>
<a href="#l50.302"></a><span id="l50.302" class="difflineminus">-    return 1;</span>
<a href="#l50.303"></a><span id="l50.303" class="difflineplus">+  if (length == 0) return 1;</span>
<a href="#l50.304"></a><span id="l50.304"> </span>
<a href="#l50.305"></a><span id="l50.305">   /* Warning, we are overwriting the buffer which was passed in.</span>
<a href="#l50.306"></a><span id="l50.306">    This is ok, because decoding these formats will never result</span>
<a href="#l50.307"></a><span id="l50.307">    in larger data than the input, only smaller. */</span>
<a href="#l50.308"></a><span id="l50.308" class="difflineminus">-  const char *in  = buffer;</span>
<a href="#l50.309"></a><span id="l50.309" class="difflineminus">-  char *out = (char *) buffer;</span>
<a href="#l50.310"></a><span id="l50.310" class="difflineminus">-  char token [4];</span>
<a href="#l50.311"></a><span id="l50.311" class="difflineplus">+  const char *in = buffer;</span>
<a href="#l50.312"></a><span id="l50.312" class="difflineplus">+  char *out = (char *)buffer;</span>
<a href="#l50.313"></a><span id="l50.313" class="difflineplus">+  char token[4];</span>
<a href="#l50.314"></a><span id="l50.314">   int i;</span>
<a href="#l50.315"></a><span id="l50.315">   bool leftover = (data-&gt;token_size &gt; 0);</span>
<a href="#l50.316"></a><span id="l50.316"> </span>
<a href="#l50.317"></a><span id="l50.317" class="difflineminus">-  NS_ASSERTION(data-&gt;encoding == mime_Base64, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.318"></a><span id="l50.318" class="difflineplus">+  NS_ASSERTION(data-&gt;encoding == mime_Base64,</span>
<a href="#l50.319"></a><span id="l50.319" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.320"></a><span id="l50.320"> </span>
<a href="#l50.321"></a><span id="l50.321">   /* For the first pass, initialize the token from the unread-buffer. */</span>
<a href="#l50.322"></a><span id="l50.322">   i = 0;</span>
<a href="#l50.323"></a><span id="l50.323" class="difflineminus">-  while (i &lt; 4 &amp;&amp; data-&gt;token_size &gt; 0)</span>
<a href="#l50.324"></a><span id="l50.324" class="difflineminus">-  {</span>
<a href="#l50.325"></a><span id="l50.325" class="difflineminus">-    token [i] = data-&gt;token[i];</span>
<a href="#l50.326"></a><span id="l50.326" class="difflineplus">+  while (i &lt; 4 &amp;&amp; data-&gt;token_size &gt; 0) {</span>
<a href="#l50.327"></a><span id="l50.327" class="difflineplus">+    token[i] = data-&gt;token[i];</span>
<a href="#l50.328"></a><span id="l50.328">     data-&gt;token_size--;</span>
<a href="#l50.329"></a><span id="l50.329">     i++;</span>
<a href="#l50.330"></a><span id="l50.330">   }</span>
<a href="#l50.331"></a><span id="l50.331"> </span>
<a href="#l50.332"></a><span id="l50.332" class="difflineminus">-  while (length &gt; 0)</span>
<a href="#l50.333"></a><span id="l50.333" class="difflineminus">-  {</span>
<a href="#l50.334"></a><span id="l50.334" class="difflineminus">-    while (i &lt; 4 &amp;&amp; length &gt; 0)</span>
<a href="#l50.335"></a><span id="l50.335" class="difflineminus">-    {</span>
<a href="#l50.336"></a><span id="l50.336" class="difflineminus">-      if ((*in &gt;= 'A' &amp;&amp; *in &lt;= 'Z') ||</span>
<a href="#l50.337"></a><span id="l50.337" class="difflineminus">-        (*in &gt;= 'a' &amp;&amp; *in &lt;= 'z') ||</span>
<a href="#l50.338"></a><span id="l50.338" class="difflineminus">-        (*in &gt;= '0' &amp;&amp; *in &lt;= '9') ||</span>
<a href="#l50.339"></a><span id="l50.339" class="difflineminus">-        *in == '+' || *in == '/' || *in == '=')</span>
<a href="#l50.340"></a><span id="l50.340" class="difflineminus">-      token [i++] = *in;</span>
<a href="#l50.341"></a><span id="l50.341" class="difflineplus">+  while (length &gt; 0) {</span>
<a href="#l50.342"></a><span id="l50.342" class="difflineplus">+    while (i &lt; 4 &amp;&amp; length &gt; 0) {</span>
<a href="#l50.343"></a><span id="l50.343" class="difflineplus">+      if ((*in &gt;= 'A' &amp;&amp; *in &lt;= 'Z') || (*in &gt;= 'a' &amp;&amp; *in &lt;= 'z') ||</span>
<a href="#l50.344"></a><span id="l50.344" class="difflineplus">+          (*in &gt;= '0' &amp;&amp; *in &lt;= '9') || *in == '+' || *in == '/' || *in == '=')</span>
<a href="#l50.345"></a><span id="l50.345" class="difflineplus">+        token[i++] = *in;</span>
<a href="#l50.346"></a><span id="l50.346">       in++;</span>
<a href="#l50.347"></a><span id="l50.347">       length--;</span>
<a href="#l50.348"></a><span id="l50.348">     }</span>
<a href="#l50.349"></a><span id="l50.349"> </span>
<a href="#l50.350"></a><span id="l50.350" class="difflineminus">-    if (i &lt; 4)</span>
<a href="#l50.351"></a><span id="l50.351" class="difflineminus">-    {</span>
<a href="#l50.352"></a><span id="l50.352" class="difflineplus">+    if (i &lt; 4) {</span>
<a href="#l50.353"></a><span id="l50.353">       /* Didn't get enough for a complete token. */</span>
<a href="#l50.354"></a><span id="l50.354" class="difflineminus">-      memcpy (data-&gt;token, token, i);</span>
<a href="#l50.355"></a><span id="l50.355" class="difflineplus">+      memcpy(data-&gt;token, token, i);</span>
<a href="#l50.356"></a><span id="l50.356">       data-&gt;token_size = i;</span>
<a href="#l50.357"></a><span id="l50.357">       length = 0;</span>
<a href="#l50.358"></a><span id="l50.358">       break;</span>
<a href="#l50.359"></a><span id="l50.359">     }</span>
<a href="#l50.360"></a><span id="l50.360">     i = 0;</span>
<a href="#l50.361"></a><span id="l50.361"> </span>
<a href="#l50.362"></a><span id="l50.362" class="difflineminus">-    if (leftover)</span>
<a href="#l50.363"></a><span id="l50.363" class="difflineminus">-    {</span>
<a href="#l50.364"></a><span id="l50.364" class="difflineplus">+    if (leftover) {</span>
<a href="#l50.365"></a><span id="l50.365">       /* If there are characters left over from the last time around,</span>
<a href="#l50.366"></a><span id="l50.366">        we might not have space in the buffer to do our dirty work</span>
<a href="#l50.367"></a><span id="l50.367">        (if there were 2 or 3 left over, then there is only room for</span>
<a href="#l50.368"></a><span id="l50.368">        1 or 2 in the buffer right now, and we need 3.)  This is only</span>
<a href="#l50.369"></a><span id="l50.369">        a problem for the first chunk in each buffer, so in that</span>
<a href="#l50.370"></a><span id="l50.370">        case, just write prematurely. */</span>
<a href="#l50.371"></a><span id="l50.371">       int n;</span>
<a href="#l50.372"></a><span id="l50.372" class="difflineminus">-      n = mime_decode_base64_token (token, token);</span>
<a href="#l50.373"></a><span id="l50.373" class="difflineminus">-      if (outSize)</span>
<a href="#l50.374"></a><span id="l50.374" class="difflineminus">-        *outSize += n;</span>
<a href="#l50.375"></a><span id="l50.375" class="difflineplus">+      n = mime_decode_base64_token(token, token);</span>
<a href="#l50.376"></a><span id="l50.376" class="difflineplus">+      if (outSize) *outSize += n;</span>
<a href="#l50.377"></a><span id="l50.377">       n = data-&gt;write_buffer(token, n, data-&gt;closure);</span>
<a href="#l50.378"></a><span id="l50.378">       if (n &lt; 0) /* abort */</span>
<a href="#l50.379"></a><span id="l50.379">         return n;</span>
<a href="#l50.380"></a><span id="l50.380"> </span>
<a href="#l50.381"></a><span id="l50.381">       /* increment buffer so that we don't write the 1 or 2 unused</span>
<a href="#l50.382"></a><span id="l50.382">        characters now at the front. */</span>
<a href="#l50.383"></a><span id="l50.383">       buffer = in;</span>
<a href="#l50.384"></a><span id="l50.384" class="difflineminus">-      out = (char *) buffer;</span>
<a href="#l50.385"></a><span id="l50.385" class="difflineplus">+      out = (char *)buffer;</span>
<a href="#l50.386"></a><span id="l50.386"> </span>
<a href="#l50.387"></a><span id="l50.387">       leftover = false;</span>
<a href="#l50.388"></a><span id="l50.388" class="difflineminus">-    }</span>
<a href="#l50.389"></a><span id="l50.389" class="difflineminus">-    else</span>
<a href="#l50.390"></a><span id="l50.390" class="difflineminus">-    {</span>
<a href="#l50.391"></a><span id="l50.391" class="difflineminus">-      int n = mime_decode_base64_token (token, out);</span>
<a href="#l50.392"></a><span id="l50.392" class="difflineplus">+    } else {</span>
<a href="#l50.393"></a><span id="l50.393" class="difflineplus">+      int n = mime_decode_base64_token(token, out);</span>
<a href="#l50.394"></a><span id="l50.394">       /* Advance &quot;out&quot; by the number of bytes just written to it. */</span>
<a href="#l50.395"></a><span id="l50.395">       out += n;</span>
<a href="#l50.396"></a><span id="l50.396">     }</span>
<a href="#l50.397"></a><span id="l50.397">   }</span>
<a href="#l50.398"></a><span id="l50.398"> </span>
<a href="#l50.399"></a><span id="l50.399" class="difflineminus">-  if (outSize)</span>
<a href="#l50.400"></a><span id="l50.400" class="difflineminus">-    *outSize += out - buffer;</span>
<a href="#l50.401"></a><span id="l50.401" class="difflineplus">+  if (outSize) *outSize += out - buffer;</span>
<a href="#l50.402"></a><span id="l50.402">   /* Now that we've altered the data in place, write it. */</span>
<a href="#l50.403"></a><span id="l50.403">   if (out &gt; buffer)</span>
<a href="#l50.404"></a><span id="l50.404">     return data-&gt;write_buffer(buffer, (out - buffer), data-&gt;closure);</span>
<a href="#l50.405"></a><span id="l50.405">   else</span>
<a href="#l50.406"></a><span id="l50.406">     return 1;</span>
<a href="#l50.407"></a><span id="l50.407"> }</span>
<a href="#l50.408"></a><span id="l50.408"> </span>
<a href="#l50.409"></a><span id="l50.409" class="difflineminus">-</span>
<a href="#l50.410"></a><span id="l50.410" class="difflineminus">-static int</span>
<a href="#l50.411"></a><span id="l50.411" class="difflineminus">-mime_decode_uue_buffer (MimeDecoderData *data,</span>
<a href="#l50.412"></a><span id="l50.412" class="difflineminus">-            const char *input_buffer, int32_t input_length, int32_t *outSize)</span>
<a href="#l50.413"></a><span id="l50.413" class="difflineminus">-{</span>
<a href="#l50.414"></a><span id="l50.414" class="difflineplus">+static int mime_decode_uue_buffer(MimeDecoderData *data,</span>
<a href="#l50.415"></a><span id="l50.415" class="difflineplus">+                                  const char *input_buffer,</span>
<a href="#l50.416"></a><span id="l50.416" class="difflineplus">+                                  int32_t input_length, int32_t *outSize) {</span>
<a href="#l50.417"></a><span id="l50.417">   /* First, copy input_buffer into state-&gt;line_buffer until we have</span>
<a href="#l50.418"></a><span id="l50.418">    a complete line.</span>
<a href="#l50.419"></a><span id="l50.419"> </span>
<a href="#l50.420"></a><span id="l50.420">    Then decode that line in place (in the line_buffer) and write</span>
<a href="#l50.421"></a><span id="l50.421">    it out.</span>
<a href="#l50.422"></a><span id="l50.422"> </span>
<a href="#l50.423"></a><span id="l50.423">    Then pull the next line into line_buffer and continue.</span>
<a href="#l50.424"></a><span id="l50.424">    */</span>
<a href="#l50.425"></a><span id="l50.425" class="difflineminus">-  if (!data-&gt;line_buffer)</span>
<a href="#l50.426"></a><span id="l50.426" class="difflineminus">-  {</span>
<a href="#l50.427"></a><span id="l50.427" class="difflineplus">+  if (!data-&gt;line_buffer) {</span>
<a href="#l50.428"></a><span id="l50.428">     data-&gt;line_buffer_size = 128;</span>
<a href="#l50.429"></a><span id="l50.429">     data-&gt;line_buffer = (char *)PR_MALLOC(data-&gt;line_buffer_size);</span>
<a href="#l50.430"></a><span id="l50.430" class="difflineminus">-    if (!data-&gt;line_buffer)</span>
<a href="#l50.431"></a><span id="l50.431" class="difflineminus">-      return -1;</span>
<a href="#l50.432"></a><span id="l50.432" class="difflineplus">+    if (!data-&gt;line_buffer) return -1;</span>
<a href="#l50.433"></a><span id="l50.433">     data-&gt;line_buffer[0] = 0;</span>
<a href="#l50.434"></a><span id="l50.434">   }</span>
<a href="#l50.435"></a><span id="l50.435"> </span>
<a href="#l50.436"></a><span id="l50.436">   int status = 0;</span>
<a href="#l50.437"></a><span id="l50.437">   char *line = data-&gt;line_buffer;</span>
<a href="#l50.438"></a><span id="l50.438">   char *line_end = data-&gt;line_buffer + data-&gt;line_buffer_size - 1;</span>
<a href="#l50.439"></a><span id="l50.439"> </span>
<a href="#l50.440"></a><span id="l50.440" class="difflineminus">-  NS_ASSERTION(data-&gt;encoding == mime_uuencode, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.441"></a><span id="l50.441" class="difflineplus">+  NS_ASSERTION(data-&gt;encoding == mime_uuencode,</span>
<a href="#l50.442"></a><span id="l50.442" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.443"></a><span id="l50.443">   if (data-&gt;encoding != mime_uuencode) return -1;</span>
<a href="#l50.444"></a><span id="l50.444"> </span>
<a href="#l50.445"></a><span id="l50.445" class="difflineminus">-  if (data-&gt;ds_state == DS_END)</span>
<a href="#l50.446"></a><span id="l50.446" class="difflineminus">-  {</span>
<a href="#l50.447"></a><span id="l50.447" class="difflineplus">+  if (data-&gt;ds_state == DS_END) {</span>
<a href="#l50.448"></a><span id="l50.448">     status = 0;</span>
<a href="#l50.449"></a><span id="l50.449">     goto DONE;</span>
<a href="#l50.450"></a><span id="l50.450">   }</span>
<a href="#l50.451"></a><span id="l50.451"> </span>
<a href="#l50.452"></a><span id="l50.452" class="difflineminus">-  while (input_length &gt; 0)</span>
<a href="#l50.453"></a><span id="l50.453" class="difflineminus">-  {</span>
<a href="#l50.454"></a><span id="l50.454" class="difflineplus">+  while (input_length &gt; 0) {</span>
<a href="#l50.455"></a><span id="l50.455">     /* Copy data from input_buffer to `line' until we have a complete line,</span>
<a href="#l50.456"></a><span id="l50.456">      or until we've run out of input.</span>
<a href="#l50.457"></a><span id="l50.457"> </span>
<a href="#l50.458"></a><span id="l50.458">      (line may have data in it already if the last time we were called,</span>
<a href="#l50.459"></a><span id="l50.459">      we weren't called with a buffer that ended on a line boundary.)</span>
<a href="#l50.460"></a><span id="l50.460">      */</span>
<a href="#l50.461"></a><span id="l50.461">     {</span>
<a href="#l50.462"></a><span id="l50.462" class="difflineminus">-    char *out = line + strlen(line);</span>
<a href="#l50.463"></a><span id="l50.463" class="difflineminus">-    while (input_length &gt; 0 &amp;&amp;</span>
<a href="#l50.464"></a><span id="l50.464" class="difflineminus">-         out &lt; line_end)</span>
<a href="#l50.465"></a><span id="l50.465" class="difflineminus">-      {</span>
<a href="#l50.466"></a><span id="l50.466" class="difflineminus">-      *out++ = *input_buffer++;</span>
<a href="#l50.467"></a><span id="l50.467" class="difflineminus">-      input_length--;</span>
<a href="#l50.468"></a><span id="l50.468" class="difflineplus">+      char *out = line + strlen(line);</span>
<a href="#l50.469"></a><span id="l50.469" class="difflineplus">+      while (input_length &gt; 0 &amp;&amp; out &lt; line_end) {</span>
<a href="#l50.470"></a><span id="l50.470" class="difflineplus">+        *out++ = *input_buffer++;</span>
<a href="#l50.471"></a><span id="l50.471" class="difflineplus">+        input_length--;</span>
<a href="#l50.472"></a><span id="l50.472"> </span>
<a href="#l50.473"></a><span id="l50.473" class="difflineminus">-      if (out[-1] == '\r' || out[-1] == '\n')</span>
<a href="#l50.474"></a><span id="l50.474" class="difflineminus">-        {</span>
<a href="#l50.475"></a><span id="l50.475" class="difflineminus">-        /* If we just copied a CR, and an LF is waiting, grab it too.</span>
<a href="#l50.476"></a><span id="l50.476" class="difflineminus">-         */</span>
<a href="#l50.477"></a><span id="l50.477" class="difflineminus">-        if (out[-1] == '\r' &amp;&amp;</span>
<a href="#l50.478"></a><span id="l50.478" class="difflineminus">-          input_length &gt; 0 &amp;&amp;</span>
<a href="#l50.479"></a><span id="l50.479" class="difflineminus">-          *input_buffer == '\n') {</span>
<a href="#l50.480"></a><span id="l50.480" class="difflineplus">+        if (out[-1] == '\r' || out[-1] == '\n') {</span>
<a href="#l50.481"></a><span id="l50.481" class="difflineplus">+          /* If we just copied a CR, and an LF is waiting, grab it too.</span>
<a href="#l50.482"></a><span id="l50.482" class="difflineplus">+           */</span>
<a href="#l50.483"></a><span id="l50.483" class="difflineplus">+          if (out[-1] == '\r' &amp;&amp; input_length &gt; 0 &amp;&amp; *input_buffer == '\n') {</span>
<a href="#l50.484"></a><span id="l50.484">             input_buffer++;</span>
<a href="#l50.485"></a><span id="l50.485">             input_length--;</span>
<a href="#l50.486"></a><span id="l50.486">           }</span>
<a href="#l50.487"></a><span id="l50.487"> </span>
<a href="#l50.488"></a><span id="l50.488" class="difflineminus">-        /* We have a line. */</span>
<a href="#l50.489"></a><span id="l50.489" class="difflineminus">-        break;</span>
<a href="#l50.490"></a><span id="l50.490" class="difflineplus">+          /* We have a line. */</span>
<a href="#l50.491"></a><span id="l50.491" class="difflineplus">+          break;</span>
<a href="#l50.492"></a><span id="l50.492">         }</span>
<a href="#l50.493"></a><span id="l50.493">       }</span>
<a href="#l50.494"></a><span id="l50.494" class="difflineminus">-    *out = 0;</span>
<a href="#l50.495"></a><span id="l50.495" class="difflineplus">+      *out = 0;</span>
<a href="#l50.496"></a><span id="l50.496"> </span>
<a href="#l50.497"></a><span id="l50.497" class="difflineminus">-    /* Ignore blank lines.</span>
<a href="#l50.498"></a><span id="l50.498" class="difflineminus">-     */</span>
<a href="#l50.499"></a><span id="l50.499" class="difflineminus">-    if (*line == '\r' || *line == '\n')</span>
<a href="#l50.500"></a><span id="l50.500" class="difflineminus">-      {</span>
<a href="#l50.501"></a><span id="l50.501" class="difflineminus">-      *line = 0;</span>
<a href="#l50.502"></a><span id="l50.502" class="difflineminus">-      continue;</span>
<a href="#l50.503"></a><span id="l50.503" class="difflineplus">+      /* Ignore blank lines.</span>
<a href="#l50.504"></a><span id="l50.504" class="difflineplus">+       */</span>
<a href="#l50.505"></a><span id="l50.505" class="difflineplus">+      if (*line == '\r' || *line == '\n') {</span>
<a href="#l50.506"></a><span id="l50.506" class="difflineplus">+        *line = 0;</span>
<a href="#l50.507"></a><span id="l50.507" class="difflineplus">+        continue;</span>
<a href="#l50.508"></a><span id="l50.508">       }</span>
<a href="#l50.509"></a><span id="l50.509"> </span>
<a href="#l50.510"></a><span id="l50.510" class="difflineminus">-    /* If this line was bigger than our buffer, truncate it.</span>
<a href="#l50.511"></a><span id="l50.511" class="difflineminus">-       (This means the data was way corrupted, and there's basically</span>
<a href="#l50.512"></a><span id="l50.512" class="difflineminus">-       no chance of decoding it properly, but give it a shot anyway.)</span>
<a href="#l50.513"></a><span id="l50.513" class="difflineminus">-     */</span>
<a href="#l50.514"></a><span id="l50.514" class="difflineminus">-    if (out == line_end)</span>
<a href="#l50.515"></a><span id="l50.515" class="difflineminus">-      {</span>
<a href="#l50.516"></a><span id="l50.516" class="difflineminus">-      out--;</span>
<a href="#l50.517"></a><span id="l50.517" class="difflineminus">-      out[-1] = '\r';</span>
<a href="#l50.518"></a><span id="l50.518" class="difflineminus">-      out[0] = 0;</span>
<a href="#l50.519"></a><span id="l50.519" class="difflineplus">+      /* If this line was bigger than our buffer, truncate it.</span>
<a href="#l50.520"></a><span id="l50.520" class="difflineplus">+         (This means the data was way corrupted, and there's basically</span>
<a href="#l50.521"></a><span id="l50.521" class="difflineplus">+         no chance of decoding it properly, but give it a shot anyway.)</span>
<a href="#l50.522"></a><span id="l50.522" class="difflineplus">+       */</span>
<a href="#l50.523"></a><span id="l50.523" class="difflineplus">+      if (out == line_end) {</span>
<a href="#l50.524"></a><span id="l50.524" class="difflineplus">+        out--;</span>
<a href="#l50.525"></a><span id="l50.525" class="difflineplus">+        out[-1] = '\r';</span>
<a href="#l50.526"></a><span id="l50.526" class="difflineplus">+        out[0] = 0;</span>
<a href="#l50.527"></a><span id="l50.527">       }</span>
<a href="#l50.528"></a><span id="l50.528"> </span>
<a href="#l50.529"></a><span id="l50.529" class="difflineminus">-    /* If we didn't get a complete line, simply return; we'll be called</span>
<a href="#l50.530"></a><span id="l50.530" class="difflineminus">-       with the rest of this line next time.</span>
<a href="#l50.531"></a><span id="l50.531" class="difflineminus">-     */</span>
<a href="#l50.532"></a><span id="l50.532" class="difflineminus">-    if (out[-1] != '\r' &amp;&amp; out[-1] != '\n')</span>
<a href="#l50.533"></a><span id="l50.533" class="difflineminus">-      {</span>
<a href="#l50.534"></a><span id="l50.534" class="difflineminus">-      NS_ASSERTION (input_length == 0, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.535"></a><span id="l50.535" class="difflineminus">-      break;</span>
<a href="#l50.536"></a><span id="l50.536" class="difflineplus">+      /* If we didn't get a complete line, simply return; we'll be called</span>
<a href="#l50.537"></a><span id="l50.537" class="difflineplus">+         with the rest of this line next time.</span>
<a href="#l50.538"></a><span id="l50.538" class="difflineplus">+       */</span>
<a href="#l50.539"></a><span id="l50.539" class="difflineplus">+      if (out[-1] != '\r' &amp;&amp; out[-1] != '\n') {</span>
<a href="#l50.540"></a><span id="l50.540" class="difflineplus">+        NS_ASSERTION(input_length == 0,</span>
<a href="#l50.541"></a><span id="l50.541" class="difflineplus">+                     &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.542"></a><span id="l50.542" class="difflineplus">+        break;</span>
<a href="#l50.543"></a><span id="l50.543">       }</span>
<a href="#l50.544"></a><span id="l50.544">     }</span>
<a href="#l50.545"></a><span id="l50.545"> </span>
<a href="#l50.546"></a><span id="l50.546" class="difflineminus">-</span>
<a href="#l50.547"></a><span id="l50.547">     /* Now we have a complete line.  Deal with it.</span>
<a href="#l50.548"></a><span id="l50.548">      */</span>
<a href="#l50.549"></a><span id="l50.549"> </span>
<a href="#l50.550"></a><span id="l50.550" class="difflineminus">-</span>
<a href="#l50.551"></a><span id="l50.551" class="difflineminus">-    if (data-&gt;ds_state == DS_BODY &amp;&amp;</span>
<a href="#l50.552"></a><span id="l50.552" class="difflineminus">-      line[0] == 'e' &amp;&amp;</span>
<a href="#l50.553"></a><span id="l50.553" class="difflineminus">-      line[1] == 'n' &amp;&amp;</span>
<a href="#l50.554"></a><span id="l50.554" class="difflineminus">-      line[2] == 'd' &amp;&amp;</span>
<a href="#l50.555"></a><span id="l50.555" class="difflineminus">-      (line[3] == '\r' ||</span>
<a href="#l50.556"></a><span id="l50.556" class="difflineminus">-       line[3] == '\n'))</span>
<a href="#l50.557"></a><span id="l50.557" class="difflineminus">-    {</span>
<a href="#l50.558"></a><span id="l50.558" class="difflineplus">+    if (data-&gt;ds_state == DS_BODY &amp;&amp; line[0] == 'e' &amp;&amp; line[1] == 'n' &amp;&amp;</span>
<a href="#l50.559"></a><span id="l50.559" class="difflineplus">+        line[2] == 'd' &amp;&amp; (line[3] == '\r' || line[3] == '\n')) {</span>
<a href="#l50.560"></a><span id="l50.560">       /* done! */</span>
<a href="#l50.561"></a><span id="l50.561">       data-&gt;ds_state = DS_END;</span>
<a href="#l50.562"></a><span id="l50.562">       *line = 0;</span>
<a href="#l50.563"></a><span id="l50.563">       break;</span>
<a href="#l50.564"></a><span id="l50.564" class="difflineminus">-    }</span>
<a href="#l50.565"></a><span id="l50.565" class="difflineminus">-    else if (data-&gt;ds_state == DS_BEGIN)</span>
<a href="#l50.566"></a><span id="l50.566" class="difflineminus">-    {</span>
<a href="#l50.567"></a><span id="l50.567" class="difflineminus">-      if (!strncmp (line, &quot;begin &quot;, 6))</span>
<a href="#l50.568"></a><span id="l50.568" class="difflineminus">-      data-&gt;ds_state = DS_BODY;</span>
<a href="#l50.569"></a><span id="l50.569" class="difflineplus">+    } else if (data-&gt;ds_state == DS_BEGIN) {</span>
<a href="#l50.570"></a><span id="l50.570" class="difflineplus">+      if (!strncmp(line, &quot;begin &quot;, 6)) data-&gt;ds_state = DS_BODY;</span>
<a href="#l50.571"></a><span id="l50.571">       *line = 0;</span>
<a href="#l50.572"></a><span id="l50.572">       continue;</span>
<a href="#l50.573"></a><span id="l50.573" class="difflineminus">-    }</span>
<a href="#l50.574"></a><span id="l50.574" class="difflineminus">-    else</span>
<a href="#l50.575"></a><span id="l50.575" class="difflineminus">-    {</span>
<a href="#l50.576"></a><span id="l50.576" class="difflineplus">+    } else {</span>
<a href="#l50.577"></a><span id="l50.577">       /* We're in DS_BODY.  Decode the line. */</span>
<a href="#l50.578"></a><span id="l50.578">       char *in, *out;</span>
<a href="#l50.579"></a><span id="l50.579">       int32_t i;</span>
<a href="#l50.580"></a><span id="l50.580">       long lost;</span>
<a href="#l50.581"></a><span id="l50.581"> </span>
<a href="#l50.582"></a><span id="l50.582" class="difflineminus">-      NS_ASSERTION (data-&gt;ds_state == DS_BODY, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.583"></a><span id="l50.583" class="difflineplus">+      NS_ASSERTION(data-&gt;ds_state == DS_BODY,</span>
<a href="#l50.584"></a><span id="l50.584" class="difflineplus">+                   &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.585"></a><span id="l50.585"> </span>
<a href="#l50.586"></a><span id="l50.586">       /* We map down `line', reading four bytes and writing three.</span>
<a href="#l50.587"></a><span id="l50.587">        That means that `out' always stays safely behind `in'.</span>
<a href="#l50.588"></a><span id="l50.588">        */</span>
<a href="#l50.589"></a><span id="l50.589">       in = line;</span>
<a href="#l50.590"></a><span id="l50.590">       out = line;</span>
<a href="#l50.591"></a><span id="l50.591"> </span>
<a href="#l50.592"></a><span id="l50.592" class="difflineminus">-# undef DEC</span>
<a href="#l50.593"></a><span id="l50.593" class="difflineminus">-# define DEC(c) (((c) - ' ') &amp; 077)</span>
<a href="#l50.594"></a><span id="l50.594" class="difflineminus">-      i = DEC (*in); /* get length */</span>
<a href="#l50.595"></a><span id="l50.595" class="difflineplus">+#undef DEC</span>
<a href="#l50.596"></a><span id="l50.596" class="difflineplus">+#define DEC(c) (((c) - ' ') &amp; 077)</span>
<a href="#l50.597"></a><span id="l50.597" class="difflineplus">+      i = DEC(*in); /* get length */</span>
<a href="#l50.598"></a><span id="l50.598"> </span>
<a href="#l50.599"></a><span id="l50.599">       /* all the parens and casts are because gcc was doing something evil.</span>
<a href="#l50.600"></a><span id="l50.600">        */</span>
<a href="#l50.601"></a><span id="l50.601" class="difflineminus">-      lost = ((long) i) - (((((long) strlen (in)) - 2L) * 3L) / 4L);</span>
<a href="#l50.602"></a><span id="l50.602" class="difflineplus">+      lost = ((long)i) - (((((long)strlen(in)) - 2L) * 3L) / 4L);</span>
<a href="#l50.603"></a><span id="l50.603"> </span>
<a href="#l50.604"></a><span id="l50.604">       if (lost &gt; 0) /* Short line!! */</span>
<a href="#l50.605"></a><span id="l50.605">       {</span>
<a href="#l50.606"></a><span id="l50.606">         /* If we get here, then the line is shorter than the length byte</span>
<a href="#l50.607"></a><span id="l50.607">          at the beginning says it should be.  However, the case where</span>
<a href="#l50.608"></a><span id="l50.608">          the line is short because it was at the end of the buffer and</span>
<a href="#l50.609"></a><span id="l50.609">          we didn't get the whole line was handled earlier (up by the</span>
<a href="#l50.610"></a><span id="l50.610">          &quot;didn't get a complete line&quot; comment.)  So if we've gotten</span>
<a href="#l50.611"></a><span id="l50.611" class="difflineat">@@ -467,655 +422,578 @@ mime_decode_uue_buffer (MimeDecoderData </span>
<a href="#l50.612"></a><span id="l50.612"> </span>
<a href="#l50.613"></a><span id="l50.613">          This probably happened because some gateway stripped trailing</span>
<a href="#l50.614"></a><span id="l50.614">          whitespace from the end of the line -- so pretend the line</span>
<a href="#l50.615"></a><span id="l50.615">          was padded with spaces (which map to \000.)</span>
<a href="#l50.616"></a><span id="l50.616">          */</span>
<a href="#l50.617"></a><span id="l50.617">         i -= lost;</span>
<a href="#l50.618"></a><span id="l50.618">       }</span>
<a href="#l50.619"></a><span id="l50.619"> </span>
<a href="#l50.620"></a><span id="l50.620" class="difflineminus">-      for (++in; i &gt; 0; in += 4, i -= 3)</span>
<a href="#l50.621"></a><span id="l50.621" class="difflineminus">-      {</span>
<a href="#l50.622"></a><span id="l50.622" class="difflineplus">+      for (++in; i &gt; 0; in += 4, i -= 3) {</span>
<a href="#l50.623"></a><span id="l50.623">         char ch;</span>
<a href="#l50.624"></a><span id="l50.624">         NS_ASSERTION(out &lt;= in, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.625"></a><span id="l50.625"> </span>
<a href="#l50.626"></a><span id="l50.626" class="difflineminus">-        if (i &gt;= 3)</span>
<a href="#l50.627"></a><span id="l50.627" class="difflineminus">-        {</span>
<a href="#l50.628"></a><span id="l50.628" class="difflineplus">+        if (i &gt;= 3) {</span>
<a href="#l50.629"></a><span id="l50.629">           /* We read four; write three. */</span>
<a href="#l50.630"></a><span id="l50.630" class="difflineminus">-          ch = DEC (in[0]) &lt;&lt; 2 | DEC (in[1]) &gt;&gt; 4;</span>
<a href="#l50.631"></a><span id="l50.631" class="difflineplus">+          ch = DEC(in[0]) &lt;&lt; 2 | DEC(in[1]) &gt;&gt; 4;</span>
<a href="#l50.632"></a><span id="l50.632">           *out++ = ch;</span>
<a href="#l50.633"></a><span id="l50.633"> </span>
<a href="#l50.634"></a><span id="l50.634" class="difflineminus">-          NS_ASSERTION(out &lt;= in+1, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.635"></a><span id="l50.635" class="difflineplus">+          NS_ASSERTION(out &lt;= in + 1,</span>
<a href="#l50.636"></a><span id="l50.636" class="difflineplus">+                       &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.637"></a><span id="l50.637"> </span>
<a href="#l50.638"></a><span id="l50.638" class="difflineminus">-          ch = DEC (in[1]) &lt;&lt; 4 | DEC (in[2]) &gt;&gt; 2;</span>
<a href="#l50.639"></a><span id="l50.639" class="difflineplus">+          ch = DEC(in[1]) &lt;&lt; 4 | DEC(in[2]) &gt;&gt; 2;</span>
<a href="#l50.640"></a><span id="l50.640">           *out++ = ch;</span>
<a href="#l50.641"></a><span id="l50.641"> </span>
<a href="#l50.642"></a><span id="l50.642" class="difflineminus">-          NS_ASSERTION(out &lt;= in+2, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.643"></a><span id="l50.643" class="difflineplus">+          NS_ASSERTION(out &lt;= in + 2,</span>
<a href="#l50.644"></a><span id="l50.644" class="difflineplus">+                       &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.645"></a><span id="l50.645"> </span>
<a href="#l50.646"></a><span id="l50.646" class="difflineminus">-          ch = DEC (in[2]) &lt;&lt; 6 | DEC (in[3]);</span>
<a href="#l50.647"></a><span id="l50.647" class="difflineplus">+          ch = DEC(in[2]) &lt;&lt; 6 | DEC(in[3]);</span>
<a href="#l50.648"></a><span id="l50.648">           *out++ = ch;</span>
<a href="#l50.649"></a><span id="l50.649"> </span>
<a href="#l50.650"></a><span id="l50.650" class="difflineminus">-          NS_ASSERTION(out &lt;= in+3, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.651"></a><span id="l50.651" class="difflineminus">-        }</span>
<a href="#l50.652"></a><span id="l50.652" class="difflineminus">-        else</span>
<a href="#l50.653"></a><span id="l50.653" class="difflineminus">-        {</span>
<a href="#l50.654"></a><span id="l50.654" class="difflineplus">+          NS_ASSERTION(out &lt;= in + 3,</span>
<a href="#l50.655"></a><span id="l50.655" class="difflineplus">+                       &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.656"></a><span id="l50.656" class="difflineplus">+        } else {</span>
<a href="#l50.657"></a><span id="l50.657">           /* Handle a line that isn't a multiple of 4 long.</span>
<a href="#l50.658"></a><span id="l50.658">            (We read 1, 2, or 3, and will write 1 or 2.)</span>
<a href="#l50.659"></a><span id="l50.659">            */</span>
<a href="#l50.660"></a><span id="l50.660" class="difflineminus">-          NS_ASSERTION (i &gt; 0 &amp;&amp; i &lt; 3, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.661"></a><span id="l50.661" class="difflineplus">+          NS_ASSERTION(i &gt; 0 &amp;&amp; i &lt; 3,</span>
<a href="#l50.662"></a><span id="l50.662" class="difflineplus">+                       &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.663"></a><span id="l50.663"> </span>
<a href="#l50.664"></a><span id="l50.664" class="difflineminus">-          ch = DEC (in[0]) &lt;&lt; 2 | DEC (in[1]) &gt;&gt; 4;</span>
<a href="#l50.665"></a><span id="l50.665" class="difflineplus">+          ch = DEC(in[0]) &lt;&lt; 2 | DEC(in[1]) &gt;&gt; 4;</span>
<a href="#l50.666"></a><span id="l50.666">           *out++ = ch;</span>
<a href="#l50.667"></a><span id="l50.667"> </span>
<a href="#l50.668"></a><span id="l50.668" class="difflineminus">-          NS_ASSERTION(out &lt;= in+1, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.669"></a><span id="l50.669" class="difflineplus">+          NS_ASSERTION(out &lt;= in + 1,</span>
<a href="#l50.670"></a><span id="l50.670" class="difflineplus">+                       &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.671"></a><span id="l50.671"> </span>
<a href="#l50.672"></a><span id="l50.672" class="difflineminus">-          if (i == 2)</span>
<a href="#l50.673"></a><span id="l50.673" class="difflineminus">-          {</span>
<a href="#l50.674"></a><span id="l50.674" class="difflineminus">-            ch = DEC (in[1]) &lt;&lt; 4 | DEC (in[2]) &gt;&gt; 2;</span>
<a href="#l50.675"></a><span id="l50.675" class="difflineplus">+          if (i == 2) {</span>
<a href="#l50.676"></a><span id="l50.676" class="difflineplus">+            ch = DEC(in[1]) &lt;&lt; 4 | DEC(in[2]) &gt;&gt; 2;</span>
<a href="#l50.677"></a><span id="l50.677">             *out++ = ch;</span>
<a href="#l50.678"></a><span id="l50.678"> </span>
<a href="#l50.679"></a><span id="l50.679" class="difflineminus">-            NS_ASSERTION(out &lt;= in+2, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.680"></a><span id="l50.680" class="difflineplus">+            NS_ASSERTION(out &lt;= in + 2,</span>
<a href="#l50.681"></a><span id="l50.681" class="difflineplus">+                         &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.682"></a><span id="l50.682">           }</span>
<a href="#l50.683"></a><span id="l50.683">         }</span>
<a href="#l50.684"></a><span id="l50.684">       }</span>
<a href="#l50.685"></a><span id="l50.685"> </span>
<a href="#l50.686"></a><span id="l50.686">       /* If the line was truncated, pad the missing bytes with 0 (SPC). */</span>
<a href="#l50.687"></a><span id="l50.687" class="difflineminus">-      while (lost &gt; 0)</span>
<a href="#l50.688"></a><span id="l50.688" class="difflineminus">-      {</span>
<a href="#l50.689"></a><span id="l50.689" class="difflineplus">+      while (lost &gt; 0) {</span>
<a href="#l50.690"></a><span id="l50.690">         *out++ = 0;</span>
<a href="#l50.691"></a><span id="l50.691">         lost--;</span>
<a href="#l50.692"></a><span id="l50.692" class="difflineminus">-        in = out+1; /* just to prevent the assert, below. */</span>
<a href="#l50.693"></a><span id="l50.693" class="difflineplus">+        in = out + 1; /* just to prevent the assert, below. */</span>
<a href="#l50.694"></a><span id="l50.694">       }</span>
<a href="#l50.695"></a><span id="l50.695" class="difflineminus">-# undef DEC</span>
<a href="#l50.696"></a><span id="l50.696" class="difflineplus">+#undef DEC</span>
<a href="#l50.697"></a><span id="l50.697"> </span>
<a href="#l50.698"></a><span id="l50.698">       /* Now write out what we decoded for this line.</span>
<a href="#l50.699"></a><span id="l50.699">        */</span>
<a href="#l50.700"></a><span id="l50.700" class="difflineminus">-      NS_ASSERTION(out &gt;= line &amp;&amp; out &lt; in, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.701"></a><span id="l50.701" class="difflineplus">+      NS_ASSERTION(out &gt;= line &amp;&amp; out &lt; in,</span>
<a href="#l50.702"></a><span id="l50.702" class="difflineplus">+                   &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.703"></a><span id="l50.703">       if (out &gt; line)</span>
<a href="#l50.704"></a><span id="l50.704" class="difflineminus">-      status = data-&gt;write_buffer (line, (out - line), data-&gt;closure);</span>
<a href="#l50.705"></a><span id="l50.705" class="difflineplus">+        status = data-&gt;write_buffer(line, (out - line), data-&gt;closure);</span>
<a href="#l50.706"></a><span id="l50.706"> </span>
<a href="#l50.707"></a><span id="l50.707">       // The assertion above tells us this is &gt;= 0</span>
<a href="#l50.708"></a><span id="l50.708" class="difflineminus">-      if (outSize)</span>
<a href="#l50.709"></a><span id="l50.709" class="difflineminus">-        *outSize = out - line;</span>
<a href="#l50.710"></a><span id="l50.710" class="difflineplus">+      if (outSize) *outSize = out - line;</span>
<a href="#l50.711"></a><span id="l50.711"> </span>
<a href="#l50.712"></a><span id="l50.712">       /* Reset the line so that we don't think it's partial next time. */</span>
<a href="#l50.713"></a><span id="l50.713">       *line = 0;</span>
<a href="#l50.714"></a><span id="l50.714"> </span>
<a href="#l50.715"></a><span id="l50.715">       if (status &lt; 0) /* abort */</span>
<a href="#l50.716"></a><span id="l50.716" class="difflineminus">-      goto DONE;</span>
<a href="#l50.717"></a><span id="l50.717" class="difflineplus">+        goto DONE;</span>
<a href="#l50.718"></a><span id="l50.718">     }</span>
<a href="#l50.719"></a><span id="l50.719">   }</span>
<a href="#l50.720"></a><span id="l50.720"> </span>
<a href="#l50.721"></a><span id="l50.721">   status = 1;</span>
<a href="#l50.722"></a><span id="l50.722"> </span>
<a href="#l50.723"></a><span id="l50.723" class="difflineminus">- DONE:</span>
<a href="#l50.724"></a><span id="l50.724" class="difflineplus">+DONE:</span>
<a href="#l50.725"></a><span id="l50.725"> </span>
<a href="#l50.726"></a><span id="l50.726">   return status;</span>
<a href="#l50.727"></a><span id="l50.727"> }</span>
<a href="#l50.728"></a><span id="l50.728"> </span>
<a href="#l50.729"></a><span id="l50.729" class="difflineminus">-static int</span>
<a href="#l50.730"></a><span id="l50.730" class="difflineminus">-mime_decode_yenc_buffer (MimeDecoderData *data,</span>
<a href="#l50.731"></a><span id="l50.731" class="difflineminus">-            const char *input_buffer, int32_t input_length, int32_t *outSize)</span>
<a href="#l50.732"></a><span id="l50.732" class="difflineminus">-{</span>
<a href="#l50.733"></a><span id="l50.733" class="difflineplus">+static int mime_decode_yenc_buffer(MimeDecoderData *data,</span>
<a href="#l50.734"></a><span id="l50.734" class="difflineplus">+                                   const char *input_buffer,</span>
<a href="#l50.735"></a><span id="l50.735" class="difflineplus">+                                   int32_t input_length, int32_t *outSize) {</span>
<a href="#l50.736"></a><span id="l50.736">   /* First, copy input_buffer into state-&gt;line_buffer until we have</span>
<a href="#l50.737"></a><span id="l50.737">    a complete line.</span>
<a href="#l50.738"></a><span id="l50.738"> </span>
<a href="#l50.739"></a><span id="l50.739">    Then decode that line in place (in the line_buffer) and write</span>
<a href="#l50.740"></a><span id="l50.740">    it out.</span>
<a href="#l50.741"></a><span id="l50.741"> </span>
<a href="#l50.742"></a><span id="l50.742">    Then pull the next line into line_buffer and continue.</span>
<a href="#l50.743"></a><span id="l50.743">    */</span>
<a href="#l50.744"></a><span id="l50.744" class="difflineminus">-  if (!data-&gt;line_buffer)</span>
<a href="#l50.745"></a><span id="l50.745" class="difflineminus">-  {</span>
<a href="#l50.746"></a><span id="l50.746" class="difflineminus">-    data-&gt;line_buffer_size = 1000; // let make sure we have plenty of space for the header line</span>
<a href="#l50.747"></a><span id="l50.747" class="difflineplus">+  if (!data-&gt;line_buffer) {</span>
<a href="#l50.748"></a><span id="l50.748" class="difflineplus">+    data-&gt;line_buffer_size =</span>
<a href="#l50.749"></a><span id="l50.749" class="difflineplus">+        1000;  // let make sure we have plenty of space for the header line</span>
<a href="#l50.750"></a><span id="l50.750">     data-&gt;line_buffer = (char *)PR_MALLOC(data-&gt;line_buffer_size);</span>
<a href="#l50.751"></a><span id="l50.751" class="difflineminus">-    if (!data-&gt;line_buffer)</span>
<a href="#l50.752"></a><span id="l50.752" class="difflineminus">-      return -1;</span>
<a href="#l50.753"></a><span id="l50.753" class="difflineplus">+    if (!data-&gt;line_buffer) return -1;</span>
<a href="#l50.754"></a><span id="l50.754">     data-&gt;line_buffer[0] = 0;</span>
<a href="#l50.755"></a><span id="l50.755">   }</span>
<a href="#l50.756"></a><span id="l50.756"> </span>
<a href="#l50.757"></a><span id="l50.757">   int status = 0;</span>
<a href="#l50.758"></a><span id="l50.758">   char *line = data-&gt;line_buffer;</span>
<a href="#l50.759"></a><span id="l50.759">   char *line_end = data-&gt;line_buffer + data-&gt;line_buffer_size - 1;</span>
<a href="#l50.760"></a><span id="l50.760"> </span>
<a href="#l50.761"></a><span id="l50.761">   NS_ASSERTION(data-&gt;encoding == mime_yencode, &quot;wrong decoder!&quot;);</span>
<a href="#l50.762"></a><span id="l50.762">   if (data-&gt;encoding != mime_yencode) return -1;</span>
<a href="#l50.763"></a><span id="l50.763"> </span>
<a href="#l50.764"></a><span id="l50.764" class="difflineminus">-  if (data-&gt;ds_state == DS_END)</span>
<a href="#l50.765"></a><span id="l50.765" class="difflineminus">-    return 0;</span>
<a href="#l50.766"></a><span id="l50.766" class="difflineplus">+  if (data-&gt;ds_state == DS_END) return 0;</span>
<a href="#l50.767"></a><span id="l50.767"> </span>
<a href="#l50.768"></a><span id="l50.768" class="difflineminus">-  while (input_length &gt; 0)</span>
<a href="#l50.769"></a><span id="l50.769" class="difflineminus">-  {</span>
<a href="#l50.770"></a><span id="l50.770" class="difflineplus">+  while (input_length &gt; 0) {</span>
<a href="#l50.771"></a><span id="l50.771">     /* Copy data from input_buffer to `line' until we have a complete line,</span>
<a href="#l50.772"></a><span id="l50.772">        or until we've run out of input.</span>
<a href="#l50.773"></a><span id="l50.773"> </span>
<a href="#l50.774"></a><span id="l50.774">        (line may have data in it already if the last time we were called,</span>
<a href="#l50.775"></a><span id="l50.775">        we weren't called with a buffer that ended on a line boundary.)</span>
<a href="#l50.776"></a><span id="l50.776">     */</span>
<a href="#l50.777"></a><span id="l50.777">     {</span>
<a href="#l50.778"></a><span id="l50.778">       char *out = line + strlen(line);</span>
<a href="#l50.779"></a><span id="l50.779" class="difflineminus">-      while (input_length &gt; 0 &amp;&amp; out &lt; line_end)</span>
<a href="#l50.780"></a><span id="l50.780" class="difflineminus">-      {</span>
<a href="#l50.781"></a><span id="l50.781" class="difflineplus">+      while (input_length &gt; 0 &amp;&amp; out &lt; line_end) {</span>
<a href="#l50.782"></a><span id="l50.782">         *out++ = *input_buffer++;</span>
<a href="#l50.783"></a><span id="l50.783">         input_length--;</span>
<a href="#l50.784"></a><span id="l50.784"> </span>
<a href="#l50.785"></a><span id="l50.785" class="difflineminus">-        if (out[-1] == '\r' || out[-1] == '\n')</span>
<a href="#l50.786"></a><span id="l50.786" class="difflineminus">-        {</span>
<a href="#l50.787"></a><span id="l50.787" class="difflineplus">+        if (out[-1] == '\r' || out[-1] == '\n') {</span>
<a href="#l50.788"></a><span id="l50.788">           /* If we just copied a CR, and an LF is waiting, grab it too. */</span>
<a href="#l50.789"></a><span id="l50.789" class="difflineminus">-          if (out[-1] == '\r' &amp;&amp;</span>
<a href="#l50.790"></a><span id="l50.790" class="difflineminus">-                  input_length &gt; 0 &amp;&amp;</span>
<a href="#l50.791"></a><span id="l50.791" class="difflineminus">-                  *input_buffer == '\n') {</span>
<a href="#l50.792"></a><span id="l50.792" class="difflineplus">+          if (out[-1] == '\r' &amp;&amp; input_length &gt; 0 &amp;&amp; *input_buffer == '\n') {</span>
<a href="#l50.793"></a><span id="l50.793">             input_buffer++;</span>
<a href="#l50.794"></a><span id="l50.794">             input_length--;</span>
<a href="#l50.795"></a><span id="l50.795">           }</span>
<a href="#l50.796"></a><span id="l50.796"> </span>
<a href="#l50.797"></a><span id="l50.797" class="difflineminus">-           /* We have a line. */</span>
<a href="#l50.798"></a><span id="l50.798" class="difflineminus">-           break;</span>
<a href="#l50.799"></a><span id="l50.799" class="difflineplus">+          /* We have a line. */</span>
<a href="#l50.800"></a><span id="l50.800" class="difflineplus">+          break;</span>
<a href="#l50.801"></a><span id="l50.801">         }</span>
<a href="#l50.802"></a><span id="l50.802">       }</span>
<a href="#l50.803"></a><span id="l50.803">       *out = 0;</span>
<a href="#l50.804"></a><span id="l50.804"> </span>
<a href="#l50.805"></a><span id="l50.805">       /* Ignore blank lines. */</span>
<a href="#l50.806"></a><span id="l50.806" class="difflineminus">-      if (*line == '\r' || *line == '\n')</span>
<a href="#l50.807"></a><span id="l50.807" class="difflineminus">-      {</span>
<a href="#l50.808"></a><span id="l50.808" class="difflineplus">+      if (*line == '\r' || *line == '\n') {</span>
<a href="#l50.809"></a><span id="l50.809">         *line = 0;</span>
<a href="#l50.810"></a><span id="l50.810">         continue;</span>
<a href="#l50.811"></a><span id="l50.811">       }</span>
<a href="#l50.812"></a><span id="l50.812"> </span>
<a href="#l50.813"></a><span id="l50.813">       /* If this line was bigger than our buffer, truncate it.</span>
<a href="#l50.814"></a><span id="l50.814">          (This means the data was way corrupted, and there's basically</span>
<a href="#l50.815"></a><span id="l50.815">          no chance of decoding it properly, but give it a shot anyway.)</span>
<a href="#l50.816"></a><span id="l50.816">       */</span>
<a href="#l50.817"></a><span id="l50.817" class="difflineminus">-      if (out == line_end)</span>
<a href="#l50.818"></a><span id="l50.818" class="difflineminus">-      {</span>
<a href="#l50.819"></a><span id="l50.819" class="difflineplus">+      if (out == line_end) {</span>
<a href="#l50.820"></a><span id="l50.820">         out--;</span>
<a href="#l50.821"></a><span id="l50.821">         out[-1] = '\r';</span>
<a href="#l50.822"></a><span id="l50.822">         out[0] = 0;</span>
<a href="#l50.823"></a><span id="l50.823">       }</span>
<a href="#l50.824"></a><span id="l50.824"> </span>
<a href="#l50.825"></a><span id="l50.825">       /* If we didn't get a complete line, simply return; we'll be called</span>
<a href="#l50.826"></a><span id="l50.826">          with the rest of this line next time.</span>
<a href="#l50.827"></a><span id="l50.827">       */</span>
<a href="#l50.828"></a><span id="l50.828" class="difflineminus">-      if (out[-1] != '\r' &amp;&amp; out[-1] != '\n')</span>
<a href="#l50.829"></a><span id="l50.829" class="difflineminus">-      {</span>
<a href="#l50.830"></a><span id="l50.830" class="difflineminus">-        NS_ASSERTION (input_length == 0, &quot;empty buffer!&quot;);</span>
<a href="#l50.831"></a><span id="l50.831" class="difflineplus">+      if (out[-1] != '\r' &amp;&amp; out[-1] != '\n') {</span>
<a href="#l50.832"></a><span id="l50.832" class="difflineplus">+        NS_ASSERTION(input_length == 0, &quot;empty buffer!&quot;);</span>
<a href="#l50.833"></a><span id="l50.833">         break;</span>
<a href="#l50.834"></a><span id="l50.834">       }</span>
<a href="#l50.835"></a><span id="l50.835">     }</span>
<a href="#l50.836"></a><span id="l50.836"> </span>
<a href="#l50.837"></a><span id="l50.837" class="difflineminus">-</span>
<a href="#l50.838"></a><span id="l50.838">     /* Now we have a complete line.  Deal with it.</span>
<a href="#l50.839"></a><span id="l50.839">      */</span>
<a href="#l50.840"></a><span id="l50.840" class="difflineminus">-    const char * endOfLine = line + strlen(line);</span>
<a href="#l50.841"></a><span id="l50.841" class="difflineplus">+    const char *endOfLine = line + strlen(line);</span>
<a href="#l50.842"></a><span id="l50.842"> </span>
<a href="#l50.843"></a><span id="l50.843" class="difflineminus">-    if (data-&gt;ds_state == DS_BEGIN)</span>
<a href="#l50.844"></a><span id="l50.844" class="difflineminus">-    {</span>
<a href="#l50.845"></a><span id="l50.845" class="difflineplus">+    if (data-&gt;ds_state == DS_BEGIN) {</span>
<a href="#l50.846"></a><span id="l50.846">       int new_line_size = 0;</span>
<a href="#l50.847"></a><span id="l50.847">       /* this yenc decoder does not support yenc v2 or multipart yenc.</span>
<a href="#l50.848"></a><span id="l50.848">          Therefore, we are looking first for &quot;=ybegin line=&quot;</span>
<a href="#l50.849"></a><span id="l50.849">       */</span>
<a href="#l50.850"></a><span id="l50.850" class="difflineminus">-      if ((endOfLine - line) &gt;= 13 &amp;&amp; !strncmp (line, &quot;=ybegin line=&quot;, 13))</span>
<a href="#l50.851"></a><span id="l50.851" class="difflineminus">-      {</span>
<a href="#l50.852"></a><span id="l50.852" class="difflineplus">+      if ((endOfLine - line) &gt;= 13 &amp;&amp; !strncmp(line, &quot;=ybegin line=&quot;, 13)) {</span>
<a href="#l50.853"></a><span id="l50.853">         /* ...then couple digits. */</span>
<a href="#l50.854"></a><span id="l50.854" class="difflineminus">-        for (line += 13; line &lt; endOfLine; line ++)</span>
<a href="#l50.855"></a><span id="l50.855" class="difflineminus">-        {</span>
<a href="#l50.856"></a><span id="l50.856" class="difflineminus">-          if (*line &lt; '0' || *line &gt; '9')</span>
<a href="#l50.857"></a><span id="l50.857" class="difflineminus">-            break;</span>
<a href="#l50.858"></a><span id="l50.858" class="difflineplus">+        for (line += 13; line &lt; endOfLine; line++) {</span>
<a href="#l50.859"></a><span id="l50.859" class="difflineplus">+          if (*line &lt; '0' || *line &gt; '9') break;</span>
<a href="#l50.860"></a><span id="l50.860">           new_line_size = (new_line_size * 10) + *line - '0';</span>
<a href="#l50.861"></a><span id="l50.861">         }</span>
<a href="#l50.862"></a><span id="l50.862"> </span>
<a href="#l50.863"></a><span id="l50.863">         /* ...next, look for &lt;space&gt;size= */</span>
<a href="#l50.864"></a><span id="l50.864" class="difflineminus">-        if ((endOfLine - line) &gt;= 6 &amp;&amp; !strncmp (line, &quot; size=&quot;, 6))</span>
<a href="#l50.865"></a><span id="l50.865" class="difflineminus">-        {</span>
<a href="#l50.866"></a><span id="l50.866" class="difflineplus">+        if ((endOfLine - line) &gt;= 6 &amp;&amp; !strncmp(line, &quot; size=&quot;, 6)) {</span>
<a href="#l50.867"></a><span id="l50.867">           /* ...then couple digits. */</span>
<a href="#l50.868"></a><span id="l50.868" class="difflineminus">-          for (line += 6; line &lt; endOfLine; line ++)</span>
<a href="#l50.869"></a><span id="l50.869" class="difflineminus">-            if (*line &lt; '0' || *line &gt; '9')</span>
<a href="#l50.870"></a><span id="l50.870" class="difflineminus">-              break;</span>
<a href="#l50.871"></a><span id="l50.871" class="difflineplus">+          for (line += 6; line &lt; endOfLine; line++)</span>
<a href="#l50.872"></a><span id="l50.872" class="difflineplus">+            if (*line &lt; '0' || *line &gt; '9') break;</span>
<a href="#l50.873"></a><span id="l50.873"> </span>
<a href="#l50.874"></a><span id="l50.874">           /* ...next, look for &lt;space&gt;name= */</span>
<a href="#l50.875"></a><span id="l50.875" class="difflineminus">-          if ((endOfLine - line) &gt;= 6 &amp;&amp; !strncmp (line, &quot; name=&quot;, 6))</span>
<a href="#l50.876"></a><span id="l50.876" class="difflineminus">-          {</span>
<a href="#l50.877"></a><span id="l50.877" class="difflineplus">+          if ((endOfLine - line) &gt;= 6 &amp;&amp; !strncmp(line, &quot; name=&quot;, 6)) {</span>
<a href="#l50.878"></a><span id="l50.878">             /* we have found the yenc header line.</span>
<a href="#l50.879"></a><span id="l50.879">                Now check if we need to grow our buffer line</span>
<a href="#l50.880"></a><span id="l50.880">             */</span>
<a href="#l50.881"></a><span id="l50.881">             data-&gt;ds_state = DS_BODY;</span>
<a href="#l50.882"></a><span id="l50.882" class="difflineminus">-            if (new_line_size &gt; data-&gt;line_buffer_size &amp;&amp; new_line_size &lt;= 997) /* don't let bad value hurt us! */</span>
<a href="#l50.883"></a><span id="l50.883" class="difflineplus">+            if (new_line_size &gt; data-&gt;line_buffer_size &amp;&amp;</span>
<a href="#l50.884"></a><span id="l50.884" class="difflineplus">+                new_line_size &lt;= 997) /* don't let bad value hurt us! */</span>
<a href="#l50.885"></a><span id="l50.885">             {</span>
<a href="#l50.886"></a><span id="l50.886">               PR_Free(data-&gt;line_buffer);</span>
<a href="#l50.887"></a><span id="l50.887" class="difflineminus">-              data-&gt;line_buffer_size = new_line_size + 4; //extra chars for line ending and potential escape char</span>
<a href="#l50.888"></a><span id="l50.888" class="difflineplus">+              data-&gt;line_buffer_size =</span>
<a href="#l50.889"></a><span id="l50.889" class="difflineplus">+                  new_line_size +</span>
<a href="#l50.890"></a><span id="l50.890" class="difflineplus">+                  4;  // extra chars for line ending and potential escape char</span>
<a href="#l50.891"></a><span id="l50.891">               data-&gt;line_buffer = (char *)PR_MALLOC(data-&gt;line_buffer_size);</span>
<a href="#l50.892"></a><span id="l50.892" class="difflineminus">-              if (!data-&gt;line_buffer)</span>
<a href="#l50.893"></a><span id="l50.893" class="difflineminus">-                return -1;</span>
<a href="#l50.894"></a><span id="l50.894" class="difflineplus">+              if (!data-&gt;line_buffer) return -1;</span>
<a href="#l50.895"></a><span id="l50.895">             }</span>
<a href="#l50.896"></a><span id="l50.896">           }</span>
<a href="#l50.897"></a><span id="l50.897">         }</span>
<a href="#l50.898"></a><span id="l50.898" class="difflineminus">-</span>
<a href="#l50.899"></a><span id="l50.899">       }</span>
<a href="#l50.900"></a><span id="l50.900">       *data-&gt;line_buffer = 0;</span>
<a href="#l50.901"></a><span id="l50.901">       continue;</span>
<a href="#l50.902"></a><span id="l50.902">     }</span>
<a href="#l50.903"></a><span id="l50.903"> </span>
<a href="#l50.904"></a><span id="l50.904" class="difflineminus">-    if (data-&gt;ds_state == DS_BODY &amp;&amp; line[0] == '=')</span>
<a href="#l50.905"></a><span id="l50.905" class="difflineminus">-    {</span>
<a href="#l50.906"></a><span id="l50.906" class="difflineplus">+    if (data-&gt;ds_state == DS_BODY &amp;&amp; line[0] == '=') {</span>
<a href="#l50.907"></a><span id="l50.907">       /* look if this this the final line */</span>
<a href="#l50.908"></a><span id="l50.908" class="difflineminus">-      if (!strncmp (line, &quot;=yend size=&quot;, 11))</span>
<a href="#l50.909"></a><span id="l50.909" class="difflineminus">-      {</span>
<a href="#l50.910"></a><span id="l50.910" class="difflineplus">+      if (!strncmp(line, &quot;=yend size=&quot;, 11)) {</span>
<a href="#l50.911"></a><span id="l50.911">         /* done! */</span>
<a href="#l50.912"></a><span id="l50.912">         data-&gt;ds_state = DS_END;</span>
<a href="#l50.913"></a><span id="l50.913">         *line = 0;</span>
<a href="#l50.914"></a><span id="l50.914">         break;</span>
<a href="#l50.915"></a><span id="l50.915">       }</span>
<a href="#l50.916"></a><span id="l50.916">     }</span>
<a href="#l50.917"></a><span id="l50.917"> </span>
<a href="#l50.918"></a><span id="l50.918">     /* We're in DS_BODY.  Decode the line in place. */</span>
<a href="#l50.919"></a><span id="l50.919">     {</span>
<a href="#l50.920"></a><span id="l50.920">       char *src = line;</span>
<a href="#l50.921"></a><span id="l50.921">       char *dest = src;</span>
<a href="#l50.922"></a><span id="l50.922">       char c;</span>
<a href="#l50.923"></a><span id="l50.923" class="difflineminus">-      for (; src &lt; line_end; src ++)</span>
<a href="#l50.924"></a><span id="l50.924" class="difflineminus">-      {</span>
<a href="#l50.925"></a><span id="l50.925" class="difflineplus">+      for (; src &lt; line_end; src++) {</span>
<a href="#l50.926"></a><span id="l50.926">         c = *src;</span>
<a href="#l50.927"></a><span id="l50.927" class="difflineminus">-        if (!c || c == '\r' || c == '\n')</span>
<a href="#l50.928"></a><span id="l50.928" class="difflineminus">-          break;</span>
<a href="#l50.929"></a><span id="l50.929" class="difflineplus">+        if (!c || c == '\r' || c == '\n') break;</span>
<a href="#l50.930"></a><span id="l50.930"> </span>
<a href="#l50.931"></a><span id="l50.931" class="difflineminus">-        if (c == '=')</span>
<a href="#l50.932"></a><span id="l50.932" class="difflineminus">-        {</span>
<a href="#l50.933"></a><span id="l50.933" class="difflineplus">+        if (c == '=') {</span>
<a href="#l50.934"></a><span id="l50.934">           src++;</span>
<a href="#l50.935"></a><span id="l50.935">           c = *src;</span>
<a href="#l50.936"></a><span id="l50.936" class="difflineminus">-          if (c == 0)</span>
<a href="#l50.937"></a><span id="l50.937" class="difflineminus">-            return -1;  /* last character cannot be escape char */</span>
<a href="#l50.938"></a><span id="l50.938" class="difflineplus">+          if (c == 0) return -1; /* last character cannot be escape char */</span>
<a href="#l50.939"></a><span id="l50.939">           c -= 64;</span>
<a href="#l50.940"></a><span id="l50.940">         }</span>
<a href="#l50.941"></a><span id="l50.941">         c -= 42;</span>
<a href="#l50.942"></a><span id="l50.942">         *dest = c;</span>
<a href="#l50.943"></a><span id="l50.943" class="difflineminus">-        dest ++;</span>
<a href="#l50.944"></a><span id="l50.944" class="difflineplus">+        dest++;</span>
<a href="#l50.945"></a><span id="l50.945">       }</span>
<a href="#l50.946"></a><span id="l50.946"> </span>
<a href="#l50.947"></a><span id="l50.947">       // The assertion below is helpful, too</span>
<a href="#l50.948"></a><span id="l50.948" class="difflineminus">-      if (outSize)</span>
<a href="#l50.949"></a><span id="l50.949" class="difflineminus">-        *outSize = dest - line;</span>
<a href="#l50.950"></a><span id="l50.950" class="difflineplus">+      if (outSize) *outSize = dest - line;</span>
<a href="#l50.951"></a><span id="l50.951"> </span>
<a href="#l50.952"></a><span id="l50.952">       /* Now write out what we decoded for this line. */</span>
<a href="#l50.953"></a><span id="l50.953">       NS_ASSERTION(dest &gt;= line &amp;&amp; dest &lt;= src, &quot;nothing to write!&quot;);</span>
<a href="#l50.954"></a><span id="l50.954" class="difflineminus">-      if (dest &gt; line)</span>
<a href="#l50.955"></a><span id="l50.955" class="difflineminus">-      {</span>
<a href="#l50.956"></a><span id="l50.956" class="difflineminus">-        status = data-&gt;write_buffer (line, dest - line, data-&gt;closure);</span>
<a href="#l50.957"></a><span id="l50.957" class="difflineplus">+      if (dest &gt; line) {</span>
<a href="#l50.958"></a><span id="l50.958" class="difflineplus">+        status = data-&gt;write_buffer(line, dest - line, data-&gt;closure);</span>
<a href="#l50.959"></a><span id="l50.959">         if (status &lt; 0) /* abort */</span>
<a href="#l50.960"></a><span id="l50.960">           return status;</span>
<a href="#l50.961"></a><span id="l50.961">       }</span>
<a href="#l50.962"></a><span id="l50.962"> </span>
<a href="#l50.963"></a><span id="l50.963">       /* Reset the line so that we don't think it's partial next time. */</span>
<a href="#l50.964"></a><span id="l50.964">       *line = 0;</span>
<a href="#l50.965"></a><span id="l50.965">     }</span>
<a href="#l50.966"></a><span id="l50.966">   }</span>
<a href="#l50.967"></a><span id="l50.967"> </span>
<a href="#l50.968"></a><span id="l50.968">   return 1;</span>
<a href="#l50.969"></a><span id="l50.969"> }</span>
<a href="#l50.970"></a><span id="l50.970"> </span>
<a href="#l50.971"></a><span id="l50.971" class="difflineminus">-int</span>
<a href="#l50.972"></a><span id="l50.972" class="difflineminus">-MimeDecoderDestroy (MimeDecoderData *data, bool abort_p)</span>
<a href="#l50.973"></a><span id="l50.973" class="difflineminus">-{</span>
<a href="#l50.974"></a><span id="l50.974" class="difflineplus">+int MimeDecoderDestroy(MimeDecoderData *data, bool abort_p) {</span>
<a href="#l50.975"></a><span id="l50.975">   int status = 0;</span>
<a href="#l50.976"></a><span id="l50.976">   /* Flush out the last few buffered characters. */</span>
<a href="#l50.977"></a><span id="l50.977" class="difflineminus">-  if (!abort_p &amp;&amp;</span>
<a href="#l50.978"></a><span id="l50.978" class="difflineminus">-    data-&gt;token_size &gt; 0 &amp;&amp;</span>
<a href="#l50.979"></a><span id="l50.979" class="difflineminus">-    data-&gt;token[0] != '=')</span>
<a href="#l50.980"></a><span id="l50.980" class="difflineminus">-  {</span>
<a href="#l50.981"></a><span id="l50.981" class="difflineplus">+  if (!abort_p &amp;&amp; data-&gt;token_size &gt; 0 &amp;&amp; data-&gt;token[0] != '=') {</span>
<a href="#l50.982"></a><span id="l50.982">     if (data-&gt;encoding == mime_Base64)</span>
<a href="#l50.983"></a><span id="l50.983" class="difflineminus">-    while ((unsigned int)data-&gt;token_size &lt; sizeof (data-&gt;token))</span>
<a href="#l50.984"></a><span id="l50.984" class="difflineminus">-      data-&gt;token [data-&gt;token_size++] = '=';</span>
<a href="#l50.985"></a><span id="l50.985" class="difflineplus">+      while ((unsigned int)data-&gt;token_size &lt; sizeof(data-&gt;token))</span>
<a href="#l50.986"></a><span id="l50.986" class="difflineplus">+        data-&gt;token[data-&gt;token_size++] = '=';</span>
<a href="#l50.987"></a><span id="l50.987"> </span>
<a href="#l50.988"></a><span id="l50.988" class="difflineminus">-    status = data-&gt;write_buffer (data-&gt;token, data-&gt;token_size,</span>
<a href="#l50.989"></a><span id="l50.989" class="difflineminus">-                   data-&gt;closure);</span>
<a href="#l50.990"></a><span id="l50.990" class="difflineplus">+    status = data-&gt;write_buffer(data-&gt;token, data-&gt;token_size, data-&gt;closure);</span>
<a href="#l50.991"></a><span id="l50.991">   }</span>
<a href="#l50.992"></a><span id="l50.992"> </span>
<a href="#l50.993"></a><span id="l50.993" class="difflineminus">-  if (data-&gt;line_buffer)</span>
<a href="#l50.994"></a><span id="l50.994" class="difflineminus">-    PR_Free(data-&gt;line_buffer);</span>
<a href="#l50.995"></a><span id="l50.995" class="difflineminus">-  PR_Free (data);</span>
<a href="#l50.996"></a><span id="l50.996" class="difflineplus">+  if (data-&gt;line_buffer) PR_Free(data-&gt;line_buffer);</span>
<a href="#l50.997"></a><span id="l50.997" class="difflineplus">+  PR_Free(data);</span>
<a href="#l50.998"></a><span id="l50.998">   return status;</span>
<a href="#l50.999"></a><span id="l50.999"> }</span>
<a href="#l50.1000"></a><span id="l50.1000"> </span>
<a href="#l50.1001"></a><span id="l50.1001" class="difflineminus">-</span>
<a href="#l50.1002"></a><span id="l50.1002" class="difflineminus">-static MimeDecoderData *</span>
<a href="#l50.1003"></a><span id="l50.1003" class="difflineminus">-mime_decoder_init (mime_encoding which,</span>
<a href="#l50.1004"></a><span id="l50.1004" class="difflineminus">-           MimeConverterOutputCallback output_fn,</span>
<a href="#l50.1005"></a><span id="l50.1005" class="difflineminus">-           void *closure)</span>
<a href="#l50.1006"></a><span id="l50.1006" class="difflineminus">-{</span>
<a href="#l50.1007"></a><span id="l50.1007" class="difflineplus">+static MimeDecoderData *mime_decoder_init(mime_encoding which,</span>
<a href="#l50.1008"></a><span id="l50.1008" class="difflineplus">+                                          MimeConverterOutputCallback output_fn,</span>
<a href="#l50.1009"></a><span id="l50.1009" class="difflineplus">+                                          void *closure) {</span>
<a href="#l50.1010"></a><span id="l50.1010">   MimeDecoderData *data = PR_NEW(MimeDecoderData);</span>
<a href="#l50.1011"></a><span id="l50.1011">   if (!data) return 0;</span>
<a href="#l50.1012"></a><span id="l50.1012">   memset(data, 0, sizeof(*data));</span>
<a href="#l50.1013"></a><span id="l50.1013">   data-&gt;encoding = which;</span>
<a href="#l50.1014"></a><span id="l50.1014">   data-&gt;write_buffer = output_fn;</span>
<a href="#l50.1015"></a><span id="l50.1015">   data-&gt;closure = closure;</span>
<a href="#l50.1016"></a><span id="l50.1016">   data-&gt;line_buffer_size = 0;</span>
<a href="#l50.1017"></a><span id="l50.1017">   data-&gt;line_buffer = nullptr;</span>
<a href="#l50.1018"></a><span id="l50.1018"> </span>
<a href="#l50.1019"></a><span id="l50.1019">   return data;</span>
<a href="#l50.1020"></a><span id="l50.1020"> }</span>
<a href="#l50.1021"></a><span id="l50.1021"> </span>
<a href="#l50.1022"></a><span id="l50.1022" class="difflineminus">-MimeDecoderData *</span>
<a href="#l50.1023"></a><span id="l50.1023" class="difflineminus">-MimeB64DecoderInit (MimeConverterOutputCallback output_fn, void *closure)</span>
<a href="#l50.1024"></a><span id="l50.1024" class="difflineminus">-{</span>
<a href="#l50.1025"></a><span id="l50.1025" class="difflineminus">-  return mime_decoder_init (mime_Base64, output_fn, closure);</span>
<a href="#l50.1026"></a><span id="l50.1026" class="difflineplus">+MimeDecoderData *MimeB64DecoderInit(MimeConverterOutputCallback output_fn,</span>
<a href="#l50.1027"></a><span id="l50.1027" class="difflineplus">+                                    void *closure) {</span>
<a href="#l50.1028"></a><span id="l50.1028" class="difflineplus">+  return mime_decoder_init(mime_Base64, output_fn, closure);</span>
<a href="#l50.1029"></a><span id="l50.1029"> }</span>
<a href="#l50.1030"></a><span id="l50.1030"> </span>
<a href="#l50.1031"></a><span id="l50.1031" class="difflineminus">-MimeDecoderData *</span>
<a href="#l50.1032"></a><span id="l50.1032" class="difflineminus">-MimeQPDecoderInit (MimeConverterOutputCallback output_fn,</span>
<a href="#l50.1033"></a><span id="l50.1033" class="difflineminus">-           void *closure, MimeObject *object)</span>
<a href="#l50.1034"></a><span id="l50.1034" class="difflineminus">-{</span>
<a href="#l50.1035"></a><span id="l50.1035" class="difflineminus">-  MimeDecoderData *retData = mime_decoder_init (mime_QuotedPrintable, output_fn, closure);</span>
<a href="#l50.1036"></a><span id="l50.1036" class="difflineminus">-  if (retData)</span>
<a href="#l50.1037"></a><span id="l50.1037" class="difflineminus">-    retData-&gt;objectToDecode = object;</span>
<a href="#l50.1038"></a><span id="l50.1038" class="difflineplus">+MimeDecoderData *MimeQPDecoderInit(MimeConverterOutputCallback output_fn,</span>
<a href="#l50.1039"></a><span id="l50.1039" class="difflineplus">+                                   void *closure, MimeObject *object) {</span>
<a href="#l50.1040"></a><span id="l50.1040" class="difflineplus">+  MimeDecoderData *retData =</span>
<a href="#l50.1041"></a><span id="l50.1041" class="difflineplus">+      mime_decoder_init(mime_QuotedPrintable, output_fn, closure);</span>
<a href="#l50.1042"></a><span id="l50.1042" class="difflineplus">+  if (retData) retData-&gt;objectToDecode = object;</span>
<a href="#l50.1043"></a><span id="l50.1043">   return retData;</span>
<a href="#l50.1044"></a><span id="l50.1044"> }</span>
<a href="#l50.1045"></a><span id="l50.1045"> </span>
<a href="#l50.1046"></a><span id="l50.1046" class="difflineminus">-MimeDecoderData *</span>
<a href="#l50.1047"></a><span id="l50.1047" class="difflineminus">-MimeUUDecoderInit (MimeConverterOutputCallback output_fn,</span>
<a href="#l50.1048"></a><span id="l50.1048" class="difflineminus">-           void *closure)</span>
<a href="#l50.1049"></a><span id="l50.1049" class="difflineminus">-{</span>
<a href="#l50.1050"></a><span id="l50.1050" class="difflineminus">-  return mime_decoder_init (mime_uuencode, output_fn, closure);</span>
<a href="#l50.1051"></a><span id="l50.1051" class="difflineplus">+MimeDecoderData *MimeUUDecoderInit(MimeConverterOutputCallback output_fn,</span>
<a href="#l50.1052"></a><span id="l50.1052" class="difflineplus">+                                   void *closure) {</span>
<a href="#l50.1053"></a><span id="l50.1053" class="difflineplus">+  return mime_decoder_init(mime_uuencode, output_fn, closure);</span>
<a href="#l50.1054"></a><span id="l50.1054"> }</span>
<a href="#l50.1055"></a><span id="l50.1055"> </span>
<a href="#l50.1056"></a><span id="l50.1056" class="difflineminus">-MimeDecoderData *</span>
<a href="#l50.1057"></a><span id="l50.1057" class="difflineminus">-MimeYDecoderInit (MimeConverterOutputCallback output_fn,</span>
<a href="#l50.1058"></a><span id="l50.1058" class="difflineminus">-           void *closure)</span>
<a href="#l50.1059"></a><span id="l50.1059" class="difflineminus">-{</span>
<a href="#l50.1060"></a><span id="l50.1060" class="difflineminus">-  return mime_decoder_init (mime_yencode, output_fn, closure);</span>
<a href="#l50.1061"></a><span id="l50.1061" class="difflineplus">+MimeDecoderData *MimeYDecoderInit(MimeConverterOutputCallback output_fn,</span>
<a href="#l50.1062"></a><span id="l50.1062" class="difflineplus">+                                  void *closure) {</span>
<a href="#l50.1063"></a><span id="l50.1063" class="difflineplus">+  return mime_decoder_init(mime_yencode, output_fn, closure);</span>
<a href="#l50.1064"></a><span id="l50.1064"> }</span>
<a href="#l50.1065"></a><span id="l50.1065"> </span>
<a href="#l50.1066"></a><span id="l50.1066" class="difflineminus">-int</span>
<a href="#l50.1067"></a><span id="l50.1067" class="difflineminus">-MimeDecoderWrite (MimeDecoderData *data, const char *buffer, int32_t size,</span>
<a href="#l50.1068"></a><span id="l50.1068" class="difflineminus">-          int32_t *outSize)</span>
<a href="#l50.1069"></a><span id="l50.1069" class="difflineminus">-{</span>
<a href="#l50.1070"></a><span id="l50.1070" class="difflineplus">+int MimeDecoderWrite(MimeDecoderData *data, const char *buffer, int32_t size,</span>
<a href="#l50.1071"></a><span id="l50.1071" class="difflineplus">+                     int32_t *outSize) {</span>
<a href="#l50.1072"></a><span id="l50.1072">   NS_ASSERTION(data, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.1073"></a><span id="l50.1073">   if (!data) return -1;</span>
<a href="#l50.1074"></a><span id="l50.1074" class="difflineminus">-  switch(data-&gt;encoding)</span>
<a href="#l50.1075"></a><span id="l50.1075" class="difflineminus">-  {</span>
<a href="#l50.1076"></a><span id="l50.1076" class="difflineminus">-  case mime_Base64:</span>
<a href="#l50.1077"></a><span id="l50.1077" class="difflineminus">-    return mime_decode_base64_buffer (data, buffer, size, outSize);</span>
<a href="#l50.1078"></a><span id="l50.1078" class="difflineminus">-  case mime_QuotedPrintable:</span>
<a href="#l50.1079"></a><span id="l50.1079" class="difflineminus">-    return mime_decode_qp_buffer (data, buffer, size, outSize);</span>
<a href="#l50.1080"></a><span id="l50.1080" class="difflineminus">-  case mime_uuencode:</span>
<a href="#l50.1081"></a><span id="l50.1081" class="difflineminus">-    return mime_decode_uue_buffer (data, buffer, size, outSize);</span>
<a href="#l50.1082"></a><span id="l50.1082" class="difflineminus">-  case mime_yencode:</span>
<a href="#l50.1083"></a><span id="l50.1083" class="difflineminus">-    return mime_decode_yenc_buffer (data, buffer, size, outSize);</span>
<a href="#l50.1084"></a><span id="l50.1084" class="difflineminus">-  default:</span>
<a href="#l50.1085"></a><span id="l50.1085" class="difflineminus">-    NS_ERROR(&quot;Invalid decoding&quot;);</span>
<a href="#l50.1086"></a><span id="l50.1086" class="difflineminus">-    return -1;</span>
<a href="#l50.1087"></a><span id="l50.1087" class="difflineplus">+  switch (data-&gt;encoding) {</span>
<a href="#l50.1088"></a><span id="l50.1088" class="difflineplus">+    case mime_Base64:</span>
<a href="#l50.1089"></a><span id="l50.1089" class="difflineplus">+      return mime_decode_base64_buffer(data, buffer, size, outSize);</span>
<a href="#l50.1090"></a><span id="l50.1090" class="difflineplus">+    case mime_QuotedPrintable:</span>
<a href="#l50.1091"></a><span id="l50.1091" class="difflineplus">+      return mime_decode_qp_buffer(data, buffer, size, outSize);</span>
<a href="#l50.1092"></a><span id="l50.1092" class="difflineplus">+    case mime_uuencode:</span>
<a href="#l50.1093"></a><span id="l50.1093" class="difflineplus">+      return mime_decode_uue_buffer(data, buffer, size, outSize);</span>
<a href="#l50.1094"></a><span id="l50.1094" class="difflineplus">+    case mime_yencode:</span>
<a href="#l50.1095"></a><span id="l50.1095" class="difflineplus">+      return mime_decode_yenc_buffer(data, buffer, size, outSize);</span>
<a href="#l50.1096"></a><span id="l50.1096" class="difflineplus">+    default:</span>
<a href="#l50.1097"></a><span id="l50.1097" class="difflineplus">+      NS_ERROR(&quot;Invalid decoding&quot;);</span>
<a href="#l50.1098"></a><span id="l50.1098" class="difflineplus">+      return -1;</span>
<a href="#l50.1099"></a><span id="l50.1099">   }</span>
<a href="#l50.1100"></a><span id="l50.1100"> }</span>
<a href="#l50.1101"></a><span id="l50.1101"> </span>
<a href="#l50.1102"></a><span id="l50.1102" class="difflineminus">-</span>
<a href="#l50.1103"></a><span id="l50.1103"> namespace mozilla {</span>
<a href="#l50.1104"></a><span id="l50.1104"> namespace mailnews {</span>
<a href="#l50.1105"></a><span id="l50.1105"> </span>
<a href="#l50.1106"></a><span id="l50.1106"> MimeEncoder::MimeEncoder(OutputCallback callback, void *closure)</span>
<a href="#l50.1107"></a><span id="l50.1107" class="difflineminus">-: mCallback(callback),</span>
<a href="#l50.1108"></a><span id="l50.1108" class="difflineminus">-  mClosure(closure),</span>
<a href="#l50.1109"></a><span id="l50.1109" class="difflineminus">-  mCurrentColumn(0)</span>
<a href="#l50.1110"></a><span id="l50.1110" class="difflineminus">-{}</span>
<a href="#l50.1111"></a><span id="l50.1111" class="difflineplus">+    : mCallback(callback), mClosure(closure), mCurrentColumn(0) {}</span>
<a href="#l50.1112"></a><span id="l50.1112"> </span>
<a href="#l50.1113"></a><span id="l50.1113"> class Base64Encoder : public MimeEncoder {</span>
<a href="#l50.1114"></a><span id="l50.1114">   unsigned char in_buffer[3];</span>
<a href="#l50.1115"></a><span id="l50.1115">   int32_t in_buffer_count;</span>
<a href="#l50.1116"></a><span id="l50.1116"> </span>
<a href="#l50.1117"></a><span id="l50.1117" class="difflineminus">-public:</span>
<a href="#l50.1118"></a><span id="l50.1118" class="difflineplus">+ public:</span>
<a href="#l50.1119"></a><span id="l50.1119">   Base64Encoder(OutputCallback callback, void *closure)</span>
<a href="#l50.1120"></a><span id="l50.1120" class="difflineminus">-    : MimeEncoder(callback, closure),</span>
<a href="#l50.1121"></a><span id="l50.1121" class="difflineminus">-      in_buffer_count(0) {}</span>
<a href="#l50.1122"></a><span id="l50.1122" class="difflineplus">+      : MimeEncoder(callback, closure), in_buffer_count(0) {}</span>
<a href="#l50.1123"></a><span id="l50.1123">   virtual ~Base64Encoder() {}</span>
<a href="#l50.1124"></a><span id="l50.1124"> </span>
<a href="#l50.1125"></a><span id="l50.1125">   virtual nsresult Write(const char *buffer, int32_t size) override;</span>
<a href="#l50.1126"></a><span id="l50.1126">   virtual nsresult Flush() override;</span>
<a href="#l50.1127"></a><span id="l50.1127"> </span>
<a href="#l50.1128"></a><span id="l50.1128" class="difflineminus">-private:</span>
<a href="#l50.1129"></a><span id="l50.1129" class="difflineplus">+ private:</span>
<a href="#l50.1130"></a><span id="l50.1130">   static void Base64EncodeBits(RangedPtr&lt;char&gt; &amp;out, uint32_t bits);</span>
<a href="#l50.1131"></a><span id="l50.1131"> };</span>
<a href="#l50.1132"></a><span id="l50.1132"> </span>
<a href="#l50.1133"></a><span id="l50.1133" class="difflineminus">-nsresult Base64Encoder::Write(const char *buffer, int32_t size)</span>
<a href="#l50.1134"></a><span id="l50.1134" class="difflineminus">-{</span>
<a href="#l50.1135"></a><span id="l50.1135" class="difflineplus">+nsresult Base64Encoder::Write(const char *buffer, int32_t size) {</span>
<a href="#l50.1136"></a><span id="l50.1136">   if (size == 0)</span>
<a href="#l50.1137"></a><span id="l50.1137">     return NS_OK;</span>
<a href="#l50.1138"></a><span id="l50.1138" class="difflineminus">-  else if (size &lt; 0)</span>
<a href="#l50.1139"></a><span id="l50.1139" class="difflineminus">-  {</span>
<a href="#l50.1140"></a><span id="l50.1140" class="difflineplus">+  else if (size &lt; 0) {</span>
<a href="#l50.1141"></a><span id="l50.1141">     NS_ERROR(&quot;Size is less than 0&quot;);</span>
<a href="#l50.1142"></a><span id="l50.1142">     return NS_ERROR_FAILURE;</span>
<a href="#l50.1143"></a><span id="l50.1143">   }</span>
<a href="#l50.1144"></a><span id="l50.1144"> </span>
<a href="#l50.1145"></a><span id="l50.1145">   // If this input buffer is too small, wait until next time.</span>
<a href="#l50.1146"></a><span id="l50.1146" class="difflineminus">-  if (size &lt; (3 - in_buffer_count))</span>
<a href="#l50.1147"></a><span id="l50.1147" class="difflineminus">-  {</span>
<a href="#l50.1148"></a><span id="l50.1148" class="difflineplus">+  if (size &lt; (3 - in_buffer_count)) {</span>
<a href="#l50.1149"></a><span id="l50.1149">     NS_ASSERTION(size == 1 || size == 2, &quot;Unexpected size&quot;);</span>
<a href="#l50.1150"></a><span id="l50.1150">     in_buffer[in_buffer_count++] = buffer[0];</span>
<a href="#l50.1151"></a><span id="l50.1151" class="difflineminus">-    if (size == 2)</span>
<a href="#l50.1152"></a><span id="l50.1152" class="difflineminus">-      in_buffer[in_buffer_count++] = buffer[1];</span>
<a href="#l50.1153"></a><span id="l50.1153" class="difflineplus">+    if (size == 2) in_buffer[in_buffer_count++] = buffer[1];</span>
<a href="#l50.1154"></a><span id="l50.1154">     NS_ASSERTION(in_buffer_count &lt; 3, &quot;Unexpected out buffer size&quot;);</span>
<a href="#l50.1155"></a><span id="l50.1155">     return NS_OK;</span>
<a href="#l50.1156"></a><span id="l50.1156">   }</span>
<a href="#l50.1157"></a><span id="l50.1157"> </span>
<a href="#l50.1158"></a><span id="l50.1158" class="difflineminus">-</span>
<a href="#l50.1159"></a><span id="l50.1159">   // If there are bytes that were put back last time, take them now.</span>
<a href="#l50.1160"></a><span id="l50.1160">   uint32_t i = in_buffer_count, bits = 0;</span>
<a href="#l50.1161"></a><span id="l50.1161">   if (in_buffer_count &gt; 0) bits = in_buffer[0];</span>
<a href="#l50.1162"></a><span id="l50.1162">   if (in_buffer_count &gt; 1) bits = (bits &lt;&lt; 8) + in_buffer[1];</span>
<a href="#l50.1163"></a><span id="l50.1163">   in_buffer_count = 0;</span>
<a href="#l50.1164"></a><span id="l50.1164"> </span>
<a href="#l50.1165"></a><span id="l50.1165">   // If this buffer is not a multiple of three, put one or two bytes back.</span>
<a href="#l50.1166"></a><span id="l50.1166">   uint32_t excess = ((size + i) % 3);</span>
<a href="#l50.1167"></a><span id="l50.1167" class="difflineminus">-  if (excess)</span>
<a href="#l50.1168"></a><span id="l50.1168" class="difflineminus">-  {</span>
<a href="#l50.1169"></a><span id="l50.1169" class="difflineplus">+  if (excess) {</span>
<a href="#l50.1170"></a><span id="l50.1170">     in_buffer[0] = buffer[size - excess];</span>
<a href="#l50.1171"></a><span id="l50.1171" class="difflineminus">-    if (excess &gt; 1)</span>
<a href="#l50.1172"></a><span id="l50.1172" class="difflineminus">-      in_buffer [1] = buffer[size - excess + 1];</span>
<a href="#l50.1173"></a><span id="l50.1173" class="difflineplus">+    if (excess &gt; 1) in_buffer[1] = buffer[size - excess + 1];</span>
<a href="#l50.1174"></a><span id="l50.1174">     in_buffer_count = excess;</span>
<a href="#l50.1175"></a><span id="l50.1175">     size -= excess;</span>
<a href="#l50.1176"></a><span id="l50.1176" class="difflineminus">-    NS_ASSERTION (! ((size + i) % 3), &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.1177"></a><span id="l50.1177" class="difflineplus">+    NS_ASSERTION(!((size + i) % 3), &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l50.1178"></a><span id="l50.1178">   }</span>
<a href="#l50.1179"></a><span id="l50.1179"> </span>
<a href="#l50.1180"></a><span id="l50.1180">   const uint8_t *in = (const uint8_t *)buffer;</span>
<a href="#l50.1181"></a><span id="l50.1181">   const uint8_t *end = (const uint8_t *)(buffer + size);</span>
<a href="#l50.1182"></a><span id="l50.1182">   MOZ_ASSERT((end - in + i) % 3 == 0, &quot;Need a multiple of 3 bytes to decode&quot;);</span>
<a href="#l50.1183"></a><span id="l50.1183"> </span>
<a href="#l50.1184"></a><span id="l50.1184">   // Populate the out_buffer with base64 data, one line at a time.</span>
<a href="#l50.1185"></a><span id="l50.1185" class="difflineminus">-  char out_buffer[80]; // Max line length will be 80, so this is safe.</span>
<a href="#l50.1186"></a><span id="l50.1186" class="difflineplus">+  char out_buffer[80];  // Max line length will be 80, so this is safe.</span>
<a href="#l50.1187"></a><span id="l50.1187">   RangedPtr&lt;char&gt; out(out_buffer);</span>
<a href="#l50.1188"></a><span id="l50.1188" class="difflineminus">-  while (in &lt; end)</span>
<a href="#l50.1189"></a><span id="l50.1189" class="difflineminus">-  {</span>
<a href="#l50.1190"></a><span id="l50.1190" class="difflineplus">+  while (in &lt; end) {</span>
<a href="#l50.1191"></a><span id="l50.1191">     // Accumulate the input bits.</span>
<a href="#l50.1192"></a><span id="l50.1192" class="difflineminus">-    while (i &lt; 3)</span>
<a href="#l50.1193"></a><span id="l50.1193" class="difflineminus">-    {</span>
<a href="#l50.1194"></a><span id="l50.1194" class="difflineplus">+    while (i &lt; 3) {</span>
<a href="#l50.1195"></a><span id="l50.1195">       bits = (bits &lt;&lt; 8) | *in++;</span>
<a href="#l50.1196"></a><span id="l50.1196">       i++;</span>
<a href="#l50.1197"></a><span id="l50.1197">     }</span>
<a href="#l50.1198"></a><span id="l50.1198">     i = 0;</span>
<a href="#l50.1199"></a><span id="l50.1199"> </span>
<a href="#l50.1200"></a><span id="l50.1200">     Base64EncodeBits(out, bits);</span>
<a href="#l50.1201"></a><span id="l50.1201"> </span>
<a href="#l50.1202"></a><span id="l50.1202">     mCurrentColumn += 4;</span>
<a href="#l50.1203"></a><span id="l50.1203" class="difflineminus">-    if (mCurrentColumn &gt;= 72)</span>
<a href="#l50.1204"></a><span id="l50.1204" class="difflineminus">-    {</span>
<a href="#l50.1205"></a><span id="l50.1205" class="difflineplus">+    if (mCurrentColumn &gt;= 72) {</span>
<a href="#l50.1206"></a><span id="l50.1206">       // Do a linebreak before column 76.  Flush out the line buffer.</span>
<a href="#l50.1207"></a><span id="l50.1207">       mCurrentColumn = 0;</span>
<a href="#l50.1208"></a><span id="l50.1208">       *out++ = '\x0D';</span>
<a href="#l50.1209"></a><span id="l50.1209">       *out++ = '\x0A';</span>
<a href="#l50.1210"></a><span id="l50.1210">       nsresult rv = mCallback(out_buffer, (out.get() - out_buffer), mClosure);</span>
<a href="#l50.1211"></a><span id="l50.1211">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.1212"></a><span id="l50.1212">       out = out_buffer;</span>
<a href="#l50.1213"></a><span id="l50.1213">     }</span>
<a href="#l50.1214"></a><span id="l50.1214">   }</span>
<a href="#l50.1215"></a><span id="l50.1215"> </span>
<a href="#l50.1216"></a><span id="l50.1216">   // Write out the unwritten portion of the last line buffer.</span>
<a href="#l50.1217"></a><span id="l50.1217" class="difflineminus">-  if (out.get() &gt; out_buffer)</span>
<a href="#l50.1218"></a><span id="l50.1218" class="difflineminus">-  {</span>
<a href="#l50.1219"></a><span id="l50.1219" class="difflineplus">+  if (out.get() &gt; out_buffer) {</span>
<a href="#l50.1220"></a><span id="l50.1220">     nsresult rv = mCallback(out_buffer, out.get() - out_buffer, mClosure);</span>
<a href="#l50.1221"></a><span id="l50.1221">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.1222"></a><span id="l50.1222">   }</span>
<a href="#l50.1223"></a><span id="l50.1223"> </span>
<a href="#l50.1224"></a><span id="l50.1224">   return NS_OK;</span>
<a href="#l50.1225"></a><span id="l50.1225"> }</span>
<a href="#l50.1226"></a><span id="l50.1226"> </span>
<a href="#l50.1227"></a><span id="l50.1227" class="difflineminus">-nsresult Base64Encoder::Flush()</span>
<a href="#l50.1228"></a><span id="l50.1228" class="difflineminus">-{</span>
<a href="#l50.1229"></a><span id="l50.1229" class="difflineminus">-  if (in_buffer_count == 0)</span>
<a href="#l50.1230"></a><span id="l50.1230" class="difflineminus">-    return NS_OK;</span>
<a href="#l50.1231"></a><span id="l50.1231" class="difflineplus">+nsresult Base64Encoder::Flush() {</span>
<a href="#l50.1232"></a><span id="l50.1232" class="difflineplus">+  if (in_buffer_count == 0) return NS_OK;</span>
<a href="#l50.1233"></a><span id="l50.1233"> </span>
<a href="#l50.1234"></a><span id="l50.1234">   // Since we need to some buffering to get a multiple of three bytes on each</span>
<a href="#l50.1235"></a><span id="l50.1235">   // block, there may be a few bytes left in the buffer after the last block has</span>
<a href="#l50.1236"></a><span id="l50.1236">   // been written. We need to flush those out now.</span>
<a href="#l50.1237"></a><span id="l50.1237">   char buf[4];</span>
<a href="#l50.1238"></a><span id="l50.1238">   RangedPtr&lt;char&gt; out(buf);</span>
<a href="#l50.1239"></a><span id="l50.1239">   uint32_t bits = ((uint32_t)in_buffer[0]) &lt;&lt; 16;</span>
<a href="#l50.1240"></a><span id="l50.1240" class="difflineminus">-  if (in_buffer_count &gt; 1)</span>
<a href="#l50.1241"></a><span id="l50.1241" class="difflineminus">-    bits |= (((uint32_t)in_buffer[1]) &lt;&lt; 8);</span>
<a href="#l50.1242"></a><span id="l50.1242" class="difflineplus">+  if (in_buffer_count &gt; 1) bits |= (((uint32_t)in_buffer[1]) &lt;&lt; 8);</span>
<a href="#l50.1243"></a><span id="l50.1243"> </span>
<a href="#l50.1244"></a><span id="l50.1244">   Base64EncodeBits(out, bits);</span>
<a href="#l50.1245"></a><span id="l50.1245"> </span>
<a href="#l50.1246"></a><span id="l50.1246">   // Pad with equal-signs.</span>
<a href="#l50.1247"></a><span id="l50.1247" class="difflineminus">-  if (in_buffer_count == 1)</span>
<a href="#l50.1248"></a><span id="l50.1248" class="difflineminus">-    buf[2] = '=';</span>
<a href="#l50.1249"></a><span id="l50.1249" class="difflineplus">+  if (in_buffer_count == 1) buf[2] = '=';</span>
<a href="#l50.1250"></a><span id="l50.1250">   buf[3] = '=';</span>
<a href="#l50.1251"></a><span id="l50.1251"> </span>
<a href="#l50.1252"></a><span id="l50.1252">   return mCallback(buf, 4, mClosure);</span>
<a href="#l50.1253"></a><span id="l50.1253"> }</span>
<a href="#l50.1254"></a><span id="l50.1254"> </span>
<a href="#l50.1255"></a><span id="l50.1255" class="difflineminus">-void Base64Encoder::Base64EncodeBits(RangedPtr&lt;char&gt; &amp;out, uint32_t bits)</span>
<a href="#l50.1256"></a><span id="l50.1256" class="difflineminus">-{</span>
<a href="#l50.1257"></a><span id="l50.1257" class="difflineplus">+void Base64Encoder::Base64EncodeBits(RangedPtr&lt;char&gt; &amp;out, uint32_t bits) {</span>
<a href="#l50.1258"></a><span id="l50.1258">   // Convert 3 bytes to 4 base64 bytes</span>
<a href="#l50.1259"></a><span id="l50.1259" class="difflineminus">-  for (int32_t j = 18; j &gt;= 0; j -= 6)</span>
<a href="#l50.1260"></a><span id="l50.1260" class="difflineminus">-  {</span>
<a href="#l50.1261"></a><span id="l50.1261" class="difflineplus">+  for (int32_t j = 18; j &gt;= 0; j -= 6) {</span>
<a href="#l50.1262"></a><span id="l50.1262">     unsigned int k = (bits &gt;&gt; j) &amp; 0x3F;</span>
<a href="#l50.1263"></a><span id="l50.1263" class="difflineminus">-    if (k &lt; 26)       *out++ = k      + 'A';</span>
<a href="#l50.1264"></a><span id="l50.1264" class="difflineminus">-    else if (k &lt; 52)  *out++ = k - 26 + 'a';</span>
<a href="#l50.1265"></a><span id="l50.1265" class="difflineminus">-    else if (k &lt; 62)  *out++ = k - 52 + '0';</span>
<a href="#l50.1266"></a><span id="l50.1266" class="difflineminus">-    else if (k == 62) *out++ = '+';</span>
<a href="#l50.1267"></a><span id="l50.1267" class="difflineminus">-    else if (k == 63) *out++ = '/';</span>
<a href="#l50.1268"></a><span id="l50.1268" class="difflineminus">-    else MOZ_CRASH(&quot;6 bits should only be between 0 and 64&quot;);</span>
<a href="#l50.1269"></a><span id="l50.1269" class="difflineplus">+    if (k &lt; 26)</span>
<a href="#l50.1270"></a><span id="l50.1270" class="difflineplus">+      *out++ = k + 'A';</span>
<a href="#l50.1271"></a><span id="l50.1271" class="difflineplus">+    else if (k &lt; 52)</span>
<a href="#l50.1272"></a><span id="l50.1272" class="difflineplus">+      *out++ = k - 26 + 'a';</span>
<a href="#l50.1273"></a><span id="l50.1273" class="difflineplus">+    else if (k &lt; 62)</span>
<a href="#l50.1274"></a><span id="l50.1274" class="difflineplus">+      *out++ = k - 52 + '0';</span>
<a href="#l50.1275"></a><span id="l50.1275" class="difflineplus">+    else if (k == 62)</span>
<a href="#l50.1276"></a><span id="l50.1276" class="difflineplus">+      *out++ = '+';</span>
<a href="#l50.1277"></a><span id="l50.1277" class="difflineplus">+    else if (k == 63)</span>
<a href="#l50.1278"></a><span id="l50.1278" class="difflineplus">+      *out++ = '/';</span>
<a href="#l50.1279"></a><span id="l50.1279" class="difflineplus">+    else</span>
<a href="#l50.1280"></a><span id="l50.1280" class="difflineplus">+      MOZ_CRASH(&quot;6 bits should only be between 0 and 64&quot;);</span>
<a href="#l50.1281"></a><span id="l50.1281">   }</span>
<a href="#l50.1282"></a><span id="l50.1282"> }</span>
<a href="#l50.1283"></a><span id="l50.1283"> </span>
<a href="#l50.1284"></a><span id="l50.1284"> class QPEncoder : public MimeEncoder {</span>
<a href="#l50.1285"></a><span id="l50.1285" class="difflineminus">-public:</span>
<a href="#l50.1286"></a><span id="l50.1286" class="difflineplus">+ public:</span>
<a href="#l50.1287"></a><span id="l50.1287">   QPEncoder(OutputCallback callback, void *closure)</span>
<a href="#l50.1288"></a><span id="l50.1288" class="difflineminus">-    : MimeEncoder(callback, closure) {}</span>
<a href="#l50.1289"></a><span id="l50.1289" class="difflineplus">+      : MimeEncoder(callback, closure) {}</span>
<a href="#l50.1290"></a><span id="l50.1290">   virtual ~QPEncoder() {}</span>
<a href="#l50.1291"></a><span id="l50.1291"> </span>
<a href="#l50.1292"></a><span id="l50.1292">   virtual nsresult Write(const char *buffer, int32_t size) override;</span>
<a href="#l50.1293"></a><span id="l50.1293"> };</span>
<a href="#l50.1294"></a><span id="l50.1294"> </span>
<a href="#l50.1295"></a><span id="l50.1295" class="difflineminus">-nsresult QPEncoder::Write(const char *buffer, int32_t size)</span>
<a href="#l50.1296"></a><span id="l50.1296" class="difflineminus">-{</span>
<a href="#l50.1297"></a><span id="l50.1297" class="difflineplus">+nsresult QPEncoder::Write(const char *buffer, int32_t size) {</span>
<a href="#l50.1298"></a><span id="l50.1298">   nsresult rv = NS_OK;</span>
<a href="#l50.1299"></a><span id="l50.1299">   static const char *hexdigits = &quot;0123456789ABCDEF&quot;;</span>
<a href="#l50.1300"></a><span id="l50.1300">   char out_buffer[80];</span>
<a href="#l50.1301"></a><span id="l50.1301">   RangedPtr&lt;char&gt; out(out_buffer);</span>
<a href="#l50.1302"></a><span id="l50.1302">   bool white = false;</span>
<a href="#l50.1303"></a><span id="l50.1303"> </span>
<a href="#l50.1304"></a><span id="l50.1304">   // Populate the out_buffer with quoted-printable data, one line at a time.</span>
<a href="#l50.1305"></a><span id="l50.1305">   const uint8_t *in = (uint8_t *)buffer;</span>
<a href="#l50.1306"></a><span id="l50.1306">   const uint8_t *end = in + size;</span>
<a href="#l50.1307"></a><span id="l50.1307" class="difflineminus">-  for (; in &lt; end; in++)</span>
<a href="#l50.1308"></a><span id="l50.1308" class="difflineminus">-  {</span>
<a href="#l50.1309"></a><span id="l50.1309" class="difflineminus">-    if (*in == '\r' || *in == '\n')</span>
<a href="#l50.1310"></a><span id="l50.1310" class="difflineminus">-    {</span>
<a href="#l50.1311"></a><span id="l50.1311" class="difflineplus">+  for (; in &lt; end; in++) {</span>
<a href="#l50.1312"></a><span id="l50.1312" class="difflineplus">+    if (*in == '\r' || *in == '\n') {</span>
<a href="#l50.1313"></a><span id="l50.1313">       // If it's CRLF, swallow two chars instead of one.</span>
<a href="#l50.1314"></a><span id="l50.1314" class="difflineminus">-      if (in + 1 &lt; end &amp;&amp; in[0] == '\r' &amp;&amp; in[1] == '\n')</span>
<a href="#l50.1315"></a><span id="l50.1315" class="difflineminus">-        in++;</span>
<a href="#l50.1316"></a><span id="l50.1316" class="difflineplus">+      if (in + 1 &lt; end &amp;&amp; in[0] == '\r' &amp;&amp; in[1] == '\n') in++;</span>
<a href="#l50.1317"></a><span id="l50.1317"> </span>
<a href="#l50.1318"></a><span id="l50.1318">       // Whitespace cannot be allowed to occur at the end of the line, so we</span>
<a href="#l50.1319"></a><span id="l50.1319">       // back up and replace the whitespace with its code.</span>
<a href="#l50.1320"></a><span id="l50.1320" class="difflineminus">-      if (white)</span>
<a href="#l50.1321"></a><span id="l50.1321" class="difflineminus">-      {</span>
<a href="#l50.1322"></a><span id="l50.1322" class="difflineplus">+      if (white) {</span>
<a href="#l50.1323"></a><span id="l50.1323">         out--;</span>
<a href="#l50.1324"></a><span id="l50.1324">         char whitespace_char = *out;</span>
<a href="#l50.1325"></a><span id="l50.1325">         *out++ = '=';</span>
<a href="#l50.1326"></a><span id="l50.1326">         *out++ = hexdigits[whitespace_char &gt;&gt; 4];</span>
<a href="#l50.1327"></a><span id="l50.1327">         *out++ = hexdigits[whitespace_char &amp; 0xF];</span>
<a href="#l50.1328"></a><span id="l50.1328">       }</span>
<a href="#l50.1329"></a><span id="l50.1329"> </span>
<a href="#l50.1330"></a><span id="l50.1330">       // Now write out the newline.</span>
<a href="#l50.1331"></a><span id="l50.1331">       *out++ = '\r';</span>
<a href="#l50.1332"></a><span id="l50.1332">       *out++ = '\n';</span>
<a href="#l50.1333"></a><span id="l50.1333">       white = false;</span>
<a href="#l50.1334"></a><span id="l50.1334"> </span>
<a href="#l50.1335"></a><span id="l50.1335">       rv = mCallback(out_buffer, out.get() - out_buffer, mClosure);</span>
<a href="#l50.1336"></a><span id="l50.1336">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.1337"></a><span id="l50.1337">       out = out_buffer;</span>
<a href="#l50.1338"></a><span id="l50.1338">       mCurrentColumn = 0;</span>
<a href="#l50.1339"></a><span id="l50.1339" class="difflineminus">-    }</span>
<a href="#l50.1340"></a><span id="l50.1340" class="difflineminus">-    else if (mCurrentColumn == 0 &amp;&amp; *in == '.')</span>
<a href="#l50.1341"></a><span id="l50.1341" class="difflineminus">-    {</span>
<a href="#l50.1342"></a><span id="l50.1342" class="difflineplus">+    } else if (mCurrentColumn == 0 &amp;&amp; *in == '.') {</span>
<a href="#l50.1343"></a><span id="l50.1343">       // Just to be SMTP-safe, if &quot;.&quot; appears in column 0, encode it.</span>
<a href="#l50.1344"></a><span id="l50.1344">       goto HEX;</span>
<a href="#l50.1345"></a><span id="l50.1345" class="difflineminus">-    }</span>
<a href="#l50.1346"></a><span id="l50.1346" class="difflineminus">-    else if (mCurrentColumn == 0 &amp;&amp; *in == 'F'</span>
<a href="#l50.1347"></a><span id="l50.1347" class="difflineminus">-               &amp;&amp; (in &gt;= end-1 || in[1] == 'r')</span>
<a href="#l50.1348"></a><span id="l50.1348" class="difflineminus">-               &amp;&amp; (in &gt;= end-2 || in[2] == 'o')</span>
<a href="#l50.1349"></a><span id="l50.1349" class="difflineminus">-               &amp;&amp; (in &gt;= end-3 || in[3] == 'm')</span>
<a href="#l50.1350"></a><span id="l50.1350" class="difflineminus">-               &amp;&amp; (in &gt;= end-4 || in[4] == ' '))</span>
<a href="#l50.1351"></a><span id="l50.1351" class="difflineminus">-    {</span>
<a href="#l50.1352"></a><span id="l50.1352" class="difflineplus">+    } else if (mCurrentColumn == 0 &amp;&amp; *in == 'F' &amp;&amp;</span>
<a href="#l50.1353"></a><span id="l50.1353" class="difflineplus">+               (in &gt;= end - 1 || in[1] == 'r') &amp;&amp;</span>
<a href="#l50.1354"></a><span id="l50.1354" class="difflineplus">+               (in &gt;= end - 2 || in[2] == 'o') &amp;&amp;</span>
<a href="#l50.1355"></a><span id="l50.1355" class="difflineplus">+               (in &gt;= end - 3 || in[3] == 'm') &amp;&amp;</span>
<a href="#l50.1356"></a><span id="l50.1356" class="difflineplus">+               (in &gt;= end - 4 || in[4] == ' ')) {</span>
<a href="#l50.1357"></a><span id="l50.1357">       // If this line begins with &quot;From &quot; (or it could but we don't have enough</span>
<a href="#l50.1358"></a><span id="l50.1358">       // data in the buffer to be certain), encode the 'F' in hex to avoid</span>
<a href="#l50.1359"></a><span id="l50.1359">       // potential problems with BSD mailbox formats.</span>
<a href="#l50.1360"></a><span id="l50.1360">       goto HEX;</span>
<a href="#l50.1361"></a><span id="l50.1361" class="difflineminus">-    }</span>
<a href="#l50.1362"></a><span id="l50.1362" class="difflineminus">-    else if ((*in &gt;= 33 &amp;&amp; *in &lt;= 60) |</span>
<a href="#l50.1363"></a><span id="l50.1363" class="difflineminus">-             (*in &gt;= 62 &amp;&amp; *in &lt;= 126)) // Printable characters except for '='</span>
<a href="#l50.1364"></a><span id="l50.1364" class="difflineplus">+    } else if ((*in &gt;= 33 &amp;&amp; *in &lt;= 60) |</span>
<a href="#l50.1365"></a><span id="l50.1365" class="difflineplus">+               (*in &gt;= 62 &amp;&amp;</span>
<a href="#l50.1366"></a><span id="l50.1366" class="difflineplus">+                *in &lt;= 126))  // Printable characters except for '='</span>
<a href="#l50.1367"></a><span id="l50.1367">     {</span>
<a href="#l50.1368"></a><span id="l50.1368">       white = false;</span>
<a href="#l50.1369"></a><span id="l50.1369">       *out++ = *in;</span>
<a href="#l50.1370"></a><span id="l50.1370">       mCurrentColumn++;</span>
<a href="#l50.1371"></a><span id="l50.1371" class="difflineminus">-    }</span>
<a href="#l50.1372"></a><span id="l50.1372" class="difflineminus">-    else if (*in == ' ' || *in == '\t') // Whitespace</span>
<a href="#l50.1373"></a><span id="l50.1373" class="difflineplus">+    } else if (*in == ' ' || *in == '\t')  // Whitespace</span>
<a href="#l50.1374"></a><span id="l50.1374">     {</span>
<a href="#l50.1375"></a><span id="l50.1375">       white = true;</span>
<a href="#l50.1376"></a><span id="l50.1376">       *out++ = *in;</span>
<a href="#l50.1377"></a><span id="l50.1377">       mCurrentColumn++;</span>
<a href="#l50.1378"></a><span id="l50.1378" class="difflineminus">-    }</span>
<a href="#l50.1379"></a><span id="l50.1379" class="difflineminus">-    else</span>
<a href="#l50.1380"></a><span id="l50.1380" class="difflineminus">-    {</span>
<a href="#l50.1381"></a><span id="l50.1381" class="difflineplus">+    } else {</span>
<a href="#l50.1382"></a><span id="l50.1382">       // Encode the characters here</span>
<a href="#l50.1383"></a><span id="l50.1383" class="difflineminus">-HEX:</span>
<a href="#l50.1384"></a><span id="l50.1384" class="difflineplus">+    HEX:</span>
<a href="#l50.1385"></a><span id="l50.1385">       white = false;</span>
<a href="#l50.1386"></a><span id="l50.1386">       *out++ = '=';</span>
<a href="#l50.1387"></a><span id="l50.1387">       *out++ = hexdigits[*in &gt;&gt; 4];</span>
<a href="#l50.1388"></a><span id="l50.1388">       *out++ = hexdigits[*in &amp; 0xF];</span>
<a href="#l50.1389"></a><span id="l50.1389">       mCurrentColumn += 3;</span>
<a href="#l50.1390"></a><span id="l50.1390">     }</span>
<a href="#l50.1391"></a><span id="l50.1391"> </span>
<a href="#l50.1392"></a><span id="l50.1392">     MOZ_ASSERT(mCurrentColumn &lt;= 76, &quot;Why haven't we added a line break yet?&quot;);</span>
<a href="#l50.1393"></a><span id="l50.1393"> </span>
<a href="#l50.1394"></a><span id="l50.1394" class="difflineminus">-    if (mCurrentColumn &gt;= 73) // Soft line break for readability</span>
<a href="#l50.1395"></a><span id="l50.1395" class="difflineplus">+    if (mCurrentColumn &gt;= 73)  // Soft line break for readability</span>
<a href="#l50.1396"></a><span id="l50.1396">     {</span>
<a href="#l50.1397"></a><span id="l50.1397">       *out++ = '=';</span>
<a href="#l50.1398"></a><span id="l50.1398">       *out++ = '\r';</span>
<a href="#l50.1399"></a><span id="l50.1399">       *out++ = '\n';</span>
<a href="#l50.1400"></a><span id="l50.1400"> </span>
<a href="#l50.1401"></a><span id="l50.1401">       rv = mCallback(out_buffer, out.get() - out_buffer, mClosure);</span>
<a href="#l50.1402"></a><span id="l50.1402">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.1403"></a><span id="l50.1403">       out = out_buffer;</span>
<a href="#l50.1404"></a><span id="l50.1404">       white = false;</span>
<a href="#l50.1405"></a><span id="l50.1405">       mCurrentColumn = 0;</span>
<a href="#l50.1406"></a><span id="l50.1406">     }</span>
<a href="#l50.1407"></a><span id="l50.1407">   }</span>
<a href="#l50.1408"></a><span id="l50.1408"> </span>
<a href="#l50.1409"></a><span id="l50.1409">   // Write out the unwritten portion of the last line buffer.</span>
<a href="#l50.1410"></a><span id="l50.1410" class="difflineminus">-  if (out.get() != out_buffer)</span>
<a href="#l50.1411"></a><span id="l50.1411" class="difflineminus">-  {</span>
<a href="#l50.1412"></a><span id="l50.1412" class="difflineplus">+  if (out.get() != out_buffer) {</span>
<a href="#l50.1413"></a><span id="l50.1413">     rv = mCallback(out_buffer, out.get() - out_buffer, mClosure);</span>
<a href="#l50.1414"></a><span id="l50.1414">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.1415"></a><span id="l50.1415">   }</span>
<a href="#l50.1416"></a><span id="l50.1416"> </span>
<a href="#l50.1417"></a><span id="l50.1417">   return NS_OK;</span>
<a href="#l50.1418"></a><span id="l50.1418"> }</span>
<a href="#l50.1419"></a><span id="l50.1419"> </span>
<a href="#l50.1420"></a><span id="l50.1420"> MimeEncoder *MimeEncoder::GetBase64Encoder(OutputCallback callback,</span>
<a href="#l50.1421"></a><span id="l50.1421" class="difflineminus">-    void *closure)</span>
<a href="#l50.1422"></a><span id="l50.1422" class="difflineminus">-{</span>
<a href="#l50.1423"></a><span id="l50.1423" class="difflineplus">+                                           void *closure) {</span>
<a href="#l50.1424"></a><span id="l50.1424">   return new Base64Encoder(callback, closure);</span>
<a href="#l50.1425"></a><span id="l50.1425"> }</span>
<a href="#l50.1426"></a><span id="l50.1426"> </span>
<a href="#l50.1427"></a><span id="l50.1427" class="difflineminus">-MimeEncoder *MimeEncoder::GetQPEncoder(OutputCallback callback, void *closure)</span>
<a href="#l50.1428"></a><span id="l50.1428" class="difflineminus">-{</span>
<a href="#l50.1429"></a><span id="l50.1429" class="difflineplus">+MimeEncoder *MimeEncoder::GetQPEncoder(OutputCallback callback, void *closure) {</span>
<a href="#l50.1430"></a><span id="l50.1430">   return new QPEncoder(callback, closure);</span>
<a href="#l50.1431"></a><span id="l50.1431"> }</span>
<a href="#l50.1432"></a><span id="l50.1432"> </span>
<a href="#l50.1433"></a><span id="l50.1433" class="difflineminus">-} // namespace mailnews</span>
<a href="#l50.1434"></a><span id="l50.1434" class="difflineminus">-} // namespace mozilla</span>
<a href="#l50.1435"></a><span id="l50.1435" class="difflineplus">+}  // namespace mailnews</span>
<a href="#l50.1436"></a><span id="l50.1436" class="difflineplus">+}  // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/mime/src/mimeeobj.cpp</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/mime/src/mimeeobj.cpp</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -8,199 +8,171 @@</span>
<a href="#l51.4"></a><span id="l51.4"> #include &quot;prmem.h&quot;</span>
<a href="#l51.5"></a><span id="l51.5"> #include &quot;plstr.h&quot;</span>
<a href="#l51.6"></a><span id="l51.6"> #include &quot;prlog.h&quot;</span>
<a href="#l51.7"></a><span id="l51.7"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l51.8"></a><span id="l51.8"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l51.9"></a><span id="l51.9"> #include &quot;mimemapl.h&quot;</span>
<a href="#l51.10"></a><span id="l51.10"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-</span>
<a href="#l51.13"></a><span id="l51.13"> #define MIME_SUPERCLASS mimeLeafClass</span>
<a href="#l51.14"></a><span id="l51.14"> MimeDefClass(MimeExternalObject, MimeExternalObjectClass,</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineminus">-       mimeExternalObjectClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+             mimeExternalObjectClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l51.17"></a><span id="l51.17"> </span>
<a href="#l51.18"></a><span id="l51.18" class="difflineminus">-static int MimeExternalObject_initialize (MimeObject *);</span>
<a href="#l51.19"></a><span id="l51.19" class="difflineminus">-static void MimeExternalObject_finalize (MimeObject *);</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineminus">-static int MimeExternalObject_parse_begin (MimeObject *);</span>
<a href="#l51.21"></a><span id="l51.21" class="difflineminus">-static int MimeExternalObject_parse_buffer (const char *, int32_t, MimeObject *);</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineminus">-static int MimeExternalObject_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineminus">-static int MimeExternalObject_parse_decoded_buffer (const char*, int32_t, MimeObject*);</span>
<a href="#l51.24"></a><span id="l51.24" class="difflineminus">-static bool MimeExternalObject_displayable_inline_p (MimeObjectClass *clazz,</span>
<a href="#l51.25"></a><span id="l51.25" class="difflineminus">-                            MimeHeaders *hdrs);</span>
<a href="#l51.26"></a><span id="l51.26" class="difflineplus">+static int MimeExternalObject_initialize(MimeObject *);</span>
<a href="#l51.27"></a><span id="l51.27" class="difflineplus">+static void MimeExternalObject_finalize(MimeObject *);</span>
<a href="#l51.28"></a><span id="l51.28" class="difflineplus">+static int MimeExternalObject_parse_begin(MimeObject *);</span>
<a href="#l51.29"></a><span id="l51.29" class="difflineplus">+static int MimeExternalObject_parse_buffer(const char *, int32_t, MimeObject *);</span>
<a href="#l51.30"></a><span id="l51.30" class="difflineplus">+static int MimeExternalObject_parse_line(const char *, int32_t, MimeObject *);</span>
<a href="#l51.31"></a><span id="l51.31" class="difflineplus">+static int MimeExternalObject_parse_decoded_buffer(const char *, int32_t,</span>
<a href="#l51.32"></a><span id="l51.32" class="difflineplus">+                                                   MimeObject *);</span>
<a href="#l51.33"></a><span id="l51.33" class="difflineplus">+static bool MimeExternalObject_displayable_inline_p(MimeObjectClass *clazz,</span>
<a href="#l51.34"></a><span id="l51.34" class="difflineplus">+                                                    MimeHeaders *hdrs);</span>
<a href="#l51.35"></a><span id="l51.35"> </span>
<a href="#l51.36"></a><span id="l51.36" class="difflineminus">-static int</span>
<a href="#l51.37"></a><span id="l51.37" class="difflineminus">-MimeExternalObjectClassInitialize(MimeExternalObjectClass *clazz)</span>
<a href="#l51.38"></a><span id="l51.38" class="difflineminus">-{</span>
<a href="#l51.39"></a><span id="l51.39" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l51.40"></a><span id="l51.40" class="difflineminus">-  MimeLeafClass   *lclass = (MimeLeafClass *) clazz;</span>
<a href="#l51.41"></a><span id="l51.41" class="difflineplus">+static int MimeExternalObjectClassInitialize(MimeExternalObjectClass *clazz) {</span>
<a href="#l51.42"></a><span id="l51.42" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l51.43"></a><span id="l51.43" class="difflineplus">+  MimeLeafClass *lclass = (MimeLeafClass *)clazz;</span>
<a href="#l51.44"></a><span id="l51.44"> </span>
<a href="#l51.45"></a><span id="l51.45" class="difflineminus">-  NS_ASSERTION(!oclass-&gt;class_initialized, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l51.46"></a><span id="l51.46" class="difflineminus">-  oclass-&gt;initialize   = MimeExternalObject_initialize;</span>
<a href="#l51.47"></a><span id="l51.47" class="difflineminus">-  oclass-&gt;finalize     = MimeExternalObject_finalize;</span>
<a href="#l51.48"></a><span id="l51.48" class="difflineminus">-  oclass-&gt;parse_begin  = MimeExternalObject_parse_begin;</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineplus">+  NS_ASSERTION(!oclass-&gt;class_initialized,</span>
<a href="#l51.50"></a><span id="l51.50" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l51.51"></a><span id="l51.51" class="difflineplus">+  oclass-&gt;initialize = MimeExternalObject_initialize;</span>
<a href="#l51.52"></a><span id="l51.52" class="difflineplus">+  oclass-&gt;finalize = MimeExternalObject_finalize;</span>
<a href="#l51.53"></a><span id="l51.53" class="difflineplus">+  oclass-&gt;parse_begin = MimeExternalObject_parse_begin;</span>
<a href="#l51.54"></a><span id="l51.54">   oclass-&gt;parse_buffer = MimeExternalObject_parse_buffer;</span>
<a href="#l51.55"></a><span id="l51.55" class="difflineminus">-  oclass-&gt;parse_line   = MimeExternalObject_parse_line;</span>
<a href="#l51.56"></a><span id="l51.56" class="difflineplus">+  oclass-&gt;parse_line = MimeExternalObject_parse_line;</span>
<a href="#l51.57"></a><span id="l51.57">   oclass-&gt;displayable_inline_p = MimeExternalObject_displayable_inline_p;</span>
<a href="#l51.58"></a><span id="l51.58">   lclass-&gt;parse_decoded_buffer = MimeExternalObject_parse_decoded_buffer;</span>
<a href="#l51.59"></a><span id="l51.59">   return 0;</span>
<a href="#l51.60"></a><span id="l51.60"> }</span>
<a href="#l51.61"></a><span id="l51.61"> </span>
<a href="#l51.62"></a><span id="l51.62" class="difflineminus">-</span>
<a href="#l51.63"></a><span id="l51.63" class="difflineminus">-static int</span>
<a href="#l51.64"></a><span id="l51.64" class="difflineminus">-MimeExternalObject_initialize (MimeObject *object)</span>
<a href="#l51.65"></a><span id="l51.65" class="difflineminus">-{</span>
<a href="#l51.66"></a><span id="l51.66" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l51.67"></a><span id="l51.67" class="difflineplus">+static int MimeExternalObject_initialize(MimeObject *object) {</span>
<a href="#l51.68"></a><span id="l51.68" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l51.69"></a><span id="l51.69"> }</span>
<a href="#l51.70"></a><span id="l51.70"> </span>
<a href="#l51.71"></a><span id="l51.71" class="difflineminus">-static void</span>
<a href="#l51.72"></a><span id="l51.72" class="difflineminus">-MimeExternalObject_finalize (MimeObject *object)</span>
<a href="#l51.73"></a><span id="l51.73" class="difflineminus">-{</span>
<a href="#l51.74"></a><span id="l51.74" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l51.75"></a><span id="l51.75" class="difflineplus">+static void MimeExternalObject_finalize(MimeObject *object) {</span>
<a href="#l51.76"></a><span id="l51.76" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l51.77"></a><span id="l51.77"> }</span>
<a href="#l51.78"></a><span id="l51.78"> </span>
<a href="#l51.79"></a><span id="l51.79" class="difflineminus">-</span>
<a href="#l51.80"></a><span id="l51.80" class="difflineminus">-static int</span>
<a href="#l51.81"></a><span id="l51.81" class="difflineminus">-MimeExternalObject_parse_begin (MimeObject *obj)</span>
<a href="#l51.82"></a><span id="l51.82" class="difflineminus">-{</span>
<a href="#l51.83"></a><span id="l51.83" class="difflineplus">+static int MimeExternalObject_parse_begin(MimeObject *obj) {</span>
<a href="#l51.84"></a><span id="l51.84">   int status;</span>
<a href="#l51.85"></a><span id="l51.85"> </span>
<a href="#l51.86"></a><span id="l51.86" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l51.87"></a><span id="l51.87" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l51.88"></a><span id="l51.88">   if (status &lt; 0) return status;</span>
<a href="#l51.89"></a><span id="l51.89"> </span>
<a href="#l51.90"></a><span id="l51.90">   // If we're writing this object, and we're doing it in raw form, then</span>
<a href="#l51.91"></a><span id="l51.91">   // now is the time to inform the backend what the type of this data is.</span>
<a href="#l51.92"></a><span id="l51.92">   //</span>
<a href="#l51.93"></a><span id="l51.93" class="difflineminus">-  if (obj-&gt;output_p &amp;&amp;</span>
<a href="#l51.94"></a><span id="l51.94" class="difflineminus">-    obj-&gt;options &amp;&amp;</span>
<a href="#l51.95"></a><span id="l51.95" class="difflineminus">-    !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l51.96"></a><span id="l51.96" class="difflineminus">-    !obj-&gt;options-&gt;state-&gt;first_data_written_p)</span>
<a href="#l51.97"></a><span id="l51.97" class="difflineminus">-  {</span>
<a href="#l51.98"></a><span id="l51.98" class="difflineplus">+  if (obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l51.99"></a><span id="l51.99" class="difflineplus">+      !obj-&gt;options-&gt;state-&gt;first_data_written_p) {</span>
<a href="#l51.100"></a><span id="l51.100">     status = MimeObject_output_init(obj, 0);</span>
<a href="#l51.101"></a><span id="l51.101">     if (status &lt; 0) return status;</span>
<a href="#l51.102"></a><span id="l51.102" class="difflineminus">-    NS_ASSERTION(obj-&gt;options-&gt;state-&gt;first_data_written_p, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l51.103"></a><span id="l51.103" class="difflineplus">+    NS_ASSERTION(obj-&gt;options-&gt;state-&gt;first_data_written_p,</span>
<a href="#l51.104"></a><span id="l51.104" class="difflineplus">+                 &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l51.105"></a><span id="l51.105">   }</span>
<a href="#l51.106"></a><span id="l51.106"> </span>
<a href="#l51.107"></a><span id="l51.107">   //</span>
<a href="#l51.108"></a><span id="l51.108">   // If we're writing this object as HTML, do all the work now -- just write</span>
<a href="#l51.109"></a><span id="l51.109">   // out a table with a link in it.  (Later calls to the `parse_buffer' method</span>
<a href="#l51.110"></a><span id="l51.110">   // will simply discard the data of the object itself.)</span>
<a href="#l51.111"></a><span id="l51.111">   //</span>
<a href="#l51.112"></a><span id="l51.112" class="difflineminus">-  if (obj-&gt;options &amp;&amp;</span>
<a href="#l51.113"></a><span id="l51.113" class="difflineminus">-      obj-&gt;output_p &amp;&amp;</span>
<a href="#l51.114"></a><span id="l51.114" class="difflineminus">-      obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l51.115"></a><span id="l51.115" class="difflineminus">-      obj-&gt;options-&gt;output_fn)</span>
<a href="#l51.116"></a><span id="l51.116" class="difflineminus">-  {</span>
<a href="#l51.117"></a><span id="l51.117" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;output_p &amp;&amp; obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l51.118"></a><span id="l51.118" class="difflineplus">+      obj-&gt;options-&gt;output_fn) {</span>
<a href="#l51.119"></a><span id="l51.119">     MimeDisplayOptions newopt = *obj-&gt;options;  // copy it</span>
<a href="#l51.120"></a><span id="l51.120">     char *id = 0;</span>
<a href="#l51.121"></a><span id="l51.121">     char *id_url = 0;</span>
<a href="#l51.122"></a><span id="l51.122">     char *id_name = 0;</span>
<a href="#l51.123"></a><span id="l51.123">     nsCString id_imap;</span>
<a href="#l51.124"></a><span id="l51.124">     bool all_headers_p = obj-&gt;options-&gt;headers == MimeHeadersAll;</span>
<a href="#l51.125"></a><span id="l51.125"> </span>
<a href="#l51.126"></a><span id="l51.126" class="difflineminus">-    id = mime_part_address (obj);</span>
<a href="#l51.127"></a><span id="l51.127" class="difflineminus">-    if (obj-&gt;options-&gt;missing_parts)</span>
<a href="#l51.128"></a><span id="l51.128" class="difflineminus">-      id_imap.Adopt(mime_imap_part_address (obj));</span>
<a href="#l51.129"></a><span id="l51.129" class="difflineminus">-    if (! id) return MIME_OUT_OF_MEMORY;</span>
<a href="#l51.130"></a><span id="l51.130" class="difflineplus">+    id = mime_part_address(obj);</span>
<a href="#l51.131"></a><span id="l51.131" class="difflineplus">+    if (obj-&gt;options-&gt;missing_parts) id_imap.Adopt(mime_imap_part_address(obj));</span>
<a href="#l51.132"></a><span id="l51.132" class="difflineplus">+    if (!id) return MIME_OUT_OF_MEMORY;</span>
<a href="#l51.133"></a><span id="l51.133"> </span>
<a href="#l51.134"></a><span id="l51.134" class="difflineminus">-    if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;url)</span>
<a href="#l51.135"></a><span id="l51.135" class="difflineminus">-    {</span>
<a href="#l51.136"></a><span id="l51.136" class="difflineplus">+    if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;url) {</span>
<a href="#l51.137"></a><span id="l51.137">       const char *url = obj-&gt;options-&gt;url;</span>
<a href="#l51.138"></a><span id="l51.138" class="difflineminus">-      if (!id_imap.IsEmpty() &amp;&amp; id)</span>
<a href="#l51.139"></a><span id="l51.139" class="difflineminus">-      {</span>
<a href="#l51.140"></a><span id="l51.140" class="difflineplus">+      if (!id_imap.IsEmpty() &amp;&amp; id) {</span>
<a href="#l51.141"></a><span id="l51.141">         // if this is an IMAP part.</span>
<a href="#l51.142"></a><span id="l51.142">         id_url = mime_set_url_imap_part(url, id_imap.get(), id);</span>
<a href="#l51.143"></a><span id="l51.143" class="difflineminus">-      }</span>
<a href="#l51.144"></a><span id="l51.144" class="difflineminus">-      else</span>
<a href="#l51.145"></a><span id="l51.145" class="difflineminus">-      {</span>
<a href="#l51.146"></a><span id="l51.146" class="difflineplus">+      } else {</span>
<a href="#l51.147"></a><span id="l51.147">         // This is just a normal MIME part as usual.</span>
<a href="#l51.148"></a><span id="l51.148">         id_url = mime_set_url_part(url, id, true);</span>
<a href="#l51.149"></a><span id="l51.149">       }</span>
<a href="#l51.150"></a><span id="l51.150" class="difflineminus">-      if (!id_url)</span>
<a href="#l51.151"></a><span id="l51.151" class="difflineminus">-      {</span>
<a href="#l51.152"></a><span id="l51.152" class="difflineplus">+      if (!id_url) {</span>
<a href="#l51.153"></a><span id="l51.153">         PR_Free(id);</span>
<a href="#l51.154"></a><span id="l51.154">         return MIME_OUT_OF_MEMORY;</span>
<a href="#l51.155"></a><span id="l51.155">       }</span>
<a href="#l51.156"></a><span id="l51.156">     }</span>
<a href="#l51.157"></a><span id="l51.157" class="difflineminus">-    if (!strcmp (id, &quot;0&quot;))</span>
<a href="#l51.158"></a><span id="l51.158" class="difflineminus">-    {</span>
<a href="#l51.159"></a><span id="l51.159" class="difflineplus">+    if (!strcmp(id, &quot;0&quot;)) {</span>
<a href="#l51.160"></a><span id="l51.160">       PR_Free(id);</span>
<a href="#l51.161"></a><span id="l51.161">       id = MimeGetStringByID(MIME_MSG_ATTACHMENT);</span>
<a href="#l51.162"></a><span id="l51.162" class="difflineminus">-    }</span>
<a href="#l51.163"></a><span id="l51.163" class="difflineminus">-    else</span>
<a href="#l51.164"></a><span id="l51.164" class="difflineminus">-    {</span>
<a href="#l51.165"></a><span id="l51.165" class="difflineplus">+    } else {</span>
<a href="#l51.166"></a><span id="l51.166">       const char *p = &quot;Part &quot;;</span>
<a href="#l51.167"></a><span id="l51.167">       uint32_t slen = strlen(p) + strlen(id) + 1;</span>
<a href="#l51.168"></a><span id="l51.168">       char *s = (char *)PR_MALLOC(slen);</span>
<a href="#l51.169"></a><span id="l51.169" class="difflineminus">-      if (!s)</span>
<a href="#l51.170"></a><span id="l51.170" class="difflineminus">-      {</span>
<a href="#l51.171"></a><span id="l51.171" class="difflineplus">+      if (!s) {</span>
<a href="#l51.172"></a><span id="l51.172">         PR_Free(id);</span>
<a href="#l51.173"></a><span id="l51.173">         PR_Free(id_url);</span>
<a href="#l51.174"></a><span id="l51.174">         return MIME_OUT_OF_MEMORY;</span>
<a href="#l51.175"></a><span id="l51.175">       }</span>
<a href="#l51.176"></a><span id="l51.176">       // we have a valid id</span>
<a href="#l51.177"></a><span id="l51.177" class="difflineminus">-      if (id)</span>
<a href="#l51.178"></a><span id="l51.178" class="difflineminus">-        id_name = mime_find_suggested_name_of_part(id, obj);</span>
<a href="#l51.179"></a><span id="l51.179" class="difflineplus">+      if (id) id_name = mime_find_suggested_name_of_part(id, obj);</span>
<a href="#l51.180"></a><span id="l51.180">       PL_strncpyz(s, p, slen);</span>
<a href="#l51.181"></a><span id="l51.181">       PL_strcatn(s, slen, id);</span>
<a href="#l51.182"></a><span id="l51.182">       PR_Free(id);</span>
<a href="#l51.183"></a><span id="l51.183">       id = s;</span>
<a href="#l51.184"></a><span id="l51.184">     }</span>
<a href="#l51.185"></a><span id="l51.185"> </span>
<a href="#l51.186"></a><span id="l51.186">     if (all_headers_p &amp;&amp;</span>
<a href="#l51.187"></a><span id="l51.187" class="difflineminus">-    // Don't bother showing all headers on this part if it's the only</span>
<a href="#l51.188"></a><span id="l51.188" class="difflineminus">-    // part in the message: in that case, we've already shown these</span>
<a href="#l51.189"></a><span id="l51.189" class="difflineminus">-    // headers.</span>
<a href="#l51.190"></a><span id="l51.190" class="difflineminus">-    obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l51.191"></a><span id="l51.191" class="difflineminus">-    obj-&gt;options-&gt;state-&gt;root == obj-&gt;parent)</span>
<a href="#l51.192"></a><span id="l51.192" class="difflineminus">-    all_headers_p = false;</span>
<a href="#l51.193"></a><span id="l51.193" class="difflineplus">+        // Don't bother showing all headers on this part if it's the only</span>
<a href="#l51.194"></a><span id="l51.194" class="difflineplus">+        // part in the message: in that case, we've already shown these</span>
<a href="#l51.195"></a><span id="l51.195" class="difflineplus">+        // headers.</span>
<a href="#l51.196"></a><span id="l51.196" class="difflineplus">+        obj-&gt;options-&gt;state &amp;&amp; obj-&gt;options-&gt;state-&gt;root == obj-&gt;parent)</span>
<a href="#l51.197"></a><span id="l51.197" class="difflineplus">+      all_headers_p = false;</span>
<a href="#l51.198"></a><span id="l51.198"> </span>
<a href="#l51.199"></a><span id="l51.199">     newopt.fancy_headers_p = true;</span>
<a href="#l51.200"></a><span id="l51.200">     newopt.headers = (all_headers_p ? MimeHeadersAll : MimeHeadersSome);</span>
<a href="#l51.201"></a><span id="l51.201"> </span>
<a href="#l51.202"></a><span id="l51.202" class="difflineminus">-/******</span>
<a href="#l51.203"></a><span id="l51.203" class="difflineminus">-RICHIE SHERRY</span>
<a href="#l51.204"></a><span id="l51.204" class="difflineminus">-GOTTA STILL DO THIS FOR QUOTING!</span>
<a href="#l51.205"></a><span id="l51.205" class="difflineminus">-     status = MimeHeaders_write_attachment_box (obj-&gt;headers, &amp;newopt,</span>
<a href="#l51.206"></a><span id="l51.206" class="difflineminus">-                                                 obj-&gt;content_type,</span>
<a href="#l51.207"></a><span id="l51.207" class="difflineminus">-                                                 obj-&gt;encoding,</span>
<a href="#l51.208"></a><span id="l51.208" class="difflineminus">-                                                 id_name? id_name : id, id_url, 0)</span>
<a href="#l51.209"></a><span id="l51.209" class="difflineminus">-*****/</span>
<a href="#l51.210"></a><span id="l51.210" class="difflineplus">+    /******</span>
<a href="#l51.211"></a><span id="l51.211" class="difflineplus">+    RICHIE SHERRY</span>
<a href="#l51.212"></a><span id="l51.212" class="difflineplus">+    GOTTA STILL DO THIS FOR QUOTING!</span>
<a href="#l51.213"></a><span id="l51.213" class="difflineplus">+         status = MimeHeaders_write_attachment_box (obj-&gt;headers, &amp;newopt,</span>
<a href="#l51.214"></a><span id="l51.214" class="difflineplus">+                                                     obj-&gt;content_type,</span>
<a href="#l51.215"></a><span id="l51.215" class="difflineplus">+                                                     obj-&gt;encoding,</span>
<a href="#l51.216"></a><span id="l51.216" class="difflineplus">+                                                     id_name? id_name : id,</span>
<a href="#l51.217"></a><span id="l51.217" class="difflineplus">+    id_url, 0)</span>
<a href="#l51.218"></a><span id="l51.218" class="difflineplus">+    *****/</span>
<a href="#l51.219"></a><span id="l51.219"> </span>
<a href="#l51.220"></a><span id="l51.220">     // obj-&gt;options really owns the storage for this.</span>
<a href="#l51.221"></a><span id="l51.221">     newopt.part_to_load = nullptr;</span>
<a href="#l51.222"></a><span id="l51.222">     newopt.default_charset = nullptr;</span>
<a href="#l51.223"></a><span id="l51.223">     PR_FREEIF(id);</span>
<a href="#l51.224"></a><span id="l51.224">     PR_FREEIF(id_url);</span>
<a href="#l51.225"></a><span id="l51.225">     PR_FREEIF(id_name);</span>
<a href="#l51.226"></a><span id="l51.226">     if (status &lt; 0) return status;</span>
<a href="#l51.227"></a><span id="l51.227">   }</span>
<a href="#l51.228"></a><span id="l51.228"> </span>
<a href="#l51.229"></a><span id="l51.229">   return 0;</span>
<a href="#l51.230"></a><span id="l51.230"> }</span>
<a href="#l51.231"></a><span id="l51.231"> </span>
<a href="#l51.232"></a><span id="l51.232" class="difflineminus">-static int</span>
<a href="#l51.233"></a><span id="l51.233" class="difflineminus">-MimeExternalObject_parse_buffer (const char *buffer, int32_t size, MimeObject *obj)</span>
<a href="#l51.234"></a><span id="l51.234" class="difflineminus">-{</span>
<a href="#l51.235"></a><span id="l51.235" class="difflineplus">+static int MimeExternalObject_parse_buffer(const char *buffer, int32_t size,</span>
<a href="#l51.236"></a><span id="l51.236" class="difflineplus">+                                           MimeObject *obj) {</span>
<a href="#l51.237"></a><span id="l51.237">   NS_ASSERTION(!obj-&gt;closed_p, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l51.238"></a><span id="l51.238">   if (obj-&gt;closed_p) return -1;</span>
<a href="#l51.239"></a><span id="l51.239"> </span>
<a href="#l51.240"></a><span id="l51.240">   // Currently, we always want to stream, in order to determine the size of the</span>
<a href="#l51.241"></a><span id="l51.241">   // MIME object.</span>
<a href="#l51.242"></a><span id="l51.242"> </span>
<a href="#l51.243"></a><span id="l51.243">   /* The data will be base64-decoded and passed to</span>
<a href="#l51.244"></a><span id="l51.244">      MimeExternalObject_parse_decoded_buffer. */</span>
<a href="#l51.245"></a><span id="l51.245" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_buffer(buffer, size, obj);</span>
<a href="#l51.246"></a><span id="l51.246" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_buffer(buffer, size, obj);</span>
<a href="#l51.247"></a><span id="l51.247"> }</span>
<a href="#l51.248"></a><span id="l51.248"> </span>
<a href="#l51.249"></a><span id="l51.249" class="difflineminus">-</span>
<a href="#l51.250"></a><span id="l51.250" class="difflineminus">-static int</span>
<a href="#l51.251"></a><span id="l51.251" class="difflineminus">-MimeExternalObject_parse_decoded_buffer (const char *buf, int32_t size,</span>
<a href="#l51.252"></a><span id="l51.252" class="difflineminus">-                     MimeObject *obj)</span>
<a href="#l51.253"></a><span id="l51.253" class="difflineminus">-{</span>
<a href="#l51.254"></a><span id="l51.254" class="difflineplus">+static int MimeExternalObject_parse_decoded_buffer(const char *buf,</span>
<a href="#l51.255"></a><span id="l51.255" class="difflineplus">+                                                   int32_t size,</span>
<a href="#l51.256"></a><span id="l51.256" class="difflineplus">+                                                   MimeObject *obj) {</span>
<a href="#l51.257"></a><span id="l51.257">   /* This is called (by MimeLeafClass-&gt;parse_buffer) with blocks of data</span>
<a href="#l51.258"></a><span id="l51.258">    that have already been base64-decoded.  This will only be called in</span>
<a href="#l51.259"></a><span id="l51.259">    the case where we're not emitting HTML, and want access to the raw</span>
<a href="#l51.260"></a><span id="l51.260">    data itself.</span>
<a href="#l51.261"></a><span id="l51.261"> </span>
<a href="#l51.262"></a><span id="l51.262">    We override the `parse_decoded_buffer' method provided by MimeLeaf</span>
<a href="#l51.263"></a><span id="l51.263">    because, unlike most children of MimeLeaf, we do not want to line-</span>
<a href="#l51.264"></a><span id="l51.264">    buffer the decoded data -- we want to simply pass it along to the</span>
<a href="#l51.265"></a><span id="l51.265" class="difflineat">@@ -208,29 +180,26 @@ MimeExternalObject_parse_decoded_buffer </span>
<a href="#l51.266"></a><span id="l51.266">    */</span>
<a href="#l51.267"></a><span id="l51.267"> </span>
<a href="#l51.268"></a><span id="l51.268">   /* Don't do a roundtrip through XPConnect when we're only interested in</span>
<a href="#l51.269"></a><span id="l51.269">    * metadata and size. This includes when we are writing HTML (otherwise, the</span>
<a href="#l51.270"></a><span id="l51.270">    * contents of binary attachments will just get dumped into messages when</span>
<a href="#l51.271"></a><span id="l51.271">    * reading them) and the JS emitter (which doesn't care about attachment data</span>
<a href="#l51.272"></a><span id="l51.272">    * at all). 0 means ok, the caller just checks for negative return value.</span>
<a href="#l51.273"></a><span id="l51.273">    */</span>
<a href="#l51.274"></a><span id="l51.274" class="difflineminus">-  if (obj-&gt;options &amp;&amp; (obj-&gt;options-&gt;metadata_only ||</span>
<a href="#l51.275"></a><span id="l51.275" class="difflineminus">-                       obj-&gt;options-&gt;write_html_p))</span>
<a href="#l51.276"></a><span id="l51.276" class="difflineplus">+  if (obj-&gt;options &amp;&amp;</span>
<a href="#l51.277"></a><span id="l51.277" class="difflineplus">+      (obj-&gt;options-&gt;metadata_only || obj-&gt;options-&gt;write_html_p))</span>
<a href="#l51.278"></a><span id="l51.278">     return 0;</span>
<a href="#l51.279"></a><span id="l51.279">   else</span>
<a href="#l51.280"></a><span id="l51.280">     return MimeObject_write(obj, buf, size, true);</span>
<a href="#l51.281"></a><span id="l51.281"> }</span>
<a href="#l51.282"></a><span id="l51.282"> </span>
<a href="#l51.283"></a><span id="l51.283" class="difflineminus">-</span>
<a href="#l51.284"></a><span id="l51.284" class="difflineminus">-static int</span>
<a href="#l51.285"></a><span id="l51.285" class="difflineminus">-MimeExternalObject_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l51.286"></a><span id="l51.286" class="difflineminus">-{</span>
<a href="#l51.287"></a><span id="l51.287" class="difflineminus">-  NS_ERROR(&quot;This method should never be called (externals do no line buffering).&quot;);</span>
<a href="#l51.288"></a><span id="l51.288" class="difflineplus">+static int MimeExternalObject_parse_line(const char *line, int32_t length,</span>
<a href="#l51.289"></a><span id="l51.289" class="difflineplus">+                                         MimeObject *obj) {</span>
<a href="#l51.290"></a><span id="l51.290" class="difflineplus">+  NS_ERROR(</span>
<a href="#l51.291"></a><span id="l51.291" class="difflineplus">+      &quot;This method should never be called (externals do no line buffering).&quot;);</span>
<a href="#l51.292"></a><span id="l51.292">   return -1;</span>
<a href="#l51.293"></a><span id="l51.293"> }</span>
<a href="#l51.294"></a><span id="l51.294"> </span>
<a href="#l51.295"></a><span id="l51.295" class="difflineminus">-static bool</span>
<a href="#l51.296"></a><span id="l51.296" class="difflineminus">-MimeExternalObject_displayable_inline_p (MimeObjectClass *clazz,</span>
<a href="#l51.297"></a><span id="l51.297" class="difflineminus">-                     MimeHeaders *hdrs)</span>
<a href="#l51.298"></a><span id="l51.298" class="difflineminus">-{</span>
<a href="#l51.299"></a><span id="l51.299" class="difflineplus">+static bool MimeExternalObject_displayable_inline_p(MimeObjectClass *clazz,</span>
<a href="#l51.300"></a><span id="l51.300" class="difflineplus">+                                                    MimeHeaders *hdrs) {</span>
<a href="#l51.301"></a><span id="l51.301">   return false;</span>
<a href="#l51.302"></a><span id="l51.302"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/mime/src/mimeeobj.h</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/mime/src/mimeeobj.h</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -11,24 +11,24 @@</span>
<a href="#l52.4"></a><span id="l52.4"> /* The MimeExternalObject class represents MIME parts which contain data</span>
<a href="#l52.5"></a><span id="l52.5">    which cannot be displayed inline -- application/octet-stream and any</span>
<a href="#l52.6"></a><span id="l52.6">    other type that is not otherwise specially handled.  (This is not to</span>
<a href="#l52.7"></a><span id="l52.7">    be confused with MimeExternalBody, which is the handler for the</span>
<a href="#l52.8"></a><span id="l52.8">    message/external-object MIME type only.)</span>
<a href="#l52.9"></a><span id="l52.9">  */</span>
<a href="#l52.10"></a><span id="l52.10"> </span>
<a href="#l52.11"></a><span id="l52.11"> typedef struct MimeExternalObjectClass MimeExternalObjectClass;</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-typedef struct MimeExternalObject      MimeExternalObject;</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+typedef struct MimeExternalObject MimeExternalObject;</span>
<a href="#l52.14"></a><span id="l52.14"> </span>
<a href="#l52.15"></a><span id="l52.15"> struct MimeExternalObjectClass {</span>
<a href="#l52.16"></a><span id="l52.16">   MimeLeafClass leaf;</span>
<a href="#l52.17"></a><span id="l52.17"> };</span>
<a href="#l52.18"></a><span id="l52.18"> </span>
<a href="#l52.19"></a><span id="l52.19"> extern &quot;C&quot; MimeExternalObjectClass mimeExternalObjectClass;</span>
<a href="#l52.20"></a><span id="l52.20"> </span>
<a href="#l52.21"></a><span id="l52.21"> struct MimeExternalObject {</span>
<a href="#l52.22"></a><span id="l52.22">   MimeLeaf leaf;</span>
<a href="#l52.23"></a><span id="l52.23"> };</span>
<a href="#l52.24"></a><span id="l52.24"> </span>
<a href="#l52.25"></a><span id="l52.25" class="difflineminus">-#define MimeExternalObjectClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineminus">-  { MimeLeafClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l52.27"></a><span id="l52.27" class="difflineplus">+#define MimeExternalObjectClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineplus">+  { MimeLeafClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l52.29"></a><span id="l52.29"> </span>
<a href="#l52.30"></a><span id="l52.30"> #endif /* _MIMEEOBJ_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/mime/src/mimefilt.cpp</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/mime/src/mimefilt.cpp</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -50,350 +50,300 @@ ERROR!  This is a unix-only file for the</span>
<a href="#l53.4"></a><span id="l53.4">     This does not go into libmime.a.</span>
<a href="#l53.5"></a><span id="l53.5"> #endif</span>
<a href="#l53.6"></a><span id="l53.6"> </span>
<a href="#l53.7"></a><span id="l53.7"> </span>
<a href="#l53.8"></a><span id="l53.8"> static char *</span>
<a href="#l53.9"></a><span id="l53.9"> test_file_type (const char *filename, void *stream_closure)</span>
<a href="#l53.10"></a><span id="l53.10"> {</span>
<a href="#l53.11"></a><span id="l53.11">   const char *suf = PL_strrchr(filename, '.');</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-  if (!suf)</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineminus">-  return 0;</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineplus">+  if (!suf) return 0;</span>
<a href="#l53.15"></a><span id="l53.15">   suf++;</span>
<a href="#l53.16"></a><span id="l53.16"> </span>
<a href="#l53.17"></a><span id="l53.17" class="difflineminus">-  if (!PL_strcasecmp(suf, &quot;txt&quot;) ||</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineminus">-    !PL_strcasecmp(suf, &quot;text&quot;))</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineminus">-  return strdup(&quot;text/plain&quot;);</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineminus">-  else if (!PL_strcasecmp(suf, &quot;htm&quot;) ||</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineminus">-       !PL_strcasecmp(suf, &quot;html&quot;))</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineminus">-  return strdup(&quot;text/html&quot;);</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+  if (!PL_strcasecmp(suf, &quot;txt&quot;) || !PL_strcasecmp(suf, &quot;text&quot;))</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineplus">+    return strdup(&quot;text/plain&quot;);</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineplus">+  else if (!PL_strcasecmp(suf, &quot;htm&quot;) || !PL_strcasecmp(suf, &quot;html&quot;))</span>
<a href="#l53.26"></a><span id="l53.26" class="difflineplus">+    return strdup(&quot;text/html&quot;);</span>
<a href="#l53.27"></a><span id="l53.27">   else if (!PL_strcasecmp(suf, &quot;gif&quot;))</span>
<a href="#l53.28"></a><span id="l53.28" class="difflineminus">-  return strdup(&quot;image/gif&quot;);</span>
<a href="#l53.29"></a><span id="l53.29" class="difflineplus">+    return strdup(&quot;image/gif&quot;);</span>
<a href="#l53.30"></a><span id="l53.30">   else if (!PL_strcasecmp(suf, &quot;svg&quot;))</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineminus">-  return strdup(&quot;image/svg+xml&quot;);</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineminus">-  else if (!PL_strcasecmp(suf, &quot;jpg&quot;) ||</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineminus">-       !PL_strcasecmp(suf, &quot;jpeg&quot;))</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineminus">-  return strdup(&quot;image/jpeg&quot;);</span>
<a href="#l53.35"></a><span id="l53.35" class="difflineminus">-  else if (!PL_strcasecmp(suf, &quot;pjpg&quot;) ||</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineminus">-       !PL_strcasecmp(suf, &quot;pjpeg&quot;))</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineminus">-  return strdup(&quot;image/pjpeg&quot;);</span>
<a href="#l53.38"></a><span id="l53.38" class="difflineplus">+    return strdup(&quot;image/svg+xml&quot;);</span>
<a href="#l53.39"></a><span id="l53.39" class="difflineplus">+  else if (!PL_strcasecmp(suf, &quot;jpg&quot;) || !PL_strcasecmp(suf, &quot;jpeg&quot;))</span>
<a href="#l53.40"></a><span id="l53.40" class="difflineplus">+    return strdup(&quot;image/jpeg&quot;);</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineplus">+  else if (!PL_strcasecmp(suf, &quot;pjpg&quot;) || !PL_strcasecmp(suf, &quot;pjpeg&quot;))</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineplus">+    return strdup(&quot;image/pjpeg&quot;);</span>
<a href="#l53.43"></a><span id="l53.43">   else if (!PL_strcasecmp(suf, &quot;xbm&quot;))</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineminus">-  return strdup(&quot;image/x-xbitmap&quot;);</span>
<a href="#l53.45"></a><span id="l53.45" class="difflineplus">+    return strdup(&quot;image/x-xbitmap&quot;);</span>
<a href="#l53.46"></a><span id="l53.46">   else if (!PL_strcasecmp(suf, &quot;xpm&quot;))</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineminus">-  return strdup(&quot;image/x-xpixmap&quot;);</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineplus">+    return strdup(&quot;image/x-xpixmap&quot;);</span>
<a href="#l53.49"></a><span id="l53.49">   else if (!PL_strcasecmp(suf, &quot;xwd&quot;))</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineminus">-  return strdup(&quot;image/x-xwindowdump&quot;);</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineplus">+    return strdup(&quot;image/x-xwindowdump&quot;);</span>
<a href="#l53.52"></a><span id="l53.52">   else if (!PL_strcasecmp(suf, &quot;bmp&quot;))</span>
<a href="#l53.53"></a><span id="l53.53" class="difflineminus">-  return strdup(&quot;image/x-MS-bmp&quot;);</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineplus">+    return strdup(&quot;image/x-MS-bmp&quot;);</span>
<a href="#l53.55"></a><span id="l53.55">   else if (!PL_strcasecmp(suf, &quot;au&quot;))</span>
<a href="#l53.56"></a><span id="l53.56" class="difflineminus">-  return strdup(&quot;audio/basic&quot;);</span>
<a href="#l53.57"></a><span id="l53.57" class="difflineminus">-  else if (!PL_strcasecmp(suf, &quot;aif&quot;) ||</span>
<a href="#l53.58"></a><span id="l53.58" class="difflineminus">-       !PL_strcasecmp(suf, &quot;aiff&quot;) ||</span>
<a href="#l53.59"></a><span id="l53.59" class="difflineminus">-       !PL_strcasecmp(suf, &quot;aifc&quot;))</span>
<a href="#l53.60"></a><span id="l53.60" class="difflineminus">-  return strdup(&quot;audio/x-aiff&quot;);</span>
<a href="#l53.61"></a><span id="l53.61" class="difflineplus">+    return strdup(&quot;audio/basic&quot;);</span>
<a href="#l53.62"></a><span id="l53.62" class="difflineplus">+  else if (!PL_strcasecmp(suf, &quot;aif&quot;) || !PL_strcasecmp(suf, &quot;aiff&quot;) ||</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineplus">+           !PL_strcasecmp(suf, &quot;aifc&quot;))</span>
<a href="#l53.64"></a><span id="l53.64" class="difflineplus">+    return strdup(&quot;audio/x-aiff&quot;);</span>
<a href="#l53.65"></a><span id="l53.65">   else if (!PL_strcasecmp(suf, &quot;ps&quot;))</span>
<a href="#l53.66"></a><span id="l53.66" class="difflineminus">-  return strdup(&quot;application/postscript&quot;);</span>
<a href="#l53.67"></a><span id="l53.67" class="difflineplus">+    return strdup(&quot;application/postscript&quot;);</span>
<a href="#l53.68"></a><span id="l53.68">   else</span>
<a href="#l53.69"></a><span id="l53.69" class="difflineminus">-  return 0;</span>
<a href="#l53.70"></a><span id="l53.70" class="difflineplus">+    return 0;</span>
<a href="#l53.71"></a><span id="l53.71"> }</span>
<a href="#l53.72"></a><span id="l53.72"> </span>
<a href="#l53.73"></a><span id="l53.73" class="difflineminus">-static int</span>
<a href="#l53.74"></a><span id="l53.74" class="difflineminus">-test_output_fn(char *buf, int32_t size, void *closure)</span>
<a href="#l53.75"></a><span id="l53.75" class="difflineminus">-{</span>
<a href="#l53.76"></a><span id="l53.76" class="difflineminus">-  FILE *out = (FILE *) closure;</span>
<a href="#l53.77"></a><span id="l53.77" class="difflineplus">+static int test_output_fn(char *buf, int32_t size, void *closure) {</span>
<a href="#l53.78"></a><span id="l53.78" class="difflineplus">+  FILE *out = (FILE *)closure;</span>
<a href="#l53.79"></a><span id="l53.79">   if (out)</span>
<a href="#l53.80"></a><span id="l53.80" class="difflineminus">-  return fwrite(buf, sizeof(*buf), size, out);</span>
<a href="#l53.81"></a><span id="l53.81" class="difflineplus">+    return fwrite(buf, sizeof(*buf), size, out);</span>
<a href="#l53.82"></a><span id="l53.82">   else</span>
<a href="#l53.83"></a><span id="l53.83" class="difflineminus">-  return 0;</span>
<a href="#l53.84"></a><span id="l53.84" class="difflineplus">+    return 0;</span>
<a href="#l53.85"></a><span id="l53.85"> }</span>
<a href="#l53.86"></a><span id="l53.86"> </span>
<a href="#l53.87"></a><span id="l53.87" class="difflineminus">-static int</span>
<a href="#l53.88"></a><span id="l53.88" class="difflineminus">-test_output_init_fn (const char *type,</span>
<a href="#l53.89"></a><span id="l53.89" class="difflineminus">-           const char *charset,</span>
<a href="#l53.90"></a><span id="l53.90" class="difflineminus">-           const char *name,</span>
<a href="#l53.91"></a><span id="l53.91" class="difflineminus">-           const char *x_mac_type,</span>
<a href="#l53.92"></a><span id="l53.92" class="difflineminus">-           const char *x_mac_creator,</span>
<a href="#l53.93"></a><span id="l53.93" class="difflineminus">-           void *stream_closure)</span>
<a href="#l53.94"></a><span id="l53.94" class="difflineminus">-{</span>
<a href="#l53.95"></a><span id="l53.95" class="difflineminus">-  FILE *out = (FILE *) stream_closure;</span>
<a href="#l53.96"></a><span id="l53.96" class="difflineplus">+static int test_output_init_fn(const char *type, const char *charset,</span>
<a href="#l53.97"></a><span id="l53.97" class="difflineplus">+                               const char *name, const char *x_mac_type,</span>
<a href="#l53.98"></a><span id="l53.98" class="difflineplus">+                               const char *x_mac_creator,</span>
<a href="#l53.99"></a><span id="l53.99" class="difflineplus">+                               void *stream_closure) {</span>
<a href="#l53.100"></a><span id="l53.100" class="difflineplus">+  FILE *out = (FILE *)stream_closure;</span>
<a href="#l53.101"></a><span id="l53.101">   fprintf(out, &quot;CONTENT-TYPE: %s&quot;, type);</span>
<a href="#l53.102"></a><span id="l53.102" class="difflineminus">-  if (charset)</span>
<a href="#l53.103"></a><span id="l53.103" class="difflineminus">-  fprintf(out, &quot;; charset=\&quot;%s\&quot;&quot;, charset);</span>
<a href="#l53.104"></a><span id="l53.104" class="difflineminus">-  if (name)</span>
<a href="#l53.105"></a><span id="l53.105" class="difflineminus">-  fprintf(out, &quot;; name=\&quot;%s\&quot;&quot;, name);</span>
<a href="#l53.106"></a><span id="l53.106" class="difflineplus">+  if (charset) fprintf(out, &quot;; charset=\&quot;%s\&quot;&quot;, charset);</span>
<a href="#l53.107"></a><span id="l53.107" class="difflineplus">+  if (name) fprintf(out, &quot;; name=\&quot;%s\&quot;&quot;, name);</span>
<a href="#l53.108"></a><span id="l53.108">   if (x_mac_type || x_mac_creator)</span>
<a href="#l53.109"></a><span id="l53.109" class="difflineminus">-  fprintf(out, &quot;; x-mac-type=\&quot;%s\&quot;; x-mac-creator=\&quot;%s\&quot;&quot;,</span>
<a href="#l53.110"></a><span id="l53.110" class="difflineminus">-      x_mac_type ? x_mac_type : &quot;&quot;,</span>
<a href="#l53.111"></a><span id="l53.111" class="difflineminus">-      x_mac_creator ? x_mac_type : &quot;&quot;);</span>
<a href="#l53.112"></a><span id="l53.112" class="difflineplus">+    fprintf(out, &quot;; x-mac-type=\&quot;%s\&quot;; x-mac-creator=\&quot;%s\&quot;&quot;,</span>
<a href="#l53.113"></a><span id="l53.113" class="difflineplus">+            x_mac_type ? x_mac_type : &quot;&quot;, x_mac_creator ? x_mac_type : &quot;&quot;);</span>
<a href="#l53.114"></a><span id="l53.114">   fprintf(out, CRLF CRLF);</span>
<a href="#l53.115"></a><span id="l53.115">   return 0;</span>
<a href="#l53.116"></a><span id="l53.116"> }</span>
<a href="#l53.117"></a><span id="l53.117"> </span>
<a href="#l53.118"></a><span id="l53.118" class="difflineminus">-static void *</span>
<a href="#l53.119"></a><span id="l53.119" class="difflineminus">-test_image_begin(const char *image_url, const char *content_type,</span>
<a href="#l53.120"></a><span id="l53.120" class="difflineminus">-         void *stream_closure)</span>
<a href="#l53.121"></a><span id="l53.121" class="difflineminus">-{</span>
<a href="#l53.122"></a><span id="l53.122" class="difflineminus">-  return ((void *) strdup(image_url));</span>
<a href="#l53.123"></a><span id="l53.123" class="difflineplus">+static void *test_image_begin(const char *image_url, const char *content_type,</span>
<a href="#l53.124"></a><span id="l53.124" class="difflineplus">+                              void *stream_closure) {</span>
<a href="#l53.125"></a><span id="l53.125" class="difflineplus">+  return ((void *)strdup(image_url));</span>
<a href="#l53.126"></a><span id="l53.126"> }</span>
<a href="#l53.127"></a><span id="l53.127"> </span>
<a href="#l53.128"></a><span id="l53.128" class="difflineminus">-static void</span>
<a href="#l53.129"></a><span id="l53.129" class="difflineminus">-test_image_end(void *image_closure, int status)</span>
<a href="#l53.130"></a><span id="l53.130" class="difflineminus">-{</span>
<a href="#l53.131"></a><span id="l53.131" class="difflineminus">-  char *url = (char *) image_closure;</span>
<a href="#l53.132"></a><span id="l53.132" class="difflineplus">+static void test_image_end(void *image_closure, int status) {</span>
<a href="#l53.133"></a><span id="l53.133" class="difflineplus">+  char *url = (char *)image_closure;</span>
<a href="#l53.134"></a><span id="l53.134">   if (url) PR_Free(url);</span>
<a href="#l53.135"></a><span id="l53.135"> }</span>
<a href="#l53.136"></a><span id="l53.136"> </span>
<a href="#l53.137"></a><span id="l53.137" class="difflineminus">-static char *</span>
<a href="#l53.138"></a><span id="l53.138" class="difflineminus">-test_image_make_image_html(void *image_data)</span>
<a href="#l53.139"></a><span id="l53.139" class="difflineminus">-{</span>
<a href="#l53.140"></a><span id="l53.140" class="difflineminus">-  char *url = (char *) image_data;</span>
<a href="#l53.141"></a><span id="l53.141" class="difflineplus">+static char *test_image_make_image_html(void *image_data) {</span>
<a href="#l53.142"></a><span id="l53.142" class="difflineplus">+  char *url = (char *)image_data;</span>
<a href="#l53.143"></a><span id="l53.143"> #if 0</span>
<a href="#l53.144"></a><span id="l53.144">   const char *prefix = &quot;&lt;P&gt;&lt;CENTER&gt;&lt;IMG SRC=\&quot;&quot;;</span>
<a href="#l53.145"></a><span id="l53.145">   const char *suffix = &quot;\&quot;&gt;&lt;/CENTER&gt;&lt;P&gt;&quot;;</span>
<a href="#l53.146"></a><span id="l53.146"> #else</span>
<a href="#l53.147"></a><span id="l53.147" class="difflineminus">-  const char *prefix = (&quot;&lt;P&gt;&lt;CENTER&gt;&lt;TABLE BORDER=2 CELLPADDING=20&quot;</span>
<a href="#l53.148"></a><span id="l53.148" class="difflineminus">-            &quot; BGCOLOR=WHITE&gt;&quot;</span>
<a href="#l53.149"></a><span id="l53.149" class="difflineminus">-            &quot;&lt;TR&gt;&lt;TD ALIGN=CENTER&gt;&quot;</span>
<a href="#l53.150"></a><span id="l53.150" class="difflineminus">-            &quot;an inlined image would have gone here for&lt;BR&gt;&quot;);</span>
<a href="#l53.151"></a><span id="l53.151" class="difflineplus">+  const char *prefix =</span>
<a href="#l53.152"></a><span id="l53.152" class="difflineplus">+      (&quot;&lt;P&gt;&lt;CENTER&gt;&lt;TABLE BORDER=2 CELLPADDING=20&quot;</span>
<a href="#l53.153"></a><span id="l53.153" class="difflineplus">+       &quot; BGCOLOR=WHITE&gt;&quot;</span>
<a href="#l53.154"></a><span id="l53.154" class="difflineplus">+       &quot;&lt;TR&gt;&lt;TD ALIGN=CENTER&gt;&quot;</span>
<a href="#l53.155"></a><span id="l53.155" class="difflineplus">+       &quot;an inlined image would have gone here for&lt;BR&gt;&quot;);</span>
<a href="#l53.156"></a><span id="l53.156">   const char *suffix = &quot;&lt;/TD&gt;&lt;/TR&gt;&lt;/TABLE&gt;&lt;/CENTER&gt;&lt;P&gt;&quot;;</span>
<a href="#l53.157"></a><span id="l53.157"> #endif</span>
<a href="#l53.158"></a><span id="l53.158" class="difflineminus">-  uint32_t buflen = strlen (prefix) + strlen (suffix) + strlen (url) + 20;</span>
<a href="#l53.159"></a><span id="l53.159" class="difflineminus">-  char *buf = (char *) PR_MALLOC (buflen);</span>
<a href="#l53.160"></a><span id="l53.160" class="difflineplus">+  uint32_t buflen = strlen(prefix) + strlen(suffix) + strlen(url) + 20;</span>
<a href="#l53.161"></a><span id="l53.161" class="difflineplus">+  char *buf = (char *)PR_MALLOC(buflen);</span>
<a href="#l53.162"></a><span id="l53.162">   if (!buf) return 0;</span>
<a href="#l53.163"></a><span id="l53.163">   *buf = 0;</span>
<a href="#l53.164"></a><span id="l53.164" class="difflineminus">-  PL_strcatn (buf, buflen, prefix);</span>
<a href="#l53.165"></a><span id="l53.165" class="difflineminus">-  PL_strcatn (buf, buflen, url);</span>
<a href="#l53.166"></a><span id="l53.166" class="difflineminus">-  PL_strcatn (buf, buflen, suffix);</span>
<a href="#l53.167"></a><span id="l53.167" class="difflineplus">+  PL_strcatn(buf, buflen, prefix);</span>
<a href="#l53.168"></a><span id="l53.168" class="difflineplus">+  PL_strcatn(buf, buflen, url);</span>
<a href="#l53.169"></a><span id="l53.169" class="difflineplus">+  PL_strcatn(buf, buflen, suffix);</span>
<a href="#l53.170"></a><span id="l53.170">   return buf;</span>
<a href="#l53.171"></a><span id="l53.171"> }</span>
<a href="#l53.172"></a><span id="l53.172"> </span>
<a href="#l53.173"></a><span id="l53.173" class="difflineminus">-static int test_image_write_buffer(const char *buf, int32_t size, void *image_closure)</span>
<a href="#l53.174"></a><span id="l53.174" class="difflineminus">-{</span>
<a href="#l53.175"></a><span id="l53.175" class="difflineplus">+static int test_image_write_buffer(const char *buf, int32_t size,</span>
<a href="#l53.176"></a><span id="l53.176" class="difflineplus">+                                   void *image_closure) {</span>
<a href="#l53.177"></a><span id="l53.177">   return 0;</span>
<a href="#l53.178"></a><span id="l53.178"> }</span>
<a href="#l53.179"></a><span id="l53.179"> </span>
<a href="#l53.180"></a><span id="l53.180" class="difflineminus">-static char *</span>
<a href="#l53.181"></a><span id="l53.181" class="difflineminus">-test_passwd_prompt (PK11SlotInfo *slot, void *wincx)</span>
<a href="#l53.182"></a><span id="l53.182" class="difflineminus">-{</span>
<a href="#l53.183"></a><span id="l53.183" class="difflineplus">+static char *test_passwd_prompt(PK11SlotInfo *slot, void *wincx) {</span>
<a href="#l53.184"></a><span id="l53.184">   char buf[2048], *s;</span>
<a href="#l53.185"></a><span id="l53.185">   fprintf(stdout, &quot;#### Password required: &quot;);</span>
<a href="#l53.186"></a><span id="l53.186" class="difflineminus">-  s = fgets(buf, sizeof(buf)-1, stdin);</span>
<a href="#l53.187"></a><span id="l53.187" class="difflineplus">+  s = fgets(buf, sizeof(buf) - 1, stdin);</span>
<a href="#l53.188"></a><span id="l53.188">   if (!s) return s;</span>
<a href="#l53.189"></a><span id="l53.189" class="difflineminus">-  if (s[strlen(s)-1] == '\r' ||</span>
<a href="#l53.190"></a><span id="l53.190" class="difflineminus">-    s[strlen(s)-1] == '\n')</span>
<a href="#l53.191"></a><span id="l53.191" class="difflineminus">-  s[strlen(s)-1] = '\0';</span>
<a href="#l53.192"></a><span id="l53.192" class="difflineplus">+  if (s[strlen(s) - 1] == '\r' || s[strlen(s) - 1] == '\n')</span>
<a href="#l53.193"></a><span id="l53.193" class="difflineplus">+    s[strlen(s) - 1] = '\0';</span>
<a href="#l53.194"></a><span id="l53.194">   return s;</span>
<a href="#l53.195"></a><span id="l53.195"> }</span>
<a href="#l53.196"></a><span id="l53.196"> </span>
<a href="#l53.197"></a><span id="l53.197" class="difflineminus">-</span>
<a href="#l53.198"></a><span id="l53.198" class="difflineminus">-int</span>
<a href="#l53.199"></a><span id="l53.199" class="difflineminus">-test(FILE *in, FILE *out,</span>
<a href="#l53.200"></a><span id="l53.200" class="difflineminus">-   const char *url,</span>
<a href="#l53.201"></a><span id="l53.201" class="difflineminus">-   bool fancy_headers_p,</span>
<a href="#l53.202"></a><span id="l53.202" class="difflineminus">-   bool html_p,</span>
<a href="#l53.203"></a><span id="l53.203" class="difflineminus">-   bool outline_p,</span>
<a href="#l53.204"></a><span id="l53.204" class="difflineminus">-   bool dexlate_p,</span>
<a href="#l53.205"></a><span id="l53.205" class="difflineminus">-   bool variable_width_plaintext_p)</span>
<a href="#l53.206"></a><span id="l53.206" class="difflineminus">-{</span>
<a href="#l53.207"></a><span id="l53.207" class="difflineplus">+int test(FILE *in, FILE *out, const char *url, bool fancy_headers_p,</span>
<a href="#l53.208"></a><span id="l53.208" class="difflineplus">+         bool html_p, bool outline_p, bool dexlate_p,</span>
<a href="#l53.209"></a><span id="l53.209" class="difflineplus">+         bool variable_width_plaintext_p) {</span>
<a href="#l53.210"></a><span id="l53.210">   int status = 0;</span>
<a href="#l53.211"></a><span id="l53.211">   MimeObject *obj = 0;</span>
<a href="#l53.212"></a><span id="l53.212">   MimeDisplayOptions *opt = new MimeDisplayOptions;</span>
<a href="#l53.213"></a><span id="l53.213" class="difflineminus">-//  memset(opt, 0, sizeof(*opt));</span>
<a href="#l53.214"></a><span id="l53.214" class="difflineplus">+  //  memset(opt, 0, sizeof(*opt));</span>
<a href="#l53.215"></a><span id="l53.215"> </span>
<a href="#l53.216"></a><span id="l53.216">   if (dexlate_p) html_p = false;</span>
<a href="#l53.217"></a><span id="l53.217"> </span>
<a href="#l53.218"></a><span id="l53.218">   opt-&gt;fancy_headers_p = fancy_headers_p;</span>
<a href="#l53.219"></a><span id="l53.219">   opt-&gt;headers = MimeHeadersSome;</span>
<a href="#l53.220"></a><span id="l53.220">   opt-&gt;rot13_p = false;</span>
<a href="#l53.221"></a><span id="l53.221"> </span>
<a href="#l53.222"></a><span id="l53.222">   status = mime_parse_url_options(url, opt);</span>
<a href="#l53.223"></a><span id="l53.223" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l53.224"></a><span id="l53.224" class="difflineminus">-  {</span>
<a href="#l53.225"></a><span id="l53.225" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l53.226"></a><span id="l53.226">     PR_Free(opt);</span>
<a href="#l53.227"></a><span id="l53.227">     return MIME_OUT_OF_MEMORY;</span>
<a href="#l53.228"></a><span id="l53.228">   }</span>
<a href="#l53.229"></a><span id="l53.229"> </span>
<a href="#l53.230"></a><span id="l53.230" class="difflineminus">-  opt-&gt;url          = url;</span>
<a href="#l53.231"></a><span id="l53.231" class="difflineminus">-  opt-&gt;write_html_p      = html_p;</span>
<a href="#l53.232"></a><span id="l53.232" class="difflineminus">-  opt-&gt;dexlate_p      = dexlate_p;</span>
<a href="#l53.233"></a><span id="l53.233" class="difflineminus">-  opt-&gt;output_init_fn    = test_output_init_fn;</span>
<a href="#l53.234"></a><span id="l53.234" class="difflineminus">-  opt-&gt;output_fn      = test_output_fn;</span>
<a href="#l53.235"></a><span id="l53.235" class="difflineminus">-  opt-&gt;charset_conversion_fn= 0;</span>
<a href="#l53.236"></a><span id="l53.236" class="difflineplus">+  opt-&gt;url = url;</span>
<a href="#l53.237"></a><span id="l53.237" class="difflineplus">+  opt-&gt;write_html_p = html_p;</span>
<a href="#l53.238"></a><span id="l53.238" class="difflineplus">+  opt-&gt;dexlate_p = dexlate_p;</span>
<a href="#l53.239"></a><span id="l53.239" class="difflineplus">+  opt-&gt;output_init_fn = test_output_init_fn;</span>
<a href="#l53.240"></a><span id="l53.240" class="difflineplus">+  opt-&gt;output_fn = test_output_fn;</span>
<a href="#l53.241"></a><span id="l53.241" class="difflineplus">+  opt-&gt;charset_conversion_fn = 0;</span>
<a href="#l53.242"></a><span id="l53.242">   opt-&gt;rfc1522_conversion_p = false;</span>
<a href="#l53.243"></a><span id="l53.243" class="difflineminus">-  opt-&gt;file_type_fn      = test_file_type;</span>
<a href="#l53.244"></a><span id="l53.244" class="difflineminus">-  opt-&gt;stream_closure    = out;</span>
<a href="#l53.245"></a><span id="l53.245" class="difflineplus">+  opt-&gt;file_type_fn = test_file_type;</span>
<a href="#l53.246"></a><span id="l53.246" class="difflineplus">+  opt-&gt;stream_closure = out;</span>
<a href="#l53.247"></a><span id="l53.247"> </span>
<a href="#l53.248"></a><span id="l53.248" class="difflineminus">-  opt-&gt;image_begin      = test_image_begin;</span>
<a href="#l53.249"></a><span id="l53.249" class="difflineminus">-  opt-&gt;image_end      = test_image_end;</span>
<a href="#l53.250"></a><span id="l53.250" class="difflineminus">-  opt-&gt;make_image_html    = test_image_make_image_html;</span>
<a href="#l53.251"></a><span id="l53.251" class="difflineminus">-  opt-&gt;image_write_buffer  = test_image_write_buffer;</span>
<a href="#l53.252"></a><span id="l53.252" class="difflineplus">+  opt-&gt;image_begin = test_image_begin;</span>
<a href="#l53.253"></a><span id="l53.253" class="difflineplus">+  opt-&gt;image_end = test_image_end;</span>
<a href="#l53.254"></a><span id="l53.254" class="difflineplus">+  opt-&gt;make_image_html = test_image_make_image_html;</span>
<a href="#l53.255"></a><span id="l53.255" class="difflineplus">+  opt-&gt;image_write_buffer = test_image_write_buffer;</span>
<a href="#l53.256"></a><span id="l53.256"> </span>
<a href="#l53.257"></a><span id="l53.257">   opt-&gt;variable_width_plaintext_p = variable_width_plaintext_p;</span>
<a href="#l53.258"></a><span id="l53.258"> </span>
<a href="#l53.259"></a><span id="l53.259" class="difflineminus">-  obj = mime_new ((MimeObjectClass *)&amp;mimeMessageClass,</span>
<a href="#l53.260"></a><span id="l53.260" class="difflineminus">-          (MimeHeaders *) NULL,</span>
<a href="#l53.261"></a><span id="l53.261" class="difflineminus">-          MESSAGE_RFC822);</span>
<a href="#l53.262"></a><span id="l53.262" class="difflineminus">-  if (!obj)</span>
<a href="#l53.263"></a><span id="l53.263" class="difflineminus">-  {</span>
<a href="#l53.264"></a><span id="l53.264" class="difflineplus">+  obj = mime_new((MimeObjectClass *)&amp;mimeMessageClass, (MimeHeaders *)NULL,</span>
<a href="#l53.265"></a><span id="l53.265" class="difflineplus">+                 MESSAGE_RFC822);</span>
<a href="#l53.266"></a><span id="l53.266" class="difflineplus">+  if (!obj) {</span>
<a href="#l53.267"></a><span id="l53.267">     PR_Free(opt);</span>
<a href="#l53.268"></a><span id="l53.268">     return MIME_OUT_OF_MEMORY;</span>
<a href="#l53.269"></a><span id="l53.269">   }</span>
<a href="#l53.270"></a><span id="l53.270">   obj-&gt;options = opt;</span>
<a href="#l53.271"></a><span id="l53.271"> </span>
<a href="#l53.272"></a><span id="l53.272">   status = obj-&gt;class-&gt;initialize(obj);</span>
<a href="#l53.273"></a><span id="l53.273" class="difflineminus">-  if (status &gt;= 0)</span>
<a href="#l53.274"></a><span id="l53.274" class="difflineminus">-  status = obj-&gt;class-&gt;parse_begin(obj);</span>
<a href="#l53.275"></a><span id="l53.275" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l53.276"></a><span id="l53.276" class="difflineminus">-  {</span>
<a href="#l53.277"></a><span id="l53.277" class="difflineplus">+  if (status &gt;= 0) status = obj-&gt;class-&gt;parse_begin(obj);</span>
<a href="#l53.278"></a><span id="l53.278" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l53.279"></a><span id="l53.279">     PR_Free(opt);</span>
<a href="#l53.280"></a><span id="l53.280">     PR_Free(obj);</span>
<a href="#l53.281"></a><span id="l53.281">     return MIME_OUT_OF_MEMORY;</span>
<a href="#l53.282"></a><span id="l53.282">   }</span>
<a href="#l53.283"></a><span id="l53.283"> </span>
<a href="#l53.284"></a><span id="l53.284" class="difflineminus">-  while (1)</span>
<a href="#l53.285"></a><span id="l53.285" class="difflineminus">-  {</span>
<a href="#l53.286"></a><span id="l53.286" class="difflineplus">+  while (1) {</span>
<a href="#l53.287"></a><span id="l53.287">     char buf[255];</span>
<a href="#l53.288"></a><span id="l53.288">     int size = fread(buf, sizeof(*buf), sizeof(buf), stdin);</span>
<a href="#l53.289"></a><span id="l53.289">     if (size &lt;= 0) break;</span>
<a href="#l53.290"></a><span id="l53.290">     status = obj-&gt;class-&gt;parse_buffer(buf, size, obj);</span>
<a href="#l53.291"></a><span id="l53.291" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l53.292"></a><span id="l53.292" class="difflineminus">-    {</span>
<a href="#l53.293"></a><span id="l53.293" class="difflineplus">+    if (status &lt; 0) {</span>
<a href="#l53.294"></a><span id="l53.294">       mime_free(obj);</span>
<a href="#l53.295"></a><span id="l53.295">       PR_Free(opt);</span>
<a href="#l53.296"></a><span id="l53.296">       return status;</span>
<a href="#l53.297"></a><span id="l53.297">     }</span>
<a href="#l53.298"></a><span id="l53.298">   }</span>
<a href="#l53.299"></a><span id="l53.299"> </span>
<a href="#l53.300"></a><span id="l53.300">   status = obj-&gt;class-&gt;parse_eof(obj, false);</span>
<a href="#l53.301"></a><span id="l53.301" class="difflineminus">-  if (status &gt;= 0)</span>
<a href="#l53.302"></a><span id="l53.302" class="difflineminus">-  status = obj-&gt;class-&gt;parse_end(obj, false);</span>
<a href="#l53.303"></a><span id="l53.303" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l53.304"></a><span id="l53.304" class="difflineminus">-  {</span>
<a href="#l53.305"></a><span id="l53.305" class="difflineplus">+  if (status &gt;= 0) status = obj-&gt;class-&gt;parse_end(obj, false);</span>
<a href="#l53.306"></a><span id="l53.306" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l53.307"></a><span id="l53.307">     mime_free(obj);</span>
<a href="#l53.308"></a><span id="l53.308">     PR_Free(opt);</span>
<a href="#l53.309"></a><span id="l53.309">     return status;</span>
<a href="#l53.310"></a><span id="l53.310">   }</span>
<a href="#l53.311"></a><span id="l53.311"> </span>
<a href="#l53.312"></a><span id="l53.312" class="difflineminus">-  if (outline_p)</span>
<a href="#l53.313"></a><span id="l53.313" class="difflineminus">-  {</span>
<a href="#l53.314"></a><span id="l53.314" class="difflineminus">-    fprintf(out, &quot;\n\n&quot;</span>
<a href="#l53.315"></a><span id="l53.315" class="difflineminus">-      &quot;###############################################################\n&quot;);</span>
<a href="#l53.316"></a><span id="l53.316" class="difflineplus">+  if (outline_p) {</span>
<a href="#l53.317"></a><span id="l53.317" class="difflineplus">+    fprintf(</span>
<a href="#l53.318"></a><span id="l53.318" class="difflineplus">+        out,</span>
<a href="#l53.319"></a><span id="l53.319" class="difflineplus">+        &quot;\n\n&quot;</span>
<a href="#l53.320"></a><span id="l53.320" class="difflineplus">+        &quot;###############################################################\n&quot;);</span>
<a href="#l53.321"></a><span id="l53.321">     obj-&gt;class-&gt;debug_print(obj, stderr, 0);</span>
<a href="#l53.322"></a><span id="l53.322" class="difflineminus">-    fprintf(out,</span>
<a href="#l53.323"></a><span id="l53.323" class="difflineminus">-      &quot;###############################################################\n&quot;);</span>
<a href="#l53.324"></a><span id="l53.324" class="difflineplus">+    fprintf(</span>
<a href="#l53.325"></a><span id="l53.325" class="difflineplus">+        out,</span>
<a href="#l53.326"></a><span id="l53.326" class="difflineplus">+        &quot;###############################################################\n&quot;);</span>
<a href="#l53.327"></a><span id="l53.327">   }</span>
<a href="#l53.328"></a><span id="l53.328"> </span>
<a href="#l53.329"></a><span id="l53.329" class="difflineminus">-  mime_free (obj);</span>
<a href="#l53.330"></a><span id="l53.330" class="difflineplus">+  mime_free(obj);</span>
<a href="#l53.331"></a><span id="l53.331">   PR_Free(opt);</span>
<a href="#l53.332"></a><span id="l53.332">   return 0;</span>
<a href="#l53.333"></a><span id="l53.333"> }</span>
<a href="#l53.334"></a><span id="l53.334"> </span>
<a href="#l53.335"></a><span id="l53.335" class="difflineminus">-</span>
<a href="#l53.336"></a><span id="l53.336" class="difflineminus">-static char *</span>
<a href="#l53.337"></a><span id="l53.337" class="difflineminus">-test_cdb_name_cb (void *arg, int vers)</span>
<a href="#l53.338"></a><span id="l53.338" class="difflineminus">-{</span>
<a href="#l53.339"></a><span id="l53.339" class="difflineplus">+static char *test_cdb_name_cb(void *arg, int vers) {</span>
<a href="#l53.340"></a><span id="l53.340">   static char f[1024];</span>
<a href="#l53.341"></a><span id="l53.341">   if (vers &lt;= 4)</span>
<a href="#l53.342"></a><span id="l53.342" class="difflineminus">-  sprintf(f, &quot;%s/.netscape/cert.db&quot;, getenv(&quot;HOME&quot;));</span>
<a href="#l53.343"></a><span id="l53.343" class="difflineplus">+    sprintf(f, &quot;%s/.netscape/cert.db&quot;, getenv(&quot;HOME&quot;));</span>
<a href="#l53.344"></a><span id="l53.344">   else</span>
<a href="#l53.345"></a><span id="l53.345" class="difflineminus">-  sprintf(f, &quot;%s/.netscape/cert%d.db&quot;, getenv(&quot;HOME&quot;), vers);</span>
<a href="#l53.346"></a><span id="l53.346" class="difflineplus">+    sprintf(f, &quot;%s/.netscape/cert%d.db&quot;, getenv(&quot;HOME&quot;), vers);</span>
<a href="#l53.347"></a><span id="l53.347">   return f;</span>
<a href="#l53.348"></a><span id="l53.348"> }</span>
<a href="#l53.349"></a><span id="l53.349"> </span>
<a href="#l53.350"></a><span id="l53.350" class="difflineminus">-static char *</span>
<a href="#l53.351"></a><span id="l53.351" class="difflineminus">-test_kdb_name_cb (void *arg, int vers)</span>
<a href="#l53.352"></a><span id="l53.352" class="difflineminus">-{</span>
<a href="#l53.353"></a><span id="l53.353" class="difflineplus">+static char *test_kdb_name_cb(void *arg, int vers) {</span>
<a href="#l53.354"></a><span id="l53.354">   static char f[1024];</span>
<a href="#l53.355"></a><span id="l53.355">   if (vers &lt;= 2)</span>
<a href="#l53.356"></a><span id="l53.356" class="difflineminus">-  sprintf(f, &quot;%s/.netscape/key.db&quot;, getenv(&quot;HOME&quot;));</span>
<a href="#l53.357"></a><span id="l53.357" class="difflineplus">+    sprintf(f, &quot;%s/.netscape/key.db&quot;, getenv(&quot;HOME&quot;));</span>
<a href="#l53.358"></a><span id="l53.358">   else</span>
<a href="#l53.359"></a><span id="l53.359" class="difflineminus">-  sprintf(f, &quot;%s/.netscape/key%d.db&quot;, getenv(&quot;HOME&quot;), vers);</span>
<a href="#l53.360"></a><span id="l53.360" class="difflineplus">+    sprintf(f, &quot;%s/.netscape/key%d.db&quot;, getenv(&quot;HOME&quot;), vers);</span>
<a href="#l53.361"></a><span id="l53.361">   return f;</span>
<a href="#l53.362"></a><span id="l53.362"> }</span>
<a href="#l53.363"></a><span id="l53.363"> </span>
<a href="#l53.364"></a><span id="l53.364"> extern void SEC_Init(void);</span>
<a href="#l53.365"></a><span id="l53.365"> </span>
<a href="#l53.366"></a><span id="l53.366" class="difflineminus">-int</span>
<a href="#l53.367"></a><span id="l53.367" class="difflineminus">-main (int argc, char **argv)</span>
<a href="#l53.368"></a><span id="l53.368" class="difflineminus">-{</span>
<a href="#l53.369"></a><span id="l53.369" class="difflineplus">+int main(int argc, char **argv) {</span>
<a href="#l53.370"></a><span id="l53.370">   int32_t i = 1;</span>
<a href="#l53.371"></a><span id="l53.371">   char *url = &quot;&quot;;</span>
<a href="#l53.372"></a><span id="l53.372">   bool fancy_p = true;</span>
<a href="#l53.373"></a><span id="l53.373">   bool html_p = true;</span>
<a href="#l53.374"></a><span id="l53.374">   bool outline_p = false;</span>
<a href="#l53.375"></a><span id="l53.375">   bool dexlate_p = false;</span>
<a href="#l53.376"></a><span id="l53.376">   char filename[1000];</span>
<a href="#l53.377"></a><span id="l53.377">   CERTCertDBHandle *cdb_handle;</span>
<a href="#l53.378"></a><span id="l53.378">   SECKEYKeyDBHandle *kdb_handle;</span>
<a href="#l53.379"></a><span id="l53.379"> </span>
<a href="#l53.380"></a><span id="l53.380">   PR_Init(&quot;mimefilt&quot;, 24, 1, 0);</span>
<a href="#l53.381"></a><span id="l53.381"> </span>
<a href="#l53.382"></a><span id="l53.382" class="difflineminus">-  cdb_handle = (CERTCertDBHandle *)  calloc(1, sizeof(*cdb_handle));</span>
<a href="#l53.383"></a><span id="l53.383" class="difflineplus">+  cdb_handle = (CERTCertDBHandle *)calloc(1, sizeof(*cdb_handle));</span>
<a href="#l53.384"></a><span id="l53.384"> </span>
<a href="#l53.385"></a><span id="l53.385">   if (SECSuccess != CERT_OpenCertDB(cdb_handle, false, test_cdb_name_cb, NULL))</span>
<a href="#l53.386"></a><span id="l53.386" class="difflineminus">-  CERT_OpenVolatileCertDB(cdb_handle);</span>
<a href="#l53.387"></a><span id="l53.387" class="difflineplus">+    CERT_OpenVolatileCertDB(cdb_handle);</span>
<a href="#l53.388"></a><span id="l53.388">   CERT_SetDefaultCertDB(cdb_handle);</span>
<a href="#l53.389"></a><span id="l53.389"> </span>
<a href="#l53.390"></a><span id="l53.390">   RNG_RNGInit();</span>
<a href="#l53.391"></a><span id="l53.391"> </span>
<a href="#l53.392"></a><span id="l53.392">   kdb_handle = SECKEY_OpenKeyDB(false, test_kdb_name_cb, NULL);</span>
<a href="#l53.393"></a><span id="l53.393">   SECKEY_SetDefaultKeyDB(kdb_handle);</span>
<a href="#l53.394"></a><span id="l53.394"> </span>
<a href="#l53.395"></a><span id="l53.395">   PK11_SetPasswordFunc(test_passwd_prompt);</span>
<a href="#l53.396"></a><span id="l53.396"> </span>
<a href="#l53.397"></a><span id="l53.397">   sprintf(filename, &quot;%s/.netscape/secmodule.db&quot;, getenv(&quot;HOME&quot;));</span>
<a href="#l53.398"></a><span id="l53.398">   SECMOD_init(filename);</span>
<a href="#l53.399"></a><span id="l53.399"> </span>
<a href="#l53.400"></a><span id="l53.400">   SEC_Init();</span>
<a href="#l53.401"></a><span id="l53.401"> </span>
<a href="#l53.402"></a><span id="l53.402" class="difflineminus">-</span>
<a href="#l53.403"></a><span id="l53.403" class="difflineminus">-  if (i &lt; argc)</span>
<a href="#l53.404"></a><span id="l53.404" class="difflineminus">-  {</span>
<a href="#l53.405"></a><span id="l53.405" class="difflineplus">+  if (i &lt; argc) {</span>
<a href="#l53.406"></a><span id="l53.406">     if (argv[i][0] == '-')</span>
<a href="#l53.407"></a><span id="l53.407" class="difflineminus">-    url = strdup(&quot;&quot;);</span>
<a href="#l53.408"></a><span id="l53.408" class="difflineplus">+      url = strdup(&quot;&quot;);</span>
<a href="#l53.409"></a><span id="l53.409">     else</span>
<a href="#l53.410"></a><span id="l53.410" class="difflineminus">-    url = argv[i++];</span>
<a href="#l53.411"></a><span id="l53.411" class="difflineplus">+      url = argv[i++];</span>
<a href="#l53.412"></a><span id="l53.412">   }</span>
<a href="#l53.413"></a><span id="l53.413"> </span>
<a href="#l53.414"></a><span id="l53.414" class="difflineminus">-  if (url &amp;&amp;</span>
<a href="#l53.415"></a><span id="l53.415" class="difflineminus">-    (PL_strstr(url, &quot;?part=&quot;) ||</span>
<a href="#l53.416"></a><span id="l53.416" class="difflineminus">-     PL_strstr(url, &quot;&amp;part=&quot;)))</span>
<a href="#l53.417"></a><span id="l53.417" class="difflineminus">-  html_p = false;</span>
<a href="#l53.418"></a><span id="l53.418" class="difflineplus">+  if (url &amp;&amp; (PL_strstr(url, &quot;?part=&quot;) || PL_strstr(url, &quot;&amp;part=&quot;)))</span>
<a href="#l53.419"></a><span id="l53.419" class="difflineplus">+    html_p = false;</span>
<a href="#l53.420"></a><span id="l53.420"> </span>
<a href="#l53.421"></a><span id="l53.421" class="difflineminus">-  while (i &lt; argc)</span>
<a href="#l53.422"></a><span id="l53.422" class="difflineminus">-  {</span>
<a href="#l53.423"></a><span id="l53.423" class="difflineplus">+  while (i &lt; argc) {</span>
<a href="#l53.424"></a><span id="l53.424">     if (!strcmp(argv[i], &quot;-fancy&quot;))</span>
<a href="#l53.425"></a><span id="l53.425" class="difflineminus">-    fancy_p = true;</span>
<a href="#l53.426"></a><span id="l53.426" class="difflineplus">+      fancy_p = true;</span>
<a href="#l53.427"></a><span id="l53.427">     else if (!strcmp(argv[i], &quot;-no-fancy&quot;))</span>
<a href="#l53.428"></a><span id="l53.428" class="difflineminus">-    fancy_p = false;</span>
<a href="#l53.429"></a><span id="l53.429" class="difflineplus">+      fancy_p = false;</span>
<a href="#l53.430"></a><span id="l53.430">     else if (!strcmp(argv[i], &quot;-html&quot;))</span>
<a href="#l53.431"></a><span id="l53.431" class="difflineminus">-    html_p = true;</span>
<a href="#l53.432"></a><span id="l53.432" class="difflineplus">+      html_p = true;</span>
<a href="#l53.433"></a><span id="l53.433">     else if (!strcmp(argv[i], &quot;-raw&quot;))</span>
<a href="#l53.434"></a><span id="l53.434" class="difflineminus">-    html_p = false;</span>
<a href="#l53.435"></a><span id="l53.435" class="difflineplus">+      html_p = false;</span>
<a href="#l53.436"></a><span id="l53.436">     else if (!strcmp(argv[i], &quot;-outline&quot;))</span>
<a href="#l53.437"></a><span id="l53.437" class="difflineminus">-    outline_p = true;</span>
<a href="#l53.438"></a><span id="l53.438" class="difflineplus">+      outline_p = true;</span>
<a href="#l53.439"></a><span id="l53.439">     else if (!strcmp(argv[i], &quot;-dexlate&quot;))</span>
<a href="#l53.440"></a><span id="l53.440" class="difflineminus">-    dexlate_p = true;</span>
<a href="#l53.441"></a><span id="l53.441" class="difflineminus">-    else</span>
<a href="#l53.442"></a><span id="l53.442" class="difflineminus">-    {</span>
<a href="#l53.443"></a><span id="l53.443" class="difflineminus">-      fprintf(stderr,</span>
<a href="#l53.444"></a><span id="l53.444" class="difflineminus">-      &quot;usage: %s [ URL [ -fancy | -no-fancy | -html | -raw | -outline | -dexlate ]]\n&quot;</span>
<a href="#l53.445"></a><span id="l53.445" class="difflineplus">+      dexlate_p = true;</span>
<a href="#l53.446"></a><span id="l53.446" class="difflineplus">+    else {</span>
<a href="#l53.447"></a><span id="l53.447" class="difflineplus">+      fprintf(</span>
<a href="#l53.448"></a><span id="l53.448" class="difflineplus">+          stderr,</span>
<a href="#l53.449"></a><span id="l53.449" class="difflineplus">+          &quot;usage: %s [ URL [ -fancy | -no-fancy | -html | -raw | -outline | &quot;</span>
<a href="#l53.450"></a><span id="l53.450" class="difflineplus">+          &quot;-dexlate ]]\n&quot;</span>
<a href="#l53.451"></a><span id="l53.451">           &quot;     &lt; message/rfc822 &gt; output\n&quot;,</span>
<a href="#l53.452"></a><span id="l53.452" class="difflineminus">-          (PL_strrchr(argv[0], '/') ?</span>
<a href="#l53.453"></a><span id="l53.453" class="difflineminus">-           PL_strrchr(argv[0], '/') + 1 :</span>
<a href="#l53.454"></a><span id="l53.454" class="difflineminus">-           argv[0]));</span>
<a href="#l53.455"></a><span id="l53.455" class="difflineplus">+          (PL_strrchr(argv[0], '/') ? PL_strrchr(argv[0], '/') + 1 : argv[0]));</span>
<a href="#l53.456"></a><span id="l53.456">       i = 1;</span>
<a href="#l53.457"></a><span id="l53.457">       goto FAIL;</span>
<a href="#l53.458"></a><span id="l53.458">     }</span>
<a href="#l53.459"></a><span id="l53.459">     i++;</span>
<a href="#l53.460"></a><span id="l53.460">   }</span>
<a href="#l53.461"></a><span id="l53.461"> </span>
<a href="#l53.462"></a><span id="l53.462">   i = test(stdin, stdout, url, fancy_p, html_p, outline_p, dexlate_p, true);</span>
<a href="#l53.463"></a><span id="l53.463">   fprintf(stdout, &quot;\n&quot;);</span>
<a href="#l53.464"></a><span id="l53.464">   fflush(stdout);</span>
<a href="#l53.465"></a><span id="l53.465"> </span>
<a href="#l53.466"></a><span id="l53.466" class="difflineminus">- FAIL:</span>
<a href="#l53.467"></a><span id="l53.467" class="difflineplus">+FAIL:</span>
<a href="#l53.468"></a><span id="l53.468"> </span>
<a href="#l53.469"></a><span id="l53.469">   CERT_ClosePermCertDB(cdb_handle);</span>
<a href="#l53.470"></a><span id="l53.470">   SECKEY_CloseKeyDB(kdb_handle);</span>
<a href="#l53.471"></a><span id="l53.471"> </span>
<a href="#l53.472"></a><span id="l53.472">   exit(i);</span>
<a href="#l53.473"></a><span id="l53.473"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/mime/src/mimehdrs.cpp</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/mime/src/mimehdrs.cpp</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -24,293 +24,252 @@</span>
<a href="#l54.4"></a><span id="l54.4"> #include &quot;nsMemory.h&quot;</span>
<a href="#l54.5"></a><span id="l54.5"> #include &lt;ctype.h&gt;</span>
<a href="#l54.6"></a><span id="l54.6"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l54.7"></a><span id="l54.7"> #include &quot;mozilla/Unused.h&quot;</span>
<a href="#l54.8"></a><span id="l54.8"> </span>
<a href="#l54.9"></a><span id="l54.9"> // Forward declares...</span>
<a href="#l54.10"></a><span id="l54.10"> int32_t MimeHeaders_build_heads_list(MimeHeaders *hdrs);</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-void</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-MimeHeaders_convert_header_value(MimeDisplayOptions *opt, nsCString &amp;value,</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineminus">-                                 bool convert_charset_only)</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineminus">-{</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineminus">-  if (value.IsEmpty())</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineminus">-    return;</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineplus">+void MimeHeaders_convert_header_value(MimeDisplayOptions *opt, nsCString &amp;value,</span>
<a href="#l54.19"></a><span id="l54.19" class="difflineplus">+                                      bool convert_charset_only) {</span>
<a href="#l54.20"></a><span id="l54.20" class="difflineplus">+  if (value.IsEmpty()) return;</span>
<a href="#l54.21"></a><span id="l54.21"> </span>
<a href="#l54.22"></a><span id="l54.22" class="difflineminus">-  if (convert_charset_only)</span>
<a href="#l54.23"></a><span id="l54.23" class="difflineminus">-  {</span>
<a href="#l54.24"></a><span id="l54.24" class="difflineplus">+  if (convert_charset_only) {</span>
<a href="#l54.25"></a><span id="l54.25">     nsAutoCString output;</span>
<a href="#l54.26"></a><span id="l54.26" class="difflineminus">-    nsMsgI18NConvertRawBytesToUTF8(value,</span>
<a href="#l54.27"></a><span id="l54.27" class="difflineminus">-                                   opt-&gt;default_charset ?</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineminus">-                                     nsDependentCString(opt-&gt;default_charset) :</span>
<a href="#l54.29"></a><span id="l54.29" class="difflineminus">-                                     EmptyCString(),</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineminus">-                                   output);</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineplus">+    nsMsgI18NConvertRawBytesToUTF8(</span>
<a href="#l54.32"></a><span id="l54.32" class="difflineplus">+        value,</span>
<a href="#l54.33"></a><span id="l54.33" class="difflineplus">+        opt-&gt;default_charset ? nsDependentCString(opt-&gt;default_charset)</span>
<a href="#l54.34"></a><span id="l54.34" class="difflineplus">+                             : EmptyCString(),</span>
<a href="#l54.35"></a><span id="l54.35" class="difflineplus">+        output);</span>
<a href="#l54.36"></a><span id="l54.36">     value.Assign(output);</span>
<a href="#l54.37"></a><span id="l54.37">     return;</span>
<a href="#l54.38"></a><span id="l54.38">   }</span>
<a href="#l54.39"></a><span id="l54.39"> </span>
<a href="#l54.40"></a><span id="l54.40" class="difflineminus">-  if (opt &amp;&amp; opt-&gt;rfc1522_conversion_p)</span>
<a href="#l54.41"></a><span id="l54.41" class="difflineminus">-  {</span>
<a href="#l54.42"></a><span id="l54.42" class="difflineplus">+  if (opt &amp;&amp; opt-&gt;rfc1522_conversion_p) {</span>
<a href="#l54.43"></a><span id="l54.43">     nsAutoCString temporary;</span>
<a href="#l54.44"></a><span id="l54.44">     MIME_DecodeMimeHeader(value.get(), opt-&gt;default_charset,</span>
<a href="#l54.45"></a><span id="l54.45">                           opt-&gt;override_charset, true, temporary);</span>
<a href="#l54.46"></a><span id="l54.46"> </span>
<a href="#l54.47"></a><span id="l54.47" class="difflineminus">-    if (!temporary.IsEmpty())</span>
<a href="#l54.48"></a><span id="l54.48" class="difflineminus">-    {</span>
<a href="#l54.49"></a><span id="l54.49" class="difflineplus">+    if (!temporary.IsEmpty()) {</span>
<a href="#l54.50"></a><span id="l54.50">       value = temporary;</span>
<a href="#l54.51"></a><span id="l54.51">     }</span>
<a href="#l54.52"></a><span id="l54.52" class="difflineminus">-  }</span>
<a href="#l54.53"></a><span id="l54.53" class="difflineminus">-  else</span>
<a href="#l54.54"></a><span id="l54.54" class="difflineminus">-  {</span>
<a href="#l54.55"></a><span id="l54.55" class="difflineplus">+  } else {</span>
<a href="#l54.56"></a><span id="l54.56">     // This behavior, though highly unusual, was carefully preserved</span>
<a href="#l54.57"></a><span id="l54.57">     // from the previous implementation.  It may be that this is dead</span>
<a href="#l54.58"></a><span id="l54.58">     // code, in which case opt-&gt;rfc1522_conversion_p is no longer</span>
<a href="#l54.59"></a><span id="l54.59">     // needed.</span>
<a href="#l54.60"></a><span id="l54.60">     value.Truncate();</span>
<a href="#l54.61"></a><span id="l54.61">   }</span>
<a href="#l54.62"></a><span id="l54.62"> }</span>
<a href="#l54.63"></a><span id="l54.63"> </span>
<a href="#l54.64"></a><span id="l54.64" class="difflineminus">-MimeHeaders *</span>
<a href="#l54.65"></a><span id="l54.65" class="difflineminus">-MimeHeaders_new (void)</span>
<a href="#l54.66"></a><span id="l54.66" class="difflineminus">-{</span>
<a href="#l54.67"></a><span id="l54.67" class="difflineminus">-  MimeHeaders *hdrs = (MimeHeaders *) PR_MALLOC(sizeof(MimeHeaders));</span>
<a href="#l54.68"></a><span id="l54.68" class="difflineplus">+MimeHeaders *MimeHeaders_new(void) {</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineplus">+  MimeHeaders *hdrs = (MimeHeaders *)PR_MALLOC(sizeof(MimeHeaders));</span>
<a href="#l54.70"></a><span id="l54.70">   if (!hdrs) return 0;</span>
<a href="#l54.71"></a><span id="l54.71"> </span>
<a href="#l54.72"></a><span id="l54.72">   memset(hdrs, 0, sizeof(*hdrs));</span>
<a href="#l54.73"></a><span id="l54.73">   hdrs-&gt;done_p = false;</span>
<a href="#l54.74"></a><span id="l54.74"> </span>
<a href="#l54.75"></a><span id="l54.75">   return hdrs;</span>
<a href="#l54.76"></a><span id="l54.76"> }</span>
<a href="#l54.77"></a><span id="l54.77"> </span>
<a href="#l54.78"></a><span id="l54.78" class="difflineminus">-void</span>
<a href="#l54.79"></a><span id="l54.79" class="difflineminus">-MimeHeaders_free (MimeHeaders *hdrs)</span>
<a href="#l54.80"></a><span id="l54.80" class="difflineminus">-{</span>
<a href="#l54.81"></a><span id="l54.81" class="difflineplus">+void MimeHeaders_free(MimeHeaders *hdrs) {</span>
<a href="#l54.82"></a><span id="l54.82">   if (!hdrs) return;</span>
<a href="#l54.83"></a><span id="l54.83">   PR_FREEIF(hdrs-&gt;all_headers);</span>
<a href="#l54.84"></a><span id="l54.84">   PR_FREEIF(hdrs-&gt;heads);</span>
<a href="#l54.85"></a><span id="l54.85">   PR_FREEIF(hdrs-&gt;obuffer);</span>
<a href="#l54.86"></a><span id="l54.86">   PR_FREEIF(hdrs-&gt;munged_subject);</span>
<a href="#l54.87"></a><span id="l54.87">   hdrs-&gt;obuffer_fp = 0;</span>
<a href="#l54.88"></a><span id="l54.88">   hdrs-&gt;obuffer_size = 0;</span>
<a href="#l54.89"></a><span id="l54.89"> </span>
<a href="#l54.90"></a><span id="l54.90" class="difflineminus">-# ifdef DEBUG__</span>
<a href="#l54.91"></a><span id="l54.91" class="difflineplus">+#ifdef DEBUG__</span>
<a href="#l54.92"></a><span id="l54.92">   {</span>
<a href="#l54.93"></a><span id="l54.93" class="difflineminus">-  int i, size = sizeof(*hdrs);</span>
<a href="#l54.94"></a><span id="l54.94" class="difflineminus">-  uint32_t *array = (uint32_t*) hdrs;</span>
<a href="#l54.95"></a><span id="l54.95" class="difflineminus">-  for (i = 0; i &lt; (size / sizeof(*array)); i++)</span>
<a href="#l54.96"></a><span id="l54.96" class="difflineminus">-    array[i] = (uint32_t) 0xDEADBEEF;</span>
<a href="#l54.97"></a><span id="l54.97" class="difflineplus">+    int i, size = sizeof(*hdrs);</span>
<a href="#l54.98"></a><span id="l54.98" class="difflineplus">+    uint32_t *array = (uint32_t *)hdrs;</span>
<a href="#l54.99"></a><span id="l54.99" class="difflineplus">+    for (i = 0; i &lt; (size / sizeof(*array)); i++)</span>
<a href="#l54.100"></a><span id="l54.100" class="difflineplus">+      array[i] = (uint32_t)0xDEADBEEF;</span>
<a href="#l54.101"></a><span id="l54.101">   }</span>
<a href="#l54.102"></a><span id="l54.102" class="difflineminus">-# endif /* DEBUG */</span>
<a href="#l54.103"></a><span id="l54.103" class="difflineplus">+#endif /* DEBUG */</span>
<a href="#l54.104"></a><span id="l54.104"> </span>
<a href="#l54.105"></a><span id="l54.105">   PR_Free(hdrs);</span>
<a href="#l54.106"></a><span id="l54.106"> }</span>
<a href="#l54.107"></a><span id="l54.107"> </span>
<a href="#l54.108"></a><span id="l54.108" class="difflineminus">-int</span>
<a href="#l54.109"></a><span id="l54.109" class="difflineminus">-MimeHeaders_parse_line (const char *buffer, int32_t size, MimeHeaders *hdrs)</span>
<a href="#l54.110"></a><span id="l54.110" class="difflineminus">-{</span>
<a href="#l54.111"></a><span id="l54.111" class="difflineplus">+int MimeHeaders_parse_line(const char *buffer, int32_t size,</span>
<a href="#l54.112"></a><span id="l54.112" class="difflineplus">+                           MimeHeaders *hdrs) {</span>
<a href="#l54.113"></a><span id="l54.113">   int status = 0;</span>
<a href="#l54.114"></a><span id="l54.114">   int desired_size;</span>
<a href="#l54.115"></a><span id="l54.115"> </span>
<a href="#l54.116"></a><span id="l54.116">   NS_ASSERTION(hdrs, &quot;1.22 &lt;rhp@netscape.com&gt; 22 Aug 1999 08:48&quot;);</span>
<a href="#l54.117"></a><span id="l54.117">   if (!hdrs) return -1;</span>
<a href="#l54.118"></a><span id="l54.118"> </span>
<a href="#l54.119"></a><span id="l54.119">   /* Don't try and feed me more data after having fed me a blank line... */</span>
<a href="#l54.120"></a><span id="l54.120">   NS_ASSERTION(!hdrs-&gt;done_p, &quot;1.22 &lt;rhp@netscape.com&gt; 22 Aug 1999 08:48&quot;);</span>
<a href="#l54.121"></a><span id="l54.121">   if (hdrs-&gt;done_p) return -1;</span>
<a href="#l54.122"></a><span id="l54.122"> </span>
<a href="#l54.123"></a><span id="l54.123" class="difflineminus">-  if (!buffer || size == 0 || *buffer == '\r' || *buffer == '\n')</span>
<a href="#l54.124"></a><span id="l54.124" class="difflineminus">-  {</span>
<a href="#l54.125"></a><span id="l54.125" class="difflineplus">+  if (!buffer || size == 0 || *buffer == '\r' || *buffer == '\n') {</span>
<a href="#l54.126"></a><span id="l54.126">     /* If this is a blank line, we're done.</span>
<a href="#l54.127"></a><span id="l54.127">      */</span>
<a href="#l54.128"></a><span id="l54.128">     hdrs-&gt;done_p = true;</span>
<a href="#l54.129"></a><span id="l54.129">     return MimeHeaders_build_heads_list(hdrs);</span>
<a href="#l54.130"></a><span id="l54.130">   }</span>
<a href="#l54.131"></a><span id="l54.131"> </span>
<a href="#l54.132"></a><span id="l54.132">   /* Tack this data on to the end of our copy.</span>
<a href="#l54.133"></a><span id="l54.133">    */</span>
<a href="#l54.134"></a><span id="l54.134">   desired_size = hdrs-&gt;all_headers_fp + size + 1;</span>
<a href="#l54.135"></a><span id="l54.135" class="difflineminus">-  if (desired_size &gt;= hdrs-&gt;all_headers_size)</span>
<a href="#l54.136"></a><span id="l54.136" class="difflineminus">-  {</span>
<a href="#l54.137"></a><span id="l54.137" class="difflineminus">-    status = mime_GrowBuffer (desired_size, sizeof(char), 255,</span>
<a href="#l54.138"></a><span id="l54.138" class="difflineminus">-                 &amp;hdrs-&gt;all_headers, &amp;hdrs-&gt;all_headers_size);</span>
<a href="#l54.139"></a><span id="l54.139" class="difflineplus">+  if (desired_size &gt;= hdrs-&gt;all_headers_size) {</span>
<a href="#l54.140"></a><span id="l54.140" class="difflineplus">+    status = mime_GrowBuffer(desired_size, sizeof(char), 255,</span>
<a href="#l54.141"></a><span id="l54.141" class="difflineplus">+                             &amp;hdrs-&gt;all_headers, &amp;hdrs-&gt;all_headers_size);</span>
<a href="#l54.142"></a><span id="l54.142">     if (status &lt; 0) return status;</span>
<a href="#l54.143"></a><span id="l54.143">   }</span>
<a href="#l54.144"></a><span id="l54.144" class="difflineminus">-  memcpy(hdrs-&gt;all_headers+hdrs-&gt;all_headers_fp, buffer, size);</span>
<a href="#l54.145"></a><span id="l54.145" class="difflineplus">+  memcpy(hdrs-&gt;all_headers + hdrs-&gt;all_headers_fp, buffer, size);</span>
<a href="#l54.146"></a><span id="l54.146">   hdrs-&gt;all_headers_fp += size;</span>
<a href="#l54.147"></a><span id="l54.147"> </span>
<a href="#l54.148"></a><span id="l54.148">   return 0;</span>
<a href="#l54.149"></a><span id="l54.149"> }</span>
<a href="#l54.150"></a><span id="l54.150"> </span>
<a href="#l54.151"></a><span id="l54.151" class="difflineminus">-MimeHeaders *</span>
<a href="#l54.152"></a><span id="l54.152" class="difflineminus">-MimeHeaders_copy (MimeHeaders *hdrs)</span>
<a href="#l54.153"></a><span id="l54.153" class="difflineminus">-{</span>
<a href="#l54.154"></a><span id="l54.154" class="difflineplus">+MimeHeaders *MimeHeaders_copy(MimeHeaders *hdrs) {</span>
<a href="#l54.155"></a><span id="l54.155">   MimeHeaders *hdrs2;</span>
<a href="#l54.156"></a><span id="l54.156">   if (!hdrs) return 0;</span>
<a href="#l54.157"></a><span id="l54.157"> </span>
<a href="#l54.158"></a><span id="l54.158" class="difflineminus">-  hdrs2 = (MimeHeaders *) PR_MALLOC(sizeof(*hdrs));</span>
<a href="#l54.159"></a><span id="l54.159" class="difflineplus">+  hdrs2 = (MimeHeaders *)PR_MALLOC(sizeof(*hdrs));</span>
<a href="#l54.160"></a><span id="l54.160">   if (!hdrs2) return 0;</span>
<a href="#l54.161"></a><span id="l54.161">   memset(hdrs2, 0, sizeof(*hdrs2));</span>
<a href="#l54.162"></a><span id="l54.162"> </span>
<a href="#l54.163"></a><span id="l54.163" class="difflineminus">-  if (hdrs-&gt;all_headers)</span>
<a href="#l54.164"></a><span id="l54.164" class="difflineminus">-  {</span>
<a href="#l54.165"></a><span id="l54.165" class="difflineminus">-    hdrs2-&gt;all_headers = (char *) PR_MALLOC(hdrs-&gt;all_headers_fp);</span>
<a href="#l54.166"></a><span id="l54.166" class="difflineminus">-    if (!hdrs2-&gt;all_headers)</span>
<a href="#l54.167"></a><span id="l54.167" class="difflineminus">-    {</span>
<a href="#l54.168"></a><span id="l54.168" class="difflineplus">+  if (hdrs-&gt;all_headers) {</span>
<a href="#l54.169"></a><span id="l54.169" class="difflineplus">+    hdrs2-&gt;all_headers = (char *)PR_MALLOC(hdrs-&gt;all_headers_fp);</span>
<a href="#l54.170"></a><span id="l54.170" class="difflineplus">+    if (!hdrs2-&gt;all_headers) {</span>
<a href="#l54.171"></a><span id="l54.171">       PR_Free(hdrs2);</span>
<a href="#l54.172"></a><span id="l54.172">       return 0;</span>
<a href="#l54.173"></a><span id="l54.173">     }</span>
<a href="#l54.174"></a><span id="l54.174">     memcpy(hdrs2-&gt;all_headers, hdrs-&gt;all_headers, hdrs-&gt;all_headers_fp);</span>
<a href="#l54.175"></a><span id="l54.175"> </span>
<a href="#l54.176"></a><span id="l54.176" class="difflineminus">-    hdrs2-&gt;all_headers_fp   = hdrs-&gt;all_headers_fp;</span>
<a href="#l54.177"></a><span id="l54.177" class="difflineplus">+    hdrs2-&gt;all_headers_fp = hdrs-&gt;all_headers_fp;</span>
<a href="#l54.178"></a><span id="l54.178">     hdrs2-&gt;all_headers_size = hdrs-&gt;all_headers_fp;</span>
<a href="#l54.179"></a><span id="l54.179">   }</span>
<a href="#l54.180"></a><span id="l54.180"> </span>
<a href="#l54.181"></a><span id="l54.181">   hdrs2-&gt;done_p = hdrs-&gt;done_p;</span>
<a href="#l54.182"></a><span id="l54.182"> </span>
<a href="#l54.183"></a><span id="l54.183" class="difflineminus">-  if (hdrs-&gt;heads)</span>
<a href="#l54.184"></a><span id="l54.184" class="difflineminus">-  {</span>
<a href="#l54.185"></a><span id="l54.185" class="difflineplus">+  if (hdrs-&gt;heads) {</span>
<a href="#l54.186"></a><span id="l54.186">     int i;</span>
<a href="#l54.187"></a><span id="l54.187" class="difflineminus">-    hdrs2-&gt;heads = (char **) PR_MALLOC(hdrs-&gt;heads_size</span>
<a href="#l54.188"></a><span id="l54.188" class="difflineminus">-                    * sizeof(*hdrs-&gt;heads));</span>
<a href="#l54.189"></a><span id="l54.189" class="difflineminus">-    if (!hdrs2-&gt;heads)</span>
<a href="#l54.190"></a><span id="l54.190" class="difflineminus">-    {</span>
<a href="#l54.191"></a><span id="l54.191" class="difflineplus">+    hdrs2-&gt;heads = (char **)PR_MALLOC(hdrs-&gt;heads_size * sizeof(*hdrs-&gt;heads));</span>
<a href="#l54.192"></a><span id="l54.192" class="difflineplus">+    if (!hdrs2-&gt;heads) {</span>
<a href="#l54.193"></a><span id="l54.193">       PR_FREEIF(hdrs2-&gt;all_headers);</span>
<a href="#l54.194"></a><span id="l54.194">       PR_Free(hdrs2);</span>
<a href="#l54.195"></a><span id="l54.195">       return 0;</span>
<a href="#l54.196"></a><span id="l54.196">     }</span>
<a href="#l54.197"></a><span id="l54.197">     hdrs2-&gt;heads_size = hdrs-&gt;heads_size;</span>
<a href="#l54.198"></a><span id="l54.198" class="difflineminus">-    for (i = 0; i &lt; hdrs-&gt;heads_size; i++)</span>
<a href="#l54.199"></a><span id="l54.199" class="difflineminus">-    {</span>
<a href="#l54.200"></a><span id="l54.200" class="difflineminus">-      hdrs2-&gt;heads[i] = (hdrs2-&gt;all_headers +</span>
<a href="#l54.201"></a><span id="l54.201" class="difflineminus">-               (hdrs-&gt;heads[i] - hdrs-&gt;all_headers));</span>
<a href="#l54.202"></a><span id="l54.202" class="difflineplus">+    for (i = 0; i &lt; hdrs-&gt;heads_size; i++) {</span>
<a href="#l54.203"></a><span id="l54.203" class="difflineplus">+      hdrs2-&gt;heads[i] =</span>
<a href="#l54.204"></a><span id="l54.204" class="difflineplus">+          (hdrs2-&gt;all_headers + (hdrs-&gt;heads[i] - hdrs-&gt;all_headers));</span>
<a href="#l54.205"></a><span id="l54.205">     }</span>
<a href="#l54.206"></a><span id="l54.206">   }</span>
<a href="#l54.207"></a><span id="l54.207">   return hdrs2;</span>
<a href="#l54.208"></a><span id="l54.208"> }</span>
<a href="#l54.209"></a><span id="l54.209"> </span>
<a href="#l54.210"></a><span id="l54.210" class="difflineminus">-int</span>
<a href="#l54.211"></a><span id="l54.211" class="difflineminus">-MimeHeaders_build_heads_list(MimeHeaders *hdrs)</span>
<a href="#l54.212"></a><span id="l54.212" class="difflineminus">-{</span>
<a href="#l54.213"></a><span id="l54.213" class="difflineplus">+int MimeHeaders_build_heads_list(MimeHeaders *hdrs) {</span>
<a href="#l54.214"></a><span id="l54.214">   char *s;</span>
<a href="#l54.215"></a><span id="l54.215">   char *end;</span>
<a href="#l54.216"></a><span id="l54.216">   int i;</span>
<a href="#l54.217"></a><span id="l54.217">   NS_ASSERTION(hdrs, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l54.218"></a><span id="l54.218">   if (!hdrs) return -1;</span>
<a href="#l54.219"></a><span id="l54.219"> </span>
<a href="#l54.220"></a><span id="l54.220" class="difflineminus">-  NS_ASSERTION(hdrs-&gt;done_p &amp;&amp; !hdrs-&gt;heads, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l54.221"></a><span id="l54.221" class="difflineminus">-  if (!hdrs-&gt;done_p || hdrs-&gt;heads)</span>
<a href="#l54.222"></a><span id="l54.222" class="difflineminus">-  return -1;</span>
<a href="#l54.223"></a><span id="l54.223" class="difflineplus">+  NS_ASSERTION(hdrs-&gt;done_p &amp;&amp; !hdrs-&gt;heads,</span>
<a href="#l54.224"></a><span id="l54.224" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l54.225"></a><span id="l54.225" class="difflineplus">+  if (!hdrs-&gt;done_p || hdrs-&gt;heads) return -1;</span>
<a href="#l54.226"></a><span id="l54.226"> </span>
<a href="#l54.227"></a><span id="l54.227" class="difflineminus">-  if (hdrs-&gt;all_headers_fp == 0)</span>
<a href="#l54.228"></a><span id="l54.228" class="difflineminus">-  {</span>
<a href="#l54.229"></a><span id="l54.229" class="difflineplus">+  if (hdrs-&gt;all_headers_fp == 0) {</span>
<a href="#l54.230"></a><span id="l54.230">     /* Must not have been any headers (we got the blank line right away.) */</span>
<a href="#l54.231"></a><span id="l54.231" class="difflineminus">-    PR_FREEIF (hdrs-&gt;all_headers);</span>
<a href="#l54.232"></a><span id="l54.232" class="difflineplus">+    PR_FREEIF(hdrs-&gt;all_headers);</span>
<a href="#l54.233"></a><span id="l54.233">     hdrs-&gt;all_headers_size = 0;</span>
<a href="#l54.234"></a><span id="l54.234">     return 0;</span>
<a href="#l54.235"></a><span id="l54.235">   }</span>
<a href="#l54.236"></a><span id="l54.236"> </span>
<a href="#l54.237"></a><span id="l54.237">   /* At this point, we might as well realloc all_headers back down to the</span>
<a href="#l54.238"></a><span id="l54.238">    minimum size it must be (it could be up to 1k bigger.)  But don't</span>
<a href="#l54.239"></a><span id="l54.239">    bother if we're only off by a tiny bit. */</span>
<a href="#l54.240"></a><span id="l54.240" class="difflineminus">-  NS_ASSERTION(hdrs-&gt;all_headers_fp &lt;= hdrs-&gt;all_headers_size, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l54.241"></a><span id="l54.241" class="difflineminus">-  if (hdrs-&gt;all_headers_fp + 60 &lt;= hdrs-&gt;all_headers_size)</span>
<a href="#l54.242"></a><span id="l54.242" class="difflineminus">-  {</span>
<a href="#l54.243"></a><span id="l54.243" class="difflineplus">+  NS_ASSERTION(hdrs-&gt;all_headers_fp &lt;= hdrs-&gt;all_headers_size,</span>
<a href="#l54.244"></a><span id="l54.244" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l54.245"></a><span id="l54.245" class="difflineplus">+  if (hdrs-&gt;all_headers_fp + 60 &lt;= hdrs-&gt;all_headers_size) {</span>
<a href="#l54.246"></a><span id="l54.246">     char *ls = (char *)PR_Realloc(hdrs-&gt;all_headers, hdrs-&gt;all_headers_fp);</span>
<a href="#l54.247"></a><span id="l54.247">     if (ls) /* can this ever fail?  we're making it smaller... */</span>
<a href="#l54.248"></a><span id="l54.248">     {</span>
<a href="#l54.249"></a><span id="l54.249" class="difflineminus">-      hdrs-&gt;all_headers = ls;  /* in case it got relocated */</span>
<a href="#l54.250"></a><span id="l54.250" class="difflineplus">+      hdrs-&gt;all_headers = ls; /* in case it got relocated */</span>
<a href="#l54.251"></a><span id="l54.251">       hdrs-&gt;all_headers_size = hdrs-&gt;all_headers_fp;</span>
<a href="#l54.252"></a><span id="l54.252">     }</span>
<a href="#l54.253"></a><span id="l54.253">   }</span>
<a href="#l54.254"></a><span id="l54.254"> </span>
<a href="#l54.255"></a><span id="l54.255">   /* First go through and count up the number of headers in the block.</span>
<a href="#l54.256"></a><span id="l54.256">    */</span>
<a href="#l54.257"></a><span id="l54.257">   end = hdrs-&gt;all_headers + hdrs-&gt;all_headers_fp;</span>
<a href="#l54.258"></a><span id="l54.258" class="difflineminus">-  for (s = hdrs-&gt;all_headers; s &lt; end; s++)</span>
<a href="#l54.259"></a><span id="l54.259" class="difflineminus">-  {</span>
<a href="#l54.260"></a><span id="l54.260" class="difflineminus">-    if (s &lt; (end-1) &amp;&amp; s[0] == '\r' &amp;&amp; s[1] == '\n') /* CRLF -&gt; LF */</span>
<a href="#l54.261"></a><span id="l54.261" class="difflineplus">+  for (s = hdrs-&gt;all_headers; s &lt; end; s++) {</span>
<a href="#l54.262"></a><span id="l54.262" class="difflineplus">+    if (s &lt; (end - 1) &amp;&amp; s[0] == '\r' &amp;&amp; s[1] == '\n') /* CRLF -&gt; LF */</span>
<a href="#l54.263"></a><span id="l54.263">       s++;</span>
<a href="#l54.264"></a><span id="l54.264"> </span>
<a href="#l54.265"></a><span id="l54.265" class="difflineminus">-    if ((s[0] == '\r' || s[0] == '\n') &amp;&amp;      /* we're at a newline, and */</span>
<a href="#l54.266"></a><span id="l54.266" class="difflineminus">-      (s &gt;= (end-1) ||            /* we're at EOF, or */</span>
<a href="#l54.267"></a><span id="l54.267" class="difflineminus">-       !(s[1] == ' ' || s[1] == '\t')))    /* next char is nonwhite */</span>
<a href="#l54.268"></a><span id="l54.268" class="difflineminus">-    hdrs-&gt;heads_size++;</span>
<a href="#l54.269"></a><span id="l54.269" class="difflineplus">+    if ((s[0] == '\r' || s[0] == '\n') &amp;&amp; /* we're at a newline, and */</span>
<a href="#l54.270"></a><span id="l54.270" class="difflineplus">+        (s &gt;= (end - 1) ||                /* we're at EOF, or */</span>
<a href="#l54.271"></a><span id="l54.271" class="difflineplus">+         !(s[1] == ' ' || s[1] == '\t'))) /* next char is nonwhite */</span>
<a href="#l54.272"></a><span id="l54.272" class="difflineplus">+      hdrs-&gt;heads_size++;</span>
<a href="#l54.273"></a><span id="l54.273">   }</span>
<a href="#l54.274"></a><span id="l54.274"> </span>
<a href="#l54.275"></a><span id="l54.275">   /* Now allocate storage for the pointers to each of those headers.</span>
<a href="#l54.276"></a><span id="l54.276">    */</span>
<a href="#l54.277"></a><span id="l54.277" class="difflineminus">-  hdrs-&gt;heads = (char **) PR_MALLOC((hdrs-&gt;heads_size + 1) * sizeof(char *));</span>
<a href="#l54.278"></a><span id="l54.278" class="difflineminus">-  if (!hdrs-&gt;heads)</span>
<a href="#l54.279"></a><span id="l54.279" class="difflineminus">-    return MIME_OUT_OF_MEMORY;</span>
<a href="#l54.280"></a><span id="l54.280" class="difflineplus">+  hdrs-&gt;heads = (char **)PR_MALLOC((hdrs-&gt;heads_size + 1) * sizeof(char *));</span>
<a href="#l54.281"></a><span id="l54.281" class="difflineplus">+  if (!hdrs-&gt;heads) return MIME_OUT_OF_MEMORY;</span>
<a href="#l54.282"></a><span id="l54.282">   memset(hdrs-&gt;heads, 0, (hdrs-&gt;heads_size + 1) * sizeof(char *));</span>
<a href="#l54.283"></a><span id="l54.283"> </span>
<a href="#l54.284"></a><span id="l54.284">   /* Now make another pass through the headers, and this time, record the</span>
<a href="#l54.285"></a><span id="l54.285">    starting position of each header.</span>
<a href="#l54.286"></a><span id="l54.286">    */</span>
<a href="#l54.287"></a><span id="l54.287"> </span>
<a href="#l54.288"></a><span id="l54.288">   i = 0;</span>
<a href="#l54.289"></a><span id="l54.289">   hdrs-&gt;heads[i++] = hdrs-&gt;all_headers;</span>
<a href="#l54.290"></a><span id="l54.290">   s = hdrs-&gt;all_headers;</span>
<a href="#l54.291"></a><span id="l54.291"> </span>
<a href="#l54.292"></a><span id="l54.292" class="difflineminus">-  while (s &lt; end)</span>
<a href="#l54.293"></a><span id="l54.293" class="difflineminus">-  {</span>
<a href="#l54.294"></a><span id="l54.294" class="difflineplus">+  while (s &lt; end) {</span>
<a href="#l54.295"></a><span id="l54.295">   SEARCH_NEWLINE:</span>
<a href="#l54.296"></a><span id="l54.296" class="difflineminus">-    while (s &lt; end &amp;&amp; *s != '\r' &amp;&amp; *s != '\n')</span>
<a href="#l54.297"></a><span id="l54.297" class="difflineminus">-      s++;</span>
<a href="#l54.298"></a><span id="l54.298" class="difflineplus">+    while (s &lt; end &amp;&amp; *s != '\r' &amp;&amp; *s != '\n') s++;</span>
<a href="#l54.299"></a><span id="l54.299"> </span>
<a href="#l54.300"></a><span id="l54.300" class="difflineminus">-    if (s &gt;= end)</span>
<a href="#l54.301"></a><span id="l54.301" class="difflineminus">-      break;</span>
<a href="#l54.302"></a><span id="l54.302" class="difflineplus">+    if (s &gt;= end) break;</span>
<a href="#l54.303"></a><span id="l54.303"> </span>
<a href="#l54.304"></a><span id="l54.304">     /* If &quot;\r\n &quot; or &quot;\r\n\t&quot; is next, that doesn't terminate the header. */</span>
<a href="#l54.305"></a><span id="l54.305" class="difflineminus">-    else if (s+2 &lt; end &amp;&amp;</span>
<a href="#l54.306"></a><span id="l54.306" class="difflineminus">-         (s[0] == '\r'  &amp;&amp; s[1] == '\n') &amp;&amp;</span>
<a href="#l54.307"></a><span id="l54.307" class="difflineminus">-         (s[2] == ' ' || s[2] == '\t'))</span>
<a href="#l54.308"></a><span id="l54.308" class="difflineminus">-    {</span>
<a href="#l54.309"></a><span id="l54.309" class="difflineplus">+    else if (s + 2 &lt; end &amp;&amp; (s[0] == '\r' &amp;&amp; s[1] == '\n') &amp;&amp;</span>
<a href="#l54.310"></a><span id="l54.310" class="difflineplus">+             (s[2] == ' ' || s[2] == '\t')) {</span>
<a href="#l54.311"></a><span id="l54.311">       s += 3;</span>
<a href="#l54.312"></a><span id="l54.312">       goto SEARCH_NEWLINE;</span>
<a href="#l54.313"></a><span id="l54.313">     }</span>
<a href="#l54.314"></a><span id="l54.314">     /* If &quot;\r &quot; or &quot;\r\t&quot; or &quot;\n &quot; or &quot;\n\t&quot; is next, that doesn't terminate</span>
<a href="#l54.315"></a><span id="l54.315">      the header either. */</span>
<a href="#l54.316"></a><span id="l54.316" class="difflineminus">-    else if (s+1 &lt; end &amp;&amp;</span>
<a href="#l54.317"></a><span id="l54.317" class="difflineminus">-         (s[0] == '\r'  || s[0] == '\n') &amp;&amp;</span>
<a href="#l54.318"></a><span id="l54.318" class="difflineminus">-         (s[1] == ' ' || s[1] == '\t'))</span>
<a href="#l54.319"></a><span id="l54.319" class="difflineminus">-    {</span>
<a href="#l54.320"></a><span id="l54.320" class="difflineplus">+    else if (s + 1 &lt; end &amp;&amp; (s[0] == '\r' || s[0] == '\n') &amp;&amp;</span>
<a href="#l54.321"></a><span id="l54.321" class="difflineplus">+             (s[1] == ' ' || s[1] == '\t')) {</span>
<a href="#l54.322"></a><span id="l54.322">       s += 2;</span>
<a href="#l54.323"></a><span id="l54.323">       goto SEARCH_NEWLINE;</span>
<a href="#l54.324"></a><span id="l54.324">     }</span>
<a href="#l54.325"></a><span id="l54.325"> </span>
<a href="#l54.326"></a><span id="l54.326">     /* At this point, `s' points before a header-terminating newline.</span>
<a href="#l54.327"></a><span id="l54.327">      Move past that newline, and store that new position in `heads'.</span>
<a href="#l54.328"></a><span id="l54.328">      */</span>
<a href="#l54.329"></a><span id="l54.329" class="difflineminus">-    if (*s == '\r')</span>
<a href="#l54.330"></a><span id="l54.330" class="difflineminus">-      s++;</span>
<a href="#l54.331"></a><span id="l54.331" class="difflineplus">+    if (*s == '\r') s++;</span>
<a href="#l54.332"></a><span id="l54.332"> </span>
<a href="#l54.333"></a><span id="l54.333" class="difflineminus">-    if (s &gt;= end)</span>
<a href="#l54.334"></a><span id="l54.334" class="difflineminus">-      break;</span>
<a href="#l54.335"></a><span id="l54.335" class="difflineplus">+    if (s &gt;= end) break;</span>
<a href="#l54.336"></a><span id="l54.336"> </span>
<a href="#l54.337"></a><span id="l54.337" class="difflineminus">-    if (*s == '\n')</span>
<a href="#l54.338"></a><span id="l54.338" class="difflineminus">-      s++;</span>
<a href="#l54.339"></a><span id="l54.339" class="difflineplus">+    if (*s == '\n') s++;</span>
<a href="#l54.340"></a><span id="l54.340"> </span>
<a href="#l54.341"></a><span id="l54.341" class="difflineminus">-    if (s &lt; end)</span>
<a href="#l54.342"></a><span id="l54.342" class="difflineminus">-    {</span>
<a href="#l54.343"></a><span id="l54.343" class="difflineminus">-      NS_ASSERTION(! (i &gt; hdrs-&gt;heads_size), &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l54.344"></a><span id="l54.344" class="difflineminus">-      if (i &gt; hdrs-&gt;heads_size)</span>
<a href="#l54.345"></a><span id="l54.345" class="difflineminus">-        return -1;</span>
<a href="#l54.346"></a><span id="l54.346" class="difflineplus">+    if (s &lt; end) {</span>
<a href="#l54.347"></a><span id="l54.347" class="difflineplus">+      NS_ASSERTION(!(i &gt; hdrs-&gt;heads_size),</span>
<a href="#l54.348"></a><span id="l54.348" class="difflineplus">+                   &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l54.349"></a><span id="l54.349" class="difflineplus">+      if (i &gt; hdrs-&gt;heads_size) return -1;</span>
<a href="#l54.350"></a><span id="l54.350">       hdrs-&gt;heads[i++] = s;</span>
<a href="#l54.351"></a><span id="l54.351">     }</span>
<a href="#l54.352"></a><span id="l54.352">   }</span>
<a href="#l54.353"></a><span id="l54.353"> </span>
<a href="#l54.354"></a><span id="l54.354">   return 0;</span>
<a href="#l54.355"></a><span id="l54.355"> }</span>
<a href="#l54.356"></a><span id="l54.356"> </span>
<a href="#l54.357"></a><span id="l54.357" class="difflineminus">-char *</span>
<a href="#l54.358"></a><span id="l54.358" class="difflineminus">-MimeHeaders_get (MimeHeaders *hdrs, const char *header_name,</span>
<a href="#l54.359"></a><span id="l54.359" class="difflineminus">-         bool strip_p, bool all_p)</span>
<a href="#l54.360"></a><span id="l54.360" class="difflineminus">-{</span>
<a href="#l54.361"></a><span id="l54.361" class="difflineplus">+char *MimeHeaders_get(MimeHeaders *hdrs, const char *header_name, bool strip_p,</span>
<a href="#l54.362"></a><span id="l54.362" class="difflineplus">+                      bool all_p) {</span>
<a href="#l54.363"></a><span id="l54.363">   int i;</span>
<a href="#l54.364"></a><span id="l54.364">   int name_length;</span>
<a href="#l54.365"></a><span id="l54.365">   char *result = 0;</span>
<a href="#l54.366"></a><span id="l54.366"> </span>
<a href="#l54.367"></a><span id="l54.367">   if (!hdrs) return 0;</span>
<a href="#l54.368"></a><span id="l54.368">   NS_ASSERTION(header_name, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l54.369"></a><span id="l54.369">   if (!header_name) return 0;</span>
<a href="#l54.370"></a><span id="l54.370"> </span>
<a href="#l54.371"></a><span id="l54.371" class="difflineat">@@ -319,335 +278,304 @@ MimeHeaders_get (MimeHeaders *hdrs, cons</span>
<a href="#l54.372"></a><span id="l54.372"> </span>
<a href="#l54.373"></a><span id="l54.373">   /* One shouldn't be trying to read headers when one hasn't finished</span>
<a href="#l54.374"></a><span id="l54.374">    parsing them yet... but this can happen if the message ended</span>
<a href="#l54.375"></a><span id="l54.375">    prematurely, and has no body at all (as opposed to a null body,</span>
<a href="#l54.376"></a><span id="l54.376">    which is more normal.)   So, if we try to read from the headers,</span>
<a href="#l54.377"></a><span id="l54.377">    let's assume that the headers are now finished.  If they aren't</span>
<a href="#l54.378"></a><span id="l54.378">    in fact finished, then a later attempt to write to them will assert.</span>
<a href="#l54.379"></a><span id="l54.379">    */</span>
<a href="#l54.380"></a><span id="l54.380" class="difflineminus">-  if (!hdrs-&gt;done_p)</span>
<a href="#l54.381"></a><span id="l54.381" class="difflineminus">-  {</span>
<a href="#l54.382"></a><span id="l54.382" class="difflineplus">+  if (!hdrs-&gt;done_p) {</span>
<a href="#l54.383"></a><span id="l54.383">     int status;</span>
<a href="#l54.384"></a><span id="l54.384">     hdrs-&gt;done_p = true;</span>
<a href="#l54.385"></a><span id="l54.385">     status = MimeHeaders_build_heads_list(hdrs);</span>
<a href="#l54.386"></a><span id="l54.386">     if (status &lt; 0) return 0;</span>
<a href="#l54.387"></a><span id="l54.387">   }</span>
<a href="#l54.388"></a><span id="l54.388"> </span>
<a href="#l54.389"></a><span id="l54.389" class="difflineminus">-  if (!hdrs-&gt;heads)    /* Must not have been any headers. */</span>
<a href="#l54.390"></a><span id="l54.390" class="difflineplus">+  if (!hdrs-&gt;heads) /* Must not have been any headers. */</span>
<a href="#l54.391"></a><span id="l54.391">   {</span>
<a href="#l54.392"></a><span id="l54.392" class="difflineminus">-    NS_ASSERTION(hdrs-&gt;all_headers_fp == 0, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l54.393"></a><span id="l54.393" class="difflineplus">+    NS_ASSERTION(hdrs-&gt;all_headers_fp == 0,</span>
<a href="#l54.394"></a><span id="l54.394" class="difflineplus">+                 &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l54.395"></a><span id="l54.395">     return 0;</span>
<a href="#l54.396"></a><span id="l54.396">   }</span>
<a href="#l54.397"></a><span id="l54.397"> </span>
<a href="#l54.398"></a><span id="l54.398">   name_length = strlen(header_name);</span>
<a href="#l54.399"></a><span id="l54.399"> </span>
<a href="#l54.400"></a><span id="l54.400" class="difflineminus">-  for (i = 0; i &lt; hdrs-&gt;heads_size; i++)</span>
<a href="#l54.401"></a><span id="l54.401" class="difflineminus">-  {</span>
<a href="#l54.402"></a><span id="l54.402" class="difflineplus">+  for (i = 0; i &lt; hdrs-&gt;heads_size; i++) {</span>
<a href="#l54.403"></a><span id="l54.403">     char *head = hdrs-&gt;heads[i];</span>
<a href="#l54.404"></a><span id="l54.404" class="difflineminus">-    char *end = (i == hdrs-&gt;heads_size-1</span>
<a href="#l54.405"></a><span id="l54.405" class="difflineminus">-           ? hdrs-&gt;all_headers + hdrs-&gt;all_headers_fp</span>
<a href="#l54.406"></a><span id="l54.406" class="difflineminus">-           : hdrs-&gt;heads[i+1]);</span>
<a href="#l54.407"></a><span id="l54.407" class="difflineplus">+    char *end =</span>
<a href="#l54.408"></a><span id="l54.408" class="difflineplus">+        (i == hdrs-&gt;heads_size - 1 ? hdrs-&gt;all_headers + hdrs-&gt;all_headers_fp</span>
<a href="#l54.409"></a><span id="l54.409" class="difflineplus">+                                   : hdrs-&gt;heads[i + 1]);</span>
<a href="#l54.410"></a><span id="l54.410">     char *colon, *ocolon;</span>
<a href="#l54.411"></a><span id="l54.411"> </span>
<a href="#l54.412"></a><span id="l54.412">     NS_ASSERTION(head, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l54.413"></a><span id="l54.413">     if (!head) continue;</span>
<a href="#l54.414"></a><span id="l54.414"> </span>
<a href="#l54.415"></a><span id="l54.415">     /* Quick hack to skip over BSD Mailbox delimiter. */</span>
<a href="#l54.416"></a><span id="l54.416" class="difflineminus">-    if (i == 0 &amp;&amp; head[0] == 'F' &amp;&amp; !strncmp(head, &quot;From &quot;, 5))</span>
<a href="#l54.417"></a><span id="l54.417" class="difflineminus">-    continue;</span>
<a href="#l54.418"></a><span id="l54.418" class="difflineplus">+    if (i == 0 &amp;&amp; head[0] == 'F' &amp;&amp; !strncmp(head, &quot;From &quot;, 5)) continue;</span>
<a href="#l54.419"></a><span id="l54.419"> </span>
<a href="#l54.420"></a><span id="l54.420">     /* Find the colon. */</span>
<a href="#l54.421"></a><span id="l54.421">     for (colon = head; colon &lt; end; colon++)</span>
<a href="#l54.422"></a><span id="l54.422" class="difflineminus">-    if (*colon == ':') break;</span>
<a href="#l54.423"></a><span id="l54.423" class="difflineplus">+      if (*colon == ':') break;</span>
<a href="#l54.424"></a><span id="l54.424"> </span>
<a href="#l54.425"></a><span id="l54.425">     if (colon &gt;= end) continue;</span>
<a href="#l54.426"></a><span id="l54.426"> </span>
<a href="#l54.427"></a><span id="l54.427">     /* Back up over whitespace before the colon. */</span>
<a href="#l54.428"></a><span id="l54.428">     ocolon = colon;</span>
<a href="#l54.429"></a><span id="l54.429">     for (; colon &gt; head &amp;&amp; IS_SPACE(colon[-1]); colon--)</span>
<a href="#l54.430"></a><span id="l54.430" class="difflineminus">-    ;</span>
<a href="#l54.431"></a><span id="l54.431" class="difflineplus">+      ;</span>
<a href="#l54.432"></a><span id="l54.432"> </span>
<a href="#l54.433"></a><span id="l54.433">     /* If the strings aren't the same length, it doesn't match. */</span>
<a href="#l54.434"></a><span id="l54.434" class="difflineminus">-    if (name_length != colon - head )</span>
<a href="#l54.435"></a><span id="l54.435" class="difflineminus">-    continue;</span>
<a href="#l54.436"></a><span id="l54.436" class="difflineplus">+    if (name_length != colon - head) continue;</span>
<a href="#l54.437"></a><span id="l54.437"> </span>
<a href="#l54.438"></a><span id="l54.438">     /* If the strings differ, it doesn't match. */</span>
<a href="#l54.439"></a><span id="l54.439" class="difflineminus">-    if (PL_strncasecmp(header_name, head, name_length))</span>
<a href="#l54.440"></a><span id="l54.440" class="difflineminus">-    continue;</span>
<a href="#l54.441"></a><span id="l54.441" class="difflineplus">+    if (PL_strncasecmp(header_name, head, name_length)) continue;</span>
<a href="#l54.442"></a><span id="l54.442"> </span>
<a href="#l54.443"></a><span id="l54.443">     /* Otherwise, we've got a match. */</span>
<a href="#l54.444"></a><span id="l54.444">     {</span>
<a href="#l54.445"></a><span id="l54.445" class="difflineminus">-    char *contents = ocolon + 1;</span>
<a href="#l54.446"></a><span id="l54.446" class="difflineminus">-    char *s;</span>
<a href="#l54.447"></a><span id="l54.447" class="difflineplus">+      char *contents = ocolon + 1;</span>
<a href="#l54.448"></a><span id="l54.448" class="difflineplus">+      char *s;</span>
<a href="#l54.449"></a><span id="l54.449"> </span>
<a href="#l54.450"></a><span id="l54.450" class="difflineminus">-    /* Skip over whitespace after colon. */</span>
<a href="#l54.451"></a><span id="l54.451" class="difflineminus">-    while (contents &lt; end &amp;&amp; IS_SPACE(contents[0])) {</span>
<a href="#l54.452"></a><span id="l54.452" class="difflineminus">-      /* Mac or Unix style line break, followed by space or tab. */</span>
<a href="#l54.453"></a><span id="l54.453" class="difflineminus">-      if (contents &lt; (end - 1) &amp;&amp;</span>
<a href="#l54.454"></a><span id="l54.454" class="difflineminus">-         (contents[0] == '\r' || contents[0] == '\n') &amp;&amp;</span>
<a href="#l54.455"></a><span id="l54.455" class="difflineminus">-         (contents[1] == ' ' || contents[1] == '\t'))</span>
<a href="#l54.456"></a><span id="l54.456" class="difflineminus">-        contents += 2;</span>
<a href="#l54.457"></a><span id="l54.457" class="difflineminus">-      /* Windows style line break, followed by space or tab. */</span>
<a href="#l54.458"></a><span id="l54.458" class="difflineminus">-      else if (contents &lt; (end - 2) &amp;&amp;</span>
<a href="#l54.459"></a><span id="l54.459" class="difflineminus">-               contents[0] == '\r' &amp;&amp; contents[1] == '\n' &amp;&amp;</span>
<a href="#l54.460"></a><span id="l54.460" class="difflineminus">-              (contents[2] == ' ' || contents[2] == '\t'))</span>
<a href="#l54.461"></a><span id="l54.461" class="difflineminus">-        contents += 3;</span>
<a href="#l54.462"></a><span id="l54.462" class="difflineminus">-      /* Any space or tab. */</span>
<a href="#l54.463"></a><span id="l54.463" class="difflineminus">-      else if (contents[0] == ' ' || contents[0] == '\t')</span>
<a href="#l54.464"></a><span id="l54.464" class="difflineminus">-        contents++;</span>
<a href="#l54.465"></a><span id="l54.465" class="difflineminus">-      /* If we get here, it's because this character is a line break</span>
<a href="#l54.466"></a><span id="l54.466" class="difflineminus">-         followed by non-whitespace, or a line break followed by</span>
<a href="#l54.467"></a><span id="l54.467" class="difflineminus">-         another line break</span>
<a href="#l54.468"></a><span id="l54.468" class="difflineminus">-       */</span>
<a href="#l54.469"></a><span id="l54.469" class="difflineminus">-      else {</span>
<a href="#l54.470"></a><span id="l54.470" class="difflineminus">-        end = contents;</span>
<a href="#l54.471"></a><span id="l54.471" class="difflineminus">-        break;</span>
<a href="#l54.472"></a><span id="l54.472" class="difflineminus">-      }</span>
<a href="#l54.473"></a><span id="l54.473" class="difflineminus">-    }</span>
<a href="#l54.474"></a><span id="l54.474" class="difflineminus">-</span>
<a href="#l54.475"></a><span id="l54.475" class="difflineminus">-    /* If we're supposed to strip at the first token, pull `end' back to</span>
<a href="#l54.476"></a><span id="l54.476" class="difflineminus">-       the first whitespace or ';' after the first token.</span>
<a href="#l54.477"></a><span id="l54.477" class="difflineminus">-     */</span>
<a href="#l54.478"></a><span id="l54.478" class="difflineminus">-    if (strip_p)</span>
<a href="#l54.479"></a><span id="l54.479" class="difflineminus">-      {</span>
<a href="#l54.480"></a><span id="l54.480" class="difflineminus">-      for (s = contents;</span>
<a href="#l54.481"></a><span id="l54.481" class="difflineminus">-         s &lt; end &amp;&amp; *s != ';' &amp;&amp; *s != ',' &amp;&amp; !IS_SPACE(*s);</span>
<a href="#l54.482"></a><span id="l54.482" class="difflineminus">-         s++)</span>
<a href="#l54.483"></a><span id="l54.483" class="difflineminus">-        ;</span>
<a href="#l54.484"></a><span id="l54.484" class="difflineminus">-      end = s;</span>
<a href="#l54.485"></a><span id="l54.485" class="difflineplus">+      /* Skip over whitespace after colon. */</span>
<a href="#l54.486"></a><span id="l54.486" class="difflineplus">+      while (contents &lt; end &amp;&amp; IS_SPACE(contents[0])) {</span>
<a href="#l54.487"></a><span id="l54.487" class="difflineplus">+        /* Mac or Unix style line break, followed by space or tab. */</span>
<a href="#l54.488"></a><span id="l54.488" class="difflineplus">+        if (contents &lt; (end - 1) &amp;&amp;</span>
<a href="#l54.489"></a><span id="l54.489" class="difflineplus">+            (contents[0] == '\r' || contents[0] == '\n') &amp;&amp;</span>
<a href="#l54.490"></a><span id="l54.490" class="difflineplus">+            (contents[1] == ' ' || contents[1] == '\t'))</span>
<a href="#l54.491"></a><span id="l54.491" class="difflineplus">+          contents += 2;</span>
<a href="#l54.492"></a><span id="l54.492" class="difflineplus">+        /* Windows style line break, followed by space or tab. */</span>
<a href="#l54.493"></a><span id="l54.493" class="difflineplus">+        else if (contents &lt; (end - 2) &amp;&amp; contents[0] == '\r' &amp;&amp;</span>
<a href="#l54.494"></a><span id="l54.494" class="difflineplus">+                 contents[1] == '\n' &amp;&amp;</span>
<a href="#l54.495"></a><span id="l54.495" class="difflineplus">+                 (contents[2] == ' ' || contents[2] == '\t'))</span>
<a href="#l54.496"></a><span id="l54.496" class="difflineplus">+          contents += 3;</span>
<a href="#l54.497"></a><span id="l54.497" class="difflineplus">+        /* Any space or tab. */</span>
<a href="#l54.498"></a><span id="l54.498" class="difflineplus">+        else if (contents[0] == ' ' || contents[0] == '\t')</span>
<a href="#l54.499"></a><span id="l54.499" class="difflineplus">+          contents++;</span>
<a href="#l54.500"></a><span id="l54.500" class="difflineplus">+        /* If we get here, it's because this character is a line break</span>
<a href="#l54.501"></a><span id="l54.501" class="difflineplus">+           followed by non-whitespace, or a line break followed by</span>
<a href="#l54.502"></a><span id="l54.502" class="difflineplus">+           another line break</span>
<a href="#l54.503"></a><span id="l54.503" class="difflineplus">+         */</span>
<a href="#l54.504"></a><span id="l54.504" class="difflineplus">+        else {</span>
<a href="#l54.505"></a><span id="l54.505" class="difflineplus">+          end = contents;</span>
<a href="#l54.506"></a><span id="l54.506" class="difflineplus">+          break;</span>
<a href="#l54.507"></a><span id="l54.507" class="difflineplus">+        }</span>
<a href="#l54.508"></a><span id="l54.508">       }</span>
<a href="#l54.509"></a><span id="l54.509"> </span>
<a href="#l54.510"></a><span id="l54.510" class="difflineminus">-    /* Now allocate some storage.</span>
<a href="#l54.511"></a><span id="l54.511" class="difflineminus">-       If `result' already has a value, enlarge it.</span>
<a href="#l54.512"></a><span id="l54.512" class="difflineminus">-       Otherwise, just allocate a block.</span>
<a href="#l54.513"></a><span id="l54.513" class="difflineminus">-       `s' gets set to the place where the new data goes.</span>
<a href="#l54.514"></a><span id="l54.514" class="difflineminus">-     */</span>
<a href="#l54.515"></a><span id="l54.515" class="difflineminus">-    if (!result)</span>
<a href="#l54.516"></a><span id="l54.516" class="difflineminus">-      {</span>
<a href="#l54.517"></a><span id="l54.517" class="difflineminus">-      result = (char *) PR_MALLOC(end - contents + 1);</span>
<a href="#l54.518"></a><span id="l54.518" class="difflineminus">-      if (!result)</span>
<a href="#l54.519"></a><span id="l54.519" class="difflineminus">-        return 0;</span>
<a href="#l54.520"></a><span id="l54.520" class="difflineminus">-      s = result;</span>
<a href="#l54.521"></a><span id="l54.521" class="difflineminus">-      }</span>
<a href="#l54.522"></a><span id="l54.522" class="difflineminus">-    else</span>
<a href="#l54.523"></a><span id="l54.523" class="difflineminus">-      {</span>
<a href="#l54.524"></a><span id="l54.524" class="difflineminus">-      int32_t L = strlen(result);</span>
<a href="#l54.525"></a><span id="l54.525" class="difflineminus">-      s = (char *) PR_Realloc(result, (L + (end - contents + 10)));</span>
<a href="#l54.526"></a><span id="l54.526" class="difflineminus">-      if (!s)</span>
<a href="#l54.527"></a><span id="l54.527" class="difflineminus">-        {</span>
<a href="#l54.528"></a><span id="l54.528" class="difflineminus">-        PR_Free(result);</span>
<a href="#l54.529"></a><span id="l54.529" class="difflineminus">-        return 0;</span>
<a href="#l54.530"></a><span id="l54.530" class="difflineminus">-        }</span>
<a href="#l54.531"></a><span id="l54.531" class="difflineminus">-      result = s;</span>
<a href="#l54.532"></a><span id="l54.532" class="difflineminus">-      s = result + L;</span>
<a href="#l54.533"></a><span id="l54.533" class="difflineminus">-</span>
<a href="#l54.534"></a><span id="l54.534" class="difflineminus">-      /* Since we are tacking more data onto the end of the header</span>
<a href="#l54.535"></a><span id="l54.535" class="difflineminus">-         field, we must make it be a well-formed continuation line,</span>
<a href="#l54.536"></a><span id="l54.536" class="difflineminus">-                          by separating the old and new data with CR-LF-TAB.</span>
<a href="#l54.537"></a><span id="l54.537" class="difflineplus">+      /* If we're supposed to strip at the first token, pull `end' back to</span>
<a href="#l54.538"></a><span id="l54.538" class="difflineplus">+         the first whitespace or ';' after the first token.</span>
<a href="#l54.539"></a><span id="l54.539">        */</span>
<a href="#l54.540"></a><span id="l54.540" class="difflineminus">-      *s++ = ',';        /* #### only do this for addr headers? */</span>
<a href="#l54.541"></a><span id="l54.541" class="difflineminus">-      *s++ = MSG_LINEBREAK[0];</span>
<a href="#l54.542"></a><span id="l54.542" class="difflineminus">-# if (MSG_LINEBREAK_LEN == 2)</span>
<a href="#l54.543"></a><span id="l54.543" class="difflineminus">-      *s++ = MSG_LINEBREAK[1];</span>
<a href="#l54.544"></a><span id="l54.544" class="difflineminus">-# endif</span>
<a href="#l54.545"></a><span id="l54.545" class="difflineminus">-      *s++ = '\t';</span>
<a href="#l54.546"></a><span id="l54.546" class="difflineplus">+      if (strip_p) {</span>
<a href="#l54.547"></a><span id="l54.547" class="difflineplus">+        for (s = contents; s &lt; end &amp;&amp; *s != ';' &amp;&amp; *s != ',' &amp;&amp; !IS_SPACE(*s);</span>
<a href="#l54.548"></a><span id="l54.548" class="difflineplus">+             s++)</span>
<a href="#l54.549"></a><span id="l54.549" class="difflineplus">+          ;</span>
<a href="#l54.550"></a><span id="l54.550" class="difflineplus">+        end = s;</span>
<a href="#l54.551"></a><span id="l54.551">       }</span>
<a href="#l54.552"></a><span id="l54.552"> </span>
<a href="#l54.553"></a><span id="l54.553" class="difflineplus">+      /* Now allocate some storage.</span>
<a href="#l54.554"></a><span id="l54.554" class="difflineplus">+         If `result' already has a value, enlarge it.</span>
<a href="#l54.555"></a><span id="l54.555" class="difflineplus">+         Otherwise, just allocate a block.</span>
<a href="#l54.556"></a><span id="l54.556" class="difflineplus">+         `s' gets set to the place where the new data goes.</span>
<a href="#l54.557"></a><span id="l54.557" class="difflineplus">+       */</span>
<a href="#l54.558"></a><span id="l54.558" class="difflineplus">+      if (!result) {</span>
<a href="#l54.559"></a><span id="l54.559" class="difflineplus">+        result = (char *)PR_MALLOC(end - contents + 1);</span>
<a href="#l54.560"></a><span id="l54.560" class="difflineplus">+        if (!result) return 0;</span>
<a href="#l54.561"></a><span id="l54.561" class="difflineplus">+        s = result;</span>
<a href="#l54.562"></a><span id="l54.562" class="difflineplus">+      } else {</span>
<a href="#l54.563"></a><span id="l54.563" class="difflineplus">+        int32_t L = strlen(result);</span>
<a href="#l54.564"></a><span id="l54.564" class="difflineplus">+        s = (char *)PR_Realloc(result, (L + (end - contents + 10)));</span>
<a href="#l54.565"></a><span id="l54.565" class="difflineplus">+        if (!s) {</span>
<a href="#l54.566"></a><span id="l54.566" class="difflineplus">+          PR_Free(result);</span>
<a href="#l54.567"></a><span id="l54.567" class="difflineplus">+          return 0;</span>
<a href="#l54.568"></a><span id="l54.568" class="difflineplus">+        }</span>
<a href="#l54.569"></a><span id="l54.569" class="difflineplus">+        result = s;</span>
<a href="#l54.570"></a><span id="l54.570" class="difflineplus">+        s = result + L;</span>
<a href="#l54.571"></a><span id="l54.571"> </span>
<a href="#l54.572"></a><span id="l54.572" class="difflineminus">-    /* Take off trailing whitespace... */</span>
<a href="#l54.573"></a><span id="l54.573" class="difflineminus">-    while (end &gt; contents &amp;&amp; IS_SPACE(end[-1]))</span>
<a href="#l54.574"></a><span id="l54.574" class="difflineminus">-      end--;</span>
<a href="#l54.575"></a><span id="l54.575" class="difflineplus">+        /* Since we are tacking more data onto the end of the header</span>
<a href="#l54.576"></a><span id="l54.576" class="difflineplus">+           field, we must make it be a well-formed continuation line,</span>
<a href="#l54.577"></a><span id="l54.577" class="difflineplus">+                            by separating the old and new data with CR-LF-TAB.</span>
<a href="#l54.578"></a><span id="l54.578" class="difflineplus">+         */</span>
<a href="#l54.579"></a><span id="l54.579" class="difflineplus">+        *s++ = ','; /* #### only do this for addr headers? */</span>
<a href="#l54.580"></a><span id="l54.580" class="difflineplus">+        *s++ = MSG_LINEBREAK[0];</span>
<a href="#l54.581"></a><span id="l54.581" class="difflineplus">+#if (MSG_LINEBREAK_LEN == 2)</span>
<a href="#l54.582"></a><span id="l54.582" class="difflineplus">+        *s++ = MSG_LINEBREAK[1];</span>
<a href="#l54.583"></a><span id="l54.583" class="difflineplus">+#endif</span>
<a href="#l54.584"></a><span id="l54.584" class="difflineplus">+        *s++ = '\t';</span>
<a href="#l54.585"></a><span id="l54.585" class="difflineplus">+      }</span>
<a href="#l54.586"></a><span id="l54.586"> </span>
<a href="#l54.587"></a><span id="l54.587" class="difflineminus">-    if (end &gt; contents)</span>
<a href="#l54.588"></a><span id="l54.588" class="difflineminus">-      {</span>
<a href="#l54.589"></a><span id="l54.589" class="difflineplus">+      /* Take off trailing whitespace... */</span>
<a href="#l54.590"></a><span id="l54.590" class="difflineplus">+      while (end &gt; contents &amp;&amp; IS_SPACE(end[-1])) end--;</span>
<a href="#l54.591"></a><span id="l54.591" class="difflineplus">+</span>
<a href="#l54.592"></a><span id="l54.592" class="difflineplus">+      if (end &gt; contents) {</span>
<a href="#l54.593"></a><span id="l54.593">         /* Now copy the header's contents in...</span>
<a href="#l54.594"></a><span id="l54.594">          */</span>
<a href="#l54.595"></a><span id="l54.595">         memcpy(s, contents, end - contents);</span>
<a href="#l54.596"></a><span id="l54.596">         s[end - contents] = 0;</span>
<a href="#l54.597"></a><span id="l54.597" class="difflineminus">-      }</span>
<a href="#l54.598"></a><span id="l54.598" class="difflineminus">-    else</span>
<a href="#l54.599"></a><span id="l54.599" class="difflineminus">-      {</span>
<a href="#l54.600"></a><span id="l54.600" class="difflineplus">+      } else {</span>
<a href="#l54.601"></a><span id="l54.601">         s[0] = 0;</span>
<a href="#l54.602"></a><span id="l54.602">       }</span>
<a href="#l54.603"></a><span id="l54.603"> </span>
<a href="#l54.604"></a><span id="l54.604" class="difflineminus">-    /* If we only wanted the first occurrence of this header, we're done. */</span>
<a href="#l54.605"></a><span id="l54.605" class="difflineminus">-    if (!all_p) break;</span>
<a href="#l54.606"></a><span id="l54.606" class="difflineplus">+      /* If we only wanted the first occurrence of this header, we're done. */</span>
<a href="#l54.607"></a><span id="l54.607" class="difflineplus">+      if (!all_p) break;</span>
<a href="#l54.608"></a><span id="l54.608">     }</span>
<a href="#l54.609"></a><span id="l54.609">   }</span>
<a href="#l54.610"></a><span id="l54.610"> </span>
<a href="#l54.611"></a><span id="l54.611" class="difflineminus">-  if (result &amp;&amp; !*result)  /* empty string */</span>
<a href="#l54.612"></a><span id="l54.612" class="difflineplus">+  if (result &amp;&amp; !*result) /* empty string */</span>
<a href="#l54.613"></a><span id="l54.613">   {</span>
<a href="#l54.614"></a><span id="l54.614">     PR_Free(result);</span>
<a href="#l54.615"></a><span id="l54.615">     return 0;</span>
<a href="#l54.616"></a><span id="l54.616">   }</span>
<a href="#l54.617"></a><span id="l54.617"> </span>
<a href="#l54.618"></a><span id="l54.618">   return result;</span>
<a href="#l54.619"></a><span id="l54.619"> }</span>
<a href="#l54.620"></a><span id="l54.620"> </span>
<a href="#l54.621"></a><span id="l54.621" class="difflineminus">-char *</span>
<a href="#l54.622"></a><span id="l54.622" class="difflineminus">-MimeHeaders_get_parameter (const char *header_value, const char *parm_name,</span>
<a href="#l54.623"></a><span id="l54.623" class="difflineminus">-                           char **charset, char **language)</span>
<a href="#l54.624"></a><span id="l54.624" class="difflineminus">-{</span>
<a href="#l54.625"></a><span id="l54.625" class="difflineplus">+char *MimeHeaders_get_parameter(const char *header_value, const char *parm_name,</span>
<a href="#l54.626"></a><span id="l54.626" class="difflineplus">+                                char **charset, char **language) {</span>
<a href="#l54.627"></a><span id="l54.627">   if (!header_value || !parm_name || !*header_value || !*parm_name)</span>
<a href="#l54.628"></a><span id="l54.628">     return nullptr;</span>
<a href="#l54.629"></a><span id="l54.629"> </span>
<a href="#l54.630"></a><span id="l54.630">   nsresult rv;</span>
<a href="#l54.631"></a><span id="l54.631" class="difflineminus">-  nsCOMPtr &lt;nsIMIMEHeaderParam&gt; mimehdrpar =</span>
<a href="#l54.632"></a><span id="l54.632" class="difflineminus">-    do_GetService(NS_MIMEHEADERPARAM_CONTRACTID, &amp;rv);</span>
<a href="#l54.633"></a><span id="l54.633" class="difflineplus">+  nsCOMPtr&lt;nsIMIMEHeaderParam&gt; mimehdrpar =</span>
<a href="#l54.634"></a><span id="l54.634" class="difflineplus">+      do_GetService(NS_MIMEHEADERPARAM_CONTRACTID, &amp;rv);</span>
<a href="#l54.635"></a><span id="l54.635"> </span>
<a href="#l54.636"></a><span id="l54.636" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l54.637"></a><span id="l54.637" class="difflineminus">-    return nullptr;</span>
<a href="#l54.638"></a><span id="l54.638" class="difflineplus">+  if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l54.639"></a><span id="l54.639"> </span>
<a href="#l54.640"></a><span id="l54.640">   nsCString result;</span>
<a href="#l54.641"></a><span id="l54.641">   rv = mimehdrpar-&gt;GetParameterInternal(header_value, parm_name, charset,</span>
<a href="#l54.642"></a><span id="l54.642">                                         language, getter_Copies(result));</span>
<a href="#l54.643"></a><span id="l54.643">   return NS_SUCCEEDED(rv) ? PL_strdup(result.get()) : nullptr;</span>
<a href="#l54.644"></a><span id="l54.644"> }</span>
<a href="#l54.645"></a><span id="l54.645"> </span>
<a href="#l54.646"></a><span id="l54.646" class="difflineminus">-#define MimeHeaders_write(HDRS,OPT,DATA,LENGTH) \</span>
<a href="#l54.647"></a><span id="l54.647" class="difflineminus">-    MimeOptions_write((HDRS), (OPT), (DATA), (LENGTH), true);</span>
<a href="#l54.648"></a><span id="l54.648" class="difflineminus">-</span>
<a href="#l54.649"></a><span id="l54.649" class="difflineplus">+#define MimeHeaders_write(HDRS, OPT, DATA, LENGTH) \</span>
<a href="#l54.650"></a><span id="l54.650" class="difflineplus">+  MimeOptions_write((HDRS), (OPT), (DATA), (LENGTH), true);</span>
<a href="#l54.651"></a><span id="l54.651"> </span>
<a href="#l54.652"></a><span id="l54.652" class="difflineminus">-#define MimeHeaders_grow_obuffer(hdrs, desired_size) \</span>
<a href="#l54.653"></a><span id="l54.653" class="difflineminus">-  ((((long) (desired_size)) &gt;= ((long) (hdrs)-&gt;obuffer_size)) ? \</span>
<a href="#l54.654"></a><span id="l54.654" class="difflineminus">-   mime_GrowBuffer ((desired_size), sizeof(char), 255, \</span>
<a href="#l54.655"></a><span id="l54.655" class="difflineminus">-           &amp;(hdrs)-&gt;obuffer, &amp;(hdrs)-&gt;obuffer_size) \</span>
<a href="#l54.656"></a><span id="l54.656" class="difflineminus">-   : 0)</span>
<a href="#l54.657"></a><span id="l54.657" class="difflineplus">+#define MimeHeaders_grow_obuffer(hdrs, desired_size)                          \</span>
<a href="#l54.658"></a><span id="l54.658" class="difflineplus">+  ((((long)(desired_size)) &gt;= ((long)(hdrs)-&gt;obuffer_size))                   \</span>
<a href="#l54.659"></a><span id="l54.659" class="difflineplus">+       ? mime_GrowBuffer((desired_size), sizeof(char), 255, &amp;(hdrs)-&gt;obuffer, \</span>
<a href="#l54.660"></a><span id="l54.660" class="difflineplus">+                         &amp;(hdrs)-&gt;obuffer_size)                               \</span>
<a href="#l54.661"></a><span id="l54.661" class="difflineplus">+       : 0)</span>
<a href="#l54.662"></a><span id="l54.662"> </span>
<a href="#l54.663"></a><span id="l54.663" class="difflineminus">-int</span>
<a href="#l54.664"></a><span id="l54.664" class="difflineminus">-MimeHeaders_write_all_headers (MimeHeaders *hdrs, MimeDisplayOptions *opt, bool attachment)</span>
<a href="#l54.665"></a><span id="l54.665" class="difflineminus">-{</span>
<a href="#l54.666"></a><span id="l54.666" class="difflineplus">+int MimeHeaders_write_all_headers(MimeHeaders *hdrs, MimeDisplayOptions *opt,</span>
<a href="#l54.667"></a><span id="l54.667" class="difflineplus">+                                  bool attachment) {</span>
<a href="#l54.668"></a><span id="l54.668">   int status = 0;</span>
<a href="#l54.669"></a><span id="l54.669">   int i;</span>
<a href="#l54.670"></a><span id="l54.670">   bool wrote_any_p = false;</span>
<a href="#l54.671"></a><span id="l54.671"> </span>
<a href="#l54.672"></a><span id="l54.672">   NS_ASSERTION(hdrs, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l54.673"></a><span id="l54.673" class="difflineminus">-  if (!hdrs)</span>
<a href="#l54.674"></a><span id="l54.674" class="difflineminus">-    return -1;</span>
<a href="#l54.675"></a><span id="l54.675" class="difflineplus">+  if (!hdrs) return -1;</span>
<a href="#l54.676"></a><span id="l54.676"> </span>
<a href="#l54.677"></a><span id="l54.677">   /* One shouldn't be trying to read headers when one hasn't finished</span>
<a href="#l54.678"></a><span id="l54.678">      parsing them yet... but this can happen if the message ended</span>
<a href="#l54.679"></a><span id="l54.679">      prematurely, and has no body at all (as opposed to a null body,</span>
<a href="#l54.680"></a><span id="l54.680">      which is more normal.)   So, if we try to read from the headers,</span>
<a href="#l54.681"></a><span id="l54.681">      let's assume that the headers are now finished.  If they aren't</span>
<a href="#l54.682"></a><span id="l54.682">      in fact finished, then a later attempt to write to them will assert.</span>
<a href="#l54.683"></a><span id="l54.683">    */</span>
<a href="#l54.684"></a><span id="l54.684" class="difflineminus">-  if (!hdrs-&gt;done_p)</span>
<a href="#l54.685"></a><span id="l54.685" class="difflineminus">-  {</span>
<a href="#l54.686"></a><span id="l54.686" class="difflineplus">+  if (!hdrs-&gt;done_p) {</span>
<a href="#l54.687"></a><span id="l54.687">     hdrs-&gt;done_p = true;</span>
<a href="#l54.688"></a><span id="l54.688">     status = MimeHeaders_build_heads_list(hdrs);</span>
<a href="#l54.689"></a><span id="l54.689">     if (status &lt; 0) return 0;</span>
<a href="#l54.690"></a><span id="l54.690">   }</span>
<a href="#l54.691"></a><span id="l54.691"> </span>
<a href="#l54.692"></a><span id="l54.692">   char *charset = nullptr;</span>
<a href="#l54.693"></a><span id="l54.693" class="difflineminus">-  if (opt-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs)</span>
<a href="#l54.694"></a><span id="l54.694" class="difflineminus">-  {</span>
<a href="#l54.695"></a><span id="l54.695" class="difflineplus">+  if (opt-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs) {</span>
<a href="#l54.696"></a><span id="l54.696">     if (opt-&gt;override_charset)</span>
<a href="#l54.697"></a><span id="l54.697">       charset = PL_strdup(opt-&gt;default_charset);</span>
<a href="#l54.698"></a><span id="l54.698" class="difflineminus">-    else</span>
<a href="#l54.699"></a><span id="l54.699" class="difflineminus">-    {</span>
<a href="#l54.700"></a><span id="l54.700" class="difflineminus">-      char *contentType = MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l54.701"></a><span id="l54.701" class="difflineplus">+    else {</span>
<a href="#l54.702"></a><span id="l54.702" class="difflineplus">+      char *contentType =</span>
<a href="#l54.703"></a><span id="l54.703" class="difflineplus">+          MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l54.704"></a><span id="l54.704">       if (contentType)</span>
<a href="#l54.705"></a><span id="l54.705" class="difflineminus">-        charset = MimeHeaders_get_parameter(contentType, HEADER_PARM_CHARSET, nullptr, nullptr);</span>
<a href="#l54.706"></a><span id="l54.706" class="difflineplus">+        charset = MimeHeaders_get_parameter(contentType, HEADER_PARM_CHARSET,</span>
<a href="#l54.707"></a><span id="l54.707" class="difflineplus">+                                            nullptr, nullptr);</span>
<a href="#l54.708"></a><span id="l54.708">       PR_FREEIF(contentType);</span>
<a href="#l54.709"></a><span id="l54.709">     }</span>
<a href="#l54.710"></a><span id="l54.710">   }</span>
<a href="#l54.711"></a><span id="l54.711"> </span>
<a href="#l54.712"></a><span id="l54.712" class="difflineminus">-  for (i = 0; i &lt; hdrs-&gt;heads_size; i++)</span>
<a href="#l54.713"></a><span id="l54.713" class="difflineminus">-  {</span>
<a href="#l54.714"></a><span id="l54.714" class="difflineplus">+  for (i = 0; i &lt; hdrs-&gt;heads_size; i++) {</span>
<a href="#l54.715"></a><span id="l54.715">     char *head = hdrs-&gt;heads[i];</span>
<a href="#l54.716"></a><span id="l54.716" class="difflineminus">-    char *end = (i == hdrs-&gt;heads_size-1</span>
<a href="#l54.717"></a><span id="l54.717" class="difflineminus">-                      ? hdrs-&gt;all_headers + hdrs-&gt;all_headers_fp</span>
<a href="#l54.718"></a><span id="l54.718" class="difflineminus">-                      : hdrs-&gt;heads[i+1]);</span>
<a href="#l54.719"></a><span id="l54.719" class="difflineplus">+    char *end =</span>
<a href="#l54.720"></a><span id="l54.720" class="difflineplus">+        (i == hdrs-&gt;heads_size - 1 ? hdrs-&gt;all_headers + hdrs-&gt;all_headers_fp</span>
<a href="#l54.721"></a><span id="l54.721" class="difflineplus">+                                   : hdrs-&gt;heads[i + 1]);</span>
<a href="#l54.722"></a><span id="l54.722">     char *colon, *ocolon;</span>
<a href="#l54.723"></a><span id="l54.723">     char *contents = end;</span>
<a href="#l54.724"></a><span id="l54.724"> </span>
<a href="#l54.725"></a><span id="l54.725">     /* Hack for BSD Mailbox delimiter. */</span>
<a href="#l54.726"></a><span id="l54.726" class="difflineminus">-    if (i == 0 &amp;&amp; head[0] == 'F' &amp;&amp; !strncmp(head, &quot;From &quot;, 5))</span>
<a href="#l54.727"></a><span id="l54.727" class="difflineminus">-    {</span>
<a href="#l54.728"></a><span id="l54.728" class="difflineplus">+    if (i == 0 &amp;&amp; head[0] == 'F' &amp;&amp; !strncmp(head, &quot;From &quot;, 5)) {</span>
<a href="#l54.729"></a><span id="l54.729">       /* For now, we don't really want this header to be output so</span>
<a href="#l54.730"></a><span id="l54.730">          we are going to just continue */</span>
<a href="#l54.731"></a><span id="l54.731">       continue;</span>
<a href="#l54.732"></a><span id="l54.732">       /* colon = head + 4; contents = colon + 1; */</span>
<a href="#l54.733"></a><span id="l54.733" class="difflineminus">-    }</span>
<a href="#l54.734"></a><span id="l54.734" class="difflineminus">-    else</span>
<a href="#l54.735"></a><span id="l54.735" class="difflineminus">-    {</span>
<a href="#l54.736"></a><span id="l54.736" class="difflineplus">+    } else {</span>
<a href="#l54.737"></a><span id="l54.737">       /* Find the colon. */</span>
<a href="#l54.738"></a><span id="l54.738">       for (colon = head; colon &lt; end &amp;&amp; *colon != ':'; colon++)</span>
<a href="#l54.739"></a><span id="l54.739">         ;</span>
<a href="#l54.740"></a><span id="l54.740"> </span>
<a href="#l54.741"></a><span id="l54.741" class="difflineminus">-        /* Back up over whitespace before the colon. */</span>
<a href="#l54.742"></a><span id="l54.742" class="difflineminus">-        ocolon = colon;</span>
<a href="#l54.743"></a><span id="l54.743" class="difflineminus">-        for (; colon &gt; head &amp;&amp; IS_SPACE(colon[-1]); colon--)</span>
<a href="#l54.744"></a><span id="l54.744" class="difflineminus">-          ;</span>
<a href="#l54.745"></a><span id="l54.745" class="difflineplus">+      /* Back up over whitespace before the colon. */</span>
<a href="#l54.746"></a><span id="l54.746" class="difflineplus">+      ocolon = colon;</span>
<a href="#l54.747"></a><span id="l54.747" class="difflineplus">+      for (; colon &gt; head &amp;&amp; IS_SPACE(colon[-1]); colon--)</span>
<a href="#l54.748"></a><span id="l54.748" class="difflineplus">+        ;</span>
<a href="#l54.749"></a><span id="l54.749"> </span>
<a href="#l54.750"></a><span id="l54.750" class="difflineminus">-        contents = ocolon + 1;</span>
<a href="#l54.751"></a><span id="l54.751" class="difflineplus">+      contents = ocolon + 1;</span>
<a href="#l54.752"></a><span id="l54.752">     }</span>
<a href="#l54.753"></a><span id="l54.753"> </span>
<a href="#l54.754"></a><span id="l54.754">     /* Skip over whitespace after colon. */</span>
<a href="#l54.755"></a><span id="l54.755" class="difflineminus">-    while (contents &lt; end &amp;&amp; IS_SPACE(*contents))</span>
<a href="#l54.756"></a><span id="l54.756" class="difflineminus">-      contents++;</span>
<a href="#l54.757"></a><span id="l54.757" class="difflineplus">+    while (contents &lt; end &amp;&amp; IS_SPACE(*contents)) contents++;</span>
<a href="#l54.758"></a><span id="l54.758"> </span>
<a href="#l54.759"></a><span id="l54.759">     /* Take off trailing whitespace... */</span>
<a href="#l54.760"></a><span id="l54.760" class="difflineminus">-    while (end &gt; contents &amp;&amp; IS_SPACE(end[-1]))</span>
<a href="#l54.761"></a><span id="l54.761" class="difflineminus">-      end--;</span>
<a href="#l54.762"></a><span id="l54.762" class="difflineplus">+    while (end &gt; contents &amp;&amp; IS_SPACE(end[-1])) end--;</span>
<a href="#l54.763"></a><span id="l54.763"> </span>
<a href="#l54.764"></a><span id="l54.764">     nsAutoCString name(Substring(head, colon));</span>
<a href="#l54.765"></a><span id="l54.765">     nsAutoCString hdr_value;</span>
<a href="#l54.766"></a><span id="l54.766"> </span>
<a href="#l54.767"></a><span id="l54.767" class="difflineminus">-    if ( (end - contents) &gt; 0 )</span>
<a href="#l54.768"></a><span id="l54.768" class="difflineminus">-    {</span>
<a href="#l54.769"></a><span id="l54.769" class="difflineplus">+    if ((end - contents) &gt; 0) {</span>
<a href="#l54.770"></a><span id="l54.770">       hdr_value = Substring(contents, end);</span>
<a href="#l54.771"></a><span id="l54.771">     }</span>
<a href="#l54.772"></a><span id="l54.772"> </span>
<a href="#l54.773"></a><span id="l54.773">     // MW Fixme: more?</span>
<a href="#l54.774"></a><span id="l54.774" class="difflineminus">-    bool convert_charset_only =</span>
<a href="#l54.775"></a><span id="l54.775" class="difflineminus">-          MsgLowerCaseEqualsLiteral(name, &quot;to&quot;) || MsgLowerCaseEqualsLiteral(name, &quot;from&quot;) ||</span>
<a href="#l54.776"></a><span id="l54.776" class="difflineminus">-          MsgLowerCaseEqualsLiteral(name, &quot;cc&quot;) || MsgLowerCaseEqualsLiteral(name, &quot;bcc&quot;) ||</span>
<a href="#l54.777"></a><span id="l54.777" class="difflineminus">-          MsgLowerCaseEqualsLiteral(name, &quot;reply-to&quot;) || MsgLowerCaseEqualsLiteral(name, &quot;sender&quot;);</span>
<a href="#l54.778"></a><span id="l54.778" class="difflineplus">+    bool convert_charset_only = MsgLowerCaseEqualsLiteral(name, &quot;to&quot;) ||</span>
<a href="#l54.779"></a><span id="l54.779" class="difflineplus">+                                MsgLowerCaseEqualsLiteral(name, &quot;from&quot;) ||</span>
<a href="#l54.780"></a><span id="l54.780" class="difflineplus">+                                MsgLowerCaseEqualsLiteral(name, &quot;cc&quot;) ||</span>
<a href="#l54.781"></a><span id="l54.781" class="difflineplus">+                                MsgLowerCaseEqualsLiteral(name, &quot;bcc&quot;) ||</span>
<a href="#l54.782"></a><span id="l54.782" class="difflineplus">+                                MsgLowerCaseEqualsLiteral(name, &quot;reply-to&quot;) ||</span>
<a href="#l54.783"></a><span id="l54.783" class="difflineplus">+                                MsgLowerCaseEqualsLiteral(name, &quot;sender&quot;);</span>
<a href="#l54.784"></a><span id="l54.784">     MimeHeaders_convert_header_value(opt, hdr_value, convert_charset_only);</span>
<a href="#l54.785"></a><span id="l54.785" class="difflineminus">-    // if we're saving as html, we need to convert headers from utf8 to message charset, if any</span>
<a href="#l54.786"></a><span id="l54.786" class="difflineminus">-    if (opt-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs &amp;&amp; charset)</span>
<a href="#l54.787"></a><span id="l54.787" class="difflineminus">-    {</span>
<a href="#l54.788"></a><span id="l54.788" class="difflineplus">+    // if we're saving as html, we need to convert headers from utf8 to message</span>
<a href="#l54.789"></a><span id="l54.789" class="difflineplus">+    // charset, if any</span>
<a href="#l54.790"></a><span id="l54.790" class="difflineplus">+    if (opt-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs &amp;&amp; charset) {</span>
<a href="#l54.791"></a><span id="l54.791">       nsAutoCString convertedStr;</span>
<a href="#l54.792"></a><span id="l54.792" class="difflineminus">-      if (NS_SUCCEEDED(nsMsgI18NConvertFromUnicode(nsDependentCString(charset),</span>
<a href="#l54.793"></a><span id="l54.793" class="difflineminus">-                       NS_ConvertUTF8toUTF16(hdr_value),</span>
<a href="#l54.794"></a><span id="l54.794" class="difflineminus">-                       convertedStr)))</span>
<a href="#l54.795"></a><span id="l54.795" class="difflineminus">-      {</span>
<a href="#l54.796"></a><span id="l54.796" class="difflineplus">+      if (NS_SUCCEEDED(nsMsgI18NConvertFromUnicode(</span>
<a href="#l54.797"></a><span id="l54.797" class="difflineplus">+              nsDependentCString(charset), NS_ConvertUTF8toUTF16(hdr_value),</span>
<a href="#l54.798"></a><span id="l54.798" class="difflineplus">+              convertedStr))) {</span>
<a href="#l54.799"></a><span id="l54.799">         hdr_value = convertedStr;</span>
<a href="#l54.800"></a><span id="l54.800">       }</span>
<a href="#l54.801"></a><span id="l54.801">     }</span>
<a href="#l54.802"></a><span id="l54.802"> </span>
<a href="#l54.803"></a><span id="l54.803">     if (attachment) {</span>
<a href="#l54.804"></a><span id="l54.804" class="difflineminus">-      if (NS_FAILED(mimeEmitterAddAttachmentField(opt, name.get(), hdr_value.get())))</span>
<a href="#l54.805"></a><span id="l54.805" class="difflineplus">+      if (NS_FAILED(</span>
<a href="#l54.806"></a><span id="l54.806" class="difflineplus">+              mimeEmitterAddAttachmentField(opt, name.get(), hdr_value.get())))</span>
<a href="#l54.807"></a><span id="l54.807">         status = -1;</span>
<a href="#l54.808"></a><span id="l54.808" class="difflineminus">-    }</span>
<a href="#l54.809"></a><span id="l54.809" class="difflineminus">-    else {</span>
<a href="#l54.810"></a><span id="l54.810" class="difflineminus">-      if (NS_FAILED(mimeEmitterAddHeaderField(opt, name.get(), hdr_value.get())))</span>
<a href="#l54.811"></a><span id="l54.811" class="difflineplus">+    } else {</span>
<a href="#l54.812"></a><span id="l54.812" class="difflineplus">+      if (NS_FAILED(</span>
<a href="#l54.813"></a><span id="l54.813" class="difflineplus">+              mimeEmitterAddHeaderField(opt, name.get(), hdr_value.get())))</span>
<a href="#l54.814"></a><span id="l54.814">         status = -1;</span>
<a href="#l54.815"></a><span id="l54.815">     }</span>
<a href="#l54.816"></a><span id="l54.816"> </span>
<a href="#l54.817"></a><span id="l54.817">     if (status &lt; 0) return status;</span>
<a href="#l54.818"></a><span id="l54.818" class="difflineminus">-    if (!wrote_any_p)</span>
<a href="#l54.819"></a><span id="l54.819" class="difflineminus">-      wrote_any_p = (status &gt; 0);</span>
<a href="#l54.820"></a><span id="l54.820" class="difflineplus">+    if (!wrote_any_p) wrote_any_p = (status &gt; 0);</span>
<a href="#l54.821"></a><span id="l54.821">   }</span>
<a href="#l54.822"></a><span id="l54.822">   mimeEmitterAddAllHeaders(opt, hdrs-&gt;all_headers, hdrs-&gt;all_headers_fp);</span>
<a href="#l54.823"></a><span id="l54.823">   PR_FREEIF(charset);</span>
<a href="#l54.824"></a><span id="l54.824"> </span>
<a href="#l54.825"></a><span id="l54.825">   return 1;</span>
<a href="#l54.826"></a><span id="l54.826"> }</span>
<a href="#l54.827"></a><span id="l54.827"> </span>
<a href="#l54.828"></a><span id="l54.828"> /* Strip CR+LF runs within (original).</span>
<a href="#l54.829"></a><span id="l54.829">    Since the string at (original) can only shrink,</span>
<a href="#l54.830"></a><span id="l54.830">    this conversion is done in place. (original)</span>
<a href="#l54.831"></a><span id="l54.831">    is returned. */</span>
<a href="#l54.832"></a><span id="l54.832" class="difflineminus">-extern &quot;C&quot; char *</span>
<a href="#l54.833"></a><span id="l54.833" class="difflineminus">-MIME_StripContinuations(char *original)</span>
<a href="#l54.834"></a><span id="l54.834" class="difflineminus">-{</span>
<a href="#l54.835"></a><span id="l54.835" class="difflineplus">+extern &quot;C&quot; char *MIME_StripContinuations(char *original) {</span>
<a href="#l54.836"></a><span id="l54.836">   char *p1, *p2;</span>
<a href="#l54.837"></a><span id="l54.837"> </span>
<a href="#l54.838"></a><span id="l54.838">   /* If we were given a null string, return it as is */</span>
<a href="#l54.839"></a><span id="l54.839">   if (!original) return NULL;</span>
<a href="#l54.840"></a><span id="l54.840"> </span>
<a href="#l54.841"></a><span id="l54.841">   /* Start source and dest pointers at the beginning */</span>
<a href="#l54.842"></a><span id="l54.842">   p1 = p2 = original;</span>
<a href="#l54.843"></a><span id="l54.843"> </span>
<a href="#l54.844"></a><span id="l54.844" class="difflineat">@@ -666,228 +594,182 @@ MIME_StripContinuations(char *original)</span>
<a href="#l54.845"></a><span id="l54.845"> </span>
<a href="#l54.846"></a><span id="l54.846">   return original;</span>
<a href="#l54.847"></a><span id="l54.847"> }</span>
<a href="#l54.848"></a><span id="l54.848"> </span>
<a href="#l54.849"></a><span id="l54.849"> extern int16_t INTL_DefaultMailToWinCharSetID(int16_t csid);</span>
<a href="#l54.850"></a><span id="l54.850"> </span>
<a href="#l54.851"></a><span id="l54.851"> /* Given text purporting to be a qtext header value, strip backslashes that</span>
<a href="#l54.852"></a><span id="l54.852">   may be escaping other chars in the string. */</span>
<a href="#l54.853"></a><span id="l54.853" class="difflineminus">-char *</span>
<a href="#l54.854"></a><span id="l54.854" class="difflineminus">-mime_decode_filename(const char *name, const char *charset,</span>
<a href="#l54.855"></a><span id="l54.855" class="difflineminus">-                     MimeDisplayOptions *opt)</span>
<a href="#l54.856"></a><span id="l54.856" class="difflineminus">-{</span>
<a href="#l54.857"></a><span id="l54.857" class="difflineplus">+char *mime_decode_filename(const char *name, const char *charset,</span>
<a href="#l54.858"></a><span id="l54.858" class="difflineplus">+                           MimeDisplayOptions *opt) {</span>
<a href="#l54.859"></a><span id="l54.859">   nsresult rv;</span>
<a href="#l54.860"></a><span id="l54.860" class="difflineminus">-  nsCOMPtr &lt;nsIMIMEHeaderParam&gt; mimehdrpar =</span>
<a href="#l54.861"></a><span id="l54.861" class="difflineminus">-    do_GetService(NS_MIMEHEADERPARAM_CONTRACTID, &amp;rv);</span>
<a href="#l54.862"></a><span id="l54.862" class="difflineplus">+  nsCOMPtr&lt;nsIMIMEHeaderParam&gt; mimehdrpar =</span>
<a href="#l54.863"></a><span id="l54.863" class="difflineplus">+      do_GetService(NS_MIMEHEADERPARAM_CONTRACTID, &amp;rv);</span>
<a href="#l54.864"></a><span id="l54.864"> </span>
<a href="#l54.865"></a><span id="l54.865" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l54.866"></a><span id="l54.866" class="difflineminus">-    return nullptr;</span>
<a href="#l54.867"></a><span id="l54.867" class="difflineplus">+  if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l54.868"></a><span id="l54.868">   nsAutoCString result;</span>
<a href="#l54.869"></a><span id="l54.869">   rv = mimehdrpar-&gt;DecodeParameter(nsDependentCString(name), charset,</span>
<a href="#l54.870"></a><span id="l54.870">                                    opt ? opt-&gt;default_charset : nullptr,</span>
<a href="#l54.871"></a><span id="l54.871" class="difflineminus">-                                   opt ? opt-&gt;override_charset : false,</span>
<a href="#l54.872"></a><span id="l54.872" class="difflineminus">-                                   result);</span>
<a href="#l54.873"></a><span id="l54.873" class="difflineplus">+                                   opt ? opt-&gt;override_charset : false, result);</span>
<a href="#l54.874"></a><span id="l54.874">   return NS_SUCCEEDED(rv) ? PL_strdup(result.get()) : nullptr;</span>
<a href="#l54.875"></a><span id="l54.875"> }</span>
<a href="#l54.876"></a><span id="l54.876"> </span>
<a href="#l54.877"></a><span id="l54.877"> /* Pull the name out of some header or another.  Order is:</span>
<a href="#l54.878"></a><span id="l54.878">    Content-Disposition: XXX; filename=NAME (RFC 1521/1806)</span>
<a href="#l54.879"></a><span id="l54.879">    Content-Type: XXX; name=NAME (RFC 1341)</span>
<a href="#l54.880"></a><span id="l54.880">    Content-Name: NAME (no RFC, but seen to occur)</span>
<a href="#l54.881"></a><span id="l54.881">    X-Sun-Data-Name: NAME (no RFC, but used by MailTool)</span>
<a href="#l54.882"></a><span id="l54.882">  */</span>
<a href="#l54.883"></a><span id="l54.883" class="difflineminus">-char *</span>
<a href="#l54.884"></a><span id="l54.884" class="difflineminus">-MimeHeaders_get_name(MimeHeaders *hdrs, MimeDisplayOptions *opt)</span>
<a href="#l54.885"></a><span id="l54.885" class="difflineminus">-{</span>
<a href="#l54.886"></a><span id="l54.886" class="difflineplus">+char *MimeHeaders_get_name(MimeHeaders *hdrs, MimeDisplayOptions *opt) {</span>
<a href="#l54.887"></a><span id="l54.887">   char *s = 0, *name = 0, *cvt = 0;</span>
<a href="#l54.888"></a><span id="l54.888" class="difflineminus">-  char *charset = nullptr; // for RFC2231 support</span>
<a href="#l54.889"></a><span id="l54.889" class="difflineplus">+  char *charset = nullptr;  // for RFC2231 support</span>
<a href="#l54.890"></a><span id="l54.890"> </span>
<a href="#l54.891"></a><span id="l54.891">   s = MimeHeaders_get(hdrs, HEADER_CONTENT_DISPOSITION, false, false);</span>
<a href="#l54.892"></a><span id="l54.892" class="difflineminus">-  if (s)</span>
<a href="#l54.893"></a><span id="l54.893" class="difflineminus">-  {</span>
<a href="#l54.894"></a><span id="l54.894" class="difflineplus">+  if (s) {</span>
<a href="#l54.895"></a><span id="l54.895">     name = MimeHeaders_get_parameter(s, HEADER_PARM_FILENAME, &amp;charset, NULL);</span>
<a href="#l54.896"></a><span id="l54.896">     PR_Free(s);</span>
<a href="#l54.897"></a><span id="l54.897">   }</span>
<a href="#l54.898"></a><span id="l54.898"> </span>
<a href="#l54.899"></a><span id="l54.899" class="difflineminus">-  if (! name)</span>
<a href="#l54.900"></a><span id="l54.900" class="difflineminus">-  {</span>
<a href="#l54.901"></a><span id="l54.901" class="difflineplus">+  if (!name) {</span>
<a href="#l54.902"></a><span id="l54.902">     s = MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l54.903"></a><span id="l54.903" class="difflineminus">-    if (s)</span>
<a href="#l54.904"></a><span id="l54.904" class="difflineminus">-    {</span>
<a href="#l54.905"></a><span id="l54.905" class="difflineplus">+    if (s) {</span>
<a href="#l54.906"></a><span id="l54.906">       free(charset);</span>
<a href="#l54.907"></a><span id="l54.907"> </span>
<a href="#l54.908"></a><span id="l54.908">       name = MimeHeaders_get_parameter(s, HEADER_PARM_NAME, &amp;charset, NULL);</span>
<a href="#l54.909"></a><span id="l54.909">       PR_Free(s);</span>
<a href="#l54.910"></a><span id="l54.910">     }</span>
<a href="#l54.911"></a><span id="l54.911">   }</span>
<a href="#l54.912"></a><span id="l54.912"> </span>
<a href="#l54.913"></a><span id="l54.913" class="difflineminus">-  if (! name)</span>
<a href="#l54.914"></a><span id="l54.914" class="difflineminus">-    name = MimeHeaders_get (hdrs, HEADER_CONTENT_NAME, false, false);</span>
<a href="#l54.915"></a><span id="l54.915" class="difflineplus">+  if (!name) name = MimeHeaders_get(hdrs, HEADER_CONTENT_NAME, false, false);</span>
<a href="#l54.916"></a><span id="l54.916"> </span>
<a href="#l54.917"></a><span id="l54.917" class="difflineminus">-  if (! name)</span>
<a href="#l54.918"></a><span id="l54.918" class="difflineminus">-    name = MimeHeaders_get (hdrs, HEADER_X_SUN_DATA_NAME, false, false);</span>
<a href="#l54.919"></a><span id="l54.919" class="difflineplus">+  if (!name) name = MimeHeaders_get(hdrs, HEADER_X_SUN_DATA_NAME, false, false);</span>
<a href="#l54.920"></a><span id="l54.920"> </span>
<a href="#l54.921"></a><span id="l54.921" class="difflineminus">-  if (name)</span>
<a href="#l54.922"></a><span id="l54.922" class="difflineminus">-  {</span>
<a href="#l54.923"></a><span id="l54.923" class="difflineplus">+  if (name) {</span>
<a href="#l54.924"></a><span id="l54.924">     /* First remove continuation delimiters (CR+LF+space), then</span>
<a href="#l54.925"></a><span id="l54.925">        remove escape ('\\') characters, then attempt to decode</span>
<a href="#l54.926"></a><span id="l54.926">        mime-2 encoded-words. The latter two are done in</span>
<a href="#l54.927"></a><span id="l54.927">        mime_decode_filename.</span>
<a href="#l54.928"></a><span id="l54.928">     */</span>
<a href="#l54.929"></a><span id="l54.929">     MIME_StripContinuations(name);</span>
<a href="#l54.930"></a><span id="l54.930"> </span>
<a href="#l54.931"></a><span id="l54.931">     /* Argh. What we should do if we want to be robust is to decode qtext</span>
<a href="#l54.932"></a><span id="l54.932">        in all appropriate headers. Unfortunately, that would be too scary</span>
<a href="#l54.933"></a><span id="l54.933">        at this juncture. So just decode qtext/mime2 here. */</span>
<a href="#l54.934"></a><span id="l54.934">     cvt = mime_decode_filename(name, charset, opt);</span>
<a href="#l54.935"></a><span id="l54.935"> </span>
<a href="#l54.936"></a><span id="l54.936">     free(charset);</span>
<a href="#l54.937"></a><span id="l54.937"> </span>
<a href="#l54.938"></a><span id="l54.938" class="difflineminus">-    if (cvt &amp;&amp; cvt != name)</span>
<a href="#l54.939"></a><span id="l54.939" class="difflineminus">-    {</span>
<a href="#l54.940"></a><span id="l54.940" class="difflineplus">+    if (cvt &amp;&amp; cvt != name) {</span>
<a href="#l54.941"></a><span id="l54.941">       PR_Free(name);</span>
<a href="#l54.942"></a><span id="l54.942">       name = cvt;</span>
<a href="#l54.943"></a><span id="l54.943">     }</span>
<a href="#l54.944"></a><span id="l54.944">   }</span>
<a href="#l54.945"></a><span id="l54.945"> </span>
<a href="#l54.946"></a><span id="l54.946">   return name;</span>
<a href="#l54.947"></a><span id="l54.947"> }</span>
<a href="#l54.948"></a><span id="l54.948"> </span>
<a href="#l54.949"></a><span id="l54.949"> #ifdef XP_UNIX</span>
<a href="#l54.950"></a><span id="l54.950"> /* This piece of junk is so that I can use BBDB with Mozilla.</span>
<a href="#l54.951"></a><span id="l54.951">    = Put bbdb-srv.perl on your path.</span>
<a href="#l54.952"></a><span id="l54.952">    = Put bbdb-srv.el on your lisp path.</span>
<a href="#l54.953"></a><span id="l54.953">    = Make sure gnudoit (comes with xemacs) is on your path.</span>
<a href="#l54.954"></a><span id="l54.954">    = Put (gnuserv-start) in ~/.emacs</span>
<a href="#l54.955"></a><span id="l54.955">    = setenv NS_MSG_DISPLAY_HOOK bbdb-srv.perl</span>
<a href="#l54.956"></a><span id="l54.956">  */</span>
<a href="#l54.957"></a><span id="l54.957" class="difflineminus">-void</span>
<a href="#l54.958"></a><span id="l54.958" class="difflineminus">-MimeHeaders_do_unix_display_hook_hack(MimeHeaders *hdrs)</span>
<a href="#l54.959"></a><span id="l54.959" class="difflineminus">-{</span>
<a href="#l54.960"></a><span id="l54.960" class="difflineplus">+void MimeHeaders_do_unix_display_hook_hack(MimeHeaders *hdrs) {</span>
<a href="#l54.961"></a><span id="l54.961">   static const char *cmd = 0;</span>
<a href="#l54.962"></a><span id="l54.962" class="difflineminus">-  if (!cmd)</span>
<a href="#l54.963"></a><span id="l54.963" class="difflineminus">-  {</span>
<a href="#l54.964"></a><span id="l54.964" class="difflineminus">-  /* The first time we're invoked, look up the command in the</span>
<a href="#l54.965"></a><span id="l54.965" class="difflineminus">-    environment.  Use &quot;&quot; as the `no command' tag. */</span>
<a href="#l54.966"></a><span id="l54.966" class="difflineplus">+  if (!cmd) {</span>
<a href="#l54.967"></a><span id="l54.967" class="difflineplus">+    /* The first time we're invoked, look up the command in the</span>
<a href="#l54.968"></a><span id="l54.968" class="difflineplus">+      environment.  Use &quot;&quot; as the `no command' tag. */</span>
<a href="#l54.969"></a><span id="l54.969">     cmd = getenv(&quot;NS_MSG_DISPLAY_HOOK&quot;);</span>
<a href="#l54.970"></a><span id="l54.970" class="difflineminus">-    if (!cmd)</span>
<a href="#l54.971"></a><span id="l54.971" class="difflineminus">-      cmd = &quot;&quot;;</span>
<a href="#l54.972"></a><span id="l54.972" class="difflineplus">+    if (!cmd) cmd = &quot;&quot;;</span>
<a href="#l54.973"></a><span id="l54.973">   }</span>
<a href="#l54.974"></a><span id="l54.974"> </span>
<a href="#l54.975"></a><span id="l54.975">   /* Invoke &quot;cmd&quot; at the end of a pipe, and give it the headers on stdin.</span>
<a href="#l54.976"></a><span id="l54.976">    The command is expected to be safe from hostile input!!</span>
<a href="#l54.977"></a><span id="l54.977">   */</span>
<a href="#l54.978"></a><span id="l54.978" class="difflineminus">-  if (cmd &amp;&amp; *cmd)</span>
<a href="#l54.979"></a><span id="l54.979" class="difflineminus">-  {</span>
<a href="#l54.980"></a><span id="l54.980" class="difflineplus">+  if (cmd &amp;&amp; *cmd) {</span>
<a href="#l54.981"></a><span id="l54.981">     FILE *fp = popen(cmd, &quot;w&quot;);</span>
<a href="#l54.982"></a><span id="l54.982" class="difflineminus">-    if (fp)</span>
<a href="#l54.983"></a><span id="l54.983" class="difflineminus">-    {</span>
<a href="#l54.984"></a><span id="l54.984" class="difflineplus">+    if (fp) {</span>
<a href="#l54.985"></a><span id="l54.985">       mozilla::Unused &lt;&lt; fwrite(hdrs-&gt;all_headers, 1, hdrs-&gt;all_headers_fp, fp);</span>
<a href="#l54.986"></a><span id="l54.986">       pclose(fp);</span>
<a href="#l54.987"></a><span id="l54.987">     }</span>
<a href="#l54.988"></a><span id="l54.988">   }</span>
<a href="#l54.989"></a><span id="l54.989"> }</span>
<a href="#l54.990"></a><span id="l54.990"> #endif /* XP_UNIX */</span>
<a href="#l54.991"></a><span id="l54.991"> </span>
<a href="#l54.992"></a><span id="l54.992" class="difflineminus">-static void</span>
<a href="#l54.993"></a><span id="l54.993" class="difflineminus">-MimeHeaders_compact (MimeHeaders *hdrs)</span>
<a href="#l54.994"></a><span id="l54.994" class="difflineminus">-{</span>
<a href="#l54.995"></a><span id="l54.995" class="difflineplus">+static void MimeHeaders_compact(MimeHeaders *hdrs) {</span>
<a href="#l54.996"></a><span id="l54.996">   NS_ASSERTION(hdrs, &quot;1.22 &lt;rhp@netscape.com&gt; 22 Aug 1999 08:48&quot;);</span>
<a href="#l54.997"></a><span id="l54.997">   if (!hdrs) return;</span>
<a href="#l54.998"></a><span id="l54.998"> </span>
<a href="#l54.999"></a><span id="l54.999">   PR_FREEIF(hdrs-&gt;obuffer);</span>
<a href="#l54.1000"></a><span id="l54.1000">   hdrs-&gt;obuffer_fp = 0;</span>
<a href="#l54.1001"></a><span id="l54.1001">   hdrs-&gt;obuffer_size = 0;</span>
<a href="#l54.1002"></a><span id="l54.1002"> </span>
<a href="#l54.1003"></a><span id="l54.1003">   /* These really shouldn't have gotten out of whack again. */</span>
<a href="#l54.1004"></a><span id="l54.1004">   NS_ASSERTION(hdrs-&gt;all_headers_fp &lt;= hdrs-&gt;all_headers_size &amp;&amp;</span>
<a href="#l54.1005"></a><span id="l54.1005" class="difflineminus">-            hdrs-&gt;all_headers_fp + 100 &gt; hdrs-&gt;all_headers_size, &quot;1.22 &lt;rhp@netscape.com&gt; 22 Aug 1999 08:48&quot;);</span>
<a href="#l54.1006"></a><span id="l54.1006" class="difflineplus">+                   hdrs-&gt;all_headers_fp + 100 &gt; hdrs-&gt;all_headers_size,</span>
<a href="#l54.1007"></a><span id="l54.1007" class="difflineplus">+               &quot;1.22 &lt;rhp@netscape.com&gt; 22 Aug 1999 08:48&quot;);</span>
<a href="#l54.1008"></a><span id="l54.1008"> }</span>
<a href="#l54.1009"></a><span id="l54.1009"> </span>
<a href="#l54.1010"></a><span id="l54.1010"> /* Writes the headers as text/plain.</span>
<a href="#l54.1011"></a><span id="l54.1011">    This writes out a blank line after the headers, unless</span>
<a href="#l54.1012"></a><span id="l54.1012">    dont_write_content_type is true, in which case the header-block</span>
<a href="#l54.1013"></a><span id="l54.1013">    is not closed off, and none of the Content- headers are written.</span>
<a href="#l54.1014"></a><span id="l54.1014">  */</span>
<a href="#l54.1015"></a><span id="l54.1015" class="difflineminus">-int</span>
<a href="#l54.1016"></a><span id="l54.1016" class="difflineminus">-MimeHeaders_write_raw_headers (MimeHeaders *hdrs, MimeDisplayOptions *opt,</span>
<a href="#l54.1017"></a><span id="l54.1017" class="difflineminus">-                 bool dont_write_content_type)</span>
<a href="#l54.1018"></a><span id="l54.1018" class="difflineminus">-{</span>
<a href="#l54.1019"></a><span id="l54.1019" class="difflineplus">+int MimeHeaders_write_raw_headers(MimeHeaders *hdrs, MimeDisplayOptions *opt,</span>
<a href="#l54.1020"></a><span id="l54.1020" class="difflineplus">+                                  bool dont_write_content_type) {</span>
<a href="#l54.1021"></a><span id="l54.1021">   int status;</span>
<a href="#l54.1022"></a><span id="l54.1022"> </span>
<a href="#l54.1023"></a><span id="l54.1023" class="difflineminus">-  if (hdrs &amp;&amp; !hdrs-&gt;done_p)</span>
<a href="#l54.1024"></a><span id="l54.1024" class="difflineminus">-  {</span>
<a href="#l54.1025"></a><span id="l54.1025" class="difflineplus">+  if (hdrs &amp;&amp; !hdrs-&gt;done_p) {</span>
<a href="#l54.1026"></a><span id="l54.1026">     hdrs-&gt;done_p = true;</span>
<a href="#l54.1027"></a><span id="l54.1027">     status = MimeHeaders_build_heads_list(hdrs);</span>
<a href="#l54.1028"></a><span id="l54.1028">     if (status &lt; 0) return 0;</span>
<a href="#l54.1029"></a><span id="l54.1029">   }</span>
<a href="#l54.1030"></a><span id="l54.1030"> </span>
<a href="#l54.1031"></a><span id="l54.1031" class="difflineminus">-  if (!dont_write_content_type)</span>
<a href="#l54.1032"></a><span id="l54.1032" class="difflineminus">-  {</span>
<a href="#l54.1033"></a><span id="l54.1033" class="difflineplus">+  if (!dont_write_content_type) {</span>
<a href="#l54.1034"></a><span id="l54.1034">     char nl[] = MSG_LINEBREAK;</span>
<a href="#l54.1035"></a><span id="l54.1035" class="difflineminus">-    if (hdrs)</span>
<a href="#l54.1036"></a><span id="l54.1036" class="difflineminus">-    {</span>
<a href="#l54.1037"></a><span id="l54.1037" class="difflineminus">-      status = MimeHeaders_write(hdrs, opt, hdrs-&gt;all_headers,</span>
<a href="#l54.1038"></a><span id="l54.1038" class="difflineminus">-                                 hdrs-&gt;all_headers_fp);</span>
<a href="#l54.1039"></a><span id="l54.1039" class="difflineplus">+    if (hdrs) {</span>
<a href="#l54.1040"></a><span id="l54.1040" class="difflineplus">+      status =</span>
<a href="#l54.1041"></a><span id="l54.1041" class="difflineplus">+          MimeHeaders_write(hdrs, opt, hdrs-&gt;all_headers, hdrs-&gt;all_headers_fp);</span>
<a href="#l54.1042"></a><span id="l54.1042">       if (status &lt; 0) return status;</span>
<a href="#l54.1043"></a><span id="l54.1043">     }</span>
<a href="#l54.1044"></a><span id="l54.1044">     status = MimeHeaders_write(hdrs, opt, nl, strlen(nl));</span>
<a href="#l54.1045"></a><span id="l54.1045">     if (status &lt; 0) return status;</span>
<a href="#l54.1046"></a><span id="l54.1046" class="difflineminus">-  }</span>
<a href="#l54.1047"></a><span id="l54.1047" class="difflineminus">-  else if (hdrs)</span>
<a href="#l54.1048"></a><span id="l54.1048" class="difflineminus">-  {</span>
<a href="#l54.1049"></a><span id="l54.1049" class="difflineplus">+  } else if (hdrs) {</span>
<a href="#l54.1050"></a><span id="l54.1050">     int32_t i;</span>
<a href="#l54.1051"></a><span id="l54.1051" class="difflineminus">-    for (i = 0; i &lt; hdrs-&gt;heads_size; i++)</span>
<a href="#l54.1052"></a><span id="l54.1052" class="difflineminus">-    {</span>
<a href="#l54.1053"></a><span id="l54.1053" class="difflineplus">+    for (i = 0; i &lt; hdrs-&gt;heads_size; i++) {</span>
<a href="#l54.1054"></a><span id="l54.1054">       char *head = hdrs-&gt;heads[i];</span>
<a href="#l54.1055"></a><span id="l54.1055" class="difflineminus">-      char *end = (i == hdrs-&gt;heads_size-1</span>
<a href="#l54.1056"></a><span id="l54.1056" class="difflineminus">-             ? hdrs-&gt;all_headers + hdrs-&gt;all_headers_fp</span>
<a href="#l54.1057"></a><span id="l54.1057" class="difflineminus">-             : hdrs-&gt;heads[i+1]);</span>
<a href="#l54.1058"></a><span id="l54.1058" class="difflineplus">+      char *end =</span>
<a href="#l54.1059"></a><span id="l54.1059" class="difflineplus">+          (i == hdrs-&gt;heads_size - 1 ? hdrs-&gt;all_headers + hdrs-&gt;all_headers_fp</span>
<a href="#l54.1060"></a><span id="l54.1060" class="difflineplus">+                                     : hdrs-&gt;heads[i + 1]);</span>
<a href="#l54.1061"></a><span id="l54.1061"> </span>
<a href="#l54.1062"></a><span id="l54.1062">       NS_ASSERTION(head, &quot;1.22 &lt;rhp@netscape.com&gt; 22 Aug 1999 08:48&quot;);</span>
<a href="#l54.1063"></a><span id="l54.1063">       if (!head) continue;</span>
<a href="#l54.1064"></a><span id="l54.1064"> </span>
<a href="#l54.1065"></a><span id="l54.1065">       /* Don't write out any Content- header. */</span>
<a href="#l54.1066"></a><span id="l54.1066" class="difflineminus">-      if (!PL_strncasecmp(head, &quot;Content-&quot;, 8))</span>
<a href="#l54.1067"></a><span id="l54.1067" class="difflineminus">-      continue;</span>
<a href="#l54.1068"></a><span id="l54.1068" class="difflineplus">+      if (!PL_strncasecmp(head, &quot;Content-&quot;, 8)) continue;</span>
<a href="#l54.1069"></a><span id="l54.1069"> </span>
<a href="#l54.1070"></a><span id="l54.1070">       /* Write out this (possibly multi-line) header. */</span>
<a href="#l54.1071"></a><span id="l54.1071">       status = MimeHeaders_write(hdrs, opt, head, end - head);</span>
<a href="#l54.1072"></a><span id="l54.1072">       if (status &lt; 0) return status;</span>
<a href="#l54.1073"></a><span id="l54.1073">     }</span>
<a href="#l54.1074"></a><span id="l54.1074">   }</span>
<a href="#l54.1075"></a><span id="l54.1075"> </span>
<a href="#l54.1076"></a><span id="l54.1076" class="difflineminus">-  if (hdrs)</span>
<a href="#l54.1077"></a><span id="l54.1077" class="difflineminus">-    MimeHeaders_compact(hdrs);</span>
<a href="#l54.1078"></a><span id="l54.1078" class="difflineplus">+  if (hdrs) MimeHeaders_compact(hdrs);</span>
<a href="#l54.1079"></a><span id="l54.1079"> </span>
<a href="#l54.1080"></a><span id="l54.1080">   return 0;</span>
<a href="#l54.1081"></a><span id="l54.1081"> }</span>
<a href="#l54.1082"></a><span id="l54.1082"> </span>
<a href="#l54.1083"></a><span id="l54.1083"> // XXX Fix this XXX //</span>
<a href="#l54.1084"></a><span id="l54.1084" class="difflineminus">-char *</span>
<a href="#l54.1085"></a><span id="l54.1085" class="difflineminus">-MimeHeaders_open_crypto_stamp(void)</span>
<a href="#l54.1086"></a><span id="l54.1086" class="difflineminus">-{</span>
<a href="#l54.1087"></a><span id="l54.1087" class="difflineminus">-  return nullptr;</span>
<a href="#l54.1088"></a><span id="l54.1088" class="difflineminus">-}</span>
<a href="#l54.1089"></a><span id="l54.1089" class="difflineplus">+char *MimeHeaders_open_crypto_stamp(void) { return nullptr; }</span>
<a href="#l54.1090"></a><span id="l54.1090" class="difflineplus">+</span>
<a href="#l54.1091"></a><span id="l54.1091" class="difflineplus">+char *MimeHeaders_finish_open_crypto_stamp(void) { return nullptr; }</span>
<a href="#l54.1092"></a><span id="l54.1092"> </span>
<a href="#l54.1093"></a><span id="l54.1093" class="difflineminus">-char *</span>
<a href="#l54.1094"></a><span id="l54.1094" class="difflineminus">-MimeHeaders_finish_open_crypto_stamp(void)</span>
<a href="#l54.1095"></a><span id="l54.1095" class="difflineminus">-{</span>
<a href="#l54.1096"></a><span id="l54.1096" class="difflineplus">+char *MimeHeaders_close_crypto_stamp(void) { return nullptr; }</span>
<a href="#l54.1097"></a><span id="l54.1097" class="difflineplus">+</span>
<a href="#l54.1098"></a><span id="l54.1098" class="difflineplus">+char *MimeHeaders_make_crypto_stamp(bool encrypted_p, bool signed_p,</span>
<a href="#l54.1099"></a><span id="l54.1099" class="difflineplus">+                                    bool good_p, bool unverified_p,</span>
<a href="#l54.1100"></a><span id="l54.1100" class="difflineplus">+                                    bool close_parent_stamp_p,</span>
<a href="#l54.1101"></a><span id="l54.1101" class="difflineplus">+                                    const char *stamp_url) {</span>
<a href="#l54.1102"></a><span id="l54.1102">   return nullptr;</span>
<a href="#l54.1103"></a><span id="l54.1103"> }</span>
<a href="#l54.1104"></a><span id="l54.1104" class="difflineminus">-</span>
<a href="#l54.1105"></a><span id="l54.1105" class="difflineminus">-char *</span>
<a href="#l54.1106"></a><span id="l54.1106" class="difflineminus">-MimeHeaders_close_crypto_stamp(void)</span>
<a href="#l54.1107"></a><span id="l54.1107" class="difflineminus">-{</span>
<a href="#l54.1108"></a><span id="l54.1108" class="difflineminus">-  return nullptr;</span>
<a href="#l54.1109"></a><span id="l54.1109" class="difflineminus">-}</span>
<a href="#l54.1110"></a><span id="l54.1110" class="difflineminus">-</span>
<a href="#l54.1111"></a><span id="l54.1111" class="difflineminus">-char *</span>
<a href="#l54.1112"></a><span id="l54.1112" class="difflineminus">-MimeHeaders_make_crypto_stamp(bool encrypted_p,</span>
<a href="#l54.1113"></a><span id="l54.1113" class="difflineminus">-                              bool signed_p,</span>
<a href="#l54.1114"></a><span id="l54.1114" class="difflineminus">-                              bool good_p,</span>
<a href="#l54.1115"></a><span id="l54.1115" class="difflineminus">-                              bool unverified_p,</span>
<a href="#l54.1116"></a><span id="l54.1116" class="difflineminus">-                              bool close_parent_stamp_p,</span>
<a href="#l54.1117"></a><span id="l54.1117" class="difflineminus">-                              const char *stamp_url)</span>
<a href="#l54.1118"></a><span id="l54.1118" class="difflineminus">-{</span>
<a href="#l54.1119"></a><span id="l54.1119" class="difflineminus">-  return nullptr;</span>
<a href="#l54.1120"></a><span id="l54.1120" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/mime/src/mimehdrs.h</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/mime/src/mimehdrs.h</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -11,78 +11,75 @@</span>
<a href="#l55.4"></a><span id="l55.4"> /* This file defines the interface to message-header parsing and formatting</span>
<a href="#l55.5"></a><span id="l55.5">    code, including conversion to HTML. */</span>
<a href="#l55.6"></a><span id="l55.6"> </span>
<a href="#l55.7"></a><span id="l55.7"> /* Other structs defined later in this file.</span>
<a href="#l55.8"></a><span id="l55.8">  */</span>
<a href="#l55.9"></a><span id="l55.9"> </span>
<a href="#l55.10"></a><span id="l55.10"> /* Creation and destruction.</span>
<a href="#l55.11"></a><span id="l55.11">  */</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-extern MimeHeaders *MimeHeaders_new (void);</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineminus">-//extern void MimeHeaders_free (MimeHeaders *);</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineminus">-//extern MimeHeaders *MimeHeaders_copy (MimeHeaders *);</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineminus">-</span>
<a href="#l55.16"></a><span id="l55.16" class="difflineplus">+extern MimeHeaders *MimeHeaders_new(void);</span>
<a href="#l55.17"></a><span id="l55.17" class="difflineplus">+// extern void MimeHeaders_free (MimeHeaders *);</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineplus">+// extern MimeHeaders *MimeHeaders_copy (MimeHeaders *);</span>
<a href="#l55.19"></a><span id="l55.19"> </span>
<a href="#l55.20"></a><span id="l55.20"> /* Feed this method the raw data from which you would like a header</span>
<a href="#l55.21"></a><span id="l55.21">    block to be parsed, one line at a time.  Feed it a blank line when</span>
<a href="#l55.22"></a><span id="l55.22">    you're done.  Returns negative on allocation-related failure.</span>
<a href="#l55.23"></a><span id="l55.23">  */</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineminus">-extern int MimeHeaders_parse_line (const char *buffer, int32_t size,</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineminus">-                   MimeHeaders *hdrs);</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineminus">-</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineplus">+extern int MimeHeaders_parse_line(const char *buffer, int32_t size,</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineplus">+                                  MimeHeaders *hdrs);</span>
<a href="#l55.29"></a><span id="l55.29"> </span>
<a href="#l55.30"></a><span id="l55.30"> /* Converts a MimeHeaders object into HTML, by writing to the provided</span>
<a href="#l55.31"></a><span id="l55.31">    output function.</span>
<a href="#l55.32"></a><span id="l55.32">  */</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineminus">-extern int MimeHeaders_write_headers_html (MimeHeaders *hdrs,</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineminus">-                       MimeDisplayOptions *opt,</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineminus">-                       bool               attachment);</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineplus">+extern int MimeHeaders_write_headers_html(MimeHeaders *hdrs,</span>
<a href="#l55.37"></a><span id="l55.37" class="difflineplus">+                                          MimeDisplayOptions *opt,</span>
<a href="#l55.38"></a><span id="l55.38" class="difflineplus">+                                          bool attachment);</span>
<a href="#l55.39"></a><span id="l55.39"> </span>
<a href="#l55.40"></a><span id="l55.40"> /*</span>
<a href="#l55.41"></a><span id="l55.41">  * Writes all headers to the mime emitter.</span>
<a href="#l55.42"></a><span id="l55.42">  */</span>
<a href="#l55.43"></a><span id="l55.43" class="difflineminus">-extern int</span>
<a href="#l55.44"></a><span id="l55.44" class="difflineminus">-MimeHeaders_write_all_headers (MimeHeaders *, MimeDisplayOptions *, bool);</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineplus">+extern int MimeHeaders_write_all_headers(MimeHeaders *, MimeDisplayOptions *,</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineplus">+                                         bool);</span>
<a href="#l55.47"></a><span id="l55.47"> </span>
<a href="#l55.48"></a><span id="l55.48"> /* Writes the headers as text/plain.</span>
<a href="#l55.49"></a><span id="l55.49">    This writes out a blank line after the headers, unless</span>
<a href="#l55.50"></a><span id="l55.50">    dont_write_content_type is true, in which case the header-block</span>
<a href="#l55.51"></a><span id="l55.51">    is not closed off, and none of the Content- headers are written.</span>
<a href="#l55.52"></a><span id="l55.52">  */</span>
<a href="#l55.53"></a><span id="l55.53" class="difflineminus">-extern int MimeHeaders_write_raw_headers (MimeHeaders *hdrs,</span>
<a href="#l55.54"></a><span id="l55.54" class="difflineminus">-                      MimeDisplayOptions *opt,</span>
<a href="#l55.55"></a><span id="l55.55" class="difflineminus">-                      bool dont_write_content_type);</span>
<a href="#l55.56"></a><span id="l55.56" class="difflineminus">-</span>
<a href="#l55.57"></a><span id="l55.57" class="difflineplus">+extern int MimeHeaders_write_raw_headers(MimeHeaders *hdrs,</span>
<a href="#l55.58"></a><span id="l55.58" class="difflineplus">+                                         MimeDisplayOptions *opt,</span>
<a href="#l55.59"></a><span id="l55.59" class="difflineplus">+                                         bool dont_write_content_type);</span>
<a href="#l55.60"></a><span id="l55.60"> </span>
<a href="#l55.61"></a><span id="l55.61"> /* Some crypto-related HTML-generated utility routines.</span>
<a href="#l55.62"></a><span id="l55.62">  * XXX This may not be needed. XXX</span>
<a href="#l55.63"></a><span id="l55.63">  */</span>
<a href="#l55.64"></a><span id="l55.64"> extern char *MimeHeaders_open_crypto_stamp(void);</span>
<a href="#l55.65"></a><span id="l55.65"> extern char *MimeHeaders_finish_open_crypto_stamp(void);</span>
<a href="#l55.66"></a><span id="l55.66"> extern char *MimeHeaders_close_crypto_stamp(void);</span>
<a href="#l55.67"></a><span id="l55.67"> extern char *MimeHeaders_make_crypto_stamp(bool encrypted_p,</span>
<a href="#l55.68"></a><span id="l55.68"> </span>
<a href="#l55.69"></a><span id="l55.69" class="difflineminus">-   bool signed_p,</span>
<a href="#l55.70"></a><span id="l55.70" class="difflineplus">+                                           bool signed_p,</span>
<a href="#l55.71"></a><span id="l55.71"> </span>
<a href="#l55.72"></a><span id="l55.72" class="difflineminus">-   bool good_p,</span>
<a href="#l55.73"></a><span id="l55.73" class="difflineplus">+                                           bool good_p,</span>
<a href="#l55.74"></a><span id="l55.74"> </span>
<a href="#l55.75"></a><span id="l55.75" class="difflineminus">-   bool unverified_p,</span>
<a href="#l55.76"></a><span id="l55.76" class="difflineplus">+                                           bool unverified_p,</span>
<a href="#l55.77"></a><span id="l55.77"> </span>
<a href="#l55.78"></a><span id="l55.78" class="difflineminus">-   bool close_parent_stamp_p,</span>
<a href="#l55.79"></a><span id="l55.79" class="difflineplus">+                                           bool close_parent_stamp_p,</span>
<a href="#l55.80"></a><span id="l55.80"> </span>
<a href="#l55.81"></a><span id="l55.81" class="difflineminus">-   const char *stamp_url);</span>
<a href="#l55.82"></a><span id="l55.82" class="difflineplus">+                                           const char *stamp_url);</span>
<a href="#l55.83"></a><span id="l55.83"> </span>
<a href="#l55.84"></a><span id="l55.84"> /* Does all the heuristic silliness to find the filename in the given headers.</span>
<a href="#l55.85"></a><span id="l55.85">  */</span>
<a href="#l55.86"></a><span id="l55.86"> extern char *MimeHeaders_get_name(MimeHeaders *hdrs, MimeDisplayOptions *opt);</span>
<a href="#l55.87"></a><span id="l55.87"> </span>
<a href="#l55.88"></a><span id="l55.88" class="difflineminus">-extern char *mime_decode_filename(const char *name, const char* charset,</span>
<a href="#l55.89"></a><span id="l55.89" class="difflineplus">+extern char *mime_decode_filename(const char *name, const char *charset,</span>
<a href="#l55.90"></a><span id="l55.90">                                   MimeDisplayOptions *opt);</span>
<a href="#l55.91"></a><span id="l55.91"> </span>
<a href="#l55.92"></a><span id="l55.92" class="difflineminus">-extern &quot;C&quot;  char * MIME_StripContinuations(char *original);</span>
<a href="#l55.93"></a><span id="l55.93" class="difflineplus">+extern &quot;C&quot; char *MIME_StripContinuations(char *original);</span>
<a href="#l55.94"></a><span id="l55.94"> </span>
<a href="#l55.95"></a><span id="l55.95"> /**</span>
<a href="#l55.96"></a><span id="l55.96">  * Convert this value to a unicode string, based on the charset.</span>
<a href="#l55.97"></a><span id="l55.97">  */</span>
<a href="#l55.98"></a><span id="l55.98"> extern void MimeHeaders_convert_header_value(MimeDisplayOptions *opt,</span>
<a href="#l55.99"></a><span id="l55.99">                                              nsCString &amp;value,</span>
<a href="#l55.100"></a><span id="l55.100">                                              bool convert_charset_only);</span>
<a href="#l55.101"></a><span id="l55.101"> #endif /* _MIMEHDRS_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/mime/src/mimei.cpp</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/mime/src/mimei.cpp</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -1,57 +1,58 @@</span>
<a href="#l56.4"></a><span id="l56.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l56.5"></a><span id="l56.5">  *</span>
<a href="#l56.6"></a><span id="l56.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l56.7"></a><span id="l56.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l56.8"></a><span id="l56.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l56.9"></a><span id="l56.9" class="difflineminus">- * This Original Code has been modified by IBM Corporation. Modifications made by IBM</span>
<a href="#l56.10"></a><span id="l56.10" class="difflineminus">- * described herein are Copyright (c) International Business Machines Corporation, 2000.</span>
<a href="#l56.11"></a><span id="l56.11" class="difflineminus">- * Modifications to Mozilla code or documentation identified per MPL Section 3.3</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineplus">+ * This Original Code has been modified by IBM Corporation. Modifications made</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+ * by IBM described herein are Copyright (c) International Business Machines</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineplus">+ * Corporation, 2000. Modifications to Mozilla code or documentation identified</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+ * per MPL Section 3.3</span>
<a href="#l56.16"></a><span id="l56.16">  *</span>
<a href="#l56.17"></a><span id="l56.17">  * Date             Modified by     Description of modification</span>
<a href="#l56.18"></a><span id="l56.18">  * 04/20/2000       IBM Corp.      OS/2 VisualAge build.</span>
<a href="#l56.19"></a><span id="l56.19">  */</span>
<a href="#l56.20"></a><span id="l56.20"> </span>
<a href="#l56.21"></a><span id="l56.21"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l56.22"></a><span id="l56.22" class="difflineminus">-#include &quot;mimeobj.h&quot;   /*  MimeObject (abstract) */</span>
<a href="#l56.23"></a><span id="l56.23" class="difflineminus">-#include &quot;mimecont.h&quot;  /*   |--- MimeContainer (abstract) */</span>
<a href="#l56.24"></a><span id="l56.24" class="difflineminus">-#include &quot;mimemult.h&quot;  /*   |     |--- MimeMultipart (abstract) */</span>
<a href="#l56.25"></a><span id="l56.25" class="difflineminus">-#include &quot;mimemmix.h&quot;  /*   |     |     |--- MimeMultipartMixed */</span>
<a href="#l56.26"></a><span id="l56.26" class="difflineminus">-#include &quot;mimemdig.h&quot;  /*   |     |     |--- MimeMultipartDigest */</span>
<a href="#l56.27"></a><span id="l56.27" class="difflineminus">-#include &quot;mimempar.h&quot;  /*   |     |     |--- MimeMultipartParallel */</span>
<a href="#l56.28"></a><span id="l56.28" class="difflineminus">-#include &quot;mimemalt.h&quot;  /*   |     |     |--- MimeMultipartAlternative */</span>
<a href="#l56.29"></a><span id="l56.29" class="difflineminus">-#include &quot;mimemrel.h&quot;  /*   |     |     |--- MimeMultipartRelated */</span>
<a href="#l56.30"></a><span id="l56.30" class="difflineminus">-#include &quot;mimemapl.h&quot;  /*   |     |     |--- MimeMultipartAppleDouble */</span>
<a href="#l56.31"></a><span id="l56.31" class="difflineminus">-#include &quot;mimesun.h&quot;   /*   |     |     |--- MimeSunAttachment */</span>
<a href="#l56.32"></a><span id="l56.32" class="difflineminus">-#include &quot;mimemsig.h&quot;  /*   |     |     |--- MimeMultipartSigned (abstract)*/</span>
<a href="#l56.33"></a><span id="l56.33" class="difflineplus">+#include &quot;mimeobj.h&quot;  /*  MimeObject (abstract) */</span>
<a href="#l56.34"></a><span id="l56.34" class="difflineplus">+#include &quot;mimecont.h&quot; /*   |--- MimeContainer (abstract) */</span>
<a href="#l56.35"></a><span id="l56.35" class="difflineplus">+#include &quot;mimemult.h&quot; /*   |     |--- MimeMultipart (abstract) */</span>
<a href="#l56.36"></a><span id="l56.36" class="difflineplus">+#include &quot;mimemmix.h&quot; /*   |     |     |--- MimeMultipartMixed */</span>
<a href="#l56.37"></a><span id="l56.37" class="difflineplus">+#include &quot;mimemdig.h&quot; /*   |     |     |--- MimeMultipartDigest */</span>
<a href="#l56.38"></a><span id="l56.38" class="difflineplus">+#include &quot;mimempar.h&quot; /*   |     |     |--- MimeMultipartParallel */</span>
<a href="#l56.39"></a><span id="l56.39" class="difflineplus">+#include &quot;mimemalt.h&quot; /*   |     |     |--- MimeMultipartAlternative */</span>
<a href="#l56.40"></a><span id="l56.40" class="difflineplus">+#include &quot;mimemrel.h&quot; /*   |     |     |--- MimeMultipartRelated */</span>
<a href="#l56.41"></a><span id="l56.41" class="difflineplus">+#include &quot;mimemapl.h&quot; /*   |     |     |--- MimeMultipartAppleDouble */</span>
<a href="#l56.42"></a><span id="l56.42" class="difflineplus">+#include &quot;mimesun.h&quot;  /*   |     |     |--- MimeSunAttachment */</span>
<a href="#l56.43"></a><span id="l56.43" class="difflineplus">+#include &quot;mimemsig.h&quot; /*   |     |     |--- MimeMultipartSigned (abstract)*/</span>
<a href="#l56.44"></a><span id="l56.44"> #ifdef ENABLE_SMIME</span>
<a href="#l56.45"></a><span id="l56.45" class="difflineminus">-#include &quot;mimemcms.h&quot;  /*   |     |           |---MimeMultipartSignedCMS */</span>
<a href="#l56.46"></a><span id="l56.46" class="difflineplus">+#  include &quot;mimemcms.h&quot; /*   |     |           |---MimeMultipartSignedCMS */</span>
<a href="#l56.47"></a><span id="l56.47"> #endif</span>
<a href="#l56.48"></a><span id="l56.48" class="difflineminus">-#include &quot;mimecryp.h&quot;  /*   |     |--- MimeEncrypted (abstract) */</span>
<a href="#l56.49"></a><span id="l56.49" class="difflineplus">+#include &quot;mimecryp.h&quot; /*   |     |--- MimeEncrypted (abstract) */</span>
<a href="#l56.50"></a><span id="l56.50"> #ifdef ENABLE_SMIME</span>
<a href="#l56.51"></a><span id="l56.51" class="difflineminus">-#include &quot;mimecms.h&quot;   /*   |     |     |--- MimeEncryptedPKCS7 */</span>
<a href="#l56.52"></a><span id="l56.52" class="difflineplus">+#  include &quot;mimecms.h&quot; /*   |     |     |--- MimeEncryptedPKCS7 */</span>
<a href="#l56.53"></a><span id="l56.53"> #endif</span>
<a href="#l56.54"></a><span id="l56.54" class="difflineminus">-#include &quot;mimemsg.h&quot;   /*   |     |--- MimeMessage */</span>
<a href="#l56.55"></a><span id="l56.55" class="difflineminus">-#include &quot;mimeunty.h&quot;  /*   |     |--- MimeUntypedText */</span>
<a href="#l56.56"></a><span id="l56.56" class="difflineminus">-#include &quot;mimeleaf.h&quot;  /*   |--- MimeLeaf (abstract) */</span>
<a href="#l56.57"></a><span id="l56.57" class="difflineminus">-#include &quot;mimetext.h&quot;  /*   |     |--- MimeInlineText (abstract) */</span>
<a href="#l56.58"></a><span id="l56.58" class="difflineminus">-#include &quot;mimetpla.h&quot;  /*   |     |     |--- MimeInlineTextPlain */</span>
<a href="#l56.59"></a><span id="l56.59" class="difflineminus">-#include &quot;mimethpl.h&quot;  /*   |     |     |     |--- M.I.TextHTMLAsPlaintext */</span>
<a href="#l56.60"></a><span id="l56.60" class="difflineminus">-#include &quot;mimetpfl.h&quot;  /*   |     |     |--- MimeInlineTextPlainFlowed */</span>
<a href="#l56.61"></a><span id="l56.61" class="difflineminus">-#include &quot;mimethtm.h&quot;  /*   |     |     |--- MimeInlineTextHTML */</span>
<a href="#l56.62"></a><span id="l56.62" class="difflineminus">-#include &quot;mimethsa.h&quot;  /*   |     |     |     |--- M.I.TextHTMLSanitized */</span>
<a href="#l56.63"></a><span id="l56.63" class="difflineplus">+#include &quot;mimemsg.h&quot;  /*   |     |--- MimeMessage */</span>
<a href="#l56.64"></a><span id="l56.64" class="difflineplus">+#include &quot;mimeunty.h&quot; /*   |     |--- MimeUntypedText */</span>
<a href="#l56.65"></a><span id="l56.65" class="difflineplus">+#include &quot;mimeleaf.h&quot; /*   |--- MimeLeaf (abstract) */</span>
<a href="#l56.66"></a><span id="l56.66" class="difflineplus">+#include &quot;mimetext.h&quot; /*   |     |--- MimeInlineText (abstract) */</span>
<a href="#l56.67"></a><span id="l56.67" class="difflineplus">+#include &quot;mimetpla.h&quot; /*   |     |     |--- MimeInlineTextPlain */</span>
<a href="#l56.68"></a><span id="l56.68" class="difflineplus">+#include &quot;mimethpl.h&quot; /*   |     |     |     |--- M.I.TextHTMLAsPlaintext */</span>
<a href="#l56.69"></a><span id="l56.69" class="difflineplus">+#include &quot;mimetpfl.h&quot; /*   |     |     |--- MimeInlineTextPlainFlowed */</span>
<a href="#l56.70"></a><span id="l56.70" class="difflineplus">+#include &quot;mimethtm.h&quot; /*   |     |     |--- MimeInlineTextHTML */</span>
<a href="#l56.71"></a><span id="l56.71" class="difflineplus">+#include &quot;mimethsa.h&quot; /*   |     |     |     |--- M.I.TextHTMLSanitized */</span>
<a href="#l56.72"></a><span id="l56.72"> #include &quot;mimeTextHTMLParsed.h&quot; /*|     |     |--- M.I.TextHTMLParsed */</span>
<a href="#l56.73"></a><span id="l56.73" class="difflineminus">-#include &quot;mimetric.h&quot;  /*   |     |     |--- MimeInlineTextRichtext */</span>
<a href="#l56.74"></a><span id="l56.74" class="difflineminus">-#include &quot;mimetenr.h&quot;  /*   |     |     |     |--- MimeInlineTextEnriched */</span>
<a href="#l56.75"></a><span id="l56.75" class="difflineplus">+#include &quot;mimetric.h&quot;           /*   |     |     |--- MimeInlineTextRichtext */</span>
<a href="#l56.76"></a><span id="l56.76" class="difflineplus">+#include &quot;mimetenr.h&quot; /*   |     |     |     |--- MimeInlineTextEnriched */</span>
<a href="#l56.77"></a><span id="l56.77"> /* SUPPORTED VIA PLUGIN     |     |     |--- MimeInlineTextVCard */</span>
<a href="#l56.78"></a><span id="l56.78" class="difflineminus">-#include &quot;mimeiimg.h&quot;  /*   |     |--- MimeInlineImage */</span>
<a href="#l56.79"></a><span id="l56.79" class="difflineminus">-#include &quot;mimeeobj.h&quot;  /*   |     |--- MimeExternalObject */</span>
<a href="#l56.80"></a><span id="l56.80" class="difflineminus">-#include &quot;mimeebod.h&quot;  /*   |--- MimeExternalBody */</span>
<a href="#l56.81"></a><span id="l56.81" class="difflineminus">-                       /* If you add classes here,also add them to mimei.h */</span>
<a href="#l56.82"></a><span id="l56.82" class="difflineplus">+#include &quot;mimeiimg.h&quot; /*   |     |--- MimeInlineImage */</span>
<a href="#l56.83"></a><span id="l56.83" class="difflineplus">+#include &quot;mimeeobj.h&quot; /*   |     |--- MimeExternalObject */</span>
<a href="#l56.84"></a><span id="l56.84" class="difflineplus">+#include &quot;mimeebod.h&quot; /*   |--- MimeExternalBody */</span>
<a href="#l56.85"></a><span id="l56.85" class="difflineplus">+                      /* If you add classes here,also add them to mimei.h */</span>
<a href="#l56.86"></a><span id="l56.86"> #include &quot;prlog.h&quot;</span>
<a href="#l56.87"></a><span id="l56.87"> #include &quot;prmem.h&quot;</span>
<a href="#l56.88"></a><span id="l56.88"> #include &quot;prenv.h&quot;</span>
<a href="#l56.89"></a><span id="l56.89"> #include &quot;plstr.h&quot;</span>
<a href="#l56.90"></a><span id="l56.90"> #include &quot;prlink.h&quot;</span>
<a href="#l56.91"></a><span id="l56.91"> #include &quot;prprf.h&quot;</span>
<a href="#l56.92"></a><span id="l56.92"> #include &quot;mimecth.h&quot;</span>
<a href="#l56.93"></a><span id="l56.93"> #include &quot;mimebuf.h&quot;</span>
<a href="#l56.94"></a><span id="l56.94" class="difflineat">@@ -70,536 +71,482 @@</span>
<a href="#l56.95"></a><span id="l56.95"> #include &quot;imgLoader.h&quot;</span>
<a href="#l56.96"></a><span id="l56.96"> </span>
<a href="#l56.97"></a><span id="l56.97"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l56.98"></a><span id="l56.98"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l56.99"></a><span id="l56.99"> </span>
<a href="#l56.100"></a><span id="l56.100"> using namespace mozilla;</span>
<a href="#l56.101"></a><span id="l56.101"> </span>
<a href="#l56.102"></a><span id="l56.102"> // forward declaration</span>
<a href="#l56.103"></a><span id="l56.103" class="difflineminus">-void getMsgHdrForCurrentURL(MimeDisplayOptions *opts, nsIMsgDBHdr ** aMsgHdr);</span>
<a href="#l56.104"></a><span id="l56.104" class="difflineplus">+void getMsgHdrForCurrentURL(MimeDisplayOptions *opts, nsIMsgDBHdr **aMsgHdr);</span>
<a href="#l56.105"></a><span id="l56.105"> </span>
<a href="#l56.106"></a><span id="l56.106" class="difflineminus">-#define  IMAP_EXTERNAL_CONTENT_HEADER &quot;X-Mozilla-IMAP-Part&quot;</span>
<a href="#l56.107"></a><span id="l56.107" class="difflineminus">-#define  EXTERNAL_ATTACHMENT_URL_HEADER &quot;X-Mozilla-External-Attachment-URL&quot;</span>
<a href="#l56.108"></a><span id="l56.108" class="difflineplus">+#define IMAP_EXTERNAL_CONTENT_HEADER &quot;X-Mozilla-IMAP-Part&quot;</span>
<a href="#l56.109"></a><span id="l56.109" class="difflineplus">+#define EXTERNAL_ATTACHMENT_URL_HEADER &quot;X-Mozilla-External-Attachment-URL&quot;</span>
<a href="#l56.110"></a><span id="l56.110"> </span>
<a href="#l56.111"></a><span id="l56.111"> /* ==========================================================================</span>
<a href="#l56.112"></a><span id="l56.112">    Allocation and destruction</span>
<a href="#l56.113"></a><span id="l56.113">    ==========================================================================</span>
<a href="#l56.114"></a><span id="l56.114">  */</span>
<a href="#l56.115"></a><span id="l56.115"> static int mime_classinit(MimeObjectClass *clazz);</span>
<a href="#l56.116"></a><span id="l56.116"> </span>
<a href="#l56.117"></a><span id="l56.117"> /*</span>
<a href="#l56.118"></a><span id="l56.118">  * These are the necessary defines/variables for doing</span>
<a href="#l56.119"></a><span id="l56.119">  * content type handlers in external plugins.</span>
<a href="#l56.120"></a><span id="l56.120">  */</span>
<a href="#l56.121"></a><span id="l56.121"> typedef struct {</span>
<a href="#l56.122"></a><span id="l56.122" class="difflineminus">-  char        content_type[128];</span>
<a href="#l56.123"></a><span id="l56.123" class="difflineminus">-  bool        force_inline_display;</span>
<a href="#l56.124"></a><span id="l56.124" class="difflineplus">+  char content_type[128];</span>
<a href="#l56.125"></a><span id="l56.125" class="difflineplus">+  bool force_inline_display;</span>
<a href="#l56.126"></a><span id="l56.126"> } cthandler_struct;</span>
<a href="#l56.127"></a><span id="l56.127"> </span>
<a href="#l56.128"></a><span id="l56.128" class="difflineminus">-nsTArray&lt;cthandler_struct*&gt; *ctHandlerList = nullptr;</span>
<a href="#l56.129"></a><span id="l56.129" class="difflineplus">+nsTArray&lt;cthandler_struct *&gt; *ctHandlerList = nullptr;</span>
<a href="#l56.130"></a><span id="l56.130"> </span>
<a href="#l56.131"></a><span id="l56.131"> /*</span>
<a href="#l56.132"></a><span id="l56.132">  * This will return TRUE if the content_type is found in the</span>
<a href="#l56.133"></a><span id="l56.133">  * list, FALSE if it is not found.</span>
<a href="#l56.134"></a><span id="l56.134">  */</span>
<a href="#l56.135"></a><span id="l56.135" class="difflineminus">-bool</span>
<a href="#l56.136"></a><span id="l56.136" class="difflineminus">-find_content_type_attribs(const char *content_type,</span>
<a href="#l56.137"></a><span id="l56.137" class="difflineminus">-                          bool       *force_inline_display)</span>
<a href="#l56.138"></a><span id="l56.138" class="difflineminus">-{</span>
<a href="#l56.139"></a><span id="l56.139" class="difflineplus">+bool find_content_type_attribs(const char *content_type,</span>
<a href="#l56.140"></a><span id="l56.140" class="difflineplus">+                               bool *force_inline_display) {</span>
<a href="#l56.141"></a><span id="l56.141">   *force_inline_display = false;</span>
<a href="#l56.142"></a><span id="l56.142" class="difflineminus">-  if (!ctHandlerList)</span>
<a href="#l56.143"></a><span id="l56.143" class="difflineminus">-    return false;</span>
<a href="#l56.144"></a><span id="l56.144" class="difflineplus">+  if (!ctHandlerList) return false;</span>
<a href="#l56.145"></a><span id="l56.145"> </span>
<a href="#l56.146"></a><span id="l56.146" class="difflineminus">-  for (size_t i = 0; i &lt; ctHandlerList-&gt;Length(); i++)</span>
<a href="#l56.147"></a><span id="l56.147" class="difflineminus">-  {</span>
<a href="#l56.148"></a><span id="l56.148" class="difflineplus">+  for (size_t i = 0; i &lt; ctHandlerList-&gt;Length(); i++) {</span>
<a href="#l56.149"></a><span id="l56.149">     cthandler_struct *ptr = ctHandlerList-&gt;ElementAt(i);</span>
<a href="#l56.150"></a><span id="l56.150" class="difflineminus">-    if (PL_strcasecmp(content_type, ptr-&gt;content_type) == 0)</span>
<a href="#l56.151"></a><span id="l56.151" class="difflineminus">-    {</span>
<a href="#l56.152"></a><span id="l56.152" class="difflineplus">+    if (PL_strcasecmp(content_type, ptr-&gt;content_type) == 0) {</span>
<a href="#l56.153"></a><span id="l56.153">       *force_inline_display = ptr-&gt;force_inline_display;</span>
<a href="#l56.154"></a><span id="l56.154">       return true;</span>
<a href="#l56.155"></a><span id="l56.155">     }</span>
<a href="#l56.156"></a><span id="l56.156">   }</span>
<a href="#l56.157"></a><span id="l56.157"> </span>
<a href="#l56.158"></a><span id="l56.158">   return false;</span>
<a href="#l56.159"></a><span id="l56.159"> }</span>
<a href="#l56.160"></a><span id="l56.160"> </span>
<a href="#l56.161"></a><span id="l56.161" class="difflineminus">-void</span>
<a href="#l56.162"></a><span id="l56.162" class="difflineminus">-add_content_type_attribs(const char *content_type,</span>
<a href="#l56.163"></a><span id="l56.163" class="difflineminus">-                         contentTypeHandlerInitStruct  *ctHandlerInfo)</span>
<a href="#l56.164"></a><span id="l56.164" class="difflineminus">-{</span>
<a href="#l56.165"></a><span id="l56.165" class="difflineminus">-  cthandler_struct    *ptr = nullptr;</span>
<a href="#l56.166"></a><span id="l56.166" class="difflineminus">-  bool                force_inline_display;</span>
<a href="#l56.167"></a><span id="l56.167" class="difflineplus">+void add_content_type_attribs(const char *content_type,</span>
<a href="#l56.168"></a><span id="l56.168" class="difflineplus">+                              contentTypeHandlerInitStruct *ctHandlerInfo) {</span>
<a href="#l56.169"></a><span id="l56.169" class="difflineplus">+  cthandler_struct *ptr = nullptr;</span>
<a href="#l56.170"></a><span id="l56.170" class="difflineplus">+  bool force_inline_display;</span>
<a href="#l56.171"></a><span id="l56.171"> </span>
<a href="#l56.172"></a><span id="l56.172" class="difflineminus">-  if (find_content_type_attribs(content_type, &amp;force_inline_display))</span>
<a href="#l56.173"></a><span id="l56.173" class="difflineminus">-    return;</span>
<a href="#l56.174"></a><span id="l56.174" class="difflineplus">+  if (find_content_type_attribs(content_type, &amp;force_inline_display)) return;</span>
<a href="#l56.175"></a><span id="l56.175"> </span>
<a href="#l56.176"></a><span id="l56.176" class="difflineminus">-  if (!content_type || !ctHandlerInfo)</span>
<a href="#l56.177"></a><span id="l56.177" class="difflineminus">-    return;</span>
<a href="#l56.178"></a><span id="l56.178" class="difflineplus">+  if (!content_type || !ctHandlerInfo) return;</span>
<a href="#l56.179"></a><span id="l56.179"> </span>
<a href="#l56.180"></a><span id="l56.180" class="difflineminus">-  if (!ctHandlerList)</span>
<a href="#l56.181"></a><span id="l56.181" class="difflineminus">-    ctHandlerList = new nsTArray&lt;cthandler_struct*&gt;();</span>
<a href="#l56.182"></a><span id="l56.182" class="difflineplus">+  if (!ctHandlerList) ctHandlerList = new nsTArray&lt;cthandler_struct *&gt;();</span>
<a href="#l56.183"></a><span id="l56.183"> </span>
<a href="#l56.184"></a><span id="l56.184" class="difflineminus">-  if (!ctHandlerList)</span>
<a href="#l56.185"></a><span id="l56.185" class="difflineminus">-    return;</span>
<a href="#l56.186"></a><span id="l56.186" class="difflineplus">+  if (!ctHandlerList) return;</span>
<a href="#l56.187"></a><span id="l56.187"> </span>
<a href="#l56.188"></a><span id="l56.188">   ptr = (cthandler_struct *)PR_MALLOC(sizeof(cthandler_struct));</span>
<a href="#l56.189"></a><span id="l56.189" class="difflineminus">-  if (!ptr)</span>
<a href="#l56.190"></a><span id="l56.190" class="difflineminus">-    return;</span>
<a href="#l56.191"></a><span id="l56.191" class="difflineplus">+  if (!ptr) return;</span>
<a href="#l56.192"></a><span id="l56.192"> </span>
<a href="#l56.193"></a><span id="l56.193">   PL_strncpy(ptr-&gt;content_type, content_type, sizeof(ptr-&gt;content_type));</span>
<a href="#l56.194"></a><span id="l56.194">   ptr-&gt;force_inline_display = ctHandlerInfo-&gt;force_inline_display;</span>
<a href="#l56.195"></a><span id="l56.195">   ctHandlerList-&gt;AppendElement(ptr);</span>
<a href="#l56.196"></a><span id="l56.196"> }</span>
<a href="#l56.197"></a><span id="l56.197"> </span>
<a href="#l56.198"></a><span id="l56.198"> /*</span>
<a href="#l56.199"></a><span id="l56.199">  * This routine will find all content type handler for a specific content</span>
<a href="#l56.200"></a><span id="l56.200">  * type (if it exists)</span>
<a href="#l56.201"></a><span id="l56.201">  */</span>
<a href="#l56.202"></a><span id="l56.202" class="difflineminus">-bool</span>
<a href="#l56.203"></a><span id="l56.203" class="difflineminus">-force_inline_display(const char *content_type)</span>
<a href="#l56.204"></a><span id="l56.204" class="difflineminus">-{</span>
<a href="#l56.205"></a><span id="l56.205" class="difflineminus">-  bool       force_inline_disp;</span>
<a href="#l56.206"></a><span id="l56.206" class="difflineplus">+bool force_inline_display(const char *content_type) {</span>
<a href="#l56.207"></a><span id="l56.207" class="difflineplus">+  bool force_inline_disp;</span>
<a href="#l56.208"></a><span id="l56.208"> </span>
<a href="#l56.209"></a><span id="l56.209">   find_content_type_attribs(content_type, &amp;force_inline_disp);</span>
<a href="#l56.210"></a><span id="l56.210">   return force_inline_disp;</span>
<a href="#l56.211"></a><span id="l56.211"> }</span>
<a href="#l56.212"></a><span id="l56.212"> </span>
<a href="#l56.213"></a><span id="l56.213"> /*</span>
<a href="#l56.214"></a><span id="l56.214">  * This routine will find all content type handler for a specific content</span>
<a href="#l56.215"></a><span id="l56.215">  * type (if it exists) and is defined to the nsRegistry</span>
<a href="#l56.216"></a><span id="l56.216">  */</span>
<a href="#l56.217"></a><span id="l56.217" class="difflineminus">-MimeObjectClass *</span>
<a href="#l56.218"></a><span id="l56.218" class="difflineminus">-mime_locate_external_content_handler(const char *content_type,</span>
<a href="#l56.219"></a><span id="l56.219" class="difflineminus">-                                     contentTypeHandlerInitStruct  *ctHandlerInfo)</span>
<a href="#l56.220"></a><span id="l56.220" class="difflineminus">-{</span>
<a href="#l56.221"></a><span id="l56.221" class="difflineminus">-  if (!content_type || !*(content_type)) // null or empty content type</span>
<a href="#l56.222"></a><span id="l56.222" class="difflineplus">+MimeObjectClass *mime_locate_external_content_handler(</span>
<a href="#l56.223"></a><span id="l56.223" class="difflineplus">+    const char *content_type, contentTypeHandlerInitStruct *ctHandlerInfo) {</span>
<a href="#l56.224"></a><span id="l56.224" class="difflineplus">+  if (!content_type || !*(content_type))  // null or empty content type</span>
<a href="#l56.225"></a><span id="l56.225">     return nullptr;</span>
<a href="#l56.226"></a><span id="l56.226"> </span>
<a href="#l56.227"></a><span id="l56.227" class="difflineminus">-  MimeObjectClass               *newObj = nullptr;</span>
<a href="#l56.228"></a><span id="l56.228" class="difflineplus">+  MimeObjectClass *newObj = nullptr;</span>
<a href="#l56.229"></a><span id="l56.229">   nsresult rv;</span>
<a href="#l56.230"></a><span id="l56.230"> </span>
<a href="#l56.231"></a><span id="l56.231">   nsAutoCString lookupID(&quot;@mozilla.org/mimecth;1?type=&quot;);</span>
<a href="#l56.232"></a><span id="l56.232">   nsAutoCString contentType;</span>
<a href="#l56.233"></a><span id="l56.233">   ToLowerCase(nsDependentCString(content_type), contentType);</span>
<a href="#l56.234"></a><span id="l56.234">   lookupID += contentType;</span>
<a href="#l56.235"></a><span id="l56.235"> </span>
<a href="#l56.236"></a><span id="l56.236" class="difflineminus">-  nsCOMPtr&lt;nsIMimeContentTypeHandler&gt; ctHandler = do_CreateInstance(lookupID.get(), &amp;rv);</span>
<a href="#l56.237"></a><span id="l56.237" class="difflineplus">+  nsCOMPtr&lt;nsIMimeContentTypeHandler&gt; ctHandler =</span>
<a href="#l56.238"></a><span id="l56.238" class="difflineplus">+      do_CreateInstance(lookupID.get(), &amp;rv);</span>
<a href="#l56.239"></a><span id="l56.239">   if (NS_FAILED(rv) || !ctHandler) {</span>
<a href="#l56.240"></a><span id="l56.240">     nsCOMPtr&lt;nsICategoryManager&gt; catman =</span>
<a href="#l56.241"></a><span id="l56.241" class="difflineminus">-      do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l56.242"></a><span id="l56.242" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l56.243"></a><span id="l56.243" class="difflineminus">-      return nullptr;</span>
<a href="#l56.244"></a><span id="l56.244" class="difflineplus">+        do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l56.245"></a><span id="l56.245" class="difflineplus">+    if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l56.246"></a><span id="l56.246"> </span>
<a href="#l56.247"></a><span id="l56.247">     nsCString value;</span>
<a href="#l56.248"></a><span id="l56.248" class="difflineminus">-    rv = catman-&gt;GetCategoryEntry(NS_SIMPLEMIMECONVERTERS_CATEGORY,</span>
<a href="#l56.249"></a><span id="l56.249" class="difflineminus">-                                  contentType, value);</span>
<a href="#l56.250"></a><span id="l56.250" class="difflineminus">-    if (NS_FAILED(rv) || value.IsEmpty())</span>
<a href="#l56.251"></a><span id="l56.251" class="difflineminus">-      return nullptr;</span>
<a href="#l56.252"></a><span id="l56.252" class="difflineplus">+    rv = catman-&gt;GetCategoryEntry(NS_SIMPLEMIMECONVERTERS_CATEGORY, contentType,</span>
<a href="#l56.253"></a><span id="l56.253" class="difflineplus">+                                  value);</span>
<a href="#l56.254"></a><span id="l56.254" class="difflineplus">+    if (NS_FAILED(rv) || value.IsEmpty()) return nullptr;</span>
<a href="#l56.255"></a><span id="l56.255">     rv = MIME_NewSimpleMimeConverterStub(contentType.get(),</span>
<a href="#l56.256"></a><span id="l56.256">                                          getter_AddRefs(ctHandler));</span>
<a href="#l56.257"></a><span id="l56.257" class="difflineminus">-    if (NS_FAILED(rv) || !ctHandler)</span>
<a href="#l56.258"></a><span id="l56.258" class="difflineminus">-      return nullptr;</span>
<a href="#l56.259"></a><span id="l56.259" class="difflineplus">+    if (NS_FAILED(rv) || !ctHandler) return nullptr;</span>
<a href="#l56.260"></a><span id="l56.260">   }</span>
<a href="#l56.261"></a><span id="l56.261"> </span>
<a href="#l56.262"></a><span id="l56.262" class="difflineminus">-  rv = ctHandler-&gt;CreateContentTypeHandlerClass(contentType.get(), ctHandlerInfo, &amp;newObj);</span>
<a href="#l56.263"></a><span id="l56.263" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l56.264"></a><span id="l56.264" class="difflineminus">-    return nullptr;</span>
<a href="#l56.265"></a><span id="l56.265" class="difflineplus">+  rv = ctHandler-&gt;CreateContentTypeHandlerClass(contentType.get(),</span>
<a href="#l56.266"></a><span id="l56.266" class="difflineplus">+                                                ctHandlerInfo, &amp;newObj);</span>
<a href="#l56.267"></a><span id="l56.267" class="difflineplus">+  if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l56.268"></a><span id="l56.268"> </span>
<a href="#l56.269"></a><span id="l56.269">   add_content_type_attribs(contentType.get(), ctHandlerInfo);</span>
<a href="#l56.270"></a><span id="l56.270">   return newObj;</span>
<a href="#l56.271"></a><span id="l56.271"> }</span>
<a href="#l56.272"></a><span id="l56.272"> </span>
<a href="#l56.273"></a><span id="l56.273"> /* This is necessary to expose the MimeObject method outside of this DLL */</span>
<a href="#l56.274"></a><span id="l56.274" class="difflineminus">-int</span>
<a href="#l56.275"></a><span id="l56.275" class="difflineminus">-MIME_MimeObject_write(MimeObject *obj, const char *output, int32_t length, bool user_visible_p)</span>
<a href="#l56.276"></a><span id="l56.276" class="difflineminus">-{</span>
<a href="#l56.277"></a><span id="l56.277" class="difflineplus">+int MIME_MimeObject_write(MimeObject *obj, const char *output, int32_t length,</span>
<a href="#l56.278"></a><span id="l56.278" class="difflineplus">+                          bool user_visible_p) {</span>
<a href="#l56.279"></a><span id="l56.279">   return MimeObject_write(obj, output, length, user_visible_p);</span>
<a href="#l56.280"></a><span id="l56.280"> }</span>
<a href="#l56.281"></a><span id="l56.281"> </span>
<a href="#l56.282"></a><span id="l56.282" class="difflineminus">-MimeObject *</span>
<a href="#l56.283"></a><span id="l56.283" class="difflineminus">-mime_new(MimeObjectClass *clazz, MimeHeaders *hdrs,</span>
<a href="#l56.284"></a><span id="l56.284" class="difflineminus">-         const char *override_content_type)</span>
<a href="#l56.285"></a><span id="l56.285" class="difflineminus">-{</span>
<a href="#l56.286"></a><span id="l56.286" class="difflineplus">+MimeObject *mime_new(MimeObjectClass *clazz, MimeHeaders *hdrs,</span>
<a href="#l56.287"></a><span id="l56.287" class="difflineplus">+                     const char *override_content_type) {</span>
<a href="#l56.288"></a><span id="l56.288">   int size = clazz-&gt;instance_size;</span>
<a href="#l56.289"></a><span id="l56.289">   MimeObject *object;</span>
<a href="#l56.290"></a><span id="l56.290">   int status;</span>
<a href="#l56.291"></a><span id="l56.291"> </span>
<a href="#l56.292"></a><span id="l56.292">   /* Some assertions to verify that this isn't random junk memory... */</span>
<a href="#l56.293"></a><span id="l56.293" class="difflineminus">-  NS_ASSERTION(clazz-&gt;class_name &amp;&amp; strlen(clazz-&gt;class_name) &gt; 0, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.294"></a><span id="l56.294" class="difflineminus">-  NS_ASSERTION(size &gt; 0 &amp;&amp; size &lt; 1000, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.295"></a><span id="l56.295" class="difflineplus">+  NS_ASSERTION(clazz-&gt;class_name &amp;&amp; strlen(clazz-&gt;class_name) &gt; 0,</span>
<a href="#l56.296"></a><span id="l56.296" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.297"></a><span id="l56.297" class="difflineplus">+  NS_ASSERTION(size &gt; 0 &amp;&amp; size &lt; 1000,</span>
<a href="#l56.298"></a><span id="l56.298" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.299"></a><span id="l56.299"> </span>
<a href="#l56.300"></a><span id="l56.300" class="difflineminus">-  if (!clazz-&gt;class_initialized)</span>
<a href="#l56.301"></a><span id="l56.301" class="difflineminus">-  {</span>
<a href="#l56.302"></a><span id="l56.302" class="difflineplus">+  if (!clazz-&gt;class_initialized) {</span>
<a href="#l56.303"></a><span id="l56.303">     status = mime_classinit(clazz);</span>
<a href="#l56.304"></a><span id="l56.304" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l56.305"></a><span id="l56.305" class="difflineminus">-      return 0;</span>
<a href="#l56.306"></a><span id="l56.306" class="difflineplus">+    if (status &lt; 0) return 0;</span>
<a href="#l56.307"></a><span id="l56.307">   }</span>
<a href="#l56.308"></a><span id="l56.308"> </span>
<a href="#l56.309"></a><span id="l56.309" class="difflineminus">-  NS_ASSERTION(clazz-&gt;initialize &amp;&amp; clazz-&gt;finalize, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.310"></a><span id="l56.310" class="difflineplus">+  NS_ASSERTION(clazz-&gt;initialize &amp;&amp; clazz-&gt;finalize,</span>
<a href="#l56.311"></a><span id="l56.311" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.312"></a><span id="l56.312"> </span>
<a href="#l56.313"></a><span id="l56.313" class="difflineminus">-  if (hdrs)</span>
<a href="#l56.314"></a><span id="l56.314" class="difflineminus">-  {</span>
<a href="#l56.315"></a><span id="l56.315" class="difflineplus">+  if (hdrs) {</span>
<a href="#l56.316"></a><span id="l56.316">     hdrs = MimeHeaders_copy(hdrs);</span>
<a href="#l56.317"></a><span id="l56.317" class="difflineminus">-    if (!hdrs)</span>
<a href="#l56.318"></a><span id="l56.318" class="difflineminus">-      return 0;</span>
<a href="#l56.319"></a><span id="l56.319" class="difflineplus">+    if (!hdrs) return 0;</span>
<a href="#l56.320"></a><span id="l56.320">   }</span>
<a href="#l56.321"></a><span id="l56.321"> </span>
<a href="#l56.322"></a><span id="l56.322">   object = (MimeObject *)PR_MALLOC(size);</span>
<a href="#l56.323"></a><span id="l56.323" class="difflineminus">-  if (!object)</span>
<a href="#l56.324"></a><span id="l56.324" class="difflineminus">-    return 0;</span>
<a href="#l56.325"></a><span id="l56.325" class="difflineplus">+  if (!object) return 0;</span>
<a href="#l56.326"></a><span id="l56.326"> </span>
<a href="#l56.327"></a><span id="l56.327">   memset(object, 0, size);</span>
<a href="#l56.328"></a><span id="l56.328">   object-&gt;clazz = clazz;</span>
<a href="#l56.329"></a><span id="l56.329">   object-&gt;headers = hdrs;</span>
<a href="#l56.330"></a><span id="l56.330">   object-&gt;dontShowAsAttachment = false;</span>
<a href="#l56.331"></a><span id="l56.331"> </span>
<a href="#l56.332"></a><span id="l56.332">   if (override_content_type &amp;&amp; *override_content_type)</span>
<a href="#l56.333"></a><span id="l56.333">     object-&gt;content_type = strdup(override_content_type);</span>
<a href="#l56.334"></a><span id="l56.334"> </span>
<a href="#l56.335"></a><span id="l56.335">   status = clazz-&gt;initialize(object);</span>
<a href="#l56.336"></a><span id="l56.336" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l56.337"></a><span id="l56.337" class="difflineminus">-  {</span>
<a href="#l56.338"></a><span id="l56.338" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l56.339"></a><span id="l56.339">     clazz-&gt;finalize(object);</span>
<a href="#l56.340"></a><span id="l56.340">     PR_Free(object);</span>
<a href="#l56.341"></a><span id="l56.341">     return 0;</span>
<a href="#l56.342"></a><span id="l56.342">   }</span>
<a href="#l56.343"></a><span id="l56.343"> </span>
<a href="#l56.344"></a><span id="l56.344">   return object;</span>
<a href="#l56.345"></a><span id="l56.345"> }</span>
<a href="#l56.346"></a><span id="l56.346"> </span>
<a href="#l56.347"></a><span id="l56.347" class="difflineminus">-void</span>
<a href="#l56.348"></a><span id="l56.348" class="difflineminus">-mime_free(MimeObject *object)</span>
<a href="#l56.349"></a><span id="l56.349" class="difflineminus">-{</span>
<a href="#l56.350"></a><span id="l56.350" class="difflineminus">-# ifdef DEBUG__</span>
<a href="#l56.351"></a><span id="l56.351" class="difflineplus">+void mime_free(MimeObject *object) {</span>
<a href="#l56.352"></a><span id="l56.352" class="difflineplus">+#ifdef DEBUG__</span>
<a href="#l56.353"></a><span id="l56.353">   int i, size = object-&gt;clazz-&gt;instance_size;</span>
<a href="#l56.354"></a><span id="l56.354" class="difflineminus">-  uint32_t *array = (uint32_t*)object;</span>
<a href="#l56.355"></a><span id="l56.355" class="difflineminus">-# endif /* DEBUG */</span>
<a href="#l56.356"></a><span id="l56.356" class="difflineplus">+  uint32_t *array = (uint32_t *)object;</span>
<a href="#l56.357"></a><span id="l56.357" class="difflineplus">+#endif /* DEBUG */</span>
<a href="#l56.358"></a><span id="l56.358"> </span>
<a href="#l56.359"></a><span id="l56.359">   object-&gt;clazz-&gt;finalize(object);</span>
<a href="#l56.360"></a><span id="l56.360"> </span>
<a href="#l56.361"></a><span id="l56.361" class="difflineminus">-# ifdef DEBUG__</span>
<a href="#l56.362"></a><span id="l56.362" class="difflineminus">-  for (i = 0; i &lt; (size / sizeof(*array)); i++)</span>
<a href="#l56.363"></a><span id="l56.363" class="difflineminus">-  array[i] = (uint32_t) 0xDEADBEEF;</span>
<a href="#l56.364"></a><span id="l56.364" class="difflineminus">-# endif /* DEBUG */</span>
<a href="#l56.365"></a><span id="l56.365" class="difflineplus">+#ifdef DEBUG__</span>
<a href="#l56.366"></a><span id="l56.366" class="difflineplus">+  for (i = 0; i &lt; (size / sizeof(*array)); i++) array[i] = (uint32_t)0xDEADBEEF;</span>
<a href="#l56.367"></a><span id="l56.367" class="difflineplus">+#endif /* DEBUG */</span>
<a href="#l56.368"></a><span id="l56.368"> </span>
<a href="#l56.369"></a><span id="l56.369">   PR_Free(object);</span>
<a href="#l56.370"></a><span id="l56.370"> }</span>
<a href="#l56.371"></a><span id="l56.371"> </span>
<a href="#l56.372"></a><span id="l56.372" class="difflineminus">-</span>
<a href="#l56.373"></a><span id="l56.373"> bool mime_is_allowed_class(const MimeObjectClass *clazz,</span>
<a href="#l56.374"></a><span id="l56.374" class="difflineminus">-                           int32_t types_of_classes_to_disallow)</span>
<a href="#l56.375"></a><span id="l56.375" class="difflineminus">-{</span>
<a href="#l56.376"></a><span id="l56.376" class="difflineminus">-  if (types_of_classes_to_disallow == 0)</span>
<a href="#l56.377"></a><span id="l56.377" class="difflineminus">-    return true;</span>
<a href="#l56.378"></a><span id="l56.378" class="difflineplus">+                           int32_t types_of_classes_to_disallow) {</span>
<a href="#l56.379"></a><span id="l56.379" class="difflineplus">+  if (types_of_classes_to_disallow == 0) return true;</span>
<a href="#l56.380"></a><span id="l56.380">   bool avoid_html = (types_of_classes_to_disallow &gt;= 1);</span>
<a href="#l56.381"></a><span id="l56.381">   bool avoid_images = (types_of_classes_to_disallow &gt;= 2);</span>
<a href="#l56.382"></a><span id="l56.382">   bool avoid_strange_content = (types_of_classes_to_disallow &gt;= 3);</span>
<a href="#l56.383"></a><span id="l56.383">   bool allow_only_vanilla_classes = (types_of_classes_to_disallow == 100);</span>
<a href="#l56.384"></a><span id="l56.384"> </span>
<a href="#l56.385"></a><span id="l56.385">   if (allow_only_vanilla_classes)</span>
<a href="#l56.386"></a><span id="l56.386">     /* A &quot;safe&quot; class is one that is unlikely to have security bugs or to</span>
<a href="#l56.387"></a><span id="l56.387">        allow security exploits or one that is essential for the usefulness</span>
<a href="#l56.388"></a><span id="l56.388">        of the application, even for paranoid users.</span>
<a href="#l56.389"></a><span id="l56.389">        What's included here is more personal judgement than following</span>
<a href="#l56.390"></a><span id="l56.390">        strict rules, though, unfortunately.</span>
<a href="#l56.391"></a><span id="l56.391">        The function returns true only for known good classes, i.e. is a</span>
<a href="#l56.392"></a><span id="l56.392">        &quot;whitelist&quot; in this case.</span>
<a href="#l56.393"></a><span id="l56.393">        This idea comes from Georgi Guninski.</span>
<a href="#l56.394"></a><span id="l56.394">     */</span>
<a href="#l56.395"></a><span id="l56.395" class="difflineminus">-    return</span>
<a href="#l56.396"></a><span id="l56.396" class="difflineminus">-      (</span>
<a href="#l56.397"></a><span id="l56.397" class="difflineminus">-        clazz == (MimeObjectClass *)&amp;mimeInlineTextPlainClass ||</span>
<a href="#l56.398"></a><span id="l56.398" class="difflineminus">-        clazz == (MimeObjectClass *)&amp;mimeInlineTextPlainFlowedClass ||</span>
<a href="#l56.399"></a><span id="l56.399" class="difflineminus">-        clazz == (MimeObjectClass *)&amp;mimeInlineTextHTMLSanitizedClass ||</span>
<a href="#l56.400"></a><span id="l56.400" class="difflineminus">-        clazz == (MimeObjectClass *)&amp;mimeInlineTextHTMLAsPlaintextClass ||</span>
<a href="#l56.401"></a><span id="l56.401" class="difflineminus">-           /* The latter 2 classes bear some risk, because they use the Gecko</span>
<a href="#l56.402"></a><span id="l56.402" class="difflineminus">-              HTML parser, but the user has the option to make an explicit</span>
<a href="#l56.403"></a><span id="l56.403" class="difflineminus">-              choice in this case, via html_as. */</span>
<a href="#l56.404"></a><span id="l56.404" class="difflineminus">-        clazz == (MimeObjectClass *)&amp;mimeMultipartMixedClass ||</span>
<a href="#l56.405"></a><span id="l56.405" class="difflineminus">-        clazz == (MimeObjectClass *)&amp;mimeMultipartAlternativeClass ||</span>
<a href="#l56.406"></a><span id="l56.406" class="difflineminus">-        clazz == (MimeObjectClass *)&amp;mimeMultipartDigestClass ||</span>
<a href="#l56.407"></a><span id="l56.407" class="difflineminus">-        clazz == (MimeObjectClass *)&amp;mimeMultipartAppleDoubleClass ||</span>
<a href="#l56.408"></a><span id="l56.408" class="difflineminus">-        clazz == (MimeObjectClass *)&amp;mimeMessageClass ||</span>
<a href="#l56.409"></a><span id="l56.409" class="difflineminus">-        clazz == (MimeObjectClass *)&amp;mimeExternalObjectClass ||</span>
<a href="#l56.410"></a><span id="l56.410" class="difflineminus">-                               /*    mimeUntypedTextClass? -- does uuencode */</span>
<a href="#l56.411"></a><span id="l56.411" class="difflineplus">+    return (clazz == (MimeObjectClass *)&amp;mimeInlineTextPlainClass ||</span>
<a href="#l56.412"></a><span id="l56.412" class="difflineplus">+            clazz == (MimeObjectClass *)&amp;mimeInlineTextPlainFlowedClass ||</span>
<a href="#l56.413"></a><span id="l56.413" class="difflineplus">+            clazz == (MimeObjectClass *)&amp;mimeInlineTextHTMLSanitizedClass ||</span>
<a href="#l56.414"></a><span id="l56.414" class="difflineplus">+            clazz == (MimeObjectClass *)&amp;mimeInlineTextHTMLAsPlaintextClass ||</span>
<a href="#l56.415"></a><span id="l56.415" class="difflineplus">+            /* The latter 2 classes bear some risk, because they use the Gecko</span>
<a href="#l56.416"></a><span id="l56.416" class="difflineplus">+               HTML parser, but the user has the option to make an explicit</span>
<a href="#l56.417"></a><span id="l56.417" class="difflineplus">+               choice in this case, via html_as. */</span>
<a href="#l56.418"></a><span id="l56.418" class="difflineplus">+            clazz == (MimeObjectClass *)&amp;mimeMultipartMixedClass ||</span>
<a href="#l56.419"></a><span id="l56.419" class="difflineplus">+            clazz == (MimeObjectClass *)&amp;mimeMultipartAlternativeClass ||</span>
<a href="#l56.420"></a><span id="l56.420" class="difflineplus">+            clazz == (MimeObjectClass *)&amp;mimeMultipartDigestClass ||</span>
<a href="#l56.421"></a><span id="l56.421" class="difflineplus">+            clazz == (MimeObjectClass *)&amp;mimeMultipartAppleDoubleClass ||</span>
<a href="#l56.422"></a><span id="l56.422" class="difflineplus">+            clazz == (MimeObjectClass *)&amp;mimeMessageClass ||</span>
<a href="#l56.423"></a><span id="l56.423" class="difflineplus">+            clazz == (MimeObjectClass *)&amp;mimeExternalObjectClass ||</span>
<a href="#l56.424"></a><span id="l56.424" class="difflineplus">+    /*    mimeUntypedTextClass? -- does uuencode */</span>
<a href="#l56.425"></a><span id="l56.425"> #ifdef ENABLE_SMIME</span>
<a href="#l56.426"></a><span id="l56.426" class="difflineminus">-        clazz == (MimeObjectClass *)&amp;mimeMultipartSignedCMSClass ||</span>
<a href="#l56.427"></a><span id="l56.427" class="difflineminus">-        clazz == (MimeObjectClass *)&amp;mimeEncryptedCMSClass ||</span>
<a href="#l56.428"></a><span id="l56.428" class="difflineplus">+            clazz == (MimeObjectClass *)&amp;mimeMultipartSignedCMSClass ||</span>
<a href="#l56.429"></a><span id="l56.429" class="difflineplus">+            clazz == (MimeObjectClass *)&amp;mimeEncryptedCMSClass ||</span>
<a href="#l56.430"></a><span id="l56.430"> #endif</span>
<a href="#l56.431"></a><span id="l56.431" class="difflineminus">-        clazz == 0</span>
<a href="#l56.432"></a><span id="l56.432" class="difflineminus">-      );</span>
<a href="#l56.433"></a><span id="l56.433" class="difflineplus">+            clazz == 0);</span>
<a href="#l56.434"></a><span id="l56.434"> </span>
<a href="#l56.435"></a><span id="l56.435">   /* Contrairy to above, the below code is a &quot;blacklist&quot;, i.e. it</span>
<a href="#l56.436"></a><span id="l56.436" class="difflineminus">-     *excludes* some &quot;bad&quot; classes. */</span>
<a href="#l56.437"></a><span id="l56.437" class="difflineminus">-  return</span>
<a href="#l56.438"></a><span id="l56.438" class="difflineminus">-     !(</span>
<a href="#l56.439"></a><span id="l56.439" class="difflineminus">-        (avoid_html</span>
<a href="#l56.440"></a><span id="l56.440" class="difflineminus">-         &amp;&amp; (</span>
<a href="#l56.441"></a><span id="l56.441" class="difflineminus">-              clazz == (MimeObjectClass *)&amp;mimeInlineTextHTMLParsedClass</span>
<a href="#l56.442"></a><span id="l56.442" class="difflineminus">-                         /* Should not happen - we protect against that in</span>
<a href="#l56.443"></a><span id="l56.443" class="difflineminus">-                            mime_find_class(). Still for safety... */</span>
<a href="#l56.444"></a><span id="l56.444" class="difflineminus">-            )) ||</span>
<a href="#l56.445"></a><span id="l56.445" class="difflineminus">-        (avoid_images</span>
<a href="#l56.446"></a><span id="l56.446" class="difflineminus">-         &amp;&amp; (</span>
<a href="#l56.447"></a><span id="l56.447" class="difflineminus">-              clazz == (MimeObjectClass *)&amp;mimeInlineImageClass</span>
<a href="#l56.448"></a><span id="l56.448" class="difflineminus">-            )) ||</span>
<a href="#l56.449"></a><span id="l56.449" class="difflineminus">-        (avoid_strange_content</span>
<a href="#l56.450"></a><span id="l56.450" class="difflineminus">-         &amp;&amp; (</span>
<a href="#l56.451"></a><span id="l56.451" class="difflineminus">-              clazz == (MimeObjectClass *)&amp;mimeInlineTextEnrichedClass ||</span>
<a href="#l56.452"></a><span id="l56.452" class="difflineminus">-              clazz == (MimeObjectClass *)&amp;mimeInlineTextRichtextClass ||</span>
<a href="#l56.453"></a><span id="l56.453" class="difflineminus">-              clazz == (MimeObjectClass *)&amp;mimeSunAttachmentClass ||</span>
<a href="#l56.454"></a><span id="l56.454" class="difflineminus">-              clazz == (MimeObjectClass *)&amp;mimeExternalBodyClass</span>
<a href="#l56.455"></a><span id="l56.455" class="difflineminus">-            ))</span>
<a href="#l56.456"></a><span id="l56.456" class="difflineminus">-      );</span>
<a href="#l56.457"></a><span id="l56.457" class="difflineplus">+   *excludes* some &quot;bad&quot; classes. */</span>
<a href="#l56.458"></a><span id="l56.458" class="difflineplus">+  return !(</span>
<a href="#l56.459"></a><span id="l56.459" class="difflineplus">+      (avoid_html &amp;&amp; (clazz == (MimeObjectClass *)&amp;mimeInlineTextHTMLParsedClass</span>
<a href="#l56.460"></a><span id="l56.460" class="difflineplus">+                      /* Should not happen - we protect against that in</span>
<a href="#l56.461"></a><span id="l56.461" class="difflineplus">+                         mime_find_class(). Still for safety... */</span>
<a href="#l56.462"></a><span id="l56.462" class="difflineplus">+                      )) ||</span>
<a href="#l56.463"></a><span id="l56.463" class="difflineplus">+      (avoid_images &amp;&amp; (clazz == (MimeObjectClass *)&amp;mimeInlineImageClass)) ||</span>
<a href="#l56.464"></a><span id="l56.464" class="difflineplus">+      (avoid_strange_content &amp;&amp;</span>
<a href="#l56.465"></a><span id="l56.465" class="difflineplus">+       (clazz == (MimeObjectClass *)&amp;mimeInlineTextEnrichedClass ||</span>
<a href="#l56.466"></a><span id="l56.466" class="difflineplus">+        clazz == (MimeObjectClass *)&amp;mimeInlineTextRichtextClass ||</span>
<a href="#l56.467"></a><span id="l56.467" class="difflineplus">+        clazz == (MimeObjectClass *)&amp;mimeSunAttachmentClass ||</span>
<a href="#l56.468"></a><span id="l56.468" class="difflineplus">+        clazz == (MimeObjectClass *)&amp;mimeExternalBodyClass)));</span>
<a href="#l56.469"></a><span id="l56.469"> }</span>
<a href="#l56.470"></a><span id="l56.470"> </span>
<a href="#l56.471"></a><span id="l56.471" class="difflineminus">-void getMsgHdrForCurrentURL(MimeDisplayOptions *opts, nsIMsgDBHdr ** aMsgHdr)</span>
<a href="#l56.472"></a><span id="l56.472" class="difflineminus">-{</span>
<a href="#l56.473"></a><span id="l56.473" class="difflineplus">+void getMsgHdrForCurrentURL(MimeDisplayOptions *opts, nsIMsgDBHdr **aMsgHdr) {</span>
<a href="#l56.474"></a><span id="l56.474">   *aMsgHdr = nullptr;</span>
<a href="#l56.475"></a><span id="l56.475"> </span>
<a href="#l56.476"></a><span id="l56.476" class="difflineminus">-  if (!opts)</span>
<a href="#l56.477"></a><span id="l56.477" class="difflineminus">-    return;</span>
<a href="#l56.478"></a><span id="l56.478" class="difflineplus">+  if (!opts) return;</span>
<a href="#l56.479"></a><span id="l56.479"> </span>
<a href="#l56.480"></a><span id="l56.480" class="difflineminus">-  mime_stream_data *msd = (mime_stream_data *) (opts-&gt;stream_closure);</span>
<a href="#l56.481"></a><span id="l56.481" class="difflineminus">-  if (!msd)</span>
<a href="#l56.482"></a><span id="l56.482" class="difflineminus">-    return;</span>
<a href="#l56.483"></a><span id="l56.483" class="difflineplus">+  mime_stream_data *msd = (mime_stream_data *)(opts-&gt;stream_closure);</span>
<a href="#l56.484"></a><span id="l56.484" class="difflineplus">+  if (!msd) return;</span>
<a href="#l56.485"></a><span id="l56.485"> </span>
<a href="#l56.486"></a><span id="l56.486" class="difflineminus">-  nsCOMPtr&lt;nsIChannel&gt; channel = msd-&gt;channel;  // note the lack of ref counting...</span>
<a href="#l56.487"></a><span id="l56.487" class="difflineminus">-  if (channel)</span>
<a href="#l56.488"></a><span id="l56.488" class="difflineminus">-  {</span>
<a href="#l56.489"></a><span id="l56.489" class="difflineplus">+  nsCOMPtr&lt;nsIChannel&gt; channel =</span>
<a href="#l56.490"></a><span id="l56.490" class="difflineplus">+      msd-&gt;channel;  // note the lack of ref counting...</span>
<a href="#l56.491"></a><span id="l56.491" class="difflineplus">+  if (channel) {</span>
<a href="#l56.492"></a><span id="l56.492">     nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l56.493"></a><span id="l56.493">     nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgURI;</span>
<a href="#l56.494"></a><span id="l56.494">     channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l56.495"></a><span id="l56.495" class="difflineminus">-    if (uri)</span>
<a href="#l56.496"></a><span id="l56.496" class="difflineminus">-    {</span>
<a href="#l56.497"></a><span id="l56.497" class="difflineplus">+    if (uri) {</span>
<a href="#l56.498"></a><span id="l56.498">       msgURI = do_QueryInterface(uri);</span>
<a href="#l56.499"></a><span id="l56.499" class="difflineminus">-      if (msgURI)</span>
<a href="#l56.500"></a><span id="l56.500" class="difflineminus">-      {</span>
<a href="#l56.501"></a><span id="l56.501" class="difflineplus">+      if (msgURI) {</span>
<a href="#l56.502"></a><span id="l56.502">         msgURI-&gt;GetMessageHeader(aMsgHdr);</span>
<a href="#l56.503"></a><span id="l56.503" class="difflineminus">-        if (*aMsgHdr)</span>
<a href="#l56.504"></a><span id="l56.504" class="difflineminus">-          return;</span>
<a href="#l56.505"></a><span id="l56.505" class="difflineplus">+        if (*aMsgHdr) return;</span>
<a href="#l56.506"></a><span id="l56.506">         nsCString rdfURI;</span>
<a href="#l56.507"></a><span id="l56.507">         msgURI-&gt;GetUri(getter_Copies(rdfURI));</span>
<a href="#l56.508"></a><span id="l56.508" class="difflineminus">-        if (!rdfURI.IsEmpty())</span>
<a href="#l56.509"></a><span id="l56.509" class="difflineminus">-        {</span>
<a href="#l56.510"></a><span id="l56.510" class="difflineplus">+        if (!rdfURI.IsEmpty()) {</span>
<a href="#l56.511"></a><span id="l56.511">           nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l56.512"></a><span id="l56.512">           GetMsgDBHdrFromURI(rdfURI.get(), getter_AddRefs(msgHdr));</span>
<a href="#l56.513"></a><span id="l56.513">           NS_IF_ADDREF(*aMsgHdr = msgHdr);</span>
<a href="#l56.514"></a><span id="l56.514">         }</span>
<a href="#l56.515"></a><span id="l56.515">       }</span>
<a href="#l56.516"></a><span id="l56.516">     }</span>
<a href="#l56.517"></a><span id="l56.517">   }</span>
<a href="#l56.518"></a><span id="l56.518"> </span>
<a href="#l56.519"></a><span id="l56.519">   return;</span>
<a href="#l56.520"></a><span id="l56.520"> }</span>
<a href="#l56.521"></a><span id="l56.521"> </span>
<a href="#l56.522"></a><span id="l56.522" class="difflineminus">-MimeObjectClass *</span>
<a href="#l56.523"></a><span id="l56.523" class="difflineminus">-mime_find_class(const char *content_type, MimeHeaders *hdrs,</span>
<a href="#l56.524"></a><span id="l56.524" class="difflineminus">-                MimeDisplayOptions *opts, bool exact_match_p)</span>
<a href="#l56.525"></a><span id="l56.525" class="difflineminus">-{</span>
<a href="#l56.526"></a><span id="l56.526" class="difflineplus">+MimeObjectClass *mime_find_class(const char *content_type, MimeHeaders *hdrs,</span>
<a href="#l56.527"></a><span id="l56.527" class="difflineplus">+                                 MimeDisplayOptions *opts, bool exact_match_p) {</span>
<a href="#l56.528"></a><span id="l56.528">   MimeObjectClass *clazz = 0;</span>
<a href="#l56.529"></a><span id="l56.529">   MimeObjectClass *tempClass = 0;</span>
<a href="#l56.530"></a><span id="l56.530" class="difflineminus">-  contentTypeHandlerInitStruct  ctHandlerInfo;</span>
<a href="#l56.531"></a><span id="l56.531" class="difflineplus">+  contentTypeHandlerInitStruct ctHandlerInfo;</span>
<a href="#l56.532"></a><span id="l56.532"> </span>
<a href="#l56.533"></a><span id="l56.533">   // Read some prefs</span>
<a href="#l56.534"></a><span id="l56.534">   nsIPrefBranch *prefBranch = GetPrefBranch(opts);</span>
<a href="#l56.535"></a><span id="l56.535" class="difflineminus">-  int32_t html_as = 0;  // def. see below</span>
<a href="#l56.536"></a><span id="l56.536" class="difflineminus">-  int32_t types_of_classes_to_disallow = 0;  /* Let only a few libmime classes</span>
<a href="#l56.537"></a><span id="l56.537" class="difflineminus">-       process incoming data. This protects from bugs (e.g. buffer overflows)</span>
<a href="#l56.538"></a><span id="l56.538" class="difflineminus">-       and from security loopholes (e.g. allowing unchecked HTML in some</span>
<a href="#l56.539"></a><span id="l56.539" class="difflineminus">-       obscure classes, although the user has html_as &gt; 0).</span>
<a href="#l56.540"></a><span id="l56.540" class="difflineminus">-       This option is mainly for the UI of html_as.</span>
<a href="#l56.541"></a><span id="l56.541" class="difflineminus">-       0 = allow all available classes</span>
<a href="#l56.542"></a><span id="l56.542" class="difflineminus">-       1 = Use hardcoded blacklist to avoid rendering (incoming) HTML</span>
<a href="#l56.543"></a><span id="l56.543" class="difflineminus">-       2 = ... and images</span>
<a href="#l56.544"></a><span id="l56.544" class="difflineminus">-       3 = ... and some other uncommon content types</span>
<a href="#l56.545"></a><span id="l56.545" class="difflineminus">-       4 = show all body parts</span>
<a href="#l56.546"></a><span id="l56.546" class="difflineminus">-       100 = Use hardcoded whitelist to avoid even more bugs(buffer overflows).</span>
<a href="#l56.547"></a><span id="l56.547" class="difflineminus">-           This mode will limit the features available (e.g. uncommon</span>
<a href="#l56.548"></a><span id="l56.548" class="difflineminus">-           attachment types and inline images) and is for paranoid users.</span>
<a href="#l56.549"></a><span id="l56.549" class="difflineminus">-       */</span>
<a href="#l56.550"></a><span id="l56.550" class="difflineplus">+  int32_t html_as = 0;                      // def. see below</span>
<a href="#l56.551"></a><span id="l56.551" class="difflineplus">+  int32_t types_of_classes_to_disallow = 0; /* Let only a few libmime classes</span>
<a href="#l56.552"></a><span id="l56.552" class="difflineplus">+      process incoming data. This protects from bugs (e.g. buffer overflows)</span>
<a href="#l56.553"></a><span id="l56.553" class="difflineplus">+      and from security loopholes (e.g. allowing unchecked HTML in some</span>
<a href="#l56.554"></a><span id="l56.554" class="difflineplus">+      obscure classes, although the user has html_as &gt; 0).</span>
<a href="#l56.555"></a><span id="l56.555" class="difflineplus">+      This option is mainly for the UI of html_as.</span>
<a href="#l56.556"></a><span id="l56.556" class="difflineplus">+      0 = allow all available classes</span>
<a href="#l56.557"></a><span id="l56.557" class="difflineplus">+      1 = Use hardcoded blacklist to avoid rendering (incoming) HTML</span>
<a href="#l56.558"></a><span id="l56.558" class="difflineplus">+      2 = ... and images</span>
<a href="#l56.559"></a><span id="l56.559" class="difflineplus">+      3 = ... and some other uncommon content types</span>
<a href="#l56.560"></a><span id="l56.560" class="difflineplus">+      4 = show all body parts</span>
<a href="#l56.561"></a><span id="l56.561" class="difflineplus">+      100 = Use hardcoded whitelist to avoid even more bugs(buffer overflows).</span>
<a href="#l56.562"></a><span id="l56.562" class="difflineplus">+          This mode will limit the features available (e.g. uncommon</span>
<a href="#l56.563"></a><span id="l56.563" class="difflineplus">+          attachment types and inline images) and is for paranoid users.</span>
<a href="#l56.564"></a><span id="l56.564" class="difflineplus">+      */</span>
<a href="#l56.565"></a><span id="l56.565">   if (opts &amp;&amp; opts-&gt;format_out != nsMimeOutput::nsMimeMessageFilterSniffer &amp;&amp;</span>
<a href="#l56.566"></a><span id="l56.566" class="difflineminus">-               opts-&gt;format_out != nsMimeOutput::nsMimeMessageDecrypt</span>
<a href="#l56.567"></a><span id="l56.567" class="difflineminus">-               &amp;&amp; opts-&gt;format_out != nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l56.568"></a><span id="l56.568" class="difflineminus">-    if (prefBranch)</span>
<a href="#l56.569"></a><span id="l56.569" class="difflineminus">-    {</span>
<a href="#l56.570"></a><span id="l56.570" class="difflineplus">+      opts-&gt;format_out != nsMimeOutput::nsMimeMessageDecrypt &amp;&amp;</span>
<a href="#l56.571"></a><span id="l56.571" class="difflineplus">+      opts-&gt;format_out != nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l56.572"></a><span id="l56.572" class="difflineplus">+    if (prefBranch) {</span>
<a href="#l56.573"></a><span id="l56.573">       prefBranch-&gt;GetIntPref(&quot;mailnews.display.html_as&quot;, &amp;html_as);</span>
<a href="#l56.574"></a><span id="l56.574">       prefBranch-&gt;GetIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;,</span>
<a href="#l56.575"></a><span id="l56.575" class="difflineminus">-                            &amp;types_of_classes_to_disallow);</span>
<a href="#l56.576"></a><span id="l56.576" class="difflineplus">+                             &amp;types_of_classes_to_disallow);</span>
<a href="#l56.577"></a><span id="l56.577">       if (types_of_classes_to_disallow &gt; 0 &amp;&amp; html_as == 0)</span>
<a href="#l56.578"></a><span id="l56.578" class="difflineminus">-           // We have non-sensical prefs. Do some fixup.</span>
<a href="#l56.579"></a><span id="l56.579" class="difflineplus">+        // We have non-sensical prefs. Do some fixup.</span>
<a href="#l56.580"></a><span id="l56.580">         html_as = 1;</span>
<a href="#l56.581"></a><span id="l56.581">     }</span>
<a href="#l56.582"></a><span id="l56.582"> </span>
<a href="#l56.583"></a><span id="l56.583">   // First, check to see if the message has been marked as JUNK. If it has,</span>
<a href="#l56.584"></a><span id="l56.584">   // then force the message to be rendered as simple, unless this has been</span>
<a href="#l56.585"></a><span id="l56.585">   // called by a filtering routine.</span>
<a href="#l56.586"></a><span id="l56.586">   bool sanitizeJunkMail = false;</span>
<a href="#l56.587"></a><span id="l56.587"> </span>
<a href="#l56.588"></a><span id="l56.588" class="difflineminus">-  // it is faster to read the pref first then figure out the msg hdr for the current url only if we have to</span>
<a href="#l56.589"></a><span id="l56.589" class="difflineminus">-  // XXX instead of reading this pref every time, part of mime should be an observer listening to this pref change</span>
<a href="#l56.590"></a><span id="l56.590" class="difflineminus">-  // and updating internal state accordingly. But none of the other prefs in this file seem to be doing that...=(</span>
<a href="#l56.591"></a><span id="l56.591" class="difflineplus">+  // it is faster to read the pref first then figure out the msg hdr for the</span>
<a href="#l56.592"></a><span id="l56.592" class="difflineplus">+  // current url only if we have to</span>
<a href="#l56.593"></a><span id="l56.593" class="difflineplus">+  // XXX instead of reading this pref every time, part of mime should be an</span>
<a href="#l56.594"></a><span id="l56.594" class="difflineplus">+  // observer listening to this pref change and updating internal state</span>
<a href="#l56.595"></a><span id="l56.595" class="difflineplus">+  // accordingly. But none of the other prefs in this file seem to be doing</span>
<a href="#l56.596"></a><span id="l56.596" class="difflineplus">+  // that...=(</span>
<a href="#l56.597"></a><span id="l56.597">   if (prefBranch)</span>
<a href="#l56.598"></a><span id="l56.598">     prefBranch-&gt;GetBoolPref(&quot;mail.spam.display.sanitize&quot;, &amp;sanitizeJunkMail);</span>
<a href="#l56.599"></a><span id="l56.599"> </span>
<a href="#l56.600"></a><span id="l56.600">   if (sanitizeJunkMail &amp;&amp;</span>
<a href="#l56.601"></a><span id="l56.601" class="difflineminus">-      !(opts &amp;&amp; opts-&gt;format_out == nsMimeOutput::nsMimeMessageFilterSniffer))</span>
<a href="#l56.602"></a><span id="l56.602" class="difflineminus">-  {</span>
<a href="#l56.603"></a><span id="l56.603" class="difflineplus">+      !(opts &amp;&amp; opts-&gt;format_out == nsMimeOutput::nsMimeMessageFilterSniffer)) {</span>
<a href="#l56.604"></a><span id="l56.604">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l56.605"></a><span id="l56.605">     getMsgHdrForCurrentURL(opts, getter_AddRefs(msgHdr));</span>
<a href="#l56.606"></a><span id="l56.606" class="difflineminus">-    if (msgHdr)</span>
<a href="#l56.607"></a><span id="l56.607" class="difflineminus">-    {</span>
<a href="#l56.608"></a><span id="l56.608" class="difflineplus">+    if (msgHdr) {</span>
<a href="#l56.609"></a><span id="l56.609">       nsCString junkScoreStr;</span>
<a href="#l56.610"></a><span id="l56.610" class="difflineminus">-      (void) msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l56.611"></a><span id="l56.611" class="difflineplus">+      (void)msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l56.612"></a><span id="l56.612">       if (html_as == 0 &amp;&amp; junkScoreStr.get() &amp;&amp; atoi(junkScoreStr.get()) &gt; 50)</span>
<a href="#l56.613"></a><span id="l56.613" class="difflineminus">-        html_as = 3; // 3 == Simple HTML</span>
<a href="#l56.614"></a><span id="l56.614" class="difflineminus">-    } // if msgHdr</span>
<a href="#l56.615"></a><span id="l56.615" class="difflineminus">-  } // if we are supposed to sanitize junk mail</span>
<a href="#l56.616"></a><span id="l56.616" class="difflineplus">+        html_as = 3;  // 3 == Simple HTML</span>
<a href="#l56.617"></a><span id="l56.617" class="difflineplus">+    }                 // if msgHdr</span>
<a href="#l56.618"></a><span id="l56.618" class="difflineplus">+  }                   // if we are supposed to sanitize junk mail</span>
<a href="#l56.619"></a><span id="l56.619"> </span>
<a href="#l56.620"></a><span id="l56.620">   /*</span>
<a href="#l56.621"></a><span id="l56.621" class="difflineminus">-  * What we do first is check for an external content handler plugin.</span>
<a href="#l56.622"></a><span id="l56.622" class="difflineminus">-  * This will actually extend the mime handling by calling a routine</span>
<a href="#l56.623"></a><span id="l56.623" class="difflineminus">-  * which will allow us to load an external content type handler</span>
<a href="#l56.624"></a><span id="l56.624" class="difflineminus">-  * for specific content types. If one is not found, we will drop back</span>
<a href="#l56.625"></a><span id="l56.625" class="difflineminus">-  * to the default handler.</span>
<a href="#l56.626"></a><span id="l56.626" class="difflineminus">-  */</span>
<a href="#l56.627"></a><span id="l56.627" class="difflineminus">-  if ((tempClass = mime_locate_external_content_handler(content_type, &amp;ctHandlerInfo)) != nullptr)</span>
<a href="#l56.628"></a><span id="l56.628" class="difflineminus">-  {</span>
<a href="#l56.629"></a><span id="l56.629" class="difflineplus">+   * What we do first is check for an external content handler plugin.</span>
<a href="#l56.630"></a><span id="l56.630" class="difflineplus">+   * This will actually extend the mime handling by calling a routine</span>
<a href="#l56.631"></a><span id="l56.631" class="difflineplus">+   * which will allow us to load an external content type handler</span>
<a href="#l56.632"></a><span id="l56.632" class="difflineplus">+   * for specific content types. If one is not found, we will drop back</span>
<a href="#l56.633"></a><span id="l56.633" class="difflineplus">+   * to the default handler.</span>
<a href="#l56.634"></a><span id="l56.634" class="difflineplus">+   */</span>
<a href="#l56.635"></a><span id="l56.635" class="difflineplus">+  if ((tempClass = mime_locate_external_content_handler(</span>
<a href="#l56.636"></a><span id="l56.636" class="difflineplus">+           content_type, &amp;ctHandlerInfo)) != nullptr) {</span>
<a href="#l56.637"></a><span id="l56.637"> #ifdef MOZ_THUNDERBIRD</span>
<a href="#l56.638"></a><span id="l56.638" class="difflineminus">-      // This is a case where we only want to add this property if we are a thunderbird build AND</span>
<a href="#l56.639"></a><span id="l56.639" class="difflineminus">-      // we have found an external mime content handler for text/calendar</span>
<a href="#l56.640"></a><span id="l56.640" class="difflineminus">-      // This will enable iMIP support in Lightning</span>
<a href="#l56.641"></a><span id="l56.641" class="difflineminus">-      if ( hdrs &amp;&amp; (!PL_strncasecmp(content_type, &quot;text/calendar&quot;, 13)))</span>
<a href="#l56.642"></a><span id="l56.642" class="difflineminus">-      {</span>
<a href="#l56.643"></a><span id="l56.643" class="difflineminus">-          char *full_content_type = MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l56.644"></a><span id="l56.644" class="difflineminus">-          if (full_content_type)</span>
<a href="#l56.645"></a><span id="l56.645" class="difflineminus">-          {</span>
<a href="#l56.646"></a><span id="l56.646" class="difflineminus">-              char *imip_method = MimeHeaders_get_parameter(full_content_type, &quot;method&quot;, nullptr, nullptr);</span>
<a href="#l56.647"></a><span id="l56.647" class="difflineminus">-              nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l56.648"></a><span id="l56.648" class="difflineminus">-              getMsgHdrForCurrentURL(opts, getter_AddRefs(msgHdr));</span>
<a href="#l56.649"></a><span id="l56.649" class="difflineminus">-              if (msgHdr)</span>
<a href="#l56.650"></a><span id="l56.650" class="difflineminus">-                msgHdr-&gt;SetStringProperty(&quot;imip_method&quot;, (imip_method) ? imip_method : &quot;nomethod&quot;);</span>
<a href="#l56.651"></a><span id="l56.651" class="difflineminus">-              // PR_Free checks for null</span>
<a href="#l56.652"></a><span id="l56.652" class="difflineminus">-              PR_Free(imip_method);</span>
<a href="#l56.653"></a><span id="l56.653" class="difflineminus">-              PR_Free(full_content_type);</span>
<a href="#l56.654"></a><span id="l56.654" class="difflineminus">-          }</span>
<a href="#l56.655"></a><span id="l56.655" class="difflineplus">+    // This is a case where we only want to add this property if we are a</span>
<a href="#l56.656"></a><span id="l56.656" class="difflineplus">+    // thunderbird build AND we have found an external mime content handler for</span>
<a href="#l56.657"></a><span id="l56.657" class="difflineplus">+    // text/calendar This will enable iMIP support in Lightning</span>
<a href="#l56.658"></a><span id="l56.658" class="difflineplus">+    if (hdrs &amp;&amp; (!PL_strncasecmp(content_type, &quot;text/calendar&quot;, 13))) {</span>
<a href="#l56.659"></a><span id="l56.659" class="difflineplus">+      char *full_content_type =</span>
<a href="#l56.660"></a><span id="l56.660" class="difflineplus">+          MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l56.661"></a><span id="l56.661" class="difflineplus">+      if (full_content_type) {</span>
<a href="#l56.662"></a><span id="l56.662" class="difflineplus">+        char *imip_method = MimeHeaders_get_parameter(</span>
<a href="#l56.663"></a><span id="l56.663" class="difflineplus">+            full_content_type, &quot;method&quot;, nullptr, nullptr);</span>
<a href="#l56.664"></a><span id="l56.664" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l56.665"></a><span id="l56.665" class="difflineplus">+        getMsgHdrForCurrentURL(opts, getter_AddRefs(msgHdr));</span>
<a href="#l56.666"></a><span id="l56.666" class="difflineplus">+        if (msgHdr)</span>
<a href="#l56.667"></a><span id="l56.667" class="difflineplus">+          msgHdr-&gt;SetStringProperty(&quot;imip_method&quot;,</span>
<a href="#l56.668"></a><span id="l56.668" class="difflineplus">+                                    (imip_method) ? imip_method : &quot;nomethod&quot;);</span>
<a href="#l56.669"></a><span id="l56.669" class="difflineplus">+        // PR_Free checks for null</span>
<a href="#l56.670"></a><span id="l56.670" class="difflineplus">+        PR_Free(imip_method);</span>
<a href="#l56.671"></a><span id="l56.671" class="difflineplus">+        PR_Free(full_content_type);</span>
<a href="#l56.672"></a><span id="l56.672">       }</span>
<a href="#l56.673"></a><span id="l56.673" class="difflineplus">+    }</span>
<a href="#l56.674"></a><span id="l56.674"> #endif</span>
<a href="#l56.675"></a><span id="l56.675"> </span>
<a href="#l56.676"></a><span id="l56.676">     if (types_of_classes_to_disallow &gt; 0 &amp;&amp;</span>
<a href="#l56.677"></a><span id="l56.677">         !PL_strncasecmp(content_type, &quot;text/x-vcard&quot;, 12))</span>
<a href="#l56.678"></a><span id="l56.678" class="difflineminus">-      /* Use a little hack to prevent some dangerous plugins, which ship</span>
<a href="#l56.679"></a><span id="l56.679" class="difflineminus">-         with Mozilla, to run.</span>
<a href="#l56.680"></a><span id="l56.680" class="difflineminus">-         For the truly user-installed plugins, we rely on the judgement</span>
<a href="#l56.681"></a><span id="l56.681" class="difflineminus">-         of the user. */</span>
<a href="#l56.682"></a><span id="l56.682" class="difflineplus">+    /* Use a little hack to prevent some dangerous plugins, which ship</span>
<a href="#l56.683"></a><span id="l56.683" class="difflineplus">+       with Mozilla, to run.</span>
<a href="#l56.684"></a><span id="l56.684" class="difflineplus">+       For the truly user-installed plugins, we rely on the judgement</span>
<a href="#l56.685"></a><span id="l56.685" class="difflineplus">+       of the user. */</span>
<a href="#l56.686"></a><span id="l56.686">     {</span>
<a href="#l56.687"></a><span id="l56.687">       if (!exact_match_p)</span>
<a href="#l56.688"></a><span id="l56.688" class="difflineminus">-        clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass; // As attachment</span>
<a href="#l56.689"></a><span id="l56.689" class="difflineminus">-    }</span>
<a href="#l56.690"></a><span id="l56.690" class="difflineminus">-    else</span>
<a href="#l56.691"></a><span id="l56.691" class="difflineplus">+        clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;  // As attachment</span>
<a href="#l56.692"></a><span id="l56.692" class="difflineplus">+    } else</span>
<a href="#l56.693"></a><span id="l56.693">       clazz = (MimeObjectClass *)tempClass;</span>
<a href="#l56.694"></a><span id="l56.694" class="difflineminus">-  }</span>
<a href="#l56.695"></a><span id="l56.695" class="difflineminus">-  else</span>
<a href="#l56.696"></a><span id="l56.696" class="difflineminus">-  {</span>
<a href="#l56.697"></a><span id="l56.697" class="difflineplus">+  } else {</span>
<a href="#l56.698"></a><span id="l56.698">     if (!content_type || !*content_type ||</span>
<a href="#l56.699"></a><span id="l56.699" class="difflineminus">-        !PL_strcasecmp(content_type, &quot;text&quot;))  /* with no / in the type */</span>
<a href="#l56.700"></a><span id="l56.700" class="difflineplus">+        !PL_strcasecmp(content_type, &quot;text&quot;)) /* with no / in the type */</span>
<a href="#l56.701"></a><span id="l56.701">       clazz = (MimeObjectClass *)&amp;mimeUntypedTextClass;</span>
<a href="#l56.702"></a><span id="l56.702"> </span>
<a href="#l56.703"></a><span id="l56.703">     /* Subtypes of text...</span>
<a href="#l56.704"></a><span id="l56.704" class="difflineminus">-    */</span>
<a href="#l56.705"></a><span id="l56.705" class="difflineminus">-    else if (!PL_strncasecmp(content_type, &quot;text/&quot;, 5))</span>
<a href="#l56.706"></a><span id="l56.706" class="difflineminus">-    {</span>
<a href="#l56.707"></a><span id="l56.707" class="difflineminus">-      if (!PL_strcasecmp(content_type+5, &quot;html&quot;))</span>
<a href="#l56.708"></a><span id="l56.708" class="difflineminus">-      {</span>
<a href="#l56.709"></a><span id="l56.709" class="difflineplus">+     */</span>
<a href="#l56.710"></a><span id="l56.710" class="difflineplus">+    else if (!PL_strncasecmp(content_type, &quot;text/&quot;, 5)) {</span>
<a href="#l56.711"></a><span id="l56.711" class="difflineplus">+      if (!PL_strcasecmp(content_type + 5, &quot;html&quot;)) {</span>
<a href="#l56.712"></a><span id="l56.712">         if (opts &amp;&amp;</span>
<a href="#l56.713"></a><span id="l56.713">             (opts-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs ||</span>
<a href="#l56.714"></a><span id="l56.714">              opts-&gt;format_out == nsMimeOutput::nsMimeMessageFilterSniffer ||</span>
<a href="#l56.715"></a><span id="l56.715">              opts-&gt;format_out == nsMimeOutput::nsMimeMessageDecrypt ||</span>
<a href="#l56.716"></a><span id="l56.716">              opts-&gt;format_out == nsMimeOutput::nsMimeMessageAttach))</span>
<a href="#l56.717"></a><span id="l56.717" class="difflineminus">-          // SaveAs in new modes doesn't work yet.</span>
<a href="#l56.718"></a><span id="l56.718" class="difflineplus">+        // SaveAs in new modes doesn't work yet.</span>
<a href="#l56.719"></a><span id="l56.719">         {</span>
<a href="#l56.720"></a><span id="l56.720">           // Don't use the parsed HTML class if we're ...</span>
<a href="#l56.721"></a><span id="l56.721">           // - saving the HTML of a message</span>
<a href="#l56.722"></a><span id="l56.722">           // - getting message content for filtering</span>
<a href="#l56.723"></a><span id="l56.723" class="difflineminus">-          // - snarfing attachments (nsMimeMessageDecrypt used in SnarfMsgAttachment)</span>
<a href="#l56.724"></a><span id="l56.724" class="difflineplus">+          // - snarfing attachments (nsMimeMessageDecrypt used in</span>
<a href="#l56.725"></a><span id="l56.725" class="difflineplus">+          // SnarfMsgAttachment)</span>
<a href="#l56.726"></a><span id="l56.726">           // - processing attachments (like deleting attachments).</span>
<a href="#l56.727"></a><span id="l56.727">           clazz = (MimeObjectClass *)&amp;mimeInlineTextHTMLClass;</span>
<a href="#l56.728"></a><span id="l56.728">           types_of_classes_to_disallow = 0;</span>
<a href="#l56.729"></a><span id="l56.729" class="difflineminus">-        }</span>
<a href="#l56.730"></a><span id="l56.730" class="difflineminus">-        else if (html_as == 0 || html_as == 4) // Render sender's HTML</span>
<a href="#l56.731"></a><span id="l56.731" class="difflineplus">+        } else if (html_as == 0 || html_as == 4)  // Render sender's HTML</span>
<a href="#l56.732"></a><span id="l56.732">           clazz = (MimeObjectClass *)&amp;mimeInlineTextHTMLParsedClass;</span>
<a href="#l56.733"></a><span id="l56.733" class="difflineminus">-        else if (html_as == 1) // convert HTML to plaintext</span>
<a href="#l56.734"></a><span id="l56.734" class="difflineplus">+        else if (html_as == 1)  // convert HTML to plaintext</span>
<a href="#l56.735"></a><span id="l56.735">           // Do a HTML-&gt;TXT-&gt;HTML conversion, see mimethpl.h.</span>
<a href="#l56.736"></a><span id="l56.736">           clazz = (MimeObjectClass *)&amp;mimeInlineTextHTMLAsPlaintextClass;</span>
<a href="#l56.737"></a><span id="l56.737" class="difflineminus">-        else if (html_as == 2) // display HTML source</span>
<a href="#l56.738"></a><span id="l56.738" class="difflineplus">+        else if (html_as == 2)  // display HTML source</span>
<a href="#l56.739"></a><span id="l56.739">           /* This is for the freaks. Treat HTML as plaintext,</span>
<a href="#l56.740"></a><span id="l56.740">              which will cause the HTML source to be displayed.</span>
<a href="#l56.741"></a><span id="l56.741">              Not very user-friendly, but some seem to want this. */</span>
<a href="#l56.742"></a><span id="l56.742">           clazz = (MimeObjectClass *)&amp;mimeInlineTextPlainClass;</span>
<a href="#l56.743"></a><span id="l56.743" class="difflineminus">-        else if (html_as == 3) // Sanitize</span>
<a href="#l56.744"></a><span id="l56.744" class="difflineplus">+        else if (html_as == 3)  // Sanitize</span>
<a href="#l56.745"></a><span id="l56.745">           // Strip all but allowed HTML</span>
<a href="#l56.746"></a><span id="l56.746">           clazz = (MimeObjectClass *)&amp;mimeInlineTextHTMLSanitizedClass;</span>
<a href="#l56.747"></a><span id="l56.747" class="difflineminus">-        else // Goofy pref</span>
<a href="#l56.748"></a><span id="l56.748" class="difflineplus">+        else  // Goofy pref</span>
<a href="#l56.749"></a><span id="l56.749">           /* User has an unknown pref value. Maybe he used a newer Mozilla</span>
<a href="#l56.750"></a><span id="l56.750">              with a new alternative to avoid HTML. Defaulting to option 1,</span>
<a href="#l56.751"></a><span id="l56.751">              which is less dangerous than defaulting to the raw HTML. */</span>
<a href="#l56.752"></a><span id="l56.752">           clazz = (MimeObjectClass *)&amp;mimeInlineTextHTMLAsPlaintextClass;</span>
<a href="#l56.753"></a><span id="l56.753" class="difflineminus">-      }</span>
<a href="#l56.754"></a><span id="l56.754" class="difflineminus">-      else if (!PL_strcasecmp(content_type+5, &quot;enriched&quot;))</span>
<a href="#l56.755"></a><span id="l56.755" class="difflineplus">+      } else if (!PL_strcasecmp(content_type + 5, &quot;enriched&quot;))</span>
<a href="#l56.756"></a><span id="l56.756">         clazz = (MimeObjectClass *)&amp;mimeInlineTextEnrichedClass;</span>
<a href="#l56.757"></a><span id="l56.757" class="difflineminus">-      else if (!PL_strcasecmp(content_type+5, &quot;richtext&quot;))</span>
<a href="#l56.758"></a><span id="l56.758" class="difflineplus">+      else if (!PL_strcasecmp(content_type + 5, &quot;richtext&quot;))</span>
<a href="#l56.759"></a><span id="l56.759">         clazz = (MimeObjectClass *)&amp;mimeInlineTextRichtextClass;</span>
<a href="#l56.760"></a><span id="l56.760" class="difflineminus">-      else if (!PL_strcasecmp(content_type+5, &quot;rtf&quot;))</span>
<a href="#l56.761"></a><span id="l56.761" class="difflineplus">+      else if (!PL_strcasecmp(content_type + 5, &quot;rtf&quot;))</span>
<a href="#l56.762"></a><span id="l56.762">         clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.763"></a><span id="l56.763" class="difflineminus">-      else if (!PL_strcasecmp(content_type+5, &quot;plain&quot;))</span>
<a href="#l56.764"></a><span id="l56.764" class="difflineminus">-      {</span>
<a href="#l56.765"></a><span id="l56.765" class="difflineplus">+      else if (!PL_strcasecmp(content_type + 5, &quot;plain&quot;)) {</span>
<a href="#l56.766"></a><span id="l56.766">         // Preliminary use the normal plain text</span>
<a href="#l56.767"></a><span id="l56.767">         clazz = (MimeObjectClass *)&amp;mimeInlineTextPlainClass;</span>
<a href="#l56.768"></a><span id="l56.768"> </span>
<a href="#l56.769"></a><span id="l56.769" class="difflineminus">-        if (opts &amp;&amp; opts-&gt;format_out != nsMimeOutput::nsMimeMessageFilterSniffer</span>
<a href="#l56.770"></a><span id="l56.770" class="difflineminus">-          &amp;&amp; opts-&gt;format_out != nsMimeOutput::nsMimeMessageAttach</span>
<a href="#l56.771"></a><span id="l56.771" class="difflineminus">-          &amp;&amp; opts-&gt;format_out != nsMimeOutput::nsMimeMessageRaw)</span>
<a href="#l56.772"></a><span id="l56.772" class="difflineminus">-        {</span>
<a href="#l56.773"></a><span id="l56.773" class="difflineplus">+        if (opts &amp;&amp;</span>
<a href="#l56.774"></a><span id="l56.774" class="difflineplus">+            opts-&gt;format_out != nsMimeOutput::nsMimeMessageFilterSniffer &amp;&amp;</span>
<a href="#l56.775"></a><span id="l56.775" class="difflineplus">+            opts-&gt;format_out != nsMimeOutput::nsMimeMessageAttach &amp;&amp;</span>
<a href="#l56.776"></a><span id="l56.776" class="difflineplus">+            opts-&gt;format_out != nsMimeOutput::nsMimeMessageRaw) {</span>
<a href="#l56.777"></a><span id="l56.777">           bool disable_format_flowed = false;</span>
<a href="#l56.778"></a><span id="l56.778">           if (prefBranch)</span>
<a href="#l56.779"></a><span id="l56.779" class="difflineminus">-            prefBranch-&gt;GetBoolPref(&quot;mailnews.display.disable_format_flowed_support&quot;,</span>
<a href="#l56.780"></a><span id="l56.780" class="difflineminus">-                                    &amp;disable_format_flowed);</span>
<a href="#l56.781"></a><span id="l56.781" class="difflineplus">+            prefBranch-&gt;GetBoolPref(</span>
<a href="#l56.782"></a><span id="l56.782" class="difflineplus">+                &quot;mailnews.display.disable_format_flowed_support&quot;,</span>
<a href="#l56.783"></a><span id="l56.783" class="difflineplus">+                &amp;disable_format_flowed);</span>
<a href="#l56.784"></a><span id="l56.784"> </span>
<a href="#l56.785"></a><span id="l56.785" class="difflineminus">-          if(!disable_format_flowed)</span>
<a href="#l56.786"></a><span id="l56.786" class="difflineminus">-          {</span>
<a href="#l56.787"></a><span id="l56.787" class="difflineplus">+          if (!disable_format_flowed) {</span>
<a href="#l56.788"></a><span id="l56.788">             // Check for format=flowed, damn, it is already stripped away from</span>
<a href="#l56.789"></a><span id="l56.789">             // the contenttype!</span>
<a href="#l56.790"></a><span id="l56.790">             // Look in headers instead even though it's expensive and clumsy</span>
<a href="#l56.791"></a><span id="l56.791">             // First find Content-Type:</span>
<a href="#l56.792"></a><span id="l56.792" class="difflineminus">-            char *content_type_row = hdrs ?</span>
<a href="#l56.793"></a><span id="l56.793" class="difflineminus">-               MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false) : 0;</span>
<a href="#l56.794"></a><span id="l56.794" class="difflineplus">+            char *content_type_row =</span>
<a href="#l56.795"></a><span id="l56.795" class="difflineplus">+                hdrs ? MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false)</span>
<a href="#l56.796"></a><span id="l56.796" class="difflineplus">+                     : 0;</span>
<a href="#l56.797"></a><span id="l56.797">             // Then the format parameter if there is one.</span>
<a href="#l56.798"></a><span id="l56.798">             // I would rather use a PARAM_FORMAT but I can't find the right</span>
<a href="#l56.799"></a><span id="l56.799">             // place to put the define. The others seems to be in net.h</span>
<a href="#l56.800"></a><span id="l56.800">             // but is that really really the right place? There is also</span>
<a href="#l56.801"></a><span id="l56.801">             // a nsMimeTypes.h but that one isn't included. Bug?</span>
<a href="#l56.802"></a><span id="l56.802" class="difflineminus">-            char *content_type_format = content_type_row ?</span>
<a href="#l56.803"></a><span id="l56.803" class="difflineminus">-               MimeHeaders_get_parameter(content_type_row, &quot;format&quot;, nullptr, nullptr) : 0;</span>
<a href="#l56.804"></a><span id="l56.804" class="difflineplus">+            char *content_type_format =</span>
<a href="#l56.805"></a><span id="l56.805" class="difflineplus">+                content_type_row</span>
<a href="#l56.806"></a><span id="l56.806" class="difflineplus">+                    ? MimeHeaders_get_parameter(content_type_row, &quot;format&quot;,</span>
<a href="#l56.807"></a><span id="l56.807" class="difflineplus">+                                                nullptr, nullptr)</span>
<a href="#l56.808"></a><span id="l56.808" class="difflineplus">+                    : 0;</span>
<a href="#l56.809"></a><span id="l56.809"> </span>
<a href="#l56.810"></a><span id="l56.810" class="difflineminus">-            if (content_type_format &amp;&amp; !PL_strcasecmp(content_type_format, &quot;flowed&quot;))</span>
<a href="#l56.811"></a><span id="l56.811" class="difflineplus">+            if (content_type_format &amp;&amp;</span>
<a href="#l56.812"></a><span id="l56.812" class="difflineplus">+                !PL_strcasecmp(content_type_format, &quot;flowed&quot;))</span>
<a href="#l56.813"></a><span id="l56.813">               clazz = (MimeObjectClass *)&amp;mimeInlineTextPlainFlowedClass;</span>
<a href="#l56.814"></a><span id="l56.814">             PR_FREEIF(content_type_format);</span>
<a href="#l56.815"></a><span id="l56.815">             PR_FREEIF(content_type_row);</span>
<a href="#l56.816"></a><span id="l56.816">           }</span>
<a href="#l56.817"></a><span id="l56.817">         }</span>
<a href="#l56.818"></a><span id="l56.818" class="difflineminus">-      }</span>
<a href="#l56.819"></a><span id="l56.819" class="difflineminus">-      else if (!exact_match_p)</span>
<a href="#l56.820"></a><span id="l56.820" class="difflineplus">+      } else if (!exact_match_p)</span>
<a href="#l56.821"></a><span id="l56.821">         clazz = (MimeObjectClass *)&amp;mimeInlineTextPlainClass;</span>
<a href="#l56.822"></a><span id="l56.822">     }</span>
<a href="#l56.823"></a><span id="l56.823"> </span>
<a href="#l56.824"></a><span id="l56.824">     /* Subtypes of multipart...</span>
<a href="#l56.825"></a><span id="l56.825" class="difflineminus">-    */</span>
<a href="#l56.826"></a><span id="l56.826" class="difflineminus">-    else if (!PL_strncasecmp(content_type, &quot;multipart/&quot;, 10))</span>
<a href="#l56.827"></a><span id="l56.827" class="difflineminus">-    {</span>
<a href="#l56.828"></a><span id="l56.828" class="difflineplus">+     */</span>
<a href="#l56.829"></a><span id="l56.829" class="difflineplus">+    else if (!PL_strncasecmp(content_type, &quot;multipart/&quot;, 10)) {</span>
<a href="#l56.830"></a><span id="l56.830">       // When html_as is 4, we want all MIME parts of the message to</span>
<a href="#l56.831"></a><span id="l56.831">       // show up in the displayed message body, if they are MIME types</span>
<a href="#l56.832"></a><span id="l56.832">       // that we know how to display, and also in the attachment pane</span>
<a href="#l56.833"></a><span id="l56.833">       // if it's appropriate to put them there. Both</span>
<a href="#l56.834"></a><span id="l56.834">       // multipart/alternative and multipart/related play games with</span>
<a href="#l56.835"></a><span id="l56.835">       // hiding various MIME parts, and we don't want that to happen,</span>
<a href="#l56.836"></a><span id="l56.836">       // so we prevent that by parsing those MIME types as</span>
<a href="#l56.837"></a><span id="l56.837">       // multipart/mixed, which won't mess with anything.</span>
<a href="#l56.838"></a><span id="l56.838" class="difflineat">@@ -608,67 +555,70 @@ mime_find_class(const char *content_type</span>
<a href="#l56.839"></a><span id="l56.839">       // i.e., we are reformatting the message to remove attachments,</span>
<a href="#l56.840"></a><span id="l56.840">       // we are in a similar boat. The code for deleting</span>
<a href="#l56.841"></a><span id="l56.841">       // attachments properly in that mode is in mimemult.cpp</span>
<a href="#l56.842"></a><span id="l56.842">       // functions which are inherited by mimeMultipartMixedClass but</span>
<a href="#l56.843"></a><span id="l56.843">       // not by mimeMultipartAlternativeClass or</span>
<a href="#l56.844"></a><span id="l56.844">       // mimeMultipartRelatedClass. Therefore, to ensure that</span>
<a href="#l56.845"></a><span id="l56.845">       // everything is handled properly, in this context too we parse</span>
<a href="#l56.846"></a><span id="l56.846">       // those MIME types as multipart/mixed.</span>
<a href="#l56.847"></a><span id="l56.847" class="difflineminus">-      bool basic_formatting = (html_as == 4) ||</span>
<a href="#l56.848"></a><span id="l56.848" class="difflineminus">-        (opts &amp;&amp; opts-&gt;format_out == nsMimeOutput::nsMimeMessageAttach);</span>
<a href="#l56.849"></a><span id="l56.849" class="difflineminus">-      if      (!PL_strcasecmp(content_type+10, &quot;alternative&quot;))</span>
<a href="#l56.850"></a><span id="l56.850" class="difflineminus">-        clazz = basic_formatting ? (MimeObjectClass *)&amp;mimeMultipartMixedClass :</span>
<a href="#l56.851"></a><span id="l56.851" class="difflineminus">-          (MimeObjectClass *)&amp;mimeMultipartAlternativeClass;</span>
<a href="#l56.852"></a><span id="l56.852" class="difflineminus">-      else if (!PL_strcasecmp(content_type+10, &quot;related&quot;))</span>
<a href="#l56.853"></a><span id="l56.853" class="difflineminus">-        clazz = basic_formatting ? (MimeObjectClass *)&amp;mimeMultipartMixedClass :</span>
<a href="#l56.854"></a><span id="l56.854" class="difflineminus">-          (MimeObjectClass *)&amp;mimeMultipartRelatedClass;</span>
<a href="#l56.855"></a><span id="l56.855" class="difflineminus">-      else if (!PL_strcasecmp(content_type+10, &quot;digest&quot;))</span>
<a href="#l56.856"></a><span id="l56.856" class="difflineplus">+      bool basic_formatting =</span>
<a href="#l56.857"></a><span id="l56.857" class="difflineplus">+          (html_as == 4) ||</span>
<a href="#l56.858"></a><span id="l56.858" class="difflineplus">+          (opts &amp;&amp; opts-&gt;format_out == nsMimeOutput::nsMimeMessageAttach);</span>
<a href="#l56.859"></a><span id="l56.859" class="difflineplus">+      if (!PL_strcasecmp(content_type + 10, &quot;alternative&quot;))</span>
<a href="#l56.860"></a><span id="l56.860" class="difflineplus">+        clazz = basic_formatting</span>
<a href="#l56.861"></a><span id="l56.861" class="difflineplus">+                    ? (MimeObjectClass *)&amp;mimeMultipartMixedClass</span>
<a href="#l56.862"></a><span id="l56.862" class="difflineplus">+                    : (MimeObjectClass *)&amp;mimeMultipartAlternativeClass;</span>
<a href="#l56.863"></a><span id="l56.863" class="difflineplus">+      else if (!PL_strcasecmp(content_type + 10, &quot;related&quot;))</span>
<a href="#l56.864"></a><span id="l56.864" class="difflineplus">+        clazz = basic_formatting</span>
<a href="#l56.865"></a><span id="l56.865" class="difflineplus">+                    ? (MimeObjectClass *)&amp;mimeMultipartMixedClass</span>
<a href="#l56.866"></a><span id="l56.866" class="difflineplus">+                    : (MimeObjectClass *)&amp;mimeMultipartRelatedClass;</span>
<a href="#l56.867"></a><span id="l56.867" class="difflineplus">+      else if (!PL_strcasecmp(content_type + 10, &quot;digest&quot;))</span>
<a href="#l56.868"></a><span id="l56.868">         clazz = (MimeObjectClass *)&amp;mimeMultipartDigestClass;</span>
<a href="#l56.869"></a><span id="l56.869" class="difflineminus">-      else if (!PL_strcasecmp(content_type+10, &quot;appledouble&quot;) ||</span>
<a href="#l56.870"></a><span id="l56.870" class="difflineminus">-               !PL_strcasecmp(content_type+10, &quot;header-set&quot;))</span>
<a href="#l56.871"></a><span id="l56.871" class="difflineplus">+      else if (!PL_strcasecmp(content_type + 10, &quot;appledouble&quot;) ||</span>
<a href="#l56.872"></a><span id="l56.872" class="difflineplus">+               !PL_strcasecmp(content_type + 10, &quot;header-set&quot;))</span>
<a href="#l56.873"></a><span id="l56.873">         clazz = (MimeObjectClass *)&amp;mimeMultipartAppleDoubleClass;</span>
<a href="#l56.874"></a><span id="l56.874" class="difflineminus">-      else if (!PL_strcasecmp(content_type+10, &quot;parallel&quot;))</span>
<a href="#l56.875"></a><span id="l56.875" class="difflineplus">+      else if (!PL_strcasecmp(content_type + 10, &quot;parallel&quot;))</span>
<a href="#l56.876"></a><span id="l56.876">         clazz = (MimeObjectClass *)&amp;mimeMultipartParallelClass;</span>
<a href="#l56.877"></a><span id="l56.877" class="difflineminus">-      else if (!PL_strcasecmp(content_type+10, &quot;mixed&quot;))</span>
<a href="#l56.878"></a><span id="l56.878" class="difflineplus">+      else if (!PL_strcasecmp(content_type + 10, &quot;mixed&quot;))</span>
<a href="#l56.879"></a><span id="l56.879">         clazz = (MimeObjectClass *)&amp;mimeMultipartMixedClass;</span>
<a href="#l56.880"></a><span id="l56.880"> #ifdef ENABLE_SMIME</span>
<a href="#l56.881"></a><span id="l56.881" class="difflineminus">-      else if (!PL_strcasecmp(content_type+10, &quot;signed&quot;))</span>
<a href="#l56.882"></a><span id="l56.882" class="difflineminus">-      {</span>
<a href="#l56.883"></a><span id="l56.883" class="difflineplus">+      else if (!PL_strcasecmp(content_type + 10, &quot;signed&quot;)) {</span>
<a href="#l56.884"></a><span id="l56.884">         /* Check that the &quot;protocol&quot; and &quot;micalg&quot; parameters are ones we</span>
<a href="#l56.885"></a><span id="l56.885">            know about. */</span>
<a href="#l56.886"></a><span id="l56.886" class="difflineminus">-        char *ct = hdrs ?</span>
<a href="#l56.887"></a><span id="l56.887" class="difflineminus">-          MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false) : 0;</span>
<a href="#l56.888"></a><span id="l56.888" class="difflineminus">-        char *proto = ct ?</span>
<a href="#l56.889"></a><span id="l56.889" class="difflineminus">-          MimeHeaders_get_parameter(ct, PARAM_PROTOCOL, nullptr, nullptr) : 0;</span>
<a href="#l56.890"></a><span id="l56.890" class="difflineminus">-        char *micalg = ct ?</span>
<a href="#l56.891"></a><span id="l56.891" class="difflineminus">-          MimeHeaders_get_parameter(ct, PARAM_MICALG, nullptr, nullptr) : 0;</span>
<a href="#l56.892"></a><span id="l56.892" class="difflineplus">+        char *ct =</span>
<a href="#l56.893"></a><span id="l56.893" class="difflineplus">+            hdrs ? MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false) : 0;</span>
<a href="#l56.894"></a><span id="l56.894" class="difflineplus">+        char *proto =</span>
<a href="#l56.895"></a><span id="l56.895" class="difflineplus">+            ct ? MimeHeaders_get_parameter(ct, PARAM_PROTOCOL, nullptr, nullptr)</span>
<a href="#l56.896"></a><span id="l56.896" class="difflineplus">+               : 0;</span>
<a href="#l56.897"></a><span id="l56.897" class="difflineplus">+        char *micalg =</span>
<a href="#l56.898"></a><span id="l56.898" class="difflineplus">+            ct ? MimeHeaders_get_parameter(ct, PARAM_MICALG, nullptr, nullptr)</span>
<a href="#l56.899"></a><span id="l56.899" class="difflineplus">+               : 0;</span>
<a href="#l56.900"></a><span id="l56.900"> </span>
<a href="#l56.901"></a><span id="l56.901" class="difflineminus">-        if (proto &amp;&amp;</span>
<a href="#l56.902"></a><span id="l56.902" class="difflineminus">-            ((/* is a signature */</span>
<a href="#l56.903"></a><span id="l56.903" class="difflineminus">-             !PL_strcasecmp(proto, APPLICATION_XPKCS7_SIGNATURE) ||</span>
<a href="#l56.904"></a><span id="l56.904" class="difflineminus">-             !PL_strcasecmp(proto, APPLICATION_PKCS7_SIGNATURE)) &amp;&amp;</span>
<a href="#l56.905"></a><span id="l56.905" class="difflineminus">-             micalg &amp;&amp;</span>
<a href="#l56.906"></a><span id="l56.906" class="difflineminus">-             (!PL_strcasecmp(micalg, PARAM_MICALG_MD5) ||</span>
<a href="#l56.907"></a><span id="l56.907" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_MD5_2) ||</span>
<a href="#l56.908"></a><span id="l56.908" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA1) ||</span>
<a href="#l56.909"></a><span id="l56.909" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_2) ||</span>
<a href="#l56.910"></a><span id="l56.910" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_3) ||</span>
<a href="#l56.911"></a><span id="l56.911" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_4) ||</span>
<a href="#l56.912"></a><span id="l56.912" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_5) ||</span>
<a href="#l56.913"></a><span id="l56.913" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA256) ||</span>
<a href="#l56.914"></a><span id="l56.914" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA256_2) ||</span>
<a href="#l56.915"></a><span id="l56.915" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA256_3) ||</span>
<a href="#l56.916"></a><span id="l56.916" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA384) ||</span>
<a href="#l56.917"></a><span id="l56.917" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA384_2) ||</span>
<a href="#l56.918"></a><span id="l56.918" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA384_3) ||</span>
<a href="#l56.919"></a><span id="l56.919" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA512) ||</span>
<a href="#l56.920"></a><span id="l56.920" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA512_2) ||</span>
<a href="#l56.921"></a><span id="l56.921" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_SHA512_3) ||</span>
<a href="#l56.922"></a><span id="l56.922" class="difflineminus">-              !PL_strcasecmp(micalg, PARAM_MICALG_MD2))))</span>
<a href="#l56.923"></a><span id="l56.923" class="difflineplus">+        if (proto &amp;&amp; ((/* is a signature */</span>
<a href="#l56.924"></a><span id="l56.924" class="difflineplus">+                       !PL_strcasecmp(proto, APPLICATION_XPKCS7_SIGNATURE) ||</span>
<a href="#l56.925"></a><span id="l56.925" class="difflineplus">+                       !PL_strcasecmp(proto, APPLICATION_PKCS7_SIGNATURE)) &amp;&amp;</span>
<a href="#l56.926"></a><span id="l56.926" class="difflineplus">+                      micalg &amp;&amp;</span>
<a href="#l56.927"></a><span id="l56.927" class="difflineplus">+                      (!PL_strcasecmp(micalg, PARAM_MICALG_MD5) ||</span>
<a href="#l56.928"></a><span id="l56.928" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_MD5_2) ||</span>
<a href="#l56.929"></a><span id="l56.929" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA1) ||</span>
<a href="#l56.930"></a><span id="l56.930" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_2) ||</span>
<a href="#l56.931"></a><span id="l56.931" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_3) ||</span>
<a href="#l56.932"></a><span id="l56.932" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_4) ||</span>
<a href="#l56.933"></a><span id="l56.933" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_5) ||</span>
<a href="#l56.934"></a><span id="l56.934" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA256) ||</span>
<a href="#l56.935"></a><span id="l56.935" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA256_2) ||</span>
<a href="#l56.936"></a><span id="l56.936" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA256_3) ||</span>
<a href="#l56.937"></a><span id="l56.937" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA384) ||</span>
<a href="#l56.938"></a><span id="l56.938" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA384_2) ||</span>
<a href="#l56.939"></a><span id="l56.939" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA384_3) ||</span>
<a href="#l56.940"></a><span id="l56.940" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA512) ||</span>
<a href="#l56.941"></a><span id="l56.941" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA512_2) ||</span>
<a href="#l56.942"></a><span id="l56.942" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_SHA512_3) ||</span>
<a href="#l56.943"></a><span id="l56.943" class="difflineplus">+                       !PL_strcasecmp(micalg, PARAM_MICALG_MD2))))</span>
<a href="#l56.944"></a><span id="l56.944">           clazz = (MimeObjectClass *)&amp;mimeMultipartSignedCMSClass;</span>
<a href="#l56.945"></a><span id="l56.945">         else</span>
<a href="#l56.946"></a><span id="l56.946">           clazz = 0;</span>
<a href="#l56.947"></a><span id="l56.947"> </span>
<a href="#l56.948"></a><span id="l56.948">         PR_FREEIF(proto);</span>
<a href="#l56.949"></a><span id="l56.949">         PR_FREEIF(micalg);</span>
<a href="#l56.950"></a><span id="l56.950">         PR_FREEIF(ct);</span>
<a href="#l56.951"></a><span id="l56.951">       }</span>
<a href="#l56.952"></a><span id="l56.952" class="difflineat">@@ -680,148 +630,140 @@ mime_find_class(const char *content_type</span>
<a href="#l56.953"></a><span id="l56.953"> </span>
<a href="#l56.954"></a><span id="l56.954">       /* If we are sniffing a message, let's treat alternative parts as mixed */</span>
<a href="#l56.955"></a><span id="l56.955">       if (opts &amp;&amp; opts-&gt;format_out == nsMimeOutput::nsMimeMessageFilterSniffer)</span>
<a href="#l56.956"></a><span id="l56.956">         if (clazz == (MimeObjectClass *)&amp;mimeMultipartAlternativeClass)</span>
<a href="#l56.957"></a><span id="l56.957">           clazz = (MimeObjectClass *)&amp;mimeMultipartMixedClass;</span>
<a href="#l56.958"></a><span id="l56.958">     }</span>
<a href="#l56.959"></a><span id="l56.959"> </span>
<a href="#l56.960"></a><span id="l56.960">     /* Subtypes of message...</span>
<a href="#l56.961"></a><span id="l56.961" class="difflineminus">-    */</span>
<a href="#l56.962"></a><span id="l56.962" class="difflineminus">-    else if (!PL_strncasecmp(content_type, &quot;message/&quot;, 8))</span>
<a href="#l56.963"></a><span id="l56.963" class="difflineminus">-    {</span>
<a href="#l56.964"></a><span id="l56.964" class="difflineminus">-      if (!PL_strcasecmp(content_type+8, &quot;rfc822&quot;) ||</span>
<a href="#l56.965"></a><span id="l56.965" class="difflineminus">-        !PL_strcasecmp(content_type+8, &quot;news&quot;))</span>
<a href="#l56.966"></a><span id="l56.966" class="difflineplus">+     */</span>
<a href="#l56.967"></a><span id="l56.967" class="difflineplus">+    else if (!PL_strncasecmp(content_type, &quot;message/&quot;, 8)) {</span>
<a href="#l56.968"></a><span id="l56.968" class="difflineplus">+      if (!PL_strcasecmp(content_type + 8, &quot;rfc822&quot;) ||</span>
<a href="#l56.969"></a><span id="l56.969" class="difflineplus">+          !PL_strcasecmp(content_type + 8, &quot;news&quot;))</span>
<a href="#l56.970"></a><span id="l56.970">         clazz = (MimeObjectClass *)&amp;mimeMessageClass;</span>
<a href="#l56.971"></a><span id="l56.971" class="difflineminus">-      else if (!PL_strcasecmp(content_type+8, &quot;external-body&quot;))</span>
<a href="#l56.972"></a><span id="l56.972" class="difflineplus">+      else if (!PL_strcasecmp(content_type + 8, &quot;external-body&quot;))</span>
<a href="#l56.973"></a><span id="l56.973">         clazz = (MimeObjectClass *)&amp;mimeExternalBodyClass;</span>
<a href="#l56.974"></a><span id="l56.974" class="difflineminus">-      else if (!PL_strcasecmp(content_type+8, &quot;partial&quot;))</span>
<a href="#l56.975"></a><span id="l56.975" class="difflineplus">+      else if (!PL_strcasecmp(content_type + 8, &quot;partial&quot;))</span>
<a href="#l56.976"></a><span id="l56.976">         /* I guess these are most useful as externals, for now... */</span>
<a href="#l56.977"></a><span id="l56.977">         clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.978"></a><span id="l56.978">       else if (!exact_match_p)</span>
<a href="#l56.979"></a><span id="l56.979">         /* Treat all unknown message subtypes as &quot;text/plain&quot; */</span>
<a href="#l56.980"></a><span id="l56.980">         clazz = (MimeObjectClass *)&amp;mimeInlineTextPlainClass;</span>
<a href="#l56.981"></a><span id="l56.981">     }</span>
<a href="#l56.982"></a><span id="l56.982"> </span>
<a href="#l56.983"></a><span id="l56.983">     /* The magic image types which we are able to display internally...</span>
<a href="#l56.984"></a><span id="l56.984" class="difflineminus">-    */</span>
<a href="#l56.985"></a><span id="l56.985" class="difflineplus">+     */</span>
<a href="#l56.986"></a><span id="l56.986">     else if (!PL_strncasecmp(content_type, &quot;image/&quot;, 6)) {</span>
<a href="#l56.987"></a><span id="l56.987" class="difflineminus">-        if (imgLoader::SupportImageWithMimeType(content_type, AcceptedMimeTypes::IMAGES_AND_DOCUMENTS))</span>
<a href="#l56.988"></a><span id="l56.988" class="difflineminus">-          clazz = (MimeObjectClass *)&amp;mimeInlineImageClass;</span>
<a href="#l56.989"></a><span id="l56.989" class="difflineminus">-        else</span>
<a href="#l56.990"></a><span id="l56.990" class="difflineminus">-          clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.991"></a><span id="l56.991" class="difflineplus">+      if (imgLoader::SupportImageWithMimeType(</span>
<a href="#l56.992"></a><span id="l56.992" class="difflineplus">+              content_type, AcceptedMimeTypes::IMAGES_AND_DOCUMENTS))</span>
<a href="#l56.993"></a><span id="l56.993" class="difflineplus">+        clazz = (MimeObjectClass *)&amp;mimeInlineImageClass;</span>
<a href="#l56.994"></a><span id="l56.994" class="difflineplus">+      else</span>
<a href="#l56.995"></a><span id="l56.995" class="difflineplus">+        clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.996"></a><span id="l56.996">     }</span>
<a href="#l56.997"></a><span id="l56.997" class="difflineminus">-</span>
<a href="#l56.998"></a><span id="l56.998"> #ifdef ENABLE_SMIME</span>
<a href="#l56.999"></a><span id="l56.999">     else if (!PL_strcasecmp(content_type, APPLICATION_XPKCS7_MIME) ||</span>
<a href="#l56.1000"></a><span id="l56.1000">              !PL_strcasecmp(content_type, APPLICATION_PKCS7_MIME)) {</span>
<a href="#l56.1001"></a><span id="l56.1001"> </span>
<a href="#l56.1002"></a><span id="l56.1002" class="difflineminus">-        if (Preferences::GetBool(&quot;mailnews.p7m_subparts_external&quot;, true) &amp;&amp;</span>
<a href="#l56.1003"></a><span id="l56.1003" class="difflineminus">-            opts-&gt;is_child) {</span>
<a href="#l56.1004"></a><span id="l56.1004" class="difflineminus">-          // We do not allow encrypted parts except as top level.</span>
<a href="#l56.1005"></a><span id="l56.1005" class="difflineminus">-          // Allowing them would leak the plain text in case the part is</span>
<a href="#l56.1006"></a><span id="l56.1006" class="difflineminus">-          // cleverly hidden and the decrypted content gets included in</span>
<a href="#l56.1007"></a><span id="l56.1007" class="difflineminus">-          // replies and forwards.</span>
<a href="#l56.1008"></a><span id="l56.1008" class="difflineminus">-          clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1009"></a><span id="l56.1009" class="difflineminus">-          return clazz;</span>
<a href="#l56.1010"></a><span id="l56.1010" class="difflineminus">-        }</span>
<a href="#l56.1011"></a><span id="l56.1011" class="difflineplus">+      if (Preferences::GetBool(&quot;mailnews.p7m_subparts_external&quot;, true) &amp;&amp;</span>
<a href="#l56.1012"></a><span id="l56.1012" class="difflineplus">+          opts-&gt;is_child) {</span>
<a href="#l56.1013"></a><span id="l56.1013" class="difflineplus">+        // We do not allow encrypted parts except as top level.</span>
<a href="#l56.1014"></a><span id="l56.1014" class="difflineplus">+        // Allowing them would leak the plain text in case the part is</span>
<a href="#l56.1015"></a><span id="l56.1015" class="difflineplus">+        // cleverly hidden and the decrypted content gets included in</span>
<a href="#l56.1016"></a><span id="l56.1016" class="difflineplus">+        // replies and forwards.</span>
<a href="#l56.1017"></a><span id="l56.1017" class="difflineplus">+        clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1018"></a><span id="l56.1018" class="difflineplus">+        return clazz;</span>
<a href="#l56.1019"></a><span id="l56.1019" class="difflineplus">+      }</span>
<a href="#l56.1020"></a><span id="l56.1020"> </span>
<a href="#l56.1021"></a><span id="l56.1021" class="difflineminus">-        char *ct = hdrs ?</span>
<a href="#l56.1022"></a><span id="l56.1022" class="difflineminus">-          MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false) : nullptr;</span>
<a href="#l56.1023"></a><span id="l56.1023" class="difflineminus">-        char *st = ct ?</span>
<a href="#l56.1024"></a><span id="l56.1024" class="difflineminus">-          MimeHeaders_get_parameter(ct, &quot;smime-type&quot;, nullptr, nullptr) : nullptr;</span>
<a href="#l56.1025"></a><span id="l56.1025" class="difflineplus">+      char *ct = hdrs ? MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false)</span>
<a href="#l56.1026"></a><span id="l56.1026" class="difflineplus">+                      : nullptr;</span>
<a href="#l56.1027"></a><span id="l56.1027" class="difflineplus">+      char *st =</span>
<a href="#l56.1028"></a><span id="l56.1028" class="difflineplus">+          ct ? MimeHeaders_get_parameter(ct, &quot;smime-type&quot;, nullptr, nullptr)</span>
<a href="#l56.1029"></a><span id="l56.1029" class="difflineplus">+             : nullptr;</span>
<a href="#l56.1030"></a><span id="l56.1030"> </span>
<a href="#l56.1031"></a><span id="l56.1031" class="difflineminus">-        /* by default, assume that it is an encrypted message */</span>
<a href="#l56.1032"></a><span id="l56.1032" class="difflineminus">-        clazz = (MimeObjectClass *)&amp;mimeEncryptedCMSClass;</span>
<a href="#l56.1033"></a><span id="l56.1033" class="difflineplus">+      /* by default, assume that it is an encrypted message */</span>
<a href="#l56.1034"></a><span id="l56.1034" class="difflineplus">+      clazz = (MimeObjectClass *)&amp;mimeEncryptedCMSClass;</span>
<a href="#l56.1035"></a><span id="l56.1035"> </span>
<a href="#l56.1036"></a><span id="l56.1036" class="difflineminus">-        /* if the smime-type parameter says that it's a certs-only or</span>
<a href="#l56.1037"></a><span id="l56.1037" class="difflineminus">-           compressed file, then show it as an attachment, however</span>
<a href="#l56.1038"></a><span id="l56.1038" class="difflineminus">-           (MimeEncryptedCMS doesn't handle these correctly) */</span>
<a href="#l56.1039"></a><span id="l56.1039" class="difflineminus">-        if (st &amp;&amp;</span>
<a href="#l56.1040"></a><span id="l56.1040" class="difflineminus">-            (!PL_strcasecmp(st, &quot;certs-only&quot;) ||</span>
<a href="#l56.1041"></a><span id="l56.1041" class="difflineminus">-             !PL_strcasecmp(st, &quot;compressed-data&quot;)))</span>
<a href="#l56.1042"></a><span id="l56.1042" class="difflineminus">-          clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1043"></a><span id="l56.1043" class="difflineminus">-        else {</span>
<a href="#l56.1044"></a><span id="l56.1044" class="difflineminus">-          /* look at the file extension... less reliable, but still covered</span>
<a href="#l56.1045"></a><span id="l56.1045" class="difflineminus">-             by the S/MIME specification (RFC 3851, section 3.2.1)  */</span>
<a href="#l56.1046"></a><span id="l56.1046" class="difflineminus">-          char *name = (hdrs ? MimeHeaders_get_name(hdrs, opts) : nullptr);</span>
<a href="#l56.1047"></a><span id="l56.1047" class="difflineminus">-          if (name) {</span>
<a href="#l56.1048"></a><span id="l56.1048" class="difflineminus">-            char *suf = PL_strrchr(name, '.');</span>
<a href="#l56.1049"></a><span id="l56.1049" class="difflineminus">-            bool p7mExternal = false;</span>
<a href="#l56.1050"></a><span id="l56.1050" class="difflineplus">+      /* if the smime-type parameter says that it's a certs-only or</span>
<a href="#l56.1051"></a><span id="l56.1051" class="difflineplus">+         compressed file, then show it as an attachment, however</span>
<a href="#l56.1052"></a><span id="l56.1052" class="difflineplus">+         (MimeEncryptedCMS doesn't handle these correctly) */</span>
<a href="#l56.1053"></a><span id="l56.1053" class="difflineplus">+      if (st &amp;&amp; (!PL_strcasecmp(st, &quot;certs-only&quot;) ||</span>
<a href="#l56.1054"></a><span id="l56.1054" class="difflineplus">+                 !PL_strcasecmp(st, &quot;compressed-data&quot;)))</span>
<a href="#l56.1055"></a><span id="l56.1055" class="difflineplus">+        clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1056"></a><span id="l56.1056" class="difflineplus">+      else {</span>
<a href="#l56.1057"></a><span id="l56.1057" class="difflineplus">+        /* look at the file extension... less reliable, but still covered</span>
<a href="#l56.1058"></a><span id="l56.1058" class="difflineplus">+           by the S/MIME specification (RFC 3851, section 3.2.1)  */</span>
<a href="#l56.1059"></a><span id="l56.1059" class="difflineplus">+        char *name = (hdrs ? MimeHeaders_get_name(hdrs, opts) : nullptr);</span>
<a href="#l56.1060"></a><span id="l56.1060" class="difflineplus">+        if (name) {</span>
<a href="#l56.1061"></a><span id="l56.1061" class="difflineplus">+          char *suf = PL_strrchr(name, '.');</span>
<a href="#l56.1062"></a><span id="l56.1062" class="difflineplus">+          bool p7mExternal = false;</span>
<a href="#l56.1063"></a><span id="l56.1063"> </span>
<a href="#l56.1064"></a><span id="l56.1064" class="difflineminus">-            if (prefBranch)</span>
<a href="#l56.1065"></a><span id="l56.1065" class="difflineminus">-              prefBranch-&gt;GetBoolPref(&quot;mailnews.p7m_external&quot;, &amp;p7mExternal);</span>
<a href="#l56.1066"></a><span id="l56.1066" class="difflineminus">-            if (suf &amp;&amp;</span>
<a href="#l56.1067"></a><span id="l56.1067" class="difflineminus">-                ((!PL_strcasecmp(suf, &quot;.p7m&quot;) &amp;&amp; p7mExternal) ||</span>
<a href="#l56.1068"></a><span id="l56.1068" class="difflineminus">-                 !PL_strcasecmp(suf, &quot;.p7c&quot;) ||</span>
<a href="#l56.1069"></a><span id="l56.1069" class="difflineminus">-                 !PL_strcasecmp(suf, &quot;.p7z&quot;)))</span>
<a href="#l56.1070"></a><span id="l56.1070" class="difflineminus">-              clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1071"></a><span id="l56.1071" class="difflineminus">-          }</span>
<a href="#l56.1072"></a><span id="l56.1072" class="difflineminus">-          PR_Free(name);</span>
<a href="#l56.1073"></a><span id="l56.1073" class="difflineplus">+          if (prefBranch)</span>
<a href="#l56.1074"></a><span id="l56.1074" class="difflineplus">+            prefBranch-&gt;GetBoolPref(&quot;mailnews.p7m_external&quot;, &amp;p7mExternal);</span>
<a href="#l56.1075"></a><span id="l56.1075" class="difflineplus">+          if (suf &amp;&amp;</span>
<a href="#l56.1076"></a><span id="l56.1076" class="difflineplus">+              ((!PL_strcasecmp(suf, &quot;.p7m&quot;) &amp;&amp; p7mExternal) ||</span>
<a href="#l56.1077"></a><span id="l56.1077" class="difflineplus">+               !PL_strcasecmp(suf, &quot;.p7c&quot;) || !PL_strcasecmp(suf, &quot;.p7z&quot;)))</span>
<a href="#l56.1078"></a><span id="l56.1078" class="difflineplus">+            clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1079"></a><span id="l56.1079">         }</span>
<a href="#l56.1080"></a><span id="l56.1080" class="difflineminus">-        PR_Free(st);</span>
<a href="#l56.1081"></a><span id="l56.1081" class="difflineminus">-        PR_Free(ct);</span>
<a href="#l56.1082"></a><span id="l56.1082" class="difflineplus">+        PR_Free(name);</span>
<a href="#l56.1083"></a><span id="l56.1083" class="difflineplus">+      }</span>
<a href="#l56.1084"></a><span id="l56.1084" class="difflineplus">+      PR_Free(st);</span>
<a href="#l56.1085"></a><span id="l56.1085" class="difflineplus">+      PR_Free(ct);</span>
<a href="#l56.1086"></a><span id="l56.1086">     }</span>
<a href="#l56.1087"></a><span id="l56.1087"> #endif</span>
<a href="#l56.1088"></a><span id="l56.1088">     /* A few types which occur in the real world and which we would otherwise</span>
<a href="#l56.1089"></a><span id="l56.1089">     treat as non-text types (which would be bad) without this special-case...</span>
<a href="#l56.1090"></a><span id="l56.1090">     */</span>
<a href="#l56.1091"></a><span id="l56.1091">     else if (!PL_strcasecmp(content_type, APPLICATION_PGP) ||</span>
<a href="#l56.1092"></a><span id="l56.1092">              !PL_strcasecmp(content_type, APPLICATION_PGP2))</span>
<a href="#l56.1093"></a><span id="l56.1093">       clazz = (MimeObjectClass *)&amp;mimeInlineTextPlainClass;</span>
<a href="#l56.1094"></a><span id="l56.1094"> </span>
<a href="#l56.1095"></a><span id="l56.1095">     else if (!PL_strcasecmp(content_type, SUN_ATTACHMENT))</span>
<a href="#l56.1096"></a><span id="l56.1096">       clazz = (MimeObjectClass *)&amp;mimeSunAttachmentClass;</span>
<a href="#l56.1097"></a><span id="l56.1097"> </span>
<a href="#l56.1098"></a><span id="l56.1098">     /* Everything else gets represented as a clickable link.</span>
<a href="#l56.1099"></a><span id="l56.1099" class="difflineminus">-    */</span>
<a href="#l56.1100"></a><span id="l56.1100" class="difflineplus">+     */</span>
<a href="#l56.1101"></a><span id="l56.1101">     else if (!exact_match_p)</span>
<a href="#l56.1102"></a><span id="l56.1102">       clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1103"></a><span id="l56.1103"> </span>
<a href="#l56.1104"></a><span id="l56.1104" class="difflineminus">-    if (!mime_is_allowed_class(clazz, types_of_classes_to_disallow))</span>
<a href="#l56.1105"></a><span id="l56.1105" class="difflineminus">-    {</span>
<a href="#l56.1106"></a><span id="l56.1106" class="difflineplus">+    if (!mime_is_allowed_class(clazz, types_of_classes_to_disallow)) {</span>
<a href="#l56.1107"></a><span id="l56.1107">       /* Do that check here (not after the if block), because we want to allow</span>
<a href="#l56.1108"></a><span id="l56.1108">          user-installed plugins. */</span>
<a href="#l56.1109"></a><span id="l56.1109" class="difflineminus">-      if(!exact_match_p)</span>
<a href="#l56.1110"></a><span id="l56.1110" class="difflineplus">+      if (!exact_match_p)</span>
<a href="#l56.1111"></a><span id="l56.1111">         clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1112"></a><span id="l56.1112">       else</span>
<a href="#l56.1113"></a><span id="l56.1113">         clazz = 0;</span>
<a href="#l56.1114"></a><span id="l56.1114">     }</span>
<a href="#l56.1115"></a><span id="l56.1115">   }</span>
<a href="#l56.1116"></a><span id="l56.1116"> </span>
<a href="#l56.1117"></a><span id="l56.1117"> #ifdef ENABLE_SMIME</span>
<a href="#l56.1118"></a><span id="l56.1118">   // see bug #189988</span>
<a href="#l56.1119"></a><span id="l56.1119">   if (opts &amp;&amp; opts-&gt;format_out == nsMimeOutput::nsMimeMessageDecrypt &amp;&amp;</span>
<a href="#l56.1120"></a><span id="l56.1120" class="difflineminus">-       (clazz != (MimeObjectClass *)&amp;mimeEncryptedCMSClass)) {</span>
<a href="#l56.1121"></a><span id="l56.1121" class="difflineplus">+      (clazz != (MimeObjectClass *)&amp;mimeEncryptedCMSClass)) {</span>
<a href="#l56.1122"></a><span id="l56.1122">     clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1123"></a><span id="l56.1123">   }</span>
<a href="#l56.1124"></a><span id="l56.1124"> #endif</span>
<a href="#l56.1125"></a><span id="l56.1125"> </span>
<a href="#l56.1126"></a><span id="l56.1126">   if (!exact_match_p)</span>
<a href="#l56.1127"></a><span id="l56.1127">     NS_ASSERTION(clazz, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.1128"></a><span id="l56.1128" class="difflineminus">-  if (!clazz)</span>
<a href="#l56.1129"></a><span id="l56.1129" class="difflineminus">-    return 0;</span>
<a href="#l56.1130"></a><span id="l56.1130" class="difflineplus">+  if (!clazz) return 0;</span>
<a href="#l56.1131"></a><span id="l56.1131"> </span>
<a href="#l56.1132"></a><span id="l56.1132">   NS_ASSERTION(clazz, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.1133"></a><span id="l56.1133"> </span>
<a href="#l56.1134"></a><span id="l56.1134" class="difflineminus">-  if (clazz &amp;&amp; !clazz-&gt;class_initialized)</span>
<a href="#l56.1135"></a><span id="l56.1135" class="difflineminus">-  {</span>
<a href="#l56.1136"></a><span id="l56.1136" class="difflineplus">+  if (clazz &amp;&amp; !clazz-&gt;class_initialized) {</span>
<a href="#l56.1137"></a><span id="l56.1137">     int status = mime_classinit(clazz);</span>
<a href="#l56.1138"></a><span id="l56.1138" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l56.1139"></a><span id="l56.1139" class="difflineminus">-      return 0;</span>
<a href="#l56.1140"></a><span id="l56.1140" class="difflineplus">+    if (status &lt; 0) return 0;</span>
<a href="#l56.1141"></a><span id="l56.1141">   }</span>
<a href="#l56.1142"></a><span id="l56.1142"> </span>
<a href="#l56.1143"></a><span id="l56.1143">   return clazz;</span>
<a href="#l56.1144"></a><span id="l56.1144"> }</span>
<a href="#l56.1145"></a><span id="l56.1145"> </span>
<a href="#l56.1146"></a><span id="l56.1146" class="difflineminus">-</span>
<a href="#l56.1147"></a><span id="l56.1147" class="difflineminus">-MimeObject *</span>
<a href="#l56.1148"></a><span id="l56.1148" class="difflineminus">-mime_create(const char *content_type, MimeHeaders *hdrs,</span>
<a href="#l56.1149"></a><span id="l56.1149" class="difflineminus">-            MimeDisplayOptions *opts, bool forceInline /* = false */)</span>
<a href="#l56.1150"></a><span id="l56.1150" class="difflineminus">-{</span>
<a href="#l56.1151"></a><span id="l56.1151" class="difflineplus">+MimeObject *mime_create(const char *content_type, MimeHeaders *hdrs,</span>
<a href="#l56.1152"></a><span id="l56.1152" class="difflineplus">+                        MimeDisplayOptions *opts,</span>
<a href="#l56.1153"></a><span id="l56.1153" class="difflineplus">+                        bool forceInline /* = false */) {</span>
<a href="#l56.1154"></a><span id="l56.1154">   /* If there is no Content-Disposition header, or if the Content-Disposition</span>
<a href="#l56.1155"></a><span id="l56.1155">    is ``inline'', then we display the part inline (and let mime_find_class()</span>
<a href="#l56.1156"></a><span id="l56.1156">    decide how.)</span>
<a href="#l56.1157"></a><span id="l56.1157"> </span>
<a href="#l56.1158"></a><span id="l56.1158">    If there is any other Content-Disposition (either ``attachment'' or some</span>
<a href="#l56.1159"></a><span id="l56.1159">    disposition that we don't recognise) then we always display the part as</span>
<a href="#l56.1160"></a><span id="l56.1160">    an external link, by using MimeExternalObject to display it.</span>
<a href="#l56.1161"></a><span id="l56.1161"> </span>
<a href="#l56.1162"></a><span id="l56.1162" class="difflineat">@@ -834,65 +776,62 @@ mime_create(const char *content_type, Mi</span>
<a href="#l56.1163"></a><span id="l56.1163">   char *content_disposition = 0;</span>
<a href="#l56.1164"></a><span id="l56.1164">   MimeObject *obj = 0;</span>
<a href="#l56.1165"></a><span id="l56.1165">   char *override_content_type = 0;</span>
<a href="#l56.1166"></a><span id="l56.1166"> </span>
<a href="#l56.1167"></a><span id="l56.1167">   /* We've had issues where the incoming content_type is invalid, of a format:</span>
<a href="#l56.1168"></a><span id="l56.1168">      content_type=&quot;=?windows-1252?q?application/pdf&quot; (bug 659355)</span>
<a href="#l56.1169"></a><span id="l56.1169">      We decided to fix that by simply trimming the stuff before the ?</span>
<a href="#l56.1170"></a><span id="l56.1170">   */</span>
<a href="#l56.1171"></a><span id="l56.1171" class="difflineminus">-  if (content_type)</span>
<a href="#l56.1172"></a><span id="l56.1172" class="difflineminus">-  {</span>
<a href="#l56.1173"></a><span id="l56.1173" class="difflineplus">+  if (content_type) {</span>
<a href="#l56.1174"></a><span id="l56.1174">     const char *lastQuestion = strrchr(content_type, '?');</span>
<a href="#l56.1175"></a><span id="l56.1175">     if (lastQuestion)</span>
<a href="#l56.1176"></a><span id="l56.1176">       content_type = lastQuestion + 1;  // the substring after the last '?'</span>
<a href="#l56.1177"></a><span id="l56.1177">   }</span>
<a href="#l56.1178"></a><span id="l56.1178"> </span>
<a href="#l56.1179"></a><span id="l56.1179">   /* There are some clients send out all attachments with a content-type</span>
<a href="#l56.1180"></a><span id="l56.1180">    of application/octet-stream.  So, if we have an octet-stream attachment,</span>
<a href="#l56.1181"></a><span id="l56.1181">    try to guess what type it really is based on the file extension.  I HATE</span>
<a href="#l56.1182"></a><span id="l56.1182">    that we have to do this...</span>
<a href="#l56.1183"></a><span id="l56.1183">   */</span>
<a href="#l56.1184"></a><span id="l56.1184">   if (hdrs &amp;&amp; opts &amp;&amp; opts-&gt;file_type_fn &amp;&amp;</span>
<a href="#l56.1185"></a><span id="l56.1185"> </span>
<a href="#l56.1186"></a><span id="l56.1186" class="difflineminus">-    /* ### mwelch - don't override AppleSingle */</span>
<a href="#l56.1187"></a><span id="l56.1187" class="difflineminus">-    (content_type ? PL_strcasecmp(content_type, APPLICATION_APPLEFILE) : true) &amp;&amp;</span>
<a href="#l56.1188"></a><span id="l56.1188" class="difflineminus">-    /* ## davidm Apple double shouldn't use this #$%&amp; either. */</span>
<a href="#l56.1189"></a><span id="l56.1189" class="difflineminus">-    (content_type ? PL_strcasecmp(content_type, MULTIPART_APPLEDOUBLE) : true) &amp;&amp;</span>
<a href="#l56.1190"></a><span id="l56.1190" class="difflineminus">-    (!content_type ||</span>
<a href="#l56.1191"></a><span id="l56.1191" class="difflineminus">-     !PL_strcasecmp(content_type, APPLICATION_OCTET_STREAM) ||</span>
<a href="#l56.1192"></a><span id="l56.1192" class="difflineminus">-     !PL_strcasecmp(content_type, UNKNOWN_CONTENT_TYPE)))</span>
<a href="#l56.1193"></a><span id="l56.1193" class="difflineminus">-  {</span>
<a href="#l56.1194"></a><span id="l56.1194" class="difflineplus">+      /* ### mwelch - don't override AppleSingle */</span>
<a href="#l56.1195"></a><span id="l56.1195" class="difflineplus">+      (content_type ? PL_strcasecmp(content_type, APPLICATION_APPLEFILE)</span>
<a href="#l56.1196"></a><span id="l56.1196" class="difflineplus">+                    : true) &amp;&amp;</span>
<a href="#l56.1197"></a><span id="l56.1197" class="difflineplus">+      /* ## davidm Apple double shouldn't use this #$%&amp; either. */</span>
<a href="#l56.1198"></a><span id="l56.1198" class="difflineplus">+      (content_type ? PL_strcasecmp(content_type, MULTIPART_APPLEDOUBLE)</span>
<a href="#l56.1199"></a><span id="l56.1199" class="difflineplus">+                    : true) &amp;&amp;</span>
<a href="#l56.1200"></a><span id="l56.1200" class="difflineplus">+      (!content_type ||</span>
<a href="#l56.1201"></a><span id="l56.1201" class="difflineplus">+       !PL_strcasecmp(content_type, APPLICATION_OCTET_STREAM) ||</span>
<a href="#l56.1202"></a><span id="l56.1202" class="difflineplus">+       !PL_strcasecmp(content_type, UNKNOWN_CONTENT_TYPE))) {</span>
<a href="#l56.1203"></a><span id="l56.1203">     char *name = MimeHeaders_get_name(hdrs, opts);</span>
<a href="#l56.1204"></a><span id="l56.1204" class="difflineminus">-    if (name)</span>
<a href="#l56.1205"></a><span id="l56.1205" class="difflineminus">-    {</span>
<a href="#l56.1206"></a><span id="l56.1206" class="difflineminus">-      override_content_type = opts-&gt;file_type_fn (name, opts-&gt;stream_closure);</span>
<a href="#l56.1207"></a><span id="l56.1207" class="difflineplus">+    if (name) {</span>
<a href="#l56.1208"></a><span id="l56.1208" class="difflineplus">+      override_content_type = opts-&gt;file_type_fn(name, opts-&gt;stream_closure);</span>
<a href="#l56.1209"></a><span id="l56.1209">       // appledouble isn't a valid override content type, and makes</span>
<a href="#l56.1210"></a><span id="l56.1210">       // attachments invisible.</span>
<a href="#l56.1211"></a><span id="l56.1211">       if (!PL_strcasecmp(override_content_type, MULTIPART_APPLEDOUBLE))</span>
<a href="#l56.1212"></a><span id="l56.1212">         override_content_type = nullptr;</span>
<a href="#l56.1213"></a><span id="l56.1213">       PR_FREEIF(name);</span>
<a href="#l56.1214"></a><span id="l56.1214"> </span>
<a href="#l56.1215"></a><span id="l56.1215">       // Workaround for saving '.eml&quot; file encoded with base64.</span>
<a href="#l56.1216"></a><span id="l56.1216">       // Do not override with message/rfc822 whenever Transfer-Encoding is</span>
<a href="#l56.1217"></a><span id="l56.1217">       // base64 since base64 encoding of message/rfc822 is invalid.</span>
<a href="#l56.1218"></a><span id="l56.1218">       // Our MimeMessageClass has no capability to decode it.</span>
<a href="#l56.1219"></a><span id="l56.1219">       if (!PL_strcasecmp(override_content_type, MESSAGE_RFC822)) {</span>
<a href="#l56.1220"></a><span id="l56.1220">         nsCString encoding;</span>
<a href="#l56.1221"></a><span id="l56.1221" class="difflineminus">-        encoding.Adopt(MimeHeaders_get(hdrs,</span>
<a href="#l56.1222"></a><span id="l56.1222" class="difflineminus">-                                       HEADER_CONTENT_TRANSFER_ENCODING,</span>
<a href="#l56.1223"></a><span id="l56.1223" class="difflineplus">+        encoding.Adopt(MimeHeaders_get(hdrs, HEADER_CONTENT_TRANSFER_ENCODING,</span>
<a href="#l56.1224"></a><span id="l56.1224">                                        true, false));</span>
<a href="#l56.1225"></a><span id="l56.1225">         if (encoding.LowerCaseEqualsLiteral(ENCODING_BASE64))</span>
<a href="#l56.1226"></a><span id="l56.1226">           override_content_type = nullptr;</span>
<a href="#l56.1227"></a><span id="l56.1227">       }</span>
<a href="#l56.1228"></a><span id="l56.1228"> </span>
<a href="#l56.1229"></a><span id="l56.1229">       // If we get here and it is not the unknown content type from the</span>
<a href="#l56.1230"></a><span id="l56.1230">       // file name, let's do some better checking not to inline something bad</span>
<a href="#l56.1231"></a><span id="l56.1231" class="difflineminus">-      if (override_content_type &amp;&amp;</span>
<a href="#l56.1232"></a><span id="l56.1232" class="difflineminus">-          *override_content_type &amp;&amp;</span>
<a href="#l56.1233"></a><span id="l56.1233" class="difflineplus">+      if (override_content_type &amp;&amp; *override_content_type &amp;&amp;</span>
<a href="#l56.1234"></a><span id="l56.1234">           (PL_strcasecmp(override_content_type, UNKNOWN_CONTENT_TYPE)))</span>
<a href="#l56.1235"></a><span id="l56.1235">         content_type = override_content_type;</span>
<a href="#l56.1236"></a><span id="l56.1236">     }</span>
<a href="#l56.1237"></a><span id="l56.1237">   }</span>
<a href="#l56.1238"></a><span id="l56.1238"> </span>
<a href="#l56.1239"></a><span id="l56.1239">   clazz = mime_find_class(content_type, hdrs, opts, false);</span>
<a href="#l56.1240"></a><span id="l56.1240"> </span>
<a href="#l56.1241"></a><span id="l56.1241">   NS_ASSERTION(clazz, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.1242"></a><span id="l56.1242" class="difflineat">@@ -900,39 +839,38 @@ mime_create(const char *content_type, Mi</span>
<a href="#l56.1243"></a><span id="l56.1243"> </span>
<a href="#l56.1244"></a><span id="l56.1244">   if (opts &amp;&amp; opts-&gt;part_to_load)</span>
<a href="#l56.1245"></a><span id="l56.1245">     /* Always ignore Content-Disposition when we're loading some specific</span>
<a href="#l56.1246"></a><span id="l56.1246">        sub-part (which may be within some container that we wouldn't otherwise</span>
<a href="#l56.1247"></a><span id="l56.1247">        descend into, if the container itself had a Content-Disposition of</span>
<a href="#l56.1248"></a><span id="l56.1248">        `attachment'. */</span>
<a href="#l56.1249"></a><span id="l56.1249">     content_disposition = 0;</span>
<a href="#l56.1250"></a><span id="l56.1250"> </span>
<a href="#l56.1251"></a><span id="l56.1251" class="difflineminus">-  else if (mime_subclass_p(clazz,(MimeObjectClass *)&amp;mimeContainerClass) &amp;&amp;</span>
<a href="#l56.1252"></a><span id="l56.1252" class="difflineminus">-       !mime_subclass_p(clazz,(MimeObjectClass *)&amp;mimeMessageClass))</span>
<a href="#l56.1253"></a><span id="l56.1253" class="difflineplus">+  else if (mime_subclass_p(clazz, (MimeObjectClass *)&amp;mimeContainerClass) &amp;&amp;</span>
<a href="#l56.1254"></a><span id="l56.1254" class="difflineplus">+           !mime_subclass_p(clazz, (MimeObjectClass *)&amp;mimeMessageClass))</span>
<a href="#l56.1255"></a><span id="l56.1255">     /* Ignore Content-Disposition on all containers except `message'.</span>
<a href="#l56.1256"></a><span id="l56.1256">        That is, Content-Disposition is ignored for multipart/mixed objects,</span>
<a href="#l56.1257"></a><span id="l56.1257">        but is obeyed for message/rfc822 objects. */</span>
<a href="#l56.1258"></a><span id="l56.1258">     content_disposition = 0;</span>
<a href="#l56.1259"></a><span id="l56.1259"> </span>
<a href="#l56.1260"></a><span id="l56.1260" class="difflineminus">-  else</span>
<a href="#l56.1261"></a><span id="l56.1261" class="difflineminus">-  {</span>
<a href="#l56.1262"></a><span id="l56.1262" class="difflineplus">+  else {</span>
<a href="#l56.1263"></a><span id="l56.1263">     /* Check to see if the plugin should override the content disposition</span>
<a href="#l56.1264"></a><span id="l56.1264">        to make it appear inline. One example is a vcard which has a content</span>
<a href="#l56.1265"></a><span id="l56.1265">        disposition of an &quot;attachment;&quot; */</span>
<a href="#l56.1266"></a><span id="l56.1266">     if (force_inline_display(content_type))</span>
<a href="#l56.1267"></a><span id="l56.1267">       NS_MsgSACopy(&amp;content_disposition, &quot;inline&quot;);</span>
<a href="#l56.1268"></a><span id="l56.1268">     else</span>
<a href="#l56.1269"></a><span id="l56.1269" class="difflineminus">-      content_disposition = hdrs ?</span>
<a href="#l56.1270"></a><span id="l56.1270" class="difflineminus">-        MimeHeaders_get(hdrs, HEADER_CONTENT_DISPOSITION, true, false) : 0;</span>
<a href="#l56.1271"></a><span id="l56.1271" class="difflineplus">+      content_disposition =</span>
<a href="#l56.1272"></a><span id="l56.1272" class="difflineplus">+          hdrs ? MimeHeaders_get(hdrs, HEADER_CONTENT_DISPOSITION, true, false)</span>
<a href="#l56.1273"></a><span id="l56.1273" class="difflineplus">+               : 0;</span>
<a href="#l56.1274"></a><span id="l56.1274">   }</span>
<a href="#l56.1275"></a><span id="l56.1275"> </span>
<a href="#l56.1276"></a><span id="l56.1276">   if (!content_disposition || !PL_strcasecmp(content_disposition, &quot;inline&quot;))</span>
<a href="#l56.1277"></a><span id="l56.1277" class="difflineminus">-    ;  /* Use the class we've got. */</span>
<a href="#l56.1278"></a><span id="l56.1278" class="difflineminus">-  else</span>
<a href="#l56.1279"></a><span id="l56.1279" class="difflineminus">-  {</span>
<a href="#l56.1280"></a><span id="l56.1280" class="difflineplus">+    ; /* Use the class we've got. */</span>
<a href="#l56.1281"></a><span id="l56.1281" class="difflineplus">+  else {</span>
<a href="#l56.1282"></a><span id="l56.1282">     // override messages that have content disposition set to &quot;attachment&quot;</span>
<a href="#l56.1283"></a><span id="l56.1283">     // even though we probably should show them inline.</span>
<a href="#l56.1284"></a><span id="l56.1284">     if ((clazz != (MimeObjectClass *)&amp;mimeMessageClass) &amp;&amp;</span>
<a href="#l56.1285"></a><span id="l56.1285">         (clazz != (MimeObjectClass *)&amp;mimeInlineImageClass) &amp;&amp;</span>
<a href="#l56.1286"></a><span id="l56.1286">         (!opts-&gt;show_attachment_inline_text ||</span>
<a href="#l56.1287"></a><span id="l56.1287">          ((clazz != (MimeObjectClass *)&amp;mimeInlineTextHTMLClass) &amp;&amp;</span>
<a href="#l56.1288"></a><span id="l56.1288">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextHTMLParsedClass) &amp;&amp;</span>
<a href="#l56.1289"></a><span id="l56.1289">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextHTMLSanitizedClass) &amp;&amp;</span>
<a href="#l56.1290"></a><span id="l56.1290" class="difflineat">@@ -941,523 +879,428 @@ mime_create(const char *content_type, Mi</span>
<a href="#l56.1291"></a><span id="l56.1291">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextEnrichedClass) &amp;&amp;</span>
<a href="#l56.1292"></a><span id="l56.1292">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextClass) &amp;&amp;</span>
<a href="#l56.1293"></a><span id="l56.1293">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextPlainClass) &amp;&amp;</span>
<a href="#l56.1294"></a><span id="l56.1294">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextPlainFlowedClass))))</span>
<a href="#l56.1295"></a><span id="l56.1295">       // not a special inline type, so show as attachment</span>
<a href="#l56.1296"></a><span id="l56.1296">       clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1297"></a><span id="l56.1297">   }</span>
<a href="#l56.1298"></a><span id="l56.1298"> </span>
<a href="#l56.1299"></a><span id="l56.1299" class="difflineminus">-  /* If the option `Show Attachments Inline' is off, now would be the time to change our mind... */</span>
<a href="#l56.1300"></a><span id="l56.1300" class="difflineminus">-  /* Also, if we're doing a reply (i.e. quoting the body), then treat that according to preference. */</span>
<a href="#l56.1301"></a><span id="l56.1301" class="difflineminus">-  if (opts &amp;&amp; ((!opts-&gt;show_attachment_inline_p &amp;&amp; !forceInline) ||</span>
<a href="#l56.1302"></a><span id="l56.1302" class="difflineminus">-               (!opts-&gt;quote_attachment_inline_p &amp;&amp;</span>
<a href="#l56.1303"></a><span id="l56.1303" class="difflineminus">-                (opts-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l56.1304"></a><span id="l56.1304" class="difflineminus">-                 opts-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting))))</span>
<a href="#l56.1305"></a><span id="l56.1305" class="difflineminus">-  {</span>
<a href="#l56.1306"></a><span id="l56.1306" class="difflineminus">-    if (mime_subclass_p(clazz, (MimeObjectClass *)&amp;mimeInlineTextClass))</span>
<a href="#l56.1307"></a><span id="l56.1307" class="difflineminus">-    {</span>
<a href="#l56.1308"></a><span id="l56.1308" class="difflineplus">+  /* If the option `Show Attachments Inline' is off, now would be the time to</span>
<a href="#l56.1309"></a><span id="l56.1309" class="difflineplus">+   * change our mind... */</span>
<a href="#l56.1310"></a><span id="l56.1310" class="difflineplus">+  /* Also, if we're doing a reply (i.e. quoting the body), then treat that</span>
<a href="#l56.1311"></a><span id="l56.1311" class="difflineplus">+   * according to preference. */</span>
<a href="#l56.1312"></a><span id="l56.1312" class="difflineplus">+  if (opts &amp;&amp;</span>
<a href="#l56.1313"></a><span id="l56.1313" class="difflineplus">+      ((!opts-&gt;show_attachment_inline_p &amp;&amp; !forceInline) ||</span>
<a href="#l56.1314"></a><span id="l56.1314" class="difflineplus">+       (!opts-&gt;quote_attachment_inline_p &amp;&amp;</span>
<a href="#l56.1315"></a><span id="l56.1315" class="difflineplus">+        (opts-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l56.1316"></a><span id="l56.1316" class="difflineplus">+         opts-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting)))) {</span>
<a href="#l56.1317"></a><span id="l56.1317" class="difflineplus">+    if (mime_subclass_p(clazz, (MimeObjectClass *)&amp;mimeInlineTextClass)) {</span>
<a href="#l56.1318"></a><span id="l56.1318">       /* It's a text type.  Write it only if it's the *first* part</span>
<a href="#l56.1319"></a><span id="l56.1319">          that we're writing, and then only if it has no &quot;filename&quot;</span>
<a href="#l56.1320"></a><span id="l56.1320">          specified (the assumption here being, if it has a filename,</span>
<a href="#l56.1321"></a><span id="l56.1321">          it wasn't simply typed into the text field -- it was actually</span>
<a href="#l56.1322"></a><span id="l56.1322">          an attached document.) */</span>
<a href="#l56.1323"></a><span id="l56.1323">       if (opts-&gt;state &amp;&amp; opts-&gt;state-&gt;first_part_written_p)</span>
<a href="#l56.1324"></a><span id="l56.1324">         clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1325"></a><span id="l56.1325" class="difflineminus">-      else</span>
<a href="#l56.1326"></a><span id="l56.1326" class="difflineminus">-      {</span>
<a href="#l56.1327"></a><span id="l56.1327" class="difflineplus">+      else {</span>
<a href="#l56.1328"></a><span id="l56.1328">         /* If there's a name, then write this as an attachment. */</span>
<a href="#l56.1329"></a><span id="l56.1329">         char *name = (hdrs ? MimeHeaders_get_name(hdrs, opts) : nullptr);</span>
<a href="#l56.1330"></a><span id="l56.1330" class="difflineminus">-        if (name)</span>
<a href="#l56.1331"></a><span id="l56.1331" class="difflineminus">-        {</span>
<a href="#l56.1332"></a><span id="l56.1332" class="difflineplus">+        if (name) {</span>
<a href="#l56.1333"></a><span id="l56.1333">           clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1334"></a><span id="l56.1334">           PR_Free(name);</span>
<a href="#l56.1335"></a><span id="l56.1335">         }</span>
<a href="#l56.1336"></a><span id="l56.1336">       }</span>
<a href="#l56.1337"></a><span id="l56.1337" class="difflineminus">-    }</span>
<a href="#l56.1338"></a><span id="l56.1338" class="difflineminus">-    else</span>
<a href="#l56.1339"></a><span id="l56.1339" class="difflineminus">-      if (mime_subclass_p(clazz,(MimeObjectClass *)&amp;mimeContainerClass) &amp;&amp;</span>
<a href="#l56.1340"></a><span id="l56.1340" class="difflineminus">-           !mime_subclass_p(clazz,(MimeObjectClass *)&amp;mimeMessageClass))</span>
<a href="#l56.1341"></a><span id="l56.1341" class="difflineminus">-        /* Multipart subtypes are ok, except for messages; descend into</span>
<a href="#l56.1342"></a><span id="l56.1342" class="difflineminus">-           multiparts, and defer judgement.</span>
<a href="#l56.1343"></a><span id="l56.1343" class="difflineplus">+    } else if (mime_subclass_p(clazz, (MimeObjectClass *)&amp;mimeContainerClass) &amp;&amp;</span>
<a href="#l56.1344"></a><span id="l56.1344" class="difflineplus">+               !mime_subclass_p(clazz, (MimeObjectClass *)&amp;mimeMessageClass))</span>
<a href="#l56.1345"></a><span id="l56.1345" class="difflineplus">+      /* Multipart subtypes are ok, except for messages; descend into</span>
<a href="#l56.1346"></a><span id="l56.1346" class="difflineplus">+         multiparts, and defer judgement.</span>
<a href="#l56.1347"></a><span id="l56.1347"> </span>
<a href="#l56.1348"></a><span id="l56.1348" class="difflineminus">-           Encrypted blobs are just like other containers (make the crypto</span>
<a href="#l56.1349"></a><span id="l56.1349" class="difflineminus">-           layer invisible, and treat them as simple containers.  So there's</span>
<a href="#l56.1350"></a><span id="l56.1350" class="difflineminus">-           no easy way to save encrypted data directly to disk; it will tend</span>
<a href="#l56.1351"></a><span id="l56.1351" class="difflineminus">-           to always be wrapped inside a message/rfc822.  That's ok.) */</span>
<a href="#l56.1352"></a><span id="l56.1352" class="difflineminus">-          ;</span>
<a href="#l56.1353"></a><span id="l56.1353" class="difflineminus">-        else if (opts &amp;&amp; opts-&gt;part_to_load &amp;&amp;</span>
<a href="#l56.1354"></a><span id="l56.1354" class="difflineminus">-                  mime_subclass_p(clazz,(MimeObjectClass *)&amp;mimeMessageClass))</span>
<a href="#l56.1355"></a><span id="l56.1355" class="difflineminus">-          /* Descend into messages only if we're looking for a specific sub-part. */</span>
<a href="#l56.1356"></a><span id="l56.1356" class="difflineminus">-            ;</span>
<a href="#l56.1357"></a><span id="l56.1357" class="difflineminus">-          else</span>
<a href="#l56.1358"></a><span id="l56.1358" class="difflineminus">-          {</span>
<a href="#l56.1359"></a><span id="l56.1359" class="difflineminus">-            /* Anything else, and display it as a link (and cause subsequent</span>
<a href="#l56.1360"></a><span id="l56.1360" class="difflineminus">-               text parts to also be displayed as links.) */</span>
<a href="#l56.1361"></a><span id="l56.1361" class="difflineminus">-            clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1362"></a><span id="l56.1362" class="difflineminus">-          }</span>
<a href="#l56.1363"></a><span id="l56.1363" class="difflineplus">+         Encrypted blobs are just like other containers (make the crypto</span>
<a href="#l56.1364"></a><span id="l56.1364" class="difflineplus">+         layer invisible, and treat them as simple containers.  So there's</span>
<a href="#l56.1365"></a><span id="l56.1365" class="difflineplus">+         no easy way to save encrypted data directly to disk; it will tend</span>
<a href="#l56.1366"></a><span id="l56.1366" class="difflineplus">+         to always be wrapped inside a message/rfc822.  That's ok.) */</span>
<a href="#l56.1367"></a><span id="l56.1367" class="difflineplus">+      ;</span>
<a href="#l56.1368"></a><span id="l56.1368" class="difflineplus">+    else if (opts &amp;&amp; opts-&gt;part_to_load &amp;&amp;</span>
<a href="#l56.1369"></a><span id="l56.1369" class="difflineplus">+             mime_subclass_p(clazz, (MimeObjectClass *)&amp;mimeMessageClass))</span>
<a href="#l56.1370"></a><span id="l56.1370" class="difflineplus">+      /* Descend into messages only if we're looking for a specific sub-part. */</span>
<a href="#l56.1371"></a><span id="l56.1371" class="difflineplus">+      ;</span>
<a href="#l56.1372"></a><span id="l56.1372" class="difflineplus">+    else {</span>
<a href="#l56.1373"></a><span id="l56.1373" class="difflineplus">+      /* Anything else, and display it as a link (and cause subsequent</span>
<a href="#l56.1374"></a><span id="l56.1374" class="difflineplus">+         text parts to also be displayed as links.) */</span>
<a href="#l56.1375"></a><span id="l56.1375" class="difflineplus">+      clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l56.1376"></a><span id="l56.1376" class="difflineplus">+    }</span>
<a href="#l56.1377"></a><span id="l56.1377">   }</span>
<a href="#l56.1378"></a><span id="l56.1378"> </span>
<a href="#l56.1379"></a><span id="l56.1379">   PR_FREEIF(content_disposition);</span>
<a href="#l56.1380"></a><span id="l56.1380">   obj = mime_new(clazz, hdrs, content_type);</span>
<a href="#l56.1381"></a><span id="l56.1381"> </span>
<a href="#l56.1382"></a><span id="l56.1382" class="difflineminus">- FAIL:</span>
<a href="#l56.1383"></a><span id="l56.1383" class="difflineplus">+FAIL:</span>
<a href="#l56.1384"></a><span id="l56.1384"> </span>
<a href="#l56.1385"></a><span id="l56.1385">   /* If we decided to ignore the content-type in the headers of this object</span>
<a href="#l56.1386"></a><span id="l56.1386">    (see above) then make sure that our new content-type is stored in the</span>
<a href="#l56.1387"></a><span id="l56.1387">    object itself.  (Or free it, if we're in an out-of-memory situation.)</span>
<a href="#l56.1388"></a><span id="l56.1388">    */</span>
<a href="#l56.1389"></a><span id="l56.1389" class="difflineminus">-  if (override_content_type)</span>
<a href="#l56.1390"></a><span id="l56.1390" class="difflineminus">-  {</span>
<a href="#l56.1391"></a><span id="l56.1391" class="difflineminus">-    if (obj)</span>
<a href="#l56.1392"></a><span id="l56.1392" class="difflineminus">-    {</span>
<a href="#l56.1393"></a><span id="l56.1393" class="difflineplus">+  if (override_content_type) {</span>
<a href="#l56.1394"></a><span id="l56.1394" class="difflineplus">+    if (obj) {</span>
<a href="#l56.1395"></a><span id="l56.1395">       PR_FREEIF(obj-&gt;content_type);</span>
<a href="#l56.1396"></a><span id="l56.1396">       obj-&gt;content_type = override_content_type;</span>
<a href="#l56.1397"></a><span id="l56.1397" class="difflineminus">-    }</span>
<a href="#l56.1398"></a><span id="l56.1398" class="difflineminus">-    else</span>
<a href="#l56.1399"></a><span id="l56.1399" class="difflineminus">-    {</span>
<a href="#l56.1400"></a><span id="l56.1400" class="difflineplus">+    } else {</span>
<a href="#l56.1401"></a><span id="l56.1401">       PR_Free(override_content_type);</span>
<a href="#l56.1402"></a><span id="l56.1402">     }</span>
<a href="#l56.1403"></a><span id="l56.1403">   }</span>
<a href="#l56.1404"></a><span id="l56.1404"> </span>
<a href="#l56.1405"></a><span id="l56.1405">   return obj;</span>
<a href="#l56.1406"></a><span id="l56.1406"> }</span>
<a href="#l56.1407"></a><span id="l56.1407"> </span>
<a href="#l56.1408"></a><span id="l56.1408" class="difflineminus">-</span>
<a href="#l56.1409"></a><span id="l56.1409" class="difflineminus">-</span>
<a href="#l56.1410"></a><span id="l56.1410"> static int mime_classinit_1(MimeObjectClass *clazz, MimeObjectClass *target);</span>
<a href="#l56.1411"></a><span id="l56.1411"> </span>
<a href="#l56.1412"></a><span id="l56.1412" class="difflineminus">-static int</span>
<a href="#l56.1413"></a><span id="l56.1413" class="difflineminus">-mime_classinit(MimeObjectClass *clazz)</span>
<a href="#l56.1414"></a><span id="l56.1414" class="difflineminus">-{</span>
<a href="#l56.1415"></a><span id="l56.1415" class="difflineplus">+static int mime_classinit(MimeObjectClass *clazz) {</span>
<a href="#l56.1416"></a><span id="l56.1416">   int status;</span>
<a href="#l56.1417"></a><span id="l56.1417" class="difflineminus">-  if (clazz-&gt;class_initialized)</span>
<a href="#l56.1418"></a><span id="l56.1418" class="difflineminus">-    return 0;</span>
<a href="#l56.1419"></a><span id="l56.1419" class="difflineplus">+  if (clazz-&gt;class_initialized) return 0;</span>
<a href="#l56.1420"></a><span id="l56.1420"> </span>
<a href="#l56.1421"></a><span id="l56.1421" class="difflineminus">-  NS_ASSERTION(clazz-&gt;class_initialize, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.1422"></a><span id="l56.1422" class="difflineminus">-  if (!clazz-&gt;class_initialize)</span>
<a href="#l56.1423"></a><span id="l56.1423" class="difflineminus">-    return -1;</span>
<a href="#l56.1424"></a><span id="l56.1424" class="difflineplus">+  NS_ASSERTION(clazz-&gt;class_initialize,</span>
<a href="#l56.1425"></a><span id="l56.1425" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.1426"></a><span id="l56.1426" class="difflineplus">+  if (!clazz-&gt;class_initialize) return -1;</span>
<a href="#l56.1427"></a><span id="l56.1427"> </span>
<a href="#l56.1428"></a><span id="l56.1428">   /* First initialize the superclass.</span>
<a href="#l56.1429"></a><span id="l56.1429">    */</span>
<a href="#l56.1430"></a><span id="l56.1430" class="difflineminus">-  if (clazz-&gt;superclass &amp;&amp; !clazz-&gt;superclass-&gt;class_initialized)</span>
<a href="#l56.1431"></a><span id="l56.1431" class="difflineminus">-  {</span>
<a href="#l56.1432"></a><span id="l56.1432" class="difflineplus">+  if (clazz-&gt;superclass &amp;&amp; !clazz-&gt;superclass-&gt;class_initialized) {</span>
<a href="#l56.1433"></a><span id="l56.1433">     status = mime_classinit(clazz-&gt;superclass);</span>
<a href="#l56.1434"></a><span id="l56.1434" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l56.1435"></a><span id="l56.1435" class="difflineminus">-      return status;</span>
<a href="#l56.1436"></a><span id="l56.1436" class="difflineplus">+    if (status &lt; 0) return status;</span>
<a href="#l56.1437"></a><span id="l56.1437">   }</span>
<a href="#l56.1438"></a><span id="l56.1438"> </span>
<a href="#l56.1439"></a><span id="l56.1439">   /* Now run each of the superclass-init procedures in turn,</span>
<a href="#l56.1440"></a><span id="l56.1440">    parentmost-first. */</span>
<a href="#l56.1441"></a><span id="l56.1441">   status = mime_classinit_1(clazz, clazz);</span>
<a href="#l56.1442"></a><span id="l56.1442" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l56.1443"></a><span id="l56.1443" class="difflineminus">-    return status;</span>
<a href="#l56.1444"></a><span id="l56.1444" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l56.1445"></a><span id="l56.1445"> </span>
<a href="#l56.1446"></a><span id="l56.1446">   /* Now we're done. */</span>
<a href="#l56.1447"></a><span id="l56.1447">   clazz-&gt;class_initialized = true;</span>
<a href="#l56.1448"></a><span id="l56.1448">   return 0;</span>
<a href="#l56.1449"></a><span id="l56.1449"> }</span>
<a href="#l56.1450"></a><span id="l56.1450"> </span>
<a href="#l56.1451"></a><span id="l56.1451" class="difflineminus">-static int</span>
<a href="#l56.1452"></a><span id="l56.1452" class="difflineminus">-mime_classinit_1(MimeObjectClass *clazz, MimeObjectClass *target)</span>
<a href="#l56.1453"></a><span id="l56.1453" class="difflineminus">-{</span>
<a href="#l56.1454"></a><span id="l56.1454" class="difflineplus">+static int mime_classinit_1(MimeObjectClass *clazz, MimeObjectClass *target) {</span>
<a href="#l56.1455"></a><span id="l56.1455">   int status;</span>
<a href="#l56.1456"></a><span id="l56.1456" class="difflineminus">-  if (clazz-&gt;superclass)</span>
<a href="#l56.1457"></a><span id="l56.1457" class="difflineminus">-  {</span>
<a href="#l56.1458"></a><span id="l56.1458" class="difflineplus">+  if (clazz-&gt;superclass) {</span>
<a href="#l56.1459"></a><span id="l56.1459">     status = mime_classinit_1(clazz-&gt;superclass, target);</span>
<a href="#l56.1460"></a><span id="l56.1460" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l56.1461"></a><span id="l56.1461" class="difflineminus">-      return status;</span>
<a href="#l56.1462"></a><span id="l56.1462" class="difflineplus">+    if (status &lt; 0) return status;</span>
<a href="#l56.1463"></a><span id="l56.1463">   }</span>
<a href="#l56.1464"></a><span id="l56.1464">   return clazz-&gt;class_initialize(target);</span>
<a href="#l56.1465"></a><span id="l56.1465"> }</span>
<a href="#l56.1466"></a><span id="l56.1466"> </span>
<a href="#l56.1467"></a><span id="l56.1467" class="difflineminus">-</span>
<a href="#l56.1468"></a><span id="l56.1468" class="difflineminus">-bool</span>
<a href="#l56.1469"></a><span id="l56.1469" class="difflineminus">-mime_subclass_p(MimeObjectClass *child, MimeObjectClass *parent)</span>
<a href="#l56.1470"></a><span id="l56.1470" class="difflineminus">-{</span>
<a href="#l56.1471"></a><span id="l56.1471" class="difflineminus">-  if (child == parent)</span>
<a href="#l56.1472"></a><span id="l56.1472" class="difflineminus">-    return true;</span>
<a href="#l56.1473"></a><span id="l56.1473" class="difflineminus">-  if (!child-&gt;superclass)</span>
<a href="#l56.1474"></a><span id="l56.1474" class="difflineminus">-    return false;</span>
<a href="#l56.1475"></a><span id="l56.1475" class="difflineplus">+bool mime_subclass_p(MimeObjectClass *child, MimeObjectClass *parent) {</span>
<a href="#l56.1476"></a><span id="l56.1476" class="difflineplus">+  if (child == parent) return true;</span>
<a href="#l56.1477"></a><span id="l56.1477" class="difflineplus">+  if (!child-&gt;superclass) return false;</span>
<a href="#l56.1478"></a><span id="l56.1478">   return mime_subclass_p(child-&gt;superclass, parent);</span>
<a href="#l56.1479"></a><span id="l56.1479"> }</span>
<a href="#l56.1480"></a><span id="l56.1480"> </span>
<a href="#l56.1481"></a><span id="l56.1481" class="difflineminus">-bool</span>
<a href="#l56.1482"></a><span id="l56.1482" class="difflineminus">-mime_typep(MimeObject *obj, MimeObjectClass *clazz)</span>
<a href="#l56.1483"></a><span id="l56.1483" class="difflineminus">-{</span>
<a href="#l56.1484"></a><span id="l56.1484" class="difflineplus">+bool mime_typep(MimeObject *obj, MimeObjectClass *clazz) {</span>
<a href="#l56.1485"></a><span id="l56.1485">   return mime_subclass_p(obj-&gt;clazz, clazz);</span>
<a href="#l56.1486"></a><span id="l56.1486"> }</span>
<a href="#l56.1487"></a><span id="l56.1487"> </span>
<a href="#l56.1488"></a><span id="l56.1488"> /* URL munging</span>
<a href="#l56.1489"></a><span id="l56.1489">  */</span>
<a href="#l56.1490"></a><span id="l56.1490"> </span>
<a href="#l56.1491"></a><span id="l56.1491"> /* Returns a string describing the location of the part (like &quot;2.5.3&quot;).</span>
<a href="#l56.1492"></a><span id="l56.1492">    This is not a full URL, just a part-number.</span>
<a href="#l56.1493"></a><span id="l56.1493">  */</span>
<a href="#l56.1494"></a><span id="l56.1494" class="difflineminus">-char *</span>
<a href="#l56.1495"></a><span id="l56.1495" class="difflineminus">-mime_part_address(MimeObject *obj)</span>
<a href="#l56.1496"></a><span id="l56.1496" class="difflineminus">-{</span>
<a href="#l56.1497"></a><span id="l56.1497" class="difflineminus">-  if (!obj-&gt;parent)</span>
<a href="#l56.1498"></a><span id="l56.1498" class="difflineminus">-    return strdup(&quot;0&quot;);</span>
<a href="#l56.1499"></a><span id="l56.1499" class="difflineplus">+char *mime_part_address(MimeObject *obj) {</span>
<a href="#l56.1500"></a><span id="l56.1500" class="difflineplus">+  if (!obj-&gt;parent) return strdup(&quot;0&quot;);</span>
<a href="#l56.1501"></a><span id="l56.1501"> </span>
<a href="#l56.1502"></a><span id="l56.1502">   /* Find this object in its parent. */</span>
<a href="#l56.1503"></a><span id="l56.1503">   int32_t i, j = -1;</span>
<a href="#l56.1504"></a><span id="l56.1504" class="difflineminus">-  char buf [20];</span>
<a href="#l56.1505"></a><span id="l56.1505" class="difflineplus">+  char buf[20];</span>
<a href="#l56.1506"></a><span id="l56.1506">   char *higher = 0;</span>
<a href="#l56.1507"></a><span id="l56.1507">   MimeContainer *cont = (MimeContainer *)obj-&gt;parent;</span>
<a href="#l56.1508"></a><span id="l56.1508" class="difflineminus">-  NS_ASSERTION(mime_typep(obj-&gt;parent,</span>
<a href="#l56.1509"></a><span id="l56.1509" class="difflineminus">-                  (MimeObjectClass *)&amp;mimeContainerClass), &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.1510"></a><span id="l56.1510" class="difflineplus">+  NS_ASSERTION(mime_typep(obj-&gt;parent, (MimeObjectClass *)&amp;mimeContainerClass),</span>
<a href="#l56.1511"></a><span id="l56.1511" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.1512"></a><span id="l56.1512">   for (i = 0; i &lt; cont-&gt;nchildren; i++)</span>
<a href="#l56.1513"></a><span id="l56.1513" class="difflineminus">-  if (cont-&gt;children[i] == obj)</span>
<a href="#l56.1514"></a><span id="l56.1514" class="difflineminus">-  {</span>
<a href="#l56.1515"></a><span id="l56.1515" class="difflineminus">-    j = i+1;</span>
<a href="#l56.1516"></a><span id="l56.1516" class="difflineminus">-    break;</span>
<a href="#l56.1517"></a><span id="l56.1517" class="difflineminus">-  }</span>
<a href="#l56.1518"></a><span id="l56.1518" class="difflineminus">-  if (j == -1)</span>
<a href="#l56.1519"></a><span id="l56.1519" class="difflineminus">-  {</span>
<a href="#l56.1520"></a><span id="l56.1520" class="difflineplus">+    if (cont-&gt;children[i] == obj) {</span>
<a href="#l56.1521"></a><span id="l56.1521" class="difflineplus">+      j = i + 1;</span>
<a href="#l56.1522"></a><span id="l56.1522" class="difflineplus">+      break;</span>
<a href="#l56.1523"></a><span id="l56.1523" class="difflineplus">+    }</span>
<a href="#l56.1524"></a><span id="l56.1524" class="difflineplus">+  if (j == -1) {</span>
<a href="#l56.1525"></a><span id="l56.1525">     NS_ERROR(&quot;No children under MeimContainer&quot;);</span>
<a href="#l56.1526"></a><span id="l56.1526">     return 0;</span>
<a href="#l56.1527"></a><span id="l56.1527">   }</span>
<a href="#l56.1528"></a><span id="l56.1528"> </span>
<a href="#l56.1529"></a><span id="l56.1529">   PR_snprintf(buf, sizeof(buf), &quot;%ld&quot;, j);</span>
<a href="#l56.1530"></a><span id="l56.1530" class="difflineminus">-  if (obj-&gt;parent-&gt;parent)</span>
<a href="#l56.1531"></a><span id="l56.1531" class="difflineminus">-  {</span>
<a href="#l56.1532"></a><span id="l56.1532" class="difflineplus">+  if (obj-&gt;parent-&gt;parent) {</span>
<a href="#l56.1533"></a><span id="l56.1533">     higher = mime_part_address(obj-&gt;parent);</span>
<a href="#l56.1534"></a><span id="l56.1534" class="difflineminus">-    if (!higher)</span>
<a href="#l56.1535"></a><span id="l56.1535" class="difflineminus">-      return 0;  /* MIME_OUT_OF_MEMORY */</span>
<a href="#l56.1536"></a><span id="l56.1536" class="difflineplus">+    if (!higher) return 0; /* MIME_OUT_OF_MEMORY */</span>
<a href="#l56.1537"></a><span id="l56.1537">   }</span>
<a href="#l56.1538"></a><span id="l56.1538"> </span>
<a href="#l56.1539"></a><span id="l56.1539" class="difflineminus">-  if (!higher)</span>
<a href="#l56.1540"></a><span id="l56.1540" class="difflineminus">-    return strdup(buf);</span>
<a href="#l56.1541"></a><span id="l56.1541" class="difflineplus">+  if (!higher) return strdup(buf);</span>
<a href="#l56.1542"></a><span id="l56.1542"> </span>
<a href="#l56.1543"></a><span id="l56.1543">   uint32_t slen = strlen(higher) + strlen(buf) + 3;</span>
<a href="#l56.1544"></a><span id="l56.1544">   char *s = (char *)PR_MALLOC(slen);</span>
<a href="#l56.1545"></a><span id="l56.1545" class="difflineminus">-  if (!s)</span>
<a href="#l56.1546"></a><span id="l56.1546" class="difflineminus">-  {</span>
<a href="#l56.1547"></a><span id="l56.1547" class="difflineplus">+  if (!s) {</span>
<a href="#l56.1548"></a><span id="l56.1548">     PR_Free(higher);</span>
<a href="#l56.1549"></a><span id="l56.1549" class="difflineminus">-    return 0;  /* MIME_OUT_OF_MEMORY */</span>
<a href="#l56.1550"></a><span id="l56.1550" class="difflineplus">+    return 0; /* MIME_OUT_OF_MEMORY */</span>
<a href="#l56.1551"></a><span id="l56.1551">   }</span>
<a href="#l56.1552"></a><span id="l56.1552">   PL_strncpyz(s, higher, slen);</span>
<a href="#l56.1553"></a><span id="l56.1553">   PL_strcatn(s, slen, &quot;.&quot;);</span>
<a href="#l56.1554"></a><span id="l56.1554">   PL_strcatn(s, slen, buf);</span>
<a href="#l56.1555"></a><span id="l56.1555">   PR_Free(higher);</span>
<a href="#l56.1556"></a><span id="l56.1556">   return s;</span>
<a href="#l56.1557"></a><span id="l56.1557"> }</span>
<a href="#l56.1558"></a><span id="l56.1558"> </span>
<a href="#l56.1559"></a><span id="l56.1559" class="difflineminus">-</span>
<a href="#l56.1560"></a><span id="l56.1560"> /* Returns a string describing the location of the *IMAP* part (like &quot;2.5.3&quot;).</span>
<a href="#l56.1561"></a><span id="l56.1561">    This is not a full URL, just a part-number.</span>
<a href="#l56.1562"></a><span id="l56.1562">    This part is explicitly passed in the X-Mozilla-IMAP-Part header.</span>
<a href="#l56.1563"></a><span id="l56.1563">    Return value must be freed by the caller.</span>
<a href="#l56.1564"></a><span id="l56.1564">  */</span>
<a href="#l56.1565"></a><span id="l56.1565" class="difflineminus">-char *</span>
<a href="#l56.1566"></a><span id="l56.1566" class="difflineminus">-mime_imap_part_address(MimeObject *obj)</span>
<a href="#l56.1567"></a><span id="l56.1567" class="difflineminus">-{</span>
<a href="#l56.1568"></a><span id="l56.1568" class="difflineminus">-  if (!obj || !obj-&gt;headers)</span>
<a href="#l56.1569"></a><span id="l56.1569" class="difflineminus">-    return 0;</span>
<a href="#l56.1570"></a><span id="l56.1570" class="difflineminus">-  return MimeHeaders_get(obj-&gt;headers, IMAP_EXTERNAL_CONTENT_HEADER, false, false);</span>
<a href="#l56.1571"></a><span id="l56.1571" class="difflineplus">+char *mime_imap_part_address(MimeObject *obj) {</span>
<a href="#l56.1572"></a><span id="l56.1572" class="difflineplus">+  if (!obj || !obj-&gt;headers) return 0;</span>
<a href="#l56.1573"></a><span id="l56.1573" class="difflineplus">+  return MimeHeaders_get(obj-&gt;headers, IMAP_EXTERNAL_CONTENT_HEADER, false,</span>
<a href="#l56.1574"></a><span id="l56.1574" class="difflineplus">+                         false);</span>
<a href="#l56.1575"></a><span id="l56.1575"> }</span>
<a href="#l56.1576"></a><span id="l56.1576"> </span>
<a href="#l56.1577"></a><span id="l56.1577" class="difflineminus">-/* Returns a full URL if the current mime object has a EXTERNAL_ATTACHMENT_URL_HEADER</span>
<a href="#l56.1578"></a><span id="l56.1578" class="difflineminus">-   header.</span>
<a href="#l56.1579"></a><span id="l56.1579" class="difflineminus">-   Return value must be freed by the caller.</span>
<a href="#l56.1580"></a><span id="l56.1580" class="difflineplus">+/* Returns a full URL if the current mime object has a</span>
<a href="#l56.1581"></a><span id="l56.1581" class="difflineplus">+   EXTERNAL_ATTACHMENT_URL_HEADER header. Return value must be freed by the</span>
<a href="#l56.1582"></a><span id="l56.1582" class="difflineplus">+   caller.</span>
<a href="#l56.1583"></a><span id="l56.1583"> */</span>
<a href="#l56.1584"></a><span id="l56.1584" class="difflineminus">-char *</span>
<a href="#l56.1585"></a><span id="l56.1585" class="difflineminus">-mime_external_attachment_url(MimeObject *obj)</span>
<a href="#l56.1586"></a><span id="l56.1586" class="difflineminus">-{</span>
<a href="#l56.1587"></a><span id="l56.1587" class="difflineminus">-  if (!obj || !obj-&gt;headers)</span>
<a href="#l56.1588"></a><span id="l56.1588" class="difflineminus">-    return 0;</span>
<a href="#l56.1589"></a><span id="l56.1589" class="difflineminus">-  return MimeHeaders_get(obj-&gt;headers, EXTERNAL_ATTACHMENT_URL_HEADER, false, false);</span>
<a href="#l56.1590"></a><span id="l56.1590" class="difflineplus">+char *mime_external_attachment_url(MimeObject *obj) {</span>
<a href="#l56.1591"></a><span id="l56.1591" class="difflineplus">+  if (!obj || !obj-&gt;headers) return 0;</span>
<a href="#l56.1592"></a><span id="l56.1592" class="difflineplus">+  return MimeHeaders_get(obj-&gt;headers, EXTERNAL_ATTACHMENT_URL_HEADER, false,</span>
<a href="#l56.1593"></a><span id="l56.1593" class="difflineplus">+                         false);</span>
<a href="#l56.1594"></a><span id="l56.1594"> }</span>
<a href="#l56.1595"></a><span id="l56.1595"> </span>
<a href="#l56.1596"></a><span id="l56.1596"> #ifdef ENABLE_SMIME</span>
<a href="#l56.1597"></a><span id="l56.1597"> /* Asks whether the given object is one of the cryptographically signed</span>
<a href="#l56.1598"></a><span id="l56.1598">    or encrypted objects that we know about.  (MimeMessageClass uses this</span>
<a href="#l56.1599"></a><span id="l56.1599">    to decide if the headers need to be presented differently.)</span>
<a href="#l56.1600"></a><span id="l56.1600">  */</span>
<a href="#l56.1601"></a><span id="l56.1601" class="difflineminus">-bool</span>
<a href="#l56.1602"></a><span id="l56.1602" class="difflineminus">-mime_crypto_object_p(MimeHeaders *hdrs, bool clearsigned_counts, MimeDisplayOptions *opts)</span>
<a href="#l56.1603"></a><span id="l56.1603" class="difflineminus">-{</span>
<a href="#l56.1604"></a><span id="l56.1604" class="difflineplus">+bool mime_crypto_object_p(MimeHeaders *hdrs, bool clearsigned_counts,</span>
<a href="#l56.1605"></a><span id="l56.1605" class="difflineplus">+                          MimeDisplayOptions *opts) {</span>
<a href="#l56.1606"></a><span id="l56.1606">   char *ct;</span>
<a href="#l56.1607"></a><span id="l56.1607">   MimeObjectClass *clazz;</span>
<a href="#l56.1608"></a><span id="l56.1608"> </span>
<a href="#l56.1609"></a><span id="l56.1609" class="difflineminus">-  if (!hdrs)</span>
<a href="#l56.1610"></a><span id="l56.1610" class="difflineminus">-    return false;</span>
<a href="#l56.1611"></a><span id="l56.1611" class="difflineplus">+  if (!hdrs) return false;</span>
<a href="#l56.1612"></a><span id="l56.1612"> </span>
<a href="#l56.1613"></a><span id="l56.1613" class="difflineminus">-  ct = MimeHeaders_get (hdrs, HEADER_CONTENT_TYPE, true, false);</span>
<a href="#l56.1614"></a><span id="l56.1614" class="difflineminus">-  if (!ct)</span>
<a href="#l56.1615"></a><span id="l56.1615" class="difflineminus">-    return false;</span>
<a href="#l56.1616"></a><span id="l56.1616" class="difflineplus">+  ct = MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, true, false);</span>
<a href="#l56.1617"></a><span id="l56.1617" class="difflineplus">+  if (!ct) return false;</span>
<a href="#l56.1618"></a><span id="l56.1618"> </span>
<a href="#l56.1619"></a><span id="l56.1619">   /* Rough cut -- look at the string before doing a more complex comparison. */</span>
<a href="#l56.1620"></a><span id="l56.1620">   if (PL_strcasecmp(ct, MULTIPART_SIGNED) &amp;&amp;</span>
<a href="#l56.1621"></a><span id="l56.1621" class="difflineminus">-      PL_strncasecmp(ct, &quot;application/&quot;, 12))</span>
<a href="#l56.1622"></a><span id="l56.1622" class="difflineminus">-  {</span>
<a href="#l56.1623"></a><span id="l56.1623" class="difflineplus">+      PL_strncasecmp(ct, &quot;application/&quot;, 12)) {</span>
<a href="#l56.1624"></a><span id="l56.1624">     PR_Free(ct);</span>
<a href="#l56.1625"></a><span id="l56.1625">     return false;</span>
<a href="#l56.1626"></a><span id="l56.1626">   }</span>
<a href="#l56.1627"></a><span id="l56.1627"> </span>
<a href="#l56.1628"></a><span id="l56.1628">   /* It's a candidate for being a crypto object.  Let's find out for sure... */</span>
<a href="#l56.1629"></a><span id="l56.1629">   clazz = mime_find_class(ct, hdrs, opts, true);</span>
<a href="#l56.1630"></a><span id="l56.1630">   PR_Free(ct);</span>
<a href="#l56.1631"></a><span id="l56.1631"> </span>
<a href="#l56.1632"></a><span id="l56.1632" class="difflineminus">-  if (clazz == ((MimeObjectClass *)&amp;mimeEncryptedCMSClass))</span>
<a href="#l56.1633"></a><span id="l56.1633" class="difflineminus">-    return true;</span>
<a href="#l56.1634"></a><span id="l56.1634" class="difflineplus">+  if (clazz == ((MimeObjectClass *)&amp;mimeEncryptedCMSClass)) return true;</span>
<a href="#l56.1635"></a><span id="l56.1635"> </span>
<a href="#l56.1636"></a><span id="l56.1636">   if (clearsigned_counts &amp;&amp;</span>
<a href="#l56.1637"></a><span id="l56.1637">       clazz == ((MimeObjectClass *)&amp;mimeMultipartSignedCMSClass))</span>
<a href="#l56.1638"></a><span id="l56.1638">     return true;</span>
<a href="#l56.1639"></a><span id="l56.1639"> </span>
<a href="#l56.1640"></a><span id="l56.1640">   return false;</span>
<a href="#l56.1641"></a><span id="l56.1641"> }</span>
<a href="#l56.1642"></a><span id="l56.1642"> </span>
<a href="#l56.1643"></a><span id="l56.1643"> /* Whether the given object has written out the HTML version of its headers</span>
<a href="#l56.1644"></a><span id="l56.1644">    in such a way that it will have a &quot;crypto stamp&quot; next to the headers.  If</span>
<a href="#l56.1645"></a><span id="l56.1645">    this is true, then the child must write out its HTML slightly differently</span>
<a href="#l56.1646"></a><span id="l56.1646">    to take this into account...</span>
<a href="#l56.1647"></a><span id="l56.1647">  */</span>
<a href="#l56.1648"></a><span id="l56.1648" class="difflineminus">-bool</span>
<a href="#l56.1649"></a><span id="l56.1649" class="difflineminus">-mime_crypto_stamped_p(MimeObject *obj)</span>
<a href="#l56.1650"></a><span id="l56.1650" class="difflineminus">-{</span>
<a href="#l56.1651"></a><span id="l56.1651" class="difflineminus">-  if (!obj)</span>
<a href="#l56.1652"></a><span id="l56.1652" class="difflineminus">-    return false;</span>
<a href="#l56.1653"></a><span id="l56.1653" class="difflineplus">+bool mime_crypto_stamped_p(MimeObject *obj) {</span>
<a href="#l56.1654"></a><span id="l56.1654" class="difflineplus">+  if (!obj) return false;</span>
<a href="#l56.1655"></a><span id="l56.1655">   if (mime_typep(obj, (MimeObjectClass *)&amp;mimeMessageClass))</span>
<a href="#l56.1656"></a><span id="l56.1656">     return ((MimeMessage *)obj)-&gt;crypto_stamped_p;</span>
<a href="#l56.1657"></a><span id="l56.1657">   return false;</span>
<a href="#l56.1658"></a><span id="l56.1658"> }</span>
<a href="#l56.1659"></a><span id="l56.1659"> </span>
<a href="#l56.1660"></a><span id="l56.1660" class="difflineminus">-#endif // ENABLE_SMIME</span>
<a href="#l56.1661"></a><span id="l56.1661" class="difflineplus">+#endif  // ENABLE_SMIME</span>
<a href="#l56.1662"></a><span id="l56.1662"> </span>
<a href="#l56.1663"></a><span id="l56.1663"> /* Puts a part-number into a URL.  If append_p is true, then the part number</span>
<a href="#l56.1664"></a><span id="l56.1664">    is appended to any existing part-number already in that URL; otherwise,</span>
<a href="#l56.1665"></a><span id="l56.1665">    it replaces it.</span>
<a href="#l56.1666"></a><span id="l56.1666">  */</span>
<a href="#l56.1667"></a><span id="l56.1667" class="difflineminus">-char *</span>
<a href="#l56.1668"></a><span id="l56.1668" class="difflineminus">-mime_set_url_part(const char *url, const char *part, bool append_p)</span>
<a href="#l56.1669"></a><span id="l56.1669" class="difflineminus">-{</span>
<a href="#l56.1670"></a><span id="l56.1670" class="difflineplus">+char *mime_set_url_part(const char *url, const char *part, bool append_p) {</span>
<a href="#l56.1671"></a><span id="l56.1671">   const char *part_begin = 0;</span>
<a href="#l56.1672"></a><span id="l56.1672">   const char *part_end = 0;</span>
<a href="#l56.1673"></a><span id="l56.1673">   bool got_q = false;</span>
<a href="#l56.1674"></a><span id="l56.1674">   const char *s;</span>
<a href="#l56.1675"></a><span id="l56.1675">   char *result;</span>
<a href="#l56.1676"></a><span id="l56.1676"> </span>
<a href="#l56.1677"></a><span id="l56.1677" class="difflineminus">-  if (!url || !part)</span>
<a href="#l56.1678"></a><span id="l56.1678" class="difflineminus">-    return 0;</span>
<a href="#l56.1679"></a><span id="l56.1679" class="difflineplus">+  if (!url || !part) return 0;</span>
<a href="#l56.1680"></a><span id="l56.1680"> </span>
<a href="#l56.1681"></a><span id="l56.1681">   nsAutoCString urlString(url);</span>
<a href="#l56.1682"></a><span id="l56.1682">   int32_t typeIndex = urlString.Find(&quot;?type=application/x-message-display&quot;);</span>
<a href="#l56.1683"></a><span id="l56.1683" class="difflineminus">-  if (typeIndex != -1)</span>
<a href="#l56.1684"></a><span id="l56.1684" class="difflineminus">-  {</span>
<a href="#l56.1685"></a><span id="l56.1685" class="difflineplus">+  if (typeIndex != -1) {</span>
<a href="#l56.1686"></a><span id="l56.1686">     urlString.Cut(typeIndex, sizeof(&quot;?type=application/x-message-display&quot;) - 1);</span>
<a href="#l56.1687"></a><span id="l56.1687">     if (urlString.CharAt(typeIndex) == '&amp;')</span>
<a href="#l56.1688"></a><span id="l56.1688">       urlString.Replace(typeIndex, 1, '?');</span>
<a href="#l56.1689"></a><span id="l56.1689">     url = urlString.get();</span>
<a href="#l56.1690"></a><span id="l56.1690">   }</span>
<a href="#l56.1691"></a><span id="l56.1691"> </span>
<a href="#l56.1692"></a><span id="l56.1692" class="difflineminus">-  for (s = url; *s; s++)</span>
<a href="#l56.1693"></a><span id="l56.1693" class="difflineminus">-  {</span>
<a href="#l56.1694"></a><span id="l56.1694" class="difflineminus">-    if (*s == '?')</span>
<a href="#l56.1695"></a><span id="l56.1695" class="difflineminus">-    {</span>
<a href="#l56.1696"></a><span id="l56.1696" class="difflineplus">+  for (s = url; *s; s++) {</span>
<a href="#l56.1697"></a><span id="l56.1697" class="difflineplus">+    if (*s == '?') {</span>
<a href="#l56.1698"></a><span id="l56.1698">       got_q = true;</span>
<a href="#l56.1699"></a><span id="l56.1699" class="difflineminus">-      if (!PL_strncasecmp(s, &quot;?part=&quot;, 6))</span>
<a href="#l56.1700"></a><span id="l56.1700" class="difflineminus">-      part_begin = (s += 6);</span>
<a href="#l56.1701"></a><span id="l56.1701" class="difflineminus">-    }</span>
<a href="#l56.1702"></a><span id="l56.1702" class="difflineminus">-    else if (got_q &amp;&amp; *s == '&amp;' &amp;&amp; !PL_strncasecmp(s, &quot;&amp;part=&quot;, 6))</span>
<a href="#l56.1703"></a><span id="l56.1703" class="difflineplus">+      if (!PL_strncasecmp(s, &quot;?part=&quot;, 6)) part_begin = (s += 6);</span>
<a href="#l56.1704"></a><span id="l56.1704" class="difflineplus">+    } else if (got_q &amp;&amp; *s == '&amp;' &amp;&amp; !PL_strncasecmp(s, &quot;&amp;part=&quot;, 6))</span>
<a href="#l56.1705"></a><span id="l56.1705">       part_begin = (s += 6);</span>
<a href="#l56.1706"></a><span id="l56.1706"> </span>
<a href="#l56.1707"></a><span id="l56.1707" class="difflineminus">-    if (part_begin)</span>
<a href="#l56.1708"></a><span id="l56.1708" class="difflineminus">-    {</span>
<a href="#l56.1709"></a><span id="l56.1709" class="difflineminus">-      while (*s &amp;&amp; *s != '?' &amp;&amp; *s != '&amp;')</span>
<a href="#l56.1710"></a><span id="l56.1710" class="difflineminus">-        s++;</span>
<a href="#l56.1711"></a><span id="l56.1711" class="difflineplus">+    if (part_begin) {</span>
<a href="#l56.1712"></a><span id="l56.1712" class="difflineplus">+      while (*s &amp;&amp; *s != '?' &amp;&amp; *s != '&amp;') s++;</span>
<a href="#l56.1713"></a><span id="l56.1713">       part_end = s;</span>
<a href="#l56.1714"></a><span id="l56.1714">       break;</span>
<a href="#l56.1715"></a><span id="l56.1715" class="difflineminus">-     }</span>
<a href="#l56.1716"></a><span id="l56.1716" class="difflineplus">+    }</span>
<a href="#l56.1717"></a><span id="l56.1717">   }</span>
<a href="#l56.1718"></a><span id="l56.1718"> </span>
<a href="#l56.1719"></a><span id="l56.1719">   uint32_t resultlen = strlen(url) + strlen(part) + 10;</span>
<a href="#l56.1720"></a><span id="l56.1720">   result = (char *)PR_MALLOC(resultlen);</span>
<a href="#l56.1721"></a><span id="l56.1721" class="difflineminus">-  if (!result)</span>
<a href="#l56.1722"></a><span id="l56.1722" class="difflineminus">-    return 0;</span>
<a href="#l56.1723"></a><span id="l56.1723" class="difflineplus">+  if (!result) return 0;</span>
<a href="#l56.1724"></a><span id="l56.1724"> </span>
<a href="#l56.1725"></a><span id="l56.1725" class="difflineminus">-  if (part_begin)</span>
<a href="#l56.1726"></a><span id="l56.1726" class="difflineminus">-  {</span>
<a href="#l56.1727"></a><span id="l56.1727" class="difflineminus">-    if (append_p)</span>
<a href="#l56.1728"></a><span id="l56.1728" class="difflineminus">-    {</span>
<a href="#l56.1729"></a><span id="l56.1729" class="difflineplus">+  if (part_begin) {</span>
<a href="#l56.1730"></a><span id="l56.1730" class="difflineplus">+    if (append_p) {</span>
<a href="#l56.1731"></a><span id="l56.1731">       memcpy(result, url, part_end - url);</span>
<a href="#l56.1732"></a><span id="l56.1732" class="difflineminus">-      result [part_end - url]     = '.';</span>
<a href="#l56.1733"></a><span id="l56.1733" class="difflineminus">-      result [part_end - url + 1] = 0;</span>
<a href="#l56.1734"></a><span id="l56.1734" class="difflineminus">-    }</span>
<a href="#l56.1735"></a><span id="l56.1735" class="difflineminus">-    else</span>
<a href="#l56.1736"></a><span id="l56.1736" class="difflineminus">-    {</span>
<a href="#l56.1737"></a><span id="l56.1737" class="difflineplus">+      result[part_end - url] = '.';</span>
<a href="#l56.1738"></a><span id="l56.1738" class="difflineplus">+      result[part_end - url + 1] = 0;</span>
<a href="#l56.1739"></a><span id="l56.1739" class="difflineplus">+    } else {</span>
<a href="#l56.1740"></a><span id="l56.1740">       memcpy(result, url, part_begin - url);</span>
<a href="#l56.1741"></a><span id="l56.1741" class="difflineminus">-      result [part_begin - url] = 0;</span>
<a href="#l56.1742"></a><span id="l56.1742" class="difflineplus">+      result[part_begin - url] = 0;</span>
<a href="#l56.1743"></a><span id="l56.1743">     }</span>
<a href="#l56.1744"></a><span id="l56.1744" class="difflineminus">-  }</span>
<a href="#l56.1745"></a><span id="l56.1745" class="difflineminus">-  else</span>
<a href="#l56.1746"></a><span id="l56.1746" class="difflineminus">-  {</span>
<a href="#l56.1747"></a><span id="l56.1747" class="difflineplus">+  } else {</span>
<a href="#l56.1748"></a><span id="l56.1748">     PL_strncpyz(result, url, resultlen);</span>
<a href="#l56.1749"></a><span id="l56.1749">     if (got_q)</span>
<a href="#l56.1750"></a><span id="l56.1750">       PL_strcatn(result, resultlen, &quot;&amp;part=&quot;);</span>
<a href="#l56.1751"></a><span id="l56.1751">     else</span>
<a href="#l56.1752"></a><span id="l56.1752">       PL_strcatn(result, resultlen, &quot;?part=&quot;);</span>
<a href="#l56.1753"></a><span id="l56.1753">   }</span>
<a href="#l56.1754"></a><span id="l56.1754"> </span>
<a href="#l56.1755"></a><span id="l56.1755">   PL_strcatn(result, resultlen, part);</span>
<a href="#l56.1756"></a><span id="l56.1756"> </span>
<a href="#l56.1757"></a><span id="l56.1757" class="difflineminus">-  if (part_end &amp;&amp; *part_end)</span>
<a href="#l56.1758"></a><span id="l56.1758" class="difflineminus">-  PL_strcatn(result, resultlen, part_end);</span>
<a href="#l56.1759"></a><span id="l56.1759" class="difflineplus">+  if (part_end &amp;&amp; *part_end) PL_strcatn(result, resultlen, part_end);</span>
<a href="#l56.1760"></a><span id="l56.1760"> </span>
<a href="#l56.1761"></a><span id="l56.1761">   /* Semi-broken kludge to omit a trailing &quot;?part=0&quot;. */</span>
<a href="#l56.1762"></a><span id="l56.1762">   {</span>
<a href="#l56.1763"></a><span id="l56.1763" class="difflineminus">-  int L = strlen(result);</span>
<a href="#l56.1764"></a><span id="l56.1764" class="difflineminus">-  if (L &gt; 6 &amp;&amp;</span>
<a href="#l56.1765"></a><span id="l56.1765" class="difflineminus">-      (result[L-7] == '?' || result[L-7] == '&amp;') &amp;&amp;</span>
<a href="#l56.1766"></a><span id="l56.1766" class="difflineminus">-      !strcmp(&quot;part=0&quot;, result + L - 6))</span>
<a href="#l56.1767"></a><span id="l56.1767" class="difflineminus">-    result[L-7] = 0;</span>
<a href="#l56.1768"></a><span id="l56.1768" class="difflineplus">+    int L = strlen(result);</span>
<a href="#l56.1769"></a><span id="l56.1769" class="difflineplus">+    if (L &gt; 6 &amp;&amp; (result[L - 7] == '?' || result[L - 7] == '&amp;') &amp;&amp;</span>
<a href="#l56.1770"></a><span id="l56.1770" class="difflineplus">+        !strcmp(&quot;part=0&quot;, result + L - 6))</span>
<a href="#l56.1771"></a><span id="l56.1771" class="difflineplus">+      result[L - 7] = 0;</span>
<a href="#l56.1772"></a><span id="l56.1772">   }</span>
<a href="#l56.1773"></a><span id="l56.1773"> </span>
<a href="#l56.1774"></a><span id="l56.1774">   return result;</span>
<a href="#l56.1775"></a><span id="l56.1775"> }</span>
<a href="#l56.1776"></a><span id="l56.1776"> </span>
<a href="#l56.1777"></a><span id="l56.1777" class="difflineminus">-</span>
<a href="#l56.1778"></a><span id="l56.1778"> /* Puts an *IMAP* part-number into a URL.</span>
<a href="#l56.1779"></a><span id="l56.1779" class="difflineminus">-   Strips off any previous *IMAP* part numbers, since they are absolute, not relative.</span>
<a href="#l56.1780"></a><span id="l56.1780" class="difflineplus">+   Strips off any previous *IMAP* part numbers, since they are absolute, not</span>
<a href="#l56.1781"></a><span id="l56.1781" class="difflineplus">+   relative.</span>
<a href="#l56.1782"></a><span id="l56.1782">  */</span>
<a href="#l56.1783"></a><span id="l56.1783" class="difflineminus">-char *</span>
<a href="#l56.1784"></a><span id="l56.1784" class="difflineminus">-mime_set_url_imap_part(const char *url, const char *imappart, const char *libmimepart)</span>
<a href="#l56.1785"></a><span id="l56.1785" class="difflineminus">-{</span>
<a href="#l56.1786"></a><span id="l56.1786" class="difflineplus">+char *mime_set_url_imap_part(const char *url, const char *imappart,</span>
<a href="#l56.1787"></a><span id="l56.1787" class="difflineplus">+                             const char *libmimepart) {</span>
<a href="#l56.1788"></a><span id="l56.1788">   char *result = 0;</span>
<a href="#l56.1789"></a><span id="l56.1789">   char *whereCurrent = PL_strstr(url, &quot;/;section=&quot;);</span>
<a href="#l56.1790"></a><span id="l56.1790" class="difflineminus">-  if (whereCurrent)</span>
<a href="#l56.1791"></a><span id="l56.1791" class="difflineminus">-  {</span>
<a href="#l56.1792"></a><span id="l56.1792" class="difflineplus">+  if (whereCurrent) {</span>
<a href="#l56.1793"></a><span id="l56.1793">     *whereCurrent = 0;</span>
<a href="#l56.1794"></a><span id="l56.1794">   }</span>
<a href="#l56.1795"></a><span id="l56.1795"> </span>
<a href="#l56.1796"></a><span id="l56.1796" class="difflineminus">-  uint32_t resultLen = strlen(url) + strlen(imappart) + strlen(libmimepart) + 17;</span>
<a href="#l56.1797"></a><span id="l56.1797" class="difflineplus">+  uint32_t resultLen =</span>
<a href="#l56.1798"></a><span id="l56.1798" class="difflineplus">+      strlen(url) + strlen(imappart) + strlen(libmimepart) + 17;</span>
<a href="#l56.1799"></a><span id="l56.1799">   result = (char *)PR_MALLOC(resultLen);</span>
<a href="#l56.1800"></a><span id="l56.1800" class="difflineminus">-  if (!result)</span>
<a href="#l56.1801"></a><span id="l56.1801" class="difflineminus">-    return 0;</span>
<a href="#l56.1802"></a><span id="l56.1802" class="difflineplus">+  if (!result) return 0;</span>
<a href="#l56.1803"></a><span id="l56.1803"> </span>
<a href="#l56.1804"></a><span id="l56.1804">   PL_strncpyz(result, url, resultLen);</span>
<a href="#l56.1805"></a><span id="l56.1805">   PL_strcatn(result, resultLen, &quot;/;section=&quot;);</span>
<a href="#l56.1806"></a><span id="l56.1806">   PL_strcatn(result, resultLen, imappart);</span>
<a href="#l56.1807"></a><span id="l56.1807">   PL_strcatn(result, resultLen, &quot;?part=&quot;);</span>
<a href="#l56.1808"></a><span id="l56.1808">   PL_strcatn(result, resultLen, libmimepart);</span>
<a href="#l56.1809"></a><span id="l56.1809"> </span>
<a href="#l56.1810"></a><span id="l56.1810" class="difflineminus">-  if (whereCurrent)</span>
<a href="#l56.1811"></a><span id="l56.1811" class="difflineminus">-    *whereCurrent = '/';</span>
<a href="#l56.1812"></a><span id="l56.1812" class="difflineplus">+  if (whereCurrent) *whereCurrent = '/';</span>
<a href="#l56.1813"></a><span id="l56.1813"> </span>
<a href="#l56.1814"></a><span id="l56.1814">   return result;</span>
<a href="#l56.1815"></a><span id="l56.1815"> }</span>
<a href="#l56.1816"></a><span id="l56.1816"> </span>
<a href="#l56.1817"></a><span id="l56.1817" class="difflineminus">-</span>
<a href="#l56.1818"></a><span id="l56.1818"> /* Given a part ID, looks through the MimeObject tree for a sub-part whose ID</span>
<a href="#l56.1819"></a><span id="l56.1819">    number matches, and returns the MimeObject (else NULL.)</span>
<a href="#l56.1820"></a><span id="l56.1820">    (part is not a URL -- it's of the form &quot;1.3.5&quot;.)</span>
<a href="#l56.1821"></a><span id="l56.1821">  */</span>
<a href="#l56.1822"></a><span id="l56.1822" class="difflineminus">-MimeObject *</span>
<a href="#l56.1823"></a><span id="l56.1823" class="difflineminus">-mime_address_to_part(const char *part, MimeObject *obj)</span>
<a href="#l56.1824"></a><span id="l56.1824" class="difflineminus">-{</span>
<a href="#l56.1825"></a><span id="l56.1825" class="difflineplus">+MimeObject *mime_address_to_part(const char *part, MimeObject *obj) {</span>
<a href="#l56.1826"></a><span id="l56.1826">   /* Note: this is an N^2 operation, but the number of parts in a message</span>
<a href="#l56.1827"></a><span id="l56.1827">    shouldn't ever be large enough that this really matters... */</span>
<a href="#l56.1828"></a><span id="l56.1828"> </span>
<a href="#l56.1829"></a><span id="l56.1829">   bool match;</span>
<a href="#l56.1830"></a><span id="l56.1830"> </span>
<a href="#l56.1831"></a><span id="l56.1831" class="difflineminus">-  if (!part || !*part)</span>
<a href="#l56.1832"></a><span id="l56.1832" class="difflineminus">-  {</span>
<a href="#l56.1833"></a><span id="l56.1833" class="difflineplus">+  if (!part || !*part) {</span>
<a href="#l56.1834"></a><span id="l56.1834">     match = !obj-&gt;parent;</span>
<a href="#l56.1835"></a><span id="l56.1835" class="difflineminus">-  }</span>
<a href="#l56.1836"></a><span id="l56.1836" class="difflineminus">-  else</span>
<a href="#l56.1837"></a><span id="l56.1837" class="difflineminus">-  {</span>
<a href="#l56.1838"></a><span id="l56.1838" class="difflineplus">+  } else {</span>
<a href="#l56.1839"></a><span id="l56.1839">     char *part2 = mime_part_address(obj);</span>
<a href="#l56.1840"></a><span id="l56.1840" class="difflineminus">-    if (!part2)</span>
<a href="#l56.1841"></a><span id="l56.1841" class="difflineminus">-      return 0;  /* MIME_OUT_OF_MEMORY */</span>
<a href="#l56.1842"></a><span id="l56.1842" class="difflineplus">+    if (!part2) return 0; /* MIME_OUT_OF_MEMORY */</span>
<a href="#l56.1843"></a><span id="l56.1843">     match = !strcmp(part, part2);</span>
<a href="#l56.1844"></a><span id="l56.1844">     PR_Free(part2);</span>
<a href="#l56.1845"></a><span id="l56.1845">   }</span>
<a href="#l56.1846"></a><span id="l56.1846"> </span>
<a href="#l56.1847"></a><span id="l56.1847" class="difflineminus">-  if (match)</span>
<a href="#l56.1848"></a><span id="l56.1848" class="difflineminus">-  {</span>
<a href="#l56.1849"></a><span id="l56.1849" class="difflineplus">+  if (match) {</span>
<a href="#l56.1850"></a><span id="l56.1850">     /* These are the droids we're looking for. */</span>
<a href="#l56.1851"></a><span id="l56.1851">     return obj;</span>
<a href="#l56.1852"></a><span id="l56.1852" class="difflineminus">-  }</span>
<a href="#l56.1853"></a><span id="l56.1853" class="difflineminus">-  else if (!mime_typep(obj, (MimeObjectClass *) &amp;mimeContainerClass))</span>
<a href="#l56.1854"></a><span id="l56.1854" class="difflineminus">-  {</span>
<a href="#l56.1855"></a><span id="l56.1855" class="difflineplus">+  } else if (!mime_typep(obj, (MimeObjectClass *)&amp;mimeContainerClass)) {</span>
<a href="#l56.1856"></a><span id="l56.1856">     /* Not a container, pull up, pull up! */</span>
<a href="#l56.1857"></a><span id="l56.1857">     return 0;</span>
<a href="#l56.1858"></a><span id="l56.1858" class="difflineminus">-  }</span>
<a href="#l56.1859"></a><span id="l56.1859" class="difflineminus">-  else</span>
<a href="#l56.1860"></a><span id="l56.1860" class="difflineminus">-  {</span>
<a href="#l56.1861"></a><span id="l56.1861" class="difflineplus">+  } else {</span>
<a href="#l56.1862"></a><span id="l56.1862">     int32_t i;</span>
<a href="#l56.1863"></a><span id="l56.1863">     MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l56.1864"></a><span id="l56.1864" class="difflineminus">-    for (i = 0; i &lt; cont-&gt;nchildren; i++)</span>
<a href="#l56.1865"></a><span id="l56.1865" class="difflineminus">-    {</span>
<a href="#l56.1866"></a><span id="l56.1866" class="difflineplus">+    for (i = 0; i &lt; cont-&gt;nchildren; i++) {</span>
<a href="#l56.1867"></a><span id="l56.1867">       MimeObject *o2 = mime_address_to_part(part, cont-&gt;children[i]);</span>
<a href="#l56.1868"></a><span id="l56.1868" class="difflineminus">-      if (o2)</span>
<a href="#l56.1869"></a><span id="l56.1869" class="difflineminus">-        return o2;</span>
<a href="#l56.1870"></a><span id="l56.1870" class="difflineplus">+      if (o2) return o2;</span>
<a href="#l56.1871"></a><span id="l56.1871">     }</span>
<a href="#l56.1872"></a><span id="l56.1872">     return 0;</span>
<a href="#l56.1873"></a><span id="l56.1873">   }</span>
<a href="#l56.1874"></a><span id="l56.1874"> }</span>
<a href="#l56.1875"></a><span id="l56.1875"> </span>
<a href="#l56.1876"></a><span id="l56.1876"> /* Given a part ID, looks through the MimeObject tree for a sub-part whose ID</span>
<a href="#l56.1877"></a><span id="l56.1877">    number matches; if one is found, returns the Content-Name of that part.</span>
<a href="#l56.1878"></a><span id="l56.1878">    Else returns NULL.  (part is not a URL -- it's of the form &quot;1.3.5&quot;.)</span>
<a href="#l56.1879"></a><span id="l56.1879">  */</span>
<a href="#l56.1880"></a><span id="l56.1880" class="difflineminus">-char *</span>
<a href="#l56.1881"></a><span id="l56.1881" class="difflineminus">-mime_find_content_type_of_part(const char *part, MimeObject *obj)</span>
<a href="#l56.1882"></a><span id="l56.1882" class="difflineminus">-{</span>
<a href="#l56.1883"></a><span id="l56.1883" class="difflineplus">+char *mime_find_content_type_of_part(const char *part, MimeObject *obj) {</span>
<a href="#l56.1884"></a><span id="l56.1884">   char *result = 0;</span>
<a href="#l56.1885"></a><span id="l56.1885"> </span>
<a href="#l56.1886"></a><span id="l56.1886">   obj = mime_address_to_part(part, obj);</span>
<a href="#l56.1887"></a><span id="l56.1887" class="difflineminus">-  if (!obj)</span>
<a href="#l56.1888"></a><span id="l56.1888" class="difflineminus">-    return 0;</span>
<a href="#l56.1889"></a><span id="l56.1889" class="difflineplus">+  if (!obj) return 0;</span>
<a href="#l56.1890"></a><span id="l56.1890"> </span>
<a href="#l56.1891"></a><span id="l56.1891" class="difflineminus">-  result = (obj-&gt;headers ? MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, true, false) : 0);</span>
<a href="#l56.1892"></a><span id="l56.1892" class="difflineplus">+  result = (obj-&gt;headers ? MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE,</span>
<a href="#l56.1893"></a><span id="l56.1893" class="difflineplus">+                                           true, false)</span>
<a href="#l56.1894"></a><span id="l56.1894" class="difflineplus">+                         : 0);</span>
<a href="#l56.1895"></a><span id="l56.1895"> </span>
<a href="#l56.1896"></a><span id="l56.1896">   return result;</span>
<a href="#l56.1897"></a><span id="l56.1897"> }</span>
<a href="#l56.1898"></a><span id="l56.1898"> </span>
<a href="#l56.1899"></a><span id="l56.1899"> /* Given a part ID, looks through the MimeObject tree for a sub-part whose ID</span>
<a href="#l56.1900"></a><span id="l56.1900">    number matches; if one is found, returns the Content-Name of that part.</span>
<a href="#l56.1901"></a><span id="l56.1901">    Else returns NULL.  (part is not a URL -- it's of the form &quot;1.3.5&quot;.)</span>
<a href="#l56.1902"></a><span id="l56.1902">  */</span>
<a href="#l56.1903"></a><span id="l56.1903" class="difflineminus">-char *</span>
<a href="#l56.1904"></a><span id="l56.1904" class="difflineminus">-mime_find_suggested_name_of_part(const char *part, MimeObject *obj)</span>
<a href="#l56.1905"></a><span id="l56.1905" class="difflineminus">-{</span>
<a href="#l56.1906"></a><span id="l56.1906" class="difflineplus">+char *mime_find_suggested_name_of_part(const char *part, MimeObject *obj) {</span>
<a href="#l56.1907"></a><span id="l56.1907">   char *result = 0;</span>
<a href="#l56.1908"></a><span id="l56.1908"> </span>
<a href="#l56.1909"></a><span id="l56.1909">   obj = mime_address_to_part(part, obj);</span>
<a href="#l56.1910"></a><span id="l56.1910" class="difflineminus">-  if (!obj)</span>
<a href="#l56.1911"></a><span id="l56.1911" class="difflineminus">-    return 0;</span>
<a href="#l56.1912"></a><span id="l56.1912" class="difflineplus">+  if (!obj) return 0;</span>
<a href="#l56.1913"></a><span id="l56.1913"> </span>
<a href="#l56.1914"></a><span id="l56.1914" class="difflineminus">-  result = (obj-&gt;headers ? MimeHeaders_get_name(obj-&gt;headers, obj-&gt;options) : 0);</span>
<a href="#l56.1915"></a><span id="l56.1915" class="difflineplus">+  result =</span>
<a href="#l56.1916"></a><span id="l56.1916" class="difflineplus">+      (obj-&gt;headers ? MimeHeaders_get_name(obj-&gt;headers, obj-&gt;options) : 0);</span>
<a href="#l56.1917"></a><span id="l56.1917"> </span>
<a href="#l56.1918"></a><span id="l56.1918">   /* If this part doesn't have a name, but this part is one fork of an</span>
<a href="#l56.1919"></a><span id="l56.1919">    AppleDouble, and the AppleDouble itself has a name, then use that. */</span>
<a href="#l56.1920"></a><span id="l56.1920" class="difflineminus">-  if (!result &amp;&amp;</span>
<a href="#l56.1921"></a><span id="l56.1921" class="difflineminus">-      obj-&gt;parent &amp;&amp;</span>
<a href="#l56.1922"></a><span id="l56.1922" class="difflineminus">-      obj-&gt;parent-&gt;headers &amp;&amp;</span>
<a href="#l56.1923"></a><span id="l56.1923" class="difflineplus">+  if (!result &amp;&amp; obj-&gt;parent &amp;&amp; obj-&gt;parent-&gt;headers &amp;&amp;</span>
<a href="#l56.1924"></a><span id="l56.1924">       mime_typep(obj-&gt;parent,</span>
<a href="#l56.1925"></a><span id="l56.1925">                  (MimeObjectClass *)&amp;mimeMultipartAppleDoubleClass))</span>
<a href="#l56.1926"></a><span id="l56.1926">     result = MimeHeaders_get_name(obj-&gt;parent-&gt;headers, obj-&gt;options);</span>
<a href="#l56.1927"></a><span id="l56.1927"> </span>
<a href="#l56.1928"></a><span id="l56.1928">   /* Else, if this part is itself an AppleDouble, and one of its children</span>
<a href="#l56.1929"></a><span id="l56.1929">    has a name, then use that (check data fork first, then resource.) */</span>
<a href="#l56.1930"></a><span id="l56.1930">   if (!result &amp;&amp;</span>
<a href="#l56.1931"></a><span id="l56.1931" class="difflineminus">-      mime_typep(obj, (MimeObjectClass *)&amp;mimeMultipartAppleDoubleClass))</span>
<a href="#l56.1932"></a><span id="l56.1932" class="difflineminus">-  {</span>
<a href="#l56.1933"></a><span id="l56.1933" class="difflineplus">+      mime_typep(obj, (MimeObjectClass *)&amp;mimeMultipartAppleDoubleClass)) {</span>
<a href="#l56.1934"></a><span id="l56.1934">     MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l56.1935"></a><span id="l56.1935" class="difflineminus">-    if (cont-&gt;nchildren &gt; 1 &amp;&amp;</span>
<a href="#l56.1936"></a><span id="l56.1936" class="difflineminus">-        cont-&gt;children[1] &amp;&amp;</span>
<a href="#l56.1937"></a><span id="l56.1937" class="difflineminus">-        cont-&gt;children[1]-&gt;headers)</span>
<a href="#l56.1938"></a><span id="l56.1938" class="difflineplus">+    if (cont-&gt;nchildren &gt; 1 &amp;&amp; cont-&gt;children[1] &amp;&amp; cont-&gt;children[1]-&gt;headers)</span>
<a href="#l56.1939"></a><span id="l56.1939">       result = MimeHeaders_get_name(cont-&gt;children[1]-&gt;headers, obj-&gt;options);</span>
<a href="#l56.1940"></a><span id="l56.1940"> </span>
<a href="#l56.1941"></a><span id="l56.1941" class="difflineminus">-    if (!result &amp;&amp;</span>
<a href="#l56.1942"></a><span id="l56.1942" class="difflineminus">-        cont-&gt;nchildren &gt; 0 &amp;&amp;</span>
<a href="#l56.1943"></a><span id="l56.1943" class="difflineminus">-        cont-&gt;children[0] &amp;&amp;</span>
<a href="#l56.1944"></a><span id="l56.1944" class="difflineplus">+    if (!result &amp;&amp; cont-&gt;nchildren &gt; 0 &amp;&amp; cont-&gt;children[0] &amp;&amp;</span>
<a href="#l56.1945"></a><span id="l56.1945">         cont-&gt;children[0]-&gt;headers)</span>
<a href="#l56.1946"></a><span id="l56.1946">       result = MimeHeaders_get_name(cont-&gt;children[0]-&gt;headers, obj-&gt;options);</span>
<a href="#l56.1947"></a><span id="l56.1947">   }</span>
<a href="#l56.1948"></a><span id="l56.1948"> </span>
<a href="#l56.1949"></a><span id="l56.1949">   /* Ok, now we have the suggested name, if any.</span>
<a href="#l56.1950"></a><span id="l56.1950">    Now we remove any extensions that correspond to the</span>
<a href="#l56.1951"></a><span id="l56.1951">    Content-Transfer-Encoding.  For example, if we see the headers</span>
<a href="#l56.1952"></a><span id="l56.1952"> </span>
<a href="#l56.1953"></a><span id="l56.1953" class="difflineat">@@ -1467,127 +1310,106 @@ mime_find_suggested_name_of_part(const c</span>
<a href="#l56.1954"></a><span id="l56.1954"> </span>
<a href="#l56.1955"></a><span id="l56.1955">    then we would look up (in mime.types) the file extensions which are</span>
<a href="#l56.1956"></a><span id="l56.1956">    associated with the x-uuencode encoding, find that &quot;uue&quot; is one of</span>
<a href="#l56.1957"></a><span id="l56.1957">    them, and remove that from the end of the file name, thus returning</span>
<a href="#l56.1958"></a><span id="l56.1958">    &quot;foo.text&quot; as the name.  This is because, by the time this file ends</span>
<a href="#l56.1959"></a><span id="l56.1959">    up on disk, its content-transfer-encoding will have been removed;</span>
<a href="#l56.1960"></a><span id="l56.1960">    therefore, we should suggest a file name that indicates that.</span>
<a href="#l56.1961"></a><span id="l56.1961">    */</span>
<a href="#l56.1962"></a><span id="l56.1962" class="difflineminus">-  if (result &amp;&amp; obj-&gt;encoding &amp;&amp; *obj-&gt;encoding)</span>
<a href="#l56.1963"></a><span id="l56.1963" class="difflineminus">-  {</span>
<a href="#l56.1964"></a><span id="l56.1964" class="difflineplus">+  if (result &amp;&amp; obj-&gt;encoding &amp;&amp; *obj-&gt;encoding) {</span>
<a href="#l56.1965"></a><span id="l56.1965">     int32_t L = strlen(result);</span>
<a href="#l56.1966"></a><span id="l56.1966">     const char **exts = 0;</span>
<a href="#l56.1967"></a><span id="l56.1967"> </span>
<a href="#l56.1968"></a><span id="l56.1968">     /*</span>
<a href="#l56.1969"></a><span id="l56.1969">      I'd like to ask the mime.types file, &quot;what extensions correspond</span>
<a href="#l56.1970"></a><span id="l56.1970">      to obj-&gt;encoding (which happens to be &quot;x-uuencode&quot;) but doing that</span>
<a href="#l56.1971"></a><span id="l56.1971">      in a non-sphagetti way would require brain surgery.  So, since</span>
<a href="#l56.1972"></a><span id="l56.1972">      currently uuencode is the only content-transfer-encoding which we</span>
<a href="#l56.1973"></a><span id="l56.1973">      understand which traditionally has an extension, we just special-</span>
<a href="#l56.1974"></a><span id="l56.1974">      case it here!  Icepicks in my forehead!</span>
<a href="#l56.1975"></a><span id="l56.1975"> </span>
<a href="#l56.1976"></a><span id="l56.1976">      Note that it's special-cased in a similar way in libmsg/compose.c.</span>
<a href="#l56.1977"></a><span id="l56.1977">      */</span>
<a href="#l56.1978"></a><span id="l56.1978" class="difflineminus">-    if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE))</span>
<a href="#l56.1979"></a><span id="l56.1979" class="difflineminus">-    {</span>
<a href="#l56.1980"></a><span id="l56.1980" class="difflineminus">-      static const char *uue_exts[] = { &quot;uu&quot;, &quot;uue&quot;, 0 };</span>
<a href="#l56.1981"></a><span id="l56.1981" class="difflineplus">+    if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE)) {</span>
<a href="#l56.1982"></a><span id="l56.1982" class="difflineplus">+      static const char *uue_exts[] = {&quot;uu&quot;, &quot;uue&quot;, 0};</span>
<a href="#l56.1983"></a><span id="l56.1983">       exts = uue_exts;</span>
<a href="#l56.1984"></a><span id="l56.1984">     }</span>
<a href="#l56.1985"></a><span id="l56.1985"> </span>
<a href="#l56.1986"></a><span id="l56.1986" class="difflineminus">-    while (exts &amp;&amp; *exts)</span>
<a href="#l56.1987"></a><span id="l56.1987" class="difflineminus">-    {</span>
<a href="#l56.1988"></a><span id="l56.1988" class="difflineplus">+    while (exts &amp;&amp; *exts) {</span>
<a href="#l56.1989"></a><span id="l56.1989">       const char *ext = *exts;</span>
<a href="#l56.1990"></a><span id="l56.1990">       int32_t L2 = strlen(ext);</span>
<a href="#l56.1991"></a><span id="l56.1991" class="difflineminus">-      if (L &gt; L2 + 1 &amp;&amp;                            /* long enough */</span>
<a href="#l56.1992"></a><span id="l56.1992" class="difflineminus">-          result[L - L2 - 1] == '.' &amp;&amp;             /* '.' in right place*/</span>
<a href="#l56.1993"></a><span id="l56.1993" class="difflineminus">-          !PL_strcasecmp(ext, result + (L - L2)))  /* ext matches */</span>
<a href="#l56.1994"></a><span id="l56.1994" class="difflineplus">+      if (L &gt; L2 + 1 &amp;&amp;                           /* long enough */</span>
<a href="#l56.1995"></a><span id="l56.1995" class="difflineplus">+          result[L - L2 - 1] == '.' &amp;&amp;            /* '.' in right place*/</span>
<a href="#l56.1996"></a><span id="l56.1996" class="difflineplus">+          !PL_strcasecmp(ext, result + (L - L2))) /* ext matches */</span>
<a href="#l56.1997"></a><span id="l56.1997">       {</span>
<a href="#l56.1998"></a><span id="l56.1998" class="difflineminus">-        result[L - L2 - 1] = 0;    /* truncate at '.' and stop. */</span>
<a href="#l56.1999"></a><span id="l56.1999" class="difflineplus">+        result[L - L2 - 1] = 0; /* truncate at '.' and stop. */</span>
<a href="#l56.2000"></a><span id="l56.2000">         break;</span>
<a href="#l56.2001"></a><span id="l56.2001">       }</span>
<a href="#l56.2002"></a><span id="l56.2002">       exts++;</span>
<a href="#l56.2003"></a><span id="l56.2003">     }</span>
<a href="#l56.2004"></a><span id="l56.2004">   }</span>
<a href="#l56.2005"></a><span id="l56.2005"> </span>
<a href="#l56.2006"></a><span id="l56.2006">   return result;</span>
<a href="#l56.2007"></a><span id="l56.2007"> }</span>
<a href="#l56.2008"></a><span id="l56.2008"> </span>
<a href="#l56.2009"></a><span id="l56.2009"> /* Parse the various &quot;?&quot; options off the URL and into the options struct.</span>
<a href="#l56.2010"></a><span id="l56.2010">  */</span>
<a href="#l56.2011"></a><span id="l56.2011" class="difflineminus">-int</span>
<a href="#l56.2012"></a><span id="l56.2012" class="difflineminus">-mime_parse_url_options(const char *url, MimeDisplayOptions *options)</span>
<a href="#l56.2013"></a><span id="l56.2013" class="difflineminus">-{</span>
<a href="#l56.2014"></a><span id="l56.2014" class="difflineplus">+int mime_parse_url_options(const char *url, MimeDisplayOptions *options) {</span>
<a href="#l56.2015"></a><span id="l56.2015">   const char *q;</span>
<a href="#l56.2016"></a><span id="l56.2016"> </span>
<a href="#l56.2017"></a><span id="l56.2017" class="difflineminus">-  if (!url || !*url)</span>
<a href="#l56.2018"></a><span id="l56.2018" class="difflineminus">-    return 0;</span>
<a href="#l56.2019"></a><span id="l56.2019" class="difflineminus">-  if (!options)</span>
<a href="#l56.2020"></a><span id="l56.2020" class="difflineminus">-    return 0;</span>
<a href="#l56.2021"></a><span id="l56.2021" class="difflineplus">+  if (!url || !*url) return 0;</span>
<a href="#l56.2022"></a><span id="l56.2022" class="difflineplus">+  if (!options) return 0;</span>
<a href="#l56.2023"></a><span id="l56.2023"> </span>
<a href="#l56.2024"></a><span id="l56.2024">   MimeHeadersState default_headers = options-&gt;headers;</span>
<a href="#l56.2025"></a><span id="l56.2025"> </span>
<a href="#l56.2026"></a><span id="l56.2026">   q = PL_strrchr(url, '?');</span>
<a href="#l56.2027"></a><span id="l56.2027" class="difflineminus">-  if (!q)</span>
<a href="#l56.2028"></a><span id="l56.2028" class="difflineminus">-    return 0;</span>
<a href="#l56.2029"></a><span id="l56.2029" class="difflineplus">+  if (!q) return 0;</span>
<a href="#l56.2030"></a><span id="l56.2030">   q++;</span>
<a href="#l56.2031"></a><span id="l56.2031" class="difflineminus">-  while (*q)</span>
<a href="#l56.2032"></a><span id="l56.2032" class="difflineminus">-  {</span>
<a href="#l56.2033"></a><span id="l56.2033" class="difflineplus">+  while (*q) {</span>
<a href="#l56.2034"></a><span id="l56.2034">     const char *end, *value, *name_end;</span>
<a href="#l56.2035"></a><span id="l56.2035">     end = q;</span>
<a href="#l56.2036"></a><span id="l56.2036" class="difflineminus">-    while (*end &amp;&amp; *end != '&amp;')</span>
<a href="#l56.2037"></a><span id="l56.2037" class="difflineminus">-      end++;</span>
<a href="#l56.2038"></a><span id="l56.2038" class="difflineplus">+    while (*end &amp;&amp; *end != '&amp;') end++;</span>
<a href="#l56.2039"></a><span id="l56.2039">     value = q;</span>
<a href="#l56.2040"></a><span id="l56.2040" class="difflineminus">-    while (*value != '=' &amp;&amp; value &lt; end)</span>
<a href="#l56.2041"></a><span id="l56.2041" class="difflineminus">-      value++;</span>
<a href="#l56.2042"></a><span id="l56.2042" class="difflineplus">+    while (*value != '=' &amp;&amp; value &lt; end) value++;</span>
<a href="#l56.2043"></a><span id="l56.2043">     name_end = value;</span>
<a href="#l56.2044"></a><span id="l56.2044" class="difflineminus">-    if (value &lt; end)</span>
<a href="#l56.2045"></a><span id="l56.2045" class="difflineminus">-      value++;</span>
<a href="#l56.2046"></a><span id="l56.2046" class="difflineplus">+    if (value &lt; end) value++;</span>
<a href="#l56.2047"></a><span id="l56.2047">     if (name_end &lt;= q)</span>
<a href="#l56.2048"></a><span id="l56.2048">       ;</span>
<a href="#l56.2049"></a><span id="l56.2049" class="difflineminus">-    else if (!PL_strncasecmp(&quot;headers&quot;, q, name_end - q))</span>
<a href="#l56.2050"></a><span id="l56.2050" class="difflineminus">-    {</span>
<a href="#l56.2051"></a><span id="l56.2051" class="difflineminus">-      if (end &gt; value &amp;&amp; !PL_strncasecmp(&quot;only&quot;, value, end-value))</span>
<a href="#l56.2052"></a><span id="l56.2052" class="difflineplus">+    else if (!PL_strncasecmp(&quot;headers&quot;, q, name_end - q)) {</span>
<a href="#l56.2053"></a><span id="l56.2053" class="difflineplus">+      if (end &gt; value &amp;&amp; !PL_strncasecmp(&quot;only&quot;, value, end - value))</span>
<a href="#l56.2054"></a><span id="l56.2054">         options-&gt;headers = MimeHeadersOnly;</span>
<a href="#l56.2055"></a><span id="l56.2055" class="difflineminus">-      else if (end &gt; value &amp;&amp; !PL_strncasecmp(&quot;none&quot;, value, end-value))</span>
<a href="#l56.2056"></a><span id="l56.2056" class="difflineplus">+      else if (end &gt; value &amp;&amp; !PL_strncasecmp(&quot;none&quot;, value, end - value))</span>
<a href="#l56.2057"></a><span id="l56.2057">         options-&gt;headers = MimeHeadersNone;</span>
<a href="#l56.2058"></a><span id="l56.2058">       else if (end &gt; value &amp;&amp; !PL_strncasecmp(&quot;all&quot;, value, end - value))</span>
<a href="#l56.2059"></a><span id="l56.2059">         options-&gt;headers = MimeHeadersAll;</span>
<a href="#l56.2060"></a><span id="l56.2060">       else if (end &gt; value &amp;&amp; !PL_strncasecmp(&quot;some&quot;, value, end - value))</span>
<a href="#l56.2061"></a><span id="l56.2061">         options-&gt;headers = MimeHeadersSome;</span>
<a href="#l56.2062"></a><span id="l56.2062">       else if (end &gt; value &amp;&amp; !PL_strncasecmp(&quot;micro&quot;, value, end - value))</span>
<a href="#l56.2063"></a><span id="l56.2063">         options-&gt;headers = MimeHeadersMicro;</span>
<a href="#l56.2064"></a><span id="l56.2064">       else if (end &gt; value &amp;&amp; !PL_strncasecmp(&quot;cite&quot;, value, end - value))</span>
<a href="#l56.2065"></a><span id="l56.2065">         options-&gt;headers = MimeHeadersCitation;</span>
<a href="#l56.2066"></a><span id="l56.2066" class="difflineminus">-      else if (end &gt; value &amp;&amp; !PL_strncasecmp(&quot;citation&quot;, value, end-value))</span>
<a href="#l56.2067"></a><span id="l56.2067" class="difflineplus">+      else if (end &gt; value &amp;&amp; !PL_strncasecmp(&quot;citation&quot;, value, end - value))</span>
<a href="#l56.2068"></a><span id="l56.2068">         options-&gt;headers = MimeHeadersCitation;</span>
<a href="#l56.2069"></a><span id="l56.2069">       else</span>
<a href="#l56.2070"></a><span id="l56.2070">         options-&gt;headers = default_headers;</span>
<a href="#l56.2071"></a><span id="l56.2071" class="difflineminus">-    }</span>
<a href="#l56.2072"></a><span id="l56.2072" class="difflineminus">-    else if (!PL_strncasecmp(&quot;part&quot;, q, name_end - q) &amp;&amp;</span>
<a href="#l56.2073"></a><span id="l56.2073" class="difflineminus">-      options-&gt;format_out != nsMimeOutput::nsMimeMessageBodyQuoting)</span>
<a href="#l56.2074"></a><span id="l56.2074" class="difflineminus">-    {</span>
<a href="#l56.2075"></a><span id="l56.2075" class="difflineplus">+    } else if (!PL_strncasecmp(&quot;part&quot;, q, name_end - q) &amp;&amp;</span>
<a href="#l56.2076"></a><span id="l56.2076" class="difflineplus">+               options-&gt;format_out != nsMimeOutput::nsMimeMessageBodyQuoting) {</span>
<a href="#l56.2077"></a><span id="l56.2077">       PR_FREEIF(options-&gt;part_to_load);</span>
<a href="#l56.2078"></a><span id="l56.2078" class="difflineminus">-      if (end &gt; value)</span>
<a href="#l56.2079"></a><span id="l56.2079" class="difflineminus">-      {</span>
<a href="#l56.2080"></a><span id="l56.2080" class="difflineplus">+      if (end &gt; value) {</span>
<a href="#l56.2081"></a><span id="l56.2081">         options-&gt;part_to_load = (char *)PR_MALLOC(end - value + 1);</span>
<a href="#l56.2082"></a><span id="l56.2082" class="difflineminus">-        if (!options-&gt;part_to_load)</span>
<a href="#l56.2083"></a><span id="l56.2083" class="difflineminus">-          return MIME_OUT_OF_MEMORY;</span>
<a href="#l56.2084"></a><span id="l56.2084" class="difflineminus">-        memcpy(options-&gt;part_to_load, value, end-value);</span>
<a href="#l56.2085"></a><span id="l56.2085" class="difflineminus">-        options-&gt;part_to_load[end-value] = 0;</span>
<a href="#l56.2086"></a><span id="l56.2086" class="difflineplus">+        if (!options-&gt;part_to_load) return MIME_OUT_OF_MEMORY;</span>
<a href="#l56.2087"></a><span id="l56.2087" class="difflineplus">+        memcpy(options-&gt;part_to_load, value, end - value);</span>
<a href="#l56.2088"></a><span id="l56.2088" class="difflineplus">+        options-&gt;part_to_load[end - value] = 0;</span>
<a href="#l56.2089"></a><span id="l56.2089">       }</span>
<a href="#l56.2090"></a><span id="l56.2090" class="difflineminus">-    }</span>
<a href="#l56.2091"></a><span id="l56.2091" class="difflineminus">-    else if (!PL_strncasecmp(&quot;rot13&quot;, q, name_end - q))</span>
<a href="#l56.2092"></a><span id="l56.2092" class="difflineminus">-    {</span>
<a href="#l56.2093"></a><span id="l56.2093" class="difflineminus">-      options-&gt;rot13_p = end &lt;= value || !PL_strncasecmp(&quot;true&quot;, value, end - value);</span>
<a href="#l56.2094"></a><span id="l56.2094" class="difflineminus">-    }</span>
<a href="#l56.2095"></a><span id="l56.2095" class="difflineminus">-    else if (!PL_strncasecmp(&quot;emitter&quot;, q, name_end - q))</span>
<a href="#l56.2096"></a><span id="l56.2096" class="difflineminus">-    {</span>
<a href="#l56.2097"></a><span id="l56.2097" class="difflineminus">-      if ((end &gt; value) &amp;&amp; !PL_strncasecmp(&quot;js&quot;, value, end - value))</span>
<a href="#l56.2098"></a><span id="l56.2098" class="difflineminus">-      {</span>
<a href="#l56.2099"></a><span id="l56.2099" class="difflineplus">+    } else if (!PL_strncasecmp(&quot;rot13&quot;, q, name_end - q)) {</span>
<a href="#l56.2100"></a><span id="l56.2100" class="difflineplus">+      options-&gt;rot13_p =</span>
<a href="#l56.2101"></a><span id="l56.2101" class="difflineplus">+          end &lt;= value || !PL_strncasecmp(&quot;true&quot;, value, end - value);</span>
<a href="#l56.2102"></a><span id="l56.2102" class="difflineplus">+    } else if (!PL_strncasecmp(&quot;emitter&quot;, q, name_end - q)) {</span>
<a href="#l56.2103"></a><span id="l56.2103" class="difflineplus">+      if ((end &gt; value) &amp;&amp; !PL_strncasecmp(&quot;js&quot;, value, end - value)) {</span>
<a href="#l56.2104"></a><span id="l56.2104">         // the js emitter needs to hear about nested message bodies</span>
<a href="#l56.2105"></a><span id="l56.2105">         //  in order to build a proper representation.</span>
<a href="#l56.2106"></a><span id="l56.2106">         options-&gt;notify_nested_bodies = true;</span>
<a href="#l56.2107"></a><span id="l56.2107">         // show_attachment_inline_p has the side-effect of letting the</span>
<a href="#l56.2108"></a><span id="l56.2108">         //  emitter see all parts of a multipart/alternative, which it</span>
<a href="#l56.2109"></a><span id="l56.2109">         //  really appreciates.</span>
<a href="#l56.2110"></a><span id="l56.2110">         options-&gt;show_attachment_inline_p = true;</span>
<a href="#l56.2111"></a><span id="l56.2111">         // however, show_attachment_inline_p also results in a few</span>
<a href="#l56.2112"></a><span id="l56.2112" class="difflineat">@@ -1598,331 +1420,295 @@ mime_parse_url_options(const char *url, </span>
<a href="#l56.2113"></a><span id="l56.2113">         options-&gt;write_pure_bodies = true;</span>
<a href="#l56.2114"></a><span id="l56.2114">         // we don't actually care about the data in the attachments, just the</span>
<a href="#l56.2115"></a><span id="l56.2115">         // metadata (i.e. size)</span>
<a href="#l56.2116"></a><span id="l56.2116">         options-&gt;metadata_only = true;</span>
<a href="#l56.2117"></a><span id="l56.2117">       }</span>
<a href="#l56.2118"></a><span id="l56.2118">     }</span>
<a href="#l56.2119"></a><span id="l56.2119"> </span>
<a href="#l56.2120"></a><span id="l56.2120">     q = end;</span>
<a href="#l56.2121"></a><span id="l56.2121" class="difflineminus">-    if (*q)</span>
<a href="#l56.2122"></a><span id="l56.2122" class="difflineminus">-      q++;</span>
<a href="#l56.2123"></a><span id="l56.2123" class="difflineplus">+    if (*q) q++;</span>
<a href="#l56.2124"></a><span id="l56.2124">   }</span>
<a href="#l56.2125"></a><span id="l56.2125"> </span>
<a href="#l56.2126"></a><span id="l56.2126" class="difflineminus">-</span>
<a href="#l56.2127"></a><span id="l56.2127" class="difflineminus">-/* Compatibility with the &quot;?part=&quot; syntax used in the old (Mozilla 2.0)</span>
<a href="#l56.2128"></a><span id="l56.2128" class="difflineminus">-   MIME parser.</span>
<a href="#l56.2129"></a><span id="l56.2129" class="difflineplus">+  /* Compatibility with the &quot;?part=&quot; syntax used in the old (Mozilla 2.0)</span>
<a href="#l56.2130"></a><span id="l56.2130" class="difflineplus">+     MIME parser.</span>
<a href="#l56.2131"></a><span id="l56.2131"> </span>
<a href="#l56.2132"></a><span id="l56.2132" class="difflineminus">-   Basically, the problem is that the old part-numbering code was totally</span>
<a href="#l56.2133"></a><span id="l56.2133" class="difflineminus">-   busted: here's a comparison of the old and new numberings with a pair</span>
<a href="#l56.2134"></a><span id="l56.2134" class="difflineminus">-   of hypothetical messages (one with a single part, and one with nested</span>
<a href="#l56.2135"></a><span id="l56.2135" class="difflineminus">-   containers).</span>
<a href="#l56.2136"></a><span id="l56.2136" class="difflineminus">-                        NEW:      OLD:  OR:</span>
<a href="#l56.2137"></a><span id="l56.2137" class="difflineminus">-   message/rfc822</span>
<a href="#l56.2138"></a><span id="l56.2138" class="difflineminus">-   image/jpeg           1         0     0</span>
<a href="#l56.2139"></a><span id="l56.2139" class="difflineplus">+     Basically, the problem is that the old part-numbering code was totally</span>
<a href="#l56.2140"></a><span id="l56.2140" class="difflineplus">+     busted: here's a comparison of the old and new numberings with a pair</span>
<a href="#l56.2141"></a><span id="l56.2141" class="difflineplus">+     of hypothetical messages (one with a single part, and one with nested</span>
<a href="#l56.2142"></a><span id="l56.2142" class="difflineplus">+     containers).</span>
<a href="#l56.2143"></a><span id="l56.2143" class="difflineplus">+                          NEW:      OLD:  OR:</span>
<a href="#l56.2144"></a><span id="l56.2144" class="difflineplus">+     message/rfc822</span>
<a href="#l56.2145"></a><span id="l56.2145" class="difflineplus">+     image/jpeg           1         0     0</span>
<a href="#l56.2146"></a><span id="l56.2146"> </span>
<a href="#l56.2147"></a><span id="l56.2147" class="difflineminus">-  message/rfc822</span>
<a href="#l56.2148"></a><span id="l56.2148" class="difflineminus">-  multipart/mixed       1         0     0</span>
<a href="#l56.2149"></a><span id="l56.2149" class="difflineminus">-  text/plain            1.1       1     1</span>
<a href="#l56.2150"></a><span id="l56.2150" class="difflineminus">-  image/jpeg            1.2       2     2</span>
<a href="#l56.2151"></a><span id="l56.2151" class="difflineminus">-  message/rfc822        1.3       -     3</span>
<a href="#l56.2152"></a><span id="l56.2152" class="difflineminus">-  text/plain            1.3.1     3     -</span>
<a href="#l56.2153"></a><span id="l56.2153" class="difflineminus">-  message/rfc822        1.4       -     4</span>
<a href="#l56.2154"></a><span id="l56.2154" class="difflineminus">-  multipart/mixed       1.4.1     4     -</span>
<a href="#l56.2155"></a><span id="l56.2155" class="difflineminus">-  text/plain            1.4.1.1   4.1   -</span>
<a href="#l56.2156"></a><span id="l56.2156" class="difflineminus">-  image/jpeg            1.4.1.2   4.2   -</span>
<a href="#l56.2157"></a><span id="l56.2157" class="difflineminus">-  text/plain            1.5       5     5</span>
<a href="#l56.2158"></a><span id="l56.2158" class="difflineplus">+    message/rfc822</span>
<a href="#l56.2159"></a><span id="l56.2159" class="difflineplus">+    multipart/mixed       1         0     0</span>
<a href="#l56.2160"></a><span id="l56.2160" class="difflineplus">+    text/plain            1.1       1     1</span>
<a href="#l56.2161"></a><span id="l56.2161" class="difflineplus">+    image/jpeg            1.2       2     2</span>
<a href="#l56.2162"></a><span id="l56.2162" class="difflineplus">+    message/rfc822        1.3       -     3</span>
<a href="#l56.2163"></a><span id="l56.2163" class="difflineplus">+    text/plain            1.3.1     3     -</span>
<a href="#l56.2164"></a><span id="l56.2164" class="difflineplus">+    message/rfc822        1.4       -     4</span>
<a href="#l56.2165"></a><span id="l56.2165" class="difflineplus">+    multipart/mixed       1.4.1     4     -</span>
<a href="#l56.2166"></a><span id="l56.2166" class="difflineplus">+    text/plain            1.4.1.1   4.1   -</span>
<a href="#l56.2167"></a><span id="l56.2167" class="difflineplus">+    image/jpeg            1.4.1.2   4.2   -</span>
<a href="#l56.2168"></a><span id="l56.2168" class="difflineplus">+    text/plain            1.5       5     5</span>
<a href="#l56.2169"></a><span id="l56.2169"> </span>
<a href="#l56.2170"></a><span id="l56.2170" class="difflineminus">- The &quot;NEW&quot; column is how the current code counts.  The &quot;OLD&quot; column is</span>
<a href="#l56.2171"></a><span id="l56.2171" class="difflineminus">- what &quot;?part=&quot; references would do in 3.0b4 and earlier; you'll see that</span>
<a href="#l56.2172"></a><span id="l56.2172" class="difflineminus">- you couldn't directly refer to the child message/rfc822 objects at all!</span>
<a href="#l56.2173"></a><span id="l56.2173" class="difflineminus">- But that's when it got really weird, because if you turned on</span>
<a href="#l56.2174"></a><span id="l56.2174" class="difflineminus">- &quot;Attachments As Links&quot; (or used a URL like &quot;?inline=false&amp;part=...&quot;)</span>
<a href="#l56.2175"></a><span id="l56.2175" class="difflineminus">- then you got a totally different numbering system (seen in the &quot;OR&quot;</span>
<a href="#l56.2176"></a><span id="l56.2176" class="difflineminus">- column.)  Gag!</span>
<a href="#l56.2177"></a><span id="l56.2177" class="difflineplus">+   The &quot;NEW&quot; column is how the current code counts.  The &quot;OLD&quot; column is</span>
<a href="#l56.2178"></a><span id="l56.2178" class="difflineplus">+   what &quot;?part=&quot; references would do in 3.0b4 and earlier; you'll see that</span>
<a href="#l56.2179"></a><span id="l56.2179" class="difflineplus">+   you couldn't directly refer to the child message/rfc822 objects at all!</span>
<a href="#l56.2180"></a><span id="l56.2180" class="difflineplus">+   But that's when it got really weird, because if you turned on</span>
<a href="#l56.2181"></a><span id="l56.2181" class="difflineplus">+   &quot;Attachments As Links&quot; (or used a URL like &quot;?inline=false&amp;part=...&quot;)</span>
<a href="#l56.2182"></a><span id="l56.2182" class="difflineplus">+   then you got a totally different numbering system (seen in the &quot;OR&quot;</span>
<a href="#l56.2183"></a><span id="l56.2183" class="difflineplus">+   column.)  Gag!</span>
<a href="#l56.2184"></a><span id="l56.2184"> </span>
<a href="#l56.2185"></a><span id="l56.2185" class="difflineminus">- So, the problem is, ClariNet had been using these part numbers in their</span>
<a href="#l56.2186"></a><span id="l56.2186" class="difflineminus">- HTML news feeds, as a sleazy way of transmitting both complex HTML layouts</span>
<a href="#l56.2187"></a><span id="l56.2187" class="difflineminus">- and images using NNTP as transport, without invoking HTTP.</span>
<a href="#l56.2188"></a><span id="l56.2188" class="difflineplus">+   So, the problem is, ClariNet had been using these part numbers in their</span>
<a href="#l56.2189"></a><span id="l56.2189" class="difflineplus">+   HTML news feeds, as a sleazy way of transmitting both complex HTML layouts</span>
<a href="#l56.2190"></a><span id="l56.2190" class="difflineplus">+   and images using NNTP as transport, without invoking HTTP.</span>
<a href="#l56.2191"></a><span id="l56.2191"> </span>
<a href="#l56.2192"></a><span id="l56.2192" class="difflineminus">- The following clause is to provide some small amount of backward</span>
<a href="#l56.2193"></a><span id="l56.2193" class="difflineminus">- compatibility.  By looking at that table, one can see that in the new</span>
<a href="#l56.2194"></a><span id="l56.2194" class="difflineminus">- model, &quot;part=0&quot; has no meaning, and neither does &quot;part=2&quot; or &quot;part=3&quot;</span>
<a href="#l56.2195"></a><span id="l56.2195" class="difflineminus">- and so on.</span>
<a href="#l56.2196"></a><span id="l56.2196" class="difflineplus">+   The following clause is to provide some small amount of backward</span>
<a href="#l56.2197"></a><span id="l56.2197" class="difflineplus">+   compatibility.  By looking at that table, one can see that in the new</span>
<a href="#l56.2198"></a><span id="l56.2198" class="difflineplus">+   model, &quot;part=0&quot; has no meaning, and neither does &quot;part=2&quot; or &quot;part=3&quot;</span>
<a href="#l56.2199"></a><span id="l56.2199" class="difflineplus">+   and so on.</span>
<a href="#l56.2200"></a><span id="l56.2200"> </span>
<a href="#l56.2201"></a><span id="l56.2201" class="difflineminus">- &quot;part=1&quot; is ambiguous between the old and new way, as is any part</span>
<a href="#l56.2202"></a><span id="l56.2202" class="difflineminus">- specification that has a &quot;.&quot; in it.</span>
<a href="#l56.2203"></a><span id="l56.2203" class="difflineplus">+   &quot;part=1&quot; is ambiguous between the old and new way, as is any part</span>
<a href="#l56.2204"></a><span id="l56.2204" class="difflineplus">+   specification that has a &quot;.&quot; in it.</span>
<a href="#l56.2205"></a><span id="l56.2205"> </span>
<a href="#l56.2206"></a><span id="l56.2206" class="difflineminus">- So, the compatibility hack we do here is: if the part is &quot;0&quot;, then map</span>
<a href="#l56.2207"></a><span id="l56.2207" class="difflineminus">- that to &quot;1&quot;.  And if the part is &gt;= &quot;2&quot;, then prepend &quot;1.&quot; to it (so that</span>
<a href="#l56.2208"></a><span id="l56.2208" class="difflineminus">- we map &quot;2&quot; to &quot;1.2&quot;, and &quot;3&quot; to &quot;1.3&quot;.)</span>
<a href="#l56.2209"></a><span id="l56.2209" class="difflineplus">+   So, the compatibility hack we do here is: if the part is &quot;0&quot;, then map</span>
<a href="#l56.2210"></a><span id="l56.2210" class="difflineplus">+   that to &quot;1&quot;.  And if the part is &gt;= &quot;2&quot;, then prepend &quot;1.&quot; to it (so that</span>
<a href="#l56.2211"></a><span id="l56.2211" class="difflineplus">+   we map &quot;2&quot; to &quot;1.2&quot;, and &quot;3&quot; to &quot;1.3&quot;.)</span>
<a href="#l56.2212"></a><span id="l56.2212"> </span>
<a href="#l56.2213"></a><span id="l56.2213" class="difflineminus">- This leaves the URLs compatible in the cases of:</span>
<a href="#l56.2214"></a><span id="l56.2214" class="difflineplus">+   This leaves the URLs compatible in the cases of:</span>
<a href="#l56.2215"></a><span id="l56.2215"> </span>
<a href="#l56.2216"></a><span id="l56.2216" class="difflineminus">- = single part messages</span>
<a href="#l56.2217"></a><span id="l56.2217" class="difflineminus">- = references to elements of a top-level multipart except the first</span>
<a href="#l56.2218"></a><span id="l56.2218" class="difflineplus">+   = single part messages</span>
<a href="#l56.2219"></a><span id="l56.2219" class="difflineplus">+   = references to elements of a top-level multipart except the first</span>
<a href="#l56.2220"></a><span id="l56.2220"> </span>
<a href="#l56.2221"></a><span id="l56.2221" class="difflineminus">- and leaves them incompatible for:</span>
<a href="#l56.2222"></a><span id="l56.2222" class="difflineplus">+   and leaves them incompatible for:</span>
<a href="#l56.2223"></a><span id="l56.2223"> </span>
<a href="#l56.2224"></a><span id="l56.2224" class="difflineminus">- = the first part of a top-level multipart</span>
<a href="#l56.2225"></a><span id="l56.2225" class="difflineminus">- = all elements deeper than the outermost part</span>
<a href="#l56.2226"></a><span id="l56.2226" class="difflineplus">+   = the first part of a top-level multipart</span>
<a href="#l56.2227"></a><span id="l56.2227" class="difflineplus">+   = all elements deeper than the outermost part</span>
<a href="#l56.2228"></a><span id="l56.2228"> </span>
<a href="#l56.2229"></a><span id="l56.2229" class="difflineminus">- Life s#$%s when you don't properly think out things that end up turning</span>
<a href="#l56.2230"></a><span id="l56.2230" class="difflineminus">- into de-facto standards...</span>
<a href="#l56.2231"></a><span id="l56.2231" class="difflineminus">- */</span>
<a href="#l56.2232"></a><span id="l56.2232" class="difflineplus">+   Life s#$%s when you don't properly think out things that end up turning</span>
<a href="#l56.2233"></a><span id="l56.2233" class="difflineplus">+   into de-facto standards...</span>
<a href="#l56.2234"></a><span id="l56.2234" class="difflineplus">+   */</span>
<a href="#l56.2235"></a><span id="l56.2235"> </span>
<a href="#l56.2236"></a><span id="l56.2236" class="difflineminus">- if (options-&gt;part_to_load &amp;&amp;</span>
<a href="#l56.2237"></a><span id="l56.2237" class="difflineminus">-   !PL_strchr(options-&gt;part_to_load, '.'))    /* doesn't contain a dot */</span>
<a href="#l56.2238"></a><span id="l56.2238" class="difflineminus">- {</span>
<a href="#l56.2239"></a><span id="l56.2239" class="difflineminus">-   if (!strcmp(options-&gt;part_to_load, &quot;0&quot;))    /* 0 */</span>
<a href="#l56.2240"></a><span id="l56.2240" class="difflineminus">-   {</span>
<a href="#l56.2241"></a><span id="l56.2241" class="difflineminus">-     PR_Free(options-&gt;part_to_load);</span>
<a href="#l56.2242"></a><span id="l56.2242" class="difflineminus">-     options-&gt;part_to_load = strdup(&quot;1&quot;);</span>
<a href="#l56.2243"></a><span id="l56.2243" class="difflineminus">-     if (!options-&gt;part_to_load)</span>
<a href="#l56.2244"></a><span id="l56.2244" class="difflineminus">-       return MIME_OUT_OF_MEMORY;</span>
<a href="#l56.2245"></a><span id="l56.2245" class="difflineminus">-   }</span>
<a href="#l56.2246"></a><span id="l56.2246" class="difflineminus">-   else if (strcmp(options-&gt;part_to_load, &quot;1&quot;))  /* not 1 */</span>
<a href="#l56.2247"></a><span id="l56.2247" class="difflineminus">-   {</span>
<a href="#l56.2248"></a><span id="l56.2248" class="difflineminus">-     const char *prefix = &quot;1.&quot;;</span>
<a href="#l56.2249"></a><span id="l56.2249" class="difflineminus">-     uint32_t slen = strlen(options-&gt;part_to_load) + strlen(prefix) + 1;</span>
<a href="#l56.2250"></a><span id="l56.2250" class="difflineminus">-     char *s = (char *)PR_MALLOC(slen);</span>
<a href="#l56.2251"></a><span id="l56.2251" class="difflineminus">-     if (!s)</span>
<a href="#l56.2252"></a><span id="l56.2252" class="difflineminus">-       return MIME_OUT_OF_MEMORY;</span>
<a href="#l56.2253"></a><span id="l56.2253" class="difflineminus">-     PL_strncpyz(s, prefix, slen);</span>
<a href="#l56.2254"></a><span id="l56.2254" class="difflineminus">-     PL_strcatn(s, slen, options-&gt;part_to_load);</span>
<a href="#l56.2255"></a><span id="l56.2255" class="difflineminus">-     PR_Free(options-&gt;part_to_load);</span>
<a href="#l56.2256"></a><span id="l56.2256" class="difflineminus">-     options-&gt;part_to_load = s;</span>
<a href="#l56.2257"></a><span id="l56.2257" class="difflineminus">-   }</span>
<a href="#l56.2258"></a><span id="l56.2258" class="difflineminus">- }</span>
<a href="#l56.2259"></a><span id="l56.2259" class="difflineplus">+  if (options-&gt;part_to_load &amp;&amp;</span>
<a href="#l56.2260"></a><span id="l56.2260" class="difflineplus">+      !PL_strchr(options-&gt;part_to_load, '.')) /* doesn't contain a dot */</span>
<a href="#l56.2261"></a><span id="l56.2261" class="difflineplus">+  {</span>
<a href="#l56.2262"></a><span id="l56.2262" class="difflineplus">+    if (!strcmp(options-&gt;part_to_load, &quot;0&quot;)) /* 0 */</span>
<a href="#l56.2263"></a><span id="l56.2263" class="difflineplus">+    {</span>
<a href="#l56.2264"></a><span id="l56.2264" class="difflineplus">+      PR_Free(options-&gt;part_to_load);</span>
<a href="#l56.2265"></a><span id="l56.2265" class="difflineplus">+      options-&gt;part_to_load = strdup(&quot;1&quot;);</span>
<a href="#l56.2266"></a><span id="l56.2266" class="difflineplus">+      if (!options-&gt;part_to_load) return MIME_OUT_OF_MEMORY;</span>
<a href="#l56.2267"></a><span id="l56.2267" class="difflineplus">+    } else if (strcmp(options-&gt;part_to_load, &quot;1&quot;)) /* not 1 */</span>
<a href="#l56.2268"></a><span id="l56.2268" class="difflineplus">+    {</span>
<a href="#l56.2269"></a><span id="l56.2269" class="difflineplus">+      const char *prefix = &quot;1.&quot;;</span>
<a href="#l56.2270"></a><span id="l56.2270" class="difflineplus">+      uint32_t slen = strlen(options-&gt;part_to_load) + strlen(prefix) + 1;</span>
<a href="#l56.2271"></a><span id="l56.2271" class="difflineplus">+      char *s = (char *)PR_MALLOC(slen);</span>
<a href="#l56.2272"></a><span id="l56.2272" class="difflineplus">+      if (!s) return MIME_OUT_OF_MEMORY;</span>
<a href="#l56.2273"></a><span id="l56.2273" class="difflineplus">+      PL_strncpyz(s, prefix, slen);</span>
<a href="#l56.2274"></a><span id="l56.2274" class="difflineplus">+      PL_strcatn(s, slen, options-&gt;part_to_load);</span>
<a href="#l56.2275"></a><span id="l56.2275" class="difflineplus">+      PR_Free(options-&gt;part_to_load);</span>
<a href="#l56.2276"></a><span id="l56.2276" class="difflineplus">+      options-&gt;part_to_load = s;</span>
<a href="#l56.2277"></a><span id="l56.2277" class="difflineplus">+    }</span>
<a href="#l56.2278"></a><span id="l56.2278" class="difflineplus">+  }</span>
<a href="#l56.2279"></a><span id="l56.2279"> </span>
<a href="#l56.2280"></a><span id="l56.2280">   return 0;</span>
<a href="#l56.2281"></a><span id="l56.2281"> }</span>
<a href="#l56.2282"></a><span id="l56.2282"> </span>
<a href="#l56.2283"></a><span id="l56.2283" class="difflineminus">-</span>
<a href="#l56.2284"></a><span id="l56.2284"> /* Some output-generation utility functions...</span>
<a href="#l56.2285"></a><span id="l56.2285">  */</span>
<a href="#l56.2286"></a><span id="l56.2286"> </span>
<a href="#l56.2287"></a><span id="l56.2287" class="difflineminus">-int</span>
<a href="#l56.2288"></a><span id="l56.2288" class="difflineminus">-MimeOptions_write(MimeHeaders *hdrs, MimeDisplayOptions *opt, const char *data,</span>
<a href="#l56.2289"></a><span id="l56.2289" class="difflineminus">-                  int32_t length, bool user_visible_p)</span>
<a href="#l56.2290"></a><span id="l56.2290" class="difflineminus">-{</span>
<a href="#l56.2291"></a><span id="l56.2291" class="difflineplus">+int MimeOptions_write(MimeHeaders *hdrs, MimeDisplayOptions *opt,</span>
<a href="#l56.2292"></a><span id="l56.2292" class="difflineplus">+                      const char *data, int32_t length, bool user_visible_p) {</span>
<a href="#l56.2293"></a><span id="l56.2293">   int status = 0;</span>
<a href="#l56.2294"></a><span id="l56.2294" class="difflineminus">-  void* closure = 0;</span>
<a href="#l56.2295"></a><span id="l56.2295" class="difflineminus">-  if (!opt || !opt-&gt;output_fn || !opt-&gt;state)</span>
<a href="#l56.2296"></a><span id="l56.2296" class="difflineminus">-    return 0;</span>
<a href="#l56.2297"></a><span id="l56.2297" class="difflineplus">+  void *closure = 0;</span>
<a href="#l56.2298"></a><span id="l56.2298" class="difflineplus">+  if (!opt || !opt-&gt;output_fn || !opt-&gt;state) return 0;</span>
<a href="#l56.2299"></a><span id="l56.2299"> </span>
<a href="#l56.2300"></a><span id="l56.2300">   closure = opt-&gt;output_closure;</span>
<a href="#l56.2301"></a><span id="l56.2301">   if (!closure) closure = opt-&gt;stream_closure;</span>
<a href="#l56.2302"></a><span id="l56.2302"> </span>
<a href="#l56.2303"></a><span id="l56.2303" class="difflineminus">-//  PR_ASSERT(opt-&gt;state-&gt;first_data_written_p);</span>
<a href="#l56.2304"></a><span id="l56.2304" class="difflineplus">+  //  PR_ASSERT(opt-&gt;state-&gt;first_data_written_p);</span>
<a href="#l56.2305"></a><span id="l56.2305"> </span>
<a href="#l56.2306"></a><span id="l56.2306" class="difflineminus">-  if (opt-&gt;state-&gt;separator_queued_p &amp;&amp; user_visible_p)</span>
<a href="#l56.2307"></a><span id="l56.2307" class="difflineminus">-  {</span>
<a href="#l56.2308"></a><span id="l56.2308" class="difflineplus">+  if (opt-&gt;state-&gt;separator_queued_p &amp;&amp; user_visible_p) {</span>
<a href="#l56.2309"></a><span id="l56.2309">     opt-&gt;state-&gt;separator_queued_p = false;</span>
<a href="#l56.2310"></a><span id="l56.2310">     if (opt-&gt;state-&gt;separator_suppressed_p)</span>
<a href="#l56.2311"></a><span id="l56.2311">       opt-&gt;state-&gt;separator_suppressed_p = false;</span>
<a href="#l56.2312"></a><span id="l56.2312">     else {</span>
<a href="#l56.2313"></a><span id="l56.2313">       const char *sep = &quot;&lt;BR&gt;&lt;FIELDSET CLASS=\&quot;mimeAttachmentHeader\&quot;&gt;&quot;;</span>
<a href="#l56.2314"></a><span id="l56.2314">       int lstatus = opt-&gt;output_fn(sep, strlen(sep), closure);</span>
<a href="#l56.2315"></a><span id="l56.2315">       opt-&gt;state-&gt;separator_suppressed_p = false;</span>
<a href="#l56.2316"></a><span id="l56.2316" class="difflineminus">-      if (lstatus &lt; 0)</span>
<a href="#l56.2317"></a><span id="l56.2317" class="difflineminus">-        return lstatus;</span>
<a href="#l56.2318"></a><span id="l56.2318" class="difflineplus">+      if (lstatus &lt; 0) return lstatus;</span>
<a href="#l56.2319"></a><span id="l56.2319"> </span>
<a href="#l56.2320"></a><span id="l56.2320">       nsCString name;</span>
<a href="#l56.2321"></a><span id="l56.2321">       name.Adopt(MimeHeaders_get_name(hdrs, opt));</span>
<a href="#l56.2322"></a><span id="l56.2322">       MimeHeaders_convert_header_value(opt, name, false);</span>
<a href="#l56.2323"></a><span id="l56.2323"> </span>
<a href="#l56.2324"></a><span id="l56.2324">       if (!name.IsEmpty()) {</span>
<a href="#l56.2325"></a><span id="l56.2325">         sep = &quot;&lt;LEGEND CLASS=\&quot;mimeAttachmentHeaderName\&quot;&gt;&quot;;</span>
<a href="#l56.2326"></a><span id="l56.2326">         lstatus = opt-&gt;output_fn(sep, strlen(sep), closure);</span>
<a href="#l56.2327"></a><span id="l56.2327">         opt-&gt;state-&gt;separator_suppressed_p = false;</span>
<a href="#l56.2328"></a><span id="l56.2328" class="difflineminus">-        if (lstatus &lt; 0)</span>
<a href="#l56.2329"></a><span id="l56.2329" class="difflineminus">-          return lstatus;</span>
<a href="#l56.2330"></a><span id="l56.2330" class="difflineplus">+        if (lstatus &lt; 0) return lstatus;</span>
<a href="#l56.2331"></a><span id="l56.2331"> </span>
<a href="#l56.2332"></a><span id="l56.2332">         nsCString escapedName;</span>
<a href="#l56.2333"></a><span id="l56.2333">         nsAppendEscapedHTML(name, escapedName);</span>
<a href="#l56.2334"></a><span id="l56.2334"> </span>
<a href="#l56.2335"></a><span id="l56.2335" class="difflineminus">-        lstatus = opt-&gt;output_fn(escapedName.get(),</span>
<a href="#l56.2336"></a><span id="l56.2336" class="difflineminus">-                                 escapedName.Length(), closure);</span>
<a href="#l56.2337"></a><span id="l56.2337" class="difflineplus">+        lstatus =</span>
<a href="#l56.2338"></a><span id="l56.2338" class="difflineplus">+            opt-&gt;output_fn(escapedName.get(), escapedName.Length(), closure);</span>
<a href="#l56.2339"></a><span id="l56.2339">         opt-&gt;state-&gt;separator_suppressed_p = false;</span>
<a href="#l56.2340"></a><span id="l56.2340" class="difflineminus">-        if (lstatus &lt; 0)</span>
<a href="#l56.2341"></a><span id="l56.2341" class="difflineminus">-          return lstatus;</span>
<a href="#l56.2342"></a><span id="l56.2342" class="difflineplus">+        if (lstatus &lt; 0) return lstatus;</span>
<a href="#l56.2343"></a><span id="l56.2343"> </span>
<a href="#l56.2344"></a><span id="l56.2344">         sep = &quot;&lt;/LEGEND&gt;&quot;;</span>
<a href="#l56.2345"></a><span id="l56.2345">         lstatus = opt-&gt;output_fn(sep, strlen(sep), closure);</span>
<a href="#l56.2346"></a><span id="l56.2346">         opt-&gt;state-&gt;separator_suppressed_p = false;</span>
<a href="#l56.2347"></a><span id="l56.2347" class="difflineminus">-        if (lstatus &lt; 0)</span>
<a href="#l56.2348"></a><span id="l56.2348" class="difflineminus">-          return lstatus;</span>
<a href="#l56.2349"></a><span id="l56.2349" class="difflineplus">+        if (lstatus &lt; 0) return lstatus;</span>
<a href="#l56.2350"></a><span id="l56.2350">       }</span>
<a href="#l56.2351"></a><span id="l56.2351"> </span>
<a href="#l56.2352"></a><span id="l56.2352">       sep = &quot;&lt;/FIELDSET&gt;&quot;;</span>
<a href="#l56.2353"></a><span id="l56.2353">       lstatus = opt-&gt;output_fn(sep, strlen(sep), closure);</span>
<a href="#l56.2354"></a><span id="l56.2354">       opt-&gt;state-&gt;separator_suppressed_p = false;</span>
<a href="#l56.2355"></a><span id="l56.2355" class="difflineminus">-      if (lstatus &lt; 0)</span>
<a href="#l56.2356"></a><span id="l56.2356" class="difflineminus">-        return lstatus;</span>
<a href="#l56.2357"></a><span id="l56.2357" class="difflineplus">+      if (lstatus &lt; 0) return lstatus;</span>
<a href="#l56.2358"></a><span id="l56.2358">     }</span>
<a href="#l56.2359"></a><span id="l56.2359">   }</span>
<a href="#l56.2360"></a><span id="l56.2360" class="difflineminus">-  if (user_visible_p)</span>
<a href="#l56.2361"></a><span id="l56.2361" class="difflineminus">-    opt-&gt;state-&gt;separator_suppressed_p = false;</span>
<a href="#l56.2362"></a><span id="l56.2362" class="difflineplus">+  if (user_visible_p) opt-&gt;state-&gt;separator_suppressed_p = false;</span>
<a href="#l56.2363"></a><span id="l56.2363"> </span>
<a href="#l56.2364"></a><span id="l56.2364" class="difflineminus">-  if (length &gt; 0)</span>
<a href="#l56.2365"></a><span id="l56.2365" class="difflineminus">-  {</span>
<a href="#l56.2366"></a><span id="l56.2366" class="difflineplus">+  if (length &gt; 0) {</span>
<a href="#l56.2367"></a><span id="l56.2367">     status = opt-&gt;output_fn(data, length, closure);</span>
<a href="#l56.2368"></a><span id="l56.2368" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l56.2369"></a><span id="l56.2369" class="difflineminus">-      return status;</span>
<a href="#l56.2370"></a><span id="l56.2370" class="difflineplus">+    if (status &lt; 0) return status;</span>
<a href="#l56.2371"></a><span id="l56.2371">   }</span>
<a href="#l56.2372"></a><span id="l56.2372"> </span>
<a href="#l56.2373"></a><span id="l56.2373">   return 0;</span>
<a href="#l56.2374"></a><span id="l56.2374"> }</span>
<a href="#l56.2375"></a><span id="l56.2375"> </span>
<a href="#l56.2376"></a><span id="l56.2376" class="difflineminus">-int</span>
<a href="#l56.2377"></a><span id="l56.2377" class="difflineminus">-MimeObject_write(MimeObject *obj, const char *output, int32_t length,</span>
<a href="#l56.2378"></a><span id="l56.2378" class="difflineminus">-         bool user_visible_p)</span>
<a href="#l56.2379"></a><span id="l56.2379" class="difflineminus">-{</span>
<a href="#l56.2380"></a><span id="l56.2380" class="difflineminus">-  if (!obj-&gt;output_p)</span>
<a href="#l56.2381"></a><span id="l56.2381" class="difflineminus">-    return 0;</span>
<a href="#l56.2382"></a><span id="l56.2382" class="difflineplus">+int MimeObject_write(MimeObject *obj, const char *output, int32_t length,</span>
<a href="#l56.2383"></a><span id="l56.2383" class="difflineplus">+                     bool user_visible_p) {</span>
<a href="#l56.2384"></a><span id="l56.2384" class="difflineplus">+  if (!obj-&gt;output_p) return 0;</span>
<a href="#l56.2385"></a><span id="l56.2385"> </span>
<a href="#l56.2386"></a><span id="l56.2386">   // if we're stripping attachments, check if any parent is not being output</span>
<a href="#l56.2387"></a><span id="l56.2387" class="difflineminus">-  if (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l56.2388"></a><span id="l56.2388" class="difflineminus">-  {</span>
<a href="#l56.2389"></a><span id="l56.2389" class="difflineplus">+  if (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach) {</span>
<a href="#l56.2390"></a><span id="l56.2390">     // if true, mime generates a separator in html - we don't want that.</span>
<a href="#l56.2391"></a><span id="l56.2391">     user_visible_p = false;</span>
<a href="#l56.2392"></a><span id="l56.2392"> </span>
<a href="#l56.2393"></a><span id="l56.2393" class="difflineminus">-    for (MimeObject *parent = obj-&gt;parent; parent; parent = parent-&gt;parent)</span>
<a href="#l56.2394"></a><span id="l56.2394" class="difflineminus">-    {</span>
<a href="#l56.2395"></a><span id="l56.2395" class="difflineminus">-      if (!parent-&gt;output_p)</span>
<a href="#l56.2396"></a><span id="l56.2396" class="difflineminus">-        return 0;</span>
<a href="#l56.2397"></a><span id="l56.2397" class="difflineplus">+    for (MimeObject *parent = obj-&gt;parent; parent; parent = parent-&gt;parent) {</span>
<a href="#l56.2398"></a><span id="l56.2398" class="difflineplus">+      if (!parent-&gt;output_p) return 0;</span>
<a href="#l56.2399"></a><span id="l56.2399">     }</span>
<a href="#l56.2400"></a><span id="l56.2400">   }</span>
<a href="#l56.2401"></a><span id="l56.2401" class="difflineminus">-  if (!obj-&gt;options-&gt;state-&gt;first_data_written_p)</span>
<a href="#l56.2402"></a><span id="l56.2402" class="difflineminus">-  {</span>
<a href="#l56.2403"></a><span id="l56.2403" class="difflineplus">+  if (!obj-&gt;options-&gt;state-&gt;first_data_written_p) {</span>
<a href="#l56.2404"></a><span id="l56.2404">     int status = MimeObject_output_init(obj, 0);</span>
<a href="#l56.2405"></a><span id="l56.2405" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l56.2406"></a><span id="l56.2406" class="difflineminus">-      return status;</span>
<a href="#l56.2407"></a><span id="l56.2407" class="difflineminus">-    NS_ASSERTION(obj-&gt;options-&gt;state-&gt;first_data_written_p, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.2408"></a><span id="l56.2408" class="difflineplus">+    if (status &lt; 0) return status;</span>
<a href="#l56.2409"></a><span id="l56.2409" class="difflineplus">+    NS_ASSERTION(obj-&gt;options-&gt;state-&gt;first_data_written_p,</span>
<a href="#l56.2410"></a><span id="l56.2410" class="difflineplus">+                 &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l56.2411"></a><span id="l56.2411">   }</span>
<a href="#l56.2412"></a><span id="l56.2412"> </span>
<a href="#l56.2413"></a><span id="l56.2413" class="difflineminus">-  return MimeOptions_write(obj-&gt;headers, obj-&gt;options, output, length, user_visible_p);</span>
<a href="#l56.2414"></a><span id="l56.2414" class="difflineplus">+  return MimeOptions_write(obj-&gt;headers, obj-&gt;options, output, length,</span>
<a href="#l56.2415"></a><span id="l56.2415" class="difflineplus">+                           user_visible_p);</span>
<a href="#l56.2416"></a><span id="l56.2416"> }</span>
<a href="#l56.2417"></a><span id="l56.2417"> </span>
<a href="#l56.2418"></a><span id="l56.2418" class="difflineminus">-int</span>
<a href="#l56.2419"></a><span id="l56.2419" class="difflineminus">-MimeObject_write_separator(MimeObject *obj)</span>
<a href="#l56.2420"></a><span id="l56.2420" class="difflineminus">-{</span>
<a href="#l56.2421"></a><span id="l56.2421" class="difflineplus">+int MimeObject_write_separator(MimeObject *obj) {</span>
<a href="#l56.2422"></a><span id="l56.2422">   if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l56.2423"></a><span id="l56.2423">       // we never want separators if we are asking for pure bodies</span>
<a href="#l56.2424"></a><span id="l56.2424">       !obj-&gt;options-&gt;write_pure_bodies)</span>
<a href="#l56.2425"></a><span id="l56.2425">     obj-&gt;options-&gt;state-&gt;separator_queued_p = true;</span>
<a href="#l56.2426"></a><span id="l56.2426">   return 0;</span>
<a href="#l56.2427"></a><span id="l56.2427"> }</span>
<a href="#l56.2428"></a><span id="l56.2428"> </span>
<a href="#l56.2429"></a><span id="l56.2429" class="difflineminus">-int</span>
<a href="#l56.2430"></a><span id="l56.2430" class="difflineminus">-MimeObject_output_init(MimeObject *obj, const char *content_type)</span>
<a href="#l56.2431"></a><span id="l56.2431" class="difflineminus">-{</span>
<a href="#l56.2432"></a><span id="l56.2432" class="difflineminus">-  if (obj &amp;&amp;</span>
<a href="#l56.2433"></a><span id="l56.2433" class="difflineminus">-      obj-&gt;options &amp;&amp;</span>
<a href="#l56.2434"></a><span id="l56.2434" class="difflineminus">-      obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l56.2435"></a><span id="l56.2435" class="difflineminus">-      !obj-&gt;options-&gt;state-&gt;first_data_written_p)</span>
<a href="#l56.2436"></a><span id="l56.2436" class="difflineminus">-  {</span>
<a href="#l56.2437"></a><span id="l56.2437" class="difflineplus">+int MimeObject_output_init(MimeObject *obj, const char *content_type) {</span>
<a href="#l56.2438"></a><span id="l56.2438" class="difflineplus">+  if (obj &amp;&amp; obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l56.2439"></a><span id="l56.2439" class="difflineplus">+      !obj-&gt;options-&gt;state-&gt;first_data_written_p) {</span>
<a href="#l56.2440"></a><span id="l56.2440">     int status;</span>
<a href="#l56.2441"></a><span id="l56.2441">     const char *charset = 0;</span>
<a href="#l56.2442"></a><span id="l56.2442">     char *name = 0, *x_mac_type = 0, *x_mac_creator = 0;</span>
<a href="#l56.2443"></a><span id="l56.2443"> </span>
<a href="#l56.2444"></a><span id="l56.2444" class="difflineminus">-    if (!obj-&gt;options-&gt;output_init_fn)</span>
<a href="#l56.2445"></a><span id="l56.2445" class="difflineminus">-    {</span>
<a href="#l56.2446"></a><span id="l56.2446" class="difflineplus">+    if (!obj-&gt;options-&gt;output_init_fn) {</span>
<a href="#l56.2447"></a><span id="l56.2447">       obj-&gt;options-&gt;state-&gt;first_data_written_p = true;</span>
<a href="#l56.2448"></a><span id="l56.2448">       return 0;</span>
<a href="#l56.2449"></a><span id="l56.2449">     }</span>
<a href="#l56.2450"></a><span id="l56.2450"> </span>
<a href="#l56.2451"></a><span id="l56.2451" class="difflineminus">-    if (obj-&gt;headers)</span>
<a href="#l56.2452"></a><span id="l56.2452" class="difflineminus">-    {</span>
<a href="#l56.2453"></a><span id="l56.2453" class="difflineplus">+    if (obj-&gt;headers) {</span>
<a href="#l56.2454"></a><span id="l56.2454">       char *ct;</span>
<a href="#l56.2455"></a><span id="l56.2455">       name = MimeHeaders_get_name(obj-&gt;headers, obj-&gt;options);</span>
<a href="#l56.2456"></a><span id="l56.2456"> </span>
<a href="#l56.2457"></a><span id="l56.2457" class="difflineminus">-      ct = MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE,</span>
<a href="#l56.2458"></a><span id="l56.2458" class="difflineminus">-                 false, false);</span>
<a href="#l56.2459"></a><span id="l56.2459" class="difflineminus">-      if (ct)</span>
<a href="#l56.2460"></a><span id="l56.2460" class="difflineminus">-      {</span>
<a href="#l56.2461"></a><span id="l56.2461" class="difflineminus">-        x_mac_type   = MimeHeaders_get_parameter(ct, PARAM_X_MAC_TYPE, nullptr, nullptr);</span>
<a href="#l56.2462"></a><span id="l56.2462" class="difflineminus">-        x_mac_creator= MimeHeaders_get_parameter(ct, PARAM_X_MAC_CREATOR, nullptr, nullptr);</span>
<a href="#l56.2463"></a><span id="l56.2463" class="difflineminus">-        /* if don't have a x_mac_type and x_mac_creator, we need to try to get it from its parent */</span>
<a href="#l56.2464"></a><span id="l56.2464" class="difflineminus">-        if (!x_mac_type &amp;&amp; !x_mac_creator &amp;&amp; obj-&gt;parent &amp;&amp; obj-&gt;parent-&gt;headers)</span>
<a href="#l56.2465"></a><span id="l56.2465" class="difflineminus">-        {</span>
<a href="#l56.2466"></a><span id="l56.2466" class="difflineminus">-          char * ctp = MimeHeaders_get(obj-&gt;parent-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l56.2467"></a><span id="l56.2467" class="difflineminus">-          if (ctp)</span>
<a href="#l56.2468"></a><span id="l56.2468" class="difflineminus">-          {</span>
<a href="#l56.2469"></a><span id="l56.2469" class="difflineminus">-            x_mac_type   = MimeHeaders_get_parameter(ctp, PARAM_X_MAC_TYPE, nullptr, nullptr);</span>
<a href="#l56.2470"></a><span id="l56.2470" class="difflineminus">-            x_mac_creator= MimeHeaders_get_parameter(ctp, PARAM_X_MAC_CREATOR, nullptr, nullptr);</span>
<a href="#l56.2471"></a><span id="l56.2471" class="difflineplus">+      ct = MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l56.2472"></a><span id="l56.2472" class="difflineplus">+      if (ct) {</span>
<a href="#l56.2473"></a><span id="l56.2473" class="difflineplus">+        x_mac_type =</span>
<a href="#l56.2474"></a><span id="l56.2474" class="difflineplus">+            MimeHeaders_get_parameter(ct, PARAM_X_MAC_TYPE, nullptr, nullptr);</span>
<a href="#l56.2475"></a><span id="l56.2475" class="difflineplus">+        x_mac_creator = MimeHeaders_get_parameter(ct, PARAM_X_MAC_CREATOR,</span>
<a href="#l56.2476"></a><span id="l56.2476" class="difflineplus">+                                                  nullptr, nullptr);</span>
<a href="#l56.2477"></a><span id="l56.2477" class="difflineplus">+        /* if don't have a x_mac_type and x_mac_creator, we need to try to get</span>
<a href="#l56.2478"></a><span id="l56.2478" class="difflineplus">+         * it from its parent */</span>
<a href="#l56.2479"></a><span id="l56.2479" class="difflineplus">+        if (!x_mac_type &amp;&amp; !x_mac_creator &amp;&amp; obj-&gt;parent &amp;&amp;</span>
<a href="#l56.2480"></a><span id="l56.2480" class="difflineplus">+            obj-&gt;parent-&gt;headers) {</span>
<a href="#l56.2481"></a><span id="l56.2481" class="difflineplus">+          char *ctp = MimeHeaders_get(obj-&gt;parent-&gt;headers, HEADER_CONTENT_TYPE,</span>
<a href="#l56.2482"></a><span id="l56.2482" class="difflineplus">+                                      false, false);</span>
<a href="#l56.2483"></a><span id="l56.2483" class="difflineplus">+          if (ctp) {</span>
<a href="#l56.2484"></a><span id="l56.2484" class="difflineplus">+            x_mac_type = MimeHeaders_get_parameter(ctp, PARAM_X_MAC_TYPE,</span>
<a href="#l56.2485"></a><span id="l56.2485" class="difflineplus">+                                                   nullptr, nullptr);</span>
<a href="#l56.2486"></a><span id="l56.2486" class="difflineplus">+            x_mac_creator = MimeHeaders_get_parameter(ctp, PARAM_X_MAC_CREATOR,</span>
<a href="#l56.2487"></a><span id="l56.2487" class="difflineplus">+                                                      nullptr, nullptr);</span>
<a href="#l56.2488"></a><span id="l56.2488">             PR_Free(ctp);</span>
<a href="#l56.2489"></a><span id="l56.2489">           }</span>
<a href="#l56.2490"></a><span id="l56.2490">         }</span>
<a href="#l56.2491"></a><span id="l56.2491"> </span>
<a href="#l56.2492"></a><span id="l56.2492">         if (!(obj-&gt;options-&gt;override_charset)) {</span>
<a href="#l56.2493"></a><span id="l56.2493" class="difflineminus">-          char *charset = MimeHeaders_get_parameter(ct, &quot;charset&quot;, nullptr, nullptr);</span>
<a href="#l56.2494"></a><span id="l56.2494" class="difflineminus">-          if (charset)</span>
<a href="#l56.2495"></a><span id="l56.2495" class="difflineminus">-          {</span>
<a href="#l56.2496"></a><span id="l56.2496" class="difflineplus">+          char *charset =</span>
<a href="#l56.2497"></a><span id="l56.2497" class="difflineplus">+              MimeHeaders_get_parameter(ct, &quot;charset&quot;, nullptr, nullptr);</span>
<a href="#l56.2498"></a><span id="l56.2498" class="difflineplus">+          if (charset) {</span>
<a href="#l56.2499"></a><span id="l56.2499">             PR_FREEIF(obj-&gt;options-&gt;default_charset);</span>
<a href="#l56.2500"></a><span id="l56.2500">             obj-&gt;options-&gt;default_charset = charset;</span>
<a href="#l56.2501"></a><span id="l56.2501">           }</span>
<a href="#l56.2502"></a><span id="l56.2502">         }</span>
<a href="#l56.2503"></a><span id="l56.2503">         PR_Free(ct);</span>
<a href="#l56.2504"></a><span id="l56.2504">       }</span>
<a href="#l56.2505"></a><span id="l56.2505">     }</span>
<a href="#l56.2506"></a><span id="l56.2506"> </span>
<a href="#l56.2507"></a><span id="l56.2507" class="difflineminus">-    if (mime_typep(obj, (MimeObjectClass *) &amp;mimeInlineTextClass))</span>
<a href="#l56.2508"></a><span id="l56.2508" class="difflineminus">-    charset = ((MimeInlineText *)obj)-&gt;charset;</span>
<a href="#l56.2509"></a><span id="l56.2509" class="difflineplus">+    if (mime_typep(obj, (MimeObjectClass *)&amp;mimeInlineTextClass))</span>
<a href="#l56.2510"></a><span id="l56.2510" class="difflineplus">+      charset = ((MimeInlineText *)obj)-&gt;charset;</span>
<a href="#l56.2511"></a><span id="l56.2511"> </span>
<a href="#l56.2512"></a><span id="l56.2512" class="difflineminus">-    if (!content_type)</span>
<a href="#l56.2513"></a><span id="l56.2513" class="difflineminus">-      content_type = obj-&gt;content_type;</span>
<a href="#l56.2514"></a><span id="l56.2514" class="difflineminus">-    if (!content_type)</span>
<a href="#l56.2515"></a><span id="l56.2515" class="difflineminus">-      content_type = TEXT_PLAIN;</span>
<a href="#l56.2516"></a><span id="l56.2516" class="difflineplus">+    if (!content_type) content_type = obj-&gt;content_type;</span>
<a href="#l56.2517"></a><span id="l56.2517" class="difflineplus">+    if (!content_type) content_type = TEXT_PLAIN;</span>
<a href="#l56.2518"></a><span id="l56.2518"> </span>
<a href="#l56.2519"></a><span id="l56.2519">     //</span>
<a href="#l56.2520"></a><span id="l56.2520">     // Set the charset on the channel we are dealing with so people know</span>
<a href="#l56.2521"></a><span id="l56.2521">     // what the charset is set to. Do this for quoting/Printing ONLY!</span>
<a href="#l56.2522"></a><span id="l56.2522">     //</span>
<a href="#l56.2523"></a><span id="l56.2523" class="difflineminus">-    extern void   ResetChannelCharset(MimeObject *obj);</span>
<a href="#l56.2524"></a><span id="l56.2524" class="difflineplus">+    extern void ResetChannelCharset(MimeObject * obj);</span>
<a href="#l56.2525"></a><span id="l56.2525">     if ((obj-&gt;options) &amp;&amp;</span>
<a href="#l56.2526"></a><span id="l56.2526" class="difflineminus">-         (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l56.2527"></a><span id="l56.2527" class="difflineminus">-          obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting ||</span>
<a href="#l56.2528"></a><span id="l56.2528" class="difflineminus">-          obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs ||</span>
<a href="#l56.2529"></a><span id="l56.2529" class="difflineminus">-          obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessagePrintOutput))</span>
<a href="#l56.2530"></a><span id="l56.2530" class="difflineplus">+        (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l56.2531"></a><span id="l56.2531" class="difflineplus">+         obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting ||</span>
<a href="#l56.2532"></a><span id="l56.2532" class="difflineplus">+         obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs ||</span>
<a href="#l56.2533"></a><span id="l56.2533" class="difflineplus">+         obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessagePrintOutput))</span>
<a href="#l56.2534"></a><span id="l56.2534">       ResetChannelCharset(obj);</span>
<a href="#l56.2535"></a><span id="l56.2535"> </span>
<a href="#l56.2536"></a><span id="l56.2536">     status = obj-&gt;options-&gt;output_init_fn(content_type, charset, name,</span>
<a href="#l56.2537"></a><span id="l56.2537">                                           x_mac_type, x_mac_creator,</span>
<a href="#l56.2538"></a><span id="l56.2538">                                           obj-&gt;options-&gt;stream_closure);</span>
<a href="#l56.2539"></a><span id="l56.2539">     PR_FREEIF(name);</span>
<a href="#l56.2540"></a><span id="l56.2540">     PR_FREEIF(x_mac_type);</span>
<a href="#l56.2541"></a><span id="l56.2541">     PR_FREEIF(x_mac_creator);</span>
<a href="#l56.2542"></a><span id="l56.2542">     obj-&gt;options-&gt;state-&gt;first_data_written_p = true;</span>
<a href="#l56.2543"></a><span id="l56.2543">     return status;</span>
<a href="#l56.2544"></a><span id="l56.2544">   }</span>
<a href="#l56.2545"></a><span id="l56.2545">   return 0;</span>
<a href="#l56.2546"></a><span id="l56.2546"> }</span>
<a href="#l56.2547"></a><span id="l56.2547"> </span>
<a href="#l56.2548"></a><span id="l56.2548" class="difflineminus">-char *</span>
<a href="#l56.2549"></a><span id="l56.2549" class="difflineminus">-mime_get_base_url(const char *url)</span>
<a href="#l56.2550"></a><span id="l56.2550" class="difflineminus">-{</span>
<a href="#l56.2551"></a><span id="l56.2551" class="difflineminus">-  if (!url)</span>
<a href="#l56.2552"></a><span id="l56.2552" class="difflineminus">-    return nullptr;</span>
<a href="#l56.2553"></a><span id="l56.2553" class="difflineplus">+char *mime_get_base_url(const char *url) {</span>
<a href="#l56.2554"></a><span id="l56.2554" class="difflineplus">+  if (!url) return nullptr;</span>
<a href="#l56.2555"></a><span id="l56.2555"> </span>
<a href="#l56.2556"></a><span id="l56.2556">   const char *s = strrchr(url, '?');</span>
<a href="#l56.2557"></a><span id="l56.2557" class="difflineminus">-  if (s &amp;&amp; !strncmp(s, &quot;?type=application/x-message-display&quot;, sizeof(&quot;?type=application/x-message-display&quot;) - 1))</span>
<a href="#l56.2558"></a><span id="l56.2558" class="difflineminus">-  {</span>
<a href="#l56.2559"></a><span id="l56.2559" class="difflineplus">+  if (s &amp;&amp; !strncmp(s, &quot;?type=application/x-message-display&quot;,</span>
<a href="#l56.2560"></a><span id="l56.2560" class="difflineplus">+                    sizeof(&quot;?type=application/x-message-display&quot;) - 1)) {</span>
<a href="#l56.2561"></a><span id="l56.2561">     const char *nextTerm = strchr(s, '&amp;');</span>
<a href="#l56.2562"></a><span id="l56.2562">     s = nextTerm ? nextTerm : s + strlen(s) - 1;</span>
<a href="#l56.2563"></a><span id="l56.2563">   }</span>
<a href="#l56.2564"></a><span id="l56.2564">   // we need to keep the ?number part of the url, or we won't know</span>
<a href="#l56.2565"></a><span id="l56.2565">   // which local message the part belongs to.</span>
<a href="#l56.2566"></a><span id="l56.2566" class="difflineminus">-  if (s &amp;&amp; *s &amp;&amp; *(s+1) &amp;&amp; !strncmp(s + 1, &quot;number=&quot;, sizeof(&quot;number=&quot;) - 1))</span>
<a href="#l56.2567"></a><span id="l56.2567" class="difflineminus">-  {</span>
<a href="#l56.2568"></a><span id="l56.2568" class="difflineplus">+  if (s &amp;&amp; *s &amp;&amp; *(s + 1) &amp;&amp;</span>
<a href="#l56.2569"></a><span id="l56.2569" class="difflineplus">+      !strncmp(s + 1, &quot;number=&quot;, sizeof(&quot;number=&quot;) - 1)) {</span>
<a href="#l56.2570"></a><span id="l56.2570">     const char *nextTerm = strchr(++s, '&amp;');</span>
<a href="#l56.2571"></a><span id="l56.2571">     s = nextTerm ? nextTerm : s + strlen(s) - 1;</span>
<a href="#l56.2572"></a><span id="l56.2572">   }</span>
<a href="#l56.2573"></a><span id="l56.2573">   char *result = (char *)PR_MALLOC(strlen(url) + 1);</span>
<a href="#l56.2574"></a><span id="l56.2574">   NS_ASSERTION(result, &quot;out of memory&quot;);</span>
<a href="#l56.2575"></a><span id="l56.2575" class="difflineminus">-  if (!result)</span>
<a href="#l56.2576"></a><span id="l56.2576" class="difflineminus">-    return nullptr;</span>
<a href="#l56.2577"></a><span id="l56.2577" class="difflineplus">+  if (!result) return nullptr;</span>
<a href="#l56.2578"></a><span id="l56.2578"> </span>
<a href="#l56.2579"></a><span id="l56.2579">   memcpy(result, url, s - url);</span>
<a href="#l56.2580"></a><span id="l56.2580">   result[s - url] = 0;</span>
<a href="#l56.2581"></a><span id="l56.2581">   return result;</span>
<a href="#l56.2582"></a><span id="l56.2582"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/mime/src/mimei.h</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/mime/src/mimei.h</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -196,72 +196,66 @@</span>
<a href="#l57.4"></a><span id="l57.4">   If you write a libmime content type handler, libmime might create several</span>
<a href="#l57.5"></a><span id="l57.5">   instances of your class at once and call e.g. the same finalize code for</span>
<a href="#l57.6"></a><span id="l57.6">   3 different objects in a row.</span>
<a href="#l57.7"></a><span id="l57.7">  */</span>
<a href="#l57.8"></a><span id="l57.8"> </span>
<a href="#l57.9"></a><span id="l57.9"> #include &quot;mimehdrs.h&quot;</span>
<a href="#l57.10"></a><span id="l57.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-typedef struct MimeObject      MimeObject;</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+typedef struct MimeObject MimeObject;</span>
<a href="#l57.14"></a><span id="l57.14"> typedef struct MimeObjectClass MimeObjectClass;</span>
<a href="#l57.15"></a><span id="l57.15"> </span>
<a href="#l57.16"></a><span id="l57.16"> /* (I don't pretend to understand this.) */</span>
<a href="#l57.17"></a><span id="l57.17" class="difflineminus">-#define cpp_stringify_noop_helper(x)#x</span>
<a href="#l57.18"></a><span id="l57.18" class="difflineplus">+#define cpp_stringify_noop_helper(x) #x</span>
<a href="#l57.19"></a><span id="l57.19"> #define cpp_stringify(x) cpp_stringify_noop_helper(x)</span>
<a href="#l57.20"></a><span id="l57.20"> </span>
<a href="#l57.21"></a><span id="l57.21" class="difflineminus">-#define MimeObjectClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineminus">-  cpp_stringify(ITYPE), \</span>
<a href="#l57.23"></a><span id="l57.23" class="difflineminus">-  sizeof(ITYPE), \</span>
<a href="#l57.24"></a><span id="l57.24" class="difflineminus">-  (MimeObjectClass *) CSUPER, \</span>
<a href="#l57.25"></a><span id="l57.25" class="difflineminus">-  (int (*) (MimeObjectClass *)) ITYPE##ClassInitialize, \</span>
<a href="#l57.26"></a><span id="l57.26" class="difflineminus">-  0</span>
<a href="#l57.27"></a><span id="l57.27" class="difflineplus">+#define MimeObjectClassInitializer(ITYPE, CSUPER)                 \</span>
<a href="#l57.28"></a><span id="l57.28" class="difflineplus">+  cpp_stringify(ITYPE), sizeof(ITYPE), (MimeObjectClass *)CSUPER, \</span>
<a href="#l57.29"></a><span id="l57.29" class="difflineplus">+      (int (*)(MimeObjectClass *))ITYPE##ClassInitialize, 0</span>
<a href="#l57.30"></a><span id="l57.30"> </span>
<a href="#l57.31"></a><span id="l57.31"> /* Macro used for setting up class definitions.</span>
<a href="#l57.32"></a><span id="l57.32">  */</span>
<a href="#l57.33"></a><span id="l57.33" class="difflineminus">-#define MimeDefClass(ITYPE,CTYPE,CVAR,CSUPER) \</span>
<a href="#l57.34"></a><span id="l57.34" class="difflineminus">- static int ITYPE##ClassInitialize(ITYPE##Class *); \</span>
<a href="#l57.35"></a><span id="l57.35" class="difflineminus">- ITYPE##Class CVAR = { ITYPE##ClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l57.36"></a><span id="l57.36" class="difflineminus">-</span>
<a href="#l57.37"></a><span id="l57.37" class="difflineplus">+#define MimeDefClass(ITYPE, CTYPE, CVAR, CSUPER)     \</span>
<a href="#l57.38"></a><span id="l57.38" class="difflineplus">+  static int ITYPE##ClassInitialize(ITYPE##Class *); \</span>
<a href="#l57.39"></a><span id="l57.39" class="difflineplus">+  ITYPE##Class CVAR = {ITYPE##ClassInitializer(ITYPE, CSUPER)}</span>
<a href="#l57.40"></a><span id="l57.40"> </span>
<a href="#l57.41"></a><span id="l57.41"> /* Creates a new (subclass of) MimeObject of the given class, with the</span>
<a href="#l57.42"></a><span id="l57.42">    given headers (which are copied.)</span>
<a href="#l57.43"></a><span id="l57.43">  */</span>
<a href="#l57.44"></a><span id="l57.44" class="difflineminus">-extern MimeObject *mime_new (MimeObjectClass *clazz, MimeHeaders *hdrs,</span>
<a href="#l57.45"></a><span id="l57.45" class="difflineminus">-               const char *override_content_type);</span>
<a href="#l57.46"></a><span id="l57.46" class="difflineminus">-</span>
<a href="#l57.47"></a><span id="l57.47" class="difflineplus">+extern MimeObject *mime_new(MimeObjectClass *clazz, MimeHeaders *hdrs,</span>
<a href="#l57.48"></a><span id="l57.48" class="difflineplus">+                            const char *override_content_type);</span>
<a href="#l57.49"></a><span id="l57.49"> </span>
<a href="#l57.50"></a><span id="l57.50"> /* Destroys a MimeObject (or subclass) and all data associated with it.</span>
<a href="#l57.51"></a><span id="l57.51">  */</span>
<a href="#l57.52"></a><span id="l57.52" class="difflineminus">-extern &quot;C&quot; void mime_free (MimeObject *object);</span>
<a href="#l57.53"></a><span id="l57.53" class="difflineplus">+extern &quot;C&quot; void mime_free(MimeObject *object);</span>
<a href="#l57.54"></a><span id="l57.54"> </span>
<a href="#l57.55"></a><span id="l57.55"> /* Given a content-type string, finds and returns an appropriate subclass</span>
<a href="#l57.56"></a><span id="l57.56">    of MimeObject.  A class object is returned.  If `exact_match_p' is true,</span>
<a href="#l57.57"></a><span id="l57.57">    then only fully-known types will be returned; that is, if it is true,</span>
<a href="#l57.58"></a><span id="l57.58">    then &quot;text/x-unknown&quot; will return MimeInlineTextPlainType, but if it is</span>
<a href="#l57.59"></a><span id="l57.59">    false, it will return NULL.</span>
<a href="#l57.60"></a><span id="l57.60">  */</span>
<a href="#l57.61"></a><span id="l57.61" class="difflineminus">-extern MimeObjectClass *mime_find_class (const char *content_type,</span>
<a href="#l57.62"></a><span id="l57.62" class="difflineminus">-                     MimeHeaders *hdrs,</span>
<a href="#l57.63"></a><span id="l57.63" class="difflineminus">-                     MimeDisplayOptions *opts,</span>
<a href="#l57.64"></a><span id="l57.64" class="difflineminus">-                     bool exact_match_p);</span>
<a href="#l57.65"></a><span id="l57.65" class="difflineplus">+extern MimeObjectClass *mime_find_class(const char *content_type,</span>
<a href="#l57.66"></a><span id="l57.66" class="difflineplus">+                                        MimeHeaders *hdrs,</span>
<a href="#l57.67"></a><span id="l57.67" class="difflineplus">+                                        MimeDisplayOptions *opts,</span>
<a href="#l57.68"></a><span id="l57.68" class="difflineplus">+                                        bool exact_match_p);</span>
<a href="#l57.69"></a><span id="l57.69"> </span>
<a href="#l57.70"></a><span id="l57.70"> /** Given a content-type string, creates and returns an appropriate subclass</span>
<a href="#l57.71"></a><span id="l57.71">  * of MimeObject.  The headers (from which the content-type was presumably</span>
<a href="#l57.72"></a><span id="l57.72">  * extracted) are copied. forceInline is set to true when the caller wants</span>
<a href="#l57.73"></a><span id="l57.73">  * the function to ignore opts-&gt;show_attachment_inline_p and force inline</span>
<a href="#l57.74"></a><span id="l57.74">  * display, e.g., mimemalt wants the body part to be shown inline.</span>
<a href="#l57.75"></a><span id="l57.75">  */</span>
<a href="#l57.76"></a><span id="l57.76" class="difflineminus">-extern MimeObject *mime_create (const char *content_type, MimeHeaders *hdrs,</span>
<a href="#l57.77"></a><span id="l57.77" class="difflineminus">-                MimeDisplayOptions *opts, bool forceInline = false);</span>
<a href="#l57.78"></a><span id="l57.78" class="difflineminus">-</span>
<a href="#l57.79"></a><span id="l57.79" class="difflineplus">+extern MimeObject *mime_create(const char *content_type, MimeHeaders *hdrs,</span>
<a href="#l57.80"></a><span id="l57.80" class="difflineplus">+                               MimeDisplayOptions *opts,</span>
<a href="#l57.81"></a><span id="l57.81" class="difflineplus">+                               bool forceInline = false);</span>
<a href="#l57.82"></a><span id="l57.82"> </span>
<a href="#l57.83"></a><span id="l57.83"> /* Querying the type hierarchy */</span>
<a href="#l57.84"></a><span id="l57.84" class="difflineminus">-extern bool mime_subclass_p(MimeObjectClass *child,</span>
<a href="#l57.85"></a><span id="l57.85" class="difflineminus">-                 MimeObjectClass *parent);</span>
<a href="#l57.86"></a><span id="l57.86" class="difflineplus">+extern bool mime_subclass_p(MimeObjectClass *child, MimeObjectClass *parent);</span>
<a href="#l57.87"></a><span id="l57.87"> extern bool mime_typep(MimeObject *obj, MimeObjectClass *clazz);</span>
<a href="#l57.88"></a><span id="l57.88"> </span>
<a href="#l57.89"></a><span id="l57.89"> /* Returns a string describing the location of the part (like &quot;2.5.3&quot;).</span>
<a href="#l57.90"></a><span id="l57.90">    This is not a full URL, just a part-number.</span>
<a href="#l57.91"></a><span id="l57.91">  */</span>
<a href="#l57.92"></a><span id="l57.92"> extern char *mime_part_address(MimeObject *obj);</span>
<a href="#l57.93"></a><span id="l57.93"> </span>
<a href="#l57.94"></a><span id="l57.94"> /* Returns a string describing the location of the *IMAP* part (like &quot;2.5.3&quot;).</span>
<a href="#l57.95"></a><span id="l57.95" class="difflineat">@@ -272,41 +266,41 @@ extern char *mime_part_address(MimeObjec</span>
<a href="#l57.96"></a><span id="l57.96"> extern char *mime_imap_part_address(MimeObject *obj);</span>
<a href="#l57.97"></a><span id="l57.97"> </span>
<a href="#l57.98"></a><span id="l57.98"> extern char *mime_external_attachment_url(MimeObject *obj);</span>
<a href="#l57.99"></a><span id="l57.99"> </span>
<a href="#l57.100"></a><span id="l57.100"> /* Puts a part-number into a URL.  If append_p is true, then the part number</span>
<a href="#l57.101"></a><span id="l57.101">    is appended to any existing part-number already in that URL; otherwise,</span>
<a href="#l57.102"></a><span id="l57.102">    it replaces it.</span>
<a href="#l57.103"></a><span id="l57.103">  */</span>
<a href="#l57.104"></a><span id="l57.104" class="difflineminus">-extern char *mime_set_url_part(const char *url, const char *part, bool append_p);</span>
<a href="#l57.105"></a><span id="l57.105" class="difflineplus">+extern char *mime_set_url_part(const char *url, const char *part,</span>
<a href="#l57.106"></a><span id="l57.106" class="difflineplus">+                               bool append_p);</span>
<a href="#l57.107"></a><span id="l57.107"> </span>
<a href="#l57.108"></a><span id="l57.108"> /*</span>
<a href="#l57.109"></a><span id="l57.109">   cut the part of url for display a attachment as a email.</span>
<a href="#l57.110"></a><span id="l57.110"> */</span>
<a href="#l57.111"></a><span id="l57.111"> extern char *mime_get_base_url(const char *url);</span>
<a href="#l57.112"></a><span id="l57.112"> </span>
<a href="#l57.113"></a><span id="l57.113"> /* Puts an *IMAP* part-number into a URL.</span>
<a href="#l57.114"></a><span id="l57.114">  */</span>
<a href="#l57.115"></a><span id="l57.115" class="difflineminus">-extern char *mime_set_url_imap_part(const char *url, const char *part, const char *libmimepart);</span>
<a href="#l57.116"></a><span id="l57.116" class="difflineminus">-</span>
<a href="#l57.117"></a><span id="l57.117" class="difflineplus">+extern char *mime_set_url_imap_part(const char *url, const char *part,</span>
<a href="#l57.118"></a><span id="l57.118" class="difflineplus">+                                    const char *libmimepart);</span>
<a href="#l57.119"></a><span id="l57.119"> </span>
<a href="#l57.120"></a><span id="l57.120"> /* Given a part ID, looks through the MimeObject tree for a sub-part whose ID</span>
<a href="#l57.121"></a><span id="l57.121">    number matches, and returns the MimeObject (else NULL.)</span>
<a href="#l57.122"></a><span id="l57.122">    (part is not a URL -- it's of the form &quot;1.3.5&quot;.)</span>
<a href="#l57.123"></a><span id="l57.123">  */</span>
<a href="#l57.124"></a><span id="l57.124"> extern MimeObject *mime_address_to_part(const char *part, MimeObject *obj);</span>
<a href="#l57.125"></a><span id="l57.125"> </span>
<a href="#l57.126"></a><span id="l57.126" class="difflineminus">-</span>
<a href="#l57.127"></a><span id="l57.127"> /* Given a part ID, looks through the MimeObject tree for a sub-part whose ID</span>
<a href="#l57.128"></a><span id="l57.128">    number matches; if one is found, returns the Content-Name of that part.</span>
<a href="#l57.129"></a><span id="l57.129">    Else returns NULL.  (part is not a URL -- it's of the form &quot;1.3.5&quot;.)</span>
<a href="#l57.130"></a><span id="l57.130">  */</span>
<a href="#l57.131"></a><span id="l57.131"> extern char *mime_find_suggested_name_of_part(const char *part,</span>
<a href="#l57.132"></a><span id="l57.132" class="difflineminus">-                        MimeObject *obj);</span>
<a href="#l57.133"></a><span id="l57.133" class="difflineplus">+                                              MimeObject *obj);</span>
<a href="#l57.134"></a><span id="l57.134"> </span>
<a href="#l57.135"></a><span id="l57.135"> /* Given a part ID, looks through the MimeObject tree for a sub-part whose ID</span>
<a href="#l57.136"></a><span id="l57.136">    number matches; if one is found, returns the Content-Name of that part.</span>
<a href="#l57.137"></a><span id="l57.137">    Else returns NULL.  (part is not a URL -- it's of the form &quot;1.3.5&quot;.)</span>
<a href="#l57.138"></a><span id="l57.138">  */</span>
<a href="#l57.139"></a><span id="l57.139"> extern char *mime_find_content_type_of_part(const char *part, MimeObject *obj);</span>
<a href="#l57.140"></a><span id="l57.140"> </span>
<a href="#l57.141"></a><span id="l57.141"> /* Parse the various &quot;?&quot; options off the URL and into the options struct.</span>
<a href="#l57.142"></a><span id="l57.142" class="difflineat">@@ -314,105 +308,110 @@ extern char *mime_find_content_type_of_p</span>
<a href="#l57.143"></a><span id="l57.143"> extern int mime_parse_url_options(const char *url, MimeDisplayOptions *);</span>
<a href="#l57.144"></a><span id="l57.144"> </span>
<a href="#l57.145"></a><span id="l57.145"> #ifdef ENABLE_SMIME</span>
<a href="#l57.146"></a><span id="l57.146"> </span>
<a href="#l57.147"></a><span id="l57.147"> /* Asks whether the given object is one of the cryptographically signed</span>
<a href="#l57.148"></a><span id="l57.148">    or encrypted objects that we know about.  (MimeMessageClass uses this</span>
<a href="#l57.149"></a><span id="l57.149">    to decide if the headers need to be presented differently.)</span>
<a href="#l57.150"></a><span id="l57.150">  */</span>
<a href="#l57.151"></a><span id="l57.151" class="difflineminus">-extern bool mime_crypto_object_p(MimeHeaders *, bool clearsigned_counts, MimeDisplayOptions *);</span>
<a href="#l57.152"></a><span id="l57.152" class="difflineplus">+extern bool mime_crypto_object_p(MimeHeaders *, bool clearsigned_counts,</span>
<a href="#l57.153"></a><span id="l57.153" class="difflineplus">+                                 MimeDisplayOptions *);</span>
<a href="#l57.154"></a><span id="l57.154"> </span>
<a href="#l57.155"></a><span id="l57.155"> /* Tells whether the given MimeObject is a message which has been encrypted</span>
<a href="#l57.156"></a><span id="l57.156">    or signed.  (Helper for MIME_GetMessageCryptoState()).</span>
<a href="#l57.157"></a><span id="l57.157">  */</span>
<a href="#l57.158"></a><span id="l57.158" class="difflineminus">-extern void mime_get_crypto_state (MimeObject *obj,</span>
<a href="#l57.159"></a><span id="l57.159" class="difflineminus">-                   bool *signed_p, bool *encrypted_p,</span>
<a href="#l57.160"></a><span id="l57.160" class="difflineminus">-                   bool *signed_ok, bool *encrypted_ok);</span>
<a href="#l57.161"></a><span id="l57.161" class="difflineminus">-</span>
<a href="#l57.162"></a><span id="l57.162" class="difflineplus">+extern void mime_get_crypto_state(MimeObject *obj, bool *signed_p,</span>
<a href="#l57.163"></a><span id="l57.163" class="difflineplus">+                                  bool *encrypted_p, bool *signed_ok,</span>
<a href="#l57.164"></a><span id="l57.164" class="difflineplus">+                                  bool *encrypted_ok);</span>
<a href="#l57.165"></a><span id="l57.165"> </span>
<a href="#l57.166"></a><span id="l57.166"> /* Whether the given object has written out the HTML version of its headers</span>
<a href="#l57.167"></a><span id="l57.167">    in such a way that it will have a &quot;crypto stamp&quot; next to the headers.  If</span>
<a href="#l57.168"></a><span id="l57.168">    this is true, then the child must write out its HTML slightly differently</span>
<a href="#l57.169"></a><span id="l57.169">    to take this into account...</span>
<a href="#l57.170"></a><span id="l57.170">  */</span>
<a href="#l57.171"></a><span id="l57.171"> extern bool mime_crypto_stamped_p(MimeObject *obj);</span>
<a href="#l57.172"></a><span id="l57.172"> </span>
<a href="#l57.173"></a><span id="l57.173"> /* How the crypto code tells the MimeMessage object what the crypto stamp</span>
<a href="#l57.174"></a><span id="l57.174">    on it says. */</span>
<a href="#l57.175"></a><span id="l57.175" class="difflineminus">-extern void mime_set_crypto_stamp(MimeObject *obj,</span>
<a href="#l57.176"></a><span id="l57.176" class="difflineminus">-                  bool signed_p, bool encrypted_p);</span>
<a href="#l57.177"></a><span id="l57.177" class="difflineminus">-#endif // ENABLE_SMIME</span>
<a href="#l57.178"></a><span id="l57.178" class="difflineplus">+extern void mime_set_crypto_stamp(MimeObject *obj, bool signed_p,</span>
<a href="#l57.179"></a><span id="l57.179" class="difflineplus">+                                  bool encrypted_p);</span>
<a href="#l57.180"></a><span id="l57.180" class="difflineplus">+#endif  // ENABLE_SMIME</span>
<a href="#l57.181"></a><span id="l57.181"> </span>
<a href="#l57.182"></a><span id="l57.182"> class MimeParseStateObject {</span>
<a href="#l57.183"></a><span id="l57.183" class="difflineminus">-public:</span>
<a href="#l57.184"></a><span id="l57.184" class="difflineplus">+ public:</span>
<a href="#l57.185"></a><span id="l57.185" class="difflineplus">+  MimeParseStateObject() {</span>
<a href="#l57.186"></a><span id="l57.186" class="difflineplus">+    root = 0;</span>
<a href="#l57.187"></a><span id="l57.187" class="difflineplus">+    separator_queued_p = false;</span>
<a href="#l57.188"></a><span id="l57.188" class="difflineplus">+    separator_suppressed_p = false;</span>
<a href="#l57.189"></a><span id="l57.189" class="difflineplus">+    first_part_written_p = false;</span>
<a href="#l57.190"></a><span id="l57.190" class="difflineplus">+    post_header_html_run_p = false;</span>
<a href="#l57.191"></a><span id="l57.191" class="difflineplus">+    first_data_written_p = false;</span>
<a href="#l57.192"></a><span id="l57.192" class="difflineplus">+    decrypted_p = false;</span>
<a href="#l57.193"></a><span id="l57.193" class="difflineplus">+    strippingPart = false;</span>
<a href="#l57.194"></a><span id="l57.194" class="difflineplus">+  }</span>
<a href="#l57.195"></a><span id="l57.195" class="difflineplus">+  MimeObject *root; /* The outermost parser object. */</span>
<a href="#l57.196"></a><span id="l57.196"> </span>
<a href="#l57.197"></a><span id="l57.197" class="difflineminus">-  MimeParseStateObject()</span>
<a href="#l57.198"></a><span id="l57.198" class="difflineminus">-      {root = 0; separator_queued_p = false; separator_suppressed_p = false;</span>
<a href="#l57.199"></a><span id="l57.199" class="difflineminus">-        first_part_written_p = false; post_header_html_run_p = false; first_data_written_p = false;</span>
<a href="#l57.200"></a><span id="l57.200" class="difflineminus">-        decrypted_p = false; strippingPart = false;</span>
<a href="#l57.201"></a><span id="l57.201" class="difflineminus">-      }</span>
<a href="#l57.202"></a><span id="l57.202" class="difflineminus">-  MimeObject *root;        /* The outermost parser object. */</span>
<a href="#l57.203"></a><span id="l57.203" class="difflineminus">-</span>
<a href="#l57.204"></a><span id="l57.204" class="difflineminus">-  bool separator_queued_p;  /* Whether a separator should be written out</span>
<a href="#l57.205"></a><span id="l57.205" class="difflineminus">-                   before the next text is written (this lets</span>
<a href="#l57.206"></a><span id="l57.206" class="difflineminus">-                   us write separators lazily, so that one</span>
<a href="#l57.207"></a><span id="l57.207" class="difflineminus">-                   doesn't appear at the end, and so that more</span>
<a href="#l57.208"></a><span id="l57.208" class="difflineminus">-                   than one don't appear in a row.) */</span>
<a href="#l57.209"></a><span id="l57.209" class="difflineplus">+  bool separator_queued_p; /* Whether a separator should be written out</span>
<a href="#l57.210"></a><span id="l57.210" class="difflineplus">+                  before the next text is written (this lets</span>
<a href="#l57.211"></a><span id="l57.211" class="difflineplus">+                  us write separators lazily, so that one</span>
<a href="#l57.212"></a><span id="l57.212" class="difflineplus">+                  doesn't appear at the end, and so that more</span>
<a href="#l57.213"></a><span id="l57.213" class="difflineplus">+                  than one don't appear in a row.) */</span>
<a href="#l57.214"></a><span id="l57.214"> </span>
<a href="#l57.215"></a><span id="l57.215">   bool separator_suppressed_p; /* Whether the currently-queued separator</span>
<a href="#l57.216"></a><span id="l57.216">                    should not be printed; this is a kludge to</span>
<a href="#l57.217"></a><span id="l57.217">                    prevent seps from being printed just after</span>
<a href="#l57.218"></a><span id="l57.218">                    a header block... */</span>
<a href="#l57.219"></a><span id="l57.219"> </span>
<a href="#l57.220"></a><span id="l57.220" class="difflineminus">-  bool first_part_written_p;  /* State used for the `Show Attachments As</span>
<a href="#l57.221"></a><span id="l57.221" class="difflineminus">-                   Links' kludge. */</span>
<a href="#l57.222"></a><span id="l57.222" class="difflineplus">+  bool first_part_written_p; /* State used for the `Show Attachments As</span>
<a href="#l57.223"></a><span id="l57.223" class="difflineplus">+                  Links' kludge. */</span>
<a href="#l57.224"></a><span id="l57.224"> </span>
<a href="#l57.225"></a><span id="l57.225">   bool post_header_html_run_p; /* Whether we've run the</span>
<a href="#l57.226"></a><span id="l57.226">                    options-&gt;generate_post_header_html_fn */</span>
<a href="#l57.227"></a><span id="l57.227"> </span>
<a href="#l57.228"></a><span id="l57.228" class="difflineminus">-  bool first_data_written_p;  /* State used for Mozilla lazy-stream-</span>
<a href="#l57.229"></a><span id="l57.229" class="difflineminus">-                   creation evilness. */</span>
<a href="#l57.230"></a><span id="l57.230" class="difflineplus">+  bool first_data_written_p; /* State used for Mozilla lazy-stream-</span>
<a href="#l57.231"></a><span id="l57.231" class="difflineplus">+                  creation evilness. */</span>
<a href="#l57.232"></a><span id="l57.232"> </span>
<a href="#l57.233"></a><span id="l57.233">   bool decrypted_p; /* If options-&gt;dexlate_p is true, then this</span>
<a href="#l57.234"></a><span id="l57.234">                         will be set to indicate whether any</span>
<a href="#l57.235"></a><span id="l57.235">                         dexlateion did in fact occur.</span>
<a href="#l57.236"></a><span id="l57.236">                       */</span>
<a href="#l57.237"></a><span id="l57.237" class="difflineminus">-  nsTArray&lt;nsCString&gt; partsToStrip; /* if we're stripping parts, what parts to strip */</span>
<a href="#l57.238"></a><span id="l57.238" class="difflineminus">-  nsTArray&lt;nsCString&gt; detachToFiles; /* if we're detaching parts, where each part was detached to */</span>
<a href="#l57.239"></a><span id="l57.239" class="difflineplus">+  nsTArray&lt;nsCString&gt;</span>
<a href="#l57.240"></a><span id="l57.240" class="difflineplus">+      partsToStrip; /* if we're stripping parts, what parts to strip */</span>
<a href="#l57.241"></a><span id="l57.241" class="difflineplus">+  nsTArray&lt;nsCString&gt; detachToFiles; /* if we're detaching parts, where each</span>
<a href="#l57.242"></a><span id="l57.242" class="difflineplus">+                                        part was detached to */</span>
<a href="#l57.243"></a><span id="l57.243">   bool strippingPart;</span>
<a href="#l57.244"></a><span id="l57.244" class="difflineminus">-  nsCString detachedFilePath;       /* if we've detached this part, filepath of detached part */</span>
<a href="#l57.245"></a><span id="l57.245" class="difflineplus">+  nsCString detachedFilePath; /* if we've detached this part, filepath of</span>
<a href="#l57.246"></a><span id="l57.246" class="difflineplus">+                                 detached part */</span>
<a href="#l57.247"></a><span id="l57.247"> };</span>
<a href="#l57.248"></a><span id="l57.248"> </span>
<a href="#l57.249"></a><span id="l57.249" class="difflineminus">-</span>
<a href="#l57.250"></a><span id="l57.250"> /* Some output-generation utility functions...</span>
<a href="#l57.251"></a><span id="l57.251">  */</span>
<a href="#l57.252"></a><span id="l57.252"> extern int MimeObject_output_init(MimeObject *obj, const char *content_type);</span>
<a href="#l57.253"></a><span id="l57.253"> </span>
<a href="#l57.254"></a><span id="l57.254"> /* The `user_visible_p' argument says whether the output that has just been</span>
<a href="#l57.255"></a><span id="l57.255">    written will cause characters or images to show up on the screen, that</span>
<a href="#l57.256"></a><span id="l57.256">    is, it should be false if the stuff being written is merely structural</span>
<a href="#l57.257"></a><span id="l57.257">    HTML or whitespace (&quot;&lt;P&gt;&quot;, &quot;&lt;/TABLE&gt;&quot;, etc.)  This information is used</span>
<a href="#l57.258"></a><span id="l57.258">    when making the decision of whether a separating &lt;HR&gt; is needed.</span>
<a href="#l57.259"></a><span id="l57.259">  */</span>
<a href="#l57.260"></a><span id="l57.260"> extern int MimeObject_write(MimeObject *, const char *data, int32_t length,</span>
<a href="#l57.261"></a><span id="l57.261">                             bool user_visible_p);</span>
<a href="#l57.262"></a><span id="l57.262" class="difflineminus">-extern int MimeOptions_write(MimeHeaders *,</span>
<a href="#l57.263"></a><span id="l57.263" class="difflineminus">-                             MimeDisplayOptions *,</span>
<a href="#l57.264"></a><span id="l57.264" class="difflineplus">+extern int MimeOptions_write(MimeHeaders *, MimeDisplayOptions *,</span>
<a href="#l57.265"></a><span id="l57.265">                              const char *data, int32_t length,</span>
<a href="#l57.266"></a><span id="l57.266">                              bool user_visible_p);</span>
<a href="#l57.267"></a><span id="l57.267"> </span>
<a href="#l57.268"></a><span id="l57.268"> /* Writes out the right kind of HR (or rather, queues it for writing.) */</span>
<a href="#l57.269"></a><span id="l57.269"> extern int MimeObject_write_separator(MimeObject *);</span>
<a href="#l57.270"></a><span id="l57.270"> </span>
<a href="#l57.271"></a><span id="l57.271"> extern bool MimeObjectIsMessageBody(MimeObject *obj);</span>
<a href="#l57.272"></a><span id="l57.272"> </span>
<a href="#l57.273"></a><span id="l57.273" class="difflineminus">-struct MimeDisplayData {            /* This struct is what we hang off of</span>
<a href="#l57.274"></a><span id="l57.274" class="difflineminus">-                                       (context)-&gt;mime_data, to remember info</span>
<a href="#l57.275"></a><span id="l57.275" class="difflineminus">-                                       about the last MIME object we've</span>
<a href="#l57.276"></a><span id="l57.276" class="difflineminus">-                                       parsed and displayed.  See</span>
<a href="#l57.277"></a><span id="l57.277" class="difflineminus">-                                       MimeGuessURLContentName() below.</span>
<a href="#l57.278"></a><span id="l57.278" class="difflineminus">-                                     */</span>
<a href="#l57.279"></a><span id="l57.279" class="difflineplus">+struct MimeDisplayData { /* This struct is what we hang off of</span>
<a href="#l57.280"></a><span id="l57.280" class="difflineplus">+                            (context)-&gt;mime_data, to remember info</span>
<a href="#l57.281"></a><span id="l57.281" class="difflineplus">+                            about the last MIME object we've</span>
<a href="#l57.282"></a><span id="l57.282" class="difflineplus">+                            parsed and displayed.  See</span>
<a href="#l57.283"></a><span id="l57.283" class="difflineplus">+                            MimeGuessURLContentName() below.</span>
<a href="#l57.284"></a><span id="l57.284" class="difflineplus">+                          */</span>
<a href="#l57.285"></a><span id="l57.285">   MimeObject *last_parsed_object;</span>
<a href="#l57.286"></a><span id="l57.286">   char *last_parsed_url;</span>
<a href="#l57.287"></a><span id="l57.287"> };</span>
<a href="#l57.288"></a><span id="l57.288"> </span>
<a href="#l57.289"></a><span id="l57.289"> #endif /* _MIMEI_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/mime/src/mimeiimg.cpp</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/mime/src/mimeiimg.cpp</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -9,241 +9,212 @@</span>
<a href="#l58.4"></a><span id="l58.4"> #include &quot;plstr.h&quot;</span>
<a href="#l58.5"></a><span id="l58.5"> #include &quot;prlog.h&quot;</span>
<a href="#l58.6"></a><span id="l58.6"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l58.7"></a><span id="l58.7"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l58.8"></a><span id="l58.8"> #include &quot;nsINetUtil.h&quot;</span>
<a href="#l58.9"></a><span id="l58.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l58.10"></a><span id="l58.10"> </span>
<a href="#l58.11"></a><span id="l58.11"> #define MIME_SUPERCLASS mimeLeafClass</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-MimeDefClass(MimeInlineImage, MimeInlineImageClass,</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-       mimeInlineImageClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineplus">+MimeDefClass(MimeInlineImage, MimeInlineImageClass, mimeInlineImageClass,</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineplus">+             &amp;MIME_SUPERCLASS);</span>
<a href="#l58.16"></a><span id="l58.16"> </span>
<a href="#l58.17"></a><span id="l58.17" class="difflineminus">-static int MimeInlineImage_initialize (MimeObject *);</span>
<a href="#l58.18"></a><span id="l58.18" class="difflineminus">-static void MimeInlineImage_finalize (MimeObject *);</span>
<a href="#l58.19"></a><span id="l58.19" class="difflineminus">-static int MimeInlineImage_parse_begin (MimeObject *);</span>
<a href="#l58.20"></a><span id="l58.20" class="difflineminus">-static int MimeInlineImage_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l58.21"></a><span id="l58.21" class="difflineminus">-static int MimeInlineImage_parse_eof (MimeObject *, bool);</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineminus">-static int MimeInlineImage_parse_decoded_buffer (const char *, int32_t, MimeObject *);</span>
<a href="#l58.23"></a><span id="l58.23" class="difflineplus">+static int MimeInlineImage_initialize(MimeObject *);</span>
<a href="#l58.24"></a><span id="l58.24" class="difflineplus">+static void MimeInlineImage_finalize(MimeObject *);</span>
<a href="#l58.25"></a><span id="l58.25" class="difflineplus">+static int MimeInlineImage_parse_begin(MimeObject *);</span>
<a href="#l58.26"></a><span id="l58.26" class="difflineplus">+static int MimeInlineImage_parse_line(const char *, int32_t, MimeObject *);</span>
<a href="#l58.27"></a><span id="l58.27" class="difflineplus">+static int MimeInlineImage_parse_eof(MimeObject *, bool);</span>
<a href="#l58.28"></a><span id="l58.28" class="difflineplus">+static int MimeInlineImage_parse_decoded_buffer(const char *, int32_t,</span>
<a href="#l58.29"></a><span id="l58.29" class="difflineplus">+                                                MimeObject *);</span>
<a href="#l58.30"></a><span id="l58.30"> </span>
<a href="#l58.31"></a><span id="l58.31" class="difflineminus">-static int</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineminus">-MimeInlineImageClassInitialize(MimeInlineImageClass *clazz)</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineminus">-{</span>
<a href="#l58.34"></a><span id="l58.34" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l58.35"></a><span id="l58.35" class="difflineminus">-  MimeLeafClass   *lclass = (MimeLeafClass *) clazz;</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineplus">+static int MimeInlineImageClassInitialize(MimeInlineImageClass *clazz) {</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineplus">+  MimeLeafClass *lclass = (MimeLeafClass *)clazz;</span>
<a href="#l58.39"></a><span id="l58.39"> </span>
<a href="#l58.40"></a><span id="l58.40" class="difflineminus">-  NS_ASSERTION(!oclass-&gt;class_initialized, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l58.41"></a><span id="l58.41" class="difflineminus">-  oclass-&gt;initialize   = MimeInlineImage_initialize;</span>
<a href="#l58.42"></a><span id="l58.42" class="difflineminus">-  oclass-&gt;finalize     = MimeInlineImage_finalize;</span>
<a href="#l58.43"></a><span id="l58.43" class="difflineminus">-  oclass-&gt;parse_begin  = MimeInlineImage_parse_begin;</span>
<a href="#l58.44"></a><span id="l58.44" class="difflineminus">-  oclass-&gt;parse_line   = MimeInlineImage_parse_line;</span>
<a href="#l58.45"></a><span id="l58.45" class="difflineminus">-  oclass-&gt;parse_eof    = MimeInlineImage_parse_eof;</span>
<a href="#l58.46"></a><span id="l58.46" class="difflineplus">+  NS_ASSERTION(!oclass-&gt;class_initialized,</span>
<a href="#l58.47"></a><span id="l58.47" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l58.48"></a><span id="l58.48" class="difflineplus">+  oclass-&gt;initialize = MimeInlineImage_initialize;</span>
<a href="#l58.49"></a><span id="l58.49" class="difflineplus">+  oclass-&gt;finalize = MimeInlineImage_finalize;</span>
<a href="#l58.50"></a><span id="l58.50" class="difflineplus">+  oclass-&gt;parse_begin = MimeInlineImage_parse_begin;</span>
<a href="#l58.51"></a><span id="l58.51" class="difflineplus">+  oclass-&gt;parse_line = MimeInlineImage_parse_line;</span>
<a href="#l58.52"></a><span id="l58.52" class="difflineplus">+  oclass-&gt;parse_eof = MimeInlineImage_parse_eof;</span>
<a href="#l58.53"></a><span id="l58.53">   lclass-&gt;parse_decoded_buffer = MimeInlineImage_parse_decoded_buffer;</span>
<a href="#l58.54"></a><span id="l58.54"> </span>
<a href="#l58.55"></a><span id="l58.55">   return 0;</span>
<a href="#l58.56"></a><span id="l58.56"> }</span>
<a href="#l58.57"></a><span id="l58.57"> </span>
<a href="#l58.58"></a><span id="l58.58" class="difflineminus">-</span>
<a href="#l58.59"></a><span id="l58.59" class="difflineminus">-static int</span>
<a href="#l58.60"></a><span id="l58.60" class="difflineminus">-MimeInlineImage_initialize (MimeObject *object)</span>
<a href="#l58.61"></a><span id="l58.61" class="difflineminus">-{</span>
<a href="#l58.62"></a><span id="l58.62" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l58.63"></a><span id="l58.63" class="difflineplus">+static int MimeInlineImage_initialize(MimeObject *object) {</span>
<a href="#l58.64"></a><span id="l58.64" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l58.65"></a><span id="l58.65"> }</span>
<a href="#l58.66"></a><span id="l58.66"> </span>
<a href="#l58.67"></a><span id="l58.67" class="difflineminus">-static void</span>
<a href="#l58.68"></a><span id="l58.68" class="difflineminus">-MimeInlineImage_finalize (MimeObject *object)</span>
<a href="#l58.69"></a><span id="l58.69" class="difflineminus">-{</span>
<a href="#l58.70"></a><span id="l58.70" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineplus">+static void MimeInlineImage_finalize(MimeObject *object) {</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l58.73"></a><span id="l58.73"> }</span>
<a href="#l58.74"></a><span id="l58.74"> </span>
<a href="#l58.75"></a><span id="l58.75" class="difflineminus">-static int</span>
<a href="#l58.76"></a><span id="l58.76" class="difflineminus">-MimeInlineImage_parse_begin (MimeObject *obj)</span>
<a href="#l58.77"></a><span id="l58.77" class="difflineminus">-{</span>
<a href="#l58.78"></a><span id="l58.78" class="difflineminus">-  MimeInlineImage *img = (MimeInlineImage *) obj;</span>
<a href="#l58.79"></a><span id="l58.79" class="difflineplus">+static int MimeInlineImage_parse_begin(MimeObject *obj) {</span>
<a href="#l58.80"></a><span id="l58.80" class="difflineplus">+  MimeInlineImage *img = (MimeInlineImage *)obj;</span>
<a href="#l58.81"></a><span id="l58.81"> </span>
<a href="#l58.82"></a><span id="l58.82">   int status;</span>
<a href="#l58.83"></a><span id="l58.83"> </span>
<a href="#l58.84"></a><span id="l58.84" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l58.85"></a><span id="l58.85" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l58.86"></a><span id="l58.86">   if (status &lt; 0) return status;</span>
<a href="#l58.87"></a><span id="l58.87"> </span>
<a href="#l58.88"></a><span id="l58.88">   if (!obj-&gt;output_p) return 0;</span>
<a href="#l58.89"></a><span id="l58.89"> </span>
<a href="#l58.90"></a><span id="l58.90">   if (!obj-&gt;options || !obj-&gt;options-&gt;output_fn ||</span>
<a href="#l58.91"></a><span id="l58.91">       // don't bother processing if the consumer doesn't want us</span>
<a href="#l58.92"></a><span id="l58.92">       //  gunking the body up.</span>
<a href="#l58.93"></a><span id="l58.93">       obj-&gt;options-&gt;write_pure_bodies)</span>
<a href="#l58.94"></a><span id="l58.94">     return 0;</span>
<a href="#l58.95"></a><span id="l58.95"> </span>
<a href="#l58.96"></a><span id="l58.96" class="difflineminus">-  if (obj-&gt;options &amp;&amp;</span>
<a href="#l58.97"></a><span id="l58.97" class="difflineminus">-    obj-&gt;options-&gt;image_begin &amp;&amp;</span>
<a href="#l58.98"></a><span id="l58.98" class="difflineminus">-    obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l58.99"></a><span id="l58.99" class="difflineminus">-    obj-&gt;options-&gt;image_write_buffer)</span>
<a href="#l58.100"></a><span id="l58.100" class="difflineminus">-  {</span>
<a href="#l58.101"></a><span id="l58.101" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;image_begin &amp;&amp; obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l58.102"></a><span id="l58.102" class="difflineplus">+      obj-&gt;options-&gt;image_write_buffer) {</span>
<a href="#l58.103"></a><span id="l58.103">     char *html, *part, *image_url;</span>
<a href="#l58.104"></a><span id="l58.104">     const char *ct;</span>
<a href="#l58.105"></a><span id="l58.105"> </span>
<a href="#l58.106"></a><span id="l58.106">     part = mime_part_address(obj);</span>
<a href="#l58.107"></a><span id="l58.107">     if (!part) return MIME_OUT_OF_MEMORY;</span>
<a href="#l58.108"></a><span id="l58.108"> </span>
<a href="#l58.109"></a><span id="l58.109">     char *no_part_url = nullptr;</span>
<a href="#l58.110"></a><span id="l58.110" class="difflineminus">-    if (obj-&gt;options-&gt;part_to_load &amp;&amp; obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay)</span>
<a href="#l58.111"></a><span id="l58.111" class="difflineplus">+    if (obj-&gt;options-&gt;part_to_load &amp;&amp;</span>
<a href="#l58.112"></a><span id="l58.112" class="difflineplus">+        obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay)</span>
<a href="#l58.113"></a><span id="l58.113">       no_part_url = mime_get_base_url(obj-&gt;options-&gt;url);</span>
<a href="#l58.114"></a><span id="l58.114"> </span>
<a href="#l58.115"></a><span id="l58.115" class="difflineminus">-    if (no_part_url)</span>
<a href="#l58.116"></a><span id="l58.116" class="difflineminus">-    {</span>
<a href="#l58.117"></a><span id="l58.117" class="difflineplus">+    if (no_part_url) {</span>
<a href="#l58.118"></a><span id="l58.118">       image_url = mime_set_url_part(no_part_url, part, true);</span>
<a href="#l58.119"></a><span id="l58.119">       PR_Free(no_part_url);</span>
<a href="#l58.120"></a><span id="l58.120" class="difflineminus">-    }</span>
<a href="#l58.121"></a><span id="l58.121" class="difflineminus">-    else</span>
<a href="#l58.122"></a><span id="l58.122" class="difflineplus">+    } else</span>
<a href="#l58.123"></a><span id="l58.123">       image_url = mime_set_url_part(obj-&gt;options-&gt;url, part, true);</span>
<a href="#l58.124"></a><span id="l58.124"> </span>
<a href="#l58.125"></a><span id="l58.125" class="difflineminus">-    if (!image_url)</span>
<a href="#l58.126"></a><span id="l58.126" class="difflineminus">-    {</span>
<a href="#l58.127"></a><span id="l58.127" class="difflineplus">+    if (!image_url) {</span>
<a href="#l58.128"></a><span id="l58.128">       PR_Free(part);</span>
<a href="#l58.129"></a><span id="l58.129">       return MIME_OUT_OF_MEMORY;</span>
<a href="#l58.130"></a><span id="l58.130">     }</span>
<a href="#l58.131"></a><span id="l58.131">     PR_Free(part);</span>
<a href="#l58.132"></a><span id="l58.132"> </span>
<a href="#l58.133"></a><span id="l58.133">     ct = obj-&gt;content_type;</span>
<a href="#l58.134"></a><span id="l58.134" class="difflineminus">-    if (!ct) ct = IMAGE_GIF;  /* Can't happen?  Close enough. */</span>
<a href="#l58.135"></a><span id="l58.135" class="difflineplus">+    if (!ct) ct = IMAGE_GIF; /* Can't happen?  Close enough. */</span>
<a href="#l58.136"></a><span id="l58.136"> </span>
<a href="#l58.137"></a><span id="l58.137">     // Fill in content type and attachment name here.</span>
<a href="#l58.138"></a><span id="l58.138">     nsAutoCString url_with_filename(image_url);</span>
<a href="#l58.139"></a><span id="l58.139">     url_with_filename += &quot;&amp;type=&quot;;</span>
<a href="#l58.140"></a><span id="l58.140">     url_with_filename += ct;</span>
<a href="#l58.141"></a><span id="l58.141" class="difflineminus">-    char * filename = MimeHeaders_get_name ( obj-&gt;headers, obj-&gt;options );</span>
<a href="#l58.142"></a><span id="l58.142" class="difflineminus">-    if (filename)</span>
<a href="#l58.143"></a><span id="l58.143" class="difflineminus">-    {</span>
<a href="#l58.144"></a><span id="l58.144" class="difflineplus">+    char *filename = MimeHeaders_get_name(obj-&gt;headers, obj-&gt;options);</span>
<a href="#l58.145"></a><span id="l58.145" class="difflineplus">+    if (filename) {</span>
<a href="#l58.146"></a><span id="l58.146">       nsCString escapedName;</span>
<a href="#l58.147"></a><span id="l58.147">       MsgEscapeString(nsDependentCString(filename), nsINetUtil::ESCAPE_URL_PATH,</span>
<a href="#l58.148"></a><span id="l58.148">                       escapedName);</span>
<a href="#l58.149"></a><span id="l58.149">       url_with_filename += &quot;&amp;filename=&quot;;</span>
<a href="#l58.150"></a><span id="l58.150">       url_with_filename += escapedName;</span>
<a href="#l58.151"></a><span id="l58.151">       PR_Free(filename);</span>
<a href="#l58.152"></a><span id="l58.152">     }</span>
<a href="#l58.153"></a><span id="l58.153"> </span>
<a href="#l58.154"></a><span id="l58.154">     // We need to separate images with HR's...</span>
<a href="#l58.155"></a><span id="l58.155">     MimeObject_write_separator(obj);</span>
<a href="#l58.156"></a><span id="l58.156"> </span>
<a href="#l58.157"></a><span id="l58.157" class="difflineminus">-    img-&gt;image_data =</span>
<a href="#l58.158"></a><span id="l58.158" class="difflineminus">-      obj-&gt;options-&gt;image_begin(url_with_filename.get(), ct, obj-&gt;options-&gt;stream_closure);</span>
<a href="#l58.159"></a><span id="l58.159" class="difflineplus">+    img-&gt;image_data = obj-&gt;options-&gt;image_begin(url_with_filename.get(), ct,</span>
<a href="#l58.160"></a><span id="l58.160" class="difflineplus">+                                                obj-&gt;options-&gt;stream_closure);</span>
<a href="#l58.161"></a><span id="l58.161">     PR_Free(image_url);</span>
<a href="#l58.162"></a><span id="l58.162"> </span>
<a href="#l58.163"></a><span id="l58.163">     if (!img-&gt;image_data) return MIME_OUT_OF_MEMORY;</span>
<a href="#l58.164"></a><span id="l58.164"> </span>
<a href="#l58.165"></a><span id="l58.165">     html = obj-&gt;options-&gt;make_image_html(img-&gt;image_data);</span>
<a href="#l58.166"></a><span id="l58.166">     if (!html) return MIME_OUT_OF_MEMORY;</span>
<a href="#l58.167"></a><span id="l58.167"> </span>
<a href="#l58.168"></a><span id="l58.168">     status = MimeObject_write(obj, html, strlen(html), true);</span>
<a href="#l58.169"></a><span id="l58.169">     PR_Free(html);</span>
<a href="#l58.170"></a><span id="l58.170">     if (status &lt; 0) return status;</span>
<a href="#l58.171"></a><span id="l58.171">   }</span>
<a href="#l58.172"></a><span id="l58.172"> </span>
<a href="#l58.173"></a><span id="l58.173">   //</span>
<a href="#l58.174"></a><span id="l58.174">   // Now we are going to see if we should set the content type in the</span>
<a href="#l58.175"></a><span id="l58.175">   // URI for the url being run...</span>
<a href="#l58.176"></a><span id="l58.176">   //</span>
<a href="#l58.177"></a><span id="l58.177" class="difflineminus">-  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;stream_closure &amp;&amp; obj-&gt;content_type)</span>
<a href="#l58.178"></a><span id="l58.178" class="difflineminus">-  {</span>
<a href="#l58.179"></a><span id="l58.179" class="difflineminus">-    mime_stream_data  *msd = (mime_stream_data *) (obj-&gt;options-&gt;stream_closure);</span>
<a href="#l58.180"></a><span id="l58.180" class="difflineminus">-    if ( (msd) &amp;&amp; (msd-&gt;channel) )</span>
<a href="#l58.181"></a><span id="l58.181" class="difflineminus">-    {</span>
<a href="#l58.182"></a><span id="l58.182" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;stream_closure &amp;&amp; obj-&gt;content_type) {</span>
<a href="#l58.183"></a><span id="l58.183" class="difflineplus">+    mime_stream_data *msd = (mime_stream_data *)(obj-&gt;options-&gt;stream_closure);</span>
<a href="#l58.184"></a><span id="l58.184" class="difflineplus">+    if ((msd) &amp;&amp; (msd-&gt;channel)) {</span>
<a href="#l58.185"></a><span id="l58.185">       msd-&gt;channel-&gt;SetContentType(nsDependentCString(obj-&gt;content_type));</span>
<a href="#l58.186"></a><span id="l58.186">     }</span>
<a href="#l58.187"></a><span id="l58.187">   }</span>
<a href="#l58.188"></a><span id="l58.188"> </span>
<a href="#l58.189"></a><span id="l58.189">   return 0;</span>
<a href="#l58.190"></a><span id="l58.190"> }</span>
<a href="#l58.191"></a><span id="l58.191"> </span>
<a href="#l58.192"></a><span id="l58.192" class="difflineminus">-</span>
<a href="#l58.193"></a><span id="l58.193" class="difflineminus">-static int</span>
<a href="#l58.194"></a><span id="l58.194" class="difflineminus">-MimeInlineImage_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l58.195"></a><span id="l58.195" class="difflineminus">-{</span>
<a href="#l58.196"></a><span id="l58.196" class="difflineminus">-  MimeInlineImage *img = (MimeInlineImage *) obj;</span>
<a href="#l58.197"></a><span id="l58.197" class="difflineplus">+static int MimeInlineImage_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l58.198"></a><span id="l58.198" class="difflineplus">+  MimeInlineImage *img = (MimeInlineImage *)obj;</span>
<a href="#l58.199"></a><span id="l58.199">   int status;</span>
<a href="#l58.200"></a><span id="l58.200">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l58.201"></a><span id="l58.201"> </span>
<a href="#l58.202"></a><span id="l58.202">   /* Force out any buffered data from the superclass (the base64 decoder.) */</span>
<a href="#l58.203"></a><span id="l58.203" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l58.204"></a><span id="l58.204" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l58.205"></a><span id="l58.205">   if (status &lt; 0) abort_p = true;</span>
<a href="#l58.206"></a><span id="l58.206"> </span>
<a href="#l58.207"></a><span id="l58.207" class="difflineminus">-  if (img-&gt;image_data)</span>
<a href="#l58.208"></a><span id="l58.208" class="difflineminus">-  {</span>
<a href="#l58.209"></a><span id="l58.209" class="difflineplus">+  if (img-&gt;image_data) {</span>
<a href="#l58.210"></a><span id="l58.210">     obj-&gt;options-&gt;image_end(img-&gt;image_data,</span>
<a href="#l58.211"></a><span id="l58.211" class="difflineminus">-                (status &lt; 0 ? status : (abort_p ? -1 : 0)));</span>
<a href="#l58.212"></a><span id="l58.212" class="difflineplus">+                            (status &lt; 0 ? status : (abort_p ? -1 : 0)));</span>
<a href="#l58.213"></a><span id="l58.213">     img-&gt;image_data = 0;</span>
<a href="#l58.214"></a><span id="l58.214">   }</span>
<a href="#l58.215"></a><span id="l58.215"> </span>
<a href="#l58.216"></a><span id="l58.216">   return status;</span>
<a href="#l58.217"></a><span id="l58.217"> }</span>
<a href="#l58.218"></a><span id="l58.218"> </span>
<a href="#l58.219"></a><span id="l58.219" class="difflineminus">-</span>
<a href="#l58.220"></a><span id="l58.220" class="difflineminus">-static int</span>
<a href="#l58.221"></a><span id="l58.221" class="difflineminus">-MimeInlineImage_parse_decoded_buffer (const char *buf, int32_t size, MimeObject *obj)</span>
<a href="#l58.222"></a><span id="l58.222" class="difflineminus">-{</span>
<a href="#l58.223"></a><span id="l58.223" class="difflineplus">+static int MimeInlineImage_parse_decoded_buffer(const char *buf, int32_t size,</span>
<a href="#l58.224"></a><span id="l58.224" class="difflineplus">+                                                MimeObject *obj) {</span>
<a href="#l58.225"></a><span id="l58.225">   /* This is called (by MimeLeafClass-&gt;parse_buffer) with blocks of data</span>
<a href="#l58.226"></a><span id="l58.226">    that have already been base64-decoded.  Pass this raw image data</span>
<a href="#l58.227"></a><span id="l58.227">    along to the backend-specific image display code.</span>
<a href="#l58.228"></a><span id="l58.228">    */</span>
<a href="#l58.229"></a><span id="l58.229" class="difflineminus">-  MimeInlineImage *img  = (MimeInlineImage *) obj;</span>
<a href="#l58.230"></a><span id="l58.230" class="difflineplus">+  MimeInlineImage *img = (MimeInlineImage *)obj;</span>
<a href="#l58.231"></a><span id="l58.231">   int status;</span>
<a href="#l58.232"></a><span id="l58.232"> </span>
<a href="#l58.233"></a><span id="l58.233">   /* Don't do a roundtrip through XPConnect when we're only interested in</span>
<a href="#l58.234"></a><span id="l58.234">    * metadata and size. 0 means ok, the caller just checks for negative return</span>
<a href="#l58.235"></a><span id="l58.235">    * value</span>
<a href="#l58.236"></a><span id="l58.236">    */</span>
<a href="#l58.237"></a><span id="l58.237" class="difflineminus">-  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;metadata_only)</span>
<a href="#l58.238"></a><span id="l58.238" class="difflineminus">-    return 0;</span>
<a href="#l58.239"></a><span id="l58.239" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;metadata_only) return 0;</span>
<a href="#l58.240"></a><span id="l58.240"> </span>
<a href="#l58.241"></a><span id="l58.241" class="difflineminus">-  if (obj-&gt;output_p &amp;&amp;</span>
<a href="#l58.242"></a><span id="l58.242" class="difflineminus">-    obj-&gt;options &amp;&amp;</span>
<a href="#l58.243"></a><span id="l58.243" class="difflineminus">-    !obj-&gt;options-&gt;write_html_p)</span>
<a href="#l58.244"></a><span id="l58.244" class="difflineminus">-  {</span>
<a href="#l58.245"></a><span id="l58.245" class="difflineplus">+  if (obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; !obj-&gt;options-&gt;write_html_p) {</span>
<a href="#l58.246"></a><span id="l58.246">     /* in this case, we just want the raw data...</span>
<a href="#l58.247"></a><span id="l58.247">      Make the stream, if it's not made, and dump the data out.</span>
<a href="#l58.248"></a><span id="l58.248">      */</span>
<a href="#l58.249"></a><span id="l58.249"> </span>
<a href="#l58.250"></a><span id="l58.250" class="difflineminus">-    if (!obj-&gt;options-&gt;state-&gt;first_data_written_p)</span>
<a href="#l58.251"></a><span id="l58.251" class="difflineminus">-    {</span>
<a href="#l58.252"></a><span id="l58.252" class="difflineplus">+    if (!obj-&gt;options-&gt;state-&gt;first_data_written_p) {</span>
<a href="#l58.253"></a><span id="l58.253">       status = MimeObject_output_init(obj, 0);</span>
<a href="#l58.254"></a><span id="l58.254">       if (status &lt; 0) return status;</span>
<a href="#l58.255"></a><span id="l58.255" class="difflineminus">-      NS_ASSERTION(obj-&gt;options-&gt;state-&gt;first_data_written_p, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l58.256"></a><span id="l58.256" class="difflineplus">+      NS_ASSERTION(obj-&gt;options-&gt;state-&gt;first_data_written_p,</span>
<a href="#l58.257"></a><span id="l58.257" class="difflineplus">+                   &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l58.258"></a><span id="l58.258">     }</span>
<a href="#l58.259"></a><span id="l58.259"> </span>
<a href="#l58.260"></a><span id="l58.260">     return MimeObject_write(obj, buf, size, true);</span>
<a href="#l58.261"></a><span id="l58.261">   }</span>
<a href="#l58.262"></a><span id="l58.262"> </span>
<a href="#l58.263"></a><span id="l58.263" class="difflineminus">-</span>
<a href="#l58.264"></a><span id="l58.264" class="difflineminus">-  if (!obj-&gt;options ||</span>
<a href="#l58.265"></a><span id="l58.265" class="difflineminus">-    !obj-&gt;options-&gt;image_write_buffer)</span>
<a href="#l58.266"></a><span id="l58.266" class="difflineminus">-  return 0;</span>
<a href="#l58.267"></a><span id="l58.267" class="difflineplus">+  if (!obj-&gt;options || !obj-&gt;options-&gt;image_write_buffer) return 0;</span>
<a href="#l58.268"></a><span id="l58.268"> </span>
<a href="#l58.269"></a><span id="l58.269">   /* If we don't have any image data, the image_end method must have already</span>
<a href="#l58.270"></a><span id="l58.270">    been called, so don't call image_write_buffer again. */</span>
<a href="#l58.271"></a><span id="l58.271">   if (!img-&gt;image_data) return 0;</span>
<a href="#l58.272"></a><span id="l58.272"> </span>
<a href="#l58.273"></a><span id="l58.273">   /* Hand this data off to the backend-specific image display stream.</span>
<a href="#l58.274"></a><span id="l58.274">    */</span>
<a href="#l58.275"></a><span id="l58.275" class="difflineminus">-  status = obj-&gt;options-&gt;image_write_buffer (buf, size, img-&gt;image_data);</span>
<a href="#l58.276"></a><span id="l58.276" class="difflineplus">+  status = obj-&gt;options-&gt;image_write_buffer(buf, size, img-&gt;image_data);</span>
<a href="#l58.277"></a><span id="l58.277"> </span>
<a href="#l58.278"></a><span id="l58.278">   /* If the image display stream fails, then close the stream - but do not</span>
<a href="#l58.279"></a><span id="l58.279">    return the failure status, and do not give up on parsing this object.</span>
<a href="#l58.280"></a><span id="l58.280">    Just because the image data was corrupt doesn't mean we need to give up</span>
<a href="#l58.281"></a><span id="l58.281">    on the whole document; we can continue by just skipping over the rest of</span>
<a href="#l58.282"></a><span id="l58.282">    this part, and letting our parent continue.</span>
<a href="#l58.283"></a><span id="l58.283">    */</span>
<a href="#l58.284"></a><span id="l58.284" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l58.285"></a><span id="l58.285" class="difflineminus">-  {</span>
<a href="#l58.286"></a><span id="l58.286" class="difflineminus">-    obj-&gt;options-&gt;image_end (img-&gt;image_data, status);</span>
<a href="#l58.287"></a><span id="l58.287" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l58.288"></a><span id="l58.288" class="difflineplus">+    obj-&gt;options-&gt;image_end(img-&gt;image_data, status);</span>
<a href="#l58.289"></a><span id="l58.289">     img-&gt;image_data = 0;</span>
<a href="#l58.290"></a><span id="l58.290">     status = 0;</span>
<a href="#l58.291"></a><span id="l58.291">   }</span>
<a href="#l58.292"></a><span id="l58.292"> </span>
<a href="#l58.293"></a><span id="l58.293">   return status;</span>
<a href="#l58.294"></a><span id="l58.294"> }</span>
<a href="#l58.295"></a><span id="l58.295"> </span>
<a href="#l58.296"></a><span id="l58.296" class="difflineminus">-</span>
<a href="#l58.297"></a><span id="l58.297" class="difflineminus">-static int</span>
<a href="#l58.298"></a><span id="l58.298" class="difflineminus">-MimeInlineImage_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l58.299"></a><span id="l58.299" class="difflineminus">-{</span>
<a href="#l58.300"></a><span id="l58.300" class="difflineminus">-  NS_ERROR(&quot;This method should never be called (inline images do no line buffering).&quot;);</span>
<a href="#l58.301"></a><span id="l58.301" class="difflineplus">+static int MimeInlineImage_parse_line(const char *line, int32_t length,</span>
<a href="#l58.302"></a><span id="l58.302" class="difflineplus">+                                      MimeObject *obj) {</span>
<a href="#l58.303"></a><span id="l58.303" class="difflineplus">+  NS_ERROR(</span>
<a href="#l58.304"></a><span id="l58.304" class="difflineplus">+      &quot;This method should never be called (inline images do no line &quot;</span>
<a href="#l58.305"></a><span id="l58.305" class="difflineplus">+      &quot;buffering).&quot;);</span>
<a href="#l58.306"></a><span id="l58.306">   return -1;</span>
<a href="#l58.307"></a><span id="l58.307"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/mime/src/mimeiimg.h</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/mime/src/mimeiimg.h</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -8,28 +8,28 @@</span>
<a href="#l59.4"></a><span id="l59.4"> </span>
<a href="#l59.5"></a><span id="l59.5"> #include &quot;mimeleaf.h&quot;</span>
<a href="#l59.6"></a><span id="l59.6"> </span>
<a href="#l59.7"></a><span id="l59.7"> /* The MimeInlineImage class implements those MIME image types which can be</span>
<a href="#l59.8"></a><span id="l59.8">    displayed inline.</span>
<a href="#l59.9"></a><span id="l59.9">  */</span>
<a href="#l59.10"></a><span id="l59.10"> </span>
<a href="#l59.11"></a><span id="l59.11"> typedef struct MimeInlineImageClass MimeInlineImageClass;</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-typedef struct MimeInlineImage      MimeInlineImage;</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+typedef struct MimeInlineImage MimeInlineImage;</span>
<a href="#l59.14"></a><span id="l59.14"> </span>
<a href="#l59.15"></a><span id="l59.15"> struct MimeInlineImageClass {</span>
<a href="#l59.16"></a><span id="l59.16">   MimeLeafClass leaf;</span>
<a href="#l59.17"></a><span id="l59.17"> };</span>
<a href="#l59.18"></a><span id="l59.18"> </span>
<a href="#l59.19"></a><span id="l59.19"> extern MimeInlineImageClass mimeInlineImageClass;</span>
<a href="#l59.20"></a><span id="l59.20"> </span>
<a href="#l59.21"></a><span id="l59.21"> struct MimeInlineImage {</span>
<a href="#l59.22"></a><span id="l59.22">   MimeLeaf leaf;</span>
<a href="#l59.23"></a><span id="l59.23"> </span>
<a href="#l59.24"></a><span id="l59.24">   /* Opaque data object for the backend-specific inline-image-display code</span>
<a href="#l59.25"></a><span id="l59.25">    (internal-external-reconnect nastiness.) */</span>
<a href="#l59.26"></a><span id="l59.26">   void *image_data;</span>
<a href="#l59.27"></a><span id="l59.27"> };</span>
<a href="#l59.28"></a><span id="l59.28"> </span>
<a href="#l59.29"></a><span id="l59.29" class="difflineminus">-#define MimeInlineImageClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l59.30"></a><span id="l59.30" class="difflineminus">-  { MimeLeafClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l59.31"></a><span id="l59.31" class="difflineplus">+#define MimeInlineImageClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l59.32"></a><span id="l59.32" class="difflineplus">+  { MimeLeafClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l59.33"></a><span id="l59.33"> </span>
<a href="#l59.34"></a><span id="l59.34"> #endif /* _MIMEIIMG_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/mime/src/mimeleaf.cpp</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/mime/src/mimeleaf.cpp</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -5,215 +5,183 @@</span>
<a href="#l60.4"></a><span id="l60.4"> </span>
<a href="#l60.5"></a><span id="l60.5"> #include &quot;modmimee.h&quot;</span>
<a href="#l60.6"></a><span id="l60.6"> #include &quot;mimeleaf.h&quot;</span>
<a href="#l60.7"></a><span id="l60.7"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l60.8"></a><span id="l60.8"> #include &quot;prmem.h&quot;</span>
<a href="#l60.9"></a><span id="l60.9"> #include &quot;plstr.h&quot;</span>
<a href="#l60.10"></a><span id="l60.10"> #include &quot;prlog.h&quot;</span>
<a href="#l60.11"></a><span id="l60.11"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-#include &quot;modmimee.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+#include &quot;modmimee.h&quot;  // for MimeConverterOutputCallback</span>
<a href="#l60.14"></a><span id="l60.14"> </span>
<a href="#l60.15"></a><span id="l60.15"> #define MIME_SUPERCLASS mimeObjectClass</span>
<a href="#l60.16"></a><span id="l60.16"> MimeDefClass(MimeLeaf, MimeLeafClass, mimeLeafClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l60.17"></a><span id="l60.17"> </span>
<a href="#l60.18"></a><span id="l60.18" class="difflineminus">-static int MimeLeaf_initialize (MimeObject *);</span>
<a href="#l60.19"></a><span id="l60.19" class="difflineminus">-static void MimeLeaf_finalize (MimeObject *);</span>
<a href="#l60.20"></a><span id="l60.20" class="difflineminus">-static int MimeLeaf_parse_begin (MimeObject *);</span>
<a href="#l60.21"></a><span id="l60.21" class="difflineminus">-static int MimeLeaf_parse_buffer (const char *, int32_t, MimeObject *);</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineminus">-static int MimeLeaf_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineminus">-static int MimeLeaf_close_decoder (MimeObject *);</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineminus">-static int MimeLeaf_parse_eof (MimeObject *, bool);</span>
<a href="#l60.25"></a><span id="l60.25" class="difflineminus">-static bool MimeLeaf_displayable_inline_p (MimeObjectClass *clazz,</span>
<a href="#l60.26"></a><span id="l60.26" class="difflineminus">-                        MimeHeaders *hdrs);</span>
<a href="#l60.27"></a><span id="l60.27" class="difflineplus">+static int MimeLeaf_initialize(MimeObject *);</span>
<a href="#l60.28"></a><span id="l60.28" class="difflineplus">+static void MimeLeaf_finalize(MimeObject *);</span>
<a href="#l60.29"></a><span id="l60.29" class="difflineplus">+static int MimeLeaf_parse_begin(MimeObject *);</span>
<a href="#l60.30"></a><span id="l60.30" class="difflineplus">+static int MimeLeaf_parse_buffer(const char *, int32_t, MimeObject *);</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineplus">+static int MimeLeaf_parse_line(const char *, int32_t, MimeObject *);</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineplus">+static int MimeLeaf_close_decoder(MimeObject *);</span>
<a href="#l60.33"></a><span id="l60.33" class="difflineplus">+static int MimeLeaf_parse_eof(MimeObject *, bool);</span>
<a href="#l60.34"></a><span id="l60.34" class="difflineplus">+static bool MimeLeaf_displayable_inline_p(MimeObjectClass *clazz,</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineplus">+                                          MimeHeaders *hdrs);</span>
<a href="#l60.36"></a><span id="l60.36"> </span>
<a href="#l60.37"></a><span id="l60.37" class="difflineminus">-static int</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineminus">-MimeLeafClassInitialize(MimeLeafClass *clazz)</span>
<a href="#l60.39"></a><span id="l60.39" class="difflineminus">-{</span>
<a href="#l60.40"></a><span id="l60.40" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l60.41"></a><span id="l60.41" class="difflineminus">-  NS_ASSERTION(!oclass-&gt;class_initialized, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l60.42"></a><span id="l60.42" class="difflineminus">-  oclass-&gt;initialize   = MimeLeaf_initialize;</span>
<a href="#l60.43"></a><span id="l60.43" class="difflineminus">-  oclass-&gt;finalize     = MimeLeaf_finalize;</span>
<a href="#l60.44"></a><span id="l60.44" class="difflineminus">-  oclass-&gt;parse_begin  = MimeLeaf_parse_begin;</span>
<a href="#l60.45"></a><span id="l60.45" class="difflineplus">+static int MimeLeafClassInitialize(MimeLeafClass *clazz) {</span>
<a href="#l60.46"></a><span id="l60.46" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l60.47"></a><span id="l60.47" class="difflineplus">+  NS_ASSERTION(!oclass-&gt;class_initialized,</span>
<a href="#l60.48"></a><span id="l60.48" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l60.49"></a><span id="l60.49" class="difflineplus">+  oclass-&gt;initialize = MimeLeaf_initialize;</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineplus">+  oclass-&gt;finalize = MimeLeaf_finalize;</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineplus">+  oclass-&gt;parse_begin = MimeLeaf_parse_begin;</span>
<a href="#l60.52"></a><span id="l60.52">   oclass-&gt;parse_buffer = MimeLeaf_parse_buffer;</span>
<a href="#l60.53"></a><span id="l60.53" class="difflineminus">-  oclass-&gt;parse_line   = MimeLeaf_parse_line;</span>
<a href="#l60.54"></a><span id="l60.54" class="difflineminus">-  oclass-&gt;parse_eof    = MimeLeaf_parse_eof;</span>
<a href="#l60.55"></a><span id="l60.55" class="difflineplus">+  oclass-&gt;parse_line = MimeLeaf_parse_line;</span>
<a href="#l60.56"></a><span id="l60.56" class="difflineplus">+  oclass-&gt;parse_eof = MimeLeaf_parse_eof;</span>
<a href="#l60.57"></a><span id="l60.57">   oclass-&gt;displayable_inline_p = MimeLeaf_displayable_inline_p;</span>
<a href="#l60.58"></a><span id="l60.58">   clazz-&gt;close_decoder = MimeLeaf_close_decoder;</span>
<a href="#l60.59"></a><span id="l60.59"> </span>
<a href="#l60.60"></a><span id="l60.60">   /* Default `parse_buffer' method is one which line-buffers the now-decoded</span>
<a href="#l60.61"></a><span id="l60.61">    data and passes it on to `parse_line'.  (We snarf the implementation of</span>
<a href="#l60.62"></a><span id="l60.62">    this method from our superclass's implementation of `parse_buffer', which</span>
<a href="#l60.63"></a><span id="l60.63">    inherited it from MimeObject.)</span>
<a href="#l60.64"></a><span id="l60.64">    */</span>
<a href="#l60.65"></a><span id="l60.65">   clazz-&gt;parse_decoded_buffer =</span>
<a href="#l60.66"></a><span id="l60.66" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_buffer;</span>
<a href="#l60.67"></a><span id="l60.67" class="difflineplus">+      ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_buffer;</span>
<a href="#l60.68"></a><span id="l60.68"> </span>
<a href="#l60.69"></a><span id="l60.69">   return 0;</span>
<a href="#l60.70"></a><span id="l60.70"> }</span>
<a href="#l60.71"></a><span id="l60.71"> </span>
<a href="#l60.72"></a><span id="l60.72" class="difflineminus">-</span>
<a href="#l60.73"></a><span id="l60.73" class="difflineminus">-static int</span>
<a href="#l60.74"></a><span id="l60.74" class="difflineminus">-MimeLeaf_initialize (MimeObject *obj)</span>
<a href="#l60.75"></a><span id="l60.75" class="difflineminus">-{</span>
<a href="#l60.76"></a><span id="l60.76" class="difflineplus">+static int MimeLeaf_initialize(MimeObject *obj) {</span>
<a href="#l60.77"></a><span id="l60.77">   /* This is an abstract class; it shouldn't be directly instantiated. */</span>
<a href="#l60.78"></a><span id="l60.78" class="difflineminus">-  NS_ASSERTION(obj-&gt;clazz != (MimeObjectClass *) &amp;mimeLeafClass, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l60.79"></a><span id="l60.79" class="difflineplus">+  NS_ASSERTION(obj-&gt;clazz != (MimeObjectClass *)&amp;mimeLeafClass,</span>
<a href="#l60.80"></a><span id="l60.80" class="difflineplus">+               &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l60.81"></a><span id="l60.81"> </span>
<a href="#l60.82"></a><span id="l60.82">   // Initial size is -1 (meaning &quot;unknown size&quot;) - we'll correct it in</span>
<a href="#l60.83"></a><span id="l60.83">   // parse_buffer.</span>
<a href="#l60.84"></a><span id="l60.84" class="difflineminus">-  MimeLeaf *leaf = (MimeLeaf *) obj;</span>
<a href="#l60.85"></a><span id="l60.85" class="difflineplus">+  MimeLeaf *leaf = (MimeLeaf *)obj;</span>
<a href="#l60.86"></a><span id="l60.86">   leaf-&gt;sizeSoFar = -1;</span>
<a href="#l60.87"></a><span id="l60.87"> </span>
<a href="#l60.88"></a><span id="l60.88" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(obj);</span>
<a href="#l60.89"></a><span id="l60.89" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(obj);</span>
<a href="#l60.90"></a><span id="l60.90"> }</span>
<a href="#l60.91"></a><span id="l60.91"> </span>
<a href="#l60.92"></a><span id="l60.92" class="difflineminus">-</span>
<a href="#l60.93"></a><span id="l60.93" class="difflineminus">-static void</span>
<a href="#l60.94"></a><span id="l60.94" class="difflineminus">-MimeLeaf_finalize (MimeObject *object)</span>
<a href="#l60.95"></a><span id="l60.95" class="difflineminus">-{</span>
<a href="#l60.96"></a><span id="l60.96" class="difflineplus">+static void MimeLeaf_finalize(MimeObject *object) {</span>
<a href="#l60.97"></a><span id="l60.97">   MimeLeaf *leaf = (MimeLeaf *)object;</span>
<a href="#l60.98"></a><span id="l60.98" class="difflineminus">-  object-&gt;clazz-&gt;parse_eof (object, false);</span>
<a href="#l60.99"></a><span id="l60.99" class="difflineplus">+  object-&gt;clazz-&gt;parse_eof(object, false);</span>
<a href="#l60.100"></a><span id="l60.100"> </span>
<a href="#l60.101"></a><span id="l60.101">   /* Free the decoder data, if it's still around.  It was probably freed</span>
<a href="#l60.102"></a><span id="l60.102">    in MimeLeaf_parse_eof(), but just in case... */</span>
<a href="#l60.103"></a><span id="l60.103" class="difflineminus">-  if (leaf-&gt;decoder_data)</span>
<a href="#l60.104"></a><span id="l60.104" class="difflineminus">-  {</span>
<a href="#l60.105"></a><span id="l60.105" class="difflineplus">+  if (leaf-&gt;decoder_data) {</span>
<a href="#l60.106"></a><span id="l60.106">     MimeDecoderDestroy(leaf-&gt;decoder_data, true);</span>
<a href="#l60.107"></a><span id="l60.107">     leaf-&gt;decoder_data = 0;</span>
<a href="#l60.108"></a><span id="l60.108">   }</span>
<a href="#l60.109"></a><span id="l60.109"> </span>
<a href="#l60.110"></a><span id="l60.110" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize (object);</span>
<a href="#l60.111"></a><span id="l60.111" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l60.112"></a><span id="l60.112"> }</span>
<a href="#l60.113"></a><span id="l60.113"> </span>
<a href="#l60.114"></a><span id="l60.114" class="difflineminus">-</span>
<a href="#l60.115"></a><span id="l60.115" class="difflineminus">-static int</span>
<a href="#l60.116"></a><span id="l60.116" class="difflineminus">-MimeLeaf_parse_begin (MimeObject *obj)</span>
<a href="#l60.117"></a><span id="l60.117" class="difflineminus">-{</span>
<a href="#l60.118"></a><span id="l60.118" class="difflineminus">-  MimeLeaf *leaf = (MimeLeaf *) obj;</span>
<a href="#l60.119"></a><span id="l60.119" class="difflineminus">-  MimeDecoderData *(*fn) (MimeConverterOutputCallback, void*) = 0;</span>
<a href="#l60.120"></a><span id="l60.120" class="difflineplus">+static int MimeLeaf_parse_begin(MimeObject *obj) {</span>
<a href="#l60.121"></a><span id="l60.121" class="difflineplus">+  MimeLeaf *leaf = (MimeLeaf *)obj;</span>
<a href="#l60.122"></a><span id="l60.122" class="difflineplus">+  MimeDecoderData *(*fn)(MimeConverterOutputCallback, void *) = 0;</span>
<a href="#l60.123"></a><span id="l60.123"> </span>
<a href="#l60.124"></a><span id="l60.124">   /* Initialize a decoder if necessary.</span>
<a href="#l60.125"></a><span id="l60.125">    */</span>
<a href="#l60.126"></a><span id="l60.126">   if (!obj-&gt;encoding ||</span>
<a href="#l60.127"></a><span id="l60.127">       // If we need the object as &quot;raw&quot; for saving or forwarding,</span>
<a href="#l60.128"></a><span id="l60.128">       // don't decode attachment parts if headers are also written</span>
<a href="#l60.129"></a><span id="l60.129">       // via the parent, so that the header matches the encoding.</span>
<a href="#l60.130"></a><span id="l60.130">       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageRaw &amp;&amp;</span>
<a href="#l60.131"></a><span id="l60.131">        obj-&gt;parent &amp;&amp; obj-&gt;parent-&gt;output_p))</span>
<a href="#l60.132"></a><span id="l60.132" class="difflineminus">-    /* no-op */ ;</span>
<a href="#l60.133"></a><span id="l60.133" class="difflineplus">+    /* no-op */;</span>
<a href="#l60.134"></a><span id="l60.134">   else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_BASE64))</span>
<a href="#l60.135"></a><span id="l60.135">     fn = &amp;MimeB64DecoderInit;</span>
<a href="#l60.136"></a><span id="l60.136">   else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l60.137"></a><span id="l60.137" class="difflineminus">-    leaf-&gt;decoder_data =</span>
<a href="#l60.138"></a><span id="l60.138" class="difflineminus">-          MimeQPDecoderInit(((MimeConverterOutputCallback)</span>
<a href="#l60.139"></a><span id="l60.139" class="difflineminus">-                        ((MimeLeafClass *)obj-&gt;clazz)-&gt;parse_decoded_buffer),</span>
<a href="#l60.140"></a><span id="l60.140" class="difflineminus">-                        obj, obj);</span>
<a href="#l60.141"></a><span id="l60.141" class="difflineplus">+    leaf-&gt;decoder_data = MimeQPDecoderInit(</span>
<a href="#l60.142"></a><span id="l60.142" class="difflineplus">+        ((MimeConverterOutputCallback)((MimeLeafClass *)obj-&gt;clazz)</span>
<a href="#l60.143"></a><span id="l60.143" class="difflineplus">+             -&gt;parse_decoded_buffer),</span>
<a href="#l60.144"></a><span id="l60.144" class="difflineplus">+        obj, obj);</span>
<a href="#l60.145"></a><span id="l60.145">   else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE) ||</span>
<a href="#l60.146"></a><span id="l60.146" class="difflineminus">-       !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE2) ||</span>
<a href="#l60.147"></a><span id="l60.147" class="difflineminus">-       !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE3) ||</span>
<a href="#l60.148"></a><span id="l60.148" class="difflineminus">-       !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE4))</span>
<a href="#l60.149"></a><span id="l60.149" class="difflineplus">+           !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE2) ||</span>
<a href="#l60.150"></a><span id="l60.150" class="difflineplus">+           !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE3) ||</span>
<a href="#l60.151"></a><span id="l60.151" class="difflineplus">+           !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE4))</span>
<a href="#l60.152"></a><span id="l60.152">     fn = &amp;MimeUUDecoderInit;</span>
<a href="#l60.153"></a><span id="l60.153">   else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_YENCODE))</span>
<a href="#l60.154"></a><span id="l60.154">     fn = &amp;MimeYDecoderInit;</span>
<a href="#l60.155"></a><span id="l60.155"> </span>
<a href="#l60.156"></a><span id="l60.156" class="difflineminus">-  if (fn)</span>
<a href="#l60.157"></a><span id="l60.157" class="difflineminus">-  {</span>
<a href="#l60.158"></a><span id="l60.158" class="difflineplus">+  if (fn) {</span>
<a href="#l60.159"></a><span id="l60.159">     leaf-&gt;decoder_data =</span>
<a href="#l60.160"></a><span id="l60.160" class="difflineminus">-    fn (/* The MimeConverterOutputCallback cast is to turn the `void' argument</span>
<a href="#l60.161"></a><span id="l60.161" class="difflineminus">-           into `MimeObject'. */</span>
<a href="#l60.162"></a><span id="l60.162" class="difflineminus">-      ((MimeConverterOutputCallback)</span>
<a href="#l60.163"></a><span id="l60.163" class="difflineminus">-       ((MimeLeafClass *)obj-&gt;clazz)-&gt;parse_decoded_buffer),</span>
<a href="#l60.164"></a><span id="l60.164" class="difflineminus">-      obj);</span>
<a href="#l60.165"></a><span id="l60.165" class="difflineplus">+        fn(/* The MimeConverterOutputCallback cast is to turn the `void'</span>
<a href="#l60.166"></a><span id="l60.166" class="difflineplus">+              argument into `MimeObject'. */</span>
<a href="#l60.167"></a><span id="l60.167" class="difflineplus">+           ((MimeConverterOutputCallback)((MimeLeafClass *)obj-&gt;clazz)</span>
<a href="#l60.168"></a><span id="l60.168" class="difflineplus">+                -&gt;parse_decoded_buffer),</span>
<a href="#l60.169"></a><span id="l60.169" class="difflineplus">+           obj);</span>
<a href="#l60.170"></a><span id="l60.170"> </span>
<a href="#l60.171"></a><span id="l60.171" class="difflineminus">-    if (!leaf-&gt;decoder_data)</span>
<a href="#l60.172"></a><span id="l60.172" class="difflineminus">-    return MIME_OUT_OF_MEMORY;</span>
<a href="#l60.173"></a><span id="l60.173" class="difflineplus">+    if (!leaf-&gt;decoder_data) return MIME_OUT_OF_MEMORY;</span>
<a href="#l60.174"></a><span id="l60.174">   }</span>
<a href="#l60.175"></a><span id="l60.175"> </span>
<a href="#l60.176"></a><span id="l60.176" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l60.177"></a><span id="l60.177" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l60.178"></a><span id="l60.178"> }</span>
<a href="#l60.179"></a><span id="l60.179"> </span>
<a href="#l60.180"></a><span id="l60.180" class="difflineminus">-</span>
<a href="#l60.181"></a><span id="l60.181" class="difflineminus">-static int</span>
<a href="#l60.182"></a><span id="l60.182" class="difflineminus">-MimeLeaf_parse_buffer (const char *buffer, int32_t size, MimeObject *obj)</span>
<a href="#l60.183"></a><span id="l60.183" class="difflineminus">-{</span>
<a href="#l60.184"></a><span id="l60.184" class="difflineminus">-  MimeLeaf *leaf = (MimeLeaf *) obj;</span>
<a href="#l60.185"></a><span id="l60.185" class="difflineplus">+static int MimeLeaf_parse_buffer(const char *buffer, int32_t size,</span>
<a href="#l60.186"></a><span id="l60.186" class="difflineplus">+                                 MimeObject *obj) {</span>
<a href="#l60.187"></a><span id="l60.187" class="difflineplus">+  MimeLeaf *leaf = (MimeLeaf *)obj;</span>
<a href="#l60.188"></a><span id="l60.188"> </span>
<a href="#l60.189"></a><span id="l60.189">   NS_ASSERTION(!obj-&gt;closed_p, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l60.190"></a><span id="l60.190">   if (obj-&gt;closed_p) return -1;</span>
<a href="#l60.191"></a><span id="l60.191"> </span>
<a href="#l60.192"></a><span id="l60.192">   /* If we're not supposed to write this object, bug out now.</span>
<a href="#l60.193"></a><span id="l60.193">    */</span>
<a href="#l60.194"></a><span id="l60.194" class="difflineminus">-  if (!obj-&gt;output_p ||</span>
<a href="#l60.195"></a><span id="l60.195" class="difflineminus">-    !obj-&gt;options ||</span>
<a href="#l60.196"></a><span id="l60.196" class="difflineminus">-    !obj-&gt;options-&gt;output_fn)</span>
<a href="#l60.197"></a><span id="l60.197" class="difflineminus">-  return 0;</span>
<a href="#l60.198"></a><span id="l60.198" class="difflineplus">+  if (!obj-&gt;output_p || !obj-&gt;options || !obj-&gt;options-&gt;output_fn) return 0;</span>
<a href="#l60.199"></a><span id="l60.199"> </span>
<a href="#l60.200"></a><span id="l60.200">   int rv;</span>
<a href="#l60.201"></a><span id="l60.201" class="difflineminus">-  if (leaf-&gt;sizeSoFar == -1)</span>
<a href="#l60.202"></a><span id="l60.202" class="difflineminus">-    leaf-&gt;sizeSoFar = 0;</span>
<a href="#l60.203"></a><span id="l60.203" class="difflineplus">+  if (leaf-&gt;sizeSoFar == -1) leaf-&gt;sizeSoFar = 0;</span>
<a href="#l60.204"></a><span id="l60.204"> </span>
<a href="#l60.205"></a><span id="l60.205" class="difflineminus">-  if (leaf-&gt;decoder_data &amp;&amp;</span>
<a href="#l60.206"></a><span id="l60.206" class="difflineminus">-      obj-&gt;options &amp;&amp;</span>
<a href="#l60.207"></a><span id="l60.207" class="difflineminus">-      obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageDecrypt</span>
<a href="#l60.208"></a><span id="l60.208" class="difflineminus">-      &amp;&amp; obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageAttach) {</span>
<a href="#l60.209"></a><span id="l60.209" class="difflineplus">+  if (leaf-&gt;decoder_data &amp;&amp; obj-&gt;options &amp;&amp;</span>
<a href="#l60.210"></a><span id="l60.210" class="difflineplus">+      obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageDecrypt &amp;&amp;</span>
<a href="#l60.211"></a><span id="l60.211" class="difflineplus">+      obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageAttach) {</span>
<a href="#l60.212"></a><span id="l60.212">     int outSize = 0;</span>
<a href="#l60.213"></a><span id="l60.213" class="difflineminus">-    rv = MimeDecoderWrite (leaf-&gt;decoder_data, buffer, size, &amp;outSize);</span>
<a href="#l60.214"></a><span id="l60.214" class="difflineplus">+    rv = MimeDecoderWrite(leaf-&gt;decoder_data, buffer, size, &amp;outSize);</span>
<a href="#l60.215"></a><span id="l60.215">     leaf-&gt;sizeSoFar += outSize;</span>
<a href="#l60.216"></a><span id="l60.216" class="difflineminus">-  }</span>
<a href="#l60.217"></a><span id="l60.217" class="difflineminus">-  else {</span>
<a href="#l60.218"></a><span id="l60.218" class="difflineminus">-    rv = ((MimeLeafClass *)obj-&gt;clazz)-&gt;parse_decoded_buffer (buffer, size,</span>
<a href="#l60.219"></a><span id="l60.219" class="difflineminus">-                                obj);</span>
<a href="#l60.220"></a><span id="l60.220" class="difflineplus">+  } else {</span>
<a href="#l60.221"></a><span id="l60.221" class="difflineplus">+    rv = ((MimeLeafClass *)obj-&gt;clazz)-&gt;parse_decoded_buffer(buffer, size, obj);</span>
<a href="#l60.222"></a><span id="l60.222">     leaf-&gt;sizeSoFar += size;</span>
<a href="#l60.223"></a><span id="l60.223">   }</span>
<a href="#l60.224"></a><span id="l60.224">   return rv;</span>
<a href="#l60.225"></a><span id="l60.225"> }</span>
<a href="#l60.226"></a><span id="l60.226"> </span>
<a href="#l60.227"></a><span id="l60.227" class="difflineminus">-static int</span>
<a href="#l60.228"></a><span id="l60.228" class="difflineminus">-MimeLeaf_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l60.229"></a><span id="l60.229" class="difflineminus">-{</span>
<a href="#l60.230"></a><span id="l60.230" class="difflineplus">+static int MimeLeaf_parse_line(const char *line, int32_t length,</span>
<a href="#l60.231"></a><span id="l60.231" class="difflineplus">+                               MimeObject *obj) {</span>
<a href="#l60.232"></a><span id="l60.232">   NS_ERROR(&quot;MimeLeaf_parse_line shouldn't ever be called.&quot;);</span>
<a href="#l60.233"></a><span id="l60.233">   return -1;</span>
<a href="#l60.234"></a><span id="l60.234"> }</span>
<a href="#l60.235"></a><span id="l60.235"> </span>
<a href="#l60.236"></a><span id="l60.236" class="difflineminus">-</span>
<a href="#l60.237"></a><span id="l60.237" class="difflineminus">-static int</span>
<a href="#l60.238"></a><span id="l60.238" class="difflineminus">-MimeLeaf_close_decoder (MimeObject *obj)</span>
<a href="#l60.239"></a><span id="l60.239" class="difflineminus">-{</span>
<a href="#l60.240"></a><span id="l60.240" class="difflineminus">-  MimeLeaf *leaf = (MimeLeaf *) obj;</span>
<a href="#l60.241"></a><span id="l60.241" class="difflineplus">+static int MimeLeaf_close_decoder(MimeObject *obj) {</span>
<a href="#l60.242"></a><span id="l60.242" class="difflineplus">+  MimeLeaf *leaf = (MimeLeaf *)obj;</span>
<a href="#l60.243"></a><span id="l60.243"> </span>
<a href="#l60.244"></a><span id="l60.244" class="difflineminus">-  if (leaf-&gt;decoder_data)</span>
<a href="#l60.245"></a><span id="l60.245" class="difflineminus">-  {</span>
<a href="#l60.246"></a><span id="l60.246" class="difflineminus">-      int status = MimeDecoderDestroy(leaf-&gt;decoder_data, false);</span>
<a href="#l60.247"></a><span id="l60.247" class="difflineminus">-      leaf-&gt;decoder_data = 0;</span>
<a href="#l60.248"></a><span id="l60.248" class="difflineminus">-      return status;</span>
<a href="#l60.249"></a><span id="l60.249" class="difflineplus">+  if (leaf-&gt;decoder_data) {</span>
<a href="#l60.250"></a><span id="l60.250" class="difflineplus">+    int status = MimeDecoderDestroy(leaf-&gt;decoder_data, false);</span>
<a href="#l60.251"></a><span id="l60.251" class="difflineplus">+    leaf-&gt;decoder_data = 0;</span>
<a href="#l60.252"></a><span id="l60.252" class="difflineplus">+    return status;</span>
<a href="#l60.253"></a><span id="l60.253">   }</span>
<a href="#l60.254"></a><span id="l60.254"> </span>
<a href="#l60.255"></a><span id="l60.255">   return 0;</span>
<a href="#l60.256"></a><span id="l60.256"> }</span>
<a href="#l60.257"></a><span id="l60.257"> </span>
<a href="#l60.258"></a><span id="l60.258" class="difflineminus">-</span>
<a href="#l60.259"></a><span id="l60.259" class="difflineminus">-static int</span>
<a href="#l60.260"></a><span id="l60.260" class="difflineminus">-MimeLeaf_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l60.261"></a><span id="l60.261" class="difflineminus">-{</span>
<a href="#l60.262"></a><span id="l60.262" class="difflineminus">-  MimeLeaf *leaf = (MimeLeaf *) obj;</span>
<a href="#l60.263"></a><span id="l60.263" class="difflineplus">+static int MimeLeaf_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l60.264"></a><span id="l60.264" class="difflineplus">+  MimeLeaf *leaf = (MimeLeaf *)obj;</span>
<a href="#l60.265"></a><span id="l60.265">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l60.266"></a><span id="l60.266"> </span>
<a href="#l60.267"></a><span id="l60.267">   /* Close off the decoder, to cause it to give up any buffered data that</span>
<a href="#l60.268"></a><span id="l60.268">    it is still holding.</span>
<a href="#l60.269"></a><span id="l60.269">    */</span>
<a href="#l60.270"></a><span id="l60.270" class="difflineminus">-  if (leaf-&gt;decoder_data)</span>
<a href="#l60.271"></a><span id="l60.271" class="difflineminus">-  {</span>
<a href="#l60.272"></a><span id="l60.272" class="difflineminus">-      int status = MimeLeaf_close_decoder(obj);</span>
<a href="#l60.273"></a><span id="l60.273" class="difflineminus">-      if (status &lt; 0) return status;</span>
<a href="#l60.274"></a><span id="l60.274" class="difflineplus">+  if (leaf-&gt;decoder_data) {</span>
<a href="#l60.275"></a><span id="l60.275" class="difflineplus">+    int status = MimeLeaf_close_decoder(obj);</span>
<a href="#l60.276"></a><span id="l60.276" class="difflineplus">+    if (status &lt; 0) return status;</span>
<a href="#l60.277"></a><span id="l60.277">   }</span>
<a href="#l60.278"></a><span id="l60.278"> </span>
<a href="#l60.279"></a><span id="l60.279">   /* Now run the superclass's parse_eof, which will force out the line</span>
<a href="#l60.280"></a><span id="l60.280">    buffer (which we may have just repopulated, above.)</span>
<a href="#l60.281"></a><span id="l60.281">    */</span>
<a href="#l60.282"></a><span id="l60.282" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof (obj, abort_p);</span>
<a href="#l60.283"></a><span id="l60.283" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l60.284"></a><span id="l60.284"> }</span>
<a href="#l60.285"></a><span id="l60.285"> </span>
<a href="#l60.286"></a><span id="l60.286" class="difflineminus">-</span>
<a href="#l60.287"></a><span id="l60.287" class="difflineminus">-static bool</span>
<a href="#l60.288"></a><span id="l60.288" class="difflineminus">-MimeLeaf_displayable_inline_p (MimeObjectClass *clazz, MimeHeaders *hdrs)</span>
<a href="#l60.289"></a><span id="l60.289" class="difflineminus">-{</span>
<a href="#l60.290"></a><span id="l60.290" class="difflineplus">+static bool MimeLeaf_displayable_inline_p(MimeObjectClass *clazz,</span>
<a href="#l60.291"></a><span id="l60.291" class="difflineplus">+                                          MimeHeaders *hdrs) {</span>
<a href="#l60.292"></a><span id="l60.292">   return true;</span>
<a href="#l60.293"></a><span id="l60.293"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/mime/src/mimeleaf.h</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/mime/src/mimeleaf.h</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -10,50 +10,51 @@</span>
<a href="#l61.4"></a><span id="l61.4"> #include &quot;modmimee.h&quot;</span>
<a href="#l61.5"></a><span id="l61.5"> </span>
<a href="#l61.6"></a><span id="l61.6"> /* MimeLeaf is the class for the objects representing all MIME types which</span>
<a href="#l61.7"></a><span id="l61.7">    are not containers for other MIME objects.  The implication of this is</span>
<a href="#l61.8"></a><span id="l61.8">    that they are MIME types which can have Content-Transfer-Encodings</span>
<a href="#l61.9"></a><span id="l61.9">    applied to their data.  This class provides that service in its</span>
<a href="#l61.10"></a><span id="l61.10">    parse_buffer() method:</span>
<a href="#l61.11"></a><span id="l61.11"> </span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-     int (*parse_decoded_buffer) (const char *buf, int32_t size, MimeObject *obj)</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+     int (*parse_decoded_buffer) (const char *buf, int32_t size, MimeObject</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineplus">+   *obj)</span>
<a href="#l61.15"></a><span id="l61.15"> </span>
<a href="#l61.16"></a><span id="l61.16">    The `parse_buffer' method of MimeLeaf passes each block of data through</span>
<a href="#l61.17"></a><span id="l61.17">    the appropriate decoder (if any) and then calls `parse_decoded_buffer'</span>
<a href="#l61.18"></a><span id="l61.18">    on each block (not line) of output.</span>
<a href="#l61.19"></a><span id="l61.19"> </span>
<a href="#l61.20"></a><span id="l61.20">    The default `parse_decoded_buffer' method of MimeLeaf line-buffers the</span>
<a href="#l61.21"></a><span id="l61.21">    now-decoded data, handing each line to the `parse_line' method in turn.</span>
<a href="#l61.22"></a><span id="l61.22">    If different behavior is desired (for example, if a class wants access</span>
<a href="#l61.23"></a><span id="l61.23">    to the decoded data before it is line-buffered) the `parse_decoded_buffer'</span>
<a href="#l61.24"></a><span id="l61.24">    method should be overridden.  (MimeExternalObject does this.)</span>
<a href="#l61.25"></a><span id="l61.25">  */</span>
<a href="#l61.26"></a><span id="l61.26"> </span>
<a href="#l61.27"></a><span id="l61.27"> typedef struct MimeLeafClass MimeLeafClass;</span>
<a href="#l61.28"></a><span id="l61.28" class="difflineminus">-typedef struct MimeLeaf      MimeLeaf;</span>
<a href="#l61.29"></a><span id="l61.29" class="difflineplus">+typedef struct MimeLeaf MimeLeaf;</span>
<a href="#l61.30"></a><span id="l61.30"> </span>
<a href="#l61.31"></a><span id="l61.31"> struct MimeLeafClass {</span>
<a href="#l61.32"></a><span id="l61.32">   MimeObjectClass object;</span>
<a href="#l61.33"></a><span id="l61.33">   /* This is the callback that is handed to the decoder. */</span>
<a href="#l61.34"></a><span id="l61.34" class="difflineminus">-  int (*parse_decoded_buffer) (const char *buf, int32_t size, MimeObject *obj);</span>
<a href="#l61.35"></a><span id="l61.35" class="difflineminus">-  int (*close_decoder) (MimeObject *obj);</span>
<a href="#l61.36"></a><span id="l61.36" class="difflineplus">+  int (*parse_decoded_buffer)(const char *buf, int32_t size, MimeObject *obj);</span>
<a href="#l61.37"></a><span id="l61.37" class="difflineplus">+  int (*close_decoder)(MimeObject *obj);</span>
<a href="#l61.38"></a><span id="l61.38"> };</span>
<a href="#l61.39"></a><span id="l61.39"> </span>
<a href="#l61.40"></a><span id="l61.40"> extern MimeLeafClass mimeLeafClass;</span>
<a href="#l61.41"></a><span id="l61.41"> </span>
<a href="#l61.42"></a><span id="l61.42"> struct MimeLeaf {</span>
<a href="#l61.43"></a><span id="l61.43" class="difflineminus">-  MimeObject object;    /* superclass variables */</span>
<a href="#l61.44"></a><span id="l61.44" class="difflineplus">+  MimeObject object; /* superclass variables */</span>
<a href="#l61.45"></a><span id="l61.45"> </span>
<a href="#l61.46"></a><span id="l61.46">   /* If we're doing Base64, Quoted-Printable, or UU decoding, this is the</span>
<a href="#l61.47"></a><span id="l61.47">    state object for the decoder. */</span>
<a href="#l61.48"></a><span id="l61.48">   MimeDecoderData *decoder_data;</span>
<a href="#l61.49"></a><span id="l61.49"> </span>
<a href="#l61.50"></a><span id="l61.50">   /* We want to count the size of the MimeObject to offer consumers the</span>
<a href="#l61.51"></a><span id="l61.51">    * opportunity to display the sizes of attachments.</span>
<a href="#l61.52"></a><span id="l61.52">    */</span>
<a href="#l61.53"></a><span id="l61.53">   int sizeSoFar;</span>
<a href="#l61.54"></a><span id="l61.54"> };</span>
<a href="#l61.55"></a><span id="l61.55"> </span>
<a href="#l61.56"></a><span id="l61.56" class="difflineminus">-#define MimeLeafClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l61.57"></a><span id="l61.57" class="difflineminus">-  { MimeObjectClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l61.58"></a><span id="l61.58" class="difflineplus">+#define MimeLeafClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l61.59"></a><span id="l61.59" class="difflineplus">+  { MimeObjectClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l61.60"></a><span id="l61.60"> </span>
<a href="#l61.61"></a><span id="l61.61"> #endif /* _MIMELEAF_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/mime/src/mimemalt.cpp</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/mime/src/mimemalt.cpp</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -88,106 +88,95 @@</span>
<a href="#l62.4"></a><span id="l62.4"> </span>
<a href="#l62.5"></a><span id="l62.5"> #include &quot;mimemalt.h&quot;</span>
<a href="#l62.6"></a><span id="l62.6"> #include &quot;prmem.h&quot;</span>
<a href="#l62.7"></a><span id="l62.7"> #include &quot;plstr.h&quot;</span>
<a href="#l62.8"></a><span id="l62.8"> #include &quot;prlog.h&quot;</span>
<a href="#l62.9"></a><span id="l62.9"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l62.10"></a><span id="l62.10"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l62.11"></a><span id="l62.11"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-#include &quot;mimemoz2.h&quot; // for prefs</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineminus">-#include &quot;modmimee.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineplus">+#include &quot;mimemoz2.h&quot;  // for prefs</span>
<a href="#l62.15"></a><span id="l62.15" class="difflineplus">+#include &quot;modmimee.h&quot;  // for MimeConverterOutputCallback</span>
<a href="#l62.16"></a><span id="l62.16"> </span>
<a href="#l62.17"></a><span id="l62.17"> extern &quot;C&quot; MimeObjectClass mimeMultipartRelatedClass;</span>
<a href="#l62.18"></a><span id="l62.18"> </span>
<a href="#l62.19"></a><span id="l62.19"> #define MIME_SUPERCLASS mimeMultipartClass</span>
<a href="#l62.20"></a><span id="l62.20"> MimeDefClass(MimeMultipartAlternative, MimeMultipartAlternativeClass,</span>
<a href="#l62.21"></a><span id="l62.21" class="difflineminus">-       mimeMultipartAlternativeClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineplus">+             mimeMultipartAlternativeClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l62.23"></a><span id="l62.23"> </span>
<a href="#l62.24"></a><span id="l62.24" class="difflineminus">-static int MimeMultipartAlternative_initialize (MimeObject *);</span>
<a href="#l62.25"></a><span id="l62.25" class="difflineminus">-static void MimeMultipartAlternative_finalize (MimeObject *);</span>
<a href="#l62.26"></a><span id="l62.26" class="difflineminus">-static int MimeMultipartAlternative_parse_eof (MimeObject *, bool);</span>
<a href="#l62.27"></a><span id="l62.27" class="difflineplus">+static int MimeMultipartAlternative_initialize(MimeObject *);</span>
<a href="#l62.28"></a><span id="l62.28" class="difflineplus">+static void MimeMultipartAlternative_finalize(MimeObject *);</span>
<a href="#l62.29"></a><span id="l62.29" class="difflineplus">+static int MimeMultipartAlternative_parse_eof(MimeObject *, bool);</span>
<a href="#l62.30"></a><span id="l62.30"> static int MimeMultipartAlternative_create_child(MimeObject *);</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineminus">-static int MimeMultipartAlternative_parse_child_line (MimeObject *, const char *,</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineminus">-                            int32_t, bool);</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+static int MimeMultipartAlternative_parse_child_line(MimeObject *, const char *,</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineplus">+                                                     int32_t, bool);</span>
<a href="#l62.35"></a><span id="l62.35"> static int MimeMultipartAlternative_close_child(MimeObject *);</span>
<a href="#l62.36"></a><span id="l62.36"> </span>
<a href="#l62.37"></a><span id="l62.37" class="difflineminus">-static int MimeMultipartAlternative_flush_children(MimeObject *, bool, priority_t);</span>
<a href="#l62.38"></a><span id="l62.38" class="difflineminus">-static priority_t MimeMultipartAlternative_display_part_p(MimeObject *self,</span>
<a href="#l62.39"></a><span id="l62.39" class="difflineminus">-                             MimeHeaders *sub_hdrs);</span>
<a href="#l62.40"></a><span id="l62.40" class="difflineminus">-static priority_t MimeMultipartAlternative_prioritize_part(char *content_type,</span>
<a href="#l62.41"></a><span id="l62.41" class="difflineminus">-                             bool prefer_plaintext);</span>
<a href="#l62.42"></a><span id="l62.42" class="difflineplus">+static int MimeMultipartAlternative_flush_children(MimeObject *, bool,</span>
<a href="#l62.43"></a><span id="l62.43" class="difflineplus">+                                                   priority_t);</span>
<a href="#l62.44"></a><span id="l62.44" class="difflineplus">+static priority_t MimeMultipartAlternative_display_part_p(</span>
<a href="#l62.45"></a><span id="l62.45" class="difflineplus">+    MimeObject *self, MimeHeaders *sub_hdrs);</span>
<a href="#l62.46"></a><span id="l62.46" class="difflineplus">+static priority_t MimeMultipartAlternative_prioritize_part(</span>
<a href="#l62.47"></a><span id="l62.47" class="difflineplus">+    char *content_type, bool prefer_plaintext);</span>
<a href="#l62.48"></a><span id="l62.48"> </span>
<a href="#l62.49"></a><span id="l62.49"> static int MimeMultipartAlternative_display_cached_part(MimeObject *,</span>
<a href="#l62.50"></a><span id="l62.50">                                                         MimeHeaders *,</span>
<a href="#l62.51"></a><span id="l62.51">                                                         MimePartBufferData *,</span>
<a href="#l62.52"></a><span id="l62.52">                                                         bool);</span>
<a href="#l62.53"></a><span id="l62.53"> </span>
<a href="#l62.54"></a><span id="l62.54" class="difflineminus">-static int</span>
<a href="#l62.55"></a><span id="l62.55" class="difflineminus">-MimeMultipartAlternativeClassInitialize(MimeMultipartAlternativeClass *clazz)</span>
<a href="#l62.56"></a><span id="l62.56" class="difflineminus">-{</span>
<a href="#l62.57"></a><span id="l62.57" class="difflineminus">-  MimeObjectClass    *oclass = (MimeObjectClass *)    clazz;</span>
<a href="#l62.58"></a><span id="l62.58" class="difflineminus">-  MimeMultipartClass *mclass = (MimeMultipartClass *) clazz;</span>
<a href="#l62.59"></a><span id="l62.59" class="difflineplus">+static int MimeMultipartAlternativeClassInitialize(</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineplus">+    MimeMultipartAlternativeClass *clazz) {</span>
<a href="#l62.61"></a><span id="l62.61" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l62.62"></a><span id="l62.62" class="difflineplus">+  MimeMultipartClass *mclass = (MimeMultipartClass *)clazz;</span>
<a href="#l62.63"></a><span id="l62.63">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l62.64"></a><span id="l62.64" class="difflineminus">-  oclass-&gt;initialize       = MimeMultipartAlternative_initialize;</span>
<a href="#l62.65"></a><span id="l62.65" class="difflineminus">-  oclass-&gt;finalize         = MimeMultipartAlternative_finalize;</span>
<a href="#l62.66"></a><span id="l62.66" class="difflineminus">-  oclass-&gt;parse_eof        = MimeMultipartAlternative_parse_eof;</span>
<a href="#l62.67"></a><span id="l62.67" class="difflineminus">-  mclass-&gt;create_child     = MimeMultipartAlternative_create_child;</span>
<a href="#l62.68"></a><span id="l62.68" class="difflineplus">+  oclass-&gt;initialize = MimeMultipartAlternative_initialize;</span>
<a href="#l62.69"></a><span id="l62.69" class="difflineplus">+  oclass-&gt;finalize = MimeMultipartAlternative_finalize;</span>
<a href="#l62.70"></a><span id="l62.70" class="difflineplus">+  oclass-&gt;parse_eof = MimeMultipartAlternative_parse_eof;</span>
<a href="#l62.71"></a><span id="l62.71" class="difflineplus">+  mclass-&gt;create_child = MimeMultipartAlternative_create_child;</span>
<a href="#l62.72"></a><span id="l62.72">   mclass-&gt;parse_child_line = MimeMultipartAlternative_parse_child_line;</span>
<a href="#l62.73"></a><span id="l62.73" class="difflineminus">-  mclass-&gt;close_child      = MimeMultipartAlternative_close_child;</span>
<a href="#l62.74"></a><span id="l62.74" class="difflineplus">+  mclass-&gt;close_child = MimeMultipartAlternative_close_child;</span>
<a href="#l62.75"></a><span id="l62.75">   return 0;</span>
<a href="#l62.76"></a><span id="l62.76"> }</span>
<a href="#l62.77"></a><span id="l62.77"> </span>
<a href="#l62.78"></a><span id="l62.78" class="difflineminus">-</span>
<a href="#l62.79"></a><span id="l62.79" class="difflineminus">-static int</span>
<a href="#l62.80"></a><span id="l62.80" class="difflineminus">-MimeMultipartAlternative_initialize (MimeObject *obj)</span>
<a href="#l62.81"></a><span id="l62.81" class="difflineminus">-{</span>
<a href="#l62.82"></a><span id="l62.82" class="difflineminus">-  MimeMultipartAlternative *malt = (MimeMultipartAlternative *) obj;</span>
<a href="#l62.83"></a><span id="l62.83" class="difflineplus">+static int MimeMultipartAlternative_initialize(MimeObject *obj) {</span>
<a href="#l62.84"></a><span id="l62.84" class="difflineplus">+  MimeMultipartAlternative *malt = (MimeMultipartAlternative *)obj;</span>
<a href="#l62.85"></a><span id="l62.85"> </span>
<a href="#l62.86"></a><span id="l62.86">   NS_ASSERTION(!malt-&gt;part_buffers, &quot;object initialized multiple times&quot;);</span>
<a href="#l62.87"></a><span id="l62.87">   NS_ASSERTION(!malt-&gt;buffered_hdrs, &quot;object initialized multiple times&quot;);</span>
<a href="#l62.88"></a><span id="l62.88">   malt-&gt;pending_parts = 0;</span>
<a href="#l62.89"></a><span id="l62.89">   malt-&gt;max_parts = 0;</span>
<a href="#l62.90"></a><span id="l62.90">   malt-&gt;buffered_priority = PRIORITY_UNDISPLAYABLE;</span>
<a href="#l62.91"></a><span id="l62.91">   malt-&gt;buffered_hdrs = nullptr;</span>
<a href="#l62.92"></a><span id="l62.92">   malt-&gt;part_buffers = nullptr;</span>
<a href="#l62.93"></a><span id="l62.93"> </span>
<a href="#l62.94"></a><span id="l62.94" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(obj);</span>
<a href="#l62.95"></a><span id="l62.95" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(obj);</span>
<a href="#l62.96"></a><span id="l62.96"> }</span>
<a href="#l62.97"></a><span id="l62.97"> </span>
<a href="#l62.98"></a><span id="l62.98" class="difflineminus">-static void</span>
<a href="#l62.99"></a><span id="l62.99" class="difflineminus">-MimeMultipartAlternative_cleanup(MimeObject *obj)</span>
<a href="#l62.100"></a><span id="l62.100" class="difflineminus">-{</span>
<a href="#l62.101"></a><span id="l62.101" class="difflineminus">-  MimeMultipartAlternative *malt = (MimeMultipartAlternative *) obj;</span>
<a href="#l62.102"></a><span id="l62.102" class="difflineplus">+static void MimeMultipartAlternative_cleanup(MimeObject *obj) {</span>
<a href="#l62.103"></a><span id="l62.103" class="difflineplus">+  MimeMultipartAlternative *malt = (MimeMultipartAlternative *)obj;</span>
<a href="#l62.104"></a><span id="l62.104">   int32_t i;</span>
<a href="#l62.105"></a><span id="l62.105"> </span>
<a href="#l62.106"></a><span id="l62.106">   for (i = 0; i &lt; malt-&gt;pending_parts; i++) {</span>
<a href="#l62.107"></a><span id="l62.107">     MimeHeaders_free(malt-&gt;buffered_hdrs[i]);</span>
<a href="#l62.108"></a><span id="l62.108">     MimePartBufferDestroy(malt-&gt;part_buffers[i]);</span>
<a href="#l62.109"></a><span id="l62.109">   }</span>
<a href="#l62.110"></a><span id="l62.110">   PR_FREEIF(malt-&gt;buffered_hdrs);</span>
<a href="#l62.111"></a><span id="l62.111">   PR_FREEIF(malt-&gt;part_buffers);</span>
<a href="#l62.112"></a><span id="l62.112">   malt-&gt;pending_parts = 0;</span>
<a href="#l62.113"></a><span id="l62.113">   malt-&gt;max_parts = 0;</span>
<a href="#l62.114"></a><span id="l62.114"> }</span>
<a href="#l62.115"></a><span id="l62.115"> </span>
<a href="#l62.116"></a><span id="l62.116" class="difflineminus">-</span>
<a href="#l62.117"></a><span id="l62.117" class="difflineminus">-static void</span>
<a href="#l62.118"></a><span id="l62.118" class="difflineminus">-MimeMultipartAlternative_finalize (MimeObject *obj)</span>
<a href="#l62.119"></a><span id="l62.119" class="difflineminus">-{</span>
<a href="#l62.120"></a><span id="l62.120" class="difflineplus">+static void MimeMultipartAlternative_finalize(MimeObject *obj) {</span>
<a href="#l62.121"></a><span id="l62.121">   MimeMultipartAlternative_cleanup(obj);</span>
<a href="#l62.122"></a><span id="l62.122" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l62.123"></a><span id="l62.123" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l62.124"></a><span id="l62.124"> }</span>
<a href="#l62.125"></a><span id="l62.125"> </span>
<a href="#l62.126"></a><span id="l62.126" class="difflineminus">-</span>
<a href="#l62.127"></a><span id="l62.127" class="difflineminus">-static int</span>
<a href="#l62.128"></a><span id="l62.128" class="difflineminus">-MimeMultipartAlternative_flush_children(MimeObject *obj,</span>
<a href="#l62.129"></a><span id="l62.129" class="difflineminus">-                                        bool finished,</span>
<a href="#l62.130"></a><span id="l62.130" class="difflineminus">-                                        priority_t next_priority)</span>
<a href="#l62.131"></a><span id="l62.131" class="difflineminus">-{</span>
<a href="#l62.132"></a><span id="l62.132" class="difflineplus">+static int MimeMultipartAlternative_flush_children(MimeObject *obj,</span>
<a href="#l62.133"></a><span id="l62.133" class="difflineplus">+                                                   bool finished,</span>
<a href="#l62.134"></a><span id="l62.134" class="difflineplus">+                                                   priority_t next_priority) {</span>
<a href="#l62.135"></a><span id="l62.135">   /*</span>
<a href="#l62.136"></a><span id="l62.136">     The cache should always have at the head the part with highest priority.</span>
<a href="#l62.137"></a><span id="l62.137"> </span>
<a href="#l62.138"></a><span id="l62.138">     Possible states:</span>
<a href="#l62.139"></a><span id="l62.139"> </span>
<a href="#l62.140"></a><span id="l62.140">     1. Cache contains nothing: do nothing.</span>
<a href="#l62.141"></a><span id="l62.141"> </span>
<a href="#l62.142"></a><span id="l62.142">     2. Finished, and the cache contains one displayable body followed</span>
<a href="#l62.143"></a><span id="l62.143" class="difflineat">@@ -203,179 +192,155 @@ MimeMultipartAlternative_flush_children(</span>
<a href="#l62.144"></a><span id="l62.144"> </span>
<a href="#l62.145"></a><span id="l62.145">     5. Not finished, and the cache contains one displayable body</span>
<a href="#l62.146"></a><span id="l62.146">        followed by zero or more bodies with lower priority, and the new</span>
<a href="#l62.147"></a><span id="l62.147">        body we're about to create has lower priority: do nothing.</span>
<a href="#l62.148"></a><span id="l62.148"> </span>
<a href="#l62.149"></a><span id="l62.149">     6. Not finished, and the cache contains one non-displayable body:</span>
<a href="#l62.150"></a><span id="l62.150">        create it with output off.</span>
<a href="#l62.151"></a><span id="l62.151">   */</span>
<a href="#l62.152"></a><span id="l62.152" class="difflineminus">-  MimeMultipartAlternative *malt = (MimeMultipartAlternative *) obj;</span>
<a href="#l62.153"></a><span id="l62.153" class="difflineplus">+  MimeMultipartAlternative *malt = (MimeMultipartAlternative *)obj;</span>
<a href="#l62.154"></a><span id="l62.154">   bool have_displayable, do_flush, do_display;</span>
<a href="#l62.155"></a><span id="l62.155"> </span>
<a href="#l62.156"></a><span id="l62.156">   /* Case 1 */</span>
<a href="#l62.157"></a><span id="l62.157" class="difflineminus">-  if (! malt-&gt;pending_parts)</span>
<a href="#l62.158"></a><span id="l62.158" class="difflineminus">-    return 0;</span>
<a href="#l62.159"></a><span id="l62.159" class="difflineplus">+  if (!malt-&gt;pending_parts) return 0;</span>
<a href="#l62.160"></a><span id="l62.160"> </span>
<a href="#l62.161"></a><span id="l62.161">   have_displayable = (malt-&gt;buffered_priority &gt; next_priority);</span>
<a href="#l62.162"></a><span id="l62.162"> </span>
<a href="#l62.163"></a><span id="l62.163">   if (finished &amp;&amp; have_displayable) {</span>
<a href="#l62.164"></a><span id="l62.164">     /* Case 2 */</span>
<a href="#l62.165"></a><span id="l62.165">     do_flush = true;</span>
<a href="#l62.166"></a><span id="l62.166">     do_display = true;</span>
<a href="#l62.167"></a><span id="l62.167" class="difflineminus">-  }</span>
<a href="#l62.168"></a><span id="l62.168" class="difflineminus">-  else if (finished &amp;&amp; ! have_displayable) {</span>
<a href="#l62.169"></a><span id="l62.169" class="difflineplus">+  } else if (finished &amp;&amp; !have_displayable) {</span>
<a href="#l62.170"></a><span id="l62.170">     /* Case 3 */</span>
<a href="#l62.171"></a><span id="l62.171">     do_flush = true;</span>
<a href="#l62.172"></a><span id="l62.172">     do_display = false;</span>
<a href="#l62.173"></a><span id="l62.173" class="difflineminus">-  }</span>
<a href="#l62.174"></a><span id="l62.174" class="difflineminus">-  else if (! finished &amp;&amp; have_displayable) {</span>
<a href="#l62.175"></a><span id="l62.175" class="difflineplus">+  } else if (!finished &amp;&amp; have_displayable) {</span>
<a href="#l62.176"></a><span id="l62.176">     /* Case 5 */</span>
<a href="#l62.177"></a><span id="l62.177">     do_flush = false;</span>
<a href="#l62.178"></a><span id="l62.178">     do_display = false;</span>
<a href="#l62.179"></a><span id="l62.179" class="difflineminus">-  }</span>
<a href="#l62.180"></a><span id="l62.180" class="difflineminus">-  else if (! finished &amp;&amp; ! have_displayable) {</span>
<a href="#l62.181"></a><span id="l62.181" class="difflineplus">+  } else if (!finished &amp;&amp; !have_displayable) {</span>
<a href="#l62.182"></a><span id="l62.182">     /* Case 4 */</span>
<a href="#l62.183"></a><span id="l62.183">     /* Case 6 */</span>
<a href="#l62.184"></a><span id="l62.184">     do_flush = true;</span>
<a href="#l62.185"></a><span id="l62.185">     do_display = false;</span>
<a href="#l62.186"></a><span id="l62.186" class="difflineminus">-  }</span>
<a href="#l62.187"></a><span id="l62.187" class="difflineminus">-  else {</span>
<a href="#l62.188"></a><span id="l62.188" class="difflineplus">+  } else {</span>
<a href="#l62.189"></a><span id="l62.189">     NS_ERROR(&quot;mimemalt.cpp: logic error in flush_children&quot;);</span>
<a href="#l62.190"></a><span id="l62.190">     return -1;</span>
<a href="#l62.191"></a><span id="l62.191">   }</span>
<a href="#l62.192"></a><span id="l62.192"> </span>
<a href="#l62.193"></a><span id="l62.193">   if (do_flush) {</span>
<a href="#l62.194"></a><span id="l62.194">     int32_t i;</span>
<a href="#l62.195"></a><span id="l62.195">     for (i = 0; i &lt; malt-&gt;pending_parts; i++) {</span>
<a href="#l62.196"></a><span id="l62.196" class="difflineminus">-      MimeMultipartAlternative_display_cached_part(obj,</span>
<a href="#l62.197"></a><span id="l62.197" class="difflineminus">-                                                   malt-&gt;buffered_hdrs[i],</span>
<a href="#l62.198"></a><span id="l62.198" class="difflineplus">+      MimeMultipartAlternative_display_cached_part(obj, malt-&gt;buffered_hdrs[i],</span>
<a href="#l62.199"></a><span id="l62.199">                                                    malt-&gt;part_buffers[i],</span>
<a href="#l62.200"></a><span id="l62.200">                                                    do_display &amp;&amp; (i == 0));</span>
<a href="#l62.201"></a><span id="l62.201">       MimeHeaders_free(malt-&gt;buffered_hdrs[i]);</span>
<a href="#l62.202"></a><span id="l62.202">       MimePartBufferDestroy(malt-&gt;part_buffers[i]);</span>
<a href="#l62.203"></a><span id="l62.203">     }</span>
<a href="#l62.204"></a><span id="l62.204">     malt-&gt;pending_parts = 0;</span>
<a href="#l62.205"></a><span id="l62.205">   }</span>
<a href="#l62.206"></a><span id="l62.206">   return 0;</span>
<a href="#l62.207"></a><span id="l62.207"> }</span>
<a href="#l62.208"></a><span id="l62.208"> </span>
<a href="#l62.209"></a><span id="l62.209" class="difflineminus">-static int</span>
<a href="#l62.210"></a><span id="l62.210" class="difflineminus">-MimeMultipartAlternative_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l62.211"></a><span id="l62.211" class="difflineminus">-{</span>
<a href="#l62.212"></a><span id="l62.212" class="difflineplus">+static int MimeMultipartAlternative_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l62.213"></a><span id="l62.213">   int status = 0;</span>
<a href="#l62.214"></a><span id="l62.214"> </span>
<a href="#l62.215"></a><span id="l62.215">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l62.216"></a><span id="l62.216"> </span>
<a href="#l62.217"></a><span id="l62.217" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l62.218"></a><span id="l62.218" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l62.219"></a><span id="l62.219">   if (status &lt; 0) return status;</span>
<a href="#l62.220"></a><span id="l62.220"> </span>
<a href="#l62.221"></a><span id="l62.221" class="difflineminus">-</span>
<a href="#l62.222"></a><span id="l62.222">   status = MimeMultipartAlternative_flush_children(obj, true,</span>
<a href="#l62.223"></a><span id="l62.223">                                                    PRIORITY_UNDISPLAYABLE);</span>
<a href="#l62.224"></a><span id="l62.224" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l62.225"></a><span id="l62.225" class="difflineminus">-    return status;</span>
<a href="#l62.226"></a><span id="l62.226" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l62.227"></a><span id="l62.227"> </span>
<a href="#l62.228"></a><span id="l62.228">   MimeMultipartAlternative_cleanup(obj);</span>
<a href="#l62.229"></a><span id="l62.229"> </span>
<a href="#l62.230"></a><span id="l62.230">   return status;</span>
<a href="#l62.231"></a><span id="l62.231"> }</span>
<a href="#l62.232"></a><span id="l62.232"> </span>
<a href="#l62.233"></a><span id="l62.233" class="difflineminus">-</span>
<a href="#l62.234"></a><span id="l62.234" class="difflineminus">-static int</span>
<a href="#l62.235"></a><span id="l62.235" class="difflineminus">-MimeMultipartAlternative_create_child(MimeObject *obj)</span>
<a href="#l62.236"></a><span id="l62.236" class="difflineminus">-{</span>
<a href="#l62.237"></a><span id="l62.237" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) obj;</span>
<a href="#l62.238"></a><span id="l62.238" class="difflineminus">-  MimeMultipartAlternative *malt = (MimeMultipartAlternative *) obj;</span>
<a href="#l62.239"></a><span id="l62.239" class="difflineplus">+static int MimeMultipartAlternative_create_child(MimeObject *obj) {</span>
<a href="#l62.240"></a><span id="l62.240" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)obj;</span>
<a href="#l62.241"></a><span id="l62.241" class="difflineplus">+  MimeMultipartAlternative *malt = (MimeMultipartAlternative *)obj;</span>
<a href="#l62.242"></a><span id="l62.242"> </span>
<a href="#l62.243"></a><span id="l62.243">   priority_t priority =</span>
<a href="#l62.244"></a><span id="l62.244" class="difflineminus">-    MimeMultipartAlternative_display_part_p (obj, mult-&gt;hdrs);</span>
<a href="#l62.245"></a><span id="l62.245" class="difflineplus">+      MimeMultipartAlternative_display_part_p(obj, mult-&gt;hdrs);</span>
<a href="#l62.246"></a><span id="l62.246"> </span>
<a href="#l62.247"></a><span id="l62.247">   MimeMultipartAlternative_flush_children(obj, false, priority);</span>
<a href="#l62.248"></a><span id="l62.248"> </span>
<a href="#l62.249"></a><span id="l62.249">   mult-&gt;state = MimeMultipartPartFirstLine;</span>
<a href="#l62.250"></a><span id="l62.250">   int32_t i = malt-&gt;pending_parts++;</span>
<a href="#l62.251"></a><span id="l62.251"> </span>
<a href="#l62.252"></a><span id="l62.252" class="difflineminus">-  if (i==0) {</span>
<a href="#l62.253"></a><span id="l62.253" class="difflineplus">+  if (i == 0) {</span>
<a href="#l62.254"></a><span id="l62.254">     malt-&gt;buffered_priority = priority;</span>
<a href="#l62.255"></a><span id="l62.255">   }</span>
<a href="#l62.256"></a><span id="l62.256"> </span>
<a href="#l62.257"></a><span id="l62.257">   if (malt-&gt;pending_parts &gt; malt-&gt;max_parts) {</span>
<a href="#l62.258"></a><span id="l62.258">     malt-&gt;max_parts = malt-&gt;pending_parts;</span>
<a href="#l62.259"></a><span id="l62.259" class="difflineminus">-    MimeHeaders **newBuf = (MimeHeaders **)</span>
<a href="#l62.260"></a><span id="l62.260" class="difflineminus">-      PR_REALLOC(malt-&gt;buffered_hdrs,</span>
<a href="#l62.261"></a><span id="l62.261" class="difflineminus">-                 malt-&gt;max_parts * sizeof(*malt-&gt;buffered_hdrs));</span>
<a href="#l62.262"></a><span id="l62.262" class="difflineplus">+    MimeHeaders **newBuf = (MimeHeaders **)PR_REALLOC(</span>
<a href="#l62.263"></a><span id="l62.263" class="difflineplus">+        malt-&gt;buffered_hdrs, malt-&gt;max_parts * sizeof(*malt-&gt;buffered_hdrs));</span>
<a href="#l62.264"></a><span id="l62.264">     NS_ENSURE_TRUE(newBuf, MIME_OUT_OF_MEMORY);</span>
<a href="#l62.265"></a><span id="l62.265">     malt-&gt;buffered_hdrs = newBuf;</span>
<a href="#l62.266"></a><span id="l62.266"> </span>
<a href="#l62.267"></a><span id="l62.267" class="difflineminus">-    MimePartBufferData **newBuf2 = (MimePartBufferData **)</span>
<a href="#l62.268"></a><span id="l62.268" class="difflineminus">-      PR_REALLOC(malt-&gt;part_buffers,</span>
<a href="#l62.269"></a><span id="l62.269" class="difflineminus">-                 malt-&gt;max_parts * sizeof(*malt-&gt;part_buffers));</span>
<a href="#l62.270"></a><span id="l62.270" class="difflineplus">+    MimePartBufferData **newBuf2 = (MimePartBufferData **)PR_REALLOC(</span>
<a href="#l62.271"></a><span id="l62.271" class="difflineplus">+        malt-&gt;part_buffers, malt-&gt;max_parts * sizeof(*malt-&gt;part_buffers));</span>
<a href="#l62.272"></a><span id="l62.272">     NS_ENSURE_TRUE(newBuf2, MIME_OUT_OF_MEMORY);</span>
<a href="#l62.273"></a><span id="l62.273">     malt-&gt;part_buffers = newBuf2;</span>
<a href="#l62.274"></a><span id="l62.274">   }</span>
<a href="#l62.275"></a><span id="l62.275"> </span>
<a href="#l62.276"></a><span id="l62.276">   malt-&gt;buffered_hdrs[i] = MimeHeaders_copy(mult-&gt;hdrs);</span>
<a href="#l62.277"></a><span id="l62.277">   NS_ENSURE_TRUE(malt-&gt;buffered_hdrs[i], MIME_OUT_OF_MEMORY);</span>
<a href="#l62.278"></a><span id="l62.278"> </span>
<a href="#l62.279"></a><span id="l62.279">   malt-&gt;part_buffers[i] = MimePartBufferCreate();</span>
<a href="#l62.280"></a><span id="l62.280">   NS_ENSURE_TRUE(malt-&gt;part_buffers[i], MIME_OUT_OF_MEMORY);</span>
<a href="#l62.281"></a><span id="l62.281"> </span>
<a href="#l62.282"></a><span id="l62.282">   return 0;</span>
<a href="#l62.283"></a><span id="l62.283"> }</span>
<a href="#l62.284"></a><span id="l62.284"> </span>
<a href="#l62.285"></a><span id="l62.285" class="difflineplus">+static int MimeMultipartAlternative_parse_child_line(MimeObject *obj,</span>
<a href="#l62.286"></a><span id="l62.286" class="difflineplus">+                                                     const char *line,</span>
<a href="#l62.287"></a><span id="l62.287" class="difflineplus">+                                                     int32_t length,</span>
<a href="#l62.288"></a><span id="l62.288" class="difflineplus">+                                                     bool first_line_p) {</span>
<a href="#l62.289"></a><span id="l62.289" class="difflineplus">+  MimeMultipartAlternative *malt = (MimeMultipartAlternative *)obj;</span>
<a href="#l62.290"></a><span id="l62.290"> </span>
<a href="#l62.291"></a><span id="l62.291" class="difflineminus">-static int</span>
<a href="#l62.292"></a><span id="l62.292" class="difflineminus">-MimeMultipartAlternative_parse_child_line (MimeObject *obj,</span>
<a href="#l62.293"></a><span id="l62.293" class="difflineminus">-                       const char *line, int32_t length,</span>
<a href="#l62.294"></a><span id="l62.294" class="difflineminus">-                       bool first_line_p)</span>
<a href="#l62.295"></a><span id="l62.295" class="difflineminus">-{</span>
<a href="#l62.296"></a><span id="l62.296" class="difflineminus">-  MimeMultipartAlternative *malt = (MimeMultipartAlternative *) obj;</span>
<a href="#l62.297"></a><span id="l62.297" class="difflineminus">-</span>
<a href="#l62.298"></a><span id="l62.298" class="difflineminus">-  NS_ASSERTION(malt-&gt;pending_parts, &quot;should be pending parts, but there aren't&quot;);</span>
<a href="#l62.299"></a><span id="l62.299" class="difflineminus">-  if (!malt-&gt;pending_parts)</span>
<a href="#l62.300"></a><span id="l62.300" class="difflineminus">-    return -1;</span>
<a href="#l62.301"></a><span id="l62.301" class="difflineplus">+  NS_ASSERTION(malt-&gt;pending_parts,</span>
<a href="#l62.302"></a><span id="l62.302" class="difflineplus">+               &quot;should be pending parts, but there aren't&quot;);</span>
<a href="#l62.303"></a><span id="l62.303" class="difflineplus">+  if (!malt-&gt;pending_parts) return -1;</span>
<a href="#l62.304"></a><span id="l62.304">   int32_t i = malt-&gt;pending_parts - 1;</span>
<a href="#l62.305"></a><span id="l62.305"> </span>
<a href="#l62.306"></a><span id="l62.306">   /* Push this line into the buffer for later retrieval. */</span>
<a href="#l62.307"></a><span id="l62.307" class="difflineminus">-  return MimePartBufferWrite (malt-&gt;part_buffers[i], line, length);</span>
<a href="#l62.308"></a><span id="l62.308" class="difflineplus">+  return MimePartBufferWrite(malt-&gt;part_buffers[i], line, length);</span>
<a href="#l62.309"></a><span id="l62.309"> }</span>
<a href="#l62.310"></a><span id="l62.310"> </span>
<a href="#l62.311"></a><span id="l62.311" class="difflineminus">-</span>
<a href="#l62.312"></a><span id="l62.312" class="difflineminus">-static int</span>
<a href="#l62.313"></a><span id="l62.313" class="difflineminus">-MimeMultipartAlternative_close_child(MimeObject *obj)</span>
<a href="#l62.314"></a><span id="l62.314" class="difflineminus">-{</span>
<a href="#l62.315"></a><span id="l62.315" class="difflineminus">-  MimeMultipartAlternative *malt = (MimeMultipartAlternative *) obj;</span>
<a href="#l62.316"></a><span id="l62.316" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) obj;</span>
<a href="#l62.317"></a><span id="l62.317" class="difflineplus">+static int MimeMultipartAlternative_close_child(MimeObject *obj) {</span>
<a href="#l62.318"></a><span id="l62.318" class="difflineplus">+  MimeMultipartAlternative *malt = (MimeMultipartAlternative *)obj;</span>
<a href="#l62.319"></a><span id="l62.319" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)obj;</span>
<a href="#l62.320"></a><span id="l62.320"> </span>
<a href="#l62.321"></a><span id="l62.321">   /* PR_ASSERT(malt-&gt;part_buffer);      Some Mac brokenness trips this...</span>
<a href="#l62.322"></a><span id="l62.322">   if (!malt-&gt;part_buffer) return -1; */</span>
<a href="#l62.323"></a><span id="l62.323"> </span>
<a href="#l62.324"></a><span id="l62.324">   if (malt-&gt;pending_parts)</span>
<a href="#l62.325"></a><span id="l62.325" class="difflineminus">-    MimePartBufferClose(malt-&gt;part_buffers[malt-&gt;pending_parts-1]);</span>
<a href="#l62.326"></a><span id="l62.326" class="difflineplus">+    MimePartBufferClose(malt-&gt;part_buffers[malt-&gt;pending_parts - 1]);</span>
<a href="#l62.327"></a><span id="l62.327"> </span>
<a href="#l62.328"></a><span id="l62.328">   /* PR_ASSERT(mult-&gt;hdrs);         I expect the Mac trips this too */</span>
<a href="#l62.329"></a><span id="l62.329"> </span>
<a href="#l62.330"></a><span id="l62.330">   if (mult-&gt;hdrs) {</span>
<a href="#l62.331"></a><span id="l62.331">     MimeHeaders_free(mult-&gt;hdrs);</span>
<a href="#l62.332"></a><span id="l62.332">     mult-&gt;hdrs = 0;</span>
<a href="#l62.333"></a><span id="l62.333">   }</span>
<a href="#l62.334"></a><span id="l62.334"> </span>
<a href="#l62.335"></a><span id="l62.335">   return 0;</span>
<a href="#l62.336"></a><span id="l62.336"> }</span>
<a href="#l62.337"></a><span id="l62.337"> </span>
<a href="#l62.338"></a><span id="l62.338" class="difflineminus">-</span>
<a href="#l62.339"></a><span id="l62.339" class="difflineminus">-static priority_t</span>
<a href="#l62.340"></a><span id="l62.340" class="difflineminus">-MimeMultipartAlternative_display_part_p(MimeObject *self,</span>
<a href="#l62.341"></a><span id="l62.341" class="difflineminus">-                    MimeHeaders *sub_hdrs)</span>
<a href="#l62.342"></a><span id="l62.342" class="difflineminus">-{</span>
<a href="#l62.343"></a><span id="l62.343" class="difflineplus">+static priority_t MimeMultipartAlternative_display_part_p(</span>
<a href="#l62.344"></a><span id="l62.344" class="difflineplus">+    MimeObject *self, MimeHeaders *sub_hdrs) {</span>
<a href="#l62.345"></a><span id="l62.345">   priority_t priority = PRIORITY_UNDISPLAYABLE;</span>
<a href="#l62.346"></a><span id="l62.346" class="difflineminus">-  char *ct = MimeHeaders_get (sub_hdrs, HEADER_CONTENT_TYPE, true, false);</span>
<a href="#l62.347"></a><span id="l62.347" class="difflineminus">-  if (!ct)</span>
<a href="#l62.348"></a><span id="l62.348" class="difflineminus">-    return priority;</span>
<a href="#l62.349"></a><span id="l62.349" class="difflineplus">+  char *ct = MimeHeaders_get(sub_hdrs, HEADER_CONTENT_TYPE, true, false);</span>
<a href="#l62.350"></a><span id="l62.350" class="difflineplus">+  if (!ct) return priority;</span>
<a href="#l62.351"></a><span id="l62.351"> </span>
<a href="#l62.352"></a><span id="l62.352">   /* RFC 1521 says:</span>
<a href="#l62.353"></a><span id="l62.353">      Receiving user agents should pick and display the last format</span>
<a href="#l62.354"></a><span id="l62.354">      they are capable of displaying.  In the case where one of the</span>
<a href="#l62.355"></a><span id="l62.355">      alternatives is itself of type &quot;multipart&quot; and contains unrecognized</span>
<a href="#l62.356"></a><span id="l62.356">      sub-parts, the user agent may choose either to show that alternative,</span>
<a href="#l62.357"></a><span id="l62.357">      an earlier alternative, or both.</span>
<a href="#l62.358"></a><span id="l62.358">    */</span>
<a href="#l62.359"></a><span id="l62.359" class="difflineat">@@ -386,50 +351,49 @@ MimeMultipartAlternative_display_part_p(</span>
<a href="#l62.360"></a><span id="l62.360">   if (clazz &amp;&amp; clazz-&gt;displayable_inline_p(clazz, sub_hdrs)) {</span>
<a href="#l62.361"></a><span id="l62.361">     // prefer_plaintext pref</span>
<a href="#l62.362"></a><span id="l62.362">     bool prefer_plaintext = false;</span>
<a href="#l62.363"></a><span id="l62.363">     nsIPrefBranch *prefBranch = GetPrefBranch(self-&gt;options);</span>
<a href="#l62.364"></a><span id="l62.364">     if (prefBranch) {</span>
<a href="#l62.365"></a><span id="l62.365">       prefBranch-&gt;GetBoolPref(&quot;mailnews.display.prefer_plaintext&quot;,</span>
<a href="#l62.366"></a><span id="l62.366">                               &amp;prefer_plaintext);</span>
<a href="#l62.367"></a><span id="l62.367">     }</span>
<a href="#l62.368"></a><span id="l62.368" class="difflineminus">-    prefer_plaintext = prefer_plaintext &amp;&amp;</span>
<a href="#l62.369"></a><span id="l62.369" class="difflineminus">-           (self-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageSaveAs) &amp;&amp;</span>
<a href="#l62.370"></a><span id="l62.370" class="difflineminus">-           (self-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageRaw);</span>
<a href="#l62.371"></a><span id="l62.371" class="difflineplus">+    prefer_plaintext =</span>
<a href="#l62.372"></a><span id="l62.372" class="difflineplus">+        prefer_plaintext &amp;&amp;</span>
<a href="#l62.373"></a><span id="l62.373" class="difflineplus">+        (self-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageSaveAs) &amp;&amp;</span>
<a href="#l62.374"></a><span id="l62.374" class="difflineplus">+        (self-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageRaw);</span>
<a href="#l62.375"></a><span id="l62.375"> </span>
<a href="#l62.376"></a><span id="l62.376">     priority = MimeMultipartAlternative_prioritize_part(ct, prefer_plaintext);</span>
<a href="#l62.377"></a><span id="l62.377">   }</span>
<a href="#l62.378"></a><span id="l62.378"> </span>
<a href="#l62.379"></a><span id="l62.379">   PR_FREEIF(ct);</span>
<a href="#l62.380"></a><span id="l62.380">   return priority;</span>
<a href="#l62.381"></a><span id="l62.381"> }</span>
<a href="#l62.382"></a><span id="l62.382"> </span>
<a href="#l62.383"></a><span id="l62.383"> /**</span>
<a href="#l62.384"></a><span id="l62.384" class="difflineminus">-* RFC 1521 says we should display the last format we are capable of displaying.</span>
<a href="#l62.385"></a><span id="l62.385" class="difflineminus">-* But for various reasons (mainly to improve the user experience) we choose</span>
<a href="#l62.386"></a><span id="l62.386" class="difflineminus">-* to ignore that in some cases, and rather pick one that we prioritize.</span>
<a href="#l62.387"></a><span id="l62.387" class="difflineminus">-*/</span>
<a href="#l62.388"></a><span id="l62.388" class="difflineminus">-static priority_t</span>
<a href="#l62.389"></a><span id="l62.389" class="difflineminus">-MimeMultipartAlternative_prioritize_part(char *content_type,</span>
<a href="#l62.390"></a><span id="l62.390" class="difflineminus">-                                         bool prefer_plaintext)</span>
<a href="#l62.391"></a><span id="l62.391" class="difflineminus">-{</span>
<a href="#l62.392"></a><span id="l62.392" class="difflineplus">+ * RFC 1521 says we should display the last format we are capable of displaying.</span>
<a href="#l62.393"></a><span id="l62.393" class="difflineplus">+ * But for various reasons (mainly to improve the user experience) we choose</span>
<a href="#l62.394"></a><span id="l62.394" class="difflineplus">+ * to ignore that in some cases, and rather pick one that we prioritize.</span>
<a href="#l62.395"></a><span id="l62.395" class="difflineplus">+ */</span>
<a href="#l62.396"></a><span id="l62.396" class="difflineplus">+static priority_t MimeMultipartAlternative_prioritize_part(</span>
<a href="#l62.397"></a><span id="l62.397" class="difflineplus">+    char *content_type, bool prefer_plaintext) {</span>
<a href="#l62.398"></a><span id="l62.398">   /*</span>
<a href="#l62.399"></a><span id="l62.399">    * PRIORITY_NORMAL is the priority of text/html, multipart/..., etc. that</span>
<a href="#l62.400"></a><span id="l62.400">    * we normally display. We should try to have as few exceptions from</span>
<a href="#l62.401"></a><span id="l62.401">    * PRIORITY_NORMAL as possible</span>
<a href="#l62.402"></a><span id="l62.402">    */</span>
<a href="#l62.403"></a><span id="l62.403"> </span>
<a href="#l62.404"></a><span id="l62.404">   /* (with no / in the type) */</span>
<a href="#l62.405"></a><span id="l62.405">   if (!PL_strcasecmp(content_type, &quot;text&quot;)) {</span>
<a href="#l62.406"></a><span id="l62.406">     if (prefer_plaintext) {</span>
<a href="#l62.407"></a><span id="l62.407" class="difflineminus">-       /* When in plain text view, a plain text part is what we want. */</span>
<a href="#l62.408"></a><span id="l62.408" class="difflineminus">-       return PRIORITY_HIGH;</span>
<a href="#l62.409"></a><span id="l62.409" class="difflineplus">+      /* When in plain text view, a plain text part is what we want. */</span>
<a href="#l62.410"></a><span id="l62.410" class="difflineplus">+      return PRIORITY_HIGH;</span>
<a href="#l62.411"></a><span id="l62.411">     }</span>
<a href="#l62.412"></a><span id="l62.412">     /* We normally prefer other parts over the unspecified text type. */</span>
<a href="#l62.413"></a><span id="l62.413" class="difflineminus">-    return  PRIORITY_TEXT_UNKNOWN;</span>
<a href="#l62.414"></a><span id="l62.414" class="difflineplus">+    return PRIORITY_TEXT_UNKNOWN;</span>
<a href="#l62.415"></a><span id="l62.415">   }</span>
<a href="#l62.416"></a><span id="l62.416"> </span>
<a href="#l62.417"></a><span id="l62.417">   if (!PL_strncasecmp(content_type, &quot;text/&quot;, 5)) {</span>
<a href="#l62.418"></a><span id="l62.418">     char *text_type = content_type + 5;</span>
<a href="#l62.419"></a><span id="l62.419"> </span>
<a href="#l62.420"></a><span id="l62.420">     if (!PL_strncasecmp(text_type, &quot;plain&quot;, 5)) {</span>
<a href="#l62.421"></a><span id="l62.421">       if (prefer_plaintext) {</span>
<a href="#l62.422"></a><span id="l62.422">         /* When in plain text view,</span>
<a href="#l62.423"></a><span id="l62.423" class="difflineat">@@ -447,17 +411,18 @@ MimeMultipartAlternative_prioritize_part</span>
<a href="#l62.424"></a><span id="l62.424">     if (!PL_strncasecmp(text_type, &quot;calendar&quot;, 8) &amp;&amp; prefer_plaintext) {</span>
<a href="#l62.425"></a><span id="l62.425">       /*</span>
<a href="#l62.426"></a><span id="l62.426">        * text/calendar receives an equally high priority so an invitation</span>
<a href="#l62.427"></a><span id="l62.427">        * shows even in plaintext mode.</span>
<a href="#l62.428"></a><span id="l62.428">        */</span>
<a href="#l62.429"></a><span id="l62.429">       return PRIORITY_HIGHEST;</span>
<a href="#l62.430"></a><span id="l62.430">     }</span>
<a href="#l62.431"></a><span id="l62.431"> </span>
<a href="#l62.432"></a><span id="l62.432" class="difflineminus">-    /* Need to white-list all text/... types that are or could be implemented. */</span>
<a href="#l62.433"></a><span id="l62.433" class="difflineplus">+    /* Need to white-list all text/... types that are or could be implemented.</span>
<a href="#l62.434"></a><span id="l62.434" class="difflineplus">+     */</span>
<a href="#l62.435"></a><span id="l62.435">     if (!PL_strncasecmp(text_type, &quot;html&quot;, 4) ||</span>
<a href="#l62.436"></a><span id="l62.436">         !PL_strncasecmp(text_type, &quot;enriched&quot;, 8) ||</span>
<a href="#l62.437"></a><span id="l62.437">         !PL_strncasecmp(text_type, &quot;richtext&quot;, 8) ||</span>
<a href="#l62.438"></a><span id="l62.438">         !PL_strncasecmp(text_type, &quot;calendar&quot;, 8) ||</span>
<a href="#l62.439"></a><span id="l62.439">         !PL_strncasecmp(text_type, &quot;rtf&quot;, 3)) {</span>
<a href="#l62.440"></a><span id="l62.440">       return PRIORITY_NORMAL;</span>
<a href="#l62.441"></a><span id="l62.441">     }</span>
<a href="#l62.442"></a><span id="l62.442"> </span>
<a href="#l62.443"></a><span id="l62.443" class="difflineat">@@ -472,109 +437,103 @@ MimeMultipartAlternative_prioritize_part</span>
<a href="#l62.444"></a><span id="l62.444">       return PRIORITY_UNDISPLAYABLE;</span>
<a href="#l62.445"></a><span id="l62.445">     else</span>
<a href="#l62.446"></a><span id="l62.446">       return PRIORITY_LOW;</span>
<a href="#l62.447"></a><span id="l62.447">   }</span>
<a href="#l62.448"></a><span id="l62.448"> </span>
<a href="#l62.449"></a><span id="l62.449">   return PRIORITY_NORMAL;</span>
<a href="#l62.450"></a><span id="l62.450"> }</span>
<a href="#l62.451"></a><span id="l62.451"> </span>
<a href="#l62.452"></a><span id="l62.452" class="difflineminus">-static int</span>
<a href="#l62.453"></a><span id="l62.453" class="difflineminus">-MimeMultipartAlternative_display_cached_part(MimeObject *obj,</span>
<a href="#l62.454"></a><span id="l62.454" class="difflineminus">-                                             MimeHeaders *hdrs,</span>
<a href="#l62.455"></a><span id="l62.455" class="difflineminus">-                                             MimePartBufferData *buffer,</span>
<a href="#l62.456"></a><span id="l62.456" class="difflineminus">-                                             bool do_display)</span>
<a href="#l62.457"></a><span id="l62.457" class="difflineminus">-{</span>
<a href="#l62.458"></a><span id="l62.458" class="difflineplus">+static int MimeMultipartAlternative_display_cached_part(</span>
<a href="#l62.459"></a><span id="l62.459" class="difflineplus">+    MimeObject *obj, MimeHeaders *hdrs, MimePartBufferData *buffer,</span>
<a href="#l62.460"></a><span id="l62.460" class="difflineplus">+    bool do_display) {</span>
<a href="#l62.461"></a><span id="l62.461">   int status;</span>
<a href="#l62.462"></a><span id="l62.462">   bool old_options_no_output_p;</span>
<a href="#l62.463"></a><span id="l62.463"> </span>
<a href="#l62.464"></a><span id="l62.464" class="difflineminus">-  char *ct = (hdrs</span>
<a href="#l62.465"></a><span id="l62.465" class="difflineminus">-        ? MimeHeaders_get (hdrs, HEADER_CONTENT_TYPE, true, false)</span>
<a href="#l62.466"></a><span id="l62.466" class="difflineminus">-        : 0);</span>
<a href="#l62.467"></a><span id="l62.467" class="difflineminus">-  const char *dct = (((MimeMultipartClass *) obj-&gt;clazz)-&gt;default_part_type);</span>
<a href="#l62.468"></a><span id="l62.468" class="difflineplus">+  char *ct =</span>
<a href="#l62.469"></a><span id="l62.469" class="difflineplus">+      (hdrs ? MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, true, false) : 0);</span>
<a href="#l62.470"></a><span id="l62.470" class="difflineplus">+  const char *dct = (((MimeMultipartClass *)obj-&gt;clazz)-&gt;default_part_type);</span>
<a href="#l62.471"></a><span id="l62.471">   MimeObject *body;</span>
<a href="#l62.472"></a><span id="l62.472">   /** Don't pass in NULL as the content-type (this means that the</span>
<a href="#l62.473"></a><span id="l62.473">    * auto-uudecode-hack won't ever be done for subparts of a</span>
<a href="#l62.474"></a><span id="l62.474">    * multipart, but only for untyped children of message/rfc822.</span>
<a href="#l62.475"></a><span id="l62.475">    */</span>
<a href="#l62.476"></a><span id="l62.476" class="difflineminus">-  const char *uct = (ct &amp;&amp; *ct) ? ct : (dct ? dct: TEXT_PLAIN);</span>
<a href="#l62.477"></a><span id="l62.477" class="difflineplus">+  const char *uct = (ct &amp;&amp; *ct) ? ct : (dct ? dct : TEXT_PLAIN);</span>
<a href="#l62.478"></a><span id="l62.478"> </span>
<a href="#l62.479"></a><span id="l62.479">   // We always want to display the cached part inline.</span>
<a href="#l62.480"></a><span id="l62.480">   body = mime_create(uct, hdrs, obj-&gt;options, true);</span>
<a href="#l62.481"></a><span id="l62.481">   PR_FREEIF(ct);</span>
<a href="#l62.482"></a><span id="l62.482">   if (!body) return MIME_OUT_OF_MEMORY;</span>
<a href="#l62.483"></a><span id="l62.483">   body-&gt;output_p = do_display;</span>
<a href="#l62.484"></a><span id="l62.484"> </span>
<a href="#l62.485"></a><span id="l62.485" class="difflineminus">-  status = ((MimeContainerClass *) obj-&gt;clazz)-&gt;add_child(obj, body);</span>
<a href="#l62.486"></a><span id="l62.486" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l62.487"></a><span id="l62.487" class="difflineminus">-  {</span>
<a href="#l62.488"></a><span id="l62.488" class="difflineplus">+  status = ((MimeContainerClass *)obj-&gt;clazz)-&gt;add_child(obj, body);</span>
<a href="#l62.489"></a><span id="l62.489" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l62.490"></a><span id="l62.490">     mime_free(body);</span>
<a href="#l62.491"></a><span id="l62.491">     return status;</span>
<a href="#l62.492"></a><span id="l62.492">   }</span>
<a href="#l62.493"></a><span id="l62.493">   /* add_child assigns body-&gt;options from obj-&gt;options, but that's</span>
<a href="#l62.494"></a><span id="l62.494">      just a pointer so if we muck with it in the child it'll modify</span>
<a href="#l62.495"></a><span id="l62.495">      the parent as well, which we definitely don't want. Therefore we</span>
<a href="#l62.496"></a><span id="l62.496">      need to make a copy of the old value and restore it later. */</span>
<a href="#l62.497"></a><span id="l62.497">   old_options_no_output_p = obj-&gt;options-&gt;no_output_p;</span>
<a href="#l62.498"></a><span id="l62.498" class="difflineminus">-  if (! do_display)</span>
<a href="#l62.499"></a><span id="l62.499" class="difflineminus">-    body-&gt;options-&gt;no_output_p = true;</span>
<a href="#l62.500"></a><span id="l62.500" class="difflineplus">+  if (!do_display) body-&gt;options-&gt;no_output_p = true;</span>
<a href="#l62.501"></a><span id="l62.501"> </span>
<a href="#l62.502"></a><span id="l62.502"> #ifdef MIME_DRAFTS</span>
<a href="#l62.503"></a><span id="l62.503">   /* if this object is a child of a multipart/related object, the parent is</span>
<a href="#l62.504"></a><span id="l62.504" class="difflineminus">-     taking care of decomposing the whole part, don't need to do it at this level.</span>
<a href="#l62.505"></a><span id="l62.505" class="difflineminus">-     However, we still have to call decompose_file_init_fn and decompose_file_close_fn</span>
<a href="#l62.506"></a><span id="l62.506" class="difflineminus">-     in order to set the correct content-type. But don't call MimePartBufferRead</span>
<a href="#l62.507"></a><span id="l62.507" class="difflineplus">+     taking care of decomposing the whole part, don't need to do it at this</span>
<a href="#l62.508"></a><span id="l62.508" class="difflineplus">+     level. However, we still have to call decompose_file_init_fn and</span>
<a href="#l62.509"></a><span id="l62.509" class="difflineplus">+     decompose_file_close_fn in order to set the correct content-type. But don't</span>
<a href="#l62.510"></a><span id="l62.510" class="difflineplus">+     call MimePartBufferRead</span>
<a href="#l62.511"></a><span id="l62.511">   */</span>
<a href="#l62.512"></a><span id="l62.512" class="difflineminus">-  bool multipartRelatedChild = mime_typep(obj-&gt;parent,(MimeObjectClass*)&amp;mimeMultipartRelatedClass);</span>
<a href="#l62.513"></a><span id="l62.513" class="difflineminus">-  bool decomposeFile = do_display &amp;&amp; obj-&gt;options &amp;&amp;</span>
<a href="#l62.514"></a><span id="l62.514" class="difflineminus">-                  obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l62.515"></a><span id="l62.515" class="difflineminus">-                  obj-&gt;options-&gt;decompose_file_init_fn &amp;&amp;</span>
<a href="#l62.516"></a><span id="l62.516" class="difflineminus">-                  !mime_typep(body, (MimeObjectClass *) &amp;mimeMultipartClass);</span>
<a href="#l62.517"></a><span id="l62.517" class="difflineplus">+  bool multipartRelatedChild =</span>
<a href="#l62.518"></a><span id="l62.518" class="difflineplus">+      mime_typep(obj-&gt;parent, (MimeObjectClass *)&amp;mimeMultipartRelatedClass);</span>
<a href="#l62.519"></a><span id="l62.519" class="difflineplus">+  bool decomposeFile =</span>
<a href="#l62.520"></a><span id="l62.520" class="difflineplus">+      do_display &amp;&amp; obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l62.521"></a><span id="l62.521" class="difflineplus">+      obj-&gt;options-&gt;decompose_file_init_fn &amp;&amp;</span>
<a href="#l62.522"></a><span id="l62.522" class="difflineplus">+      !mime_typep(body, (MimeObjectClass *)&amp;mimeMultipartClass);</span>
<a href="#l62.523"></a><span id="l62.523"> </span>
<a href="#l62.524"></a><span id="l62.524" class="difflineminus">-  if (decomposeFile)</span>
<a href="#l62.525"></a><span id="l62.525" class="difflineminus">-  {</span>
<a href="#l62.526"></a><span id="l62.526" class="difflineminus">-    status = obj-&gt;options-&gt;decompose_file_init_fn (</span>
<a href="#l62.527"></a><span id="l62.527" class="difflineminus">-                        obj-&gt;options-&gt;stream_closure, hdrs);</span>
<a href="#l62.528"></a><span id="l62.528" class="difflineplus">+  if (decomposeFile) {</span>
<a href="#l62.529"></a><span id="l62.529" class="difflineplus">+    status = obj-&gt;options-&gt;decompose_file_init_fn(obj-&gt;options-&gt;stream_closure,</span>
<a href="#l62.530"></a><span id="l62.530" class="difflineplus">+                                                  hdrs);</span>
<a href="#l62.531"></a><span id="l62.531">     if (status &lt; 0) return status;</span>
<a href="#l62.532"></a><span id="l62.532">   }</span>
<a href="#l62.533"></a><span id="l62.533"> #endif /* MIME_DRAFTS */</span>
<a href="#l62.534"></a><span id="l62.534"> </span>
<a href="#l62.535"></a><span id="l62.535">   /* Now that we've added this new object to our list of children,</span>
<a href="#l62.536"></a><span id="l62.536">    notify emitters and start its parser going. */</span>
<a href="#l62.537"></a><span id="l62.537">   MimeMultipart_notify_emitter(body);</span>
<a href="#l62.538"></a><span id="l62.538"> </span>
<a href="#l62.539"></a><span id="l62.539">   status = body-&gt;clazz-&gt;parse_begin(body);</span>
<a href="#l62.540"></a><span id="l62.540">   if (status &lt; 0) return status;</span>
<a href="#l62.541"></a><span id="l62.541"> </span>
<a href="#l62.542"></a><span id="l62.542"> #ifdef MIME_DRAFTS</span>
<a href="#l62.543"></a><span id="l62.543">   if (decomposeFile &amp;&amp; !multipartRelatedChild)</span>
<a href="#l62.544"></a><span id="l62.544" class="difflineminus">-    status = MimePartBufferRead (buffer,</span>
<a href="#l62.545"></a><span id="l62.545" class="difflineminus">-                  obj-&gt;options-&gt;decompose_file_output_fn,</span>
<a href="#l62.546"></a><span id="l62.546" class="difflineminus">-                  obj-&gt;options-&gt;stream_closure);</span>
<a href="#l62.547"></a><span id="l62.547" class="difflineplus">+    status = MimePartBufferRead(buffer, obj-&gt;options-&gt;decompose_file_output_fn,</span>
<a href="#l62.548"></a><span id="l62.548" class="difflineplus">+                                obj-&gt;options-&gt;stream_closure);</span>
<a href="#l62.549"></a><span id="l62.549">   else</span>
<a href="#l62.550"></a><span id="l62.550"> #endif /* MIME_DRAFTS */</span>
<a href="#l62.551"></a><span id="l62.551"> </span>
<a href="#l62.552"></a><span id="l62.552" class="difflineminus">-  status = MimePartBufferRead (buffer,</span>
<a href="#l62.553"></a><span id="l62.553" class="difflineminus">-                  /* The MimeConverterOutputCallback cast is to turn the</span>
<a href="#l62.554"></a><span id="l62.554" class="difflineminus">-                   `void' argument into `MimeObject'. */</span>
<a href="#l62.555"></a><span id="l62.555" class="difflineminus">-                  ((MimeConverterOutputCallback) body-&gt;clazz-&gt;parse_buffer),</span>
<a href="#l62.556"></a><span id="l62.556" class="difflineminus">-                  body);</span>
<a href="#l62.557"></a><span id="l62.557" class="difflineplus">+    status = MimePartBufferRead(</span>
<a href="#l62.558"></a><span id="l62.558" class="difflineplus">+        buffer,</span>
<a href="#l62.559"></a><span id="l62.559" class="difflineplus">+        /* The MimeConverterOutputCallback cast is to turn the</span>
<a href="#l62.560"></a><span id="l62.560" class="difflineplus">+         `void' argument into `MimeObject'. */</span>
<a href="#l62.561"></a><span id="l62.561" class="difflineplus">+        ((MimeConverterOutputCallback)body-&gt;clazz-&gt;parse_buffer), body);</span>
<a href="#l62.562"></a><span id="l62.562"> </span>
<a href="#l62.563"></a><span id="l62.563">   if (status &lt; 0) return status;</span>
<a href="#l62.564"></a><span id="l62.564"> </span>
<a href="#l62.565"></a><span id="l62.565">   /* Done parsing. */</span>
<a href="#l62.566"></a><span id="l62.566">   status = body-&gt;clazz-&gt;parse_eof(body, false);</span>
<a href="#l62.567"></a><span id="l62.567">   if (status &lt; 0) return status;</span>
<a href="#l62.568"></a><span id="l62.568">   status = body-&gt;clazz-&gt;parse_end(body, false);</span>
<a href="#l62.569"></a><span id="l62.569">   if (status &lt; 0) return status;</span>
<a href="#l62.570"></a><span id="l62.570"> </span>
<a href="#l62.571"></a><span id="l62.571"> #ifdef MIME_DRAFTS</span>
<a href="#l62.572"></a><span id="l62.572" class="difflineminus">-  if (decomposeFile)</span>
<a href="#l62.573"></a><span id="l62.573" class="difflineminus">-  {</span>
<a href="#l62.574"></a><span id="l62.574" class="difflineminus">-    status = obj-&gt;options-&gt;decompose_file_close_fn ( obj-&gt;options-&gt;stream_closure );</span>
<a href="#l62.575"></a><span id="l62.575" class="difflineplus">+  if (decomposeFile) {</span>
<a href="#l62.576"></a><span id="l62.576" class="difflineplus">+    status =</span>
<a href="#l62.577"></a><span id="l62.577" class="difflineplus">+        obj-&gt;options-&gt;decompose_file_close_fn(obj-&gt;options-&gt;stream_closure);</span>
<a href="#l62.578"></a><span id="l62.578">     if (status &lt; 0) return status;</span>
<a href="#l62.579"></a><span id="l62.579">   }</span>
<a href="#l62.580"></a><span id="l62.580"> #endif /* MIME_DRAFTS */</span>
<a href="#l62.581"></a><span id="l62.581"> </span>
<a href="#l62.582"></a><span id="l62.582">   /* Restore options to what parent classes expects. */</span>
<a href="#l62.583"></a><span id="l62.583">   obj-&gt;options-&gt;no_output_p = old_options_no_output_p;</span>
<a href="#l62.584"></a><span id="l62.584"> </span>
<a href="#l62.585"></a><span id="l62.585">   return 0;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/mime/src/mimemalt.h</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/mime/src/mimemalt.h</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -10,39 +10,41 @@</span>
<a href="#l63.4"></a><span id="l63.4"> #include &quot;mimepbuf.h&quot;</span>
<a href="#l63.5"></a><span id="l63.5"> </span>
<a href="#l63.6"></a><span id="l63.6"> /* The MimeMultipartAlternative class implements the multipart/alternative</span>
<a href="#l63.7"></a><span id="l63.7">    MIME container, which displays only one (the `best') of a set of enclosed</span>
<a href="#l63.8"></a><span id="l63.8">    documents.</span>
<a href="#l63.9"></a><span id="l63.9">  */</span>
<a href="#l63.10"></a><span id="l63.10"> </span>
<a href="#l63.11"></a><span id="l63.11"> typedef struct MimeMultipartAlternativeClass MimeMultipartAlternativeClass;</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-typedef struct MimeMultipartAlternative      MimeMultipartAlternative;</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+typedef struct MimeMultipartAlternative MimeMultipartAlternative;</span>
<a href="#l63.14"></a><span id="l63.14"> </span>
<a href="#l63.15"></a><span id="l63.15"> struct MimeMultipartAlternativeClass {</span>
<a href="#l63.16"></a><span id="l63.16">   MimeMultipartClass multipart;</span>
<a href="#l63.17"></a><span id="l63.17"> };</span>
<a href="#l63.18"></a><span id="l63.18"> </span>
<a href="#l63.19"></a><span id="l63.19"> extern &quot;C&quot; MimeMultipartAlternativeClass mimeMultipartAlternativeClass;</span>
<a href="#l63.20"></a><span id="l63.20"> </span>
<a href="#l63.21"></a><span id="l63.21" class="difflineminus">-enum priority_t {PRIORITY_UNDISPLAYABLE,</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineminus">-                 PRIORITY_LOW,</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineminus">-                 PRIORITY_TEXT_UNKNOWN,</span>
<a href="#l63.24"></a><span id="l63.24" class="difflineminus">-                 PRIORITY_TEXT_PLAIN,</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineminus">-                 PRIORITY_NORMAL,</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineminus">-                 PRIORITY_HIGH,</span>
<a href="#l63.27"></a><span id="l63.27" class="difflineminus">-                 PRIORITY_HIGHEST};</span>
<a href="#l63.28"></a><span id="l63.28" class="difflineplus">+enum priority_t {</span>
<a href="#l63.29"></a><span id="l63.29" class="difflineplus">+  PRIORITY_UNDISPLAYABLE,</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineplus">+  PRIORITY_LOW,</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineplus">+  PRIORITY_TEXT_UNKNOWN,</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineplus">+  PRIORITY_TEXT_PLAIN,</span>
<a href="#l63.33"></a><span id="l63.33" class="difflineplus">+  PRIORITY_NORMAL,</span>
<a href="#l63.34"></a><span id="l63.34" class="difflineplus">+  PRIORITY_HIGH,</span>
<a href="#l63.35"></a><span id="l63.35" class="difflineplus">+  PRIORITY_HIGHEST</span>
<a href="#l63.36"></a><span id="l63.36" class="difflineplus">+};</span>
<a href="#l63.37"></a><span id="l63.37"> </span>
<a href="#l63.38"></a><span id="l63.38"> struct MimeMultipartAlternative {</span>
<a href="#l63.39"></a><span id="l63.39" class="difflineminus">-  MimeMultipart multipart;      /* superclass variables */</span>
<a href="#l63.40"></a><span id="l63.40" class="difflineplus">+  MimeMultipart multipart; /* superclass variables */</span>
<a href="#l63.41"></a><span id="l63.41"> </span>
<a href="#l63.42"></a><span id="l63.42" class="difflineminus">-  MimeHeaders **buffered_hdrs;    /* The headers of pending parts */</span>
<a href="#l63.43"></a><span id="l63.43" class="difflineminus">-  MimePartBufferData **part_buffers;  /* The data of pending parts</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineminus">-                                         (see mimepbuf.h) */</span>
<a href="#l63.45"></a><span id="l63.45" class="difflineplus">+  MimeHeaders **buffered_hdrs;       /* The headers of pending parts */</span>
<a href="#l63.46"></a><span id="l63.46" class="difflineplus">+  MimePartBufferData **part_buffers; /* The data of pending parts</span>
<a href="#l63.47"></a><span id="l63.47" class="difflineplus">+                                        (see mimepbuf.h) */</span>
<a href="#l63.48"></a><span id="l63.48">   int32_t pending_parts;</span>
<a href="#l63.49"></a><span id="l63.49">   int32_t max_parts;</span>
<a href="#l63.50"></a><span id="l63.50">   priority_t buffered_priority; /* Priority of head of pending parts */</span>
<a href="#l63.51"></a><span id="l63.51"> };</span>
<a href="#l63.52"></a><span id="l63.52"> </span>
<a href="#l63.53"></a><span id="l63.53" class="difflineminus">-#define MimeMultipartAlternativeClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l63.54"></a><span id="l63.54" class="difflineminus">-  { MimeMultipartClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l63.55"></a><span id="l63.55" class="difflineplus">+#define MimeMultipartAlternativeClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l63.56"></a><span id="l63.56" class="difflineplus">+  { MimeMultipartClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l63.57"></a><span id="l63.57"> </span>
<a href="#l63.58"></a><span id="l63.58"> #endif /* _MIMEMALT_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/mime/src/mimemapl.cpp</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/mime/src/mimemapl.cpp</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -8,181 +8,166 @@</span>
<a href="#l64.4"></a><span id="l64.4"> #include &quot;prmem.h&quot;</span>
<a href="#l64.5"></a><span id="l64.5"> #include &quot;plstr.h&quot;</span>
<a href="#l64.6"></a><span id="l64.6"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l64.7"></a><span id="l64.7"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l64.8"></a><span id="l64.8"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l64.9"></a><span id="l64.9"> </span>
<a href="#l64.10"></a><span id="l64.10"> #define MIME_SUPERCLASS mimeMultipartClass</span>
<a href="#l64.11"></a><span id="l64.11"> MimeDefClass(MimeMultipartAppleDouble, MimeMultipartAppleDoubleClass,</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-       mimeMultipartAppleDoubleClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+             mimeMultipartAppleDoubleClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l64.14"></a><span id="l64.14"> </span>
<a href="#l64.15"></a><span id="l64.15" class="difflineminus">-static int MimeMultipartAppleDouble_parse_begin (MimeObject *);</span>
<a href="#l64.16"></a><span id="l64.16" class="difflineminus">-static bool MimeMultipartAppleDouble_output_child_p(MimeObject *,</span>
<a href="#l64.17"></a><span id="l64.17" class="difflineminus">-                             MimeObject *);</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineplus">+static int MimeMultipartAppleDouble_parse_begin(MimeObject *);</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineplus">+static bool MimeMultipartAppleDouble_output_child_p(MimeObject *, MimeObject *);</span>
<a href="#l64.20"></a><span id="l64.20"> </span>
<a href="#l64.21"></a><span id="l64.21" class="difflineminus">-static int</span>
<a href="#l64.22"></a><span id="l64.22" class="difflineminus">-MimeMultipartAppleDoubleClassInitialize(MimeMultipartAppleDoubleClass *clazz)</span>
<a href="#l64.23"></a><span id="l64.23" class="difflineminus">-{</span>
<a href="#l64.24"></a><span id="l64.24" class="difflineminus">-  MimeObjectClass    *oclass = (MimeObjectClass *)    clazz;</span>
<a href="#l64.25"></a><span id="l64.25" class="difflineminus">-  MimeMultipartClass *mclass = (MimeMultipartClass *) clazz;</span>
<a href="#l64.26"></a><span id="l64.26" class="difflineplus">+static int MimeMultipartAppleDoubleClassInitialize(</span>
<a href="#l64.27"></a><span id="l64.27" class="difflineplus">+    MimeMultipartAppleDoubleClass *clazz) {</span>
<a href="#l64.28"></a><span id="l64.28" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineplus">+  MimeMultipartClass *mclass = (MimeMultipartClass *)clazz;</span>
<a href="#l64.30"></a><span id="l64.30"> </span>
<a href="#l64.31"></a><span id="l64.31">   NS_ASSERTION(!oclass-&gt;class_initialized, &quot;mime class not initialized&quot;);</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineminus">-  oclass-&gt;parse_begin    = MimeMultipartAppleDouble_parse_begin;</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineplus">+  oclass-&gt;parse_begin = MimeMultipartAppleDouble_parse_begin;</span>
<a href="#l64.34"></a><span id="l64.34">   mclass-&gt;output_child_p = MimeMultipartAppleDouble_output_child_p;</span>
<a href="#l64.35"></a><span id="l64.35">   return 0;</span>
<a href="#l64.36"></a><span id="l64.36"> }</span>
<a href="#l64.37"></a><span id="l64.37"> </span>
<a href="#l64.38"></a><span id="l64.38" class="difflineminus">-static int</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineminus">-MimeMultipartAppleDouble_parse_begin (MimeObject *obj)</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineminus">-{</span>
<a href="#l64.41"></a><span id="l64.41" class="difflineplus">+static int MimeMultipartAppleDouble_parse_begin(MimeObject *obj) {</span>
<a href="#l64.42"></a><span id="l64.42">   /* #### This method is identical to MimeExternalObject_parse_begin</span>
<a href="#l64.43"></a><span id="l64.43">    which kinda s#$%s...</span>
<a href="#l64.44"></a><span id="l64.44">    */</span>
<a href="#l64.45"></a><span id="l64.45">   int status;</span>
<a href="#l64.46"></a><span id="l64.46"> </span>
<a href="#l64.47"></a><span id="l64.47" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l64.48"></a><span id="l64.48" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l64.49"></a><span id="l64.49">   if (status &lt; 0) return status;</span>
<a href="#l64.50"></a><span id="l64.50"> </span>
<a href="#l64.51"></a><span id="l64.51">   /* If we're writing this object, and we're doing it in raw form, then</span>
<a href="#l64.52"></a><span id="l64.52">    now is the time to inform the backend what the type of this data is.</span>
<a href="#l64.53"></a><span id="l64.53">    */</span>
<a href="#l64.54"></a><span id="l64.54" class="difflineminus">-  if (obj-&gt;output_p &amp;&amp;</span>
<a href="#l64.55"></a><span id="l64.55" class="difflineminus">-    obj-&gt;options &amp;&amp;</span>
<a href="#l64.56"></a><span id="l64.56" class="difflineminus">-    !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l64.57"></a><span id="l64.57" class="difflineminus">-    !obj-&gt;options-&gt;state-&gt;first_data_written_p)</span>
<a href="#l64.58"></a><span id="l64.58" class="difflineminus">-  {</span>
<a href="#l64.59"></a><span id="l64.59" class="difflineplus">+  if (obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l64.60"></a><span id="l64.60" class="difflineplus">+      !obj-&gt;options-&gt;state-&gt;first_data_written_p) {</span>
<a href="#l64.61"></a><span id="l64.61">     status = MimeObject_output_init(obj, 0);</span>
<a href="#l64.62"></a><span id="l64.62">     if (status &lt; 0) return status;</span>
<a href="#l64.63"></a><span id="l64.63" class="difflineminus">-    NS_ASSERTION(obj-&gt;options-&gt;state-&gt;first_data_written_p, &quot;first data not written&quot;);</span>
<a href="#l64.64"></a><span id="l64.64" class="difflineplus">+    NS_ASSERTION(obj-&gt;options-&gt;state-&gt;first_data_written_p,</span>
<a href="#l64.65"></a><span id="l64.65" class="difflineplus">+                 &quot;first data not written&quot;);</span>
<a href="#l64.66"></a><span id="l64.66">   }</span>
<a href="#l64.67"></a><span id="l64.67"> </span>
<a href="#l64.68"></a><span id="l64.68"> #ifdef XP_MACOSX</span>
<a href="#l64.69"></a><span id="l64.69" class="difflineminus">-  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state)</span>
<a href="#l64.70"></a><span id="l64.70" class="difflineminus">-  {</span>
<a href="#l64.71"></a><span id="l64.71" class="difflineminus">-//  obj-&gt;options-&gt;state-&gt;separator_suppressed_p = true;</span>
<a href="#l64.72"></a><span id="l64.72" class="difflineminus">-  goto done;</span>
<a href="#l64.73"></a><span id="l64.73" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state) {</span>
<a href="#l64.74"></a><span id="l64.74" class="difflineplus">+    //  obj-&gt;options-&gt;state-&gt;separator_suppressed_p = true;</span>
<a href="#l64.75"></a><span id="l64.75" class="difflineplus">+    goto done;</span>
<a href="#l64.76"></a><span id="l64.76">   }</span>
<a href="#l64.77"></a><span id="l64.77">   /*</span>
<a href="#l64.78"></a><span id="l64.78">    * It would be nice to not showing the resource fork links</span>
<a href="#l64.79"></a><span id="l64.79">    * if we are displaying inline. But, there is no way we could</span>
<a href="#l64.80"></a><span id="l64.80">    * know ahead of time that we could display the data fork and</span>
<a href="#l64.81"></a><span id="l64.81">    * the data fork is always hidden on MAC platform.</span>
<a href="#l64.82"></a><span id="l64.82">    */</span>
<a href="#l64.83"></a><span id="l64.83"> #endif</span>
<a href="#l64.84"></a><span id="l64.84">   /* If we're writing this object as HTML, then emit a link for the</span>
<a href="#l64.85"></a><span id="l64.85">    multipart/appledouble part (both links) that looks just like the</span>
<a href="#l64.86"></a><span id="l64.86">    links that MimeExternalObject emits for external leaf parts.</span>
<a href="#l64.87"></a><span id="l64.87">    */</span>
<a href="#l64.88"></a><span id="l64.88" class="difflineminus">-  if (obj-&gt;options &amp;&amp;</span>
<a href="#l64.89"></a><span id="l64.89" class="difflineminus">-    obj-&gt;output_p &amp;&amp;</span>
<a href="#l64.90"></a><span id="l64.90" class="difflineminus">-    obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l64.91"></a><span id="l64.91" class="difflineminus">-    obj-&gt;options-&gt;output_fn)</span>
<a href="#l64.92"></a><span id="l64.92" class="difflineminus">-  {</span>
<a href="#l64.93"></a><span id="l64.93" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;output_p &amp;&amp; obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l64.94"></a><span id="l64.94" class="difflineplus">+      obj-&gt;options-&gt;output_fn) {</span>
<a href="#l64.95"></a><span id="l64.95">     char *id = 0;</span>
<a href="#l64.96"></a><span id="l64.96">     char *id_url = 0;</span>
<a href="#l64.97"></a><span id="l64.97">     char *id_imap = 0;</span>
<a href="#l64.98"></a><span id="l64.98"> </span>
<a href="#l64.99"></a><span id="l64.99" class="difflineminus">-    id = mime_part_address (obj);</span>
<a href="#l64.100"></a><span id="l64.100" class="difflineminus">-    if (! id) return MIME_OUT_OF_MEMORY;</span>
<a href="#l64.101"></a><span id="l64.101" class="difflineminus">-    if (obj-&gt;options-&gt;missing_parts)</span>
<a href="#l64.102"></a><span id="l64.102" class="difflineminus">-    id_imap = mime_imap_part_address (obj);</span>
<a href="#l64.103"></a><span id="l64.103" class="difflineplus">+    id = mime_part_address(obj);</span>
<a href="#l64.104"></a><span id="l64.104" class="difflineplus">+    if (!id) return MIME_OUT_OF_MEMORY;</span>
<a href="#l64.105"></a><span id="l64.105" class="difflineplus">+    if (obj-&gt;options-&gt;missing_parts) id_imap = mime_imap_part_address(obj);</span>
<a href="#l64.106"></a><span id="l64.106"> </span>
<a href="#l64.107"></a><span id="l64.107" class="difflineminus">-      if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;url)</span>
<a href="#l64.108"></a><span id="l64.108" class="difflineminus">-    {</span>
<a href="#l64.109"></a><span id="l64.109" class="difflineplus">+    if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;url) {</span>
<a href="#l64.110"></a><span id="l64.110">       const char *url = obj-&gt;options-&gt;url;</span>
<a href="#l64.111"></a><span id="l64.111" class="difflineminus">-      if (id_imap &amp;&amp; id)</span>
<a href="#l64.112"></a><span id="l64.112" class="difflineminus">-      {</span>
<a href="#l64.113"></a><span id="l64.113" class="difflineminus">-      /* if this is an IMAP part. */</span>
<a href="#l64.114"></a><span id="l64.114" class="difflineminus">-      id_url = mime_set_url_imap_part(url, id_imap, id);</span>
<a href="#l64.115"></a><span id="l64.115" class="difflineplus">+      if (id_imap &amp;&amp; id) {</span>
<a href="#l64.116"></a><span id="l64.116" class="difflineplus">+        /* if this is an IMAP part. */</span>
<a href="#l64.117"></a><span id="l64.117" class="difflineplus">+        id_url = mime_set_url_imap_part(url, id_imap, id);</span>
<a href="#l64.118"></a><span id="l64.118" class="difflineplus">+      } else {</span>
<a href="#l64.119"></a><span id="l64.119" class="difflineplus">+        /* This is just a normal MIME part as usual. */</span>
<a href="#l64.120"></a><span id="l64.120" class="difflineplus">+        id_url = mime_set_url_part(url, id, true);</span>
<a href="#l64.121"></a><span id="l64.121">       }</span>
<a href="#l64.122"></a><span id="l64.122" class="difflineminus">-      else</span>
<a href="#l64.123"></a><span id="l64.123" class="difflineminus">-      {</span>
<a href="#l64.124"></a><span id="l64.124" class="difflineminus">-      /* This is just a normal MIME part as usual. */</span>
<a href="#l64.125"></a><span id="l64.125" class="difflineminus">-      id_url = mime_set_url_part(url, id, true);</span>
<a href="#l64.126"></a><span id="l64.126" class="difflineminus">-      }</span>
<a href="#l64.127"></a><span id="l64.127" class="difflineminus">-      if (!id_url)</span>
<a href="#l64.128"></a><span id="l64.128" class="difflineminus">-      {</span>
<a href="#l64.129"></a><span id="l64.129" class="difflineplus">+      if (!id_url) {</span>
<a href="#l64.130"></a><span id="l64.130">         PR_Free(id);</span>
<a href="#l64.131"></a><span id="l64.131">         return MIME_OUT_OF_MEMORY;</span>
<a href="#l64.132"></a><span id="l64.132">       }</span>
<a href="#l64.133"></a><span id="l64.133">     }</span>
<a href="#l64.134"></a><span id="l64.134"> </span>
<a href="#l64.135"></a><span id="l64.135" class="difflineminus">-/**********************</span>
<a href="#l64.136"></a><span id="l64.136" class="difflineminus">-    if (!strcmp (id, &quot;0&quot;))</span>
<a href="#l64.137"></a><span id="l64.137" class="difflineminus">-    {</span>
<a href="#l64.138"></a><span id="l64.138" class="difflineminus">-      PR_Free(id);</span>
<a href="#l64.139"></a><span id="l64.139" class="difflineminus">-      id = MimeGetStringByID(MIME_MSG_ATTACHMENT);</span>
<a href="#l64.140"></a><span id="l64.140" class="difflineminus">-    }</span>
<a href="#l64.141"></a><span id="l64.141" class="difflineminus">-    else</span>
<a href="#l64.142"></a><span id="l64.142" class="difflineminus">-    {</span>
<a href="#l64.143"></a><span id="l64.143" class="difflineminus">-      const char *p = &quot;Part &quot;;</span>
<a href="#l64.144"></a><span id="l64.144" class="difflineminus">-      char *s = (char *)PR_MALLOC(strlen(p) + strlen(id) + 1);</span>
<a href="#l64.145"></a><span id="l64.145" class="difflineminus">-      if (!s)</span>
<a href="#l64.146"></a><span id="l64.146" class="difflineminus">-      {</span>
<a href="#l64.147"></a><span id="l64.147" class="difflineminus">-        PR_Free(id);</span>
<a href="#l64.148"></a><span id="l64.148" class="difflineminus">-        PR_Free(id_url);</span>
<a href="#l64.149"></a><span id="l64.149" class="difflineminus">-        return MIME_OUT_OF_MEMORY;</span>
<a href="#l64.150"></a><span id="l64.150" class="difflineminus">-      }</span>
<a href="#l64.151"></a><span id="l64.151" class="difflineminus">-      PL_strcpy(s, p);</span>
<a href="#l64.152"></a><span id="l64.152" class="difflineminus">-      PL_strcat(s, id);</span>
<a href="#l64.153"></a><span id="l64.153" class="difflineminus">-      PR_Free(id);</span>
<a href="#l64.154"></a><span id="l64.154" class="difflineminus">-      id = s;</span>
<a href="#l64.155"></a><span id="l64.155" class="difflineminus">-    }</span>
<a href="#l64.156"></a><span id="l64.156" class="difflineplus">+    /**********************</span>
<a href="#l64.157"></a><span id="l64.157" class="difflineplus">+        if (!strcmp (id, &quot;0&quot;))</span>
<a href="#l64.158"></a><span id="l64.158" class="difflineplus">+        {</span>
<a href="#l64.159"></a><span id="l64.159" class="difflineplus">+          PR_Free(id);</span>
<a href="#l64.160"></a><span id="l64.160" class="difflineplus">+          id = MimeGetStringByID(MIME_MSG_ATTACHMENT);</span>
<a href="#l64.161"></a><span id="l64.161" class="difflineplus">+        }</span>
<a href="#l64.162"></a><span id="l64.162" class="difflineplus">+        else</span>
<a href="#l64.163"></a><span id="l64.163" class="difflineplus">+        {</span>
<a href="#l64.164"></a><span id="l64.164" class="difflineplus">+          const char *p = &quot;Part &quot;;</span>
<a href="#l64.165"></a><span id="l64.165" class="difflineplus">+          char *s = (char *)PR_MALLOC(strlen(p) + strlen(id) + 1);</span>
<a href="#l64.166"></a><span id="l64.166" class="difflineplus">+          if (!s)</span>
<a href="#l64.167"></a><span id="l64.167" class="difflineplus">+          {</span>
<a href="#l64.168"></a><span id="l64.168" class="difflineplus">+            PR_Free(id);</span>
<a href="#l64.169"></a><span id="l64.169" class="difflineplus">+            PR_Free(id_url);</span>
<a href="#l64.170"></a><span id="l64.170" class="difflineplus">+            return MIME_OUT_OF_MEMORY;</span>
<a href="#l64.171"></a><span id="l64.171" class="difflineplus">+          }</span>
<a href="#l64.172"></a><span id="l64.172" class="difflineplus">+          PL_strcpy(s, p);</span>
<a href="#l64.173"></a><span id="l64.173" class="difflineplus">+          PL_strcat(s, id);</span>
<a href="#l64.174"></a><span id="l64.174" class="difflineplus">+          PR_Free(id);</span>
<a href="#l64.175"></a><span id="l64.175" class="difflineplus">+          id = s;</span>
<a href="#l64.176"></a><span id="l64.176" class="difflineplus">+        }</span>
<a href="#l64.177"></a><span id="l64.177"> </span>
<a href="#l64.178"></a><span id="l64.178" class="difflineminus">-    if (all_headers_p &amp;&amp;</span>
<a href="#l64.179"></a><span id="l64.179" class="difflineminus">-      // Don't bother showing all headers on this part if it's the only</span>
<a href="#l64.180"></a><span id="l64.180" class="difflineminus">-      // part in the message: in that case, we've already shown these</span>
<a href="#l64.181"></a><span id="l64.181" class="difflineminus">-      // headers.</span>
<a href="#l64.182"></a><span id="l64.182" class="difflineminus">-      obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l64.183"></a><span id="l64.183" class="difflineminus">-      obj-&gt;options-&gt;state-&gt;root == obj-&gt;parent)</span>
<a href="#l64.184"></a><span id="l64.184" class="difflineminus">-    all_headers_p = false;</span>
<a href="#l64.185"></a><span id="l64.185" class="difflineplus">+        if (all_headers_p &amp;&amp;</span>
<a href="#l64.186"></a><span id="l64.186" class="difflineplus">+          // Don't bother showing all headers on this part if it's the only</span>
<a href="#l64.187"></a><span id="l64.187" class="difflineplus">+          // part in the message: in that case, we've already shown these</span>
<a href="#l64.188"></a><span id="l64.188" class="difflineplus">+          // headers.</span>
<a href="#l64.189"></a><span id="l64.189" class="difflineplus">+          obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l64.190"></a><span id="l64.190" class="difflineplus">+          obj-&gt;options-&gt;state-&gt;root == obj-&gt;parent)</span>
<a href="#l64.191"></a><span id="l64.191" class="difflineplus">+        all_headers_p = false;</span>
<a href="#l64.192"></a><span id="l64.192"> </span>
<a href="#l64.193"></a><span id="l64.193" class="difflineminus">-    newopt.fancy_headers_p = true;</span>
<a href="#l64.194"></a><span id="l64.194" class="difflineminus">-    newopt.headers = (all_headers_p ? MimeHeadersAll : MimeHeadersSome);</span>
<a href="#l64.195"></a><span id="l64.195" class="difflineplus">+        newopt.fancy_headers_p = true;</span>
<a href="#l64.196"></a><span id="l64.196" class="difflineplus">+        newopt.headers = (all_headers_p ? MimeHeadersAll : MimeHeadersSome);</span>
<a href="#l64.197"></a><span id="l64.197"> </span>
<a href="#l64.198"></a><span id="l64.198" class="difflineminus">-//</span>
<a href="#l64.199"></a><span id="l64.199" class="difflineminus">-RICHIE SHERRY</span>
<a href="#l64.200"></a><span id="l64.200" class="difflineminus">-GOTTA STILL DO THIS FOR QUOTING!</span>
<a href="#l64.201"></a><span id="l64.201" class="difflineminus">-     status = MimeHeaders_write_attachment_box (obj-&gt;headers, &amp;newopt,</span>
<a href="#l64.202"></a><span id="l64.202" class="difflineminus">-                                                 obj-&gt;content_type,</span>
<a href="#l64.203"></a><span id="l64.203" class="difflineminus">-                                                 obj-&gt;encoding,</span>
<a href="#l64.204"></a><span id="l64.204" class="difflineminus">-                                                 id_name? id_name : id, id_url, 0</span>
<a href="#l64.205"></a><span id="l64.205" class="difflineminus">-//</span>
<a href="#l64.206"></a><span id="l64.206" class="difflineminus">-*********************************************************************************/</span>
<a href="#l64.207"></a><span id="l64.207" class="difflineplus">+    //</span>
<a href="#l64.208"></a><span id="l64.208" class="difflineplus">+    RICHIE SHERRY</span>
<a href="#l64.209"></a><span id="l64.209" class="difflineplus">+    GOTTA STILL DO THIS FOR QUOTING!</span>
<a href="#l64.210"></a><span id="l64.210" class="difflineplus">+         status = MimeHeaders_write_attachment_box (obj-&gt;headers, &amp;newopt,</span>
<a href="#l64.211"></a><span id="l64.211" class="difflineplus">+                                                     obj-&gt;content_type,</span>
<a href="#l64.212"></a><span id="l64.212" class="difflineplus">+                                                     obj-&gt;encoding,</span>
<a href="#l64.213"></a><span id="l64.213" class="difflineplus">+                                                     id_name? id_name : id,</span>
<a href="#l64.214"></a><span id="l64.214" class="difflineplus">+    id_url, 0</span>
<a href="#l64.215"></a><span id="l64.215" class="difflineplus">+    //</span>
<a href="#l64.216"></a><span id="l64.216" class="difflineplus">+    *********************************************************************************/</span>
<a href="#l64.217"></a><span id="l64.217"> </span>
<a href="#l64.218"></a><span id="l64.218" class="difflineminus">-//  FAIL:</span>
<a href="#l64.219"></a><span id="l64.219" class="difflineplus">+    //  FAIL:</span>
<a href="#l64.220"></a><span id="l64.220">     PR_FREEIF(id);</span>
<a href="#l64.221"></a><span id="l64.221">     PR_FREEIF(id_url);</span>
<a href="#l64.222"></a><span id="l64.222">     PR_FREEIF(id_imap);</span>
<a href="#l64.223"></a><span id="l64.223">     if (status &lt; 0) return status;</span>
<a href="#l64.224"></a><span id="l64.224">   }</span>
<a href="#l64.225"></a><span id="l64.225"> </span>
<a href="#l64.226"></a><span id="l64.226"> #ifdef XP_MACOSX</span>
<a href="#l64.227"></a><span id="l64.227"> done:</span>
<a href="#l64.228"></a><span id="l64.228"> #endif</span>
<a href="#l64.229"></a><span id="l64.229"> </span>
<a href="#l64.230"></a><span id="l64.230">   return 0;</span>
<a href="#l64.231"></a><span id="l64.231"> }</span>
<a href="#l64.232"></a><span id="l64.232"> </span>
<a href="#l64.233"></a><span id="l64.233" class="difflineminus">-static bool</span>
<a href="#l64.234"></a><span id="l64.234" class="difflineminus">-MimeMultipartAppleDouble_output_child_p(MimeObject *obj, MimeObject *child)</span>
<a href="#l64.235"></a><span id="l64.235" class="difflineminus">-{</span>
<a href="#l64.236"></a><span id="l64.236" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) obj;</span>
<a href="#l64.237"></a><span id="l64.237" class="difflineplus">+static bool MimeMultipartAppleDouble_output_child_p(MimeObject *obj,</span>
<a href="#l64.238"></a><span id="l64.238" class="difflineplus">+                                                    MimeObject *child) {</span>
<a href="#l64.239"></a><span id="l64.239" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l64.240"></a><span id="l64.240"> </span>
<a href="#l64.241"></a><span id="l64.241">   /* If this is the first child, and it's an application/applefile, then</span>
<a href="#l64.242"></a><span id="l64.242">    don't emit a link for it.  (There *should* be only two children, and</span>
<a href="#l64.243"></a><span id="l64.243">    the first one should always be an application/applefile.)</span>
<a href="#l64.244"></a><span id="l64.244">    */</span>
<a href="#l64.245"></a><span id="l64.245"> </span>
<a href="#l64.246"></a><span id="l64.246" class="difflineminus">-  if (cont-&gt;nchildren &gt;= 1 &amp;&amp; cont-&gt;children[0] == child &amp;&amp; child-&gt;content_type &amp;&amp;</span>
<a href="#l64.247"></a><span id="l64.247" class="difflineminus">-      !PL_strcasecmp(child-&gt;content_type, APPLICATION_APPLEFILE))</span>
<a href="#l64.248"></a><span id="l64.248" class="difflineminus">-  {</span>
<a href="#l64.249"></a><span id="l64.249" class="difflineplus">+  if (cont-&gt;nchildren &gt;= 1 &amp;&amp; cont-&gt;children[0] == child &amp;&amp;</span>
<a href="#l64.250"></a><span id="l64.250" class="difflineplus">+      child-&gt;content_type &amp;&amp;</span>
<a href="#l64.251"></a><span id="l64.251" class="difflineplus">+      !PL_strcasecmp(child-&gt;content_type, APPLICATION_APPLEFILE)) {</span>
<a href="#l64.252"></a><span id="l64.252"> #ifdef XP_MACOSX</span>
<a href="#l64.253"></a><span id="l64.253" class="difflineminus">-    if (obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; obj-&gt;options-&gt;write_html_p) //output HTML</span>
<a href="#l64.254"></a><span id="l64.254" class="difflineplus">+    if (obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp;</span>
<a href="#l64.255"></a><span id="l64.255" class="difflineplus">+        obj-&gt;options-&gt;write_html_p)  // output HTML</span>
<a href="#l64.256"></a><span id="l64.256">       return false;</span>
<a href="#l64.257"></a><span id="l64.257"> #else</span>
<a href="#l64.258"></a><span id="l64.258">     /* if we are not on a Macintosh, don't emitte the resources fork at all. */</span>
<a href="#l64.259"></a><span id="l64.259">     return false;</span>
<a href="#l64.260"></a><span id="l64.260"> #endif</span>
<a href="#l64.261"></a><span id="l64.261">   }</span>
<a href="#l64.262"></a><span id="l64.262"> </span>
<a href="#l64.263"></a><span id="l64.263">   return true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/mime/src/mimemapl.h</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/mime/src/mimemapl.h</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -9,24 +9,24 @@</span>
<a href="#l65.4"></a><span id="l65.4"> #include &quot;mimemult.h&quot;</span>
<a href="#l65.5"></a><span id="l65.5"> </span>
<a href="#l65.6"></a><span id="l65.6"> /* The MimeMultipartAppleDouble class implements the multipart/appledouble</span>
<a href="#l65.7"></a><span id="l65.7">    MIME container, which provides a method of encapsulating and reconstructing</span>
<a href="#l65.8"></a><span id="l65.8">    a two-forked Macintosh file.</span>
<a href="#l65.9"></a><span id="l65.9">  */</span>
<a href="#l65.10"></a><span id="l65.10"> </span>
<a href="#l65.11"></a><span id="l65.11"> typedef struct MimeMultipartAppleDoubleClass MimeMultipartAppleDoubleClass;</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-typedef struct MimeMultipartAppleDouble      MimeMultipartAppleDouble;</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+typedef struct MimeMultipartAppleDouble MimeMultipartAppleDouble;</span>
<a href="#l65.14"></a><span id="l65.14"> </span>
<a href="#l65.15"></a><span id="l65.15"> struct MimeMultipartAppleDoubleClass {</span>
<a href="#l65.16"></a><span id="l65.16">   MimeMultipartClass multipart;</span>
<a href="#l65.17"></a><span id="l65.17"> };</span>
<a href="#l65.18"></a><span id="l65.18"> </span>
<a href="#l65.19"></a><span id="l65.19"> extern MimeMultipartAppleDoubleClass mimeMultipartAppleDoubleClass;</span>
<a href="#l65.20"></a><span id="l65.20"> </span>
<a href="#l65.21"></a><span id="l65.21"> struct MimeMultipartAppleDouble {</span>
<a href="#l65.22"></a><span id="l65.22">   MimeMultipart multipart;</span>
<a href="#l65.23"></a><span id="l65.23"> };</span>
<a href="#l65.24"></a><span id="l65.24"> </span>
<a href="#l65.25"></a><span id="l65.25" class="difflineminus">-#define MimeMultipartAppleDoubleClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l65.26"></a><span id="l65.26" class="difflineminus">-  { MimeMultipartClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l65.27"></a><span id="l65.27" class="difflineplus">+#define MimeMultipartAppleDoubleClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l65.28"></a><span id="l65.28" class="difflineplus">+  { MimeMultipartClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l65.29"></a><span id="l65.29"> </span>
<a href="#l65.30"></a><span id="l65.30"> #endif /* _MIMEMAPL_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/mime/src/mimemcms.cpp</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/mime/src/mimemcms.cpp</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -21,357 +21,325 @@</span>
<a href="#l66.4"></a><span id="l66.4"> #include &quot;nsIMsgSMIMEHeaderSink.h&quot;</span>
<a href="#l66.5"></a><span id="l66.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l66.6"></a><span id="l66.6"> #include &quot;nsIX509Cert.h&quot;</span>
<a href="#l66.7"></a><span id="l66.7"> #include &quot;plstr.h&quot;</span>
<a href="#l66.8"></a><span id="l66.8"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l66.9"></a><span id="l66.9"> </span>
<a href="#l66.10"></a><span id="l66.10"> #define MIME_SUPERCLASS mimeMultipartSignedClass</span>
<a href="#l66.11"></a><span id="l66.11"> MimeDefClass(MimeMultipartSignedCMS, MimeMultipartSignedCMSClass,</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-       mimeMultipartSignedCMSClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+             mimeMultipartSignedCMSClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l66.14"></a><span id="l66.14"> </span>
<a href="#l66.15"></a><span id="l66.15" class="difflineminus">-static int MimeMultipartSignedCMS_initialize (MimeObject *);</span>
<a href="#l66.16"></a><span id="l66.16" class="difflineplus">+static int MimeMultipartSignedCMS_initialize(MimeObject *);</span>
<a href="#l66.17"></a><span id="l66.17"> </span>
<a href="#l66.18"></a><span id="l66.18" class="difflineminus">-static void *MimeMultCMS_init (MimeObject *);</span>
<a href="#l66.19"></a><span id="l66.19" class="difflineminus">-static int MimeMultCMS_data_hash (const char *, int32_t, void *);</span>
<a href="#l66.20"></a><span id="l66.20" class="difflineminus">-static int MimeMultCMS_sig_hash  (const char *, int32_t, void *);</span>
<a href="#l66.21"></a><span id="l66.21" class="difflineminus">-static int MimeMultCMS_data_eof (void *, bool);</span>
<a href="#l66.22"></a><span id="l66.22" class="difflineminus">-static int MimeMultCMS_sig_eof  (void *, bool);</span>
<a href="#l66.23"></a><span id="l66.23" class="difflineminus">-static int MimeMultCMS_sig_init (void *, MimeObject *, MimeHeaders *);</span>
<a href="#l66.24"></a><span id="l66.24" class="difflineminus">-static char * MimeMultCMS_generate (void *);</span>
<a href="#l66.25"></a><span id="l66.25" class="difflineminus">-static void MimeMultCMS_free (void *);</span>
<a href="#l66.26"></a><span id="l66.26" class="difflineplus">+static void *MimeMultCMS_init(MimeObject *);</span>
<a href="#l66.27"></a><span id="l66.27" class="difflineplus">+static int MimeMultCMS_data_hash(const char *, int32_t, void *);</span>
<a href="#l66.28"></a><span id="l66.28" class="difflineplus">+static int MimeMultCMS_sig_hash(const char *, int32_t, void *);</span>
<a href="#l66.29"></a><span id="l66.29" class="difflineplus">+static int MimeMultCMS_data_eof(void *, bool);</span>
<a href="#l66.30"></a><span id="l66.30" class="difflineplus">+static int MimeMultCMS_sig_eof(void *, bool);</span>
<a href="#l66.31"></a><span id="l66.31" class="difflineplus">+static int MimeMultCMS_sig_init(void *, MimeObject *, MimeHeaders *);</span>
<a href="#l66.32"></a><span id="l66.32" class="difflineplus">+static char *MimeMultCMS_generate(void *);</span>
<a href="#l66.33"></a><span id="l66.33" class="difflineplus">+static void MimeMultCMS_free(void *);</span>
<a href="#l66.34"></a><span id="l66.34"> </span>
<a href="#l66.35"></a><span id="l66.35"> extern int SEC_ERROR_CERT_ADDR_MISMATCH;</span>
<a href="#l66.36"></a><span id="l66.36"> </span>
<a href="#l66.37"></a><span id="l66.37" class="difflineminus">-static int</span>
<a href="#l66.38"></a><span id="l66.38" class="difflineminus">-MimeMultipartSignedCMSClassInitialize(MimeMultipartSignedCMSClass *clazz)</span>
<a href="#l66.39"></a><span id="l66.39" class="difflineminus">-{</span>
<a href="#l66.40"></a><span id="l66.40" class="difflineminus">-  MimeObjectClass          *oclass = (MimeObjectClass *)    clazz;</span>
<a href="#l66.41"></a><span id="l66.41" class="difflineminus">-  MimeMultipartSignedClass *sclass = (MimeMultipartSignedClass *) clazz;</span>
<a href="#l66.42"></a><span id="l66.42" class="difflineplus">+static int MimeMultipartSignedCMSClassInitialize(</span>
<a href="#l66.43"></a><span id="l66.43" class="difflineplus">+    MimeMultipartSignedCMSClass *clazz) {</span>
<a href="#l66.44"></a><span id="l66.44" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l66.45"></a><span id="l66.45" class="difflineplus">+  MimeMultipartSignedClass *sclass = (MimeMultipartSignedClass *)clazz;</span>
<a href="#l66.46"></a><span id="l66.46"> </span>
<a href="#l66.47"></a><span id="l66.47" class="difflineminus">-  oclass-&gt;initialize  = MimeMultipartSignedCMS_initialize;</span>
<a href="#l66.48"></a><span id="l66.48" class="difflineplus">+  oclass-&gt;initialize = MimeMultipartSignedCMS_initialize;</span>
<a href="#l66.49"></a><span id="l66.49"> </span>
<a href="#l66.50"></a><span id="l66.50" class="difflineminus">-  sclass-&gt;crypto_init           = MimeMultCMS_init;</span>
<a href="#l66.51"></a><span id="l66.51" class="difflineminus">-  sclass-&gt;crypto_data_hash      = MimeMultCMS_data_hash;</span>
<a href="#l66.52"></a><span id="l66.52" class="difflineminus">-  sclass-&gt;crypto_data_eof       = MimeMultCMS_data_eof;</span>
<a href="#l66.53"></a><span id="l66.53" class="difflineplus">+  sclass-&gt;crypto_init = MimeMultCMS_init;</span>
<a href="#l66.54"></a><span id="l66.54" class="difflineplus">+  sclass-&gt;crypto_data_hash = MimeMultCMS_data_hash;</span>
<a href="#l66.55"></a><span id="l66.55" class="difflineplus">+  sclass-&gt;crypto_data_eof = MimeMultCMS_data_eof;</span>
<a href="#l66.56"></a><span id="l66.56">   sclass-&gt;crypto_signature_init = MimeMultCMS_sig_init;</span>
<a href="#l66.57"></a><span id="l66.57">   sclass-&gt;crypto_signature_hash = MimeMultCMS_sig_hash;</span>
<a href="#l66.58"></a><span id="l66.58" class="difflineminus">-  sclass-&gt;crypto_signature_eof  = MimeMultCMS_sig_eof;</span>
<a href="#l66.59"></a><span id="l66.59" class="difflineminus">-  sclass-&gt;crypto_generate_html  = MimeMultCMS_generate;</span>
<a href="#l66.60"></a><span id="l66.60" class="difflineminus">-  sclass-&gt;crypto_free           = MimeMultCMS_free;</span>
<a href="#l66.61"></a><span id="l66.61" class="difflineplus">+  sclass-&gt;crypto_signature_eof = MimeMultCMS_sig_eof;</span>
<a href="#l66.62"></a><span id="l66.62" class="difflineplus">+  sclass-&gt;crypto_generate_html = MimeMultCMS_generate;</span>
<a href="#l66.63"></a><span id="l66.63" class="difflineplus">+  sclass-&gt;crypto_free = MimeMultCMS_free;</span>
<a href="#l66.64"></a><span id="l66.64"> </span>
<a href="#l66.65"></a><span id="l66.65">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l66.66"></a><span id="l66.66">   return 0;</span>
<a href="#l66.67"></a><span id="l66.67"> }</span>
<a href="#l66.68"></a><span id="l66.68"> </span>
<a href="#l66.69"></a><span id="l66.69" class="difflineminus">-static int</span>
<a href="#l66.70"></a><span id="l66.70" class="difflineminus">-MimeMultipartSignedCMS_initialize (MimeObject *object)</span>
<a href="#l66.71"></a><span id="l66.71" class="difflineminus">-{</span>
<a href="#l66.72"></a><span id="l66.72" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l66.73"></a><span id="l66.73" class="difflineplus">+static int MimeMultipartSignedCMS_initialize(MimeObject *object) {</span>
<a href="#l66.74"></a><span id="l66.74" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l66.75"></a><span id="l66.75"> }</span>
<a href="#l66.76"></a><span id="l66.76"> </span>
<a href="#l66.77"></a><span id="l66.77" class="difflineminus">-</span>
<a href="#l66.78"></a><span id="l66.78" class="difflineminus">-typedef struct MimeMultCMSdata</span>
<a href="#l66.79"></a><span id="l66.79" class="difflineminus">-{</span>
<a href="#l66.80"></a><span id="l66.80" class="difflineplus">+typedef struct MimeMultCMSdata {</span>
<a href="#l66.81"></a><span id="l66.81">   int16_t hash_type;</span>
<a href="#l66.82"></a><span id="l66.82">   nsCOMPtr&lt;nsICryptoHash&gt; data_hash_context;</span>
<a href="#l66.83"></a><span id="l66.83">   nsCOMPtr&lt;nsICMSDecoder&gt; sig_decoder_context;</span>
<a href="#l66.84"></a><span id="l66.84">   nsCOMPtr&lt;nsICMSMessage&gt; content_info;</span>
<a href="#l66.85"></a><span id="l66.85">   char *sender_addr;</span>
<a href="#l66.86"></a><span id="l66.86">   bool decoding_failed;</span>
<a href="#l66.87"></a><span id="l66.87" class="difflineminus">-  unsigned char* item_data;</span>
<a href="#l66.88"></a><span id="l66.88" class="difflineplus">+  unsigned char *item_data;</span>
<a href="#l66.89"></a><span id="l66.89">   uint32_t item_len;</span>
<a href="#l66.90"></a><span id="l66.90">   MimeObject *self;</span>
<a href="#l66.91"></a><span id="l66.91">   bool parent_is_encrypted_p;</span>
<a href="#l66.92"></a><span id="l66.92">   bool parent_holds_stamp_p;</span>
<a href="#l66.93"></a><span id="l66.93">   nsCOMPtr&lt;nsIMsgSMIMEHeaderSink&gt; smimeHeaderSink;</span>
<a href="#l66.94"></a><span id="l66.94"> </span>
<a href="#l66.95"></a><span id="l66.95">   MimeMultCMSdata()</span>
<a href="#l66.96"></a><span id="l66.96" class="difflineminus">-  :hash_type(0),</span>
<a href="#l66.97"></a><span id="l66.97" class="difflineminus">-  sender_addr(nullptr),</span>
<a href="#l66.98"></a><span id="l66.98" class="difflineminus">-  decoding_failed(false),</span>
<a href="#l66.99"></a><span id="l66.99" class="difflineminus">-  item_data(nullptr),</span>
<a href="#l66.100"></a><span id="l66.100" class="difflineminus">-  self(nullptr),</span>
<a href="#l66.101"></a><span id="l66.101" class="difflineminus">-  parent_is_encrypted_p(false),</span>
<a href="#l66.102"></a><span id="l66.102" class="difflineminus">-  parent_holds_stamp_p(false)</span>
<a href="#l66.103"></a><span id="l66.103" class="difflineminus">-  {</span>
<a href="#l66.104"></a><span id="l66.104" class="difflineminus">-  }</span>
<a href="#l66.105"></a><span id="l66.105" class="difflineplus">+      : hash_type(0),</span>
<a href="#l66.106"></a><span id="l66.106" class="difflineplus">+        sender_addr(nullptr),</span>
<a href="#l66.107"></a><span id="l66.107" class="difflineplus">+        decoding_failed(false),</span>
<a href="#l66.108"></a><span id="l66.108" class="difflineplus">+        item_data(nullptr),</span>
<a href="#l66.109"></a><span id="l66.109" class="difflineplus">+        self(nullptr),</span>
<a href="#l66.110"></a><span id="l66.110" class="difflineplus">+        parent_is_encrypted_p(false),</span>
<a href="#l66.111"></a><span id="l66.111" class="difflineplus">+        parent_holds_stamp_p(false) {}</span>
<a href="#l66.112"></a><span id="l66.112"> </span>
<a href="#l66.113"></a><span id="l66.113" class="difflineminus">-  ~MimeMultCMSdata()</span>
<a href="#l66.114"></a><span id="l66.114" class="difflineminus">-  {</span>
<a href="#l66.115"></a><span id="l66.115" class="difflineplus">+  ~MimeMultCMSdata() {</span>
<a href="#l66.116"></a><span id="l66.116">     PR_FREEIF(sender_addr);</span>
<a href="#l66.117"></a><span id="l66.117"> </span>
<a href="#l66.118"></a><span id="l66.118" class="difflineminus">-    // Do a graceful shutdown of the nsICMSDecoder and release the nsICMSMessage //</span>
<a href="#l66.119"></a><span id="l66.119" class="difflineminus">-    if (sig_decoder_context)</span>
<a href="#l66.120"></a><span id="l66.120" class="difflineminus">-    {</span>
<a href="#l66.121"></a><span id="l66.121" class="difflineplus">+    // Do a graceful shutdown of the nsICMSDecoder and release the nsICMSMessage</span>
<a href="#l66.122"></a><span id="l66.122" class="difflineplus">+    // //</span>
<a href="#l66.123"></a><span id="l66.123" class="difflineplus">+    if (sig_decoder_context) {</span>
<a href="#l66.124"></a><span id="l66.124">       nsCOMPtr&lt;nsICMSMessage&gt; cinfo;</span>
<a href="#l66.125"></a><span id="l66.125">       sig_decoder_context-&gt;Finish(getter_AddRefs(cinfo));</span>
<a href="#l66.126"></a><span id="l66.126">     }</span>
<a href="#l66.127"></a><span id="l66.127"> </span>
<a href="#l66.128"></a><span id="l66.128" class="difflineminus">-    delete [] item_data;</span>
<a href="#l66.129"></a><span id="l66.129" class="difflineplus">+    delete[] item_data;</span>
<a href="#l66.130"></a><span id="l66.130">   }</span>
<a href="#l66.131"></a><span id="l66.131"> } MimeMultCMSdata;</span>
<a href="#l66.132"></a><span id="l66.132"> </span>
<a href="#l66.133"></a><span id="l66.133"> /* #### MimeEncryptedCMS and MimeMultipartSignedCMS have a sleazy,</span>
<a href="#l66.134"></a><span id="l66.134">         incestuous, dysfunctional relationship. */</span>
<a href="#l66.135"></a><span id="l66.135" class="difflineminus">-extern bool MimeEncryptedCMS_encrypted_p (MimeObject *obj);</span>
<a href="#l66.136"></a><span id="l66.136" class="difflineminus">-extern void MimeCMSGetFromSender(MimeObject *obj,</span>
<a href="#l66.137"></a><span id="l66.137" class="difflineminus">-                                 nsCString &amp;from_addr,</span>
<a href="#l66.138"></a><span id="l66.138" class="difflineminus">-                                 nsCString &amp;from_name,</span>
<a href="#l66.139"></a><span id="l66.139" class="difflineminus">-                                 nsCString &amp;sender_addr,</span>
<a href="#l66.140"></a><span id="l66.140" class="difflineplus">+extern bool MimeEncryptedCMS_encrypted_p(MimeObject *obj);</span>
<a href="#l66.141"></a><span id="l66.141" class="difflineplus">+extern void MimeCMSGetFromSender(MimeObject *obj, nsCString &amp;from_addr,</span>
<a href="#l66.142"></a><span id="l66.142" class="difflineplus">+                                 nsCString &amp;from_name, nsCString &amp;sender_addr,</span>
<a href="#l66.143"></a><span id="l66.143">                                  nsCString &amp;sender_name);</span>
<a href="#l66.144"></a><span id="l66.144" class="difflineminus">-extern bool MimeCMSHeadersAndCertsMatch(MimeObject *obj,</span>
<a href="#l66.145"></a><span id="l66.145" class="difflineminus">-                                          nsICMSMessage *,</span>
<a href="#l66.146"></a><span id="l66.146" class="difflineminus">-                                          bool *signing_cert_without_email_address);</span>
<a href="#l66.147"></a><span id="l66.147" class="difflineminus">-extern void MimeCMSRequestAsyncSignatureVerification(nsICMSMessage *aCMSMsg,</span>
<a href="#l66.148"></a><span id="l66.148" class="difflineminus">-                                                     const char *aFromAddr, const char *aFromName,</span>
<a href="#l66.149"></a><span id="l66.149" class="difflineminus">-                                                     const char *aSenderAddr, const char *aSenderName,</span>
<a href="#l66.150"></a><span id="l66.150" class="difflineminus">-                                                     nsIMsgSMIMEHeaderSink *aHeaderSink, int32_t aMimeNestingLevel,</span>
<a href="#l66.151"></a><span id="l66.151" class="difflineminus">-                                                     unsigned char* item_data, uint32_t item_len,</span>
<a href="#l66.152"></a><span id="l66.152" class="difflineminus">-                                                     int16_t digest_type);</span>
<a href="#l66.153"></a><span id="l66.153" class="difflineplus">+extern bool MimeCMSHeadersAndCertsMatch(</span>
<a href="#l66.154"></a><span id="l66.154" class="difflineplus">+    MimeObject *obj, nsICMSMessage *, bool *signing_cert_without_email_address);</span>
<a href="#l66.155"></a><span id="l66.155" class="difflineplus">+extern void MimeCMSRequestAsyncSignatureVerification(</span>
<a href="#l66.156"></a><span id="l66.156" class="difflineplus">+    nsICMSMessage *aCMSMsg, const char *aFromAddr, const char *aFromName,</span>
<a href="#l66.157"></a><span id="l66.157" class="difflineplus">+    const char *aSenderAddr, const char *aSenderName,</span>
<a href="#l66.158"></a><span id="l66.158" class="difflineplus">+    nsIMsgSMIMEHeaderSink *aHeaderSink, int32_t aMimeNestingLevel,</span>
<a href="#l66.159"></a><span id="l66.159" class="difflineplus">+    unsigned char *item_data, uint32_t item_len, int16_t digest_type);</span>
<a href="#l66.160"></a><span id="l66.160"> extern char *MimeCMS_MakeSAURL(MimeObject *obj);</span>
<a href="#l66.161"></a><span id="l66.161"> extern char *IMAP_CreateReloadAllPartsUrl(const char *url);</span>
<a href="#l66.162"></a><span id="l66.162"> extern int MIMEGetRelativeCryptoNestLevel(MimeObject *obj);</span>
<a href="#l66.163"></a><span id="l66.163"> </span>
<a href="#l66.164"></a><span id="l66.164" class="difflineminus">-static void *</span>
<a href="#l66.165"></a><span id="l66.165" class="difflineminus">-MimeMultCMS_init (MimeObject *obj)</span>
<a href="#l66.166"></a><span id="l66.166" class="difflineminus">-{</span>
<a href="#l66.167"></a><span id="l66.167" class="difflineplus">+static void *MimeMultCMS_init(MimeObject *obj) {</span>
<a href="#l66.168"></a><span id="l66.168">   MimeHeaders *hdrs = obj-&gt;headers;</span>
<a href="#l66.169"></a><span id="l66.169">   MimeMultCMSdata *data = 0;</span>
<a href="#l66.170"></a><span id="l66.170">   char *ct, *micalg;</span>
<a href="#l66.171"></a><span id="l66.171">   int16_t hash_type;</span>
<a href="#l66.172"></a><span id="l66.172">   nsresult rv;</span>
<a href="#l66.173"></a><span id="l66.173"> </span>
<a href="#l66.174"></a><span id="l66.174" class="difflineminus">-  ct = MimeHeaders_get (hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l66.175"></a><span id="l66.175" class="difflineplus">+  ct = MimeHeaders_get(hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l66.176"></a><span id="l66.176">   if (!ct) return 0; /* #### bogus message?  out of memory? */</span>
<a href="#l66.177"></a><span id="l66.177" class="difflineminus">-  micalg = MimeHeaders_get_parameter (ct, PARAM_MICALG, NULL, NULL);</span>
<a href="#l66.178"></a><span id="l66.178" class="difflineplus">+  micalg = MimeHeaders_get_parameter(ct, PARAM_MICALG, NULL, NULL);</span>
<a href="#l66.179"></a><span id="l66.179">   PR_Free(ct);</span>
<a href="#l66.180"></a><span id="l66.180">   ct = 0;</span>
<a href="#l66.181"></a><span id="l66.181">   if (!micalg) return 0; /* #### bogus message?  out of memory? */</span>
<a href="#l66.182"></a><span id="l66.182"> </span>
<a href="#l66.183"></a><span id="l66.183">   if (!PL_strcasecmp(micalg, PARAM_MICALG_MD5) ||</span>
<a href="#l66.184"></a><span id="l66.184">       !PL_strcasecmp(micalg, PARAM_MICALG_MD5_2))</span>
<a href="#l66.185"></a><span id="l66.185">     hash_type = nsICryptoHash::MD5;</span>
<a href="#l66.186"></a><span id="l66.186">   else if (!PL_strcasecmp(micalg, PARAM_MICALG_SHA1) ||</span>
<a href="#l66.187"></a><span id="l66.187" class="difflineminus">-       !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_2) ||</span>
<a href="#l66.188"></a><span id="l66.188" class="difflineminus">-       !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_3) ||</span>
<a href="#l66.189"></a><span id="l66.189" class="difflineminus">-       !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_4) ||</span>
<a href="#l66.190"></a><span id="l66.190" class="difflineminus">-       !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_5))</span>
<a href="#l66.191"></a><span id="l66.191" class="difflineplus">+           !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_2) ||</span>
<a href="#l66.192"></a><span id="l66.192" class="difflineplus">+           !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_3) ||</span>
<a href="#l66.193"></a><span id="l66.193" class="difflineplus">+           !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_4) ||</span>
<a href="#l66.194"></a><span id="l66.194" class="difflineplus">+           !PL_strcasecmp(micalg, PARAM_MICALG_SHA1_5))</span>
<a href="#l66.195"></a><span id="l66.195">     hash_type = nsICryptoHash::SHA1;</span>
<a href="#l66.196"></a><span id="l66.196">   else if (!PL_strcasecmp(micalg, PARAM_MICALG_SHA256) ||</span>
<a href="#l66.197"></a><span id="l66.197" class="difflineminus">-       !PL_strcasecmp(micalg, PARAM_MICALG_SHA256_2) ||</span>
<a href="#l66.198"></a><span id="l66.198" class="difflineminus">-       !PL_strcasecmp(micalg, PARAM_MICALG_SHA256_3))</span>
<a href="#l66.199"></a><span id="l66.199" class="difflineplus">+           !PL_strcasecmp(micalg, PARAM_MICALG_SHA256_2) ||</span>
<a href="#l66.200"></a><span id="l66.200" class="difflineplus">+           !PL_strcasecmp(micalg, PARAM_MICALG_SHA256_3))</span>
<a href="#l66.201"></a><span id="l66.201">     hash_type = nsICryptoHash::SHA256;</span>
<a href="#l66.202"></a><span id="l66.202">   else if (!PL_strcasecmp(micalg, PARAM_MICALG_SHA384) ||</span>
<a href="#l66.203"></a><span id="l66.203" class="difflineminus">-       !PL_strcasecmp(micalg, PARAM_MICALG_SHA384_2) ||</span>
<a href="#l66.204"></a><span id="l66.204" class="difflineminus">-       !PL_strcasecmp(micalg, PARAM_MICALG_SHA384_3))</span>
<a href="#l66.205"></a><span id="l66.205" class="difflineplus">+           !PL_strcasecmp(micalg, PARAM_MICALG_SHA384_2) ||</span>
<a href="#l66.206"></a><span id="l66.206" class="difflineplus">+           !PL_strcasecmp(micalg, PARAM_MICALG_SHA384_3))</span>
<a href="#l66.207"></a><span id="l66.207">     hash_type = nsICryptoHash::SHA384;</span>
<a href="#l66.208"></a><span id="l66.208">   else if (!PL_strcasecmp(micalg, PARAM_MICALG_SHA512) ||</span>
<a href="#l66.209"></a><span id="l66.209" class="difflineminus">-       !PL_strcasecmp(micalg, PARAM_MICALG_SHA512_2) ||</span>
<a href="#l66.210"></a><span id="l66.210" class="difflineminus">-       !PL_strcasecmp(micalg, PARAM_MICALG_SHA512_3))</span>
<a href="#l66.211"></a><span id="l66.211" class="difflineplus">+           !PL_strcasecmp(micalg, PARAM_MICALG_SHA512_2) ||</span>
<a href="#l66.212"></a><span id="l66.212" class="difflineplus">+           !PL_strcasecmp(micalg, PARAM_MICALG_SHA512_3))</span>
<a href="#l66.213"></a><span id="l66.213">     hash_type = nsICryptoHash::SHA512;</span>
<a href="#l66.214"></a><span id="l66.214">   else</span>
<a href="#l66.215"></a><span id="l66.215">     hash_type = -1;</span>
<a href="#l66.216"></a><span id="l66.216"> </span>
<a href="#l66.217"></a><span id="l66.217">   PR_Free(micalg);</span>
<a href="#l66.218"></a><span id="l66.218">   micalg = 0;</span>
<a href="#l66.219"></a><span id="l66.219"> </span>
<a href="#l66.220"></a><span id="l66.220">   if (hash_type == -1) return 0; /* #### bogus message? */</span>
<a href="#l66.221"></a><span id="l66.221"> </span>
<a href="#l66.222"></a><span id="l66.222">   data = new MimeMultCMSdata;</span>
<a href="#l66.223"></a><span id="l66.223" class="difflineminus">-  if (!data)</span>
<a href="#l66.224"></a><span id="l66.224" class="difflineminus">-    return 0;</span>
<a href="#l66.225"></a><span id="l66.225" class="difflineplus">+  if (!data) return 0;</span>
<a href="#l66.226"></a><span id="l66.226"> </span>
<a href="#l66.227"></a><span id="l66.227">   data-&gt;self = obj;</span>
<a href="#l66.228"></a><span id="l66.228">   data-&gt;hash_type = hash_type;</span>
<a href="#l66.229"></a><span id="l66.229"> </span>
<a href="#l66.230"></a><span id="l66.230" class="difflineminus">-  data-&gt;data_hash_context = do_CreateInstance(&quot;@mozilla.org/security/hash;1&quot;, &amp;rv);</span>
<a href="#l66.231"></a><span id="l66.231" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l66.232"></a><span id="l66.232" class="difflineminus">-  {</span>
<a href="#l66.233"></a><span id="l66.233" class="difflineplus">+  data-&gt;data_hash_context =</span>
<a href="#l66.234"></a><span id="l66.234" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/security/hash;1&quot;, &amp;rv);</span>
<a href="#l66.235"></a><span id="l66.235" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l66.236"></a><span id="l66.236">     delete data;</span>
<a href="#l66.237"></a><span id="l66.237">     return 0;</span>
<a href="#l66.238"></a><span id="l66.238">   }</span>
<a href="#l66.239"></a><span id="l66.239"> </span>
<a href="#l66.240"></a><span id="l66.240">   rv = data-&gt;data_hash_context-&gt;Init(data-&gt;hash_type);</span>
<a href="#l66.241"></a><span id="l66.241" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l66.242"></a><span id="l66.242" class="difflineminus">-  {</span>
<a href="#l66.243"></a><span id="l66.243" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l66.244"></a><span id="l66.244">     delete data;</span>
<a href="#l66.245"></a><span id="l66.245">     return 0;</span>
<a href="#l66.246"></a><span id="l66.246">   }</span>
<a href="#l66.247"></a><span id="l66.247"> </span>
<a href="#l66.248"></a><span id="l66.248" class="difflineminus">-  PR_SetError(0,0);</span>
<a href="#l66.249"></a><span id="l66.249" class="difflineplus">+  PR_SetError(0, 0);</span>
<a href="#l66.250"></a><span id="l66.250"> </span>
<a href="#l66.251"></a><span id="l66.251">   data-&gt;parent_holds_stamp_p =</span>
<a href="#l66.252"></a><span id="l66.252" class="difflineminus">-  (obj-&gt;parent &amp;&amp; mime_crypto_stamped_p(obj-&gt;parent));</span>
<a href="#l66.253"></a><span id="l66.253" class="difflineplus">+      (obj-&gt;parent &amp;&amp; mime_crypto_stamped_p(obj-&gt;parent));</span>
<a href="#l66.254"></a><span id="l66.254"> </span>
<a href="#l66.255"></a><span id="l66.255">   data-&gt;parent_is_encrypted_p =</span>
<a href="#l66.256"></a><span id="l66.256" class="difflineminus">-  (obj-&gt;parent &amp;&amp; MimeEncryptedCMS_encrypted_p (obj-&gt;parent));</span>
<a href="#l66.257"></a><span id="l66.257" class="difflineplus">+      (obj-&gt;parent &amp;&amp; MimeEncryptedCMS_encrypted_p(obj-&gt;parent));</span>
<a href="#l66.258"></a><span id="l66.258"> </span>
<a href="#l66.259"></a><span id="l66.259">   /* If the parent of this object is a crypto-blob, then it's the grandparent</span>
<a href="#l66.260"></a><span id="l66.260">    who would have written out the headers and prepared for a stamp...</span>
<a href="#l66.261"></a><span id="l66.261">    (This s##t s$%#s.)</span>
<a href="#l66.262"></a><span id="l66.262">    */</span>
<a href="#l66.263"></a><span id="l66.263" class="difflineminus">-  if (data-&gt;parent_is_encrypted_p &amp;&amp;</span>
<a href="#l66.264"></a><span id="l66.264" class="difflineminus">-    !data-&gt;parent_holds_stamp_p &amp;&amp;</span>
<a href="#l66.265"></a><span id="l66.265" class="difflineminus">-    obj-&gt;parent &amp;&amp; obj-&gt;parent-&gt;parent)</span>
<a href="#l66.266"></a><span id="l66.266" class="difflineminus">-  data-&gt;parent_holds_stamp_p =</span>
<a href="#l66.267"></a><span id="l66.267" class="difflineminus">-    mime_crypto_stamped_p (obj-&gt;parent-&gt;parent);</span>
<a href="#l66.268"></a><span id="l66.268" class="difflineplus">+  if (data-&gt;parent_is_encrypted_p &amp;&amp; !data-&gt;parent_holds_stamp_p &amp;&amp;</span>
<a href="#l66.269"></a><span id="l66.269" class="difflineplus">+      obj-&gt;parent &amp;&amp; obj-&gt;parent-&gt;parent)</span>
<a href="#l66.270"></a><span id="l66.270" class="difflineplus">+    data-&gt;parent_holds_stamp_p = mime_crypto_stamped_p(obj-&gt;parent-&gt;parent);</span>
<a href="#l66.271"></a><span id="l66.271"> </span>
<a href="#l66.272"></a><span id="l66.272" class="difflineminus">-  mime_stream_data *msd = (mime_stream_data *) (data-&gt;self-&gt;options-&gt;stream_closure);</span>
<a href="#l66.273"></a><span id="l66.273" class="difflineminus">-  if (msd)</span>
<a href="#l66.274"></a><span id="l66.274" class="difflineminus">-  {</span>
<a href="#l66.275"></a><span id="l66.275" class="difflineplus">+  mime_stream_data *msd =</span>
<a href="#l66.276"></a><span id="l66.276" class="difflineplus">+      (mime_stream_data *)(data-&gt;self-&gt;options-&gt;stream_closure);</span>
<a href="#l66.277"></a><span id="l66.277" class="difflineplus">+  if (msd) {</span>
<a href="#l66.278"></a><span id="l66.278">     nsIChannel *channel = msd-&gt;channel;  // note the lack of ref counting...</span>
<a href="#l66.279"></a><span id="l66.279" class="difflineminus">-    if (channel)</span>
<a href="#l66.280"></a><span id="l66.280" class="difflineminus">-    {</span>
<a href="#l66.281"></a><span id="l66.281" class="difflineplus">+    if (channel) {</span>
<a href="#l66.282"></a><span id="l66.282">       nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l66.283"></a><span id="l66.283">       nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l66.284"></a><span id="l66.284">       nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l66.285"></a><span id="l66.285">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl;</span>
<a href="#l66.286"></a><span id="l66.286">       nsCOMPtr&lt;nsISupports&gt; securityInfo;</span>
<a href="#l66.287"></a><span id="l66.287">       channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l66.288"></a><span id="l66.288" class="difflineminus">-      if (uri)</span>
<a href="#l66.289"></a><span id="l66.289" class="difflineminus">-      {</span>
<a href="#l66.290"></a><span id="l66.290" class="difflineplus">+      if (uri) {</span>
<a href="#l66.291"></a><span id="l66.291">         nsAutoCString urlSpec;</span>
<a href="#l66.292"></a><span id="l66.292">         rv = uri-&gt;GetSpec(urlSpec);</span>
<a href="#l66.293"></a><span id="l66.293"> </span>
<a href="#l66.294"></a><span id="l66.294">         // We only want to update the UI if the current mime transaction</span>
<a href="#l66.295"></a><span id="l66.295">         // is intended for display.</span>
<a href="#l66.296"></a><span id="l66.296">         // If the current transaction is intended for background processing,</span>
<a href="#l66.297"></a><span id="l66.297">         // we can learn that by looking at the additional header=filter</span>
<a href="#l66.298"></a><span id="l66.298">         // string contained in the URI.</span>
<a href="#l66.299"></a><span id="l66.299">         //</span>
<a href="#l66.300"></a><span id="l66.300">         // If we find something, we do not set smimeHeaderSink,</span>
<a href="#l66.301"></a><span id="l66.301">         // which will prevent us from giving UI feedback.</span>
<a href="#l66.302"></a><span id="l66.302">         //</span>
<a href="#l66.303"></a><span id="l66.303">         // If we do not find header=filter, we assume the result of the</span>
<a href="#l66.304"></a><span id="l66.304">         // processing will be shown in the UI.</span>
<a href="#l66.305"></a><span id="l66.305"> </span>
<a href="#l66.306"></a><span id="l66.306">         if (!strstr(urlSpec.get(), &quot;?header=filter&quot;) &amp;&amp;</span>
<a href="#l66.307"></a><span id="l66.307" class="difflineminus">-            !strstr(urlSpec.get(), &quot;&amp;header=filter&quot;)&amp;&amp;</span>
<a href="#l66.308"></a><span id="l66.308" class="difflineplus">+            !strstr(urlSpec.get(), &quot;&amp;header=filter&quot;) &amp;&amp;</span>
<a href="#l66.309"></a><span id="l66.309">             !strstr(urlSpec.get(), &quot;?header=attach&quot;) &amp;&amp;</span>
<a href="#l66.310"></a><span id="l66.310" class="difflineminus">-            !strstr(urlSpec.get(), &quot;&amp;header=attach&quot;))</span>
<a href="#l66.311"></a><span id="l66.311" class="difflineminus">-        {</span>
<a href="#l66.312"></a><span id="l66.312" class="difflineplus">+            !strstr(urlSpec.get(), &quot;&amp;header=attach&quot;)) {</span>
<a href="#l66.313"></a><span id="l66.313">           msgurl = do_QueryInterface(uri);</span>
<a href="#l66.314"></a><span id="l66.314" class="difflineminus">-          if (msgurl)</span>
<a href="#l66.315"></a><span id="l66.315" class="difflineminus">-            msgurl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l66.316"></a><span id="l66.316" class="difflineplus">+          if (msgurl) msgurl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l66.317"></a><span id="l66.317">           if (msgWindow)</span>
<a href="#l66.318"></a><span id="l66.318">             msgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l66.319"></a><span id="l66.319">           if (headerSink)</span>
<a href="#l66.320"></a><span id="l66.320">             headerSink-&gt;GetSecurityInfo(getter_AddRefs(securityInfo));</span>
<a href="#l66.321"></a><span id="l66.321">           if (securityInfo)</span>
<a href="#l66.322"></a><span id="l66.322">             data-&gt;smimeHeaderSink = do_QueryInterface(securityInfo);</span>
<a href="#l66.323"></a><span id="l66.323" class="difflineminus">-         }</span>
<a href="#l66.324"></a><span id="l66.324" class="difflineminus">-       }</span>
<a href="#l66.325"></a><span id="l66.325" class="difflineminus">-    } // if channel</span>
<a href="#l66.326"></a><span id="l66.326" class="difflineminus">-  } // if msd</span>
<a href="#l66.327"></a><span id="l66.327" class="difflineplus">+        }</span>
<a href="#l66.328"></a><span id="l66.328" class="difflineplus">+      }</span>
<a href="#l66.329"></a><span id="l66.329" class="difflineplus">+    }  // if channel</span>
<a href="#l66.330"></a><span id="l66.330" class="difflineplus">+  }    // if msd</span>
<a href="#l66.331"></a><span id="l66.331"> </span>
<a href="#l66.332"></a><span id="l66.332">   return data;</span>
<a href="#l66.333"></a><span id="l66.333"> }</span>
<a href="#l66.334"></a><span id="l66.334"> </span>
<a href="#l66.335"></a><span id="l66.335" class="difflineminus">-static int</span>
<a href="#l66.336"></a><span id="l66.336" class="difflineminus">-MimeMultCMS_data_hash (const char *buf, int32_t size, void *crypto_closure)</span>
<a href="#l66.337"></a><span id="l66.337" class="difflineminus">-{</span>
<a href="#l66.338"></a><span id="l66.338" class="difflineminus">-  MimeMultCMSdata *data = (MimeMultCMSdata *) crypto_closure;</span>
<a href="#l66.339"></a><span id="l66.339" class="difflineplus">+static int MimeMultCMS_data_hash(const char *buf, int32_t size,</span>
<a href="#l66.340"></a><span id="l66.340" class="difflineplus">+                                 void *crypto_closure) {</span>
<a href="#l66.341"></a><span id="l66.341" class="difflineplus">+  MimeMultCMSdata *data = (MimeMultCMSdata *)crypto_closure;</span>
<a href="#l66.342"></a><span id="l66.342">   if (!data || !data-&gt;data_hash_context) {</span>
<a href="#l66.343"></a><span id="l66.343">     return -1;</span>
<a href="#l66.344"></a><span id="l66.344">   }</span>
<a href="#l66.345"></a><span id="l66.345"> </span>
<a href="#l66.346"></a><span id="l66.346">   PR_SetError(0, 0);</span>
<a href="#l66.347"></a><span id="l66.347" class="difflineminus">-  nsresult rv = data-&gt;data_hash_context-&gt;Update((unsigned char *) buf, size);</span>
<a href="#l66.348"></a><span id="l66.348" class="difflineplus">+  nsresult rv = data-&gt;data_hash_context-&gt;Update((unsigned char *)buf, size);</span>
<a href="#l66.349"></a><span id="l66.349">   data-&gt;decoding_failed = NS_FAILED(rv);</span>
<a href="#l66.350"></a><span id="l66.350"> </span>
<a href="#l66.351"></a><span id="l66.351">   return 0;</span>
<a href="#l66.352"></a><span id="l66.352"> }</span>
<a href="#l66.353"></a><span id="l66.353"> </span>
<a href="#l66.354"></a><span id="l66.354" class="difflineminus">-static int</span>
<a href="#l66.355"></a><span id="l66.355" class="difflineminus">-MimeMultCMS_data_eof (void *crypto_closure, bool abort_p)</span>
<a href="#l66.356"></a><span id="l66.356" class="difflineminus">-{</span>
<a href="#l66.357"></a><span id="l66.357" class="difflineminus">-  MimeMultCMSdata *data = (MimeMultCMSdata *) crypto_closure;</span>
<a href="#l66.358"></a><span id="l66.358" class="difflineplus">+static int MimeMultCMS_data_eof(void *crypto_closure, bool abort_p) {</span>
<a href="#l66.359"></a><span id="l66.359" class="difflineplus">+  MimeMultCMSdata *data = (MimeMultCMSdata *)crypto_closure;</span>
<a href="#l66.360"></a><span id="l66.360">   if (!data || !data-&gt;data_hash_context) {</span>
<a href="#l66.361"></a><span id="l66.361">     return -1;</span>
<a href="#l66.362"></a><span id="l66.362">   }</span>
<a href="#l66.363"></a><span id="l66.363"> </span>
<a href="#l66.364"></a><span id="l66.364">   nsAutoCString hashString;</span>
<a href="#l66.365"></a><span id="l66.365">   data-&gt;data_hash_context-&gt;Finish(false, hashString);</span>
<a href="#l66.366"></a><span id="l66.366">   PR_SetError(0, 0);</span>
<a href="#l66.367"></a><span id="l66.367"> </span>
<a href="#l66.368"></a><span id="l66.368" class="difflineminus">-  data-&gt;item_len  = hashString.Length();</span>
<a href="#l66.369"></a><span id="l66.369" class="difflineplus">+  data-&gt;item_len = hashString.Length();</span>
<a href="#l66.370"></a><span id="l66.370">   data-&gt;item_data = new unsigned char[data-&gt;item_len];</span>
<a href="#l66.371"></a><span id="l66.371">   if (!data-&gt;item_data) return MIME_OUT_OF_MEMORY;</span>
<a href="#l66.372"></a><span id="l66.372"> </span>
<a href="#l66.373"></a><span id="l66.373">   memcpy(data-&gt;item_data, hashString.get(), data-&gt;item_len);</span>
<a href="#l66.374"></a><span id="l66.374"> </span>
<a href="#l66.375"></a><span id="l66.375">   // Release our reference to nsICryptoHash //</span>
<a href="#l66.376"></a><span id="l66.376">   data-&gt;data_hash_context = nullptr;</span>
<a href="#l66.377"></a><span id="l66.377"> </span>
<a href="#l66.378"></a><span id="l66.378">   /* At this point, data-&gt;item.data contains a digest for the first part.</span>
<a href="#l66.379"></a><span id="l66.379">    When we process the signature, the security library will compare this</span>
<a href="#l66.380"></a><span id="l66.380">    digest to what's in the signature object. */</span>
<a href="#l66.381"></a><span id="l66.381"> </span>
<a href="#l66.382"></a><span id="l66.382">   return 0;</span>
<a href="#l66.383"></a><span id="l66.383"> }</span>
<a href="#l66.384"></a><span id="l66.384"> </span>
<a href="#l66.385"></a><span id="l66.385" class="difflineminus">-</span>
<a href="#l66.386"></a><span id="l66.386" class="difflineminus">-static int</span>
<a href="#l66.387"></a><span id="l66.387" class="difflineminus">-MimeMultCMS_sig_init (void *crypto_closure,</span>
<a href="#l66.388"></a><span id="l66.388" class="difflineminus">-            MimeObject *multipart_object,</span>
<a href="#l66.389"></a><span id="l66.389" class="difflineminus">-            MimeHeaders *signature_hdrs)</span>
<a href="#l66.390"></a><span id="l66.390" class="difflineminus">-{</span>
<a href="#l66.391"></a><span id="l66.391" class="difflineminus">-  MimeMultCMSdata *data = (MimeMultCMSdata *) crypto_closure;</span>
<a href="#l66.392"></a><span id="l66.392" class="difflineplus">+static int MimeMultCMS_sig_init(void *crypto_closure,</span>
<a href="#l66.393"></a><span id="l66.393" class="difflineplus">+                                MimeObject *multipart_object,</span>
<a href="#l66.394"></a><span id="l66.394" class="difflineplus">+                                MimeHeaders *signature_hdrs) {</span>
<a href="#l66.395"></a><span id="l66.395" class="difflineplus">+  MimeMultCMSdata *data = (MimeMultCMSdata *)crypto_closure;</span>
<a href="#l66.396"></a><span id="l66.396">   char *ct;</span>
<a href="#l66.397"></a><span id="l66.397">   int status = 0;</span>
<a href="#l66.398"></a><span id="l66.398">   nsresult rv;</span>
<a href="#l66.399"></a><span id="l66.399"> </span>
<a href="#l66.400"></a><span id="l66.400">   if (!signature_hdrs) {</span>
<a href="#l66.401"></a><span id="l66.401">     return -1;</span>
<a href="#l66.402"></a><span id="l66.402">   }</span>
<a href="#l66.403"></a><span id="l66.403"> </span>
<a href="#l66.404"></a><span id="l66.404" class="difflineminus">-  ct = MimeHeaders_get (signature_hdrs, HEADER_CONTENT_TYPE, true, false);</span>
<a href="#l66.405"></a><span id="l66.405" class="difflineplus">+  ct = MimeHeaders_get(signature_hdrs, HEADER_CONTENT_TYPE, true, false);</span>
<a href="#l66.406"></a><span id="l66.406"> </span>
<a href="#l66.407"></a><span id="l66.407">   /* Verify that the signature object is of the right type. */</span>
<a href="#l66.408"></a><span id="l66.408">   if (!ct || /* is not a signature type */</span>
<a href="#l66.409"></a><span id="l66.409" class="difflineminus">-             (PL_strcasecmp(ct, APPLICATION_XPKCS7_SIGNATURE) != 0</span>
<a href="#l66.410"></a><span id="l66.410" class="difflineminus">-              &amp;&amp; PL_strcasecmp(ct, APPLICATION_PKCS7_SIGNATURE) != 0)) {</span>
<a href="#l66.411"></a><span id="l66.411" class="difflineplus">+      (PL_strcasecmp(ct, APPLICATION_XPKCS7_SIGNATURE) != 0 &amp;&amp;</span>
<a href="#l66.412"></a><span id="l66.412" class="difflineplus">+       PL_strcasecmp(ct, APPLICATION_PKCS7_SIGNATURE) != 0)) {</span>
<a href="#l66.413"></a><span id="l66.413">     status = -1; /* #### error msg about bogus message */</span>
<a href="#l66.414"></a><span id="l66.414">   }</span>
<a href="#l66.415"></a><span id="l66.415">   PR_FREEIF(ct);</span>
<a href="#l66.416"></a><span id="l66.416">   if (status &lt; 0) return status;</span>
<a href="#l66.417"></a><span id="l66.417"> </span>
<a href="#l66.418"></a><span id="l66.418">   data-&gt;sig_decoder_context = do_CreateInstance(NS_CMSDECODER_CONTRACTID, &amp;rv);</span>
<a href="#l66.419"></a><span id="l66.419">   if (NS_FAILED(rv)) return 0;</span>
<a href="#l66.420"></a><span id="l66.420"> </span>
<a href="#l66.421"></a><span id="l66.421">   rv = data-&gt;sig_decoder_context-&gt;Start(nullptr, nullptr);</span>
<a href="#l66.422"></a><span id="l66.422">   if (NS_FAILED(rv)) {</span>
<a href="#l66.423"></a><span id="l66.423">     status = PR_GetError();</span>
<a href="#l66.424"></a><span id="l66.424">     if (status &gt;= 0) status = -1;</span>
<a href="#l66.425"></a><span id="l66.425">   }</span>
<a href="#l66.426"></a><span id="l66.426">   return status;</span>
<a href="#l66.427"></a><span id="l66.427"> }</span>
<a href="#l66.428"></a><span id="l66.428"> </span>
<a href="#l66.429"></a><span id="l66.429" class="difflineminus">-</span>
<a href="#l66.430"></a><span id="l66.430" class="difflineminus">-static int</span>
<a href="#l66.431"></a><span id="l66.431" class="difflineminus">-MimeMultCMS_sig_hash (const char *buf, int32_t size, void *crypto_closure)</span>
<a href="#l66.432"></a><span id="l66.432" class="difflineminus">-{</span>
<a href="#l66.433"></a><span id="l66.433" class="difflineminus">-  MimeMultCMSdata *data = (MimeMultCMSdata *) crypto_closure;</span>
<a href="#l66.434"></a><span id="l66.434" class="difflineplus">+static int MimeMultCMS_sig_hash(const char *buf, int32_t size,</span>
<a href="#l66.435"></a><span id="l66.435" class="difflineplus">+                                void *crypto_closure) {</span>
<a href="#l66.436"></a><span id="l66.436" class="difflineplus">+  MimeMultCMSdata *data = (MimeMultCMSdata *)crypto_closure;</span>
<a href="#l66.437"></a><span id="l66.437">   nsresult rv;</span>
<a href="#l66.438"></a><span id="l66.438"> </span>
<a href="#l66.439"></a><span id="l66.439">   if (!data || !data-&gt;sig_decoder_context) {</span>
<a href="#l66.440"></a><span id="l66.440">     return -1;</span>
<a href="#l66.441"></a><span id="l66.441">   }</span>
<a href="#l66.442"></a><span id="l66.442"> </span>
<a href="#l66.443"></a><span id="l66.443">   rv = data-&gt;sig_decoder_context-&gt;Update(buf, size);</span>
<a href="#l66.444"></a><span id="l66.444">   data-&gt;decoding_failed = NS_FAILED(rv);</span>
<a href="#l66.445"></a><span id="l66.445"> </span>
<a href="#l66.446"></a><span id="l66.446">   return 0;</span>
<a href="#l66.447"></a><span id="l66.447"> }</span>
<a href="#l66.448"></a><span id="l66.448"> </span>
<a href="#l66.449"></a><span id="l66.449" class="difflineminus">-static int</span>
<a href="#l66.450"></a><span id="l66.450" class="difflineminus">-MimeMultCMS_sig_eof (void *crypto_closure, bool abort_p)</span>
<a href="#l66.451"></a><span id="l66.451" class="difflineminus">-{</span>
<a href="#l66.452"></a><span id="l66.452" class="difflineminus">-  MimeMultCMSdata *data = (MimeMultCMSdata *) crypto_closure;</span>
<a href="#l66.453"></a><span id="l66.453" class="difflineplus">+static int MimeMultCMS_sig_eof(void *crypto_closure, bool abort_p) {</span>
<a href="#l66.454"></a><span id="l66.454" class="difflineplus">+  MimeMultCMSdata *data = (MimeMultCMSdata *)crypto_closure;</span>
<a href="#l66.455"></a><span id="l66.455"> </span>
<a href="#l66.456"></a><span id="l66.456">   if (!data) {</span>
<a href="#l66.457"></a><span id="l66.457">     return -1;</span>
<a href="#l66.458"></a><span id="l66.458">   }</span>
<a href="#l66.459"></a><span id="l66.459"> </span>
<a href="#l66.460"></a><span id="l66.460">   /* Hand an EOF to the crypto library.</span>
<a href="#l66.461"></a><span id="l66.461"> </span>
<a href="#l66.462"></a><span id="l66.462">    We save away the value returned and will use it later to emit a</span>
<a href="#l66.463"></a><span id="l66.463" class="difflineat">@@ -383,87 +351,74 @@ MimeMultCMS_sig_eof (void *crypto_closur</span>
<a href="#l66.464"></a><span id="l66.464"> </span>
<a href="#l66.465"></a><span id="l66.465">     // Release our reference to nsICMSDecoder //</span>
<a href="#l66.466"></a><span id="l66.466">     data-&gt;sig_decoder_context = nullptr;</span>
<a href="#l66.467"></a><span id="l66.467">   }</span>
<a href="#l66.468"></a><span id="l66.468"> </span>
<a href="#l66.469"></a><span id="l66.469">   return 0;</span>
<a href="#l66.470"></a><span id="l66.470"> }</span>
<a href="#l66.471"></a><span id="l66.471"> </span>
<a href="#l66.472"></a><span id="l66.472" class="difflineminus">-static void</span>
<a href="#l66.473"></a><span id="l66.473" class="difflineminus">-MimeMultCMS_free (void *crypto_closure)</span>
<a href="#l66.474"></a><span id="l66.474" class="difflineminus">-{</span>
<a href="#l66.475"></a><span id="l66.475" class="difflineminus">-  MimeMultCMSdata *data = (MimeMultCMSdata *) crypto_closure;</span>
<a href="#l66.476"></a><span id="l66.476" class="difflineplus">+static void MimeMultCMS_free(void *crypto_closure) {</span>
<a href="#l66.477"></a><span id="l66.477" class="difflineplus">+  MimeMultCMSdata *data = (MimeMultCMSdata *)crypto_closure;</span>
<a href="#l66.478"></a><span id="l66.478">   if (!data) return;</span>
<a href="#l66.479"></a><span id="l66.479"> </span>
<a href="#l66.480"></a><span id="l66.480">   delete data;</span>
<a href="#l66.481"></a><span id="l66.481"> }</span>
<a href="#l66.482"></a><span id="l66.482"> </span>
<a href="#l66.483"></a><span id="l66.483" class="difflineminus">-static char *</span>
<a href="#l66.484"></a><span id="l66.484" class="difflineminus">-MimeMultCMS_generate (void *crypto_closure)</span>
<a href="#l66.485"></a><span id="l66.485" class="difflineminus">-{</span>
<a href="#l66.486"></a><span id="l66.486" class="difflineminus">-  MimeMultCMSdata *data = (MimeMultCMSdata *) crypto_closure;</span>
<a href="#l66.487"></a><span id="l66.487" class="difflineplus">+static char *MimeMultCMS_generate(void *crypto_closure) {</span>
<a href="#l66.488"></a><span id="l66.488" class="difflineplus">+  MimeMultCMSdata *data = (MimeMultCMSdata *)crypto_closure;</span>
<a href="#l66.489"></a><span id="l66.489">   if (!data) return 0;</span>
<a href="#l66.490"></a><span id="l66.490">   nsCOMPtr&lt;nsIX509Cert&gt; signerCert;</span>
<a href="#l66.491"></a><span id="l66.491"> </span>
<a href="#l66.492"></a><span id="l66.492">   int aRelativeNestLevel = MIMEGetRelativeCryptoNestLevel(data-&gt;self);</span>
<a href="#l66.493"></a><span id="l66.493"> </span>
<a href="#l66.494"></a><span id="l66.494" class="difflineminus">-  if (aRelativeNestLevel &lt; 0)</span>
<a href="#l66.495"></a><span id="l66.495" class="difflineminus">-    return nullptr;</span>
<a href="#l66.496"></a><span id="l66.496" class="difflineplus">+  if (aRelativeNestLevel &lt; 0) return nullptr;</span>
<a href="#l66.497"></a><span id="l66.497"> </span>
<a href="#l66.498"></a><span id="l66.498">   int32_t maxNestLevel = 0;</span>
<a href="#l66.499"></a><span id="l66.499" class="difflineminus">-  if (data-&gt;smimeHeaderSink &amp;&amp; aRelativeNestLevel &gt;= 0)</span>
<a href="#l66.500"></a><span id="l66.500" class="difflineminus">-  {</span>
<a href="#l66.501"></a><span id="l66.501" class="difflineplus">+  if (data-&gt;smimeHeaderSink &amp;&amp; aRelativeNestLevel &gt;= 0) {</span>
<a href="#l66.502"></a><span id="l66.502">     data-&gt;smimeHeaderSink-&gt;MaxWantedNesting(&amp;maxNestLevel);</span>
<a href="#l66.503"></a><span id="l66.503"> </span>
<a href="#l66.504"></a><span id="l66.504" class="difflineminus">-    if (aRelativeNestLevel &gt; maxNestLevel)</span>
<a href="#l66.505"></a><span id="l66.505" class="difflineminus">-      return nullptr;</span>
<a href="#l66.506"></a><span id="l66.506" class="difflineplus">+    if (aRelativeNestLevel &gt; maxNestLevel) return nullptr;</span>
<a href="#l66.507"></a><span id="l66.507">   }</span>
<a href="#l66.508"></a><span id="l66.508"> </span>
<a href="#l66.509"></a><span id="l66.509" class="difflineminus">-  if (data-&gt;self-&gt;options-&gt;missing_parts)</span>
<a href="#l66.510"></a><span id="l66.510" class="difflineminus">-  {</span>
<a href="#l66.511"></a><span id="l66.511" class="difflineplus">+  if (data-&gt;self-&gt;options-&gt;missing_parts) {</span>
<a href="#l66.512"></a><span id="l66.512">     // We were not given all parts of the message.</span>
<a href="#l66.513"></a><span id="l66.513">     // We are therefore unable to verify correctness of the signature.</span>
<a href="#l66.514"></a><span id="l66.514"> </span>
<a href="#l66.515"></a><span id="l66.515">     if (data-&gt;smimeHeaderSink)</span>
<a href="#l66.516"></a><span id="l66.516" class="difflineminus">-      data-&gt;smimeHeaderSink-&gt;SignedStatus(aRelativeNestLevel,</span>
<a href="#l66.517"></a><span id="l66.517" class="difflineminus">-                                          nsICMSMessageErrors::VERIFY_NOT_YET_ATTEMPTED,</span>
<a href="#l66.518"></a><span id="l66.518" class="difflineminus">-                                          nullptr);</span>
<a href="#l66.519"></a><span id="l66.519" class="difflineplus">+      data-&gt;smimeHeaderSink-&gt;SignedStatus(</span>
<a href="#l66.520"></a><span id="l66.520" class="difflineplus">+          aRelativeNestLevel, nsICMSMessageErrors::VERIFY_NOT_YET_ATTEMPTED,</span>
<a href="#l66.521"></a><span id="l66.521" class="difflineplus">+          nullptr);</span>
<a href="#l66.522"></a><span id="l66.522">     return nullptr;</span>
<a href="#l66.523"></a><span id="l66.523">   }</span>
<a href="#l66.524"></a><span id="l66.524"> </span>
<a href="#l66.525"></a><span id="l66.525" class="difflineminus">-  if (!data-&gt;content_info)</span>
<a href="#l66.526"></a><span id="l66.526" class="difflineminus">-  {</span>
<a href="#l66.527"></a><span id="l66.527" class="difflineplus">+  if (!data-&gt;content_info) {</span>
<a href="#l66.528"></a><span id="l66.528">     /* No content_info at all -- since we're inside a multipart/signed,</span>
<a href="#l66.529"></a><span id="l66.529">      that means that we've either gotten a message that was truncated</span>
<a href="#l66.530"></a><span id="l66.530">      before the signature part, or we ran out of memory, or something</span>
<a href="#l66.531"></a><span id="l66.531">      awful has happened.</span>
<a href="#l66.532"></a><span id="l66.532">      */</span>
<a href="#l66.533"></a><span id="l66.533" class="difflineminus">-     return nullptr;</span>
<a href="#l66.534"></a><span id="l66.534" class="difflineplus">+    return nullptr;</span>
<a href="#l66.535"></a><span id="l66.535">   }</span>
<a href="#l66.536"></a><span id="l66.536"> </span>
<a href="#l66.537"></a><span id="l66.537">   nsCString from_addr;</span>
<a href="#l66.538"></a><span id="l66.538">   nsCString from_name;</span>
<a href="#l66.539"></a><span id="l66.539">   nsCString sender_addr;</span>
<a href="#l66.540"></a><span id="l66.540">   nsCString sender_name;</span>
<a href="#l66.541"></a><span id="l66.541"> </span>
<a href="#l66.542"></a><span id="l66.542" class="difflineminus">-  MimeCMSGetFromSender(data-&gt;self,</span>
<a href="#l66.543"></a><span id="l66.543" class="difflineminus">-                       from_addr, from_name,</span>
<a href="#l66.544"></a><span id="l66.544" class="difflineminus">-                       sender_addr, sender_name);</span>
<a href="#l66.545"></a><span id="l66.545" class="difflineplus">+  MimeCMSGetFromSender(data-&gt;self, from_addr, from_name, sender_addr,</span>
<a href="#l66.546"></a><span id="l66.546" class="difflineplus">+                       sender_name);</span>
<a href="#l66.547"></a><span id="l66.547"> </span>
<a href="#l66.548"></a><span id="l66.548" class="difflineminus">-  MimeCMSRequestAsyncSignatureVerification(data-&gt;content_info,</span>
<a href="#l66.549"></a><span id="l66.549" class="difflineminus">-                                           from_addr.get(), from_name.get(),</span>
<a href="#l66.550"></a><span id="l66.550" class="difflineminus">-                                           sender_addr.get(), sender_name.get(),</span>
<a href="#l66.551"></a><span id="l66.551" class="difflineminus">-                                           data-&gt;smimeHeaderSink, aRelativeNestLevel,</span>
<a href="#l66.552"></a><span id="l66.552" class="difflineminus">-                                           data-&gt;item_data, data-&gt;item_len,</span>
<a href="#l66.553"></a><span id="l66.553" class="difflineminus">-                                           data-&gt;hash_type);</span>
<a href="#l66.554"></a><span id="l66.554" class="difflineplus">+  MimeCMSRequestAsyncSignatureVerification(</span>
<a href="#l66.555"></a><span id="l66.555" class="difflineplus">+      data-&gt;content_info, from_addr.get(), from_name.get(), sender_addr.get(),</span>
<a href="#l66.556"></a><span id="l66.556" class="difflineplus">+      sender_name.get(), data-&gt;smimeHeaderSink, aRelativeNestLevel,</span>
<a href="#l66.557"></a><span id="l66.557" class="difflineplus">+      data-&gt;item_data, data-&gt;item_len, data-&gt;hash_type);</span>
<a href="#l66.558"></a><span id="l66.558"> </span>
<a href="#l66.559"></a><span id="l66.559" class="difflineminus">-  if (data-&gt;content_info)</span>
<a href="#l66.560"></a><span id="l66.560" class="difflineminus">-  {</span>
<a href="#l66.561"></a><span id="l66.561" class="difflineminus">-#if 0 // XXX Fix this. What do we do here? //</span>
<a href="#l66.562"></a><span id="l66.562" class="difflineplus">+  if (data-&gt;content_info) {</span>
<a href="#l66.563"></a><span id="l66.563" class="difflineplus">+#if 0  // XXX Fix this. What do we do here? //</span>
<a href="#l66.564"></a><span id="l66.564">     if (SEC_CMSContainsCertsOrCrls(data-&gt;content_info))</span>
<a href="#l66.565"></a><span id="l66.565">     {</span>
<a href="#l66.566"></a><span id="l66.566">       /* #### call libsec telling it to import the certs */</span>
<a href="#l66.567"></a><span id="l66.567">     }</span>
<a href="#l66.568"></a><span id="l66.568"> #endif</span>
<a href="#l66.569"></a><span id="l66.569">   }</span>
<a href="#l66.570"></a><span id="l66.570"> </span>
<a href="#l66.571"></a><span id="l66.571">   return nullptr;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/mime/src/mimemcms.h</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/mime/src/mimemcms.h</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -12,24 +12,24 @@ class nsICMSMessage;  // for function ar</span>
<a href="#l67.4"></a><span id="l67.4"> </span>
<a href="#l67.5"></a><span id="l67.5"> /* The MimeMultipartSignedCMS class implements a multipart/signed MIME</span>
<a href="#l67.6"></a><span id="l67.6">    container with protocol=application/x-CMS-signature, which passes the</span>
<a href="#l67.7"></a><span id="l67.7">    signed object through CMS code to verify the signature.  See mimemsig.h</span>
<a href="#l67.8"></a><span id="l67.8">    for details of the general mechanism on which this is built.</span>
<a href="#l67.9"></a><span id="l67.9">  */</span>
<a href="#l67.10"></a><span id="l67.10"> </span>
<a href="#l67.11"></a><span id="l67.11"> typedef struct MimeMultipartSignedCMSClass MimeMultipartSignedCMSClass;</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-typedef struct MimeMultipartSignedCMS      MimeMultipartSignedCMS;</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+typedef struct MimeMultipartSignedCMS MimeMultipartSignedCMS;</span>
<a href="#l67.14"></a><span id="l67.14"> </span>
<a href="#l67.15"></a><span id="l67.15"> struct MimeMultipartSignedCMSClass {</span>
<a href="#l67.16"></a><span id="l67.16">   MimeMultipartSignedClass msigned;</span>
<a href="#l67.17"></a><span id="l67.17"> };</span>
<a href="#l67.18"></a><span id="l67.18"> </span>
<a href="#l67.19"></a><span id="l67.19"> extern MimeMultipartSignedCMSClass mimeMultipartSignedCMSClass;</span>
<a href="#l67.20"></a><span id="l67.20"> </span>
<a href="#l67.21"></a><span id="l67.21"> struct MimeMultipartSignedCMS {</span>
<a href="#l67.22"></a><span id="l67.22">   MimeMultipartSigned msigned;</span>
<a href="#l67.23"></a><span id="l67.23"> };</span>
<a href="#l67.24"></a><span id="l67.24"> </span>
<a href="#l67.25"></a><span id="l67.25" class="difflineminus">-#define MimeMultipartSignedCMSClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l67.26"></a><span id="l67.26" class="difflineminus">-  { MimeMultipartSignedClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l67.27"></a><span id="l67.27" class="difflineplus">+#define MimeMultipartSignedCMSClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l67.28"></a><span id="l67.28" class="difflineplus">+  { MimeMultipartSignedClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l67.29"></a><span id="l67.29"> </span>
<a href="#l67.30"></a><span id="l67.30"> #endif /* _MIMEMPKC_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/mime/src/mimemdig.cpp</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/mime/src/mimemdig.cpp</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -4,21 +4,19 @@</span>
<a href="#l68.4"></a><span id="l68.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l68.5"></a><span id="l68.5"> </span>
<a href="#l68.6"></a><span id="l68.6"> #include &quot;mimemdig.h&quot;</span>
<a href="#l68.7"></a><span id="l68.7"> #include &quot;prlog.h&quot;</span>
<a href="#l68.8"></a><span id="l68.8"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l68.9"></a><span id="l68.9"> </span>
<a href="#l68.10"></a><span id="l68.10"> #define MIME_SUPERCLASS mimeMultipartClass</span>
<a href="#l68.11"></a><span id="l68.11"> MimeDefClass(MimeMultipartDigest, MimeMultipartDigestClass,</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-       mimeMultipartDigestClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+             mimeMultipartDigestClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l68.14"></a><span id="l68.14"> </span>
<a href="#l68.15"></a><span id="l68.15" class="difflineminus">-static int</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineminus">-MimeMultipartDigestClassInitialize(MimeMultipartDigestClass *clazz)</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineminus">-{</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineplus">+static int MimeMultipartDigestClassInitialize(MimeMultipartDigestClass *clazz) {</span>
<a href="#l68.19"></a><span id="l68.19"> #ifdef DEBUG</span>
<a href="#l68.20"></a><span id="l68.20" class="difflineminus">-  MimeObjectClass    *oclass = (MimeObjectClass *)    clazz;</span>
<a href="#l68.21"></a><span id="l68.21" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l68.22"></a><span id="l68.22">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l68.23"></a><span id="l68.23"> #endif</span>
<a href="#l68.24"></a><span id="l68.24" class="difflineminus">-  MimeMultipartClass *mclass = (MimeMultipartClass *) clazz;</span>
<a href="#l68.25"></a><span id="l68.25" class="difflineplus">+  MimeMultipartClass *mclass = (MimeMultipartClass *)clazz;</span>
<a href="#l68.26"></a><span id="l68.26">   mclass-&gt;default_part_type = MESSAGE_RFC822;</span>
<a href="#l68.27"></a><span id="l68.27">   return 0;</span>
<a href="#l68.28"></a><span id="l68.28"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/mime/src/mimemdig.h</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/mime/src/mimemdig.h</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -10,24 +10,24 @@</span>
<a href="#l69.4"></a><span id="l69.4"> </span>
<a href="#l69.5"></a><span id="l69.5"> /* The MimeMultipartDigest class implements the multipart/digest MIME</span>
<a href="#l69.6"></a><span id="l69.6">    container, which is just like multipart/mixed, except that the default</span>
<a href="#l69.7"></a><span id="l69.7">    type (for parts with no type explicitly specified) is message/rfc822</span>
<a href="#l69.8"></a><span id="l69.8">    instead of text/plain.</span>
<a href="#l69.9"></a><span id="l69.9">  */</span>
<a href="#l69.10"></a><span id="l69.10"> </span>
<a href="#l69.11"></a><span id="l69.11"> typedef struct MimeMultipartDigestClass MimeMultipartDigestClass;</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-typedef struct MimeMultipartDigest      MimeMultipartDigest;</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+typedef struct MimeMultipartDigest MimeMultipartDigest;</span>
<a href="#l69.14"></a><span id="l69.14"> </span>
<a href="#l69.15"></a><span id="l69.15"> struct MimeMultipartDigestClass {</span>
<a href="#l69.16"></a><span id="l69.16">   MimeMultipartClass multipart;</span>
<a href="#l69.17"></a><span id="l69.17"> };</span>
<a href="#l69.18"></a><span id="l69.18"> </span>
<a href="#l69.19"></a><span id="l69.19"> extern MimeMultipartDigestClass mimeMultipartDigestClass;</span>
<a href="#l69.20"></a><span id="l69.20"> </span>
<a href="#l69.21"></a><span id="l69.21"> struct MimeMultipartDigest {</span>
<a href="#l69.22"></a><span id="l69.22">   MimeMultipart multipart;</span>
<a href="#l69.23"></a><span id="l69.23"> };</span>
<a href="#l69.24"></a><span id="l69.24"> </span>
<a href="#l69.25"></a><span id="l69.25" class="difflineminus">-#define MimeMultipartDigestClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l69.26"></a><span id="l69.26" class="difflineminus">-  { MimeMultipartClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l69.27"></a><span id="l69.27" class="difflineplus">+#define MimeMultipartDigestClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l69.28"></a><span id="l69.28" class="difflineplus">+  { MimeMultipartClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l69.29"></a><span id="l69.29"> </span>
<a href="#l69.30"></a><span id="l69.30"> #endif /* _MIMEMDIG_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mailnews/mime/src/mimemmix.cpp</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mailnews/mime/src/mimemmix.cpp</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -3,19 +3,17 @@</span>
<a href="#l70.4"></a><span id="l70.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l70.5"></a><span id="l70.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l70.6"></a><span id="l70.6"> </span>
<a href="#l70.7"></a><span id="l70.7"> #include &quot;mimemmix.h&quot;</span>
<a href="#l70.8"></a><span id="l70.8"> #include &quot;prlog.h&quot;</span>
<a href="#l70.9"></a><span id="l70.9"> </span>
<a href="#l70.10"></a><span id="l70.10"> #define MIME_SUPERCLASS mimeMultipartClass</span>
<a href="#l70.11"></a><span id="l70.11"> MimeDefClass(MimeMultipartMixed, MimeMultipartMixedClass,</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-       mimeMultipartMixedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+             mimeMultipartMixedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l70.14"></a><span id="l70.14"> </span>
<a href="#l70.15"></a><span id="l70.15" class="difflineminus">-static int</span>
<a href="#l70.16"></a><span id="l70.16" class="difflineminus">-MimeMultipartMixedClassInitialize(MimeMultipartMixedClass *clazz)</span>
<a href="#l70.17"></a><span id="l70.17" class="difflineminus">-{</span>
<a href="#l70.18"></a><span id="l70.18" class="difflineplus">+static int MimeMultipartMixedClassInitialize(MimeMultipartMixedClass *clazz) {</span>
<a href="#l70.19"></a><span id="l70.19"> #ifdef DEBUG</span>
<a href="#l70.20"></a><span id="l70.20" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l70.21"></a><span id="l70.21" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l70.22"></a><span id="l70.22">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l70.23"></a><span id="l70.23"> #endif</span>
<a href="#l70.24"></a><span id="l70.24">   return 0;</span>
<a href="#l70.25"></a><span id="l70.25"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/mailnews/mime/src/mimemmix.h</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/mailnews/mime/src/mimemmix.h</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -9,24 +9,24 @@</span>
<a href="#l71.4"></a><span id="l71.4"> #include &quot;mimemult.h&quot;</span>
<a href="#l71.5"></a><span id="l71.5"> </span>
<a href="#l71.6"></a><span id="l71.6"> /* The MimeMultipartMixed class implements the multipart/mixed MIME container,</span>
<a href="#l71.7"></a><span id="l71.7">    and is also used for any and all otherwise-unrecognised subparts of</span>
<a href="#l71.8"></a><span id="l71.8">    multipart/.</span>
<a href="#l71.9"></a><span id="l71.9">  */</span>
<a href="#l71.10"></a><span id="l71.10"> </span>
<a href="#l71.11"></a><span id="l71.11"> typedef struct MimeMultipartMixedClass MimeMultipartMixedClass;</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-typedef struct MimeMultipartMixed      MimeMultipartMixed;</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+typedef struct MimeMultipartMixed MimeMultipartMixed;</span>
<a href="#l71.14"></a><span id="l71.14"> </span>
<a href="#l71.15"></a><span id="l71.15"> struct MimeMultipartMixedClass {</span>
<a href="#l71.16"></a><span id="l71.16">   MimeMultipartClass multipart;</span>
<a href="#l71.17"></a><span id="l71.17"> };</span>
<a href="#l71.18"></a><span id="l71.18"> </span>
<a href="#l71.19"></a><span id="l71.19"> extern MimeMultipartMixedClass mimeMultipartMixedClass;</span>
<a href="#l71.20"></a><span id="l71.20"> </span>
<a href="#l71.21"></a><span id="l71.21"> struct MimeMultipartMixed {</span>
<a href="#l71.22"></a><span id="l71.22">   MimeMultipart multipart;</span>
<a href="#l71.23"></a><span id="l71.23"> };</span>
<a href="#l71.24"></a><span id="l71.24"> </span>
<a href="#l71.25"></a><span id="l71.25" class="difflineminus">-#define MimeMultipartMixedClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l71.26"></a><span id="l71.26" class="difflineminus">-  { MimeMultipartClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l71.27"></a><span id="l71.27" class="difflineplus">+#define MimeMultipartMixedClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l71.28"></a><span id="l71.28" class="difflineplus">+  { MimeMultipartClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l71.29"></a><span id="l71.29"> </span>
<a href="#l71.30"></a><span id="l71.30"> #endif /* _MIMEMMIX_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -2,25 +2,25 @@</span>
<a href="#l72.4"></a><span id="l72.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l72.5"></a><span id="l72.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l72.6"></a><span id="l72.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l72.7"></a><span id="l72.7"> #include &quot;prlog.h&quot;</span>
<a href="#l72.8"></a><span id="l72.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l72.9"></a><span id="l72.9"> #include &quot;modlmime.h&quot;</span>
<a href="#l72.10"></a><span id="l72.10"> #include &quot;mimeobj.h&quot;</span>
<a href="#l72.11"></a><span id="l72.11"> #include &quot;mimemsg.h&quot;</span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-#include &quot;mimetric.h&quot;   /* for MIME_RichtextConverter */</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+#include &quot;mimetric.h&quot; /* for MIME_RichtextConverter */</span>
<a href="#l72.14"></a><span id="l72.14"> #include &quot;mimethtm.h&quot;</span>
<a href="#l72.15"></a><span id="l72.15"> #include &quot;mimemsig.h&quot;</span>
<a href="#l72.16"></a><span id="l72.16"> #include &quot;mimemrel.h&quot;</span>
<a href="#l72.17"></a><span id="l72.17"> #include &quot;mimemalt.h&quot;</span>
<a href="#l72.18"></a><span id="l72.18"> #include &quot;mimebuf.h&quot;</span>
<a href="#l72.19"></a><span id="l72.19"> #include &quot;mimemapl.h&quot;</span>
<a href="#l72.20"></a><span id="l72.20"> #include &quot;prprf.h&quot;</span>
<a href="#l72.21"></a><span id="l72.21" class="difflineminus">-#include &quot;mimei.h&quot;      /* for moved MimeDisplayData struct */</span>
<a href="#l72.22"></a><span id="l72.22" class="difflineplus">+#include &quot;mimei.h&quot; /* for moved MimeDisplayData struct */</span>
<a href="#l72.23"></a><span id="l72.23"> #include &quot;mimebuf.h&quot;</span>
<a href="#l72.24"></a><span id="l72.24"> #include &quot;prmem.h&quot;</span>
<a href="#l72.25"></a><span id="l72.25"> #include &quot;plstr.h&quot;</span>
<a href="#l72.26"></a><span id="l72.26"> #include &quot;prmem.h&quot;</span>
<a href="#l72.27"></a><span id="l72.27"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l72.28"></a><span id="l72.28"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l72.29"></a><span id="l72.29"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l72.30"></a><span id="l72.30"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l72.31"></a><span id="l72.31" class="difflineat">@@ -47,634 +47,593 @@</span>
<a href="#l72.32"></a><span id="l72.32"> // &lt;for functions=&quot;HTML2Plaintext,HTMLSantinize&quot;&gt;</span>
<a href="#l72.33"></a><span id="l72.33"> #include &quot;nsXPCOM.h&quot;</span>
<a href="#l72.34"></a><span id="l72.34"> #include &quot;nsLayoutCID.h&quot;</span>
<a href="#l72.35"></a><span id="l72.35"> #include &quot;nsIParserUtils.h&quot;</span>
<a href="#l72.36"></a><span id="l72.36"> // &lt;/for&gt;</span>
<a href="#l72.37"></a><span id="l72.37"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l72.38"></a><span id="l72.38"> #include &quot;mozilla/Unused.h&quot;</span>
<a href="#l72.39"></a><span id="l72.39"> </span>
<a href="#l72.40"></a><span id="l72.40" class="difflineminus">-void                 ValidateRealName(nsMsgAttachmentData *aAttach, MimeHeaders *aHdrs);</span>
<a href="#l72.41"></a><span id="l72.41" class="difflineplus">+void ValidateRealName(nsMsgAttachmentData *aAttach, MimeHeaders *aHdrs);</span>
<a href="#l72.42"></a><span id="l72.42"> </span>
<a href="#l72.43"></a><span id="l72.43"> static MimeHeadersState MIME_HeaderType;</span>
<a href="#l72.44"></a><span id="l72.44"> static bool MIME_WrapLongLines;</span>
<a href="#l72.45"></a><span id="l72.45"> static bool MIME_VariableWidthPlaintext;</span>
<a href="#l72.46"></a><span id="l72.46"> </span>
<a href="#l72.47"></a><span id="l72.47" class="difflineminus">-mime_stream_data::mime_stream_data() : url_name(nullptr), orig_url_name(nullptr),</span>
<a href="#l72.48"></a><span id="l72.48" class="difflineminus">-  pluginObj2(nullptr), istream(nullptr), obj(nullptr), options(nullptr),</span>
<a href="#l72.49"></a><span id="l72.49" class="difflineminus">-  headers(nullptr), output_emitter(nullptr), firstCheck(false)</span>
<a href="#l72.50"></a><span id="l72.50" class="difflineminus">-{</span>
<a href="#l72.51"></a><span id="l72.51" class="difflineminus">-}</span>
<a href="#l72.52"></a><span id="l72.52" class="difflineplus">+mime_stream_data::mime_stream_data()</span>
<a href="#l72.53"></a><span id="l72.53" class="difflineplus">+    : url_name(nullptr),</span>
<a href="#l72.54"></a><span id="l72.54" class="difflineplus">+      orig_url_name(nullptr),</span>
<a href="#l72.55"></a><span id="l72.55" class="difflineplus">+      pluginObj2(nullptr),</span>
<a href="#l72.56"></a><span id="l72.56" class="difflineplus">+      istream(nullptr),</span>
<a href="#l72.57"></a><span id="l72.57" class="difflineplus">+      obj(nullptr),</span>
<a href="#l72.58"></a><span id="l72.58" class="difflineplus">+      options(nullptr),</span>
<a href="#l72.59"></a><span id="l72.59" class="difflineplus">+      headers(nullptr),</span>
<a href="#l72.60"></a><span id="l72.60" class="difflineplus">+      output_emitter(nullptr),</span>
<a href="#l72.61"></a><span id="l72.61" class="difflineplus">+      firstCheck(false) {}</span>
<a href="#l72.62"></a><span id="l72.62"> </span>
<a href="#l72.63"></a><span id="l72.63"> ////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l72.64"></a><span id="l72.64"> // Attachment handling routines</span>
<a href="#l72.65"></a><span id="l72.65"> ////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l72.66"></a><span id="l72.66"> //</span>
<a href="#l72.67"></a><span id="l72.67" class="difflineminus">-MimeObject    *mime_get_main_object(MimeObject* obj);</span>
<a href="#l72.68"></a><span id="l72.68" class="difflineplus">+MimeObject *mime_get_main_object(MimeObject *obj);</span>
<a href="#l72.69"></a><span id="l72.69"> </span>
<a href="#l72.70"></a><span id="l72.70"> nsresult MimeGetSize(MimeObject *child, int32_t *size) {</span>
<a href="#l72.71"></a><span id="l72.71" class="difflineminus">-  bool isLeaf = mime_subclass_p(child-&gt;clazz, (MimeObjectClass *) &amp;mimeLeafClass);</span>
<a href="#l72.72"></a><span id="l72.72" class="difflineminus">-  bool isContainer = mime_subclass_p(child-&gt;clazz, (MimeObjectClass *) &amp;mimeContainerClass);</span>
<a href="#l72.73"></a><span id="l72.73" class="difflineminus">-  bool isMsg = mime_subclass_p(child-&gt;clazz, (MimeObjectClass *) &amp;mimeMessageClass);</span>
<a href="#l72.74"></a><span id="l72.74" class="difflineplus">+  bool isLeaf =</span>
<a href="#l72.75"></a><span id="l72.75" class="difflineplus">+      mime_subclass_p(child-&gt;clazz, (MimeObjectClass *)&amp;mimeLeafClass);</span>
<a href="#l72.76"></a><span id="l72.76" class="difflineplus">+  bool isContainer =</span>
<a href="#l72.77"></a><span id="l72.77" class="difflineplus">+      mime_subclass_p(child-&gt;clazz, (MimeObjectClass *)&amp;mimeContainerClass);</span>
<a href="#l72.78"></a><span id="l72.78" class="difflineplus">+  bool isMsg =</span>
<a href="#l72.79"></a><span id="l72.79" class="difflineplus">+      mime_subclass_p(child-&gt;clazz, (MimeObjectClass *)&amp;mimeMessageClass);</span>
<a href="#l72.80"></a><span id="l72.80"> </span>
<a href="#l72.81"></a><span id="l72.81">   if (isLeaf) {</span>
<a href="#l72.82"></a><span id="l72.82">     *size += ((MimeLeaf *)child)-&gt;sizeSoFar;</span>
<a href="#l72.83"></a><span id="l72.83">   } else if (isMsg) {</span>
<a href="#l72.84"></a><span id="l72.84">     *size += ((MimeMessage *)child)-&gt;sizeSoFar;</span>
<a href="#l72.85"></a><span id="l72.85">   } else if (isContainer) {</span>
<a href="#l72.86"></a><span id="l72.86">     int i;</span>
<a href="#l72.87"></a><span id="l72.87">     MimeContainer *cont = (MimeContainer *)child;</span>
<a href="#l72.88"></a><span id="l72.88">     for (i = 0; i &lt; cont-&gt;nchildren; ++i) {</span>
<a href="#l72.89"></a><span id="l72.89">       MimeGetSize(cont-&gt;children[i], size);</span>
<a href="#l72.90"></a><span id="l72.90">     }</span>
<a href="#l72.91"></a><span id="l72.91">   }</span>
<a href="#l72.92"></a><span id="l72.92">   return NS_OK;</span>
<a href="#l72.93"></a><span id="l72.93"> }</span>
<a href="#l72.94"></a><span id="l72.94"> </span>
<a href="#l72.95"></a><span id="l72.95" class="difflineminus">-nsresult</span>
<a href="#l72.96"></a><span id="l72.96" class="difflineminus">-ProcessBodyAsAttachment(MimeObject *obj, nsMsgAttachmentData **data)</span>
<a href="#l72.97"></a><span id="l72.97" class="difflineminus">-{</span>
<a href="#l72.98"></a><span id="l72.98" class="difflineminus">-  nsMsgAttachmentData   *tmp;</span>
<a href="#l72.99"></a><span id="l72.99" class="difflineminus">-  char                  *disp = nullptr;</span>
<a href="#l72.100"></a><span id="l72.100" class="difflineminus">-  char                  *charset = nullptr;</span>
<a href="#l72.101"></a><span id="l72.101" class="difflineplus">+nsresult ProcessBodyAsAttachment(MimeObject *obj, nsMsgAttachmentData **data) {</span>
<a href="#l72.102"></a><span id="l72.102" class="difflineplus">+  nsMsgAttachmentData *tmp;</span>
<a href="#l72.103"></a><span id="l72.103" class="difflineplus">+  char *disp = nullptr;</span>
<a href="#l72.104"></a><span id="l72.104" class="difflineplus">+  char *charset = nullptr;</span>
<a href="#l72.105"></a><span id="l72.105"> </span>
<a href="#l72.106"></a><span id="l72.106">   // Ok, this is the special case when somebody sends an &quot;attachment&quot; as the</span>
<a href="#l72.107"></a><span id="l72.107">   // body of an RFC822 message...I really don't think this is the way this</span>
<a href="#l72.108"></a><span id="l72.108">   // should be done.  I believe this should really be a multipart/mixed message</span>
<a href="#l72.109"></a><span id="l72.109">   // with an empty body part, but what can ya do...our friends to the North seem</span>
<a href="#l72.110"></a><span id="l72.110">   // to do this.</span>
<a href="#l72.111"></a><span id="l72.111" class="difflineminus">-  MimeObject    *child = obj;</span>
<a href="#l72.112"></a><span id="l72.112" class="difflineplus">+  MimeObject *child = obj;</span>
<a href="#l72.113"></a><span id="l72.113"> </span>
<a href="#l72.114"></a><span id="l72.114">   *data = new nsMsgAttachmentData[2];</span>
<a href="#l72.115"></a><span id="l72.115" class="difflineminus">-  if (!*data)</span>
<a href="#l72.116"></a><span id="l72.116" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.117"></a><span id="l72.117" class="difflineplus">+  if (!*data) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.118"></a><span id="l72.118"> </span>
<a href="#l72.119"></a><span id="l72.119">   tmp = *data;</span>
<a href="#l72.120"></a><span id="l72.120">   tmp-&gt;m_realType = child-&gt;content_type;</span>
<a href="#l72.121"></a><span id="l72.121">   tmp-&gt;m_realEncoding = child-&gt;encoding;</span>
<a href="#l72.122"></a><span id="l72.122" class="difflineminus">-  disp = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_DISPOSITION, false, false);</span>
<a href="#l72.123"></a><span id="l72.123" class="difflineminus">-  tmp-&gt;m_realName.Adopt(MimeHeaders_get_parameter(disp, &quot;name&quot;, &amp;charset, NULL));</span>
<a href="#l72.124"></a><span id="l72.124" class="difflineminus">-  if (!tmp-&gt;m_realName.IsEmpty())</span>
<a href="#l72.125"></a><span id="l72.125" class="difflineminus">-  {</span>
<a href="#l72.126"></a><span id="l72.126" class="difflineplus">+  disp =</span>
<a href="#l72.127"></a><span id="l72.127" class="difflineplus">+      MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_DISPOSITION, false, false);</span>
<a href="#l72.128"></a><span id="l72.128" class="difflineplus">+  tmp-&gt;m_realName.Adopt(</span>
<a href="#l72.129"></a><span id="l72.129" class="difflineplus">+      MimeHeaders_get_parameter(disp, &quot;name&quot;, &amp;charset, NULL));</span>
<a href="#l72.130"></a><span id="l72.130" class="difflineplus">+  if (!tmp-&gt;m_realName.IsEmpty()) {</span>
<a href="#l72.131"></a><span id="l72.131">     char *fname = NULL;</span>
<a href="#l72.132"></a><span id="l72.132">     fname = mime_decode_filename(tmp-&gt;m_realName.get(), charset, obj-&gt;options);</span>
<a href="#l72.133"></a><span id="l72.133">     free(charset);</span>
<a href="#l72.134"></a><span id="l72.134" class="difflineminus">-    if (fname)</span>
<a href="#l72.135"></a><span id="l72.135" class="difflineminus">-      tmp-&gt;m_realName.Adopt(fname);</span>
<a href="#l72.136"></a><span id="l72.136" class="difflineminus">-  }</span>
<a href="#l72.137"></a><span id="l72.137" class="difflineminus">-  else</span>
<a href="#l72.138"></a><span id="l72.138" class="difflineminus">-  {</span>
<a href="#l72.139"></a><span id="l72.139" class="difflineplus">+    if (fname) tmp-&gt;m_realName.Adopt(fname);</span>
<a href="#l72.140"></a><span id="l72.140" class="difflineplus">+  } else {</span>
<a href="#l72.141"></a><span id="l72.141">     tmp-&gt;m_realName.Adopt(MimeHeaders_get_name(child-&gt;headers, obj-&gt;options));</span>
<a href="#l72.142"></a><span id="l72.142"> </span>
<a href="#l72.143"></a><span id="l72.143">     if (tmp-&gt;m_realName.IsEmpty() &amp;&amp;</span>
<a href="#l72.144"></a><span id="l72.144" class="difflineminus">-        tmp-&gt;m_realType.LowerCaseEqualsLiteral(MESSAGE_RFC822))</span>
<a href="#l72.145"></a><span id="l72.145" class="difflineminus">-    {</span>
<a href="#l72.146"></a><span id="l72.146" class="difflineplus">+        tmp-&gt;m_realType.LowerCaseEqualsLiteral(MESSAGE_RFC822)) {</span>
<a href="#l72.147"></a><span id="l72.147">       // We haven't actually parsed the message &quot;attachment&quot;, so just give it a</span>
<a href="#l72.148"></a><span id="l72.148">       // generic name.</span>
<a href="#l72.149"></a><span id="l72.149">       tmp-&gt;m_realName = &quot;AttachedMessage.eml&quot;;</span>
<a href="#l72.150"></a><span id="l72.150">     }</span>
<a href="#l72.151"></a><span id="l72.151">   }</span>
<a href="#l72.152"></a><span id="l72.152"> </span>
<a href="#l72.153"></a><span id="l72.153">   tmp-&gt;m_hasFilename = !tmp-&gt;m_realName.IsEmpty();</span>
<a href="#l72.154"></a><span id="l72.154"> </span>
<a href="#l72.155"></a><span id="l72.155">   if (tmp-&gt;m_realName.IsEmpty() &amp;&amp;</span>
<a href="#l72.156"></a><span id="l72.156">       StringBeginsWith(tmp-&gt;m_realType, NS_LITERAL_CSTRING(&quot;text&quot;),</span>
<a href="#l72.157"></a><span id="l72.157">                        nsCaseInsensitiveCStringComparator()))</span>
<a href="#l72.158"></a><span id="l72.158">     ValidateRealName(tmp, child-&gt;headers);</span>
<a href="#l72.159"></a><span id="l72.159"> </span>
<a href="#l72.160"></a><span id="l72.160" class="difflineminus">-  tmp-&gt;m_displayableInline = obj-&gt;clazz-&gt;displayable_inline_p(obj-&gt;clazz,</span>
<a href="#l72.161"></a><span id="l72.161" class="difflineminus">-                                                              obj-&gt;headers);</span>
<a href="#l72.162"></a><span id="l72.162" class="difflineplus">+  tmp-&gt;m_displayableInline =</span>
<a href="#l72.163"></a><span id="l72.163" class="difflineplus">+      obj-&gt;clazz-&gt;displayable_inline_p(obj-&gt;clazz, obj-&gt;headers);</span>
<a href="#l72.164"></a><span id="l72.164"> </span>
<a href="#l72.165"></a><span id="l72.165" class="difflineminus">-  char  *tmpURL = nullptr;</span>
<a href="#l72.166"></a><span id="l72.166" class="difflineminus">-  char  *id = nullptr;</span>
<a href="#l72.167"></a><span id="l72.167" class="difflineminus">-  char  *id_imap = nullptr;</span>
<a href="#l72.168"></a><span id="l72.168" class="difflineplus">+  char *tmpURL = nullptr;</span>
<a href="#l72.169"></a><span id="l72.169" class="difflineplus">+  char *id = nullptr;</span>
<a href="#l72.170"></a><span id="l72.170" class="difflineplus">+  char *id_imap = nullptr;</span>
<a href="#l72.171"></a><span id="l72.171"> </span>
<a href="#l72.172"></a><span id="l72.172" class="difflineminus">-  id = mime_part_address (obj);</span>
<a href="#l72.173"></a><span id="l72.173" class="difflineminus">-  if (obj-&gt;options-&gt;missing_parts)</span>
<a href="#l72.174"></a><span id="l72.174" class="difflineminus">-    id_imap = mime_imap_part_address (obj);</span>
<a href="#l72.175"></a><span id="l72.175" class="difflineplus">+  id = mime_part_address(obj);</span>
<a href="#l72.176"></a><span id="l72.176" class="difflineplus">+  if (obj-&gt;options-&gt;missing_parts) id_imap = mime_imap_part_address(obj);</span>
<a href="#l72.177"></a><span id="l72.177"> </span>
<a href="#l72.178"></a><span id="l72.178">   tmp-&gt;m_isDownloaded = !id_imap;</span>
<a href="#l72.179"></a><span id="l72.179"> </span>
<a href="#l72.180"></a><span id="l72.180" class="difflineminus">-  if (! id)</span>
<a href="#l72.181"></a><span id="l72.181" class="difflineminus">-  {</span>
<a href="#l72.182"></a><span id="l72.182" class="difflineminus">-    delete [] *data;</span>
<a href="#l72.183"></a><span id="l72.183" class="difflineplus">+  if (!id) {</span>
<a href="#l72.184"></a><span id="l72.184" class="difflineplus">+    delete[] * data;</span>
<a href="#l72.185"></a><span id="l72.185">     *data = nullptr;</span>
<a href="#l72.186"></a><span id="l72.186">     PR_FREEIF(id_imap);</span>
<a href="#l72.187"></a><span id="l72.187">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.188"></a><span id="l72.188">   }</span>
<a href="#l72.189"></a><span id="l72.189"> </span>
<a href="#l72.190"></a><span id="l72.190" class="difflineminus">-  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;url)</span>
<a href="#l72.191"></a><span id="l72.191" class="difflineminus">-  {</span>
<a href="#l72.192"></a><span id="l72.192" class="difflineminus">-    const char  *url = obj-&gt;options-&gt;url;</span>
<a href="#l72.193"></a><span id="l72.193" class="difflineminus">-    nsresult    rv;</span>
<a href="#l72.194"></a><span id="l72.194" class="difflineminus">-    if (id_imap &amp;&amp; id)</span>
<a href="#l72.195"></a><span id="l72.195" class="difflineminus">-    {</span>
<a href="#l72.196"></a><span id="l72.196" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;url) {</span>
<a href="#l72.197"></a><span id="l72.197" class="difflineplus">+    const char *url = obj-&gt;options-&gt;url;</span>
<a href="#l72.198"></a><span id="l72.198" class="difflineplus">+    nsresult rv;</span>
<a href="#l72.199"></a><span id="l72.199" class="difflineplus">+    if (id_imap &amp;&amp; id) {</span>
<a href="#l72.200"></a><span id="l72.200">       // if this is an IMAP part.</span>
<a href="#l72.201"></a><span id="l72.201">       tmpURL = mime_set_url_imap_part(url, id_imap, id);</span>
<a href="#l72.202"></a><span id="l72.202">       rv = nsMimeNewURI(getter_AddRefs(tmp-&gt;m_url), tmpURL, nullptr);</span>
<a href="#l72.203"></a><span id="l72.203" class="difflineminus">-    }</span>
<a href="#l72.204"></a><span id="l72.204" class="difflineminus">-    else</span>
<a href="#l72.205"></a><span id="l72.205" class="difflineminus">-    {</span>
<a href="#l72.206"></a><span id="l72.206" class="difflineplus">+    } else {</span>
<a href="#l72.207"></a><span id="l72.207">       // This is just a normal MIME part as usual.</span>
<a href="#l72.208"></a><span id="l72.208">       tmpURL = mime_set_url_part(url, id, true);</span>
<a href="#l72.209"></a><span id="l72.209">       rv = nsMimeNewURI(getter_AddRefs(tmp-&gt;m_url), tmpURL, nullptr);</span>
<a href="#l72.210"></a><span id="l72.210">     }</span>
<a href="#l72.211"></a><span id="l72.211"> </span>
<a href="#l72.212"></a><span id="l72.212" class="difflineminus">-    if (!tmp-&gt;m_url || NS_FAILED(rv))</span>
<a href="#l72.213"></a><span id="l72.213" class="difflineminus">-    {</span>
<a href="#l72.214"></a><span id="l72.214" class="difflineminus">-      delete [] *data;</span>
<a href="#l72.215"></a><span id="l72.215" class="difflineplus">+    if (!tmp-&gt;m_url || NS_FAILED(rv)) {</span>
<a href="#l72.216"></a><span id="l72.216" class="difflineplus">+      delete[] * data;</span>
<a href="#l72.217"></a><span id="l72.217">       *data = nullptr;</span>
<a href="#l72.218"></a><span id="l72.218">       PR_FREEIF(id);</span>
<a href="#l72.219"></a><span id="l72.219">       PR_FREEIF(id_imap);</span>
<a href="#l72.220"></a><span id="l72.220">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.221"></a><span id="l72.221">     }</span>
<a href="#l72.222"></a><span id="l72.222">   }</span>
<a href="#l72.223"></a><span id="l72.223">   PR_FREEIF(id);</span>
<a href="#l72.224"></a><span id="l72.224">   PR_FREEIF(id_imap);</span>
<a href="#l72.225"></a><span id="l72.225">   PR_FREEIF(tmpURL);</span>
<a href="#l72.226"></a><span id="l72.226" class="difflineminus">-  tmp-&gt;m_description.Adopt(MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_DESCRIPTION, false, false));</span>
<a href="#l72.227"></a><span id="l72.227" class="difflineplus">+  tmp-&gt;m_description.Adopt(MimeHeaders_get(</span>
<a href="#l72.228"></a><span id="l72.228" class="difflineplus">+      child-&gt;headers, HEADER_CONTENT_DESCRIPTION, false, false));</span>
<a href="#l72.229"></a><span id="l72.229"> </span>
<a href="#l72.230"></a><span id="l72.230">   tmp-&gt;m_size = 0;</span>
<a href="#l72.231"></a><span id="l72.231">   MimeGetSize(child, &amp;tmp-&gt;m_size);</span>
<a href="#l72.232"></a><span id="l72.232"> </span>
<a href="#l72.233"></a><span id="l72.233">   return NS_OK;</span>
<a href="#l72.234"></a><span id="l72.234"> }</span>
<a href="#l72.235"></a><span id="l72.235"> </span>
<a href="#l72.236"></a><span id="l72.236" class="difflineminus">-int32_t</span>
<a href="#l72.237"></a><span id="l72.237" class="difflineminus">-CountTotalMimeAttachments(MimeContainer *aObj)</span>
<a href="#l72.238"></a><span id="l72.238" class="difflineminus">-{</span>
<a href="#l72.239"></a><span id="l72.239" class="difflineminus">-  int32_t     i;</span>
<a href="#l72.240"></a><span id="l72.240" class="difflineminus">-  int32_t     rc = 0;</span>
<a href="#l72.241"></a><span id="l72.241" class="difflineplus">+int32_t CountTotalMimeAttachments(MimeContainer *aObj) {</span>
<a href="#l72.242"></a><span id="l72.242" class="difflineplus">+  int32_t i;</span>
<a href="#l72.243"></a><span id="l72.243" class="difflineplus">+  int32_t rc = 0;</span>
<a href="#l72.244"></a><span id="l72.244"> </span>
<a href="#l72.245"></a><span id="l72.245" class="difflineminus">-  if ( (!aObj) || (!aObj-&gt;children) || (aObj-&gt;nchildren &lt;= 0) )</span>
<a href="#l72.246"></a><span id="l72.246" class="difflineplus">+  if ((!aObj) || (!aObj-&gt;children) || (aObj-&gt;nchildren &lt;= 0)) return 0;</span>
<a href="#l72.247"></a><span id="l72.247" class="difflineplus">+</span>
<a href="#l72.248"></a><span id="l72.248" class="difflineplus">+  if (!mime_typep(((MimeObject *)aObj), (MimeObjectClass *)&amp;mimeContainerClass))</span>
<a href="#l72.249"></a><span id="l72.249">     return 0;</span>
<a href="#l72.250"></a><span id="l72.250"> </span>
<a href="#l72.251"></a><span id="l72.251" class="difflineminus">-  if (!mime_typep(((MimeObject *) aObj), (MimeObjectClass*) &amp;mimeContainerClass))</span>
<a href="#l72.252"></a><span id="l72.252" class="difflineminus">-    return 0;</span>
<a href="#l72.253"></a><span id="l72.253" class="difflineminus">-</span>
<a href="#l72.254"></a><span id="l72.254" class="difflineminus">-  for (i=0; i&lt;aObj-&gt;nchildren; i++)</span>
<a href="#l72.255"></a><span id="l72.255" class="difflineplus">+  for (i = 0; i &lt; aObj-&gt;nchildren; i++)</span>
<a href="#l72.256"></a><span id="l72.256">     rc += CountTotalMimeAttachments((MimeContainer *)aObj-&gt;children[i]) + 1;</span>
<a href="#l72.257"></a><span id="l72.257"> </span>
<a href="#l72.258"></a><span id="l72.258">   return rc;</span>
<a href="#l72.259"></a><span id="l72.259"> }</span>
<a href="#l72.260"></a><span id="l72.260"> </span>
<a href="#l72.261"></a><span id="l72.261" class="difflineminus">-void</span>
<a href="#l72.262"></a><span id="l72.262" class="difflineminus">-ValidateRealName(nsMsgAttachmentData *aAttach, MimeHeaders *aHdrs)</span>
<a href="#l72.263"></a><span id="l72.263" class="difflineminus">-{</span>
<a href="#l72.264"></a><span id="l72.264" class="difflineplus">+void ValidateRealName(nsMsgAttachmentData *aAttach, MimeHeaders *aHdrs) {</span>
<a href="#l72.265"></a><span id="l72.265">   // Sanity.</span>
<a href="#l72.266"></a><span id="l72.266" class="difflineminus">-  if (!aAttach)</span>
<a href="#l72.267"></a><span id="l72.267" class="difflineminus">-    return;</span>
<a href="#l72.268"></a><span id="l72.268" class="difflineplus">+  if (!aAttach) return;</span>
<a href="#l72.269"></a><span id="l72.269"> </span>
<a href="#l72.270"></a><span id="l72.270">   // Do we need to validate?</span>
<a href="#l72.271"></a><span id="l72.271" class="difflineminus">-  if (!aAttach-&gt;m_realName.IsEmpty())</span>
<a href="#l72.272"></a><span id="l72.272" class="difflineminus">-    return;</span>
<a href="#l72.273"></a><span id="l72.273" class="difflineplus">+  if (!aAttach-&gt;m_realName.IsEmpty()) return;</span>
<a href="#l72.274"></a><span id="l72.274"> </span>
<a href="#l72.275"></a><span id="l72.275">   // Internal MIME structures need not be named!</span>
<a href="#l72.276"></a><span id="l72.276">   if (aAttach-&gt;m_realType.IsEmpty() ||</span>
<a href="#l72.277"></a><span id="l72.277">       StringBeginsWith(aAttach-&gt;m_realType, NS_LITERAL_CSTRING(&quot;multipart&quot;),</span>
<a href="#l72.278"></a><span id="l72.278">                        nsCaseInsensitiveCStringComparator()))</span>
<a href="#l72.279"></a><span id="l72.279">     return;</span>
<a href="#l72.280"></a><span id="l72.280"> </span>
<a href="#l72.281"></a><span id="l72.281">   //</span>
<a href="#l72.282"></a><span id="l72.282">   // Now validate any other name we have for the attachment!</span>
<a href="#l72.283"></a><span id="l72.283">   //</span>
<a href="#l72.284"></a><span id="l72.284" class="difflineminus">-  if (aAttach-&gt;m_realName.IsEmpty())</span>
<a href="#l72.285"></a><span id="l72.285" class="difflineminus">-  {</span>
<a href="#l72.286"></a><span id="l72.286" class="difflineplus">+  if (aAttach-&gt;m_realName.IsEmpty()) {</span>
<a href="#l72.287"></a><span id="l72.287">     aAttach-&gt;m_realName = &quot;attachment&quot;;</span>
<a href="#l72.288"></a><span id="l72.288">     nsresult rv = NS_OK;</span>
<a href="#l72.289"></a><span id="l72.289" class="difflineminus">-    nsAutoCString contentType (aAttach-&gt;m_realType);</span>
<a href="#l72.290"></a><span id="l72.290" class="difflineplus">+    nsAutoCString contentType(aAttach-&gt;m_realType);</span>
<a href="#l72.291"></a><span id="l72.291">     int32_t pos = contentType.FindChar(';');</span>
<a href="#l72.292"></a><span id="l72.292" class="difflineminus">-    if (pos &gt; 0)</span>
<a href="#l72.293"></a><span id="l72.293" class="difflineminus">-      contentType.SetLength(pos);</span>
<a href="#l72.294"></a><span id="l72.294" class="difflineplus">+    if (pos &gt; 0) contentType.SetLength(pos);</span>
<a href="#l72.295"></a><span id="l72.295"> </span>
<a href="#l72.296"></a><span id="l72.296" class="difflineminus">-    nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder (do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l72.297"></a><span id="l72.297" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l72.298"></a><span id="l72.298" class="difflineminus">-    {</span>
<a href="#l72.299"></a><span id="l72.299" class="difflineplus">+    nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder(</span>
<a href="#l72.300"></a><span id="l72.300" class="difflineplus">+        do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l72.301"></a><span id="l72.301" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l72.302"></a><span id="l72.302">       nsAutoCString fileExtension;</span>
<a href="#l72.303"></a><span id="l72.303" class="difflineminus">-      rv = mimeFinder-&gt;GetPrimaryExtension(contentType, EmptyCString(), fileExtension);</span>
<a href="#l72.304"></a><span id="l72.304" class="difflineplus">+      rv = mimeFinder-&gt;GetPrimaryExtension(contentType, EmptyCString(),</span>
<a href="#l72.305"></a><span id="l72.305" class="difflineplus">+                                           fileExtension);</span>
<a href="#l72.306"></a><span id="l72.306"> </span>
<a href="#l72.307"></a><span id="l72.307" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !fileExtension.IsEmpty())</span>
<a href="#l72.308"></a><span id="l72.308" class="difflineminus">-      {</span>
<a href="#l72.309"></a><span id="l72.309" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; !fileExtension.IsEmpty()) {</span>
<a href="#l72.310"></a><span id="l72.310">         aAttach-&gt;m_realName.Append('.');</span>
<a href="#l72.311"></a><span id="l72.311">         aAttach-&gt;m_realName.Append(fileExtension);</span>
<a href="#l72.312"></a><span id="l72.312">       }</span>
<a href="#l72.313"></a><span id="l72.313">     }</span>
<a href="#l72.314"></a><span id="l72.314">   }</span>
<a href="#l72.315"></a><span id="l72.315"> }</span>
<a href="#l72.316"></a><span id="l72.316"> </span>
<a href="#l72.317"></a><span id="l72.317" class="difflineminus">-static  int32_t     attIndex = 0;</span>
<a href="#l72.318"></a><span id="l72.318" class="difflineplus">+static int32_t attIndex = 0;</span>
<a href="#l72.319"></a><span id="l72.319"> </span>
<a href="#l72.320"></a><span id="l72.320" class="difflineminus">-nsresult</span>
<a href="#l72.321"></a><span id="l72.321" class="difflineminus">-GenerateAttachmentData(MimeObject *object, const char *aMessageURL, MimeDisplayOptions *options,</span>
<a href="#l72.322"></a><span id="l72.322" class="difflineminus">-                       bool isAnAppleDoublePart, int32_t attSize, nsMsgAttachmentData *aAttachData)</span>
<a href="#l72.323"></a><span id="l72.323" class="difflineminus">-{</span>
<a href="#l72.324"></a><span id="l72.324" class="difflineplus">+nsresult GenerateAttachmentData(MimeObject *object, const char *aMessageURL,</span>
<a href="#l72.325"></a><span id="l72.325" class="difflineplus">+                                MimeDisplayOptions *options,</span>
<a href="#l72.326"></a><span id="l72.326" class="difflineplus">+                                bool isAnAppleDoublePart, int32_t attSize,</span>
<a href="#l72.327"></a><span id="l72.327" class="difflineplus">+                                nsMsgAttachmentData *aAttachData) {</span>
<a href="#l72.328"></a><span id="l72.328">   nsCString imappart;</span>
<a href="#l72.329"></a><span id="l72.329">   nsCString part;</span>
<a href="#l72.330"></a><span id="l72.330">   bool isExternalAttachment = false;</span>
<a href="#l72.331"></a><span id="l72.331"> </span>
<a href="#l72.332"></a><span id="l72.332">   /* be sure the object has not be marked as Not to be an attachment */</span>
<a href="#l72.333"></a><span id="l72.333" class="difflineminus">-  if (object-&gt;dontShowAsAttachment)</span>
<a href="#l72.334"></a><span id="l72.334" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.335"></a><span id="l72.335" class="difflineplus">+  if (object-&gt;dontShowAsAttachment) return NS_OK;</span>
<a href="#l72.336"></a><span id="l72.336"> </span>
<a href="#l72.337"></a><span id="l72.337">   part.Adopt(mime_part_address(object));</span>
<a href="#l72.338"></a><span id="l72.338" class="difflineminus">-  if (part.IsEmpty())</span>
<a href="#l72.339"></a><span id="l72.339" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.340"></a><span id="l72.340" class="difflineplus">+  if (part.IsEmpty()) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.341"></a><span id="l72.341"> </span>
<a href="#l72.342"></a><span id="l72.342" class="difflineminus">-  if (options-&gt;missing_parts)</span>
<a href="#l72.343"></a><span id="l72.343" class="difflineminus">-    imappart.Adopt(mime_imap_part_address(object));</span>
<a href="#l72.344"></a><span id="l72.344" class="difflineplus">+  if (options-&gt;missing_parts) imappart.Adopt(mime_imap_part_address(object));</span>
<a href="#l72.345"></a><span id="l72.345"> </span>
<a href="#l72.346"></a><span id="l72.346">   char *urlSpec = nullptr;</span>
<a href="#l72.347"></a><span id="l72.347" class="difflineminus">-  if (!imappart.IsEmpty())</span>
<a href="#l72.348"></a><span id="l72.348" class="difflineminus">-  {</span>
<a href="#l72.349"></a><span id="l72.349" class="difflineplus">+  if (!imappart.IsEmpty()) {</span>
<a href="#l72.350"></a><span id="l72.350">     urlSpec = mime_set_url_imap_part(aMessageURL, imappart.get(), part.get());</span>
<a href="#l72.351"></a><span id="l72.351" class="difflineminus">-  }</span>
<a href="#l72.352"></a><span id="l72.352" class="difflineminus">-  else</span>
<a href="#l72.353"></a><span id="l72.353" class="difflineminus">-  {</span>
<a href="#l72.354"></a><span id="l72.354" class="difflineplus">+  } else {</span>
<a href="#l72.355"></a><span id="l72.355">     char *no_part_url = nullptr;</span>
<a href="#l72.356"></a><span id="l72.356" class="difflineminus">-    if (options-&gt;part_to_load &amp;&amp; options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay)</span>
<a href="#l72.357"></a><span id="l72.357" class="difflineplus">+    if (options-&gt;part_to_load &amp;&amp;</span>
<a href="#l72.358"></a><span id="l72.358" class="difflineplus">+        options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay)</span>
<a href="#l72.359"></a><span id="l72.359">       no_part_url = mime_get_base_url(aMessageURL);</span>
<a href="#l72.360"></a><span id="l72.360">     if (no_part_url) {</span>
<a href="#l72.361"></a><span id="l72.361">       urlSpec = mime_set_url_part(no_part_url, part.get(), true);</span>
<a href="#l72.362"></a><span id="l72.362">       PR_Free(no_part_url);</span>
<a href="#l72.363"></a><span id="l72.363" class="difflineminus">-    }</span>
<a href="#l72.364"></a><span id="l72.364" class="difflineminus">-    else</span>
<a href="#l72.365"></a><span id="l72.365" class="difflineminus">-    {</span>
<a href="#l72.366"></a><span id="l72.366" class="difflineminus">-      // if the mime object contains an external attachment URL, then use it, otherwise</span>
<a href="#l72.367"></a><span id="l72.367" class="difflineminus">-      // fall back to creating an attachment url based on the message URI and the</span>
<a href="#l72.368"></a><span id="l72.368" class="difflineminus">-      // part number.</span>
<a href="#l72.369"></a><span id="l72.369" class="difflineplus">+    } else {</span>
<a href="#l72.370"></a><span id="l72.370" class="difflineplus">+      // if the mime object contains an external attachment URL, then use it,</span>
<a href="#l72.371"></a><span id="l72.371" class="difflineplus">+      // otherwise fall back to creating an attachment url based on the message</span>
<a href="#l72.372"></a><span id="l72.372" class="difflineplus">+      // URI and the part number.</span>
<a href="#l72.373"></a><span id="l72.373">       urlSpec = mime_external_attachment_url(object);</span>
<a href="#l72.374"></a><span id="l72.374">       isExternalAttachment = urlSpec ? true : false;</span>
<a href="#l72.375"></a><span id="l72.375" class="difflineminus">-      if (!urlSpec)</span>
<a href="#l72.376"></a><span id="l72.376" class="difflineminus">-        urlSpec = mime_set_url_part(aMessageURL, part.get(), true);</span>
<a href="#l72.377"></a><span id="l72.377" class="difflineplus">+      if (!urlSpec) urlSpec = mime_set_url_part(aMessageURL, part.get(), true);</span>
<a href="#l72.378"></a><span id="l72.378">     }</span>
<a href="#l72.379"></a><span id="l72.379">   }</span>
<a href="#l72.380"></a><span id="l72.380"> </span>
<a href="#l72.381"></a><span id="l72.381" class="difflineminus">-  if (!urlSpec)</span>
<a href="#l72.382"></a><span id="l72.382" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.383"></a><span id="l72.383" class="difflineplus">+  if (!urlSpec) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.384"></a><span id="l72.384"> </span>
<a href="#l72.385"></a><span id="l72.385" class="difflineminus">-  if ((options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay) &amp;&amp; (PL_strncasecmp(aMessageURL, urlSpec, strlen(urlSpec)) == 0))</span>
<a href="#l72.386"></a><span id="l72.386" class="difflineplus">+  if ((options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay) &amp;&amp;</span>
<a href="#l72.387"></a><span id="l72.387" class="difflineplus">+      (PL_strncasecmp(aMessageURL, urlSpec, strlen(urlSpec)) == 0))</span>
<a href="#l72.388"></a><span id="l72.388">     return NS_OK;</span>
<a href="#l72.389"></a><span id="l72.389"> </span>
<a href="#l72.390"></a><span id="l72.390">   nsCString urlString(urlSpec);</span>
<a href="#l72.391"></a><span id="l72.391"> </span>
<a href="#l72.392"></a><span id="l72.392">   nsMsgAttachmentData *tmp = &amp;(aAttachData[attIndex++]);</span>
<a href="#l72.393"></a><span id="l72.393"> </span>
<a href="#l72.394"></a><span id="l72.394">   tmp-&gt;m_realType = object-&gt;content_type;</span>
<a href="#l72.395"></a><span id="l72.395">   tmp-&gt;m_realEncoding = object-&gt;encoding;</span>
<a href="#l72.396"></a><span id="l72.396">   tmp-&gt;m_isExternalAttachment = isExternalAttachment;</span>
<a href="#l72.397"></a><span id="l72.397">   tmp-&gt;m_isExternalLinkAttachment =</span>
<a href="#l72.398"></a><span id="l72.398" class="difflineminus">-    (isExternalAttachment &amp;&amp;</span>
<a href="#l72.399"></a><span id="l72.399" class="difflineminus">-     StringBeginsWith(urlString, NS_LITERAL_CSTRING(&quot;http&quot;),</span>
<a href="#l72.400"></a><span id="l72.400" class="difflineminus">-                      nsCaseInsensitiveCStringComparator()));</span>
<a href="#l72.401"></a><span id="l72.401" class="difflineplus">+      (isExternalAttachment &amp;&amp;</span>
<a href="#l72.402"></a><span id="l72.402" class="difflineplus">+       StringBeginsWith(urlString, NS_LITERAL_CSTRING(&quot;http&quot;),</span>
<a href="#l72.403"></a><span id="l72.403" class="difflineplus">+                        nsCaseInsensitiveCStringComparator()));</span>
<a href="#l72.404"></a><span id="l72.404">   tmp-&gt;m_size = attSize;</span>
<a href="#l72.405"></a><span id="l72.405">   tmp-&gt;m_sizeExternalStr = &quot;-1&quot;;</span>
<a href="#l72.406"></a><span id="l72.406" class="difflineminus">-  tmp-&gt;m_disposition.Adopt(MimeHeaders_get(object-&gt;headers, HEADER_CONTENT_DISPOSITION, true, false));</span>
<a href="#l72.407"></a><span id="l72.407" class="difflineminus">-  tmp-&gt;m_displayableInline = object-&gt;clazz-&gt;displayable_inline_p(object-&gt;clazz, object-&gt;headers);</span>
<a href="#l72.408"></a><span id="l72.408" class="difflineplus">+  tmp-&gt;m_disposition.Adopt(MimeHeaders_get(</span>
<a href="#l72.409"></a><span id="l72.409" class="difflineplus">+      object-&gt;headers, HEADER_CONTENT_DISPOSITION, true, false));</span>
<a href="#l72.410"></a><span id="l72.410" class="difflineplus">+  tmp-&gt;m_displayableInline =</span>
<a href="#l72.411"></a><span id="l72.411" class="difflineplus">+      object-&gt;clazz-&gt;displayable_inline_p(object-&gt;clazz, object-&gt;headers);</span>
<a href="#l72.412"></a><span id="l72.412"> </span>
<a href="#l72.413"></a><span id="l72.413">   char *part_addr = mime_imap_part_address(object);</span>
<a href="#l72.414"></a><span id="l72.414">   tmp-&gt;m_isDownloaded = !part_addr;</span>
<a href="#l72.415"></a><span id="l72.415">   PR_FREEIF(part_addr);</span>
<a href="#l72.416"></a><span id="l72.416"> </span>
<a href="#l72.417"></a><span id="l72.417">   int32_t i;</span>
<a href="#l72.418"></a><span id="l72.418">   char *charset = nullptr;</span>
<a href="#l72.419"></a><span id="l72.419" class="difflineminus">-  char *disp = MimeHeaders_get(object-&gt;headers, HEADER_CONTENT_DISPOSITION, false, false);</span>
<a href="#l72.420"></a><span id="l72.420" class="difflineminus">-  if (disp)</span>
<a href="#l72.421"></a><span id="l72.421" class="difflineminus">-  {</span>
<a href="#l72.422"></a><span id="l72.422" class="difflineminus">-    tmp-&gt;m_realName.Adopt(MimeHeaders_get_parameter(disp, &quot;filename&quot;, &amp;charset, nullptr));</span>
<a href="#l72.423"></a><span id="l72.423" class="difflineplus">+  char *disp = MimeHeaders_get(object-&gt;headers, HEADER_CONTENT_DISPOSITION,</span>
<a href="#l72.424"></a><span id="l72.424" class="difflineplus">+                               false, false);</span>
<a href="#l72.425"></a><span id="l72.425" class="difflineplus">+  if (disp) {</span>
<a href="#l72.426"></a><span id="l72.426" class="difflineplus">+    tmp-&gt;m_realName.Adopt(</span>
<a href="#l72.427"></a><span id="l72.427" class="difflineplus">+        MimeHeaders_get_parameter(disp, &quot;filename&quot;, &amp;charset, nullptr));</span>
<a href="#l72.428"></a><span id="l72.428">     if (isAnAppleDoublePart)</span>
<a href="#l72.429"></a><span id="l72.429" class="difflineminus">-      for (i = 0; i &lt; 2 &amp;&amp; tmp-&gt;m_realName.IsEmpty(); i ++)</span>
<a href="#l72.430"></a><span id="l72.430" class="difflineminus">-      {</span>
<a href="#l72.431"></a><span id="l72.431" class="difflineplus">+      for (i = 0; i &lt; 2 &amp;&amp; tmp-&gt;m_realName.IsEmpty(); i++) {</span>
<a href="#l72.432"></a><span id="l72.432">         PR_FREEIF(disp);</span>
<a href="#l72.433"></a><span id="l72.433">         free(charset);</span>
<a href="#l72.434"></a><span id="l72.434" class="difflineminus">-        disp = MimeHeaders_get(((MimeContainer *)object)-&gt;children[i]-&gt;headers, HEADER_CONTENT_DISPOSITION, false, false);</span>
<a href="#l72.435"></a><span id="l72.435" class="difflineminus">-        tmp-&gt;m_realName.Adopt(MimeHeaders_get_parameter(disp, &quot;filename&quot;, &amp;charset, nullptr));</span>
<a href="#l72.436"></a><span id="l72.436" class="difflineplus">+        disp = MimeHeaders_get(((MimeContainer *)object)-&gt;children[i]-&gt;headers,</span>
<a href="#l72.437"></a><span id="l72.437" class="difflineplus">+                               HEADER_CONTENT_DISPOSITION, false, false);</span>
<a href="#l72.438"></a><span id="l72.438" class="difflineplus">+        tmp-&gt;m_realName.Adopt(</span>
<a href="#l72.439"></a><span id="l72.439" class="difflineplus">+            MimeHeaders_get_parameter(disp, &quot;filename&quot;, &amp;charset, nullptr));</span>
<a href="#l72.440"></a><span id="l72.440">       }</span>
<a href="#l72.441"></a><span id="l72.441"> </span>
<a href="#l72.442"></a><span id="l72.442" class="difflineminus">-    if (!tmp-&gt;m_realName.IsEmpty())</span>
<a href="#l72.443"></a><span id="l72.443" class="difflineminus">-    {</span>
<a href="#l72.444"></a><span id="l72.444" class="difflineplus">+    if (!tmp-&gt;m_realName.IsEmpty()) {</span>
<a href="#l72.445"></a><span id="l72.445">       // check encoded type</span>
<a href="#l72.446"></a><span id="l72.446">       //</span>
<a href="#l72.447"></a><span id="l72.447">       // The parameter of Content-Disposition must use RFC 2231.</span>
<a href="#l72.448"></a><span id="l72.448">       // But old Netscape 4.x and Outlook Express etc. use RFC2047.</span>
<a href="#l72.449"></a><span id="l72.449">       // So we should parse both types.</span>
<a href="#l72.450"></a><span id="l72.450"> </span>
<a href="#l72.451"></a><span id="l72.451">       char *fname = nullptr;</span>
<a href="#l72.452"></a><span id="l72.452">       fname = mime_decode_filename(tmp-&gt;m_realName.get(), charset, options);</span>
<a href="#l72.453"></a><span id="l72.453">       free(charset);</span>
<a href="#l72.454"></a><span id="l72.454"> </span>
<a href="#l72.455"></a><span id="l72.455" class="difflineminus">-      if (fname)</span>
<a href="#l72.456"></a><span id="l72.456" class="difflineminus">-        tmp-&gt;m_realName.Adopt(fname);</span>
<a href="#l72.457"></a><span id="l72.457" class="difflineplus">+      if (fname) tmp-&gt;m_realName.Adopt(fname);</span>
<a href="#l72.458"></a><span id="l72.458">     }</span>
<a href="#l72.459"></a><span id="l72.459"> </span>
<a href="#l72.460"></a><span id="l72.460">     PR_FREEIF(disp);</span>
<a href="#l72.461"></a><span id="l72.461">   }</span>
<a href="#l72.462"></a><span id="l72.462"> </span>
<a href="#l72.463"></a><span id="l72.463">   disp = MimeHeaders_get(object-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l72.464"></a><span id="l72.464" class="difflineminus">-  if (disp)</span>
<a href="#l72.465"></a><span id="l72.465" class="difflineminus">-  {</span>
<a href="#l72.466"></a><span id="l72.466" class="difflineminus">-    tmp-&gt;m_xMacType.Adopt(MimeHeaders_get_parameter(disp, PARAM_X_MAC_TYPE, nullptr, nullptr));</span>
<a href="#l72.467"></a><span id="l72.467" class="difflineminus">-    tmp-&gt;m_xMacCreator.Adopt(MimeHeaders_get_parameter(disp, PARAM_X_MAC_CREATOR, nullptr, nullptr));</span>
<a href="#l72.468"></a><span id="l72.468" class="difflineplus">+  if (disp) {</span>
<a href="#l72.469"></a><span id="l72.469" class="difflineplus">+    tmp-&gt;m_xMacType.Adopt(</span>
<a href="#l72.470"></a><span id="l72.470" class="difflineplus">+        MimeHeaders_get_parameter(disp, PARAM_X_MAC_TYPE, nullptr, nullptr));</span>
<a href="#l72.471"></a><span id="l72.471" class="difflineplus">+    tmp-&gt;m_xMacCreator.Adopt(</span>
<a href="#l72.472"></a><span id="l72.472" class="difflineplus">+        MimeHeaders_get_parameter(disp, PARAM_X_MAC_CREATOR, nullptr, nullptr));</span>
<a href="#l72.473"></a><span id="l72.473"> </span>
<a href="#l72.474"></a><span id="l72.474" class="difflineminus">-    if (tmp-&gt;m_realName.IsEmpty())</span>
<a href="#l72.475"></a><span id="l72.475" class="difflineminus">-    {</span>
<a href="#l72.476"></a><span id="l72.476" class="difflineminus">-      tmp-&gt;m_realName.Adopt(MimeHeaders_get_parameter(disp, &quot;name&quot;, &amp;charset, nullptr));</span>
<a href="#l72.477"></a><span id="l72.477" class="difflineplus">+    if (tmp-&gt;m_realName.IsEmpty()) {</span>
<a href="#l72.478"></a><span id="l72.478" class="difflineplus">+      tmp-&gt;m_realName.Adopt(</span>
<a href="#l72.479"></a><span id="l72.479" class="difflineplus">+          MimeHeaders_get_parameter(disp, &quot;name&quot;, &amp;charset, nullptr));</span>
<a href="#l72.480"></a><span id="l72.480">       if (isAnAppleDoublePart)</span>
<a href="#l72.481"></a><span id="l72.481" class="difflineminus">-        // the data fork is the 2nd part, and we should ALWAYS look there first for the file name</span>
<a href="#l72.482"></a><span id="l72.482" class="difflineminus">-        for (i = 1; i &gt;= 0 &amp;&amp; tmp-&gt;m_realName.IsEmpty(); i --)</span>
<a href="#l72.483"></a><span id="l72.483" class="difflineminus">-        {</span>
<a href="#l72.484"></a><span id="l72.484" class="difflineplus">+        // the data fork is the 2nd part, and we should ALWAYS look there first</span>
<a href="#l72.485"></a><span id="l72.485" class="difflineplus">+        // for the file name</span>
<a href="#l72.486"></a><span id="l72.486" class="difflineplus">+        for (i = 1; i &gt;= 0 &amp;&amp; tmp-&gt;m_realName.IsEmpty(); i--) {</span>
<a href="#l72.487"></a><span id="l72.487">           PR_FREEIF(disp);</span>
<a href="#l72.488"></a><span id="l72.488">           free(charset);</span>
<a href="#l72.489"></a><span id="l72.489" class="difflineminus">-          disp = MimeHeaders_get(((MimeContainer *)object)-&gt;children[i]-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l72.490"></a><span id="l72.490" class="difflineminus">-          tmp-&gt;m_realName.Adopt(MimeHeaders_get_parameter(disp, &quot;name&quot;, &amp;charset, nullptr));</span>
<a href="#l72.491"></a><span id="l72.491" class="difflineplus">+          disp =</span>
<a href="#l72.492"></a><span id="l72.492" class="difflineplus">+              MimeHeaders_get(((MimeContainer *)object)-&gt;children[i]-&gt;headers,</span>
<a href="#l72.493"></a><span id="l72.493" class="difflineplus">+                              HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l72.494"></a><span id="l72.494" class="difflineplus">+          tmp-&gt;m_realName.Adopt(</span>
<a href="#l72.495"></a><span id="l72.495" class="difflineplus">+              MimeHeaders_get_parameter(disp, &quot;name&quot;, &amp;charset, nullptr));</span>
<a href="#l72.496"></a><span id="l72.496">           tmp-&gt;m_realType.Adopt(</span>
<a href="#l72.497"></a><span id="l72.497" class="difflineminus">-            MimeHeaders_get(((MimeContainer *)object)-&gt;children[i]-&gt;headers,</span>
<a href="#l72.498"></a><span id="l72.498" class="difflineminus">-                            HEADER_CONTENT_TYPE, true, false));</span>
<a href="#l72.499"></a><span id="l72.499" class="difflineplus">+              MimeHeaders_get(((MimeContainer *)object)-&gt;children[i]-&gt;headers,</span>
<a href="#l72.500"></a><span id="l72.500" class="difflineplus">+                              HEADER_CONTENT_TYPE, true, false));</span>
<a href="#l72.501"></a><span id="l72.501">         }</span>
<a href="#l72.502"></a><span id="l72.502"> </span>
<a href="#l72.503"></a><span id="l72.503" class="difflineminus">-      if (!tmp-&gt;m_realName.IsEmpty())</span>
<a href="#l72.504"></a><span id="l72.504" class="difflineminus">-      {</span>
<a href="#l72.505"></a><span id="l72.505" class="difflineplus">+      if (!tmp-&gt;m_realName.IsEmpty()) {</span>
<a href="#l72.506"></a><span id="l72.506">         // check encoded type</span>
<a href="#l72.507"></a><span id="l72.507">         //</span>
<a href="#l72.508"></a><span id="l72.508">         // The parameter of Content-Disposition must use RFC 2231.</span>
<a href="#l72.509"></a><span id="l72.509">         // But old Netscape 4.x and Outlook Express etc. use RFC2047.</span>
<a href="#l72.510"></a><span id="l72.510">         // So we should parse both types.</span>
<a href="#l72.511"></a><span id="l72.511"> </span>
<a href="#l72.512"></a><span id="l72.512">         char *fname = nullptr;</span>
<a href="#l72.513"></a><span id="l72.513">         fname = mime_decode_filename(tmp-&gt;m_realName.get(), charset, options);</span>
<a href="#l72.514"></a><span id="l72.514">         free(charset);</span>
<a href="#l72.515"></a><span id="l72.515"> </span>
<a href="#l72.516"></a><span id="l72.516" class="difflineminus">-        if (fname)</span>
<a href="#l72.517"></a><span id="l72.517" class="difflineminus">-          tmp-&gt;m_realName.Adopt(fname);</span>
<a href="#l72.518"></a><span id="l72.518" class="difflineplus">+        if (fname) tmp-&gt;m_realName.Adopt(fname);</span>
<a href="#l72.519"></a><span id="l72.519">       }</span>
<a href="#l72.520"></a><span id="l72.520">     }</span>
<a href="#l72.521"></a><span id="l72.521"> </span>
<a href="#l72.522"></a><span id="l72.522" class="difflineminus">-    if (tmp-&gt;m_isExternalLinkAttachment)</span>
<a href="#l72.523"></a><span id="l72.523" class="difflineminus">-    {</span>
<a href="#l72.524"></a><span id="l72.524" class="difflineplus">+    if (tmp-&gt;m_isExternalLinkAttachment) {</span>
<a href="#l72.525"></a><span id="l72.525">       // If an external link attachment part's Content-Type contains a</span>
<a href="#l72.526"></a><span id="l72.526">       // |size| parm, store it in m_sizeExternalStr. Let the msgHeaderSink</span>
<a href="#l72.527"></a><span id="l72.527">       // addAttachmentField() figure out if it's sane, and don't bother</span>
<a href="#l72.528"></a><span id="l72.528">       // strtol'ing it to an int only to emit it as a string.</span>
<a href="#l72.529"></a><span id="l72.529" class="difflineminus">-      char* sizeStr = MimeHeaders_get_parameter(disp, &quot;size&quot;, nullptr, nullptr);</span>
<a href="#l72.530"></a><span id="l72.530" class="difflineminus">-      if (sizeStr)</span>
<a href="#l72.531"></a><span id="l72.531" class="difflineminus">-        tmp-&gt;m_sizeExternalStr = sizeStr;</span>
<a href="#l72.532"></a><span id="l72.532" class="difflineplus">+      char *sizeStr = MimeHeaders_get_parameter(disp, &quot;size&quot;, nullptr, nullptr);</span>
<a href="#l72.533"></a><span id="l72.533" class="difflineplus">+      if (sizeStr) tmp-&gt;m_sizeExternalStr = sizeStr;</span>
<a href="#l72.534"></a><span id="l72.534">     }</span>
<a href="#l72.535"></a><span id="l72.535"> </span>
<a href="#l72.536"></a><span id="l72.536">     PR_FREEIF(disp);</span>
<a href="#l72.537"></a><span id="l72.537">   }</span>
<a href="#l72.538"></a><span id="l72.538"> </span>
<a href="#l72.539"></a><span id="l72.539" class="difflineminus">-  tmp-&gt;m_description.Adopt(MimeHeaders_get(object-&gt;headers, HEADER_CONTENT_DESCRIPTION,</span>
<a href="#l72.540"></a><span id="l72.540" class="difflineminus">-                                           false, false));</span>
<a href="#l72.541"></a><span id="l72.541" class="difflineplus">+  tmp-&gt;m_description.Adopt(MimeHeaders_get(</span>
<a href="#l72.542"></a><span id="l72.542" class="difflineplus">+      object-&gt;headers, HEADER_CONTENT_DESCRIPTION, false, false));</span>
<a href="#l72.543"></a><span id="l72.543"> </span>
<a href="#l72.544"></a><span id="l72.544">   // Now, do the right thing with the name!</span>
<a href="#l72.545"></a><span id="l72.545" class="difflineminus">-  if (tmp-&gt;m_realName.IsEmpty() &amp;&amp; !(tmp-&gt;m_realType.LowerCaseEqualsLiteral(MESSAGE_RFC822)))</span>
<a href="#l72.546"></a><span id="l72.546" class="difflineminus">-  {</span>
<a href="#l72.547"></a><span id="l72.547" class="difflineplus">+  if (tmp-&gt;m_realName.IsEmpty() &amp;&amp;</span>
<a href="#l72.548"></a><span id="l72.548" class="difflineplus">+      !(tmp-&gt;m_realType.LowerCaseEqualsLiteral(MESSAGE_RFC822))) {</span>
<a href="#l72.549"></a><span id="l72.549">     // Keep in mind that the name was provided by us and this is probably not a</span>
<a href="#l72.550"></a><span id="l72.550">     // real attachment.</span>
<a href="#l72.551"></a><span id="l72.551">     tmp-&gt;m_hasFilename = false;</span>
<a href="#l72.552"></a><span id="l72.552">     /* If this attachment doesn't have a name, just give it one... */</span>
<a href="#l72.553"></a><span id="l72.553">     tmp-&gt;m_realName.Adopt(MimeGetStringByID(MIME_MSG_DEFAULT_ATTACHMENT_NAME));</span>
<a href="#l72.554"></a><span id="l72.554" class="difflineminus">-    if (!tmp-&gt;m_realName.IsEmpty())</span>
<a href="#l72.555"></a><span id="l72.555" class="difflineminus">-    {</span>
<a href="#l72.556"></a><span id="l72.556" class="difflineplus">+    if (!tmp-&gt;m_realName.IsEmpty()) {</span>
<a href="#l72.557"></a><span id="l72.557">       char *newName = PR_smprintf(tmp-&gt;m_realName.get(), part.get());</span>
<a href="#l72.558"></a><span id="l72.558" class="difflineminus">-      if (newName)</span>
<a href="#l72.559"></a><span id="l72.559" class="difflineminus">-        tmp-&gt;m_realName.Adopt(newName);</span>
<a href="#l72.560"></a><span id="l72.560" class="difflineminus">-    }</span>
<a href="#l72.561"></a><span id="l72.561" class="difflineminus">-    else</span>
<a href="#l72.562"></a><span id="l72.562" class="difflineplus">+      if (newName) tmp-&gt;m_realName.Adopt(newName);</span>
<a href="#l72.563"></a><span id="l72.563" class="difflineplus">+    } else</span>
<a href="#l72.564"></a><span id="l72.564">       tmp-&gt;m_realName.Adopt(mime_part_address(object));</span>
<a href="#l72.565"></a><span id="l72.565">   } else {</span>
<a href="#l72.566"></a><span id="l72.566">     tmp-&gt;m_hasFilename = true;</span>
<a href="#l72.567"></a><span id="l72.567">   }</span>
<a href="#l72.568"></a><span id="l72.568"> </span>
<a href="#l72.569"></a><span id="l72.569" class="difflineminus">-  if (!tmp-&gt;m_realName.IsEmpty() &amp;&amp; !tmp-&gt;m_isExternalAttachment)</span>
<a href="#l72.570"></a><span id="l72.570" class="difflineminus">-  {</span>
<a href="#l72.571"></a><span id="l72.571" class="difflineplus">+  if (!tmp-&gt;m_realName.IsEmpty() &amp;&amp; !tmp-&gt;m_isExternalAttachment) {</span>
<a href="#l72.572"></a><span id="l72.572">     urlString.AppendLiteral(&quot;&amp;filename=&quot;);</span>
<a href="#l72.573"></a><span id="l72.573">     nsAutoCString aResult;</span>
<a href="#l72.574"></a><span id="l72.574">     if (NS_SUCCEEDED(MsgEscapeString(tmp-&gt;m_realName,</span>
<a href="#l72.575"></a><span id="l72.575">                                      nsINetUtil::ESCAPE_XALPHAS, aResult)))</span>
<a href="#l72.576"></a><span id="l72.576">       urlString.Append(aResult);</span>
<a href="#l72.577"></a><span id="l72.577">     else</span>
<a href="#l72.578"></a><span id="l72.578">       urlString.Append(tmp-&gt;m_realName);</span>
<a href="#l72.579"></a><span id="l72.579">     if (tmp-&gt;m_realType.EqualsLiteral(&quot;message/rfc822&quot;) &amp;&amp;</span>
<a href="#l72.580"></a><span id="l72.580" class="difflineminus">-           !StringEndsWith(urlString, NS_LITERAL_CSTRING(&quot;.eml&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l72.581"></a><span id="l72.581" class="difflineplus">+        !StringEndsWith(urlString, NS_LITERAL_CSTRING(&quot;.eml&quot;),</span>
<a href="#l72.582"></a><span id="l72.582" class="difflineplus">+                        nsCaseInsensitiveCStringComparator()))</span>
<a href="#l72.583"></a><span id="l72.583">       urlString.AppendLiteral(&quot;.eml&quot;);</span>
<a href="#l72.584"></a><span id="l72.584">   } else if (tmp-&gt;m_isExternalAttachment) {</span>
<a href="#l72.585"></a><span id="l72.585">     // Allows the JS mime emitter to figure out the part information.</span>
<a href="#l72.586"></a><span id="l72.586">     urlString.AppendLiteral(&quot;?part=&quot;);</span>
<a href="#l72.587"></a><span id="l72.587">     urlString.Append(part);</span>
<a href="#l72.588"></a><span id="l72.588">   } else if (tmp-&gt;m_realType.LowerCaseEqualsLiteral(MESSAGE_RFC822)) {</span>
<a href="#l72.589"></a><span id="l72.589">     // Special case...if this is a enclosed RFC822 message, give it a nice</span>
<a href="#l72.590"></a><span id="l72.590">     // name.</span>
<a href="#l72.591"></a><span id="l72.591" class="difflineminus">-    if (object-&gt;headers-&gt;munged_subject)</span>
<a href="#l72.592"></a><span id="l72.592" class="difflineminus">-    {</span>
<a href="#l72.593"></a><span id="l72.593" class="difflineplus">+    if (object-&gt;headers-&gt;munged_subject) {</span>
<a href="#l72.594"></a><span id="l72.594">       nsCString subject;</span>
<a href="#l72.595"></a><span id="l72.595">       subject.Assign(object-&gt;headers-&gt;munged_subject);</span>
<a href="#l72.596"></a><span id="l72.596">       MimeHeaders_convert_header_value(options, subject, false);</span>
<a href="#l72.597"></a><span id="l72.597">       tmp-&gt;m_realName.Assign(subject);</span>
<a href="#l72.598"></a><span id="l72.598">       tmp-&gt;m_realName.AppendLiteral(&quot;.eml&quot;);</span>
<a href="#l72.599"></a><span id="l72.599" class="difflineminus">-    }</span>
<a href="#l72.600"></a><span id="l72.600" class="difflineminus">-    else</span>
<a href="#l72.601"></a><span id="l72.601" class="difflineplus">+    } else</span>
<a href="#l72.602"></a><span id="l72.602">       tmp-&gt;m_realName = &quot;ForwardedMessage.eml&quot;;</span>
<a href="#l72.603"></a><span id="l72.603">   }</span>
<a href="#l72.604"></a><span id="l72.604"> </span>
<a href="#l72.605"></a><span id="l72.605" class="difflineminus">-  nsresult rv = nsMimeNewURI(getter_AddRefs(tmp-&gt;m_url), urlString.get(), nullptr);</span>
<a href="#l72.606"></a><span id="l72.606" class="difflineplus">+  nsresult rv =</span>
<a href="#l72.607"></a><span id="l72.607" class="difflineplus">+      nsMimeNewURI(getter_AddRefs(tmp-&gt;m_url), urlString.get(), nullptr);</span>
<a href="#l72.608"></a><span id="l72.608"> </span>
<a href="#l72.609"></a><span id="l72.609">   PR_FREEIF(urlSpec);</span>
<a href="#l72.610"></a><span id="l72.610"> </span>
<a href="#l72.611"></a><span id="l72.611" class="difflineminus">-  if (NS_FAILED(rv) || !tmp-&gt;m_url)</span>
<a href="#l72.612"></a><span id="l72.612" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.613"></a><span id="l72.613" class="difflineplus">+  if (NS_FAILED(rv) || !tmp-&gt;m_url) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.614"></a><span id="l72.614"> </span>
<a href="#l72.615"></a><span id="l72.615">   ValidateRealName(tmp, object-&gt;headers);</span>
<a href="#l72.616"></a><span id="l72.616"> </span>
<a href="#l72.617"></a><span id="l72.617">   return NS_OK;</span>
<a href="#l72.618"></a><span id="l72.618"> }</span>
<a href="#l72.619"></a><span id="l72.619"> </span>
<a href="#l72.620"></a><span id="l72.620" class="difflineminus">-nsresult</span>
<a href="#l72.621"></a><span id="l72.621" class="difflineminus">-BuildAttachmentList(MimeObject *anObject, nsMsgAttachmentData *aAttachData, const char *aMessageURL)</span>
<a href="#l72.622"></a><span id="l72.622" class="difflineminus">-{</span>
<a href="#l72.623"></a><span id="l72.623" class="difflineminus">-  nsresult              rv;</span>
<a href="#l72.624"></a><span id="l72.624" class="difflineminus">-  int32_t               i;</span>
<a href="#l72.625"></a><span id="l72.625" class="difflineminus">-  MimeContainer         *cobj = (MimeContainer *) anObject;</span>
<a href="#l72.626"></a><span id="l72.626" class="difflineminus">-  bool                  found_output = false;</span>
<a href="#l72.627"></a><span id="l72.627" class="difflineplus">+nsresult BuildAttachmentList(MimeObject *anObject,</span>
<a href="#l72.628"></a><span id="l72.628" class="difflineplus">+                             nsMsgAttachmentData *aAttachData,</span>
<a href="#l72.629"></a><span id="l72.629" class="difflineplus">+                             const char *aMessageURL) {</span>
<a href="#l72.630"></a><span id="l72.630" class="difflineplus">+  nsresult rv;</span>
<a href="#l72.631"></a><span id="l72.631" class="difflineplus">+  int32_t i;</span>
<a href="#l72.632"></a><span id="l72.632" class="difflineplus">+  MimeContainer *cobj = (MimeContainer *)anObject;</span>
<a href="#l72.633"></a><span id="l72.633" class="difflineplus">+  bool found_output = false;</span>
<a href="#l72.634"></a><span id="l72.634"> </span>
<a href="#l72.635"></a><span id="l72.635" class="difflineminus">-  if ( (!anObject) || (!cobj-&gt;children) || (!cobj-&gt;nchildren) ||</span>
<a href="#l72.636"></a><span id="l72.636" class="difflineminus">-       (mime_typep(anObject, (MimeObjectClass *)&amp;mimeExternalBodyClass)))</span>
<a href="#l72.637"></a><span id="l72.637" class="difflineplus">+  if ((!anObject) || (!cobj-&gt;children) || (!cobj-&gt;nchildren) ||</span>
<a href="#l72.638"></a><span id="l72.638" class="difflineplus">+      (mime_typep(anObject, (MimeObjectClass *)&amp;mimeExternalBodyClass)))</span>
<a href="#l72.639"></a><span id="l72.639">     return NS_OK;</span>
<a href="#l72.640"></a><span id="l72.640"> </span>
<a href="#l72.641"></a><span id="l72.641" class="difflineminus">-  for (i = 0; i &lt; cobj-&gt;nchildren ; i++)</span>
<a href="#l72.642"></a><span id="l72.642" class="difflineminus">-  {</span>
<a href="#l72.643"></a><span id="l72.643" class="difflineminus">-    MimeObject    *child = cobj-&gt;children[i];</span>
<a href="#l72.644"></a><span id="l72.644" class="difflineminus">-    char          *ct = child-&gt;content_type;</span>
<a href="#l72.645"></a><span id="l72.645" class="difflineplus">+  for (i = 0; i &lt; cobj-&gt;nchildren; i++) {</span>
<a href="#l72.646"></a><span id="l72.646" class="difflineplus">+    MimeObject *child = cobj-&gt;children[i];</span>
<a href="#l72.647"></a><span id="l72.647" class="difflineplus">+    char *ct = child-&gt;content_type;</span>
<a href="#l72.648"></a><span id="l72.648"> </span>
<a href="#l72.649"></a><span id="l72.649">     // We're going to ignore the output_p attribute because we want to output</span>
<a href="#l72.650"></a><span id="l72.650">     // any part with a name to work around bug 674473</span>
<a href="#l72.651"></a><span id="l72.651"> </span>
<a href="#l72.652"></a><span id="l72.652">     // Skip the first child that's being output if it's in fact a message body.</span>
<a href="#l72.653"></a><span id="l72.653">     // Start by assuming that it is, until proven otherwise in the code below.</span>
<a href="#l72.654"></a><span id="l72.654">     bool skip = true;</span>
<a href="#l72.655"></a><span id="l72.655">     if (found_output)</span>
<a href="#l72.656"></a><span id="l72.656">       // not first child being output</span>
<a href="#l72.657"></a><span id="l72.657">       skip = false;</span>
<a href="#l72.658"></a><span id="l72.658" class="difflineminus">-    else if (! ct)</span>
<a href="#l72.659"></a><span id="l72.659" class="difflineplus">+    else if (!ct)</span>
<a href="#l72.660"></a><span id="l72.660">       // no content type so can't be message body</span>
<a href="#l72.661"></a><span id="l72.661">       skip = false;</span>
<a href="#l72.662"></a><span id="l72.662" class="difflineminus">-    else if (PL_strcasecmp (ct, TEXT_PLAIN) &amp;&amp;</span>
<a href="#l72.663"></a><span id="l72.663" class="difflineminus">-             PL_strcasecmp (ct, TEXT_HTML) &amp;&amp;</span>
<a href="#l72.664"></a><span id="l72.664" class="difflineminus">-             PL_strcasecmp (ct, TEXT_MDL))</span>
<a href="#l72.665"></a><span id="l72.665" class="difflineplus">+    else if (PL_strcasecmp(ct, TEXT_PLAIN) &amp;&amp; PL_strcasecmp(ct, TEXT_HTML) &amp;&amp;</span>
<a href="#l72.666"></a><span id="l72.666" class="difflineplus">+             PL_strcasecmp(ct, TEXT_MDL))</span>
<a href="#l72.667"></a><span id="l72.667">       // not a type we recognize as a message body</span>
<a href="#l72.668"></a><span id="l72.668">       skip = false;</span>
<a href="#l72.669"></a><span id="l72.669">     // we're displaying all body parts</span>
<a href="#l72.670"></a><span id="l72.670" class="difflineminus">-    if (child-&gt;options-&gt;html_as_p == 4)</span>
<a href="#l72.671"></a><span id="l72.671" class="difflineminus">-        skip = false;</span>
<a href="#l72.672"></a><span id="l72.672" class="difflineminus">-    if (skip &amp;&amp; child-&gt;headers)</span>
<a href="#l72.673"></a><span id="l72.673" class="difflineminus">-    {</span>
<a href="#l72.674"></a><span id="l72.674" class="difflineplus">+    if (child-&gt;options-&gt;html_as_p == 4) skip = false;</span>
<a href="#l72.675"></a><span id="l72.675" class="difflineplus">+    if (skip &amp;&amp; child-&gt;headers) {</span>
<a href="#l72.676"></a><span id="l72.676">       // If it has a filename, we don't skip it regardless of the</span>
<a href="#l72.677"></a><span id="l72.677">       // content disposition which can be &quot;inline&quot; or &quot;attachment&quot;.</span>
<a href="#l72.678"></a><span id="l72.678">       // Inline parts are not shown when attachments aren't displayed</span>
<a href="#l72.679"></a><span id="l72.679">       // inline, so the only chance to see the part is as attachment.</span>
<a href="#l72.680"></a><span id="l72.680" class="difflineminus">-      char * name = MimeHeaders_get_name(child-&gt;headers, nullptr);</span>
<a href="#l72.681"></a><span id="l72.681" class="difflineminus">-      if (name)</span>
<a href="#l72.682"></a><span id="l72.682" class="difflineminus">-        skip = false;</span>
<a href="#l72.683"></a><span id="l72.683" class="difflineplus">+      char *name = MimeHeaders_get_name(child-&gt;headers, nullptr);</span>
<a href="#l72.684"></a><span id="l72.684" class="difflineplus">+      if (name) skip = false;</span>
<a href="#l72.685"></a><span id="l72.685">       PR_FREEIF(name);</span>
<a href="#l72.686"></a><span id="l72.686">     }</span>
<a href="#l72.687"></a><span id="l72.687"> </span>
<a href="#l72.688"></a><span id="l72.688">     found_output = true;</span>
<a href="#l72.689"></a><span id="l72.689" class="difflineminus">-    if (skip)</span>
<a href="#l72.690"></a><span id="l72.690" class="difflineminus">-      continue;</span>
<a href="#l72.691"></a><span id="l72.691" class="difflineplus">+    if (skip) continue;</span>
<a href="#l72.692"></a><span id="l72.692"> </span>
<a href="#l72.693"></a><span id="l72.693">     // We should generate an attachment for leaf object only but...</span>
<a href="#l72.694"></a><span id="l72.694" class="difflineminus">-    bool isALeafObject = mime_subclass_p(child-&gt;clazz, (MimeObjectClass *) &amp;mimeLeafClass);</span>
<a href="#l72.695"></a><span id="l72.695" class="difflineplus">+    bool isALeafObject =</span>
<a href="#l72.696"></a><span id="l72.696" class="difflineplus">+        mime_subclass_p(child-&gt;clazz, (MimeObjectClass *)&amp;mimeLeafClass);</span>
<a href="#l72.697"></a><span id="l72.697"> </span>
<a href="#l72.698"></a><span id="l72.698">     // ...we will generate an attachment for inline message too.</span>
<a href="#l72.699"></a><span id="l72.699" class="difflineminus">-    bool isAnInlineMessage = mime_typep(child, (MimeObjectClass *) &amp;mimeMessageClass);</span>
<a href="#l72.700"></a><span id="l72.700" class="difflineplus">+    bool isAnInlineMessage =</span>
<a href="#l72.701"></a><span id="l72.701" class="difflineplus">+        mime_typep(child, (MimeObjectClass *)&amp;mimeMessageClass);</span>
<a href="#l72.702"></a><span id="l72.702"> </span>
<a href="#l72.703"></a><span id="l72.703" class="difflineminus">-    // AppleDouble part need special care: we need to fetch the part as well its two</span>
<a href="#l72.704"></a><span id="l72.704" class="difflineminus">-    // children for the needed info as they could be anywhere, eventually, they won't contain</span>
<a href="#l72.705"></a><span id="l72.705" class="difflineminus">-    // a name or file name. In any case we need to build only one attachment data</span>
<a href="#l72.706"></a><span id="l72.706" class="difflineminus">-    bool isAnAppleDoublePart = mime_typep(child, (MimeObjectClass *) &amp;mimeMultipartAppleDoubleClass) &amp;&amp;</span>
<a href="#l72.707"></a><span id="l72.707" class="difflineminus">-                                 ((MimeContainer *)child)-&gt;nchildren == 2;</span>
<a href="#l72.708"></a><span id="l72.708" class="difflineplus">+    // AppleDouble part need special care: we need to fetch the part as well its</span>
<a href="#l72.709"></a><span id="l72.709" class="difflineplus">+    // two children for the needed info as they could be anywhere, eventually,</span>
<a href="#l72.710"></a><span id="l72.710" class="difflineplus">+    // they won't contain a name or file name. In any case we need to build only</span>
<a href="#l72.711"></a><span id="l72.711" class="difflineplus">+    // one attachment data</span>
<a href="#l72.712"></a><span id="l72.712" class="difflineplus">+    bool isAnAppleDoublePart =</span>
<a href="#l72.713"></a><span id="l72.713" class="difflineplus">+        mime_typep(child, (MimeObjectClass *)&amp;mimeMultipartAppleDoubleClass) &amp;&amp;</span>
<a href="#l72.714"></a><span id="l72.714" class="difflineplus">+        ((MimeContainer *)child)-&gt;nchildren == 2;</span>
<a href="#l72.715"></a><span id="l72.715"> </span>
<a href="#l72.716"></a><span id="l72.716">     // The function below does not necessarily set the size to something (I</span>
<a href="#l72.717"></a><span id="l72.717">     // don't think it will work for external objects, for instance, since they</span>
<a href="#l72.718"></a><span id="l72.718">     // are neither containers nor leafs).</span>
<a href="#l72.719"></a><span id="l72.719">     int32_t attSize = 0;</span>
<a href="#l72.720"></a><span id="l72.720">     MimeGetSize(child, &amp;attSize);</span>
<a href="#l72.721"></a><span id="l72.721"> </span>
<a href="#l72.722"></a><span id="l72.722" class="difflineminus">-    if (isALeafObject || isAnInlineMessage || isAnAppleDoublePart)</span>
<a href="#l72.723"></a><span id="l72.723" class="difflineminus">-    {</span>
<a href="#l72.724"></a><span id="l72.724" class="difflineminus">-      rv = GenerateAttachmentData(child, aMessageURL, anObject-&gt;options, isAnAppleDoublePart, attSize, aAttachData);</span>
<a href="#l72.725"></a><span id="l72.725" class="difflineplus">+    if (isALeafObject || isAnInlineMessage || isAnAppleDoublePart) {</span>
<a href="#l72.726"></a><span id="l72.726" class="difflineplus">+      rv = GenerateAttachmentData(child, aMessageURL, anObject-&gt;options,</span>
<a href="#l72.727"></a><span id="l72.727" class="difflineplus">+                                  isAnAppleDoublePart, attSize, aAttachData);</span>
<a href="#l72.728"></a><span id="l72.728">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l72.729"></a><span id="l72.729">     }</span>
<a href="#l72.730"></a><span id="l72.730"> </span>
<a href="#l72.731"></a><span id="l72.731">     // Now build the attachment list for the children of our object...</span>
<a href="#l72.732"></a><span id="l72.732" class="difflineminus">-    if (!isALeafObject &amp;&amp; !isAnAppleDoublePart)</span>
<a href="#l72.733"></a><span id="l72.733" class="difflineminus">-    {</span>
<a href="#l72.734"></a><span id="l72.734" class="difflineplus">+    if (!isALeafObject &amp;&amp; !isAnAppleDoublePart) {</span>
<a href="#l72.735"></a><span id="l72.735">       rv = BuildAttachmentList((MimeObject *)child, aAttachData, aMessageURL);</span>
<a href="#l72.736"></a><span id="l72.736">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l72.737"></a><span id="l72.737">     }</span>
<a href="#l72.738"></a><span id="l72.738">   }</span>
<a href="#l72.739"></a><span id="l72.739"> </span>
<a href="#l72.740"></a><span id="l72.740">   return NS_OK;</span>
<a href="#l72.741"></a><span id="l72.741" class="difflineminus">-</span>
<a href="#l72.742"></a><span id="l72.742"> }</span>
<a href="#l72.743"></a><span id="l72.743"> </span>
<a href="#l72.744"></a><span id="l72.744" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.745"></a><span id="l72.745" class="difflineminus">-MimeGetAttachmentList(MimeObject *tobj, const char *aMessageURL, nsMsgAttachmentData **data)</span>
<a href="#l72.746"></a><span id="l72.746" class="difflineminus">-{</span>
<a href="#l72.747"></a><span id="l72.747" class="difflineminus">-  MimeObject            *obj;</span>
<a href="#l72.748"></a><span id="l72.748" class="difflineminus">-  MimeContainer         *cobj;</span>
<a href="#l72.749"></a><span id="l72.749" class="difflineminus">-  int32_t               n;</span>
<a href="#l72.750"></a><span id="l72.750" class="difflineminus">-  bool                  isAnInlineMessage;</span>
<a href="#l72.751"></a><span id="l72.751" class="difflineplus">+extern &quot;C&quot; nsresult MimeGetAttachmentList(MimeObject *tobj,</span>
<a href="#l72.752"></a><span id="l72.752" class="difflineplus">+                                          const char *aMessageURL,</span>
<a href="#l72.753"></a><span id="l72.753" class="difflineplus">+                                          nsMsgAttachmentData **data) {</span>
<a href="#l72.754"></a><span id="l72.754" class="difflineplus">+  MimeObject *obj;</span>
<a href="#l72.755"></a><span id="l72.755" class="difflineplus">+  MimeContainer *cobj;</span>
<a href="#l72.756"></a><span id="l72.756" class="difflineplus">+  int32_t n;</span>
<a href="#l72.757"></a><span id="l72.757" class="difflineplus">+  bool isAnInlineMessage;</span>
<a href="#l72.758"></a><span id="l72.758"> </span>
<a href="#l72.759"></a><span id="l72.759" class="difflineminus">-  if (!data)</span>
<a href="#l72.760"></a><span id="l72.760" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l72.761"></a><span id="l72.761" class="difflineplus">+  if (!data) return NS_ERROR_INVALID_ARG;</span>
<a href="#l72.762"></a><span id="l72.762">   *data = nullptr;</span>
<a href="#l72.763"></a><span id="l72.763"> </span>
<a href="#l72.764"></a><span id="l72.764">   obj = mime_get_main_object(tobj);</span>
<a href="#l72.765"></a><span id="l72.765" class="difflineminus">-  if (!obj)</span>
<a href="#l72.766"></a><span id="l72.766" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.767"></a><span id="l72.767" class="difflineplus">+  if (!obj) return NS_OK;</span>
<a href="#l72.768"></a><span id="l72.768"> </span>
<a href="#l72.769"></a><span id="l72.769" class="difflineminus">-  if (!mime_subclass_p(obj-&gt;clazz, (MimeObjectClass*) &amp;mimeContainerClass))</span>
<a href="#l72.770"></a><span id="l72.770" class="difflineplus">+  if (!mime_subclass_p(obj-&gt;clazz, (MimeObjectClass *)&amp;mimeContainerClass))</span>
<a href="#l72.771"></a><span id="l72.771">     return ProcessBodyAsAttachment(obj, data);</span>
<a href="#l72.772"></a><span id="l72.772"> </span>
<a href="#l72.773"></a><span id="l72.773" class="difflineminus">-  isAnInlineMessage = mime_typep(obj, (MimeObjectClass *) &amp;mimeMessageClass);</span>
<a href="#l72.774"></a><span id="l72.774" class="difflineplus">+  isAnInlineMessage = mime_typep(obj, (MimeObjectClass *)&amp;mimeMessageClass);</span>
<a href="#l72.775"></a><span id="l72.775"> </span>
<a href="#l72.776"></a><span id="l72.776" class="difflineminus">-  cobj = (MimeContainer*) obj;</span>
<a href="#l72.777"></a><span id="l72.777" class="difflineplus">+  cobj = (MimeContainer *)obj;</span>
<a href="#l72.778"></a><span id="l72.778">   n = CountTotalMimeAttachments(cobj);</span>
<a href="#l72.779"></a><span id="l72.779">   if (n &lt;= 0)</span>
<a href="#l72.780"></a><span id="l72.780">     // XXX n is a regular number here, not meaningful as an nsresult</span>
<a href="#l72.781"></a><span id="l72.781">     return static_cast&lt;nsresult&gt;(n);</span>
<a href="#l72.782"></a><span id="l72.782"> </span>
<a href="#l72.783"></a><span id="l72.783">   // in case of an inline message (as body), we need an extra slot for the</span>
<a href="#l72.784"></a><span id="l72.784">   // message itself that we will fill later...</span>
<a href="#l72.785"></a><span id="l72.785" class="difflineminus">-  if (isAnInlineMessage)</span>
<a href="#l72.786"></a><span id="l72.786" class="difflineminus">-    n ++;</span>
<a href="#l72.787"></a><span id="l72.787" class="difflineplus">+  if (isAnInlineMessage) n++;</span>
<a href="#l72.788"></a><span id="l72.788"> </span>
<a href="#l72.789"></a><span id="l72.789">   *data = new nsMsgAttachmentData[n + 1];</span>
<a href="#l72.790"></a><span id="l72.790" class="difflineminus">-  if (!*data)</span>
<a href="#l72.791"></a><span id="l72.791" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.792"></a><span id="l72.792" class="difflineplus">+  if (!*data) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.793"></a><span id="l72.793"> </span>
<a href="#l72.794"></a><span id="l72.794">   attIndex = 0;</span>
<a href="#l72.795"></a><span id="l72.795"> </span>
<a href="#l72.796"></a><span id="l72.796">   // Now, build the list!</span>
<a href="#l72.797"></a><span id="l72.797"> </span>
<a href="#l72.798"></a><span id="l72.798">   nsresult rv;</span>
<a href="#l72.799"></a><span id="l72.799"> </span>
<a href="#l72.800"></a><span id="l72.800" class="difflineminus">-  if (isAnInlineMessage)</span>
<a href="#l72.801"></a><span id="l72.801" class="difflineminus">-  {</span>
<a href="#l72.802"></a><span id="l72.802" class="difflineplus">+  if (isAnInlineMessage) {</span>
<a href="#l72.803"></a><span id="l72.803">     int32_t size = 0;</span>
<a href="#l72.804"></a><span id="l72.804">     MimeGetSize(obj, &amp;size);</span>
<a href="#l72.805"></a><span id="l72.805">     rv = GenerateAttachmentData(obj, aMessageURL, obj-&gt;options, false, size,</span>
<a href="#l72.806"></a><span id="l72.806">                                 *data);</span>
<a href="#l72.807"></a><span id="l72.807" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l72.808"></a><span id="l72.808" class="difflineminus">-    {</span>
<a href="#l72.809"></a><span id="l72.809" class="difflineminus">-      delete [] *data;             // release data in case of error return.</span>
<a href="#l72.810"></a><span id="l72.810" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l72.811"></a><span id="l72.811" class="difflineplus">+      delete[] * data;  // release data in case of error return.</span>
<a href="#l72.812"></a><span id="l72.812">       return rv;</span>
<a href="#l72.813"></a><span id="l72.813">     }</span>
<a href="#l72.814"></a><span id="l72.814" class="difflineminus">-</span>
<a href="#l72.815"></a><span id="l72.815">   }</span>
<a href="#l72.816"></a><span id="l72.816" class="difflineminus">-  rv = BuildAttachmentList((MimeObject *) cobj, *data, aMessageURL);</span>
<a href="#l72.817"></a><span id="l72.817" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l72.818"></a><span id="l72.818" class="difflineminus">-  {</span>
<a href="#l72.819"></a><span id="l72.819" class="difflineminus">-    delete [] *data;             // release data in case of error return.</span>
<a href="#l72.820"></a><span id="l72.820" class="difflineplus">+  rv = BuildAttachmentList((MimeObject *)cobj, *data, aMessageURL);</span>
<a href="#l72.821"></a><span id="l72.821" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l72.822"></a><span id="l72.822" class="difflineplus">+    delete[] * data;  // release data in case of error return.</span>
<a href="#l72.823"></a><span id="l72.823">   }</span>
<a href="#l72.824"></a><span id="l72.824">   return rv;</span>
<a href="#l72.825"></a><span id="l72.825"> }</span>
<a href="#l72.826"></a><span id="l72.826"> </span>
<a href="#l72.827"></a><span id="l72.827" class="difflineminus">-extern &quot;C&quot; void</span>
<a href="#l72.828"></a><span id="l72.828" class="difflineminus">-MimeFreeAttachmentList(nsMsgAttachmentData *data)</span>
<a href="#l72.829"></a><span id="l72.829" class="difflineminus">-{</span>
<a href="#l72.830"></a><span id="l72.830" class="difflineminus">-  delete [] data;</span>
<a href="#l72.831"></a><span id="l72.831" class="difflineplus">+extern &quot;C&quot; void MimeFreeAttachmentList(nsMsgAttachmentData *data) {</span>
<a href="#l72.832"></a><span id="l72.832" class="difflineplus">+  delete[] data;</span>
<a href="#l72.833"></a><span id="l72.833"> }</span>
<a href="#l72.834"></a><span id="l72.834"> </span>
<a href="#l72.835"></a><span id="l72.835" class="difflineminus">-extern &quot;C&quot; void</span>
<a href="#l72.836"></a><span id="l72.836" class="difflineminus">-NotifyEmittersOfAttachmentList(MimeDisplayOptions     *opt,</span>
<a href="#l72.837"></a><span id="l72.837" class="difflineminus">-                               nsMsgAttachmentData    *data)</span>
<a href="#l72.838"></a><span id="l72.838" class="difflineminus">-{</span>
<a href="#l72.839"></a><span id="l72.839" class="difflineminus">-  int32_t     i = 0;</span>
<a href="#l72.840"></a><span id="l72.840" class="difflineminus">-  nsMsgAttachmentData  *tmp = data;</span>
<a href="#l72.841"></a><span id="l72.841" class="difflineplus">+extern &quot;C&quot; void NotifyEmittersOfAttachmentList(MimeDisplayOptions *opt,</span>
<a href="#l72.842"></a><span id="l72.842" class="difflineplus">+                                               nsMsgAttachmentData *data) {</span>
<a href="#l72.843"></a><span id="l72.843" class="difflineplus">+  int32_t i = 0;</span>
<a href="#l72.844"></a><span id="l72.844" class="difflineplus">+  nsMsgAttachmentData *tmp = data;</span>
<a href="#l72.845"></a><span id="l72.845"> </span>
<a href="#l72.846"></a><span id="l72.846" class="difflineminus">-  if (!tmp)</span>
<a href="#l72.847"></a><span id="l72.847" class="difflineminus">-    return;</span>
<a href="#l72.848"></a><span id="l72.848" class="difflineplus">+  if (!tmp) return;</span>
<a href="#l72.849"></a><span id="l72.849"> </span>
<a href="#l72.850"></a><span id="l72.850" class="difflineminus">-  while (tmp-&gt;m_url)</span>
<a href="#l72.851"></a><span id="l72.851" class="difflineminus">-  {</span>
<a href="#l72.852"></a><span id="l72.852" class="difflineplus">+  while (tmp-&gt;m_url) {</span>
<a href="#l72.853"></a><span id="l72.853">     // The code below implements the following logic:</span>
<a href="#l72.854"></a><span id="l72.854">     // - Always display the attachment if the Content-Disposition is</span>
<a href="#l72.855"></a><span id="l72.855">     //   &quot;attachment&quot; or if it can't be displayed inline.</span>
<a href="#l72.856"></a><span id="l72.856">     // - If there's no name at all, just skip it (we don't know what to do with</span>
<a href="#l72.857"></a><span id="l72.857">     //   it then).</span>
<a href="#l72.858"></a><span id="l72.858">     // - If the attachment has a &quot;provided name&quot; (i.e. not something like &quot;Part</span>
<a href="#l72.859"></a><span id="l72.859">     //   1.2&quot;), display it.</span>
<a href="#l72.860"></a><span id="l72.860">     // - If we're asking for all body parts and NOT asking for metadata only,</span>
<a href="#l72.861"></a><span id="l72.861">     //   display it.</span>
<a href="#l72.862"></a><span id="l72.862">     // - Otherwise, skip it.</span>
<a href="#l72.863"></a><span id="l72.863" class="difflineminus">-    if (!tmp-&gt;m_disposition.EqualsLiteral(&quot;attachment&quot;) &amp;&amp; tmp-&gt;m_displayableInline &amp;&amp;</span>
<a href="#l72.864"></a><span id="l72.864" class="difflineminus">-        (tmp-&gt;m_realName.IsEmpty() || (!tmp-&gt;m_hasFilename &amp;&amp;</span>
<a href="#l72.865"></a><span id="l72.865" class="difflineminus">-        (opt-&gt;html_as_p != 4 || opt-&gt;metadata_only))))</span>
<a href="#l72.866"></a><span id="l72.866" class="difflineminus">-    {</span>
<a href="#l72.867"></a><span id="l72.867" class="difflineplus">+    if (!tmp-&gt;m_disposition.EqualsLiteral(&quot;attachment&quot;) &amp;&amp;</span>
<a href="#l72.868"></a><span id="l72.868" class="difflineplus">+        tmp-&gt;m_displayableInline &amp;&amp;</span>
<a href="#l72.869"></a><span id="l72.869" class="difflineplus">+        (tmp-&gt;m_realName.IsEmpty() ||</span>
<a href="#l72.870"></a><span id="l72.870" class="difflineplus">+         (!tmp-&gt;m_hasFilename &amp;&amp;</span>
<a href="#l72.871"></a><span id="l72.871" class="difflineplus">+          (opt-&gt;html_as_p != 4 || opt-&gt;metadata_only)))) {</span>
<a href="#l72.872"></a><span id="l72.872">       ++i;</span>
<a href="#l72.873"></a><span id="l72.873">       ++tmp;</span>
<a href="#l72.874"></a><span id="l72.874">       continue;</span>
<a href="#l72.875"></a><span id="l72.875">     }</span>
<a href="#l72.876"></a><span id="l72.876"> </span>
<a href="#l72.877"></a><span id="l72.877">     nsAutoCString spec;</span>
<a href="#l72.878"></a><span id="l72.878">     if (tmp-&gt;m_url) {</span>
<a href="#l72.879"></a><span id="l72.879">       if (tmp-&gt;m_isExternalLinkAttachment)</span>
<a href="#l72.880"></a><span id="l72.880" class="difflineat">@@ -687,631 +646,554 @@ NotifyEmittersOfAttachmentList(MimeDispl</span>
<a href="#l72.881"></a><span id="l72.881">     if (tmp-&gt;m_isExternalLinkAttachment)</span>
<a href="#l72.882"></a><span id="l72.882">       sizeStr.Append(tmp-&gt;m_sizeExternalStr);</span>
<a href="#l72.883"></a><span id="l72.883">     else</span>
<a href="#l72.884"></a><span id="l72.884">       sizeStr.AppendInt(tmp-&gt;m_size);</span>
<a href="#l72.885"></a><span id="l72.885"> </span>
<a href="#l72.886"></a><span id="l72.886">     nsAutoCString downloadedStr;</span>
<a href="#l72.887"></a><span id="l72.887">     downloadedStr.AppendInt(tmp-&gt;m_isDownloaded);</span>
<a href="#l72.888"></a><span id="l72.888"> </span>
<a href="#l72.889"></a><span id="l72.889" class="difflineminus">-    mimeEmitterStartAttachment(opt, tmp-&gt;m_realName.get(), tmp-&gt;m_realType.get(),</span>
<a href="#l72.890"></a><span id="l72.890" class="difflineminus">-                               spec.get(), tmp-&gt;m_isExternalAttachment);</span>
<a href="#l72.891"></a><span id="l72.891" class="difflineplus">+    mimeEmitterStartAttachment(opt, tmp-&gt;m_realName.get(),</span>
<a href="#l72.892"></a><span id="l72.892" class="difflineplus">+                               tmp-&gt;m_realType.get(), spec.get(),</span>
<a href="#l72.893"></a><span id="l72.893" class="difflineplus">+                               tmp-&gt;m_isExternalAttachment);</span>
<a href="#l72.894"></a><span id="l72.894">     mimeEmitterAddAttachmentField(opt, HEADER_X_MOZILLA_PART_URL, spec.get());</span>
<a href="#l72.895"></a><span id="l72.895" class="difflineminus">-    mimeEmitterAddAttachmentField(opt, HEADER_X_MOZILLA_PART_SIZE, sizeStr.get());</span>
<a href="#l72.896"></a><span id="l72.896" class="difflineminus">-    mimeEmitterAddAttachmentField(opt, HEADER_X_MOZILLA_PART_DOWNLOADED, downloadedStr.get());</span>
<a href="#l72.897"></a><span id="l72.897" class="difflineplus">+    mimeEmitterAddAttachmentField(opt, HEADER_X_MOZILLA_PART_SIZE,</span>
<a href="#l72.898"></a><span id="l72.898" class="difflineplus">+                                  sizeStr.get());</span>
<a href="#l72.899"></a><span id="l72.899" class="difflineplus">+    mimeEmitterAddAttachmentField(opt, HEADER_X_MOZILLA_PART_DOWNLOADED,</span>
<a href="#l72.900"></a><span id="l72.900" class="difflineplus">+                                  downloadedStr.get());</span>
<a href="#l72.901"></a><span id="l72.901"> </span>
<a href="#l72.902"></a><span id="l72.902" class="difflineminus">-    if ( (opt-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting) ||</span>
<a href="#l72.903"></a><span id="l72.903" class="difflineminus">-         (opt-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting) ||</span>
<a href="#l72.904"></a><span id="l72.904" class="difflineminus">-         (opt-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs) ||</span>
<a href="#l72.905"></a><span id="l72.905" class="difflineminus">-         (opt-&gt;format_out == nsMimeOutput::nsMimeMessagePrintOutput))</span>
<a href="#l72.906"></a><span id="l72.906" class="difflineminus">-    {</span>
<a href="#l72.907"></a><span id="l72.907" class="difflineminus">-      mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_DESCRIPTION, tmp-&gt;m_description.get());</span>
<a href="#l72.908"></a><span id="l72.908" class="difflineminus">-      mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_TYPE, tmp-&gt;m_realType.get());</span>
<a href="#l72.909"></a><span id="l72.909" class="difflineminus">-      mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_ENCODING, tmp-&gt;m_realEncoding.get());</span>
<a href="#l72.910"></a><span id="l72.910" class="difflineplus">+    if ((opt-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting) ||</span>
<a href="#l72.911"></a><span id="l72.911" class="difflineplus">+        (opt-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting) ||</span>
<a href="#l72.912"></a><span id="l72.912" class="difflineplus">+        (opt-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs) ||</span>
<a href="#l72.913"></a><span id="l72.913" class="difflineplus">+        (opt-&gt;format_out == nsMimeOutput::nsMimeMessagePrintOutput)) {</span>
<a href="#l72.914"></a><span id="l72.914" class="difflineplus">+      mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_DESCRIPTION,</span>
<a href="#l72.915"></a><span id="l72.915" class="difflineplus">+                                    tmp-&gt;m_description.get());</span>
<a href="#l72.916"></a><span id="l72.916" class="difflineplus">+      mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_TYPE,</span>
<a href="#l72.917"></a><span id="l72.917" class="difflineplus">+                                    tmp-&gt;m_realType.get());</span>
<a href="#l72.918"></a><span id="l72.918" class="difflineplus">+      mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_ENCODING,</span>
<a href="#l72.919"></a><span id="l72.919" class="difflineplus">+                                    tmp-&gt;m_realEncoding.get());</span>
<a href="#l72.920"></a><span id="l72.920">     }</span>
<a href="#l72.921"></a><span id="l72.921"> </span>
<a href="#l72.922"></a><span id="l72.922">     mimeEmitterEndAttachment(opt);</span>
<a href="#l72.923"></a><span id="l72.923">     ++i;</span>
<a href="#l72.924"></a><span id="l72.924">     ++tmp;</span>
<a href="#l72.925"></a><span id="l72.925">   }</span>
<a href="#l72.926"></a><span id="l72.926">   mimeEmitterEndAllAttachments(opt);</span>
<a href="#l72.927"></a><span id="l72.927"> }</span>
<a href="#l72.928"></a><span id="l72.928"> </span>
<a href="#l72.929"></a><span id="l72.929"> // Utility to create a nsIURI object...</span>
<a href="#l72.930"></a><span id="l72.930" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.931"></a><span id="l72.931" class="difflineminus">-nsMimeNewURI(nsIURI** aInstancePtrResult, const char *aSpec, nsIURI *aBase)</span>
<a href="#l72.932"></a><span id="l72.932" class="difflineminus">-{</span>
<a href="#l72.933"></a><span id="l72.933" class="difflineminus">-  if (nullptr == aInstancePtrResult)</span>
<a href="#l72.934"></a><span id="l72.934" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l72.935"></a><span id="l72.935" class="difflineplus">+extern &quot;C&quot; nsresult nsMimeNewURI(nsIURI **aInstancePtrResult, const char *aSpec,</span>
<a href="#l72.936"></a><span id="l72.936" class="difflineplus">+                                 nsIURI *aBase) {</span>
<a href="#l72.937"></a><span id="l72.937" class="difflineplus">+  if (nullptr == aInstancePtrResult) return NS_ERROR_NULL_POINTER;</span>
<a href="#l72.938"></a><span id="l72.938"> </span>
<a href="#l72.939"></a><span id="l72.939" class="difflineminus">-  nsCOMPtr&lt;nsIIOService&gt; pService =</span>
<a href="#l72.940"></a><span id="l72.940" class="difflineminus">-    mozilla::services::GetIOService();</span>
<a href="#l72.941"></a><span id="l72.941" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; pService = mozilla::services::GetIOService();</span>
<a href="#l72.942"></a><span id="l72.942">   NS_ENSURE_TRUE(pService, NS_ERROR_FACTORY_NOT_REGISTERED);</span>
<a href="#l72.943"></a><span id="l72.943"> </span>
<a href="#l72.944"></a><span id="l72.944" class="difflineminus">-  return pService-&gt;NewURI(nsDependentCString(aSpec), nullptr, aBase, aInstancePtrResult);</span>
<a href="#l72.945"></a><span id="l72.945" class="difflineplus">+  return pService-&gt;NewURI(nsDependentCString(aSpec), nullptr, aBase,</span>
<a href="#l72.946"></a><span id="l72.946" class="difflineplus">+                          aInstancePtrResult);</span>
<a href="#l72.947"></a><span id="l72.947"> }</span>
<a href="#l72.948"></a><span id="l72.948"> </span>
<a href="#l72.949"></a><span id="l72.949" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.950"></a><span id="l72.950" class="difflineminus">-SetMailCharacterSetToMsgWindow(MimeObject *obj, const char *aCharacterSet)</span>
<a href="#l72.951"></a><span id="l72.951" class="difflineminus">-{</span>
<a href="#l72.952"></a><span id="l72.952" class="difflineplus">+extern &quot;C&quot; nsresult SetMailCharacterSetToMsgWindow(MimeObject *obj,</span>
<a href="#l72.953"></a><span id="l72.953" class="difflineplus">+                                                   const char *aCharacterSet) {</span>
<a href="#l72.954"></a><span id="l72.954">   nsresult rv = NS_OK;</span>
<a href="#l72.955"></a><span id="l72.955"> </span>
<a href="#l72.956"></a><span id="l72.956" class="difflineminus">-  if (obj &amp;&amp; obj-&gt;options)</span>
<a href="#l72.957"></a><span id="l72.957" class="difflineminus">-  {</span>
<a href="#l72.958"></a><span id="l72.958" class="difflineminus">-    mime_stream_data *msd = (mime_stream_data *) (obj-&gt;options-&gt;stream_closure);</span>
<a href="#l72.959"></a><span id="l72.959" class="difflineminus">-    if (msd)</span>
<a href="#l72.960"></a><span id="l72.960" class="difflineminus">-    {</span>
<a href="#l72.961"></a><span id="l72.961" class="difflineplus">+  if (obj &amp;&amp; obj-&gt;options) {</span>
<a href="#l72.962"></a><span id="l72.962" class="difflineplus">+    mime_stream_data *msd = (mime_stream_data *)(obj-&gt;options-&gt;stream_closure);</span>
<a href="#l72.963"></a><span id="l72.963" class="difflineplus">+    if (msd) {</span>
<a href="#l72.964"></a><span id="l72.964">       nsIChannel *channel = msd-&gt;channel;</span>
<a href="#l72.965"></a><span id="l72.965" class="difflineminus">-      if (channel)</span>
<a href="#l72.966"></a><span id="l72.966" class="difflineminus">-      {</span>
<a href="#l72.967"></a><span id="l72.967" class="difflineplus">+      if (channel) {</span>
<a href="#l72.968"></a><span id="l72.968">         nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l72.969"></a><span id="l72.969">         channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l72.970"></a><span id="l72.970" class="difflineminus">-        if (uri)</span>
<a href="#l72.971"></a><span id="l72.971" class="difflineminus">-        {</span>
<a href="#l72.972"></a><span id="l72.972" class="difflineminus">-          nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(uri));</span>
<a href="#l72.973"></a><span id="l72.973" class="difflineminus">-          if (msgurl)</span>
<a href="#l72.974"></a><span id="l72.974" class="difflineminus">-          {</span>
<a href="#l72.975"></a><span id="l72.975" class="difflineplus">+        if (uri) {</span>
<a href="#l72.976"></a><span id="l72.976" class="difflineplus">+          nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(uri));</span>
<a href="#l72.977"></a><span id="l72.977" class="difflineplus">+          if (msgurl) {</span>
<a href="#l72.978"></a><span id="l72.978">             nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l72.979"></a><span id="l72.979">             msgurl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l72.980"></a><span id="l72.980">             if (msgWindow)</span>
<a href="#l72.981"></a><span id="l72.981" class="difflineminus">-              rv = msgWindow-&gt;SetMailCharacterSet(!PL_strcasecmp(aCharacterSet, &quot;us-ascii&quot;) ?</span>
<a href="#l72.982"></a><span id="l72.982" class="difflineminus">-                                                  static_cast&lt;const nsCString&amp;&gt;(NS_LITERAL_CSTRING(&quot;ISO-8859-1&quot;)) :</span>
<a href="#l72.983"></a><span id="l72.983" class="difflineminus">-                                                  static_cast&lt;const nsCString&amp;&gt;(nsDependentCString(aCharacterSet)));</span>
<a href="#l72.984"></a><span id="l72.984" class="difflineplus">+              rv = msgWindow-&gt;SetMailCharacterSet(</span>
<a href="#l72.985"></a><span id="l72.985" class="difflineplus">+                  !PL_strcasecmp(aCharacterSet, &quot;us-ascii&quot;)</span>
<a href="#l72.986"></a><span id="l72.986" class="difflineplus">+                      ? static_cast&lt;const nsCString &amp;&gt;(</span>
<a href="#l72.987"></a><span id="l72.987" class="difflineplus">+                            NS_LITERAL_CSTRING(&quot;ISO-8859-1&quot;))</span>
<a href="#l72.988"></a><span id="l72.988" class="difflineplus">+                      : static_cast&lt;const nsCString &amp;&gt;(</span>
<a href="#l72.989"></a><span id="l72.989" class="difflineplus">+                            nsDependentCString(aCharacterSet)));</span>
<a href="#l72.990"></a><span id="l72.990">           }</span>
<a href="#l72.991"></a><span id="l72.991">         }</span>
<a href="#l72.992"></a><span id="l72.992">       }</span>
<a href="#l72.993"></a><span id="l72.993">     }</span>
<a href="#l72.994"></a><span id="l72.994">   }</span>
<a href="#l72.995"></a><span id="l72.995"> </span>
<a href="#l72.996"></a><span id="l72.996">   return rv;</span>
<a href="#l72.997"></a><span id="l72.997"> }</span>
<a href="#l72.998"></a><span id="l72.998"> </span>
<a href="#l72.999"></a><span id="l72.999" class="difflineminus">-static void ResetMsgHeaderSinkProps(nsIURI *uri)</span>
<a href="#l72.1000"></a><span id="l72.1000" class="difflineminus">-{</span>
<a href="#l72.1001"></a><span id="l72.1001" class="difflineplus">+static void ResetMsgHeaderSinkProps(nsIURI *uri) {</span>
<a href="#l72.1002"></a><span id="l72.1002">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(uri));</span>
<a href="#l72.1003"></a><span id="l72.1003" class="difflineminus">-  if (!msgurl)</span>
<a href="#l72.1004"></a><span id="l72.1004" class="difflineminus">-    return;</span>
<a href="#l72.1005"></a><span id="l72.1005" class="difflineplus">+  if (!msgurl) return;</span>
<a href="#l72.1006"></a><span id="l72.1006"> </span>
<a href="#l72.1007"></a><span id="l72.1007">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l72.1008"></a><span id="l72.1008">   msgurl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l72.1009"></a><span id="l72.1009" class="difflineminus">-  if (!msgWindow)</span>
<a href="#l72.1010"></a><span id="l72.1010" class="difflineminus">-    return;</span>
<a href="#l72.1011"></a><span id="l72.1011" class="difflineplus">+  if (!msgWindow) return;</span>
<a href="#l72.1012"></a><span id="l72.1012"> </span>
<a href="#l72.1013"></a><span id="l72.1013">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; msgHeaderSink;</span>
<a href="#l72.1014"></a><span id="l72.1014">   msgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(msgHeaderSink));</span>
<a href="#l72.1015"></a><span id="l72.1015" class="difflineminus">-  if (!msgHeaderSink)</span>
<a href="#l72.1016"></a><span id="l72.1016" class="difflineminus">-    return;</span>
<a href="#l72.1017"></a><span id="l72.1017" class="difflineplus">+  if (!msgHeaderSink) return;</span>
<a href="#l72.1018"></a><span id="l72.1018"> </span>
<a href="#l72.1019"></a><span id="l72.1019">   msgHeaderSink-&gt;ResetProperties();</span>
<a href="#l72.1020"></a><span id="l72.1020"> }</span>
<a href="#l72.1021"></a><span id="l72.1021"> </span>
<a href="#l72.1022"></a><span id="l72.1022" class="difflineminus">-static char *</span>
<a href="#l72.1023"></a><span id="l72.1023" class="difflineminus">-mime_file_type (const char *filename, void *stream_closure)</span>
<a href="#l72.1024"></a><span id="l72.1024" class="difflineminus">-{</span>
<a href="#l72.1025"></a><span id="l72.1025" class="difflineminus">-  char        *retType = nullptr;</span>
<a href="#l72.1026"></a><span id="l72.1026" class="difflineminus">-  char        *ext = nullptr;</span>
<a href="#l72.1027"></a><span id="l72.1027" class="difflineminus">-  nsresult    rv;</span>
<a href="#l72.1028"></a><span id="l72.1028" class="difflineplus">+static char *mime_file_type(const char *filename, void *stream_closure) {</span>
<a href="#l72.1029"></a><span id="l72.1029" class="difflineplus">+  char *retType = nullptr;</span>
<a href="#l72.1030"></a><span id="l72.1030" class="difflineplus">+  char *ext = nullptr;</span>
<a href="#l72.1031"></a><span id="l72.1031" class="difflineplus">+  nsresult rv;</span>
<a href="#l72.1032"></a><span id="l72.1032"> </span>
<a href="#l72.1033"></a><span id="l72.1033">   ext = PL_strrchr(filename, '.');</span>
<a href="#l72.1034"></a><span id="l72.1034" class="difflineminus">-  if (ext)</span>
<a href="#l72.1035"></a><span id="l72.1035" class="difflineminus">-  {</span>
<a href="#l72.1036"></a><span id="l72.1036" class="difflineplus">+  if (ext) {</span>
<a href="#l72.1037"></a><span id="l72.1037">     ext++;</span>
<a href="#l72.1038"></a><span id="l72.1038" class="difflineminus">-    nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder (do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l72.1039"></a><span id="l72.1039" class="difflineplus">+    nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder(</span>
<a href="#l72.1040"></a><span id="l72.1040" class="difflineplus">+        do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l72.1041"></a><span id="l72.1041">     if (mimeFinder) {</span>
<a href="#l72.1042"></a><span id="l72.1042">       nsAutoCString type;</span>
<a href="#l72.1043"></a><span id="l72.1043">       mimeFinder-&gt;GetTypeFromExtension(nsDependentCString(ext), type);</span>
<a href="#l72.1044"></a><span id="l72.1044">       retType = ToNewCString(type);</span>
<a href="#l72.1045"></a><span id="l72.1045">     }</span>
<a href="#l72.1046"></a><span id="l72.1046">   }</span>
<a href="#l72.1047"></a><span id="l72.1047"> </span>
<a href="#l72.1048"></a><span id="l72.1048">   return retType;</span>
<a href="#l72.1049"></a><span id="l72.1049"> }</span>
<a href="#l72.1050"></a><span id="l72.1050"> </span>
<a href="#l72.1051"></a><span id="l72.1051"> int ConvertToUTF8(const char *stringToUse, int32_t inLength,</span>
<a href="#l72.1052"></a><span id="l72.1052" class="difflineminus">-                  const char *input_charset,</span>
<a href="#l72.1053"></a><span id="l72.1053" class="difflineminus">-                  nsACString&amp; outString)</span>
<a href="#l72.1054"></a><span id="l72.1054" class="difflineminus">-{</span>
<a href="#l72.1055"></a><span id="l72.1055" class="difflineplus">+                  const char *input_charset, nsACString &amp;outString) {</span>
<a href="#l72.1056"></a><span id="l72.1056">   nsresult rv = NS_OK;</span>
<a href="#l72.1057"></a><span id="l72.1057"> </span>
<a href="#l72.1058"></a><span id="l72.1058">   // Look up Thunderbird's special aliases from charsetalias.properties.</span>
<a href="#l72.1059"></a><span id="l72.1059">   nsCOMPtr&lt;nsICharsetConverterManager&gt; ccm =</span>
<a href="#l72.1060"></a><span id="l72.1060" class="difflineminus">-    do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l72.1061"></a><span id="l72.1061" class="difflineplus">+      do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l72.1062"></a><span id="l72.1062">   NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l72.1063"></a><span id="l72.1063"> </span>
<a href="#l72.1064"></a><span id="l72.1064">   nsCString newCharset;</span>
<a href="#l72.1065"></a><span id="l72.1065">   rv = ccm-&gt;GetCharsetAlias(input_charset, newCharset);</span>
<a href="#l72.1066"></a><span id="l72.1066">   NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l72.1067"></a><span id="l72.1067"> </span>
<a href="#l72.1068"></a><span id="l72.1068">   if (newCharset.Equals(&quot;UTF-7&quot;, nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l72.1069"></a><span id="l72.1069">     nsAutoString utf16;</span>
<a href="#l72.1070"></a><span id="l72.1070">     rv = CopyUTF7toUTF16(nsDependentCSubstring(stringToUse, inLength), utf16);</span>
<a href="#l72.1071"></a><span id="l72.1071" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l72.1072"></a><span id="l72.1072" class="difflineminus">-      return -1;</span>
<a href="#l72.1073"></a><span id="l72.1073" class="difflineplus">+    if (NS_FAILED(rv)) return -1;</span>
<a href="#l72.1074"></a><span id="l72.1074">     CopyUTF16toUTF8(utf16, outString);</span>
<a href="#l72.1075"></a><span id="l72.1075">     return 0;</span>
<a href="#l72.1076"></a><span id="l72.1076">   }</span>
<a href="#l72.1077"></a><span id="l72.1077"> </span>
<a href="#l72.1078"></a><span id="l72.1078">   auto encoding = mozilla::Encoding::ForLabel(newCharset);</span>
<a href="#l72.1079"></a><span id="l72.1079" class="difflineminus">-  NS_ENSURE_TRUE(encoding, -1);  // Impossible since GetCharsetAlias() already checked.</span>
<a href="#l72.1080"></a><span id="l72.1080" class="difflineplus">+  NS_ENSURE_TRUE(encoding,</span>
<a href="#l72.1081"></a><span id="l72.1081" class="difflineplus">+                 -1);  // Impossible since GetCharsetAlias() already checked.</span>
<a href="#l72.1082"></a><span id="l72.1082"> </span>
<a href="#l72.1083"></a><span id="l72.1083" class="difflineminus">-  rv = encoding-&gt;DecodeWithoutBOMHandling(nsDependentCSubstring(stringToUse, inLength), outString);</span>
<a href="#l72.1084"></a><span id="l72.1084" class="difflineplus">+  rv = encoding-&gt;DecodeWithoutBOMHandling(</span>
<a href="#l72.1085"></a><span id="l72.1085" class="difflineplus">+      nsDependentCSubstring(stringToUse, inLength), outString);</span>
<a href="#l72.1086"></a><span id="l72.1086">   return NS_SUCCEEDED(rv) ? 0 : -1;</span>
<a href="#l72.1087"></a><span id="l72.1087"> }</span>
<a href="#l72.1088"></a><span id="l72.1088"> </span>
<a href="#l72.1089"></a><span id="l72.1089" class="difflineminus">-static int</span>
<a href="#l72.1090"></a><span id="l72.1090" class="difflineminus">-mime_convert_charset (const char *input_line, int32_t input_length,</span>
<a href="#l72.1091"></a><span id="l72.1091" class="difflineminus">-                      const char *input_charset,</span>
<a href="#l72.1092"></a><span id="l72.1092" class="difflineminus">-                      nsACString&amp; convertedString,</span>
<a href="#l72.1093"></a><span id="l72.1093" class="difflineminus">-                      void *stream_closure)</span>
<a href="#l72.1094"></a><span id="l72.1094" class="difflineminus">-{</span>
<a href="#l72.1095"></a><span id="l72.1095" class="difflineminus">-  return ConvertToUTF8(input_line, input_length, input_charset, convertedString);</span>
<a href="#l72.1096"></a><span id="l72.1096" class="difflineplus">+static int mime_convert_charset(const char *input_line, int32_t input_length,</span>
<a href="#l72.1097"></a><span id="l72.1097" class="difflineplus">+                                const char *input_charset,</span>
<a href="#l72.1098"></a><span id="l72.1098" class="difflineplus">+                                nsACString &amp;convertedString,</span>
<a href="#l72.1099"></a><span id="l72.1099" class="difflineplus">+                                void *stream_closure) {</span>
<a href="#l72.1100"></a><span id="l72.1100" class="difflineplus">+  return ConvertToUTF8(input_line, input_length, input_charset,</span>
<a href="#l72.1101"></a><span id="l72.1101" class="difflineplus">+                       convertedString);</span>
<a href="#l72.1102"></a><span id="l72.1102"> }</span>
<a href="#l72.1103"></a><span id="l72.1103"> </span>
<a href="#l72.1104"></a><span id="l72.1104" class="difflineminus">-static int</span>
<a href="#l72.1105"></a><span id="l72.1105" class="difflineminus">-mime_output_fn(const char *buf, int32_t size, void *stream_closure)</span>
<a href="#l72.1106"></a><span id="l72.1106" class="difflineminus">-{</span>
<a href="#l72.1107"></a><span id="l72.1107" class="difflineminus">-  uint32_t  written = 0;</span>
<a href="#l72.1108"></a><span id="l72.1108" class="difflineminus">-  mime_stream_data *msd = (mime_stream_data *) stream_closure;</span>
<a href="#l72.1109"></a><span id="l72.1109" class="difflineminus">-  if ( (!msd-&gt;pluginObj2) &amp;&amp; (!msd-&gt;output_emitter) )</span>
<a href="#l72.1110"></a><span id="l72.1110" class="difflineminus">-    return -1;</span>
<a href="#l72.1111"></a><span id="l72.1111" class="difflineplus">+static int mime_output_fn(const char *buf, int32_t size, void *stream_closure) {</span>
<a href="#l72.1112"></a><span id="l72.1112" class="difflineplus">+  uint32_t written = 0;</span>
<a href="#l72.1113"></a><span id="l72.1113" class="difflineplus">+  mime_stream_data *msd = (mime_stream_data *)stream_closure;</span>
<a href="#l72.1114"></a><span id="l72.1114" class="difflineplus">+  if ((!msd-&gt;pluginObj2) &amp;&amp; (!msd-&gt;output_emitter)) return -1;</span>
<a href="#l72.1115"></a><span id="l72.1115"> </span>
<a href="#l72.1116"></a><span id="l72.1116">   // Fire pending start request</span>
<a href="#l72.1117"></a><span id="l72.1117" class="difflineminus">-  ((nsStreamConverter*)msd-&gt;pluginObj2)-&gt;FirePendingStartRequest();</span>
<a href="#l72.1118"></a><span id="l72.1118" class="difflineminus">-</span>
<a href="#l72.1119"></a><span id="l72.1119" class="difflineplus">+  ((nsStreamConverter *)msd-&gt;pluginObj2)-&gt;FirePendingStartRequest();</span>
<a href="#l72.1120"></a><span id="l72.1120"> </span>
<a href="#l72.1121"></a><span id="l72.1121">   // Now, write to the WriteBody method if this is a message body and not</span>
<a href="#l72.1122"></a><span id="l72.1122">   // a part retrevial</span>
<a href="#l72.1123"></a><span id="l72.1123" class="difflineminus">-  if (!msd-&gt;options-&gt;part_to_load || msd-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay)</span>
<a href="#l72.1124"></a><span id="l72.1124" class="difflineminus">-  {</span>
<a href="#l72.1125"></a><span id="l72.1125" class="difflineminus">-    if (msd-&gt;output_emitter)</span>
<a href="#l72.1126"></a><span id="l72.1126" class="difflineminus">-    {</span>
<a href="#l72.1127"></a><span id="l72.1127" class="difflineminus">-      msd-&gt;output_emitter-&gt;WriteBody(Substring(buf, buf+size),</span>
<a href="#l72.1128"></a><span id="l72.1128" class="difflineminus">-                                     &amp;written);</span>
<a href="#l72.1129"></a><span id="l72.1129" class="difflineplus">+  if (!msd-&gt;options-&gt;part_to_load ||</span>
<a href="#l72.1130"></a><span id="l72.1130" class="difflineplus">+      msd-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay) {</span>
<a href="#l72.1131"></a><span id="l72.1131" class="difflineplus">+    if (msd-&gt;output_emitter) {</span>
<a href="#l72.1132"></a><span id="l72.1132" class="difflineplus">+      msd-&gt;output_emitter-&gt;WriteBody(Substring(buf, buf + size), &amp;written);</span>
<a href="#l72.1133"></a><span id="l72.1133">     }</span>
<a href="#l72.1134"></a><span id="l72.1134" class="difflineminus">-  }</span>
<a href="#l72.1135"></a><span id="l72.1135" class="difflineminus">-  else</span>
<a href="#l72.1136"></a><span id="l72.1136" class="difflineminus">-  {</span>
<a href="#l72.1137"></a><span id="l72.1137" class="difflineminus">-    if (msd-&gt;output_emitter)</span>
<a href="#l72.1138"></a><span id="l72.1138" class="difflineminus">-    {</span>
<a href="#l72.1139"></a><span id="l72.1139" class="difflineminus">-      msd-&gt;output_emitter-&gt;Write(Substring(buf, buf+size), &amp;written);</span>
<a href="#l72.1140"></a><span id="l72.1140" class="difflineplus">+  } else {</span>
<a href="#l72.1141"></a><span id="l72.1141" class="difflineplus">+    if (msd-&gt;output_emitter) {</span>
<a href="#l72.1142"></a><span id="l72.1142" class="difflineplus">+      msd-&gt;output_emitter-&gt;Write(Substring(buf, buf + size), &amp;written);</span>
<a href="#l72.1143"></a><span id="l72.1143">     }</span>
<a href="#l72.1144"></a><span id="l72.1144">   }</span>
<a href="#l72.1145"></a><span id="l72.1145">   return written;</span>
<a href="#l72.1146"></a><span id="l72.1146"> }</span>
<a href="#l72.1147"></a><span id="l72.1147"> </span>
<a href="#l72.1148"></a><span id="l72.1148" class="difflineminus">-extern &quot;C&quot; int</span>
<a href="#l72.1149"></a><span id="l72.1149" class="difflineminus">-mime_display_stream_write (nsMIMESession *stream,</span>
<a href="#l72.1150"></a><span id="l72.1150" class="difflineminus">-                           const char* buf,</span>
<a href="#l72.1151"></a><span id="l72.1151" class="difflineminus">-                           int32_t size)</span>
<a href="#l72.1152"></a><span id="l72.1152" class="difflineminus">-{</span>
<a href="#l72.1153"></a><span id="l72.1153" class="difflineminus">-  mime_stream_data *msd = (mime_stream_data *) ((nsMIMESession *)stream)-&gt;data_object;</span>
<a href="#l72.1154"></a><span id="l72.1154" class="difflineplus">+extern &quot;C&quot; int mime_display_stream_write(nsMIMESession *stream, const char *buf,</span>
<a href="#l72.1155"></a><span id="l72.1155" class="difflineplus">+                                         int32_t size) {</span>
<a href="#l72.1156"></a><span id="l72.1156" class="difflineplus">+  mime_stream_data *msd =</span>
<a href="#l72.1157"></a><span id="l72.1157" class="difflineplus">+      (mime_stream_data *)((nsMIMESession *)stream)-&gt;data_object;</span>
<a href="#l72.1158"></a><span id="l72.1158"> </span>
<a href="#l72.1159"></a><span id="l72.1159">   MimeObject *obj = (msd ? msd-&gt;obj : 0);</span>
<a href="#l72.1160"></a><span id="l72.1160">   if (!obj) return -1;</span>
<a href="#l72.1161"></a><span id="l72.1161"> </span>
<a href="#l72.1162"></a><span id="l72.1162">   //</span>
<a href="#l72.1163"></a><span id="l72.1163" class="difflineminus">-  // Ok, now check to see if this is a display operation for a MIME Parts on Demand</span>
<a href="#l72.1164"></a><span id="l72.1164" class="difflineminus">-  // enabled call.</span>
<a href="#l72.1165"></a><span id="l72.1165" class="difflineplus">+  // Ok, now check to see if this is a display operation for a MIME Parts on</span>
<a href="#l72.1166"></a><span id="l72.1166" class="difflineplus">+  // Demand enabled call.</span>
<a href="#l72.1167"></a><span id="l72.1167">   //</span>
<a href="#l72.1168"></a><span id="l72.1168" class="difflineminus">-  if (msd-&gt;firstCheck)</span>
<a href="#l72.1169"></a><span id="l72.1169" class="difflineminus">-  {</span>
<a href="#l72.1170"></a><span id="l72.1170" class="difflineminus">-    if (msd-&gt;channel)</span>
<a href="#l72.1171"></a><span id="l72.1171" class="difflineminus">-    {</span>
<a href="#l72.1172"></a><span id="l72.1172" class="difflineplus">+  if (msd-&gt;firstCheck) {</span>
<a href="#l72.1173"></a><span id="l72.1173" class="difflineplus">+    if (msd-&gt;channel) {</span>
<a href="#l72.1174"></a><span id="l72.1174">       nsCOMPtr&lt;nsIURI&gt; aUri;</span>
<a href="#l72.1175"></a><span id="l72.1175" class="difflineminus">-      if (NS_SUCCEEDED(msd-&gt;channel-&gt;GetURI(getter_AddRefs(aUri))))</span>
<a href="#l72.1176"></a><span id="l72.1176" class="difflineminus">-      {</span>
<a href="#l72.1177"></a><span id="l72.1177" class="difflineplus">+      if (NS_SUCCEEDED(msd-&gt;channel-&gt;GetURI(getter_AddRefs(aUri)))) {</span>
<a href="#l72.1178"></a><span id="l72.1178">         nsCOMPtr&lt;nsIImapUrl&gt; imapURL = do_QueryInterface(aUri);</span>
<a href="#l72.1179"></a><span id="l72.1179" class="difflineminus">-        if (imapURL)</span>
<a href="#l72.1180"></a><span id="l72.1180" class="difflineminus">-        {</span>
<a href="#l72.1181"></a><span id="l72.1181" class="difflineminus">-          nsImapContentModifiedType   cModified;</span>
<a href="#l72.1182"></a><span id="l72.1182" class="difflineminus">-          if (NS_SUCCEEDED(imapURL-&gt;GetContentModified(&amp;cModified)))</span>
<a href="#l72.1183"></a><span id="l72.1183" class="difflineminus">-          {</span>
<a href="#l72.1184"></a><span id="l72.1184" class="difflineminus">-            if ( cModified != nsImapContentModifiedTypes::IMAP_CONTENT_NOT_MODIFIED )</span>
<a href="#l72.1185"></a><span id="l72.1185" class="difflineplus">+        if (imapURL) {</span>
<a href="#l72.1186"></a><span id="l72.1186" class="difflineplus">+          nsImapContentModifiedType cModified;</span>
<a href="#l72.1187"></a><span id="l72.1187" class="difflineplus">+          if (NS_SUCCEEDED(imapURL-&gt;GetContentModified(&amp;cModified))) {</span>
<a href="#l72.1188"></a><span id="l72.1188" class="difflineplus">+            if (cModified !=</span>
<a href="#l72.1189"></a><span id="l72.1189" class="difflineplus">+                nsImapContentModifiedTypes::IMAP_CONTENT_NOT_MODIFIED)</span>
<a href="#l72.1190"></a><span id="l72.1190">               msd-&gt;options-&gt;missing_parts = true;</span>
<a href="#l72.1191"></a><span id="l72.1191">           }</span>
<a href="#l72.1192"></a><span id="l72.1192">         }</span>
<a href="#l72.1193"></a><span id="l72.1193">       }</span>
<a href="#l72.1194"></a><span id="l72.1194">     }</span>
<a href="#l72.1195"></a><span id="l72.1195"> </span>
<a href="#l72.1196"></a><span id="l72.1196">     msd-&gt;firstCheck = false;</span>
<a href="#l72.1197"></a><span id="l72.1197">   }</span>
<a href="#l72.1198"></a><span id="l72.1198"> </span>
<a href="#l72.1199"></a><span id="l72.1199" class="difflineminus">-  return obj-&gt;clazz-&gt;parse_buffer((char *) buf, size, obj);</span>
<a href="#l72.1200"></a><span id="l72.1200" class="difflineplus">+  return obj-&gt;clazz-&gt;parse_buffer((char *)buf, size, obj);</span>
<a href="#l72.1201"></a><span id="l72.1201"> }</span>
<a href="#l72.1202"></a><span id="l72.1202"> </span>
<a href="#l72.1203"></a><span id="l72.1203" class="difflineminus">-extern &quot;C&quot; void</span>
<a href="#l72.1204"></a><span id="l72.1204" class="difflineminus">-mime_display_stream_complete (nsMIMESession *stream)</span>
<a href="#l72.1205"></a><span id="l72.1205" class="difflineminus">-{</span>
<a href="#l72.1206"></a><span id="l72.1206" class="difflineminus">-  mime_stream_data *msd = (mime_stream_data *) ((nsMIMESession *)stream)-&gt;data_object;</span>
<a href="#l72.1207"></a><span id="l72.1207" class="difflineplus">+extern &quot;C&quot; void mime_display_stream_complete(nsMIMESession *stream) {</span>
<a href="#l72.1208"></a><span id="l72.1208" class="difflineplus">+  mime_stream_data *msd =</span>
<a href="#l72.1209"></a><span id="l72.1209" class="difflineplus">+      (mime_stream_data *)((nsMIMESession *)stream)-&gt;data_object;</span>
<a href="#l72.1210"></a><span id="l72.1210">   MimeObject *obj = (msd ? msd-&gt;obj : 0);</span>
<a href="#l72.1211"></a><span id="l72.1211" class="difflineminus">-  if (obj)</span>
<a href="#l72.1212"></a><span id="l72.1212" class="difflineminus">-  {</span>
<a href="#l72.1213"></a><span id="l72.1213" class="difflineminus">-    int       status;</span>
<a href="#l72.1214"></a><span id="l72.1214" class="difflineminus">-    bool      abortNow = false;</span>
<a href="#l72.1215"></a><span id="l72.1215" class="difflineplus">+  if (obj) {</span>
<a href="#l72.1216"></a><span id="l72.1216" class="difflineplus">+    int status;</span>
<a href="#l72.1217"></a><span id="l72.1217" class="difflineplus">+    bool abortNow = false;</span>
<a href="#l72.1218"></a><span id="l72.1218"> </span>
<a href="#l72.1219"></a><span id="l72.1219">     if ((obj-&gt;options) &amp;&amp; (obj-&gt;options-&gt;headers == MimeHeadersOnly))</span>
<a href="#l72.1220"></a><span id="l72.1220">       abortNow = true;</span>
<a href="#l72.1221"></a><span id="l72.1221"> </span>
<a href="#l72.1222"></a><span id="l72.1222">     status = obj-&gt;clazz-&gt;parse_eof(obj, abortNow);</span>
<a href="#l72.1223"></a><span id="l72.1223">     obj-&gt;clazz-&gt;parse_end(obj, (status &lt; 0 ? true : false));</span>
<a href="#l72.1224"></a><span id="l72.1224"> </span>
<a href="#l72.1225"></a><span id="l72.1225">     //</span>
<a href="#l72.1226"></a><span id="l72.1226">     // Ok, now we are going to process the attachment data by getting all</span>
<a href="#l72.1227"></a><span id="l72.1227">     // of the attachment info and then driving the emitter with this data.</span>
<a href="#l72.1228"></a><span id="l72.1228">     //</span>
<a href="#l72.1229"></a><span id="l72.1229" class="difflineminus">-    if (!msd-&gt;options-&gt;part_to_load || msd-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay)</span>
<a href="#l72.1230"></a><span id="l72.1230" class="difflineminus">-    {</span>
<a href="#l72.1231"></a><span id="l72.1231" class="difflineplus">+    if (!msd-&gt;options-&gt;part_to_load ||</span>
<a href="#l72.1232"></a><span id="l72.1232" class="difflineplus">+        msd-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay) {</span>
<a href="#l72.1233"></a><span id="l72.1233">       nsMsgAttachmentData *attachments;</span>
<a href="#l72.1234"></a><span id="l72.1234">       nsresult rv = MimeGetAttachmentList(obj, msd-&gt;url_name, &amp;attachments);</span>
<a href="#l72.1235"></a><span id="l72.1235" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l72.1236"></a><span id="l72.1236" class="difflineminus">-      {</span>
<a href="#l72.1237"></a><span id="l72.1237" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l72.1238"></a><span id="l72.1238">         NotifyEmittersOfAttachmentList(msd-&gt;options, attachments);</span>
<a href="#l72.1239"></a><span id="l72.1239">         MimeFreeAttachmentList(attachments);</span>
<a href="#l72.1240"></a><span id="l72.1240">       }</span>
<a href="#l72.1241"></a><span id="l72.1241">     }</span>
<a href="#l72.1242"></a><span id="l72.1242"> </span>
<a href="#l72.1243"></a><span id="l72.1243">     // Release the conversion object - this has to be done after</span>
<a href="#l72.1244"></a><span id="l72.1244">     // we finish processing data.</span>
<a href="#l72.1245"></a><span id="l72.1245" class="difflineminus">-    if ( obj-&gt;options)</span>
<a href="#l72.1246"></a><span id="l72.1246" class="difflineminus">-    {</span>
<a href="#l72.1247"></a><span id="l72.1247" class="difflineplus">+    if (obj-&gt;options) {</span>
<a href="#l72.1248"></a><span id="l72.1248">       NS_IF_RELEASE(obj-&gt;options-&gt;conv);</span>
<a href="#l72.1249"></a><span id="l72.1249">     }</span>
<a href="#l72.1250"></a><span id="l72.1250"> </span>
<a href="#l72.1251"></a><span id="l72.1251">     // Destroy the object now.</span>
<a href="#l72.1252"></a><span id="l72.1252">     PR_ASSERT(msd-&gt;options == obj-&gt;options);</span>
<a href="#l72.1253"></a><span id="l72.1253">     mime_free(obj);</span>
<a href="#l72.1254"></a><span id="l72.1254">     obj = NULL;</span>
<a href="#l72.1255"></a><span id="l72.1255" class="difflineminus">-    if (msd-&gt;options)</span>
<a href="#l72.1256"></a><span id="l72.1256" class="difflineminus">-    {</span>
<a href="#l72.1257"></a><span id="l72.1257" class="difflineplus">+    if (msd-&gt;options) {</span>
<a href="#l72.1258"></a><span id="l72.1258">       delete msd-&gt;options;</span>
<a href="#l72.1259"></a><span id="l72.1259">       msd-&gt;options = 0;</span>
<a href="#l72.1260"></a><span id="l72.1260">     }</span>
<a href="#l72.1261"></a><span id="l72.1261">   }</span>
<a href="#l72.1262"></a><span id="l72.1262"> </span>
<a href="#l72.1263"></a><span id="l72.1263" class="difflineminus">-  if (msd-&gt;headers)</span>
<a href="#l72.1264"></a><span id="l72.1264" class="difflineminus">-    MimeHeaders_free (msd-&gt;headers);</span>
<a href="#l72.1265"></a><span id="l72.1265" class="difflineplus">+  if (msd-&gt;headers) MimeHeaders_free(msd-&gt;headers);</span>
<a href="#l72.1266"></a><span id="l72.1266"> </span>
<a href="#l72.1267"></a><span id="l72.1267" class="difflineminus">-  if (msd-&gt;url_name)</span>
<a href="#l72.1268"></a><span id="l72.1268" class="difflineminus">-    free(msd-&gt;url_name);</span>
<a href="#l72.1269"></a><span id="l72.1269" class="difflineplus">+  if (msd-&gt;url_name) free(msd-&gt;url_name);</span>
<a href="#l72.1270"></a><span id="l72.1270"> </span>
<a href="#l72.1271"></a><span id="l72.1271" class="difflineminus">-  if (msd-&gt;orig_url_name)</span>
<a href="#l72.1272"></a><span id="l72.1272" class="difflineminus">-      free(msd-&gt;orig_url_name);</span>
<a href="#l72.1273"></a><span id="l72.1273" class="difflineplus">+  if (msd-&gt;orig_url_name) free(msd-&gt;orig_url_name);</span>
<a href="#l72.1274"></a><span id="l72.1274"> </span>
<a href="#l72.1275"></a><span id="l72.1275">   delete msd;</span>
<a href="#l72.1276"></a><span id="l72.1276"> }</span>
<a href="#l72.1277"></a><span id="l72.1277"> </span>
<a href="#l72.1278"></a><span id="l72.1278" class="difflineminus">-extern &quot;C&quot; void</span>
<a href="#l72.1279"></a><span id="l72.1279" class="difflineminus">-mime_display_stream_abort (nsMIMESession *stream, int status)</span>
<a href="#l72.1280"></a><span id="l72.1280" class="difflineminus">-{</span>
<a href="#l72.1281"></a><span id="l72.1281" class="difflineminus">-  mime_stream_data *msd = (mime_stream_data *) ((nsMIMESession *)stream)-&gt;data_object;</span>
<a href="#l72.1282"></a><span id="l72.1282" class="difflineplus">+extern &quot;C&quot; void mime_display_stream_abort(nsMIMESession *stream, int status) {</span>
<a href="#l72.1283"></a><span id="l72.1283" class="difflineplus">+  mime_stream_data *msd =</span>
<a href="#l72.1284"></a><span id="l72.1284" class="difflineplus">+      (mime_stream_data *)((nsMIMESession *)stream)-&gt;data_object;</span>
<a href="#l72.1285"></a><span id="l72.1285"> </span>
<a href="#l72.1286"></a><span id="l72.1286">   MimeObject *obj = (msd ? msd-&gt;obj : 0);</span>
<a href="#l72.1287"></a><span id="l72.1287" class="difflineminus">-  if (obj)</span>
<a href="#l72.1288"></a><span id="l72.1288" class="difflineminus">-  {</span>
<a href="#l72.1289"></a><span id="l72.1289" class="difflineminus">-    if (!obj-&gt;closed_p)</span>
<a href="#l72.1290"></a><span id="l72.1290" class="difflineminus">-      obj-&gt;clazz-&gt;parse_eof(obj, true);</span>
<a href="#l72.1291"></a><span id="l72.1291" class="difflineminus">-    if (!obj-&gt;parsed_p)</span>
<a href="#l72.1292"></a><span id="l72.1292" class="difflineminus">-      obj-&gt;clazz-&gt;parse_end(obj, true);</span>
<a href="#l72.1293"></a><span id="l72.1293" class="difflineplus">+  if (obj) {</span>
<a href="#l72.1294"></a><span id="l72.1294" class="difflineplus">+    if (!obj-&gt;closed_p) obj-&gt;clazz-&gt;parse_eof(obj, true);</span>
<a href="#l72.1295"></a><span id="l72.1295" class="difflineplus">+    if (!obj-&gt;parsed_p) obj-&gt;clazz-&gt;parse_end(obj, true);</span>
<a href="#l72.1296"></a><span id="l72.1296"> </span>
<a href="#l72.1297"></a><span id="l72.1297">     // Destroy code....</span>
<a href="#l72.1298"></a><span id="l72.1298">     PR_ASSERT(msd-&gt;options == obj-&gt;options);</span>
<a href="#l72.1299"></a><span id="l72.1299">     mime_free(obj);</span>
<a href="#l72.1300"></a><span id="l72.1300" class="difflineminus">-    if (msd-&gt;options)</span>
<a href="#l72.1301"></a><span id="l72.1301" class="difflineminus">-    {</span>
<a href="#l72.1302"></a><span id="l72.1302" class="difflineplus">+    if (msd-&gt;options) {</span>
<a href="#l72.1303"></a><span id="l72.1303">       delete msd-&gt;options;</span>
<a href="#l72.1304"></a><span id="l72.1304">       msd-&gt;options = 0;</span>
<a href="#l72.1305"></a><span id="l72.1305">     }</span>
<a href="#l72.1306"></a><span id="l72.1306">   }</span>
<a href="#l72.1307"></a><span id="l72.1307"> </span>
<a href="#l72.1308"></a><span id="l72.1308" class="difflineminus">-  if (msd-&gt;headers)</span>
<a href="#l72.1309"></a><span id="l72.1309" class="difflineminus">-    MimeHeaders_free (msd-&gt;headers);</span>
<a href="#l72.1310"></a><span id="l72.1310" class="difflineplus">+  if (msd-&gt;headers) MimeHeaders_free(msd-&gt;headers);</span>
<a href="#l72.1311"></a><span id="l72.1311"> </span>
<a href="#l72.1312"></a><span id="l72.1312" class="difflineminus">-  if (msd-&gt;url_name)</span>
<a href="#l72.1313"></a><span id="l72.1313" class="difflineminus">-    free(msd-&gt;url_name);</span>
<a href="#l72.1314"></a><span id="l72.1314" class="difflineplus">+  if (msd-&gt;url_name) free(msd-&gt;url_name);</span>
<a href="#l72.1315"></a><span id="l72.1315"> </span>
<a href="#l72.1316"></a><span id="l72.1316" class="difflineminus">-  if (msd-&gt;orig_url_name)</span>
<a href="#l72.1317"></a><span id="l72.1317" class="difflineminus">-      free(msd-&gt;orig_url_name);</span>
<a href="#l72.1318"></a><span id="l72.1318" class="difflineplus">+  if (msd-&gt;orig_url_name) free(msd-&gt;orig_url_name);</span>
<a href="#l72.1319"></a><span id="l72.1319"> </span>
<a href="#l72.1320"></a><span id="l72.1320">   delete msd;</span>
<a href="#l72.1321"></a><span id="l72.1321"> }</span>
<a href="#l72.1322"></a><span id="l72.1322"> </span>
<a href="#l72.1323"></a><span id="l72.1323" class="difflineminus">-static int</span>
<a href="#l72.1324"></a><span id="l72.1324" class="difflineminus">-mime_output_init_fn (const char *type,</span>
<a href="#l72.1325"></a><span id="l72.1325" class="difflineminus">-                     const char *charset,</span>
<a href="#l72.1326"></a><span id="l72.1326" class="difflineminus">-                     const char *name,</span>
<a href="#l72.1327"></a><span id="l72.1327" class="difflineminus">-                     const char *x_mac_type,</span>
<a href="#l72.1328"></a><span id="l72.1328" class="difflineminus">-                     const char *x_mac_creator,</span>
<a href="#l72.1329"></a><span id="l72.1329" class="difflineminus">-                     void *stream_closure)</span>
<a href="#l72.1330"></a><span id="l72.1330" class="difflineminus">-{</span>
<a href="#l72.1331"></a><span id="l72.1331" class="difflineminus">-  mime_stream_data *msd = (mime_stream_data *) stream_closure;</span>
<a href="#l72.1332"></a><span id="l72.1332" class="difflineplus">+static int mime_output_init_fn(const char *type, const char *charset,</span>
<a href="#l72.1333"></a><span id="l72.1333" class="difflineplus">+                               const char *name, const char *x_mac_type,</span>
<a href="#l72.1334"></a><span id="l72.1334" class="difflineplus">+                               const char *x_mac_creator,</span>
<a href="#l72.1335"></a><span id="l72.1335" class="difflineplus">+                               void *stream_closure) {</span>
<a href="#l72.1336"></a><span id="l72.1336" class="difflineplus">+  mime_stream_data *msd = (mime_stream_data *)stream_closure;</span>
<a href="#l72.1337"></a><span id="l72.1337"> </span>
<a href="#l72.1338"></a><span id="l72.1338">   // Now, all of this stream creation is done outside of libmime, so this</span>
<a href="#l72.1339"></a><span id="l72.1339">   // is just a check of the pluginObj member and returning accordingly.</span>
<a href="#l72.1340"></a><span id="l72.1340">   if (!msd-&gt;pluginObj2)</span>
<a href="#l72.1341"></a><span id="l72.1341">     return -1;</span>
<a href="#l72.1342"></a><span id="l72.1342">   else</span>
<a href="#l72.1343"></a><span id="l72.1343">     return 0;</span>
<a href="#l72.1344"></a><span id="l72.1344"> }</span>
<a href="#l72.1345"></a><span id="l72.1345"> </span>
<a href="#l72.1346"></a><span id="l72.1346" class="difflineminus">-static void   *mime_image_begin(const char *image_url, const char *content_type,</span>
<a href="#l72.1347"></a><span id="l72.1347" class="difflineplus">+static void *mime_image_begin(const char *image_url, const char *content_type,</span>
<a href="#l72.1348"></a><span id="l72.1348">                               void *stream_closure);</span>
<a href="#l72.1349"></a><span id="l72.1349" class="difflineminus">-static void   mime_image_end(void *image_closure, int status);</span>
<a href="#l72.1350"></a><span id="l72.1350" class="difflineminus">-static char   *mime_image_make_image_html(void *image_data);</span>
<a href="#l72.1351"></a><span id="l72.1351" class="difflineminus">-static int    mime_image_write_buffer(const char *buf, int32_t size, void *image_closure);</span>
<a href="#l72.1352"></a><span id="l72.1352" class="difflineplus">+static void mime_image_end(void *image_closure, int status);</span>
<a href="#l72.1353"></a><span id="l72.1353" class="difflineplus">+static char *mime_image_make_image_html(void *image_data);</span>
<a href="#l72.1354"></a><span id="l72.1354" class="difflineplus">+static int mime_image_write_buffer(const char *buf, int32_t size,</span>
<a href="#l72.1355"></a><span id="l72.1355" class="difflineplus">+                                   void *image_closure);</span>
<a href="#l72.1356"></a><span id="l72.1356"> </span>
<a href="#l72.1357"></a><span id="l72.1357"> /* Interface between libmime and inline display of images: the abomination</span>
<a href="#l72.1358"></a><span id="l72.1358">    that is known as &quot;internal-external-reconnect&quot;.</span>
<a href="#l72.1359"></a><span id="l72.1359">  */</span>
<a href="#l72.1360"></a><span id="l72.1360"> class mime_image_stream_data {</span>
<a href="#l72.1361"></a><span id="l72.1361" class="difflineminus">-public:</span>
<a href="#l72.1362"></a><span id="l72.1362" class="difflineplus">+ public:</span>
<a href="#l72.1363"></a><span id="l72.1363">   mime_image_stream_data();</span>
<a href="#l72.1364"></a><span id="l72.1364"> </span>
<a href="#l72.1365"></a><span id="l72.1365">   mime_stream_data *msd;</span>
<a href="#l72.1366"></a><span id="l72.1366" class="difflineminus">-  char                    *url;</span>
<a href="#l72.1367"></a><span id="l72.1367" class="difflineminus">-  nsMIMESession           *istream;</span>
<a href="#l72.1368"></a><span id="l72.1368" class="difflineplus">+  char *url;</span>
<a href="#l72.1369"></a><span id="l72.1369" class="difflineplus">+  nsMIMESession *istream;</span>
<a href="#l72.1370"></a><span id="l72.1370"> };</span>
<a href="#l72.1371"></a><span id="l72.1371"> </span>
<a href="#l72.1372"></a><span id="l72.1372" class="difflineminus">-mime_image_stream_data::mime_image_stream_data()</span>
<a href="#l72.1373"></a><span id="l72.1373" class="difflineminus">-{</span>
<a href="#l72.1374"></a><span id="l72.1374" class="difflineplus">+mime_image_stream_data::mime_image_stream_data() {</span>
<a href="#l72.1375"></a><span id="l72.1375">   url = nullptr;</span>
<a href="#l72.1376"></a><span id="l72.1376">   istream = nullptr;</span>
<a href="#l72.1377"></a><span id="l72.1377">   msd = nullptr;</span>
<a href="#l72.1378"></a><span id="l72.1378"> }</span>
<a href="#l72.1379"></a><span id="l72.1379"> </span>
<a href="#l72.1380"></a><span id="l72.1380" class="difflineminus">-static void *</span>
<a href="#l72.1381"></a><span id="l72.1381" class="difflineminus">-mime_image_begin(const char *image_url, const char *content_type,</span>
<a href="#l72.1382"></a><span id="l72.1382" class="difflineminus">-                 void *stream_closure)</span>
<a href="#l72.1383"></a><span id="l72.1383" class="difflineminus">-{</span>
<a href="#l72.1384"></a><span id="l72.1384" class="difflineminus">-  mime_stream_data *msd = (mime_stream_data *) stream_closure;</span>
<a href="#l72.1385"></a><span id="l72.1385" class="difflineplus">+static void *mime_image_begin(const char *image_url, const char *content_type,</span>
<a href="#l72.1386"></a><span id="l72.1386" class="difflineplus">+                              void *stream_closure) {</span>
<a href="#l72.1387"></a><span id="l72.1387" class="difflineplus">+  mime_stream_data *msd = (mime_stream_data *)stream_closure;</span>
<a href="#l72.1388"></a><span id="l72.1388">   class mime_image_stream_data *mid;</span>
<a href="#l72.1389"></a><span id="l72.1389"> </span>
<a href="#l72.1390"></a><span id="l72.1390">   mid = new mime_image_stream_data;</span>
<a href="#l72.1391"></a><span id="l72.1391">   if (!mid) return nullptr;</span>
<a href="#l72.1392"></a><span id="l72.1392"> </span>
<a href="#l72.1393"></a><span id="l72.1393" class="difflineminus">-</span>
<a href="#l72.1394"></a><span id="l72.1394">   mid-&gt;msd = msd;</span>
<a href="#l72.1395"></a><span id="l72.1395"> </span>
<a href="#l72.1396"></a><span id="l72.1396" class="difflineminus">-  mid-&gt;url = (char *) strdup(image_url);</span>
<a href="#l72.1397"></a><span id="l72.1397" class="difflineminus">-  if (!mid-&gt;url)</span>
<a href="#l72.1398"></a><span id="l72.1398" class="difflineminus">-  {</span>
<a href="#l72.1399"></a><span id="l72.1399" class="difflineplus">+  mid-&gt;url = (char *)strdup(image_url);</span>
<a href="#l72.1400"></a><span id="l72.1400" class="difflineplus">+  if (!mid-&gt;url) {</span>
<a href="#l72.1401"></a><span id="l72.1401">     PR_Free(mid);</span>
<a href="#l72.1402"></a><span id="l72.1402">     return nullptr;</span>
<a href="#l72.1403"></a><span id="l72.1403">   }</span>
<a href="#l72.1404"></a><span id="l72.1404"> </span>
<a href="#l72.1405"></a><span id="l72.1405" class="difflineminus">-  mid-&gt;istream = (nsMIMESession *) msd-&gt;pluginObj2;</span>
<a href="#l72.1406"></a><span id="l72.1406" class="difflineplus">+  mid-&gt;istream = (nsMIMESession *)msd-&gt;pluginObj2;</span>
<a href="#l72.1407"></a><span id="l72.1407">   return mid;</span>
<a href="#l72.1408"></a><span id="l72.1408"> }</span>
<a href="#l72.1409"></a><span id="l72.1409"> </span>
<a href="#l72.1410"></a><span id="l72.1410" class="difflineminus">-static void</span>
<a href="#l72.1411"></a><span id="l72.1411" class="difflineminus">-mime_image_end(void *image_closure, int status)</span>
<a href="#l72.1412"></a><span id="l72.1412" class="difflineminus">-{</span>
<a href="#l72.1413"></a><span id="l72.1413" class="difflineminus">-  mime_image_stream_data *mid =</span>
<a href="#l72.1414"></a><span id="l72.1414" class="difflineminus">-    (mime_image_stream_data *) image_closure;</span>
<a href="#l72.1415"></a><span id="l72.1415" class="difflineplus">+static void mime_image_end(void *image_closure, int status) {</span>
<a href="#l72.1416"></a><span id="l72.1416" class="difflineplus">+  mime_image_stream_data *mid = (mime_image_stream_data *)image_closure;</span>
<a href="#l72.1417"></a><span id="l72.1417"> </span>
<a href="#l72.1418"></a><span id="l72.1418">   PR_ASSERT(mid);</span>
<a href="#l72.1419"></a><span id="l72.1419" class="difflineminus">-  if (!mid)</span>
<a href="#l72.1420"></a><span id="l72.1420" class="difflineminus">-    return;</span>
<a href="#l72.1421"></a><span id="l72.1421" class="difflineplus">+  if (!mid) return;</span>
<a href="#l72.1422"></a><span id="l72.1422"> </span>
<a href="#l72.1423"></a><span id="l72.1423">   PR_FREEIF(mid-&gt;url);</span>
<a href="#l72.1424"></a><span id="l72.1424">   delete mid;</span>
<a href="#l72.1425"></a><span id="l72.1425"> }</span>
<a href="#l72.1426"></a><span id="l72.1426"> </span>
<a href="#l72.1427"></a><span id="l72.1427" class="difflineminus">-</span>
<a href="#l72.1428"></a><span id="l72.1428" class="difflineminus">-static char *</span>
<a href="#l72.1429"></a><span id="l72.1429" class="difflineminus">-mime_image_make_image_html(void *image_closure)</span>
<a href="#l72.1430"></a><span id="l72.1430" class="difflineminus">-{</span>
<a href="#l72.1431"></a><span id="l72.1431" class="difflineminus">-  mime_image_stream_data *mid =</span>
<a href="#l72.1432"></a><span id="l72.1432" class="difflineminus">-    (mime_image_stream_data *) image_closure;</span>
<a href="#l72.1433"></a><span id="l72.1433" class="difflineplus">+static char *mime_image_make_image_html(void *image_closure) {</span>
<a href="#l72.1434"></a><span id="l72.1434" class="difflineplus">+  mime_image_stream_data *mid = (mime_image_stream_data *)image_closure;</span>
<a href="#l72.1435"></a><span id="l72.1435"> </span>
<a href="#l72.1436"></a><span id="l72.1436">   PR_ASSERT(mid);</span>
<a href="#l72.1437"></a><span id="l72.1437">   if (!mid) return 0;</span>
<a href="#l72.1438"></a><span id="l72.1438"> </span>
<a href="#l72.1439"></a><span id="l72.1439">   /* Internal-external-reconnect only works when going to the screen. */</span>
<a href="#l72.1440"></a><span id="l72.1440">   if (!mid-&gt;istream)</span>
<a href="#l72.1441"></a><span id="l72.1441" class="difflineminus">-    return strdup(&quot;&lt;DIV CLASS=\&quot;moz-attached-image-container\&quot;&gt;&lt;IMG SRC=\&quot;resource://gre-resources/loading-image.png\&quot; ALT=\&quot;[Image]\&quot;&gt;&lt;/DIV&gt;&quot;);</span>
<a href="#l72.1442"></a><span id="l72.1442" class="difflineplus">+    return strdup(</span>
<a href="#l72.1443"></a><span id="l72.1443" class="difflineplus">+        &quot;&lt;DIV CLASS=\&quot;moz-attached-image-container\&quot;&gt;&lt;IMG &quot;</span>
<a href="#l72.1444"></a><span id="l72.1444" class="difflineplus">+        &quot;SRC=\&quot;resource://gre-resources/loading-image.png\&quot; &quot;</span>
<a href="#l72.1445"></a><span id="l72.1445" class="difflineplus">+        &quot;ALT=\&quot;[Image]\&quot;&gt;&lt;/DIV&gt;&quot;);</span>
<a href="#l72.1446"></a><span id="l72.1446"> </span>
<a href="#l72.1447"></a><span id="l72.1447">   const char *prefix;</span>
<a href="#l72.1448"></a><span id="l72.1448">   const char *url;</span>
<a href="#l72.1449"></a><span id="l72.1449">   char *buf;</span>
<a href="#l72.1450"></a><span id="l72.1450">   /* Wouldn't it be nice if attributes were case-sensitive? */</span>
<a href="#l72.1451"></a><span id="l72.1451" class="difflineminus">-  const char *scaledPrefix = &quot;&lt;DIV CLASS=\&quot;moz-attached-image-container\&quot;&gt;&lt;IMG CLASS=\&quot;moz-attached-image\&quot; shrinktofit=\&quot;yes\&quot; SRC=\&quot;&quot;;</span>
<a href="#l72.1452"></a><span id="l72.1452" class="difflineplus">+  const char *scaledPrefix =</span>
<a href="#l72.1453"></a><span id="l72.1453" class="difflineplus">+      &quot;&lt;DIV CLASS=\&quot;moz-attached-image-container\&quot;&gt;&lt;IMG &quot;</span>
<a href="#l72.1454"></a><span id="l72.1454" class="difflineplus">+      &quot;CLASS=\&quot;moz-attached-image\&quot; shrinktofit=\&quot;yes\&quot; SRC=\&quot;&quot;;</span>
<a href="#l72.1455"></a><span id="l72.1455">   const char *suffix = &quot;\&quot;&gt;&lt;/DIV&gt;&quot;;</span>
<a href="#l72.1456"></a><span id="l72.1456">   // Thunderbird doesn't have this pref.</span>
<a href="#l72.1457"></a><span id="l72.1457"> #ifdef MOZ_SUITE</span>
<a href="#l72.1458"></a><span id="l72.1458" class="difflineminus">-  const char *unscaledPrefix = &quot;&lt;DIV CLASS=\&quot;moz-attached-image-container\&quot;&gt;&lt;IMG CLASS=\&quot;moz-attached-image\&quot; SRC=\&quot;&quot;;</span>
<a href="#l72.1459"></a><span id="l72.1459" class="difflineplus">+  const char *unscaledPrefix =</span>
<a href="#l72.1460"></a><span id="l72.1460" class="difflineplus">+      &quot;&lt;DIV CLASS=\&quot;moz-attached-image-container\&quot;&gt;&lt;IMG &quot;</span>
<a href="#l72.1461"></a><span id="l72.1461" class="difflineplus">+      &quot;CLASS=\&quot;moz-attached-image\&quot; SRC=\&quot;&quot;;</span>
<a href="#l72.1462"></a><span id="l72.1462">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l72.1463"></a><span id="l72.1463">   nsCOMPtr&lt;nsIPrefService&gt; prefSvc(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l72.1464"></a><span id="l72.1464">   bool resize = true;</span>
<a href="#l72.1465"></a><span id="l72.1465"> </span>
<a href="#l72.1466"></a><span id="l72.1466" class="difflineminus">-  if (prefSvc)</span>
<a href="#l72.1467"></a><span id="l72.1467" class="difflineminus">-    prefSvc-&gt;GetBranch(&quot;&quot;, getter_AddRefs(prefBranch));</span>
<a href="#l72.1468"></a><span id="l72.1468" class="difflineplus">+  if (prefSvc) prefSvc-&gt;GetBranch(&quot;&quot;, getter_AddRefs(prefBranch));</span>
<a href="#l72.1469"></a><span id="l72.1469">   if (prefBranch)</span>
<a href="#l72.1470"></a><span id="l72.1470" class="difflineminus">-    prefBranch-&gt;GetBoolPref(&quot;mail.enable_automatic_image_resizing&quot;, &amp;resize); // ignore return value</span>
<a href="#l72.1471"></a><span id="l72.1471" class="difflineplus">+    prefBranch-&gt;GetBoolPref(&quot;mail.enable_automatic_image_resizing&quot;,</span>
<a href="#l72.1472"></a><span id="l72.1472" class="difflineplus">+                            &amp;resize);  // ignore return value</span>
<a href="#l72.1473"></a><span id="l72.1473">   prefix = resize ? scaledPrefix : unscaledPrefix;</span>
<a href="#l72.1474"></a><span id="l72.1474"> #else</span>
<a href="#l72.1475"></a><span id="l72.1475">   prefix = scaledPrefix;</span>
<a href="#l72.1476"></a><span id="l72.1476"> #endif</span>
<a href="#l72.1477"></a><span id="l72.1477"> </span>
<a href="#l72.1478"></a><span id="l72.1478" class="difflineminus">-  if ( (!mid-&gt;url) || (!(*mid-&gt;url)) )</span>
<a href="#l72.1479"></a><span id="l72.1479" class="difflineplus">+  if ((!mid-&gt;url) || (!(*mid-&gt;url)))</span>
<a href="#l72.1480"></a><span id="l72.1480">     url = &quot;&quot;;</span>
<a href="#l72.1481"></a><span id="l72.1481">   else</span>
<a href="#l72.1482"></a><span id="l72.1482">     url = mid-&gt;url;</span>
<a href="#l72.1483"></a><span id="l72.1483"> </span>
<a href="#l72.1484"></a><span id="l72.1484">   uint32_t buflen = strlen(prefix) + strlen(suffix) + strlen(url) + 20;</span>
<a href="#l72.1485"></a><span id="l72.1485" class="difflineminus">-  buf = (char *) PR_MALLOC (buflen);</span>
<a href="#l72.1486"></a><span id="l72.1486" class="difflineminus">-  if (!buf)</span>
<a href="#l72.1487"></a><span id="l72.1487" class="difflineminus">-    return 0;</span>
<a href="#l72.1488"></a><span id="l72.1488" class="difflineplus">+  buf = (char *)PR_MALLOC(buflen);</span>
<a href="#l72.1489"></a><span id="l72.1489" class="difflineplus">+  if (!buf) return 0;</span>
<a href="#l72.1490"></a><span id="l72.1490">   *buf = 0;</span>
<a href="#l72.1491"></a><span id="l72.1491"> </span>
<a href="#l72.1492"></a><span id="l72.1492" class="difflineminus">-  PL_strcatn (buf, buflen, prefix);</span>
<a href="#l72.1493"></a><span id="l72.1493" class="difflineminus">-  PL_strcatn (buf, buflen, url);</span>
<a href="#l72.1494"></a><span id="l72.1494" class="difflineminus">-  PL_strcatn (buf, buflen, suffix);</span>
<a href="#l72.1495"></a><span id="l72.1495" class="difflineplus">+  PL_strcatn(buf, buflen, prefix);</span>
<a href="#l72.1496"></a><span id="l72.1496" class="difflineplus">+  PL_strcatn(buf, buflen, url);</span>
<a href="#l72.1497"></a><span id="l72.1497" class="difflineplus">+  PL_strcatn(buf, buflen, suffix);</span>
<a href="#l72.1498"></a><span id="l72.1498">   return buf;</span>
<a href="#l72.1499"></a><span id="l72.1499"> }</span>
<a href="#l72.1500"></a><span id="l72.1500"> </span>
<a href="#l72.1501"></a><span id="l72.1501" class="difflineminus">-static int</span>
<a href="#l72.1502"></a><span id="l72.1502" class="difflineminus">-mime_image_write_buffer(const char *buf, int32_t size, void *image_closure)</span>
<a href="#l72.1503"></a><span id="l72.1503" class="difflineminus">-{</span>
<a href="#l72.1504"></a><span id="l72.1504" class="difflineminus">-  mime_image_stream_data *mid =</span>
<a href="#l72.1505"></a><span id="l72.1505" class="difflineminus">-                (mime_image_stream_data *) image_closure;</span>
<a href="#l72.1506"></a><span id="l72.1506" class="difflineplus">+static int mime_image_write_buffer(const char *buf, int32_t size,</span>
<a href="#l72.1507"></a><span id="l72.1507" class="difflineplus">+                                   void *image_closure) {</span>
<a href="#l72.1508"></a><span id="l72.1508" class="difflineplus">+  mime_image_stream_data *mid = (mime_image_stream_data *)image_closure;</span>
<a href="#l72.1509"></a><span id="l72.1509">   mime_stream_data *msd = mid-&gt;msd;</span>
<a href="#l72.1510"></a><span id="l72.1510"> </span>
<a href="#l72.1511"></a><span id="l72.1511" class="difflineminus">-  if ( ( (!msd-&gt;output_emitter) ) &amp;&amp;</span>
<a href="#l72.1512"></a><span id="l72.1512" class="difflineminus">-       ( (!msd-&gt;pluginObj2)     ) )</span>
<a href="#l72.1513"></a><span id="l72.1513" class="difflineminus">-    return -1;</span>
<a href="#l72.1514"></a><span id="l72.1514" class="difflineplus">+  if (((!msd-&gt;output_emitter)) &amp;&amp; ((!msd-&gt;pluginObj2))) return -1;</span>
<a href="#l72.1515"></a><span id="l72.1515"> </span>
<a href="#l72.1516"></a><span id="l72.1516">   return size;</span>
<a href="#l72.1517"></a><span id="l72.1517"> }</span>
<a href="#l72.1518"></a><span id="l72.1518"> </span>
<a href="#l72.1519"></a><span id="l72.1519" class="difflineminus">-MimeObject*</span>
<a href="#l72.1520"></a><span id="l72.1520" class="difflineminus">-mime_get_main_object(MimeObject* obj)</span>
<a href="#l72.1521"></a><span id="l72.1521" class="difflineminus">-{</span>
<a href="#l72.1522"></a><span id="l72.1522" class="difflineplus">+MimeObject *mime_get_main_object(MimeObject *obj) {</span>
<a href="#l72.1523"></a><span id="l72.1523">   MimeContainer *cobj;</span>
<a href="#l72.1524"></a><span id="l72.1524" class="difflineminus">-  if (!(mime_subclass_p(obj-&gt;clazz, (MimeObjectClass*) &amp;mimeMessageClass)))</span>
<a href="#l72.1525"></a><span id="l72.1525" class="difflineminus">-  {</span>
<a href="#l72.1526"></a><span id="l72.1526" class="difflineplus">+  if (!(mime_subclass_p(obj-&gt;clazz, (MimeObjectClass *)&amp;mimeMessageClass))) {</span>
<a href="#l72.1527"></a><span id="l72.1527">     return obj;</span>
<a href="#l72.1528"></a><span id="l72.1528">   }</span>
<a href="#l72.1529"></a><span id="l72.1529" class="difflineminus">-  cobj = (MimeContainer*) obj;</span>
<a href="#l72.1530"></a><span id="l72.1530" class="difflineplus">+  cobj = (MimeContainer *)obj;</span>
<a href="#l72.1531"></a><span id="l72.1531">   if (cobj-&gt;nchildren != 1) return obj;</span>
<a href="#l72.1532"></a><span id="l72.1532">   obj = cobj-&gt;children[0];</span>
<a href="#l72.1533"></a><span id="l72.1533" class="difflineminus">-  while (obj)</span>
<a href="#l72.1534"></a><span id="l72.1534" class="difflineminus">-  {</span>
<a href="#l72.1535"></a><span id="l72.1535" class="difflineminus">-    if ( (!mime_subclass_p(obj-&gt;clazz,</span>
<a href="#l72.1536"></a><span id="l72.1536" class="difflineminus">-         (MimeObjectClass*) &amp;mimeMultipartSignedClass)) &amp;&amp;</span>
<a href="#l72.1537"></a><span id="l72.1537" class="difflineminus">-         (PL_strcasecmp(obj-&gt;content_type, MULTIPART_SIGNED) != 0)</span>
<a href="#l72.1538"></a><span id="l72.1538" class="difflineminus">-       )</span>
<a href="#l72.1539"></a><span id="l72.1539" class="difflineminus">-    {</span>
<a href="#l72.1540"></a><span id="l72.1540" class="difflineminus">-        return obj;</span>
<a href="#l72.1541"></a><span id="l72.1541" class="difflineminus">-    }</span>
<a href="#l72.1542"></a><span id="l72.1542" class="difflineminus">-    else</span>
<a href="#l72.1543"></a><span id="l72.1543" class="difflineminus">-    {</span>
<a href="#l72.1544"></a><span id="l72.1544" class="difflineminus">-      if (mime_subclass_p(obj-&gt;clazz, (MimeObjectClass*)&amp;mimeContainerClass))</span>
<a href="#l72.1545"></a><span id="l72.1545" class="difflineminus">-      {</span>
<a href="#l72.1546"></a><span id="l72.1546" class="difflineplus">+  while (obj) {</span>
<a href="#l72.1547"></a><span id="l72.1547" class="difflineplus">+    if ((!mime_subclass_p(obj-&gt;clazz,</span>
<a href="#l72.1548"></a><span id="l72.1548" class="difflineplus">+                          (MimeObjectClass *)&amp;mimeMultipartSignedClass)) &amp;&amp;</span>
<a href="#l72.1549"></a><span id="l72.1549" class="difflineplus">+        (PL_strcasecmp(obj-&gt;content_type, MULTIPART_SIGNED) != 0)) {</span>
<a href="#l72.1550"></a><span id="l72.1550" class="difflineplus">+      return obj;</span>
<a href="#l72.1551"></a><span id="l72.1551" class="difflineplus">+    } else {</span>
<a href="#l72.1552"></a><span id="l72.1552" class="difflineplus">+      if (mime_subclass_p(obj-&gt;clazz, (MimeObjectClass *)&amp;mimeContainerClass)) {</span>
<a href="#l72.1553"></a><span id="l72.1553">         // We don't care about a signed/smime object; Go inside to the</span>
<a href="#l72.1554"></a><span id="l72.1554">         // thing that we signed or smime'ed</span>
<a href="#l72.1555"></a><span id="l72.1555">         //</span>
<a href="#l72.1556"></a><span id="l72.1556" class="difflineminus">-        cobj = (MimeContainer*) obj;</span>
<a href="#l72.1557"></a><span id="l72.1557" class="difflineplus">+        cobj = (MimeContainer *)obj;</span>
<a href="#l72.1558"></a><span id="l72.1558">         if (cobj-&gt;nchildren &gt; 0)</span>
<a href="#l72.1559"></a><span id="l72.1559">           obj = cobj-&gt;children[0];</span>
<a href="#l72.1560"></a><span id="l72.1560">         else</span>
<a href="#l72.1561"></a><span id="l72.1561">           obj = nullptr;</span>
<a href="#l72.1562"></a><span id="l72.1562" class="difflineminus">-      }</span>
<a href="#l72.1563"></a><span id="l72.1563" class="difflineminus">-      else</span>
<a href="#l72.1564"></a><span id="l72.1564" class="difflineminus">-      {</span>
<a href="#l72.1565"></a><span id="l72.1565" class="difflineplus">+      } else {</span>
<a href="#l72.1566"></a><span id="l72.1566">         // we received a message with a child object that looks like a signed</span>
<a href="#l72.1567"></a><span id="l72.1567">         // object, but it is not a subclass of mimeContainer, so let's</span>
<a href="#l72.1568"></a><span id="l72.1568">         // return the given child object.</span>
<a href="#l72.1569"></a><span id="l72.1569">         return obj;</span>
<a href="#l72.1570"></a><span id="l72.1570">       }</span>
<a href="#l72.1571"></a><span id="l72.1571">     }</span>
<a href="#l72.1572"></a><span id="l72.1572">   }</span>
<a href="#l72.1573"></a><span id="l72.1573">   return nullptr;</span>
<a href="#l72.1574"></a><span id="l72.1574"> }</span>
<a href="#l72.1575"></a><span id="l72.1575"> </span>
<a href="#l72.1576"></a><span id="l72.1576" class="difflineminus">-static</span>
<a href="#l72.1577"></a><span id="l72.1577" class="difflineminus">-bool MimeObjectIsMessageBodyNoClimb(MimeObject *parent,</span>
<a href="#l72.1578"></a><span id="l72.1578" class="difflineminus">-                                      MimeObject *looking_for,</span>
<a href="#l72.1579"></a><span id="l72.1579" class="difflineminus">-                                      bool *stop)</span>
<a href="#l72.1580"></a><span id="l72.1580" class="difflineminus">-{</span>
<a href="#l72.1581"></a><span id="l72.1581" class="difflineplus">+static bool MimeObjectIsMessageBodyNoClimb(MimeObject *parent,</span>
<a href="#l72.1582"></a><span id="l72.1582" class="difflineplus">+                                           MimeObject *looking_for,</span>
<a href="#l72.1583"></a><span id="l72.1583" class="difflineplus">+                                           bool *stop) {</span>
<a href="#l72.1584"></a><span id="l72.1584">   MimeContainer *container = (MimeContainer *)parent;</span>
<a href="#l72.1585"></a><span id="l72.1585">   int32_t i;</span>
<a href="#l72.1586"></a><span id="l72.1586">   char *disp;</span>
<a href="#l72.1587"></a><span id="l72.1587"> </span>
<a href="#l72.1588"></a><span id="l72.1588">   NS_ASSERTION(stop, &quot;NULL stop to MimeObjectIsMessageBodyNoClimb&quot;);</span>
<a href="#l72.1589"></a><span id="l72.1589"> </span>
<a href="#l72.1590"></a><span id="l72.1590">   for (i = 0; i &lt; container-&gt;nchildren; i++) {</span>
<a href="#l72.1591"></a><span id="l72.1591">     MimeObject *child = container-&gt;children[i];</span>
<a href="#l72.1592"></a><span id="l72.1592">     bool is_body = true;</span>
<a href="#l72.1593"></a><span id="l72.1593"> </span>
<a href="#l72.1594"></a><span id="l72.1594">     // The body can't be something we're not displaying.</span>
<a href="#l72.1595"></a><span id="l72.1595" class="difflineminus">-    if (! child-&gt;output_p)</span>
<a href="#l72.1596"></a><span id="l72.1596" class="difflineplus">+    if (!child-&gt;output_p)</span>
<a href="#l72.1597"></a><span id="l72.1597">       is_body = false;</span>
<a href="#l72.1598"></a><span id="l72.1598" class="difflineminus">-    else if ((disp = MimeHeaders_get (child-&gt;headers, HEADER_CONTENT_DISPOSITION,</span>
<a href="#l72.1599"></a><span id="l72.1599" class="difflineminus">-                                      true, false))) {</span>
<a href="#l72.1600"></a><span id="l72.1600" class="difflineplus">+    else if ((disp = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_DISPOSITION,</span>
<a href="#l72.1601"></a><span id="l72.1601" class="difflineplus">+                                     true, false))) {</span>
<a href="#l72.1602"></a><span id="l72.1602">       PR_Free(disp);</span>
<a href="#l72.1603"></a><span id="l72.1603">       is_body = false;</span>
<a href="#l72.1604"></a><span id="l72.1604" class="difflineminus">-    }</span>
<a href="#l72.1605"></a><span id="l72.1605" class="difflineminus">-    else if (PL_strcasecmp (child-&gt;content_type, TEXT_PLAIN) &amp;&amp;</span>
<a href="#l72.1606"></a><span id="l72.1606" class="difflineminus">-             PL_strcasecmp (child-&gt;content_type, TEXT_HTML) &amp;&amp;</span>
<a href="#l72.1607"></a><span id="l72.1607" class="difflineminus">-             PL_strcasecmp (child-&gt;content_type, TEXT_MDL) &amp;&amp;</span>
<a href="#l72.1608"></a><span id="l72.1608" class="difflineminus">-             PL_strcasecmp (child-&gt;content_type, MESSAGE_NEWS) &amp;&amp;</span>
<a href="#l72.1609"></a><span id="l72.1609" class="difflineminus">-             PL_strcasecmp (child-&gt;content_type, MESSAGE_RFC822))</span>
<a href="#l72.1610"></a><span id="l72.1610" class="difflineplus">+    } else if (PL_strcasecmp(child-&gt;content_type, TEXT_PLAIN) &amp;&amp;</span>
<a href="#l72.1611"></a><span id="l72.1611" class="difflineplus">+               PL_strcasecmp(child-&gt;content_type, TEXT_HTML) &amp;&amp;</span>
<a href="#l72.1612"></a><span id="l72.1612" class="difflineplus">+               PL_strcasecmp(child-&gt;content_type, TEXT_MDL) &amp;&amp;</span>
<a href="#l72.1613"></a><span id="l72.1613" class="difflineplus">+               PL_strcasecmp(child-&gt;content_type, MESSAGE_NEWS) &amp;&amp;</span>
<a href="#l72.1614"></a><span id="l72.1614" class="difflineplus">+               PL_strcasecmp(child-&gt;content_type, MESSAGE_RFC822))</span>
<a href="#l72.1615"></a><span id="l72.1615">       is_body = false;</span>
<a href="#l72.1616"></a><span id="l72.1616"> </span>
<a href="#l72.1617"></a><span id="l72.1617">     if (is_body || child == looking_for) {</span>
<a href="#l72.1618"></a><span id="l72.1618">       *stop = true;</span>
<a href="#l72.1619"></a><span id="l72.1619">       return child == looking_for;</span>
<a href="#l72.1620"></a><span id="l72.1620">     }</span>
<a href="#l72.1621"></a><span id="l72.1621"> </span>
<a href="#l72.1622"></a><span id="l72.1622">     // The body could be down inside a multipart child, so search recursively.</span>
<a href="#l72.1623"></a><span id="l72.1623" class="difflineminus">-    if (mime_subclass_p(child-&gt;clazz, (MimeObjectClass*) &amp;mimeContainerClass)) {</span>
<a href="#l72.1624"></a><span id="l72.1624" class="difflineplus">+    if (mime_subclass_p(child-&gt;clazz, (MimeObjectClass *)&amp;mimeContainerClass)) {</span>
<a href="#l72.1625"></a><span id="l72.1625">       is_body = MimeObjectIsMessageBodyNoClimb(child, looking_for, stop);</span>
<a href="#l72.1626"></a><span id="l72.1626" class="difflineminus">-      if (is_body || *stop)</span>
<a href="#l72.1627"></a><span id="l72.1627" class="difflineminus">-        return is_body;</span>
<a href="#l72.1628"></a><span id="l72.1628" class="difflineplus">+      if (is_body || *stop) return is_body;</span>
<a href="#l72.1629"></a><span id="l72.1629">     }</span>
<a href="#l72.1630"></a><span id="l72.1630">   }</span>
<a href="#l72.1631"></a><span id="l72.1631">   return false;</span>
<a href="#l72.1632"></a><span id="l72.1632"> }</span>
<a href="#l72.1633"></a><span id="l72.1633"> </span>
<a href="#l72.1634"></a><span id="l72.1634"> /* Should this be static in mimemult.cpp? */</span>
<a href="#l72.1635"></a><span id="l72.1635" class="difflineminus">-bool MimeObjectIsMessageBody(MimeObject *looking_for)</span>
<a href="#l72.1636"></a><span id="l72.1636" class="difflineminus">-{</span>
<a href="#l72.1637"></a><span id="l72.1637" class="difflineplus">+bool MimeObjectIsMessageBody(MimeObject *looking_for) {</span>
<a href="#l72.1638"></a><span id="l72.1638">   bool stop = false;</span>
<a href="#l72.1639"></a><span id="l72.1639">   MimeObject *root = looking_for;</span>
<a href="#l72.1640"></a><span id="l72.1640" class="difflineminus">-  while (root-&gt;parent)</span>
<a href="#l72.1641"></a><span id="l72.1641" class="difflineminus">-    root = root-&gt;parent;</span>
<a href="#l72.1642"></a><span id="l72.1642" class="difflineplus">+  while (root-&gt;parent) root = root-&gt;parent;</span>
<a href="#l72.1643"></a><span id="l72.1643">   return MimeObjectIsMessageBodyNoClimb(root, looking_for, &amp;stop);</span>
<a href="#l72.1644"></a><span id="l72.1644"> }</span>
<a href="#l72.1645"></a><span id="l72.1645"> </span>
<a href="#l72.1646"></a><span id="l72.1646"> //</span>
<a href="#l72.1647"></a><span id="l72.1647"> // New Stream Converter Interface</span>
<a href="#l72.1648"></a><span id="l72.1648"> //</span>
<a href="#l72.1649"></a><span id="l72.1649"> </span>
<a href="#l72.1650"></a><span id="l72.1650"> // Get the connection to prefs service manager</span>
<a href="#l72.1651"></a><span id="l72.1651" class="difflineminus">-nsIPrefBranch *</span>
<a href="#l72.1652"></a><span id="l72.1652" class="difflineminus">-GetPrefBranch(MimeDisplayOptions *opt)</span>
<a href="#l72.1653"></a><span id="l72.1653" class="difflineminus">-{</span>
<a href="#l72.1654"></a><span id="l72.1654" class="difflineminus">-  if (!opt)</span>
<a href="#l72.1655"></a><span id="l72.1655" class="difflineminus">-    return nullptr;</span>
<a href="#l72.1656"></a><span id="l72.1656" class="difflineplus">+nsIPrefBranch *GetPrefBranch(MimeDisplayOptions *opt) {</span>
<a href="#l72.1657"></a><span id="l72.1657" class="difflineplus">+  if (!opt) return nullptr;</span>
<a href="#l72.1658"></a><span id="l72.1658"> </span>
<a href="#l72.1659"></a><span id="l72.1659">   return opt-&gt;m_prefBranch;</span>
<a href="#l72.1660"></a><span id="l72.1660"> }</span>
<a href="#l72.1661"></a><span id="l72.1661"> </span>
<a href="#l72.1662"></a><span id="l72.1662"> // Get the text converter...</span>
<a href="#l72.1663"></a><span id="l72.1663" class="difflineminus">-mozITXTToHTMLConv *</span>
<a href="#l72.1664"></a><span id="l72.1664" class="difflineminus">-GetTextConverter(MimeDisplayOptions *opt)</span>
<a href="#l72.1665"></a><span id="l72.1665" class="difflineminus">-{</span>
<a href="#l72.1666"></a><span id="l72.1666" class="difflineminus">-  if (!opt)</span>
<a href="#l72.1667"></a><span id="l72.1667" class="difflineminus">-    return nullptr;</span>
<a href="#l72.1668"></a><span id="l72.1668" class="difflineplus">+mozITXTToHTMLConv *GetTextConverter(MimeDisplayOptions *opt) {</span>
<a href="#l72.1669"></a><span id="l72.1669" class="difflineplus">+  if (!opt) return nullptr;</span>
<a href="#l72.1670"></a><span id="l72.1670"> </span>
<a href="#l72.1671"></a><span id="l72.1671">   return opt-&gt;conv;</span>
<a href="#l72.1672"></a><span id="l72.1672"> }</span>
<a href="#l72.1673"></a><span id="l72.1673"> </span>
<a href="#l72.1674"></a><span id="l72.1674" class="difflineminus">-MimeDisplayOptions::MimeDisplayOptions()</span>
<a href="#l72.1675"></a><span id="l72.1675" class="difflineminus">-{</span>
<a href="#l72.1676"></a><span id="l72.1676" class="difflineminus">-  conv = nullptr;        // For text conversion...</span>
<a href="#l72.1677"></a><span id="l72.1677" class="difflineminus">-  format_out = 0;   // The format out type</span>
<a href="#l72.1678"></a><span id="l72.1678" class="difflineplus">+MimeDisplayOptions::MimeDisplayOptions() {</span>
<a href="#l72.1679"></a><span id="l72.1679" class="difflineplus">+  conv = nullptr;  // For text conversion...</span>
<a href="#l72.1680"></a><span id="l72.1680" class="difflineplus">+  format_out = 0;  // The format out type</span>
<a href="#l72.1681"></a><span id="l72.1681">   url = nullptr;</span>
<a href="#l72.1682"></a><span id="l72.1682"> </span>
<a href="#l72.1683"></a><span id="l72.1683" class="difflineminus">-  memset(&amp;headers,0, sizeof(headers));</span>
<a href="#l72.1684"></a><span id="l72.1684" class="difflineplus">+  memset(&amp;headers, 0, sizeof(headers));</span>
<a href="#l72.1685"></a><span id="l72.1685">   fancy_headers_p = false;</span>
<a href="#l72.1686"></a><span id="l72.1686"> </span>
<a href="#l72.1687"></a><span id="l72.1687">   output_vcard_buttons_p = false;</span>
<a href="#l72.1688"></a><span id="l72.1688"> </span>
<a href="#l72.1689"></a><span id="l72.1689">   variable_width_plaintext_p = false;</span>
<a href="#l72.1690"></a><span id="l72.1690">   wrap_long_lines_p = false;</span>
<a href="#l72.1691"></a><span id="l72.1691">   rot13_p = false;</span>
<a href="#l72.1692"></a><span id="l72.1692">   part_to_load = nullptr;</span>
<a href="#l72.1693"></a><span id="l72.1693"> </span>
<a href="#l72.1694"></a><span id="l72.1694">   no_output_p = false;</span>
<a href="#l72.1695"></a><span id="l72.1695">   write_html_p = false;</span>
<a href="#l72.1696"></a><span id="l72.1696"> </span>
<a href="#l72.1697"></a><span id="l72.1697">   decrypt_p = false;</span>
<a href="#l72.1698"></a><span id="l72.1698"> </span>
<a href="#l72.1699"></a><span id="l72.1699" class="difflineminus">-  whattodo = 0 ;</span>
<a href="#l72.1700"></a><span id="l72.1700" class="difflineplus">+  whattodo = 0;</span>
<a href="#l72.1701"></a><span id="l72.1701">   default_charset = nullptr;</span>
<a href="#l72.1702"></a><span id="l72.1702">   override_charset = false;</span>
<a href="#l72.1703"></a><span id="l72.1703">   force_user_charset = false;</span>
<a href="#l72.1704"></a><span id="l72.1704">   stream_closure = nullptr;</span>
<a href="#l72.1705"></a><span id="l72.1705"> </span>
<a href="#l72.1706"></a><span id="l72.1706">   /* For setting up the display stream, so that the MIME parser can inform</span>
<a href="#l72.1707"></a><span id="l72.1707">    the caller of the type of the data it will be getting. */</span>
<a href="#l72.1708"></a><span id="l72.1708">   output_init_fn = nullptr;</span>
<a href="#l72.1709"></a><span id="l72.1709" class="difflineat">@@ -1361,633 +1243,562 @@ MimeDisplayOptions::MimeDisplayOptions()</span>
<a href="#l72.1710"></a><span id="l72.1710">   show_attachment_inline_p = false;</span>
<a href="#l72.1711"></a><span id="l72.1711">   show_attachment_inline_text = false;</span>
<a href="#l72.1712"></a><span id="l72.1712">   quote_attachment_inline_p = false;</span>
<a href="#l72.1713"></a><span id="l72.1713">   notify_nested_bodies = false;</span>
<a href="#l72.1714"></a><span id="l72.1714">   write_pure_bodies = false;</span>
<a href="#l72.1715"></a><span id="l72.1715">   metadata_only = false;</span>
<a href="#l72.1716"></a><span id="l72.1716"> }</span>
<a href="#l72.1717"></a><span id="l72.1717"> </span>
<a href="#l72.1718"></a><span id="l72.1718" class="difflineminus">-MimeDisplayOptions::~MimeDisplayOptions()</span>
<a href="#l72.1719"></a><span id="l72.1719" class="difflineminus">-{</span>
<a href="#l72.1720"></a><span id="l72.1720" class="difflineplus">+MimeDisplayOptions::~MimeDisplayOptions() {</span>
<a href="#l72.1721"></a><span id="l72.1721">   PR_FREEIF(part_to_load);</span>
<a href="#l72.1722"></a><span id="l72.1722">   PR_FREEIF(default_charset);</span>
<a href="#l72.1723"></a><span id="l72.1723"> }</span>
<a href="#l72.1724"></a><span id="l72.1724"> ////////////////////////////////////////////////////////////////</span>
<a href="#l72.1725"></a><span id="l72.1725"> // Bridge routines for new stream converter XP-COM interface</span>
<a href="#l72.1726"></a><span id="l72.1726"> ////////////////////////////////////////////////////////////////</span>
<a href="#l72.1727"></a><span id="l72.1727" class="difflineminus">-extern &quot;C&quot; void  *</span>
<a href="#l72.1728"></a><span id="l72.1728" class="difflineminus">-mime_bridge_create_display_stream(</span>
<a href="#l72.1729"></a><span id="l72.1729" class="difflineminus">-                          nsIMimeEmitter      *newEmitter,</span>
<a href="#l72.1730"></a><span id="l72.1730" class="difflineminus">-                          nsStreamConverter   *newPluginObj2,</span>
<a href="#l72.1731"></a><span id="l72.1731" class="difflineminus">-                          nsIURI              *uri,</span>
<a href="#l72.1732"></a><span id="l72.1732" class="difflineminus">-                          nsMimeOutputType    format_out,</span>
<a href="#l72.1733"></a><span id="l72.1733" class="difflineminus">-                          uint32_t            whattodo,</span>
<a href="#l72.1734"></a><span id="l72.1734" class="difflineminus">-                          nsIChannel          *aChannel)</span>
<a href="#l72.1735"></a><span id="l72.1735" class="difflineminus">-{</span>
<a href="#l72.1736"></a><span id="l72.1736" class="difflineminus">-  int                       status = 0;</span>
<a href="#l72.1737"></a><span id="l72.1737" class="difflineminus">-  MimeObject                *obj;</span>
<a href="#l72.1738"></a><span id="l72.1738" class="difflineminus">-  mime_stream_data   *msd;</span>
<a href="#l72.1739"></a><span id="l72.1739" class="difflineminus">-  nsMIMESession             *stream = 0;</span>
<a href="#l72.1740"></a><span id="l72.1740" class="difflineplus">+extern &quot;C&quot; void *mime_bridge_create_display_stream(</span>
<a href="#l72.1741"></a><span id="l72.1741" class="difflineplus">+    nsIMimeEmitter *newEmitter, nsStreamConverter *newPluginObj2, nsIURI *uri,</span>
<a href="#l72.1742"></a><span id="l72.1742" class="difflineplus">+    nsMimeOutputType format_out, uint32_t whattodo, nsIChannel *aChannel) {</span>
<a href="#l72.1743"></a><span id="l72.1743" class="difflineplus">+  int status = 0;</span>
<a href="#l72.1744"></a><span id="l72.1744" class="difflineplus">+  MimeObject *obj;</span>
<a href="#l72.1745"></a><span id="l72.1745" class="difflineplus">+  mime_stream_data *msd;</span>
<a href="#l72.1746"></a><span id="l72.1746" class="difflineplus">+  nsMIMESession *stream = 0;</span>
<a href="#l72.1747"></a><span id="l72.1747"> </span>
<a href="#l72.1748"></a><span id="l72.1748" class="difflineminus">-  if (!uri)</span>
<a href="#l72.1749"></a><span id="l72.1749" class="difflineminus">-    return nullptr;</span>
<a href="#l72.1750"></a><span id="l72.1750" class="difflineplus">+  if (!uri) return nullptr;</span>
<a href="#l72.1751"></a><span id="l72.1751"> </span>
<a href="#l72.1752"></a><span id="l72.1752">   msd = new mime_stream_data;</span>
<a href="#l72.1753"></a><span id="l72.1753" class="difflineminus">-  if (!msd)</span>
<a href="#l72.1754"></a><span id="l72.1754" class="difflineminus">-    return NULL;</span>
<a href="#l72.1755"></a><span id="l72.1755" class="difflineplus">+  if (!msd) return NULL;</span>
<a href="#l72.1756"></a><span id="l72.1756"> </span>
<a href="#l72.1757"></a><span id="l72.1757">   // Assign the new mime emitter - will handle output operations</span>
<a href="#l72.1758"></a><span id="l72.1758">   msd-&gt;output_emitter = newEmitter;</span>
<a href="#l72.1759"></a><span id="l72.1759">   msd-&gt;firstCheck = true;</span>
<a href="#l72.1760"></a><span id="l72.1760"> </span>
<a href="#l72.1761"></a><span id="l72.1761">   // Store the URL string for this decode operation</span>
<a href="#l72.1762"></a><span id="l72.1762">   nsAutoCString urlString;</span>
<a href="#l72.1763"></a><span id="l72.1763">   nsresult rv;</span>
<a href="#l72.1764"></a><span id="l72.1764"> </span>
<a href="#l72.1765"></a><span id="l72.1765">   // Keep a hold of the channel...</span>
<a href="#l72.1766"></a><span id="l72.1766">   msd-&gt;channel = aChannel;</span>
<a href="#l72.1767"></a><span id="l72.1767">   rv = uri-&gt;GetSpec(urlString);</span>
<a href="#l72.1768"></a><span id="l72.1768" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l72.1769"></a><span id="l72.1769" class="difflineminus">-  {</span>
<a href="#l72.1770"></a><span id="l72.1770" class="difflineminus">-    if (!urlString.IsEmpty())</span>
<a href="#l72.1771"></a><span id="l72.1771" class="difflineminus">-    {</span>
<a href="#l72.1772"></a><span id="l72.1772" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l72.1773"></a><span id="l72.1773" class="difflineplus">+    if (!urlString.IsEmpty()) {</span>
<a href="#l72.1774"></a><span id="l72.1774">       msd-&gt;url_name = ToNewCString(urlString);</span>
<a href="#l72.1775"></a><span id="l72.1775" class="difflineminus">-      if (!(msd-&gt;url_name))</span>
<a href="#l72.1776"></a><span id="l72.1776" class="difflineminus">-      {</span>
<a href="#l72.1777"></a><span id="l72.1777" class="difflineplus">+      if (!(msd-&gt;url_name)) {</span>
<a href="#l72.1778"></a><span id="l72.1778">         delete msd;</span>
<a href="#l72.1779"></a><span id="l72.1779">         return NULL;</span>
<a href="#l72.1780"></a><span id="l72.1780">       }</span>
<a href="#l72.1781"></a><span id="l72.1781">       nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(uri);</span>
<a href="#l72.1782"></a><span id="l72.1782" class="difflineminus">-      if (msgUrl)</span>
<a href="#l72.1783"></a><span id="l72.1783" class="difflineminus">-          msgUrl-&gt;GetOriginalSpec(&amp;msd-&gt;orig_url_name);</span>
<a href="#l72.1784"></a><span id="l72.1784" class="difflineplus">+      if (msgUrl) msgUrl-&gt;GetOriginalSpec(&amp;msd-&gt;orig_url_name);</span>
<a href="#l72.1785"></a><span id="l72.1785">     }</span>
<a href="#l72.1786"></a><span id="l72.1786">   }</span>
<a href="#l72.1787"></a><span id="l72.1787"> </span>
<a href="#l72.1788"></a><span id="l72.1788" class="difflineminus">-  msd-&gt;format_out = format_out;       // output format</span>
<a href="#l72.1789"></a><span id="l72.1789" class="difflineminus">-  msd-&gt;pluginObj2 = newPluginObj2;    // the plugin object pointer</span>
<a href="#l72.1790"></a><span id="l72.1790" class="difflineplus">+  msd-&gt;format_out = format_out;     // output format</span>
<a href="#l72.1791"></a><span id="l72.1791" class="difflineplus">+  msd-&gt;pluginObj2 = newPluginObj2;  // the plugin object pointer</span>
<a href="#l72.1792"></a><span id="l72.1792"> </span>
<a href="#l72.1793"></a><span id="l72.1793">   msd-&gt;options = new MimeDisplayOptions;</span>
<a href="#l72.1794"></a><span id="l72.1794" class="difflineminus">-  if (!msd-&gt;options)</span>
<a href="#l72.1795"></a><span id="l72.1795" class="difflineminus">-  {</span>
<a href="#l72.1796"></a><span id="l72.1796" class="difflineplus">+  if (!msd-&gt;options) {</span>
<a href="#l72.1797"></a><span id="l72.1797">     delete msd;</span>
<a href="#l72.1798"></a><span id="l72.1798">     return 0;</span>
<a href="#l72.1799"></a><span id="l72.1799">   }</span>
<a href="#l72.1800"></a><span id="l72.1800" class="difflineminus">-//  memset(msd-&gt;options, 0, sizeof(*msd-&gt;options));</span>
<a href="#l72.1801"></a><span id="l72.1801" class="difflineminus">-  msd-&gt;options-&gt;format_out = format_out;     // output format</span>
<a href="#l72.1802"></a><span id="l72.1802" class="difflineplus">+  //  memset(msd-&gt;options, 0, sizeof(*msd-&gt;options));</span>
<a href="#l72.1803"></a><span id="l72.1803" class="difflineplus">+  msd-&gt;options-&gt;format_out = format_out;  // output format</span>
<a href="#l72.1804"></a><span id="l72.1804"> </span>
<a href="#l72.1805"></a><span id="l72.1805">   msd-&gt;options-&gt;m_prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l72.1806"></a><span id="l72.1806" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l72.1807"></a><span id="l72.1807" class="difflineminus">-  {</span>
<a href="#l72.1808"></a><span id="l72.1808" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l72.1809"></a><span id="l72.1809">     delete msd;</span>
<a href="#l72.1810"></a><span id="l72.1810">     return nullptr;</span>
<a href="#l72.1811"></a><span id="l72.1811">   }</span>
<a href="#l72.1812"></a><span id="l72.1812"> </span>
<a href="#l72.1813"></a><span id="l72.1813">   // Need the text converter...</span>
<a href="#l72.1814"></a><span id="l72.1814">   rv = CallCreateInstance(MOZ_TXTTOHTMLCONV_CONTRACTID, &amp;(msd-&gt;options-&gt;conv));</span>
<a href="#l72.1815"></a><span id="l72.1815" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l72.1816"></a><span id="l72.1816" class="difflineminus">-  {</span>
<a href="#l72.1817"></a><span id="l72.1817" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l72.1818"></a><span id="l72.1818">     msd-&gt;options-&gt;m_prefBranch = nullptr;</span>
<a href="#l72.1819"></a><span id="l72.1819">     delete msd;</span>
<a href="#l72.1820"></a><span id="l72.1820">     return nullptr;</span>
<a href="#l72.1821"></a><span id="l72.1821">   }</span>
<a href="#l72.1822"></a><span id="l72.1822"> </span>
<a href="#l72.1823"></a><span id="l72.1823">   //</span>
<a href="#l72.1824"></a><span id="l72.1824">   // Set the defaults, based on the context, and the output-type.</span>
<a href="#l72.1825"></a><span id="l72.1825">   //</span>
<a href="#l72.1826"></a><span id="l72.1826">   MIME_HeaderType = MimeHeadersAll;</span>
<a href="#l72.1827"></a><span id="l72.1827">   msd-&gt;options-&gt;write_html_p = true;</span>
<a href="#l72.1828"></a><span id="l72.1828" class="difflineminus">-  switch (format_out)</span>
<a href="#l72.1829"></a><span id="l72.1829" class="difflineminus">-  {</span>
<a href="#l72.1830"></a><span id="l72.1830" class="difflineminus">-    case nsMimeOutput::nsMimeMessageSplitDisplay:   // the wrapper HTML output to produce the split header/body display</span>
<a href="#l72.1831"></a><span id="l72.1831" class="difflineminus">-    case nsMimeOutput::nsMimeMessageHeaderDisplay:  // the split header/body display</span>
<a href="#l72.1832"></a><span id="l72.1832" class="difflineminus">-    case nsMimeOutput::nsMimeMessageBodyDisplay:    // the split header/body display</span>
<a href="#l72.1833"></a><span id="l72.1833" class="difflineplus">+  switch (format_out) {</span>
<a href="#l72.1834"></a><span id="l72.1834" class="difflineplus">+    case nsMimeOutput::nsMimeMessageSplitDisplay:  // the wrapper HTML output to</span>
<a href="#l72.1835"></a><span id="l72.1835" class="difflineplus">+                                                   // produce the split</span>
<a href="#l72.1836"></a><span id="l72.1836" class="difflineplus">+                                                   // header/body display</span>
<a href="#l72.1837"></a><span id="l72.1837" class="difflineplus">+    case nsMimeOutput::nsMimeMessageHeaderDisplay:  // the split header/body</span>
<a href="#l72.1838"></a><span id="l72.1838" class="difflineplus">+                                                    // display</span>
<a href="#l72.1839"></a><span id="l72.1839" class="difflineplus">+    case nsMimeOutput::nsMimeMessageBodyDisplay:    // the split header/body</span>
<a href="#l72.1840"></a><span id="l72.1840" class="difflineplus">+                                                    // display</span>
<a href="#l72.1841"></a><span id="l72.1841">       msd-&gt;options-&gt;fancy_headers_p = true;</span>
<a href="#l72.1842"></a><span id="l72.1842">       msd-&gt;options-&gt;output_vcard_buttons_p = true;</span>
<a href="#l72.1843"></a><span id="l72.1843">       break;</span>
<a href="#l72.1844"></a><span id="l72.1844"> </span>
<a href="#l72.1845"></a><span id="l72.1845" class="difflineminus">-    case nsMimeOutput::nsMimeMessageSaveAs:         // Save As operations</span>
<a href="#l72.1846"></a><span id="l72.1846" class="difflineminus">-    case nsMimeOutput::nsMimeMessageQuoting:        // all HTML quoted/printed output</span>
<a href="#l72.1847"></a><span id="l72.1847" class="difflineplus">+    case nsMimeOutput::nsMimeMessageSaveAs:   // Save As operations</span>
<a href="#l72.1848"></a><span id="l72.1848" class="difflineplus">+    case nsMimeOutput::nsMimeMessageQuoting:  // all HTML quoted/printed output</span>
<a href="#l72.1849"></a><span id="l72.1849">     case nsMimeOutput::nsMimeMessagePrintOutput:</span>
<a href="#l72.1850"></a><span id="l72.1850">       msd-&gt;options-&gt;fancy_headers_p = true;</span>
<a href="#l72.1851"></a><span id="l72.1851">       break;</span>
<a href="#l72.1852"></a><span id="l72.1852"> </span>
<a href="#l72.1853"></a><span id="l72.1853" class="difflineminus">-    case nsMimeOutput::nsMimeMessageBodyQuoting:        // only HTML body quoted output</span>
<a href="#l72.1854"></a><span id="l72.1854" class="difflineplus">+    case nsMimeOutput::nsMimeMessageBodyQuoting:  // only HTML body quoted</span>
<a href="#l72.1855"></a><span id="l72.1855" class="difflineplus">+                                                  // output</span>
<a href="#l72.1856"></a><span id="l72.1856">       MIME_HeaderType = MimeHeadersNone;</span>
<a href="#l72.1857"></a><span id="l72.1857">       break;</span>
<a href="#l72.1858"></a><span id="l72.1858"> </span>
<a href="#l72.1859"></a><span id="l72.1859" class="difflineminus">-    case nsMimeOutput::nsMimeMessageAttach:           // handling attachment storage</span>
<a href="#l72.1860"></a><span id="l72.1860" class="difflineminus">-        msd-&gt;options-&gt;write_html_p = false;</span>
<a href="#l72.1861"></a><span id="l72.1861" class="difflineminus">-        break;</span>
<a href="#l72.1862"></a><span id="l72.1862" class="difflineminus">-    case nsMimeOutput::nsMimeMessageRaw:              // the raw RFC822 data (view source) and attachments</span>
<a href="#l72.1863"></a><span id="l72.1863" class="difflineminus">-    case nsMimeOutput::nsMimeMessageDraftOrTemplate:  // Loading drafts &amp; templates</span>
<a href="#l72.1864"></a><span id="l72.1864" class="difflineminus">-    case nsMimeOutput::nsMimeMessageEditorTemplate:   // Loading templates into editor</span>
<a href="#l72.1865"></a><span id="l72.1865" class="difflineminus">-    case nsMimeOutput::nsMimeMessageFilterSniffer:    // generating an output that can be scan by a message filter</span>
<a href="#l72.1866"></a><span id="l72.1866" class="difflineplus">+    case nsMimeOutput::nsMimeMessageAttach:  // handling attachment storage</span>
<a href="#l72.1867"></a><span id="l72.1867" class="difflineplus">+      msd-&gt;options-&gt;write_html_p = false;</span>
<a href="#l72.1868"></a><span id="l72.1868" class="difflineplus">+      break;</span>
<a href="#l72.1869"></a><span id="l72.1869" class="difflineplus">+    case nsMimeOutput::nsMimeMessageRaw:  // the raw RFC822 data (view source)</span>
<a href="#l72.1870"></a><span id="l72.1870" class="difflineplus">+                                          // and attachments</span>
<a href="#l72.1871"></a><span id="l72.1871" class="difflineplus">+    case nsMimeOutput::nsMimeMessageDraftOrTemplate:  // Loading drafts &amp;</span>
<a href="#l72.1872"></a><span id="l72.1872" class="difflineplus">+                                                      // templates</span>
<a href="#l72.1873"></a><span id="l72.1873" class="difflineplus">+    case nsMimeOutput::nsMimeMessageEditorTemplate:   // Loading templates into</span>
<a href="#l72.1874"></a><span id="l72.1874" class="difflineplus">+                                                      // editor</span>
<a href="#l72.1875"></a><span id="l72.1875" class="difflineplus">+    case nsMimeOutput::nsMimeMessageFilterSniffer:  // generating an output that</span>
<a href="#l72.1876"></a><span id="l72.1876" class="difflineplus">+                                                    // can be scan by a message</span>
<a href="#l72.1877"></a><span id="l72.1877" class="difflineplus">+                                                    // filter</span>
<a href="#l72.1878"></a><span id="l72.1878">       break;</span>
<a href="#l72.1879"></a><span id="l72.1879"> </span>
<a href="#l72.1880"></a><span id="l72.1880">     case nsMimeOutput::nsMimeMessageDecrypt:</span>
<a href="#l72.1881"></a><span id="l72.1881">       msd-&gt;options-&gt;decrypt_p = true;</span>
<a href="#l72.1882"></a><span id="l72.1882">       msd-&gt;options-&gt;write_html_p = false;</span>
<a href="#l72.1883"></a><span id="l72.1883">       break;</span>
<a href="#l72.1884"></a><span id="l72.1884">   }</span>
<a href="#l72.1885"></a><span id="l72.1885"> </span>
<a href="#l72.1886"></a><span id="l72.1886">   ////////////////////////////////////////////////////////////</span>
<a href="#l72.1887"></a><span id="l72.1887">   // Now, get the libmime prefs...</span>
<a href="#l72.1888"></a><span id="l72.1888">   ////////////////////////////////////////////////////////////</span>
<a href="#l72.1889"></a><span id="l72.1889"> </span>
<a href="#l72.1890"></a><span id="l72.1890">   MIME_WrapLongLines = true;</span>
<a href="#l72.1891"></a><span id="l72.1891">   MIME_VariableWidthPlaintext = true;</span>
<a href="#l72.1892"></a><span id="l72.1892">   msd-&gt;options-&gt;force_user_charset = false;</span>
<a href="#l72.1893"></a><span id="l72.1893"> </span>
<a href="#l72.1894"></a><span id="l72.1894" class="difflineminus">-  if (msd-&gt;options-&gt;m_prefBranch)</span>
<a href="#l72.1895"></a><span id="l72.1895" class="difflineminus">-  {</span>
<a href="#l72.1896"></a><span id="l72.1896" class="difflineminus">-    msd-&gt;options-&gt;m_prefBranch-&gt;GetBoolPref(&quot;mail.wrap_long_lines&quot;, &amp;MIME_WrapLongLines);</span>
<a href="#l72.1897"></a><span id="l72.1897" class="difflineminus">-    msd-&gt;options-&gt;m_prefBranch-&gt;GetBoolPref(&quot;mail.fixed_width_messages&quot;, &amp;MIME_VariableWidthPlaintext);</span>
<a href="#l72.1898"></a><span id="l72.1898" class="difflineminus">-      //</span>
<a href="#l72.1899"></a><span id="l72.1899" class="difflineminus">-      // Charset overrides takes place here</span>
<a href="#l72.1900"></a><span id="l72.1900" class="difflineminus">-      //</span>
<a href="#l72.1901"></a><span id="l72.1901" class="difflineminus">-      // We have a bool pref (mail.force_user_charset) to deal with attachments.</span>
<a href="#l72.1902"></a><span id="l72.1902" class="difflineminus">-      // 1) If true - libmime does NO conversion and just passes it through to raptor</span>
<a href="#l72.1903"></a><span id="l72.1903" class="difflineminus">-      // 2) If false, then we try to use the charset of the part and if not available,</span>
<a href="#l72.1904"></a><span id="l72.1904" class="difflineminus">-      //    the charset of the root message</span>
<a href="#l72.1905"></a><span id="l72.1905" class="difflineminus">-      //</span>
<a href="#l72.1906"></a><span id="l72.1906" class="difflineminus">-    msd-&gt;options-&gt;m_prefBranch-&gt;GetBoolPref(&quot;mail.force_user_charset&quot;, &amp;(msd-&gt;options-&gt;force_user_charset));</span>
<a href="#l72.1907"></a><span id="l72.1907" class="difflineminus">-    msd-&gt;options-&gt;m_prefBranch-&gt;GetBoolPref(&quot;mail.inline_attachments&quot;, &amp;(msd-&gt;options-&gt;show_attachment_inline_p));</span>
<a href="#l72.1908"></a><span id="l72.1908" class="difflineminus">-    msd-&gt;options-&gt;m_prefBranch-&gt;GetBoolPref(&quot;mail.inline_attachments.text&quot;, &amp;(msd-&gt;options-&gt;show_attachment_inline_text));</span>
<a href="#l72.1909"></a><span id="l72.1909" class="difflineminus">-    msd-&gt;options-&gt;m_prefBranch-&gt;GetBoolPref(&quot;mail.reply_quote_inline&quot;, &amp;(msd-&gt;options-&gt;quote_attachment_inline_p));</span>
<a href="#l72.1910"></a><span id="l72.1910" class="difflineminus">-    msd-&gt;options-&gt;m_prefBranch-&gt;GetIntPref(&quot;mailnews.display.html_as&quot;, &amp;(msd-&gt;options-&gt;html_as_p));</span>
<a href="#l72.1911"></a><span id="l72.1911" class="difflineplus">+  if (msd-&gt;options-&gt;m_prefBranch) {</span>
<a href="#l72.1912"></a><span id="l72.1912" class="difflineplus">+    msd-&gt;options-&gt;m_prefBranch-&gt;GetBoolPref(&quot;mail.wrap_long_lines&quot;,</span>
<a href="#l72.1913"></a><span id="l72.1913" class="difflineplus">+                                            &amp;MIME_WrapLongLines);</span>
<a href="#l72.1914"></a><span id="l72.1914" class="difflineplus">+    msd-&gt;options-&gt;m_prefBranch-&gt;GetBoolPref(&quot;mail.fixed_width_messages&quot;,</span>
<a href="#l72.1915"></a><span id="l72.1915" class="difflineplus">+                                            &amp;MIME_VariableWidthPlaintext);</span>
<a href="#l72.1916"></a><span id="l72.1916" class="difflineplus">+    //</span>
<a href="#l72.1917"></a><span id="l72.1917" class="difflineplus">+    // Charset overrides takes place here</span>
<a href="#l72.1918"></a><span id="l72.1918" class="difflineplus">+    //</span>
<a href="#l72.1919"></a><span id="l72.1919" class="difflineplus">+    // We have a bool pref (mail.force_user_charset) to deal with attachments.</span>
<a href="#l72.1920"></a><span id="l72.1920" class="difflineplus">+    // 1) If true - libmime does NO conversion and just passes it through to</span>
<a href="#l72.1921"></a><span id="l72.1921" class="difflineplus">+    // raptor 2) If false, then we try to use the charset of the part and if not</span>
<a href="#l72.1922"></a><span id="l72.1922" class="difflineplus">+    // available,</span>
<a href="#l72.1923"></a><span id="l72.1923" class="difflineplus">+    //    the charset of the root message</span>
<a href="#l72.1924"></a><span id="l72.1924" class="difflineplus">+    //</span>
<a href="#l72.1925"></a><span id="l72.1925" class="difflineplus">+    msd-&gt;options-&gt;m_prefBranch-&gt;GetBoolPref(</span>
<a href="#l72.1926"></a><span id="l72.1926" class="difflineplus">+        &quot;mail.force_user_charset&quot;, &amp;(msd-&gt;options-&gt;force_user_charset));</span>
<a href="#l72.1927"></a><span id="l72.1927" class="difflineplus">+    msd-&gt;options-&gt;m_prefBranch-&gt;GetBoolPref(</span>
<a href="#l72.1928"></a><span id="l72.1928" class="difflineplus">+        &quot;mail.inline_attachments&quot;, &amp;(msd-&gt;options-&gt;show_attachment_inline_p));</span>
<a href="#l72.1929"></a><span id="l72.1929" class="difflineplus">+    msd-&gt;options-&gt;m_prefBranch-&gt;GetBoolPref(</span>
<a href="#l72.1930"></a><span id="l72.1930" class="difflineplus">+        &quot;mail.inline_attachments.text&quot;,</span>
<a href="#l72.1931"></a><span id="l72.1931" class="difflineplus">+        &amp;(msd-&gt;options-&gt;show_attachment_inline_text));</span>
<a href="#l72.1932"></a><span id="l72.1932" class="difflineplus">+    msd-&gt;options-&gt;m_prefBranch-&gt;GetBoolPref(</span>
<a href="#l72.1933"></a><span id="l72.1933" class="difflineplus">+        &quot;mail.reply_quote_inline&quot;, &amp;(msd-&gt;options-&gt;quote_attachment_inline_p));</span>
<a href="#l72.1934"></a><span id="l72.1934" class="difflineplus">+    msd-&gt;options-&gt;m_prefBranch-&gt;GetIntPref(&quot;mailnews.display.html_as&quot;,</span>
<a href="#l72.1935"></a><span id="l72.1935" class="difflineplus">+                                           &amp;(msd-&gt;options-&gt;html_as_p));</span>
<a href="#l72.1936"></a><span id="l72.1936">   }</span>
<a href="#l72.1937"></a><span id="l72.1937">   /* This pref is written down in with the</span>
<a href="#l72.1938"></a><span id="l72.1938">      opposite sense of what we like to use... */</span>
<a href="#l72.1939"></a><span id="l72.1939">   MIME_VariableWidthPlaintext = !MIME_VariableWidthPlaintext;</span>
<a href="#l72.1940"></a><span id="l72.1940"> </span>
<a href="#l72.1941"></a><span id="l72.1941">   msd-&gt;options-&gt;wrap_long_lines_p = MIME_WrapLongLines;</span>
<a href="#l72.1942"></a><span id="l72.1942">   msd-&gt;options-&gt;headers = MIME_HeaderType;</span>
<a href="#l72.1943"></a><span id="l72.1943"> </span>
<a href="#l72.1944"></a><span id="l72.1944">   // We need to have the URL to be able to support the various</span>
<a href="#l72.1945"></a><span id="l72.1945">   // arguments</span>
<a href="#l72.1946"></a><span id="l72.1946">   status = mime_parse_url_options(msd-&gt;url_name, msd-&gt;options);</span>
<a href="#l72.1947"></a><span id="l72.1947" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l72.1948"></a><span id="l72.1948" class="difflineminus">-  {</span>
<a href="#l72.1949"></a><span id="l72.1949" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l72.1950"></a><span id="l72.1950">     PR_FREEIF(msd-&gt;options-&gt;part_to_load);</span>
<a href="#l72.1951"></a><span id="l72.1951">     PR_Free(msd-&gt;options);</span>
<a href="#l72.1952"></a><span id="l72.1952">     delete msd;</span>
<a href="#l72.1953"></a><span id="l72.1953">     return 0;</span>
<a href="#l72.1954"></a><span id="l72.1954">   }</span>
<a href="#l72.1955"></a><span id="l72.1955"> </span>
<a href="#l72.1956"></a><span id="l72.1956">   if (msd-&gt;options-&gt;headers == MimeHeadersMicro &amp;&amp;</span>
<a href="#l72.1957"></a><span id="l72.1957" class="difflineminus">-     (msd-&gt;url_name == NULL || (strncmp(msd-&gt;url_name, &quot;news:&quot;, 5) != 0 &amp;&amp;</span>
<a href="#l72.1958"></a><span id="l72.1958" class="difflineminus">-              strncmp(msd-&gt;url_name, &quot;snews:&quot;, 6) != 0)) )</span>
<a href="#l72.1959"></a><span id="l72.1959" class="difflineplus">+      (msd-&gt;url_name == NULL || (strncmp(msd-&gt;url_name, &quot;news:&quot;, 5) != 0 &amp;&amp;</span>
<a href="#l72.1960"></a><span id="l72.1960" class="difflineplus">+                                 strncmp(msd-&gt;url_name, &quot;snews:&quot;, 6) != 0)))</span>
<a href="#l72.1961"></a><span id="l72.1961">     msd-&gt;options-&gt;headers = MimeHeadersMicroPlus;</span>
<a href="#l72.1962"></a><span id="l72.1962"> </span>
<a href="#l72.1963"></a><span id="l72.1963">   msd-&gt;options-&gt;url = msd-&gt;url_name;</span>
<a href="#l72.1964"></a><span id="l72.1964" class="difflineminus">-  msd-&gt;options-&gt;output_init_fn        = mime_output_init_fn;</span>
<a href="#l72.1965"></a><span id="l72.1965" class="difflineplus">+  msd-&gt;options-&gt;output_init_fn = mime_output_init_fn;</span>
<a href="#l72.1966"></a><span id="l72.1966"> </span>
<a href="#l72.1967"></a><span id="l72.1967" class="difflineminus">-  msd-&gt;options-&gt;output_fn             = mime_output_fn;</span>
<a href="#l72.1968"></a><span id="l72.1968" class="difflineplus">+  msd-&gt;options-&gt;output_fn = mime_output_fn;</span>
<a href="#l72.1969"></a><span id="l72.1969"> </span>
<a href="#l72.1970"></a><span id="l72.1970" class="difflineminus">-  msd-&gt;options-&gt;whattodo              = whattodo;</span>
<a href="#l72.1971"></a><span id="l72.1971" class="difflineplus">+  msd-&gt;options-&gt;whattodo = whattodo;</span>
<a href="#l72.1972"></a><span id="l72.1972">   msd-&gt;options-&gt;charset_conversion_fn = mime_convert_charset;</span>
<a href="#l72.1973"></a><span id="l72.1973" class="difflineminus">-  msd-&gt;options-&gt;rfc1522_conversion_p  = true;</span>
<a href="#l72.1974"></a><span id="l72.1974" class="difflineminus">-  msd-&gt;options-&gt;file_type_fn          = mime_file_type;</span>
<a href="#l72.1975"></a><span id="l72.1975" class="difflineminus">-  msd-&gt;options-&gt;stream_closure        = msd;</span>
<a href="#l72.1976"></a><span id="l72.1976" class="difflineminus">-  msd-&gt;options-&gt;passwd_prompt_fn      = 0;</span>
<a href="#l72.1977"></a><span id="l72.1977" class="difflineplus">+  msd-&gt;options-&gt;rfc1522_conversion_p = true;</span>
<a href="#l72.1978"></a><span id="l72.1978" class="difflineplus">+  msd-&gt;options-&gt;file_type_fn = mime_file_type;</span>
<a href="#l72.1979"></a><span id="l72.1979" class="difflineplus">+  msd-&gt;options-&gt;stream_closure = msd;</span>
<a href="#l72.1980"></a><span id="l72.1980" class="difflineplus">+  msd-&gt;options-&gt;passwd_prompt_fn = 0;</span>
<a href="#l72.1981"></a><span id="l72.1981"> </span>
<a href="#l72.1982"></a><span id="l72.1982" class="difflineminus">-  msd-&gt;options-&gt;image_begin           = mime_image_begin;</span>
<a href="#l72.1983"></a><span id="l72.1983" class="difflineminus">-  msd-&gt;options-&gt;image_end             = mime_image_end;</span>
<a href="#l72.1984"></a><span id="l72.1984" class="difflineminus">-  msd-&gt;options-&gt;make_image_html       = mime_image_make_image_html;</span>
<a href="#l72.1985"></a><span id="l72.1985" class="difflineminus">-  msd-&gt;options-&gt;image_write_buffer    = mime_image_write_buffer;</span>
<a href="#l72.1986"></a><span id="l72.1986" class="difflineplus">+  msd-&gt;options-&gt;image_begin = mime_image_begin;</span>
<a href="#l72.1987"></a><span id="l72.1987" class="difflineplus">+  msd-&gt;options-&gt;image_end = mime_image_end;</span>
<a href="#l72.1988"></a><span id="l72.1988" class="difflineplus">+  msd-&gt;options-&gt;make_image_html = mime_image_make_image_html;</span>
<a href="#l72.1989"></a><span id="l72.1989" class="difflineplus">+  msd-&gt;options-&gt;image_write_buffer = mime_image_write_buffer;</span>
<a href="#l72.1990"></a><span id="l72.1990"> </span>
<a href="#l72.1991"></a><span id="l72.1991">   msd-&gt;options-&gt;variable_width_plaintext_p = MIME_VariableWidthPlaintext;</span>
<a href="#l72.1992"></a><span id="l72.1992"> </span>
<a href="#l72.1993"></a><span id="l72.1993">   // If this is a part, then we should emit the HTML to render the data</span>
<a href="#l72.1994"></a><span id="l72.1994">   // (i.e. embedded images)</span>
<a href="#l72.1995"></a><span id="l72.1995" class="difflineminus">-  if (msd-&gt;options-&gt;part_to_load &amp;&amp; msd-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageBodyDisplay)</span>
<a href="#l72.1996"></a><span id="l72.1996" class="difflineplus">+  if (msd-&gt;options-&gt;part_to_load &amp;&amp;</span>
<a href="#l72.1997"></a><span id="l72.1997" class="difflineplus">+      msd-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageBodyDisplay)</span>
<a href="#l72.1998"></a><span id="l72.1998">     msd-&gt;options-&gt;write_html_p = false;</span>
<a href="#l72.1999"></a><span id="l72.1999"> </span>
<a href="#l72.2000"></a><span id="l72.2000" class="difflineminus">-  obj = mime_new ((MimeObjectClass *)&amp;mimeMessageClass, (MimeHeaders *) NULL, MESSAGE_RFC822);</span>
<a href="#l72.2001"></a><span id="l72.2001" class="difflineminus">-  if (!obj)</span>
<a href="#l72.2002"></a><span id="l72.2002" class="difflineminus">-  {</span>
<a href="#l72.2003"></a><span id="l72.2003" class="difflineplus">+  obj = mime_new((MimeObjectClass *)&amp;mimeMessageClass, (MimeHeaders *)NULL,</span>
<a href="#l72.2004"></a><span id="l72.2004" class="difflineplus">+                 MESSAGE_RFC822);</span>
<a href="#l72.2005"></a><span id="l72.2005" class="difflineplus">+  if (!obj) {</span>
<a href="#l72.2006"></a><span id="l72.2006">     delete msd-&gt;options;</span>
<a href="#l72.2007"></a><span id="l72.2007">     delete msd;</span>
<a href="#l72.2008"></a><span id="l72.2008">     return 0;</span>
<a href="#l72.2009"></a><span id="l72.2009">   }</span>
<a href="#l72.2010"></a><span id="l72.2010"> </span>
<a href="#l72.2011"></a><span id="l72.2011">   obj-&gt;options = msd-&gt;options;</span>
<a href="#l72.2012"></a><span id="l72.2012">   msd-&gt;obj = obj;</span>
<a href="#l72.2013"></a><span id="l72.2013"> </span>
<a href="#l72.2014"></a><span id="l72.2014">   /* Both of these better not be true at the same time. */</span>
<a href="#l72.2015"></a><span id="l72.2015" class="difflineminus">-  PR_ASSERT(! (obj-&gt;options-&gt;decrypt_p &amp;&amp; obj-&gt;options-&gt;write_html_p));</span>
<a href="#l72.2016"></a><span id="l72.2016" class="difflineplus">+  PR_ASSERT(!(obj-&gt;options-&gt;decrypt_p &amp;&amp; obj-&gt;options-&gt;write_html_p));</span>
<a href="#l72.2017"></a><span id="l72.2017"> </span>
<a href="#l72.2018"></a><span id="l72.2018">   stream = PR_NEW(nsMIMESession);</span>
<a href="#l72.2019"></a><span id="l72.2019" class="difflineminus">-  if (!stream)</span>
<a href="#l72.2020"></a><span id="l72.2020" class="difflineminus">-  {</span>
<a href="#l72.2021"></a><span id="l72.2021" class="difflineplus">+  if (!stream) {</span>
<a href="#l72.2022"></a><span id="l72.2022">     delete msd-&gt;options;</span>
<a href="#l72.2023"></a><span id="l72.2023">     delete msd;</span>
<a href="#l72.2024"></a><span id="l72.2024">     PR_Free(obj);</span>
<a href="#l72.2025"></a><span id="l72.2025">     return 0;</span>
<a href="#l72.2026"></a><span id="l72.2026">   }</span>
<a href="#l72.2027"></a><span id="l72.2027"> </span>
<a href="#l72.2028"></a><span id="l72.2028">   ResetMsgHeaderSinkProps(uri);</span>
<a href="#l72.2029"></a><span id="l72.2029"> </span>
<a href="#l72.2030"></a><span id="l72.2030" class="difflineminus">-  memset (stream, 0, sizeof (*stream));</span>
<a href="#l72.2031"></a><span id="l72.2031" class="difflineminus">-  stream-&gt;name           = &quot;MIME Conversion Stream&quot;;</span>
<a href="#l72.2032"></a><span id="l72.2032" class="difflineminus">-  stream-&gt;complete       = mime_display_stream_complete;</span>
<a href="#l72.2033"></a><span id="l72.2033" class="difflineminus">-  stream-&gt;abort          = mime_display_stream_abort;</span>
<a href="#l72.2034"></a><span id="l72.2034" class="difflineminus">-  stream-&gt;put_block      = mime_display_stream_write;</span>
<a href="#l72.2035"></a><span id="l72.2035" class="difflineminus">-  stream-&gt;data_object    = msd;</span>
<a href="#l72.2036"></a><span id="l72.2036" class="difflineplus">+  memset(stream, 0, sizeof(*stream));</span>
<a href="#l72.2037"></a><span id="l72.2037" class="difflineplus">+  stream-&gt;name = &quot;MIME Conversion Stream&quot;;</span>
<a href="#l72.2038"></a><span id="l72.2038" class="difflineplus">+  stream-&gt;complete = mime_display_stream_complete;</span>
<a href="#l72.2039"></a><span id="l72.2039" class="difflineplus">+  stream-&gt;abort = mime_display_stream_abort;</span>
<a href="#l72.2040"></a><span id="l72.2040" class="difflineplus">+  stream-&gt;put_block = mime_display_stream_write;</span>
<a href="#l72.2041"></a><span id="l72.2041" class="difflineplus">+  stream-&gt;data_object = msd;</span>
<a href="#l72.2042"></a><span id="l72.2042"> </span>
<a href="#l72.2043"></a><span id="l72.2043">   status = obj-&gt;clazz-&gt;initialize(obj);</span>
<a href="#l72.2044"></a><span id="l72.2044" class="difflineminus">-  if (status &gt;= 0)</span>
<a href="#l72.2045"></a><span id="l72.2045" class="difflineminus">-    status = obj-&gt;clazz-&gt;parse_begin(obj);</span>
<a href="#l72.2046"></a><span id="l72.2046" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l72.2047"></a><span id="l72.2047" class="difflineminus">-  {</span>
<a href="#l72.2048"></a><span id="l72.2048" class="difflineplus">+  if (status &gt;= 0) status = obj-&gt;clazz-&gt;parse_begin(obj);</span>
<a href="#l72.2049"></a><span id="l72.2049" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l72.2050"></a><span id="l72.2050">     PR_Free(stream);</span>
<a href="#l72.2051"></a><span id="l72.2051">     delete msd-&gt;options;</span>
<a href="#l72.2052"></a><span id="l72.2052">     delete msd;</span>
<a href="#l72.2053"></a><span id="l72.2053">     PR_Free(obj);</span>
<a href="#l72.2054"></a><span id="l72.2054">     return 0;</span>
<a href="#l72.2055"></a><span id="l72.2055">   }</span>
<a href="#l72.2056"></a><span id="l72.2056"> </span>
<a href="#l72.2057"></a><span id="l72.2057">   return stream;</span>
<a href="#l72.2058"></a><span id="l72.2058"> }</span>
<a href="#l72.2059"></a><span id="l72.2059"> </span>
<a href="#l72.2060"></a><span id="l72.2060"> //</span>
<a href="#l72.2061"></a><span id="l72.2061"> // Emitter Wrapper Routines!</span>
<a href="#l72.2062"></a><span id="l72.2062"> //</span>
<a href="#l72.2063"></a><span id="l72.2063" class="difflineminus">-nsIMimeEmitter *</span>
<a href="#l72.2064"></a><span id="l72.2064" class="difflineminus">-GetMimeEmitter(MimeDisplayOptions *opt)</span>
<a href="#l72.2065"></a><span id="l72.2065" class="difflineminus">-{</span>
<a href="#l72.2066"></a><span id="l72.2066" class="difflineminus">-  mime_stream_data  *msd = (mime_stream_data *)opt-&gt;stream_closure;</span>
<a href="#l72.2067"></a><span id="l72.2067" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2068"></a><span id="l72.2068" class="difflineminus">-    return NULL;</span>
<a href="#l72.2069"></a><span id="l72.2069" class="difflineplus">+nsIMimeEmitter *GetMimeEmitter(MimeDisplayOptions *opt) {</span>
<a href="#l72.2070"></a><span id="l72.2070" class="difflineplus">+  mime_stream_data *msd = (mime_stream_data *)opt-&gt;stream_closure;</span>
<a href="#l72.2071"></a><span id="l72.2071" class="difflineplus">+  if (!msd) return NULL;</span>
<a href="#l72.2072"></a><span id="l72.2072"> </span>
<a href="#l72.2073"></a><span id="l72.2073" class="difflineminus">-  nsIMimeEmitter     *ptr = (nsIMimeEmitter *)(msd-&gt;output_emitter);</span>
<a href="#l72.2074"></a><span id="l72.2074" class="difflineplus">+  nsIMimeEmitter *ptr = (nsIMimeEmitter *)(msd-&gt;output_emitter);</span>
<a href="#l72.2075"></a><span id="l72.2075">   return ptr;</span>
<a href="#l72.2076"></a><span id="l72.2076"> }</span>
<a href="#l72.2077"></a><span id="l72.2077"> </span>
<a href="#l72.2078"></a><span id="l72.2078" class="difflineminus">-mime_stream_data *</span>
<a href="#l72.2079"></a><span id="l72.2079" class="difflineminus">-GetMSD(MimeDisplayOptions *opt)</span>
<a href="#l72.2080"></a><span id="l72.2080" class="difflineminus">-{</span>
<a href="#l72.2081"></a><span id="l72.2081" class="difflineminus">-  if (!opt)</span>
<a href="#l72.2082"></a><span id="l72.2082" class="difflineminus">-    return nullptr;</span>
<a href="#l72.2083"></a><span id="l72.2083" class="difflineminus">-  mime_stream_data  *msd = (mime_stream_data *)opt-&gt;stream_closure;</span>
<a href="#l72.2084"></a><span id="l72.2084" class="difflineplus">+mime_stream_data *GetMSD(MimeDisplayOptions *opt) {</span>
<a href="#l72.2085"></a><span id="l72.2085" class="difflineplus">+  if (!opt) return nullptr;</span>
<a href="#l72.2086"></a><span id="l72.2086" class="difflineplus">+  mime_stream_data *msd = (mime_stream_data *)opt-&gt;stream_closure;</span>
<a href="#l72.2087"></a><span id="l72.2087">   return msd;</span>
<a href="#l72.2088"></a><span id="l72.2088"> }</span>
<a href="#l72.2089"></a><span id="l72.2089"> </span>
<a href="#l72.2090"></a><span id="l72.2090" class="difflineminus">-bool</span>
<a href="#l72.2091"></a><span id="l72.2091" class="difflineminus">-NoEmitterProcessing(nsMimeOutputType    format_out)</span>
<a href="#l72.2092"></a><span id="l72.2092" class="difflineminus">-{</span>
<a href="#l72.2093"></a><span id="l72.2093" class="difflineminus">-  if ( (format_out == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l72.2094"></a><span id="l72.2094" class="difflineminus">-       (format_out == nsMimeOutput::nsMimeMessageEditorTemplate))</span>
<a href="#l72.2095"></a><span id="l72.2095" class="difflineplus">+bool NoEmitterProcessing(nsMimeOutputType format_out) {</span>
<a href="#l72.2096"></a><span id="l72.2096" class="difflineplus">+  if ((format_out == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l72.2097"></a><span id="l72.2097" class="difflineplus">+      (format_out == nsMimeOutput::nsMimeMessageEditorTemplate))</span>
<a href="#l72.2098"></a><span id="l72.2098">     return true;</span>
<a href="#l72.2099"></a><span id="l72.2099">   else</span>
<a href="#l72.2100"></a><span id="l72.2100">     return false;</span>
<a href="#l72.2101"></a><span id="l72.2101"> }</span>
<a href="#l72.2102"></a><span id="l72.2102"> </span>
<a href="#l72.2103"></a><span id="l72.2103" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.2104"></a><span id="l72.2104" class="difflineminus">-mimeEmitterAddAttachmentField(MimeDisplayOptions *opt, const char *field, const char *value)</span>
<a href="#l72.2105"></a><span id="l72.2105" class="difflineminus">-{</span>
<a href="#l72.2106"></a><span id="l72.2106" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterAddAttachmentField(MimeDisplayOptions *opt,</span>
<a href="#l72.2107"></a><span id="l72.2107" class="difflineplus">+                                                  const char *field,</span>
<a href="#l72.2108"></a><span id="l72.2108" class="difflineplus">+                                                  const char *value) {</span>
<a href="#l72.2109"></a><span id="l72.2109">   // Check for draft processing...</span>
<a href="#l72.2110"></a><span id="l72.2110" class="difflineminus">-  if (NoEmitterProcessing(opt-&gt;format_out))</span>
<a href="#l72.2111"></a><span id="l72.2111" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.2112"></a><span id="l72.2112" class="difflineplus">+  if (NoEmitterProcessing(opt-&gt;format_out)) return NS_OK;</span>
<a href="#l72.2113"></a><span id="l72.2113"> </span>
<a href="#l72.2114"></a><span id="l72.2114" class="difflineminus">-  mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l72.2115"></a><span id="l72.2115" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2116"></a><span id="l72.2116" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2117"></a><span id="l72.2117" class="difflineplus">+  mime_stream_data *msd = GetMSD(opt);</span>
<a href="#l72.2118"></a><span id="l72.2118" class="difflineplus">+  if (!msd) return NS_ERROR_FAILURE;</span>
<a href="#l72.2119"></a><span id="l72.2119"> </span>
<a href="#l72.2120"></a><span id="l72.2120" class="difflineminus">-  if (msd-&gt;output_emitter)</span>
<a href="#l72.2121"></a><span id="l72.2121" class="difflineminus">-  {</span>
<a href="#l72.2122"></a><span id="l72.2122" class="difflineplus">+  if (msd-&gt;output_emitter) {</span>
<a href="#l72.2123"></a><span id="l72.2123">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l72.2124"></a><span id="l72.2124">     return emitter-&gt;AddAttachmentField(field, value);</span>
<a href="#l72.2125"></a><span id="l72.2125">   }</span>
<a href="#l72.2126"></a><span id="l72.2126"> </span>
<a href="#l72.2127"></a><span id="l72.2127">   return NS_ERROR_FAILURE;</span>
<a href="#l72.2128"></a><span id="l72.2128"> }</span>
<a href="#l72.2129"></a><span id="l72.2129"> </span>
<a href="#l72.2130"></a><span id="l72.2130" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.2131"></a><span id="l72.2131" class="difflineminus">-mimeEmitterAddHeaderField(MimeDisplayOptions *opt, const char *field, const char *value)</span>
<a href="#l72.2132"></a><span id="l72.2132" class="difflineminus">-{</span>
<a href="#l72.2133"></a><span id="l72.2133" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterAddHeaderField(MimeDisplayOptions *opt,</span>
<a href="#l72.2134"></a><span id="l72.2134" class="difflineplus">+                                              const char *field,</span>
<a href="#l72.2135"></a><span id="l72.2135" class="difflineplus">+                                              const char *value) {</span>
<a href="#l72.2136"></a><span id="l72.2136">   // Check for draft processing...</span>
<a href="#l72.2137"></a><span id="l72.2137" class="difflineminus">-  if (NoEmitterProcessing(opt-&gt;format_out))</span>
<a href="#l72.2138"></a><span id="l72.2138" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.2139"></a><span id="l72.2139" class="difflineplus">+  if (NoEmitterProcessing(opt-&gt;format_out)) return NS_OK;</span>
<a href="#l72.2140"></a><span id="l72.2140"> </span>
<a href="#l72.2141"></a><span id="l72.2141" class="difflineminus">-  mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l72.2142"></a><span id="l72.2142" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2143"></a><span id="l72.2143" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2144"></a><span id="l72.2144" class="difflineplus">+  mime_stream_data *msd = GetMSD(opt);</span>
<a href="#l72.2145"></a><span id="l72.2145" class="difflineplus">+  if (!msd) return NS_ERROR_FAILURE;</span>
<a href="#l72.2146"></a><span id="l72.2146"> </span>
<a href="#l72.2147"></a><span id="l72.2147" class="difflineminus">-  if (msd-&gt;output_emitter)</span>
<a href="#l72.2148"></a><span id="l72.2148" class="difflineminus">-  {</span>
<a href="#l72.2149"></a><span id="l72.2149" class="difflineplus">+  if (msd-&gt;output_emitter) {</span>
<a href="#l72.2150"></a><span id="l72.2150">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l72.2151"></a><span id="l72.2151">     return emitter-&gt;AddHeaderField(field, value);</span>
<a href="#l72.2152"></a><span id="l72.2152">   }</span>
<a href="#l72.2153"></a><span id="l72.2153"> </span>
<a href="#l72.2154"></a><span id="l72.2154">   return NS_ERROR_FAILURE;</span>
<a href="#l72.2155"></a><span id="l72.2155"> }</span>
<a href="#l72.2156"></a><span id="l72.2156"> </span>
<a href="#l72.2157"></a><span id="l72.2157" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.2158"></a><span id="l72.2158" class="difflineminus">-mimeEmitterAddAllHeaders(MimeDisplayOptions *opt, const char *allheaders, const int32_t allheadersize)</span>
<a href="#l72.2159"></a><span id="l72.2159" class="difflineminus">-{</span>
<a href="#l72.2160"></a><span id="l72.2160" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterAddAllHeaders(MimeDisplayOptions *opt,</span>
<a href="#l72.2161"></a><span id="l72.2161" class="difflineplus">+                                             const char *allheaders,</span>
<a href="#l72.2162"></a><span id="l72.2162" class="difflineplus">+                                             const int32_t allheadersize) {</span>
<a href="#l72.2163"></a><span id="l72.2163">   // Check for draft processing...</span>
<a href="#l72.2164"></a><span id="l72.2164" class="difflineminus">-  if (NoEmitterProcessing(opt-&gt;format_out))</span>
<a href="#l72.2165"></a><span id="l72.2165" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.2166"></a><span id="l72.2166" class="difflineplus">+  if (NoEmitterProcessing(opt-&gt;format_out)) return NS_OK;</span>
<a href="#l72.2167"></a><span id="l72.2167"> </span>
<a href="#l72.2168"></a><span id="l72.2168" class="difflineminus">-  mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l72.2169"></a><span id="l72.2169" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2170"></a><span id="l72.2170" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2171"></a><span id="l72.2171" class="difflineplus">+  mime_stream_data *msd = GetMSD(opt);</span>
<a href="#l72.2172"></a><span id="l72.2172" class="difflineplus">+  if (!msd) return NS_ERROR_FAILURE;</span>
<a href="#l72.2173"></a><span id="l72.2173"> </span>
<a href="#l72.2174"></a><span id="l72.2174" class="difflineminus">-  if (msd-&gt;output_emitter)</span>
<a href="#l72.2175"></a><span id="l72.2175" class="difflineminus">-  {</span>
<a href="#l72.2176"></a><span id="l72.2176" class="difflineplus">+  if (msd-&gt;output_emitter) {</span>
<a href="#l72.2177"></a><span id="l72.2177">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l72.2178"></a><span id="l72.2178" class="difflineminus">-    return emitter-&gt;AddAllHeaders(Substring(allheaders,</span>
<a href="#l72.2179"></a><span id="l72.2179" class="difflineminus">-                                            allheaders + allheadersize));</span>
<a href="#l72.2180"></a><span id="l72.2180" class="difflineplus">+    return emitter-&gt;AddAllHeaders(</span>
<a href="#l72.2181"></a><span id="l72.2181" class="difflineplus">+        Substring(allheaders, allheaders + allheadersize));</span>
<a href="#l72.2182"></a><span id="l72.2182">   }</span>
<a href="#l72.2183"></a><span id="l72.2183"> </span>
<a href="#l72.2184"></a><span id="l72.2184">   return NS_ERROR_FAILURE;</span>
<a href="#l72.2185"></a><span id="l72.2185"> }</span>
<a href="#l72.2186"></a><span id="l72.2186"> </span>
<a href="#l72.2187"></a><span id="l72.2187" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.2188"></a><span id="l72.2188" class="difflineminus">-mimeEmitterStartAttachment(MimeDisplayOptions *opt, const char *name, const char *contentType, const char *url,</span>
<a href="#l72.2189"></a><span id="l72.2189" class="difflineminus">-                           bool aIsExternalAttachment)</span>
<a href="#l72.2190"></a><span id="l72.2190" class="difflineminus">-{</span>
<a href="#l72.2191"></a><span id="l72.2191" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterStartAttachment(MimeDisplayOptions *opt,</span>
<a href="#l72.2192"></a><span id="l72.2192" class="difflineplus">+                                               const char *name,</span>
<a href="#l72.2193"></a><span id="l72.2193" class="difflineplus">+                                               const char *contentType,</span>
<a href="#l72.2194"></a><span id="l72.2194" class="difflineplus">+                                               const char *url,</span>
<a href="#l72.2195"></a><span id="l72.2195" class="difflineplus">+                                               bool aIsExternalAttachment) {</span>
<a href="#l72.2196"></a><span id="l72.2196">   // Check for draft processing...</span>
<a href="#l72.2197"></a><span id="l72.2197" class="difflineminus">-  if (NoEmitterProcessing(opt-&gt;format_out))</span>
<a href="#l72.2198"></a><span id="l72.2198" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.2199"></a><span id="l72.2199" class="difflineplus">+  if (NoEmitterProcessing(opt-&gt;format_out)) return NS_OK;</span>
<a href="#l72.2200"></a><span id="l72.2200"> </span>
<a href="#l72.2201"></a><span id="l72.2201" class="difflineminus">-  mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l72.2202"></a><span id="l72.2202" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2203"></a><span id="l72.2203" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2204"></a><span id="l72.2204" class="difflineplus">+  mime_stream_data *msd = GetMSD(opt);</span>
<a href="#l72.2205"></a><span id="l72.2205" class="difflineplus">+  if (!msd) return NS_ERROR_FAILURE;</span>
<a href="#l72.2206"></a><span id="l72.2206"> </span>
<a href="#l72.2207"></a><span id="l72.2207" class="difflineminus">-  if (msd-&gt;output_emitter)</span>
<a href="#l72.2208"></a><span id="l72.2208" class="difflineminus">-  {</span>
<a href="#l72.2209"></a><span id="l72.2209" class="difflineplus">+  if (msd-&gt;output_emitter) {</span>
<a href="#l72.2210"></a><span id="l72.2210">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l72.2211"></a><span id="l72.2211">     return emitter-&gt;StartAttachment(nsDependentCString(name), contentType, url,</span>
<a href="#l72.2212"></a><span id="l72.2212">                                     aIsExternalAttachment);</span>
<a href="#l72.2213"></a><span id="l72.2213">   }</span>
<a href="#l72.2214"></a><span id="l72.2214"> </span>
<a href="#l72.2215"></a><span id="l72.2215">   return NS_ERROR_FAILURE;</span>
<a href="#l72.2216"></a><span id="l72.2216"> }</span>
<a href="#l72.2217"></a><span id="l72.2217"> </span>
<a href="#l72.2218"></a><span id="l72.2218" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.2219"></a><span id="l72.2219" class="difflineminus">-mimeEmitterEndAttachment(MimeDisplayOptions *opt)</span>
<a href="#l72.2220"></a><span id="l72.2220" class="difflineminus">-{</span>
<a href="#l72.2221"></a><span id="l72.2221" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterEndAttachment(MimeDisplayOptions *opt) {</span>
<a href="#l72.2222"></a><span id="l72.2222">   // Check for draft processing...</span>
<a href="#l72.2223"></a><span id="l72.2223" class="difflineminus">-  if (NoEmitterProcessing(opt-&gt;format_out))</span>
<a href="#l72.2224"></a><span id="l72.2224" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.2225"></a><span id="l72.2225" class="difflineplus">+  if (NoEmitterProcessing(opt-&gt;format_out)) return NS_OK;</span>
<a href="#l72.2226"></a><span id="l72.2226"> </span>
<a href="#l72.2227"></a><span id="l72.2227" class="difflineminus">-  mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l72.2228"></a><span id="l72.2228" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2229"></a><span id="l72.2229" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2230"></a><span id="l72.2230" class="difflineplus">+  mime_stream_data *msd = GetMSD(opt);</span>
<a href="#l72.2231"></a><span id="l72.2231" class="difflineplus">+  if (!msd) return NS_ERROR_FAILURE;</span>
<a href="#l72.2232"></a><span id="l72.2232"> </span>
<a href="#l72.2233"></a><span id="l72.2233" class="difflineminus">-  if (msd-&gt;output_emitter)</span>
<a href="#l72.2234"></a><span id="l72.2234" class="difflineminus">-  {</span>
<a href="#l72.2235"></a><span id="l72.2235" class="difflineplus">+  if (msd-&gt;output_emitter) {</span>
<a href="#l72.2236"></a><span id="l72.2236">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l72.2237"></a><span id="l72.2237">     if (emitter)</span>
<a href="#l72.2238"></a><span id="l72.2238">       return emitter-&gt;EndAttachment();</span>
<a href="#l72.2239"></a><span id="l72.2239">     else</span>
<a href="#l72.2240"></a><span id="l72.2240">       return NS_OK;</span>
<a href="#l72.2241"></a><span id="l72.2241">   }</span>
<a href="#l72.2242"></a><span id="l72.2242"> </span>
<a href="#l72.2243"></a><span id="l72.2243">   return NS_ERROR_FAILURE;</span>
<a href="#l72.2244"></a><span id="l72.2244"> }</span>
<a href="#l72.2245"></a><span id="l72.2245"> </span>
<a href="#l72.2246"></a><span id="l72.2246" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.2247"></a><span id="l72.2247" class="difflineminus">-mimeEmitterEndAllAttachments(MimeDisplayOptions *opt)</span>
<a href="#l72.2248"></a><span id="l72.2248" class="difflineminus">-{</span>
<a href="#l72.2249"></a><span id="l72.2249" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterEndAllAttachments(MimeDisplayOptions *opt) {</span>
<a href="#l72.2250"></a><span id="l72.2250">   // Check for draft processing...</span>
<a href="#l72.2251"></a><span id="l72.2251" class="difflineminus">-  if (NoEmitterProcessing(opt-&gt;format_out))</span>
<a href="#l72.2252"></a><span id="l72.2252" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.2253"></a><span id="l72.2253" class="difflineplus">+  if (NoEmitterProcessing(opt-&gt;format_out)) return NS_OK;</span>
<a href="#l72.2254"></a><span id="l72.2254"> </span>
<a href="#l72.2255"></a><span id="l72.2255" class="difflineminus">-  mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l72.2256"></a><span id="l72.2256" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2257"></a><span id="l72.2257" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2258"></a><span id="l72.2258" class="difflineplus">+  mime_stream_data *msd = GetMSD(opt);</span>
<a href="#l72.2259"></a><span id="l72.2259" class="difflineplus">+  if (!msd) return NS_ERROR_FAILURE;</span>
<a href="#l72.2260"></a><span id="l72.2260"> </span>
<a href="#l72.2261"></a><span id="l72.2261" class="difflineminus">-  if (msd-&gt;output_emitter)</span>
<a href="#l72.2262"></a><span id="l72.2262" class="difflineminus">-  {</span>
<a href="#l72.2263"></a><span id="l72.2263" class="difflineplus">+  if (msd-&gt;output_emitter) {</span>
<a href="#l72.2264"></a><span id="l72.2264">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l72.2265"></a><span id="l72.2265">     if (emitter)</span>
<a href="#l72.2266"></a><span id="l72.2266">       return emitter-&gt;EndAllAttachments();</span>
<a href="#l72.2267"></a><span id="l72.2267">     else</span>
<a href="#l72.2268"></a><span id="l72.2268">       return NS_OK;</span>
<a href="#l72.2269"></a><span id="l72.2269">   }</span>
<a href="#l72.2270"></a><span id="l72.2270"> </span>
<a href="#l72.2271"></a><span id="l72.2271">   return NS_ERROR_FAILURE;</span>
<a href="#l72.2272"></a><span id="l72.2272"> }</span>
<a href="#l72.2273"></a><span id="l72.2273"> </span>
<a href="#l72.2274"></a><span id="l72.2274" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.2275"></a><span id="l72.2275" class="difflineminus">-mimeEmitterStartBody(MimeDisplayOptions *opt, bool bodyOnly, const char *msgID, const char *outCharset)</span>
<a href="#l72.2276"></a><span id="l72.2276" class="difflineminus">-{</span>
<a href="#l72.2277"></a><span id="l72.2277" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterStartBody(MimeDisplayOptions *opt, bool bodyOnly,</span>
<a href="#l72.2278"></a><span id="l72.2278" class="difflineplus">+                                         const char *msgID,</span>
<a href="#l72.2279"></a><span id="l72.2279" class="difflineplus">+                                         const char *outCharset) {</span>
<a href="#l72.2280"></a><span id="l72.2280">   // Check for draft processing...</span>
<a href="#l72.2281"></a><span id="l72.2281" class="difflineminus">-  if (NoEmitterProcessing(opt-&gt;format_out))</span>
<a href="#l72.2282"></a><span id="l72.2282" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.2283"></a><span id="l72.2283" class="difflineplus">+  if (NoEmitterProcessing(opt-&gt;format_out)) return NS_OK;</span>
<a href="#l72.2284"></a><span id="l72.2284"> </span>
<a href="#l72.2285"></a><span id="l72.2285" class="difflineminus">-  mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l72.2286"></a><span id="l72.2286" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2287"></a><span id="l72.2287" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2288"></a><span id="l72.2288" class="difflineplus">+  mime_stream_data *msd = GetMSD(opt);</span>
<a href="#l72.2289"></a><span id="l72.2289" class="difflineplus">+  if (!msd) return NS_ERROR_FAILURE;</span>
<a href="#l72.2290"></a><span id="l72.2290"> </span>
<a href="#l72.2291"></a><span id="l72.2291" class="difflineminus">-  if (msd-&gt;output_emitter)</span>
<a href="#l72.2292"></a><span id="l72.2292" class="difflineminus">-  {</span>
<a href="#l72.2293"></a><span id="l72.2293" class="difflineplus">+  if (msd-&gt;output_emitter) {</span>
<a href="#l72.2294"></a><span id="l72.2294">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l72.2295"></a><span id="l72.2295">     return emitter-&gt;StartBody(bodyOnly, msgID, outCharset);</span>
<a href="#l72.2296"></a><span id="l72.2296">   }</span>
<a href="#l72.2297"></a><span id="l72.2297"> </span>
<a href="#l72.2298"></a><span id="l72.2298">   return NS_ERROR_FAILURE;</span>
<a href="#l72.2299"></a><span id="l72.2299"> }</span>
<a href="#l72.2300"></a><span id="l72.2300"> </span>
<a href="#l72.2301"></a><span id="l72.2301" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.2302"></a><span id="l72.2302" class="difflineminus">-mimeEmitterEndBody(MimeDisplayOptions *opt)</span>
<a href="#l72.2303"></a><span id="l72.2303" class="difflineminus">-{</span>
<a href="#l72.2304"></a><span id="l72.2304" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterEndBody(MimeDisplayOptions *opt) {</span>
<a href="#l72.2305"></a><span id="l72.2305">   // Check for draft processing...</span>
<a href="#l72.2306"></a><span id="l72.2306" class="difflineminus">-  if (NoEmitterProcessing(opt-&gt;format_out))</span>
<a href="#l72.2307"></a><span id="l72.2307" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.2308"></a><span id="l72.2308" class="difflineplus">+  if (NoEmitterProcessing(opt-&gt;format_out)) return NS_OK;</span>
<a href="#l72.2309"></a><span id="l72.2309"> </span>
<a href="#l72.2310"></a><span id="l72.2310" class="difflineminus">-  mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l72.2311"></a><span id="l72.2311" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2312"></a><span id="l72.2312" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2313"></a><span id="l72.2313" class="difflineplus">+  mime_stream_data *msd = GetMSD(opt);</span>
<a href="#l72.2314"></a><span id="l72.2314" class="difflineplus">+  if (!msd) return NS_ERROR_FAILURE;</span>
<a href="#l72.2315"></a><span id="l72.2315"> </span>
<a href="#l72.2316"></a><span id="l72.2316" class="difflineminus">-  if (msd-&gt;output_emitter)</span>
<a href="#l72.2317"></a><span id="l72.2317" class="difflineminus">-  {</span>
<a href="#l72.2318"></a><span id="l72.2318" class="difflineplus">+  if (msd-&gt;output_emitter) {</span>
<a href="#l72.2319"></a><span id="l72.2319">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l72.2320"></a><span id="l72.2320">     return emitter-&gt;EndBody();</span>
<a href="#l72.2321"></a><span id="l72.2321">   }</span>
<a href="#l72.2322"></a><span id="l72.2322"> </span>
<a href="#l72.2323"></a><span id="l72.2323">   return NS_ERROR_FAILURE;</span>
<a href="#l72.2324"></a><span id="l72.2324"> }</span>
<a href="#l72.2325"></a><span id="l72.2325"> </span>
<a href="#l72.2326"></a><span id="l72.2326" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.2327"></a><span id="l72.2327" class="difflineminus">-mimeEmitterEndHeader(MimeDisplayOptions *opt, MimeObject *obj)</span>
<a href="#l72.2328"></a><span id="l72.2328" class="difflineminus">-{</span>
<a href="#l72.2329"></a><span id="l72.2329" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterEndHeader(MimeDisplayOptions *opt,</span>
<a href="#l72.2330"></a><span id="l72.2330" class="difflineplus">+                                         MimeObject *obj) {</span>
<a href="#l72.2331"></a><span id="l72.2331">   // Check for draft processing...</span>
<a href="#l72.2332"></a><span id="l72.2332" class="difflineminus">-  if (NoEmitterProcessing(opt-&gt;format_out))</span>
<a href="#l72.2333"></a><span id="l72.2333" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.2334"></a><span id="l72.2334" class="difflineplus">+  if (NoEmitterProcessing(opt-&gt;format_out)) return NS_OK;</span>
<a href="#l72.2335"></a><span id="l72.2335"> </span>
<a href="#l72.2336"></a><span id="l72.2336" class="difflineminus">-  mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l72.2337"></a><span id="l72.2337" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2338"></a><span id="l72.2338" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2339"></a><span id="l72.2339" class="difflineplus">+  mime_stream_data *msd = GetMSD(opt);</span>
<a href="#l72.2340"></a><span id="l72.2340" class="difflineplus">+  if (!msd) return NS_ERROR_FAILURE;</span>
<a href="#l72.2341"></a><span id="l72.2341"> </span>
<a href="#l72.2342"></a><span id="l72.2342" class="difflineminus">-  if (msd-&gt;output_emitter)</span>
<a href="#l72.2343"></a><span id="l72.2343" class="difflineminus">-  {</span>
<a href="#l72.2344"></a><span id="l72.2344" class="difflineplus">+  if (msd-&gt;output_emitter) {</span>
<a href="#l72.2345"></a><span id="l72.2345">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l72.2346"></a><span id="l72.2346"> </span>
<a href="#l72.2347"></a><span id="l72.2347">     nsCString name;</span>
<a href="#l72.2348"></a><span id="l72.2348">     if (msd-&gt;format_out == nsMimeOutput::nsMimeMessageSplitDisplay ||</span>
<a href="#l72.2349"></a><span id="l72.2349">         msd-&gt;format_out == nsMimeOutput::nsMimeMessageHeaderDisplay ||</span>
<a href="#l72.2350"></a><span id="l72.2350">         msd-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay ||</span>
<a href="#l72.2351"></a><span id="l72.2351">         msd-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs ||</span>
<a href="#l72.2352"></a><span id="l72.2352">         msd-&gt;format_out == nsMimeOutput::nsMimeMessagePrintOutput) {</span>
<a href="#l72.2353"></a><span id="l72.2353">       if (obj-&gt;headers) {</span>
<a href="#l72.2354"></a><span id="l72.2354">         nsMsgAttachmentData attachment;</span>
<a href="#l72.2355"></a><span id="l72.2355">         attIndex = 0;</span>
<a href="#l72.2356"></a><span id="l72.2356" class="difflineminus">-        nsresult rv = GenerateAttachmentData(obj, msd-&gt;url_name, opt, false,</span>
<a href="#l72.2357"></a><span id="l72.2357" class="difflineminus">-                                             0, &amp;attachment);</span>
<a href="#l72.2358"></a><span id="l72.2358" class="difflineplus">+        nsresult rv = GenerateAttachmentData(obj, msd-&gt;url_name, opt, false, 0,</span>
<a href="#l72.2359"></a><span id="l72.2359" class="difflineplus">+                                             &amp;attachment);</span>
<a href="#l72.2360"></a><span id="l72.2360"> </span>
<a href="#l72.2361"></a><span id="l72.2361" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l72.2362"></a><span id="l72.2362" class="difflineminus">-          name.Assign(attachment.m_realName);</span>
<a href="#l72.2363"></a><span id="l72.2363" class="difflineplus">+        if (NS_SUCCEEDED(rv)) name.Assign(attachment.m_realName);</span>
<a href="#l72.2364"></a><span id="l72.2364">       }</span>
<a href="#l72.2365"></a><span id="l72.2365">     }</span>
<a href="#l72.2366"></a><span id="l72.2366"> </span>
<a href="#l72.2367"></a><span id="l72.2367">     MimeHeaders_convert_header_value(opt, name, false);</span>
<a href="#l72.2368"></a><span id="l72.2368">     return emitter-&gt;EndHeader(name);</span>
<a href="#l72.2369"></a><span id="l72.2369">   }</span>
<a href="#l72.2370"></a><span id="l72.2370"> </span>
<a href="#l72.2371"></a><span id="l72.2371">   return NS_ERROR_FAILURE;</span>
<a href="#l72.2372"></a><span id="l72.2372"> }</span>
<a href="#l72.2373"></a><span id="l72.2373"> </span>
<a href="#l72.2374"></a><span id="l72.2374" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.2375"></a><span id="l72.2375" class="difflineminus">-mimeEmitterUpdateCharacterSet(MimeDisplayOptions *opt, const char *aCharset)</span>
<a href="#l72.2376"></a><span id="l72.2376" class="difflineminus">-{</span>
<a href="#l72.2377"></a><span id="l72.2377" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterUpdateCharacterSet(MimeDisplayOptions *opt,</span>
<a href="#l72.2378"></a><span id="l72.2378" class="difflineplus">+                                                  const char *aCharset) {</span>
<a href="#l72.2379"></a><span id="l72.2379">   // Check for draft processing...</span>
<a href="#l72.2380"></a><span id="l72.2380" class="difflineminus">-  if (NoEmitterProcessing(opt-&gt;format_out))</span>
<a href="#l72.2381"></a><span id="l72.2381" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.2382"></a><span id="l72.2382" class="difflineplus">+  if (NoEmitterProcessing(opt-&gt;format_out)) return NS_OK;</span>
<a href="#l72.2383"></a><span id="l72.2383"> </span>
<a href="#l72.2384"></a><span id="l72.2384" class="difflineminus">-  mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l72.2385"></a><span id="l72.2385" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2386"></a><span id="l72.2386" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2387"></a><span id="l72.2387" class="difflineplus">+  mime_stream_data *msd = GetMSD(opt);</span>
<a href="#l72.2388"></a><span id="l72.2388" class="difflineplus">+  if (!msd) return NS_ERROR_FAILURE;</span>
<a href="#l72.2389"></a><span id="l72.2389"> </span>
<a href="#l72.2390"></a><span id="l72.2390" class="difflineminus">-  if (msd-&gt;output_emitter)</span>
<a href="#l72.2391"></a><span id="l72.2391" class="difflineminus">-  {</span>
<a href="#l72.2392"></a><span id="l72.2392" class="difflineplus">+  if (msd-&gt;output_emitter) {</span>
<a href="#l72.2393"></a><span id="l72.2393">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l72.2394"></a><span id="l72.2394">     return emitter-&gt;UpdateCharacterSet(aCharset);</span>
<a href="#l72.2395"></a><span id="l72.2395">   }</span>
<a href="#l72.2396"></a><span id="l72.2396"> </span>
<a href="#l72.2397"></a><span id="l72.2397">   return NS_ERROR_FAILURE;</span>
<a href="#l72.2398"></a><span id="l72.2398"> }</span>
<a href="#l72.2399"></a><span id="l72.2399"> </span>
<a href="#l72.2400"></a><span id="l72.2400" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.2401"></a><span id="l72.2401" class="difflineminus">-mimeEmitterStartHeader(MimeDisplayOptions *opt, bool rootMailHeader, bool headerOnly, const char *msgID,</span>
<a href="#l72.2402"></a><span id="l72.2402" class="difflineminus">-                       const char *outCharset)</span>
<a href="#l72.2403"></a><span id="l72.2403" class="difflineminus">-{</span>
<a href="#l72.2404"></a><span id="l72.2404" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterStartHeader(MimeDisplayOptions *opt,</span>
<a href="#l72.2405"></a><span id="l72.2405" class="difflineplus">+                                           bool rootMailHeader, bool headerOnly,</span>
<a href="#l72.2406"></a><span id="l72.2406" class="difflineplus">+                                           const char *msgID,</span>
<a href="#l72.2407"></a><span id="l72.2407" class="difflineplus">+                                           const char *outCharset) {</span>
<a href="#l72.2408"></a><span id="l72.2408">   // Check for draft processing...</span>
<a href="#l72.2409"></a><span id="l72.2409" class="difflineminus">-  if (NoEmitterProcessing(opt-&gt;format_out))</span>
<a href="#l72.2410"></a><span id="l72.2410" class="difflineminus">-    return NS_OK;</span>
<a href="#l72.2411"></a><span id="l72.2411" class="difflineplus">+  if (NoEmitterProcessing(opt-&gt;format_out)) return NS_OK;</span>
<a href="#l72.2412"></a><span id="l72.2412"> </span>
<a href="#l72.2413"></a><span id="l72.2413" class="difflineminus">-  mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l72.2414"></a><span id="l72.2414" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2415"></a><span id="l72.2415" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2416"></a><span id="l72.2416" class="difflineplus">+  mime_stream_data *msd = GetMSD(opt);</span>
<a href="#l72.2417"></a><span id="l72.2417" class="difflineplus">+  if (!msd) return NS_ERROR_FAILURE;</span>
<a href="#l72.2418"></a><span id="l72.2418"> </span>
<a href="#l72.2419"></a><span id="l72.2419" class="difflineminus">-  if (msd-&gt;output_emitter)</span>
<a href="#l72.2420"></a><span id="l72.2420" class="difflineminus">-  {</span>
<a href="#l72.2421"></a><span id="l72.2421" class="difflineplus">+  if (msd-&gt;output_emitter) {</span>
<a href="#l72.2422"></a><span id="l72.2422">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l72.2423"></a><span id="l72.2423">     return emitter-&gt;StartHeader(rootMailHeader, headerOnly, msgID, outCharset);</span>
<a href="#l72.2424"></a><span id="l72.2424">   }</span>
<a href="#l72.2425"></a><span id="l72.2425"> </span>
<a href="#l72.2426"></a><span id="l72.2426">   return NS_ERROR_FAILURE;</span>
<a href="#l72.2427"></a><span id="l72.2427"> }</span>
<a href="#l72.2428"></a><span id="l72.2428"> </span>
<a href="#l72.2429"></a><span id="l72.2429" class="difflineplus">+extern &quot;C&quot; nsresult mimeSetNewURL(nsMIMESession *stream, char *url) {</span>
<a href="#l72.2430"></a><span id="l72.2430" class="difflineplus">+  if ((!stream) || (!url) || (!*url)) return NS_ERROR_FAILURE;</span>
<a href="#l72.2431"></a><span id="l72.2431"> </span>
<a href="#l72.2432"></a><span id="l72.2432" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l72.2433"></a><span id="l72.2433" class="difflineminus">-mimeSetNewURL(nsMIMESession *stream, char *url)</span>
<a href="#l72.2434"></a><span id="l72.2434" class="difflineminus">-{</span>
<a href="#l72.2435"></a><span id="l72.2435" class="difflineminus">-  if ( (!stream) || (!url) || (!*url) )</span>
<a href="#l72.2436"></a><span id="l72.2436" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2437"></a><span id="l72.2437" class="difflineminus">-</span>
<a href="#l72.2438"></a><span id="l72.2438" class="difflineminus">-  mime_stream_data  *msd = (mime_stream_data *)stream-&gt;data_object;</span>
<a href="#l72.2439"></a><span id="l72.2439" class="difflineminus">-  if (!msd)</span>
<a href="#l72.2440"></a><span id="l72.2440" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l72.2441"></a><span id="l72.2441" class="difflineplus">+  mime_stream_data *msd = (mime_stream_data *)stream-&gt;data_object;</span>
<a href="#l72.2442"></a><span id="l72.2442" class="difflineplus">+  if (!msd) return NS_ERROR_FAILURE;</span>
<a href="#l72.2443"></a><span id="l72.2443"> </span>
<a href="#l72.2444"></a><span id="l72.2444">   char *tmpPtr = strdup(url);</span>
<a href="#l72.2445"></a><span id="l72.2445" class="difflineminus">-  if (!tmpPtr)</span>
<a href="#l72.2446"></a><span id="l72.2446" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.2447"></a><span id="l72.2447" class="difflineplus">+  if (!tmpPtr) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.2448"></a><span id="l72.2448"> </span>
<a href="#l72.2449"></a><span id="l72.2449">   PR_FREEIF(msd-&gt;url_name);</span>
<a href="#l72.2450"></a><span id="l72.2450">   msd-&gt;url_name = tmpPtr;</span>
<a href="#l72.2451"></a><span id="l72.2451">   return NS_OK;</span>
<a href="#l72.2452"></a><span id="l72.2452"> }</span>
<a href="#l72.2453"></a><span id="l72.2453"> </span>
<a href="#l72.2454"></a><span id="l72.2454" class="difflineminus">-#define     MIME_URL &quot;chrome://messenger/locale/mime.properties&quot;</span>
<a href="#l72.2455"></a><span id="l72.2455" class="difflineplus">+#define MIME_URL &quot;chrome://messenger/locale/mime.properties&quot;</span>
<a href="#l72.2456"></a><span id="l72.2456"> </span>
<a href="#l72.2457"></a><span id="l72.2457" class="difflineminus">-extern &quot;C&quot;</span>
<a href="#l72.2458"></a><span id="l72.2458" class="difflineminus">-char *</span>
<a href="#l72.2459"></a><span id="l72.2459" class="difflineminus">-MimeGetStringByID(int32_t stringID)</span>
<a href="#l72.2460"></a><span id="l72.2460" class="difflineminus">-{</span>
<a href="#l72.2461"></a><span id="l72.2461" class="difflineplus">+extern &quot;C&quot; char *MimeGetStringByID(int32_t stringID) {</span>
<a href="#l72.2462"></a><span id="l72.2462">   nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleService =</span>
<a href="#l72.2463"></a><span id="l72.2463" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l72.2464"></a><span id="l72.2464" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l72.2465"></a><span id="l72.2465"> </span>
<a href="#l72.2466"></a><span id="l72.2466">   nsCOMPtr&lt;nsIStringBundle&gt; stringBundle;</span>
<a href="#l72.2467"></a><span id="l72.2467">   stringBundleService-&gt;CreateBundle(MIME_URL, getter_AddRefs(stringBundle));</span>
<a href="#l72.2468"></a><span id="l72.2468" class="difflineminus">-  if (stringBundle)</span>
<a href="#l72.2469"></a><span id="l72.2469" class="difflineminus">-  {</span>
<a href="#l72.2470"></a><span id="l72.2470" class="difflineplus">+  if (stringBundle) {</span>
<a href="#l72.2471"></a><span id="l72.2471">     nsString v;</span>
<a href="#l72.2472"></a><span id="l72.2472">     if (NS_SUCCEEDED(stringBundle-&gt;GetStringFromID(stringID, v)))</span>
<a href="#l72.2473"></a><span id="l72.2473">       return ToNewUTF8String(v);</span>
<a href="#l72.2474"></a><span id="l72.2474">   }</span>
<a href="#l72.2475"></a><span id="l72.2475"> </span>
<a href="#l72.2476"></a><span id="l72.2476">   return strdup(&quot;???&quot;);</span>
<a href="#l72.2477"></a><span id="l72.2477"> }</span>
<a href="#l72.2478"></a><span id="l72.2478"> </span>
<a href="#l72.2479"></a><span id="l72.2479" class="difflineminus">-extern &quot;C&quot;</span>
<a href="#l72.2480"></a><span id="l72.2480" class="difflineminus">-char *</span>
<a href="#l72.2481"></a><span id="l72.2481" class="difflineminus">-MimeGetStringByName(const char16_t *stringName)</span>
<a href="#l72.2482"></a><span id="l72.2482" class="difflineminus">-{</span>
<a href="#l72.2483"></a><span id="l72.2483" class="difflineplus">+extern &quot;C&quot; char *MimeGetStringByName(const char16_t *stringName) {</span>
<a href="#l72.2484"></a><span id="l72.2484">   nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleService =</span>
<a href="#l72.2485"></a><span id="l72.2485" class="difflineminus">-    do_GetService(NS_STRINGBUNDLE_CONTRACTID);</span>
<a href="#l72.2486"></a><span id="l72.2486" class="difflineplus">+      do_GetService(NS_STRINGBUNDLE_CONTRACTID);</span>
<a href="#l72.2487"></a><span id="l72.2487"> </span>
<a href="#l72.2488"></a><span id="l72.2488">   nsCOMPtr&lt;nsIStringBundle&gt; stringBundle;</span>
<a href="#l72.2489"></a><span id="l72.2489">   stringBundleService-&gt;CreateBundle(MIME_URL, getter_AddRefs(stringBundle));</span>
<a href="#l72.2490"></a><span id="l72.2490" class="difflineminus">-  if (stringBundle)</span>
<a href="#l72.2491"></a><span id="l72.2491" class="difflineminus">-  {</span>
<a href="#l72.2492"></a><span id="l72.2492" class="difflineplus">+  if (stringBundle) {</span>
<a href="#l72.2493"></a><span id="l72.2493">     nsString v;</span>
<a href="#l72.2494"></a><span id="l72.2494" class="difflineminus">-    if (NS_SUCCEEDED(stringBundle-&gt;GetStringFromName(NS_ConvertUTF16toUTF8(stringName).get(), v)))</span>
<a href="#l72.2495"></a><span id="l72.2495" class="difflineplus">+    if (NS_SUCCEEDED(stringBundle-&gt;GetStringFromName(</span>
<a href="#l72.2496"></a><span id="l72.2496" class="difflineplus">+            NS_ConvertUTF16toUTF8(stringName).get(), v)))</span>
<a href="#l72.2497"></a><span id="l72.2497">       return ToNewUTF8String(v);</span>
<a href="#l72.2498"></a><span id="l72.2498">   }</span>
<a href="#l72.2499"></a><span id="l72.2499"> </span>
<a href="#l72.2500"></a><span id="l72.2500">   return strdup(&quot;???&quot;);</span>
<a href="#l72.2501"></a><span id="l72.2501"> }</span>
<a href="#l72.2502"></a><span id="l72.2502"> </span>
<a href="#l72.2503"></a><span id="l72.2503" class="difflineminus">-void</span>
<a href="#l72.2504"></a><span id="l72.2504" class="difflineminus">-ResetChannelCharset(MimeObject *obj)</span>
<a href="#l72.2505"></a><span id="l72.2505" class="difflineminus">-{</span>
<a href="#l72.2506"></a><span id="l72.2506" class="difflineplus">+void ResetChannelCharset(MimeObject *obj) {</span>
<a href="#l72.2507"></a><span id="l72.2507">   if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;stream_closure &amp;&amp;</span>
<a href="#l72.2508"></a><span id="l72.2508" class="difflineminus">-      obj-&gt;options-&gt;default_charset &amp;&amp; obj-&gt;headers )</span>
<a href="#l72.2509"></a><span id="l72.2509" class="difflineminus">-  {</span>
<a href="#l72.2510"></a><span id="l72.2510" class="difflineminus">-    mime_stream_data  *msd = (mime_stream_data *) (obj-&gt;options-&gt;stream_closure);</span>
<a href="#l72.2511"></a><span id="l72.2511" class="difflineminus">-    char *ct = MimeHeaders_get (obj-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l72.2512"></a><span id="l72.2512" class="difflineminus">-    if ( (ct) &amp;&amp; (msd) &amp;&amp; (msd-&gt;channel) )</span>
<a href="#l72.2513"></a><span id="l72.2513" class="difflineminus">-    {</span>
<a href="#l72.2514"></a><span id="l72.2514" class="difflineplus">+      obj-&gt;options-&gt;default_charset &amp;&amp; obj-&gt;headers) {</span>
<a href="#l72.2515"></a><span id="l72.2515" class="difflineplus">+    mime_stream_data *msd = (mime_stream_data *)(obj-&gt;options-&gt;stream_closure);</span>
<a href="#l72.2516"></a><span id="l72.2516" class="difflineplus">+    char *ct = MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l72.2517"></a><span id="l72.2517" class="difflineplus">+    if ((ct) &amp;&amp; (msd) &amp;&amp; (msd-&gt;channel)) {</span>
<a href="#l72.2518"></a><span id="l72.2518">       char *ptr = strstr(ct, &quot;charset=&quot;);</span>
<a href="#l72.2519"></a><span id="l72.2519" class="difflineminus">-      if (ptr)</span>
<a href="#l72.2520"></a><span id="l72.2520" class="difflineminus">-      {</span>
<a href="#l72.2521"></a><span id="l72.2521" class="difflineplus">+      if (ptr) {</span>
<a href="#l72.2522"></a><span id="l72.2522">         // First, setup the channel!</span>
<a href="#l72.2523"></a><span id="l72.2523">         msd-&gt;channel-&gt;SetContentType(nsDependentCString(ct));</span>
<a href="#l72.2524"></a><span id="l72.2524"> </span>
<a href="#l72.2525"></a><span id="l72.2525">         // Second, if this is a Save As operation, then we need to convert</span>
<a href="#l72.2526"></a><span id="l72.2526">         // to override the output charset!</span>
<a href="#l72.2527"></a><span id="l72.2527" class="difflineminus">-        mime_stream_data  *msd = GetMSD(obj-&gt;options);</span>
<a href="#l72.2528"></a><span id="l72.2528" class="difflineminus">-        if ( (msd) &amp;&amp; (msd-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs) )</span>
<a href="#l72.2529"></a><span id="l72.2529" class="difflineminus">-        {</span>
<a href="#l72.2530"></a><span id="l72.2530" class="difflineplus">+        mime_stream_data *msd = GetMSD(obj-&gt;options);</span>
<a href="#l72.2531"></a><span id="l72.2531" class="difflineplus">+        if ((msd) &amp;&amp; (msd-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs)) {</span>
<a href="#l72.2532"></a><span id="l72.2532">           // Extract the charset alone</span>
<a href="#l72.2533"></a><span id="l72.2533" class="difflineminus">-          char  *cSet = nullptr;</span>
<a href="#l72.2534"></a><span id="l72.2534" class="difflineminus">-          if (*(ptr+8) == '&quot;')</span>
<a href="#l72.2535"></a><span id="l72.2535" class="difflineminus">-            cSet = strdup(ptr+9);</span>
<a href="#l72.2536"></a><span id="l72.2536" class="difflineplus">+          char *cSet = nullptr;</span>
<a href="#l72.2537"></a><span id="l72.2537" class="difflineplus">+          if (*(ptr + 8) == '&quot;')</span>
<a href="#l72.2538"></a><span id="l72.2538" class="difflineplus">+            cSet = strdup(ptr + 9);</span>
<a href="#l72.2539"></a><span id="l72.2539">           else</span>
<a href="#l72.2540"></a><span id="l72.2540" class="difflineminus">-            cSet = strdup(ptr+8);</span>
<a href="#l72.2541"></a><span id="l72.2541" class="difflineminus">-          if (cSet)</span>
<a href="#l72.2542"></a><span id="l72.2542" class="difflineminus">-          {</span>
<a href="#l72.2543"></a><span id="l72.2543" class="difflineplus">+            cSet = strdup(ptr + 8);</span>
<a href="#l72.2544"></a><span id="l72.2544" class="difflineplus">+          if (cSet) {</span>
<a href="#l72.2545"></a><span id="l72.2545">             char *ptr2 = cSet;</span>
<a href="#l72.2546"></a><span id="l72.2546" class="difflineminus">-            while ( (*cSet) &amp;&amp; (*cSet != ' ') &amp;&amp; (*cSet != ';') &amp;&amp;</span>
<a href="#l72.2547"></a><span id="l72.2547" class="difflineminus">-                    (*cSet != '\r') &amp;&amp; (*cSet != '\n') &amp;&amp; (*cSet != '&quot;') )</span>
<a href="#l72.2548"></a><span id="l72.2548" class="difflineplus">+            while ((*cSet) &amp;&amp; (*cSet != ' ') &amp;&amp; (*cSet != ';') &amp;&amp;</span>
<a href="#l72.2549"></a><span id="l72.2549" class="difflineplus">+                   (*cSet != '\r') &amp;&amp; (*cSet != '\n') &amp;&amp; (*cSet != '&quot;'))</span>
<a href="#l72.2550"></a><span id="l72.2550">               ptr2++;</span>
<a href="#l72.2551"></a><span id="l72.2551"> </span>
<a href="#l72.2552"></a><span id="l72.2552">             if (*cSet) {</span>
<a href="#l72.2553"></a><span id="l72.2553">               PR_FREEIF(obj-&gt;options-&gt;default_charset);</span>
<a href="#l72.2554"></a><span id="l72.2554">               obj-&gt;options-&gt;default_charset = strdup(cSet);</span>
<a href="#l72.2555"></a><span id="l72.2555">               obj-&gt;options-&gt;override_charset = true;</span>
<a href="#l72.2556"></a><span id="l72.2556">             }</span>
<a href="#l72.2557"></a><span id="l72.2557"> </span>
<a href="#l72.2558"></a><span id="l72.2558" class="difflineat">@@ -1995,124 +1806,112 @@ ResetChannelCharset(MimeObject *obj)</span>
<a href="#l72.2559"></a><span id="l72.2559">           }</span>
<a href="#l72.2560"></a><span id="l72.2560">         }</span>
<a href="#l72.2561"></a><span id="l72.2561">       }</span>
<a href="#l72.2562"></a><span id="l72.2562">       PR_FREEIF(ct);</span>
<a href="#l72.2563"></a><span id="l72.2563">     }</span>
<a href="#l72.2564"></a><span id="l72.2564">   }</span>
<a href="#l72.2565"></a><span id="l72.2565"> }</span>
<a href="#l72.2566"></a><span id="l72.2566"> </span>
<a href="#l72.2567"></a><span id="l72.2567" class="difflineminus">-  ////////////////////////////////////////////////////////////</span>
<a href="#l72.2568"></a><span id="l72.2568" class="difflineminus">-  // Function to get up mail/news fontlang</span>
<a href="#l72.2569"></a><span id="l72.2569" class="difflineminus">-  ////////////////////////////////////////////////////////////</span>
<a href="#l72.2570"></a><span id="l72.2570" class="difflineplus">+////////////////////////////////////////////////////////////</span>
<a href="#l72.2571"></a><span id="l72.2571" class="difflineplus">+// Function to get up mail/news fontlang</span>
<a href="#l72.2572"></a><span id="l72.2572" class="difflineplus">+////////////////////////////////////////////////////////////</span>
<a href="#l72.2573"></a><span id="l72.2573"> </span>
<a href="#l72.2574"></a><span id="l72.2574" class="difflineminus">-</span>
<a href="#l72.2575"></a><span id="l72.2575" class="difflineminus">-nsresult GetMailNewsFont(MimeObject *obj, bool styleFixed,  int32_t *fontPixelSize,</span>
<a href="#l72.2576"></a><span id="l72.2576" class="difflineminus">-                         int32_t *fontSizePercentage, nsCString&amp; fontLang)</span>
<a href="#l72.2577"></a><span id="l72.2577" class="difflineminus">-{</span>
<a href="#l72.2578"></a><span id="l72.2578" class="difflineplus">+nsresult GetMailNewsFont(MimeObject *obj, bool styleFixed,</span>
<a href="#l72.2579"></a><span id="l72.2579" class="difflineplus">+                         int32_t *fontPixelSize, int32_t *fontSizePercentage,</span>
<a href="#l72.2580"></a><span id="l72.2580" class="difflineplus">+                         nsCString &amp;fontLang) {</span>
<a href="#l72.2581"></a><span id="l72.2581">   nsresult rv = NS_OK;</span>
<a href="#l72.2582"></a><span id="l72.2582"> </span>
<a href="#l72.2583"></a><span id="l72.2583">   nsIPrefBranch *prefBranch = GetPrefBranch(obj-&gt;options);</span>
<a href="#l72.2584"></a><span id="l72.2584">   if (prefBranch) {</span>
<a href="#l72.2585"></a><span id="l72.2585" class="difflineminus">-    MimeInlineText  *text = (MimeInlineText *) obj;</span>
<a href="#l72.2586"></a><span id="l72.2586" class="difflineplus">+    MimeInlineText *text = (MimeInlineText *)obj;</span>
<a href="#l72.2587"></a><span id="l72.2587">     nsAutoCString charset;</span>
<a href="#l72.2588"></a><span id="l72.2588"> </span>
<a href="#l72.2589"></a><span id="l72.2589">     // get a charset</span>
<a href="#l72.2590"></a><span id="l72.2590">     if (!text-&gt;initializeCharset)</span>
<a href="#l72.2591"></a><span id="l72.2591" class="difflineminus">-      ((MimeInlineTextClass*)&amp;mimeInlineTextClass)-&gt;initialize_charset(obj);</span>
<a href="#l72.2592"></a><span id="l72.2592" class="difflineplus">+      ((MimeInlineTextClass *)&amp;mimeInlineTextClass)-&gt;initialize_charset(obj);</span>
<a href="#l72.2593"></a><span id="l72.2593"> </span>
<a href="#l72.2594"></a><span id="l72.2594">     if (!text-&gt;charset || !(*text-&gt;charset))</span>
<a href="#l72.2595"></a><span id="l72.2595">       charset.AssignLiteral(&quot;us-ascii&quot;);</span>
<a href="#l72.2596"></a><span id="l72.2596">     else</span>
<a href="#l72.2597"></a><span id="l72.2597">       charset.Assign(text-&gt;charset);</span>
<a href="#l72.2598"></a><span id="l72.2598"> </span>
<a href="#l72.2599"></a><span id="l72.2599">     nsCOMPtr&lt;nsICharsetConverterManager&gt; charSetConverterManager2;</span>
<a href="#l72.2600"></a><span id="l72.2600">     nsAutoCString prefStr;</span>
<a href="#l72.2601"></a><span id="l72.2601"> </span>
<a href="#l72.2602"></a><span id="l72.2602">     ToLowerCase(charset);</span>
<a href="#l72.2603"></a><span id="l72.2603"> </span>
<a href="#l72.2604"></a><span id="l72.2604" class="difflineminus">-    charSetConverterManager2 = do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l72.2605"></a><span id="l72.2605" class="difflineminus">-    if ( NS_FAILED(rv))</span>
<a href="#l72.2606"></a><span id="l72.2606" class="difflineminus">-      return rv;</span>
<a href="#l72.2607"></a><span id="l72.2607" class="difflineplus">+    charSetConverterManager2 =</span>
<a href="#l72.2608"></a><span id="l72.2608" class="difflineplus">+        do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l72.2609"></a><span id="l72.2609" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l72.2610"></a><span id="l72.2610"> </span>
<a href="#l72.2611"></a><span id="l72.2611">     // get a language, e.g. x-western, ja</span>
<a href="#l72.2612"></a><span id="l72.2612">     rv = charSetConverterManager2-&gt;GetCharsetLangGroup(charset.get(), fontLang);</span>
<a href="#l72.2613"></a><span id="l72.2613" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l72.2614"></a><span id="l72.2614" class="difflineminus">-      return rv;</span>
<a href="#l72.2615"></a><span id="l72.2615" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l72.2616"></a><span id="l72.2616"> </span>
<a href="#l72.2617"></a><span id="l72.2617">     // get a font size from pref</span>
<a href="#l72.2618"></a><span id="l72.2618" class="difflineminus">-    prefStr.Assign(!styleFixed ? &quot;font.size.variable.&quot; : &quot;font.size.monospace.&quot;);</span>
<a href="#l72.2619"></a><span id="l72.2619" class="difflineplus">+    prefStr.Assign(!styleFixed ? &quot;font.size.variable.&quot;</span>
<a href="#l72.2620"></a><span id="l72.2620" class="difflineplus">+                               : &quot;font.size.monospace.&quot;);</span>
<a href="#l72.2621"></a><span id="l72.2621">     prefStr.Append(fontLang);</span>
<a href="#l72.2622"></a><span id="l72.2622">     rv = prefBranch-&gt;GetIntPref(prefStr.get(), fontPixelSize);</span>
<a href="#l72.2623"></a><span id="l72.2623" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l72.2624"></a><span id="l72.2624" class="difflineminus">-      return rv;</span>
<a href="#l72.2625"></a><span id="l72.2625" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l72.2626"></a><span id="l72.2626"> </span>
<a href="#l72.2627"></a><span id="l72.2627">     nsCOMPtr&lt;nsIPrefBranch&gt; prefDefBranch;</span>
<a href="#l72.2628"></a><span id="l72.2628" class="difflineminus">-    nsCOMPtr&lt;nsIPrefService&gt; prefSvc(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l72.2629"></a><span id="l72.2629" class="difflineminus">-    if(prefSvc)</span>
<a href="#l72.2630"></a><span id="l72.2630" class="difflineplus">+    nsCOMPtr&lt;nsIPrefService&gt; prefSvc(</span>
<a href="#l72.2631"></a><span id="l72.2631" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l72.2632"></a><span id="l72.2632" class="difflineplus">+    if (prefSvc)</span>
<a href="#l72.2633"></a><span id="l72.2633">       rv = prefSvc-&gt;GetDefaultBranch(&quot;&quot;, getter_AddRefs(prefDefBranch));</span>
<a href="#l72.2634"></a><span id="l72.2634"> </span>
<a href="#l72.2635"></a><span id="l72.2635" class="difflineminus">-    if(!prefDefBranch)</span>
<a href="#l72.2636"></a><span id="l72.2636" class="difflineminus">-      return rv;</span>
<a href="#l72.2637"></a><span id="l72.2637" class="difflineplus">+    if (!prefDefBranch) return rv;</span>
<a href="#l72.2638"></a><span id="l72.2638"> </span>
<a href="#l72.2639"></a><span id="l72.2639">     // get original font size</span>
<a href="#l72.2640"></a><span id="l72.2640">     int32_t originalSize;</span>
<a href="#l72.2641"></a><span id="l72.2641">     rv = prefDefBranch-&gt;GetIntPref(prefStr.get(), &amp;originalSize);</span>
<a href="#l72.2642"></a><span id="l72.2642" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l72.2643"></a><span id="l72.2643" class="difflineminus">-      return rv;</span>
<a href="#l72.2644"></a><span id="l72.2644" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l72.2645"></a><span id="l72.2645"> </span>
<a href="#l72.2646"></a><span id="l72.2646">     // calculate percentage</span>
<a href="#l72.2647"></a><span id="l72.2647" class="difflineminus">-    *fontSizePercentage = originalSize ?</span>
<a href="#l72.2648"></a><span id="l72.2648" class="difflineminus">-                          (int32_t)((float)*fontPixelSize / (float)originalSize * 100) : 0;</span>
<a href="#l72.2649"></a><span id="l72.2649" class="difflineminus">-</span>
<a href="#l72.2650"></a><span id="l72.2650" class="difflineplus">+    *fontSizePercentage =</span>
<a href="#l72.2651"></a><span id="l72.2651" class="difflineplus">+        originalSize</span>
<a href="#l72.2652"></a><span id="l72.2652" class="difflineplus">+            ? (int32_t)((float)*fontPixelSize / (float)originalSize * 100)</span>
<a href="#l72.2653"></a><span id="l72.2653" class="difflineplus">+            : 0;</span>
<a href="#l72.2654"></a><span id="l72.2654">   }</span>
<a href="#l72.2655"></a><span id="l72.2655"> </span>
<a href="#l72.2656"></a><span id="l72.2656">   return NS_OK;</span>
<a href="#l72.2657"></a><span id="l72.2657"> }</span>
<a href="#l72.2658"></a><span id="l72.2658"> </span>
<a href="#l72.2659"></a><span id="l72.2659" class="difflineminus">-</span>
<a href="#l72.2660"></a><span id="l72.2660"> /**</span>
<a href="#l72.2661"></a><span id="l72.2661">  * This function synchronously converts an HTML document (as string)</span>
<a href="#l72.2662"></a><span id="l72.2662">  * to plaintext (as string) using the Gecko converter.</span>
<a href="#l72.2663"></a><span id="l72.2663">  *</span>
<a href="#l72.2664"></a><span id="l72.2664">  * @param flags see nsIDocumentEncoder.h</span>
<a href="#l72.2665"></a><span id="l72.2665">  */</span>
<a href="#l72.2666"></a><span id="l72.2666" class="difflineminus">-nsresult</span>
<a href="#l72.2667"></a><span id="l72.2667" class="difflineminus">-HTML2Plaintext(const nsString&amp; inString, nsString&amp; outString,</span>
<a href="#l72.2668"></a><span id="l72.2668" class="difflineminus">-               uint32_t flags, uint32_t wrapCol)</span>
<a href="#l72.2669"></a><span id="l72.2669" class="difflineminus">-{</span>
<a href="#l72.2670"></a><span id="l72.2670" class="difflineminus">-  nsCOMPtr&lt;nsIParserUtils&gt; utils =</span>
<a href="#l72.2671"></a><span id="l72.2671" class="difflineminus">-    do_GetService(NS_PARSERUTILS_CONTRACTID);</span>
<a href="#l72.2672"></a><span id="l72.2672" class="difflineplus">+nsresult HTML2Plaintext(const nsString &amp;inString, nsString &amp;outString,</span>
<a href="#l72.2673"></a><span id="l72.2673" class="difflineplus">+                        uint32_t flags, uint32_t wrapCol) {</span>
<a href="#l72.2674"></a><span id="l72.2674" class="difflineplus">+  nsCOMPtr&lt;nsIParserUtils&gt; utils = do_GetService(NS_PARSERUTILS_CONTRACTID);</span>
<a href="#l72.2675"></a><span id="l72.2675">   return utils-&gt;ConvertToPlainText(inString, flags, wrapCol, outString);</span>
<a href="#l72.2676"></a><span id="l72.2676"> }</span>
<a href="#l72.2677"></a><span id="l72.2677"> </span>
<a href="#l72.2678"></a><span id="l72.2678" class="difflineminus">-</span>
<a href="#l72.2679"></a><span id="l72.2679"> /**</span>
<a href="#l72.2680"></a><span id="l72.2680">  * This function synchronously sanitizes an HTML document (string-&gt;string)</span>
<a href="#l72.2681"></a><span id="l72.2681">  * using the Gecko nsTreeSanitizer.</span>
<a href="#l72.2682"></a><span id="l72.2682">  */</span>
<a href="#l72.2683"></a><span id="l72.2683" class="difflineminus">-nsresult</span>
<a href="#l72.2684"></a><span id="l72.2684" class="difflineminus">-HTMLSanitize(const nsString&amp; inString, nsString&amp; outString)</span>
<a href="#l72.2685"></a><span id="l72.2685" class="difflineminus">-{</span>
<a href="#l72.2686"></a><span id="l72.2686" class="difflineplus">+nsresult HTMLSanitize(const nsString &amp;inString, nsString &amp;outString) {</span>
<a href="#l72.2687"></a><span id="l72.2687">   // If you want to add alternative sanitization, you can insert a conditional</span>
<a href="#l72.2688"></a><span id="l72.2688">   // call to another sanitizer and an early return here.</span>
<a href="#l72.2689"></a><span id="l72.2689"> </span>
<a href="#l72.2690"></a><span id="l72.2690">   uint32_t flags = nsIParserUtils::SanitizerCidEmbedsOnly |</span>
<a href="#l72.2691"></a><span id="l72.2691">                    nsIParserUtils::SanitizerDropForms;</span>
<a href="#l72.2692"></a><span id="l72.2692"> </span>
<a href="#l72.2693"></a><span id="l72.2693">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l72.2694"></a><span id="l72.2694"> </span>
<a href="#l72.2695"></a><span id="l72.2695">   bool dropPresentational = true;</span>
<a href="#l72.2696"></a><span id="l72.2696">   bool dropMedia = false;</span>
<a href="#l72.2697"></a><span id="l72.2697">   prefs-&gt;GetBoolPref(</span>
<a href="#l72.2698"></a><span id="l72.2698" class="difflineminus">-    &quot;mailnews.display.html_sanitizer.drop_non_css_presentation&quot;,</span>
<a href="#l72.2699"></a><span id="l72.2699" class="difflineminus">-    &amp;dropPresentational);</span>
<a href="#l72.2700"></a><span id="l72.2700" class="difflineminus">-  prefs-&gt;GetBoolPref(</span>
<a href="#l72.2701"></a><span id="l72.2701" class="difflineminus">-    &quot;mailnews.display.html_sanitizer.drop_media&quot;,</span>
<a href="#l72.2702"></a><span id="l72.2702" class="difflineminus">-    &amp;dropMedia);</span>
<a href="#l72.2703"></a><span id="l72.2703" class="difflineplus">+      &quot;mailnews.display.html_sanitizer.drop_non_css_presentation&quot;,</span>
<a href="#l72.2704"></a><span id="l72.2704" class="difflineplus">+      &amp;dropPresentational);</span>
<a href="#l72.2705"></a><span id="l72.2705" class="difflineplus">+  prefs-&gt;GetBoolPref(&quot;mailnews.display.html_sanitizer.drop_media&quot;, &amp;dropMedia);</span>
<a href="#l72.2706"></a><span id="l72.2706">   if (dropPresentational)</span>
<a href="#l72.2707"></a><span id="l72.2707">     flags |= nsIParserUtils::SanitizerDropNonCSSPresentation;</span>
<a href="#l72.2708"></a><span id="l72.2708" class="difflineminus">-  if (dropMedia)</span>
<a href="#l72.2709"></a><span id="l72.2709" class="difflineminus">-    flags |= nsIParserUtils::SanitizerDropMedia;</span>
<a href="#l72.2710"></a><span id="l72.2710" class="difflineplus">+  if (dropMedia) flags |= nsIParserUtils::SanitizerDropMedia;</span>
<a href="#l72.2711"></a><span id="l72.2711"> </span>
<a href="#l72.2712"></a><span id="l72.2712">   nsCOMPtr&lt;nsIParserUtils&gt; utils = do_GetService(NS_PARSERUTILS_CONTRACTID);</span>
<a href="#l72.2713"></a><span id="l72.2713">   return utils-&gt;Sanitize(inString, flags, outString);</span>
<a href="#l72.2714"></a><span id="l72.2714"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.h</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.h</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -11,185 +11,196 @@</span>
<a href="#l73.4"></a><span id="l73.4"> #include &quot;nsIURI.h&quot;</span>
<a href="#l73.5"></a><span id="l73.5"> #include &quot;mozITXTToHTMLConv.h&quot;</span>
<a href="#l73.6"></a><span id="l73.6"> #include &quot;modmimee.h&quot;</span>
<a href="#l73.7"></a><span id="l73.7"> #include &quot;nsMsgAttachmentData.h&quot;</span>
<a href="#l73.8"></a><span id="l73.8"> </span>
<a href="#l73.9"></a><span id="l73.9"> // SHERRY - Need to get these out of here eventually</span>
<a href="#l73.10"></a><span id="l73.10"> </span>
<a href="#l73.11"></a><span id="l73.11"> #ifdef XP_UNIX</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-#undef Bool</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+#  undef Bool</span>
<a href="#l73.14"></a><span id="l73.14"> #endif</span>
<a href="#l73.15"></a><span id="l73.15"> </span>
<a href="#l73.16"></a><span id="l73.16" class="difflineminus">-</span>
<a href="#l73.17"></a><span id="l73.17" class="difflineminus">-</span>
<a href="#l73.18"></a><span id="l73.18"> #include &quot;mimei.h&quot;</span>
<a href="#l73.19"></a><span id="l73.19"> </span>
<a href="#l73.20"></a><span id="l73.20"> #ifdef __cplusplus</span>
<a href="#l73.21"></a><span id="l73.21"> extern &quot;C&quot; {</span>
<a href="#l73.22"></a><span id="l73.22"> #endif /* __cplusplus */</span>
<a href="#l73.23"></a><span id="l73.23"> </span>
<a href="#l73.24"></a><span id="l73.24"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l73.25"></a><span id="l73.25"> </span>
<a href="#l73.26"></a><span id="l73.26"> typedef struct _nsMIMESession nsMIMESession;</span>
<a href="#l73.27"></a><span id="l73.27"> </span>
<a href="#l73.28"></a><span id="l73.28"> /* stream functions */</span>
<a href="#l73.29"></a><span id="l73.29" class="difflineminus">-typedef unsigned int</span>
<a href="#l73.30"></a><span id="l73.30" class="difflineminus">-(*MKSessionWriteReadyFunc) (nsMIMESession *stream);</span>
<a href="#l73.31"></a><span id="l73.31" class="difflineplus">+typedef unsigned int (*MKSessionWriteReadyFunc)(nsMIMESession *stream);</span>
<a href="#l73.32"></a><span id="l73.32"> </span>
<a href="#l73.33"></a><span id="l73.33" class="difflineminus">-#define MAX_WRITE_READY (((unsigned) (~0) &lt;&lt; 1) &gt;&gt; 1)   /* must be &lt;= than MAXINT!!!!! */</span>
<a href="#l73.34"></a><span id="l73.34" class="difflineplus">+#define MAX_WRITE_READY \</span>
<a href="#l73.35"></a><span id="l73.35" class="difflineplus">+  (((unsigned)(~0) &lt;&lt; 1) &gt;&gt; 1) /* must be &lt;= than MAXINT!!!!! */</span>
<a href="#l73.36"></a><span id="l73.36"> </span>
<a href="#l73.37"></a><span id="l73.37" class="difflineminus">-typedef int</span>
<a href="#l73.38"></a><span id="l73.38" class="difflineminus">-(*MKSessionWriteFunc) (nsMIMESession *stream, const char *str, int32_t len);</span>
<a href="#l73.39"></a><span id="l73.39" class="difflineplus">+typedef int (*MKSessionWriteFunc)(nsMIMESession *stream, const char *str,</span>
<a href="#l73.40"></a><span id="l73.40" class="difflineplus">+                                  int32_t len);</span>
<a href="#l73.41"></a><span id="l73.41"> </span>
<a href="#l73.42"></a><span id="l73.42" class="difflineminus">-typedef void</span>
<a href="#l73.43"></a><span id="l73.43" class="difflineminus">-(*MKSessionCompleteFunc) (nsMIMESession *stream);</span>
<a href="#l73.44"></a><span id="l73.44" class="difflineplus">+typedef void (*MKSessionCompleteFunc)(nsMIMESession *stream);</span>
<a href="#l73.45"></a><span id="l73.45"> </span>
<a href="#l73.46"></a><span id="l73.46" class="difflineminus">-typedef void</span>
<a href="#l73.47"></a><span id="l73.47" class="difflineminus">-(*MKSessionAbortFunc) (nsMIMESession *stream, int status);</span>
<a href="#l73.48"></a><span id="l73.48" class="difflineplus">+typedef void (*MKSessionAbortFunc)(nsMIMESession *stream, int status);</span>
<a href="#l73.49"></a><span id="l73.49"> </span>
<a href="#l73.50"></a><span id="l73.50"> /* streamclass function */</span>
<a href="#l73.51"></a><span id="l73.51"> struct _nsMIMESession {</span>
<a href="#l73.52"></a><span id="l73.52" class="difflineplus">+  const char *name; /* Just for diagnostics */</span>
<a href="#l73.53"></a><span id="l73.53"> </span>
<a href="#l73.54"></a><span id="l73.54" class="difflineminus">-    const char * name;         /* Just for diagnostics */</span>
<a href="#l73.55"></a><span id="l73.55" class="difflineminus">-</span>
<a href="#l73.56"></a><span id="l73.56" class="difflineminus">-    void       * window_id;    /* used for progress messages, etc. */</span>
<a href="#l73.57"></a><span id="l73.57" class="difflineplus">+  void *window_id; /* used for progress messages, etc. */</span>
<a href="#l73.58"></a><span id="l73.58"> </span>
<a href="#l73.59"></a><span id="l73.59" class="difflineminus">-    void       * data_object;  /* a pointer to whatever</span>
<a href="#l73.60"></a><span id="l73.60" class="difflineminus">-                                * structure you wish to have</span>
<a href="#l73.61"></a><span id="l73.61" class="difflineminus">-                                * passed to the routines below</span>
<a href="#l73.62"></a><span id="l73.62" class="difflineminus">-                                * during writes, etc...</span>
<a href="#l73.63"></a><span id="l73.63" class="difflineminus">-                                *</span>
<a href="#l73.64"></a><span id="l73.64" class="difflineminus">-                                * this data object should hold</span>
<a href="#l73.65"></a><span id="l73.65" class="difflineminus">-                                * the document, document</span>
<a href="#l73.66"></a><span id="l73.66" class="difflineminus">-                                * structure or a pointer to the</span>
<a href="#l73.67"></a><span id="l73.67" class="difflineminus">-                                * document.</span>
<a href="#l73.68"></a><span id="l73.68" class="difflineminus">-                                */</span>
<a href="#l73.69"></a><span id="l73.69" class="difflineplus">+  void *data_object; /* a pointer to whatever</span>
<a href="#l73.70"></a><span id="l73.70" class="difflineplus">+                      * structure you wish to have</span>
<a href="#l73.71"></a><span id="l73.71" class="difflineplus">+                      * passed to the routines below</span>
<a href="#l73.72"></a><span id="l73.72" class="difflineplus">+                      * during writes, etc...</span>
<a href="#l73.73"></a><span id="l73.73" class="difflineplus">+                      *</span>
<a href="#l73.74"></a><span id="l73.74" class="difflineplus">+                      * this data object should hold</span>
<a href="#l73.75"></a><span id="l73.75" class="difflineplus">+                      * the document, document</span>
<a href="#l73.76"></a><span id="l73.76" class="difflineplus">+                      * structure or a pointer to the</span>
<a href="#l73.77"></a><span id="l73.77" class="difflineplus">+                      * document.</span>
<a href="#l73.78"></a><span id="l73.78" class="difflineplus">+                      */</span>
<a href="#l73.79"></a><span id="l73.79"> </span>
<a href="#l73.80"></a><span id="l73.80" class="difflineminus">-    MKSessionWriteReadyFunc  is_write_ready;   /* checks to see if the stream is ready</span>
<a href="#l73.81"></a><span id="l73.81" class="difflineminus">-                                               * for writing.  Returns 0 if not ready</span>
<a href="#l73.82"></a><span id="l73.82" class="difflineminus">-                                               * or the number of bytes that it can</span>
<a href="#l73.83"></a><span id="l73.83" class="difflineminus">-                                               * accept for write</span>
<a href="#l73.84"></a><span id="l73.84" class="difflineminus">-                                               */</span>
<a href="#l73.85"></a><span id="l73.85" class="difflineminus">-    MKSessionWriteFunc       put_block;        /* writes a block of data to the stream */</span>
<a href="#l73.86"></a><span id="l73.86" class="difflineminus">-    MKSessionCompleteFunc    complete;         /* normal end */</span>
<a href="#l73.87"></a><span id="l73.87" class="difflineminus">-    MKSessionAbortFunc       abort;            /* abnormal end */</span>
<a href="#l73.88"></a><span id="l73.88" class="difflineplus">+  MKSessionWriteReadyFunc is_write_ready; /* checks to see if the stream is</span>
<a href="#l73.89"></a><span id="l73.89" class="difflineplus">+                                           * ready for writing.  Returns 0 if</span>
<a href="#l73.90"></a><span id="l73.90" class="difflineplus">+                                           * not ready or the number of bytes</span>
<a href="#l73.91"></a><span id="l73.91" class="difflineplus">+                                           * that it can accept for write</span>
<a href="#l73.92"></a><span id="l73.92" class="difflineplus">+                                           */</span>
<a href="#l73.93"></a><span id="l73.93" class="difflineplus">+  MKSessionWriteFunc put_block;   /* writes a block of data to the stream */</span>
<a href="#l73.94"></a><span id="l73.94" class="difflineplus">+  MKSessionCompleteFunc complete; /* normal end */</span>
<a href="#l73.95"></a><span id="l73.95" class="difflineplus">+  MKSessionAbortFunc abort;       /* abnormal end */</span>
<a href="#l73.96"></a><span id="l73.96"> </span>
<a href="#l73.97"></a><span id="l73.97" class="difflineminus">-    bool                    is_multipart;    /* is the stream part of a multipart sequence */</span>
<a href="#l73.98"></a><span id="l73.98" class="difflineplus">+  bool is_multipart; /* is the stream part of a multipart sequence */</span>
<a href="#l73.99"></a><span id="l73.99"> };</span>
<a href="#l73.100"></a><span id="l73.100"> </span>
<a href="#l73.101"></a><span id="l73.101"> /*</span>
<a href="#l73.102"></a><span id="l73.102">  * This is for the reworked mime parser.</span>
<a href="#l73.103"></a><span id="l73.103">  */</span>
<a href="#l73.104"></a><span id="l73.104" class="difflineminus">-class mime_stream_data {           /* This object is the state we pass around</span>
<a href="#l73.105"></a><span id="l73.105" class="difflineminus">-                                       amongst the various stream functions</span>
<a href="#l73.106"></a><span id="l73.106" class="difflineminus">-                                       used by MIME_MessageConverter(). */</span>
<a href="#l73.107"></a><span id="l73.107" class="difflineminus">-public:</span>
<a href="#l73.108"></a><span id="l73.108" class="difflineplus">+class mime_stream_data { /* This object is the state we pass around</span>
<a href="#l73.109"></a><span id="l73.109" class="difflineplus">+                             amongst the various stream functions</span>
<a href="#l73.110"></a><span id="l73.110" class="difflineplus">+                             used by MIME_MessageConverter(). */</span>
<a href="#l73.111"></a><span id="l73.111" class="difflineplus">+ public:</span>
<a href="#l73.112"></a><span id="l73.112">   mime_stream_data();</span>
<a href="#l73.113"></a><span id="l73.113"> </span>
<a href="#l73.114"></a><span id="l73.114" class="difflineminus">-  char                *url_name;</span>
<a href="#l73.115"></a><span id="l73.115" class="difflineminus">-  char                *orig_url_name; /* original url name */</span>
<a href="#l73.116"></a><span id="l73.116" class="difflineplus">+  char *url_name;</span>
<a href="#l73.117"></a><span id="l73.117" class="difflineplus">+  char *orig_url_name; /* original url name */</span>
<a href="#l73.118"></a><span id="l73.118">   nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l73.119"></a><span id="l73.119" class="difflineminus">-  nsMimeOutputType    format_out;</span>
<a href="#l73.120"></a><span id="l73.120" class="difflineminus">-  void                *pluginObj2;  /* The new XP-COM stream converter object */</span>
<a href="#l73.121"></a><span id="l73.121" class="difflineminus">-  nsMIMESession       *istream;     /* Holdover - new stream we're writing out image data-if any. */</span>
<a href="#l73.122"></a><span id="l73.122" class="difflineminus">-  MimeObject          *obj;         /* The root parser object */</span>
<a href="#l73.123"></a><span id="l73.123" class="difflineminus">-  MimeDisplayOptions  *options;     /* Data for communicating with libmime.a */</span>
<a href="#l73.124"></a><span id="l73.124" class="difflineminus">-  MimeHeaders         *headers;     /* Copy of outer most mime header */</span>
<a href="#l73.125"></a><span id="l73.125" class="difflineplus">+  nsMimeOutputType format_out;</span>
<a href="#l73.126"></a><span id="l73.126" class="difflineplus">+  void *pluginObj2; /* The new XP-COM stream converter object */</span>
<a href="#l73.127"></a><span id="l73.127" class="difflineplus">+  nsMIMESession</span>
<a href="#l73.128"></a><span id="l73.128" class="difflineplus">+      *istream; /* Holdover - new stream we're writing out image data-if any. */</span>
<a href="#l73.129"></a><span id="l73.129" class="difflineplus">+  MimeObject *obj;             /* The root parser object */</span>
<a href="#l73.130"></a><span id="l73.130" class="difflineplus">+  MimeDisplayOptions *options; /* Data for communicating with libmime.a */</span>
<a href="#l73.131"></a><span id="l73.131" class="difflineplus">+  MimeHeaders *headers;        /* Copy of outer most mime header */</span>
<a href="#l73.132"></a><span id="l73.132"> </span>
<a href="#l73.133"></a><span id="l73.133" class="difflineminus">-  nsIMimeEmitter      *output_emitter;  /* Output emitter engine for libmime */</span>
<a href="#l73.134"></a><span id="l73.134" class="difflineminus">-  bool                firstCheck;   /* Is this the first look at the stream data */</span>
<a href="#l73.135"></a><span id="l73.135" class="difflineplus">+  nsIMimeEmitter *output_emitter; /* Output emitter engine for libmime */</span>
<a href="#l73.136"></a><span id="l73.136" class="difflineplus">+  bool firstCheck; /* Is this the first look at the stream data */</span>
<a href="#l73.137"></a><span id="l73.137"> };</span>
<a href="#l73.138"></a><span id="l73.138"> </span>
<a href="#l73.139"></a><span id="l73.139"> //</span>
<a href="#l73.140"></a><span id="l73.140"> // This object is the state we use for loading drafts and templates...</span>
<a href="#l73.141"></a><span id="l73.141"> //</span>
<a href="#l73.142"></a><span id="l73.142" class="difflineminus">-class mime_draft_data</span>
<a href="#l73.143"></a><span id="l73.143" class="difflineminus">-{</span>
<a href="#l73.144"></a><span id="l73.144" class="difflineminus">-public:</span>
<a href="#l73.145"></a><span id="l73.145" class="difflineplus">+class mime_draft_data {</span>
<a href="#l73.146"></a><span id="l73.146" class="difflineplus">+ public:</span>
<a href="#l73.147"></a><span id="l73.147">   mime_draft_data();</span>
<a href="#l73.148"></a><span id="l73.148" class="difflineminus">-  char                *url_name;           // original url name */</span>
<a href="#l73.149"></a><span id="l73.149" class="difflineminus">-  nsMimeOutputType    format_out;          // intended output format; should be FO_OPEN_DRAFT */</span>
<a href="#l73.150"></a><span id="l73.150" class="difflineminus">-  nsMIMESession       *stream;             // not used for now</span>
<a href="#l73.151"></a><span id="l73.151" class="difflineminus">-  MimeObject          *obj;                // The root</span>
<a href="#l73.152"></a><span id="l73.152" class="difflineminus">-  MimeDisplayOptions  *options;            // data for communicating with libmime</span>
<a href="#l73.153"></a><span id="l73.153" class="difflineminus">-  MimeHeaders         *headers;            // Copy of outer most mime header</span>
<a href="#l73.154"></a><span id="l73.154" class="difflineminus">-  nsTArray&lt;nsMsgAttachedFile*&gt; attachments;// attachments</span>
<a href="#l73.155"></a><span id="l73.155" class="difflineminus">-  nsMsgAttachedFile   *messageBody;        // message body</span>
<a href="#l73.156"></a><span id="l73.156" class="difflineminus">-  nsMsgAttachedFile   *curAttachment;       // temp</span>
<a href="#l73.157"></a><span id="l73.157" class="difflineplus">+  char *url_name;  // original url name */</span>
<a href="#l73.158"></a><span id="l73.158" class="difflineplus">+  nsMimeOutputType</span>
<a href="#l73.159"></a><span id="l73.159" class="difflineplus">+      format_out;         // intended output format; should be FO_OPEN_DRAFT */</span>
<a href="#l73.160"></a><span id="l73.160" class="difflineplus">+  nsMIMESession *stream;  // not used for now</span>
<a href="#l73.161"></a><span id="l73.161" class="difflineplus">+  MimeObject *obj;        // The root</span>
<a href="#l73.162"></a><span id="l73.162" class="difflineplus">+  MimeDisplayOptions *options;  // data for communicating with libmime</span>
<a href="#l73.163"></a><span id="l73.163" class="difflineplus">+  MimeHeaders *headers;         // Copy of outer most mime header</span>
<a href="#l73.164"></a><span id="l73.164" class="difflineplus">+  nsTArray&lt;nsMsgAttachedFile *&gt; attachments;  // attachments</span>
<a href="#l73.165"></a><span id="l73.165" class="difflineplus">+  nsMsgAttachedFile *messageBody;             // message body</span>
<a href="#l73.166"></a><span id="l73.166" class="difflineplus">+  nsMsgAttachedFile *curAttachment;           // temp</span>
<a href="#l73.167"></a><span id="l73.167"> </span>
<a href="#l73.168"></a><span id="l73.168" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l73.169"></a><span id="l73.169" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; tmpFileStream;      // output file handle</span>
<a href="#l73.170"></a><span id="l73.170" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l73.171"></a><span id="l73.171" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; tmpFileStream;  // output file handle</span>
<a href="#l73.172"></a><span id="l73.172"> </span>
<a href="#l73.173"></a><span id="l73.173" class="difflineminus">-  MimeDecoderData     *decoder_data;</span>
<a href="#l73.174"></a><span id="l73.174" class="difflineminus">-  char                *mailcharset;        // get it from CHARSET of Content-Type</span>
<a href="#l73.175"></a><span id="l73.175" class="difflineminus">-  bool                forwardInline;</span>
<a href="#l73.176"></a><span id="l73.176" class="difflineminus">-  bool                forwardInlineFilter;</span>
<a href="#l73.177"></a><span id="l73.177" class="difflineminus">-  bool                overrideComposeFormat; // Override compose format (for forward inline).</span>
<a href="#l73.178"></a><span id="l73.178" class="difflineminus">-  nsString            forwardToAddress;</span>
<a href="#l73.179"></a><span id="l73.179" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIdentity&gt;      identity;</span>
<a href="#l73.180"></a><span id="l73.180" class="difflineminus">-  char                *originalMsgURI;     // the original URI of the message we are currently processing</span>
<a href="#l73.181"></a><span id="l73.181" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt;         origMsgHdr;</span>
<a href="#l73.182"></a><span id="l73.182" class="difflineplus">+  MimeDecoderData *decoder_data;</span>
<a href="#l73.183"></a><span id="l73.183" class="difflineplus">+  char *mailcharset;  // get it from CHARSET of Content-Type</span>
<a href="#l73.184"></a><span id="l73.184" class="difflineplus">+  bool forwardInline;</span>
<a href="#l73.185"></a><span id="l73.185" class="difflineplus">+  bool forwardInlineFilter;</span>
<a href="#l73.186"></a><span id="l73.186" class="difflineplus">+  bool overrideComposeFormat;  // Override compose format (for forward inline).</span>
<a href="#l73.187"></a><span id="l73.187" class="difflineplus">+  nsString forwardToAddress;</span>
<a href="#l73.188"></a><span id="l73.188" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l73.189"></a><span id="l73.189" class="difflineplus">+  char *originalMsgURI;  // the original URI of the message we are currently</span>
<a href="#l73.190"></a><span id="l73.190" class="difflineplus">+                         // processing</span>
<a href="#l73.191"></a><span id="l73.191" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; origMsgHdr;</span>
<a href="#l73.192"></a><span id="l73.192"> };</span>
<a href="#l73.193"></a><span id="l73.193"> </span>
<a href="#l73.194"></a><span id="l73.194"> ////////////////////////////////////////////////////////////////</span>
<a href="#l73.195"></a><span id="l73.195"> // Bridge routines for legacy mime code</span>
<a href="#l73.196"></a><span id="l73.196"> ////////////////////////////////////////////////////////////////</span>
<a href="#l73.197"></a><span id="l73.197"> </span>
<a href="#l73.198"></a><span id="l73.198"> // Create bridge stream for libmime</span>
<a href="#l73.199"></a><span id="l73.199" class="difflineminus">-extern &quot;C&quot;</span>
<a href="#l73.200"></a><span id="l73.200" class="difflineminus">-void         *mime_bridge_create_display_stream(nsIMimeEmitter      *newEmitter,</span>
<a href="#l73.201"></a><span id="l73.201" class="difflineminus">-                                                nsStreamConverter   *newPluginObj2,</span>
<a href="#l73.202"></a><span id="l73.202" class="difflineminus">-                                                nsIURI              *uri,</span>
<a href="#l73.203"></a><span id="l73.203" class="difflineminus">-                                                nsMimeOutputType    format_out,</span>
<a href="#l73.204"></a><span id="l73.204" class="difflineminus">-                                                uint32_t            whattodo,</span>
<a href="#l73.205"></a><span id="l73.205" class="difflineminus">-                                                nsIChannel          *aChannel);</span>
<a href="#l73.206"></a><span id="l73.206" class="difflineplus">+extern &quot;C&quot; void *mime_bridge_create_display_stream(</span>
<a href="#l73.207"></a><span id="l73.207" class="difflineplus">+    nsIMimeEmitter *newEmitter, nsStreamConverter *newPluginObj2, nsIURI *uri,</span>
<a href="#l73.208"></a><span id="l73.208" class="difflineplus">+    nsMimeOutputType format_out, uint32_t whattodo, nsIChannel *aChannel);</span>
<a href="#l73.209"></a><span id="l73.209"> </span>
<a href="#l73.210"></a><span id="l73.210"> // To get the mime emitter...</span>
<a href="#l73.211"></a><span id="l73.211" class="difflineminus">-extern &quot;C&quot; nsIMimeEmitter   *GetMimeEmitter(MimeDisplayOptions *opt);</span>
<a href="#l73.212"></a><span id="l73.212" class="difflineplus">+extern &quot;C&quot; nsIMimeEmitter *GetMimeEmitter(MimeDisplayOptions *opt);</span>
<a href="#l73.213"></a><span id="l73.213"> </span>
<a href="#l73.214"></a><span id="l73.214"> // To support 2 types of emitters...we need these routines :-(</span>
<a href="#l73.215"></a><span id="l73.215" class="difflineminus">-extern &quot;C&quot; nsresult     mimeSetNewURL(nsMIMESession *stream, char *url);</span>
<a href="#l73.216"></a><span id="l73.216" class="difflineminus">-extern &quot;C&quot; nsresult     mimeEmitterAddAttachmentField(MimeDisplayOptions *opt, const char *field, const char *value);</span>
<a href="#l73.217"></a><span id="l73.217" class="difflineminus">-extern &quot;C&quot; nsresult     mimeEmitterAddHeaderField(MimeDisplayOptions *opt, const char *field, const char *value);</span>
<a href="#l73.218"></a><span id="l73.218" class="difflineminus">-extern &quot;C&quot; nsresult     mimeEmitterAddAllHeaders(MimeDisplayOptions *opt, const char *allheaders, const int32_t allheadersize);</span>
<a href="#l73.219"></a><span id="l73.219" class="difflineminus">-extern &quot;C&quot; nsresult     mimeEmitterStartAttachment(MimeDisplayOptions *opt, const char *name, const char *contentType, const char *url,</span>
<a href="#l73.220"></a><span id="l73.220" class="difflineminus">-                                                   bool aIsExternalAttachment);</span>
<a href="#l73.221"></a><span id="l73.221" class="difflineminus">-extern &quot;C&quot; nsresult     mimeEmitterEndAttachment(MimeDisplayOptions *opt);</span>
<a href="#l73.222"></a><span id="l73.222" class="difflineminus">-extern &quot;C&quot; nsresult     mimeEmitterEndAllAttachments(MimeDisplayOptions *opt);</span>
<a href="#l73.223"></a><span id="l73.223" class="difflineminus">-extern &quot;C&quot; nsresult     mimeEmitterStartBody(MimeDisplayOptions *opt, bool bodyOnly, const char *msgID, const char *outCharset);</span>
<a href="#l73.224"></a><span id="l73.224" class="difflineminus">-extern &quot;C&quot; nsresult     mimeEmitterEndBody(MimeDisplayOptions *opt);</span>
<a href="#l73.225"></a><span id="l73.225" class="difflineminus">-extern &quot;C&quot; nsresult     mimeEmitterEndHeader(MimeDisplayOptions *opt, MimeObject *obj);</span>
<a href="#l73.226"></a><span id="l73.226" class="difflineminus">-extern &quot;C&quot; nsresult     mimeEmitterStartHeader(MimeDisplayOptions *opt, bool rootMailHeader, bool headerOnly, const char *msgID,</span>
<a href="#l73.227"></a><span id="l73.227" class="difflineminus">-                                               const char *outCharset);</span>
<a href="#l73.228"></a><span id="l73.228" class="difflineminus">-extern &quot;C&quot; nsresult     mimeEmitterUpdateCharacterSet(MimeDisplayOptions *opt, const char *aCharset);</span>
<a href="#l73.229"></a><span id="l73.229" class="difflineplus">+extern &quot;C&quot; nsresult mimeSetNewURL(nsMIMESession *stream, char *url);</span>
<a href="#l73.230"></a><span id="l73.230" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterAddAttachmentField(MimeDisplayOptions *opt,</span>
<a href="#l73.231"></a><span id="l73.231" class="difflineplus">+                                                  const char *field,</span>
<a href="#l73.232"></a><span id="l73.232" class="difflineplus">+                                                  const char *value);</span>
<a href="#l73.233"></a><span id="l73.233" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterAddHeaderField(MimeDisplayOptions *opt,</span>
<a href="#l73.234"></a><span id="l73.234" class="difflineplus">+                                              const char *field,</span>
<a href="#l73.235"></a><span id="l73.235" class="difflineplus">+                                              const char *value);</span>
<a href="#l73.236"></a><span id="l73.236" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterAddAllHeaders(MimeDisplayOptions *opt,</span>
<a href="#l73.237"></a><span id="l73.237" class="difflineplus">+                                             const char *allheaders,</span>
<a href="#l73.238"></a><span id="l73.238" class="difflineplus">+                                             const int32_t allheadersize);</span>
<a href="#l73.239"></a><span id="l73.239" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterStartAttachment(MimeDisplayOptions *opt,</span>
<a href="#l73.240"></a><span id="l73.240" class="difflineplus">+                                               const char *name,</span>
<a href="#l73.241"></a><span id="l73.241" class="difflineplus">+                                               const char *contentType,</span>
<a href="#l73.242"></a><span id="l73.242" class="difflineplus">+                                               const char *url,</span>
<a href="#l73.243"></a><span id="l73.243" class="difflineplus">+                                               bool aIsExternalAttachment);</span>
<a href="#l73.244"></a><span id="l73.244" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterEndAttachment(MimeDisplayOptions *opt);</span>
<a href="#l73.245"></a><span id="l73.245" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterEndAllAttachments(MimeDisplayOptions *opt);</span>
<a href="#l73.246"></a><span id="l73.246" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterStartBody(MimeDisplayOptions *opt, bool bodyOnly,</span>
<a href="#l73.247"></a><span id="l73.247" class="difflineplus">+                                         const char *msgID,</span>
<a href="#l73.248"></a><span id="l73.248" class="difflineplus">+                                         const char *outCharset);</span>
<a href="#l73.249"></a><span id="l73.249" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterEndBody(MimeDisplayOptions *opt);</span>
<a href="#l73.250"></a><span id="l73.250" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterEndHeader(MimeDisplayOptions *opt,</span>
<a href="#l73.251"></a><span id="l73.251" class="difflineplus">+                                         MimeObject *obj);</span>
<a href="#l73.252"></a><span id="l73.252" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterStartHeader(MimeDisplayOptions *opt,</span>
<a href="#l73.253"></a><span id="l73.253" class="difflineplus">+                                           bool rootMailHeader, bool headerOnly,</span>
<a href="#l73.254"></a><span id="l73.254" class="difflineplus">+                                           const char *msgID,</span>
<a href="#l73.255"></a><span id="l73.255" class="difflineplus">+                                           const char *outCharset);</span>
<a href="#l73.256"></a><span id="l73.256" class="difflineplus">+extern &quot;C&quot; nsresult mimeEmitterUpdateCharacterSet(MimeDisplayOptions *opt,</span>
<a href="#l73.257"></a><span id="l73.257" class="difflineplus">+                                                  const char *aCharset);</span>
<a href="#l73.258"></a><span id="l73.258"> </span>
<a href="#l73.259"></a><span id="l73.259" class="difflineminus">-extern &quot;C&quot; nsresult     MimeGetAttachmentList(MimeObject *tobj, const char *aMessageURL, nsMsgAttachmentData **data);</span>
<a href="#l73.260"></a><span id="l73.260" class="difflineplus">+extern &quot;C&quot; nsresult MimeGetAttachmentList(MimeObject *tobj,</span>
<a href="#l73.261"></a><span id="l73.261" class="difflineplus">+                                          const char *aMessageURL,</span>
<a href="#l73.262"></a><span id="l73.262" class="difflineplus">+                                          nsMsgAttachmentData **data);</span>
<a href="#l73.263"></a><span id="l73.263"> </span>
<a href="#l73.264"></a><span id="l73.264"> /* To Get the connection to prefs service manager */</span>
<a href="#l73.265"></a><span id="l73.265" class="difflineminus">-extern &quot;C&quot; nsIPrefBranch      *GetPrefBranch(MimeDisplayOptions *opt);</span>
<a href="#l73.266"></a><span id="l73.266" class="difflineplus">+extern &quot;C&quot; nsIPrefBranch *GetPrefBranch(MimeDisplayOptions *opt);</span>
<a href="#l73.267"></a><span id="l73.267"> </span>
<a href="#l73.268"></a><span id="l73.268"> // Get the text converter...</span>
<a href="#l73.269"></a><span id="l73.269" class="difflineminus">-mozITXTToHTMLConv           *GetTextConverter(MimeDisplayOptions *opt);</span>
<a href="#l73.270"></a><span id="l73.270" class="difflineplus">+mozITXTToHTMLConv *GetTextConverter(MimeDisplayOptions *opt);</span>
<a href="#l73.271"></a><span id="l73.271"> </span>
<a href="#l73.272"></a><span id="l73.272" class="difflineminus">-nsresult</span>
<a href="#l73.273"></a><span id="l73.273" class="difflineminus">-HTML2Plaintext(const nsString&amp; inString, nsString&amp; outString,</span>
<a href="#l73.274"></a><span id="l73.274" class="difflineminus">-               uint32_t flags, uint32_t wrapCol);</span>
<a href="#l73.275"></a><span id="l73.275" class="difflineminus">-nsresult</span>
<a href="#l73.276"></a><span id="l73.276" class="difflineminus">-HTMLSanitize(const nsString&amp; inString, nsString&amp; outString);</span>
<a href="#l73.277"></a><span id="l73.277" class="difflineplus">+nsresult HTML2Plaintext(const nsString &amp;inString, nsString &amp;outString,</span>
<a href="#l73.278"></a><span id="l73.278" class="difflineplus">+                        uint32_t flags, uint32_t wrapCol);</span>
<a href="#l73.279"></a><span id="l73.279" class="difflineplus">+nsresult HTMLSanitize(const nsString &amp;inString, nsString &amp;outString);</span>
<a href="#l73.280"></a><span id="l73.280"> </span>
<a href="#l73.281"></a><span id="l73.281" class="difflineminus">-extern &quot;C&quot; char             *MimeGetStringByID(int32_t stringID);</span>
<a href="#l73.282"></a><span id="l73.282" class="difflineminus">-extern &quot;C&quot; char             *MimeGetStringByName(const char16_t *stringName);</span>
<a href="#l73.283"></a><span id="l73.283" class="difflineplus">+extern &quot;C&quot; char *MimeGetStringByID(int32_t stringID);</span>
<a href="#l73.284"></a><span id="l73.284" class="difflineplus">+extern &quot;C&quot; char *MimeGetStringByName(const char16_t *stringName);</span>
<a href="#l73.285"></a><span id="l73.285"> </span>
<a href="#l73.286"></a><span id="l73.286"> // Utility to create a nsIURI object...</span>
<a href="#l73.287"></a><span id="l73.287" class="difflineminus">-extern &quot;C&quot; nsresult         nsMimeNewURI(nsIURI** aInstancePtrResult, const char *aSpec, nsIURI *aBase);</span>
<a href="#l73.288"></a><span id="l73.288" class="difflineplus">+extern &quot;C&quot; nsresult nsMimeNewURI(nsIURI **aInstancePtrResult, const char *aSpec,</span>
<a href="#l73.289"></a><span id="l73.289" class="difflineplus">+                                 nsIURI *aBase);</span>
<a href="#l73.290"></a><span id="l73.290"> </span>
<a href="#l73.291"></a><span id="l73.291" class="difflineminus">-extern &quot;C&quot; nsresult SetMailCharacterSetToMsgWindow(MimeObject *obj, const char *aCharacterSet);</span>
<a href="#l73.292"></a><span id="l73.292" class="difflineplus">+extern &quot;C&quot; nsresult SetMailCharacterSetToMsgWindow(MimeObject *obj,</span>
<a href="#l73.293"></a><span id="l73.293" class="difflineplus">+                                                   const char *aCharacterSet);</span>
<a href="#l73.294"></a><span id="l73.294"> </span>
<a href="#l73.295"></a><span id="l73.295" class="difflineminus">-extern &quot;C&quot;  nsresult GetMailNewsFont(MimeObject *obj, bool styleFixed, int32_t *fontPixelSize, int32_t *fontSizePercentage, nsCString&amp; fontLang);</span>
<a href="#l73.296"></a><span id="l73.296" class="difflineminus">-</span>
<a href="#l73.297"></a><span id="l73.297" class="difflineplus">+extern &quot;C&quot; nsresult GetMailNewsFont(MimeObject *obj, bool styleFixed,</span>
<a href="#l73.298"></a><span id="l73.298" class="difflineplus">+                                    int32_t *fontPixelSize,</span>
<a href="#l73.299"></a><span id="l73.299" class="difflineplus">+                                    int32_t *fontSizePercentage,</span>
<a href="#l73.300"></a><span id="l73.300" class="difflineplus">+                                    nsCString &amp;fontLang);</span>
<a href="#l73.301"></a><span id="l73.301"> </span>
<a href="#l73.302"></a><span id="l73.302"> #ifdef __cplusplus</span>
<a href="#l73.303"></a><span id="l73.303"> }</span>
<a href="#l73.304"></a><span id="l73.304"> #endif /* __cplusplus */</span>
<a href="#l73.305"></a><span id="l73.305"> </span>
<a href="#l73.306"></a><span id="l73.306"> #endif /* _MIMEMOZ_H_ */</span>
<a href="#l73.307"></a><span id="l73.307" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/mailnews/mime/src/mimempar.cpp</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/mailnews/mime/src/mimempar.cpp</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -3,19 +3,18 @@</span>
<a href="#l74.4"></a><span id="l74.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l74.5"></a><span id="l74.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l74.6"></a><span id="l74.6"> </span>
<a href="#l74.7"></a><span id="l74.7"> #include &quot;mimempar.h&quot;</span>
<a href="#l74.8"></a><span id="l74.8"> #include &quot;prlog.h&quot;</span>
<a href="#l74.9"></a><span id="l74.9"> </span>
<a href="#l74.10"></a><span id="l74.10"> #define MIME_SUPERCLASS mimeMultipartClass</span>
<a href="#l74.11"></a><span id="l74.11"> MimeDefClass(MimeMultipartParallel, MimeMultipartParallelClass,</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-       mimeMultipartParallelClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+             mimeMultipartParallelClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l74.14"></a><span id="l74.14"> </span>
<a href="#l74.15"></a><span id="l74.15" class="difflineminus">-static int</span>
<a href="#l74.16"></a><span id="l74.16" class="difflineminus">-MimeMultipartParallelClassInitialize(MimeMultipartParallelClass *clazz)</span>
<a href="#l74.17"></a><span id="l74.17" class="difflineminus">-{</span>
<a href="#l74.18"></a><span id="l74.18" class="difflineplus">+static int MimeMultipartParallelClassInitialize(</span>
<a href="#l74.19"></a><span id="l74.19" class="difflineplus">+    MimeMultipartParallelClass *clazz) {</span>
<a href="#l74.20"></a><span id="l74.20"> #ifdef DEBUG</span>
<a href="#l74.21"></a><span id="l74.21" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l74.22"></a><span id="l74.22" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l74.23"></a><span id="l74.23">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l74.24"></a><span id="l74.24"> #endif</span>
<a href="#l74.25"></a><span id="l74.25">   return 0;</span>
<a href="#l74.26"></a><span id="l74.26"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/mailnews/mime/src/mimempar.h</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/mailnews/mime/src/mimempar.h</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -9,24 +9,24 @@</span>
<a href="#l75.4"></a><span id="l75.4"> #include &quot;mimemult.h&quot;</span>
<a href="#l75.5"></a><span id="l75.5"> </span>
<a href="#l75.6"></a><span id="l75.6"> /* The MimeMultipartParallel class implements the multipart/parallel MIME</span>
<a href="#l75.7"></a><span id="l75.7">    container, which is currently no different from multipart/mixed, since</span>
<a href="#l75.8"></a><span id="l75.8">    it's not clear that there's anything useful it could do differently.</span>
<a href="#l75.9"></a><span id="l75.9">  */</span>
<a href="#l75.10"></a><span id="l75.10"> </span>
<a href="#l75.11"></a><span id="l75.11"> typedef struct MimeMultipartParallelClass MimeMultipartParallelClass;</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-typedef struct MimeMultipartParallel      MimeMultipartParallel;</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+typedef struct MimeMultipartParallel MimeMultipartParallel;</span>
<a href="#l75.14"></a><span id="l75.14"> </span>
<a href="#l75.15"></a><span id="l75.15"> struct MimeMultipartParallelClass {</span>
<a href="#l75.16"></a><span id="l75.16">   MimeMultipartClass multipart;</span>
<a href="#l75.17"></a><span id="l75.17"> };</span>
<a href="#l75.18"></a><span id="l75.18"> </span>
<a href="#l75.19"></a><span id="l75.19"> extern MimeMultipartParallelClass mimeMultipartParallelClass;</span>
<a href="#l75.20"></a><span id="l75.20"> </span>
<a href="#l75.21"></a><span id="l75.21"> struct MimeMultipartParallel {</span>
<a href="#l75.22"></a><span id="l75.22">   MimeMultipart multipart;</span>
<a href="#l75.23"></a><span id="l75.23"> };</span>
<a href="#l75.24"></a><span id="l75.24"> </span>
<a href="#l75.25"></a><span id="l75.25" class="difflineminus">-#define MimeMultipartParallelClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l75.26"></a><span id="l75.26" class="difflineminus">-  { MimeMultipartClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l75.27"></a><span id="l75.27" class="difflineplus">+#define MimeMultipartParallelClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l75.28"></a><span id="l75.28" class="difflineplus">+  { MimeMultipartClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l75.29"></a><span id="l75.29"> </span>
<a href="#l75.30"></a><span id="l75.30"> #endif /* _MIMEMPAR_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/mailnews/mime/src/mimemrel.cpp</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/mailnews/mime/src/mimemrel.cpp</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l76.4"></a><span id="l76.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l76.5"></a><span id="l76.5">  *</span>
<a href="#l76.6"></a><span id="l76.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l76.7"></a><span id="l76.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l76.8"></a><span id="l76.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l76.9"></a><span id="l76.9" class="difflineminus">- * This Original Code has been modified by IBM Corporation. Modifications made by IBM</span>
<a href="#l76.10"></a><span id="l76.10" class="difflineminus">- * described herein are Copyright (c) International Business Machines Corporation, 2000.</span>
<a href="#l76.11"></a><span id="l76.11" class="difflineminus">- * Modifications to Mozilla code or documentation identified per MPL Section 3.3</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineplus">+ * This Original Code has been modified by IBM Corporation. Modifications made</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+ * by IBM described herein are Copyright (c) International Business Machines</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineplus">+ * Corporation, 2000. Modifications to Mozilla code or documentation identified</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineplus">+ * per MPL Section 3.3</span>
<a href="#l76.16"></a><span id="l76.16">  *</span>
<a href="#l76.17"></a><span id="l76.17">  * Date             Modified by     Description of modification</span>
<a href="#l76.18"></a><span id="l76.18">  * 04/20/2000       IBM Corp.      OS/2 VisualAge build.</span>
<a href="#l76.19"></a><span id="l76.19">  */</span>
<a href="#l76.20"></a><span id="l76.20"> </span>
<a href="#l76.21"></a><span id="l76.21"> /* Thoughts on how to implement this:</span>
<a href="#l76.22"></a><span id="l76.22"> </span>
<a href="#l76.23"></a><span id="l76.23">    = if the type of this multipart/related is not text/html, then treat</span>
<a href="#l76.24"></a><span id="l76.24" class="difflineat">@@ -110,866 +111,791 @@</span>
<a href="#l76.25"></a><span id="l76.25"> #include &quot;mimebuf.h&quot;</span>
<a href="#l76.26"></a><span id="l76.26"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l76.27"></a><span id="l76.27"> #include &lt;ctype.h&gt;</span>
<a href="#l76.28"></a><span id="l76.28"> </span>
<a href="#l76.29"></a><span id="l76.29"> //</span>
<a href="#l76.30"></a><span id="l76.30"> // External Defines...</span>
<a href="#l76.31"></a><span id="l76.31"> //</span>
<a href="#l76.32"></a><span id="l76.32"> </span>
<a href="#l76.33"></a><span id="l76.33" class="difflineminus">-extern nsresult</span>
<a href="#l76.34"></a><span id="l76.34" class="difflineminus">-nsMsgCreateTempFile(const char *tFileName, nsIFile **tFile);</span>
<a href="#l76.35"></a><span id="l76.35" class="difflineplus">+extern nsresult nsMsgCreateTempFile(const char *tFileName, nsIFile **tFile);</span>
<a href="#l76.36"></a><span id="l76.36"> </span>
<a href="#l76.37"></a><span id="l76.37"> #define MIME_SUPERCLASS mimeMultipartClass</span>
<a href="#l76.38"></a><span id="l76.38"> MimeDefClass(MimeMultipartRelated, MimeMultipartRelatedClass,</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineminus">-       mimeMultipartRelatedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineminus">-</span>
<a href="#l76.41"></a><span id="l76.41" class="difflineplus">+             mimeMultipartRelatedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l76.42"></a><span id="l76.42"> </span>
<a href="#l76.43"></a><span id="l76.43" class="difflineminus">-class MimeHashValue</span>
<a href="#l76.44"></a><span id="l76.44" class="difflineminus">-{</span>
<a href="#l76.45"></a><span id="l76.45" class="difflineminus">-public:</span>
<a href="#l76.46"></a><span id="l76.46" class="difflineplus">+class MimeHashValue {</span>
<a href="#l76.47"></a><span id="l76.47" class="difflineplus">+ public:</span>
<a href="#l76.48"></a><span id="l76.48">   MimeHashValue(MimeObject *obj, char *url) {</span>
<a href="#l76.49"></a><span id="l76.49">     m_obj = obj;</span>
<a href="#l76.50"></a><span id="l76.50">     m_url = strdup(url);</span>
<a href="#l76.51"></a><span id="l76.51">   }</span>
<a href="#l76.52"></a><span id="l76.52">   virtual ~MimeHashValue() {</span>
<a href="#l76.53"></a><span id="l76.53" class="difflineminus">-    if (m_url)</span>
<a href="#l76.54"></a><span id="l76.54" class="difflineminus">-      PR_Free((void *)m_url);</span>
<a href="#l76.55"></a><span id="l76.55" class="difflineplus">+    if (m_url) PR_Free((void *)m_url);</span>
<a href="#l76.56"></a><span id="l76.56">   }</span>
<a href="#l76.57"></a><span id="l76.57"> </span>
<a href="#l76.58"></a><span id="l76.58" class="difflineminus">-  MimeObject  *m_obj;</span>
<a href="#l76.59"></a><span id="l76.59" class="difflineminus">-  char        *m_url;</span>
<a href="#l76.60"></a><span id="l76.60" class="difflineplus">+  MimeObject *m_obj;</span>
<a href="#l76.61"></a><span id="l76.61" class="difflineplus">+  char *m_url;</span>
<a href="#l76.62"></a><span id="l76.62"> };</span>
<a href="#l76.63"></a><span id="l76.63"> </span>
<a href="#l76.64"></a><span id="l76.64" class="difflineminus">-static int</span>
<a href="#l76.65"></a><span id="l76.65" class="difflineminus">-MimeMultipartRelated_initialize(MimeObject* obj)</span>
<a href="#l76.66"></a><span id="l76.66" class="difflineminus">-{</span>
<a href="#l76.67"></a><span id="l76.67" class="difflineminus">-  MimeMultipartRelated* relobj = (MimeMultipartRelated*) obj;</span>
<a href="#l76.68"></a><span id="l76.68" class="difflineminus">-  relobj-&gt;base_url = MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_BASE,</span>
<a href="#l76.69"></a><span id="l76.69" class="difflineminus">-                     false, false);</span>
<a href="#l76.70"></a><span id="l76.70" class="difflineplus">+static int MimeMultipartRelated_initialize(MimeObject *obj) {</span>
<a href="#l76.71"></a><span id="l76.71" class="difflineplus">+  MimeMultipartRelated *relobj = (MimeMultipartRelated *)obj;</span>
<a href="#l76.72"></a><span id="l76.72" class="difflineplus">+  relobj-&gt;base_url =</span>
<a href="#l76.73"></a><span id="l76.73" class="difflineplus">+      MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_BASE, false, false);</span>
<a href="#l76.74"></a><span id="l76.74">   /* rhp: need this for supporting Content-Location */</span>
<a href="#l76.75"></a><span id="l76.75" class="difflineminus">-  if (!relobj-&gt;base_url)</span>
<a href="#l76.76"></a><span id="l76.76" class="difflineminus">-  {</span>
<a href="#l76.77"></a><span id="l76.77" class="difflineminus">-    relobj-&gt;base_url = MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_LOCATION,</span>
<a href="#l76.78"></a><span id="l76.78" class="difflineminus">-      false, false);</span>
<a href="#l76.79"></a><span id="l76.79" class="difflineplus">+  if (!relobj-&gt;base_url) {</span>
<a href="#l76.80"></a><span id="l76.80" class="difflineplus">+    relobj-&gt;base_url =</span>
<a href="#l76.81"></a><span id="l76.81" class="difflineplus">+        MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_LOCATION, false, false);</span>
<a href="#l76.82"></a><span id="l76.82">   }</span>
<a href="#l76.83"></a><span id="l76.83">   /* rhp: need this for supporting Content-Location */</span>
<a href="#l76.84"></a><span id="l76.84"> </span>
<a href="#l76.85"></a><span id="l76.85">   /* I used to have code here to test if the type was text/html.  Then I</span>
<a href="#l76.86"></a><span id="l76.86">      added multipart/alternative as being OK, too.  Then I found that the</span>
<a href="#l76.87"></a><span id="l76.87">      VCard spec seems to talk about having the first part of a</span>
<a href="#l76.88"></a><span id="l76.88">      multipart/related be an application/directory.  At that point, I decided</span>
<a href="#l76.89"></a><span id="l76.89">      to punt.  We handle anything as the first part, and stomp on the HTML it</span>
<a href="#l76.90"></a><span id="l76.90">      generates to adjust tags to point into the other parts.  This probably</span>
<a href="#l76.91"></a><span id="l76.91">      works out to something reasonable in most cases. */</span>
<a href="#l76.92"></a><span id="l76.92"> </span>
<a href="#l76.93"></a><span id="l76.93" class="difflineminus">-  relobj-&gt;hash = PL_NewHashTable(20, PL_HashString, PL_CompareStrings, PL_CompareValues,</span>
<a href="#l76.94"></a><span id="l76.94" class="difflineminus">-                                (PLHashAllocOps *)NULL, NULL);</span>
<a href="#l76.95"></a><span id="l76.95" class="difflineplus">+  relobj-&gt;hash =</span>
<a href="#l76.96"></a><span id="l76.96" class="difflineplus">+      PL_NewHashTable(20, PL_HashString, PL_CompareStrings, PL_CompareValues,</span>
<a href="#l76.97"></a><span id="l76.97" class="difflineplus">+                      (PLHashAllocOps *)NULL, NULL);</span>
<a href="#l76.98"></a><span id="l76.98"> </span>
<a href="#l76.99"></a><span id="l76.99">   if (!relobj-&gt;hash) return MIME_OUT_OF_MEMORY;</span>
<a href="#l76.100"></a><span id="l76.100"> </span>
<a href="#l76.101"></a><span id="l76.101">   relobj-&gt;input_file_stream = nullptr;</span>
<a href="#l76.102"></a><span id="l76.102">   relobj-&gt;output_file_stream = nullptr;</span>
<a href="#l76.103"></a><span id="l76.103"> </span>
<a href="#l76.104"></a><span id="l76.104" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(obj);</span>
<a href="#l76.105"></a><span id="l76.105" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(obj);</span>
<a href="#l76.106"></a><span id="l76.106"> }</span>
<a href="#l76.107"></a><span id="l76.107"> </span>
<a href="#l76.108"></a><span id="l76.108" class="difflineminus">-static int</span>
<a href="#l76.109"></a><span id="l76.109" class="difflineminus">-mime_multipart_related_nukehash(PLHashEntry *table,</span>
<a href="#l76.110"></a><span id="l76.110" class="difflineminus">-                                       int indx, void *arg)</span>
<a href="#l76.111"></a><span id="l76.111" class="difflineminus">-{</span>
<a href="#l76.112"></a><span id="l76.112" class="difflineminus">-  if (table-&gt;key)</span>
<a href="#l76.113"></a><span id="l76.113" class="difflineminus">-    PR_Free((char*) table-&gt;key);</span>
<a href="#l76.114"></a><span id="l76.114" class="difflineplus">+static int mime_multipart_related_nukehash(PLHashEntry *table, int indx,</span>
<a href="#l76.115"></a><span id="l76.115" class="difflineplus">+                                           void *arg) {</span>
<a href="#l76.116"></a><span id="l76.116" class="difflineplus">+  if (table-&gt;key) PR_Free((char *)table-&gt;key);</span>
<a href="#l76.117"></a><span id="l76.117"> </span>
<a href="#l76.118"></a><span id="l76.118" class="difflineminus">-  if (table-&gt;value)</span>
<a href="#l76.119"></a><span id="l76.119" class="difflineminus">-    delete (MimeHashValue *)table-&gt;value;</span>
<a href="#l76.120"></a><span id="l76.120" class="difflineplus">+  if (table-&gt;value) delete (MimeHashValue *)table-&gt;value;</span>
<a href="#l76.121"></a><span id="l76.121"> </span>
<a href="#l76.122"></a><span id="l76.122" class="difflineminus">-  return HT_ENUMERATE_NEXT;   /* XP_Maphash will continue traversing the hash */</span>
<a href="#l76.123"></a><span id="l76.123" class="difflineplus">+  return HT_ENUMERATE_NEXT; /* XP_Maphash will continue traversing the hash */</span>
<a href="#l76.124"></a><span id="l76.124"> }</span>
<a href="#l76.125"></a><span id="l76.125"> </span>
<a href="#l76.126"></a><span id="l76.126" class="difflineminus">-static void</span>
<a href="#l76.127"></a><span id="l76.127" class="difflineminus">-MimeMultipartRelated_finalize (MimeObject *obj)</span>
<a href="#l76.128"></a><span id="l76.128" class="difflineminus">-{</span>
<a href="#l76.129"></a><span id="l76.129" class="difflineminus">-  MimeMultipartRelated* relobj = (MimeMultipartRelated*) obj;</span>
<a href="#l76.130"></a><span id="l76.130" class="difflineplus">+static void MimeMultipartRelated_finalize(MimeObject *obj) {</span>
<a href="#l76.131"></a><span id="l76.131" class="difflineplus">+  MimeMultipartRelated *relobj = (MimeMultipartRelated *)obj;</span>
<a href="#l76.132"></a><span id="l76.132">   PR_FREEIF(relobj-&gt;base_url);</span>
<a href="#l76.133"></a><span id="l76.133">   PR_FREEIF(relobj-&gt;curtag);</span>
<a href="#l76.134"></a><span id="l76.134">   if (relobj-&gt;buffered_hdrs) {</span>
<a href="#l76.135"></a><span id="l76.135">     PR_FREEIF(relobj-&gt;buffered_hdrs-&gt;all_headers);</span>
<a href="#l76.136"></a><span id="l76.136">     PR_FREEIF(relobj-&gt;buffered_hdrs-&gt;heads);</span>
<a href="#l76.137"></a><span id="l76.137">     PR_FREEIF(relobj-&gt;buffered_hdrs);</span>
<a href="#l76.138"></a><span id="l76.138">   }</span>
<a href="#l76.139"></a><span id="l76.139">   PR_FREEIF(relobj-&gt;head_buffer);</span>
<a href="#l76.140"></a><span id="l76.140">   relobj-&gt;head_buffer_fp = 0;</span>
<a href="#l76.141"></a><span id="l76.141">   relobj-&gt;head_buffer_size = 0;</span>
<a href="#l76.142"></a><span id="l76.142">   if (relobj-&gt;hash) {</span>
<a href="#l76.143"></a><span id="l76.143" class="difflineminus">-    PL_HashTableEnumerateEntries(relobj-&gt;hash, mime_multipart_related_nukehash, NULL);</span>
<a href="#l76.144"></a><span id="l76.144" class="difflineplus">+    PL_HashTableEnumerateEntries(relobj-&gt;hash, mime_multipart_related_nukehash,</span>
<a href="#l76.145"></a><span id="l76.145" class="difflineplus">+                                 NULL);</span>
<a href="#l76.146"></a><span id="l76.146">     PL_HashTableDestroy(relobj-&gt;hash);</span>
<a href="#l76.147"></a><span id="l76.147">     relobj-&gt;hash = NULL;</span>
<a href="#l76.148"></a><span id="l76.148">   }</span>
<a href="#l76.149"></a><span id="l76.149"> </span>
<a href="#l76.150"></a><span id="l76.150" class="difflineminus">-  if (relobj-&gt;input_file_stream)</span>
<a href="#l76.151"></a><span id="l76.151" class="difflineminus">-  {</span>
<a href="#l76.152"></a><span id="l76.152" class="difflineplus">+  if (relobj-&gt;input_file_stream) {</span>
<a href="#l76.153"></a><span id="l76.153">     relobj-&gt;input_file_stream-&gt;Close();</span>
<a href="#l76.154"></a><span id="l76.154">     relobj-&gt;input_file_stream = nullptr;</span>
<a href="#l76.155"></a><span id="l76.155">   }</span>
<a href="#l76.156"></a><span id="l76.156"> </span>
<a href="#l76.157"></a><span id="l76.157" class="difflineminus">-  if (relobj-&gt;output_file_stream)</span>
<a href="#l76.158"></a><span id="l76.158" class="difflineminus">-  {</span>
<a href="#l76.159"></a><span id="l76.159" class="difflineplus">+  if (relobj-&gt;output_file_stream) {</span>
<a href="#l76.160"></a><span id="l76.160">     relobj-&gt;output_file_stream-&gt;Close();</span>
<a href="#l76.161"></a><span id="l76.161">     relobj-&gt;output_file_stream = nullptr;</span>
<a href="#l76.162"></a><span id="l76.162">   }</span>
<a href="#l76.163"></a><span id="l76.163"> </span>
<a href="#l76.164"></a><span id="l76.164" class="difflineminus">-  if (relobj-&gt;file_buffer)</span>
<a href="#l76.165"></a><span id="l76.165" class="difflineminus">-  {</span>
<a href="#l76.166"></a><span id="l76.166" class="difflineplus">+  if (relobj-&gt;file_buffer) {</span>
<a href="#l76.167"></a><span id="l76.167">     relobj-&gt;file_buffer-&gt;Remove(false);</span>
<a href="#l76.168"></a><span id="l76.168">     relobj-&gt;file_buffer = nullptr;</span>
<a href="#l76.169"></a><span id="l76.169">   }</span>
<a href="#l76.170"></a><span id="l76.170"> </span>
<a href="#l76.171"></a><span id="l76.171">   if (relobj-&gt;headobj) {</span>
<a href="#l76.172"></a><span id="l76.172">     // In some error conditions when MimeMultipartRelated_parse_eof() isn't run</span>
<a href="#l76.173"></a><span id="l76.173">     // (for example, no temp disk space available to extract message parts),</span>
<a href="#l76.174"></a><span id="l76.174">     // the head object is also referenced as a child.</span>
<a href="#l76.175"></a><span id="l76.175">     // If we free it, we remove the child reference first ... or crash later :-(</span>
<a href="#l76.176"></a><span id="l76.176">     MimeContainer *cont = (MimeContainer *)relobj;</span>
<a href="#l76.177"></a><span id="l76.177">     for (int i = 0; i &lt; cont-&gt;nchildren; i++) {</span>
<a href="#l76.178"></a><span id="l76.178">       if (cont-&gt;children[i] == relobj-&gt;headobj) {</span>
<a href="#l76.179"></a><span id="l76.179">         // Shift remaining children down.</span>
<a href="#l76.180"></a><span id="l76.180" class="difflineminus">-        for (int j = i+1; j &lt; cont-&gt;nchildren; j++) {</span>
<a href="#l76.181"></a><span id="l76.181" class="difflineminus">-          cont-&gt;children[j-1] = cont-&gt;children[j];</span>
<a href="#l76.182"></a><span id="l76.182" class="difflineplus">+        for (int j = i + 1; j &lt; cont-&gt;nchildren; j++) {</span>
<a href="#l76.183"></a><span id="l76.183" class="difflineplus">+          cont-&gt;children[j - 1] = cont-&gt;children[j];</span>
<a href="#l76.184"></a><span id="l76.184">         }</span>
<a href="#l76.185"></a><span id="l76.185">         cont-&gt;children[--cont-&gt;nchildren] = nullptr;</span>
<a href="#l76.186"></a><span id="l76.186">         break;</span>
<a href="#l76.187"></a><span id="l76.187">       }</span>
<a href="#l76.188"></a><span id="l76.188">     }</span>
<a href="#l76.189"></a><span id="l76.189"> </span>
<a href="#l76.190"></a><span id="l76.190">     mime_free(relobj-&gt;headobj);</span>
<a href="#l76.191"></a><span id="l76.191">     relobj-&gt;headobj = nullptr;</span>
<a href="#l76.192"></a><span id="l76.192">   }</span>
<a href="#l76.193"></a><span id="l76.193"> </span>
<a href="#l76.194"></a><span id="l76.194" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l76.195"></a><span id="l76.195" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l76.196"></a><span id="l76.196"> }</span>
<a href="#l76.197"></a><span id="l76.197"> </span>
<a href="#l76.198"></a><span id="l76.198" class="difflineminus">-#define ISHEX(c) ( ((c) &gt;= '0' &amp;&amp; (c) &lt;= '9') || ((c) &gt;= 'a' &amp;&amp; (c) &lt;= 'f') || ((c) &gt;= 'A' &amp;&amp; (c) &lt;= 'F') )</span>
<a href="#l76.199"></a><span id="l76.199" class="difflineplus">+#define ISHEX(c)                                               \</span>
<a href="#l76.200"></a><span id="l76.200" class="difflineplus">+  (((c) &gt;= '0' &amp;&amp; (c) &lt;= '9') || ((c) &gt;= 'a' &amp;&amp; (c) &lt;= 'f') || \</span>
<a href="#l76.201"></a><span id="l76.201" class="difflineplus">+   ((c) &gt;= 'A' &amp;&amp; (c) &lt;= 'F'))</span>
<a href="#l76.202"></a><span id="l76.202"> #define NONHEX(c) (!ISHEX(c))</span>
<a href="#l76.203"></a><span id="l76.203"> </span>
<a href="#l76.204"></a><span id="l76.204" class="difflineminus">-extern &quot;C&quot; char *</span>
<a href="#l76.205"></a><span id="l76.205" class="difflineminus">-escape_unescaped_percents(const char *incomingURL)</span>
<a href="#l76.206"></a><span id="l76.206" class="difflineminus">-{</span>
<a href="#l76.207"></a><span id="l76.207" class="difflineplus">+extern &quot;C&quot; char *escape_unescaped_percents(const char *incomingURL) {</span>
<a href="#l76.208"></a><span id="l76.208">   const char *inC;</span>
<a href="#l76.209"></a><span id="l76.209">   char *outC;</span>
<a href="#l76.210"></a><span id="l76.210" class="difflineminus">-  char *result = (char *) PR_Malloc(strlen(incomingURL)*3+1);</span>
<a href="#l76.211"></a><span id="l76.211" class="difflineplus">+  char *result = (char *)PR_Malloc(strlen(incomingURL) * 3 + 1);</span>
<a href="#l76.212"></a><span id="l76.212"> </span>
<a href="#l76.213"></a><span id="l76.213" class="difflineminus">-  if (result)</span>
<a href="#l76.214"></a><span id="l76.214" class="difflineminus">-  {</span>
<a href="#l76.215"></a><span id="l76.215" class="difflineminus">-    for(inC = incomingURL, outC = result; *inC != '\0'; inC++)</span>
<a href="#l76.216"></a><span id="l76.216" class="difflineminus">-    {</span>
<a href="#l76.217"></a><span id="l76.217" class="difflineminus">-      if (*inC == '%')</span>
<a href="#l76.218"></a><span id="l76.218" class="difflineminus">-      {</span>
<a href="#l76.219"></a><span id="l76.219" class="difflineplus">+  if (result) {</span>
<a href="#l76.220"></a><span id="l76.220" class="difflineplus">+    for (inC = incomingURL, outC = result; *inC != '\0'; inC++) {</span>
<a href="#l76.221"></a><span id="l76.221" class="difflineplus">+      if (*inC == '%') {</span>
<a href="#l76.222"></a><span id="l76.222">         /* Check if either of the next two characters are non-hex. */</span>
<a href="#l76.223"></a><span id="l76.223" class="difflineminus">-        if ( !*(inC+1) || NONHEX(*(inC+1)) || !*(inC+2) || NONHEX(*(inC+2)) )</span>
<a href="#l76.224"></a><span id="l76.224" class="difflineminus">-        {</span>
<a href="#l76.225"></a><span id="l76.225" class="difflineplus">+        if (!*(inC + 1) || NONHEX(*(inC + 1)) || !*(inC + 2) ||</span>
<a href="#l76.226"></a><span id="l76.226" class="difflineplus">+            NONHEX(*(inC + 2))) {</span>
<a href="#l76.227"></a><span id="l76.227">           /* Hex characters don't follow, escape the</span>
<a href="#l76.228"></a><span id="l76.228">              percent char */</span>
<a href="#l76.229"></a><span id="l76.229" class="difflineminus">-          *outC++ = '%'; *outC++ = '2'; *outC++ = '5';</span>
<a href="#l76.230"></a><span id="l76.230" class="difflineminus">-        }</span>
<a href="#l76.231"></a><span id="l76.231" class="difflineminus">-        else</span>
<a href="#l76.232"></a><span id="l76.232" class="difflineminus">-        {</span>
<a href="#l76.233"></a><span id="l76.233" class="difflineplus">+          *outC++ = '%';</span>
<a href="#l76.234"></a><span id="l76.234" class="difflineplus">+          *outC++ = '2';</span>
<a href="#l76.235"></a><span id="l76.235" class="difflineplus">+          *outC++ = '5';</span>
<a href="#l76.236"></a><span id="l76.236" class="difflineplus">+        } else {</span>
<a href="#l76.237"></a><span id="l76.237">           /* Hex characters follow, so assume the percent</span>
<a href="#l76.238"></a><span id="l76.238">              is escaping something else */</span>
<a href="#l76.239"></a><span id="l76.239">           *outC++ = *inC;</span>
<a href="#l76.240"></a><span id="l76.240">         }</span>
<a href="#l76.241"></a><span id="l76.241" class="difflineminus">-      }</span>
<a href="#l76.242"></a><span id="l76.242" class="difflineminus">-      else</span>
<a href="#l76.243"></a><span id="l76.243" class="difflineplus">+      } else</span>
<a href="#l76.244"></a><span id="l76.244">         *outC++ = *inC;</span>
<a href="#l76.245"></a><span id="l76.245">     }</span>
<a href="#l76.246"></a><span id="l76.246">     *outC = '\0';</span>
<a href="#l76.247"></a><span id="l76.247">   }</span>
<a href="#l76.248"></a><span id="l76.248"> </span>
<a href="#l76.249"></a><span id="l76.249">   return result;</span>
<a href="#l76.250"></a><span id="l76.250"> }</span>
<a href="#l76.251"></a><span id="l76.251"> </span>
<a href="#l76.252"></a><span id="l76.252"> /* This routine is only necessary because the mailbox URL fed to us</span>
<a href="#l76.253"></a><span id="l76.253">    by the winfe can contain spaces and '&gt;'s in it. It's a hack. */</span>
<a href="#l76.254"></a><span id="l76.254" class="difflineminus">-static char *</span>
<a href="#l76.255"></a><span id="l76.255" class="difflineminus">-escape_for_mrel_subst(char *inURL)</span>
<a href="#l76.256"></a><span id="l76.256" class="difflineminus">-{</span>
<a href="#l76.257"></a><span id="l76.257" class="difflineplus">+static char *escape_for_mrel_subst(char *inURL) {</span>
<a href="#l76.258"></a><span id="l76.258">   char *output, *inC, *outC, *temp;</span>
<a href="#l76.259"></a><span id="l76.259"> </span>
<a href="#l76.260"></a><span id="l76.260">   int size = strlen(inURL) + 1;</span>
<a href="#l76.261"></a><span id="l76.261"> </span>
<a href="#l76.262"></a><span id="l76.262" class="difflineminus">-  for(inC = inURL; *inC; inC++)</span>
<a href="#l76.263"></a><span id="l76.263" class="difflineplus">+  for (inC = inURL; *inC; inC++)</span>
<a href="#l76.264"></a><span id="l76.264">     if ((*inC == ' ') || (*inC == '&gt;'))</span>
<a href="#l76.265"></a><span id="l76.265">       size += 2; /* space -&gt; '%20', '&gt;' -&gt; '%3E', etc. */</span>
<a href="#l76.266"></a><span id="l76.266"> </span>
<a href="#l76.267"></a><span id="l76.267">   output = (char *)PR_MALLOC(size);</span>
<a href="#l76.268"></a><span id="l76.268" class="difflineminus">-  if (output)</span>
<a href="#l76.269"></a><span id="l76.269" class="difflineminus">-  {</span>
<a href="#l76.270"></a><span id="l76.270" class="difflineplus">+  if (output) {</span>
<a href="#l76.271"></a><span id="l76.271">     /* Walk through the source string, copying all chars</span>
<a href="#l76.272"></a><span id="l76.272">       except for spaces, which get escaped. */</span>
<a href="#l76.273"></a><span id="l76.273">     inC = inURL;</span>
<a href="#l76.274"></a><span id="l76.274">     outC = output;</span>
<a href="#l76.275"></a><span id="l76.275" class="difflineminus">-    while(*inC)</span>
<a href="#l76.276"></a><span id="l76.276" class="difflineminus">-    {</span>
<a href="#l76.277"></a><span id="l76.277" class="difflineminus">-      if (*inC == ' ')</span>
<a href="#l76.278"></a><span id="l76.278" class="difflineminus">-      {</span>
<a href="#l76.279"></a><span id="l76.279" class="difflineminus">-        *outC++ = '%'; *outC++ = '2'; *outC++ = '0';</span>
<a href="#l76.280"></a><span id="l76.280" class="difflineminus">-      }</span>
<a href="#l76.281"></a><span id="l76.281" class="difflineminus">-      else if (*inC == '&gt;')</span>
<a href="#l76.282"></a><span id="l76.282" class="difflineminus">-      {</span>
<a href="#l76.283"></a><span id="l76.283" class="difflineminus">-        *outC++ = '%'; *outC++ = '3'; *outC++ = 'E';</span>
<a href="#l76.284"></a><span id="l76.284" class="difflineminus">-      }</span>
<a href="#l76.285"></a><span id="l76.285" class="difflineminus">-      else</span>
<a href="#l76.286"></a><span id="l76.286" class="difflineplus">+    while (*inC) {</span>
<a href="#l76.287"></a><span id="l76.287" class="difflineplus">+      if (*inC == ' ') {</span>
<a href="#l76.288"></a><span id="l76.288" class="difflineplus">+        *outC++ = '%';</span>
<a href="#l76.289"></a><span id="l76.289" class="difflineplus">+        *outC++ = '2';</span>
<a href="#l76.290"></a><span id="l76.290" class="difflineplus">+        *outC++ = '0';</span>
<a href="#l76.291"></a><span id="l76.291" class="difflineplus">+      } else if (*inC == '&gt;') {</span>
<a href="#l76.292"></a><span id="l76.292" class="difflineplus">+        *outC++ = '%';</span>
<a href="#l76.293"></a><span id="l76.293" class="difflineplus">+        *outC++ = '3';</span>
<a href="#l76.294"></a><span id="l76.294" class="difflineplus">+        *outC++ = 'E';</span>
<a href="#l76.295"></a><span id="l76.295" class="difflineplus">+      } else</span>
<a href="#l76.296"></a><span id="l76.296">         *outC++ = *inC;</span>
<a href="#l76.297"></a><span id="l76.297"> </span>
<a href="#l76.298"></a><span id="l76.298">       inC++;</span>
<a href="#l76.299"></a><span id="l76.299">     }</span>
<a href="#l76.300"></a><span id="l76.300">     *outC = '\0';</span>
<a href="#l76.301"></a><span id="l76.301"> </span>
<a href="#l76.302"></a><span id="l76.302">     temp = escape_unescaped_percents(output);</span>
<a href="#l76.303"></a><span id="l76.303" class="difflineminus">-    if (temp)</span>
<a href="#l76.304"></a><span id="l76.304" class="difflineminus">-    {</span>
<a href="#l76.305"></a><span id="l76.305" class="difflineplus">+    if (temp) {</span>
<a href="#l76.306"></a><span id="l76.306">       PR_FREEIF(output);</span>
<a href="#l76.307"></a><span id="l76.307">       output = temp;</span>
<a href="#l76.308"></a><span id="l76.308">     }</span>
<a href="#l76.309"></a><span id="l76.309">   }</span>
<a href="#l76.310"></a><span id="l76.310">   return output;</span>
<a href="#l76.311"></a><span id="l76.311"> }</span>
<a href="#l76.312"></a><span id="l76.312"> </span>
<a href="#l76.313"></a><span id="l76.313" class="difflineminus">-static bool</span>
<a href="#l76.314"></a><span id="l76.314" class="difflineminus">-MimeStartParamExists(MimeObject *obj, MimeObject* child)</span>
<a href="#l76.315"></a><span id="l76.315" class="difflineminus">-{</span>
<a href="#l76.316"></a><span id="l76.316" class="difflineminus">-  char *ct = MimeHeaders_get (obj-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l76.317"></a><span id="l76.317" class="difflineminus">-  char *st = (ct</span>
<a href="#l76.318"></a><span id="l76.318" class="difflineminus">-              ? MimeHeaders_get_parameter(ct, HEADER_PARM_START, NULL, NULL)</span>
<a href="#l76.319"></a><span id="l76.319" class="difflineminus">-              : 0);</span>
<a href="#l76.320"></a><span id="l76.320" class="difflineplus">+static bool MimeStartParamExists(MimeObject *obj, MimeObject *child) {</span>
<a href="#l76.321"></a><span id="l76.321" class="difflineplus">+  char *ct = MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l76.322"></a><span id="l76.322" class="difflineplus">+  char *st =</span>
<a href="#l76.323"></a><span id="l76.323" class="difflineplus">+      (ct ? MimeHeaders_get_parameter(ct, HEADER_PARM_START, NULL, NULL) : 0);</span>
<a href="#l76.324"></a><span id="l76.324"> </span>
<a href="#l76.325"></a><span id="l76.325">   PR_FREEIF(ct);</span>
<a href="#l76.326"></a><span id="l76.326" class="difflineminus">-  if (!st)</span>
<a href="#l76.327"></a><span id="l76.327" class="difflineminus">-    return false;</span>
<a href="#l76.328"></a><span id="l76.328" class="difflineplus">+  if (!st) return false;</span>
<a href="#l76.329"></a><span id="l76.329"> </span>
<a href="#l76.330"></a><span id="l76.330">   PR_FREEIF(st);</span>
<a href="#l76.331"></a><span id="l76.331">   return true;</span>
<a href="#l76.332"></a><span id="l76.332"> }</span>
<a href="#l76.333"></a><span id="l76.333"> </span>
<a href="#l76.334"></a><span id="l76.334" class="difflineminus">-static bool</span>
<a href="#l76.335"></a><span id="l76.335" class="difflineminus">-MimeThisIsStartPart(MimeObject *obj, MimeObject* child)</span>
<a href="#l76.336"></a><span id="l76.336" class="difflineminus">-{</span>
<a href="#l76.337"></a><span id="l76.337" class="difflineplus">+static bool MimeThisIsStartPart(MimeObject *obj, MimeObject *child) {</span>
<a href="#l76.338"></a><span id="l76.338">   bool rval = false;</span>
<a href="#l76.339"></a><span id="l76.339">   char *ct, *st, *cst;</span>
<a href="#l76.340"></a><span id="l76.340"> </span>
<a href="#l76.341"></a><span id="l76.341" class="difflineminus">-  ct = MimeHeaders_get (obj-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l76.342"></a><span id="l76.342" class="difflineminus">-  st = (ct</span>
<a href="#l76.343"></a><span id="l76.343" class="difflineminus">-        ? MimeHeaders_get_parameter(ct, HEADER_PARM_START, NULL, NULL)</span>
<a href="#l76.344"></a><span id="l76.344" class="difflineminus">-        : 0);</span>
<a href="#l76.345"></a><span id="l76.345" class="difflineplus">+  ct = MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l76.346"></a><span id="l76.346" class="difflineplus">+  st = (ct ? MimeHeaders_get_parameter(ct, HEADER_PARM_START, NULL, NULL) : 0);</span>
<a href="#l76.347"></a><span id="l76.347"> </span>
<a href="#l76.348"></a><span id="l76.348">   PR_FREEIF(ct);</span>
<a href="#l76.349"></a><span id="l76.349" class="difflineminus">-  if (!st)</span>
<a href="#l76.350"></a><span id="l76.350" class="difflineminus">-    return false;</span>
<a href="#l76.351"></a><span id="l76.351" class="difflineplus">+  if (!st) return false;</span>
<a href="#l76.352"></a><span id="l76.352"> </span>
<a href="#l76.353"></a><span id="l76.353">   cst = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_ID, false, false);</span>
<a href="#l76.354"></a><span id="l76.354">   if (!cst)</span>
<a href="#l76.355"></a><span id="l76.355">     rval = false;</span>
<a href="#l76.356"></a><span id="l76.356" class="difflineminus">-  else</span>
<a href="#l76.357"></a><span id="l76.357" class="difflineminus">-  {</span>
<a href="#l76.358"></a><span id="l76.358" class="difflineplus">+  else {</span>
<a href="#l76.359"></a><span id="l76.359">     char *tmp = cst;</span>
<a href="#l76.360"></a><span id="l76.360" class="difflineminus">-    if (*tmp == '&lt;')</span>
<a href="#l76.361"></a><span id="l76.361" class="difflineminus">-    {</span>
<a href="#l76.362"></a><span id="l76.362" class="difflineplus">+    if (*tmp == '&lt;') {</span>
<a href="#l76.363"></a><span id="l76.363">       int length;</span>
<a href="#l76.364"></a><span id="l76.364">       tmp++;</span>
<a href="#l76.365"></a><span id="l76.365">       length = strlen(tmp);</span>
<a href="#l76.366"></a><span id="l76.366" class="difflineminus">-      if (length &gt; 0 &amp;&amp; tmp[length - 1] == '&gt;')</span>
<a href="#l76.367"></a><span id="l76.367" class="difflineminus">-      {</span>
<a href="#l76.368"></a><span id="l76.368" class="difflineplus">+      if (length &gt; 0 &amp;&amp; tmp[length - 1] == '&gt;') {</span>
<a href="#l76.369"></a><span id="l76.369">         tmp[length - 1] = '\0';</span>
<a href="#l76.370"></a><span id="l76.370">       }</span>
<a href="#l76.371"></a><span id="l76.371">     }</span>
<a href="#l76.372"></a><span id="l76.372"> </span>
<a href="#l76.373"></a><span id="l76.373">     rval = (!strcmp(st, tmp));</span>
<a href="#l76.374"></a><span id="l76.374">   }</span>
<a href="#l76.375"></a><span id="l76.375"> </span>
<a href="#l76.376"></a><span id="l76.376">   PR_FREEIF(st);</span>
<a href="#l76.377"></a><span id="l76.377">   PR_FREEIF(cst);</span>
<a href="#l76.378"></a><span id="l76.378">   return rval;</span>
<a href="#l76.379"></a><span id="l76.379"> }</span>
<a href="#l76.380"></a><span id="l76.380"> /* rhp - gotta support the &quot;start&quot; parameter */</span>
<a href="#l76.381"></a><span id="l76.381"> </span>
<a href="#l76.382"></a><span id="l76.382" class="difflineminus">-char *</span>
<a href="#l76.383"></a><span id="l76.383" class="difflineminus">-MakeAbsoluteURL(char *base_url, char *relative_url)</span>
<a href="#l76.384"></a><span id="l76.384" class="difflineminus">-{</span>
<a href="#l76.385"></a><span id="l76.385" class="difflineminus">-  char            *retString = nullptr;</span>
<a href="#l76.386"></a><span id="l76.386" class="difflineminus">-  nsIURI          *base = nullptr;</span>
<a href="#l76.387"></a><span id="l76.387" class="difflineplus">+char *MakeAbsoluteURL(char *base_url, char *relative_url) {</span>
<a href="#l76.388"></a><span id="l76.388" class="difflineplus">+  char *retString = nullptr;</span>
<a href="#l76.389"></a><span id="l76.389" class="difflineplus">+  nsIURI *base = nullptr;</span>
<a href="#l76.390"></a><span id="l76.390"> </span>
<a href="#l76.391"></a><span id="l76.391">   // if either is NULL, just return the relative if safe...</span>
<a href="#l76.392"></a><span id="l76.392" class="difflineminus">-  if (!base_url || !relative_url)</span>
<a href="#l76.393"></a><span id="l76.393" class="difflineminus">-  {</span>
<a href="#l76.394"></a><span id="l76.394" class="difflineminus">-    if (!relative_url)</span>
<a href="#l76.395"></a><span id="l76.395" class="difflineminus">-      return nullptr;</span>
<a href="#l76.396"></a><span id="l76.396" class="difflineplus">+  if (!base_url || !relative_url) {</span>
<a href="#l76.397"></a><span id="l76.397" class="difflineplus">+    if (!relative_url) return nullptr;</span>
<a href="#l76.398"></a><span id="l76.398"> </span>
<a href="#l76.399"></a><span id="l76.399">     NS_MsgSACopy(&amp;retString, relative_url);</span>
<a href="#l76.400"></a><span id="l76.400">     return retString;</span>
<a href="#l76.401"></a><span id="l76.401">   }</span>
<a href="#l76.402"></a><span id="l76.402"> </span>
<a href="#l76.403"></a><span id="l76.403">   nsresult err = nsMimeNewURI(&amp;base, base_url, nullptr);</span>
<a href="#l76.404"></a><span id="l76.404" class="difflineminus">-  if (NS_FAILED(err))</span>
<a href="#l76.405"></a><span id="l76.405" class="difflineminus">-    return nullptr;</span>
<a href="#l76.406"></a><span id="l76.406" class="difflineplus">+  if (NS_FAILED(err)) return nullptr;</span>
<a href="#l76.407"></a><span id="l76.407"> </span>
<a href="#l76.408"></a><span id="l76.408">   nsAutoCString spec;</span>
<a href="#l76.409"></a><span id="l76.409"> </span>
<a href="#l76.410"></a><span id="l76.410" class="difflineminus">-  nsIURI    *url = nullptr;</span>
<a href="#l76.411"></a><span id="l76.411" class="difflineplus">+  nsIURI *url = nullptr;</span>
<a href="#l76.412"></a><span id="l76.412">   err = nsMimeNewURI(&amp;url, relative_url, base);</span>
<a href="#l76.413"></a><span id="l76.413" class="difflineminus">-  if (NS_FAILED(err))</span>
<a href="#l76.414"></a><span id="l76.414" class="difflineminus">-    goto done;</span>
<a href="#l76.415"></a><span id="l76.415" class="difflineplus">+  if (NS_FAILED(err)) goto done;</span>
<a href="#l76.416"></a><span id="l76.416"> </span>
<a href="#l76.417"></a><span id="l76.417">   err = url-&gt;GetSpec(spec);</span>
<a href="#l76.418"></a><span id="l76.418" class="difflineminus">-  if (NS_FAILED(err))</span>
<a href="#l76.419"></a><span id="l76.419" class="difflineminus">-  {</span>
<a href="#l76.420"></a><span id="l76.420" class="difflineplus">+  if (NS_FAILED(err)) {</span>
<a href="#l76.421"></a><span id="l76.421">     retString = nullptr;</span>
<a href="#l76.422"></a><span id="l76.422">     goto done;</span>
<a href="#l76.423"></a><span id="l76.423">   }</span>
<a href="#l76.424"></a><span id="l76.424">   retString = ToNewCString(spec);</span>
<a href="#l76.425"></a><span id="l76.425"> </span>
<a href="#l76.426"></a><span id="l76.426"> done:</span>
<a href="#l76.427"></a><span id="l76.427">   NS_IF_RELEASE(url);</span>
<a href="#l76.428"></a><span id="l76.428">   NS_IF_RELEASE(base);</span>
<a href="#l76.429"></a><span id="l76.429">   return retString;</span>
<a href="#l76.430"></a><span id="l76.430"> }</span>
<a href="#l76.431"></a><span id="l76.431"> </span>
<a href="#l76.432"></a><span id="l76.432" class="difflineminus">-static bool</span>
<a href="#l76.433"></a><span id="l76.433" class="difflineminus">-MimeMultipartRelated_output_child_p(MimeObject *obj, MimeObject* child)</span>
<a href="#l76.434"></a><span id="l76.434" class="difflineminus">-{</span>
<a href="#l76.435"></a><span id="l76.435" class="difflineminus">-  MimeMultipartRelated *relobj = (MimeMultipartRelated *) obj;</span>
<a href="#l76.436"></a><span id="l76.436" class="difflineplus">+static bool MimeMultipartRelated_output_child_p(MimeObject *obj,</span>
<a href="#l76.437"></a><span id="l76.437" class="difflineplus">+                                                MimeObject *child) {</span>
<a href="#l76.438"></a><span id="l76.438" class="difflineplus">+  MimeMultipartRelated *relobj = (MimeMultipartRelated *)obj;</span>
<a href="#l76.439"></a><span id="l76.439"> </span>
<a href="#l76.440"></a><span id="l76.440">   /* rhp - Changed from &quot;if (relobj-&gt;head_loaded)&quot; alone to support the</span>
<a href="#l76.441"></a><span id="l76.441">            start parameter</span>
<a href="#l76.442"></a><span id="l76.442">    */</span>
<a href="#l76.443"></a><span id="l76.443" class="difflineminus">-  if (</span>
<a href="#l76.444"></a><span id="l76.444" class="difflineminus">-       (relobj-&gt;head_loaded) ||</span>
<a href="#l76.445"></a><span id="l76.445" class="difflineminus">-       (MimeStartParamExists(obj, child) &amp;&amp; !MimeThisIsStartPart(obj, child))</span>
<a href="#l76.446"></a><span id="l76.446" class="difflineminus">-     )</span>
<a href="#l76.447"></a><span id="l76.447" class="difflineminus">-  {</span>
<a href="#l76.448"></a><span id="l76.448" class="difflineplus">+  if ((relobj-&gt;head_loaded) ||</span>
<a href="#l76.449"></a><span id="l76.449" class="difflineplus">+      (MimeStartParamExists(obj, child) &amp;&amp; !MimeThisIsStartPart(obj, child))) {</span>
<a href="#l76.450"></a><span id="l76.450">     /* This is a child part.  Just remember the mapping between the URL</span>
<a href="#l76.451"></a><span id="l76.451">        it represents and the part-URL to get it back. */</span>
<a href="#l76.452"></a><span id="l76.452"> </span>
<a href="#l76.453"></a><span id="l76.453" class="difflineminus">-    char* location = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_LOCATION,</span>
<a href="#l76.454"></a><span id="l76.454" class="difflineminus">-                     false, false);</span>
<a href="#l76.455"></a><span id="l76.455" class="difflineplus">+    char *location =</span>
<a href="#l76.456"></a><span id="l76.456" class="difflineplus">+        MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_LOCATION, false, false);</span>
<a href="#l76.457"></a><span id="l76.457">     if (!location) {</span>
<a href="#l76.458"></a><span id="l76.458" class="difflineminus">-      char* tmp = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_ID,</span>
<a href="#l76.459"></a><span id="l76.459" class="difflineminus">-                    false, false);</span>
<a href="#l76.460"></a><span id="l76.460" class="difflineplus">+      char *tmp =</span>
<a href="#l76.461"></a><span id="l76.461" class="difflineplus">+          MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_ID, false, false);</span>
<a href="#l76.462"></a><span id="l76.462">       if (tmp) {</span>
<a href="#l76.463"></a><span id="l76.463" class="difflineminus">-        char* tmp2 = tmp;</span>
<a href="#l76.464"></a><span id="l76.464" class="difflineplus">+        char *tmp2 = tmp;</span>
<a href="#l76.465"></a><span id="l76.465">         if (*tmp2 == '&lt;') {</span>
<a href="#l76.466"></a><span id="l76.466">           int length;</span>
<a href="#l76.467"></a><span id="l76.467">           tmp2++;</span>
<a href="#l76.468"></a><span id="l76.468">           length = strlen(tmp2);</span>
<a href="#l76.469"></a><span id="l76.469">           if (length &gt; 0 &amp;&amp; tmp2[length - 1] == '&gt;') {</span>
<a href="#l76.470"></a><span id="l76.470">             tmp2[length - 1] = '\0';</span>
<a href="#l76.471"></a><span id="l76.471">           }</span>
<a href="#l76.472"></a><span id="l76.472">         }</span>
<a href="#l76.473"></a><span id="l76.473">         location = PR_smprintf(&quot;cid:%s&quot;, tmp2);</span>
<a href="#l76.474"></a><span id="l76.474">         PR_Free(tmp);</span>
<a href="#l76.475"></a><span id="l76.475">       }</span>
<a href="#l76.476"></a><span id="l76.476">     }</span>
<a href="#l76.477"></a><span id="l76.477"> </span>
<a href="#l76.478"></a><span id="l76.478">     if (location) {</span>
<a href="#l76.479"></a><span id="l76.479">       char *absolute;</span>
<a href="#l76.480"></a><span id="l76.480" class="difflineminus">-      char *base_url = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_BASE,</span>
<a href="#l76.481"></a><span id="l76.481" class="difflineminus">-                       false, false);</span>
<a href="#l76.482"></a><span id="l76.482" class="difflineminus">-      absolute = MakeAbsoluteURL(base_url ? base_url : relobj-&gt;base_url, location);</span>
<a href="#l76.483"></a><span id="l76.483" class="difflineplus">+      char *base_url =</span>
<a href="#l76.484"></a><span id="l76.484" class="difflineplus">+          MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_BASE, false, false);</span>
<a href="#l76.485"></a><span id="l76.485" class="difflineplus">+      absolute =</span>
<a href="#l76.486"></a><span id="l76.486" class="difflineplus">+          MakeAbsoluteURL(base_url ? base_url : relobj-&gt;base_url, location);</span>
<a href="#l76.487"></a><span id="l76.487"> </span>
<a href="#l76.488"></a><span id="l76.488">       PR_FREEIF(base_url);</span>
<a href="#l76.489"></a><span id="l76.489">       PR_Free(location);</span>
<a href="#l76.490"></a><span id="l76.490">       if (absolute) {</span>
<a href="#l76.491"></a><span id="l76.491">         nsAutoCString partnum;</span>
<a href="#l76.492"></a><span id="l76.492">         nsAutoCString imappartnum;</span>
<a href="#l76.493"></a><span id="l76.493">         partnum.Adopt(mime_part_address(child));</span>
<a href="#l76.494"></a><span id="l76.494">         if (!partnum.IsEmpty()) {</span>
<a href="#l76.495"></a><span id="l76.495" class="difflineminus">-          if (obj-&gt;options-&gt;missing_parts)</span>
<a href="#l76.496"></a><span id="l76.496" class="difflineminus">-          {</span>
<a href="#l76.497"></a><span id="l76.497" class="difflineminus">-            char * imappart = mime_imap_part_address(child);</span>
<a href="#l76.498"></a><span id="l76.498" class="difflineminus">-            if (imappart)</span>
<a href="#l76.499"></a><span id="l76.499" class="difflineminus">-              imappartnum.Adopt(imappart);</span>
<a href="#l76.500"></a><span id="l76.500" class="difflineplus">+          if (obj-&gt;options-&gt;missing_parts) {</span>
<a href="#l76.501"></a><span id="l76.501" class="difflineplus">+            char *imappart = mime_imap_part_address(child);</span>
<a href="#l76.502"></a><span id="l76.502" class="difflineplus">+            if (imappart) imappartnum.Adopt(imappart);</span>
<a href="#l76.503"></a><span id="l76.503">           }</span>
<a href="#l76.504"></a><span id="l76.504"> </span>
<a href="#l76.505"></a><span id="l76.505">           /*</span>
<a href="#l76.506"></a><span id="l76.506" class="difflineminus">-            AppleDouble part need special care: we need to output only the data fork part of it.</span>
<a href="#l76.507"></a><span id="l76.507" class="difflineminus">-            The problem at this point is that we haven't yet decoded the children of the AppleDouble</span>
<a href="#l76.508"></a><span id="l76.508" class="difflineminus">-            part therefore we will have to hope the datafork is the second one!</span>
<a href="#l76.509"></a><span id="l76.509" class="difflineplus">+            AppleDouble part need special care: we need to output only the data</span>
<a href="#l76.510"></a><span id="l76.510" class="difflineplus">+            fork part of it. The problem at this point is that we haven't yet</span>
<a href="#l76.511"></a><span id="l76.511" class="difflineplus">+            decoded the children of the AppleDouble part therefore we will have</span>
<a href="#l76.512"></a><span id="l76.512" class="difflineplus">+            to hope the datafork is the second one!</span>
<a href="#l76.513"></a><span id="l76.513">           */</span>
<a href="#l76.514"></a><span id="l76.514" class="difflineminus">-          if (mime_typep(child, (MimeObjectClass *) &amp;mimeMultipartAppleDoubleClass))</span>
<a href="#l76.515"></a><span id="l76.515" class="difflineplus">+          if (mime_typep(child,</span>
<a href="#l76.516"></a><span id="l76.516" class="difflineplus">+                         (MimeObjectClass *)&amp;mimeMultipartAppleDoubleClass))</span>
<a href="#l76.517"></a><span id="l76.517">             partnum.AppendLiteral(&quot;.2&quot;);</span>
<a href="#l76.518"></a><span id="l76.518"> </span>
<a href="#l76.519"></a><span id="l76.519" class="difflineminus">-          char* part;</span>
<a href="#l76.520"></a><span id="l76.520" class="difflineplus">+          char *part;</span>
<a href="#l76.521"></a><span id="l76.521">           if (!imappartnum.IsEmpty())</span>
<a href="#l76.522"></a><span id="l76.522" class="difflineminus">-            part = mime_set_url_imap_part(obj-&gt;options-&gt;url, imappartnum.get(), partnum.get());</span>
<a href="#l76.523"></a><span id="l76.523" class="difflineminus">-          else</span>
<a href="#l76.524"></a><span id="l76.524" class="difflineminus">-          {</span>
<a href="#l76.525"></a><span id="l76.525" class="difflineplus">+            part = mime_set_url_imap_part(obj-&gt;options-&gt;url, imappartnum.get(),</span>
<a href="#l76.526"></a><span id="l76.526" class="difflineplus">+                                          partnum.get());</span>
<a href="#l76.527"></a><span id="l76.527" class="difflineplus">+          else {</span>
<a href="#l76.528"></a><span id="l76.528">             char *no_part_url = nullptr;</span>
<a href="#l76.529"></a><span id="l76.529" class="difflineminus">-            if (obj-&gt;options-&gt;part_to_load &amp;&amp; obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay)</span>
<a href="#l76.530"></a><span id="l76.530" class="difflineplus">+            if (obj-&gt;options-&gt;part_to_load &amp;&amp;</span>
<a href="#l76.531"></a><span id="l76.531" class="difflineplus">+                obj-&gt;options-&gt;format_out ==</span>
<a href="#l76.532"></a><span id="l76.532" class="difflineplus">+                    nsMimeOutput::nsMimeMessageBodyDisplay)</span>
<a href="#l76.533"></a><span id="l76.533">               no_part_url = mime_get_base_url(obj-&gt;options-&gt;url);</span>
<a href="#l76.534"></a><span id="l76.534" class="difflineminus">-            if (no_part_url)</span>
<a href="#l76.535"></a><span id="l76.535" class="difflineminus">-            {</span>
<a href="#l76.536"></a><span id="l76.536" class="difflineplus">+            if (no_part_url) {</span>
<a href="#l76.537"></a><span id="l76.537">               part = mime_set_url_part(no_part_url, partnum.get(), false);</span>
<a href="#l76.538"></a><span id="l76.538">               PR_Free(no_part_url);</span>
<a href="#l76.539"></a><span id="l76.539" class="difflineminus">-            }</span>
<a href="#l76.540"></a><span id="l76.540" class="difflineminus">-            else</span>
<a href="#l76.541"></a><span id="l76.541" class="difflineplus">+            } else</span>
<a href="#l76.542"></a><span id="l76.542">               part = mime_set_url_part(obj-&gt;options-&gt;url, partnum.get(), false);</span>
<a href="#l76.543"></a><span id="l76.543">           }</span>
<a href="#l76.544"></a><span id="l76.544" class="difflineminus">-          if (part)</span>
<a href="#l76.545"></a><span id="l76.545" class="difflineminus">-          {</span>
<a href="#l76.546"></a><span id="l76.546" class="difflineplus">+          if (part) {</span>
<a href="#l76.547"></a><span id="l76.547">             char *name = MimeHeaders_get_name(child-&gt;headers, child-&gt;options);</span>
<a href="#l76.548"></a><span id="l76.548">             // let's stick the filename in the part so save as will work.</span>
<a href="#l76.549"></a><span id="l76.549" class="difflineminus">-            if (name)</span>
<a href="#l76.550"></a><span id="l76.550" class="difflineminus">-            {</span>
<a href="#l76.551"></a><span id="l76.551" class="difflineplus">+            if (name) {</span>
<a href="#l76.552"></a><span id="l76.552">               char *savePart = part;</span>
<a href="#l76.553"></a><span id="l76.553">               part = PR_smprintf(&quot;%s&amp;filename=%s&quot;, savePart, name);</span>
<a href="#l76.554"></a><span id="l76.554">               PR_Free(savePart);</span>
<a href="#l76.555"></a><span id="l76.555">               PR_Free(name);</span>
<a href="#l76.556"></a><span id="l76.556">             }</span>
<a href="#l76.557"></a><span id="l76.557">             char *temp = part;</span>
<a href="#l76.558"></a><span id="l76.558">             /* If there's a space in the url, escape the url.</span>
<a href="#l76.559"></a><span id="l76.559">                (This happens primarily on Windows and Unix.) */</span>
<a href="#l76.560"></a><span id="l76.560" class="difflineminus">-            if (PL_strchr(part, ' ') || PL_strchr(part, '&gt;') || PL_strchr(part, '%'))</span>
<a href="#l76.561"></a><span id="l76.561" class="difflineplus">+            if (PL_strchr(part, ' ') || PL_strchr(part, '&gt;') ||</span>
<a href="#l76.562"></a><span id="l76.562" class="difflineplus">+                PL_strchr(part, '%'))</span>
<a href="#l76.563"></a><span id="l76.563">               temp = escape_for_mrel_subst(part);</span>
<a href="#l76.564"></a><span id="l76.564" class="difflineminus">-            MimeHashValue * value = new MimeHashValue(child, temp);</span>
<a href="#l76.565"></a><span id="l76.565" class="difflineplus">+            MimeHashValue *value = new MimeHashValue(child, temp);</span>
<a href="#l76.566"></a><span id="l76.566">             PL_HashTableAdd(relobj-&gt;hash, absolute, value);</span>
<a href="#l76.567"></a><span id="l76.567"> </span>
<a href="#l76.568"></a><span id="l76.568">             /* rhp - If this part ALSO has a Content-ID we need to put that into</span>
<a href="#l76.569"></a><span id="l76.569">                      the hash table and this is what this code does</span>
<a href="#l76.570"></a><span id="l76.570">              */</span>
<a href="#l76.571"></a><span id="l76.571">             {</span>
<a href="#l76.572"></a><span id="l76.572">               char *tloc;</span>
<a href="#l76.573"></a><span id="l76.573" class="difflineminus">-              char *tmp = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_ID, false, false);</span>
<a href="#l76.574"></a><span id="l76.574" class="difflineminus">-              if (tmp)</span>
<a href="#l76.575"></a><span id="l76.575" class="difflineminus">-              {</span>
<a href="#l76.576"></a><span id="l76.576" class="difflineminus">-                char* tmp2 = tmp;</span>
<a href="#l76.577"></a><span id="l76.577" class="difflineminus">-                if (*tmp2 == '&lt;')</span>
<a href="#l76.578"></a><span id="l76.578" class="difflineminus">-                {</span>
<a href="#l76.579"></a><span id="l76.579" class="difflineplus">+              char *tmp = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_ID,</span>
<a href="#l76.580"></a><span id="l76.580" class="difflineplus">+                                          false, false);</span>
<a href="#l76.581"></a><span id="l76.581" class="difflineplus">+              if (tmp) {</span>
<a href="#l76.582"></a><span id="l76.582" class="difflineplus">+                char *tmp2 = tmp;</span>
<a href="#l76.583"></a><span id="l76.583" class="difflineplus">+                if (*tmp2 == '&lt;') {</span>
<a href="#l76.584"></a><span id="l76.584">                   int length;</span>
<a href="#l76.585"></a><span id="l76.585">                   tmp2++;</span>
<a href="#l76.586"></a><span id="l76.586">                   length = strlen(tmp2);</span>
<a href="#l76.587"></a><span id="l76.587" class="difflineminus">-                  if (length &gt; 0 &amp;&amp; tmp2[length - 1] == '&gt;')</span>
<a href="#l76.588"></a><span id="l76.588" class="difflineminus">-                  {</span>
<a href="#l76.589"></a><span id="l76.589" class="difflineplus">+                  if (length &gt; 0 &amp;&amp; tmp2[length - 1] == '&gt;') {</span>
<a href="#l76.590"></a><span id="l76.590">                     tmp2[length - 1] = '\0';</span>
<a href="#l76.591"></a><span id="l76.591">                   }</span>
<a href="#l76.592"></a><span id="l76.592">                 }</span>
<a href="#l76.593"></a><span id="l76.593"> </span>
<a href="#l76.594"></a><span id="l76.594">                 tloc = PR_smprintf(&quot;cid:%s&quot;, tmp2);</span>
<a href="#l76.595"></a><span id="l76.595">                 PR_Free(tmp);</span>
<a href="#l76.596"></a><span id="l76.596" class="difflineminus">-                if (tloc)</span>
<a href="#l76.597"></a><span id="l76.597" class="difflineminus">-                {</span>
<a href="#l76.598"></a><span id="l76.598" class="difflineplus">+                if (tloc) {</span>
<a href="#l76.599"></a><span id="l76.599">                   MimeHashValue *value;</span>
<a href="#l76.600"></a><span id="l76.600" class="difflineminus">-                  value = (MimeHashValue*)PL_HashTableLookup(relobj-&gt;hash, tloc);</span>
<a href="#l76.601"></a><span id="l76.601" class="difflineplus">+                  value =</span>
<a href="#l76.602"></a><span id="l76.602" class="difflineplus">+                      (MimeHashValue *)PL_HashTableLookup(relobj-&gt;hash, tloc);</span>
<a href="#l76.603"></a><span id="l76.603"> </span>
<a href="#l76.604"></a><span id="l76.604" class="difflineminus">-                  if (!value)</span>
<a href="#l76.605"></a><span id="l76.605" class="difflineminus">-                  {</span>
<a href="#l76.606"></a><span id="l76.606" class="difflineplus">+                  if (!value) {</span>
<a href="#l76.607"></a><span id="l76.607">                     value = new MimeHashValue(child, temp);</span>
<a href="#l76.608"></a><span id="l76.608">                     PL_HashTableAdd(relobj-&gt;hash, tloc, value);</span>
<a href="#l76.609"></a><span id="l76.609" class="difflineminus">-                  }</span>
<a href="#l76.610"></a><span id="l76.610" class="difflineminus">-                  else</span>
<a href="#l76.611"></a><span id="l76.611" class="difflineplus">+                  } else</span>
<a href="#l76.612"></a><span id="l76.612">                     PR_smprintf_free(tloc);</span>
<a href="#l76.613"></a><span id="l76.613">                 }</span>
<a href="#l76.614"></a><span id="l76.614">               }</span>
<a href="#l76.615"></a><span id="l76.615">             }</span>
<a href="#l76.616"></a><span id="l76.616">             /*  rhp - End of putting more stuff into the hash table */</span>
<a href="#l76.617"></a><span id="l76.617"> </span>
<a href="#l76.618"></a><span id="l76.618" class="difflineminus">-              /* it's possible that temp pointer is the same than the part pointer,</span>
<a href="#l76.619"></a><span id="l76.619" class="difflineminus">-                 therefore be careful to not freeing twice the same pointer */</span>
<a href="#l76.620"></a><span id="l76.620" class="difflineminus">-              if (temp &amp;&amp; temp != part)</span>
<a href="#l76.621"></a><span id="l76.621" class="difflineminus">-                PR_Free(temp);</span>
<a href="#l76.622"></a><span id="l76.622" class="difflineminus">-              PR_Free(part);</span>
<a href="#l76.623"></a><span id="l76.623" class="difflineminus">-            }</span>
<a href="#l76.624"></a><span id="l76.624" class="difflineplus">+            /* it's possible that temp pointer is the same than the part</span>
<a href="#l76.625"></a><span id="l76.625" class="difflineplus">+               pointer, therefore be careful to not freeing twice the same</span>
<a href="#l76.626"></a><span id="l76.626" class="difflineplus">+               pointer */</span>
<a href="#l76.627"></a><span id="l76.627" class="difflineplus">+            if (temp &amp;&amp; temp != part) PR_Free(temp);</span>
<a href="#l76.628"></a><span id="l76.628" class="difflineplus">+            PR_Free(part);</span>
<a href="#l76.629"></a><span id="l76.629">           }</span>
<a href="#l76.630"></a><span id="l76.630">         }</span>
<a href="#l76.631"></a><span id="l76.631">       }</span>
<a href="#l76.632"></a><span id="l76.632" class="difflineplus">+    }</span>
<a href="#l76.633"></a><span id="l76.633">   } else {</span>
<a href="#l76.634"></a><span id="l76.634">     /* Ah-hah!  We're the head object.  */</span>
<a href="#l76.635"></a><span id="l76.635" class="difflineminus">-    char* base_url;</span>
<a href="#l76.636"></a><span id="l76.636" class="difflineplus">+    char *base_url;</span>
<a href="#l76.637"></a><span id="l76.637">     relobj-&gt;head_loaded = true;</span>
<a href="#l76.638"></a><span id="l76.638">     relobj-&gt;headobj = child;</span>
<a href="#l76.639"></a><span id="l76.639">     relobj-&gt;buffered_hdrs = MimeHeaders_copy(child-&gt;headers);</span>
<a href="#l76.640"></a><span id="l76.640" class="difflineminus">-    base_url = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_BASE,</span>
<a href="#l76.641"></a><span id="l76.641" class="difflineminus">-                   false, false);</span>
<a href="#l76.642"></a><span id="l76.642" class="difflineplus">+    base_url =</span>
<a href="#l76.643"></a><span id="l76.643" class="difflineplus">+        MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_BASE, false, false);</span>
<a href="#l76.644"></a><span id="l76.644">     /* rhp: need this for supporting Content-Location */</span>
<a href="#l76.645"></a><span id="l76.645" class="difflineminus">-    if (!base_url)</span>
<a href="#l76.646"></a><span id="l76.646" class="difflineminus">-    {</span>
<a href="#l76.647"></a><span id="l76.647" class="difflineminus">-      base_url = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_LOCATION, false, false);</span>
<a href="#l76.648"></a><span id="l76.648" class="difflineplus">+    if (!base_url) {</span>
<a href="#l76.649"></a><span id="l76.649" class="difflineplus">+      base_url = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_LOCATION, false,</span>
<a href="#l76.650"></a><span id="l76.650" class="difflineplus">+                                 false);</span>
<a href="#l76.651"></a><span id="l76.651">     }</span>
<a href="#l76.652"></a><span id="l76.652">     /* rhp: need this for supporting Content-Location */</span>
<a href="#l76.653"></a><span id="l76.653"> </span>
<a href="#l76.654"></a><span id="l76.654">     if (base_url) {</span>
<a href="#l76.655"></a><span id="l76.655">       /* If the head object has a base_url associated with it, use</span>
<a href="#l76.656"></a><span id="l76.656">          that instead of any base_url that may have been associated</span>
<a href="#l76.657"></a><span id="l76.657">          with the multipart/related. */</span>
<a href="#l76.658"></a><span id="l76.658">       PR_FREEIF(relobj-&gt;base_url);</span>
<a href="#l76.659"></a><span id="l76.659">       relobj-&gt;base_url = base_url;</span>
<a href="#l76.660"></a><span id="l76.660">     }</span>
<a href="#l76.661"></a><span id="l76.661">   }</span>
<a href="#l76.662"></a><span id="l76.662">   if (obj-&gt;options &amp;&amp; !obj-&gt;options-&gt;write_html_p</span>
<a href="#l76.663"></a><span id="l76.663"> #ifdef MIME_DRAFTS</span>
<a href="#l76.664"></a><span id="l76.664" class="difflineminus">-    &amp;&amp; !obj-&gt;options-&gt;decompose_file_p</span>
<a href="#l76.665"></a><span id="l76.665" class="difflineplus">+      &amp;&amp; !obj-&gt;options-&gt;decompose_file_p</span>
<a href="#l76.666"></a><span id="l76.666"> #endif /* MIME_DRAFTS */</span>
<a href="#l76.667"></a><span id="l76.667" class="difflineminus">-    )</span>
<a href="#l76.668"></a><span id="l76.668" class="difflineminus">-    {</span>
<a href="#l76.669"></a><span id="l76.669" class="difflineplus">+  ) {</span>
<a href="#l76.670"></a><span id="l76.670">     return true;</span>
<a href="#l76.671"></a><span id="l76.671" class="difflineminus">-    }</span>
<a href="#l76.672"></a><span id="l76.672" class="difflineplus">+  }</span>
<a href="#l76.673"></a><span id="l76.673"> </span>
<a href="#l76.674"></a><span id="l76.674" class="difflineminus">-  return false;      /* Don't actually parse this child; we'll handle</span>
<a href="#l76.675"></a><span id="l76.675" class="difflineminus">-                 all that at eof time. */</span>
<a href="#l76.676"></a><span id="l76.676" class="difflineplus">+  return false; /* Don't actually parse this child; we'll handle</span>
<a href="#l76.677"></a><span id="l76.677" class="difflineplus">+            all that at eof time. */</span>
<a href="#l76.678"></a><span id="l76.678"> }</span>
<a href="#l76.679"></a><span id="l76.679"> </span>
<a href="#l76.680"></a><span id="l76.680" class="difflineminus">-static int</span>
<a href="#l76.681"></a><span id="l76.681" class="difflineminus">-MimeMultipartRelated_parse_child_line (MimeObject *obj,</span>
<a href="#l76.682"></a><span id="l76.682" class="difflineminus">-                     const char *line, int32_t length,</span>
<a href="#l76.683"></a><span id="l76.683" class="difflineminus">-                     bool first_line_p)</span>
<a href="#l76.684"></a><span id="l76.684" class="difflineminus">-{</span>
<a href="#l76.685"></a><span id="l76.685" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) obj;</span>
<a href="#l76.686"></a><span id="l76.686" class="difflineminus">-  MimeMultipartRelated *relobj = (MimeMultipartRelated *) obj;</span>
<a href="#l76.687"></a><span id="l76.687" class="difflineplus">+static int MimeMultipartRelated_parse_child_line(MimeObject *obj,</span>
<a href="#l76.688"></a><span id="l76.688" class="difflineplus">+                                                 const char *line,</span>
<a href="#l76.689"></a><span id="l76.689" class="difflineplus">+                                                 int32_t length,</span>
<a href="#l76.690"></a><span id="l76.690" class="difflineplus">+                                                 bool first_line_p) {</span>
<a href="#l76.691"></a><span id="l76.691" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l76.692"></a><span id="l76.692" class="difflineplus">+  MimeMultipartRelated *relobj = (MimeMultipartRelated *)obj;</span>
<a href="#l76.693"></a><span id="l76.693">   MimeObject *kid;</span>
<a href="#l76.694"></a><span id="l76.694"> </span>
<a href="#l76.695"></a><span id="l76.695">   if (obj-&gt;options &amp;&amp; !obj-&gt;options-&gt;write_html_p</span>
<a href="#l76.696"></a><span id="l76.696"> #ifdef MIME_DRAFTS</span>
<a href="#l76.697"></a><span id="l76.697" class="difflineminus">-    &amp;&amp; !obj-&gt;options-&gt;decompose_file_p</span>
<a href="#l76.698"></a><span id="l76.698" class="difflineplus">+      &amp;&amp; !obj-&gt;options-&gt;decompose_file_p</span>
<a href="#l76.699"></a><span id="l76.699"> #endif /* MIME_DRAFTS */</span>
<a href="#l76.700"></a><span id="l76.700" class="difflineminus">-    )</span>
<a href="#l76.701"></a><span id="l76.701" class="difflineminus">-    {</span>
<a href="#l76.702"></a><span id="l76.702" class="difflineplus">+  ) {</span>
<a href="#l76.703"></a><span id="l76.703">     /* Oh, just go do the normal thing... */</span>
<a href="#l76.704"></a><span id="l76.704" class="difflineminus">-    return ((MimeMultipartClass*)&amp;MIME_SUPERCLASS)-&gt;</span>
<a href="#l76.705"></a><span id="l76.705" class="difflineminus">-      parse_child_line(obj, line, length, first_line_p);</span>
<a href="#l76.706"></a><span id="l76.706" class="difflineminus">-    }</span>
<a href="#l76.707"></a><span id="l76.707" class="difflineplus">+    return ((MimeMultipartClass *)&amp;MIME_SUPERCLASS)</span>
<a href="#l76.708"></a><span id="l76.708" class="difflineplus">+        -&gt;parse_child_line(obj, line, length, first_line_p);</span>
<a href="#l76.709"></a><span id="l76.709" class="difflineplus">+  }</span>
<a href="#l76.710"></a><span id="l76.710"> </span>
<a href="#l76.711"></a><span id="l76.711">   /* Throw it away if this isn't the head object.  (Someday, maybe we'll</span>
<a href="#l76.712"></a><span id="l76.712">      cache it instead.) */</span>
<a href="#l76.713"></a><span id="l76.713">   PR_ASSERT(cont-&gt;nchildren &gt; 0);</span>
<a href="#l76.714"></a><span id="l76.714" class="difflineminus">-  if (cont-&gt;nchildren &lt;= 0)</span>
<a href="#l76.715"></a><span id="l76.715" class="difflineminus">-    return -1;</span>
<a href="#l76.716"></a><span id="l76.716" class="difflineminus">-  kid = cont-&gt;children[cont-&gt;nchildren-1];</span>
<a href="#l76.717"></a><span id="l76.717" class="difflineplus">+  if (cont-&gt;nchildren &lt;= 0) return -1;</span>
<a href="#l76.718"></a><span id="l76.718" class="difflineplus">+  kid = cont-&gt;children[cont-&gt;nchildren - 1];</span>
<a href="#l76.719"></a><span id="l76.719">   PR_ASSERT(kid);</span>
<a href="#l76.720"></a><span id="l76.720">   if (!kid) return -1;</span>
<a href="#l76.721"></a><span id="l76.721">   if (kid != relobj-&gt;headobj) return 0;</span>
<a href="#l76.722"></a><span id="l76.722"> </span>
<a href="#l76.723"></a><span id="l76.723">   /* Buffer this up (###tw much code duplication from mimemalt.c) */</span>
<a href="#l76.724"></a><span id="l76.724">   /* If we don't yet have a buffer (either memory or file) try and make a</span>
<a href="#l76.725"></a><span id="l76.725">      memory buffer. */</span>
<a href="#l76.726"></a><span id="l76.726">   if (!relobj-&gt;head_buffer &amp;&amp; !relobj-&gt;file_buffer) {</span>
<a href="#l76.727"></a><span id="l76.727" class="difflineminus">-    int target_size = 1024 * 50;       /* try for 50k */</span>
<a href="#l76.728"></a><span id="l76.728" class="difflineplus">+    int target_size = 1024 * 50; /* try for 50k */</span>
<a href="#l76.729"></a><span id="l76.729">     while (target_size &gt; 0) {</span>
<a href="#l76.730"></a><span id="l76.730" class="difflineminus">-      relobj-&gt;head_buffer = (char *) PR_MALLOC(target_size);</span>
<a href="#l76.731"></a><span id="l76.731" class="difflineminus">-      if (relobj-&gt;head_buffer) break;  /* got it! */</span>
<a href="#l76.732"></a><span id="l76.732" class="difflineminus">-      target_size -= (1024 * 5);     /* decrease it and try again */</span>
<a href="#l76.733"></a><span id="l76.733" class="difflineplus">+      relobj-&gt;head_buffer = (char *)PR_MALLOC(target_size);</span>
<a href="#l76.734"></a><span id="l76.734" class="difflineplus">+      if (relobj-&gt;head_buffer) break; /* got it! */</span>
<a href="#l76.735"></a><span id="l76.735" class="difflineplus">+      target_size -= (1024 * 5);      /* decrease it and try again */</span>
<a href="#l76.736"></a><span id="l76.736">     }</span>
<a href="#l76.737"></a><span id="l76.737"> </span>
<a href="#l76.738"></a><span id="l76.738">     if (relobj-&gt;head_buffer) {</span>
<a href="#l76.739"></a><span id="l76.739">       relobj-&gt;head_buffer_size = target_size;</span>
<a href="#l76.740"></a><span id="l76.740">     } else {</span>
<a href="#l76.741"></a><span id="l76.741">       relobj-&gt;head_buffer_size = 0;</span>
<a href="#l76.742"></a><span id="l76.742">     }</span>
<a href="#l76.743"></a><span id="l76.743"> </span>
<a href="#l76.744"></a><span id="l76.744">     relobj-&gt;head_buffer_fp = 0;</span>
<a href="#l76.745"></a><span id="l76.745">   }</span>
<a href="#l76.746"></a><span id="l76.746"> </span>
<a href="#l76.747"></a><span id="l76.747">   nsresult rv;</span>
<a href="#l76.748"></a><span id="l76.748">   /* Ok, if at this point we still don't have either kind of buffer, try and</span>
<a href="#l76.749"></a><span id="l76.749">      make a file buffer. */</span>
<a href="#l76.750"></a><span id="l76.750" class="difflineminus">-  if (!relobj-&gt;head_buffer &amp;&amp; !relobj-&gt;file_buffer)</span>
<a href="#l76.751"></a><span id="l76.751" class="difflineminus">-  {</span>
<a href="#l76.752"></a><span id="l76.752" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l76.753"></a><span id="l76.753" class="difflineplus">+  if (!relobj-&gt;head_buffer &amp;&amp; !relobj-&gt;file_buffer) {</span>
<a href="#l76.754"></a><span id="l76.754" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l76.755"></a><span id="l76.755">     rv = nsMsgCreateTempFile(&quot;nsma&quot;, getter_AddRefs(file));</span>
<a href="#l76.756"></a><span id="l76.756">     NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l76.757"></a><span id="l76.757">     relobj-&gt;file_buffer = file;</span>
<a href="#l76.758"></a><span id="l76.758"> </span>
<a href="#l76.759"></a><span id="l76.759" class="difflineminus">-    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(relobj-&gt;output_file_stream), relobj-&gt;file_buffer, PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l76.760"></a><span id="l76.760" class="difflineplus">+    rv = MsgNewBufferedFileOutputStream(</span>
<a href="#l76.761"></a><span id="l76.761" class="difflineplus">+        getter_AddRefs(relobj-&gt;output_file_stream), relobj-&gt;file_buffer,</span>
<a href="#l76.762"></a><span id="l76.762" class="difflineplus">+        PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l76.763"></a><span id="l76.763">     NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l76.764"></a><span id="l76.764">   }</span>
<a href="#l76.765"></a><span id="l76.765"> </span>
<a href="#l76.766"></a><span id="l76.766">   PR_ASSERT(relobj-&gt;head_buffer || relobj-&gt;output_file_stream);</span>
<a href="#l76.767"></a><span id="l76.767"> </span>
<a href="#l76.768"></a><span id="l76.768" class="difflineminus">-</span>
<a href="#l76.769"></a><span id="l76.769">   /* If this line will fit in the memory buffer, put it there.</span>
<a href="#l76.770"></a><span id="l76.770">    */</span>
<a href="#l76.771"></a><span id="l76.771">   if (relobj-&gt;head_buffer &amp;&amp;</span>
<a href="#l76.772"></a><span id="l76.772">       relobj-&gt;head_buffer_fp + length &lt; relobj-&gt;head_buffer_size) {</span>
<a href="#l76.773"></a><span id="l76.773">     memcpy(relobj-&gt;head_buffer + relobj-&gt;head_buffer_fp, line, length);</span>
<a href="#l76.774"></a><span id="l76.774">     relobj-&gt;head_buffer_fp += length;</span>
<a href="#l76.775"></a><span id="l76.775">   } else {</span>
<a href="#l76.776"></a><span id="l76.776">     /* Otherwise it won't fit; write it to the file instead. */</span>
<a href="#l76.777"></a><span id="l76.777"> </span>
<a href="#l76.778"></a><span id="l76.778">     /* If the file isn't open yet, open it, and dump the memory buffer</span>
<a href="#l76.779"></a><span id="l76.779">        to it. */</span>
<a href="#l76.780"></a><span id="l76.780" class="difflineminus">-    if (!relobj-&gt;output_file_stream)</span>
<a href="#l76.781"></a><span id="l76.781" class="difflineminus">-    {</span>
<a href="#l76.782"></a><span id="l76.782" class="difflineminus">-      if (!relobj-&gt;file_buffer)</span>
<a href="#l76.783"></a><span id="l76.783" class="difflineminus">-      {</span>
<a href="#l76.784"></a><span id="l76.784" class="difflineminus">-        nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l76.785"></a><span id="l76.785" class="difflineplus">+    if (!relobj-&gt;output_file_stream) {</span>
<a href="#l76.786"></a><span id="l76.786" class="difflineplus">+      if (!relobj-&gt;file_buffer) {</span>
<a href="#l76.787"></a><span id="l76.787" class="difflineplus">+        nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l76.788"></a><span id="l76.788">         rv = nsMsgCreateTempFile(&quot;nsma&quot;, getter_AddRefs(file));</span>
<a href="#l76.789"></a><span id="l76.789">         NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l76.790"></a><span id="l76.790">         relobj-&gt;file_buffer = file;</span>
<a href="#l76.791"></a><span id="l76.791">       }</span>
<a href="#l76.792"></a><span id="l76.792"> </span>
<a href="#l76.793"></a><span id="l76.793" class="difflineminus">-      nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(relobj-&gt;output_file_stream), relobj-&gt;file_buffer, PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l76.794"></a><span id="l76.794" class="difflineplus">+      nsresult rv = MsgNewBufferedFileOutputStream(</span>
<a href="#l76.795"></a><span id="l76.795" class="difflineplus">+          getter_AddRefs(relobj-&gt;output_file_stream), relobj-&gt;file_buffer,</span>
<a href="#l76.796"></a><span id="l76.796" class="difflineplus">+          PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l76.797"></a><span id="l76.797">       NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l76.798"></a><span id="l76.798"> </span>
<a href="#l76.799"></a><span id="l76.799" class="difflineminus">-      if (relobj-&gt;head_buffer &amp;&amp; relobj-&gt;head_buffer_fp)</span>
<a href="#l76.800"></a><span id="l76.800" class="difflineminus">-      {</span>
<a href="#l76.801"></a><span id="l76.801" class="difflineplus">+      if (relobj-&gt;head_buffer &amp;&amp; relobj-&gt;head_buffer_fp) {</span>
<a href="#l76.802"></a><span id="l76.802">         uint32_t bytesWritten;</span>
<a href="#l76.803"></a><span id="l76.803" class="difflineminus">-        rv = relobj-&gt;output_file_stream-&gt;Write(relobj-&gt;head_buffer, relobj-&gt;head_buffer_fp, &amp;bytesWritten);</span>
<a href="#l76.804"></a><span id="l76.804" class="difflineplus">+        rv = relobj-&gt;output_file_stream-&gt;Write(</span>
<a href="#l76.805"></a><span id="l76.805" class="difflineplus">+            relobj-&gt;head_buffer, relobj-&gt;head_buffer_fp, &amp;bytesWritten);</span>
<a href="#l76.806"></a><span id="l76.806">         if (NS_FAILED(rv) || (bytesWritten &lt; relobj-&gt;head_buffer_fp))</span>
<a href="#l76.807"></a><span id="l76.807">           return MIME_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l76.808"></a><span id="l76.808">       }</span>
<a href="#l76.809"></a><span id="l76.809"> </span>
<a href="#l76.810"></a><span id="l76.810">       PR_FREEIF(relobj-&gt;head_buffer);</span>
<a href="#l76.811"></a><span id="l76.811">       relobj-&gt;head_buffer_fp = 0;</span>
<a href="#l76.812"></a><span id="l76.812">       relobj-&gt;head_buffer_size = 0;</span>
<a href="#l76.813"></a><span id="l76.813">     }</span>
<a href="#l76.814"></a><span id="l76.814"> </span>
<a href="#l76.815"></a><span id="l76.815">     /* Dump this line to the file. */</span>
<a href="#l76.816"></a><span id="l76.816">     uint32_t bytesWritten;</span>
<a href="#l76.817"></a><span id="l76.817">     rv = relobj-&gt;output_file_stream-&gt;Write(line, length, &amp;bytesWritten);</span>
<a href="#l76.818"></a><span id="l76.818" class="difflineminus">-    if ((int32_t) bytesWritten &lt; length || NS_FAILED(rv))</span>
<a href="#l76.819"></a><span id="l76.819" class="difflineplus">+    if ((int32_t)bytesWritten &lt; length || NS_FAILED(rv))</span>
<a href="#l76.820"></a><span id="l76.820">       return MIME_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l76.821"></a><span id="l76.821">   }</span>
<a href="#l76.822"></a><span id="l76.822"> </span>
<a href="#l76.823"></a><span id="l76.823">   return 0;</span>
<a href="#l76.824"></a><span id="l76.824"> }</span>
<a href="#l76.825"></a><span id="l76.825"> </span>
<a href="#l76.826"></a><span id="l76.826" class="difflineminus">-</span>
<a href="#l76.827"></a><span id="l76.827" class="difflineminus">-</span>
<a href="#l76.828"></a><span id="l76.828" class="difflineminus">-</span>
<a href="#l76.829"></a><span id="l76.829" class="difflineminus">-static int</span>
<a href="#l76.830"></a><span id="l76.830" class="difflineminus">-real_write(MimeMultipartRelated* relobj, const char* buf, int32_t size)</span>
<a href="#l76.831"></a><span id="l76.831" class="difflineminus">-{</span>
<a href="#l76.832"></a><span id="l76.832" class="difflineminus">-  MimeObject* obj = (MimeObject*) relobj;</span>
<a href="#l76.833"></a><span id="l76.833" class="difflineminus">-  void* closure = relobj-&gt;real_output_closure;</span>
<a href="#l76.834"></a><span id="l76.834" class="difflineplus">+static int real_write(MimeMultipartRelated *relobj, const char *buf,</span>
<a href="#l76.835"></a><span id="l76.835" class="difflineplus">+                      int32_t size) {</span>
<a href="#l76.836"></a><span id="l76.836" class="difflineplus">+  MimeObject *obj = (MimeObject *)relobj;</span>
<a href="#l76.837"></a><span id="l76.837" class="difflineplus">+  void *closure = relobj-&gt;real_output_closure;</span>
<a href="#l76.838"></a><span id="l76.838"> </span>
<a href="#l76.839"></a><span id="l76.839"> #ifdef MIME_DRAFTS</span>
<a href="#l76.840"></a><span id="l76.840" class="difflineminus">-  if ( obj-&gt;options &amp;&amp;</span>
<a href="#l76.841"></a><span id="l76.841" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l76.842"></a><span id="l76.842" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_output_fn )</span>
<a href="#l76.843"></a><span id="l76.843" class="difflineminus">-  {</span>
<a href="#l76.844"></a><span id="l76.844" class="difflineminus">-</span>
<a href="#l76.845"></a><span id="l76.845" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l76.846"></a><span id="l76.846" class="difflineplus">+      obj-&gt;options-&gt;decompose_file_output_fn) {</span>
<a href="#l76.847"></a><span id="l76.847">     // the buf here has already been decoded, but we want to use general output</span>
<a href="#l76.848"></a><span id="l76.848">     // functions here that permit decoded or encoded input, using the closure</span>
<a href="#l76.849"></a><span id="l76.849">     // to tell the difference. We'll temporarily disable the closure's decoder,</span>
<a href="#l76.850"></a><span id="l76.850" class="difflineminus">-    // then restore it when we are done. Not sure if we shouldn't just turn it off</span>
<a href="#l76.851"></a><span id="l76.851" class="difflineminus">-    // permanently though.</span>
<a href="#l76.852"></a><span id="l76.852" class="difflineplus">+    // then restore it when we are done. Not sure if we shouldn't just turn it</span>
<a href="#l76.853"></a><span id="l76.853" class="difflineplus">+    // off permanently though.</span>
<a href="#l76.854"></a><span id="l76.854"> </span>
<a href="#l76.855"></a><span id="l76.855" class="difflineminus">-    mime_draft_data *mdd = (mime_draft_data *) obj-&gt;options-&gt;stream_closure;</span>
<a href="#l76.856"></a><span id="l76.856" class="difflineminus">-    MimeDecoderData* old_decoder_data = mdd-&gt;decoder_data;</span>
<a href="#l76.857"></a><span id="l76.857" class="difflineplus">+    mime_draft_data *mdd = (mime_draft_data *)obj-&gt;options-&gt;stream_closure;</span>
<a href="#l76.858"></a><span id="l76.858" class="difflineplus">+    MimeDecoderData *old_decoder_data = mdd-&gt;decoder_data;</span>
<a href="#l76.859"></a><span id="l76.859">     mdd-&gt;decoder_data = nullptr;</span>
<a href="#l76.860"></a><span id="l76.860" class="difflineminus">-    int status = obj-&gt;options-&gt;decompose_file_output_fn</span>
<a href="#l76.861"></a><span id="l76.861" class="difflineminus">-                 (buf, size, (void *)mdd);</span>
<a href="#l76.862"></a><span id="l76.862" class="difflineplus">+    int status = obj-&gt;options-&gt;decompose_file_output_fn(buf, size, (void *)mdd);</span>
<a href="#l76.863"></a><span id="l76.863">     mdd-&gt;decoder_data = old_decoder_data;</span>
<a href="#l76.864"></a><span id="l76.864">     return status;</span>
<a href="#l76.865"></a><span id="l76.865" class="difflineminus">-  }</span>
<a href="#l76.866"></a><span id="l76.866" class="difflineminus">-  else</span>
<a href="#l76.867"></a><span id="l76.867" class="difflineplus">+  } else</span>
<a href="#l76.868"></a><span id="l76.868"> #endif /* MIME_DRAFTS */</span>
<a href="#l76.869"></a><span id="l76.869">   {</span>
<a href="#l76.870"></a><span id="l76.870">     if (!closure) {</span>
<a href="#l76.871"></a><span id="l76.871" class="difflineminus">-      MimeObject* lobj = (MimeObject*) relobj;</span>
<a href="#l76.872"></a><span id="l76.872" class="difflineplus">+      MimeObject *lobj = (MimeObject *)relobj;</span>
<a href="#l76.873"></a><span id="l76.873">       closure = lobj-&gt;options-&gt;stream_closure;</span>
<a href="#l76.874"></a><span id="l76.874">     }</span>
<a href="#l76.875"></a><span id="l76.875">     return relobj-&gt;real_output_fn(buf, size, closure);</span>
<a href="#l76.876"></a><span id="l76.876">   }</span>
<a href="#l76.877"></a><span id="l76.877"> }</span>
<a href="#l76.878"></a><span id="l76.878"> </span>
<a href="#l76.879"></a><span id="l76.879" class="difflineminus">-</span>
<a href="#l76.880"></a><span id="l76.880" class="difflineminus">-static int</span>
<a href="#l76.881"></a><span id="l76.881" class="difflineminus">-push_tag(MimeMultipartRelated* relobj, const char* buf, int32_t size)</span>
<a href="#l76.882"></a><span id="l76.882" class="difflineminus">-{</span>
<a href="#l76.883"></a><span id="l76.883" class="difflineplus">+static int push_tag(MimeMultipartRelated *relobj, const char *buf,</span>
<a href="#l76.884"></a><span id="l76.884" class="difflineplus">+                    int32_t size) {</span>
<a href="#l76.885"></a><span id="l76.885">   if (size + relobj-&gt;curtag_length &gt; relobj-&gt;curtag_max) {</span>
<a href="#l76.886"></a><span id="l76.886">     relobj-&gt;curtag_max += 2 * size;</span>
<a href="#l76.887"></a><span id="l76.887" class="difflineminus">-    if (relobj-&gt;curtag_max &lt; 1024)</span>
<a href="#l76.888"></a><span id="l76.888" class="difflineminus">-      relobj-&gt;curtag_max = 1024;</span>
<a href="#l76.889"></a><span id="l76.889" class="difflineplus">+    if (relobj-&gt;curtag_max &lt; 1024) relobj-&gt;curtag_max = 1024;</span>
<a href="#l76.890"></a><span id="l76.890"> </span>
<a href="#l76.891"></a><span id="l76.891" class="difflineminus">-    char* newBuf = (char*) PR_Realloc(relobj-&gt;curtag, relobj-&gt;curtag_max);</span>
<a href="#l76.892"></a><span id="l76.892" class="difflineplus">+    char *newBuf = (char *)PR_Realloc(relobj-&gt;curtag, relobj-&gt;curtag_max);</span>
<a href="#l76.893"></a><span id="l76.893">     NS_ENSURE_TRUE(newBuf, MIME_OUT_OF_MEMORY);</span>
<a href="#l76.894"></a><span id="l76.894">     relobj-&gt;curtag = newBuf;</span>
<a href="#l76.895"></a><span id="l76.895">   }</span>
<a href="#l76.896"></a><span id="l76.896">   memcpy(relobj-&gt;curtag + relobj-&gt;curtag_length, buf, size);</span>
<a href="#l76.897"></a><span id="l76.897">   relobj-&gt;curtag_length += size;</span>
<a href="#l76.898"></a><span id="l76.898">   return 0;</span>
<a href="#l76.899"></a><span id="l76.899"> }</span>
<a href="#l76.900"></a><span id="l76.900"> </span>
<a href="#l76.901"></a><span id="l76.901" class="difflineminus">-static bool accept_related_part(MimeMultipartRelated* relobj, MimeObject* part_obj)</span>
<a href="#l76.902"></a><span id="l76.902" class="difflineminus">-{</span>
<a href="#l76.903"></a><span id="l76.903" class="difflineminus">-  if (!relobj || !part_obj)</span>
<a href="#l76.904"></a><span id="l76.904" class="difflineminus">-    return false;</span>
<a href="#l76.905"></a><span id="l76.905" class="difflineplus">+static bool accept_related_part(MimeMultipartRelated *relobj,</span>
<a href="#l76.906"></a><span id="l76.906" class="difflineplus">+                                MimeObject *part_obj) {</span>
<a href="#l76.907"></a><span id="l76.907" class="difflineplus">+  if (!relobj || !part_obj) return false;</span>
<a href="#l76.908"></a><span id="l76.908"> </span>
<a href="#l76.909"></a><span id="l76.909">   /* before accepting it as a valid related part, make sure we</span>
<a href="#l76.910"></a><span id="l76.910">      are able to display it inline as an embedded object. Else just ignore</span>
<a href="#l76.911"></a><span id="l76.911">      it, that will prevent any bad surprise... */</span>
<a href="#l76.912"></a><span id="l76.912" class="difflineminus">-  MimeObjectClass *clazz = mime_find_class (part_obj-&gt;content_type, part_obj-&gt;headers, part_obj-&gt;options, false);</span>
<a href="#l76.913"></a><span id="l76.913" class="difflineplus">+  MimeObjectClass *clazz = mime_find_class(</span>
<a href="#l76.914"></a><span id="l76.914" class="difflineplus">+      part_obj-&gt;content_type, part_obj-&gt;headers, part_obj-&gt;options, false);</span>
<a href="#l76.915"></a><span id="l76.915">   if (clazz ? clazz-&gt;displayable_inline_p(clazz, part_obj-&gt;headers) : false)</span>
<a href="#l76.916"></a><span id="l76.916">     return true;</span>
<a href="#l76.917"></a><span id="l76.917"> </span>
<a href="#l76.918"></a><span id="l76.918">   /* ...but we always accept it if it's referenced by an anchor */</span>
<a href="#l76.919"></a><span id="l76.919">   return (relobj-&gt;curtag &amp;&amp; relobj-&gt;curtag_length &gt;= 3 &amp;&amp;</span>
<a href="#l76.920"></a><span id="l76.920" class="difflineminus">-    (relobj-&gt;curtag[1] == 'A' || relobj-&gt;curtag[1] == 'a') &amp;&amp; IS_SPACE(relobj-&gt;curtag[2]));</span>
<a href="#l76.921"></a><span id="l76.921" class="difflineplus">+          (relobj-&gt;curtag[1] == 'A' || relobj-&gt;curtag[1] == 'a') &amp;&amp;</span>
<a href="#l76.922"></a><span id="l76.922" class="difflineplus">+          IS_SPACE(relobj-&gt;curtag[2]));</span>
<a href="#l76.923"></a><span id="l76.923"> }</span>
<a href="#l76.924"></a><span id="l76.924"> </span>
<a href="#l76.925"></a><span id="l76.925" class="difflineminus">-static int</span>
<a href="#l76.926"></a><span id="l76.926" class="difflineminus">-flush_tag(MimeMultipartRelated* relobj)</span>
<a href="#l76.927"></a><span id="l76.927" class="difflineminus">-{</span>
<a href="#l76.928"></a><span id="l76.928" class="difflineplus">+static int flush_tag(MimeMultipartRelated *relobj) {</span>
<a href="#l76.929"></a><span id="l76.929">   int length = relobj-&gt;curtag_length;</span>
<a href="#l76.930"></a><span id="l76.930" class="difflineminus">-  char* buf;</span>
<a href="#l76.931"></a><span id="l76.931" class="difflineplus">+  char *buf;</span>
<a href="#l76.932"></a><span id="l76.932">   int status;</span>
<a href="#l76.933"></a><span id="l76.933"> </span>
<a href="#l76.934"></a><span id="l76.934">   if (relobj-&gt;curtag == NULL || length == 0) return 0;</span>
<a href="#l76.935"></a><span id="l76.935"> </span>
<a href="#l76.936"></a><span id="l76.936">   status = push_tag(relobj, &quot;&quot;, 1); /* Push on a trailing NULL. */</span>
<a href="#l76.937"></a><span id="l76.937">   if (status &lt; 0) return status;</span>
<a href="#l76.938"></a><span id="l76.938">   buf = relobj-&gt;curtag;</span>
<a href="#l76.939"></a><span id="l76.939">   PR_ASSERT(*buf == '&lt;' &amp;&amp; buf[length - 1] == '&gt;');</span>
<a href="#l76.940"></a><span id="l76.940">   while (*buf) {</span>
<a href="#l76.941"></a><span id="l76.941">     char c;</span>
<a href="#l76.942"></a><span id="l76.942" class="difflineminus">-    char* absolute;</span>
<a href="#l76.943"></a><span id="l76.943" class="difflineminus">-    char* part_url;</span>
<a href="#l76.944"></a><span id="l76.944" class="difflineminus">-    char* ptr = buf;</span>
<a href="#l76.945"></a><span id="l76.945" class="difflineplus">+    char *absolute;</span>
<a href="#l76.946"></a><span id="l76.946" class="difflineplus">+    char *part_url;</span>
<a href="#l76.947"></a><span id="l76.947" class="difflineplus">+    char *ptr = buf;</span>
<a href="#l76.948"></a><span id="l76.948">     char *ptr2;</span>
<a href="#l76.949"></a><span id="l76.949">     char quoteDelimiter = '\0';</span>
<a href="#l76.950"></a><span id="l76.950">     while (*ptr &amp;&amp; *ptr != '=') ptr++;</span>
<a href="#l76.951"></a><span id="l76.951">     if (*ptr == '=') {</span>
<a href="#l76.952"></a><span id="l76.952">       /* Ignore = and leading space. */</span>
<a href="#l76.953"></a><span id="l76.953">       /* Safe, because there's a '&gt;' at the end! */</span>
<a href="#l76.954"></a><span id="l76.954" class="difflineminus">-      do {ptr++;} while (IS_SPACE(*ptr));</span>
<a href="#l76.955"></a><span id="l76.955" class="difflineplus">+      do {</span>
<a href="#l76.956"></a><span id="l76.956" class="difflineplus">+        ptr++;</span>
<a href="#l76.957"></a><span id="l76.957" class="difflineplus">+      } while (IS_SPACE(*ptr));</span>
<a href="#l76.958"></a><span id="l76.958">       if (*ptr == '&quot;' || *ptr == '\'') {</span>
<a href="#l76.959"></a><span id="l76.959">         quoteDelimiter = *ptr;</span>
<a href="#l76.960"></a><span id="l76.960">         /* Take up the quote and leading space here as well. */</span>
<a href="#l76.961"></a><span id="l76.961">         /* Safe because there's a '&gt;' at the end */</span>
<a href="#l76.962"></a><span id="l76.962" class="difflineminus">-        do {ptr++;} while (IS_SPACE(*ptr));</span>
<a href="#l76.963"></a><span id="l76.963" class="difflineplus">+        do {</span>
<a href="#l76.964"></a><span id="l76.964" class="difflineplus">+          ptr++;</span>
<a href="#l76.965"></a><span id="l76.965" class="difflineplus">+        } while (IS_SPACE(*ptr));</span>
<a href="#l76.966"></a><span id="l76.966">       }</span>
<a href="#l76.967"></a><span id="l76.967">     }</span>
<a href="#l76.968"></a><span id="l76.968">     status = real_write(relobj, buf, ptr - buf);</span>
<a href="#l76.969"></a><span id="l76.969">     if (status &lt; 0) return status;</span>
<a href="#l76.970"></a><span id="l76.970">     buf = ptr;</span>
<a href="#l76.971"></a><span id="l76.971">     if (!*buf) break;</span>
<a href="#l76.972"></a><span id="l76.972" class="difflineminus">-    if (quoteDelimiter)</span>
<a href="#l76.973"></a><span id="l76.973" class="difflineminus">-    {</span>
<a href="#l76.974"></a><span id="l76.974" class="difflineplus">+    if (quoteDelimiter) {</span>
<a href="#l76.975"></a><span id="l76.975">       ptr = PL_strnchr(buf, quoteDelimiter, length - (buf - relobj-&gt;curtag));</span>
<a href="#l76.976"></a><span id="l76.976">     } else {</span>
<a href="#l76.977"></a><span id="l76.977" class="difflineminus">-      for (ptr = buf; *ptr ; ptr++) {</span>
<a href="#l76.978"></a><span id="l76.978" class="difflineplus">+      for (ptr = buf; *ptr; ptr++) {</span>
<a href="#l76.979"></a><span id="l76.979">         if (*ptr == '&gt;' || IS_SPACE(*ptr)) break;</span>
<a href="#l76.980"></a><span id="l76.980">       }</span>
<a href="#l76.981"></a><span id="l76.981">       PR_ASSERT(*ptr);</span>
<a href="#l76.982"></a><span id="l76.982">     }</span>
<a href="#l76.983"></a><span id="l76.983">     if (!ptr || !*ptr) break;</span>
<a href="#l76.984"></a><span id="l76.984"> </span>
<a href="#l76.985"></a><span id="l76.985" class="difflineminus">-    while(buf &lt; ptr)</span>
<a href="#l76.986"></a><span id="l76.986" class="difflineminus">-    {</span>
<a href="#l76.987"></a><span id="l76.987" class="difflineplus">+    while (buf &lt; ptr) {</span>
<a href="#l76.988"></a><span id="l76.988">       /* ### mwelch For each word in the value string, see if</span>
<a href="#l76.989"></a><span id="l76.989">                       the word is a cid: URL. If so, attempt to</span>
<a href="#l76.990"></a><span id="l76.990">               substitute the appropriate mailbox part URL in</span>
<a href="#l76.991"></a><span id="l76.991">               its place. */</span>
<a href="#l76.992"></a><span id="l76.992" class="difflineminus">-      ptr2=buf; /* walk from the left end rightward */</span>
<a href="#l76.993"></a><span id="l76.993" class="difflineminus">-      while((ptr2&lt;ptr) &amp;&amp; (!IS_SPACE(*ptr2)))</span>
<a href="#l76.994"></a><span id="l76.994" class="difflineminus">-        ptr2++;</span>
<a href="#l76.995"></a><span id="l76.995" class="difflineplus">+      ptr2 = buf; /* walk from the left end rightward */</span>
<a href="#l76.996"></a><span id="l76.996" class="difflineplus">+      while ((ptr2 &lt; ptr) &amp;&amp; (!IS_SPACE(*ptr2))) ptr2++;</span>
<a href="#l76.997"></a><span id="l76.997">       /* Compare the beginning of the word with &quot;cid:&quot;. Yuck. */</span>
<a href="#l76.998"></a><span id="l76.998">       if (((ptr2 - buf) &gt; 4) &amp;&amp;</span>
<a href="#l76.999"></a><span id="l76.999" class="difflineminus">-        ((buf[0]=='c' || buf[0]=='C') &amp;&amp;</span>
<a href="#l76.1000"></a><span id="l76.1000" class="difflineminus">-         (buf[1]=='i' || buf[1]=='I') &amp;&amp;</span>
<a href="#l76.1001"></a><span id="l76.1001" class="difflineminus">-         (buf[2]=='d' || buf[2]=='D') &amp;&amp;</span>
<a href="#l76.1002"></a><span id="l76.1002" class="difflineminus">-          buf[3]==':'))</span>
<a href="#l76.1003"></a><span id="l76.1003" class="difflineminus">-      {</span>
<a href="#l76.1004"></a><span id="l76.1004" class="difflineminus">-        // Make sure it's lowercase, otherwise it won't be found in the hash table</span>
<a href="#l76.1005"></a><span id="l76.1005" class="difflineminus">-        buf[0] = 'c'; buf[1] = 'i'; buf[2] = 'd';</span>
<a href="#l76.1006"></a><span id="l76.1006" class="difflineplus">+          ((buf[0] == 'c' || buf[0] == 'C') &amp;&amp;</span>
<a href="#l76.1007"></a><span id="l76.1007" class="difflineplus">+           (buf[1] == 'i' || buf[1] == 'I') &amp;&amp;</span>
<a href="#l76.1008"></a><span id="l76.1008" class="difflineplus">+           (buf[2] == 'd' || buf[2] == 'D') &amp;&amp; buf[3] == ':')) {</span>
<a href="#l76.1009"></a><span id="l76.1009" class="difflineplus">+        // Make sure it's lowercase, otherwise it won't be found in the hash</span>
<a href="#l76.1010"></a><span id="l76.1010" class="difflineplus">+        // table</span>
<a href="#l76.1011"></a><span id="l76.1011" class="difflineplus">+        buf[0] = 'c';</span>
<a href="#l76.1012"></a><span id="l76.1012" class="difflineplus">+        buf[1] = 'i';</span>
<a href="#l76.1013"></a><span id="l76.1013" class="difflineplus">+        buf[2] = 'd';</span>
<a href="#l76.1014"></a><span id="l76.1014"> </span>
<a href="#l76.1015"></a><span id="l76.1015">         /* Null terminate the word so we can... */</span>
<a href="#l76.1016"></a><span id="l76.1016">         c = *ptr2;</span>
<a href="#l76.1017"></a><span id="l76.1017">         *ptr2 = '\0';</span>
<a href="#l76.1018"></a><span id="l76.1018"> </span>
<a href="#l76.1019"></a><span id="l76.1019">         /* Construct a URL out of the word. */</span>
<a href="#l76.1020"></a><span id="l76.1020">         absolute = MakeAbsoluteURL(relobj-&gt;base_url, buf);</span>
<a href="#l76.1021"></a><span id="l76.1021"> </span>
<a href="#l76.1022"></a><span id="l76.1022">         /* See if we have a mailbox part URL</span>
<a href="#l76.1023"></a><span id="l76.1023">            corresponding to this cid. */</span>
<a href="#l76.1024"></a><span id="l76.1024">         part_url = nullptr;</span>
<a href="#l76.1025"></a><span id="l76.1025" class="difflineminus">-        MimeHashValue * value = nullptr;</span>
<a href="#l76.1026"></a><span id="l76.1026" class="difflineminus">-        if (absolute)</span>
<a href="#l76.1027"></a><span id="l76.1027" class="difflineminus">-        {</span>
<a href="#l76.1028"></a><span id="l76.1028" class="difflineplus">+        MimeHashValue *value = nullptr;</span>
<a href="#l76.1029"></a><span id="l76.1029" class="difflineplus">+        if (absolute) {</span>
<a href="#l76.1030"></a><span id="l76.1030">           value = (MimeHashValue *)PL_HashTableLookup(relobj-&gt;hash, buf);</span>
<a href="#l76.1031"></a><span id="l76.1031">           part_url = value ? value-&gt;m_url : nullptr;</span>
<a href="#l76.1032"></a><span id="l76.1032">           PR_FREEIF(absolute);</span>
<a href="#l76.1033"></a><span id="l76.1033">         }</span>
<a href="#l76.1034"></a><span id="l76.1034"> </span>
<a href="#l76.1035"></a><span id="l76.1035">         /*If we found a mailbox part URL, write that out instead.*/</span>
<a href="#l76.1036"></a><span id="l76.1036" class="difflineminus">-        if (part_url &amp;&amp; accept_related_part(relobj, value-&gt;m_obj))</span>
<a href="#l76.1037"></a><span id="l76.1037" class="difflineminus">-        {</span>
<a href="#l76.1038"></a><span id="l76.1038" class="difflineplus">+        if (part_url &amp;&amp; accept_related_part(relobj, value-&gt;m_obj)) {</span>
<a href="#l76.1039"></a><span id="l76.1039">           status = real_write(relobj, part_url, strlen(part_url));</span>
<a href="#l76.1040"></a><span id="l76.1040">           if (status &lt; 0) return status;</span>
<a href="#l76.1041"></a><span id="l76.1041">           buf = ptr2; /* skip over the cid: URL we substituted */</span>
<a href="#l76.1042"></a><span id="l76.1042"> </span>
<a href="#l76.1043"></a><span id="l76.1043">           /* don't show that object as attachment */</span>
<a href="#l76.1044"></a><span id="l76.1044" class="difflineminus">-          if (value-&gt;m_obj)</span>
<a href="#l76.1045"></a><span id="l76.1045" class="difflineminus">-            value-&gt;m_obj-&gt;dontShowAsAttachment = true;</span>
<a href="#l76.1046"></a><span id="l76.1046" class="difflineplus">+          if (value-&gt;m_obj) value-&gt;m_obj-&gt;dontShowAsAttachment = true;</span>
<a href="#l76.1047"></a><span id="l76.1047">         }</span>
<a href="#l76.1048"></a><span id="l76.1048"> </span>
<a href="#l76.1049"></a><span id="l76.1049">         /* Restore the character that we nulled. */</span>
<a href="#l76.1050"></a><span id="l76.1050">         *ptr2 = c;</span>
<a href="#l76.1051"></a><span id="l76.1051">       }</span>
<a href="#l76.1052"></a><span id="l76.1052">       /* rhp - if we get here, we should still check against the hash table! */</span>
<a href="#l76.1053"></a><span id="l76.1053" class="difflineminus">-      else</span>
<a href="#l76.1054"></a><span id="l76.1054" class="difflineminus">-      {</span>
<a href="#l76.1055"></a><span id="l76.1055" class="difflineplus">+      else {</span>
<a href="#l76.1056"></a><span id="l76.1056">         char holder = *ptr2;</span>
<a href="#l76.1057"></a><span id="l76.1057">         char *realout;</span>
<a href="#l76.1058"></a><span id="l76.1058"> </span>
<a href="#l76.1059"></a><span id="l76.1059">         *ptr2 = '\0';</span>
<a href="#l76.1060"></a><span id="l76.1060"> </span>
<a href="#l76.1061"></a><span id="l76.1061">         /* Construct a URL out of the word. */</span>
<a href="#l76.1062"></a><span id="l76.1062">         absolute = MakeAbsoluteURL(relobj-&gt;base_url, buf);</span>
<a href="#l76.1063"></a><span id="l76.1063"> </span>
<a href="#l76.1064"></a><span id="l76.1064">         /* See if we have a mailbox part URL</span>
<a href="#l76.1065"></a><span id="l76.1065">            corresponding to this cid. */</span>
<a href="#l76.1066"></a><span id="l76.1066" class="difflineminus">-        MimeHashValue * value;</span>
<a href="#l76.1067"></a><span id="l76.1067" class="difflineplus">+        MimeHashValue *value;</span>
<a href="#l76.1068"></a><span id="l76.1068">         if (absolute)</span>
<a href="#l76.1069"></a><span id="l76.1069">           value = (MimeHashValue *)PL_HashTableLookup(relobj-&gt;hash, absolute);</span>
<a href="#l76.1070"></a><span id="l76.1070">         else</span>
<a href="#l76.1071"></a><span id="l76.1071">           value = (MimeHashValue *)PL_HashTableLookup(relobj-&gt;hash, buf);</span>
<a href="#l76.1072"></a><span id="l76.1072">         realout = value ? value-&gt;m_url : nullptr;</span>
<a href="#l76.1073"></a><span id="l76.1073"> </span>
<a href="#l76.1074"></a><span id="l76.1074">         *ptr2 = holder;</span>
<a href="#l76.1075"></a><span id="l76.1075">         PR_FREEIF(absolute);</span>
<a href="#l76.1076"></a><span id="l76.1076"> </span>
<a href="#l76.1077"></a><span id="l76.1077" class="difflineminus">-        if (realout &amp;&amp; accept_related_part(relobj, value-&gt;m_obj))</span>
<a href="#l76.1078"></a><span id="l76.1078" class="difflineminus">-        {</span>
<a href="#l76.1079"></a><span id="l76.1079" class="difflineplus">+        if (realout &amp;&amp; accept_related_part(relobj, value-&gt;m_obj)) {</span>
<a href="#l76.1080"></a><span id="l76.1080">           status = real_write(relobj, realout, strlen(realout));</span>
<a href="#l76.1081"></a><span id="l76.1081">           if (status &lt; 0) return status;</span>
<a href="#l76.1082"></a><span id="l76.1082">           buf = ptr2; /* skip over the cid: URL we substituted */</span>
<a href="#l76.1083"></a><span id="l76.1083"> </span>
<a href="#l76.1084"></a><span id="l76.1084">           /* don't show that object as attachment */</span>
<a href="#l76.1085"></a><span id="l76.1085" class="difflineminus">-          if (value-&gt;m_obj)</span>
<a href="#l76.1086"></a><span id="l76.1086" class="difflineminus">-            value-&gt;m_obj-&gt;dontShowAsAttachment = true;</span>
<a href="#l76.1087"></a><span id="l76.1087" class="difflineplus">+          if (value-&gt;m_obj) value-&gt;m_obj-&gt;dontShowAsAttachment = true;</span>
<a href="#l76.1088"></a><span id="l76.1088">         }</span>
<a href="#l76.1089"></a><span id="l76.1089">       }</span>
<a href="#l76.1090"></a><span id="l76.1090">       /* rhp - if we get here, we should still check against the hash table! */</span>
<a href="#l76.1091"></a><span id="l76.1091"> </span>
<a href="#l76.1092"></a><span id="l76.1092">       /* Advance to the beginning of the next word, or to</span>
<a href="#l76.1093"></a><span id="l76.1093">          the end of the value string. */</span>
<a href="#l76.1094"></a><span id="l76.1094" class="difflineminus">-      while((ptr2&lt;ptr) &amp;&amp; (IS_SPACE(*ptr2)))</span>
<a href="#l76.1095"></a><span id="l76.1095" class="difflineminus">-        ptr2++;</span>
<a href="#l76.1096"></a><span id="l76.1096" class="difflineplus">+      while ((ptr2 &lt; ptr) &amp;&amp; (IS_SPACE(*ptr2))) ptr2++;</span>
<a href="#l76.1097"></a><span id="l76.1097"> </span>
<a href="#l76.1098"></a><span id="l76.1098">       /* Write whatever original text remains after</span>
<a href="#l76.1099"></a><span id="l76.1099">          cid: URL substitution. */</span>
<a href="#l76.1100"></a><span id="l76.1100" class="difflineminus">-      status = real_write(relobj, buf, ptr2-buf);</span>
<a href="#l76.1101"></a><span id="l76.1101" class="difflineplus">+      status = real_write(relobj, buf, ptr2 - buf);</span>
<a href="#l76.1102"></a><span id="l76.1102">       if (status &lt; 0) return status;</span>
<a href="#l76.1103"></a><span id="l76.1103">       buf = ptr2;</span>
<a href="#l76.1104"></a><span id="l76.1104">     }</span>
<a href="#l76.1105"></a><span id="l76.1105">   }</span>
<a href="#l76.1106"></a><span id="l76.1106">   if (buf &amp;&amp; *buf) {</span>
<a href="#l76.1107"></a><span id="l76.1107">     status = real_write(relobj, buf, strlen(buf));</span>
<a href="#l76.1108"></a><span id="l76.1108">     if (status &lt; 0) return status;</span>
<a href="#l76.1109"></a><span id="l76.1109">   }</span>
<a href="#l76.1110"></a><span id="l76.1110">   relobj-&gt;curtag_length = 0;</span>
<a href="#l76.1111"></a><span id="l76.1111">   return 0;</span>
<a href="#l76.1112"></a><span id="l76.1112"> }</span>
<a href="#l76.1113"></a><span id="l76.1113"> </span>
<a href="#l76.1114"></a><span id="l76.1114" class="difflineminus">-</span>
<a href="#l76.1115"></a><span id="l76.1115" class="difflineminus">-</span>
<a href="#l76.1116"></a><span id="l76.1116" class="difflineminus">-static int</span>
<a href="#l76.1117"></a><span id="l76.1117" class="difflineminus">-mime_multipart_related_output_fn(const char* buf, int32_t size, void *stream_closure)</span>
<a href="#l76.1118"></a><span id="l76.1118" class="difflineminus">-{</span>
<a href="#l76.1119"></a><span id="l76.1119" class="difflineminus">-  MimeMultipartRelated *relobj = (MimeMultipartRelated *) stream_closure;</span>
<a href="#l76.1120"></a><span id="l76.1120" class="difflineminus">-  char* ptr;</span>
<a href="#l76.1121"></a><span id="l76.1121" class="difflineplus">+static int mime_multipart_related_output_fn(const char *buf, int32_t size,</span>
<a href="#l76.1122"></a><span id="l76.1122" class="difflineplus">+                                            void *stream_closure) {</span>
<a href="#l76.1123"></a><span id="l76.1123" class="difflineplus">+  MimeMultipartRelated *relobj = (MimeMultipartRelated *)stream_closure;</span>
<a href="#l76.1124"></a><span id="l76.1124" class="difflineplus">+  char *ptr;</span>
<a href="#l76.1125"></a><span id="l76.1125">   int32_t delta;</span>
<a href="#l76.1126"></a><span id="l76.1126">   int status;</span>
<a href="#l76.1127"></a><span id="l76.1127">   while (size &gt; 0) {</span>
<a href="#l76.1128"></a><span id="l76.1128">     if (relobj-&gt;curtag_length &gt; 0) {</span>
<a href="#l76.1129"></a><span id="l76.1129">       ptr = PL_strnchr(buf, '&gt;', size);</span>
<a href="#l76.1130"></a><span id="l76.1130">       if (!ptr) {</span>
<a href="#l76.1131"></a><span id="l76.1131">         return push_tag(relobj, buf, size);</span>
<a href="#l76.1132"></a><span id="l76.1132">       }</span>
<a href="#l76.1133"></a><span id="l76.1133" class="difflineat">@@ -996,50 +922,47 @@ mime_multipart_related_output_fn(const c</span>
<a href="#l76.1134"></a><span id="l76.1134">     if (status &lt; 0) return status;</span>
<a href="#l76.1135"></a><span id="l76.1135">     PR_ASSERT(relobj-&gt;curtag_length == 1);</span>
<a href="#l76.1136"></a><span id="l76.1136">     buf++;</span>
<a href="#l76.1137"></a><span id="l76.1137">     size--;</span>
<a href="#l76.1138"></a><span id="l76.1138">   }</span>
<a href="#l76.1139"></a><span id="l76.1139">   return 0;</span>
<a href="#l76.1140"></a><span id="l76.1140"> }</span>
<a href="#l76.1141"></a><span id="l76.1141"> </span>
<a href="#l76.1142"></a><span id="l76.1142" class="difflineminus">-</span>
<a href="#l76.1143"></a><span id="l76.1143" class="difflineminus">-static int</span>
<a href="#l76.1144"></a><span id="l76.1144" class="difflineminus">-MimeMultipartRelated_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l76.1145"></a><span id="l76.1145" class="difflineminus">-{</span>
<a href="#l76.1146"></a><span id="l76.1146" class="difflineplus">+static int MimeMultipartRelated_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l76.1147"></a><span id="l76.1147">   /* OK, all the necessary data has been collected.  We now have to spew out</span>
<a href="#l76.1148"></a><span id="l76.1148">      the HTML.  We let it go through all the normal mechanisms (which</span>
<a href="#l76.1149"></a><span id="l76.1149">      includes content-encoding handling), and intercept the output data to do</span>
<a href="#l76.1150"></a><span id="l76.1150">      translation of the tags.  Whee. */</span>
<a href="#l76.1151"></a><span id="l76.1151" class="difflineminus">-  MimeMultipartRelated *relobj = (MimeMultipartRelated *) obj;</span>
<a href="#l76.1152"></a><span id="l76.1152" class="difflineplus">+  MimeMultipartRelated *relobj = (MimeMultipartRelated *)obj;</span>
<a href="#l76.1153"></a><span id="l76.1153">   MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l76.1154"></a><span id="l76.1154">   int status = 0;</span>
<a href="#l76.1155"></a><span id="l76.1155">   MimeObject *body;</span>
<a href="#l76.1156"></a><span id="l76.1156" class="difflineminus">-  char* ct;</span>
<a href="#l76.1157"></a><span id="l76.1157" class="difflineminus">-  const char* dct;</span>
<a href="#l76.1158"></a><span id="l76.1158" class="difflineplus">+  char *ct;</span>
<a href="#l76.1159"></a><span id="l76.1159" class="difflineplus">+  const char *dct;</span>
<a href="#l76.1160"></a><span id="l76.1160"> </span>
<a href="#l76.1161"></a><span id="l76.1161" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l76.1162"></a><span id="l76.1162" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l76.1163"></a><span id="l76.1163">   if (status &lt; 0) goto FAIL;</span>
<a href="#l76.1164"></a><span id="l76.1164"> </span>
<a href="#l76.1165"></a><span id="l76.1165">   if (!relobj-&gt;headobj) return 0;</span>
<a href="#l76.1166"></a><span id="l76.1166"> </span>
<a href="#l76.1167"></a><span id="l76.1167" class="difflineminus">-  ct = (relobj-&gt;buffered_hdrs</span>
<a href="#l76.1168"></a><span id="l76.1168" class="difflineminus">-      ? MimeHeaders_get (relobj-&gt;buffered_hdrs, HEADER_CONTENT_TYPE,</span>
<a href="#l76.1169"></a><span id="l76.1169" class="difflineminus">-               true, false)</span>
<a href="#l76.1170"></a><span id="l76.1170" class="difflineminus">-      : 0);</span>
<a href="#l76.1171"></a><span id="l76.1171" class="difflineminus">-  dct = (((MimeMultipartClass *) obj-&gt;clazz)-&gt;default_part_type);</span>
<a href="#l76.1172"></a><span id="l76.1172" class="difflineplus">+  ct =</span>
<a href="#l76.1173"></a><span id="l76.1173" class="difflineplus">+      (relobj-&gt;buffered_hdrs ? MimeHeaders_get(relobj-&gt;buffered_hdrs,</span>
<a href="#l76.1174"></a><span id="l76.1174" class="difflineplus">+                                               HEADER_CONTENT_TYPE, true, false)</span>
<a href="#l76.1175"></a><span id="l76.1175" class="difflineplus">+                             : 0);</span>
<a href="#l76.1176"></a><span id="l76.1176" class="difflineplus">+  dct = (((MimeMultipartClass *)obj-&gt;clazz)-&gt;default_part_type);</span>
<a href="#l76.1177"></a><span id="l76.1177"> </span>
<a href="#l76.1178"></a><span id="l76.1178">   relobj-&gt;real_output_fn = obj-&gt;options-&gt;output_fn;</span>
<a href="#l76.1179"></a><span id="l76.1179">   relobj-&gt;real_output_closure = obj-&gt;options-&gt;output_closure;</span>
<a href="#l76.1180"></a><span id="l76.1180"> </span>
<a href="#l76.1181"></a><span id="l76.1181">   obj-&gt;options-&gt;output_fn = mime_multipart_related_output_fn;</span>
<a href="#l76.1182"></a><span id="l76.1182">   obj-&gt;options-&gt;output_closure = obj;</span>
<a href="#l76.1183"></a><span id="l76.1183"> </span>
<a href="#l76.1184"></a><span id="l76.1184">   body = mime_create(((ct &amp;&amp; *ct) ? ct : (dct ? dct : TEXT_HTML)),</span>
<a href="#l76.1185"></a><span id="l76.1185" class="difflineminus">-             relobj-&gt;buffered_hdrs, obj-&gt;options);</span>
<a href="#l76.1186"></a><span id="l76.1186" class="difflineplus">+                     relobj-&gt;buffered_hdrs, obj-&gt;options);</span>
<a href="#l76.1187"></a><span id="l76.1187"> </span>
<a href="#l76.1188"></a><span id="l76.1188">   PR_FREEIF(ct);</span>
<a href="#l76.1189"></a><span id="l76.1189">   if (!body) {</span>
<a href="#l76.1190"></a><span id="l76.1190">     status = MIME_OUT_OF_MEMORY;</span>
<a href="#l76.1191"></a><span id="l76.1191">     goto FAIL;</span>
<a href="#l76.1192"></a><span id="l76.1192">   }</span>
<a href="#l76.1193"></a><span id="l76.1193">   // replace the existing head object with the new object</span>
<a href="#l76.1194"></a><span id="l76.1194">   for (int iChild = 0; iChild &lt; cont-&gt;nchildren; iChild++) {</span>
<a href="#l76.1195"></a><span id="l76.1195" class="difflineat">@@ -1052,102 +975,87 @@ MimeMultipartRelated_parse_eof (MimeObje</span>
<a href="#l76.1196"></a><span id="l76.1196">     }</span>
<a href="#l76.1197"></a><span id="l76.1197">   }</span>
<a href="#l76.1198"></a><span id="l76.1198"> </span>
<a href="#l76.1199"></a><span id="l76.1199">   if (!body-&gt;parent) {</span>
<a href="#l76.1200"></a><span id="l76.1200">     NS_WARNING(&quot;unexpected mime multipart related structure&quot;);</span>
<a href="#l76.1201"></a><span id="l76.1201">     goto FAIL;</span>
<a href="#l76.1202"></a><span id="l76.1202">   }</span>
<a href="#l76.1203"></a><span id="l76.1203"> </span>
<a href="#l76.1204"></a><span id="l76.1204" class="difflineminus">-  body-&gt;dontShowAsAttachment = body-&gt;clazz-&gt;displayable_inline_p(body-&gt;clazz, body-&gt;headers);</span>
<a href="#l76.1205"></a><span id="l76.1205" class="difflineplus">+  body-&gt;dontShowAsAttachment =</span>
<a href="#l76.1206"></a><span id="l76.1206" class="difflineplus">+      body-&gt;clazz-&gt;displayable_inline_p(body-&gt;clazz, body-&gt;headers);</span>
<a href="#l76.1207"></a><span id="l76.1207"> </span>
<a href="#l76.1208"></a><span id="l76.1208"> #ifdef MIME_DRAFTS</span>
<a href="#l76.1209"></a><span id="l76.1209" class="difflineminus">-  if ( obj-&gt;options &amp;&amp;</span>
<a href="#l76.1210"></a><span id="l76.1210" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l76.1211"></a><span id="l76.1211" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_init_fn &amp;&amp;</span>
<a href="#l76.1212"></a><span id="l76.1212" class="difflineminus">-     (relobj-&gt;file_buffer || relobj-&gt;head_buffer))</span>
<a href="#l76.1213"></a><span id="l76.1213" class="difflineminus">-  {</span>
<a href="#l76.1214"></a><span id="l76.1214" class="difflineminus">-    status = obj-&gt;options-&gt;decompose_file_init_fn ( obj-&gt;options-&gt;stream_closure,</span>
<a href="#l76.1215"></a><span id="l76.1215" class="difflineminus">-                            relobj-&gt;buffered_hdrs );</span>
<a href="#l76.1216"></a><span id="l76.1216" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l76.1217"></a><span id="l76.1217" class="difflineplus">+      obj-&gt;options-&gt;decompose_file_init_fn &amp;&amp;</span>
<a href="#l76.1218"></a><span id="l76.1218" class="difflineplus">+      (relobj-&gt;file_buffer || relobj-&gt;head_buffer)) {</span>
<a href="#l76.1219"></a><span id="l76.1219" class="difflineplus">+    status = obj-&gt;options-&gt;decompose_file_init_fn(obj-&gt;options-&gt;stream_closure,</span>
<a href="#l76.1220"></a><span id="l76.1220" class="difflineplus">+                                                  relobj-&gt;buffered_hdrs);</span>
<a href="#l76.1221"></a><span id="l76.1221">     if (status &lt; 0) return status;</span>
<a href="#l76.1222"></a><span id="l76.1222">   }</span>
<a href="#l76.1223"></a><span id="l76.1223"> #endif /* MIME_DRAFTS */</span>
<a href="#l76.1224"></a><span id="l76.1224"> </span>
<a href="#l76.1225"></a><span id="l76.1225">   /* if the emitter wants to know about nested bodies, then it needs</span>
<a href="#l76.1226"></a><span id="l76.1226">      to know that we jumped back to this body part. */</span>
<a href="#l76.1227"></a><span id="l76.1227" class="difflineminus">-  if (obj-&gt;options-&gt;notify_nested_bodies)</span>
<a href="#l76.1228"></a><span id="l76.1228" class="difflineminus">-  {</span>
<a href="#l76.1229"></a><span id="l76.1229" class="difflineplus">+  if (obj-&gt;options-&gt;notify_nested_bodies) {</span>
<a href="#l76.1230"></a><span id="l76.1230">     char *part_path = mime_part_address(body);</span>
<a href="#l76.1231"></a><span id="l76.1231" class="difflineminus">-    if (part_path)</span>
<a href="#l76.1232"></a><span id="l76.1232" class="difflineminus">-    {</span>
<a href="#l76.1233"></a><span id="l76.1233" class="difflineminus">-      mimeEmitterAddHeaderField(obj-&gt;options,</span>
<a href="#l76.1234"></a><span id="l76.1234" class="difflineminus">-                                &quot;x-jsemitter-part-path&quot;,</span>
<a href="#l76.1235"></a><span id="l76.1235" class="difflineplus">+    if (part_path) {</span>
<a href="#l76.1236"></a><span id="l76.1236" class="difflineplus">+      mimeEmitterAddHeaderField(obj-&gt;options, &quot;x-jsemitter-part-path&quot;,</span>
<a href="#l76.1237"></a><span id="l76.1237">                                 part_path);</span>
<a href="#l76.1238"></a><span id="l76.1238">       PR_Free(part_path);</span>
<a href="#l76.1239"></a><span id="l76.1239">     }</span>
<a href="#l76.1240"></a><span id="l76.1240">   }</span>
<a href="#l76.1241"></a><span id="l76.1241"> </span>
<a href="#l76.1242"></a><span id="l76.1242">   /* Now that we've added this new object to our list of children,</span>
<a href="#l76.1243"></a><span id="l76.1243">      start its parser going. */</span>
<a href="#l76.1244"></a><span id="l76.1244">   status = body-&gt;clazz-&gt;parse_begin(body);</span>
<a href="#l76.1245"></a><span id="l76.1245">   if (status &lt; 0) goto FAIL;</span>
<a href="#l76.1246"></a><span id="l76.1246"> </span>
<a href="#l76.1247"></a><span id="l76.1247" class="difflineminus">-  if (relobj-&gt;head_buffer)</span>
<a href="#l76.1248"></a><span id="l76.1248" class="difflineminus">-  {</span>
<a href="#l76.1249"></a><span id="l76.1249" class="difflineplus">+  if (relobj-&gt;head_buffer) {</span>
<a href="#l76.1250"></a><span id="l76.1250">     /* Read it out of memory. */</span>
<a href="#l76.1251"></a><span id="l76.1251">     PR_ASSERT(!relobj-&gt;file_buffer &amp;&amp; !relobj-&gt;input_file_stream);</span>
<a href="#l76.1252"></a><span id="l76.1252"> </span>
<a href="#l76.1253"></a><span id="l76.1253">     status = body-&gt;clazz-&gt;parse_buffer(relobj-&gt;head_buffer,</span>
<a href="#l76.1254"></a><span id="l76.1254" class="difflineminus">-                         relobj-&gt;head_buffer_fp,</span>
<a href="#l76.1255"></a><span id="l76.1255" class="difflineminus">-                         body);</span>
<a href="#l76.1256"></a><span id="l76.1256" class="difflineminus">-  }</span>
<a href="#l76.1257"></a><span id="l76.1257" class="difflineminus">-  else if (relobj-&gt;file_buffer)</span>
<a href="#l76.1258"></a><span id="l76.1258" class="difflineminus">-  {</span>
<a href="#l76.1259"></a><span id="l76.1259" class="difflineplus">+                                       relobj-&gt;head_buffer_fp, body);</span>
<a href="#l76.1260"></a><span id="l76.1260" class="difflineplus">+  } else if (relobj-&gt;file_buffer) {</span>
<a href="#l76.1261"></a><span id="l76.1261">     /* Read it off disk. */</span>
<a href="#l76.1262"></a><span id="l76.1262">     char *buf;</span>
<a href="#l76.1263"></a><span id="l76.1263"> </span>
<a href="#l76.1264"></a><span id="l76.1264" class="difflineminus">-    PR_ASSERT(relobj-&gt;head_buffer_size == 0 &amp;&amp;</span>
<a href="#l76.1265"></a><span id="l76.1265" class="difflineminus">-          relobj-&gt;head_buffer_fp == 0);</span>
<a href="#l76.1266"></a><span id="l76.1266" class="difflineplus">+    PR_ASSERT(relobj-&gt;head_buffer_size == 0 &amp;&amp; relobj-&gt;head_buffer_fp == 0);</span>
<a href="#l76.1267"></a><span id="l76.1267">     PR_ASSERT(relobj-&gt;file_buffer);</span>
<a href="#l76.1268"></a><span id="l76.1268" class="difflineminus">-    if (!relobj-&gt;file_buffer)</span>
<a href="#l76.1269"></a><span id="l76.1269" class="difflineminus">-    {</span>
<a href="#l76.1270"></a><span id="l76.1270" class="difflineplus">+    if (!relobj-&gt;file_buffer) {</span>
<a href="#l76.1271"></a><span id="l76.1271">       status = -1;</span>
<a href="#l76.1272"></a><span id="l76.1272">       goto FAIL;</span>
<a href="#l76.1273"></a><span id="l76.1273">     }</span>
<a href="#l76.1274"></a><span id="l76.1274"> </span>
<a href="#l76.1275"></a><span id="l76.1275" class="difflineminus">-    buf = (char *) PR_MALLOC(FILE_IO_BUFFER_SIZE);</span>
<a href="#l76.1276"></a><span id="l76.1276" class="difflineminus">-    if (!buf)</span>
<a href="#l76.1277"></a><span id="l76.1277" class="difflineminus">-    {</span>
<a href="#l76.1278"></a><span id="l76.1278" class="difflineplus">+    buf = (char *)PR_MALLOC(FILE_IO_BUFFER_SIZE);</span>
<a href="#l76.1279"></a><span id="l76.1279" class="difflineplus">+    if (!buf) {</span>
<a href="#l76.1280"></a><span id="l76.1280">       status = MIME_OUT_OF_MEMORY;</span>
<a href="#l76.1281"></a><span id="l76.1281">       goto FAIL;</span>
<a href="#l76.1282"></a><span id="l76.1282">     }</span>
<a href="#l76.1283"></a><span id="l76.1283"> </span>
<a href="#l76.1284"></a><span id="l76.1284">     // First, close the output file to open the input file!</span>
<a href="#l76.1285"></a><span id="l76.1285" class="difflineminus">-    if (relobj-&gt;output_file_stream)</span>
<a href="#l76.1286"></a><span id="l76.1286" class="difflineminus">-      relobj-&gt;output_file_stream-&gt;Close();</span>
<a href="#l76.1287"></a><span id="l76.1287" class="difflineplus">+    if (relobj-&gt;output_file_stream) relobj-&gt;output_file_stream-&gt;Close();</span>
<a href="#l76.1288"></a><span id="l76.1288"> </span>
<a href="#l76.1289"></a><span id="l76.1289" class="difflineminus">-    nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(relobj-&gt;input_file_stream), relobj-&gt;file_buffer);</span>
<a href="#l76.1290"></a><span id="l76.1290" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l76.1291"></a><span id="l76.1291" class="difflineminus">-    {</span>
<a href="#l76.1292"></a><span id="l76.1292" class="difflineplus">+    nsresult rv = NS_NewLocalFileInputStream(</span>
<a href="#l76.1293"></a><span id="l76.1293" class="difflineplus">+        getter_AddRefs(relobj-&gt;input_file_stream), relobj-&gt;file_buffer);</span>
<a href="#l76.1294"></a><span id="l76.1294" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l76.1295"></a><span id="l76.1295">       PR_Free(buf);</span>
<a href="#l76.1296"></a><span id="l76.1296">       status = MIME_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l76.1297"></a><span id="l76.1297">       goto FAIL;</span>
<a href="#l76.1298"></a><span id="l76.1298">     }</span>
<a href="#l76.1299"></a><span id="l76.1299"> </span>
<a href="#l76.1300"></a><span id="l76.1300" class="difflineminus">-    while(1)</span>
<a href="#l76.1301"></a><span id="l76.1301" class="difflineminus">-    {</span>
<a href="#l76.1302"></a><span id="l76.1302" class="difflineplus">+    while (1) {</span>
<a href="#l76.1303"></a><span id="l76.1303">       uint32_t bytesRead = 0;</span>
<a href="#l76.1304"></a><span id="l76.1304" class="difflineminus">-      rv = relobj-&gt;input_file_stream-&gt;Read(buf, FILE_IO_BUFFER_SIZE - 1, &amp;bytesRead);</span>
<a href="#l76.1305"></a><span id="l76.1305" class="difflineminus">-      if (NS_FAILED(rv) || !bytesRead)</span>
<a href="#l76.1306"></a><span id="l76.1306" class="difflineminus">-      {</span>
<a href="#l76.1307"></a><span id="l76.1307" class="difflineplus">+      rv = relobj-&gt;input_file_stream-&gt;Read(buf, FILE_IO_BUFFER_SIZE - 1,</span>
<a href="#l76.1308"></a><span id="l76.1308" class="difflineplus">+                                           &amp;bytesRead);</span>
<a href="#l76.1309"></a><span id="l76.1309" class="difflineplus">+      if (NS_FAILED(rv) || !bytesRead) {</span>
<a href="#l76.1310"></a><span id="l76.1310">         status = NS_FAILED(rv) ? -1 : 0;</span>
<a href="#l76.1311"></a><span id="l76.1311">         break;</span>
<a href="#l76.1312"></a><span id="l76.1312" class="difflineminus">-      }</span>
<a href="#l76.1313"></a><span id="l76.1313" class="difflineminus">-      else</span>
<a href="#l76.1314"></a><span id="l76.1314" class="difflineminus">-      {</span>
<a href="#l76.1315"></a><span id="l76.1315" class="difflineplus">+      } else {</span>
<a href="#l76.1316"></a><span id="l76.1316">         /* It would be really nice to be able to yield here, and let</span>
<a href="#l76.1317"></a><span id="l76.1317">            some user events and other input sources get processed.</span>
<a href="#l76.1318"></a><span id="l76.1318">            Oh well. */</span>
<a href="#l76.1319"></a><span id="l76.1319"> </span>
<a href="#l76.1320"></a><span id="l76.1320">         status = body-&gt;clazz-&gt;parse_buffer(buf, bytesRead, body);</span>
<a href="#l76.1321"></a><span id="l76.1321">         if (status &lt; 0) break;</span>
<a href="#l76.1322"></a><span id="l76.1322">       }</span>
<a href="#l76.1323"></a><span id="l76.1323">     }</span>
<a href="#l76.1324"></a><span id="l76.1324" class="difflineat">@@ -1160,39 +1068,35 @@ MimeMultipartRelated_parse_eof (MimeObje</span>
<a href="#l76.1325"></a><span id="l76.1325">   status = body-&gt;clazz-&gt;parse_eof(body, false);</span>
<a href="#l76.1326"></a><span id="l76.1326">   if (status &lt; 0) goto FAIL;</span>
<a href="#l76.1327"></a><span id="l76.1327">   status = body-&gt;clazz-&gt;parse_end(body, false);</span>
<a href="#l76.1328"></a><span id="l76.1328">   if (status &lt; 0) goto FAIL;</span>
<a href="#l76.1329"></a><span id="l76.1329"> </span>
<a href="#l76.1330"></a><span id="l76.1330"> FAIL:</span>
<a href="#l76.1331"></a><span id="l76.1331"> </span>
<a href="#l76.1332"></a><span id="l76.1332"> #ifdef MIME_DRAFTS</span>
<a href="#l76.1333"></a><span id="l76.1333" class="difflineminus">-  if ( obj-&gt;options &amp;&amp;</span>
<a href="#l76.1334"></a><span id="l76.1334" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l76.1335"></a><span id="l76.1335" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_close_fn &amp;&amp;</span>
<a href="#l76.1336"></a><span id="l76.1336" class="difflineminus">-     (relobj-&gt;file_buffer || relobj-&gt;head_buffer)) {</span>
<a href="#l76.1337"></a><span id="l76.1337" class="difflineminus">-  status = obj-&gt;options-&gt;decompose_file_close_fn ( obj-&gt;options-&gt;stream_closure );</span>
<a href="#l76.1338"></a><span id="l76.1338" class="difflineminus">-  if (status &lt; 0) return status;</span>
<a href="#l76.1339"></a><span id="l76.1339" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l76.1340"></a><span id="l76.1340" class="difflineplus">+      obj-&gt;options-&gt;decompose_file_close_fn &amp;&amp;</span>
<a href="#l76.1341"></a><span id="l76.1341" class="difflineplus">+      (relobj-&gt;file_buffer || relobj-&gt;head_buffer)) {</span>
<a href="#l76.1342"></a><span id="l76.1342" class="difflineplus">+    status =</span>
<a href="#l76.1343"></a><span id="l76.1343" class="difflineplus">+        obj-&gt;options-&gt;decompose_file_close_fn(obj-&gt;options-&gt;stream_closure);</span>
<a href="#l76.1344"></a><span id="l76.1344" class="difflineplus">+    if (status &lt; 0) return status;</span>
<a href="#l76.1345"></a><span id="l76.1345">   }</span>
<a href="#l76.1346"></a><span id="l76.1346"> #endif /* MIME_DRAFTS */</span>
<a href="#l76.1347"></a><span id="l76.1347"> </span>
<a href="#l76.1348"></a><span id="l76.1348">   obj-&gt;options-&gt;output_fn = relobj-&gt;real_output_fn;</span>
<a href="#l76.1349"></a><span id="l76.1349">   obj-&gt;options-&gt;output_closure = relobj-&gt;real_output_closure;</span>
<a href="#l76.1350"></a><span id="l76.1350"> </span>
<a href="#l76.1351"></a><span id="l76.1351">   return status;</span>
<a href="#l76.1352"></a><span id="l76.1352"> }</span>
<a href="#l76.1353"></a><span id="l76.1353"> </span>
<a href="#l76.1354"></a><span id="l76.1354" class="difflineminus">-</span>
<a href="#l76.1355"></a><span id="l76.1355" class="difflineminus">-</span>
<a href="#l76.1356"></a><span id="l76.1356" class="difflineminus">-</span>
<a href="#l76.1357"></a><span id="l76.1357" class="difflineminus">-static int</span>
<a href="#l76.1358"></a><span id="l76.1358" class="difflineminus">-MimeMultipartRelatedClassInitialize(MimeMultipartRelatedClass *clazz)</span>
<a href="#l76.1359"></a><span id="l76.1359" class="difflineminus">-{</span>
<a href="#l76.1360"></a><span id="l76.1360" class="difflineminus">-  MimeObjectClass    *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l76.1361"></a><span id="l76.1361" class="difflineminus">-  MimeMultipartClass *mclass = (MimeMultipartClass *) clazz;</span>
<a href="#l76.1362"></a><span id="l76.1362" class="difflineplus">+static int MimeMultipartRelatedClassInitialize(</span>
<a href="#l76.1363"></a><span id="l76.1363" class="difflineplus">+    MimeMultipartRelatedClass *clazz) {</span>
<a href="#l76.1364"></a><span id="l76.1364" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l76.1365"></a><span id="l76.1365" class="difflineplus">+  MimeMultipartClass *mclass = (MimeMultipartClass *)clazz;</span>
<a href="#l76.1366"></a><span id="l76.1366">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l76.1367"></a><span id="l76.1367" class="difflineminus">-  oclass-&gt;initialize       = MimeMultipartRelated_initialize;</span>
<a href="#l76.1368"></a><span id="l76.1368" class="difflineminus">-  oclass-&gt;finalize         = MimeMultipartRelated_finalize;</span>
<a href="#l76.1369"></a><span id="l76.1369" class="difflineminus">-  oclass-&gt;parse_eof        = MimeMultipartRelated_parse_eof;</span>
<a href="#l76.1370"></a><span id="l76.1370" class="difflineminus">-  mclass-&gt;output_child_p   = MimeMultipartRelated_output_child_p;</span>
<a href="#l76.1371"></a><span id="l76.1371" class="difflineplus">+  oclass-&gt;initialize = MimeMultipartRelated_initialize;</span>
<a href="#l76.1372"></a><span id="l76.1372" class="difflineplus">+  oclass-&gt;finalize = MimeMultipartRelated_finalize;</span>
<a href="#l76.1373"></a><span id="l76.1373" class="difflineplus">+  oclass-&gt;parse_eof = MimeMultipartRelated_parse_eof;</span>
<a href="#l76.1374"></a><span id="l76.1374" class="difflineplus">+  mclass-&gt;output_child_p = MimeMultipartRelated_output_child_p;</span>
<a href="#l76.1375"></a><span id="l76.1375">   mclass-&gt;parse_child_line = MimeMultipartRelated_parse_child_line;</span>
<a href="#l76.1376"></a><span id="l76.1376">   return 0;</span>
<a href="#l76.1377"></a><span id="l76.1377"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/mailnews/mime/src/mimemrel.h</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/mailnews/mime/src/mimemrel.h</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -5,62 +5,59 @@</span>
<a href="#l77.4"></a><span id="l77.4"> </span>
<a href="#l77.5"></a><span id="l77.5"> #ifndef _MIMEMREL_H_</span>
<a href="#l77.6"></a><span id="l77.6"> #define _MIMEMREL_H_</span>
<a href="#l77.7"></a><span id="l77.7"> </span>
<a href="#l77.8"></a><span id="l77.8"> #include &quot;mimemult.h&quot;</span>
<a href="#l77.9"></a><span id="l77.9"> #include &quot;plhash.h&quot;</span>
<a href="#l77.10"></a><span id="l77.10"> #include &quot;prio.h&quot;</span>
<a href="#l77.11"></a><span id="l77.11"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-#include &quot;modmimee.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+#include &quot;modmimee.h&quot;  // for MimeConverterOutputCallback</span>
<a href="#l77.14"></a><span id="l77.14"> </span>
<a href="#l77.15"></a><span id="l77.15"> /* The MimeMultipartRelated class implements the multipart/related MIME</span>
<a href="#l77.16"></a><span id="l77.16">    container, which allows `sibling' sub-parts to refer to each other.</span>
<a href="#l77.17"></a><span id="l77.17">  */</span>
<a href="#l77.18"></a><span id="l77.18"> </span>
<a href="#l77.19"></a><span id="l77.19"> typedef struct MimeMultipartRelatedClass MimeMultipartRelatedClass;</span>
<a href="#l77.20"></a><span id="l77.20" class="difflineminus">-typedef struct MimeMultipartRelated      MimeMultipartRelated;</span>
<a href="#l77.21"></a><span id="l77.21" class="difflineplus">+typedef struct MimeMultipartRelated MimeMultipartRelated;</span>
<a href="#l77.22"></a><span id="l77.22"> </span>
<a href="#l77.23"></a><span id="l77.23"> struct MimeMultipartRelatedClass {</span>
<a href="#l77.24"></a><span id="l77.24">   MimeMultipartClass multipart;</span>
<a href="#l77.25"></a><span id="l77.25"> };</span>
<a href="#l77.26"></a><span id="l77.26"> </span>
<a href="#l77.27"></a><span id="l77.27"> extern &quot;C&quot; MimeMultipartRelatedClass mimeMultipartRelatedClass;</span>
<a href="#l77.28"></a><span id="l77.28"> </span>
<a href="#l77.29"></a><span id="l77.29"> struct MimeMultipartRelated {</span>
<a href="#l77.30"></a><span id="l77.30" class="difflineminus">-  MimeMultipart multipart;  /* superclass variables */</span>
<a href="#l77.31"></a><span id="l77.31" class="difflineplus">+  MimeMultipart multipart; /* superclass variables */</span>
<a href="#l77.32"></a><span id="l77.32"> </span>
<a href="#l77.33"></a><span id="l77.33" class="difflineminus">-  char* base_url;        /* Base URL (if any) for the whole</span>
<a href="#l77.34"></a><span id="l77.34" class="difflineminus">-                   multipart/related. */</span>
<a href="#l77.35"></a><span id="l77.35" class="difflineplus">+  char* base_url; /* Base URL (if any) for the whole</span>
<a href="#l77.36"></a><span id="l77.36" class="difflineplus">+            multipart/related. */</span>
<a href="#l77.37"></a><span id="l77.37"> </span>
<a href="#l77.38"></a><span id="l77.38" class="difflineminus">-  char* head_buffer;      /* Buffer used to remember the text/html 'head'</span>
<a href="#l77.39"></a><span id="l77.39" class="difflineminus">-                   part. */</span>
<a href="#l77.40"></a><span id="l77.40" class="difflineminus">-  uint32_t head_buffer_fp;    /* Active length. */</span>
<a href="#l77.41"></a><span id="l77.41" class="difflineminus">-  uint32_t head_buffer_size;    /* How big it is. */</span>
<a href="#l77.42"></a><span id="l77.42" class="difflineplus">+  char* head_buffer;         /* Buffer used to remember the text/html 'head'</span>
<a href="#l77.43"></a><span id="l77.43" class="difflineplus">+                      part. */</span>
<a href="#l77.44"></a><span id="l77.44" class="difflineplus">+  uint32_t head_buffer_fp;   /* Active length. */</span>
<a href="#l77.45"></a><span id="l77.45" class="difflineplus">+  uint32_t head_buffer_size; /* How big it is. */</span>
<a href="#l77.46"></a><span id="l77.46"> </span>
<a href="#l77.47"></a><span id="l77.47" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;          file_buffer;    /* The nsIFile of a temp file used when we</span>
<a href="#l77.48"></a><span id="l77.48" class="difflineminus">-                                               run out of room in the head_buffer. */</span>
<a href="#l77.49"></a><span id="l77.49" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt;   input_file_stream;    /* A stream to it. */</span>
<a href="#l77.50"></a><span id="l77.50" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt;  output_file_stream;  /* A stream to it. */</span>
<a href="#l77.51"></a><span id="l77.51" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; file_buffer; /* The nsIFile of a temp file used when we</span>
<a href="#l77.52"></a><span id="l77.52" class="difflineplus">+                                  run out of room in the head_buffer. */</span>
<a href="#l77.53"></a><span id="l77.53" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; input_file_stream;   /* A stream to it. */</span>
<a href="#l77.54"></a><span id="l77.54" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; output_file_stream; /* A stream to it. */</span>
<a href="#l77.55"></a><span id="l77.55"> </span>
<a href="#l77.56"></a><span id="l77.56" class="difflineminus">-  MimeHeaders* buffered_hdrs;  /* The headers of the 'head' part. */</span>
<a href="#l77.57"></a><span id="l77.57" class="difflineplus">+  MimeHeaders* buffered_hdrs; /* The headers of the 'head' part. */</span>
<a href="#l77.58"></a><span id="l77.58"> </span>
<a href="#l77.59"></a><span id="l77.59">   bool head_loaded;    /* Whether we've already passed the 'head'</span>
<a href="#l77.60"></a><span id="l77.60">                    part. */</span>
<a href="#l77.61"></a><span id="l77.61" class="difflineminus">-  MimeObject* headobj;    /* The actual text/html head object. */</span>
<a href="#l77.62"></a><span id="l77.62" class="difflineplus">+  MimeObject* headobj; /* The actual text/html head object. */</span>
<a href="#l77.63"></a><span id="l77.63"> </span>
<a href="#l77.64"></a><span id="l77.64" class="difflineminus">-  PLHashTable    *hash;</span>
<a href="#l77.65"></a><span id="l77.65" class="difflineplus">+  PLHashTable* hash;</span>
<a href="#l77.66"></a><span id="l77.66"> </span>
<a href="#l77.67"></a><span id="l77.67">   MimeConverterOutputCallback real_output_fn;</span>
<a href="#l77.68"></a><span id="l77.68">   void* real_output_closure;</span>
<a href="#l77.69"></a><span id="l77.69"> </span>
<a href="#l77.70"></a><span id="l77.70">   char* curtag;</span>
<a href="#l77.71"></a><span id="l77.71">   int32_t curtag_max;</span>
<a href="#l77.72"></a><span id="l77.72">   int32_t curtag_length;</span>
<a href="#l77.73"></a><span id="l77.73" class="difflineminus">-</span>
<a href="#l77.74"></a><span id="l77.74" class="difflineminus">-</span>
<a href="#l77.75"></a><span id="l77.75" class="difflineminus">-</span>
<a href="#l77.76"></a><span id="l77.76"> };</span>
<a href="#l77.77"></a><span id="l77.77"> </span>
<a href="#l77.78"></a><span id="l77.78" class="difflineminus">-#define MimeMultipartRelatedClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l77.79"></a><span id="l77.79" class="difflineminus">-  { MimeMultipartClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l77.80"></a><span id="l77.80" class="difflineplus">+#define MimeMultipartRelatedClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l77.81"></a><span id="l77.81" class="difflineplus">+  { MimeMultipartClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l77.82"></a><span id="l77.82"> </span>
<a href="#l77.83"></a><span id="l77.83"> #endif /* _MIMEMREL_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/mailnews/mime/src/mimemsg.cpp</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/mailnews/mime/src/mimemsg.cpp</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -19,272 +19,236 @@</span>
<a href="#l78.4"></a><span id="l78.4"> #include &quot;mimetext.h&quot;</span>
<a href="#l78.5"></a><span id="l78.5"> #include &quot;mimecryp.h&quot;</span>
<a href="#l78.6"></a><span id="l78.6"> #include &quot;mimetpfl.h&quot;</span>
<a href="#l78.7"></a><span id="l78.7"> #include &quot;nsINetUtil.h&quot;</span>
<a href="#l78.8"></a><span id="l78.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l78.9"></a><span id="l78.9"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l78.10"></a><span id="l78.10"> </span>
<a href="#l78.11"></a><span id="l78.11"> #define MIME_SUPERCLASS mimeContainerClass</span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-MimeDefClass(MimeMessage, MimeMessageClass, mimeMessageClass,</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineminus">-       &amp;MIME_SUPERCLASS);</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineplus">+MimeDefClass(MimeMessage, MimeMessageClass, mimeMessageClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l78.15"></a><span id="l78.15"> </span>
<a href="#l78.16"></a><span id="l78.16" class="difflineminus">-static int MimeMessage_initialize (MimeObject *);</span>
<a href="#l78.17"></a><span id="l78.17" class="difflineminus">-static void MimeMessage_finalize (MimeObject *);</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineminus">-static int MimeMessage_add_child (MimeObject *, MimeObject *);</span>
<a href="#l78.19"></a><span id="l78.19" class="difflineminus">-static int MimeMessage_parse_begin (MimeObject *);</span>
<a href="#l78.20"></a><span id="l78.20" class="difflineminus">-static int MimeMessage_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l78.21"></a><span id="l78.21" class="difflineminus">-static int MimeMessage_parse_eof (MimeObject *, bool);</span>
<a href="#l78.22"></a><span id="l78.22" class="difflineminus">-static int MimeMessage_close_headers (MimeObject *obj);</span>
<a href="#l78.23"></a><span id="l78.23" class="difflineminus">-static int MimeMessage_write_headers_html (MimeObject *);</span>
<a href="#l78.24"></a><span id="l78.24" class="difflineminus">-static char *MimeMessage_partial_message_html(const char *data,</span>
<a href="#l78.25"></a><span id="l78.25" class="difflineminus">-                        void *closure,</span>
<a href="#l78.26"></a><span id="l78.26" class="difflineminus">-                        MimeHeaders *headers);</span>
<a href="#l78.27"></a><span id="l78.27" class="difflineplus">+static int MimeMessage_initialize(MimeObject *);</span>
<a href="#l78.28"></a><span id="l78.28" class="difflineplus">+static void MimeMessage_finalize(MimeObject *);</span>
<a href="#l78.29"></a><span id="l78.29" class="difflineplus">+static int MimeMessage_add_child(MimeObject *, MimeObject *);</span>
<a href="#l78.30"></a><span id="l78.30" class="difflineplus">+static int MimeMessage_parse_begin(MimeObject *);</span>
<a href="#l78.31"></a><span id="l78.31" class="difflineplus">+static int MimeMessage_parse_line(const char *, int32_t, MimeObject *);</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineplus">+static int MimeMessage_parse_eof(MimeObject *, bool);</span>
<a href="#l78.33"></a><span id="l78.33" class="difflineplus">+static int MimeMessage_close_headers(MimeObject *obj);</span>
<a href="#l78.34"></a><span id="l78.34" class="difflineplus">+static int MimeMessage_write_headers_html(MimeObject *);</span>
<a href="#l78.35"></a><span id="l78.35" class="difflineplus">+static char *MimeMessage_partial_message_html(const char *data, void *closure,</span>
<a href="#l78.36"></a><span id="l78.36" class="difflineplus">+                                              MimeHeaders *headers);</span>
<a href="#l78.37"></a><span id="l78.37"> </span>
<a href="#l78.38"></a><span id="l78.38"> #ifdef XP_UNIX</span>
<a href="#l78.39"></a><span id="l78.39"> extern void MimeHeaders_do_unix_display_hook_hack(MimeHeaders *);</span>
<a href="#l78.40"></a><span id="l78.40"> #endif /* XP_UNIX */</span>
<a href="#l78.41"></a><span id="l78.41"> </span>
<a href="#l78.42"></a><span id="l78.42"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l78.43"></a><span id="l78.43" class="difflineminus">-static int MimeMessage_debug_print (MimeObject *, PRFileDesc *, int32_t depth);</span>
<a href="#l78.44"></a><span id="l78.44" class="difflineplus">+static int MimeMessage_debug_print(MimeObject *, PRFileDesc *, int32_t depth);</span>
<a href="#l78.45"></a><span id="l78.45"> #endif</span>
<a href="#l78.46"></a><span id="l78.46"> </span>
<a href="#l78.47"></a><span id="l78.47"> extern MimeObjectClass mimeMultipartClass;</span>
<a href="#l78.48"></a><span id="l78.48"> </span>
<a href="#l78.49"></a><span id="l78.49" class="difflineminus">-static int</span>
<a href="#l78.50"></a><span id="l78.50" class="difflineminus">-MimeMessageClassInitialize(MimeMessageClass *clazz)</span>
<a href="#l78.51"></a><span id="l78.51" class="difflineminus">-{</span>
<a href="#l78.52"></a><span id="l78.52" class="difflineminus">-  MimeObjectClass    *oclass = (MimeObjectClass *)    clazz;</span>
<a href="#l78.53"></a><span id="l78.53" class="difflineminus">-  MimeContainerClass *cclass = (MimeContainerClass *) clazz;</span>
<a href="#l78.54"></a><span id="l78.54" class="difflineplus">+static int MimeMessageClassInitialize(MimeMessageClass *clazz) {</span>
<a href="#l78.55"></a><span id="l78.55" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l78.56"></a><span id="l78.56" class="difflineplus">+  MimeContainerClass *cclass = (MimeContainerClass *)clazz;</span>
<a href="#l78.57"></a><span id="l78.57"> </span>
<a href="#l78.58"></a><span id="l78.58">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l78.59"></a><span id="l78.59" class="difflineminus">-  oclass-&gt;initialize  = MimeMessage_initialize;</span>
<a href="#l78.60"></a><span id="l78.60" class="difflineminus">-  oclass-&gt;finalize    = MimeMessage_finalize;</span>
<a href="#l78.61"></a><span id="l78.61" class="difflineplus">+  oclass-&gt;initialize = MimeMessage_initialize;</span>
<a href="#l78.62"></a><span id="l78.62" class="difflineplus">+  oclass-&gt;finalize = MimeMessage_finalize;</span>
<a href="#l78.63"></a><span id="l78.63">   oclass-&gt;parse_begin = MimeMessage_parse_begin;</span>
<a href="#l78.64"></a><span id="l78.64" class="difflineminus">-  oclass-&gt;parse_line  = MimeMessage_parse_line;</span>
<a href="#l78.65"></a><span id="l78.65" class="difflineminus">-  oclass-&gt;parse_eof   = MimeMessage_parse_eof;</span>
<a href="#l78.66"></a><span id="l78.66" class="difflineminus">-  cclass-&gt;add_child   = MimeMessage_add_child;</span>
<a href="#l78.67"></a><span id="l78.67" class="difflineplus">+  oclass-&gt;parse_line = MimeMessage_parse_line;</span>
<a href="#l78.68"></a><span id="l78.68" class="difflineplus">+  oclass-&gt;parse_eof = MimeMessage_parse_eof;</span>
<a href="#l78.69"></a><span id="l78.69" class="difflineplus">+  cclass-&gt;add_child = MimeMessage_add_child;</span>
<a href="#l78.70"></a><span id="l78.70"> </span>
<a href="#l78.71"></a><span id="l78.71"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l78.72"></a><span id="l78.72">   oclass-&gt;debug_print = MimeMessage_debug_print;</span>
<a href="#l78.73"></a><span id="l78.73"> #endif</span>
<a href="#l78.74"></a><span id="l78.74">   return 0;</span>
<a href="#l78.75"></a><span id="l78.75"> }</span>
<a href="#l78.76"></a><span id="l78.76"> </span>
<a href="#l78.77"></a><span id="l78.77" class="difflineminus">-</span>
<a href="#l78.78"></a><span id="l78.78" class="difflineminus">-static int</span>
<a href="#l78.79"></a><span id="l78.79" class="difflineminus">-MimeMessage_initialize (MimeObject *object)</span>
<a href="#l78.80"></a><span id="l78.80" class="difflineminus">-{</span>
<a href="#l78.81"></a><span id="l78.81" class="difflineplus">+static int MimeMessage_initialize(MimeObject *object) {</span>
<a href="#l78.82"></a><span id="l78.82">   MimeMessage *msg = (MimeMessage *)object;</span>
<a href="#l78.83"></a><span id="l78.83">   msg-&gt;grabSubject = false;</span>
<a href="#l78.84"></a><span id="l78.84">   msg-&gt;bodyLength = 0;</span>
<a href="#l78.85"></a><span id="l78.85">   msg-&gt;sizeSoFar = 0;</span>
<a href="#l78.86"></a><span id="l78.86"> </span>
<a href="#l78.87"></a><span id="l78.87" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l78.88"></a><span id="l78.88" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l78.89"></a><span id="l78.89"> }</span>
<a href="#l78.90"></a><span id="l78.90"> </span>
<a href="#l78.91"></a><span id="l78.91" class="difflineminus">-static void</span>
<a href="#l78.92"></a><span id="l78.92" class="difflineminus">-MimeMessage_finalize (MimeObject *object)</span>
<a href="#l78.93"></a><span id="l78.93" class="difflineminus">-{</span>
<a href="#l78.94"></a><span id="l78.94" class="difflineplus">+static void MimeMessage_finalize(MimeObject *object) {</span>
<a href="#l78.95"></a><span id="l78.95">   MimeMessage *msg = (MimeMessage *)object;</span>
<a href="#l78.96"></a><span id="l78.96" class="difflineminus">-  if (msg-&gt;hdrs)</span>
<a href="#l78.97"></a><span id="l78.97" class="difflineminus">-  MimeHeaders_free(msg-&gt;hdrs);</span>
<a href="#l78.98"></a><span id="l78.98" class="difflineplus">+  if (msg-&gt;hdrs) MimeHeaders_free(msg-&gt;hdrs);</span>
<a href="#l78.99"></a><span id="l78.99">   msg-&gt;hdrs = 0;</span>
<a href="#l78.100"></a><span id="l78.100" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l78.101"></a><span id="l78.101" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l78.102"></a><span id="l78.102"> }</span>
<a href="#l78.103"></a><span id="l78.103"> </span>
<a href="#l78.104"></a><span id="l78.104" class="difflineminus">-static int</span>
<a href="#l78.105"></a><span id="l78.105" class="difflineminus">-MimeMessage_parse_begin (MimeObject *obj)</span>
<a href="#l78.106"></a><span id="l78.106" class="difflineminus">-{</span>
<a href="#l78.107"></a><span id="l78.107" class="difflineplus">+static int MimeMessage_parse_begin(MimeObject *obj) {</span>
<a href="#l78.108"></a><span id="l78.108">   MimeMessage *msg = (MimeMessage *)obj;</span>
<a href="#l78.109"></a><span id="l78.109"> </span>
<a href="#l78.110"></a><span id="l78.110" class="difflineminus">-  int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l78.111"></a><span id="l78.111" class="difflineplus">+  int status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l78.112"></a><span id="l78.112">   if (status &lt; 0) return status;</span>
<a href="#l78.113"></a><span id="l78.113"> </span>
<a href="#l78.114"></a><span id="l78.114" class="difflineminus">-  if (obj-&gt;parent)</span>
<a href="#l78.115"></a><span id="l78.115" class="difflineminus">-  {</span>
<a href="#l78.116"></a><span id="l78.116" class="difflineplus">+  if (obj-&gt;parent) {</span>
<a href="#l78.117"></a><span id="l78.117">     msg-&gt;grabSubject = true;</span>
<a href="#l78.118"></a><span id="l78.118">   }</span>
<a href="#l78.119"></a><span id="l78.119"> </span>
<a href="#l78.120"></a><span id="l78.120">   /* Messages have separators before the headers, except for the outermost</span>
<a href="#l78.121"></a><span id="l78.121">    message. */</span>
<a href="#l78.122"></a><span id="l78.122">   return MimeObject_write_separator(obj);</span>
<a href="#l78.123"></a><span id="l78.123"> }</span>
<a href="#l78.124"></a><span id="l78.124"> </span>
<a href="#l78.125"></a><span id="l78.125" class="difflineminus">-</span>
<a href="#l78.126"></a><span id="l78.126" class="difflineminus">-static int</span>
<a href="#l78.127"></a><span id="l78.127" class="difflineminus">-MimeMessage_parse_line (const char *aLine, int32_t aLength, MimeObject *obj)</span>
<a href="#l78.128"></a><span id="l78.128" class="difflineminus">-{</span>
<a href="#l78.129"></a><span id="l78.129" class="difflineminus">-  const char * line = aLine;</span>
<a href="#l78.130"></a><span id="l78.130" class="difflineplus">+static int MimeMessage_parse_line(const char *aLine, int32_t aLength,</span>
<a href="#l78.131"></a><span id="l78.131" class="difflineplus">+                                  MimeObject *obj) {</span>
<a href="#l78.132"></a><span id="l78.132" class="difflineplus">+  const char *line = aLine;</span>
<a href="#l78.133"></a><span id="l78.133">   int32_t length = aLength;</span>
<a href="#l78.134"></a><span id="l78.134"> </span>
<a href="#l78.135"></a><span id="l78.135" class="difflineminus">-  MimeMessage *msg = (MimeMessage *) obj;</span>
<a href="#l78.136"></a><span id="l78.136" class="difflineplus">+  MimeMessage *msg = (MimeMessage *)obj;</span>
<a href="#l78.137"></a><span id="l78.137">   int status = 0;</span>
<a href="#l78.138"></a><span id="l78.138"> </span>
<a href="#l78.139"></a><span id="l78.139">   NS_ASSERTION(line &amp;&amp; *line, &quot;empty line in mime msg parse_line&quot;);</span>
<a href="#l78.140"></a><span id="l78.140">   if (!line || !*line) return -1;</span>
<a href="#l78.141"></a><span id="l78.141"> </span>
<a href="#l78.142"></a><span id="l78.142">   msg-&gt;sizeSoFar += length;</span>
<a href="#l78.143"></a><span id="l78.143"> </span>
<a href="#l78.144"></a><span id="l78.144" class="difflineminus">-  if (msg-&gt;grabSubject)</span>
<a href="#l78.145"></a><span id="l78.145" class="difflineminus">-  {</span>
<a href="#l78.146"></a><span id="l78.146" class="difflineminus">-    if ( (!PL_strncasecmp(line, &quot;Subject: &quot;, 9)) &amp;&amp; (obj-&gt;parent) )</span>
<a href="#l78.147"></a><span id="l78.147" class="difflineminus">-    {</span>
<a href="#l78.148"></a><span id="l78.148" class="difflineminus">-      if ( (obj-&gt;headers) &amp;&amp; (!obj-&gt;headers-&gt;munged_subject) )</span>
<a href="#l78.149"></a><span id="l78.149" class="difflineminus">-      {</span>
<a href="#l78.150"></a><span id="l78.150" class="difflineminus">-        obj-&gt;headers-&gt;munged_subject = (char *) PL_strndup(line + 9, length - 9);</span>
<a href="#l78.151"></a><span id="l78.151" class="difflineplus">+  if (msg-&gt;grabSubject) {</span>
<a href="#l78.152"></a><span id="l78.152" class="difflineplus">+    if ((!PL_strncasecmp(line, &quot;Subject: &quot;, 9)) &amp;&amp; (obj-&gt;parent)) {</span>
<a href="#l78.153"></a><span id="l78.153" class="difflineplus">+      if ((obj-&gt;headers) &amp;&amp; (!obj-&gt;headers-&gt;munged_subject)) {</span>
<a href="#l78.154"></a><span id="l78.154" class="difflineplus">+        obj-&gt;headers-&gt;munged_subject = (char *)PL_strndup(line + 9, length - 9);</span>
<a href="#l78.155"></a><span id="l78.155">         char *tPtr = obj-&gt;headers-&gt;munged_subject;</span>
<a href="#l78.156"></a><span id="l78.156" class="difflineminus">-        while (*tPtr)</span>
<a href="#l78.157"></a><span id="l78.157" class="difflineminus">-        {</span>
<a href="#l78.158"></a><span id="l78.158" class="difflineminus">-          if ( (*tPtr == '\r') || (*tPtr == '\n') )</span>
<a href="#l78.159"></a><span id="l78.159" class="difflineminus">-          {</span>
<a href="#l78.160"></a><span id="l78.160" class="difflineplus">+        while (*tPtr) {</span>
<a href="#l78.161"></a><span id="l78.161" class="difflineplus">+          if ((*tPtr == '\r') || (*tPtr == '\n')) {</span>
<a href="#l78.162"></a><span id="l78.162">             *tPtr = '\0';</span>
<a href="#l78.163"></a><span id="l78.163">             break;</span>
<a href="#l78.164"></a><span id="l78.164">           }</span>
<a href="#l78.165"></a><span id="l78.165">           tPtr++;</span>
<a href="#l78.166"></a><span id="l78.166">         }</span>
<a href="#l78.167"></a><span id="l78.167">       }</span>
<a href="#l78.168"></a><span id="l78.168">     }</span>
<a href="#l78.169"></a><span id="l78.169">   }</span>
<a href="#l78.170"></a><span id="l78.170"> </span>
<a href="#l78.171"></a><span id="l78.171">   /* If we already have a child object, then we're done parsing headers,</span>
<a href="#l78.172"></a><span id="l78.172">    and all subsequent lines get passed to the inferior object without</span>
<a href="#l78.173"></a><span id="l78.173">    further processing by us.  (Our parent will stop feeding us lines</span>
<a href="#l78.174"></a><span id="l78.174">    when this MimeMessage part is out of data.)</span>
<a href="#l78.175"></a><span id="l78.175">    */</span>
<a href="#l78.176"></a><span id="l78.176" class="difflineminus">-  if (msg-&gt;container.nchildren)</span>
<a href="#l78.177"></a><span id="l78.177" class="difflineminus">-  {</span>
<a href="#l78.178"></a><span id="l78.178" class="difflineplus">+  if (msg-&gt;container.nchildren) {</span>
<a href="#l78.179"></a><span id="l78.179">     MimeObject *kid = msg-&gt;container.children[0];</span>
<a href="#l78.180"></a><span id="l78.180">     bool nl;</span>
<a href="#l78.181"></a><span id="l78.181">     PR_ASSERT(kid);</span>
<a href="#l78.182"></a><span id="l78.182">     if (!kid) return -1;</span>
<a href="#l78.183"></a><span id="l78.183"> </span>
<a href="#l78.184"></a><span id="l78.184">     msg-&gt;bodyLength += length;</span>
<a href="#l78.185"></a><span id="l78.185"> </span>
<a href="#l78.186"></a><span id="l78.186">     /* Don't allow MimeMessage objects to not end in a newline, since it</span>
<a href="#l78.187"></a><span id="l78.187">      would be inappropriate for any following part to appear on the same</span>
<a href="#l78.188"></a><span id="l78.188">      line as the last line of the message.</span>
<a href="#l78.189"></a><span id="l78.189"> </span>
<a href="#l78.190"></a><span id="l78.190">      #### This assumes that the only time the `parse_line' method is</span>
<a href="#l78.191"></a><span id="l78.191">      called with a line that doesn't end in a newline is when that line</span>
<a href="#l78.192"></a><span id="l78.192">      is the last line.</span>
<a href="#l78.193"></a><span id="l78.193">      */</span>
<a href="#l78.194"></a><span id="l78.194" class="difflineminus">-    nl = (length &gt; 0 &amp;&amp; (line[length-1] == '\r' || line[length-1] == '\n'));</span>
<a href="#l78.195"></a><span id="l78.195" class="difflineplus">+    nl = (length &gt; 0 &amp;&amp; (line[length - 1] == '\r' || line[length - 1] == '\n'));</span>
<a href="#l78.196"></a><span id="l78.196"> </span>
<a href="#l78.197"></a><span id="l78.197"> #ifdef MIME_DRAFTS</span>
<a href="#l78.198"></a><span id="l78.198" class="difflineminus">-    if (!mime_typep (kid, (MimeObjectClass*) &amp;mimeMessageClass) &amp;&amp;</span>
<a href="#l78.199"></a><span id="l78.199" class="difflineminus">-        obj-&gt;options &amp;&amp;</span>
<a href="#l78.200"></a><span id="l78.200" class="difflineminus">-        obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l78.201"></a><span id="l78.201" class="difflineplus">+    if (!mime_typep(kid, (MimeObjectClass *)&amp;mimeMessageClass) &amp;&amp;</span>
<a href="#l78.202"></a><span id="l78.202" class="difflineplus">+        obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l78.203"></a><span id="l78.203">         !obj-&gt;options-&gt;is_multipart_msg &amp;&amp;</span>
<a href="#l78.204"></a><span id="l78.204" class="difflineminus">-        obj-&gt;options-&gt;decompose_file_output_fn &amp;&amp;</span>
<a href="#l78.205"></a><span id="l78.205" class="difflineminus">-        !obj-&gt;options-&gt;decrypt_p)</span>
<a href="#l78.206"></a><span id="l78.206" class="difflineminus">-    {</span>
<a href="#l78.207"></a><span id="l78.207" class="difflineplus">+        obj-&gt;options-&gt;decompose_file_output_fn &amp;&amp; !obj-&gt;options-&gt;decrypt_p) {</span>
<a href="#l78.208"></a><span id="l78.208">       // If we are processing a flowed plain text line, we need to parse the</span>
<a href="#l78.209"></a><span id="l78.209">       // line in mimeInlineTextPlainFlowedClass.</span>
<a href="#l78.210"></a><span id="l78.210" class="difflineminus">-      if (mime_typep(kid, (MimeObjectClass *)&amp;mimeInlineTextPlainFlowedClass))</span>
<a href="#l78.211"></a><span id="l78.211" class="difflineminus">-      {</span>
<a href="#l78.212"></a><span id="l78.212" class="difflineplus">+      if (mime_typep(kid, (MimeObjectClass *)&amp;mimeInlineTextPlainFlowedClass)) {</span>
<a href="#l78.213"></a><span id="l78.213">         // Remove any stuffed space.</span>
<a href="#l78.214"></a><span id="l78.214" class="difflineminus">-        if (length &gt; 0 &amp;&amp; ' ' == *line)</span>
<a href="#l78.215"></a><span id="l78.215" class="difflineminus">-        {</span>
<a href="#l78.216"></a><span id="l78.216" class="difflineplus">+        if (length &gt; 0 &amp;&amp; ' ' == *line) {</span>
<a href="#l78.217"></a><span id="l78.217">           line++;</span>
<a href="#l78.218"></a><span id="l78.218">           length--;</span>
<a href="#l78.219"></a><span id="l78.219">         }</span>
<a href="#l78.220"></a><span id="l78.220" class="difflineminus">-        return kid-&gt;clazz-&gt;parse_line (line, length, kid);</span>
<a href="#l78.221"></a><span id="l78.221" class="difflineminus">-      }</span>
<a href="#l78.222"></a><span id="l78.222" class="difflineminus">-      else</span>
<a href="#l78.223"></a><span id="l78.223" class="difflineminus">-      {</span>
<a href="#l78.224"></a><span id="l78.224" class="difflineminus">-        status = obj-&gt;options-&gt;decompose_file_output_fn (line,</span>
<a href="#l78.225"></a><span id="l78.225" class="difflineminus">-                                 length,</span>
<a href="#l78.226"></a><span id="l78.226" class="difflineminus">-                           obj-&gt;options-&gt;stream_closure);</span>
<a href="#l78.227"></a><span id="l78.227" class="difflineplus">+        return kid-&gt;clazz-&gt;parse_line(line, length, kid);</span>
<a href="#l78.228"></a><span id="l78.228" class="difflineplus">+      } else {</span>
<a href="#l78.229"></a><span id="l78.229" class="difflineplus">+        status = obj-&gt;options-&gt;decompose_file_output_fn(</span>
<a href="#l78.230"></a><span id="l78.230" class="difflineplus">+            line, length, obj-&gt;options-&gt;stream_closure);</span>
<a href="#l78.231"></a><span id="l78.231">         if (status &lt; 0) return status;</span>
<a href="#l78.232"></a><span id="l78.232">         if (!nl) {</span>
<a href="#l78.233"></a><span id="l78.233" class="difflineminus">-        status = obj-&gt;options-&gt;decompose_file_output_fn (MSG_LINEBREAK,</span>
<a href="#l78.234"></a><span id="l78.234" class="difflineminus">-                                 MSG_LINEBREAK_LEN,</span>
<a href="#l78.235"></a><span id="l78.235" class="difflineminus">-                           obj-&gt;options-&gt;stream_closure);</span>
<a href="#l78.236"></a><span id="l78.236" class="difflineminus">-        if (status &lt; 0) return status;</span>
<a href="#l78.237"></a><span id="l78.237" class="difflineplus">+          status = obj-&gt;options-&gt;decompose_file_output_fn(</span>
<a href="#l78.238"></a><span id="l78.238" class="difflineplus">+              MSG_LINEBREAK, MSG_LINEBREAK_LEN, obj-&gt;options-&gt;stream_closure);</span>
<a href="#l78.239"></a><span id="l78.239" class="difflineplus">+          if (status &lt; 0) return status;</span>
<a href="#l78.240"></a><span id="l78.240">         }</span>
<a href="#l78.241"></a><span id="l78.241">         return status;</span>
<a href="#l78.242"></a><span id="l78.242">       }</span>
<a href="#l78.243"></a><span id="l78.243">     }</span>
<a href="#l78.244"></a><span id="l78.244"> #endif /* MIME_DRAFTS */</span>
<a href="#l78.245"></a><span id="l78.245"> </span>
<a href="#l78.246"></a><span id="l78.246" class="difflineminus">-</span>
<a href="#l78.247"></a><span id="l78.247">     if (nl)</span>
<a href="#l78.248"></a><span id="l78.248" class="difflineminus">-    return kid-&gt;clazz-&gt;parse_buffer (line, length, kid);</span>
<a href="#l78.249"></a><span id="l78.249" class="difflineminus">-    else</span>
<a href="#l78.250"></a><span id="l78.250" class="difflineminus">-    {</span>
<a href="#l78.251"></a><span id="l78.251" class="difflineplus">+      return kid-&gt;clazz-&gt;parse_buffer(line, length, kid);</span>
<a href="#l78.252"></a><span id="l78.252" class="difflineplus">+    else {</span>
<a href="#l78.253"></a><span id="l78.253">       /* Hack a newline onto the end. */</span>
<a href="#l78.254"></a><span id="l78.254">       char *s = (char *)PR_MALLOC(length + MSG_LINEBREAK_LEN + 1);</span>
<a href="#l78.255"></a><span id="l78.255">       if (!s) return MIME_OUT_OF_MEMORY;</span>
<a href="#l78.256"></a><span id="l78.256">       memcpy(s, line, length);</span>
<a href="#l78.257"></a><span id="l78.257">       PL_strncpyz(s + length, MSG_LINEBREAK, MSG_LINEBREAK_LEN + 1);</span>
<a href="#l78.258"></a><span id="l78.258" class="difflineminus">-      status = kid-&gt;clazz-&gt;parse_buffer (s, length + MSG_LINEBREAK_LEN, kid);</span>
<a href="#l78.259"></a><span id="l78.259" class="difflineplus">+      status = kid-&gt;clazz-&gt;parse_buffer(s, length + MSG_LINEBREAK_LEN, kid);</span>
<a href="#l78.260"></a><span id="l78.260">       PR_Free(s);</span>
<a href="#l78.261"></a><span id="l78.261">       return status;</span>
<a href="#l78.262"></a><span id="l78.262">     }</span>
<a href="#l78.263"></a><span id="l78.263">   }</span>
<a href="#l78.264"></a><span id="l78.264"> </span>
<a href="#l78.265"></a><span id="l78.265">   /* Otherwise we don't yet have a child object, which means we're not</span>
<a href="#l78.266"></a><span id="l78.266">    done parsing our headers yet.</span>
<a href="#l78.267"></a><span id="l78.267">    */</span>
<a href="#l78.268"></a><span id="l78.268" class="difflineminus">-  if (!msg-&gt;hdrs)</span>
<a href="#l78.269"></a><span id="l78.269" class="difflineminus">-  {</span>
<a href="#l78.270"></a><span id="l78.270" class="difflineplus">+  if (!msg-&gt;hdrs) {</span>
<a href="#l78.271"></a><span id="l78.271">     msg-&gt;hdrs = MimeHeaders_new();</span>
<a href="#l78.272"></a><span id="l78.272">     if (!msg-&gt;hdrs) return MIME_OUT_OF_MEMORY;</span>
<a href="#l78.273"></a><span id="l78.273">   }</span>
<a href="#l78.274"></a><span id="l78.274"> </span>
<a href="#l78.275"></a><span id="l78.275"> #ifdef MIME_DRAFTS</span>
<a href="#l78.276"></a><span id="l78.276" class="difflineminus">-  if ( obj-&gt;options &amp;&amp;</span>
<a href="#l78.277"></a><span id="l78.277" class="difflineminus">-       obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l78.278"></a><span id="l78.278" class="difflineminus">-       ! obj-&gt;options-&gt;is_multipart_msg &amp;&amp;</span>
<a href="#l78.279"></a><span id="l78.279" class="difflineminus">-       obj-&gt;options-&gt;done_parsing_outer_headers &amp;&amp;</span>
<a href="#l78.280"></a><span id="l78.280" class="difflineminus">-       obj-&gt;options-&gt;decompose_file_output_fn )</span>
<a href="#l78.281"></a><span id="l78.281" class="difflineminus">-  {</span>
<a href="#l78.282"></a><span id="l78.282" class="difflineminus">-    status =  obj-&gt;options-&gt;decompose_file_output_fn( line, length,</span>
<a href="#l78.283"></a><span id="l78.283" class="difflineminus">-                                                      obj-&gt;options-&gt;stream_closure );</span>
<a href="#l78.284"></a><span id="l78.284" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l78.285"></a><span id="l78.285" class="difflineminus">-      return status;</span>
<a href="#l78.286"></a><span id="l78.286" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l78.287"></a><span id="l78.287" class="difflineplus">+      !obj-&gt;options-&gt;is_multipart_msg &amp;&amp;</span>
<a href="#l78.288"></a><span id="l78.288" class="difflineplus">+      obj-&gt;options-&gt;done_parsing_outer_headers &amp;&amp;</span>
<a href="#l78.289"></a><span id="l78.289" class="difflineplus">+      obj-&gt;options-&gt;decompose_file_output_fn) {</span>
<a href="#l78.290"></a><span id="l78.290" class="difflineplus">+    status = obj-&gt;options-&gt;decompose_file_output_fn(</span>
<a href="#l78.291"></a><span id="l78.291" class="difflineplus">+        line, length, obj-&gt;options-&gt;stream_closure);</span>
<a href="#l78.292"></a><span id="l78.292" class="difflineplus">+    if (status &lt; 0) return status;</span>
<a href="#l78.293"></a><span id="l78.293">   }</span>
<a href="#l78.294"></a><span id="l78.294"> #endif /* MIME_DRAFTS */</span>
<a href="#l78.295"></a><span id="l78.295"> </span>
<a href="#l78.296"></a><span id="l78.296">   status = MimeHeaders_parse_line(line, length, msg-&gt;hdrs);</span>
<a href="#l78.297"></a><span id="l78.297">   if (status &lt; 0) return status;</span>
<a href="#l78.298"></a><span id="l78.298"> </span>
<a href="#l78.299"></a><span id="l78.299">   /* If this line is blank, we're now done parsing headers, and should</span>
<a href="#l78.300"></a><span id="l78.300">    examine our content-type to create our &quot;body&quot; part.</span>
<a href="#l78.301"></a><span id="l78.301">    */</span>
<a href="#l78.302"></a><span id="l78.302" class="difflineminus">-  if (*line == '\r' || *line == '\n')</span>
<a href="#l78.303"></a><span id="l78.303" class="difflineminus">-  {</span>
<a href="#l78.304"></a><span id="l78.304" class="difflineplus">+  if (*line == '\r' || *line == '\n') {</span>
<a href="#l78.305"></a><span id="l78.305">     status = MimeMessage_close_headers(obj);</span>
<a href="#l78.306"></a><span id="l78.306">     if (status &lt; 0) return status;</span>
<a href="#l78.307"></a><span id="l78.307">   }</span>
<a href="#l78.308"></a><span id="l78.308"> </span>
<a href="#l78.309"></a><span id="l78.309">   return 0;</span>
<a href="#l78.310"></a><span id="l78.310"> }</span>
<a href="#l78.311"></a><span id="l78.311"> </span>
<a href="#l78.312"></a><span id="l78.312" class="difflineminus">-static int</span>
<a href="#l78.313"></a><span id="l78.313" class="difflineminus">-MimeMessage_close_headers (MimeObject *obj)</span>
<a href="#l78.314"></a><span id="l78.314" class="difflineminus">-{</span>
<a href="#l78.315"></a><span id="l78.315" class="difflineminus">-  MimeMessage *msg = (MimeMessage *) obj;</span>
<a href="#l78.316"></a><span id="l78.316" class="difflineplus">+static int MimeMessage_close_headers(MimeObject *obj) {</span>
<a href="#l78.317"></a><span id="l78.317" class="difflineplus">+  MimeMessage *msg = (MimeMessage *)obj;</span>
<a href="#l78.318"></a><span id="l78.318">   int status = 0;</span>
<a href="#l78.319"></a><span id="l78.319" class="difflineminus">-  char *ct = 0;      /* Content-Type header */</span>
<a href="#l78.320"></a><span id="l78.320" class="difflineplus">+  char *ct = 0; /* Content-Type header */</span>
<a href="#l78.321"></a><span id="l78.321">   MimeObject *body;</span>
<a href="#l78.322"></a><span id="l78.322"> </span>
<a href="#l78.323"></a><span id="l78.323">   // Do a proper decoding of the munged subject.</span>
<a href="#l78.324"></a><span id="l78.324" class="difflineminus">-  if (obj-&gt;headers &amp;&amp; msg-&gt;hdrs &amp;&amp; msg-&gt;grabSubject &amp;&amp; obj-&gt;headers-&gt;munged_subject) {</span>
<a href="#l78.325"></a><span id="l78.325" class="difflineplus">+  if (obj-&gt;headers &amp;&amp; msg-&gt;hdrs &amp;&amp; msg-&gt;grabSubject &amp;&amp;</span>
<a href="#l78.326"></a><span id="l78.326" class="difflineplus">+      obj-&gt;headers-&gt;munged_subject) {</span>
<a href="#l78.327"></a><span id="l78.327">     // nsMsgI18NConvertToUnicode wants nsAStrings...</span>
<a href="#l78.328"></a><span id="l78.328">     nsDependentCString orig(obj-&gt;headers-&gt;munged_subject);</span>
<a href="#l78.329"></a><span id="l78.329">     nsAutoString dest;</span>
<a href="#l78.330"></a><span id="l78.330">     // First, get the Content-Type, then extract the charset=&quot;whatever&quot; part of</span>
<a href="#l78.331"></a><span id="l78.331">     // it.</span>
<a href="#l78.332"></a><span id="l78.332">     nsCString charset;</span>
<a href="#l78.333"></a><span id="l78.333">     nsCString contentType;</span>
<a href="#l78.334"></a><span id="l78.334" class="difflineminus">-    contentType.Adopt(MimeHeaders_get(msg-&gt;hdrs, HEADER_CONTENT_TYPE, false, false));</span>
<a href="#l78.335"></a><span id="l78.335" class="difflineplus">+    contentType.Adopt(</span>
<a href="#l78.336"></a><span id="l78.336" class="difflineplus">+        MimeHeaders_get(msg-&gt;hdrs, HEADER_CONTENT_TYPE, false, false));</span>
<a href="#l78.337"></a><span id="l78.337">     if (!contentType.IsEmpty())</span>
<a href="#l78.338"></a><span id="l78.338" class="difflineminus">-      charset.Adopt(MimeHeaders_get_parameter(contentType.get(), &quot;charset&quot;, nullptr, nullptr));</span>
<a href="#l78.339"></a><span id="l78.339" class="difflineplus">+      charset.Adopt(MimeHeaders_get_parameter(contentType.get(), &quot;charset&quot;,</span>
<a href="#l78.340"></a><span id="l78.340" class="difflineplus">+                                              nullptr, nullptr));</span>
<a href="#l78.341"></a><span id="l78.341"> </span>
<a href="#l78.342"></a><span id="l78.342">     // If we've got a charset, use nsMsgI18NConvertToUnicode to magically decode</span>
<a href="#l78.343"></a><span id="l78.343">     // the munged subject.</span>
<a href="#l78.344"></a><span id="l78.344">     if (!charset.IsEmpty()) {</span>
<a href="#l78.345"></a><span id="l78.345">       nsresult rv = nsMsgI18NConvertToUnicode(charset, orig, dest);</span>
<a href="#l78.346"></a><span id="l78.346">       // If we managed to convert the string, replace munged_subject with the</span>
<a href="#l78.347"></a><span id="l78.347">       // UTF8 version of it, otherwise, just forget about it (maybe there was an</span>
<a href="#l78.348"></a><span id="l78.348">       // improperly encoded string in there).</span>
<a href="#l78.349"></a><span id="l78.349" class="difflineat">@@ -294,527 +258,453 @@ MimeMessage_close_headers (MimeObject *o</span>
<a href="#l78.350"></a><span id="l78.350">       else</span>
<a href="#l78.351"></a><span id="l78.351">         obj-&gt;headers-&gt;munged_subject = nullptr;</span>
<a href="#l78.352"></a><span id="l78.352">     } else {</span>
<a href="#l78.353"></a><span id="l78.353">       PR_Free(obj-&gt;headers-&gt;munged_subject);</span>
<a href="#l78.354"></a><span id="l78.354">       obj-&gt;headers-&gt;munged_subject = nullptr;</span>
<a href="#l78.355"></a><span id="l78.355">     }</span>
<a href="#l78.356"></a><span id="l78.356">   }</span>
<a href="#l78.357"></a><span id="l78.357"> </span>
<a href="#l78.358"></a><span id="l78.358" class="difflineminus">-  if (msg-&gt;hdrs)</span>
<a href="#l78.359"></a><span id="l78.359" class="difflineminus">-  {</span>
<a href="#l78.360"></a><span id="l78.360" class="difflineplus">+  if (msg-&gt;hdrs) {</span>
<a href="#l78.361"></a><span id="l78.361">     bool outer_p = !obj-&gt;headers; /* is this the outermost message? */</span>
<a href="#l78.362"></a><span id="l78.362"> </span>
<a href="#l78.363"></a><span id="l78.363" class="difflineminus">-</span>
<a href="#l78.364"></a><span id="l78.364"> #ifdef MIME_DRAFTS</span>
<a href="#l78.365"></a><span id="l78.365" class="difflineminus">-    if (outer_p &amp;&amp;</span>
<a href="#l78.366"></a><span id="l78.366" class="difflineminus">-      obj-&gt;options &amp;&amp;</span>
<a href="#l78.367"></a><span id="l78.367" class="difflineminus">-          (obj-&gt;options-&gt;decompose_file_p || obj-&gt;options-&gt;caller_need_root_headers) &amp;&amp;</span>
<a href="#l78.368"></a><span id="l78.368" class="difflineminus">-      obj-&gt;options-&gt;decompose_headers_info_fn)</span>
<a href="#l78.369"></a><span id="l78.369" class="difflineminus">-    {</span>
<a href="#l78.370"></a><span id="l78.370" class="difflineminus">-#ifdef ENABLE_SMIME</span>
<a href="#l78.371"></a><span id="l78.371" class="difflineminus">-      if (obj-&gt;options-&gt;decrypt_p &amp;&amp; !mime_crypto_object_p(msg-&gt;hdrs, false, obj-&gt;options))</span>
<a href="#l78.372"></a><span id="l78.372" class="difflineplus">+    if (outer_p &amp;&amp; obj-&gt;options &amp;&amp;</span>
<a href="#l78.373"></a><span id="l78.373" class="difflineplus">+        (obj-&gt;options-&gt;decompose_file_p ||</span>
<a href="#l78.374"></a><span id="l78.374" class="difflineplus">+         obj-&gt;options-&gt;caller_need_root_headers) &amp;&amp;</span>
<a href="#l78.375"></a><span id="l78.375" class="difflineplus">+        obj-&gt;options-&gt;decompose_headers_info_fn) {</span>
<a href="#l78.376"></a><span id="l78.376" class="difflineplus">+#  ifdef ENABLE_SMIME</span>
<a href="#l78.377"></a><span id="l78.377" class="difflineplus">+      if (obj-&gt;options-&gt;decrypt_p &amp;&amp;</span>
<a href="#l78.378"></a><span id="l78.378" class="difflineplus">+          !mime_crypto_object_p(msg-&gt;hdrs, false, obj-&gt;options))</span>
<a href="#l78.379"></a><span id="l78.379">         obj-&gt;options-&gt;decrypt_p = false;</span>
<a href="#l78.380"></a><span id="l78.380" class="difflineminus">-#endif /* ENABLE_SMIME */</span>
<a href="#l78.381"></a><span id="l78.381" class="difflineminus">-      if (!obj-&gt;options-&gt;caller_need_root_headers || (obj == obj-&gt;options-&gt;state-&gt;root))</span>
<a href="#l78.382"></a><span id="l78.382" class="difflineminus">-        status = obj-&gt;options-&gt;decompose_headers_info_fn (</span>
<a href="#l78.383"></a><span id="l78.383" class="difflineminus">-                         obj-&gt;options-&gt;stream_closure,</span>
<a href="#l78.384"></a><span id="l78.384" class="difflineminus">-                               msg-&gt;hdrs );</span>
<a href="#l78.385"></a><span id="l78.385" class="difflineplus">+#  endif /* ENABLE_SMIME */</span>
<a href="#l78.386"></a><span id="l78.386" class="difflineplus">+      if (!obj-&gt;options-&gt;caller_need_root_headers ||</span>
<a href="#l78.387"></a><span id="l78.387" class="difflineplus">+          (obj == obj-&gt;options-&gt;state-&gt;root))</span>
<a href="#l78.388"></a><span id="l78.388" class="difflineplus">+        status = obj-&gt;options-&gt;decompose_headers_info_fn(</span>
<a href="#l78.389"></a><span id="l78.389" class="difflineplus">+            obj-&gt;options-&gt;stream_closure, msg-&gt;hdrs);</span>
<a href="#l78.390"></a><span id="l78.390">     }</span>
<a href="#l78.391"></a><span id="l78.391"> #endif /* MIME_DRAFTS */</span>
<a href="#l78.392"></a><span id="l78.392"> </span>
<a href="#l78.393"></a><span id="l78.393" class="difflineminus">-</span>
<a href="#l78.394"></a><span id="l78.394">     /* If this is the outermost message, we need to run the</span>
<a href="#l78.395"></a><span id="l78.395">      `generate_header' callback.  This happens here instead of</span>
<a href="#l78.396"></a><span id="l78.396">      in `parse_begin', because it's only now that we've parsed</span>
<a href="#l78.397"></a><span id="l78.397">      our headers.  However, since this is the outermost message,</span>
<a href="#l78.398"></a><span id="l78.398">      we have yet to write any HTML, so that's fine.</span>
<a href="#l78.399"></a><span id="l78.399">      */</span>
<a href="#l78.400"></a><span id="l78.400" class="difflineminus">-    if (outer_p &amp;&amp;</span>
<a href="#l78.401"></a><span id="l78.401" class="difflineminus">-      obj-&gt;output_p &amp;&amp;</span>
<a href="#l78.402"></a><span id="l78.402" class="difflineminus">-      obj-&gt;options &amp;&amp;</span>
<a href="#l78.403"></a><span id="l78.403" class="difflineminus">-      obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l78.404"></a><span id="l78.404" class="difflineminus">-      obj-&gt;options-&gt;generate_header_html_fn)</span>
<a href="#l78.405"></a><span id="l78.405" class="difflineminus">-    {</span>
<a href="#l78.406"></a><span id="l78.406" class="difflineplus">+    if (outer_p &amp;&amp; obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp;</span>
<a href="#l78.407"></a><span id="l78.407" class="difflineplus">+        obj-&gt;options-&gt;write_html_p &amp;&amp; obj-&gt;options-&gt;generate_header_html_fn) {</span>
<a href="#l78.408"></a><span id="l78.408">       int lstatus = 0;</span>
<a href="#l78.409"></a><span id="l78.409">       char *html = 0;</span>
<a href="#l78.410"></a><span id="l78.410"> </span>
<a href="#l78.411"></a><span id="l78.411">       /* The generate_header_html_fn might return HTML, so it's important</span>
<a href="#l78.412"></a><span id="l78.412">        that the output stream be set up with the proper type before we</span>
<a href="#l78.413"></a><span id="l78.413">        make the MimeObject_write() call below. */</span>
<a href="#l78.414"></a><span id="l78.414" class="difflineminus">-      if (!obj-&gt;options-&gt;state-&gt;first_data_written_p)</span>
<a href="#l78.415"></a><span id="l78.415" class="difflineminus">-      {</span>
<a href="#l78.416"></a><span id="l78.416" class="difflineminus">-        lstatus = MimeObject_output_init (obj, TEXT_HTML);</span>
<a href="#l78.417"></a><span id="l78.417" class="difflineplus">+      if (!obj-&gt;options-&gt;state-&gt;first_data_written_p) {</span>
<a href="#l78.418"></a><span id="l78.418" class="difflineplus">+        lstatus = MimeObject_output_init(obj, TEXT_HTML);</span>
<a href="#l78.419"></a><span id="l78.419">         if (lstatus &lt; 0) return lstatus;</span>
<a href="#l78.420"></a><span id="l78.420">         PR_ASSERT(obj-&gt;options-&gt;state-&gt;first_data_written_p);</span>
<a href="#l78.421"></a><span id="l78.421">       }</span>
<a href="#l78.422"></a><span id="l78.422"> </span>
<a href="#l78.423"></a><span id="l78.423" class="difflineminus">-      html = obj-&gt;options-&gt;generate_header_html_fn(NULL,</span>
<a href="#l78.424"></a><span id="l78.424" class="difflineminus">-                           obj-&gt;options-&gt;html_closure,</span>
<a href="#l78.425"></a><span id="l78.425" class="difflineminus">-                             msg-&gt;hdrs);</span>
<a href="#l78.426"></a><span id="l78.426" class="difflineminus">-      if (html)</span>
<a href="#l78.427"></a><span id="l78.427" class="difflineminus">-      {</span>
<a href="#l78.428"></a><span id="l78.428" class="difflineplus">+      html = obj-&gt;options-&gt;generate_header_html_fn(</span>
<a href="#l78.429"></a><span id="l78.429" class="difflineplus">+          NULL, obj-&gt;options-&gt;html_closure, msg-&gt;hdrs);</span>
<a href="#l78.430"></a><span id="l78.430" class="difflineplus">+      if (html) {</span>
<a href="#l78.431"></a><span id="l78.431">         lstatus = MimeObject_write(obj, html, strlen(html), false);</span>
<a href="#l78.432"></a><span id="l78.432">         PR_Free(html);</span>
<a href="#l78.433"></a><span id="l78.433">         if (lstatus &lt; 0) return lstatus;</span>
<a href="#l78.434"></a><span id="l78.434">       }</span>
<a href="#l78.435"></a><span id="l78.435">     }</span>
<a href="#l78.436"></a><span id="l78.436"> </span>
<a href="#l78.437"></a><span id="l78.437" class="difflineminus">-</span>
<a href="#l78.438"></a><span id="l78.438">     /* Find the content-type of the body of this message.</span>
<a href="#l78.439"></a><span id="l78.439">      */</span>
<a href="#l78.440"></a><span id="l78.440">     {</span>
<a href="#l78.441"></a><span id="l78.441" class="difflineminus">-    bool ok = true;</span>
<a href="#l78.442"></a><span id="l78.442" class="difflineminus">-    char *mv = MimeHeaders_get (msg-&gt;hdrs, HEADER_MIME_VERSION,</span>
<a href="#l78.443"></a><span id="l78.443" class="difflineminus">-                  true, false);</span>
<a href="#l78.444"></a><span id="l78.444" class="difflineplus">+      bool ok = true;</span>
<a href="#l78.445"></a><span id="l78.445" class="difflineplus">+      char *mv = MimeHeaders_get(msg-&gt;hdrs, HEADER_MIME_VERSION, true, false);</span>
<a href="#l78.446"></a><span id="l78.446"> </span>
<a href="#l78.447"></a><span id="l78.447"> #ifdef REQUIRE_MIME_VERSION_HEADER</span>
<a href="#l78.448"></a><span id="l78.448" class="difflineminus">-    /* If this is the outermost message, it must have a MIME-Version</span>
<a href="#l78.449"></a><span id="l78.449" class="difflineminus">-       header with the value 1.0 for us to believe what might be in</span>
<a href="#l78.450"></a><span id="l78.450" class="difflineminus">-       the Content-Type header.  If the MIME-Version header is not</span>
<a href="#l78.451"></a><span id="l78.451" class="difflineminus">-       present, we must treat this message as untyped.</span>
<a href="#l78.452"></a><span id="l78.452" class="difflineminus">-     */</span>
<a href="#l78.453"></a><span id="l78.453" class="difflineminus">-    ok = (mv &amp;&amp; !strcmp(mv, &quot;1.0&quot;));</span>
<a href="#l78.454"></a><span id="l78.454" class="difflineplus">+      /* If this is the outermost message, it must have a MIME-Version</span>
<a href="#l78.455"></a><span id="l78.455" class="difflineplus">+         header with the value 1.0 for us to believe what might be in</span>
<a href="#l78.456"></a><span id="l78.456" class="difflineplus">+         the Content-Type header.  If the MIME-Version header is not</span>
<a href="#l78.457"></a><span id="l78.457" class="difflineplus">+         present, we must treat this message as untyped.</span>
<a href="#l78.458"></a><span id="l78.458" class="difflineplus">+       */</span>
<a href="#l78.459"></a><span id="l78.459" class="difflineplus">+      ok = (mv &amp;&amp; !strcmp(mv, &quot;1.0&quot;));</span>
<a href="#l78.460"></a><span id="l78.460"> #else</span>
<a href="#l78.461"></a><span id="l78.461" class="difflineminus">-    /* #### actually, we didn't check this in Mozilla 2.0, and checking</span>
<a href="#l78.462"></a><span id="l78.462" class="difflineminus">-       it now could cause some compatibility nonsense, so for now, let's</span>
<a href="#l78.463"></a><span id="l78.463" class="difflineminus">-       just believe any Content-Type header we see.</span>
<a href="#l78.464"></a><span id="l78.464" class="difflineminus">-     */</span>
<a href="#l78.465"></a><span id="l78.465" class="difflineminus">-    ok = true;</span>
<a href="#l78.466"></a><span id="l78.466" class="difflineplus">+      /* #### actually, we didn't check this in Mozilla 2.0, and checking</span>
<a href="#l78.467"></a><span id="l78.467" class="difflineplus">+         it now could cause some compatibility nonsense, so for now, let's</span>
<a href="#l78.468"></a><span id="l78.468" class="difflineplus">+         just believe any Content-Type header we see.</span>
<a href="#l78.469"></a><span id="l78.469" class="difflineplus">+       */</span>
<a href="#l78.470"></a><span id="l78.470" class="difflineplus">+      ok = true;</span>
<a href="#l78.471"></a><span id="l78.471"> #endif</span>
<a href="#l78.472"></a><span id="l78.472"> </span>
<a href="#l78.473"></a><span id="l78.473" class="difflineminus">-    if (ok)</span>
<a href="#l78.474"></a><span id="l78.474" class="difflineminus">-      {</span>
<a href="#l78.475"></a><span id="l78.475" class="difflineminus">-      ct = MimeHeaders_get (msg-&gt;hdrs, HEADER_CONTENT_TYPE, true, false);</span>
<a href="#l78.476"></a><span id="l78.476" class="difflineplus">+      if (ok) {</span>
<a href="#l78.477"></a><span id="l78.477" class="difflineplus">+        ct = MimeHeaders_get(msg-&gt;hdrs, HEADER_CONTENT_TYPE, true, false);</span>
<a href="#l78.478"></a><span id="l78.478"> </span>
<a href="#l78.479"></a><span id="l78.479" class="difflineminus">-      /* If there is no Content-Type header, but there is a MIME-Version</span>
<a href="#l78.480"></a><span id="l78.480" class="difflineminus">-         header, then assume that this *is* in fact a MIME message.</span>
<a href="#l78.481"></a><span id="l78.481" class="difflineminus">-         (I've seen messages with</span>
<a href="#l78.482"></a><span id="l78.482" class="difflineplus">+        /* If there is no Content-Type header, but there is a MIME-Version</span>
<a href="#l78.483"></a><span id="l78.483" class="difflineplus">+           header, then assume that this *is* in fact a MIME message.</span>
<a href="#l78.484"></a><span id="l78.484" class="difflineplus">+           (I've seen messages with</span>
<a href="#l78.485"></a><span id="l78.485"> </span>
<a href="#l78.486"></a><span id="l78.486" class="difflineminus">-          MIME-Version: 1.0</span>
<a href="#l78.487"></a><span id="l78.487" class="difflineminus">-          Content-Transfer-Encoding: quoted-printable</span>
<a href="#l78.488"></a><span id="l78.488" class="difflineplus">+            MIME-Version: 1.0</span>
<a href="#l78.489"></a><span id="l78.489" class="difflineplus">+            Content-Transfer-Encoding: quoted-printable</span>
<a href="#l78.490"></a><span id="l78.490"> </span>
<a href="#l78.491"></a><span id="l78.491" class="difflineminus">-         and no Content-Type, and we should treat those as being of type</span>
<a href="#l78.492"></a><span id="l78.492" class="difflineminus">-         MimeInlineTextPlain rather than MimeUntypedText.)</span>
<a href="#l78.493"></a><span id="l78.493" class="difflineminus">-       */</span>
<a href="#l78.494"></a><span id="l78.494" class="difflineminus">-      if (mv &amp;&amp; !ct)</span>
<a href="#l78.495"></a><span id="l78.495" class="difflineminus">-        ct = strdup(TEXT_PLAIN);</span>
<a href="#l78.496"></a><span id="l78.496" class="difflineplus">+           and no Content-Type, and we should treat those as being of type</span>
<a href="#l78.497"></a><span id="l78.497" class="difflineplus">+           MimeInlineTextPlain rather than MimeUntypedText.)</span>
<a href="#l78.498"></a><span id="l78.498" class="difflineplus">+         */</span>
<a href="#l78.499"></a><span id="l78.499" class="difflineplus">+        if (mv &amp;&amp; !ct) ct = strdup(TEXT_PLAIN);</span>
<a href="#l78.500"></a><span id="l78.500">       }</span>
<a href="#l78.501"></a><span id="l78.501"> </span>
<a href="#l78.502"></a><span id="l78.502" class="difflineminus">-    PR_FREEIF(mv);  /* done with this now. */</span>
<a href="#l78.503"></a><span id="l78.503" class="difflineplus">+      PR_FREEIF(mv); /* done with this now. */</span>
<a href="#l78.504"></a><span id="l78.504">     }</span>
<a href="#l78.505"></a><span id="l78.505"> </span>
<a href="#l78.506"></a><span id="l78.506">     /* If this message has a body which is encrypted and we're going to</span>
<a href="#l78.507"></a><span id="l78.507">        decrypt it (without converting it to HTML, since decrypt_p and</span>
<a href="#l78.508"></a><span id="l78.508">        write_html_p are never true at the same time)</span>
<a href="#l78.509"></a><span id="l78.509">     */</span>
<a href="#l78.510"></a><span id="l78.510" class="difflineminus">-    if (obj-&gt;output_p &amp;&amp;</span>
<a href="#l78.511"></a><span id="l78.511" class="difflineminus">-        obj-&gt;options &amp;&amp;</span>
<a href="#l78.512"></a><span id="l78.512" class="difflineminus">-        obj-&gt;options-&gt;decrypt_p</span>
<a href="#l78.513"></a><span id="l78.513" class="difflineplus">+    if (obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decrypt_p</span>
<a href="#l78.514"></a><span id="l78.514"> #ifdef ENABLE_SMIME</span>
<a href="#l78.515"></a><span id="l78.515">         &amp;&amp; !mime_crypto_object_p(msg-&gt;hdrs, false, obj-&gt;options)</span>
<a href="#l78.516"></a><span id="l78.516"> #endif /* ENABLE_SMIME */</span>
<a href="#l78.517"></a><span id="l78.517" class="difflineminus">-        )</span>
<a href="#l78.518"></a><span id="l78.518" class="difflineminus">-    {</span>
<a href="#l78.519"></a><span id="l78.519" class="difflineplus">+    ) {</span>
<a href="#l78.520"></a><span id="l78.520">       /* The body of this message is not an encrypted object, so we need</span>
<a href="#l78.521"></a><span id="l78.521">          to turn off the decrypt_p flag (to prevent us from s#$%ing the</span>
<a href="#l78.522"></a><span id="l78.522">          body of the internal object up into one.) In this case,</span>
<a href="#l78.523"></a><span id="l78.523">          our output will end up being identical to our input.</span>
<a href="#l78.524"></a><span id="l78.524">       */</span>
<a href="#l78.525"></a><span id="l78.525">       obj-&gt;options-&gt;decrypt_p = false;</span>
<a href="#l78.526"></a><span id="l78.526">     }</span>
<a href="#l78.527"></a><span id="l78.527"> </span>
<a href="#l78.528"></a><span id="l78.528">     /* Emit the HTML for this message's headers.  Do this before</span>
<a href="#l78.529"></a><span id="l78.529">      creating the object representing the body.</span>
<a href="#l78.530"></a><span id="l78.530">      */</span>
<a href="#l78.531"></a><span id="l78.531" class="difflineminus">-    if (obj-&gt;output_p &amp;&amp;</span>
<a href="#l78.532"></a><span id="l78.532" class="difflineminus">-      obj-&gt;options &amp;&amp;</span>
<a href="#l78.533"></a><span id="l78.533" class="difflineminus">-      obj-&gt;options-&gt;write_html_p)</span>
<a href="#l78.534"></a><span id="l78.534" class="difflineminus">-    {</span>
<a href="#l78.535"></a><span id="l78.535" class="difflineplus">+    if (obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; obj-&gt;options-&gt;write_html_p) {</span>
<a href="#l78.536"></a><span id="l78.536">       /* If citation headers are on, and this is not the outermost message,</span>
<a href="#l78.537"></a><span id="l78.537">        turn them off. */</span>
<a href="#l78.538"></a><span id="l78.538">       if (obj-&gt;options-&gt;headers == MimeHeadersCitation &amp;&amp; !outer_p)</span>
<a href="#l78.539"></a><span id="l78.539" class="difflineminus">-      obj-&gt;options-&gt;headers = MimeHeadersSome;</span>
<a href="#l78.540"></a><span id="l78.540" class="difflineplus">+        obj-&gt;options-&gt;headers = MimeHeadersSome;</span>
<a href="#l78.541"></a><span id="l78.541"> </span>
<a href="#l78.542"></a><span id="l78.542">       /* Emit a normal header block. */</span>
<a href="#l78.543"></a><span id="l78.543">       status = MimeMessage_write_headers_html(obj);</span>
<a href="#l78.544"></a><span id="l78.544" class="difflineminus">-      if (status &lt; 0)</span>
<a href="#l78.545"></a><span id="l78.545" class="difflineminus">-      {</span>
<a href="#l78.546"></a><span id="l78.546" class="difflineplus">+      if (status &lt; 0) {</span>
<a href="#l78.547"></a><span id="l78.547">         PR_FREEIF(ct);</span>
<a href="#l78.548"></a><span id="l78.548">         return status;</span>
<a href="#l78.549"></a><span id="l78.549">       }</span>
<a href="#l78.550"></a><span id="l78.550" class="difflineminus">-    }</span>
<a href="#l78.551"></a><span id="l78.551" class="difflineminus">-    else if (obj-&gt;output_p)</span>
<a href="#l78.552"></a><span id="l78.552" class="difflineminus">-    {</span>
<a href="#l78.553"></a><span id="l78.553" class="difflineplus">+    } else if (obj-&gt;output_p) {</span>
<a href="#l78.554"></a><span id="l78.554">       /* Dump the headers, raw. */</span>
<a href="#l78.555"></a><span id="l78.555" class="difflineminus">-      status = MimeObject_write(obj, &quot;&quot;, 0, false);  /* initialize */</span>
<a href="#l78.556"></a><span id="l78.556" class="difflineminus">-      if (status &lt; 0)</span>
<a href="#l78.557"></a><span id="l78.557" class="difflineminus">-      {</span>
<a href="#l78.558"></a><span id="l78.558" class="difflineplus">+      status = MimeObject_write(obj, &quot;&quot;, 0, false); /* initialize */</span>
<a href="#l78.559"></a><span id="l78.559" class="difflineplus">+      if (status &lt; 0) {</span>
<a href="#l78.560"></a><span id="l78.560">         PR_FREEIF(ct);</span>
<a href="#l78.561"></a><span id="l78.561">         return status;</span>
<a href="#l78.562"></a><span id="l78.562">       }</span>
<a href="#l78.563"></a><span id="l78.563">       status = MimeHeaders_write_raw_headers(msg-&gt;hdrs, obj-&gt;options,</span>
<a href="#l78.564"></a><span id="l78.564" class="difflineminus">-                         obj-&gt;options-&gt;decrypt_p);</span>
<a href="#l78.565"></a><span id="l78.565" class="difflineminus">-      if (status &lt; 0)</span>
<a href="#l78.566"></a><span id="l78.566" class="difflineminus">-      {</span>
<a href="#l78.567"></a><span id="l78.567" class="difflineplus">+                                             obj-&gt;options-&gt;decrypt_p);</span>
<a href="#l78.568"></a><span id="l78.568" class="difflineplus">+      if (status &lt; 0) {</span>
<a href="#l78.569"></a><span id="l78.569">         PR_FREEIF(ct);</span>
<a href="#l78.570"></a><span id="l78.570">         return status;</span>
<a href="#l78.571"></a><span id="l78.571">       }</span>
<a href="#l78.572"></a><span id="l78.572">     }</span>
<a href="#l78.573"></a><span id="l78.573"> </span>
<a href="#l78.574"></a><span id="l78.574"> #ifdef XP_UNIX</span>
<a href="#l78.575"></a><span id="l78.575" class="difflineminus">-    if (outer_p &amp;&amp; obj-&gt;output_p)</span>
<a href="#l78.576"></a><span id="l78.576" class="difflineminus">-    /* Kludge from mimehdrs.c */</span>
<a href="#l78.577"></a><span id="l78.577" class="difflineminus">-    MimeHeaders_do_unix_display_hook_hack(msg-&gt;hdrs);</span>
<a href="#l78.578"></a><span id="l78.578" class="difflineplus">+    if (outer_p &amp;&amp; obj-&gt;output_p) /* Kludge from mimehdrs.c */</span>
<a href="#l78.579"></a><span id="l78.579" class="difflineplus">+      MimeHeaders_do_unix_display_hook_hack(msg-&gt;hdrs);</span>
<a href="#l78.580"></a><span id="l78.580"> #endif /* XP_UNIX */</span>
<a href="#l78.581"></a><span id="l78.581">   }</span>
<a href="#l78.582"></a><span id="l78.582"> </span>
<a href="#l78.583"></a><span id="l78.583">   /* Never put out a separator after a message header block. */</span>
<a href="#l78.584"></a><span id="l78.584">   if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state)</span>
<a href="#l78.585"></a><span id="l78.585" class="difflineminus">-  obj-&gt;options-&gt;state-&gt;separator_suppressed_p = true;</span>
<a href="#l78.586"></a><span id="l78.586" class="difflineplus">+    obj-&gt;options-&gt;state-&gt;separator_suppressed_p = true;</span>
<a href="#l78.587"></a><span id="l78.587"> </span>
<a href="#l78.588"></a><span id="l78.588"> #ifdef MIME_DRAFTS</span>
<a href="#l78.589"></a><span id="l78.589" class="difflineminus">-  if ( !obj-&gt;headers &amp;&amp;    /* outer most message header */</span>
<a href="#l78.590"></a><span id="l78.590" class="difflineminus">-     obj-&gt;options &amp;&amp;</span>
<a href="#l78.591"></a><span id="l78.591" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l78.592"></a><span id="l78.592" class="difflineminus">-     ct )</span>
<a href="#l78.593"></a><span id="l78.593" class="difflineminus">-  obj-&gt;options-&gt;is_multipart_msg = PL_strcasestr(ct, &quot;multipart/&quot;) != NULL;</span>
<a href="#l78.594"></a><span id="l78.594" class="difflineplus">+  if (!obj-&gt;headers &amp;&amp; /* outer most message header */</span>
<a href="#l78.595"></a><span id="l78.595" class="difflineplus">+      obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decompose_file_p &amp;&amp; ct)</span>
<a href="#l78.596"></a><span id="l78.596" class="difflineplus">+    obj-&gt;options-&gt;is_multipart_msg = PL_strcasestr(ct, &quot;multipart/&quot;) != NULL;</span>
<a href="#l78.597"></a><span id="l78.597"> #endif /* MIME_DRAFTS */</span>
<a href="#l78.598"></a><span id="l78.598"> </span>
<a href="#l78.599"></a><span id="l78.599" class="difflineminus">-</span>
<a href="#l78.600"></a><span id="l78.600">   body = mime_create(ct, msg-&gt;hdrs, obj-&gt;options);</span>
<a href="#l78.601"></a><span id="l78.601"> </span>
<a href="#l78.602"></a><span id="l78.602">   PR_FREEIF(ct);</span>
<a href="#l78.603"></a><span id="l78.603">   if (!body) return MIME_OUT_OF_MEMORY;</span>
<a href="#l78.604"></a><span id="l78.604" class="difflineminus">-  status = ((MimeContainerClass *) obj-&gt;clazz)-&gt;add_child (obj, body);</span>
<a href="#l78.605"></a><span id="l78.605" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l78.606"></a><span id="l78.606" class="difflineminus">-  {</span>
<a href="#l78.607"></a><span id="l78.607" class="difflineplus">+  status = ((MimeContainerClass *)obj-&gt;clazz)-&gt;add_child(obj, body);</span>
<a href="#l78.608"></a><span id="l78.608" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l78.609"></a><span id="l78.609">     mime_free(body);</span>
<a href="#l78.610"></a><span id="l78.610">     return status;</span>
<a href="#l78.611"></a><span id="l78.611">   }</span>
<a href="#l78.612"></a><span id="l78.612"> </span>
<a href="#l78.613"></a><span id="l78.613">   // Only do this if this is a Text Object!</span>
<a href="#l78.614"></a><span id="l78.614" class="difflineminus">-  if ( mime_typep(body, (MimeObjectClass *) &amp;mimeInlineTextClass) )</span>
<a href="#l78.615"></a><span id="l78.615" class="difflineminus">-  {</span>
<a href="#l78.616"></a><span id="l78.616" class="difflineminus">-    ((MimeInlineText *) body)-&gt;needUpdateMsgWinCharset = true;</span>
<a href="#l78.617"></a><span id="l78.617" class="difflineplus">+  if (mime_typep(body, (MimeObjectClass *)&amp;mimeInlineTextClass)) {</span>
<a href="#l78.618"></a><span id="l78.618" class="difflineplus">+    ((MimeInlineText *)body)-&gt;needUpdateMsgWinCharset = true;</span>
<a href="#l78.619"></a><span id="l78.619">   }</span>
<a href="#l78.620"></a><span id="l78.620"> </span>
<a href="#l78.621"></a><span id="l78.621">   /* Now that we've added this new object to our list of children,</span>
<a href="#l78.622"></a><span id="l78.622">    start its parser going. */</span>
<a href="#l78.623"></a><span id="l78.623">   status = body-&gt;clazz-&gt;parse_begin(body);</span>
<a href="#l78.624"></a><span id="l78.624">   if (status &lt; 0) return status;</span>
<a href="#l78.625"></a><span id="l78.625"> </span>
<a href="#l78.626"></a><span id="l78.626">   // Now notify the emitter if this is the outer most message, unless</span>
<a href="#l78.627"></a><span id="l78.627">   // it is a part that is not the head of the message. If it's a part,</span>
<a href="#l78.628"></a><span id="l78.628">   // we need to figure out the content type/charset of the part</span>
<a href="#l78.629"></a><span id="l78.629">   //</span>
<a href="#l78.630"></a><span id="l78.630" class="difflineminus">-  bool outer_p = !obj-&gt;headers;  /* is this the outermost message? */</span>
<a href="#l78.631"></a><span id="l78.631" class="difflineplus">+  bool outer_p = !obj-&gt;headers; /* is this the outermost message? */</span>
<a href="#l78.632"></a><span id="l78.632"> </span>
<a href="#l78.633"></a><span id="l78.633" class="difflineminus">-  if ( (outer_p || obj-&gt;options-&gt;notify_nested_bodies) &amp;&amp;</span>
<a href="#l78.634"></a><span id="l78.634" class="difflineminus">-       (!obj-&gt;options-&gt;part_to_load || obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay))</span>
<a href="#l78.635"></a><span id="l78.635" class="difflineminus">-  {</span>
<a href="#l78.636"></a><span id="l78.636" class="difflineplus">+  if ((outer_p || obj-&gt;options-&gt;notify_nested_bodies) &amp;&amp;</span>
<a href="#l78.637"></a><span id="l78.637" class="difflineplus">+      (!obj-&gt;options-&gt;part_to_load ||</span>
<a href="#l78.638"></a><span id="l78.638" class="difflineplus">+       obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay)) {</span>
<a href="#l78.639"></a><span id="l78.639">     // call SetMailCharacterSetToMsgWindow() to set a menu charset</span>
<a href="#l78.640"></a><span id="l78.640" class="difflineminus">-    if (mime_typep(body, (MimeObjectClass *) &amp;mimeInlineTextClass))</span>
<a href="#l78.641"></a><span id="l78.641" class="difflineminus">-    {</span>
<a href="#l78.642"></a><span id="l78.642" class="difflineminus">-      MimeInlineText  *text = (MimeInlineText *) body;</span>
<a href="#l78.643"></a><span id="l78.643" class="difflineplus">+    if (mime_typep(body, (MimeObjectClass *)&amp;mimeInlineTextClass)) {</span>
<a href="#l78.644"></a><span id="l78.644" class="difflineplus">+      MimeInlineText *text = (MimeInlineText *)body;</span>
<a href="#l78.645"></a><span id="l78.645">       if (text &amp;&amp; text-&gt;charset &amp;&amp; *text-&gt;charset)</span>
<a href="#l78.646"></a><span id="l78.646">         SetMailCharacterSetToMsgWindow(body, text-&gt;charset);</span>
<a href="#l78.647"></a><span id="l78.647">     }</span>
<a href="#l78.648"></a><span id="l78.648"> </span>
<a href="#l78.649"></a><span id="l78.649" class="difflineminus">-    char  *msgID = MimeHeaders_get (msg-&gt;hdrs, HEADER_MESSAGE_ID,</span>
<a href="#l78.650"></a><span id="l78.650" class="difflineminus">-                                    false, false);</span>
<a href="#l78.651"></a><span id="l78.651" class="difflineplus">+    char *msgID = MimeHeaders_get(msg-&gt;hdrs, HEADER_MESSAGE_ID, false, false);</span>
<a href="#l78.652"></a><span id="l78.652"> </span>
<a href="#l78.653"></a><span id="l78.653" class="difflineminus">-    const char  *outCharset = NULL;</span>
<a href="#l78.654"></a><span id="l78.654" class="difflineminus">-    if (!obj-&gt;options-&gt;force_user_charset)  /* Only convert if the user prefs is false */</span>
<a href="#l78.655"></a><span id="l78.655" class="difflineplus">+    const char *outCharset = NULL;</span>
<a href="#l78.656"></a><span id="l78.656" class="difflineplus">+    if (!obj-&gt;options</span>
<a href="#l78.657"></a><span id="l78.657" class="difflineplus">+             -&gt;force_user_charset) /* Only convert if the user prefs is false */</span>
<a href="#l78.658"></a><span id="l78.658">       outCharset = &quot;UTF-8&quot;;</span>
<a href="#l78.659"></a><span id="l78.659"> </span>
<a href="#l78.660"></a><span id="l78.660" class="difflineminus">-    mimeEmitterStartBody(obj-&gt;options, (obj-&gt;options-&gt;headers == MimeHeadersNone), msgID, outCharset);</span>
<a href="#l78.661"></a><span id="l78.661" class="difflineplus">+    mimeEmitterStartBody(obj-&gt;options,</span>
<a href="#l78.662"></a><span id="l78.662" class="difflineplus">+                         (obj-&gt;options-&gt;headers == MimeHeadersNone), msgID,</span>
<a href="#l78.663"></a><span id="l78.663" class="difflineplus">+                         outCharset);</span>
<a href="#l78.664"></a><span id="l78.664">     PR_FREEIF(msgID);</span>
<a href="#l78.665"></a><span id="l78.665"> </span>
<a href="#l78.666"></a><span id="l78.666" class="difflineminus">-  // setting up truncated message html fotter function</span>
<a href="#l78.667"></a><span id="l78.667" class="difflineminus">-  char *xmoz = MimeHeaders_get(msg-&gt;hdrs, HEADER_X_MOZILLA_STATUS, false,</span>
<a href="#l78.668"></a><span id="l78.668" class="difflineminus">-                 false);</span>
<a href="#l78.669"></a><span id="l78.669" class="difflineminus">-  if (xmoz)</span>
<a href="#l78.670"></a><span id="l78.670" class="difflineminus">-  {</span>
<a href="#l78.671"></a><span id="l78.671" class="difflineminus">-    uint32_t flags = 0;</span>
<a href="#l78.672"></a><span id="l78.672" class="difflineminus">-    char dummy = 0;</span>
<a href="#l78.673"></a><span id="l78.673" class="difflineminus">-    if (sscanf(xmoz, &quot; %x %c&quot;, &amp;flags, &amp;dummy) == 1 &amp;&amp;</span>
<a href="#l78.674"></a><span id="l78.674" class="difflineminus">-      flags &amp; nsMsgMessageFlags::Partial)</span>
<a href="#l78.675"></a><span id="l78.675" class="difflineminus">-    {</span>
<a href="#l78.676"></a><span id="l78.676" class="difflineminus">-      obj-&gt;options-&gt;html_closure = obj;</span>
<a href="#l78.677"></a><span id="l78.677" class="difflineminus">-      obj-&gt;options-&gt;generate_footer_html_fn =</span>
<a href="#l78.678"></a><span id="l78.678" class="difflineminus">-        MimeMessage_partial_message_html;</span>
<a href="#l78.679"></a><span id="l78.679" class="difflineplus">+    // setting up truncated message html fotter function</span>
<a href="#l78.680"></a><span id="l78.680" class="difflineplus">+    char *xmoz =</span>
<a href="#l78.681"></a><span id="l78.681" class="difflineplus">+        MimeHeaders_get(msg-&gt;hdrs, HEADER_X_MOZILLA_STATUS, false, false);</span>
<a href="#l78.682"></a><span id="l78.682" class="difflineplus">+    if (xmoz) {</span>
<a href="#l78.683"></a><span id="l78.683" class="difflineplus">+      uint32_t flags = 0;</span>
<a href="#l78.684"></a><span id="l78.684" class="difflineplus">+      char dummy = 0;</span>
<a href="#l78.685"></a><span id="l78.685" class="difflineplus">+      if (sscanf(xmoz, &quot; %x %c&quot;, &amp;flags, &amp;dummy) == 1 &amp;&amp;</span>
<a href="#l78.686"></a><span id="l78.686" class="difflineplus">+          flags &amp; nsMsgMessageFlags::Partial) {</span>
<a href="#l78.687"></a><span id="l78.687" class="difflineplus">+        obj-&gt;options-&gt;html_closure = obj;</span>
<a href="#l78.688"></a><span id="l78.688" class="difflineplus">+        obj-&gt;options-&gt;generate_footer_html_fn =</span>
<a href="#l78.689"></a><span id="l78.689" class="difflineplus">+            MimeMessage_partial_message_html;</span>
<a href="#l78.690"></a><span id="l78.690" class="difflineplus">+      }</span>
<a href="#l78.691"></a><span id="l78.691" class="difflineplus">+      PR_FREEIF(xmoz);</span>
<a href="#l78.692"></a><span id="l78.692">     }</span>
<a href="#l78.693"></a><span id="l78.693" class="difflineminus">-    PR_FREEIF(xmoz);</span>
<a href="#l78.694"></a><span id="l78.694" class="difflineminus">-  }</span>
<a href="#l78.695"></a><span id="l78.695">   }</span>
<a href="#l78.696"></a><span id="l78.696"> </span>
<a href="#l78.697"></a><span id="l78.697">   return 0;</span>
<a href="#l78.698"></a><span id="l78.698"> }</span>
<a href="#l78.699"></a><span id="l78.699"> </span>
<a href="#l78.700"></a><span id="l78.700" class="difflineminus">-</span>
<a href="#l78.701"></a><span id="l78.701" class="difflineminus">-</span>
<a href="#l78.702"></a><span id="l78.702" class="difflineminus">-static int</span>
<a href="#l78.703"></a><span id="l78.703" class="difflineminus">-MimeMessage_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l78.704"></a><span id="l78.704" class="difflineminus">-{</span>
<a href="#l78.705"></a><span id="l78.705" class="difflineplus">+static int MimeMessage_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l78.706"></a><span id="l78.706">   int status;</span>
<a href="#l78.707"></a><span id="l78.707">   bool outer_p;</span>
<a href="#l78.708"></a><span id="l78.708">   MimeMessage *msg = (MimeMessage *)obj;</span>
<a href="#l78.709"></a><span id="l78.709">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l78.710"></a><span id="l78.710"> </span>
<a href="#l78.711"></a><span id="l78.711">   /* Run parent method first, to flush out any buffered data. */</span>
<a href="#l78.712"></a><span id="l78.712" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l78.713"></a><span id="l78.713" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l78.714"></a><span id="l78.714">   if (status &lt; 0) return status;</span>
<a href="#l78.715"></a><span id="l78.715"> </span>
<a href="#l78.716"></a><span id="l78.716" class="difflineminus">-  outer_p = !obj-&gt;headers;  /* is this the outermost message? */</span>
<a href="#l78.717"></a><span id="l78.717" class="difflineplus">+  outer_p = !obj-&gt;headers; /* is this the outermost message? */</span>
<a href="#l78.718"></a><span id="l78.718"> </span>
<a href="#l78.719"></a><span id="l78.719">   // Hack for messages with truncated headers (bug 244722)</span>
<a href="#l78.720"></a><span id="l78.720">   // If there is no empty line in a message, the parser can't figure out where</span>
<a href="#l78.721"></a><span id="l78.721">   // the headers end, causing parsing to hang. So we insert an extra newline</span>
<a href="#l78.722"></a><span id="l78.722">   // to keep it happy. This is OK, since a message without any empty lines is</span>
<a href="#l78.723"></a><span id="l78.723">   // broken anyway...</span>
<a href="#l78.724"></a><span id="l78.724" class="difflineminus">-  if(outer_p &amp;&amp; msg-&gt;hdrs &amp;&amp; ! msg-&gt;hdrs-&gt;done_p) {</span>
<a href="#l78.725"></a><span id="l78.725" class="difflineplus">+  if (outer_p &amp;&amp; msg-&gt;hdrs &amp;&amp; !msg-&gt;hdrs-&gt;done_p) {</span>
<a href="#l78.726"></a><span id="l78.726">     MimeMessage_parse_line(&quot;\n&quot;, 1, obj);</span>
<a href="#l78.727"></a><span id="l78.727">   }</span>
<a href="#l78.728"></a><span id="l78.728"> </span>
<a href="#l78.729"></a><span id="l78.729">   // Once we get to the end of parsing the message, we will notify</span>
<a href="#l78.730"></a><span id="l78.730">   // the emitter that we are done the the body.</span>
<a href="#l78.731"></a><span id="l78.731"> </span>
<a href="#l78.732"></a><span id="l78.732">   // Mark the end of the mail body if we are actually emitting the</span>
<a href="#l78.733"></a><span id="l78.733">   // body of the message (i.e. not Header ONLY)</span>
<a href="#l78.734"></a><span id="l78.734">   if ((outer_p || obj-&gt;options-&gt;notify_nested_bodies) &amp;&amp; obj-&gt;options &amp;&amp;</span>
<a href="#l78.735"></a><span id="l78.735" class="difflineminus">-      obj-&gt;options-&gt;write_html_p)</span>
<a href="#l78.736"></a><span id="l78.736" class="difflineminus">-  {</span>
<a href="#l78.737"></a><span id="l78.737" class="difflineminus">-    if (obj-&gt;options-&gt;generate_footer_html_fn)</span>
<a href="#l78.738"></a><span id="l78.738" class="difflineminus">-    {</span>
<a href="#l78.739"></a><span id="l78.739" class="difflineminus">-      mime_stream_data *msd =</span>
<a href="#l78.740"></a><span id="l78.740" class="difflineminus">-        (mime_stream_data *) obj-&gt;options-&gt;stream_closure;</span>
<a href="#l78.741"></a><span id="l78.741" class="difflineminus">-      if (msd)</span>
<a href="#l78.742"></a><span id="l78.742" class="difflineminus">-      {</span>
<a href="#l78.743"></a><span id="l78.743" class="difflineminus">-        char *html = obj-&gt;options-&gt;generate_footer_html_fn</span>
<a href="#l78.744"></a><span id="l78.744" class="difflineminus">-          (msd-&gt;orig_url_name, obj-&gt;options-&gt;html_closure, msg-&gt;hdrs);</span>
<a href="#l78.745"></a><span id="l78.745" class="difflineminus">-        if (html)</span>
<a href="#l78.746"></a><span id="l78.746" class="difflineminus">-        {</span>
<a href="#l78.747"></a><span id="l78.747" class="difflineminus">-          int lstatus = MimeObject_write(obj, html,</span>
<a href="#l78.748"></a><span id="l78.748" class="difflineminus">-                         strlen(html),</span>
<a href="#l78.749"></a><span id="l78.749" class="difflineminus">-                         false);</span>
<a href="#l78.750"></a><span id="l78.750" class="difflineplus">+      obj-&gt;options-&gt;write_html_p) {</span>
<a href="#l78.751"></a><span id="l78.751" class="difflineplus">+    if (obj-&gt;options-&gt;generate_footer_html_fn) {</span>
<a href="#l78.752"></a><span id="l78.752" class="difflineplus">+      mime_stream_data *msd = (mime_stream_data *)obj-&gt;options-&gt;stream_closure;</span>
<a href="#l78.753"></a><span id="l78.753" class="difflineplus">+      if (msd) {</span>
<a href="#l78.754"></a><span id="l78.754" class="difflineplus">+        char *html = obj-&gt;options-&gt;generate_footer_html_fn(</span>
<a href="#l78.755"></a><span id="l78.755" class="difflineplus">+            msd-&gt;orig_url_name, obj-&gt;options-&gt;html_closure, msg-&gt;hdrs);</span>
<a href="#l78.756"></a><span id="l78.756" class="difflineplus">+        if (html) {</span>
<a href="#l78.757"></a><span id="l78.757" class="difflineplus">+          int lstatus = MimeObject_write(obj, html, strlen(html), false);</span>
<a href="#l78.758"></a><span id="l78.758">           PR_Free(html);</span>
<a href="#l78.759"></a><span id="l78.759">           if (lstatus &lt; 0) return lstatus;</span>
<a href="#l78.760"></a><span id="l78.760">         }</span>
<a href="#l78.761"></a><span id="l78.761">       }</span>
<a href="#l78.762"></a><span id="l78.762">     }</span>
<a href="#l78.763"></a><span id="l78.763" class="difflineminus">-    if ((!obj-&gt;options-&gt;part_to_load  || obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay) &amp;&amp;</span>
<a href="#l78.764"></a><span id="l78.764" class="difflineminus">-      obj-&gt;options-&gt;headers != MimeHeadersOnly)</span>
<a href="#l78.765"></a><span id="l78.765" class="difflineplus">+    if ((!obj-&gt;options-&gt;part_to_load ||</span>
<a href="#l78.766"></a><span id="l78.766" class="difflineplus">+         obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay) &amp;&amp;</span>
<a href="#l78.767"></a><span id="l78.767" class="difflineplus">+        obj-&gt;options-&gt;headers != MimeHeadersOnly)</span>
<a href="#l78.768"></a><span id="l78.768">       mimeEmitterEndBody(obj-&gt;options);</span>
<a href="#l78.769"></a><span id="l78.769">   }</span>
<a href="#l78.770"></a><span id="l78.770"> </span>
<a href="#l78.771"></a><span id="l78.771"> #ifdef MIME_DRAFTS</span>
<a href="#l78.772"></a><span id="l78.772" class="difflineminus">-  if ( obj-&gt;options &amp;&amp;</span>
<a href="#l78.773"></a><span id="l78.773" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l78.774"></a><span id="l78.774" class="difflineminus">-     obj-&gt;options-&gt;done_parsing_outer_headers &amp;&amp;</span>
<a href="#l78.775"></a><span id="l78.775" class="difflineminus">-     ! obj-&gt;options-&gt;is_multipart_msg &amp;&amp;</span>
<a href="#l78.776"></a><span id="l78.776" class="difflineminus">-     ! mime_typep(obj, (MimeObjectClass*) &amp;mimeEncryptedClass) &amp;&amp;</span>
<a href="#l78.777"></a><span id="l78.777" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_close_fn ) {</span>
<a href="#l78.778"></a><span id="l78.778" class="difflineminus">-  status = obj-&gt;options-&gt;decompose_file_close_fn (</span>
<a href="#l78.779"></a><span id="l78.779" class="difflineminus">-                         obj-&gt;options-&gt;stream_closure );</span>
<a href="#l78.780"></a><span id="l78.780" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l78.781"></a><span id="l78.781" class="difflineplus">+      obj-&gt;options-&gt;done_parsing_outer_headers &amp;&amp;</span>
<a href="#l78.782"></a><span id="l78.782" class="difflineplus">+      !obj-&gt;options-&gt;is_multipart_msg &amp;&amp;</span>
<a href="#l78.783"></a><span id="l78.783" class="difflineplus">+      !mime_typep(obj, (MimeObjectClass *)&amp;mimeEncryptedClass) &amp;&amp;</span>
<a href="#l78.784"></a><span id="l78.784" class="difflineplus">+      obj-&gt;options-&gt;decompose_file_close_fn) {</span>
<a href="#l78.785"></a><span id="l78.785" class="difflineplus">+    status =</span>
<a href="#l78.786"></a><span id="l78.786" class="difflineplus">+        obj-&gt;options-&gt;decompose_file_close_fn(obj-&gt;options-&gt;stream_closure);</span>
<a href="#l78.787"></a><span id="l78.787"> </span>
<a href="#l78.788"></a><span id="l78.788" class="difflineminus">-  if ( status &lt; 0 ) return status;</span>
<a href="#l78.789"></a><span id="l78.789" class="difflineplus">+    if (status &lt; 0) return status;</span>
<a href="#l78.790"></a><span id="l78.790">   }</span>
<a href="#l78.791"></a><span id="l78.791"> #endif /* MIME_DRAFTS */</span>
<a href="#l78.792"></a><span id="l78.792"> </span>
<a href="#l78.793"></a><span id="l78.793" class="difflineminus">-</span>
<a href="#l78.794"></a><span id="l78.794">   /* Put out a separator after every message/rfc822 object. */</span>
<a href="#l78.795"></a><span id="l78.795" class="difflineminus">-  if (!abort_p &amp;&amp; !outer_p)</span>
<a href="#l78.796"></a><span id="l78.796" class="difflineminus">-  {</span>
<a href="#l78.797"></a><span id="l78.797" class="difflineplus">+  if (!abort_p &amp;&amp; !outer_p) {</span>
<a href="#l78.798"></a><span id="l78.798">     status = MimeObject_write_separator(obj);</span>
<a href="#l78.799"></a><span id="l78.799">     if (status &lt; 0) return status;</span>
<a href="#l78.800"></a><span id="l78.800">   }</span>
<a href="#l78.801"></a><span id="l78.801"> </span>
<a href="#l78.802"></a><span id="l78.802">   return 0;</span>
<a href="#l78.803"></a><span id="l78.803"> }</span>
<a href="#l78.804"></a><span id="l78.804"> </span>
<a href="#l78.805"></a><span id="l78.805" class="difflineminus">-</span>
<a href="#l78.806"></a><span id="l78.806" class="difflineminus">-static int</span>
<a href="#l78.807"></a><span id="l78.807" class="difflineminus">-MimeMessage_add_child (MimeObject *parent, MimeObject *child)</span>
<a href="#l78.808"></a><span id="l78.808" class="difflineminus">-{</span>
<a href="#l78.809"></a><span id="l78.809" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) parent;</span>
<a href="#l78.810"></a><span id="l78.810" class="difflineplus">+static int MimeMessage_add_child(MimeObject *parent, MimeObject *child) {</span>
<a href="#l78.811"></a><span id="l78.811" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)parent;</span>
<a href="#l78.812"></a><span id="l78.812">   PR_ASSERT(parent &amp;&amp; child);</span>
<a href="#l78.813"></a><span id="l78.813">   if (!parent || !child) return -1;</span>
<a href="#l78.814"></a><span id="l78.814"> </span>
<a href="#l78.815"></a><span id="l78.815">   /* message/rfc822 containers can only have one child. */</span>
<a href="#l78.816"></a><span id="l78.816">   PR_ASSERT(cont-&gt;nchildren == 0);</span>
<a href="#l78.817"></a><span id="l78.817">   if (cont-&gt;nchildren != 0) return -1;</span>
<a href="#l78.818"></a><span id="l78.818"> </span>
<a href="#l78.819"></a><span id="l78.819"> #ifdef MIME_DRAFTS</span>
<a href="#l78.820"></a><span id="l78.820" class="difflineminus">-  if ( parent-&gt;options &amp;&amp;</span>
<a href="#l78.821"></a><span id="l78.821" class="difflineminus">-     parent-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l78.822"></a><span id="l78.822" class="difflineminus">-     ! parent-&gt;options-&gt;is_multipart_msg &amp;&amp;</span>
<a href="#l78.823"></a><span id="l78.823" class="difflineminus">-     ! mime_typep(child, (MimeObjectClass*) &amp;mimeEncryptedClass) &amp;&amp;</span>
<a href="#l78.824"></a><span id="l78.824" class="difflineminus">-     parent-&gt;options-&gt;decompose_file_init_fn ) {</span>
<a href="#l78.825"></a><span id="l78.825" class="difflineminus">-  int status = 0;</span>
<a href="#l78.826"></a><span id="l78.826" class="difflineminus">-  status = parent-&gt;options-&gt;decompose_file_init_fn (</span>
<a href="#l78.827"></a><span id="l78.827" class="difflineminus">-                        parent-&gt;options-&gt;stream_closure,</span>
<a href="#l78.828"></a><span id="l78.828" class="difflineminus">-                        ((MimeMessage*)parent)-&gt;hdrs );</span>
<a href="#l78.829"></a><span id="l78.829" class="difflineminus">-  if ( status &lt; 0 ) return status;</span>
<a href="#l78.830"></a><span id="l78.830" class="difflineplus">+  if (parent-&gt;options &amp;&amp; parent-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l78.831"></a><span id="l78.831" class="difflineplus">+      !parent-&gt;options-&gt;is_multipart_msg &amp;&amp;</span>
<a href="#l78.832"></a><span id="l78.832" class="difflineplus">+      !mime_typep(child, (MimeObjectClass *)&amp;mimeEncryptedClass) &amp;&amp;</span>
<a href="#l78.833"></a><span id="l78.833" class="difflineplus">+      parent-&gt;options-&gt;decompose_file_init_fn) {</span>
<a href="#l78.834"></a><span id="l78.834" class="difflineplus">+    int status = 0;</span>
<a href="#l78.835"></a><span id="l78.835" class="difflineplus">+    status = parent-&gt;options-&gt;decompose_file_init_fn(</span>
<a href="#l78.836"></a><span id="l78.836" class="difflineplus">+        parent-&gt;options-&gt;stream_closure, ((MimeMessage *)parent)-&gt;hdrs);</span>
<a href="#l78.837"></a><span id="l78.837" class="difflineplus">+    if (status &lt; 0) return status;</span>
<a href="#l78.838"></a><span id="l78.838">   }</span>
<a href="#l78.839"></a><span id="l78.839"> #endif /* MIME_DRAFTS */</span>
<a href="#l78.840"></a><span id="l78.840"> </span>
<a href="#l78.841"></a><span id="l78.841" class="difflineminus">-  return ((MimeContainerClass*)&amp;MIME_SUPERCLASS)-&gt;add_child (parent, child);</span>
<a href="#l78.842"></a><span id="l78.842" class="difflineplus">+  return ((MimeContainerClass *)&amp;MIME_SUPERCLASS)-&gt;add_child(parent, child);</span>
<a href="#l78.843"></a><span id="l78.843"> }</span>
<a href="#l78.844"></a><span id="l78.844"> </span>
<a href="#l78.845"></a><span id="l78.845"> // This is necessary to determine which charset to use for a reply/forward</span>
<a href="#l78.846"></a><span id="l78.846" class="difflineminus">-char *</span>
<a href="#l78.847"></a><span id="l78.847" class="difflineminus">-DetermineMailCharset(MimeMessage *msg)</span>
<a href="#l78.848"></a><span id="l78.848" class="difflineminus">-{</span>
<a href="#l78.849"></a><span id="l78.849" class="difflineminus">-  char          *retCharset = nullptr;</span>
<a href="#l78.850"></a><span id="l78.850" class="difflineplus">+char *DetermineMailCharset(MimeMessage *msg) {</span>
<a href="#l78.851"></a><span id="l78.851" class="difflineplus">+  char *retCharset = nullptr;</span>
<a href="#l78.852"></a><span id="l78.852"> </span>
<a href="#l78.853"></a><span id="l78.853" class="difflineminus">-  if ( (msg) &amp;&amp; (msg-&gt;hdrs) )</span>
<a href="#l78.854"></a><span id="l78.854" class="difflineminus">-  {</span>
<a href="#l78.855"></a><span id="l78.855" class="difflineminus">-    char *ct = MimeHeaders_get (msg-&gt;hdrs, HEADER_CONTENT_TYPE,</span>
<a href="#l78.856"></a><span id="l78.856" class="difflineminus">-                                false, false);</span>
<a href="#l78.857"></a><span id="l78.857" class="difflineminus">-    if (ct)</span>
<a href="#l78.858"></a><span id="l78.858" class="difflineminus">-    {</span>
<a href="#l78.859"></a><span id="l78.859" class="difflineminus">-      retCharset = MimeHeaders_get_parameter (ct, &quot;charset&quot;, NULL, NULL);</span>
<a href="#l78.860"></a><span id="l78.860" class="difflineplus">+  if ((msg) &amp;&amp; (msg-&gt;hdrs)) {</span>
<a href="#l78.861"></a><span id="l78.861" class="difflineplus">+    char *ct = MimeHeaders_get(msg-&gt;hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l78.862"></a><span id="l78.862" class="difflineplus">+    if (ct) {</span>
<a href="#l78.863"></a><span id="l78.863" class="difflineplus">+      retCharset = MimeHeaders_get_parameter(ct, &quot;charset&quot;, NULL, NULL);</span>
<a href="#l78.864"></a><span id="l78.864">       PR_Free(ct);</span>
<a href="#l78.865"></a><span id="l78.865">     }</span>
<a href="#l78.866"></a><span id="l78.866"> </span>
<a href="#l78.867"></a><span id="l78.867" class="difflineminus">-    if (!retCharset)</span>
<a href="#l78.868"></a><span id="l78.868" class="difflineminus">-    {</span>
<a href="#l78.869"></a><span id="l78.869" class="difflineplus">+    if (!retCharset) {</span>
<a href="#l78.870"></a><span id="l78.870">       // If we didn't find &quot;Content-Type: ...; charset=XX&quot; then look</span>
<a href="#l78.871"></a><span id="l78.871">       // for &quot;X-Sun-Charset: XX&quot; instead.  (Maybe this should be done</span>
<a href="#l78.872"></a><span id="l78.872">       // in MimeSunAttachmentClass, but it's harder there than here.)</span>
<a href="#l78.873"></a><span id="l78.873" class="difflineminus">-      retCharset = MimeHeaders_get (msg-&gt;hdrs, HEADER_X_SUN_CHARSET,</span>
<a href="#l78.874"></a><span id="l78.874" class="difflineminus">-                                    false, false);</span>
<a href="#l78.875"></a><span id="l78.875" class="difflineplus">+      retCharset =</span>
<a href="#l78.876"></a><span id="l78.876" class="difflineplus">+          MimeHeaders_get(msg-&gt;hdrs, HEADER_X_SUN_CHARSET, false, false);</span>
<a href="#l78.877"></a><span id="l78.877">     }</span>
<a href="#l78.878"></a><span id="l78.878">   }</span>
<a href="#l78.879"></a><span id="l78.879"> </span>
<a href="#l78.880"></a><span id="l78.880">   if (!retCharset)</span>
<a href="#l78.881"></a><span id="l78.881">     return strdup(&quot;ISO-8859-1&quot;);</span>
<a href="#l78.882"></a><span id="l78.882">   else</span>
<a href="#l78.883"></a><span id="l78.883">     return retCharset;</span>
<a href="#l78.884"></a><span id="l78.884"> }</span>
<a href="#l78.885"></a><span id="l78.885"> </span>
<a href="#l78.886"></a><span id="l78.886" class="difflineminus">-static int</span>
<a href="#l78.887"></a><span id="l78.887" class="difflineminus">-MimeMessage_write_headers_html (MimeObject *obj)</span>
<a href="#l78.888"></a><span id="l78.888" class="difflineminus">-{</span>
<a href="#l78.889"></a><span id="l78.889" class="difflineminus">-  MimeMessage     *msg = (MimeMessage *) obj;</span>
<a href="#l78.890"></a><span id="l78.890" class="difflineminus">-  int             status;</span>
<a href="#l78.891"></a><span id="l78.891" class="difflineplus">+static int MimeMessage_write_headers_html(MimeObject *obj) {</span>
<a href="#l78.892"></a><span id="l78.892" class="difflineplus">+  MimeMessage *msg = (MimeMessage *)obj;</span>
<a href="#l78.893"></a><span id="l78.893" class="difflineplus">+  int status;</span>
<a href="#l78.894"></a><span id="l78.894"> </span>
<a href="#l78.895"></a><span id="l78.895" class="difflineminus">-  if (!obj-&gt;options || !obj-&gt;options-&gt;output_fn)</span>
<a href="#l78.896"></a><span id="l78.896" class="difflineminus">-    return 0;</span>
<a href="#l78.897"></a><span id="l78.897" class="difflineplus">+  if (!obj-&gt;options || !obj-&gt;options-&gt;output_fn) return 0;</span>
<a href="#l78.898"></a><span id="l78.898"> </span>
<a href="#l78.899"></a><span id="l78.899">   PR_ASSERT(obj-&gt;output_p &amp;&amp; obj-&gt;options-&gt;write_html_p);</span>
<a href="#l78.900"></a><span id="l78.900"> </span>
<a href="#l78.901"></a><span id="l78.901">   // To support the no header option! Make sure we are not</span>
<a href="#l78.902"></a><span id="l78.902">   // suppressing headers on included email messages...</span>
<a href="#l78.903"></a><span id="l78.903" class="difflineminus">-  if ( (obj-&gt;options-&gt;headers == MimeHeadersNone) &amp;&amp;</span>
<a href="#l78.904"></a><span id="l78.904" class="difflineminus">-       (obj == obj-&gt;options-&gt;state-&gt;root) )</span>
<a href="#l78.905"></a><span id="l78.905" class="difflineminus">-  {</span>
<a href="#l78.906"></a><span id="l78.906" class="difflineplus">+  if ((obj-&gt;options-&gt;headers == MimeHeadersNone) &amp;&amp;</span>
<a href="#l78.907"></a><span id="l78.907" class="difflineplus">+      (obj == obj-&gt;options-&gt;state-&gt;root)) {</span>
<a href="#l78.908"></a><span id="l78.908">     // Ok, we are going to kick the Emitter for a StartHeader</span>
<a href="#l78.909"></a><span id="l78.909">     // operation ONLY WHEN THE CHARSET OF THE ORIGINAL MESSAGE IS</span>
<a href="#l78.910"></a><span id="l78.910">     // NOT US-ASCII (&quot;ISO-8859-1&quot;)</span>
<a href="#l78.911"></a><span id="l78.911">     //</span>
<a href="#l78.912"></a><span id="l78.912">     // This is only to notify the emitter of the charset of the</span>
<a href="#l78.913"></a><span id="l78.913">     // original message</span>
<a href="#l78.914"></a><span id="l78.914" class="difflineminus">-    char    *mailCharset = DetermineMailCharset(msg);</span>
<a href="#l78.915"></a><span id="l78.915" class="difflineplus">+    char *mailCharset = DetermineMailCharset(msg);</span>
<a href="#l78.916"></a><span id="l78.916"> </span>
<a href="#l78.917"></a><span id="l78.917" class="difflineminus">-    if ( (mailCharset) &amp;&amp; (PL_strcasecmp(mailCharset, &quot;US-ASCII&quot;)) &amp;&amp;</span>
<a href="#l78.918"></a><span id="l78.918" class="difflineminus">-         (PL_strcasecmp(mailCharset, &quot;ISO-8859-1&quot;)) )</span>
<a href="#l78.919"></a><span id="l78.919" class="difflineplus">+    if ((mailCharset) &amp;&amp; (PL_strcasecmp(mailCharset, &quot;US-ASCII&quot;)) &amp;&amp;</span>
<a href="#l78.920"></a><span id="l78.920" class="difflineplus">+        (PL_strcasecmp(mailCharset, &quot;ISO-8859-1&quot;)))</span>
<a href="#l78.921"></a><span id="l78.921">       mimeEmitterUpdateCharacterSet(obj-&gt;options, mailCharset);</span>
<a href="#l78.922"></a><span id="l78.922">     PR_FREEIF(mailCharset);</span>
<a href="#l78.923"></a><span id="l78.923">     return 0;</span>
<a href="#l78.924"></a><span id="l78.924">   }</span>
<a href="#l78.925"></a><span id="l78.925"> </span>
<a href="#l78.926"></a><span id="l78.926" class="difflineminus">-  if (!obj-&gt;options-&gt;state-&gt;first_data_written_p)</span>
<a href="#l78.927"></a><span id="l78.927" class="difflineminus">-  {</span>
<a href="#l78.928"></a><span id="l78.928" class="difflineminus">-    status = MimeObject_output_init (obj, TEXT_HTML);</span>
<a href="#l78.929"></a><span id="l78.929" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l78.930"></a><span id="l78.930" class="difflineminus">-    {</span>
<a href="#l78.931"></a><span id="l78.931" class="difflineplus">+  if (!obj-&gt;options-&gt;state-&gt;first_data_written_p) {</span>
<a href="#l78.932"></a><span id="l78.932" class="difflineplus">+    status = MimeObject_output_init(obj, TEXT_HTML);</span>
<a href="#l78.933"></a><span id="l78.933" class="difflineplus">+    if (status &lt; 0) {</span>
<a href="#l78.934"></a><span id="l78.934">       mimeEmitterEndHeader(obj-&gt;options, obj);</span>
<a href="#l78.935"></a><span id="l78.935">       return status;</span>
<a href="#l78.936"></a><span id="l78.936">     }</span>
<a href="#l78.937"></a><span id="l78.937">     PR_ASSERT(obj-&gt;options-&gt;state-&gt;first_data_written_p);</span>
<a href="#l78.938"></a><span id="l78.938">   }</span>
<a href="#l78.939"></a><span id="l78.939"> </span>
<a href="#l78.940"></a><span id="l78.940">   // Start the header parsing by the emitter</span>
<a href="#l78.941"></a><span id="l78.941" class="difflineminus">-  char *msgID = MimeHeaders_get (msg-&gt;hdrs, HEADER_MESSAGE_ID,</span>
<a href="#l78.942"></a><span id="l78.942" class="difflineminus">-                                    false, false);</span>
<a href="#l78.943"></a><span id="l78.943" class="difflineplus">+  char *msgID = MimeHeaders_get(msg-&gt;hdrs, HEADER_MESSAGE_ID, false, false);</span>
<a href="#l78.944"></a><span id="l78.944">   bool outer_p = !obj-&gt;headers; /* is this the outermost message? */</span>
<a href="#l78.945"></a><span id="l78.945" class="difflineminus">-  if (!outer_p &amp;&amp; obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay &amp;&amp;</span>
<a href="#l78.946"></a><span id="l78.946" class="difflineminus">-      obj-&gt;options-&gt;part_to_load)</span>
<a href="#l78.947"></a><span id="l78.947" class="difflineminus">-  {</span>
<a href="#l78.948"></a><span id="l78.948" class="difflineminus">-    //Maybe we are displaying a embedded message as outer part!</span>
<a href="#l78.949"></a><span id="l78.949" class="difflineplus">+  if (!outer_p &amp;&amp;</span>
<a href="#l78.950"></a><span id="l78.950" class="difflineplus">+      obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay &amp;&amp;</span>
<a href="#l78.951"></a><span id="l78.951" class="difflineplus">+      obj-&gt;options-&gt;part_to_load) {</span>
<a href="#l78.952"></a><span id="l78.952" class="difflineplus">+    // Maybe we are displaying a embedded message as outer part!</span>
<a href="#l78.953"></a><span id="l78.953">     char *id = mime_part_address(obj);</span>
<a href="#l78.954"></a><span id="l78.954" class="difflineminus">-    if (id)</span>
<a href="#l78.955"></a><span id="l78.955" class="difflineminus">-    {</span>
<a href="#l78.956"></a><span id="l78.956" class="difflineplus">+    if (id) {</span>
<a href="#l78.957"></a><span id="l78.957">       outer_p = !strcmp(id, obj-&gt;options-&gt;part_to_load);</span>
<a href="#l78.958"></a><span id="l78.958">       PR_Free(id);</span>
<a href="#l78.959"></a><span id="l78.959">     }</span>
<a href="#l78.960"></a><span id="l78.960">   }</span>
<a href="#l78.961"></a><span id="l78.961"> </span>
<a href="#l78.962"></a><span id="l78.962">   // Ok, we should really find out the charset of this part. We always</span>
<a href="#l78.963"></a><span id="l78.963">   // output UTF-8 for display, but the original charset is necessary for</span>
<a href="#l78.964"></a><span id="l78.964">   // reply and forward operations.</span>
<a href="#l78.965"></a><span id="l78.965">   //</span>
<a href="#l78.966"></a><span id="l78.966" class="difflineminus">-  char    *mailCharset = DetermineMailCharset(msg);</span>
<a href="#l78.967"></a><span id="l78.967" class="difflineminus">-  mimeEmitterStartHeader(obj-&gt;options,</span>
<a href="#l78.968"></a><span id="l78.968" class="difflineminus">-                            outer_p,</span>
<a href="#l78.969"></a><span id="l78.969" class="difflineminus">-                            (obj-&gt;options-&gt;headers == MimeHeadersOnly),</span>
<a href="#l78.970"></a><span id="l78.970" class="difflineminus">-                            msgID,</span>
<a href="#l78.971"></a><span id="l78.971" class="difflineminus">-                            mailCharset);</span>
<a href="#l78.972"></a><span id="l78.972" class="difflineplus">+  char *mailCharset = DetermineMailCharset(msg);</span>
<a href="#l78.973"></a><span id="l78.973" class="difflineplus">+  mimeEmitterStartHeader(obj-&gt;options, outer_p,</span>
<a href="#l78.974"></a><span id="l78.974" class="difflineplus">+                         (obj-&gt;options-&gt;headers == MimeHeadersOnly), msgID,</span>
<a href="#l78.975"></a><span id="l78.975" class="difflineplus">+                         mailCharset);</span>
<a href="#l78.976"></a><span id="l78.976"> </span>
<a href="#l78.977"></a><span id="l78.977">   // Change the default_charset by the charset of the original message</span>
<a href="#l78.978"></a><span id="l78.978">   // ONLY WHEN THE CHARSET OF THE ORIGINAL MESSAGE IS NOT US-ASCII</span>
<a href="#l78.979"></a><span id="l78.979">   // (&quot;ISO-8859-1&quot;) and default_charset and mailCharset are different,</span>
<a href="#l78.980"></a><span id="l78.980">   // or when there is no default_charset (this can happen with saved messages).</span>
<a href="#l78.981"></a><span id="l78.981" class="difflineminus">-  if ( (!obj-&gt;options-&gt;default_charset ||</span>
<a href="#l78.982"></a><span id="l78.982" class="difflineminus">-        ((mailCharset) &amp;&amp; (PL_strcasecmp(mailCharset, &quot;US-ASCII&quot;)) &amp;&amp;</span>
<a href="#l78.983"></a><span id="l78.983" class="difflineminus">-         (PL_strcasecmp(mailCharset, &quot;ISO-8859-1&quot;)) &amp;&amp;</span>
<a href="#l78.984"></a><span id="l78.984" class="difflineminus">-         (PL_strcasecmp(obj-&gt;options-&gt;default_charset, mailCharset)))) &amp;&amp;</span>
<a href="#l78.985"></a><span id="l78.985" class="difflineminus">-       !obj-&gt;options-&gt;override_charset )</span>
<a href="#l78.986"></a><span id="l78.986" class="difflineminus">-  {</span>
<a href="#l78.987"></a><span id="l78.987" class="difflineplus">+  if ((!obj-&gt;options-&gt;default_charset ||</span>
<a href="#l78.988"></a><span id="l78.988" class="difflineplus">+       ((mailCharset) &amp;&amp; (PL_strcasecmp(mailCharset, &quot;US-ASCII&quot;)) &amp;&amp;</span>
<a href="#l78.989"></a><span id="l78.989" class="difflineplus">+        (PL_strcasecmp(mailCharset, &quot;ISO-8859-1&quot;)) &amp;&amp;</span>
<a href="#l78.990"></a><span id="l78.990" class="difflineplus">+        (PL_strcasecmp(obj-&gt;options-&gt;default_charset, mailCharset)))) &amp;&amp;</span>
<a href="#l78.991"></a><span id="l78.991" class="difflineplus">+      !obj-&gt;options-&gt;override_charset) {</span>
<a href="#l78.992"></a><span id="l78.992">     PR_FREEIF(obj-&gt;options-&gt;default_charset);</span>
<a href="#l78.993"></a><span id="l78.993">     obj-&gt;options-&gt;default_charset = strdup(mailCharset);</span>
<a href="#l78.994"></a><span id="l78.994">   }</span>
<a href="#l78.995"></a><span id="l78.995"> </span>
<a href="#l78.996"></a><span id="l78.996">   PR_FREEIF(msgID);</span>
<a href="#l78.997"></a><span id="l78.997">   PR_FREEIF(mailCharset);</span>
<a href="#l78.998"></a><span id="l78.998"> </span>
<a href="#l78.999"></a><span id="l78.999" class="difflineminus">-  status = MimeHeaders_write_all_headers (msg-&gt;hdrs, obj-&gt;options, false);</span>
<a href="#l78.1000"></a><span id="l78.1000" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l78.1001"></a><span id="l78.1001" class="difflineminus">-  {</span>
<a href="#l78.1002"></a><span id="l78.1002" class="difflineplus">+  status = MimeHeaders_write_all_headers(msg-&gt;hdrs, obj-&gt;options, false);</span>
<a href="#l78.1003"></a><span id="l78.1003" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l78.1004"></a><span id="l78.1004">     mimeEmitterEndHeader(obj-&gt;options, obj);</span>
<a href="#l78.1005"></a><span id="l78.1005">     return status;</span>
<a href="#l78.1006"></a><span id="l78.1006">   }</span>
<a href="#l78.1007"></a><span id="l78.1007"> </span>
<a href="#l78.1008"></a><span id="l78.1008" class="difflineminus">-  if (!msg-&gt;crypto_stamped_p)</span>
<a href="#l78.1009"></a><span id="l78.1009" class="difflineminus">-  {</span>
<a href="#l78.1010"></a><span id="l78.1010" class="difflineminus">-  /* If we're not writing a xlation stamp, and this is the outermost</span>
<a href="#l78.1011"></a><span id="l78.1011" class="difflineminus">-  message, then now is the time to run the post_header_html_fn.</span>
<a href="#l78.1012"></a><span id="l78.1012" class="difflineminus">-  (Otherwise, it will be run when the xlation-stamp is finally</span>
<a href="#l78.1013"></a><span id="l78.1013" class="difflineminus">-  closed off, in MimeXlateed_emit_buffered_child() or</span>
<a href="#l78.1014"></a><span id="l78.1014" class="difflineminus">-  MimeMultipartSigned_emit_child().)</span>
<a href="#l78.1015"></a><span id="l78.1015" class="difflineminus">-     */</span>
<a href="#l78.1016"></a><span id="l78.1016" class="difflineminus">-    if (obj-&gt;options &amp;&amp;</span>
<a href="#l78.1017"></a><span id="l78.1017" class="difflineminus">-      obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l78.1018"></a><span id="l78.1018" class="difflineminus">-      obj-&gt;options-&gt;generate_post_header_html_fn &amp;&amp;</span>
<a href="#l78.1019"></a><span id="l78.1019" class="difflineminus">-      !obj-&gt;options-&gt;state-&gt;post_header_html_run_p)</span>
<a href="#l78.1020"></a><span id="l78.1020" class="difflineminus">-    {</span>
<a href="#l78.1021"></a><span id="l78.1021" class="difflineplus">+  if (!msg-&gt;crypto_stamped_p) {</span>
<a href="#l78.1022"></a><span id="l78.1022" class="difflineplus">+    /* If we're not writing a xlation stamp, and this is the outermost</span>
<a href="#l78.1023"></a><span id="l78.1023" class="difflineplus">+    message, then now is the time to run the post_header_html_fn.</span>
<a href="#l78.1024"></a><span id="l78.1024" class="difflineplus">+    (Otherwise, it will be run when the xlation-stamp is finally</span>
<a href="#l78.1025"></a><span id="l78.1025" class="difflineplus">+    closed off, in MimeXlateed_emit_buffered_child() or</span>
<a href="#l78.1026"></a><span id="l78.1026" class="difflineplus">+    MimeMultipartSigned_emit_child().)</span>
<a href="#l78.1027"></a><span id="l78.1027" class="difflineplus">+       */</span>
<a href="#l78.1028"></a><span id="l78.1028" class="difflineplus">+    if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l78.1029"></a><span id="l78.1029" class="difflineplus">+        obj-&gt;options-&gt;generate_post_header_html_fn &amp;&amp;</span>
<a href="#l78.1030"></a><span id="l78.1030" class="difflineplus">+        !obj-&gt;options-&gt;state-&gt;post_header_html_run_p) {</span>
<a href="#l78.1031"></a><span id="l78.1031">       char *html = 0;</span>
<a href="#l78.1032"></a><span id="l78.1032">       PR_ASSERT(obj-&gt;options-&gt;state-&gt;first_data_written_p);</span>
<a href="#l78.1033"></a><span id="l78.1033" class="difflineminus">-      html = obj-&gt;options-&gt;generate_post_header_html_fn(NULL,</span>
<a href="#l78.1034"></a><span id="l78.1034" class="difflineminus">-                                          obj-&gt;options-&gt;html_closure,</span>
<a href="#l78.1035"></a><span id="l78.1035" class="difflineminus">-                                          msg-&gt;hdrs);</span>
<a href="#l78.1036"></a><span id="l78.1036" class="difflineplus">+      html = obj-&gt;options-&gt;generate_post_header_html_fn(</span>
<a href="#l78.1037"></a><span id="l78.1037" class="difflineplus">+          NULL, obj-&gt;options-&gt;html_closure, msg-&gt;hdrs);</span>
<a href="#l78.1038"></a><span id="l78.1038">       obj-&gt;options-&gt;state-&gt;post_header_html_run_p = true;</span>
<a href="#l78.1039"></a><span id="l78.1039" class="difflineminus">-      if (html)</span>
<a href="#l78.1040"></a><span id="l78.1040" class="difflineminus">-      {</span>
<a href="#l78.1041"></a><span id="l78.1041" class="difflineplus">+      if (html) {</span>
<a href="#l78.1042"></a><span id="l78.1042">         status = MimeObject_write(obj, html, strlen(html), false);</span>
<a href="#l78.1043"></a><span id="l78.1043">         PR_Free(html);</span>
<a href="#l78.1044"></a><span id="l78.1044" class="difflineminus">-        if (status &lt; 0)</span>
<a href="#l78.1045"></a><span id="l78.1045" class="difflineminus">-        {</span>
<a href="#l78.1046"></a><span id="l78.1046" class="difflineplus">+        if (status &lt; 0) {</span>
<a href="#l78.1047"></a><span id="l78.1047">           mimeEmitterEndHeader(obj-&gt;options, obj);</span>
<a href="#l78.1048"></a><span id="l78.1048">           return status;</span>
<a href="#l78.1049"></a><span id="l78.1049">         }</span>
<a href="#l78.1050"></a><span id="l78.1050">       }</span>
<a href="#l78.1051"></a><span id="l78.1051">     }</span>
<a href="#l78.1052"></a><span id="l78.1052">   }</span>
<a href="#l78.1053"></a><span id="l78.1053"> </span>
<a href="#l78.1054"></a><span id="l78.1054">   mimeEmitterEndHeader(obj-&gt;options, obj);</span>
<a href="#l78.1055"></a><span id="l78.1055" class="difflineat">@@ -829,63 +719,61 @@ MimeMessage_write_headers_html (MimeObje</span>
<a href="#l78.1056"></a><span id="l78.1056">   //</span>
<a href="#l78.1057"></a><span id="l78.1057">   // if (obj-&gt;options-&gt;headers == MimeHeadersOnly)</span>
<a href="#l78.1058"></a><span id="l78.1058">   //   return -1;</span>
<a href="#l78.1059"></a><span id="l78.1059">   // else</span>
<a href="#l78.1060"></a><span id="l78.1060"> </span>
<a href="#l78.1061"></a><span id="l78.1061">   return 0;</span>
<a href="#l78.1062"></a><span id="l78.1062"> }</span>
<a href="#l78.1063"></a><span id="l78.1063"> </span>
<a href="#l78.1064"></a><span id="l78.1064" class="difflineminus">-static char *</span>
<a href="#l78.1065"></a><span id="l78.1065" class="difflineminus">-MimeMessage_partial_message_html(const char *data, void *closure,</span>
<a href="#l78.1066"></a><span id="l78.1066" class="difflineminus">-                                 MimeHeaders *headers)</span>
<a href="#l78.1067"></a><span id="l78.1067" class="difflineminus">-{</span>
<a href="#l78.1068"></a><span id="l78.1068" class="difflineplus">+static char *MimeMessage_partial_message_html(const char *data, void *closure,</span>
<a href="#l78.1069"></a><span id="l78.1069" class="difflineplus">+                                              MimeHeaders *headers) {</span>
<a href="#l78.1070"></a><span id="l78.1070">   MimeMessage *msg = (MimeMessage *)closure;</span>
<a href="#l78.1071"></a><span id="l78.1071">   nsAutoCString orig_url(data);</span>
<a href="#l78.1072"></a><span id="l78.1072">   char *uidl = MimeHeaders_get(headers, HEADER_X_UIDL, false, false);</span>
<a href="#l78.1073"></a><span id="l78.1073" class="difflineminus">-  char *msgId = MimeHeaders_get(headers, HEADER_MESSAGE_ID, false,</span>
<a href="#l78.1074"></a><span id="l78.1074" class="difflineminus">-                  false);</span>
<a href="#l78.1075"></a><span id="l78.1075" class="difflineplus">+  char *msgId = MimeHeaders_get(headers, HEADER_MESSAGE_ID, false, false);</span>
<a href="#l78.1076"></a><span id="l78.1076">   char *msgIdPtr = PL_strchr(msgId, '&lt;');</span>
<a href="#l78.1077"></a><span id="l78.1077"> </span>
<a href="#l78.1078"></a><span id="l78.1078">   int32_t pos = orig_url.Find(&quot;mailbox-message&quot;);</span>
<a href="#l78.1079"></a><span id="l78.1079" class="difflineminus">-  if (pos != -1)</span>
<a href="#l78.1080"></a><span id="l78.1080" class="difflineminus">-    orig_url.Cut(pos + 7, 8);</span>
<a href="#l78.1081"></a><span id="l78.1081" class="difflineplus">+  if (pos != -1) orig_url.Cut(pos + 7, 8);</span>
<a href="#l78.1082"></a><span id="l78.1082"> </span>
<a href="#l78.1083"></a><span id="l78.1083">   pos = orig_url.FindChar('#');</span>
<a href="#l78.1084"></a><span id="l78.1084" class="difflineminus">-  if (pos != -1)</span>
<a href="#l78.1085"></a><span id="l78.1085" class="difflineminus">-    orig_url.Replace(pos, 1, &quot;?number=&quot;, 8);</span>
<a href="#l78.1086"></a><span id="l78.1086" class="difflineplus">+  if (pos != -1) orig_url.Replace(pos, 1, &quot;?number=&quot;, 8);</span>
<a href="#l78.1087"></a><span id="l78.1087"> </span>
<a href="#l78.1088"></a><span id="l78.1088">   if (msgIdPtr)</span>
<a href="#l78.1089"></a><span id="l78.1089">     msgIdPtr++;</span>
<a href="#l78.1090"></a><span id="l78.1090">   else</span>
<a href="#l78.1091"></a><span id="l78.1091">     msgIdPtr = msgId;</span>
<a href="#l78.1092"></a><span id="l78.1092">   char *gtPtr = PL_strchr(msgIdPtr, '&gt;');</span>
<a href="#l78.1093"></a><span id="l78.1093" class="difflineminus">-  if (gtPtr)</span>
<a href="#l78.1094"></a><span id="l78.1094" class="difflineminus">-    *gtPtr = 0;</span>
<a href="#l78.1095"></a><span id="l78.1095" class="difflineplus">+  if (gtPtr) *gtPtr = 0;</span>
<a href="#l78.1096"></a><span id="l78.1096"> </span>
<a href="#l78.1097"></a><span id="l78.1097">   bool msgBaseTruncated = (msg-&gt;bodyLength &gt; MSG_LINEBREAK_LEN);</span>
<a href="#l78.1098"></a><span id="l78.1098"> </span>
<a href="#l78.1099"></a><span id="l78.1099">   nsCString partialMsgHtml;</span>
<a href="#l78.1100"></a><span id="l78.1100">   nsCString item;</span>
<a href="#l78.1101"></a><span id="l78.1101"> </span>
<a href="#l78.1102"></a><span id="l78.1102" class="difflineminus">-  partialMsgHtml.AppendLiteral(&quot;&lt;div style=\&quot;margin: 1em auto; border: 1px solid black; width: 80%\&quot;&gt;&quot;);</span>
<a href="#l78.1103"></a><span id="l78.1103" class="difflineminus">-  partialMsgHtml.AppendLiteral(&quot;&lt;div style=\&quot;margin: 5px; padding: 10px; border: 1px solid gray; font-weight: bold; text-align: center;\&quot;&gt;&quot;);</span>
<a href="#l78.1104"></a><span id="l78.1104" class="difflineplus">+  partialMsgHtml.AppendLiteral(</span>
<a href="#l78.1105"></a><span id="l78.1105" class="difflineplus">+      &quot;&lt;div style=\&quot;margin: 1em auto; border: 1px solid black; width: 80%\&quot;&gt;&quot;);</span>
<a href="#l78.1106"></a><span id="l78.1106" class="difflineplus">+  partialMsgHtml.AppendLiteral(</span>
<a href="#l78.1107"></a><span id="l78.1107" class="difflineplus">+      &quot;&lt;div style=\&quot;margin: 5px; padding: 10px; border: 1px solid gray; &quot;</span>
<a href="#l78.1108"></a><span id="l78.1108" class="difflineplus">+      &quot;font-weight: bold; text-align: center;\&quot;&gt;&quot;);</span>
<a href="#l78.1109"></a><span id="l78.1109"> </span>
<a href="#l78.1110"></a><span id="l78.1110">   partialMsgHtml.AppendLiteral(&quot;&lt;span style=\&quot;font-size: 120%;\&quot;&gt;&quot;);</span>
<a href="#l78.1111"></a><span id="l78.1111">   if (msgBaseTruncated)</span>
<a href="#l78.1112"></a><span id="l78.1112">     item.Adopt(MimeGetStringByName(u&quot;MIME_MSG_PARTIAL_TRUNCATED&quot;));</span>
<a href="#l78.1113"></a><span id="l78.1113">   else</span>
<a href="#l78.1114"></a><span id="l78.1114">     item.Adopt(MimeGetStringByName(u&quot;MIME_MSG_PARTIAL_NOT_DOWNLOADED&quot;));</span>
<a href="#l78.1115"></a><span id="l78.1115">   partialMsgHtml += item;</span>
<a href="#l78.1116"></a><span id="l78.1116">   partialMsgHtml.AppendLiteral(&quot;&lt;/span&gt;&lt;hr&gt;&quot;);</span>
<a href="#l78.1117"></a><span id="l78.1117"> </span>
<a href="#l78.1118"></a><span id="l78.1118">   if (msgBaseTruncated)</span>
<a href="#l78.1119"></a><span id="l78.1119">     item.Adopt(MimeGetStringByName(u&quot;MIME_MSG_PARTIAL_TRUNCATED_EXPLANATION&quot;));</span>
<a href="#l78.1120"></a><span id="l78.1120">   else</span>
<a href="#l78.1121"></a><span id="l78.1121" class="difflineminus">-    item.Adopt(MimeGetStringByName(u&quot;MIME_MSG_PARTIAL_NOT_DOWNLOADED_EXPLANATION&quot;));</span>
<a href="#l78.1122"></a><span id="l78.1122" class="difflineplus">+    item.Adopt(</span>
<a href="#l78.1123"></a><span id="l78.1123" class="difflineplus">+        MimeGetStringByName(u&quot;MIME_MSG_PARTIAL_NOT_DOWNLOADED_EXPLANATION&quot;));</span>
<a href="#l78.1124"></a><span id="l78.1124">   partialMsgHtml += item;</span>
<a href="#l78.1125"></a><span id="l78.1125">   partialMsgHtml.AppendLiteral(&quot;&lt;br&gt;&lt;br&gt;&quot;);</span>
<a href="#l78.1126"></a><span id="l78.1126"> </span>
<a href="#l78.1127"></a><span id="l78.1127">   partialMsgHtml.AppendLiteral(&quot;&lt;a href=\&quot;&quot;);</span>
<a href="#l78.1128"></a><span id="l78.1128">   partialMsgHtml.Append(orig_url);</span>
<a href="#l78.1129"></a><span id="l78.1129"> </span>
<a href="#l78.1130"></a><span id="l78.1130">   if (msgIdPtr) {</span>
<a href="#l78.1131"></a><span id="l78.1131">     partialMsgHtml.AppendLiteral(&quot;&amp;messageid=&quot;);</span>
<a href="#l78.1132"></a><span id="l78.1132" class="difflineat">@@ -894,83 +782,78 @@ MimeMessage_partial_message_html(const c</span>
<a href="#l78.1133"></a><span id="l78.1133">                     item);</span>
<a href="#l78.1134"></a><span id="l78.1134"> </span>
<a href="#l78.1135"></a><span id="l78.1135">     partialMsgHtml.Append(item);</span>
<a href="#l78.1136"></a><span id="l78.1136">   }</span>
<a href="#l78.1137"></a><span id="l78.1137"> </span>
<a href="#l78.1138"></a><span id="l78.1138">   if (uidl) {</span>
<a href="#l78.1139"></a><span id="l78.1139">     partialMsgHtml.AppendLiteral(&quot;&amp;uidl=&quot;);</span>
<a href="#l78.1140"></a><span id="l78.1140"> </span>
<a href="#l78.1141"></a><span id="l78.1141" class="difflineminus">-    MsgEscapeString(nsDependentCString(uidl), nsINetUtil::ESCAPE_XALPHAS,</span>
<a href="#l78.1142"></a><span id="l78.1142" class="difflineminus">-                    item);</span>
<a href="#l78.1143"></a><span id="l78.1143" class="difflineplus">+    MsgEscapeString(nsDependentCString(uidl), nsINetUtil::ESCAPE_XALPHAS, item);</span>
<a href="#l78.1144"></a><span id="l78.1144"> </span>
<a href="#l78.1145"></a><span id="l78.1145">     partialMsgHtml.Append(item);</span>
<a href="#l78.1146"></a><span id="l78.1146">   }</span>
<a href="#l78.1147"></a><span id="l78.1147"> </span>
<a href="#l78.1148"></a><span id="l78.1148">   partialMsgHtml.AppendLiteral(&quot;\&quot;&gt;&quot;);</span>
<a href="#l78.1149"></a><span id="l78.1149">   item.Adopt(MimeGetStringByName(u&quot;MIME_MSG_PARTIAL_CLICK_FOR_REST&quot;));</span>
<a href="#l78.1150"></a><span id="l78.1150">   partialMsgHtml += item;</span>
<a href="#l78.1151"></a><span id="l78.1151">   partialMsgHtml.AppendLiteral(&quot;&lt;/a&gt;&quot;);</span>
<a href="#l78.1152"></a><span id="l78.1152"> </span>
<a href="#l78.1153"></a><span id="l78.1153">   partialMsgHtml.AppendLiteral(&quot;&lt;/div&gt;&lt;/div&gt;&quot;);</span>
<a href="#l78.1154"></a><span id="l78.1154"> </span>
<a href="#l78.1155"></a><span id="l78.1155">   return ToNewCString(partialMsgHtml);</span>
<a href="#l78.1156"></a><span id="l78.1156"> }</span>
<a href="#l78.1157"></a><span id="l78.1157"> </span>
<a href="#l78.1158"></a><span id="l78.1158"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l78.1159"></a><span id="l78.1159" class="difflineminus">-static int</span>
<a href="#l78.1160"></a><span id="l78.1160" class="difflineminus">-MimeMessage_debug_print (MimeObject *obj, PRFileDesc *stream, int32_t depth)</span>
<a href="#l78.1161"></a><span id="l78.1161" class="difflineminus">-{</span>
<a href="#l78.1162"></a><span id="l78.1162" class="difflineminus">-  MimeMessage *msg = (MimeMessage *) obj;</span>
<a href="#l78.1163"></a><span id="l78.1163" class="difflineplus">+static int MimeMessage_debug_print(MimeObject *obj, PRFileDesc *stream,</span>
<a href="#l78.1164"></a><span id="l78.1164" class="difflineplus">+                                   int32_t depth) {</span>
<a href="#l78.1165"></a><span id="l78.1165" class="difflineplus">+  MimeMessage *msg = (MimeMessage *)obj;</span>
<a href="#l78.1166"></a><span id="l78.1166">   char *addr = mime_part_address(obj);</span>
<a href="#l78.1167"></a><span id="l78.1167">   int i;</span>
<a href="#l78.1168"></a><span id="l78.1168" class="difflineminus">-  for (i=0; i &lt; depth; i++)</span>
<a href="#l78.1169"></a><span id="l78.1169" class="difflineminus">-  PR_Write(stream, &quot;  &quot;, 2);</span>
<a href="#l78.1170"></a><span id="l78.1170" class="difflineminus">-/*</span>
<a href="#l78.1171"></a><span id="l78.1171" class="difflineminus">-  fprintf(stream, &quot;&lt;%s %s%s 0x%08X&gt;\n&quot;,</span>
<a href="#l78.1172"></a><span id="l78.1172" class="difflineminus">-      obj-&gt;clazz-&gt;class_name,</span>
<a href="#l78.1173"></a><span id="l78.1173" class="difflineminus">-      addr ? addr : &quot;???&quot;,</span>
<a href="#l78.1174"></a><span id="l78.1174" class="difflineminus">-      (msg-&gt;container.nchildren == 0 ? &quot; (no body)&quot; : &quot;&quot;),</span>
<a href="#l78.1175"></a><span id="l78.1175" class="difflineminus">-      (uint32_t) msg);</span>
<a href="#l78.1176"></a><span id="l78.1176" class="difflineminus">-*/</span>
<a href="#l78.1177"></a><span id="l78.1177" class="difflineplus">+  for (i = 0; i &lt; depth; i++) PR_Write(stream, &quot;  &quot;, 2);</span>
<a href="#l78.1178"></a><span id="l78.1178" class="difflineplus">+  /*</span>
<a href="#l78.1179"></a><span id="l78.1179" class="difflineplus">+    fprintf(stream, &quot;&lt;%s %s%s 0x%08X&gt;\n&quot;,</span>
<a href="#l78.1180"></a><span id="l78.1180" class="difflineplus">+        obj-&gt;clazz-&gt;class_name,</span>
<a href="#l78.1181"></a><span id="l78.1181" class="difflineplus">+        addr ? addr : &quot;???&quot;,</span>
<a href="#l78.1182"></a><span id="l78.1182" class="difflineplus">+        (msg-&gt;container.nchildren == 0 ? &quot; (no body)&quot; : &quot;&quot;),</span>
<a href="#l78.1183"></a><span id="l78.1183" class="difflineplus">+        (uint32_t) msg);</span>
<a href="#l78.1184"></a><span id="l78.1184" class="difflineplus">+  */</span>
<a href="#l78.1185"></a><span id="l78.1185">   PR_FREEIF(addr);</span>
<a href="#l78.1186"></a><span id="l78.1186"> </span>
<a href="#l78.1187"></a><span id="l78.1187" class="difflineminus">-#if 0</span>
<a href="#l78.1188"></a><span id="l78.1188" class="difflineplus">+#  if 0</span>
<a href="#l78.1189"></a><span id="l78.1189">   if (msg-&gt;hdrs)</span>
<a href="#l78.1190"></a><span id="l78.1190">   {</span>
<a href="#l78.1191"></a><span id="l78.1191">     char *s;</span>
<a href="#l78.1192"></a><span id="l78.1192"> </span>
<a href="#l78.1193"></a><span id="l78.1193">     depth++;</span>
<a href="#l78.1194"></a><span id="l78.1194"> </span>
<a href="#l78.1195"></a><span id="l78.1195" class="difflineminus">-# define DUMP(HEADER) \</span>
<a href="#l78.1196"></a><span id="l78.1196" class="difflineminus">-    for (i=0; i &lt; depth; i++)                        \</span>
<a href="#l78.1197"></a><span id="l78.1197" class="difflineminus">-        PR_Write(stream, &quot;  &quot;, 2);                        \</span>
<a href="#l78.1198"></a><span id="l78.1198" class="difflineminus">-    s = MimeHeaders_get (msg-&gt;hdrs, HEADER, false, true);</span>
<a href="#l78.1199"></a><span id="l78.1199" class="difflineplus">+#    define DUMP(HEADER)                                     \</span>
<a href="#l78.1200"></a><span id="l78.1200" class="difflineplus">+      for (i = 0; i &lt; depth; i++) PR_Write(stream, &quot;  &quot;, 2); \</span>
<a href="#l78.1201"></a><span id="l78.1201" class="difflineplus">+      s = MimeHeaders_get(msg-&gt;hdrs, HEADER, false, true);</span>
<a href="#l78.1202"></a><span id="l78.1202"> /**</span>
<a href="#l78.1203"></a><span id="l78.1203">     \</span>
<a href="#l78.1204"></a><span id="l78.1204">     PR_Write(stream, HEADER &quot;: %s\n&quot;, s ? s : &quot;&quot;);              \</span>
<a href="#l78.1205"></a><span id="l78.1205"> **/</span>
<a href="#l78.1206"></a><span id="l78.1206"> </span>
<a href="#l78.1207"></a><span id="l78.1207">     PR_FREEIF(s)</span>
<a href="#l78.1208"></a><span id="l78.1208"> </span>
<a href="#l78.1209"></a><span id="l78.1209">       DUMP(HEADER_SUBJECT);</span>
<a href="#l78.1210"></a><span id="l78.1210">       DUMP(HEADER_DATE);</span>
<a href="#l78.1211"></a><span id="l78.1211">       DUMP(HEADER_FROM);</span>
<a href="#l78.1212"></a><span id="l78.1212">       DUMP(HEADER_TO);</span>
<a href="#l78.1213"></a><span id="l78.1213">       /* DUMP(HEADER_CC); */</span>
<a href="#l78.1214"></a><span id="l78.1214">       DUMP(HEADER_NEWSGROUPS);</span>
<a href="#l78.1215"></a><span id="l78.1215">       DUMP(HEADER_MESSAGE_ID);</span>
<a href="#l78.1216"></a><span id="l78.1216" class="difflineminus">-# undef DUMP</span>
<a href="#l78.1217"></a><span id="l78.1217" class="difflineplus">+#    undef DUMP</span>
<a href="#l78.1218"></a><span id="l78.1218"> </span>
<a href="#l78.1219"></a><span id="l78.1219">     PR_Write(stream, &quot;\n&quot;, 1);</span>
<a href="#l78.1220"></a><span id="l78.1220">   }</span>
<a href="#l78.1221"></a><span id="l78.1221" class="difflineminus">-#endif</span>
<a href="#l78.1222"></a><span id="l78.1222" class="difflineplus">+#  endif</span>
<a href="#l78.1223"></a><span id="l78.1223"> </span>
<a href="#l78.1224"></a><span id="l78.1224">   PR_ASSERT(msg-&gt;container.nchildren &lt;= 1);</span>
<a href="#l78.1225"></a><span id="l78.1225" class="difflineminus">-  if (msg-&gt;container.nchildren == 1)</span>
<a href="#l78.1226"></a><span id="l78.1226" class="difflineminus">-  {</span>
<a href="#l78.1227"></a><span id="l78.1227" class="difflineplus">+  if (msg-&gt;container.nchildren == 1) {</span>
<a href="#l78.1228"></a><span id="l78.1228">     MimeObject *kid = msg-&gt;container.children[0];</span>
<a href="#l78.1229"></a><span id="l78.1229" class="difflineminus">-    int status = kid-&gt;clazz-&gt;debug_print (kid, stream, depth+1);</span>
<a href="#l78.1230"></a><span id="l78.1230" class="difflineplus">+    int status = kid-&gt;clazz-&gt;debug_print(kid, stream, depth + 1);</span>
<a href="#l78.1231"></a><span id="l78.1231">     if (status &lt; 0) return status;</span>
<a href="#l78.1232"></a><span id="l78.1232">   }</span>
<a href="#l78.1233"></a><span id="l78.1233">   return 0;</span>
<a href="#l78.1234"></a><span id="l78.1234"> }</span>
<a href="#l78.1235"></a><span id="l78.1235"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/mailnews/mime/src/mimemsg.h</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/mailnews/mime/src/mimemsg.h</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -8,36 +8,36 @@</span>
<a href="#l79.4"></a><span id="l79.4"> </span>
<a href="#l79.5"></a><span id="l79.5"> #include &quot;mimecont.h&quot;</span>
<a href="#l79.6"></a><span id="l79.6"> </span>
<a href="#l79.7"></a><span id="l79.7"> /* The MimeMessage class implements the message/rfc822 and message/news</span>
<a href="#l79.8"></a><span id="l79.8">    MIME containers, which is to say, mail and news messages.</span>
<a href="#l79.9"></a><span id="l79.9">  */</span>
<a href="#l79.10"></a><span id="l79.10"> </span>
<a href="#l79.11"></a><span id="l79.11"> typedef struct MimeMessageClass MimeMessageClass;</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-typedef struct MimeMessage      MimeMessage;</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineplus">+typedef struct MimeMessage MimeMessage;</span>
<a href="#l79.14"></a><span id="l79.14"> </span>
<a href="#l79.15"></a><span id="l79.15"> struct MimeMessageClass {</span>
<a href="#l79.16"></a><span id="l79.16">   MimeContainerClass container;</span>
<a href="#l79.17"></a><span id="l79.17"> };</span>
<a href="#l79.18"></a><span id="l79.18"> </span>
<a href="#l79.19"></a><span id="l79.19"> extern MimeMessageClass mimeMessageClass;</span>
<a href="#l79.20"></a><span id="l79.20"> </span>
<a href="#l79.21"></a><span id="l79.21"> struct MimeMessage {</span>
<a href="#l79.22"></a><span id="l79.22" class="difflineminus">-  MimeContainer container;    /* superclass variables */</span>
<a href="#l79.23"></a><span id="l79.23" class="difflineminus">-  MimeHeaders *hdrs;      /* headers of this message */</span>
<a href="#l79.24"></a><span id="l79.24" class="difflineminus">-  bool newline_p;      /* whether the last line ended in a newline */</span>
<a href="#l79.25"></a><span id="l79.25" class="difflineminus">-  bool crypto_stamped_p;    /* whether the header of this message has been</span>
<a href="#l79.26"></a><span id="l79.26" class="difflineminus">-                   emitted expecting its child to emit HTML</span>
<a href="#l79.27"></a><span id="l79.27" class="difflineminus">-                   which says that it is xlated. */</span>
<a href="#l79.28"></a><span id="l79.28" class="difflineplus">+  MimeContainer container; /* superclass variables */</span>
<a href="#l79.29"></a><span id="l79.29" class="difflineplus">+  MimeHeaders *hdrs;       /* headers of this message */</span>
<a href="#l79.30"></a><span id="l79.30" class="difflineplus">+  bool newline_p;          /* whether the last line ended in a newline */</span>
<a href="#l79.31"></a><span id="l79.31" class="difflineplus">+  bool crypto_stamped_p;   /* whether the header of this message has been</span>
<a href="#l79.32"></a><span id="l79.32" class="difflineplus">+                  emitted expecting its child to emit HTML</span>
<a href="#l79.33"></a><span id="l79.33" class="difflineplus">+                  which says that it is xlated. */</span>
<a href="#l79.34"></a><span id="l79.34"> </span>
<a href="#l79.35"></a><span id="l79.35" class="difflineminus">-  bool crypto_msg_signed_p;  /* What the emitted xlation-stamp *says*. */</span>
<a href="#l79.36"></a><span id="l79.36" class="difflineplus">+  bool crypto_msg_signed_p; /* What the emitted xlation-stamp *says*. */</span>
<a href="#l79.37"></a><span id="l79.37">   bool crypto_msg_encrypted_p;</span>
<a href="#l79.38"></a><span id="l79.38" class="difflineminus">-  bool grabSubject;  /* Should we try to grab the subject of this message */</span>
<a href="#l79.39"></a><span id="l79.39" class="difflineplus">+  bool grabSubject;   /* Should we try to grab the subject of this message */</span>
<a href="#l79.40"></a><span id="l79.40">   int32_t bodyLength; /* Used for determining if the body has been truncated */</span>
<a href="#l79.41"></a><span id="l79.41" class="difflineminus">-  int32_t sizeSoFar; /* The total size of the MIME message, once parsing is</span>
<a href="#l79.42"></a><span id="l79.42" class="difflineminus">-                        finished. */</span>
<a href="#l79.43"></a><span id="l79.43" class="difflineplus">+  int32_t sizeSoFar;  /* The total size of the MIME message, once parsing is</span>
<a href="#l79.44"></a><span id="l79.44" class="difflineplus">+                         finished. */</span>
<a href="#l79.45"></a><span id="l79.45"> };</span>
<a href="#l79.46"></a><span id="l79.46"> </span>
<a href="#l79.47"></a><span id="l79.47" class="difflineminus">-#define MimeMessageClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l79.48"></a><span id="l79.48" class="difflineminus">-  { MimeContainerClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l79.49"></a><span id="l79.49" class="difflineplus">+#define MimeMessageClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l79.50"></a><span id="l79.50" class="difflineplus">+  { MimeContainerClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l79.51"></a><span id="l79.51"> </span>
<a href="#l79.52"></a><span id="l79.52"> #endif /* _MIMEMSG_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/mailnews/mime/src/mimemsig.cpp</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/mailnews/mime/src/mimemsig.cpp</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -9,766 +9,696 @@</span>
<a href="#l80.4"></a><span id="l80.4"> </span>
<a href="#l80.5"></a><span id="l80.5"> #include &quot;prmem.h&quot;</span>
<a href="#l80.6"></a><span id="l80.6"> #include &quot;plstr.h&quot;</span>
<a href="#l80.7"></a><span id="l80.7"> #include &quot;prerror.h&quot;</span>
<a href="#l80.8"></a><span id="l80.8"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l80.9"></a><span id="l80.9"> #include &quot;msgCore.h&quot;</span>
<a href="#l80.10"></a><span id="l80.10"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l80.11"></a><span id="l80.11"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-#include &quot;modmimee.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+#include &quot;modmimee.h&quot;  // for MimeConverterOutputCallback</span>
<a href="#l80.14"></a><span id="l80.14"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l80.15"></a><span id="l80.15"> </span>
<a href="#l80.16"></a><span id="l80.16"> #define MIME_SUPERCLASS mimeMultipartClass</span>
<a href="#l80.17"></a><span id="l80.17"> MimeDefClass(MimeMultipartSigned, MimeMultipartSignedClass,</span>
<a href="#l80.18"></a><span id="l80.18" class="difflineminus">-       mimeMultipartSignedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l80.19"></a><span id="l80.19" class="difflineplus">+             mimeMultipartSignedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l80.20"></a><span id="l80.20"> </span>
<a href="#l80.21"></a><span id="l80.21" class="difflineminus">-static int MimeMultipartSigned_initialize (MimeObject *);</span>
<a href="#l80.22"></a><span id="l80.22" class="difflineminus">-static int MimeMultipartSigned_create_child (MimeObject *);</span>
<a href="#l80.23"></a><span id="l80.23" class="difflineplus">+static int MimeMultipartSigned_initialize(MimeObject *);</span>
<a href="#l80.24"></a><span id="l80.24" class="difflineplus">+static int MimeMultipartSigned_create_child(MimeObject *);</span>
<a href="#l80.25"></a><span id="l80.25"> static int MimeMultipartSigned_close_child(MimeObject *);</span>
<a href="#l80.26"></a><span id="l80.26" class="difflineminus">-static int MimeMultipartSigned_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l80.27"></a><span id="l80.27" class="difflineminus">-static int MimeMultipartSigned_parse_child_line (MimeObject *, const char *, int32_t,</span>
<a href="#l80.28"></a><span id="l80.28" class="difflineminus">-                         bool);</span>
<a href="#l80.29"></a><span id="l80.29" class="difflineminus">-static int MimeMultipartSigned_parse_eof (MimeObject *, bool);</span>
<a href="#l80.30"></a><span id="l80.30" class="difflineminus">-static void MimeMultipartSigned_finalize (MimeObject *);</span>
<a href="#l80.31"></a><span id="l80.31" class="difflineminus">-</span>
<a href="#l80.32"></a><span id="l80.32" class="difflineminus">-static int MimeMultipartSigned_emit_child (MimeObject *obj);</span>
<a href="#l80.33"></a><span id="l80.33" class="difflineplus">+static int MimeMultipartSigned_parse_line(const char *, int32_t, MimeObject *);</span>
<a href="#l80.34"></a><span id="l80.34" class="difflineplus">+static int MimeMultipartSigned_parse_child_line(MimeObject *, const char *,</span>
<a href="#l80.35"></a><span id="l80.35" class="difflineplus">+                                                int32_t, bool);</span>
<a href="#l80.36"></a><span id="l80.36" class="difflineplus">+static int MimeMultipartSigned_parse_eof(MimeObject *, bool);</span>
<a href="#l80.37"></a><span id="l80.37" class="difflineplus">+static void MimeMultipartSigned_finalize(MimeObject *);</span>
<a href="#l80.38"></a><span id="l80.38"> </span>
<a href="#l80.39"></a><span id="l80.39" class="difflineminus">-static int</span>
<a href="#l80.40"></a><span id="l80.40" class="difflineminus">-MimeMultipartSignedClassInitialize(MimeMultipartSignedClass *clazz)</span>
<a href="#l80.41"></a><span id="l80.41" class="difflineminus">-{</span>
<a href="#l80.42"></a><span id="l80.42" class="difflineminus">-  MimeObjectClass    *oclass = (MimeObjectClass *)    clazz;</span>
<a href="#l80.43"></a><span id="l80.43" class="difflineminus">-  MimeMultipartClass *mclass = (MimeMultipartClass *) clazz;</span>
<a href="#l80.44"></a><span id="l80.44" class="difflineplus">+static int MimeMultipartSigned_emit_child(MimeObject *obj);</span>
<a href="#l80.45"></a><span id="l80.45" class="difflineplus">+</span>
<a href="#l80.46"></a><span id="l80.46" class="difflineplus">+static int MimeMultipartSignedClassInitialize(MimeMultipartSignedClass *clazz) {</span>
<a href="#l80.47"></a><span id="l80.47" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l80.48"></a><span id="l80.48" class="difflineplus">+  MimeMultipartClass *mclass = (MimeMultipartClass *)clazz;</span>
<a href="#l80.49"></a><span id="l80.49"> </span>
<a href="#l80.50"></a><span id="l80.50" class="difflineminus">-  oclass-&gt;initialize       = MimeMultipartSigned_initialize;</span>
<a href="#l80.51"></a><span id="l80.51" class="difflineminus">-  oclass-&gt;parse_line       = MimeMultipartSigned_parse_line;</span>
<a href="#l80.52"></a><span id="l80.52" class="difflineminus">-  oclass-&gt;parse_eof        = MimeMultipartSigned_parse_eof;</span>
<a href="#l80.53"></a><span id="l80.53" class="difflineminus">-  oclass-&gt;finalize         = MimeMultipartSigned_finalize;</span>
<a href="#l80.54"></a><span id="l80.54" class="difflineminus">-  mclass-&gt;create_child     = MimeMultipartSigned_create_child;</span>
<a href="#l80.55"></a><span id="l80.55" class="difflineplus">+  oclass-&gt;initialize = MimeMultipartSigned_initialize;</span>
<a href="#l80.56"></a><span id="l80.56" class="difflineplus">+  oclass-&gt;parse_line = MimeMultipartSigned_parse_line;</span>
<a href="#l80.57"></a><span id="l80.57" class="difflineplus">+  oclass-&gt;parse_eof = MimeMultipartSigned_parse_eof;</span>
<a href="#l80.58"></a><span id="l80.58" class="difflineplus">+  oclass-&gt;finalize = MimeMultipartSigned_finalize;</span>
<a href="#l80.59"></a><span id="l80.59" class="difflineplus">+  mclass-&gt;create_child = MimeMultipartSigned_create_child;</span>
<a href="#l80.60"></a><span id="l80.60">   mclass-&gt;parse_child_line = MimeMultipartSigned_parse_child_line;</span>
<a href="#l80.61"></a><span id="l80.61" class="difflineminus">-  mclass-&gt;close_child      = MimeMultipartSigned_close_child;</span>
<a href="#l80.62"></a><span id="l80.62" class="difflineplus">+  mclass-&gt;close_child = MimeMultipartSigned_close_child;</span>
<a href="#l80.63"></a><span id="l80.63"> </span>
<a href="#l80.64"></a><span id="l80.64">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l80.65"></a><span id="l80.65">   return 0;</span>
<a href="#l80.66"></a><span id="l80.66"> }</span>
<a href="#l80.67"></a><span id="l80.67"> </span>
<a href="#l80.68"></a><span id="l80.68" class="difflineminus">-static int</span>
<a href="#l80.69"></a><span id="l80.69" class="difflineminus">-MimeMultipartSigned_initialize (MimeObject *object)</span>
<a href="#l80.70"></a><span id="l80.70" class="difflineminus">-{</span>
<a href="#l80.71"></a><span id="l80.71" class="difflineminus">-  MimeMultipartSigned *sig = (MimeMultipartSigned *) object;</span>
<a href="#l80.72"></a><span id="l80.72" class="difflineplus">+static int MimeMultipartSigned_initialize(MimeObject *object) {</span>
<a href="#l80.73"></a><span id="l80.73" class="difflineplus">+  MimeMultipartSigned *sig = (MimeMultipartSigned *)object;</span>
<a href="#l80.74"></a><span id="l80.74"> </span>
<a href="#l80.75"></a><span id="l80.75">   /* This is an abstract class; it shouldn't be directly instantiated. */</span>
<a href="#l80.76"></a><span id="l80.76" class="difflineminus">-  PR_ASSERT(object-&gt;clazz != (MimeObjectClass *) &amp;mimeMultipartSignedClass);</span>
<a href="#l80.77"></a><span id="l80.77" class="difflineplus">+  PR_ASSERT(object-&gt;clazz != (MimeObjectClass *)&amp;mimeMultipartSignedClass);</span>
<a href="#l80.78"></a><span id="l80.78"> </span>
<a href="#l80.79"></a><span id="l80.79">   sig-&gt;state = MimeMultipartSignedPreamble;</span>
<a href="#l80.80"></a><span id="l80.80"> </span>
<a href="#l80.81"></a><span id="l80.81" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l80.82"></a><span id="l80.82" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l80.83"></a><span id="l80.83"> }</span>
<a href="#l80.84"></a><span id="l80.84"> </span>
<a href="#l80.85"></a><span id="l80.85" class="difflineminus">-static void</span>
<a href="#l80.86"></a><span id="l80.86" class="difflineminus">-MimeMultipartSigned_cleanup (MimeObject *obj, bool finalizing_p)</span>
<a href="#l80.87"></a><span id="l80.87" class="difflineminus">-{</span>
<a href="#l80.88"></a><span id="l80.88" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) obj; /* #58075.  Fix suggested by jwz */</span>
<a href="#l80.89"></a><span id="l80.89" class="difflineminus">-  MimeMultipartSigned *sig = (MimeMultipartSigned *) obj;</span>
<a href="#l80.90"></a><span id="l80.90" class="difflineminus">-  if (sig-&gt;part_buffer)</span>
<a href="#l80.91"></a><span id="l80.91" class="difflineminus">-  {</span>
<a href="#l80.92"></a><span id="l80.92" class="difflineplus">+static void MimeMultipartSigned_cleanup(MimeObject *obj, bool finalizing_p) {</span>
<a href="#l80.93"></a><span id="l80.93" class="difflineplus">+  MimeMultipart *mult =</span>
<a href="#l80.94"></a><span id="l80.94" class="difflineplus">+      (MimeMultipart *)obj; /* #58075.  Fix suggested by jwz */</span>
<a href="#l80.95"></a><span id="l80.95" class="difflineplus">+  MimeMultipartSigned *sig = (MimeMultipartSigned *)obj;</span>
<a href="#l80.96"></a><span id="l80.96" class="difflineplus">+  if (sig-&gt;part_buffer) {</span>
<a href="#l80.97"></a><span id="l80.97">     MimePartBufferDestroy(sig-&gt;part_buffer);</span>
<a href="#l80.98"></a><span id="l80.98">     sig-&gt;part_buffer = 0;</span>
<a href="#l80.99"></a><span id="l80.99">   }</span>
<a href="#l80.100"></a><span id="l80.100" class="difflineminus">-  if (sig-&gt;body_hdrs)</span>
<a href="#l80.101"></a><span id="l80.101" class="difflineminus">-  {</span>
<a href="#l80.102"></a><span id="l80.102" class="difflineminus">-    MimeHeaders_free (sig-&gt;body_hdrs);</span>
<a href="#l80.103"></a><span id="l80.103" class="difflineplus">+  if (sig-&gt;body_hdrs) {</span>
<a href="#l80.104"></a><span id="l80.104" class="difflineplus">+    MimeHeaders_free(sig-&gt;body_hdrs);</span>
<a href="#l80.105"></a><span id="l80.105">     sig-&gt;body_hdrs = 0;</span>
<a href="#l80.106"></a><span id="l80.106">   }</span>
<a href="#l80.107"></a><span id="l80.107" class="difflineminus">-  if (sig-&gt;sig_hdrs)</span>
<a href="#l80.108"></a><span id="l80.108" class="difflineminus">-  {</span>
<a href="#l80.109"></a><span id="l80.109" class="difflineminus">-    MimeHeaders_free (sig-&gt;sig_hdrs);</span>
<a href="#l80.110"></a><span id="l80.110" class="difflineplus">+  if (sig-&gt;sig_hdrs) {</span>
<a href="#l80.111"></a><span id="l80.111" class="difflineplus">+    MimeHeaders_free(sig-&gt;sig_hdrs);</span>
<a href="#l80.112"></a><span id="l80.112">     sig-&gt;sig_hdrs = 0;</span>
<a href="#l80.113"></a><span id="l80.113">   }</span>
<a href="#l80.114"></a><span id="l80.114"> </span>
<a href="#l80.115"></a><span id="l80.115" class="difflineminus">-  mult-&gt;state = MimeMultipartEpilogue;  /* #58075.  Fix suggested by jwz */</span>
<a href="#l80.116"></a><span id="l80.116" class="difflineplus">+  mult-&gt;state = MimeMultipartEpilogue; /* #58075.  Fix suggested by jwz */</span>
<a href="#l80.117"></a><span id="l80.117">   sig-&gt;state = MimeMultipartSignedEpilogue;</span>
<a href="#l80.118"></a><span id="l80.118"> </span>
<a href="#l80.119"></a><span id="l80.119">   if (finalizing_p &amp;&amp; sig-&gt;crypto_closure) {</span>
<a href="#l80.120"></a><span id="l80.120">     /* Don't free these until this object is really going away -- keep them</span>
<a href="#l80.121"></a><span id="l80.121">        around for the lifetime of the MIME object, so that we can get at the</span>
<a href="#l80.122"></a><span id="l80.122">        security info of sub-parts of the currently-displayed message. */</span>
<a href="#l80.123"></a><span id="l80.123" class="difflineminus">-    ((MimeMultipartSignedClass *) obj-&gt;clazz)-&gt;crypto_free (sig-&gt;crypto_closure);</span>
<a href="#l80.124"></a><span id="l80.124" class="difflineminus">-     sig-&gt;crypto_closure = 0;</span>
<a href="#l80.125"></a><span id="l80.125" class="difflineplus">+    ((MimeMultipartSignedClass *)obj-&gt;clazz)-&gt;crypto_free(sig-&gt;crypto_closure);</span>
<a href="#l80.126"></a><span id="l80.126" class="difflineplus">+    sig-&gt;crypto_closure = 0;</span>
<a href="#l80.127"></a><span id="l80.127">   }</span>
<a href="#l80.128"></a><span id="l80.128"> </span>
<a href="#l80.129"></a><span id="l80.129" class="difflineminus">-  if (sig-&gt;sig_decoder_data)</span>
<a href="#l80.130"></a><span id="l80.130" class="difflineminus">-  {</span>
<a href="#l80.131"></a><span id="l80.131" class="difflineplus">+  if (sig-&gt;sig_decoder_data) {</span>
<a href="#l80.132"></a><span id="l80.132">     MimeDecoderDestroy(sig-&gt;sig_decoder_data, true);</span>
<a href="#l80.133"></a><span id="l80.133">     sig-&gt;sig_decoder_data = 0;</span>
<a href="#l80.134"></a><span id="l80.134">   }</span>
<a href="#l80.135"></a><span id="l80.135"> }</span>
<a href="#l80.136"></a><span id="l80.136"> </span>
<a href="#l80.137"></a><span id="l80.137" class="difflineminus">-static int</span>
<a href="#l80.138"></a><span id="l80.138" class="difflineminus">-MimeMultipartSigned_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l80.139"></a><span id="l80.139" class="difflineminus">-{</span>
<a href="#l80.140"></a><span id="l80.140" class="difflineminus">-  MimeMultipartSigned *sig = (MimeMultipartSigned *) obj;</span>
<a href="#l80.141"></a><span id="l80.141" class="difflineplus">+static int MimeMultipartSigned_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l80.142"></a><span id="l80.142" class="difflineplus">+  MimeMultipartSigned *sig = (MimeMultipartSigned *)obj;</span>
<a href="#l80.143"></a><span id="l80.143">   int status = 0;</span>
<a href="#l80.144"></a><span id="l80.144"> </span>
<a href="#l80.145"></a><span id="l80.145">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l80.146"></a><span id="l80.146"> </span>
<a href="#l80.147"></a><span id="l80.147">   /* Close off the signature, if we've gotten that far.</span>
<a href="#l80.148"></a><span id="l80.148">    */</span>
<a href="#l80.149"></a><span id="l80.149">   if (sig-&gt;state == MimeMultipartSignedSignatureHeaders ||</span>
<a href="#l80.150"></a><span id="l80.150" class="difflineminus">-    sig-&gt;state == MimeMultipartSignedSignatureFirstLine ||</span>
<a href="#l80.151"></a><span id="l80.151" class="difflineminus">-    sig-&gt;state == MimeMultipartSignedSignatureLine ||</span>
<a href="#l80.152"></a><span id="l80.152" class="difflineminus">-    sig-&gt;state == MimeMultipartSignedEpilogue)</span>
<a href="#l80.153"></a><span id="l80.153" class="difflineminus">-  {</span>
<a href="#l80.154"></a><span id="l80.154" class="difflineminus">-    status = (((MimeMultipartSignedClass *) obj-&gt;clazz)-&gt;crypto_signature_eof) (sig-&gt;crypto_closure, abort_p);</span>
<a href="#l80.155"></a><span id="l80.155" class="difflineplus">+      sig-&gt;state == MimeMultipartSignedSignatureFirstLine ||</span>
<a href="#l80.156"></a><span id="l80.156" class="difflineplus">+      sig-&gt;state == MimeMultipartSignedSignatureLine ||</span>
<a href="#l80.157"></a><span id="l80.157" class="difflineplus">+      sig-&gt;state == MimeMultipartSignedEpilogue) {</span>
<a href="#l80.158"></a><span id="l80.158" class="difflineplus">+    status = (((MimeMultipartSignedClass *)obj-&gt;clazz)-&gt;crypto_signature_eof)(</span>
<a href="#l80.159"></a><span id="l80.159" class="difflineplus">+        sig-&gt;crypto_closure, abort_p);</span>
<a href="#l80.160"></a><span id="l80.160">     if (status &lt; 0) return status;</span>
<a href="#l80.161"></a><span id="l80.161">   }</span>
<a href="#l80.162"></a><span id="l80.162"> </span>
<a href="#l80.163"></a><span id="l80.163" class="difflineminus">-  if (!abort_p)</span>
<a href="#l80.164"></a><span id="l80.164" class="difflineminus">-  {</span>
<a href="#l80.165"></a><span id="l80.165" class="difflineplus">+  if (!abort_p) {</span>
<a href="#l80.166"></a><span id="l80.166">     /* Now that we've read both the signed object and the signature (and</span>
<a href="#l80.167"></a><span id="l80.167">      have presumably verified the signature) write out a blurb, and then</span>
<a href="#l80.168"></a><span id="l80.168">      the signed object.</span>
<a href="#l80.169"></a><span id="l80.169">      */</span>
<a href="#l80.170"></a><span id="l80.170">     status = MimeMultipartSigned_emit_child(obj);</span>
<a href="#l80.171"></a><span id="l80.171">     if (status &lt; 0) return status;</span>
<a href="#l80.172"></a><span id="l80.172">   }</span>
<a href="#l80.173"></a><span id="l80.173"> </span>
<a href="#l80.174"></a><span id="l80.174">   MimeMultipartSigned_cleanup(obj, false);</span>
<a href="#l80.175"></a><span id="l80.175" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l80.176"></a><span id="l80.176" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l80.177"></a><span id="l80.177"> }</span>
<a href="#l80.178"></a><span id="l80.178"> </span>
<a href="#l80.179"></a><span id="l80.179" class="difflineminus">-</span>
<a href="#l80.180"></a><span id="l80.180" class="difflineminus">-static void</span>
<a href="#l80.181"></a><span id="l80.181" class="difflineminus">-MimeMultipartSigned_finalize (MimeObject *obj)</span>
<a href="#l80.182"></a><span id="l80.182" class="difflineminus">-{</span>
<a href="#l80.183"></a><span id="l80.183" class="difflineplus">+static void MimeMultipartSigned_finalize(MimeObject *obj) {</span>
<a href="#l80.184"></a><span id="l80.184">   MimeMultipartSigned_cleanup(obj, true);</span>
<a href="#l80.185"></a><span id="l80.185" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l80.186"></a><span id="l80.186" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l80.187"></a><span id="l80.187"> }</span>
<a href="#l80.188"></a><span id="l80.188"> </span>
<a href="#l80.189"></a><span id="l80.189" class="difflineminus">-</span>
<a href="#l80.190"></a><span id="l80.190" class="difflineminus">-static int</span>
<a href="#l80.191"></a><span id="l80.191" class="difflineminus">-MimeMultipartSigned_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l80.192"></a><span id="l80.192" class="difflineminus">-{</span>
<a href="#l80.193"></a><span id="l80.193" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) obj;</span>
<a href="#l80.194"></a><span id="l80.194" class="difflineminus">-  MimeMultipartSigned *sig = (MimeMultipartSigned *) obj;</span>
<a href="#l80.195"></a><span id="l80.195" class="difflineplus">+static int MimeMultipartSigned_parse_line(const char *line, int32_t length,</span>
<a href="#l80.196"></a><span id="l80.196" class="difflineplus">+                                          MimeObject *obj) {</span>
<a href="#l80.197"></a><span id="l80.197" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)obj;</span>
<a href="#l80.198"></a><span id="l80.198" class="difflineplus">+  MimeMultipartSigned *sig = (MimeMultipartSigned *)obj;</span>
<a href="#l80.199"></a><span id="l80.199">   MimeMultipartParseState old_state = mult-&gt;state;</span>
<a href="#l80.200"></a><span id="l80.200">   bool hash_line_p = true;</span>
<a href="#l80.201"></a><span id="l80.201">   bool no_headers_p = false;</span>
<a href="#l80.202"></a><span id="l80.202">   int status = 0;</span>
<a href="#l80.203"></a><span id="l80.203"> </span>
<a href="#l80.204"></a><span id="l80.204">   /* First do the parsing for normal multipart/ objects by handing it off to</span>
<a href="#l80.205"></a><span id="l80.205">    the superclass method.  This includes calling the create_child and</span>
<a href="#l80.206"></a><span id="l80.206">    close_child methods.</span>
<a href="#l80.207"></a><span id="l80.207">    */</span>
<a href="#l80.208"></a><span id="l80.208" class="difflineminus">-  status = (((MimeObjectClass *)(&amp;MIME_SUPERCLASS))</span>
<a href="#l80.209"></a><span id="l80.209" class="difflineminus">-      -&gt;parse_line (line, length, obj));</span>
<a href="#l80.210"></a><span id="l80.210" class="difflineplus">+  status =</span>
<a href="#l80.211"></a><span id="l80.211" class="difflineplus">+      (((MimeObjectClass *)(&amp;MIME_SUPERCLASS))-&gt;parse_line(line, length, obj));</span>
<a href="#l80.212"></a><span id="l80.212">   if (status &lt; 0) return status;</span>
<a href="#l80.213"></a><span id="l80.213"> </span>
<a href="#l80.214"></a><span id="l80.214">   /* The instance variable MimeMultipartClass-&gt;state tracks motion through</span>
<a href="#l80.215"></a><span id="l80.215">    the various stages of multipart/ parsing.  The instance variable</span>
<a href="#l80.216"></a><span id="l80.216">    MimeMultipartSigned-&gt;state tracks the difference between the first</span>
<a href="#l80.217"></a><span id="l80.217">    part (the body) and the second part (the signature.)  This second,</span>
<a href="#l80.218"></a><span id="l80.218">    more specific state variable is updated by noticing the transitions</span>
<a href="#l80.219"></a><span id="l80.219">    of the first, more general state variable.</span>
<a href="#l80.220"></a><span id="l80.220">    */</span>
<a href="#l80.221"></a><span id="l80.221" class="difflineminus">-  if (old_state != mult-&gt;state)  /* there has been a state change */</span>
<a href="#l80.222"></a><span id="l80.222" class="difflineplus">+  if (old_state != mult-&gt;state) /* there has been a state change */</span>
<a href="#l80.223"></a><span id="l80.223">   {</span>
<a href="#l80.224"></a><span id="l80.224" class="difflineminus">-    switch (mult-&gt;state)</span>
<a href="#l80.225"></a><span id="l80.225" class="difflineminus">-    {</span>
<a href="#l80.226"></a><span id="l80.226" class="difflineminus">-    case MimeMultipartPreamble:</span>
<a href="#l80.227"></a><span id="l80.227" class="difflineminus">-      PR_ASSERT(0);  /* can't move *in* to preamble state. */</span>
<a href="#l80.228"></a><span id="l80.228" class="difflineminus">-      sig-&gt;state = MimeMultipartSignedPreamble;</span>
<a href="#l80.229"></a><span id="l80.229" class="difflineminus">-      break;</span>
<a href="#l80.230"></a><span id="l80.230" class="difflineplus">+    switch (mult-&gt;state) {</span>
<a href="#l80.231"></a><span id="l80.231" class="difflineplus">+      case MimeMultipartPreamble:</span>
<a href="#l80.232"></a><span id="l80.232" class="difflineplus">+        PR_ASSERT(0); /* can't move *in* to preamble state. */</span>
<a href="#l80.233"></a><span id="l80.233" class="difflineplus">+        sig-&gt;state = MimeMultipartSignedPreamble;</span>
<a href="#l80.234"></a><span id="l80.234" class="difflineplus">+        break;</span>
<a href="#l80.235"></a><span id="l80.235"> </span>
<a href="#l80.236"></a><span id="l80.236" class="difflineminus">-    case MimeMultipartHeaders:</span>
<a href="#l80.237"></a><span id="l80.237" class="difflineminus">-      /* If we're moving in to the Headers state, then that means</span>
<a href="#l80.238"></a><span id="l80.238" class="difflineminus">-       that this line is the preceding boundary string (and we</span>
<a href="#l80.239"></a><span id="l80.239" class="difflineminus">-       should ignore it.)</span>
<a href="#l80.240"></a><span id="l80.240" class="difflineminus">-       */</span>
<a href="#l80.241"></a><span id="l80.241" class="difflineminus">-      hash_line_p = false;</span>
<a href="#l80.242"></a><span id="l80.242" class="difflineplus">+      case MimeMultipartHeaders:</span>
<a href="#l80.243"></a><span id="l80.243" class="difflineplus">+        /* If we're moving in to the Headers state, then that means</span>
<a href="#l80.244"></a><span id="l80.244" class="difflineplus">+         that this line is the preceding boundary string (and we</span>
<a href="#l80.245"></a><span id="l80.245" class="difflineplus">+         should ignore it.)</span>
<a href="#l80.246"></a><span id="l80.246" class="difflineplus">+         */</span>
<a href="#l80.247"></a><span id="l80.247" class="difflineplus">+        hash_line_p = false;</span>
<a href="#l80.248"></a><span id="l80.248"> </span>
<a href="#l80.249"></a><span id="l80.249" class="difflineminus">-      if (sig-&gt;state == MimeMultipartSignedPreamble)</span>
<a href="#l80.250"></a><span id="l80.250" class="difflineminus">-      sig-&gt;state = MimeMultipartSignedBodyFirstHeader;</span>
<a href="#l80.251"></a><span id="l80.251" class="difflineminus">-      else if (sig-&gt;state == MimeMultipartSignedBodyFirstLine ||</span>
<a href="#l80.252"></a><span id="l80.252" class="difflineminus">-           sig-&gt;state == MimeMultipartSignedBodyLine)</span>
<a href="#l80.253"></a><span id="l80.253" class="difflineminus">-      sig-&gt;state = MimeMultipartSignedSignatureHeaders;</span>
<a href="#l80.254"></a><span id="l80.254" class="difflineminus">-      else if (sig-&gt;state == MimeMultipartSignedSignatureFirstLine ||</span>
<a href="#l80.255"></a><span id="l80.255" class="difflineminus">-           sig-&gt;state == MimeMultipartSignedSignatureLine)</span>
<a href="#l80.256"></a><span id="l80.256" class="difflineminus">-      sig-&gt;state = MimeMultipartSignedEpilogue;</span>
<a href="#l80.257"></a><span id="l80.257" class="difflineminus">-      break;</span>
<a href="#l80.258"></a><span id="l80.258" class="difflineplus">+        if (sig-&gt;state == MimeMultipartSignedPreamble)</span>
<a href="#l80.259"></a><span id="l80.259" class="difflineplus">+          sig-&gt;state = MimeMultipartSignedBodyFirstHeader;</span>
<a href="#l80.260"></a><span id="l80.260" class="difflineplus">+        else if (sig-&gt;state == MimeMultipartSignedBodyFirstLine ||</span>
<a href="#l80.261"></a><span id="l80.261" class="difflineplus">+                 sig-&gt;state == MimeMultipartSignedBodyLine)</span>
<a href="#l80.262"></a><span id="l80.262" class="difflineplus">+          sig-&gt;state = MimeMultipartSignedSignatureHeaders;</span>
<a href="#l80.263"></a><span id="l80.263" class="difflineplus">+        else if (sig-&gt;state == MimeMultipartSignedSignatureFirstLine ||</span>
<a href="#l80.264"></a><span id="l80.264" class="difflineplus">+                 sig-&gt;state == MimeMultipartSignedSignatureLine)</span>
<a href="#l80.265"></a><span id="l80.265" class="difflineplus">+          sig-&gt;state = MimeMultipartSignedEpilogue;</span>
<a href="#l80.266"></a><span id="l80.266" class="difflineplus">+        break;</span>
<a href="#l80.267"></a><span id="l80.267"> </span>
<a href="#l80.268"></a><span id="l80.268" class="difflineminus">-    case MimeMultipartPartFirstLine:</span>
<a href="#l80.269"></a><span id="l80.269" class="difflineminus">-      if (sig-&gt;state == MimeMultipartSignedBodyFirstHeader)</span>
<a href="#l80.270"></a><span id="l80.270" class="difflineminus">-      {</span>
<a href="#l80.271"></a><span id="l80.271" class="difflineminus">-        sig-&gt;state = MimeMultipartSignedBodyFirstLine;</span>
<a href="#l80.272"></a><span id="l80.272" class="difflineminus">-        no_headers_p = true;</span>
<a href="#l80.273"></a><span id="l80.273" class="difflineminus">-      }</span>
<a href="#l80.274"></a><span id="l80.274" class="difflineminus">-      else if (sig-&gt;state == MimeMultipartSignedBodyHeaders)</span>
<a href="#l80.275"></a><span id="l80.275" class="difflineminus">-      sig-&gt;state = MimeMultipartSignedBodyFirstLine;</span>
<a href="#l80.276"></a><span id="l80.276" class="difflineminus">-      else if (sig-&gt;state == MimeMultipartSignedSignatureHeaders)</span>
<a href="#l80.277"></a><span id="l80.277" class="difflineminus">-      sig-&gt;state = MimeMultipartSignedSignatureFirstLine;</span>
<a href="#l80.278"></a><span id="l80.278" class="difflineminus">-      else</span>
<a href="#l80.279"></a><span id="l80.279" class="difflineminus">-      sig-&gt;state = MimeMultipartSignedEpilogue;</span>
<a href="#l80.280"></a><span id="l80.280" class="difflineminus">-      break;</span>
<a href="#l80.281"></a><span id="l80.281" class="difflineplus">+      case MimeMultipartPartFirstLine:</span>
<a href="#l80.282"></a><span id="l80.282" class="difflineplus">+        if (sig-&gt;state == MimeMultipartSignedBodyFirstHeader) {</span>
<a href="#l80.283"></a><span id="l80.283" class="difflineplus">+          sig-&gt;state = MimeMultipartSignedBodyFirstLine;</span>
<a href="#l80.284"></a><span id="l80.284" class="difflineplus">+          no_headers_p = true;</span>
<a href="#l80.285"></a><span id="l80.285" class="difflineplus">+        } else if (sig-&gt;state == MimeMultipartSignedBodyHeaders)</span>
<a href="#l80.286"></a><span id="l80.286" class="difflineplus">+          sig-&gt;state = MimeMultipartSignedBodyFirstLine;</span>
<a href="#l80.287"></a><span id="l80.287" class="difflineplus">+        else if (sig-&gt;state == MimeMultipartSignedSignatureHeaders)</span>
<a href="#l80.288"></a><span id="l80.288" class="difflineplus">+          sig-&gt;state = MimeMultipartSignedSignatureFirstLine;</span>
<a href="#l80.289"></a><span id="l80.289" class="difflineplus">+        else</span>
<a href="#l80.290"></a><span id="l80.290" class="difflineplus">+          sig-&gt;state = MimeMultipartSignedEpilogue;</span>
<a href="#l80.291"></a><span id="l80.291" class="difflineplus">+        break;</span>
<a href="#l80.292"></a><span id="l80.292"> </span>
<a href="#l80.293"></a><span id="l80.293" class="difflineminus">-    case MimeMultipartPartLine:</span>
<a href="#l80.294"></a><span id="l80.294" class="difflineplus">+      case MimeMultipartPartLine:</span>
<a href="#l80.295"></a><span id="l80.295"> </span>
<a href="#l80.296"></a><span id="l80.296" class="difflineminus">-      PR_ASSERT(sig-&gt;state == MimeMultipartSignedBodyFirstLine ||</span>
<a href="#l80.297"></a><span id="l80.297" class="difflineminus">-          sig-&gt;state == MimeMultipartSignedBodyLine ||</span>
<a href="#l80.298"></a><span id="l80.298" class="difflineminus">-          sig-&gt;state == MimeMultipartSignedSignatureFirstLine ||</span>
<a href="#l80.299"></a><span id="l80.299" class="difflineminus">-          sig-&gt;state == MimeMultipartSignedSignatureLine);</span>
<a href="#l80.300"></a><span id="l80.300" class="difflineplus">+        PR_ASSERT(sig-&gt;state == MimeMultipartSignedBodyFirstLine ||</span>
<a href="#l80.301"></a><span id="l80.301" class="difflineplus">+                  sig-&gt;state == MimeMultipartSignedBodyLine ||</span>
<a href="#l80.302"></a><span id="l80.302" class="difflineplus">+                  sig-&gt;state == MimeMultipartSignedSignatureFirstLine ||</span>
<a href="#l80.303"></a><span id="l80.303" class="difflineplus">+                  sig-&gt;state == MimeMultipartSignedSignatureLine);</span>
<a href="#l80.304"></a><span id="l80.304"> </span>
<a href="#l80.305"></a><span id="l80.305" class="difflineminus">-      if (sig-&gt;state == MimeMultipartSignedBodyFirstLine)</span>
<a href="#l80.306"></a><span id="l80.306" class="difflineminus">-      sig-&gt;state = MimeMultipartSignedBodyLine;</span>
<a href="#l80.307"></a><span id="l80.307" class="difflineminus">-      else if (sig-&gt;state == MimeMultipartSignedSignatureFirstLine)</span>
<a href="#l80.308"></a><span id="l80.308" class="difflineminus">-      sig-&gt;state = MimeMultipartSignedSignatureLine;</span>
<a href="#l80.309"></a><span id="l80.309" class="difflineminus">-      break;</span>
<a href="#l80.310"></a><span id="l80.310" class="difflineplus">+        if (sig-&gt;state == MimeMultipartSignedBodyFirstLine)</span>
<a href="#l80.311"></a><span id="l80.311" class="difflineplus">+          sig-&gt;state = MimeMultipartSignedBodyLine;</span>
<a href="#l80.312"></a><span id="l80.312" class="difflineplus">+        else if (sig-&gt;state == MimeMultipartSignedSignatureFirstLine)</span>
<a href="#l80.313"></a><span id="l80.313" class="difflineplus">+          sig-&gt;state = MimeMultipartSignedSignatureLine;</span>
<a href="#l80.314"></a><span id="l80.314" class="difflineplus">+        break;</span>
<a href="#l80.315"></a><span id="l80.315"> </span>
<a href="#l80.316"></a><span id="l80.316" class="difflineminus">-    case MimeMultipartEpilogue:</span>
<a href="#l80.317"></a><span id="l80.317" class="difflineminus">-      sig-&gt;state = MimeMultipartSignedEpilogue;</span>
<a href="#l80.318"></a><span id="l80.318" class="difflineminus">-      break;</span>
<a href="#l80.319"></a><span id="l80.319" class="difflineplus">+      case MimeMultipartEpilogue:</span>
<a href="#l80.320"></a><span id="l80.320" class="difflineplus">+        sig-&gt;state = MimeMultipartSignedEpilogue;</span>
<a href="#l80.321"></a><span id="l80.321" class="difflineplus">+        break;</span>
<a href="#l80.322"></a><span id="l80.322"> </span>
<a href="#l80.323"></a><span id="l80.323" class="difflineminus">-    default:  /* bad state */</span>
<a href="#l80.324"></a><span id="l80.324" class="difflineminus">-      NS_ERROR(&quot;bad state in MultipartSigned parse line&quot;);</span>
<a href="#l80.325"></a><span id="l80.325" class="difflineminus">-      return -1;</span>
<a href="#l80.326"></a><span id="l80.326" class="difflineminus">-      break;</span>
<a href="#l80.327"></a><span id="l80.327" class="difflineplus">+      default: /* bad state */</span>
<a href="#l80.328"></a><span id="l80.328" class="difflineplus">+        NS_ERROR(&quot;bad state in MultipartSigned parse line&quot;);</span>
<a href="#l80.329"></a><span id="l80.329" class="difflineplus">+        return -1;</span>
<a href="#l80.330"></a><span id="l80.330" class="difflineplus">+        break;</span>
<a href="#l80.331"></a><span id="l80.331">     }</span>
<a href="#l80.332"></a><span id="l80.332">   }</span>
<a href="#l80.333"></a><span id="l80.333"> </span>
<a href="#l80.334"></a><span id="l80.334" class="difflineminus">-</span>
<a href="#l80.335"></a><span id="l80.335">   /* Perform multipart/signed-related actions on this line based on the state</span>
<a href="#l80.336"></a><span id="l80.336">    of the parser.</span>
<a href="#l80.337"></a><span id="l80.337">    */</span>
<a href="#l80.338"></a><span id="l80.338" class="difflineminus">-  switch (sig-&gt;state)</span>
<a href="#l80.339"></a><span id="l80.339" class="difflineminus">-  {</span>
<a href="#l80.340"></a><span id="l80.340" class="difflineminus">-  case MimeMultipartSignedPreamble:</span>
<a href="#l80.341"></a><span id="l80.341" class="difflineminus">-    /* Do nothing. */</span>
<a href="#l80.342"></a><span id="l80.342" class="difflineminus">-    break;</span>
<a href="#l80.343"></a><span id="l80.343" class="difflineplus">+  switch (sig-&gt;state) {</span>
<a href="#l80.344"></a><span id="l80.344" class="difflineplus">+    case MimeMultipartSignedPreamble:</span>
<a href="#l80.345"></a><span id="l80.345" class="difflineplus">+      /* Do nothing. */</span>
<a href="#l80.346"></a><span id="l80.346" class="difflineplus">+      break;</span>
<a href="#l80.347"></a><span id="l80.347"> </span>
<a href="#l80.348"></a><span id="l80.348" class="difflineminus">-  case MimeMultipartSignedBodyFirstLine:</span>
<a href="#l80.349"></a><span id="l80.349" class="difflineminus">-    /* We have just moved out of the MimeMultipartSignedBodyHeaders</span>
<a href="#l80.350"></a><span id="l80.350" class="difflineminus">-     state, so cache away the headers that apply only to the body part.</span>
<a href="#l80.351"></a><span id="l80.351" class="difflineminus">-     */</span>
<a href="#l80.352"></a><span id="l80.352" class="difflineminus">-    NS_ASSERTION(mult-&gt;hdrs, &quot;null multipart hdrs&quot;);</span>
<a href="#l80.353"></a><span id="l80.353" class="difflineminus">-    NS_ASSERTION(!sig-&gt;body_hdrs, &quot;signed part shouldn't have already have body_hdrs&quot;);</span>
<a href="#l80.354"></a><span id="l80.354" class="difflineminus">-    sig-&gt;body_hdrs = mult-&gt;hdrs;</span>
<a href="#l80.355"></a><span id="l80.355" class="difflineminus">-    mult-&gt;hdrs = 0;</span>
<a href="#l80.356"></a><span id="l80.356" class="difflineplus">+    case MimeMultipartSignedBodyFirstLine:</span>
<a href="#l80.357"></a><span id="l80.357" class="difflineplus">+      /* We have just moved out of the MimeMultipartSignedBodyHeaders</span>
<a href="#l80.358"></a><span id="l80.358" class="difflineplus">+       state, so cache away the headers that apply only to the body part.</span>
<a href="#l80.359"></a><span id="l80.359" class="difflineplus">+       */</span>
<a href="#l80.360"></a><span id="l80.360" class="difflineplus">+      NS_ASSERTION(mult-&gt;hdrs, &quot;null multipart hdrs&quot;);</span>
<a href="#l80.361"></a><span id="l80.361" class="difflineplus">+      NS_ASSERTION(!sig-&gt;body_hdrs,</span>
<a href="#l80.362"></a><span id="l80.362" class="difflineplus">+                   &quot;signed part shouldn't have already have body_hdrs&quot;);</span>
<a href="#l80.363"></a><span id="l80.363" class="difflineplus">+      sig-&gt;body_hdrs = mult-&gt;hdrs;</span>
<a href="#l80.364"></a><span id="l80.364" class="difflineplus">+      mult-&gt;hdrs = 0;</span>
<a href="#l80.365"></a><span id="l80.365" class="difflineplus">+</span>
<a href="#l80.366"></a><span id="l80.366" class="difflineplus">+      /* fall through. */</span>
<a href="#l80.367"></a><span id="l80.367" class="difflineplus">+      MOZ_FALLTHROUGH;</span>
<a href="#l80.368"></a><span id="l80.368" class="difflineplus">+    case MimeMultipartSignedBodyFirstHeader:</span>
<a href="#l80.369"></a><span id="l80.369" class="difflineplus">+    case MimeMultipartSignedBodyHeaders:</span>
<a href="#l80.370"></a><span id="l80.370" class="difflineplus">+    case MimeMultipartSignedBodyLine:</span>
<a href="#l80.371"></a><span id="l80.371"> </span>
<a href="#l80.372"></a><span id="l80.372" class="difflineminus">-    /* fall through. */</span>
<a href="#l80.373"></a><span id="l80.373" class="difflineminus">-   MOZ_FALLTHROUGH;</span>
<a href="#l80.374"></a><span id="l80.374" class="difflineminus">-  case MimeMultipartSignedBodyFirstHeader:</span>
<a href="#l80.375"></a><span id="l80.375" class="difflineminus">-  case MimeMultipartSignedBodyHeaders:</span>
<a href="#l80.376"></a><span id="l80.376" class="difflineminus">-  case MimeMultipartSignedBodyLine:</span>
<a href="#l80.377"></a><span id="l80.377" class="difflineplus">+      if (!sig-&gt;crypto_closure) {</span>
<a href="#l80.378"></a><span id="l80.378" class="difflineplus">+        /* Set error change */</span>
<a href="#l80.379"></a><span id="l80.379" class="difflineplus">+        PR_SetError(0, 0);</span>
<a href="#l80.380"></a><span id="l80.380" class="difflineplus">+        /* Initialize the signature verification library. */</span>
<a href="#l80.381"></a><span id="l80.381" class="difflineplus">+        sig-&gt;crypto_closure =</span>
<a href="#l80.382"></a><span id="l80.382" class="difflineplus">+            (((MimeMultipartSignedClass *)obj-&gt;clazz)-&gt;crypto_init)(obj);</span>
<a href="#l80.383"></a><span id="l80.383" class="difflineplus">+        if (!sig-&gt;crypto_closure) {</span>
<a href="#l80.384"></a><span id="l80.384" class="difflineplus">+          status = PR_GetError();</span>
<a href="#l80.385"></a><span id="l80.385" class="difflineplus">+          NS_ASSERTION(status &lt; 0, &quot;got non-negative status&quot;);</span>
<a href="#l80.386"></a><span id="l80.386" class="difflineplus">+          if (status &gt;= 0) status = -1;</span>
<a href="#l80.387"></a><span id="l80.387" class="difflineplus">+          return status;</span>
<a href="#l80.388"></a><span id="l80.388" class="difflineplus">+        }</span>
<a href="#l80.389"></a><span id="l80.389" class="difflineplus">+      }</span>
<a href="#l80.390"></a><span id="l80.390" class="difflineplus">+</span>
<a href="#l80.391"></a><span id="l80.391" class="difflineplus">+      if (hash_line_p) {</span>
<a href="#l80.392"></a><span id="l80.392" class="difflineplus">+        /* this is the first hashed line if this is the first header</span>
<a href="#l80.393"></a><span id="l80.393" class="difflineplus">+         (that is, if it's the first line in the header state after</span>
<a href="#l80.394"></a><span id="l80.394" class="difflineplus">+         a state change.)</span>
<a href="#l80.395"></a><span id="l80.395" class="difflineplus">+         */</span>
<a href="#l80.396"></a><span id="l80.396" class="difflineplus">+        bool first_line_p =</span>
<a href="#l80.397"></a><span id="l80.397" class="difflineplus">+            (no_headers_p || sig-&gt;state == MimeMultipartSignedBodyFirstHeader);</span>
<a href="#l80.398"></a><span id="l80.398"> </span>
<a href="#l80.399"></a><span id="l80.399" class="difflineminus">-    if (!sig-&gt;crypto_closure)</span>
<a href="#l80.400"></a><span id="l80.400" class="difflineminus">-    {</span>
<a href="#l80.401"></a><span id="l80.401" class="difflineminus">-      /* Set error change */</span>
<a href="#l80.402"></a><span id="l80.402" class="difflineminus">-      PR_SetError(0, 0);</span>
<a href="#l80.403"></a><span id="l80.403" class="difflineminus">-      /* Initialize the signature verification library. */</span>
<a href="#l80.404"></a><span id="l80.404" class="difflineminus">-      sig-&gt;crypto_closure = (((MimeMultipartSignedClass *) obj-&gt;clazz)</span>
<a href="#l80.405"></a><span id="l80.405" class="difflineminus">-                 -&gt;crypto_init) (obj);</span>
<a href="#l80.406"></a><span id="l80.406" class="difflineminus">-      if (!sig-&gt;crypto_closure)</span>
<a href="#l80.407"></a><span id="l80.407" class="difflineminus">-      {</span>
<a href="#l80.408"></a><span id="l80.408" class="difflineminus">-        status = PR_GetError();</span>
<a href="#l80.409"></a><span id="l80.409" class="difflineminus">-        NS_ASSERTION(status &lt; 0, &quot;got non-negative status&quot;);</span>
<a href="#l80.410"></a><span id="l80.410" class="difflineminus">-        if (status &gt;= 0)</span>
<a href="#l80.411"></a><span id="l80.411" class="difflineminus">-          status = -1;</span>
<a href="#l80.412"></a><span id="l80.412" class="difflineminus">-        return status;</span>
<a href="#l80.413"></a><span id="l80.413" class="difflineminus">-      }</span>
<a href="#l80.414"></a><span id="l80.414" class="difflineminus">-    }</span>
<a href="#l80.415"></a><span id="l80.415" class="difflineplus">+        if (sig-&gt;state == MimeMultipartSignedBodyFirstHeader)</span>
<a href="#l80.416"></a><span id="l80.416" class="difflineplus">+          sig-&gt;state = MimeMultipartSignedBodyHeaders;</span>
<a href="#l80.417"></a><span id="l80.417" class="difflineplus">+</span>
<a href="#l80.418"></a><span id="l80.418" class="difflineplus">+        /* The newline issues here are tricky, since both the newlines</span>
<a href="#l80.419"></a><span id="l80.419" class="difflineplus">+         before and after the boundary string are to be considered part</span>
<a href="#l80.420"></a><span id="l80.420" class="difflineplus">+         of the boundary: this is so that a part can be specified such</span>
<a href="#l80.421"></a><span id="l80.421" class="difflineplus">+         that it does not end in a trailing newline.</span>
<a href="#l80.422"></a><span id="l80.422" class="difflineplus">+</span>
<a href="#l80.423"></a><span id="l80.423" class="difflineplus">+         To implement this, we send a newline *before* each line instead</span>
<a href="#l80.424"></a><span id="l80.424" class="difflineplus">+         of after, except for the first line, which is not preceded by a</span>
<a href="#l80.425"></a><span id="l80.425" class="difflineplus">+         newline.</span>
<a href="#l80.426"></a><span id="l80.426" class="difflineplus">+</span>
<a href="#l80.427"></a><span id="l80.427" class="difflineplus">+         For purposes of cryptographic hashing, we always hash line</span>
<a href="#l80.428"></a><span id="l80.428" class="difflineplus">+         breaks as CRLF -- the canonical, on-the-wire linebreaks, since</span>
<a href="#l80.429"></a><span id="l80.429" class="difflineplus">+         we have no idea of knowing what line breaks were used on the</span>
<a href="#l80.430"></a><span id="l80.430" class="difflineplus">+         originating system (SMTP rightly destroys that information.)</span>
<a href="#l80.431"></a><span id="l80.431" class="difflineplus">+         */</span>
<a href="#l80.432"></a><span id="l80.432" class="difflineplus">+</span>
<a href="#l80.433"></a><span id="l80.433" class="difflineplus">+        /* Remove the trailing newline... */</span>
<a href="#l80.434"></a><span id="l80.434" class="difflineplus">+        if (length &gt; 0 &amp;&amp; line[length - 1] == '\n') length--;</span>
<a href="#l80.435"></a><span id="l80.435" class="difflineplus">+        if (length &gt; 0 &amp;&amp; line[length - 1] == '\r') length--;</span>
<a href="#l80.436"></a><span id="l80.436" class="difflineplus">+</span>
<a href="#l80.437"></a><span id="l80.437" class="difflineplus">+        PR_ASSERT(sig-&gt;crypto_closure);</span>
<a href="#l80.438"></a><span id="l80.438"> </span>
<a href="#l80.439"></a><span id="l80.439" class="difflineminus">-    if (hash_line_p)</span>
<a href="#l80.440"></a><span id="l80.440" class="difflineminus">-    {</span>
<a href="#l80.441"></a><span id="l80.441" class="difflineminus">-      /* this is the first hashed line if this is the first header</span>
<a href="#l80.442"></a><span id="l80.442" class="difflineminus">-       (that is, if it's the first line in the header state after</span>
<a href="#l80.443"></a><span id="l80.443" class="difflineminus">-       a state change.)</span>
<a href="#l80.444"></a><span id="l80.444" class="difflineplus">+        if (!first_line_p) {</span>
<a href="#l80.445"></a><span id="l80.445" class="difflineplus">+          /* Push out a preceding newline... */</span>
<a href="#l80.446"></a><span id="l80.446" class="difflineplus">+          char nl[] = CRLF;</span>
<a href="#l80.447"></a><span id="l80.447" class="difflineplus">+          status = (((MimeMultipartSignedClass *)obj-&gt;clazz)</span>
<a href="#l80.448"></a><span id="l80.448" class="difflineplus">+                        -&gt;crypto_data_hash(nl, 2, sig-&gt;crypto_closure));</span>
<a href="#l80.449"></a><span id="l80.449" class="difflineplus">+          if (status &lt; 0) return status;</span>
<a href="#l80.450"></a><span id="l80.450" class="difflineplus">+        }</span>
<a href="#l80.451"></a><span id="l80.451" class="difflineplus">+</span>
<a href="#l80.452"></a><span id="l80.452" class="difflineplus">+        /* Now push out the line sans trailing newline. */</span>
<a href="#l80.453"></a><span id="l80.453" class="difflineplus">+        if (length &gt; 0)</span>
<a href="#l80.454"></a><span id="l80.454" class="difflineplus">+          status = (((MimeMultipartSignedClass *)obj-&gt;clazz)</span>
<a href="#l80.455"></a><span id="l80.455" class="difflineplus">+                        -&gt;crypto_data_hash(line, length, sig-&gt;crypto_closure));</span>
<a href="#l80.456"></a><span id="l80.456" class="difflineplus">+        if (status &lt; 0) return status;</span>
<a href="#l80.457"></a><span id="l80.457" class="difflineplus">+      }</span>
<a href="#l80.458"></a><span id="l80.458" class="difflineplus">+      break;</span>
<a href="#l80.459"></a><span id="l80.459" class="difflineplus">+</span>
<a href="#l80.460"></a><span id="l80.460" class="difflineplus">+    case MimeMultipartSignedSignatureHeaders:</span>
<a href="#l80.461"></a><span id="l80.461" class="difflineplus">+</span>
<a href="#l80.462"></a><span id="l80.462" class="difflineplus">+      if (sig-&gt;crypto_closure &amp;&amp; old_state != mult-&gt;state) {</span>
<a href="#l80.463"></a><span id="l80.463" class="difflineplus">+        /* We have just moved out of the MimeMultipartSignedBodyLine</span>
<a href="#l80.464"></a><span id="l80.464" class="difflineplus">+         state, so tell the signature verification library that we've</span>
<a href="#l80.465"></a><span id="l80.465" class="difflineplus">+         reached the end of the signed data.</span>
<a href="#l80.466"></a><span id="l80.466" class="difflineplus">+         */</span>
<a href="#l80.467"></a><span id="l80.467" class="difflineplus">+        status = (((MimeMultipartSignedClass *)obj-&gt;clazz)-&gt;crypto_data_eof)(</span>
<a href="#l80.468"></a><span id="l80.468" class="difflineplus">+            sig-&gt;crypto_closure, false);</span>
<a href="#l80.469"></a><span id="l80.469" class="difflineplus">+        if (status &lt; 0) return status;</span>
<a href="#l80.470"></a><span id="l80.470" class="difflineplus">+      }</span>
<a href="#l80.471"></a><span id="l80.471" class="difflineplus">+      break;</span>
<a href="#l80.472"></a><span id="l80.472" class="difflineplus">+</span>
<a href="#l80.473"></a><span id="l80.473" class="difflineplus">+    case MimeMultipartSignedSignatureFirstLine:</span>
<a href="#l80.474"></a><span id="l80.474" class="difflineplus">+      /* We have just moved out of the MimeMultipartSignedSignatureHeaders</span>
<a href="#l80.475"></a><span id="l80.475" class="difflineplus">+       state, so cache away the headers that apply only to the sig part.</span>
<a href="#l80.476"></a><span id="l80.476">        */</span>
<a href="#l80.477"></a><span id="l80.477" class="difflineminus">-      bool first_line_p</span>
<a href="#l80.478"></a><span id="l80.478" class="difflineminus">-      = (no_headers_p ||</span>
<a href="#l80.479"></a><span id="l80.479" class="difflineminus">-         sig-&gt;state == MimeMultipartSignedBodyFirstHeader);</span>
<a href="#l80.480"></a><span id="l80.480" class="difflineminus">-</span>
<a href="#l80.481"></a><span id="l80.481" class="difflineminus">-      if (sig-&gt;state == MimeMultipartSignedBodyFirstHeader)</span>
<a href="#l80.482"></a><span id="l80.482" class="difflineminus">-      sig-&gt;state = MimeMultipartSignedBodyHeaders;</span>
<a href="#l80.483"></a><span id="l80.483" class="difflineminus">-</span>
<a href="#l80.484"></a><span id="l80.484" class="difflineminus">-      /* The newline issues here are tricky, since both the newlines</span>
<a href="#l80.485"></a><span id="l80.485" class="difflineminus">-       before and after the boundary string are to be considered part</span>
<a href="#l80.486"></a><span id="l80.486" class="difflineminus">-       of the boundary: this is so that a part can be specified such</span>
<a href="#l80.487"></a><span id="l80.487" class="difflineminus">-       that it does not end in a trailing newline.</span>
<a href="#l80.488"></a><span id="l80.488" class="difflineplus">+      PR_ASSERT(mult-&gt;hdrs);</span>
<a href="#l80.489"></a><span id="l80.489" class="difflineplus">+      PR_ASSERT(!sig-&gt;sig_hdrs);</span>
<a href="#l80.490"></a><span id="l80.490" class="difflineplus">+      sig-&gt;sig_hdrs = mult-&gt;hdrs;</span>
<a href="#l80.491"></a><span id="l80.491" class="difflineplus">+      mult-&gt;hdrs = 0;</span>
<a href="#l80.492"></a><span id="l80.492"> </span>
<a href="#l80.493"></a><span id="l80.493" class="difflineminus">-       To implement this, we send a newline *before* each line instead</span>
<a href="#l80.494"></a><span id="l80.494" class="difflineminus">-       of after, except for the first line, which is not preceded by a</span>
<a href="#l80.495"></a><span id="l80.495" class="difflineminus">-       newline.</span>
<a href="#l80.496"></a><span id="l80.496" class="difflineminus">-</span>
<a href="#l80.497"></a><span id="l80.497" class="difflineminus">-       For purposes of cryptographic hashing, we always hash line</span>
<a href="#l80.498"></a><span id="l80.498" class="difflineminus">-       breaks as CRLF -- the canonical, on-the-wire linebreaks, since</span>
<a href="#l80.499"></a><span id="l80.499" class="difflineminus">-       we have no idea of knowing what line breaks were used on the</span>
<a href="#l80.500"></a><span id="l80.500" class="difflineminus">-       originating system (SMTP rightly destroys that information.)</span>
<a href="#l80.501"></a><span id="l80.501" class="difflineplus">+      /* If the signature block has an encoding, set up a decoder for it.</span>
<a href="#l80.502"></a><span id="l80.502" class="difflineplus">+       (Similar logic is in MimeLeafClass-&gt;parse_begin.)</span>
<a href="#l80.503"></a><span id="l80.503">        */</span>
<a href="#l80.504"></a><span id="l80.504" class="difflineplus">+      {</span>
<a href="#l80.505"></a><span id="l80.505" class="difflineplus">+        MimeDecoderData *(*fn)(MimeConverterOutputCallback, void *) = 0;</span>
<a href="#l80.506"></a><span id="l80.506" class="difflineplus">+        nsCString encoding;</span>
<a href="#l80.507"></a><span id="l80.507" class="difflineplus">+        encoding.Adopt(MimeHeaders_get(</span>
<a href="#l80.508"></a><span id="l80.508" class="difflineplus">+            sig-&gt;sig_hdrs, HEADER_CONTENT_TRANSFER_ENCODING, true, false));</span>
<a href="#l80.509"></a><span id="l80.509" class="difflineplus">+        if (encoding.IsEmpty())</span>
<a href="#l80.510"></a><span id="l80.510" class="difflineplus">+          ;</span>
<a href="#l80.511"></a><span id="l80.511" class="difflineplus">+        else if (!PL_strcasecmp(encoding.get(), ENCODING_BASE64))</span>
<a href="#l80.512"></a><span id="l80.512" class="difflineplus">+          fn = &amp;MimeB64DecoderInit;</span>
<a href="#l80.513"></a><span id="l80.513" class="difflineplus">+        else if (!PL_strcasecmp(encoding.get(), ENCODING_QUOTED_PRINTABLE)) {</span>
<a href="#l80.514"></a><span id="l80.514" class="difflineplus">+          sig-&gt;sig_decoder_data =</span>
<a href="#l80.515"></a><span id="l80.515" class="difflineplus">+              MimeQPDecoderInit(((MimeConverterOutputCallback)(</span>
<a href="#l80.516"></a><span id="l80.516" class="difflineplus">+                                    ((MimeMultipartSignedClass *)obj-&gt;clazz)</span>
<a href="#l80.517"></a><span id="l80.517" class="difflineplus">+                                        -&gt;crypto_signature_hash)),</span>
<a href="#l80.518"></a><span id="l80.518" class="difflineplus">+                                sig-&gt;crypto_closure);</span>
<a href="#l80.519"></a><span id="l80.519" class="difflineplus">+          if (!sig-&gt;sig_decoder_data) return MIME_OUT_OF_MEMORY;</span>
<a href="#l80.520"></a><span id="l80.520" class="difflineplus">+        } else if (!PL_strcasecmp(encoding.get(), ENCODING_UUENCODE) ||</span>
<a href="#l80.521"></a><span id="l80.521" class="difflineplus">+                   !PL_strcasecmp(encoding.get(), ENCODING_UUENCODE2) ||</span>
<a href="#l80.522"></a><span id="l80.522" class="difflineplus">+                   !PL_strcasecmp(encoding.get(), ENCODING_UUENCODE3) ||</span>
<a href="#l80.523"></a><span id="l80.523" class="difflineplus">+                   !PL_strcasecmp(encoding.get(), ENCODING_UUENCODE4))</span>
<a href="#l80.524"></a><span id="l80.524" class="difflineplus">+          fn = &amp;MimeUUDecoderInit;</span>
<a href="#l80.525"></a><span id="l80.525" class="difflineplus">+        else if (!PL_strcasecmp(encoding.get(), ENCODING_YENCODE))</span>
<a href="#l80.526"></a><span id="l80.526" class="difflineplus">+          fn = &amp;MimeYDecoderInit;</span>
<a href="#l80.527"></a><span id="l80.527" class="difflineplus">+        if (fn) {</span>
<a href="#l80.528"></a><span id="l80.528" class="difflineplus">+          sig-&gt;sig_decoder_data =</span>
<a href="#l80.529"></a><span id="l80.529" class="difflineplus">+              fn(((MimeConverterOutputCallback)(</span>
<a href="#l80.530"></a><span id="l80.530" class="difflineplus">+                     ((MimeMultipartSignedClass *)obj-&gt;clazz)</span>
<a href="#l80.531"></a><span id="l80.531" class="difflineplus">+                         -&gt;crypto_signature_hash)),</span>
<a href="#l80.532"></a><span id="l80.532" class="difflineplus">+                 sig-&gt;crypto_closure);</span>
<a href="#l80.533"></a><span id="l80.533" class="difflineplus">+          if (!sig-&gt;sig_decoder_data) return MIME_OUT_OF_MEMORY;</span>
<a href="#l80.534"></a><span id="l80.534" class="difflineplus">+        }</span>
<a href="#l80.535"></a><span id="l80.535" class="difflineplus">+      }</span>
<a href="#l80.536"></a><span id="l80.536"> </span>
<a href="#l80.537"></a><span id="l80.537" class="difflineminus">-      /* Remove the trailing newline... */</span>
<a href="#l80.538"></a><span id="l80.538" class="difflineminus">-      if (length &gt; 0 &amp;&amp; line[length-1] == '\n') length--;</span>
<a href="#l80.539"></a><span id="l80.539" class="difflineminus">-      if (length &gt; 0 &amp;&amp; line[length-1] == '\r') length--;</span>
<a href="#l80.540"></a><span id="l80.540" class="difflineminus">-</span>
<a href="#l80.541"></a><span id="l80.541" class="difflineminus">-      PR_ASSERT(sig-&gt;crypto_closure);</span>
<a href="#l80.542"></a><span id="l80.542" class="difflineminus">-</span>
<a href="#l80.543"></a><span id="l80.543" class="difflineminus">-      if (!first_line_p)</span>
<a href="#l80.544"></a><span id="l80.544" class="difflineminus">-      {</span>
<a href="#l80.545"></a><span id="l80.545" class="difflineminus">-        /* Push out a preceding newline... */</span>
<a href="#l80.546"></a><span id="l80.546" class="difflineminus">-        char nl[] = CRLF;</span>
<a href="#l80.547"></a><span id="l80.547" class="difflineminus">-        status = (((MimeMultipartSignedClass *) obj-&gt;clazz)</span>
<a href="#l80.548"></a><span id="l80.548" class="difflineminus">-            -&gt;crypto_data_hash (nl, 2, sig-&gt;crypto_closure));</span>
<a href="#l80.549"></a><span id="l80.549" class="difflineplus">+      /* Show these headers to the crypto module. */</span>
<a href="#l80.550"></a><span id="l80.550" class="difflineplus">+      if (hash_line_p) {</span>
<a href="#l80.551"></a><span id="l80.551" class="difflineplus">+        status =</span>
<a href="#l80.552"></a><span id="l80.552" class="difflineplus">+            (((MimeMultipartSignedClass *)obj-&gt;clazz)-&gt;crypto_signature_init)(</span>
<a href="#l80.553"></a><span id="l80.553" class="difflineplus">+                sig-&gt;crypto_closure, obj, sig-&gt;sig_hdrs);</span>
<a href="#l80.554"></a><span id="l80.554">         if (status &lt; 0) return status;</span>
<a href="#l80.555"></a><span id="l80.555">       }</span>
<a href="#l80.556"></a><span id="l80.556"> </span>
<a href="#l80.557"></a><span id="l80.557" class="difflineminus">-      /* Now push out the line sans trailing newline. */</span>
<a href="#l80.558"></a><span id="l80.558" class="difflineminus">-      if (length &gt; 0)</span>
<a href="#l80.559"></a><span id="l80.559" class="difflineminus">-      status = (((MimeMultipartSignedClass *) obj-&gt;clazz)</span>
<a href="#l80.560"></a><span id="l80.560" class="difflineminus">-            -&gt;crypto_data_hash (line,length, sig-&gt;crypto_closure));</span>
<a href="#l80.561"></a><span id="l80.561" class="difflineminus">-      if (status &lt; 0) return status;</span>
<a href="#l80.562"></a><span id="l80.562" class="difflineminus">-    }</span>
<a href="#l80.563"></a><span id="l80.563" class="difflineminus">-    break;</span>
<a href="#l80.564"></a><span id="l80.564" class="difflineminus">-</span>
<a href="#l80.565"></a><span id="l80.565" class="difflineminus">-  case MimeMultipartSignedSignatureHeaders:</span>
<a href="#l80.566"></a><span id="l80.566" class="difflineminus">-</span>
<a href="#l80.567"></a><span id="l80.567" class="difflineminus">-    if (sig-&gt;crypto_closure &amp;&amp;</span>
<a href="#l80.568"></a><span id="l80.568" class="difflineminus">-      old_state != mult-&gt;state)</span>
<a href="#l80.569"></a><span id="l80.569" class="difflineminus">-    {</span>
<a href="#l80.570"></a><span id="l80.570" class="difflineminus">-      /* We have just moved out of the MimeMultipartSignedBodyLine</span>
<a href="#l80.571"></a><span id="l80.571" class="difflineminus">-       state, so tell the signature verification library that we've</span>
<a href="#l80.572"></a><span id="l80.572" class="difflineminus">-       reached the end of the signed data.</span>
<a href="#l80.573"></a><span id="l80.573" class="difflineminus">-       */</span>
<a href="#l80.574"></a><span id="l80.574" class="difflineminus">-      status = (((MimeMultipartSignedClass *) obj-&gt;clazz)</span>
<a href="#l80.575"></a><span id="l80.575" class="difflineminus">-          -&gt;crypto_data_eof) (sig-&gt;crypto_closure, false);</span>
<a href="#l80.576"></a><span id="l80.576" class="difflineminus">-      if (status &lt; 0) return status;</span>
<a href="#l80.577"></a><span id="l80.577" class="difflineminus">-    }</span>
<a href="#l80.578"></a><span id="l80.578" class="difflineminus">-    break;</span>
<a href="#l80.579"></a><span id="l80.579" class="difflineminus">-</span>
<a href="#l80.580"></a><span id="l80.580" class="difflineminus">-  case MimeMultipartSignedSignatureFirstLine:</span>
<a href="#l80.581"></a><span id="l80.581" class="difflineminus">-    /* We have just moved out of the MimeMultipartSignedSignatureHeaders</span>
<a href="#l80.582"></a><span id="l80.582" class="difflineminus">-     state, so cache away the headers that apply only to the sig part.</span>
<a href="#l80.583"></a><span id="l80.583" class="difflineminus">-     */</span>
<a href="#l80.584"></a><span id="l80.584" class="difflineminus">-    PR_ASSERT(mult-&gt;hdrs);</span>
<a href="#l80.585"></a><span id="l80.585" class="difflineminus">-    PR_ASSERT(!sig-&gt;sig_hdrs);</span>
<a href="#l80.586"></a><span id="l80.586" class="difflineminus">-    sig-&gt;sig_hdrs = mult-&gt;hdrs;</span>
<a href="#l80.587"></a><span id="l80.587" class="difflineminus">-    mult-&gt;hdrs = 0;</span>
<a href="#l80.588"></a><span id="l80.588" class="difflineminus">-</span>
<a href="#l80.589"></a><span id="l80.589" class="difflineplus">+      /* fall through. */</span>
<a href="#l80.590"></a><span id="l80.590" class="difflineplus">+      MOZ_FALLTHROUGH;</span>
<a href="#l80.591"></a><span id="l80.591" class="difflineplus">+    case MimeMultipartSignedSignatureLine:</span>
<a href="#l80.592"></a><span id="l80.592" class="difflineplus">+      if (hash_line_p) {</span>
<a href="#l80.593"></a><span id="l80.593" class="difflineplus">+        /* Feed this line into the signature verification routines. */</span>
<a href="#l80.594"></a><span id="l80.594"> </span>
<a href="#l80.595"></a><span id="l80.595" class="difflineminus">-    /* If the signature block has an encoding, set up a decoder for it.</span>
<a href="#l80.596"></a><span id="l80.596" class="difflineminus">-     (Similar logic is in MimeLeafClass-&gt;parse_begin.)</span>
<a href="#l80.597"></a><span id="l80.597" class="difflineminus">-     */</span>
<a href="#l80.598"></a><span id="l80.598" class="difflineminus">-    {</span>
<a href="#l80.599"></a><span id="l80.599" class="difflineminus">-    MimeDecoderData *(*fn) (MimeConverterOutputCallback, void*) = 0;</span>
<a href="#l80.600"></a><span id="l80.600" class="difflineminus">-    nsCString encoding;</span>
<a href="#l80.601"></a><span id="l80.601" class="difflineminus">-    encoding.Adopt(MimeHeaders_get (sig-&gt;sig_hdrs,</span>
<a href="#l80.602"></a><span id="l80.602" class="difflineminus">-                   HEADER_CONTENT_TRANSFER_ENCODING,</span>
<a href="#l80.603"></a><span id="l80.603" class="difflineminus">-                   true, false));</span>
<a href="#l80.604"></a><span id="l80.604" class="difflineminus">-    if (encoding.IsEmpty())</span>
<a href="#l80.605"></a><span id="l80.605" class="difflineminus">-      ;</span>
<a href="#l80.606"></a><span id="l80.606" class="difflineminus">-    else if (!PL_strcasecmp(encoding.get(), ENCODING_BASE64))</span>
<a href="#l80.607"></a><span id="l80.607" class="difflineminus">-      fn = &amp;MimeB64DecoderInit;</span>
<a href="#l80.608"></a><span id="l80.608" class="difflineminus">-    else if (!PL_strcasecmp(encoding.get(), ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l80.609"></a><span id="l80.609" class="difflineminus">-    {</span>
<a href="#l80.610"></a><span id="l80.610" class="difflineminus">-      sig-&gt;sig_decoder_data =</span>
<a href="#l80.611"></a><span id="l80.611" class="difflineminus">-  MimeQPDecoderInit (((MimeConverterOutputCallback)</span>
<a href="#l80.612"></a><span id="l80.612" class="difflineminus">-     (((MimeMultipartSignedClass *) obj-&gt;clazz)</span>
<a href="#l80.613"></a><span id="l80.613" class="difflineminus">-          -&gt;crypto_signature_hash)),</span>
<a href="#l80.614"></a><span id="l80.614" class="difflineminus">-    sig-&gt;crypto_closure);</span>
<a href="#l80.615"></a><span id="l80.615" class="difflineminus">-      if (!sig-&gt;sig_decoder_data)</span>
<a href="#l80.616"></a><span id="l80.616" class="difflineminus">-  return MIME_OUT_OF_MEMORY;</span>
<a href="#l80.617"></a><span id="l80.617" class="difflineminus">-    }</span>
<a href="#l80.618"></a><span id="l80.618" class="difflineminus">-    else if (!PL_strcasecmp(encoding.get(), ENCODING_UUENCODE) ||</span>
<a href="#l80.619"></a><span id="l80.619" class="difflineminus">-             !PL_strcasecmp(encoding.get(), ENCODING_UUENCODE2) ||</span>
<a href="#l80.620"></a><span id="l80.620" class="difflineminus">-             !PL_strcasecmp(encoding.get(), ENCODING_UUENCODE3) ||</span>
<a href="#l80.621"></a><span id="l80.621" class="difflineminus">-             !PL_strcasecmp(encoding.get(), ENCODING_UUENCODE4))</span>
<a href="#l80.622"></a><span id="l80.622" class="difflineminus">-      fn = &amp;MimeUUDecoderInit;</span>
<a href="#l80.623"></a><span id="l80.623" class="difflineminus">-    else if (!PL_strcasecmp(encoding.get(), ENCODING_YENCODE))</span>
<a href="#l80.624"></a><span id="l80.624" class="difflineminus">-      fn = &amp;MimeYDecoderInit;</span>
<a href="#l80.625"></a><span id="l80.625" class="difflineminus">-    if (fn)</span>
<a href="#l80.626"></a><span id="l80.626" class="difflineminus">-      {</span>
<a href="#l80.627"></a><span id="l80.627" class="difflineminus">-      sig-&gt;sig_decoder_data =</span>
<a href="#l80.628"></a><span id="l80.628" class="difflineminus">-        fn (((MimeConverterOutputCallback)</span>
<a href="#l80.629"></a><span id="l80.629" class="difflineminus">-           (((MimeMultipartSignedClass *) obj-&gt;clazz)</span>
<a href="#l80.630"></a><span id="l80.630" class="difflineminus">-          -&gt;crypto_signature_hash)),</span>
<a href="#l80.631"></a><span id="l80.631" class="difflineminus">-          sig-&gt;crypto_closure);</span>
<a href="#l80.632"></a><span id="l80.632" class="difflineminus">-      if (!sig-&gt;sig_decoder_data)</span>
<a href="#l80.633"></a><span id="l80.633" class="difflineminus">-        return MIME_OUT_OF_MEMORY;</span>
<a href="#l80.634"></a><span id="l80.634" class="difflineplus">+        if (sig-&gt;sig_decoder_data)</span>
<a href="#l80.635"></a><span id="l80.635" class="difflineplus">+          status =</span>
<a href="#l80.636"></a><span id="l80.636" class="difflineplus">+              MimeDecoderWrite(sig-&gt;sig_decoder_data, line, length, nullptr);</span>
<a href="#l80.637"></a><span id="l80.637" class="difflineplus">+        else</span>
<a href="#l80.638"></a><span id="l80.638" class="difflineplus">+          status =</span>
<a href="#l80.639"></a><span id="l80.639" class="difflineplus">+              (((MimeMultipartSignedClass *)obj-&gt;clazz)</span>
<a href="#l80.640"></a><span id="l80.640" class="difflineplus">+                   -&gt;crypto_signature_hash(line, length, sig-&gt;crypto_closure));</span>
<a href="#l80.641"></a><span id="l80.641" class="difflineplus">+        if (status &lt; 0) return status;</span>
<a href="#l80.642"></a><span id="l80.642">       }</span>
<a href="#l80.643"></a><span id="l80.643" class="difflineminus">-    }</span>
<a href="#l80.644"></a><span id="l80.644" class="difflineminus">-</span>
<a href="#l80.645"></a><span id="l80.645" class="difflineminus">-    /* Show these headers to the crypto module. */</span>
<a href="#l80.646"></a><span id="l80.646" class="difflineminus">-    if (hash_line_p)</span>
<a href="#l80.647"></a><span id="l80.647" class="difflineminus">-    {</span>
<a href="#l80.648"></a><span id="l80.648" class="difflineminus">-      status = (((MimeMultipartSignedClass *) obj-&gt;clazz)</span>
<a href="#l80.649"></a><span id="l80.649" class="difflineminus">-          -&gt;crypto_signature_init) (sig-&gt;crypto_closure,</span>
<a href="#l80.650"></a><span id="l80.650" class="difflineminus">-                        obj, sig-&gt;sig_hdrs);</span>
<a href="#l80.651"></a><span id="l80.651" class="difflineminus">-      if (status &lt; 0) return status;</span>
<a href="#l80.652"></a><span id="l80.652" class="difflineminus">-    }</span>
<a href="#l80.653"></a><span id="l80.653" class="difflineminus">-</span>
<a href="#l80.654"></a><span id="l80.654" class="difflineminus">-    /* fall through. */</span>
<a href="#l80.655"></a><span id="l80.655" class="difflineminus">-   MOZ_FALLTHROUGH;</span>
<a href="#l80.656"></a><span id="l80.656" class="difflineminus">-  case MimeMultipartSignedSignatureLine:</span>
<a href="#l80.657"></a><span id="l80.657" class="difflineminus">-    if (hash_line_p)</span>
<a href="#l80.658"></a><span id="l80.658" class="difflineminus">-    {</span>
<a href="#l80.659"></a><span id="l80.659" class="difflineminus">-      /* Feed this line into the signature verification routines. */</span>
<a href="#l80.660"></a><span id="l80.660" class="difflineplus">+      break;</span>
<a href="#l80.661"></a><span id="l80.661"> </span>
<a href="#l80.662"></a><span id="l80.662" class="difflineminus">-      if (sig-&gt;sig_decoder_data)</span>
<a href="#l80.663"></a><span id="l80.663" class="difflineminus">-      status = MimeDecoderWrite (sig-&gt;sig_decoder_data, line, length, nullptr);</span>
<a href="#l80.664"></a><span id="l80.664" class="difflineminus">-      else</span>
<a href="#l80.665"></a><span id="l80.665" class="difflineminus">-      status = (((MimeMultipartSignedClass *) obj-&gt;clazz)</span>
<a href="#l80.666"></a><span id="l80.666" class="difflineminus">-            -&gt;crypto_signature_hash (line, length,</span>
<a href="#l80.667"></a><span id="l80.667" class="difflineminus">-                         sig-&gt;crypto_closure));</span>
<a href="#l80.668"></a><span id="l80.668" class="difflineminus">-      if (status &lt; 0) return status;</span>
<a href="#l80.669"></a><span id="l80.669" class="difflineminus">-    }</span>
<a href="#l80.670"></a><span id="l80.670" class="difflineminus">-    break;</span>
<a href="#l80.671"></a><span id="l80.671" class="difflineplus">+    case MimeMultipartSignedEpilogue:</span>
<a href="#l80.672"></a><span id="l80.672" class="difflineplus">+      /* Nothing special to do here. */</span>
<a href="#l80.673"></a><span id="l80.673" class="difflineplus">+      break;</span>
<a href="#l80.674"></a><span id="l80.674"> </span>
<a href="#l80.675"></a><span id="l80.675" class="difflineminus">-  case MimeMultipartSignedEpilogue:</span>
<a href="#l80.676"></a><span id="l80.676" class="difflineminus">-    /* Nothing special to do here. */</span>
<a href="#l80.677"></a><span id="l80.677" class="difflineminus">-    break;</span>
<a href="#l80.678"></a><span id="l80.678" class="difflineminus">-</span>
<a href="#l80.679"></a><span id="l80.679" class="difflineminus">-  default:  /* bad state */</span>
<a href="#l80.680"></a><span id="l80.680" class="difflineminus">-    PR_ASSERT(0);</span>
<a href="#l80.681"></a><span id="l80.681" class="difflineminus">-    return -1;</span>
<a href="#l80.682"></a><span id="l80.682" class="difflineplus">+    default: /* bad state */</span>
<a href="#l80.683"></a><span id="l80.683" class="difflineplus">+      PR_ASSERT(0);</span>
<a href="#l80.684"></a><span id="l80.684" class="difflineplus">+      return -1;</span>
<a href="#l80.685"></a><span id="l80.685">   }</span>
<a href="#l80.686"></a><span id="l80.686"> </span>
<a href="#l80.687"></a><span id="l80.687">   return status;</span>
<a href="#l80.688"></a><span id="l80.688"> }</span>
<a href="#l80.689"></a><span id="l80.689"> </span>
<a href="#l80.690"></a><span id="l80.690" class="difflineminus">-</span>
<a href="#l80.691"></a><span id="l80.691" class="difflineminus">-static int</span>
<a href="#l80.692"></a><span id="l80.692" class="difflineminus">-MimeMultipartSigned_create_child (MimeObject *parent)</span>
<a href="#l80.693"></a><span id="l80.693" class="difflineminus">-{</span>
<a href="#l80.694"></a><span id="l80.694" class="difflineplus">+static int MimeMultipartSigned_create_child(MimeObject *parent) {</span>
<a href="#l80.695"></a><span id="l80.695">   /* Don't actually create a child -- we call the superclass create_child</span>
<a href="#l80.696"></a><span id="l80.696">    method later, after we've fully parsed everything.  (And we only call</span>
<a href="#l80.697"></a><span id="l80.697">    it once, for part #1, and never for part #2 (the signature.))</span>
<a href="#l80.698"></a><span id="l80.698">    */</span>
<a href="#l80.699"></a><span id="l80.699" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) parent;</span>
<a href="#l80.700"></a><span id="l80.700" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)parent;</span>
<a href="#l80.701"></a><span id="l80.701">   mult-&gt;state = MimeMultipartPartFirstLine;</span>
<a href="#l80.702"></a><span id="l80.702">   return 0;</span>
<a href="#l80.703"></a><span id="l80.703"> }</span>
<a href="#l80.704"></a><span id="l80.704"> </span>
<a href="#l80.705"></a><span id="l80.705" class="difflineminus">-</span>
<a href="#l80.706"></a><span id="l80.706" class="difflineminus">-static int</span>
<a href="#l80.707"></a><span id="l80.707" class="difflineminus">-MimeMultipartSigned_close_child (MimeObject *obj)</span>
<a href="#l80.708"></a><span id="l80.708" class="difflineminus">-{</span>
<a href="#l80.709"></a><span id="l80.709" class="difflineplus">+static int MimeMultipartSigned_close_child(MimeObject *obj) {</span>
<a href="#l80.710"></a><span id="l80.710">   /* The close_child method on MimeMultipartSigned doesn't actually do</span>
<a href="#l80.711"></a><span id="l80.711">    anything to the children list, since the create_child method also</span>
<a href="#l80.712"></a><span id="l80.712">    doesn't do anything.</span>
<a href="#l80.713"></a><span id="l80.713">    */</span>
<a href="#l80.714"></a><span id="l80.714" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) obj;</span>
<a href="#l80.715"></a><span id="l80.715" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) obj;</span>
<a href="#l80.716"></a><span id="l80.716" class="difflineminus">-  MimeMultipartSigned *msig = (MimeMultipartSigned *) obj;</span>
<a href="#l80.717"></a><span id="l80.717" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)obj;</span>
<a href="#l80.718"></a><span id="l80.718" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l80.719"></a><span id="l80.719" class="difflineplus">+  MimeMultipartSigned *msig = (MimeMultipartSigned *)obj;</span>
<a href="#l80.720"></a><span id="l80.720"> </span>
<a href="#l80.721"></a><span id="l80.721">   if (msig-&gt;part_buffer)</span>
<a href="#l80.722"></a><span id="l80.722" class="difflineminus">-  /* Closes the tmp file, if there is one: doesn't free the part_buffer. */</span>
<a href="#l80.723"></a><span id="l80.723" class="difflineminus">-  MimePartBufferClose(msig-&gt;part_buffer);</span>
<a href="#l80.724"></a><span id="l80.724" class="difflineplus">+    /* Closes the tmp file, if there is one: doesn't free the part_buffer. */</span>
<a href="#l80.725"></a><span id="l80.725" class="difflineplus">+    MimePartBufferClose(msig-&gt;part_buffer);</span>
<a href="#l80.726"></a><span id="l80.726"> </span>
<a href="#l80.727"></a><span id="l80.727" class="difflineminus">-  if (mult-&gt;hdrs)  /* duplicated from MimeMultipart_close_child, ugh. */</span>
<a href="#l80.728"></a><span id="l80.728" class="difflineplus">+  if (mult-&gt;hdrs) /* duplicated from MimeMultipart_close_child, ugh. */</span>
<a href="#l80.729"></a><span id="l80.729">   {</span>
<a href="#l80.730"></a><span id="l80.730">     MimeHeaders_free(mult-&gt;hdrs);</span>
<a href="#l80.731"></a><span id="l80.731">     mult-&gt;hdrs = 0;</span>
<a href="#l80.732"></a><span id="l80.732">   }</span>
<a href="#l80.733"></a><span id="l80.733"> </span>
<a href="#l80.734"></a><span id="l80.734">   /* Should be no kids yet. */</span>
<a href="#l80.735"></a><span id="l80.735">   PR_ASSERT(cont-&gt;nchildren == 0);</span>
<a href="#l80.736"></a><span id="l80.736">   if (cont-&gt;nchildren != 0) return -1;</span>
<a href="#l80.737"></a><span id="l80.737"> </span>
<a href="#l80.738"></a><span id="l80.738">   return 0;</span>
<a href="#l80.739"></a><span id="l80.739"> }</span>
<a href="#l80.740"></a><span id="l80.740"> </span>
<a href="#l80.741"></a><span id="l80.741" class="difflineminus">-</span>
<a href="#l80.742"></a><span id="l80.742" class="difflineminus">-static int</span>
<a href="#l80.743"></a><span id="l80.743" class="difflineminus">-MimeMultipartSigned_parse_child_line (MimeObject *obj,</span>
<a href="#l80.744"></a><span id="l80.744" class="difflineminus">-                    const char *line, int32_t length,</span>
<a href="#l80.745"></a><span id="l80.745" class="difflineminus">-                    bool first_line_p)</span>
<a href="#l80.746"></a><span id="l80.746" class="difflineminus">-{</span>
<a href="#l80.747"></a><span id="l80.747" class="difflineminus">-  MimeMultipartSigned *sig = (MimeMultipartSigned *) obj;</span>
<a href="#l80.748"></a><span id="l80.748" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) obj;</span>
<a href="#l80.749"></a><span id="l80.749" class="difflineplus">+static int MimeMultipartSigned_parse_child_line(MimeObject *obj,</span>
<a href="#l80.750"></a><span id="l80.750" class="difflineplus">+                                                const char *line,</span>
<a href="#l80.751"></a><span id="l80.751" class="difflineplus">+                                                int32_t length,</span>
<a href="#l80.752"></a><span id="l80.752" class="difflineplus">+                                                bool first_line_p) {</span>
<a href="#l80.753"></a><span id="l80.753" class="difflineplus">+  MimeMultipartSigned *sig = (MimeMultipartSigned *)obj;</span>
<a href="#l80.754"></a><span id="l80.754" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l80.755"></a><span id="l80.755">   int status = 0;</span>
<a href="#l80.756"></a><span id="l80.756"> </span>
<a href="#l80.757"></a><span id="l80.757">   /* Shouldn't have made any sub-parts yet. */</span>
<a href="#l80.758"></a><span id="l80.758">   PR_ASSERT(cont-&gt;nchildren == 0);</span>
<a href="#l80.759"></a><span id="l80.759">   if (cont-&gt;nchildren != 0) return -1;</span>
<a href="#l80.760"></a><span id="l80.760"> </span>
<a href="#l80.761"></a><span id="l80.761" class="difflineminus">-  switch (sig-&gt;state)</span>
<a href="#l80.762"></a><span id="l80.762" class="difflineminus">-  {</span>
<a href="#l80.763"></a><span id="l80.763" class="difflineminus">-  case MimeMultipartSignedPreamble:</span>
<a href="#l80.764"></a><span id="l80.764" class="difflineminus">-  case MimeMultipartSignedBodyFirstHeader:</span>
<a href="#l80.765"></a><span id="l80.765" class="difflineminus">-  case MimeMultipartSignedBodyHeaders:</span>
<a href="#l80.766"></a><span id="l80.766" class="difflineminus">-    // How'd we get here?  Oh well, fall through.</span>
<a href="#l80.767"></a><span id="l80.767" class="difflineminus">-    NS_ERROR(&quot;wrong state in parse child line&quot;);</span>
<a href="#l80.768"></a><span id="l80.768" class="difflineminus">-    MOZ_FALLTHROUGH;</span>
<a href="#l80.769"></a><span id="l80.769" class="difflineminus">-  case MimeMultipartSignedBodyFirstLine:</span>
<a href="#l80.770"></a><span id="l80.770" class="difflineminus">-    PR_ASSERT(first_line_p);</span>
<a href="#l80.771"></a><span id="l80.771" class="difflineminus">-    if (!sig-&gt;part_buffer)</span>
<a href="#l80.772"></a><span id="l80.772" class="difflineminus">-    {</span>
<a href="#l80.773"></a><span id="l80.773" class="difflineminus">-      sig-&gt;part_buffer = MimePartBufferCreate();</span>
<a href="#l80.774"></a><span id="l80.774" class="difflineminus">-      if (!sig-&gt;part_buffer)</span>
<a href="#l80.775"></a><span id="l80.775" class="difflineminus">-      return MIME_OUT_OF_MEMORY;</span>
<a href="#l80.776"></a><span id="l80.776" class="difflineminus">-    }</span>
<a href="#l80.777"></a><span id="l80.777" class="difflineminus">-    /* fall through */</span>
<a href="#l80.778"></a><span id="l80.778" class="difflineminus">-   MOZ_FALLTHROUGH;</span>
<a href="#l80.779"></a><span id="l80.779" class="difflineminus">-  case MimeMultipartSignedBodyLine:</span>
<a href="#l80.780"></a><span id="l80.780" class="difflineminus">-    {</span>
<a href="#l80.781"></a><span id="l80.781" class="difflineminus">-    /* This is the first part; we are buffering it, and will emit it all</span>
<a href="#l80.782"></a><span id="l80.782" class="difflineminus">-       at the end (so that we know whether the signature matches before</span>
<a href="#l80.783"></a><span id="l80.783" class="difflineminus">-       showing anything to the user.)</span>
<a href="#l80.784"></a><span id="l80.784" class="difflineminus">-     */</span>
<a href="#l80.785"></a><span id="l80.785" class="difflineplus">+  switch (sig-&gt;state) {</span>
<a href="#l80.786"></a><span id="l80.786" class="difflineplus">+    case MimeMultipartSignedPreamble:</span>
<a href="#l80.787"></a><span id="l80.787" class="difflineplus">+    case MimeMultipartSignedBodyFirstHeader:</span>
<a href="#l80.788"></a><span id="l80.788" class="difflineplus">+    case MimeMultipartSignedBodyHeaders:</span>
<a href="#l80.789"></a><span id="l80.789" class="difflineplus">+      // How'd we get here?  Oh well, fall through.</span>
<a href="#l80.790"></a><span id="l80.790" class="difflineplus">+      NS_ERROR(&quot;wrong state in parse child line&quot;);</span>
<a href="#l80.791"></a><span id="l80.791" class="difflineplus">+      MOZ_FALLTHROUGH;</span>
<a href="#l80.792"></a><span id="l80.792" class="difflineplus">+    case MimeMultipartSignedBodyFirstLine:</span>
<a href="#l80.793"></a><span id="l80.793" class="difflineplus">+      PR_ASSERT(first_line_p);</span>
<a href="#l80.794"></a><span id="l80.794" class="difflineplus">+      if (!sig-&gt;part_buffer) {</span>
<a href="#l80.795"></a><span id="l80.795" class="difflineplus">+        sig-&gt;part_buffer = MimePartBufferCreate();</span>
<a href="#l80.796"></a><span id="l80.796" class="difflineplus">+        if (!sig-&gt;part_buffer) return MIME_OUT_OF_MEMORY;</span>
<a href="#l80.797"></a><span id="l80.797" class="difflineplus">+      }</span>
<a href="#l80.798"></a><span id="l80.798" class="difflineplus">+      /* fall through */</span>
<a href="#l80.799"></a><span id="l80.799" class="difflineplus">+      MOZ_FALLTHROUGH;</span>
<a href="#l80.800"></a><span id="l80.800" class="difflineplus">+    case MimeMultipartSignedBodyLine: {</span>
<a href="#l80.801"></a><span id="l80.801" class="difflineplus">+      /* This is the first part; we are buffering it, and will emit it all</span>
<a href="#l80.802"></a><span id="l80.802" class="difflineplus">+         at the end (so that we know whether the signature matches before</span>
<a href="#l80.803"></a><span id="l80.803" class="difflineplus">+         showing anything to the user.)</span>
<a href="#l80.804"></a><span id="l80.804" class="difflineplus">+       */</span>
<a href="#l80.805"></a><span id="l80.805"> </span>
<a href="#l80.806"></a><span id="l80.806" class="difflineminus">-    /* The newline issues here are tricky, since both the newlines</span>
<a href="#l80.807"></a><span id="l80.807" class="difflineminus">-       before and after the boundary string are to be considered part</span>
<a href="#l80.808"></a><span id="l80.808" class="difflineminus">-       of the boundary: this is so that a part can be specified such</span>
<a href="#l80.809"></a><span id="l80.809" class="difflineminus">-       that it does not end in a trailing newline.</span>
<a href="#l80.810"></a><span id="l80.810" class="difflineplus">+      /* The newline issues here are tricky, since both the newlines</span>
<a href="#l80.811"></a><span id="l80.811" class="difflineplus">+         before and after the boundary string are to be considered part</span>
<a href="#l80.812"></a><span id="l80.812" class="difflineplus">+         of the boundary: this is so that a part can be specified such</span>
<a href="#l80.813"></a><span id="l80.813" class="difflineplus">+         that it does not end in a trailing newline.</span>
<a href="#l80.814"></a><span id="l80.814"> </span>
<a href="#l80.815"></a><span id="l80.815" class="difflineminus">-       To implement this, we send a newline *before* each line instead</span>
<a href="#l80.816"></a><span id="l80.816" class="difflineminus">-       of after, except for the first line, which is not preceded by a</span>
<a href="#l80.817"></a><span id="l80.817" class="difflineminus">-       newline.</span>
<a href="#l80.818"></a><span id="l80.818" class="difflineminus">-     */</span>
<a href="#l80.819"></a><span id="l80.819" class="difflineplus">+         To implement this, we send a newline *before* each line instead</span>
<a href="#l80.820"></a><span id="l80.820" class="difflineplus">+         of after, except for the first line, which is not preceded by a</span>
<a href="#l80.821"></a><span id="l80.821" class="difflineplus">+         newline.</span>
<a href="#l80.822"></a><span id="l80.822" class="difflineplus">+       */</span>
<a href="#l80.823"></a><span id="l80.823"> </span>
<a href="#l80.824"></a><span id="l80.824" class="difflineminus">-    /* Remove the trailing newline... */</span>
<a href="#l80.825"></a><span id="l80.825" class="difflineminus">-    if (length &gt; 0 &amp;&amp; line[length-1] == '\n') length--;</span>
<a href="#l80.826"></a><span id="l80.826" class="difflineminus">-    if (length &gt; 0 &amp;&amp; line[length-1] == '\r') length--;</span>
<a href="#l80.827"></a><span id="l80.827" class="difflineplus">+      /* Remove the trailing newline... */</span>
<a href="#l80.828"></a><span id="l80.828" class="difflineplus">+      if (length &gt; 0 &amp;&amp; line[length - 1] == '\n') length--;</span>
<a href="#l80.829"></a><span id="l80.829" class="difflineplus">+      if (length &gt; 0 &amp;&amp; line[length - 1] == '\r') length--;</span>
<a href="#l80.830"></a><span id="l80.830"> </span>
<a href="#l80.831"></a><span id="l80.831" class="difflineminus">-    PR_ASSERT(sig-&gt;part_buffer);</span>
<a href="#l80.832"></a><span id="l80.832" class="difflineminus">-    PR_ASSERT(first_line_p ==</span>
<a href="#l80.833"></a><span id="l80.833" class="difflineminus">-          (sig-&gt;state == MimeMultipartSignedBodyFirstLine));</span>
<a href="#l80.834"></a><span id="l80.834" class="difflineplus">+      PR_ASSERT(sig-&gt;part_buffer);</span>
<a href="#l80.835"></a><span id="l80.835" class="difflineplus">+      PR_ASSERT(first_line_p ==</span>
<a href="#l80.836"></a><span id="l80.836" class="difflineplus">+                (sig-&gt;state == MimeMultipartSignedBodyFirstLine));</span>
<a href="#l80.837"></a><span id="l80.837"> </span>
<a href="#l80.838"></a><span id="l80.838" class="difflineminus">-    if (!first_line_p)</span>
<a href="#l80.839"></a><span id="l80.839" class="difflineminus">-      {</span>
<a href="#l80.840"></a><span id="l80.840" class="difflineminus">-      /* Push out a preceding newline... */</span>
<a href="#l80.841"></a><span id="l80.841" class="difflineminus">-      char nl[] = MSG_LINEBREAK;</span>
<a href="#l80.842"></a><span id="l80.842" class="difflineminus">-      status = MimePartBufferWrite (sig-&gt;part_buffer, nl, MSG_LINEBREAK_LEN);</span>
<a href="#l80.843"></a><span id="l80.843" class="difflineminus">-      if (status &lt; 0) return status;</span>
<a href="#l80.844"></a><span id="l80.844" class="difflineplus">+      if (!first_line_p) {</span>
<a href="#l80.845"></a><span id="l80.845" class="difflineplus">+        /* Push out a preceding newline... */</span>
<a href="#l80.846"></a><span id="l80.846" class="difflineplus">+        char nl[] = MSG_LINEBREAK;</span>
<a href="#l80.847"></a><span id="l80.847" class="difflineplus">+        status = MimePartBufferWrite(sig-&gt;part_buffer, nl, MSG_LINEBREAK_LEN);</span>
<a href="#l80.848"></a><span id="l80.848" class="difflineplus">+        if (status &lt; 0) return status;</span>
<a href="#l80.849"></a><span id="l80.849">       }</span>
<a href="#l80.850"></a><span id="l80.850"> </span>
<a href="#l80.851"></a><span id="l80.851" class="difflineminus">-    /* Now push out the line sans trailing newline. */</span>
<a href="#l80.852"></a><span id="l80.852" class="difflineminus">-    if (length &gt; 0)</span>
<a href="#l80.853"></a><span id="l80.853" class="difflineminus">-      status = MimePartBufferWrite (sig-&gt;part_buffer, line, length);</span>
<a href="#l80.854"></a><span id="l80.854" class="difflineminus">-    if (status &lt; 0) return status;</span>
<a href="#l80.855"></a><span id="l80.855" class="difflineminus">-    }</span>
<a href="#l80.856"></a><span id="l80.856" class="difflineminus">-  break;</span>
<a href="#l80.857"></a><span id="l80.857" class="difflineplus">+      /* Now push out the line sans trailing newline. */</span>
<a href="#l80.858"></a><span id="l80.858" class="difflineplus">+      if (length &gt; 0)</span>
<a href="#l80.859"></a><span id="l80.859" class="difflineplus">+        status = MimePartBufferWrite(sig-&gt;part_buffer, line, length);</span>
<a href="#l80.860"></a><span id="l80.860" class="difflineplus">+      if (status &lt; 0) return status;</span>
<a href="#l80.861"></a><span id="l80.861" class="difflineplus">+    } break;</span>
<a href="#l80.862"></a><span id="l80.862"> </span>
<a href="#l80.863"></a><span id="l80.863" class="difflineminus">-  case MimeMultipartSignedSignatureHeaders:</span>
<a href="#l80.864"></a><span id="l80.864" class="difflineminus">-    // How'd we get here?  Oh well, fall through.</span>
<a href="#l80.865"></a><span id="l80.865" class="difflineminus">-    NS_ERROR(&quot;should have already parse sig hdrs&quot;);</span>
<a href="#l80.866"></a><span id="l80.866" class="difflineminus">-    MOZ_FALLTHROUGH;</span>
<a href="#l80.867"></a><span id="l80.867" class="difflineminus">-  case MimeMultipartSignedSignatureFirstLine:</span>
<a href="#l80.868"></a><span id="l80.868" class="difflineminus">-  case MimeMultipartSignedSignatureLine:</span>
<a href="#l80.869"></a><span id="l80.869" class="difflineminus">-    /* Nothing to do here -- hashing of the signature part is handled up</span>
<a href="#l80.870"></a><span id="l80.870" class="difflineminus">-     in MimeMultipartSigned_parse_line().</span>
<a href="#l80.871"></a><span id="l80.871" class="difflineminus">-     */</span>
<a href="#l80.872"></a><span id="l80.872" class="difflineminus">-    break;</span>
<a href="#l80.873"></a><span id="l80.873" class="difflineplus">+    case MimeMultipartSignedSignatureHeaders:</span>
<a href="#l80.874"></a><span id="l80.874" class="difflineplus">+      // How'd we get here?  Oh well, fall through.</span>
<a href="#l80.875"></a><span id="l80.875" class="difflineplus">+      NS_ERROR(&quot;should have already parse sig hdrs&quot;);</span>
<a href="#l80.876"></a><span id="l80.876" class="difflineplus">+      MOZ_FALLTHROUGH;</span>
<a href="#l80.877"></a><span id="l80.877" class="difflineplus">+    case MimeMultipartSignedSignatureFirstLine:</span>
<a href="#l80.878"></a><span id="l80.878" class="difflineplus">+    case MimeMultipartSignedSignatureLine:</span>
<a href="#l80.879"></a><span id="l80.879" class="difflineplus">+      /* Nothing to do here -- hashing of the signature part is handled up</span>
<a href="#l80.880"></a><span id="l80.880" class="difflineplus">+       in MimeMultipartSigned_parse_line().</span>
<a href="#l80.881"></a><span id="l80.881" class="difflineplus">+       */</span>
<a href="#l80.882"></a><span id="l80.882" class="difflineplus">+      break;</span>
<a href="#l80.883"></a><span id="l80.883"> </span>
<a href="#l80.884"></a><span id="l80.884" class="difflineminus">-  case MimeMultipartSignedEpilogue:</span>
<a href="#l80.885"></a><span id="l80.885" class="difflineminus">-    /* Too many kids?  MimeMultipartSigned_create_child() should have</span>
<a href="#l80.886"></a><span id="l80.886" class="difflineminus">-     prevented us from getting here. */</span>
<a href="#l80.887"></a><span id="l80.887" class="difflineminus">-    NS_ERROR(&quot;too many kids?&quot;);</span>
<a href="#l80.888"></a><span id="l80.888" class="difflineminus">-    return -1;</span>
<a href="#l80.889"></a><span id="l80.889" class="difflineminus">-    break;</span>
<a href="#l80.890"></a><span id="l80.890" class="difflineplus">+    case MimeMultipartSignedEpilogue:</span>
<a href="#l80.891"></a><span id="l80.891" class="difflineplus">+      /* Too many kids?  MimeMultipartSigned_create_child() should have</span>
<a href="#l80.892"></a><span id="l80.892" class="difflineplus">+       prevented us from getting here. */</span>
<a href="#l80.893"></a><span id="l80.893" class="difflineplus">+      NS_ERROR(&quot;too many kids?&quot;);</span>
<a href="#l80.894"></a><span id="l80.894" class="difflineplus">+      return -1;</span>
<a href="#l80.895"></a><span id="l80.895" class="difflineplus">+      break;</span>
<a href="#l80.896"></a><span id="l80.896"> </span>
<a href="#l80.897"></a><span id="l80.897" class="difflineminus">-  default: /* bad state */</span>
<a href="#l80.898"></a><span id="l80.898" class="difflineminus">-    NS_ERROR(&quot;bad state in multipart signed parse line&quot;);</span>
<a href="#l80.899"></a><span id="l80.899" class="difflineminus">-    return -1;</span>
<a href="#l80.900"></a><span id="l80.900" class="difflineminus">-    break;</span>
<a href="#l80.901"></a><span id="l80.901" class="difflineplus">+    default: /* bad state */</span>
<a href="#l80.902"></a><span id="l80.902" class="difflineplus">+      NS_ERROR(&quot;bad state in multipart signed parse line&quot;);</span>
<a href="#l80.903"></a><span id="l80.903" class="difflineplus">+      return -1;</span>
<a href="#l80.904"></a><span id="l80.904" class="difflineplus">+      break;</span>
<a href="#l80.905"></a><span id="l80.905">   }</span>
<a href="#l80.906"></a><span id="l80.906"> </span>
<a href="#l80.907"></a><span id="l80.907">   return status;</span>
<a href="#l80.908"></a><span id="l80.908"> }</span>
<a href="#l80.909"></a><span id="l80.909"> </span>
<a href="#l80.910"></a><span id="l80.910" class="difflineminus">-</span>
<a href="#l80.911"></a><span id="l80.911" class="difflineminus">-static int</span>
<a href="#l80.912"></a><span id="l80.912" class="difflineminus">-MimeMultipartSigned_emit_child (MimeObject *obj)</span>
<a href="#l80.913"></a><span id="l80.913" class="difflineminus">-{</span>
<a href="#l80.914"></a><span id="l80.914" class="difflineminus">-  MimeMultipartSigned *sig = (MimeMultipartSigned *) obj;</span>
<a href="#l80.915"></a><span id="l80.915" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) obj;</span>
<a href="#l80.916"></a><span id="l80.916" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) obj;</span>
<a href="#l80.917"></a><span id="l80.917" class="difflineplus">+static int MimeMultipartSigned_emit_child(MimeObject *obj) {</span>
<a href="#l80.918"></a><span id="l80.918" class="difflineplus">+  MimeMultipartSigned *sig = (MimeMultipartSigned *)obj;</span>
<a href="#l80.919"></a><span id="l80.919" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)obj;</span>
<a href="#l80.920"></a><span id="l80.920" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l80.921"></a><span id="l80.921">   int status = 0;</span>
<a href="#l80.922"></a><span id="l80.922">   MimeObject *body;</span>
<a href="#l80.923"></a><span id="l80.923"> </span>
<a href="#l80.924"></a><span id="l80.924">   NS_ASSERTION(sig-&gt;crypto_closure, &quot;no crypto closure&quot;);</span>
<a href="#l80.925"></a><span id="l80.925"> </span>
<a href="#l80.926"></a><span id="l80.926">   /* Emit some HTML saying whether the signature was cool.</span>
<a href="#l80.927"></a><span id="l80.927">    But don't emit anything if in FO_QUOTE_MESSAGE mode.</span>
<a href="#l80.928"></a><span id="l80.928">    */</span>
<a href="#l80.929"></a><span id="l80.929" class="difflineminus">-  if (obj-&gt;options &amp;&amp;</span>
<a href="#l80.930"></a><span id="l80.930" class="difflineminus">-    obj-&gt;options-&gt;headers != MimeHeadersCitation &amp;&amp;</span>
<a href="#l80.931"></a><span id="l80.931" class="difflineminus">-    obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l80.932"></a><span id="l80.932" class="difflineminus">-    obj-&gt;options-&gt;output_fn &amp;&amp;</span>
<a href="#l80.933"></a><span id="l80.933" class="difflineminus">-    obj-&gt;options-&gt;headers != MimeHeadersCitation &amp;&amp;</span>
<a href="#l80.934"></a><span id="l80.934" class="difflineminus">-    sig-&gt;crypto_closure)</span>
<a href="#l80.935"></a><span id="l80.935" class="difflineminus">-  {</span>
<a href="#l80.936"></a><span id="l80.936" class="difflineminus">-    char *html = (((MimeMultipartSignedClass *) obj-&gt;clazz)</span>
<a href="#l80.937"></a><span id="l80.937" class="difflineminus">-          -&gt;crypto_generate_html (sig-&gt;crypto_closure));</span>
<a href="#l80.938"></a><span id="l80.938" class="difflineminus">-#if 0 // XXX For the moment, no HTML output. Fix this XXX //</span>
<a href="#l80.939"></a><span id="l80.939" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;headers != MimeHeadersCitation &amp;&amp;</span>
<a href="#l80.940"></a><span id="l80.940" class="difflineplus">+      obj-&gt;options-&gt;write_html_p &amp;&amp; obj-&gt;options-&gt;output_fn &amp;&amp;</span>
<a href="#l80.941"></a><span id="l80.941" class="difflineplus">+      obj-&gt;options-&gt;headers != MimeHeadersCitation &amp;&amp; sig-&gt;crypto_closure) {</span>
<a href="#l80.942"></a><span id="l80.942" class="difflineplus">+    char *html = (((MimeMultipartSignedClass *)obj-&gt;clazz)</span>
<a href="#l80.943"></a><span id="l80.943" class="difflineplus">+                      -&gt;crypto_generate_html(sig-&gt;crypto_closure));</span>
<a href="#l80.944"></a><span id="l80.944" class="difflineplus">+#if 0  // XXX For the moment, no HTML output. Fix this XXX //</span>
<a href="#l80.945"></a><span id="l80.945">     if (!html) return -1; /* MIME_OUT_OF_MEMORY? */</span>
<a href="#l80.946"></a><span id="l80.946"> </span>
<a href="#l80.947"></a><span id="l80.947">     status = MimeObject_write(obj, html, strlen(html), false);</span>
<a href="#l80.948"></a><span id="l80.948">     PR_Free(html);</span>
<a href="#l80.949"></a><span id="l80.949">     if (status &lt; 0) return status;</span>
<a href="#l80.950"></a><span id="l80.950"> #endif</span>
<a href="#l80.951"></a><span id="l80.951"> </span>
<a href="#l80.952"></a><span id="l80.952">     /* Now that we have written out the crypto stamp, the outermost header</span>
<a href="#l80.953"></a><span id="l80.953">      block is well and truly closed.  If this is in fact the outermost</span>
<a href="#l80.954"></a><span id="l80.954">      message, then run the post_header_html_fn now.</span>
<a href="#l80.955"></a><span id="l80.955">      */</span>
<a href="#l80.956"></a><span id="l80.956" class="difflineminus">-    if (obj-&gt;options &amp;&amp;</span>
<a href="#l80.957"></a><span id="l80.957" class="difflineminus">-      obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l80.958"></a><span id="l80.958" class="difflineminus">-      obj-&gt;options-&gt;generate_post_header_html_fn &amp;&amp;</span>
<a href="#l80.959"></a><span id="l80.959" class="difflineminus">-      !obj-&gt;options-&gt;state-&gt;post_header_html_run_p)</span>
<a href="#l80.960"></a><span id="l80.960" class="difflineminus">-    {</span>
<a href="#l80.961"></a><span id="l80.961" class="difflineminus">-      MimeHeaders *outer_headers=nullptr;</span>
<a href="#l80.962"></a><span id="l80.962" class="difflineplus">+    if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l80.963"></a><span id="l80.963" class="difflineplus">+        obj-&gt;options-&gt;generate_post_header_html_fn &amp;&amp;</span>
<a href="#l80.964"></a><span id="l80.964" class="difflineplus">+        !obj-&gt;options-&gt;state-&gt;post_header_html_run_p) {</span>
<a href="#l80.965"></a><span id="l80.965" class="difflineplus">+      MimeHeaders *outer_headers = nullptr;</span>
<a href="#l80.966"></a><span id="l80.966">       MimeObject *p;</span>
<a href="#l80.967"></a><span id="l80.967" class="difflineminus">-      for (p = obj; p-&gt;parent; p = p-&gt;parent)</span>
<a href="#l80.968"></a><span id="l80.968" class="difflineminus">-      outer_headers = p-&gt;headers;</span>
<a href="#l80.969"></a><span id="l80.969" class="difflineplus">+      for (p = obj; p-&gt;parent; p = p-&gt;parent) outer_headers = p-&gt;headers;</span>
<a href="#l80.970"></a><span id="l80.970">       NS_ASSERTION(obj-&gt;options-&gt;state-&gt;first_data_written_p,</span>
<a href="#l80.971"></a><span id="l80.971">                    &quot;should have already written some data&quot;);</span>
<a href="#l80.972"></a><span id="l80.972" class="difflineminus">-      html = obj-&gt;options-&gt;generate_post_header_html_fn(NULL,</span>
<a href="#l80.973"></a><span id="l80.973" class="difflineminus">-                          obj-&gt;options-&gt;html_closure,</span>
<a href="#l80.974"></a><span id="l80.974" class="difflineminus">-                              outer_headers);</span>
<a href="#l80.975"></a><span id="l80.975" class="difflineplus">+      html = obj-&gt;options-&gt;generate_post_header_html_fn(</span>
<a href="#l80.976"></a><span id="l80.976" class="difflineplus">+          NULL, obj-&gt;options-&gt;html_closure, outer_headers);</span>
<a href="#l80.977"></a><span id="l80.977">       obj-&gt;options-&gt;state-&gt;post_header_html_run_p = true;</span>
<a href="#l80.978"></a><span id="l80.978" class="difflineminus">-      if (html)</span>
<a href="#l80.979"></a><span id="l80.979" class="difflineminus">-      {</span>
<a href="#l80.980"></a><span id="l80.980" class="difflineplus">+      if (html) {</span>
<a href="#l80.981"></a><span id="l80.981">         status = MimeObject_write(obj, html, strlen(html), false);</span>
<a href="#l80.982"></a><span id="l80.982">         PR_Free(html);</span>
<a href="#l80.983"></a><span id="l80.983">         if (status &lt; 0) return status;</span>
<a href="#l80.984"></a><span id="l80.984">       }</span>
<a href="#l80.985"></a><span id="l80.985">     }</span>
<a href="#l80.986"></a><span id="l80.986">   }</span>
<a href="#l80.987"></a><span id="l80.987"> </span>
<a href="#l80.988"></a><span id="l80.988" class="difflineminus">-</span>
<a href="#l80.989"></a><span id="l80.989">   /* Oh, this is fairly nasty.  We're skipping over our &quot;create child&quot; method</span>
<a href="#l80.990"></a><span id="l80.990">    and using the one our superclass defines.  Perhaps instead we should add</span>
<a href="#l80.991"></a><span id="l80.991">    a new method on this class, and initialize that method to be the</span>
<a href="#l80.992"></a><span id="l80.992">    create_child method of the superclass.  Whatever.</span>
<a href="#l80.993"></a><span id="l80.993">    */</span>
<a href="#l80.994"></a><span id="l80.994"> </span>
<a href="#l80.995"></a><span id="l80.995" class="difflineminus">-</span>
<a href="#l80.996"></a><span id="l80.996">   /* The superclass method expects to find the headers for the part that it's</span>
<a href="#l80.997"></a><span id="l80.997">    to create in mult-&gt;hdrs, so ensure that they're there. */</span>
<a href="#l80.998"></a><span id="l80.998">   NS_ASSERTION(!mult-&gt;hdrs, &quot;shouldn't already have hdrs for multipart&quot;);</span>
<a href="#l80.999"></a><span id="l80.999">   if (mult-&gt;hdrs) MimeHeaders_free(mult-&gt;hdrs);</span>
<a href="#l80.1000"></a><span id="l80.1000">   mult-&gt;hdrs = sig-&gt;body_hdrs;</span>
<a href="#l80.1001"></a><span id="l80.1001">   sig-&gt;body_hdrs = 0;</span>
<a href="#l80.1002"></a><span id="l80.1002"> </span>
<a href="#l80.1003"></a><span id="l80.1003">   /* Run the superclass create_child method.</span>
<a href="#l80.1004"></a><span id="l80.1004">    */</span>
<a href="#l80.1005"></a><span id="l80.1005">   status = (((MimeMultipartClass *)(&amp;MIME_SUPERCLASS))-&gt;create_child(obj));</span>
<a href="#l80.1006"></a><span id="l80.1006">   if (status &lt; 0) return status;</span>
<a href="#l80.1007"></a><span id="l80.1007"> </span>
<a href="#l80.1008"></a><span id="l80.1008">   // Notify the charset of the first part.</span>
<a href="#l80.1009"></a><span id="l80.1009">   if (obj-&gt;options &amp;&amp; !(obj-&gt;options-&gt;override_charset)) {</span>
<a href="#l80.1010"></a><span id="l80.1010" class="difflineminus">-    MimeObject *firstChild = ((MimeContainer*) obj)-&gt;children[0];</span>
<a href="#l80.1011"></a><span id="l80.1011" class="difflineminus">-    char *disposition = MimeHeaders_get (firstChild-&gt;headers,</span>
<a href="#l80.1012"></a><span id="l80.1012" class="difflineminus">-                                         HEADER_CONTENT_DISPOSITION,</span>
<a href="#l80.1013"></a><span id="l80.1013" class="difflineminus">-                                         true,</span>
<a href="#l80.1014"></a><span id="l80.1014" class="difflineminus">-                                         false);</span>
<a href="#l80.1015"></a><span id="l80.1015" class="difflineplus">+    MimeObject *firstChild = ((MimeContainer *)obj)-&gt;children[0];</span>
<a href="#l80.1016"></a><span id="l80.1016" class="difflineplus">+    char *disposition = MimeHeaders_get(</span>
<a href="#l80.1017"></a><span id="l80.1017" class="difflineplus">+        firstChild-&gt;headers, HEADER_CONTENT_DISPOSITION, true, false);</span>
<a href="#l80.1018"></a><span id="l80.1018">     // check if need to show as inline</span>
<a href="#l80.1019"></a><span id="l80.1019" class="difflineminus">-    if (!disposition)</span>
<a href="#l80.1020"></a><span id="l80.1020" class="difflineminus">-    {</span>
<a href="#l80.1021"></a><span id="l80.1021" class="difflineplus">+    if (!disposition) {</span>
<a href="#l80.1022"></a><span id="l80.1022">       const char *content_type = firstChild-&gt;content_type;</span>
<a href="#l80.1023"></a><span id="l80.1023" class="difflineminus">-      if (!PL_strcasecmp (content_type, TEXT_PLAIN) ||</span>
<a href="#l80.1024"></a><span id="l80.1024" class="difflineminus">-          !PL_strcasecmp (content_type, TEXT_HTML) ||</span>
<a href="#l80.1025"></a><span id="l80.1025" class="difflineminus">-          !PL_strcasecmp (content_type, TEXT_MDL) ||</span>
<a href="#l80.1026"></a><span id="l80.1026" class="difflineminus">-          !PL_strcasecmp (content_type, MULTIPART_ALTERNATIVE) ||</span>
<a href="#l80.1027"></a><span id="l80.1027" class="difflineminus">-          !PL_strcasecmp (content_type, MULTIPART_RELATED) ||</span>
<a href="#l80.1028"></a><span id="l80.1028" class="difflineminus">-          !PL_strcasecmp (content_type, MESSAGE_NEWS) ||</span>
<a href="#l80.1029"></a><span id="l80.1029" class="difflineminus">-          !PL_strcasecmp (content_type, MESSAGE_RFC822)) {</span>
<a href="#l80.1030"></a><span id="l80.1030" class="difflineminus">-        char *ct = MimeHeaders_get(mult-&gt;hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l80.1031"></a><span id="l80.1031" class="difflineplus">+      if (!PL_strcasecmp(content_type, TEXT_PLAIN) ||</span>
<a href="#l80.1032"></a><span id="l80.1032" class="difflineplus">+          !PL_strcasecmp(content_type, TEXT_HTML) ||</span>
<a href="#l80.1033"></a><span id="l80.1033" class="difflineplus">+          !PL_strcasecmp(content_type, TEXT_MDL) ||</span>
<a href="#l80.1034"></a><span id="l80.1034" class="difflineplus">+          !PL_strcasecmp(content_type, MULTIPART_ALTERNATIVE) ||</span>
<a href="#l80.1035"></a><span id="l80.1035" class="difflineplus">+          !PL_strcasecmp(content_type, MULTIPART_RELATED) ||</span>
<a href="#l80.1036"></a><span id="l80.1036" class="difflineplus">+          !PL_strcasecmp(content_type, MESSAGE_NEWS) ||</span>
<a href="#l80.1037"></a><span id="l80.1037" class="difflineplus">+          !PL_strcasecmp(content_type, MESSAGE_RFC822)) {</span>
<a href="#l80.1038"></a><span id="l80.1038" class="difflineplus">+        char *ct =</span>
<a href="#l80.1039"></a><span id="l80.1039" class="difflineplus">+            MimeHeaders_get(mult-&gt;hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l80.1040"></a><span id="l80.1040">         if (ct) {</span>
<a href="#l80.1041"></a><span id="l80.1041" class="difflineminus">-          char *cset = MimeHeaders_get_parameter (ct, &quot;charset&quot;, NULL, NULL);</span>
<a href="#l80.1042"></a><span id="l80.1042" class="difflineplus">+          char *cset = MimeHeaders_get_parameter(ct, &quot;charset&quot;, NULL, NULL);</span>
<a href="#l80.1043"></a><span id="l80.1043">           if (cset) {</span>
<a href="#l80.1044"></a><span id="l80.1044">             mimeEmitterUpdateCharacterSet(obj-&gt;options, cset);</span>
<a href="#l80.1045"></a><span id="l80.1045">             SetMailCharacterSetToMsgWindow(obj, cset);</span>
<a href="#l80.1046"></a><span id="l80.1046">             PR_Free(cset);</span>
<a href="#l80.1047"></a><span id="l80.1047">           }</span>
<a href="#l80.1048"></a><span id="l80.1048">           PR_Free(ct);</span>
<a href="#l80.1049"></a><span id="l80.1049">         }</span>
<a href="#l80.1050"></a><span id="l80.1050">       }</span>
<a href="#l80.1051"></a><span id="l80.1051">     }</span>
<a href="#l80.1052"></a><span id="l80.1052">   }</span>
<a href="#l80.1053"></a><span id="l80.1053"> </span>
<a href="#l80.1054"></a><span id="l80.1054">   // The js emitter wants to know about the newly created child.  Because</span>
<a href="#l80.1055"></a><span id="l80.1055">   //  MimeMultipartSigned dummies out its create_child operation, the logic</span>
<a href="#l80.1056"></a><span id="l80.1056">   //  in MimeMultipart_parse_line that would normally provide this notification</span>
<a href="#l80.1057"></a><span id="l80.1057">   //  does not get to fire.</span>
<a href="#l80.1058"></a><span id="l80.1058">   if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;notify_nested_bodies) {</span>
<a href="#l80.1059"></a><span id="l80.1059" class="difflineminus">-    MimeObject *kid = ((MimeContainer*) obj)-&gt;children[0];</span>
<a href="#l80.1060"></a><span id="l80.1060" class="difflineplus">+    MimeObject *kid = ((MimeContainer *)obj)-&gt;children[0];</span>
<a href="#l80.1061"></a><span id="l80.1061">     // The emitter is expecting the content type with parameters; not the fully</span>
<a href="#l80.1062"></a><span id="l80.1062">     //  parsed thing, so get it from raw.  (We do not do it in the charset</span>
<a href="#l80.1063"></a><span id="l80.1063">     //  notification block that just happened because it already has complex</span>
<a href="#l80.1064"></a><span id="l80.1064">     //  if-checks that do not jive with us.</span>
<a href="#l80.1065"></a><span id="l80.1065" class="difflineminus">-    char *ct = MimeHeaders_get(mult-&gt;hdrs, HEADER_CONTENT_TYPE, false,</span>
<a href="#l80.1066"></a><span id="l80.1066" class="difflineminus">-                               false);</span>
<a href="#l80.1067"></a><span id="l80.1067" class="difflineplus">+    char *ct = MimeHeaders_get(mult-&gt;hdrs, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l80.1068"></a><span id="l80.1068">     mimeEmitterAddHeaderField(obj-&gt;options, HEADER_CONTENT_TYPE,</span>
<a href="#l80.1069"></a><span id="l80.1069">                               ct ? ct : &quot;text/plain&quot;);</span>
<a href="#l80.1070"></a><span id="l80.1070">     PR_Free(ct);</span>
<a href="#l80.1071"></a><span id="l80.1071"> </span>
<a href="#l80.1072"></a><span id="l80.1072">     char *part_path = mime_part_address(kid);</span>
<a href="#l80.1073"></a><span id="l80.1073">     if (part_path) {</span>
<a href="#l80.1074"></a><span id="l80.1074" class="difflineminus">-      mimeEmitterAddHeaderField(obj-&gt;options,</span>
<a href="#l80.1075"></a><span id="l80.1075" class="difflineminus">-                                &quot;x-jsemitter-part-path&quot;,</span>
<a href="#l80.1076"></a><span id="l80.1076" class="difflineplus">+      mimeEmitterAddHeaderField(obj-&gt;options, &quot;x-jsemitter-part-path&quot;,</span>
<a href="#l80.1077"></a><span id="l80.1077">                                 part_path);</span>
<a href="#l80.1078"></a><span id="l80.1078">       PR_Free(part_path);</span>
<a href="#l80.1079"></a><span id="l80.1079">     }</span>
<a href="#l80.1080"></a><span id="l80.1080">   }</span>
<a href="#l80.1081"></a><span id="l80.1081"> </span>
<a href="#l80.1082"></a><span id="l80.1082">   /* Retrieve the child that it created.</span>
<a href="#l80.1083"></a><span id="l80.1083">    */</span>
<a href="#l80.1084"></a><span id="l80.1084">   NS_ASSERTION(cont-&gt;nchildren == 1, &quot;should only have one child&quot;);</span>
<a href="#l80.1085"></a><span id="l80.1085" class="difflineminus">-  if (cont-&gt;nchildren != 1)</span>
<a href="#l80.1086"></a><span id="l80.1086" class="difflineminus">-    return -1;</span>
<a href="#l80.1087"></a><span id="l80.1087" class="difflineplus">+  if (cont-&gt;nchildren != 1) return -1;</span>
<a href="#l80.1088"></a><span id="l80.1088">   body = cont-&gt;children[0];</span>
<a href="#l80.1089"></a><span id="l80.1089">   NS_ASSERTION(body, &quot;missing body&quot;);</span>
<a href="#l80.1090"></a><span id="l80.1090" class="difflineminus">-  if (!body)</span>
<a href="#l80.1091"></a><span id="l80.1091" class="difflineminus">-    return -1;</span>
<a href="#l80.1092"></a><span id="l80.1092" class="difflineplus">+  if (!body) return -1;</span>
<a href="#l80.1093"></a><span id="l80.1093"> </span>
<a href="#l80.1094"></a><span id="l80.1094"> #ifdef MIME_DRAFTS</span>
<a href="#l80.1095"></a><span id="l80.1095">   if (body-&gt;options-&gt;decompose_file_p) {</span>
<a href="#l80.1096"></a><span id="l80.1096">     body-&gt;options-&gt;signed_p = true;</span>
<a href="#l80.1097"></a><span id="l80.1097" class="difflineminus">-    if (!mime_typep(body, (MimeObjectClass*)&amp;mimeMultipartClass) &amp;&amp;</span>
<a href="#l80.1098"></a><span id="l80.1098" class="difflineminus">-    body-&gt;options-&gt;decompose_file_init_fn)</span>
<a href="#l80.1099"></a><span id="l80.1099" class="difflineminus">-    body-&gt;options-&gt;decompose_file_init_fn ( body-&gt;options-&gt;stream_closure, body-&gt;headers );</span>
<a href="#l80.1100"></a><span id="l80.1100" class="difflineplus">+    if (!mime_typep(body, (MimeObjectClass *)&amp;mimeMultipartClass) &amp;&amp;</span>
<a href="#l80.1101"></a><span id="l80.1101" class="difflineplus">+        body-&gt;options-&gt;decompose_file_init_fn)</span>
<a href="#l80.1102"></a><span id="l80.1102" class="difflineplus">+      body-&gt;options-&gt;decompose_file_init_fn(body-&gt;options-&gt;stream_closure,</span>
<a href="#l80.1103"></a><span id="l80.1103" class="difflineplus">+                                            body-&gt;headers);</span>
<a href="#l80.1104"></a><span id="l80.1104">   }</span>
<a href="#l80.1105"></a><span id="l80.1105"> #endif /* MIME_DRAFTS */</span>
<a href="#l80.1106"></a><span id="l80.1106"> </span>
<a href="#l80.1107"></a><span id="l80.1107">   /* If there's no part_buffer, this is a zero-length signed message? */</span>
<a href="#l80.1108"></a><span id="l80.1108" class="difflineminus">-  if (sig-&gt;part_buffer)</span>
<a href="#l80.1109"></a><span id="l80.1109" class="difflineminus">-  {</span>
<a href="#l80.1110"></a><span id="l80.1110" class="difflineplus">+  if (sig-&gt;part_buffer) {</span>
<a href="#l80.1111"></a><span id="l80.1111"> #ifdef MIME_DRAFTS</span>
<a href="#l80.1112"></a><span id="l80.1112">     if (body-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l80.1113"></a><span id="l80.1113" class="difflineminus">-      !mime_typep(body, (MimeObjectClass*)&amp;mimeMultipartClass)  &amp;&amp;</span>
<a href="#l80.1114"></a><span id="l80.1114" class="difflineminus">-      body-&gt;options-&gt;decompose_file_output_fn)</span>
<a href="#l80.1115"></a><span id="l80.1115" class="difflineminus">-      status = MimePartBufferRead (sig-&gt;part_buffer,</span>
<a href="#l80.1116"></a><span id="l80.1116" class="difflineminus">-                 /* The (MimeConverterOutputCallback) cast is to turn the</span>
<a href="#l80.1117"></a><span id="l80.1117" class="difflineminus">-                  `void' argument into `MimeObject'. */</span>
<a href="#l80.1118"></a><span id="l80.1118" class="difflineminus">-                 ((MimeConverterOutputCallback)</span>
<a href="#l80.1119"></a><span id="l80.1119" class="difflineminus">-                 body-&gt;options-&gt;decompose_file_output_fn),</span>
<a href="#l80.1120"></a><span id="l80.1120" class="difflineminus">-                 body-&gt;options-&gt;stream_closure);</span>
<a href="#l80.1121"></a><span id="l80.1121" class="difflineplus">+        !mime_typep(body, (MimeObjectClass *)&amp;mimeMultipartClass) &amp;&amp;</span>
<a href="#l80.1122"></a><span id="l80.1122" class="difflineplus">+        body-&gt;options-&gt;decompose_file_output_fn)</span>
<a href="#l80.1123"></a><span id="l80.1123" class="difflineplus">+      status =</span>
<a href="#l80.1124"></a><span id="l80.1124" class="difflineplus">+          MimePartBufferRead(sig-&gt;part_buffer,</span>
<a href="#l80.1125"></a><span id="l80.1125" class="difflineplus">+                             /* The (MimeConverterOutputCallback) cast is to</span>
<a href="#l80.1126"></a><span id="l80.1126" class="difflineplus">+                              turn the `void' argument into `MimeObject'. */</span>
<a href="#l80.1127"></a><span id="l80.1127" class="difflineplus">+                             ((MimeConverterOutputCallback)</span>
<a href="#l80.1128"></a><span id="l80.1128" class="difflineplus">+                                  body-&gt;options-&gt;decompose_file_output_fn),</span>
<a href="#l80.1129"></a><span id="l80.1129" class="difflineplus">+                             body-&gt;options-&gt;stream_closure);</span>
<a href="#l80.1130"></a><span id="l80.1130">     else</span>
<a href="#l80.1131"></a><span id="l80.1131"> #endif /* MIME_DRAFTS */</span>
<a href="#l80.1132"></a><span id="l80.1132"> </span>
<a href="#l80.1133"></a><span id="l80.1133" class="difflineminus">-    status = MimePartBufferRead (sig-&gt;part_buffer,</span>
<a href="#l80.1134"></a><span id="l80.1134" class="difflineminus">-                 /* The (MimeConverterOutputCallback) cast is to turn the</span>
<a href="#l80.1135"></a><span id="l80.1135" class="difflineminus">-                  `void' argument into `MimeObject'. */</span>
<a href="#l80.1136"></a><span id="l80.1136" class="difflineminus">-                 ((MimeConverterOutputCallback) body-&gt;clazz-&gt;parse_buffer),</span>
<a href="#l80.1137"></a><span id="l80.1137" class="difflineminus">-                body);</span>
<a href="#l80.1138"></a><span id="l80.1138" class="difflineplus">+      status = MimePartBufferRead(</span>
<a href="#l80.1139"></a><span id="l80.1139" class="difflineplus">+          sig-&gt;part_buffer,</span>
<a href="#l80.1140"></a><span id="l80.1140" class="difflineplus">+          /* The (MimeConverterOutputCallback) cast is to turn the</span>
<a href="#l80.1141"></a><span id="l80.1141" class="difflineplus">+           `void' argument into `MimeObject'. */</span>
<a href="#l80.1142"></a><span id="l80.1142" class="difflineplus">+          ((MimeConverterOutputCallback)body-&gt;clazz-&gt;parse_buffer), body);</span>
<a href="#l80.1143"></a><span id="l80.1143">     if (status &lt; 0) return status;</span>
<a href="#l80.1144"></a><span id="l80.1144">   }</span>
<a href="#l80.1145"></a><span id="l80.1145"> </span>
<a href="#l80.1146"></a><span id="l80.1146">   MimeMultipartSigned_cleanup(obj, false);</span>
<a href="#l80.1147"></a><span id="l80.1147"> </span>
<a href="#l80.1148"></a><span id="l80.1148">   /* Done parsing. */</span>
<a href="#l80.1149"></a><span id="l80.1149">   status = body-&gt;clazz-&gt;parse_eof(body, false);</span>
<a href="#l80.1150"></a><span id="l80.1150">   if (status &lt; 0) return status;</span>
<a href="#l80.1151"></a><span id="l80.1151">   status = body-&gt;clazz-&gt;parse_end(body, false);</span>
<a href="#l80.1152"></a><span id="l80.1152">   if (status &lt; 0) return status;</span>
<a href="#l80.1153"></a><span id="l80.1153"> </span>
<a href="#l80.1154"></a><span id="l80.1154"> #ifdef MIME_DRAFTS</span>
<a href="#l80.1155"></a><span id="l80.1155">   if (body-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l80.1156"></a><span id="l80.1156" class="difflineminus">-    !mime_typep(body, (MimeObjectClass*)&amp;mimeMultipartClass)  &amp;&amp;</span>
<a href="#l80.1157"></a><span id="l80.1157" class="difflineminus">-    body-&gt;options-&gt;decompose_file_close_fn)</span>
<a href="#l80.1158"></a><span id="l80.1158" class="difflineplus">+      !mime_typep(body, (MimeObjectClass *)&amp;mimeMultipartClass) &amp;&amp;</span>
<a href="#l80.1159"></a><span id="l80.1159" class="difflineplus">+      body-&gt;options-&gt;decompose_file_close_fn)</span>
<a href="#l80.1160"></a><span id="l80.1160">     body-&gt;options-&gt;decompose_file_close_fn(body-&gt;options-&gt;stream_closure);</span>
<a href="#l80.1161"></a><span id="l80.1161"> #endif /* MIME_DRAFTS */</span>
<a href="#l80.1162"></a><span id="l80.1162"> </span>
<a href="#l80.1163"></a><span id="l80.1163">   /* Put out a separator after every multipart/signed object. */</span>
<a href="#l80.1164"></a><span id="l80.1164">   status = MimeObject_write_separator(obj);</span>
<a href="#l80.1165"></a><span id="l80.1165">   if (status &lt; 0) return status;</span>
<a href="#l80.1166"></a><span id="l80.1166"> </span>
<a href="#l80.1167"></a><span id="l80.1167">   return 0;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/mailnews/mime/src/mimemsig.h</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/mailnews/mime/src/mimemsig.h</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -66,17 +66,17 @@</span>
<a href="#l81.4"></a><span id="l81.4">    void crypto_free (void *crypto_closure)</span>
<a href="#l81.5"></a><span id="l81.5"> </span>
<a href="#l81.6"></a><span id="l81.6">      This will be called when we're all done, after `crypto_signature_eof' and</span>
<a href="#l81.7"></a><span id="l81.7">    `crypto_emit_html'.  It is intended to free any data represented by the</span>
<a href="#l81.8"></a><span id="l81.8">    crypto_closure.</span>
<a href="#l81.9"></a><span id="l81.9">  */</span>
<a href="#l81.10"></a><span id="l81.10"> </span>
<a href="#l81.11"></a><span id="l81.11"> typedef struct MimeMultipartSignedClass MimeMultipartSignedClass;</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-typedef struct MimeMultipartSigned      MimeMultipartSigned;</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+typedef struct MimeMultipartSigned MimeMultipartSigned;</span>
<a href="#l81.14"></a><span id="l81.14"> </span>
<a href="#l81.15"></a><span id="l81.15"> typedef enum {</span>
<a href="#l81.16"></a><span id="l81.16">   MimeMultipartSignedPreamble,</span>
<a href="#l81.17"></a><span id="l81.17">   MimeMultipartSignedBodyFirstHeader,</span>
<a href="#l81.18"></a><span id="l81.18">   MimeMultipartSignedBodyHeaders,</span>
<a href="#l81.19"></a><span id="l81.19">   MimeMultipartSignedBodyFirstLine,</span>
<a href="#l81.20"></a><span id="l81.20">   MimeMultipartSignedBodyLine,</span>
<a href="#l81.21"></a><span id="l81.21">   MimeMultipartSignedSignatureHeaders,</span>
<a href="#l81.22"></a><span id="l81.22" class="difflineat">@@ -84,51 +84,51 @@ typedef enum {</span>
<a href="#l81.23"></a><span id="l81.23">   MimeMultipartSignedSignatureLine,</span>
<a href="#l81.24"></a><span id="l81.24">   MimeMultipartSignedEpilogue</span>
<a href="#l81.25"></a><span id="l81.25"> } MimeMultipartSignedParseState;</span>
<a href="#l81.26"></a><span id="l81.26"> </span>
<a href="#l81.27"></a><span id="l81.27"> struct MimeMultipartSignedClass {</span>
<a href="#l81.28"></a><span id="l81.28">   MimeMultipartClass multipart;</span>
<a href="#l81.29"></a><span id="l81.29"> </span>
<a href="#l81.30"></a><span id="l81.30">   /* Callbacks used by dexlateion (really, signature verification) module. */</span>
<a href="#l81.31"></a><span id="l81.31" class="difflineminus">-  void * (*crypto_init) (MimeObject *multipart_object);</span>
<a href="#l81.32"></a><span id="l81.32" class="difflineplus">+  void *(*crypto_init)(MimeObject *multipart_object);</span>
<a href="#l81.33"></a><span id="l81.33"> </span>
<a href="#l81.34"></a><span id="l81.34" class="difflineminus">-  int (*crypto_data_hash)      (const char *data, int32_t data_size,</span>
<a href="#l81.35"></a><span id="l81.35" class="difflineminus">-                void *crypto_closure);</span>
<a href="#l81.36"></a><span id="l81.36" class="difflineminus">-  int (*crypto_signature_hash) (const char *data, int32_t data_size,</span>
<a href="#l81.37"></a><span id="l81.37" class="difflineminus">-                void *crypto_closure);</span>
<a href="#l81.38"></a><span id="l81.38" class="difflineplus">+  int (*crypto_data_hash)(const char *data, int32_t data_size,</span>
<a href="#l81.39"></a><span id="l81.39" class="difflineplus">+                          void *crypto_closure);</span>
<a href="#l81.40"></a><span id="l81.40" class="difflineplus">+  int (*crypto_signature_hash)(const char *data, int32_t data_size,</span>
<a href="#l81.41"></a><span id="l81.41" class="difflineplus">+                               void *crypto_closure);</span>
<a href="#l81.42"></a><span id="l81.42"> </span>
<a href="#l81.43"></a><span id="l81.43" class="difflineminus">-  int (*crypto_data_eof)      (void *crypto_closure, bool abort_p);</span>
<a href="#l81.44"></a><span id="l81.44" class="difflineminus">-  int (*crypto_signature_eof) (void *crypto_closure, bool abort_p);</span>
<a href="#l81.45"></a><span id="l81.45" class="difflineplus">+  int (*crypto_data_eof)(void *crypto_closure, bool abort_p);</span>
<a href="#l81.46"></a><span id="l81.46" class="difflineplus">+  int (*crypto_signature_eof)(void *crypto_closure, bool abort_p);</span>
<a href="#l81.47"></a><span id="l81.47"> </span>
<a href="#l81.48"></a><span id="l81.48" class="difflineminus">-  int (*crypto_signature_init) (void *crypto_closure,</span>
<a href="#l81.49"></a><span id="l81.49" class="difflineminus">-                MimeObject *multipart_object,</span>
<a href="#l81.50"></a><span id="l81.50" class="difflineminus">-                MimeHeaders *signature_hdrs);</span>
<a href="#l81.51"></a><span id="l81.51" class="difflineplus">+  int (*crypto_signature_init)(void *crypto_closure,</span>
<a href="#l81.52"></a><span id="l81.52" class="difflineplus">+                               MimeObject *multipart_object,</span>
<a href="#l81.53"></a><span id="l81.53" class="difflineplus">+                               MimeHeaders *signature_hdrs);</span>
<a href="#l81.54"></a><span id="l81.54"> </span>
<a href="#l81.55"></a><span id="l81.55" class="difflineminus">-  char * (*crypto_generate_html) (void *crypto_closure);</span>
<a href="#l81.56"></a><span id="l81.56" class="difflineplus">+  char *(*crypto_generate_html)(void *crypto_closure);</span>
<a href="#l81.57"></a><span id="l81.57"> </span>
<a href="#l81.58"></a><span id="l81.58" class="difflineminus">-  void (*crypto_free) (void *crypto_closure);</span>
<a href="#l81.59"></a><span id="l81.59" class="difflineplus">+  void (*crypto_free)(void *crypto_closure);</span>
<a href="#l81.60"></a><span id="l81.60"> };</span>
<a href="#l81.61"></a><span id="l81.61"> </span>
<a href="#l81.62"></a><span id="l81.62"> extern &quot;C&quot; MimeMultipartSignedClass mimeMultipartSignedClass;</span>
<a href="#l81.63"></a><span id="l81.63"> </span>
<a href="#l81.64"></a><span id="l81.64"> struct MimeMultipartSigned {</span>
<a href="#l81.65"></a><span id="l81.65">   MimeMultipart multipart;</span>
<a href="#l81.66"></a><span id="l81.66" class="difflineminus">-  MimeMultipartSignedParseState state;  /* State of parser */</span>
<a href="#l81.67"></a><span id="l81.67" class="difflineplus">+  MimeMultipartSignedParseState state; /* State of parser */</span>
<a href="#l81.68"></a><span id="l81.68"> </span>
<a href="#l81.69"></a><span id="l81.69" class="difflineminus">-  void *crypto_closure;           /* Opaque data used by signature</span>
<a href="#l81.70"></a><span id="l81.70" class="difflineminus">-                      verification module. */</span>
<a href="#l81.71"></a><span id="l81.71" class="difflineplus">+  void *crypto_closure; /* Opaque data used by signature</span>
<a href="#l81.72"></a><span id="l81.72" class="difflineplus">+            verification module. */</span>
<a href="#l81.73"></a><span id="l81.73"> </span>
<a href="#l81.74"></a><span id="l81.74" class="difflineminus">-  MimeHeaders *body_hdrs;        /* The headers of the signed object. */</span>
<a href="#l81.75"></a><span id="l81.75" class="difflineminus">-  MimeHeaders *sig_hdrs;        /* The headers of the signature. */</span>
<a href="#l81.76"></a><span id="l81.76" class="difflineplus">+  MimeHeaders *body_hdrs; /* The headers of the signed object. */</span>
<a href="#l81.77"></a><span id="l81.77" class="difflineplus">+  MimeHeaders *sig_hdrs;  /* The headers of the signature. */</span>
<a href="#l81.78"></a><span id="l81.78"> </span>
<a href="#l81.79"></a><span id="l81.79" class="difflineminus">-  MimePartBufferData *part_buffer;      /* The buffered body of the signed</span>
<a href="#l81.80"></a><span id="l81.80" class="difflineminus">-                       object (see mimepbuf.h) */</span>
<a href="#l81.81"></a><span id="l81.81" class="difflineplus">+  MimePartBufferData *part_buffer; /* The buffered body of the signed</span>
<a href="#l81.82"></a><span id="l81.82" class="difflineplus">+                  object (see mimepbuf.h) */</span>
<a href="#l81.83"></a><span id="l81.83"> </span>
<a href="#l81.84"></a><span id="l81.84" class="difflineminus">-  MimeDecoderData *sig_decoder_data;  /* The signature is probably base64</span>
<a href="#l81.85"></a><span id="l81.85" class="difflineminus">-                       encoded; this is the decoder used</span>
<a href="#l81.86"></a><span id="l81.86" class="difflineminus">-                       to get raw bits out of it. */</span>
<a href="#l81.87"></a><span id="l81.87" class="difflineplus">+  MimeDecoderData *sig_decoder_data; /* The signature is probably base64</span>
<a href="#l81.88"></a><span id="l81.88" class="difflineplus">+                      encoded; this is the decoder used</span>
<a href="#l81.89"></a><span id="l81.89" class="difflineplus">+                      to get raw bits out of it. */</span>
<a href="#l81.90"></a><span id="l81.90"> };</span>
<a href="#l81.91"></a><span id="l81.91"> </span>
<a href="#l81.92"></a><span id="l81.92" class="difflineminus">-#define MimeMultipartSignedClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l81.93"></a><span id="l81.93" class="difflineminus">-  { MimeMultipartClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l81.94"></a><span id="l81.94" class="difflineplus">+#define MimeMultipartSignedClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l81.95"></a><span id="l81.95" class="difflineplus">+  { MimeMultipartClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l81.96"></a><span id="l81.96"> </span>
<a href="#l81.97"></a><span id="l81.97"> #endif /* _MIMEMSIG_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/mailnews/mime/src/mimemult.cpp</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/mailnews/mime/src/mimemult.cpp</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -12,737 +12,694 @@</span>
<a href="#l82.4"></a><span id="l82.4"> #include &quot;prmem.h&quot;</span>
<a href="#l82.5"></a><span id="l82.5"> #include &quot;plstr.h&quot;</span>
<a href="#l82.6"></a><span id="l82.6"> #include &quot;prio.h&quot;</span>
<a href="#l82.7"></a><span id="l82.7"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l82.8"></a><span id="l82.8"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l82.9"></a><span id="l82.9"> #include &lt;ctype.h&gt;</span>
<a href="#l82.10"></a><span id="l82.10"> </span>
<a href="#l82.11"></a><span id="l82.11"> #ifdef XP_MACOSX</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-  extern MimeObjectClass mimeMultipartAppleDoubleClass;</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+extern MimeObjectClass mimeMultipartAppleDoubleClass;</span>
<a href="#l82.14"></a><span id="l82.14"> #endif</span>
<a href="#l82.15"></a><span id="l82.15"> </span>
<a href="#l82.16"></a><span id="l82.16"> #define MIME_SUPERCLASS mimeContainerClass</span>
<a href="#l82.17"></a><span id="l82.17" class="difflineminus">-MimeDefClass(MimeMultipart, MimeMultipartClass,</span>
<a href="#l82.18"></a><span id="l82.18" class="difflineminus">-       mimeMultipartClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l82.19"></a><span id="l82.19" class="difflineplus">+MimeDefClass(MimeMultipart, MimeMultipartClass, mimeMultipartClass,</span>
<a href="#l82.20"></a><span id="l82.20" class="difflineplus">+             &amp;MIME_SUPERCLASS);</span>
<a href="#l82.21"></a><span id="l82.21"> </span>
<a href="#l82.22"></a><span id="l82.22" class="difflineminus">-static int MimeMultipart_initialize (MimeObject *);</span>
<a href="#l82.23"></a><span id="l82.23" class="difflineminus">-static void MimeMultipart_finalize (MimeObject *);</span>
<a href="#l82.24"></a><span id="l82.24" class="difflineminus">-static int MimeMultipart_parse_line (const char *line, int32_t length, MimeObject *);</span>
<a href="#l82.25"></a><span id="l82.25" class="difflineminus">-static int MimeMultipart_parse_eof (MimeObject *object, bool abort_p);</span>
<a href="#l82.26"></a><span id="l82.26" class="difflineplus">+static int MimeMultipart_initialize(MimeObject *);</span>
<a href="#l82.27"></a><span id="l82.27" class="difflineplus">+static void MimeMultipart_finalize(MimeObject *);</span>
<a href="#l82.28"></a><span id="l82.28" class="difflineplus">+static int MimeMultipart_parse_line(const char *line, int32_t length,</span>
<a href="#l82.29"></a><span id="l82.29" class="difflineplus">+                                    MimeObject *);</span>
<a href="#l82.30"></a><span id="l82.30" class="difflineplus">+static int MimeMultipart_parse_eof(MimeObject *object, bool abort_p);</span>
<a href="#l82.31"></a><span id="l82.31"> </span>
<a href="#l82.32"></a><span id="l82.32"> static MimeMultipartBoundaryType MimeMultipart_check_boundary(MimeObject *,</span>
<a href="#l82.33"></a><span id="l82.33" class="difflineminus">-                                const char *,</span>
<a href="#l82.34"></a><span id="l82.34" class="difflineminus">-                                int32_t);</span>
<a href="#l82.35"></a><span id="l82.35" class="difflineplus">+                                                              const char *,</span>
<a href="#l82.36"></a><span id="l82.36" class="difflineplus">+                                                              int32_t);</span>
<a href="#l82.37"></a><span id="l82.37"> static int MimeMultipart_create_child(MimeObject *);</span>
<a href="#l82.38"></a><span id="l82.38"> static bool MimeMultipart_output_child_p(MimeObject *, MimeObject *);</span>
<a href="#l82.39"></a><span id="l82.39" class="difflineminus">-static int MimeMultipart_parse_child_line (MimeObject *, const char *, int32_t,</span>
<a href="#l82.40"></a><span id="l82.40" class="difflineminus">-                       bool);</span>
<a href="#l82.41"></a><span id="l82.41" class="difflineplus">+static int MimeMultipart_parse_child_line(MimeObject *, const char *, int32_t,</span>
<a href="#l82.42"></a><span id="l82.42" class="difflineplus">+                                          bool);</span>
<a href="#l82.43"></a><span id="l82.43"> static int MimeMultipart_close_child(MimeObject *);</span>
<a href="#l82.44"></a><span id="l82.44"> </span>
<a href="#l82.45"></a><span id="l82.45"> extern &quot;C&quot; MimeObjectClass mimeMultipartAlternativeClass;</span>
<a href="#l82.46"></a><span id="l82.46"> extern &quot;C&quot; MimeObjectClass mimeMultipartRelatedClass;</span>
<a href="#l82.47"></a><span id="l82.47"> extern &quot;C&quot; MimeObjectClass mimeMultipartSignedClass;</span>
<a href="#l82.48"></a><span id="l82.48"> extern &quot;C&quot; MimeObjectClass mimeInlineTextVCardClass;</span>
<a href="#l82.49"></a><span id="l82.49"> extern &quot;C&quot; MimeExternalObjectClass mimeExternalObjectClass;</span>
<a href="#l82.50"></a><span id="l82.50"> </span>
<a href="#l82.51"></a><span id="l82.51"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l82.52"></a><span id="l82.52" class="difflineminus">-static int MimeMultipart_debug_print (MimeObject *, PRFileDesc *, int32_t);</span>
<a href="#l82.53"></a><span id="l82.53" class="difflineplus">+static int MimeMultipart_debug_print(MimeObject *, PRFileDesc *, int32_t);</span>
<a href="#l82.54"></a><span id="l82.54"> #endif</span>
<a href="#l82.55"></a><span id="l82.55"> </span>
<a href="#l82.56"></a><span id="l82.56" class="difflineminus">-static int</span>
<a href="#l82.57"></a><span id="l82.57" class="difflineminus">-MimeMultipartClassInitialize(MimeMultipartClass *clazz)</span>
<a href="#l82.58"></a><span id="l82.58" class="difflineminus">-{</span>
<a href="#l82.59"></a><span id="l82.59" class="difflineminus">-  MimeObjectClass    *oclass = (MimeObjectClass *)    clazz;</span>
<a href="#l82.60"></a><span id="l82.60" class="difflineminus">-  MimeMultipartClass *mclass = (MimeMultipartClass *) clazz;</span>
<a href="#l82.61"></a><span id="l82.61" class="difflineplus">+static int MimeMultipartClassInitialize(MimeMultipartClass *clazz) {</span>
<a href="#l82.62"></a><span id="l82.62" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l82.63"></a><span id="l82.63" class="difflineplus">+  MimeMultipartClass *mclass = (MimeMultipartClass *)clazz;</span>
<a href="#l82.64"></a><span id="l82.64"> </span>
<a href="#l82.65"></a><span id="l82.65">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l82.66"></a><span id="l82.66" class="difflineminus">-  oclass-&gt;initialize  = MimeMultipart_initialize;</span>
<a href="#l82.67"></a><span id="l82.67" class="difflineminus">-  oclass-&gt;finalize    = MimeMultipart_finalize;</span>
<a href="#l82.68"></a><span id="l82.68" class="difflineminus">-  oclass-&gt;parse_line  = MimeMultipart_parse_line;</span>
<a href="#l82.69"></a><span id="l82.69" class="difflineminus">-  oclass-&gt;parse_eof   = MimeMultipart_parse_eof;</span>
<a href="#l82.70"></a><span id="l82.70" class="difflineplus">+  oclass-&gt;initialize = MimeMultipart_initialize;</span>
<a href="#l82.71"></a><span id="l82.71" class="difflineplus">+  oclass-&gt;finalize = MimeMultipart_finalize;</span>
<a href="#l82.72"></a><span id="l82.72" class="difflineplus">+  oclass-&gt;parse_line = MimeMultipart_parse_line;</span>
<a href="#l82.73"></a><span id="l82.73" class="difflineplus">+  oclass-&gt;parse_eof = MimeMultipart_parse_eof;</span>
<a href="#l82.74"></a><span id="l82.74"> </span>
<a href="#l82.75"></a><span id="l82.75" class="difflineminus">-  mclass-&gt;check_boundary   = MimeMultipart_check_boundary;</span>
<a href="#l82.76"></a><span id="l82.76" class="difflineminus">-  mclass-&gt;create_child     = MimeMultipart_create_child;</span>
<a href="#l82.77"></a><span id="l82.77" class="difflineminus">-  mclass-&gt;output_child_p   = MimeMultipart_output_child_p;</span>
<a href="#l82.78"></a><span id="l82.78" class="difflineplus">+  mclass-&gt;check_boundary = MimeMultipart_check_boundary;</span>
<a href="#l82.79"></a><span id="l82.79" class="difflineplus">+  mclass-&gt;create_child = MimeMultipart_create_child;</span>
<a href="#l82.80"></a><span id="l82.80" class="difflineplus">+  mclass-&gt;output_child_p = MimeMultipart_output_child_p;</span>
<a href="#l82.81"></a><span id="l82.81">   mclass-&gt;parse_child_line = MimeMultipart_parse_child_line;</span>
<a href="#l82.82"></a><span id="l82.82" class="difflineminus">-  mclass-&gt;close_child      = MimeMultipart_close_child;</span>
<a href="#l82.83"></a><span id="l82.83" class="difflineplus">+  mclass-&gt;close_child = MimeMultipart_close_child;</span>
<a href="#l82.84"></a><span id="l82.84"> </span>
<a href="#l82.85"></a><span id="l82.85"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l82.86"></a><span id="l82.86">   oclass-&gt;debug_print = MimeMultipart_debug_print;</span>
<a href="#l82.87"></a><span id="l82.87"> #endif</span>
<a href="#l82.88"></a><span id="l82.88"> </span>
<a href="#l82.89"></a><span id="l82.89">   return 0;</span>
<a href="#l82.90"></a><span id="l82.90"> }</span>
<a href="#l82.91"></a><span id="l82.91"> </span>
<a href="#l82.92"></a><span id="l82.92" class="difflineminus">-</span>
<a href="#l82.93"></a><span id="l82.93" class="difflineminus">-static int</span>
<a href="#l82.94"></a><span id="l82.94" class="difflineminus">-MimeMultipart_initialize (MimeObject *object)</span>
<a href="#l82.95"></a><span id="l82.95" class="difflineminus">-{</span>
<a href="#l82.96"></a><span id="l82.96" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) object;</span>
<a href="#l82.97"></a><span id="l82.97" class="difflineplus">+static int MimeMultipart_initialize(MimeObject *object) {</span>
<a href="#l82.98"></a><span id="l82.98" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)object;</span>
<a href="#l82.99"></a><span id="l82.99">   char *ct;</span>
<a href="#l82.100"></a><span id="l82.100"> </span>
<a href="#l82.101"></a><span id="l82.101">   /* This is an abstract class; it shouldn't be directly instantiated. */</span>
<a href="#l82.102"></a><span id="l82.102" class="difflineminus">-  PR_ASSERT(object-&gt;clazz != (MimeObjectClass *) &amp;mimeMultipartClass);</span>
<a href="#l82.103"></a><span id="l82.103" class="difflineplus">+  PR_ASSERT(object-&gt;clazz != (MimeObjectClass *)&amp;mimeMultipartClass);</span>
<a href="#l82.104"></a><span id="l82.104"> </span>
<a href="#l82.105"></a><span id="l82.105" class="difflineminus">-  ct = MimeHeaders_get (object-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l82.106"></a><span id="l82.106" class="difflineminus">-  mult-&gt;boundary = (ct</span>
<a href="#l82.107"></a><span id="l82.107" class="difflineminus">-          ? MimeHeaders_get_parameter (ct, HEADER_PARM_BOUNDARY, NULL, NULL)</span>
<a href="#l82.108"></a><span id="l82.108" class="difflineplus">+  ct = MimeHeaders_get(object-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l82.109"></a><span id="l82.109" class="difflineplus">+  mult-&gt;boundary =</span>
<a href="#l82.110"></a><span id="l82.110" class="difflineplus">+      (ct ? MimeHeaders_get_parameter(ct, HEADER_PARM_BOUNDARY, NULL, NULL)</span>
<a href="#l82.111"></a><span id="l82.111">           : 0);</span>
<a href="#l82.112"></a><span id="l82.112">   PR_FREEIF(ct);</span>
<a href="#l82.113"></a><span id="l82.113">   mult-&gt;state = MimeMultipartPreamble;</span>
<a href="#l82.114"></a><span id="l82.114" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l82.115"></a><span id="l82.115" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l82.116"></a><span id="l82.116"> }</span>
<a href="#l82.117"></a><span id="l82.117"> </span>
<a href="#l82.118"></a><span id="l82.118" class="difflineminus">-</span>
<a href="#l82.119"></a><span id="l82.119" class="difflineminus">-static void</span>
<a href="#l82.120"></a><span id="l82.120" class="difflineminus">-MimeMultipart_finalize (MimeObject *object)</span>
<a href="#l82.121"></a><span id="l82.121" class="difflineminus">-{</span>
<a href="#l82.122"></a><span id="l82.122" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) object;</span>
<a href="#l82.123"></a><span id="l82.123" class="difflineplus">+static void MimeMultipart_finalize(MimeObject *object) {</span>
<a href="#l82.124"></a><span id="l82.124" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)object;</span>
<a href="#l82.125"></a><span id="l82.125"> </span>
<a href="#l82.126"></a><span id="l82.126">   object-&gt;clazz-&gt;parse_eof(object, false);</span>
<a href="#l82.127"></a><span id="l82.127"> </span>
<a href="#l82.128"></a><span id="l82.128">   PR_FREEIF(mult-&gt;boundary);</span>
<a href="#l82.129"></a><span id="l82.129" class="difflineminus">-  if (mult-&gt;hdrs)</span>
<a href="#l82.130"></a><span id="l82.130" class="difflineminus">-  MimeHeaders_free(mult-&gt;hdrs);</span>
<a href="#l82.131"></a><span id="l82.131" class="difflineplus">+  if (mult-&gt;hdrs) MimeHeaders_free(mult-&gt;hdrs);</span>
<a href="#l82.132"></a><span id="l82.132">   mult-&gt;hdrs = 0;</span>
<a href="#l82.133"></a><span id="l82.133" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l82.134"></a><span id="l82.134" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l82.135"></a><span id="l82.135"> }</span>
<a href="#l82.136"></a><span id="l82.136"> </span>
<a href="#l82.137"></a><span id="l82.137" class="difflineminus">-int MimeWriteAString(MimeObject *obj, const nsACString &amp;string)</span>
<a href="#l82.138"></a><span id="l82.138" class="difflineminus">-{</span>
<a href="#l82.139"></a><span id="l82.139" class="difflineplus">+int MimeWriteAString(MimeObject *obj, const nsACString &amp;string) {</span>
<a href="#l82.140"></a><span id="l82.140">   const nsCString &amp;flatString = PromiseFlatCString(string);</span>
<a href="#l82.141"></a><span id="l82.141">   return MimeObject_write(obj, flatString.get(), flatString.Length(), true);</span>
<a href="#l82.142"></a><span id="l82.142"> }</span>
<a href="#l82.143"></a><span id="l82.143"> </span>
<a href="#l82.144"></a><span id="l82.144" class="difflineminus">-static int</span>
<a href="#l82.145"></a><span id="l82.145" class="difflineminus">-MimeMultipart_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l82.146"></a><span id="l82.146" class="difflineminus">-{</span>
<a href="#l82.147"></a><span id="l82.147" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) obj;</span>
<a href="#l82.148"></a><span id="l82.148" class="difflineminus">-  MimeContainer *container = (MimeContainer*) obj;</span>
<a href="#l82.149"></a><span id="l82.149" class="difflineplus">+static int MimeMultipart_parse_line(const char *line, int32_t length,</span>
<a href="#l82.150"></a><span id="l82.150" class="difflineplus">+                                    MimeObject *obj) {</span>
<a href="#l82.151"></a><span id="l82.151" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)obj;</span>
<a href="#l82.152"></a><span id="l82.152" class="difflineplus">+  MimeContainer *container = (MimeContainer *)obj;</span>
<a href="#l82.153"></a><span id="l82.153">   int status = 0;</span>
<a href="#l82.154"></a><span id="l82.154">   MimeMultipartBoundaryType boundary;</span>
<a href="#l82.155"></a><span id="l82.155"> </span>
<a href="#l82.156"></a><span id="l82.156">   NS_ASSERTION(line &amp;&amp; *line, &quot;empty line in multipart parse_line&quot;);</span>
<a href="#l82.157"></a><span id="l82.157">   if (!line || !*line) return -1;</span>
<a href="#l82.158"></a><span id="l82.158"> </span>
<a href="#l82.159"></a><span id="l82.159">   NS_ASSERTION(!obj-&gt;closed_p, &quot;obj shouldn't already be closed&quot;);</span>
<a href="#l82.160"></a><span id="l82.160">   if (obj-&gt;closed_p) return -1;</span>
<a href="#l82.161"></a><span id="l82.161"> </span>
<a href="#l82.162"></a><span id="l82.162">   /* If we're supposed to write this object, but aren't supposed to convert</span>
<a href="#l82.163"></a><span id="l82.163">      it to HTML, simply pass it through unaltered. */</span>
<a href="#l82.164"></a><span id="l82.164" class="difflineminus">-  if (obj-&gt;output_p &amp;&amp;</span>
<a href="#l82.165"></a><span id="l82.165" class="difflineminus">-    obj-&gt;options &amp;&amp;</span>
<a href="#l82.166"></a><span id="l82.166" class="difflineminus">-    !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l82.167"></a><span id="l82.167" class="difflineminus">-    obj-&gt;options-&gt;output_fn</span>
<a href="#l82.168"></a><span id="l82.168" class="difflineminus">-          &amp;&amp; obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l82.169"></a><span id="l82.169" class="difflineminus">-  return MimeObject_write(obj, line, length, true);</span>
<a href="#l82.170"></a><span id="l82.170" class="difflineplus">+  if (obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l82.171"></a><span id="l82.171" class="difflineplus">+      obj-&gt;options-&gt;output_fn &amp;&amp;</span>
<a href="#l82.172"></a><span id="l82.172" class="difflineplus">+      obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l82.173"></a><span id="l82.173" class="difflineplus">+    return MimeObject_write(obj, line, length, true);</span>
<a href="#l82.174"></a><span id="l82.174"> </span>
<a href="#l82.175"></a><span id="l82.175" class="difflineminus">-  if (mult-&gt;state == MimeMultipartEpilogue)  /* already done */</span>
<a href="#l82.176"></a><span id="l82.176" class="difflineplus">+  if (mult-&gt;state == MimeMultipartEpilogue) /* already done */</span>
<a href="#l82.177"></a><span id="l82.177">     boundary = MimeMultipartBoundaryTypeNone;</span>
<a href="#l82.178"></a><span id="l82.178">   else</span>
<a href="#l82.179"></a><span id="l82.179" class="difflineminus">-    boundary = ((MimeMultipartClass *)obj-&gt;clazz)-&gt;check_boundary(obj, line,</span>
<a href="#l82.180"></a><span id="l82.180" class="difflineminus">-                                                                  length);</span>
<a href="#l82.181"></a><span id="l82.181" class="difflineplus">+    boundary =</span>
<a href="#l82.182"></a><span id="l82.182" class="difflineplus">+        ((MimeMultipartClass *)obj-&gt;clazz)-&gt;check_boundary(obj, line, length);</span>
<a href="#l82.183"></a><span id="l82.183"> </span>
<a href="#l82.184"></a><span id="l82.184">   if (boundary == MimeMultipartBoundaryTypeTerminator ||</span>
<a href="#l82.185"></a><span id="l82.185" class="difflineminus">-    boundary == MimeMultipartBoundaryTypeSeparator)</span>
<a href="#l82.186"></a><span id="l82.186" class="difflineminus">-  {</span>
<a href="#l82.187"></a><span id="l82.187" class="difflineminus">-  /* Match!  Close the currently-open part, move on to the next</span>
<a href="#l82.188"></a><span id="l82.188" class="difflineminus">-     state, and discard this line.</span>
<a href="#l82.189"></a><span id="l82.189" class="difflineminus">-   */</span>
<a href="#l82.190"></a><span id="l82.190" class="difflineplus">+      boundary == MimeMultipartBoundaryTypeSeparator) {</span>
<a href="#l82.191"></a><span id="l82.191" class="difflineplus">+    /* Match!  Close the currently-open part, move on to the next</span>
<a href="#l82.192"></a><span id="l82.192" class="difflineplus">+       state, and discard this line.</span>
<a href="#l82.193"></a><span id="l82.193" class="difflineplus">+     */</span>
<a href="#l82.194"></a><span id="l82.194">     bool endOfPart = (mult-&gt;state != MimeMultipartPreamble);</span>
<a href="#l82.195"></a><span id="l82.195">     if (endOfPart)</span>
<a href="#l82.196"></a><span id="l82.196">       status = ((MimeMultipartClass *)obj-&gt;clazz)-&gt;close_child(obj);</span>
<a href="#l82.197"></a><span id="l82.197">     if (status &lt; 0) return status;</span>
<a href="#l82.198"></a><span id="l82.198"> </span>
<a href="#l82.199"></a><span id="l82.199">     if (boundary == MimeMultipartBoundaryTypeTerminator)</span>
<a href="#l82.200"></a><span id="l82.200">       mult-&gt;state = MimeMultipartEpilogue;</span>
<a href="#l82.201"></a><span id="l82.201" class="difflineminus">-    else</span>
<a href="#l82.202"></a><span id="l82.202" class="difflineminus">-    {</span>
<a href="#l82.203"></a><span id="l82.203" class="difflineplus">+    else {</span>
<a href="#l82.204"></a><span id="l82.204">       mult-&gt;state = MimeMultipartHeaders;</span>
<a href="#l82.205"></a><span id="l82.205"> </span>
<a href="#l82.206"></a><span id="l82.206">       /* Reset the header parser for this upcoming part. */</span>
<a href="#l82.207"></a><span id="l82.207">       NS_ASSERTION(!mult-&gt;hdrs, &quot;mult-&gt;hdrs should be null here&quot;);</span>
<a href="#l82.208"></a><span id="l82.208" class="difflineminus">-      if (mult-&gt;hdrs)</span>
<a href="#l82.209"></a><span id="l82.209" class="difflineminus">-        MimeHeaders_free(mult-&gt;hdrs);</span>
<a href="#l82.210"></a><span id="l82.210" class="difflineplus">+      if (mult-&gt;hdrs) MimeHeaders_free(mult-&gt;hdrs);</span>
<a href="#l82.211"></a><span id="l82.211">       mult-&gt;hdrs = MimeHeaders_new();</span>
<a href="#l82.212"></a><span id="l82.212" class="difflineminus">-      if (!mult-&gt;hdrs)</span>
<a href="#l82.213"></a><span id="l82.213" class="difflineminus">-        return MIME_OUT_OF_MEMORY;</span>
<a href="#l82.214"></a><span id="l82.214" class="difflineplus">+      if (!mult-&gt;hdrs) return MIME_OUT_OF_MEMORY;</span>
<a href="#l82.215"></a><span id="l82.215">       if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l82.216"></a><span id="l82.216" class="difflineminus">-          obj-&gt;options-&gt;state-&gt;partsToStrip.Length() &gt; 0)</span>
<a href="#l82.217"></a><span id="l82.217" class="difflineminus">-      {</span>
<a href="#l82.218"></a><span id="l82.218" class="difflineplus">+          obj-&gt;options-&gt;state-&gt;partsToStrip.Length() &gt; 0) {</span>
<a href="#l82.219"></a><span id="l82.219">         nsAutoCString newPart(mime_part_address(obj));</span>
<a href="#l82.220"></a><span id="l82.220">         newPart.Append('.');</span>
<a href="#l82.221"></a><span id="l82.221">         newPart.AppendInt(container-&gt;nchildren + 1);</span>
<a href="#l82.222"></a><span id="l82.222">         obj-&gt;options-&gt;state-&gt;strippingPart = false;</span>
<a href="#l82.223"></a><span id="l82.223">         // check if this is a sub-part of a part we're stripping.</span>
<a href="#l82.224"></a><span id="l82.224" class="difflineminus">-        for (uint32_t partIndex = 0; partIndex &lt; obj-&gt;options-&gt;state-&gt;partsToStrip.Length(); partIndex++)</span>
<a href="#l82.225"></a><span id="l82.225" class="difflineminus">-        {</span>
<a href="#l82.226"></a><span id="l82.226" class="difflineminus">-          nsCString &amp;curPartToStrip = obj-&gt;options-&gt;state-&gt;partsToStrip[partIndex];</span>
<a href="#l82.227"></a><span id="l82.227" class="difflineminus">-          if (newPart.Find(curPartToStrip) == 0 &amp;&amp; (newPart.Length() == curPartToStrip.Length() || newPart.CharAt(curPartToStrip.Length()) == '.'))</span>
<a href="#l82.228"></a><span id="l82.228" class="difflineminus">-          {</span>
<a href="#l82.229"></a><span id="l82.229" class="difflineplus">+        for (uint32_t partIndex = 0;</span>
<a href="#l82.230"></a><span id="l82.230" class="difflineplus">+             partIndex &lt; obj-&gt;options-&gt;state-&gt;partsToStrip.Length();</span>
<a href="#l82.231"></a><span id="l82.231" class="difflineplus">+             partIndex++) {</span>
<a href="#l82.232"></a><span id="l82.232" class="difflineplus">+          nsCString &amp;curPartToStrip =</span>
<a href="#l82.233"></a><span id="l82.233" class="difflineplus">+              obj-&gt;options-&gt;state-&gt;partsToStrip[partIndex];</span>
<a href="#l82.234"></a><span id="l82.234" class="difflineplus">+          if (newPart.Find(curPartToStrip) == 0 &amp;&amp;</span>
<a href="#l82.235"></a><span id="l82.235" class="difflineplus">+              (newPart.Length() == curPartToStrip.Length() ||</span>
<a href="#l82.236"></a><span id="l82.236" class="difflineplus">+               newPart.CharAt(curPartToStrip.Length()) == '.')) {</span>
<a href="#l82.237"></a><span id="l82.237">             obj-&gt;options-&gt;state-&gt;strippingPart = true;</span>
<a href="#l82.238"></a><span id="l82.238">             if (partIndex &lt; obj-&gt;options-&gt;state-&gt;detachToFiles.Length())</span>
<a href="#l82.239"></a><span id="l82.239" class="difflineminus">-              obj-&gt;options-&gt;state-&gt;detachedFilePath = obj-&gt;options-&gt;state-&gt;detachToFiles[partIndex];</span>
<a href="#l82.240"></a><span id="l82.240" class="difflineplus">+              obj-&gt;options-&gt;state-&gt;detachedFilePath =</span>
<a href="#l82.241"></a><span id="l82.241" class="difflineplus">+                  obj-&gt;options-&gt;state-&gt;detachToFiles[partIndex];</span>
<a href="#l82.242"></a><span id="l82.242">             break;</span>
<a href="#l82.243"></a><span id="l82.243">           }</span>
<a href="#l82.244"></a><span id="l82.244">         }</span>
<a href="#l82.245"></a><span id="l82.245">       }</span>
<a href="#l82.246"></a><span id="l82.246">     }</span>
<a href="#l82.247"></a><span id="l82.247"> </span>
<a href="#l82.248"></a><span id="l82.248">     // if stripping out attachments, write the boundary line. Otherwise, return</span>
<a href="#l82.249"></a><span id="l82.249">     // to ignore it.</span>
<a href="#l82.250"></a><span id="l82.250" class="difflineminus">-    if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l82.251"></a><span id="l82.251" class="difflineminus">-    {</span>
<a href="#l82.252"></a><span id="l82.252" class="difflineplus">+    if (obj-&gt;options &amp;&amp;</span>
<a href="#l82.253"></a><span id="l82.253" class="difflineplus">+        obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach) {</span>
<a href="#l82.254"></a><span id="l82.254">       // Because MimeMultipart_parse_child_line strips out the</span>
<a href="#l82.255"></a><span id="l82.255">       // the CRLF of the last line before the end of a part, we need to add that</span>
<a href="#l82.256"></a><span id="l82.256">       // back in here.</span>
<a href="#l82.257"></a><span id="l82.257" class="difflineminus">-      if (endOfPart)</span>
<a href="#l82.258"></a><span id="l82.258" class="difflineminus">-        MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK));</span>
<a href="#l82.259"></a><span id="l82.259" class="difflineplus">+      if (endOfPart) MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK));</span>
<a href="#l82.260"></a><span id="l82.260"> </span>
<a href="#l82.261"></a><span id="l82.261">       status = MimeObject_write(obj, line, length, true);</span>
<a href="#l82.262"></a><span id="l82.262">     }</span>
<a href="#l82.263"></a><span id="l82.263">     return 0;</span>
<a href="#l82.264"></a><span id="l82.264">   }</span>
<a href="#l82.265"></a><span id="l82.265"> </span>
<a href="#l82.266"></a><span id="l82.266">   /* Otherwise, this isn't a boundary string.  So do whatever it is we</span>
<a href="#l82.267"></a><span id="l82.267">    should do with this line (parse it as a header, feed it to the</span>
<a href="#l82.268"></a><span id="l82.268">    child part, ignore it, etc.) */</span>
<a href="#l82.269"></a><span id="l82.269"> </span>
<a href="#l82.270"></a><span id="l82.270" class="difflineminus">-  switch (mult-&gt;state)</span>
<a href="#l82.271"></a><span id="l82.271" class="difflineminus">-  {</span>
<a href="#l82.272"></a><span id="l82.272" class="difflineplus">+  switch (mult-&gt;state) {</span>
<a href="#l82.273"></a><span id="l82.273">     case MimeMultipartPreamble:</span>
<a href="#l82.274"></a><span id="l82.274">     case MimeMultipartEpilogue:</span>
<a href="#l82.275"></a><span id="l82.275">       /* Ignore this line. */</span>
<a href="#l82.276"></a><span id="l82.276">       break;</span>
<a href="#l82.277"></a><span id="l82.277"> </span>
<a href="#l82.278"></a><span id="l82.278">     case MimeMultipartHeaders:</span>
<a href="#l82.279"></a><span id="l82.279" class="difflineminus">-    /* Parse this line as a header for the sub-part. */</span>
<a href="#l82.280"></a><span id="l82.280" class="difflineminus">-    {</span>
<a href="#l82.281"></a><span id="l82.281" class="difflineminus">-      status = MimeHeaders_parse_line(line, length, mult-&gt;hdrs);</span>
<a href="#l82.282"></a><span id="l82.282" class="difflineminus">-      bool stripping = false;</span>
<a href="#l82.283"></a><span id="l82.283" class="difflineplus">+      /* Parse this line as a header for the sub-part. */</span>
<a href="#l82.284"></a><span id="l82.284" class="difflineplus">+      {</span>
<a href="#l82.285"></a><span id="l82.285" class="difflineplus">+        status = MimeHeaders_parse_line(line, length, mult-&gt;hdrs);</span>
<a href="#l82.286"></a><span id="l82.286" class="difflineplus">+        bool stripping = false;</span>
<a href="#l82.287"></a><span id="l82.287"> </span>
<a href="#l82.288"></a><span id="l82.288" class="difflineminus">-      if (status &lt; 0) return status;</span>
<a href="#l82.289"></a><span id="l82.289" class="difflineplus">+        if (status &lt; 0) return status;</span>
<a href="#l82.290"></a><span id="l82.290"> </span>
<a href="#l82.291"></a><span id="l82.291" class="difflineminus">-      // If this line is blank, we're now done parsing headers, and should</span>
<a href="#l82.292"></a><span id="l82.292" class="difflineminus">-      // now examine the content-type to create this &quot;body&quot; part.</span>
<a href="#l82.293"></a><span id="l82.293" class="difflineminus">-      //</span>
<a href="#l82.294"></a><span id="l82.294" class="difflineminus">-      if (*line == '\r' || *line == '\n')</span>
<a href="#l82.295"></a><span id="l82.295" class="difflineminus">-      {</span>
<a href="#l82.296"></a><span id="l82.296" class="difflineminus">-        if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l82.297"></a><span id="l82.297" class="difflineminus">-            obj-&gt;options-&gt;state-&gt;strippingPart)</span>
<a href="#l82.298"></a><span id="l82.298" class="difflineminus">-        {</span>
<a href="#l82.299"></a><span id="l82.299" class="difflineminus">-          stripping = true;</span>
<a href="#l82.300"></a><span id="l82.300" class="difflineminus">-          bool detachingPart = obj-&gt;options-&gt;state-&gt;detachedFilePath.Length() &gt; 0;</span>
<a href="#l82.301"></a><span id="l82.301" class="difflineplus">+        // If this line is blank, we're now done parsing headers, and should</span>
<a href="#l82.302"></a><span id="l82.302" class="difflineplus">+        // now examine the content-type to create this &quot;body&quot; part.</span>
<a href="#l82.303"></a><span id="l82.303" class="difflineplus">+        //</span>
<a href="#l82.304"></a><span id="l82.304" class="difflineplus">+        if (*line == '\r' || *line == '\n') {</span>
<a href="#l82.305"></a><span id="l82.305" class="difflineplus">+          if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l82.306"></a><span id="l82.306" class="difflineplus">+              obj-&gt;options-&gt;state-&gt;strippingPart) {</span>
<a href="#l82.307"></a><span id="l82.307" class="difflineplus">+            stripping = true;</span>
<a href="#l82.308"></a><span id="l82.308" class="difflineplus">+            bool detachingPart =</span>
<a href="#l82.309"></a><span id="l82.309" class="difflineplus">+                obj-&gt;options-&gt;state-&gt;detachedFilePath.Length() &gt; 0;</span>
<a href="#l82.310"></a><span id="l82.310"> </span>
<a href="#l82.311"></a><span id="l82.311" class="difflineminus">-          nsAutoCString fileName;</span>
<a href="#l82.312"></a><span id="l82.312" class="difflineminus">-          fileName.Adopt(MimeHeaders_get_name(mult-&gt;hdrs, obj-&gt;options));</span>
<a href="#l82.313"></a><span id="l82.313" class="difflineminus">-          if (detachingPart)</span>
<a href="#l82.314"></a><span id="l82.314" class="difflineminus">-          {</span>
<a href="#l82.315"></a><span id="l82.315" class="difflineminus">-            char *contentType = MimeHeaders_get(mult-&gt;hdrs, &quot;Content-Type&quot;, false, false);</span>
<a href="#l82.316"></a><span id="l82.316" class="difflineminus">-            if (contentType)</span>
<a href="#l82.317"></a><span id="l82.317" class="difflineminus">-            {</span>
<a href="#l82.318"></a><span id="l82.318" class="difflineminus">-              MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;Content-Type: &quot;));</span>
<a href="#l82.319"></a><span id="l82.319" class="difflineminus">-              MimeWriteAString(obj, nsDependentCString(contentType));</span>
<a href="#l82.320"></a><span id="l82.320" class="difflineminus">-              PR_Free(contentType);</span>
<a href="#l82.321"></a><span id="l82.321" class="difflineplus">+            nsAutoCString fileName;</span>
<a href="#l82.322"></a><span id="l82.322" class="difflineplus">+            fileName.Adopt(MimeHeaders_get_name(mult-&gt;hdrs, obj-&gt;options));</span>
<a href="#l82.323"></a><span id="l82.323" class="difflineplus">+            if (detachingPart) {</span>
<a href="#l82.324"></a><span id="l82.324" class="difflineplus">+              char *contentType =</span>
<a href="#l82.325"></a><span id="l82.325" class="difflineplus">+                  MimeHeaders_get(mult-&gt;hdrs, &quot;Content-Type&quot;, false, false);</span>
<a href="#l82.326"></a><span id="l82.326" class="difflineplus">+              if (contentType) {</span>
<a href="#l82.327"></a><span id="l82.327" class="difflineplus">+                MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;Content-Type: &quot;));</span>
<a href="#l82.328"></a><span id="l82.328" class="difflineplus">+                MimeWriteAString(obj, nsDependentCString(contentType));</span>
<a href="#l82.329"></a><span id="l82.329" class="difflineplus">+                PR_Free(contentType);</span>
<a href="#l82.330"></a><span id="l82.330" class="difflineplus">+              }</span>
<a href="#l82.331"></a><span id="l82.331" class="difflineplus">+              MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK));</span>
<a href="#l82.332"></a><span id="l82.332" class="difflineplus">+              MimeWriteAString(</span>
<a href="#l82.333"></a><span id="l82.333" class="difflineplus">+                  obj, NS_LITERAL_CSTRING(</span>
<a href="#l82.334"></a><span id="l82.334" class="difflineplus">+                           &quot;Content-Disposition: attachment; filename=\&quot;&quot;));</span>
<a href="#l82.335"></a><span id="l82.335" class="difflineplus">+              MimeWriteAString(obj, fileName);</span>
<a href="#l82.336"></a><span id="l82.336" class="difflineplus">+              MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot; MSG_LINEBREAK));</span>
<a href="#l82.337"></a><span id="l82.337" class="difflineplus">+              MimeWriteAString(obj, NS_LITERAL_CSTRING(</span>
<a href="#l82.338"></a><span id="l82.338" class="difflineplus">+                                        &quot;X-Mozilla-External-Attachment-URL: &quot;));</span>
<a href="#l82.339"></a><span id="l82.339" class="difflineplus">+              MimeWriteAString(obj, obj-&gt;options-&gt;state-&gt;detachedFilePath);</span>
<a href="#l82.340"></a><span id="l82.340" class="difflineplus">+              MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK));</span>
<a href="#l82.341"></a><span id="l82.341" class="difflineplus">+              MimeWriteAString(</span>
<a href="#l82.342"></a><span id="l82.342" class="difflineplus">+                  obj, NS_LITERAL_CSTRING(</span>
<a href="#l82.343"></a><span id="l82.343" class="difflineplus">+                           &quot;X-Mozilla-Altered: AttachmentDetached; date=\&quot;&quot;));</span>
<a href="#l82.344"></a><span id="l82.344" class="difflineplus">+            } else {</span>
<a href="#l82.345"></a><span id="l82.345" class="difflineplus">+              nsAutoCString header(</span>
<a href="#l82.346"></a><span id="l82.346" class="difflineplus">+                  &quot;Content-Type: text/x-moz-deleted; name=\&quot;Deleted: &quot;);</span>
<a href="#l82.347"></a><span id="l82.347" class="difflineplus">+              header.Append(fileName);</span>
<a href="#l82.348"></a><span id="l82.348" class="difflineplus">+              status = MimeWriteAString(obj, header);</span>
<a href="#l82.349"></a><span id="l82.349" class="difflineplus">+              if (status &lt; 0) return status;</span>
<a href="#l82.350"></a><span id="l82.350" class="difflineplus">+              status = MimeWriteAString(</span>
<a href="#l82.351"></a><span id="l82.351" class="difflineplus">+                  obj, NS_LITERAL_CSTRING(</span>
<a href="#l82.352"></a><span id="l82.352" class="difflineplus">+                           &quot;\&quot;&quot; MSG_LINEBREAK</span>
<a href="#l82.353"></a><span id="l82.353" class="difflineplus">+                           &quot;Content-Transfer-Encoding: 8bit&quot; MSG_LINEBREAK));</span>
<a href="#l82.354"></a><span id="l82.354" class="difflineplus">+              MimeWriteAString(</span>
<a href="#l82.355"></a><span id="l82.355" class="difflineplus">+                  obj,</span>
<a href="#l82.356"></a><span id="l82.356" class="difflineplus">+                  NS_LITERAL_CSTRING(</span>
<a href="#l82.357"></a><span id="l82.357" class="difflineplus">+                      &quot;Content-Disposition: inline; filename=\&quot;Deleted: &quot;));</span>
<a href="#l82.358"></a><span id="l82.358" class="difflineplus">+              MimeWriteAString(obj, fileName);</span>
<a href="#l82.359"></a><span id="l82.359" class="difflineplus">+              MimeWriteAString(</span>
<a href="#l82.360"></a><span id="l82.360" class="difflineplus">+                  obj, NS_LITERAL_CSTRING(</span>
<a href="#l82.361"></a><span id="l82.361" class="difflineplus">+                           &quot;\&quot;&quot; MSG_LINEBREAK</span>
<a href="#l82.362"></a><span id="l82.362" class="difflineplus">+                           &quot;X-Mozilla-Altered: AttachmentDeleted; date=\&quot;&quot;));</span>
<a href="#l82.363"></a><span id="l82.363">             }</span>
<a href="#l82.364"></a><span id="l82.364" class="difflineminus">-            MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK));</span>
<a href="#l82.365"></a><span id="l82.365" class="difflineminus">-            MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;Content-Disposition: attachment; filename=\&quot;&quot;));</span>
<a href="#l82.366"></a><span id="l82.366" class="difflineminus">-            MimeWriteAString(obj, fileName);</span>
<a href="#l82.367"></a><span id="l82.367" class="difflineplus">+            nsCString result;</span>
<a href="#l82.368"></a><span id="l82.368" class="difflineplus">+            char timeBuffer[128];</span>
<a href="#l82.369"></a><span id="l82.369" class="difflineplus">+            PRExplodedTime now;</span>
<a href="#l82.370"></a><span id="l82.370" class="difflineplus">+            PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;now);</span>
<a href="#l82.371"></a><span id="l82.371" class="difflineplus">+            PR_FormatTimeUSEnglish(timeBuffer, sizeof(timeBuffer),</span>
<a href="#l82.372"></a><span id="l82.372" class="difflineplus">+                                   &quot;%a %b %d %H:%M:%S %Y&quot;, &amp;now);</span>
<a href="#l82.373"></a><span id="l82.373" class="difflineplus">+            MimeWriteAString(obj, nsDependentCString(timeBuffer));</span>
<a href="#l82.374"></a><span id="l82.374">             MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot; MSG_LINEBREAK));</span>
<a href="#l82.375"></a><span id="l82.375" class="difflineminus">-            MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;X-Mozilla-External-Attachment-URL: &quot;));</span>
<a href="#l82.376"></a><span id="l82.376" class="difflineminus">-            MimeWriteAString(obj, obj-&gt;options-&gt;state-&gt;detachedFilePath);</span>
<a href="#l82.377"></a><span id="l82.377" class="difflineminus">-            MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK));</span>
<a href="#l82.378"></a><span id="l82.378" class="difflineminus">-            MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;X-Mozilla-Altered: AttachmentDetached; date=\&quot;&quot;));</span>
<a href="#l82.379"></a><span id="l82.379" class="difflineplus">+            MimeWriteAString(</span>
<a href="#l82.380"></a><span id="l82.380" class="difflineplus">+                obj,</span>
<a href="#l82.381"></a><span id="l82.381" class="difflineplus">+                NS_LITERAL_CSTRING(</span>
<a href="#l82.382"></a><span id="l82.382" class="difflineplus">+                    MSG_LINEBREAK</span>
<a href="#l82.383"></a><span id="l82.383" class="difflineplus">+                    &quot;You deleted an attachment from this message. The original &quot;</span>
<a href="#l82.384"></a><span id="l82.384" class="difflineplus">+                    &quot;MIME headers for the attachment were:&quot; MSG_LINEBREAK));</span>
<a href="#l82.385"></a><span id="l82.385" class="difflineplus">+            MimeHeaders_write_raw_headers(mult-&gt;hdrs, obj-&gt;options, false);</span>
<a href="#l82.386"></a><span id="l82.386">           }</span>
<a href="#l82.387"></a><span id="l82.387" class="difflineminus">-          else</span>
<a href="#l82.388"></a><span id="l82.388" class="difflineminus">-          {</span>
<a href="#l82.389"></a><span id="l82.389" class="difflineminus">-            nsAutoCString header(&quot;Content-Type: text/x-moz-deleted; name=\&quot;Deleted: &quot;);</span>
<a href="#l82.390"></a><span id="l82.390" class="difflineminus">-            header.Append(fileName);</span>
<a href="#l82.391"></a><span id="l82.391" class="difflineminus">-            status = MimeWriteAString(obj, header);</span>
<a href="#l82.392"></a><span id="l82.392" class="difflineminus">-            if (status &lt; 0)</span>
<a href="#l82.393"></a><span id="l82.393" class="difflineminus">-              return status;</span>
<a href="#l82.394"></a><span id="l82.394" class="difflineminus">-            status = MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot; MSG_LINEBREAK &quot;Content-Transfer-Encoding: 8bit&quot; MSG_LINEBREAK));</span>
<a href="#l82.395"></a><span id="l82.395" class="difflineminus">-            MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;Content-Disposition: inline; filename=\&quot;Deleted: &quot;));</span>
<a href="#l82.396"></a><span id="l82.396" class="difflineminus">-            MimeWriteAString(obj, fileName);</span>
<a href="#l82.397"></a><span id="l82.397" class="difflineminus">-            MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot; MSG_LINEBREAK &quot;X-Mozilla-Altered: AttachmentDeleted; date=\&quot;&quot;));</span>
<a href="#l82.398"></a><span id="l82.398" class="difflineplus">+          int32_t old_nchildren = container-&gt;nchildren;</span>
<a href="#l82.399"></a><span id="l82.399" class="difflineplus">+          status = ((MimeMultipartClass *)obj-&gt;clazz)-&gt;create_child(obj);</span>
<a href="#l82.400"></a><span id="l82.400" class="difflineplus">+          if (status &lt; 0) return status;</span>
<a href="#l82.401"></a><span id="l82.401" class="difflineplus">+          NS_ASSERTION(mult-&gt;state != MimeMultipartHeaders,</span>
<a href="#l82.402"></a><span id="l82.402" class="difflineplus">+                       &quot;mult-&gt;state shouldn't be MimeMultipartHeaders&quot;);</span>
<a href="#l82.403"></a><span id="l82.403" class="difflineplus">+</span>
<a href="#l82.404"></a><span id="l82.404" class="difflineplus">+          if (!stripping &amp;&amp; container-&gt;nchildren &gt; old_nchildren &amp;&amp;</span>
<a href="#l82.405"></a><span id="l82.405" class="difflineplus">+              obj-&gt;options &amp;&amp;</span>
<a href="#l82.406"></a><span id="l82.406" class="difflineplus">+              !mime_typep(obj,</span>
<a href="#l82.407"></a><span id="l82.407" class="difflineplus">+                          (MimeObjectClass *)&amp;mimeMultipartAlternativeClass)) {</span>
<a href="#l82.408"></a><span id="l82.408" class="difflineplus">+            // Notify emitter about content type and part path.</span>
<a href="#l82.409"></a><span id="l82.409" class="difflineplus">+            MimeObject *kid = container-&gt;children[container-&gt;nchildren - 1];</span>
<a href="#l82.410"></a><span id="l82.410" class="difflineplus">+            MimeMultipart_notify_emitter(kid);</span>
<a href="#l82.411"></a><span id="l82.411">           }</span>
<a href="#l82.412"></a><span id="l82.412" class="difflineminus">-          nsCString result;</span>
<a href="#l82.413"></a><span id="l82.413" class="difflineminus">-          char timeBuffer[128];</span>
<a href="#l82.414"></a><span id="l82.414" class="difflineminus">-          PRExplodedTime now;</span>
<a href="#l82.415"></a><span id="l82.415" class="difflineminus">-          PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;now);</span>
<a href="#l82.416"></a><span id="l82.416" class="difflineminus">-          PR_FormatTimeUSEnglish(timeBuffer, sizeof(timeBuffer),</span>
<a href="#l82.417"></a><span id="l82.417" class="difflineminus">-                                 &quot;%a %b %d %H:%M:%S %Y&quot;,</span>
<a href="#l82.418"></a><span id="l82.418" class="difflineminus">-                                 &amp;now);</span>
<a href="#l82.419"></a><span id="l82.419" class="difflineminus">-          MimeWriteAString(obj, nsDependentCString(timeBuffer));</span>
<a href="#l82.420"></a><span id="l82.420" class="difflineminus">-          MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot; MSG_LINEBREAK));</span>
<a href="#l82.421"></a><span id="l82.421" class="difflineminus">-          MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK &quot;You deleted an attachment from this message. The original MIME headers for the attachment were:&quot; MSG_LINEBREAK));</span>
<a href="#l82.422"></a><span id="l82.422" class="difflineminus">-          MimeHeaders_write_raw_headers(mult-&gt;hdrs, obj-&gt;options, false);</span>
<a href="#l82.423"></a><span id="l82.423">         }</span>
<a href="#l82.424"></a><span id="l82.424" class="difflineminus">-        int32_t old_nchildren = container-&gt;nchildren;</span>
<a href="#l82.425"></a><span id="l82.425" class="difflineminus">-        status = ((MimeMultipartClass *) obj-&gt;clazz)-&gt;create_child(obj);</span>
<a href="#l82.426"></a><span id="l82.426" class="difflineminus">-        if (status &lt; 0) return status;</span>
<a href="#l82.427"></a><span id="l82.427" class="difflineminus">-        NS_ASSERTION(mult-&gt;state != MimeMultipartHeaders,</span>
<a href="#l82.428"></a><span id="l82.428" class="difflineminus">-                     &quot;mult-&gt;state shouldn't be MimeMultipartHeaders&quot;);</span>
<a href="#l82.429"></a><span id="l82.429" class="difflineminus">-</span>
<a href="#l82.430"></a><span id="l82.430" class="difflineminus">-        if (!stripping &amp;&amp; container-&gt;nchildren &gt; old_nchildren &amp;&amp; obj-&gt;options &amp;&amp;</span>
<a href="#l82.431"></a><span id="l82.431" class="difflineminus">-            !mime_typep(obj, (MimeObjectClass*)&amp;mimeMultipartAlternativeClass)) {</span>
<a href="#l82.432"></a><span id="l82.432" class="difflineminus">-          // Notify emitter about content type and part path.</span>
<a href="#l82.433"></a><span id="l82.433" class="difflineminus">-          MimeObject *kid = container-&gt;children[container-&gt;nchildren-1];</span>
<a href="#l82.434"></a><span id="l82.434" class="difflineminus">-          MimeMultipart_notify_emitter(kid);</span>
<a href="#l82.435"></a><span id="l82.435" class="difflineminus">-        }</span>
<a href="#l82.436"></a><span id="l82.436" class="difflineplus">+        break;</span>
<a href="#l82.437"></a><span id="l82.437">       }</span>
<a href="#l82.438"></a><span id="l82.438" class="difflineminus">-      break;</span>
<a href="#l82.439"></a><span id="l82.439" class="difflineminus">-    }</span>
<a href="#l82.440"></a><span id="l82.440"> </span>
<a href="#l82.441"></a><span id="l82.441">     case MimeMultipartPartFirstLine:</span>
<a href="#l82.442"></a><span id="l82.442">       /* Hand this line off to the sub-part. */</span>
<a href="#l82.443"></a><span id="l82.443" class="difflineminus">-      status = (((MimeMultipartClass *) obj-&gt;clazz)-&gt;parse_child_line(obj,</span>
<a href="#l82.444"></a><span id="l82.444" class="difflineminus">-                                                  line, length, true));</span>
<a href="#l82.445"></a><span id="l82.445" class="difflineplus">+      status = (((MimeMultipartClass *)obj-&gt;clazz)</span>
<a href="#l82.446"></a><span id="l82.446" class="difflineplus">+                    -&gt;parse_child_line(obj, line, length, true));</span>
<a href="#l82.447"></a><span id="l82.447">       if (status &lt; 0) return status;</span>
<a href="#l82.448"></a><span id="l82.448">       mult-&gt;state = MimeMultipartPartLine;</span>
<a href="#l82.449"></a><span id="l82.449">       break;</span>
<a href="#l82.450"></a><span id="l82.450"> </span>
<a href="#l82.451"></a><span id="l82.451">     case MimeMultipartPartLine:</span>
<a href="#l82.452"></a><span id="l82.452">       /* Hand this line off to the sub-part. */</span>
<a href="#l82.453"></a><span id="l82.453" class="difflineminus">-      status = (((MimeMultipartClass *) obj-&gt;clazz)-&gt;parse_child_line(obj,</span>
<a href="#l82.454"></a><span id="l82.454" class="difflineminus">-                  line, length, false));</span>
<a href="#l82.455"></a><span id="l82.455" class="difflineplus">+      status = (((MimeMultipartClass *)obj-&gt;clazz)</span>
<a href="#l82.456"></a><span id="l82.456" class="difflineplus">+                    -&gt;parse_child_line(obj, line, length, false));</span>
<a href="#l82.457"></a><span id="l82.457">       if (status &lt; 0) return status;</span>
<a href="#l82.458"></a><span id="l82.458">       break;</span>
<a href="#l82.459"></a><span id="l82.459"> </span>
<a href="#l82.460"></a><span id="l82.460">     default:</span>
<a href="#l82.461"></a><span id="l82.461">       NS_ERROR(&quot;unexpected state in parse line&quot;);</span>
<a href="#l82.462"></a><span id="l82.462">       return -1;</span>
<a href="#l82.463"></a><span id="l82.463">   }</span>
<a href="#l82.464"></a><span id="l82.464"> </span>
<a href="#l82.465"></a><span id="l82.465">   if (obj-&gt;options &amp;&amp;</span>
<a href="#l82.466"></a><span id="l82.466">       obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach &amp;&amp;</span>
<a href="#l82.467"></a><span id="l82.467">       (!(obj-&gt;options-&gt;state &amp;&amp; obj-&gt;options-&gt;state-&gt;strippingPart) &amp;&amp;</span>
<a href="#l82.468"></a><span id="l82.468" class="difflineminus">-      mult-&gt;state != MimeMultipartPartLine))</span>
<a href="#l82.469"></a><span id="l82.469" class="difflineminus">-      return MimeObject_write(obj, line, length, false);</span>
<a href="#l82.470"></a><span id="l82.470" class="difflineplus">+       mult-&gt;state != MimeMultipartPartLine))</span>
<a href="#l82.471"></a><span id="l82.471" class="difflineplus">+    return MimeObject_write(obj, line, length, false);</span>
<a href="#l82.472"></a><span id="l82.472">   return 0;</span>
<a href="#l82.473"></a><span id="l82.473"> }</span>
<a href="#l82.474"></a><span id="l82.474"> </span>
<a href="#l82.475"></a><span id="l82.475" class="difflineminus">-void MimeMultipart_notify_emitter(MimeObject *obj)</span>
<a href="#l82.476"></a><span id="l82.476" class="difflineminus">-{</span>
<a href="#l82.477"></a><span id="l82.477" class="difflineplus">+void MimeMultipart_notify_emitter(MimeObject *obj) {</span>
<a href="#l82.478"></a><span id="l82.478">   char *ct = nullptr;</span>
<a href="#l82.479"></a><span id="l82.479"> </span>
<a href="#l82.480"></a><span id="l82.480" class="difflineminus">-  NS_ASSERTION(obj-&gt;options, &quot;MimeMultipart_notify_emitter called with null options&quot;);</span>
<a href="#l82.481"></a><span id="l82.481" class="difflineminus">-  if (! obj-&gt;options)</span>
<a href="#l82.482"></a><span id="l82.482" class="difflineminus">-    return;</span>
<a href="#l82.483"></a><span id="l82.483" class="difflineplus">+  NS_ASSERTION(obj-&gt;options,</span>
<a href="#l82.484"></a><span id="l82.484" class="difflineplus">+               &quot;MimeMultipart_notify_emitter called with null options&quot;);</span>
<a href="#l82.485"></a><span id="l82.485" class="difflineplus">+  if (!obj-&gt;options) return;</span>
<a href="#l82.486"></a><span id="l82.486"> </span>
<a href="#l82.487"></a><span id="l82.487" class="difflineminus">-  ct = MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE,</span>
<a href="#l82.488"></a><span id="l82.488" class="difflineminus">-                       false, false);</span>
<a href="#l82.489"></a><span id="l82.489" class="difflineplus">+  ct = MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l82.490"></a><span id="l82.490">   if (obj-&gt;options-&gt;notify_nested_bodies) {</span>
<a href="#l82.491"></a><span id="l82.491">     mimeEmitterAddHeaderField(obj-&gt;options, HEADER_CONTENT_TYPE,</span>
<a href="#l82.492"></a><span id="l82.492">                               ct ? ct : TEXT_PLAIN);</span>
<a href="#l82.493"></a><span id="l82.493">     char *part_path = mime_part_address(obj);</span>
<a href="#l82.494"></a><span id="l82.494">     if (part_path) {</span>
<a href="#l82.495"></a><span id="l82.495">       mimeEmitterAddHeaderField(obj-&gt;options, &quot;x-jsemitter-part-path&quot;,</span>
<a href="#l82.496"></a><span id="l82.496">                                 part_path);</span>
<a href="#l82.497"></a><span id="l82.497">       PR_Free(part_path);</span>
<a href="#l82.498"></a><span id="l82.498">     }</span>
<a href="#l82.499"></a><span id="l82.499">   }</span>
<a href="#l82.500"></a><span id="l82.500"> </span>
<a href="#l82.501"></a><span id="l82.501">   // Examine the headers and see if there is a special charset</span>
<a href="#l82.502"></a><span id="l82.502">   // (i.e. non US-ASCII) for this message. If so, we need to</span>
<a href="#l82.503"></a><span id="l82.503">   // tell the emitter that this is the case for use in any</span>
<a href="#l82.504"></a><span id="l82.504">   // possible reply or forward operation.</span>
<a href="#l82.505"></a><span id="l82.505" class="difflineminus">-  if (ct &amp;&amp; (obj-&gt;options-&gt;notify_nested_bodies ||</span>
<a href="#l82.506"></a><span id="l82.506" class="difflineminus">-             MimeObjectIsMessageBody(obj))) {</span>
<a href="#l82.507"></a><span id="l82.507" class="difflineplus">+  if (ct &amp;&amp;</span>
<a href="#l82.508"></a><span id="l82.508" class="difflineplus">+      (obj-&gt;options-&gt;notify_nested_bodies || MimeObjectIsMessageBody(obj))) {</span>
<a href="#l82.509"></a><span id="l82.509">     char *cset = MimeHeaders_get_parameter(ct, &quot;charset&quot;, NULL, NULL);</span>
<a href="#l82.510"></a><span id="l82.510">     if (cset) {</span>
<a href="#l82.511"></a><span id="l82.511">       mimeEmitterUpdateCharacterSet(obj-&gt;options, cset);</span>
<a href="#l82.512"></a><span id="l82.512">       if (!obj-&gt;options-&gt;override_charset)</span>
<a href="#l82.513"></a><span id="l82.513">         // Also set this charset to msgWindow</span>
<a href="#l82.514"></a><span id="l82.514">         SetMailCharacterSetToMsgWindow(obj, cset);</span>
<a href="#l82.515"></a><span id="l82.515">       PR_Free(cset);</span>
<a href="#l82.516"></a><span id="l82.516">     }</span>
<a href="#l82.517"></a><span id="l82.517">   }</span>
<a href="#l82.518"></a><span id="l82.518"> </span>
<a href="#l82.519"></a><span id="l82.519">   PR_FREEIF(ct);</span>
<a href="#l82.520"></a><span id="l82.520"> }</span>
<a href="#l82.521"></a><span id="l82.521"> </span>
<a href="#l82.522"></a><span id="l82.522" class="difflineminus">-static MimeMultipartBoundaryType</span>
<a href="#l82.523"></a><span id="l82.523" class="difflineminus">-MimeMultipart_check_boundary(MimeObject *obj, const char *line, int32_t length)</span>
<a href="#l82.524"></a><span id="l82.524" class="difflineminus">-{</span>
<a href="#l82.525"></a><span id="l82.525" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) obj;</span>
<a href="#l82.526"></a><span id="l82.526" class="difflineplus">+static MimeMultipartBoundaryType MimeMultipart_check_boundary(MimeObject *obj,</span>
<a href="#l82.527"></a><span id="l82.527" class="difflineplus">+                                                              const char *line,</span>
<a href="#l82.528"></a><span id="l82.528" class="difflineplus">+                                                              int32_t length) {</span>
<a href="#l82.529"></a><span id="l82.529" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)obj;</span>
<a href="#l82.530"></a><span id="l82.530">   int32_t blen;</span>
<a href="#l82.531"></a><span id="l82.531">   bool term_p;</span>
<a href="#l82.532"></a><span id="l82.532"> </span>
<a href="#l82.533"></a><span id="l82.533" class="difflineminus">-  if (!mult-&gt;boundary ||</span>
<a href="#l82.534"></a><span id="l82.534" class="difflineminus">-    line[0] != '-' ||</span>
<a href="#l82.535"></a><span id="l82.535" class="difflineminus">-    line[1] != '-')</span>
<a href="#l82.536"></a><span id="l82.536" class="difflineminus">-  return MimeMultipartBoundaryTypeNone;</span>
<a href="#l82.537"></a><span id="l82.537" class="difflineplus">+  if (!mult-&gt;boundary || line[0] != '-' || line[1] != '-')</span>
<a href="#l82.538"></a><span id="l82.538" class="difflineplus">+    return MimeMultipartBoundaryTypeNone;</span>
<a href="#l82.539"></a><span id="l82.539"> </span>
<a href="#l82.540"></a><span id="l82.540">   /* This is a candidate line to be a boundary.  Check it out... */</span>
<a href="#l82.541"></a><span id="l82.541">   blen = strlen(mult-&gt;boundary);</span>
<a href="#l82.542"></a><span id="l82.542">   term_p = false;</span>
<a href="#l82.543"></a><span id="l82.543"> </span>
<a href="#l82.544"></a><span id="l82.544">   /* strip trailing whitespace (including the newline.) */</span>
<a href="#l82.545"></a><span id="l82.545" class="difflineminus">-  while(length &gt; 2 &amp;&amp; IS_SPACE(line[length-1]))</span>
<a href="#l82.546"></a><span id="l82.546" class="difflineminus">-  length--;</span>
<a href="#l82.547"></a><span id="l82.547" class="difflineplus">+  while (length &gt; 2 &amp;&amp; IS_SPACE(line[length - 1])) length--;</span>
<a href="#l82.548"></a><span id="l82.548"> </span>
<a href="#l82.549"></a><span id="l82.549">   /* Could this be a terminating boundary? */</span>
<a href="#l82.550"></a><span id="l82.550" class="difflineminus">-  if (length == blen + 4 &amp;&amp;</span>
<a href="#l82.551"></a><span id="l82.551" class="difflineminus">-    line[length-1] == '-' &amp;&amp;</span>
<a href="#l82.552"></a><span id="l82.552" class="difflineminus">-    line[length-2] == '-')</span>
<a href="#l82.553"></a><span id="l82.553" class="difflineminus">-  {</span>
<a href="#l82.554"></a><span id="l82.554" class="difflineplus">+  if (length == blen + 4 &amp;&amp; line[length - 1] == '-' &amp;&amp;</span>
<a href="#l82.555"></a><span id="l82.555" class="difflineplus">+      line[length - 2] == '-') {</span>
<a href="#l82.556"></a><span id="l82.556">     term_p = true;</span>
<a href="#l82.557"></a><span id="l82.557">   }</span>
<a href="#l82.558"></a><span id="l82.558"> </span>
<a href="#l82.559"></a><span id="l82.559" class="difflineminus">-  //looks like we have a separator but first, we need to check it's not for one of the part's children.</span>
<a href="#l82.560"></a><span id="l82.560" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) obj;</span>
<a href="#l82.561"></a><span id="l82.561" class="difflineminus">-  if (cont-&gt;nchildren &gt; 0)</span>
<a href="#l82.562"></a><span id="l82.562" class="difflineminus">-  {</span>
<a href="#l82.563"></a><span id="l82.563" class="difflineminus">-    MimeObject *kid = cont-&gt;children[cont-&gt;nchildren-1];</span>
<a href="#l82.564"></a><span id="l82.564" class="difflineplus">+  // looks like we have a separator but first, we need to check it's not for one</span>
<a href="#l82.565"></a><span id="l82.565" class="difflineplus">+  // of the part's children.</span>
<a href="#l82.566"></a><span id="l82.566" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l82.567"></a><span id="l82.567" class="difflineplus">+  if (cont-&gt;nchildren &gt; 0) {</span>
<a href="#l82.568"></a><span id="l82.568" class="difflineplus">+    MimeObject *kid = cont-&gt;children[cont-&gt;nchildren - 1];</span>
<a href="#l82.569"></a><span id="l82.569">     if (kid)</span>
<a href="#l82.570"></a><span id="l82.570" class="difflineminus">-      if (mime_typep(kid, (MimeObjectClass*) &amp;mimeMultipartClass))</span>
<a href="#l82.571"></a><span id="l82.571" class="difflineminus">-      {</span>
<a href="#l82.572"></a><span id="l82.572" class="difflineminus">-        //Don't ask the kid to check the boundary if it has already detected a Teminator</span>
<a href="#l82.573"></a><span id="l82.573" class="difflineminus">-        MimeMultipart *mult = (MimeMultipart *) kid;</span>
<a href="#l82.574"></a><span id="l82.574" class="difflineplus">+      if (mime_typep(kid, (MimeObjectClass *)&amp;mimeMultipartClass)) {</span>
<a href="#l82.575"></a><span id="l82.575" class="difflineplus">+        // Don't ask the kid to check the boundary if it has already detected a</span>
<a href="#l82.576"></a><span id="l82.576" class="difflineplus">+        // Teminator</span>
<a href="#l82.577"></a><span id="l82.577" class="difflineplus">+        MimeMultipart *mult = (MimeMultipart *)kid;</span>
<a href="#l82.578"></a><span id="l82.578">         if (mult-&gt;state != MimeMultipartEpilogue)</span>
<a href="#l82.579"></a><span id="l82.579" class="difflineminus">-          if (MimeMultipart_check_boundary(kid, line, length) != MimeMultipartBoundaryTypeNone)</span>
<a href="#l82.580"></a><span id="l82.580" class="difflineplus">+          if (MimeMultipart_check_boundary(kid, line, length) !=</span>
<a href="#l82.581"></a><span id="l82.581" class="difflineplus">+              MimeMultipartBoundaryTypeNone)</span>
<a href="#l82.582"></a><span id="l82.582">             return MimeMultipartBoundaryTypeNone;</span>
<a href="#l82.583"></a><span id="l82.583">       }</span>
<a href="#l82.584"></a><span id="l82.584">   }</span>
<a href="#l82.585"></a><span id="l82.585"> </span>
<a href="#l82.586"></a><span id="l82.586" class="difflineminus">-  if (term_p)</span>
<a href="#l82.587"></a><span id="l82.587" class="difflineminus">-    length -= 2;</span>
<a href="#l82.588"></a><span id="l82.588" class="difflineplus">+  if (term_p) length -= 2;</span>
<a href="#l82.589"></a><span id="l82.589"> </span>
<a href="#l82.590"></a><span id="l82.590" class="difflineminus">-  if (blen == length-2 &amp;&amp; !strncmp(line+2, mult-&gt;boundary, length-2))</span>
<a href="#l82.591"></a><span id="l82.591" class="difflineminus">-    return (term_p</span>
<a href="#l82.592"></a><span id="l82.592" class="difflineminus">-      ? MimeMultipartBoundaryTypeTerminator</span>
<a href="#l82.593"></a><span id="l82.593" class="difflineminus">-      : MimeMultipartBoundaryTypeSeparator);</span>
<a href="#l82.594"></a><span id="l82.594" class="difflineplus">+  if (blen == length - 2 &amp;&amp; !strncmp(line + 2, mult-&gt;boundary, length - 2))</span>
<a href="#l82.595"></a><span id="l82.595" class="difflineplus">+    return (term_p ? MimeMultipartBoundaryTypeTerminator</span>
<a href="#l82.596"></a><span id="l82.596" class="difflineplus">+                   : MimeMultipartBoundaryTypeSeparator);</span>
<a href="#l82.597"></a><span id="l82.597">   else</span>
<a href="#l82.598"></a><span id="l82.598">     return MimeMultipartBoundaryTypeNone;</span>
<a href="#l82.599"></a><span id="l82.599"> }</span>
<a href="#l82.600"></a><span id="l82.600"> </span>
<a href="#l82.601"></a><span id="l82.601" class="difflineminus">-</span>
<a href="#l82.602"></a><span id="l82.602" class="difflineminus">-static int</span>
<a href="#l82.603"></a><span id="l82.603" class="difflineminus">-MimeMultipart_create_child(MimeObject *obj)</span>
<a href="#l82.604"></a><span id="l82.604" class="difflineminus">-{</span>
<a href="#l82.605"></a><span id="l82.605" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) obj;</span>
<a href="#l82.606"></a><span id="l82.606" class="difflineminus">-  int           status;</span>
<a href="#l82.607"></a><span id="l82.607" class="difflineminus">-  char *ct = (mult-&gt;hdrs</span>
<a href="#l82.608"></a><span id="l82.608" class="difflineminus">-        ? MimeHeaders_get (mult-&gt;hdrs, HEADER_CONTENT_TYPE,</span>
<a href="#l82.609"></a><span id="l82.609" class="difflineminus">-                 true, false)</span>
<a href="#l82.610"></a><span id="l82.610" class="difflineminus">-        : 0);</span>
<a href="#l82.611"></a><span id="l82.611" class="difflineminus">-  const char *dct = (((MimeMultipartClass *) obj-&gt;clazz)-&gt;default_part_type);</span>
<a href="#l82.612"></a><span id="l82.612" class="difflineplus">+static int MimeMultipart_create_child(MimeObject *obj) {</span>
<a href="#l82.613"></a><span id="l82.613" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)obj;</span>
<a href="#l82.614"></a><span id="l82.614" class="difflineplus">+  int status;</span>
<a href="#l82.615"></a><span id="l82.615" class="difflineplus">+  char *ct = (mult-&gt;hdrs ? MimeHeaders_get(mult-&gt;hdrs, HEADER_CONTENT_TYPE,</span>
<a href="#l82.616"></a><span id="l82.616" class="difflineplus">+                                           true, false)</span>
<a href="#l82.617"></a><span id="l82.617" class="difflineplus">+                         : 0);</span>
<a href="#l82.618"></a><span id="l82.618" class="difflineplus">+  const char *dct = (((MimeMultipartClass *)obj-&gt;clazz)-&gt;default_part_type);</span>
<a href="#l82.619"></a><span id="l82.619">   MimeObject *body = NULL;</span>
<a href="#l82.620"></a><span id="l82.620"> </span>
<a href="#l82.621"></a><span id="l82.621">   mult-&gt;state = MimeMultipartPartFirstLine;</span>
<a href="#l82.622"></a><span id="l82.622" class="difflineminus">-  if (obj-&gt;options)</span>
<a href="#l82.623"></a><span id="l82.623" class="difflineminus">-    obj-&gt;options-&gt;is_child = true;</span>
<a href="#l82.624"></a><span id="l82.624" class="difflineplus">+  if (obj-&gt;options) obj-&gt;options-&gt;is_child = true;</span>
<a href="#l82.625"></a><span id="l82.625"> </span>
<a href="#l82.626"></a><span id="l82.626">   /* Don't pass in NULL as the content-type (this means that the</span>
<a href="#l82.627"></a><span id="l82.627">    auto-uudecode-hack won't ever be done for subparts of a</span>
<a href="#l82.628"></a><span id="l82.628">    multipart, but only for untyped children of message/rfc822.</span>
<a href="#l82.629"></a><span id="l82.629">    */</span>
<a href="#l82.630"></a><span id="l82.630" class="difflineminus">-  body = mime_create(((ct &amp;&amp; *ct) ? ct : (dct ? dct: TEXT_PLAIN)),</span>
<a href="#l82.631"></a><span id="l82.631" class="difflineminus">-           mult-&gt;hdrs, obj-&gt;options);</span>
<a href="#l82.632"></a><span id="l82.632" class="difflineplus">+  body = mime_create(((ct &amp;&amp; *ct) ? ct : (dct ? dct : TEXT_PLAIN)), mult-&gt;hdrs,</span>
<a href="#l82.633"></a><span id="l82.633" class="difflineplus">+                     obj-&gt;options);</span>
<a href="#l82.634"></a><span id="l82.634">   PR_FREEIF(ct);</span>
<a href="#l82.635"></a><span id="l82.635">   if (!body) return MIME_OUT_OF_MEMORY;</span>
<a href="#l82.636"></a><span id="l82.636" class="difflineminus">-  status = ((MimeContainerClass *) obj-&gt;clazz)-&gt;add_child(obj, body);</span>
<a href="#l82.637"></a><span id="l82.637" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l82.638"></a><span id="l82.638" class="difflineminus">-  {</span>
<a href="#l82.639"></a><span id="l82.639" class="difflineplus">+  status = ((MimeContainerClass *)obj-&gt;clazz)-&gt;add_child(obj, body);</span>
<a href="#l82.640"></a><span id="l82.640" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l82.641"></a><span id="l82.641">     mime_free(body);</span>
<a href="#l82.642"></a><span id="l82.642">     return status;</span>
<a href="#l82.643"></a><span id="l82.643">   }</span>
<a href="#l82.644"></a><span id="l82.644"> </span>
<a href="#l82.645"></a><span id="l82.645"> #ifdef MIME_DRAFTS</span>
<a href="#l82.646"></a><span id="l82.646" class="difflineminus">-  if ( obj-&gt;options &amp;&amp;</span>
<a href="#l82.647"></a><span id="l82.647" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l82.648"></a><span id="l82.648" class="difflineminus">-     obj-&gt;options-&gt;is_multipart_msg &amp;&amp;</span>
<a href="#l82.649"></a><span id="l82.649" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_init_fn )</span>
<a href="#l82.650"></a><span id="l82.650" class="difflineminus">-  {</span>
<a href="#l82.651"></a><span id="l82.651" class="difflineminus">-    if ( !mime_typep(obj,(MimeObjectClass*)&amp;mimeMultipartRelatedClass) &amp;&amp;</span>
<a href="#l82.652"></a><span id="l82.652" class="difflineminus">-           !mime_typep(obj,(MimeObjectClass*)&amp;mimeMultipartAlternativeClass) &amp;&amp;</span>
<a href="#l82.653"></a><span id="l82.653" class="difflineminus">-       !mime_typep(obj,(MimeObjectClass*)&amp;mimeMultipartSignedClass) &amp;&amp;</span>
<a href="#l82.654"></a><span id="l82.654" class="difflineminus">-#ifdef MIME_DETAIL_CHECK</span>
<a href="#l82.655"></a><span id="l82.655" class="difflineminus">-       !mime_typep(body, (MimeObjectClass*)&amp;mimeMultipartRelatedClass) &amp;&amp;</span>
<a href="#l82.656"></a><span id="l82.656" class="difflineminus">-       !mime_typep(body, (MimeObjectClass*)&amp;mimeMultipartAlternativeClass) &amp;&amp;</span>
<a href="#l82.657"></a><span id="l82.657" class="difflineminus">-       !mime_typep(body,(MimeObjectClass*)&amp;mimeMultipartSignedClass)</span>
<a href="#l82.658"></a><span id="l82.658" class="difflineminus">-#else</span>
<a href="#l82.659"></a><span id="l82.659" class="difflineminus">-           /* bug 21869 -- due to the fact that we are not generating the</span>
<a href="#l82.660"></a><span id="l82.660" class="difflineminus">-              correct mime class object for content-typ multipart/signed part</span>
<a href="#l82.661"></a><span id="l82.661" class="difflineminus">-              the above check failed. to solve the problem in general and not</span>
<a href="#l82.662"></a><span id="l82.662" class="difflineminus">-              to cause early temination when parsing message for opening as</span>
<a href="#l82.663"></a><span id="l82.663" class="difflineminus">-              draft we can simply make sure that the child is not a multipart</span>
<a href="#l82.664"></a><span id="l82.664" class="difflineminus">-              mime object. this way we could have a proper decomposing message</span>
<a href="#l82.665"></a><span id="l82.665" class="difflineminus">-              part functions set correctly */</span>
<a href="#l82.666"></a><span id="l82.666" class="difflineminus">-           !mime_typep(body, (MimeObjectClass*) &amp;mimeMultipartClass)</span>
<a href="#l82.667"></a><span id="l82.667" class="difflineminus">-#endif</span>
<a href="#l82.668"></a><span id="l82.668" class="difflineminus">-    &amp;&amp;        ! (mime_typep(body, (MimeObjectClass*)&amp;mimeExternalObjectClass) &amp;&amp; !strcmp(body-&gt;content_type, &quot;text/x-vcard&quot;))</span>
<a href="#l82.669"></a><span id="l82.669" class="difflineminus">-       )</span>
<a href="#l82.670"></a><span id="l82.670" class="difflineminus">-    {</span>
<a href="#l82.671"></a><span id="l82.671" class="difflineminus">-    status = obj-&gt;options-&gt;decompose_file_init_fn ( obj-&gt;options-&gt;stream_closure, mult-&gt;hdrs );</span>
<a href="#l82.672"></a><span id="l82.672" class="difflineminus">-    if (status &lt; 0) return status;</span>
<a href="#l82.673"></a><span id="l82.673" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l82.674"></a><span id="l82.674" class="difflineplus">+      obj-&gt;options-&gt;is_multipart_msg &amp;&amp; obj-&gt;options-&gt;decompose_file_init_fn) {</span>
<a href="#l82.675"></a><span id="l82.675" class="difflineplus">+    if (!mime_typep(obj, (MimeObjectClass *)&amp;mimeMultipartRelatedClass) &amp;&amp;</span>
<a href="#l82.676"></a><span id="l82.676" class="difflineplus">+        !mime_typep(obj, (MimeObjectClass *)&amp;mimeMultipartAlternativeClass) &amp;&amp;</span>
<a href="#l82.677"></a><span id="l82.677" class="difflineplus">+        !mime_typep(obj, (MimeObjectClass *)&amp;mimeMultipartSignedClass) &amp;&amp;</span>
<a href="#l82.678"></a><span id="l82.678" class="difflineplus">+#  ifdef MIME_DETAIL_CHECK</span>
<a href="#l82.679"></a><span id="l82.679" class="difflineplus">+        !mime_typep(body, (MimeObjectClass *)&amp;mimeMultipartRelatedClass) &amp;&amp;</span>
<a href="#l82.680"></a><span id="l82.680" class="difflineplus">+        !mime_typep(body, (MimeObjectClass *)&amp;mimeMultipartAlternativeClass) &amp;&amp;</span>
<a href="#l82.681"></a><span id="l82.681" class="difflineplus">+        !mime_typep(body, (MimeObjectClass *)&amp;mimeMultipartSignedClass)</span>
<a href="#l82.682"></a><span id="l82.682" class="difflineplus">+#  else</span>
<a href="#l82.683"></a><span id="l82.683" class="difflineplus">+        /* bug 21869 -- due to the fact that we are not generating the</span>
<a href="#l82.684"></a><span id="l82.684" class="difflineplus">+           correct mime class object for content-typ multipart/signed part</span>
<a href="#l82.685"></a><span id="l82.685" class="difflineplus">+           the above check failed. to solve the problem in general and not</span>
<a href="#l82.686"></a><span id="l82.686" class="difflineplus">+           to cause early temination when parsing message for opening as</span>
<a href="#l82.687"></a><span id="l82.687" class="difflineplus">+           draft we can simply make sure that the child is not a multipart</span>
<a href="#l82.688"></a><span id="l82.688" class="difflineplus">+           mime object. this way we could have a proper decomposing message</span>
<a href="#l82.689"></a><span id="l82.689" class="difflineplus">+           part functions set correctly */</span>
<a href="#l82.690"></a><span id="l82.690" class="difflineplus">+        !mime_typep(body, (MimeObjectClass *)&amp;mimeMultipartClass)</span>
<a href="#l82.691"></a><span id="l82.691" class="difflineplus">+#  endif</span>
<a href="#l82.692"></a><span id="l82.692" class="difflineplus">+        &amp;&amp; !(mime_typep(body, (MimeObjectClass *)&amp;mimeExternalObjectClass) &amp;&amp;</span>
<a href="#l82.693"></a><span id="l82.693" class="difflineplus">+             !strcmp(body-&gt;content_type, &quot;text/x-vcard&quot;))) {</span>
<a href="#l82.694"></a><span id="l82.694" class="difflineplus">+      status = obj-&gt;options-&gt;decompose_file_init_fn(</span>
<a href="#l82.695"></a><span id="l82.695" class="difflineplus">+          obj-&gt;options-&gt;stream_closure, mult-&gt;hdrs);</span>
<a href="#l82.696"></a><span id="l82.696" class="difflineplus">+      if (status &lt; 0) return status;</span>
<a href="#l82.697"></a><span id="l82.697">     }</span>
<a href="#l82.698"></a><span id="l82.698">   }</span>
<a href="#l82.699"></a><span id="l82.699"> #endif /* MIME_DRAFTS */</span>
<a href="#l82.700"></a><span id="l82.700"> </span>
<a href="#l82.701"></a><span id="l82.701" class="difflineminus">-</span>
<a href="#l82.702"></a><span id="l82.702">   /* Now that we've added this new object to our list of children,</span>
<a href="#l82.703"></a><span id="l82.703">    start its parser going (if we want to display it.)</span>
<a href="#l82.704"></a><span id="l82.704">    */</span>
<a href="#l82.705"></a><span id="l82.705" class="difflineminus">-  body-&gt;output_p = (((MimeMultipartClass *) obj-&gt;clazz)-&gt;output_child_p(obj, body));</span>
<a href="#l82.706"></a><span id="l82.706" class="difflineminus">-  if (body-&gt;output_p)</span>
<a href="#l82.707"></a><span id="l82.707" class="difflineminus">-  {</span>
<a href="#l82.708"></a><span id="l82.708" class="difflineplus">+  body-&gt;output_p =</span>
<a href="#l82.709"></a><span id="l82.709" class="difflineplus">+      (((MimeMultipartClass *)obj-&gt;clazz)-&gt;output_child_p(obj, body));</span>
<a href="#l82.710"></a><span id="l82.710" class="difflineplus">+  if (body-&gt;output_p) {</span>
<a href="#l82.711"></a><span id="l82.711">     status = body-&gt;clazz-&gt;parse_begin(body);</span>
<a href="#l82.712"></a><span id="l82.712"> </span>
<a href="#l82.713"></a><span id="l82.713"> #ifdef XP_MACOSX</span>
<a href="#l82.714"></a><span id="l82.714" class="difflineminus">-    /* if we are saving an apple double attachment, we need to set correctly the content type of the channel */</span>
<a href="#l82.715"></a><span id="l82.715" class="difflineminus">-    if (mime_typep(obj, (MimeObjectClass *) &amp;mimeMultipartAppleDoubleClass))</span>
<a href="#l82.716"></a><span id="l82.716" class="difflineminus">-    {</span>
<a href="#l82.717"></a><span id="l82.717" class="difflineplus">+    /* if we are saving an apple double attachment, we need to set correctly the</span>
<a href="#l82.718"></a><span id="l82.718" class="difflineplus">+     * content type of the channel */</span>
<a href="#l82.719"></a><span id="l82.719" class="difflineplus">+    if (mime_typep(obj, (MimeObjectClass *)&amp;mimeMultipartAppleDoubleClass)) {</span>
<a href="#l82.720"></a><span id="l82.720">       mime_stream_data *msd = (mime_stream_data *)body-&gt;options-&gt;stream_closure;</span>
<a href="#l82.721"></a><span id="l82.721" class="difflineminus">-      if (!body-&gt;options-&gt;write_html_p &amp;&amp; body-&gt;content_type &amp;&amp; !PL_strcasecmp(body-&gt;content_type, APPLICATION_APPLEFILE))</span>
<a href="#l82.722"></a><span id="l82.722" class="difflineminus">-      {</span>
<a href="#l82.723"></a><span id="l82.723" class="difflineplus">+      if (!body-&gt;options-&gt;write_html_p &amp;&amp; body-&gt;content_type &amp;&amp;</span>
<a href="#l82.724"></a><span id="l82.724" class="difflineplus">+          !PL_strcasecmp(body-&gt;content_type, APPLICATION_APPLEFILE)) {</span>
<a href="#l82.725"></a><span id="l82.725">         if (msd &amp;&amp; msd-&gt;channel)</span>
<a href="#l82.726"></a><span id="l82.726" class="difflineminus">-          msd-&gt;channel-&gt;SetContentType(NS_LITERAL_CSTRING(APPLICATION_APPLEFILE));</span>
<a href="#l82.727"></a><span id="l82.727" class="difflineplus">+          msd-&gt;channel-&gt;SetContentType(</span>
<a href="#l82.728"></a><span id="l82.728" class="difflineplus">+              NS_LITERAL_CSTRING(APPLICATION_APPLEFILE));</span>
<a href="#l82.729"></a><span id="l82.729">       }</span>
<a href="#l82.730"></a><span id="l82.730">     }</span>
<a href="#l82.731"></a><span id="l82.731"> #endif</span>
<a href="#l82.732"></a><span id="l82.732"> </span>
<a href="#l82.733"></a><span id="l82.733">     if (status &lt; 0) return status;</span>
<a href="#l82.734"></a><span id="l82.734">   }</span>
<a href="#l82.735"></a><span id="l82.735"> </span>
<a href="#l82.736"></a><span id="l82.736">   return 0;</span>
<a href="#l82.737"></a><span id="l82.737"> }</span>
<a href="#l82.738"></a><span id="l82.738"> </span>
<a href="#l82.739"></a><span id="l82.739" class="difflineminus">-</span>
<a href="#l82.740"></a><span id="l82.740" class="difflineminus">-static bool</span>
<a href="#l82.741"></a><span id="l82.741" class="difflineminus">-MimeMultipart_output_child_p(MimeObject *obj, MimeObject *child)</span>
<a href="#l82.742"></a><span id="l82.742" class="difflineminus">-{</span>
<a href="#l82.743"></a><span id="l82.743" class="difflineplus">+static bool MimeMultipart_output_child_p(MimeObject *obj, MimeObject *child) {</span>
<a href="#l82.744"></a><span id="l82.744">   /* We don't output a child if we're stripping it. */</span>
<a href="#l82.745"></a><span id="l82.745">   if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state &amp;&amp; obj-&gt;options-&gt;state-&gt;strippingPart)</span>
<a href="#l82.746"></a><span id="l82.746">     return false;</span>
<a href="#l82.747"></a><span id="l82.747" class="difflineminus">-  /* if we are saving an apple double attachment, ignore the appledouble wrapper part */</span>
<a href="#l82.748"></a><span id="l82.748" class="difflineplus">+  /* if we are saving an apple double attachment, ignore the appledouble wrapper</span>
<a href="#l82.749"></a><span id="l82.749" class="difflineplus">+   * part */</span>
<a href="#l82.750"></a><span id="l82.750">   return (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;write_html_p) ||</span>
<a href="#l82.751"></a><span id="l82.751" class="difflineminus">-          PL_strcasecmp(child-&gt;content_type, MULTIPART_APPLEDOUBLE);</span>
<a href="#l82.752"></a><span id="l82.752" class="difflineplus">+         PL_strcasecmp(child-&gt;content_type, MULTIPART_APPLEDOUBLE);</span>
<a href="#l82.753"></a><span id="l82.753"> }</span>
<a href="#l82.754"></a><span id="l82.754"> </span>
<a href="#l82.755"></a><span id="l82.755" class="difflineminus">-</span>
<a href="#l82.756"></a><span id="l82.756" class="difflineplus">+static int MimeMultipart_close_child(MimeObject *object) {</span>
<a href="#l82.757"></a><span id="l82.757" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)object;</span>
<a href="#l82.758"></a><span id="l82.758" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)object;</span>
<a href="#l82.759"></a><span id="l82.759"> </span>
<a href="#l82.760"></a><span id="l82.760" class="difflineminus">-static int</span>
<a href="#l82.761"></a><span id="l82.761" class="difflineminus">-MimeMultipart_close_child(MimeObject *object)</span>
<a href="#l82.762"></a><span id="l82.762" class="difflineminus">-{</span>
<a href="#l82.763"></a><span id="l82.763" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) object;</span>
<a href="#l82.764"></a><span id="l82.764" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) object;</span>
<a href="#l82.765"></a><span id="l82.765" class="difflineminus">-</span>
<a href="#l82.766"></a><span id="l82.766" class="difflineminus">-  if (!mult-&gt;hdrs)</span>
<a href="#l82.767"></a><span id="l82.767" class="difflineminus">-  return 0;</span>
<a href="#l82.768"></a><span id="l82.768" class="difflineplus">+  if (!mult-&gt;hdrs) return 0;</span>
<a href="#l82.769"></a><span id="l82.769"> </span>
<a href="#l82.770"></a><span id="l82.770">   MimeHeaders_free(mult-&gt;hdrs);</span>
<a href="#l82.771"></a><span id="l82.771">   mult-&gt;hdrs = 0;</span>
<a href="#l82.772"></a><span id="l82.772"> </span>
<a href="#l82.773"></a><span id="l82.773">   NS_ASSERTION(cont-&gt;nchildren &gt; 0, &quot;badly formed mime message&quot;);</span>
<a href="#l82.774"></a><span id="l82.774" class="difflineminus">-  if (cont-&gt;nchildren &gt; 0)</span>
<a href="#l82.775"></a><span id="l82.775" class="difflineminus">-  {</span>
<a href="#l82.776"></a><span id="l82.776" class="difflineminus">-    MimeObject *kid = cont-&gt;children[cont-&gt;nchildren-1];</span>
<a href="#l82.777"></a><span id="l82.777" class="difflineplus">+  if (cont-&gt;nchildren &gt; 0) {</span>
<a href="#l82.778"></a><span id="l82.778" class="difflineplus">+    MimeObject *kid = cont-&gt;children[cont-&gt;nchildren - 1];</span>
<a href="#l82.779"></a><span id="l82.779">     // If we have a child and it has not already been closed, process it.</span>
<a href="#l82.780"></a><span id="l82.780">     // The kid would be already be closed if we encounter a multipart section</span>
<a href="#l82.781"></a><span id="l82.781">     // that did not have a fully delineated header block.  No header block means</span>
<a href="#l82.782"></a><span id="l82.782">     // no creation of a new child, but the termination case still happens and</span>
<a href="#l82.783"></a><span id="l82.783">     // we still end up here.  Obviously, we don't want to close the child a</span>
<a href="#l82.784"></a><span id="l82.784">     // second time and the best thing we can do is nothing.</span>
<a href="#l82.785"></a><span id="l82.785" class="difflineminus">-    if (kid &amp;&amp; !kid-&gt;closed_p)</span>
<a href="#l82.786"></a><span id="l82.786" class="difflineminus">-    {</span>
<a href="#l82.787"></a><span id="l82.787" class="difflineplus">+    if (kid &amp;&amp; !kid-&gt;closed_p) {</span>
<a href="#l82.788"></a><span id="l82.788">       int status;</span>
<a href="#l82.789"></a><span id="l82.789">       status = kid-&gt;clazz-&gt;parse_eof(kid, false);</span>
<a href="#l82.790"></a><span id="l82.790">       if (status &lt; 0) return status;</span>
<a href="#l82.791"></a><span id="l82.791">       status = kid-&gt;clazz-&gt;parse_end(kid, false);</span>
<a href="#l82.792"></a><span id="l82.792">       if (status &lt; 0) return status;</span>
<a href="#l82.793"></a><span id="l82.793"> </span>
<a href="#l82.794"></a><span id="l82.794"> #ifdef MIME_DRAFTS</span>
<a href="#l82.795"></a><span id="l82.795" class="difflineminus">-      if ( object-&gt;options &amp;&amp;</span>
<a href="#l82.796"></a><span id="l82.796" class="difflineminus">-         object-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l82.797"></a><span id="l82.797" class="difflineminus">-         object-&gt;options-&gt;is_multipart_msg &amp;&amp;</span>
<a href="#l82.798"></a><span id="l82.798" class="difflineminus">-         object-&gt;options-&gt;decompose_file_close_fn )</span>
<a href="#l82.799"></a><span id="l82.799" class="difflineminus">-      {</span>
<a href="#l82.800"></a><span id="l82.800" class="difflineminus">-        if ( !mime_typep(object,(MimeObjectClass*)&amp;mimeMultipartRelatedClass) &amp;&amp;</span>
<a href="#l82.801"></a><span id="l82.801" class="difflineminus">-           !mime_typep(object,(MimeObjectClass*)&amp;mimeMultipartAlternativeClass) &amp;&amp;</span>
<a href="#l82.802"></a><span id="l82.802" class="difflineminus">-           !mime_typep(object,(MimeObjectClass*)&amp;mimeMultipartSignedClass) &amp;&amp;</span>
<a href="#l82.803"></a><span id="l82.803" class="difflineminus">-#ifdef MIME_DETAIL_CHECK</span>
<a href="#l82.804"></a><span id="l82.804" class="difflineminus">-           !mime_typep(kid,(MimeObjectClass*)&amp;mimeMultipartRelatedClass) &amp;&amp;</span>
<a href="#l82.805"></a><span id="l82.805" class="difflineminus">-           !mime_typep(kid,(MimeObjectClass*)&amp;mimeMultipartAlternativeClass) &amp;&amp;</span>
<a href="#l82.806"></a><span id="l82.806" class="difflineminus">-           !mime_typep(kid,(MimeObjectClass*)&amp;mimeMultipartSignedClass)</span>
<a href="#l82.807"></a><span id="l82.807" class="difflineminus">-#else</span>
<a href="#l82.808"></a><span id="l82.808" class="difflineminus">-                   /* bug 21869 -- due to the fact that we are not generating the</span>
<a href="#l82.809"></a><span id="l82.809" class="difflineminus">-                      correct mime class object for content-typ multipart/signed part</span>
<a href="#l82.810"></a><span id="l82.810" class="difflineminus">-                      the above check failed. to solve the problem in general and not</span>
<a href="#l82.811"></a><span id="l82.811" class="difflineminus">-                      to cause early temination when parsing message for opening as</span>
<a href="#l82.812"></a><span id="l82.812" class="difflineminus">-                      draft we can simply make sure that the child is not a multipart</span>
<a href="#l82.813"></a><span id="l82.813" class="difflineminus">-                      mime object. this way we could have a proper decomposing message</span>
<a href="#l82.814"></a><span id="l82.814" class="difflineminus">-                      part functions set correctly */</span>
<a href="#l82.815"></a><span id="l82.815" class="difflineminus">-                   !mime_typep(kid,(MimeObjectClass*) &amp;mimeMultipartClass)</span>
<a href="#l82.816"></a><span id="l82.816" class="difflineminus">-#endif</span>
<a href="#l82.817"></a><span id="l82.817" class="difflineminus">-                                  &amp;&amp; !(mime_typep(kid, (MimeObjectClass*)&amp;mimeExternalObjectClass) &amp;&amp; !strcmp(kid-&gt;content_type, &quot;text/x-vcard&quot;))</span>
<a href="#l82.818"></a><span id="l82.818" class="difflineminus">-           )</span>
<a href="#l82.819"></a><span id="l82.819" class="difflineminus">-        {</span>
<a href="#l82.820"></a><span id="l82.820" class="difflineminus">-          status = object-&gt;options-&gt;decompose_file_close_fn ( object-&gt;options-&gt;stream_closure );</span>
<a href="#l82.821"></a><span id="l82.821" class="difflineplus">+      if (object-&gt;options &amp;&amp; object-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l82.822"></a><span id="l82.822" class="difflineplus">+          object-&gt;options-&gt;is_multipart_msg &amp;&amp;</span>
<a href="#l82.823"></a><span id="l82.823" class="difflineplus">+          object-&gt;options-&gt;decompose_file_close_fn) {</span>
<a href="#l82.824"></a><span id="l82.824" class="difflineplus">+        if (!mime_typep(object,</span>
<a href="#l82.825"></a><span id="l82.825" class="difflineplus">+                        (MimeObjectClass *)&amp;mimeMultipartRelatedClass) &amp;&amp;</span>
<a href="#l82.826"></a><span id="l82.826" class="difflineplus">+            !mime_typep(object,</span>
<a href="#l82.827"></a><span id="l82.827" class="difflineplus">+                        (MimeObjectClass *)&amp;mimeMultipartAlternativeClass) &amp;&amp;</span>
<a href="#l82.828"></a><span id="l82.828" class="difflineplus">+            !mime_typep(object, (MimeObjectClass *)&amp;mimeMultipartSignedClass) &amp;&amp;</span>
<a href="#l82.829"></a><span id="l82.829" class="difflineplus">+#  ifdef MIME_DETAIL_CHECK</span>
<a href="#l82.830"></a><span id="l82.830" class="difflineplus">+            !mime_typep(kid, (MimeObjectClass *)&amp;mimeMultipartRelatedClass) &amp;&amp;</span>
<a href="#l82.831"></a><span id="l82.831" class="difflineplus">+            !mime_typep(kid,</span>
<a href="#l82.832"></a><span id="l82.832" class="difflineplus">+                        (MimeObjectClass *)&amp;mimeMultipartAlternativeClass) &amp;&amp;</span>
<a href="#l82.833"></a><span id="l82.833" class="difflineplus">+            !mime_typep(kid, (MimeObjectClass *)&amp;mimeMultipartSignedClass)</span>
<a href="#l82.834"></a><span id="l82.834" class="difflineplus">+#  else</span>
<a href="#l82.835"></a><span id="l82.835" class="difflineplus">+            /* bug 21869 -- due to the fact that we are not generating the</span>
<a href="#l82.836"></a><span id="l82.836" class="difflineplus">+               correct mime class object for content-typ multipart/signed part</span>
<a href="#l82.837"></a><span id="l82.837" class="difflineplus">+               the above check failed. to solve the problem in general and not</span>
<a href="#l82.838"></a><span id="l82.838" class="difflineplus">+               to cause early temination when parsing message for opening as</span>
<a href="#l82.839"></a><span id="l82.839" class="difflineplus">+               draft we can simply make sure that the child is not a multipart</span>
<a href="#l82.840"></a><span id="l82.840" class="difflineplus">+               mime object. this way we could have a proper decomposing message</span>
<a href="#l82.841"></a><span id="l82.841" class="difflineplus">+               part functions set correctly */</span>
<a href="#l82.842"></a><span id="l82.842" class="difflineplus">+            !mime_typep(kid, (MimeObjectClass *)&amp;mimeMultipartClass)</span>
<a href="#l82.843"></a><span id="l82.843" class="difflineplus">+#  endif</span>
<a href="#l82.844"></a><span id="l82.844" class="difflineplus">+            &amp;&amp; !(mime_typep(kid, (MimeObjectClass *)&amp;mimeExternalObjectClass) &amp;&amp;</span>
<a href="#l82.845"></a><span id="l82.845" class="difflineplus">+                 !strcmp(kid-&gt;content_type, &quot;text/x-vcard&quot;))) {</span>
<a href="#l82.846"></a><span id="l82.846" class="difflineplus">+          status = object-&gt;options-&gt;decompose_file_close_fn(</span>
<a href="#l82.847"></a><span id="l82.847" class="difflineplus">+              object-&gt;options-&gt;stream_closure);</span>
<a href="#l82.848"></a><span id="l82.848">           if (status &lt; 0) return status;</span>
<a href="#l82.849"></a><span id="l82.849">         }</span>
<a href="#l82.850"></a><span id="l82.850">       }</span>
<a href="#l82.851"></a><span id="l82.851"> #endif /* MIME_DRAFTS */</span>
<a href="#l82.852"></a><span id="l82.852" class="difflineminus">-</span>
<a href="#l82.853"></a><span id="l82.853">     }</span>
<a href="#l82.854"></a><span id="l82.854">   }</span>
<a href="#l82.855"></a><span id="l82.855">   return 0;</span>
<a href="#l82.856"></a><span id="l82.856"> }</span>
<a href="#l82.857"></a><span id="l82.857"> </span>
<a href="#l82.858"></a><span id="l82.858" class="difflineminus">-</span>
<a href="#l82.859"></a><span id="l82.859" class="difflineminus">-static int</span>
<a href="#l82.860"></a><span id="l82.860" class="difflineminus">-MimeMultipart_parse_child_line (MimeObject *obj, const char *line, int32_t length,</span>
<a href="#l82.861"></a><span id="l82.861" class="difflineminus">-                bool first_line_p)</span>
<a href="#l82.862"></a><span id="l82.862" class="difflineminus">-{</span>
<a href="#l82.863"></a><span id="l82.863" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) obj;</span>
<a href="#l82.864"></a><span id="l82.864" class="difflineplus">+static int MimeMultipart_parse_child_line(MimeObject *obj, const char *line,</span>
<a href="#l82.865"></a><span id="l82.865" class="difflineplus">+                                          int32_t length, bool first_line_p) {</span>
<a href="#l82.866"></a><span id="l82.866" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l82.867"></a><span id="l82.867">   int status;</span>
<a href="#l82.868"></a><span id="l82.868">   MimeObject *kid;</span>
<a href="#l82.869"></a><span id="l82.869"> </span>
<a href="#l82.870"></a><span id="l82.870">   PR_ASSERT(cont-&gt;nchildren &gt; 0);</span>
<a href="#l82.871"></a><span id="l82.871" class="difflineminus">-  if (cont-&gt;nchildren &lt;= 0)</span>
<a href="#l82.872"></a><span id="l82.872" class="difflineminus">-  return -1;</span>
<a href="#l82.873"></a><span id="l82.873" class="difflineplus">+  if (cont-&gt;nchildren &lt;= 0) return -1;</span>
<a href="#l82.874"></a><span id="l82.874"> </span>
<a href="#l82.875"></a><span id="l82.875" class="difflineminus">-  kid = cont-&gt;children[cont-&gt;nchildren-1];</span>
<a href="#l82.876"></a><span id="l82.876" class="difflineplus">+  kid = cont-&gt;children[cont-&gt;nchildren - 1];</span>
<a href="#l82.877"></a><span id="l82.877">   PR_ASSERT(kid);</span>
<a href="#l82.878"></a><span id="l82.878">   if (!kid) return -1;</span>
<a href="#l82.879"></a><span id="l82.879"> </span>
<a href="#l82.880"></a><span id="l82.880"> #ifdef MIME_DRAFTS</span>
<a href="#l82.881"></a><span id="l82.881" class="difflineminus">-  if ( obj-&gt;options &amp;&amp;</span>
<a href="#l82.882"></a><span id="l82.882" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l82.883"></a><span id="l82.883" class="difflineminus">-     obj-&gt;options-&gt;is_multipart_msg &amp;&amp;</span>
<a href="#l82.884"></a><span id="l82.884" class="difflineminus">-     obj-&gt;options-&gt;decompose_file_output_fn )</span>
<a href="#l82.885"></a><span id="l82.885" class="difflineminus">-  {</span>
<a href="#l82.886"></a><span id="l82.886" class="difflineminus">-  if (!mime_typep(obj,(MimeObjectClass*)&amp;mimeMultipartAlternativeClass) &amp;&amp;</span>
<a href="#l82.887"></a><span id="l82.887" class="difflineminus">-    !mime_typep(obj,(MimeObjectClass*)&amp;mimeMultipartRelatedClass) &amp;&amp;</span>
<a href="#l82.888"></a><span id="l82.888" class="difflineminus">-    !mime_typep(obj,(MimeObjectClass*)&amp;mimeMultipartSignedClass) &amp;&amp;</span>
<a href="#l82.889"></a><span id="l82.889" class="difflineminus">-#ifdef MIME_DETAIL_CHECK</span>
<a href="#l82.890"></a><span id="l82.890" class="difflineminus">-    !mime_typep(kid,(MimeObjectClass*)&amp;mimeMultipartAlternativeClass) &amp;&amp;</span>
<a href="#l82.891"></a><span id="l82.891" class="difflineminus">-    !mime_typep(kid,(MimeObjectClass*)&amp;mimeMultipartRelatedClass) &amp;&amp;</span>
<a href="#l82.892"></a><span id="l82.892" class="difflineminus">-    !mime_typep(kid,(MimeObjectClass*)&amp;mimeMultipartSignedClass)</span>
<a href="#l82.893"></a><span id="l82.893" class="difflineminus">-#else</span>
<a href="#l82.894"></a><span id="l82.894" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l82.895"></a><span id="l82.895" class="difflineplus">+      obj-&gt;options-&gt;is_multipart_msg &amp;&amp;</span>
<a href="#l82.896"></a><span id="l82.896" class="difflineplus">+      obj-&gt;options-&gt;decompose_file_output_fn) {</span>
<a href="#l82.897"></a><span id="l82.897" class="difflineplus">+    if (!mime_typep(obj, (MimeObjectClass *)&amp;mimeMultipartAlternativeClass) &amp;&amp;</span>
<a href="#l82.898"></a><span id="l82.898" class="difflineplus">+        !mime_typep(obj, (MimeObjectClass *)&amp;mimeMultipartRelatedClass) &amp;&amp;</span>
<a href="#l82.899"></a><span id="l82.899" class="difflineplus">+        !mime_typep(obj, (MimeObjectClass *)&amp;mimeMultipartSignedClass) &amp;&amp;</span>
<a href="#l82.900"></a><span id="l82.900" class="difflineplus">+#  ifdef MIME_DETAIL_CHECK</span>
<a href="#l82.901"></a><span id="l82.901" class="difflineplus">+        !mime_typep(kid, (MimeObjectClass *)&amp;mimeMultipartAlternativeClass) &amp;&amp;</span>
<a href="#l82.902"></a><span id="l82.902" class="difflineplus">+        !mime_typep(kid, (MimeObjectClass *)&amp;mimeMultipartRelatedClass) &amp;&amp;</span>
<a href="#l82.903"></a><span id="l82.903" class="difflineplus">+        !mime_typep(kid, (MimeObjectClass *)&amp;mimeMultipartSignedClass)</span>
<a href="#l82.904"></a><span id="l82.904" class="difflineplus">+#  else</span>
<a href="#l82.905"></a><span id="l82.905">         /* bug 21869 -- due to the fact that we are not generating the</span>
<a href="#l82.906"></a><span id="l82.906">            correct mime class object for content-typ multipart/signed part</span>
<a href="#l82.907"></a><span id="l82.907">            the above check failed. to solve the problem in general and not</span>
<a href="#l82.908"></a><span id="l82.908">            to cause early temination when parsing message for opening as</span>
<a href="#l82.909"></a><span id="l82.909">            draft we can simply make sure that the child is not a multipart</span>
<a href="#l82.910"></a><span id="l82.910">            mime object. this way we could have a proper decomposing message</span>
<a href="#l82.911"></a><span id="l82.911">            part functions set correctly */</span>
<a href="#l82.912"></a><span id="l82.912" class="difflineminus">-        !mime_typep(kid, (MimeObjectClass*) &amp;mimeMultipartClass)</span>
<a href="#l82.913"></a><span id="l82.913" class="difflineminus">-#endif</span>
<a href="#l82.914"></a><span id="l82.914" class="difflineminus">-    &amp;&amp; !(mime_typep(kid, (MimeObjectClass*)&amp;mimeExternalObjectClass) &amp;&amp; !strcmp(kid-&gt;content_type, &quot;text/x-vcard&quot;))</span>
<a href="#l82.915"></a><span id="l82.915" class="difflineminus">-    )</span>
<a href="#l82.916"></a><span id="l82.916" class="difflineminus">-    return obj-&gt;options-&gt;decompose_file_output_fn (line, length, obj-&gt;options-&gt;stream_closure);</span>
<a href="#l82.917"></a><span id="l82.917" class="difflineplus">+        !mime_typep(kid, (MimeObjectClass *)&amp;mimeMultipartClass)</span>
<a href="#l82.918"></a><span id="l82.918" class="difflineplus">+#  endif</span>
<a href="#l82.919"></a><span id="l82.919" class="difflineplus">+        &amp;&amp; !(mime_typep(kid, (MimeObjectClass *)&amp;mimeExternalObjectClass) &amp;&amp;</span>
<a href="#l82.920"></a><span id="l82.920" class="difflineplus">+             !strcmp(kid-&gt;content_type, &quot;text/x-vcard&quot;)))</span>
<a href="#l82.921"></a><span id="l82.921" class="difflineplus">+      return obj-&gt;options-&gt;decompose_file_output_fn(</span>
<a href="#l82.922"></a><span id="l82.922" class="difflineplus">+          line, length, obj-&gt;options-&gt;stream_closure);</span>
<a href="#l82.923"></a><span id="l82.923">   }</span>
<a href="#l82.924"></a><span id="l82.924"> #endif /* MIME_DRAFTS */</span>
<a href="#l82.925"></a><span id="l82.925"> </span>
<a href="#l82.926"></a><span id="l82.926">   /* The newline issues here are tricky, since both the newlines before</span>
<a href="#l82.927"></a><span id="l82.927">    and after the boundary string are to be considered part of the</span>
<a href="#l82.928"></a><span id="l82.928">    boundary: this is so that a part can be specified such that it</span>
<a href="#l82.929"></a><span id="l82.929">    does not end in a trailing newline.</span>
<a href="#l82.930"></a><span id="l82.930"> </span>
<a href="#l82.931"></a><span id="l82.931">    To implement this, we send a newline *before* each line instead</span>
<a href="#l82.932"></a><span id="l82.932">    of after, except for the first line, which is not preceded by a</span>
<a href="#l82.933"></a><span id="l82.933">    newline.</span>
<a href="#l82.934"></a><span id="l82.934">    */</span>
<a href="#l82.935"></a><span id="l82.935"> </span>
<a href="#l82.936"></a><span id="l82.936">   /* Remove the trailing newline... */</span>
<a href="#l82.937"></a><span id="l82.937" class="difflineminus">-  if (length &gt; 0 &amp;&amp; line[length-1] == '\n') length--;</span>
<a href="#l82.938"></a><span id="l82.938" class="difflineminus">-  if (length &gt; 0 &amp;&amp; line[length-1] == '\r') length--;</span>
<a href="#l82.939"></a><span id="l82.939" class="difflineplus">+  if (length &gt; 0 &amp;&amp; line[length - 1] == '\n') length--;</span>
<a href="#l82.940"></a><span id="l82.940" class="difflineplus">+  if (length &gt; 0 &amp;&amp; line[length - 1] == '\r') length--;</span>
<a href="#l82.941"></a><span id="l82.941"> </span>
<a href="#l82.942"></a><span id="l82.942" class="difflineminus">-  if (!first_line_p)</span>
<a href="#l82.943"></a><span id="l82.943" class="difflineminus">-  {</span>
<a href="#l82.944"></a><span id="l82.944" class="difflineplus">+  if (!first_line_p) {</span>
<a href="#l82.945"></a><span id="l82.945">     /* Push out a preceding newline... */</span>
<a href="#l82.946"></a><span id="l82.946">     char nl[] = MSG_LINEBREAK;</span>
<a href="#l82.947"></a><span id="l82.947" class="difflineminus">-    status = kid-&gt;clazz-&gt;parse_buffer (nl, MSG_LINEBREAK_LEN, kid);</span>
<a href="#l82.948"></a><span id="l82.948" class="difflineplus">+    status = kid-&gt;clazz-&gt;parse_buffer(nl, MSG_LINEBREAK_LEN, kid);</span>
<a href="#l82.949"></a><span id="l82.949">     if (status &lt; 0) return status;</span>
<a href="#l82.950"></a><span id="l82.950">   }</span>
<a href="#l82.951"></a><span id="l82.951"> </span>
<a href="#l82.952"></a><span id="l82.952">   /* Now push out the line sans trailing newline. */</span>
<a href="#l82.953"></a><span id="l82.953" class="difflineminus">-  return kid-&gt;clazz-&gt;parse_buffer (line, length, kid);</span>
<a href="#l82.954"></a><span id="l82.954" class="difflineplus">+  return kid-&gt;clazz-&gt;parse_buffer(line, length, kid);</span>
<a href="#l82.955"></a><span id="l82.955"> }</span>
<a href="#l82.956"></a><span id="l82.956"> </span>
<a href="#l82.957"></a><span id="l82.957" class="difflineminus">-</span>
<a href="#l82.958"></a><span id="l82.958" class="difflineminus">-static int</span>
<a href="#l82.959"></a><span id="l82.959" class="difflineminus">-MimeMultipart_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l82.960"></a><span id="l82.960" class="difflineminus">-{</span>
<a href="#l82.961"></a><span id="l82.961" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) obj;</span>
<a href="#l82.962"></a><span id="l82.962" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) obj;</span>
<a href="#l82.963"></a><span id="l82.963" class="difflineplus">+static int MimeMultipart_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l82.964"></a><span id="l82.964" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)obj;</span>
<a href="#l82.965"></a><span id="l82.965" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l82.966"></a><span id="l82.966"> </span>
<a href="#l82.967"></a><span id="l82.967">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l82.968"></a><span id="l82.968"> </span>
<a href="#l82.969"></a><span id="l82.969">   /* Push out the last trailing line if there's one in the buffer.  If</span>
<a href="#l82.970"></a><span id="l82.970">    this happens, this object does not end in a trailing newline (and</span>
<a href="#l82.971"></a><span id="l82.971">    the parse_line method will be called with a string with no trailing</span>
<a href="#l82.972"></a><span id="l82.972">    newline, which isn't the usual case.)</span>
<a href="#l82.973"></a><span id="l82.973">    */</span>
<a href="#l82.974"></a><span id="l82.974" class="difflineminus">-  if (!abort_p &amp;&amp; obj-&gt;ibuffer_fp &gt; 0)</span>
<a href="#l82.975"></a><span id="l82.975" class="difflineminus">-  {</span>
<a href="#l82.976"></a><span id="l82.976" class="difflineplus">+  if (!abort_p &amp;&amp; obj-&gt;ibuffer_fp &gt; 0) {</span>
<a href="#l82.977"></a><span id="l82.977">     /* There is leftover data without a terminating newline. */</span>
<a href="#l82.978"></a><span id="l82.978" class="difflineminus">-    int status = obj-&gt;clazz-&gt;parse_line(obj-&gt;ibuffer, obj-&gt;ibuffer_fp,obj);</span>
<a href="#l82.979"></a><span id="l82.979" class="difflineplus">+    int status = obj-&gt;clazz-&gt;parse_line(obj-&gt;ibuffer, obj-&gt;ibuffer_fp, obj);</span>
<a href="#l82.980"></a><span id="l82.980">     obj-&gt;ibuffer_fp = 0;</span>
<a href="#l82.981"></a><span id="l82.981" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l82.982"></a><span id="l82.982" class="difflineminus">-    {</span>
<a href="#l82.983"></a><span id="l82.983" class="difflineplus">+    if (status &lt; 0) {</span>
<a href="#l82.984"></a><span id="l82.984">       obj-&gt;closed_p = true;</span>
<a href="#l82.985"></a><span id="l82.985">       return status;</span>
<a href="#l82.986"></a><span id="l82.986">     }</span>
<a href="#l82.987"></a><span id="l82.987">   }</span>
<a href="#l82.988"></a><span id="l82.988"> </span>
<a href="#l82.989"></a><span id="l82.989">   /* Now call parse_eof for our active child, if there is one.</span>
<a href="#l82.990"></a><span id="l82.990">    */</span>
<a href="#l82.991"></a><span id="l82.991" class="difflineminus">-  if (cont-&gt;nchildren &gt; 0 &amp;&amp;</span>
<a href="#l82.992"></a><span id="l82.992" class="difflineminus">-    (mult-&gt;state == MimeMultipartPartLine ||</span>
<a href="#l82.993"></a><span id="l82.993" class="difflineminus">-     mult-&gt;state == MimeMultipartPartFirstLine))</span>
<a href="#l82.994"></a><span id="l82.994" class="difflineminus">-  {</span>
<a href="#l82.995"></a><span id="l82.995" class="difflineminus">-    MimeObject *kid = cont-&gt;children[cont-&gt;nchildren-1];</span>
<a href="#l82.996"></a><span id="l82.996" class="difflineplus">+  if (cont-&gt;nchildren &gt; 0 &amp;&amp; (mult-&gt;state == MimeMultipartPartLine ||</span>
<a href="#l82.997"></a><span id="l82.997" class="difflineplus">+                              mult-&gt;state == MimeMultipartPartFirstLine)) {</span>
<a href="#l82.998"></a><span id="l82.998" class="difflineplus">+    MimeObject *kid = cont-&gt;children[cont-&gt;nchildren - 1];</span>
<a href="#l82.999"></a><span id="l82.999">     NS_ASSERTION(kid, &quot;not expecting null kid&quot;);</span>
<a href="#l82.1000"></a><span id="l82.1000" class="difflineminus">-    if (kid)</span>
<a href="#l82.1001"></a><span id="l82.1001" class="difflineminus">-    {</span>
<a href="#l82.1002"></a><span id="l82.1002" class="difflineplus">+    if (kid) {</span>
<a href="#l82.1003"></a><span id="l82.1003">       int status = kid-&gt;clazz-&gt;parse_eof(kid, abort_p);</span>
<a href="#l82.1004"></a><span id="l82.1004">       if (status &lt; 0) return status;</span>
<a href="#l82.1005"></a><span id="l82.1005">     }</span>
<a href="#l82.1006"></a><span id="l82.1006">   }</span>
<a href="#l82.1007"></a><span id="l82.1007"> </span>
<a href="#l82.1008"></a><span id="l82.1008" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l82.1009"></a><span id="l82.1009" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l82.1010"></a><span id="l82.1010"> }</span>
<a href="#l82.1011"></a><span id="l82.1011"> </span>
<a href="#l82.1012"></a><span id="l82.1012" class="difflineminus">-</span>
<a href="#l82.1013"></a><span id="l82.1013"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l82.1014"></a><span id="l82.1014" class="difflineminus">-static int</span>
<a href="#l82.1015"></a><span id="l82.1015" class="difflineminus">-MimeMultipart_debug_print (MimeObject *obj, PRFileDesc *stream, int32_t depth)</span>
<a href="#l82.1016"></a><span id="l82.1016" class="difflineminus">-{</span>
<a href="#l82.1017"></a><span id="l82.1017" class="difflineplus">+static int MimeMultipart_debug_print(MimeObject *obj, PRFileDesc *stream,</span>
<a href="#l82.1018"></a><span id="l82.1018" class="difflineplus">+                                     int32_t depth) {</span>
<a href="#l82.1019"></a><span id="l82.1019">   /*  MimeMultipart *mult = (MimeMultipart *) obj; */</span>
<a href="#l82.1020"></a><span id="l82.1020" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) obj;</span>
<a href="#l82.1021"></a><span id="l82.1021" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l82.1022"></a><span id="l82.1022">   char *addr = mime_part_address(obj);</span>
<a href="#l82.1023"></a><span id="l82.1023">   int i;</span>
<a href="#l82.1024"></a><span id="l82.1024" class="difflineminus">-  for (i=0; i &lt; depth; i++)</span>
<a href="#l82.1025"></a><span id="l82.1025" class="difflineminus">-  PR_Write(stream, &quot;  &quot;, 2);</span>
<a href="#l82.1026"></a><span id="l82.1026" class="difflineminus">-/**</span>
<a href="#l82.1027"></a><span id="l82.1027" class="difflineminus">-  fprintf(stream, &quot;&lt;%s %s (%d kid%s) boundary=%s 0x%08X&gt;\n&quot;,</span>
<a href="#l82.1028"></a><span id="l82.1028" class="difflineminus">-      obj-&gt;clazz-&gt;class_name,</span>
<a href="#l82.1029"></a><span id="l82.1029" class="difflineminus">-      addr ? addr : &quot;???&quot;,</span>
<a href="#l82.1030"></a><span id="l82.1030" class="difflineminus">-      cont-&gt;nchildren, (cont-&gt;nchildren == 1 ? &quot;&quot; : &quot;s&quot;),</span>
<a href="#l82.1031"></a><span id="l82.1031" class="difflineminus">-      (mult-&gt;boundary ? mult-&gt;boundary : &quot;(none)&quot;),</span>
<a href="#l82.1032"></a><span id="l82.1032" class="difflineminus">-      (uint32_t) mult);</span>
<a href="#l82.1033"></a><span id="l82.1033" class="difflineminus">-**/</span>
<a href="#l82.1034"></a><span id="l82.1034" class="difflineplus">+  for (i = 0; i &lt; depth; i++) PR_Write(stream, &quot;  &quot;, 2);</span>
<a href="#l82.1035"></a><span id="l82.1035" class="difflineplus">+  /**</span>
<a href="#l82.1036"></a><span id="l82.1036" class="difflineplus">+    fprintf(stream, &quot;&lt;%s %s (%d kid%s) boundary=%s 0x%08X&gt;\n&quot;,</span>
<a href="#l82.1037"></a><span id="l82.1037" class="difflineplus">+        obj-&gt;clazz-&gt;class_name,</span>
<a href="#l82.1038"></a><span id="l82.1038" class="difflineplus">+        addr ? addr : &quot;???&quot;,</span>
<a href="#l82.1039"></a><span id="l82.1039" class="difflineplus">+        cont-&gt;nchildren, (cont-&gt;nchildren == 1 ? &quot;&quot; : &quot;s&quot;),</span>
<a href="#l82.1040"></a><span id="l82.1040" class="difflineplus">+        (mult-&gt;boundary ? mult-&gt;boundary : &quot;(none)&quot;),</span>
<a href="#l82.1041"></a><span id="l82.1041" class="difflineplus">+        (uint32_t) mult);</span>
<a href="#l82.1042"></a><span id="l82.1042" class="difflineplus">+  **/</span>
<a href="#l82.1043"></a><span id="l82.1043">   PR_FREEIF(addr);</span>
<a href="#l82.1044"></a><span id="l82.1044"> </span>
<a href="#l82.1045"></a><span id="l82.1045" class="difflineminus">-/*</span>
<a href="#l82.1046"></a><span id="l82.1046" class="difflineminus">-  if (cont-&gt;nchildren &gt; 0)</span>
<a href="#l82.1047"></a><span id="l82.1047" class="difflineminus">-  fprintf(stream, &quot;\n&quot;);</span>
<a href="#l82.1048"></a><span id="l82.1048" class="difflineminus">- */</span>
<a href="#l82.1049"></a><span id="l82.1049" class="difflineplus">+  /*</span>
<a href="#l82.1050"></a><span id="l82.1050" class="difflineplus">+    if (cont-&gt;nchildren &gt; 0)</span>
<a href="#l82.1051"></a><span id="l82.1051" class="difflineplus">+    fprintf(stream, &quot;\n&quot;);</span>
<a href="#l82.1052"></a><span id="l82.1052" class="difflineplus">+   */</span>
<a href="#l82.1053"></a><span id="l82.1053"> </span>
<a href="#l82.1054"></a><span id="l82.1054" class="difflineminus">-  for (i = 0; i &lt; cont-&gt;nchildren; i++)</span>
<a href="#l82.1055"></a><span id="l82.1055" class="difflineminus">-  {</span>
<a href="#l82.1056"></a><span id="l82.1056" class="difflineplus">+  for (i = 0; i &lt; cont-&gt;nchildren; i++) {</span>
<a href="#l82.1057"></a><span id="l82.1057">     MimeObject *kid = cont-&gt;children[i];</span>
<a href="#l82.1058"></a><span id="l82.1058" class="difflineminus">-    int status = kid-&gt;clazz-&gt;debug_print (kid, stream, depth+1);</span>
<a href="#l82.1059"></a><span id="l82.1059" class="difflineplus">+    int status = kid-&gt;clazz-&gt;debug_print(kid, stream, depth + 1);</span>
<a href="#l82.1060"></a><span id="l82.1060">     if (status &lt; 0) return status;</span>
<a href="#l82.1061"></a><span id="l82.1061">   }</span>
<a href="#l82.1062"></a><span id="l82.1062"> </span>
<a href="#l82.1063"></a><span id="l82.1063" class="difflineminus">-/*</span>
<a href="#l82.1064"></a><span id="l82.1064" class="difflineminus">-  if (cont-&gt;nchildren &gt; 0)</span>
<a href="#l82.1065"></a><span id="l82.1065" class="difflineminus">-  fprintf(stream, &quot;\n&quot;);</span>
<a href="#l82.1066"></a><span id="l82.1066" class="difflineminus">- */</span>
<a href="#l82.1067"></a><span id="l82.1067" class="difflineplus">+  /*</span>
<a href="#l82.1068"></a><span id="l82.1068" class="difflineplus">+    if (cont-&gt;nchildren &gt; 0)</span>
<a href="#l82.1069"></a><span id="l82.1069" class="difflineplus">+    fprintf(stream, &quot;\n&quot;);</span>
<a href="#l82.1070"></a><span id="l82.1070" class="difflineplus">+   */</span>
<a href="#l82.1071"></a><span id="l82.1071"> </span>
<a href="#l82.1072"></a><span id="l82.1072">   return 0;</span>
<a href="#l82.1073"></a><span id="l82.1073"> }</span>
<a href="#l82.1074"></a><span id="l82.1074"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/mailnews/mime/src/mimemult.h</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/mailnews/mime/src/mimemult.h</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -49,54 +49,53 @@</span>
<a href="#l83.4"></a><span id="l83.4">    const char *default_part_type</span>
<a href="#l83.5"></a><span id="l83.5"> </span>
<a href="#l83.6"></a><span id="l83.6">      This is the type which should be assumed for sub-parts which have</span>
<a href="#l83.7"></a><span id="l83.7">      no explicit type specified.  The default is &quot;text/plain&quot;, but the</span>
<a href="#l83.8"></a><span id="l83.8">      &quot;multipart/digest&quot; subclass overrides this to &quot;message/rfc822&quot;.</span>
<a href="#l83.9"></a><span id="l83.9">  */</span>
<a href="#l83.10"></a><span id="l83.10"> </span>
<a href="#l83.11"></a><span id="l83.11"> typedef struct MimeMultipartClass MimeMultipartClass;</span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-typedef struct MimeMultipart      MimeMultipart;</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+typedef struct MimeMultipart MimeMultipart;</span>
<a href="#l83.14"></a><span id="l83.14"> </span>
<a href="#l83.15"></a><span id="l83.15"> typedef enum {</span>
<a href="#l83.16"></a><span id="l83.16">   MimeMultipartPreamble,</span>
<a href="#l83.17"></a><span id="l83.17">   MimeMultipartHeaders,</span>
<a href="#l83.18"></a><span id="l83.18">   MimeMultipartPartFirstLine,</span>
<a href="#l83.19"></a><span id="l83.19">   MimeMultipartPartLine,</span>
<a href="#l83.20"></a><span id="l83.20">   MimeMultipartEpilogue</span>
<a href="#l83.21"></a><span id="l83.21"> } MimeMultipartParseState;</span>
<a href="#l83.22"></a><span id="l83.22"> </span>
<a href="#l83.23"></a><span id="l83.23"> typedef enum {</span>
<a href="#l83.24"></a><span id="l83.24">   MimeMultipartBoundaryTypeNone,</span>
<a href="#l83.25"></a><span id="l83.25">   MimeMultipartBoundaryTypeSeparator,</span>
<a href="#l83.26"></a><span id="l83.26">   MimeMultipartBoundaryTypeTerminator</span>
<a href="#l83.27"></a><span id="l83.27"> } MimeMultipartBoundaryType;</span>
<a href="#l83.28"></a><span id="l83.28"> </span>
<a href="#l83.29"></a><span id="l83.29" class="difflineminus">-</span>
<a href="#l83.30"></a><span id="l83.30"> struct MimeMultipartClass {</span>
<a href="#l83.31"></a><span id="l83.31">   MimeContainerClass container;</span>
<a href="#l83.32"></a><span id="l83.32">   const char *default_part_type;</span>
<a href="#l83.33"></a><span id="l83.33"> </span>
<a href="#l83.34"></a><span id="l83.34" class="difflineminus">-  int (*create_child) (MimeObject *);</span>
<a href="#l83.35"></a><span id="l83.35" class="difflineminus">-  bool (*output_child_p) (MimeObject *self, MimeObject *child);</span>
<a href="#l83.36"></a><span id="l83.36" class="difflineminus">-  int (*close_child) (MimeObject *);</span>
<a href="#l83.37"></a><span id="l83.37" class="difflineminus">-  int (*parse_child_line) (MimeObject *, const char *line, int32_t length,</span>
<a href="#l83.38"></a><span id="l83.38" class="difflineminus">-               bool first_line_p);</span>
<a href="#l83.39"></a><span id="l83.39" class="difflineminus">-  MimeMultipartBoundaryType (*check_boundary) (MimeObject *, const char *line,</span>
<a href="#l83.40"></a><span id="l83.40" class="difflineminus">-                         int32_t length);</span>
<a href="#l83.41"></a><span id="l83.41" class="difflineplus">+  int (*create_child)(MimeObject *);</span>
<a href="#l83.42"></a><span id="l83.42" class="difflineplus">+  bool (*output_child_p)(MimeObject *self, MimeObject *child);</span>
<a href="#l83.43"></a><span id="l83.43" class="difflineplus">+  int (*close_child)(MimeObject *);</span>
<a href="#l83.44"></a><span id="l83.44" class="difflineplus">+  int (*parse_child_line)(MimeObject *, const char *line, int32_t length,</span>
<a href="#l83.45"></a><span id="l83.45" class="difflineplus">+                          bool first_line_p);</span>
<a href="#l83.46"></a><span id="l83.46" class="difflineplus">+  MimeMultipartBoundaryType (*check_boundary)(MimeObject *, const char *line,</span>
<a href="#l83.47"></a><span id="l83.47" class="difflineplus">+                                              int32_t length);</span>
<a href="#l83.48"></a><span id="l83.48"> };</span>
<a href="#l83.49"></a><span id="l83.49"> </span>
<a href="#l83.50"></a><span id="l83.50"> extern MimeMultipartClass mimeMultipartClass;</span>
<a href="#l83.51"></a><span id="l83.51"> </span>
<a href="#l83.52"></a><span id="l83.52"> struct MimeMultipart {</span>
<a href="#l83.53"></a><span id="l83.53" class="difflineminus">-  MimeContainer container;      /* superclass variables */</span>
<a href="#l83.54"></a><span id="l83.54" class="difflineminus">-  char *boundary;          /* Inter-part delimiter string */</span>
<a href="#l83.55"></a><span id="l83.55" class="difflineminus">-  MimeHeaders *hdrs;        /* headers of the part currently</span>
<a href="#l83.56"></a><span id="l83.56" class="difflineminus">-                     being parsed, if any */</span>
<a href="#l83.57"></a><span id="l83.57" class="difflineminus">-  MimeMultipartParseState state;  /* State of parser */</span>
<a href="#l83.58"></a><span id="l83.58" class="difflineplus">+  MimeContainer container;       /* superclass variables */</span>
<a href="#l83.59"></a><span id="l83.59" class="difflineplus">+  char *boundary;                /* Inter-part delimiter string */</span>
<a href="#l83.60"></a><span id="l83.60" class="difflineplus">+  MimeHeaders *hdrs;             /* headers of the part currently</span>
<a href="#l83.61"></a><span id="l83.61" class="difflineplus">+                          being parsed, if any */</span>
<a href="#l83.62"></a><span id="l83.62" class="difflineplus">+  MimeMultipartParseState state; /* State of parser */</span>
<a href="#l83.63"></a><span id="l83.63"> };</span>
<a href="#l83.64"></a><span id="l83.64"> </span>
<a href="#l83.65"></a><span id="l83.65"> extern void MimeMultipart_notify_emitter(MimeObject *);</span>
<a href="#l83.66"></a><span id="l83.66"> </span>
<a href="#l83.67"></a><span id="l83.67" class="difflineminus">-#define MimeMultipartClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l83.68"></a><span id="l83.68" class="difflineminus">-  { MimeContainerClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l83.69"></a><span id="l83.69" class="difflineplus">+#define MimeMultipartClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l83.70"></a><span id="l83.70" class="difflineplus">+  { MimeContainerClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l83.71"></a><span id="l83.71"> </span>
<a href="#l83.72"></a><span id="l83.72"> #endif /* _MIMEMULT_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/mailnews/mime/src/mimeobj.cpp</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/mailnews/mime/src/mimeobj.cpp</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l84.4"></a><span id="l84.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l84.5"></a><span id="l84.5">  *</span>
<a href="#l84.6"></a><span id="l84.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l84.7"></a><span id="l84.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l84.8"></a><span id="l84.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l84.9"></a><span id="l84.9" class="difflineminus">- * This Original Code has been modified by IBM Corporation. Modifications made by IBM</span>
<a href="#l84.10"></a><span id="l84.10" class="difflineminus">- * described herein are Copyright (c) International Business Machines Corporation, 2000.</span>
<a href="#l84.11"></a><span id="l84.11" class="difflineminus">- * Modifications to Mozilla code or documentation identified per MPL Section 3.3</span>
<a href="#l84.12"></a><span id="l84.12" class="difflineplus">+ * This Original Code has been modified by IBM Corporation. Modifications made</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+ * by IBM described herein are Copyright (c) International Business Machines</span>
<a href="#l84.14"></a><span id="l84.14" class="difflineplus">+ * Corporation, 2000. Modifications to Mozilla code or documentation identified</span>
<a href="#l84.15"></a><span id="l84.15" class="difflineplus">+ * per MPL Section 3.3</span>
<a href="#l84.16"></a><span id="l84.16">  *</span>
<a href="#l84.17"></a><span id="l84.17">  * Date             Modified by     Description of modification</span>
<a href="#l84.18"></a><span id="l84.18">  * 04/20/2000       IBM Corp.      OS/2 VisualAge build.</span>
<a href="#l84.19"></a><span id="l84.19">  */</span>
<a href="#l84.20"></a><span id="l84.20"> </span>
<a href="#l84.21"></a><span id="l84.21"> #include &quot;mimeobj.h&quot;</span>
<a href="#l84.22"></a><span id="l84.22"> #include &quot;prmem.h&quot;</span>
<a href="#l84.23"></a><span id="l84.23"> #include &quot;plstr.h&quot;</span>
<a href="#l84.24"></a><span id="l84.24" class="difflineat">@@ -19,309 +20,278 @@</span>
<a href="#l84.25"></a><span id="l84.25"> #include &quot;prlog.h&quot;</span>
<a href="#l84.26"></a><span id="l84.26"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l84.27"></a><span id="l84.27"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l84.28"></a><span id="l84.28"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l84.29"></a><span id="l84.29"> #include &quot;mimemsg.h&quot;</span>
<a href="#l84.30"></a><span id="l84.30"> #include &quot;mimemapl.h&quot;</span>
<a href="#l84.31"></a><span id="l84.31"> </span>
<a href="#l84.32"></a><span id="l84.32"> /* Way to destroy any notions of modularity or class hierarchy, Terry! */</span>
<a href="#l84.33"></a><span id="l84.33" class="difflineminus">-# include &quot;mimetpla.h&quot;</span>
<a href="#l84.34"></a><span id="l84.34" class="difflineminus">-# include &quot;mimethtm.h&quot;</span>
<a href="#l84.35"></a><span id="l84.35" class="difflineminus">-# include &quot;mimecont.h&quot;</span>
<a href="#l84.36"></a><span id="l84.36" class="difflineplus">+#include &quot;mimetpla.h&quot;</span>
<a href="#l84.37"></a><span id="l84.37" class="difflineplus">+#include &quot;mimethtm.h&quot;</span>
<a href="#l84.38"></a><span id="l84.38" class="difflineplus">+#include &quot;mimecont.h&quot;</span>
<a href="#l84.39"></a><span id="l84.39"> </span>
<a href="#l84.40"></a><span id="l84.40" class="difflineminus">-MimeDefClass (MimeObject, MimeObjectClass, mimeObjectClass, NULL);</span>
<a href="#l84.41"></a><span id="l84.41" class="difflineplus">+MimeDefClass(MimeObject, MimeObjectClass, mimeObjectClass, NULL);</span>
<a href="#l84.42"></a><span id="l84.42"> </span>
<a href="#l84.43"></a><span id="l84.43" class="difflineminus">-static int MimeObject_initialize (MimeObject *);</span>
<a href="#l84.44"></a><span id="l84.44" class="difflineminus">-static void MimeObject_finalize (MimeObject *);</span>
<a href="#l84.45"></a><span id="l84.45" class="difflineminus">-static int MimeObject_parse_begin (MimeObject *);</span>
<a href="#l84.46"></a><span id="l84.46" class="difflineminus">-static int MimeObject_parse_buffer (const char *, int32_t, MimeObject *);</span>
<a href="#l84.47"></a><span id="l84.47" class="difflineminus">-static int MimeObject_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l84.48"></a><span id="l84.48" class="difflineminus">-static int MimeObject_parse_eof (MimeObject *, bool);</span>
<a href="#l84.49"></a><span id="l84.49" class="difflineminus">-static int MimeObject_parse_end (MimeObject *, bool);</span>
<a href="#l84.50"></a><span id="l84.50" class="difflineminus">-static bool MimeObject_displayable_inline_p (MimeObjectClass *clazz,</span>
<a href="#l84.51"></a><span id="l84.51" class="difflineminus">-                        MimeHeaders *hdrs);</span>
<a href="#l84.52"></a><span id="l84.52" class="difflineplus">+static int MimeObject_initialize(MimeObject *);</span>
<a href="#l84.53"></a><span id="l84.53" class="difflineplus">+static void MimeObject_finalize(MimeObject *);</span>
<a href="#l84.54"></a><span id="l84.54" class="difflineplus">+static int MimeObject_parse_begin(MimeObject *);</span>
<a href="#l84.55"></a><span id="l84.55" class="difflineplus">+static int MimeObject_parse_buffer(const char *, int32_t, MimeObject *);</span>
<a href="#l84.56"></a><span id="l84.56" class="difflineplus">+static int MimeObject_parse_line(const char *, int32_t, MimeObject *);</span>
<a href="#l84.57"></a><span id="l84.57" class="difflineplus">+static int MimeObject_parse_eof(MimeObject *, bool);</span>
<a href="#l84.58"></a><span id="l84.58" class="difflineplus">+static int MimeObject_parse_end(MimeObject *, bool);</span>
<a href="#l84.59"></a><span id="l84.59" class="difflineplus">+static bool MimeObject_displayable_inline_p(MimeObjectClass *clazz,</span>
<a href="#l84.60"></a><span id="l84.60" class="difflineplus">+                                            MimeHeaders *hdrs);</span>
<a href="#l84.61"></a><span id="l84.61"> </span>
<a href="#l84.62"></a><span id="l84.62"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l84.63"></a><span id="l84.63" class="difflineminus">-static int MimeObject_debug_print (MimeObject *, PRFileDesc *, int32_t depth);</span>
<a href="#l84.64"></a><span id="l84.64" class="difflineplus">+static int MimeObject_debug_print(MimeObject *, PRFileDesc *, int32_t depth);</span>
<a href="#l84.65"></a><span id="l84.65"> #endif</span>
<a href="#l84.66"></a><span id="l84.66"> </span>
<a href="#l84.67"></a><span id="l84.67" class="difflineminus">-static int</span>
<a href="#l84.68"></a><span id="l84.68" class="difflineminus">-MimeObjectClassInitialize(MimeObjectClass *clazz)</span>
<a href="#l84.69"></a><span id="l84.69" class="difflineminus">-{</span>
<a href="#l84.70"></a><span id="l84.70" class="difflineminus">-  NS_ASSERTION(!clazz-&gt;class_initialized, &quot;class shouldn't already be initialized&quot;);</span>
<a href="#l84.71"></a><span id="l84.71" class="difflineminus">-  clazz-&gt;initialize   = MimeObject_initialize;</span>
<a href="#l84.72"></a><span id="l84.72" class="difflineminus">-  clazz-&gt;finalize     = MimeObject_finalize;</span>
<a href="#l84.73"></a><span id="l84.73" class="difflineminus">-  clazz-&gt;parse_begin  = MimeObject_parse_begin;</span>
<a href="#l84.74"></a><span id="l84.74" class="difflineplus">+static int MimeObjectClassInitialize(MimeObjectClass *clazz) {</span>
<a href="#l84.75"></a><span id="l84.75" class="difflineplus">+  NS_ASSERTION(!clazz-&gt;class_initialized,</span>
<a href="#l84.76"></a><span id="l84.76" class="difflineplus">+               &quot;class shouldn't already be initialized&quot;);</span>
<a href="#l84.77"></a><span id="l84.77" class="difflineplus">+  clazz-&gt;initialize = MimeObject_initialize;</span>
<a href="#l84.78"></a><span id="l84.78" class="difflineplus">+  clazz-&gt;finalize = MimeObject_finalize;</span>
<a href="#l84.79"></a><span id="l84.79" class="difflineplus">+  clazz-&gt;parse_begin = MimeObject_parse_begin;</span>
<a href="#l84.80"></a><span id="l84.80">   clazz-&gt;parse_buffer = MimeObject_parse_buffer;</span>
<a href="#l84.81"></a><span id="l84.81" class="difflineminus">-  clazz-&gt;parse_line   = MimeObject_parse_line;</span>
<a href="#l84.82"></a><span id="l84.82" class="difflineminus">-  clazz-&gt;parse_eof    = MimeObject_parse_eof;</span>
<a href="#l84.83"></a><span id="l84.83" class="difflineminus">-  clazz-&gt;parse_end    = MimeObject_parse_end;</span>
<a href="#l84.84"></a><span id="l84.84" class="difflineplus">+  clazz-&gt;parse_line = MimeObject_parse_line;</span>
<a href="#l84.85"></a><span id="l84.85" class="difflineplus">+  clazz-&gt;parse_eof = MimeObject_parse_eof;</span>
<a href="#l84.86"></a><span id="l84.86" class="difflineplus">+  clazz-&gt;parse_end = MimeObject_parse_end;</span>
<a href="#l84.87"></a><span id="l84.87">   clazz-&gt;displayable_inline_p = MimeObject_displayable_inline_p;</span>
<a href="#l84.88"></a><span id="l84.88"> </span>
<a href="#l84.89"></a><span id="l84.89"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l84.90"></a><span id="l84.90" class="difflineminus">-  clazz-&gt;debug_print  = MimeObject_debug_print;</span>
<a href="#l84.91"></a><span id="l84.91" class="difflineplus">+  clazz-&gt;debug_print = MimeObject_debug_print;</span>
<a href="#l84.92"></a><span id="l84.92"> #endif</span>
<a href="#l84.93"></a><span id="l84.93">   return 0;</span>
<a href="#l84.94"></a><span id="l84.94"> }</span>
<a href="#l84.95"></a><span id="l84.95"> </span>
<a href="#l84.96"></a><span id="l84.96" class="difflineminus">-static int</span>
<a href="#l84.97"></a><span id="l84.97" class="difflineminus">-MimeObject_initialize (MimeObject *obj)</span>
<a href="#l84.98"></a><span id="l84.98" class="difflineminus">-{</span>
<a href="#l84.99"></a><span id="l84.99" class="difflineplus">+static int MimeObject_initialize(MimeObject *obj) {</span>
<a href="#l84.100"></a><span id="l84.100">   /* This is an abstract class; it shouldn't be directly instantiated. */</span>
<a href="#l84.101"></a><span id="l84.101" class="difflineminus">-  NS_ASSERTION(obj-&gt;clazz != &amp;mimeObjectClass, &quot;should directly instantiate abstract class&quot;);</span>
<a href="#l84.102"></a><span id="l84.102" class="difflineplus">+  NS_ASSERTION(obj-&gt;clazz != &amp;mimeObjectClass,</span>
<a href="#l84.103"></a><span id="l84.103" class="difflineplus">+               &quot;should directly instantiate abstract class&quot;);</span>
<a href="#l84.104"></a><span id="l84.104"> </span>
<a href="#l84.105"></a><span id="l84.105">   /* Set up the content-type and encoding. */</span>
<a href="#l84.106"></a><span id="l84.106">   if (!obj-&gt;content_type &amp;&amp; obj-&gt;headers)</span>
<a href="#l84.107"></a><span id="l84.107" class="difflineminus">-  obj-&gt;content_type = MimeHeaders_get (obj-&gt;headers, HEADER_CONTENT_TYPE,</span>
<a href="#l84.108"></a><span id="l84.108" class="difflineminus">-                     true, false);</span>
<a href="#l84.109"></a><span id="l84.109" class="difflineplus">+    obj-&gt;content_type =</span>
<a href="#l84.110"></a><span id="l84.110" class="difflineplus">+        MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, true, false);</span>
<a href="#l84.111"></a><span id="l84.111">   if (!obj-&gt;encoding &amp;&amp; obj-&gt;headers)</span>
<a href="#l84.112"></a><span id="l84.112" class="difflineminus">-  obj-&gt;encoding = MimeHeaders_get (obj-&gt;headers,</span>
<a href="#l84.113"></a><span id="l84.113" class="difflineminus">-                   HEADER_CONTENT_TRANSFER_ENCODING,</span>
<a href="#l84.114"></a><span id="l84.114" class="difflineminus">-                   true, false);</span>
<a href="#l84.115"></a><span id="l84.115" class="difflineplus">+    obj-&gt;encoding = MimeHeaders_get(</span>
<a href="#l84.116"></a><span id="l84.116" class="difflineplus">+        obj-&gt;headers, HEADER_CONTENT_TRANSFER_ENCODING, true, false);</span>
<a href="#l84.117"></a><span id="l84.117"> </span>
<a href="#l84.118"></a><span id="l84.118">   /* Special case to normalize some types and encodings to a canonical form.</span>
<a href="#l84.119"></a><span id="l84.119">    (These are nonstandard types/encodings which have been seen to appear in</span>
<a href="#l84.120"></a><span id="l84.120">    multiple forms; we normalize them so that things like looking up icons</span>
<a href="#l84.121"></a><span id="l84.121">    and extensions has consistent behavior for the receiver, regardless of</span>
<a href="#l84.122"></a><span id="l84.122">    the &quot;alias&quot; type that the sender used.)</span>
<a href="#l84.123"></a><span id="l84.123">    */</span>
<a href="#l84.124"></a><span id="l84.124">   if (!obj-&gt;content_type || !*(obj-&gt;content_type))</span>
<a href="#l84.125"></a><span id="l84.125" class="difflineminus">-  ;</span>
<a href="#l84.126"></a><span id="l84.126" class="difflineplus">+    ;</span>
<a href="#l84.127"></a><span id="l84.127">   else if (!PL_strcasecmp(obj-&gt;content_type, APPLICATION_UUENCODE2) ||</span>
<a href="#l84.128"></a><span id="l84.128" class="difflineminus">-       !PL_strcasecmp(obj-&gt;content_type, APPLICATION_UUENCODE3) ||</span>
<a href="#l84.129"></a><span id="l84.129" class="difflineminus">-       !PL_strcasecmp(obj-&gt;content_type, APPLICATION_UUENCODE4))</span>
<a href="#l84.130"></a><span id="l84.130" class="difflineminus">-  {</span>
<a href="#l84.131"></a><span id="l84.131" class="difflineplus">+           !PL_strcasecmp(obj-&gt;content_type, APPLICATION_UUENCODE3) ||</span>
<a href="#l84.132"></a><span id="l84.132" class="difflineplus">+           !PL_strcasecmp(obj-&gt;content_type, APPLICATION_UUENCODE4)) {</span>
<a href="#l84.133"></a><span id="l84.133">     PR_Free(obj-&gt;content_type);</span>
<a href="#l84.134"></a><span id="l84.134">     obj-&gt;content_type = strdup(APPLICATION_UUENCODE);</span>
<a href="#l84.135"></a><span id="l84.135" class="difflineminus">-  }</span>
<a href="#l84.136"></a><span id="l84.136" class="difflineminus">-  else if (!PL_strcasecmp(obj-&gt;content_type, IMAGE_XBM2) ||</span>
<a href="#l84.137"></a><span id="l84.137" class="difflineminus">-       !PL_strcasecmp(obj-&gt;content_type, IMAGE_XBM3))</span>
<a href="#l84.138"></a><span id="l84.138" class="difflineminus">-  {</span>
<a href="#l84.139"></a><span id="l84.139" class="difflineplus">+  } else if (!PL_strcasecmp(obj-&gt;content_type, IMAGE_XBM2) ||</span>
<a href="#l84.140"></a><span id="l84.140" class="difflineplus">+             !PL_strcasecmp(obj-&gt;content_type, IMAGE_XBM3)) {</span>
<a href="#l84.141"></a><span id="l84.141">     PR_Free(obj-&gt;content_type);</span>
<a href="#l84.142"></a><span id="l84.142">     obj-&gt;content_type = strdup(IMAGE_XBM);</span>
<a href="#l84.143"></a><span id="l84.143" class="difflineminus">-  }</span>
<a href="#l84.144"></a><span id="l84.144" class="difflineminus">-  else {</span>
<a href="#l84.145"></a><span id="l84.145" class="difflineplus">+  } else {</span>
<a href="#l84.146"></a><span id="l84.146">     // MIME-types are case-insenitive, but let's make it lower case internally</span>
<a href="#l84.147"></a><span id="l84.147">     // to avoid some hassle later down the road.</span>
<a href="#l84.148"></a><span id="l84.148">     nsAutoCString lowerCaseContentType;</span>
<a href="#l84.149"></a><span id="l84.149">     ToLowerCase(nsDependentCString(obj-&gt;content_type), lowerCaseContentType);</span>
<a href="#l84.150"></a><span id="l84.150">     PR_Free(obj-&gt;content_type);</span>
<a href="#l84.151"></a><span id="l84.151">     obj-&gt;content_type = ToNewCString(lowerCaseContentType);</span>
<a href="#l84.152"></a><span id="l84.152">   }</span>
<a href="#l84.153"></a><span id="l84.153"> </span>
<a href="#l84.154"></a><span id="l84.154">   if (!obj-&gt;encoding)</span>
<a href="#l84.155"></a><span id="l84.155" class="difflineminus">-  ;</span>
<a href="#l84.156"></a><span id="l84.156" class="difflineplus">+    ;</span>
<a href="#l84.157"></a><span id="l84.157">   else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE2) ||</span>
<a href="#l84.158"></a><span id="l84.158" class="difflineminus">-       !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE3) ||</span>
<a href="#l84.159"></a><span id="l84.159" class="difflineminus">-       !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE4))</span>
<a href="#l84.160"></a><span id="l84.160" class="difflineminus">-  {</span>
<a href="#l84.161"></a><span id="l84.161" class="difflineplus">+           !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE3) ||</span>
<a href="#l84.162"></a><span id="l84.162" class="difflineplus">+           !PL_strcasecmp(obj-&gt;encoding, ENCODING_UUENCODE4)) {</span>
<a href="#l84.163"></a><span id="l84.163">     PR_Free(obj-&gt;encoding);</span>
<a href="#l84.164"></a><span id="l84.164">     obj-&gt;encoding = strdup(ENCODING_UUENCODE);</span>
<a href="#l84.165"></a><span id="l84.165" class="difflineminus">-  }</span>
<a href="#l84.166"></a><span id="l84.166" class="difflineminus">-  else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_COMPRESS2))</span>
<a href="#l84.167"></a><span id="l84.167" class="difflineminus">-  {</span>
<a href="#l84.168"></a><span id="l84.168" class="difflineplus">+  } else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_COMPRESS2)) {</span>
<a href="#l84.169"></a><span id="l84.169">     PR_Free(obj-&gt;encoding);</span>
<a href="#l84.170"></a><span id="l84.170">     obj-&gt;encoding = strdup(ENCODING_COMPRESS);</span>
<a href="#l84.171"></a><span id="l84.171" class="difflineminus">-  }</span>
<a href="#l84.172"></a><span id="l84.172" class="difflineminus">-  else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_GZIP2))</span>
<a href="#l84.173"></a><span id="l84.173" class="difflineminus">-  {</span>
<a href="#l84.174"></a><span id="l84.174" class="difflineplus">+  } else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_GZIP2)) {</span>
<a href="#l84.175"></a><span id="l84.175">     PR_Free(obj-&gt;encoding);</span>
<a href="#l84.176"></a><span id="l84.176">     obj-&gt;encoding = strdup(ENCODING_GZIP);</span>
<a href="#l84.177"></a><span id="l84.177">   }</span>
<a href="#l84.178"></a><span id="l84.178"> </span>
<a href="#l84.179"></a><span id="l84.179">   return 0;</span>
<a href="#l84.180"></a><span id="l84.180"> }</span>
<a href="#l84.181"></a><span id="l84.181"> </span>
<a href="#l84.182"></a><span id="l84.182" class="difflineminus">-static void</span>
<a href="#l84.183"></a><span id="l84.183" class="difflineminus">-MimeObject_finalize (MimeObject *obj)</span>
<a href="#l84.184"></a><span id="l84.184" class="difflineminus">-{</span>
<a href="#l84.185"></a><span id="l84.185" class="difflineminus">-  obj-&gt;clazz-&gt;parse_eof (obj, false);</span>
<a href="#l84.186"></a><span id="l84.186" class="difflineminus">-  obj-&gt;clazz-&gt;parse_end (obj, false);</span>
<a href="#l84.187"></a><span id="l84.187" class="difflineplus">+static void MimeObject_finalize(MimeObject *obj) {</span>
<a href="#l84.188"></a><span id="l84.188" class="difflineplus">+  obj-&gt;clazz-&gt;parse_eof(obj, false);</span>
<a href="#l84.189"></a><span id="l84.189" class="difflineplus">+  obj-&gt;clazz-&gt;parse_end(obj, false);</span>
<a href="#l84.190"></a><span id="l84.190"> </span>
<a href="#l84.191"></a><span id="l84.191" class="difflineminus">-  if (obj-&gt;headers)</span>
<a href="#l84.192"></a><span id="l84.192" class="difflineminus">-  {</span>
<a href="#l84.193"></a><span id="l84.193" class="difflineplus">+  if (obj-&gt;headers) {</span>
<a href="#l84.194"></a><span id="l84.194">     MimeHeaders_free(obj-&gt;headers);</span>
<a href="#l84.195"></a><span id="l84.195">     obj-&gt;headers = 0;</span>
<a href="#l84.196"></a><span id="l84.196">   }</span>
<a href="#l84.197"></a><span id="l84.197"> </span>
<a href="#l84.198"></a><span id="l84.198">   /* Should have been freed by parse_eof, but just in case... */</span>
<a href="#l84.199"></a><span id="l84.199">   NS_ASSERTION(!obj-&gt;ibuffer, &quot;buffer not freed&quot;);</span>
<a href="#l84.200"></a><span id="l84.200">   NS_ASSERTION(!obj-&gt;obuffer, &quot;buffer not freed&quot;);</span>
<a href="#l84.201"></a><span id="l84.201" class="difflineminus">-  PR_FREEIF (obj-&gt;ibuffer);</span>
<a href="#l84.202"></a><span id="l84.202" class="difflineminus">-  PR_FREEIF (obj-&gt;obuffer);</span>
<a href="#l84.203"></a><span id="l84.203" class="difflineplus">+  PR_FREEIF(obj-&gt;ibuffer);</span>
<a href="#l84.204"></a><span id="l84.204" class="difflineplus">+  PR_FREEIF(obj-&gt;obuffer);</span>
<a href="#l84.205"></a><span id="l84.205"> </span>
<a href="#l84.206"></a><span id="l84.206">   PR_FREEIF(obj-&gt;content_type);</span>
<a href="#l84.207"></a><span id="l84.207">   PR_FREEIF(obj-&gt;encoding);</span>
<a href="#l84.208"></a><span id="l84.208"> </span>
<a href="#l84.209"></a><span id="l84.209" class="difflineminus">-  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state)</span>
<a href="#l84.210"></a><span id="l84.210" class="difflineminus">-  {</span>
<a href="#l84.211"></a><span id="l84.211" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state) {</span>
<a href="#l84.212"></a><span id="l84.212">     delete obj-&gt;options-&gt;state;</span>
<a href="#l84.213"></a><span id="l84.213">     obj-&gt;options-&gt;state = nullptr;</span>
<a href="#l84.214"></a><span id="l84.214">   }</span>
<a href="#l84.215"></a><span id="l84.215"> }</span>
<a href="#l84.216"></a><span id="l84.216"> </span>
<a href="#l84.217"></a><span id="l84.217" class="difflineminus">-static int</span>
<a href="#l84.218"></a><span id="l84.218" class="difflineminus">-MimeObject_parse_begin (MimeObject *obj)</span>
<a href="#l84.219"></a><span id="l84.219" class="difflineminus">-{</span>
<a href="#l84.220"></a><span id="l84.220" class="difflineminus">-  NS_ASSERTION (!obj-&gt;closed_p, &quot;object shouldn't be already closed&quot;);</span>
<a href="#l84.221"></a><span id="l84.221" class="difflineplus">+static int MimeObject_parse_begin(MimeObject *obj) {</span>
<a href="#l84.222"></a><span id="l84.222" class="difflineplus">+  NS_ASSERTION(!obj-&gt;closed_p, &quot;object shouldn't be already closed&quot;);</span>
<a href="#l84.223"></a><span id="l84.223"> </span>
<a href="#l84.224"></a><span id="l84.224">   /* If we haven't set up the state object yet, then this should be</span>
<a href="#l84.225"></a><span id="l84.225">    the outermost object... */</span>
<a href="#l84.226"></a><span id="l84.226" class="difflineminus">-  if (obj-&gt;options &amp;&amp; !obj-&gt;options-&gt;state)</span>
<a href="#l84.227"></a><span id="l84.227" class="difflineminus">-  {</span>
<a href="#l84.228"></a><span id="l84.228" class="difflineminus">-    NS_ASSERTION(!obj-&gt;headers, &quot;headers should be null&quot;);  /* should be the outermost object. */</span>
<a href="#l84.229"></a><span id="l84.229" class="difflineplus">+  if (obj-&gt;options &amp;&amp; !obj-&gt;options-&gt;state) {</span>
<a href="#l84.230"></a><span id="l84.230" class="difflineplus">+    NS_ASSERTION(</span>
<a href="#l84.231"></a><span id="l84.231" class="difflineplus">+        !obj-&gt;headers,</span>
<a href="#l84.232"></a><span id="l84.232" class="difflineplus">+        &quot;headers should be null&quot;); /* should be the outermost object. */</span>
<a href="#l84.233"></a><span id="l84.233"> </span>
<a href="#l84.234"></a><span id="l84.234">     obj-&gt;options-&gt;state = new MimeParseStateObject;</span>
<a href="#l84.235"></a><span id="l84.235">     if (!obj-&gt;options-&gt;state) return MIME_OUT_OF_MEMORY;</span>
<a href="#l84.236"></a><span id="l84.236">     obj-&gt;options-&gt;state-&gt;root = obj;</span>
<a href="#l84.237"></a><span id="l84.237">     obj-&gt;options-&gt;state-&gt;separator_suppressed_p = true; /* no first sep */</span>
<a href="#l84.238"></a><span id="l84.238">     const char *delParts = PL_strcasestr(obj-&gt;options-&gt;url, &quot;&amp;del=&quot;);</span>
<a href="#l84.239"></a><span id="l84.239" class="difflineminus">-    const char *detachLocations = PL_strcasestr(obj-&gt;options-&gt;url, &quot;&amp;detachTo=&quot;);</span>
<a href="#l84.240"></a><span id="l84.240" class="difflineminus">-    if (delParts)</span>
<a href="#l84.241"></a><span id="l84.241" class="difflineminus">-    {</span>
<a href="#l84.242"></a><span id="l84.242" class="difflineplus">+    const char *detachLocations =</span>
<a href="#l84.243"></a><span id="l84.243" class="difflineplus">+        PL_strcasestr(obj-&gt;options-&gt;url, &quot;&amp;detachTo=&quot;);</span>
<a href="#l84.244"></a><span id="l84.244" class="difflineplus">+    if (delParts) {</span>
<a href="#l84.245"></a><span id="l84.245">       const char *delEnd = PL_strcasestr(delParts + 1, &quot;&amp;&quot;);</span>
<a href="#l84.246"></a><span id="l84.246" class="difflineminus">-      if (!delEnd)</span>
<a href="#l84.247"></a><span id="l84.247" class="difflineminus">-        delEnd = delParts + strlen(delParts);</span>
<a href="#l84.248"></a><span id="l84.248" class="difflineminus">-      ParseString(Substring(delParts + 5, delEnd), ',', obj-&gt;options-&gt;state-&gt;partsToStrip);</span>
<a href="#l84.249"></a><span id="l84.249" class="difflineplus">+      if (!delEnd) delEnd = delParts + strlen(delParts);</span>
<a href="#l84.250"></a><span id="l84.250" class="difflineplus">+      ParseString(Substring(delParts + 5, delEnd), ',',</span>
<a href="#l84.251"></a><span id="l84.251" class="difflineplus">+                  obj-&gt;options-&gt;state-&gt;partsToStrip);</span>
<a href="#l84.252"></a><span id="l84.252">     }</span>
<a href="#l84.253"></a><span id="l84.253" class="difflineminus">-    if (detachLocations)</span>
<a href="#l84.254"></a><span id="l84.254" class="difflineminus">-    {</span>
<a href="#l84.255"></a><span id="l84.255" class="difflineminus">-      detachLocations += 10; // advance past &quot;&amp;detachTo=&quot;</span>
<a href="#l84.256"></a><span id="l84.256" class="difflineminus">-      ParseString(nsDependentCString(detachLocations), ',', obj-&gt;options-&gt;state-&gt;detachToFiles);</span>
<a href="#l84.257"></a><span id="l84.257" class="difflineplus">+    if (detachLocations) {</span>
<a href="#l84.258"></a><span id="l84.258" class="difflineplus">+      detachLocations += 10;  // advance past &quot;&amp;detachTo=&quot;</span>
<a href="#l84.259"></a><span id="l84.259" class="difflineplus">+      ParseString(nsDependentCString(detachLocations), ',',</span>
<a href="#l84.260"></a><span id="l84.260" class="difflineplus">+                  obj-&gt;options-&gt;state-&gt;detachToFiles);</span>
<a href="#l84.261"></a><span id="l84.261">     }</span>
<a href="#l84.262"></a><span id="l84.262">   }</span>
<a href="#l84.263"></a><span id="l84.263"> </span>
<a href="#l84.264"></a><span id="l84.264">   /* Decide whether this object should be output or not... */</span>
<a href="#l84.265"></a><span id="l84.265" class="difflineminus">-  if (!obj-&gt;options || obj-&gt;options-&gt;no_output_p || !obj-&gt;options-&gt;output_fn</span>
<a href="#l84.266"></a><span id="l84.266" class="difflineminus">-    /* if we are decomposing the message in files and processing a multipart object,</span>
<a href="#l84.267"></a><span id="l84.267" class="difflineminus">-       we must not output it without parsing it first */</span>
<a href="#l84.268"></a><span id="l84.268" class="difflineminus">-     || (obj-&gt;options-&gt;decompose_file_p &amp;&amp; obj-&gt;options-&gt;decompose_file_output_fn &amp;&amp;</span>
<a href="#l84.269"></a><span id="l84.269" class="difflineminus">-      mime_typep(obj, (MimeObjectClass*) &amp;mimeMultipartClass))</span>
<a href="#l84.270"></a><span id="l84.270" class="difflineminus">-    )</span>
<a href="#l84.271"></a><span id="l84.271" class="difflineplus">+  if (!obj-&gt;options || obj-&gt;options-&gt;no_output_p ||</span>
<a href="#l84.272"></a><span id="l84.272" class="difflineplus">+      !obj-&gt;options-&gt;output_fn</span>
<a href="#l84.273"></a><span id="l84.273" class="difflineplus">+      /* if we are decomposing the message in files and processing a multipart</span>
<a href="#l84.274"></a><span id="l84.274" class="difflineplus">+         object, we must not output it without parsing it first */</span>
<a href="#l84.275"></a><span id="l84.275" class="difflineplus">+      || (obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l84.276"></a><span id="l84.276" class="difflineplus">+          obj-&gt;options-&gt;decompose_file_output_fn &amp;&amp;</span>
<a href="#l84.277"></a><span id="l84.277" class="difflineplus">+          mime_typep(obj, (MimeObjectClass *)&amp;mimeMultipartClass)))</span>
<a href="#l84.278"></a><span id="l84.278">     obj-&gt;output_p = false;</span>
<a href="#l84.279"></a><span id="l84.279">   else if (!obj-&gt;options-&gt;part_to_load)</span>
<a href="#l84.280"></a><span id="l84.280">     obj-&gt;output_p = true;</span>
<a href="#l84.281"></a><span id="l84.281" class="difflineminus">-  else</span>
<a href="#l84.282"></a><span id="l84.282" class="difflineminus">-  {</span>
<a href="#l84.283"></a><span id="l84.283" class="difflineplus">+  else {</span>
<a href="#l84.284"></a><span id="l84.284">     char *id = mime_part_address(obj);</span>
<a href="#l84.285"></a><span id="l84.285">     if (!id) return MIME_OUT_OF_MEMORY;</span>
<a href="#l84.286"></a><span id="l84.286"> </span>
<a href="#l84.287"></a><span id="l84.287">     // We need to check if a part is the subpart of the part to load.</span>
<a href="#l84.288"></a><span id="l84.288">     // If so and this is a raw or body display output operation, then</span>
<a href="#l84.289"></a><span id="l84.289">     // we should mark the part for subsequent output.</span>
<a href="#l84.290"></a><span id="l84.290"> </span>
<a href="#l84.291"></a><span id="l84.291">     // First, check for an exact match</span>
<a href="#l84.292"></a><span id="l84.292">     obj-&gt;output_p = !strcmp(id, obj-&gt;options-&gt;part_to_load);</span>
<a href="#l84.293"></a><span id="l84.293" class="difflineminus">-    if (!obj-&gt;output_p &amp;&amp; (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageRaw ||</span>
<a href="#l84.294"></a><span id="l84.294" class="difflineminus">-                           obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay ||</span>
<a href="#l84.295"></a><span id="l84.295" class="difflineminus">-                           obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach))</span>
<a href="#l84.296"></a><span id="l84.296" class="difflineminus">-    {</span>
<a href="#l84.297"></a><span id="l84.297" class="difflineplus">+    if (!obj-&gt;output_p &amp;&amp;</span>
<a href="#l84.298"></a><span id="l84.298" class="difflineplus">+        (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageRaw ||</span>
<a href="#l84.299"></a><span id="l84.299" class="difflineplus">+         obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay ||</span>
<a href="#l84.300"></a><span id="l84.300" class="difflineplus">+         obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach)) {</span>
<a href="#l84.301"></a><span id="l84.301">       // Then, check for subpart</span>
<a href="#l84.302"></a><span id="l84.302">       unsigned int partlen = strlen(obj-&gt;options-&gt;part_to_load);</span>
<a href="#l84.303"></a><span id="l84.303">       obj-&gt;output_p = (strlen(id) &gt;= partlen + 2) &amp;&amp; (id[partlen] == '.') &amp;&amp;</span>
<a href="#l84.304"></a><span id="l84.304" class="difflineminus">-        !strncmp(id, obj-&gt;options-&gt;part_to_load, partlen);</span>
<a href="#l84.305"></a><span id="l84.305" class="difflineplus">+                      !strncmp(id, obj-&gt;options-&gt;part_to_load, partlen);</span>
<a href="#l84.306"></a><span id="l84.306">     }</span>
<a href="#l84.307"></a><span id="l84.307"> </span>
<a href="#l84.308"></a><span id="l84.308">     PR_Free(id);</span>
<a href="#l84.309"></a><span id="l84.309">   }</span>
<a href="#l84.310"></a><span id="l84.310"> </span>
<a href="#l84.311"></a><span id="l84.311">   // If we've decided not to output this part, we also shouldn't be showing it</span>
<a href="#l84.312"></a><span id="l84.312">   // as an attachment.</span>
<a href="#l84.313"></a><span id="l84.313">   obj-&gt;dontShowAsAttachment = !obj-&gt;output_p;</span>
<a href="#l84.314"></a><span id="l84.314"> </span>
<a href="#l84.315"></a><span id="l84.315">   return 0;</span>
<a href="#l84.316"></a><span id="l84.316"> }</span>
<a href="#l84.317"></a><span id="l84.317"> </span>
<a href="#l84.318"></a><span id="l84.318" class="difflineminus">-static int</span>
<a href="#l84.319"></a><span id="l84.319" class="difflineminus">-MimeObject_parse_buffer (const char *buffer, int32_t size, MimeObject *obj)</span>
<a href="#l84.320"></a><span id="l84.320" class="difflineminus">-{</span>
<a href="#l84.321"></a><span id="l84.321" class="difflineplus">+static int MimeObject_parse_buffer(const char *buffer, int32_t size,</span>
<a href="#l84.322"></a><span id="l84.322" class="difflineplus">+                                   MimeObject *obj) {</span>
<a href="#l84.323"></a><span id="l84.323">   NS_ASSERTION(!obj-&gt;closed_p, &quot;object shouldn't be closed&quot;);</span>
<a href="#l84.324"></a><span id="l84.324">   if (obj-&gt;closed_p) return -1;</span>
<a href="#l84.325"></a><span id="l84.325"> </span>
<a href="#l84.326"></a><span id="l84.326" class="difflineminus">-  return mime_LineBuffer (buffer, size,</span>
<a href="#l84.327"></a><span id="l84.327" class="difflineminus">-             &amp;obj-&gt;ibuffer, &amp;obj-&gt;ibuffer_size, &amp;obj-&gt;ibuffer_fp,</span>
<a href="#l84.328"></a><span id="l84.328" class="difflineminus">-             true,</span>
<a href="#l84.329"></a><span id="l84.329" class="difflineminus">-             ((int (*) (char *, int32_t, void *))</span>
<a href="#l84.330"></a><span id="l84.330" class="difflineminus">-              /* This cast is to turn void into MimeObject */</span>
<a href="#l84.331"></a><span id="l84.331" class="difflineminus">-              obj-&gt;clazz-&gt;parse_line),</span>
<a href="#l84.332"></a><span id="l84.332" class="difflineminus">-             obj);</span>
<a href="#l84.333"></a><span id="l84.333" class="difflineplus">+  return mime_LineBuffer(buffer, size, &amp;obj-&gt;ibuffer, &amp;obj-&gt;ibuffer_size,</span>
<a href="#l84.334"></a><span id="l84.334" class="difflineplus">+                         &amp;obj-&gt;ibuffer_fp, true,</span>
<a href="#l84.335"></a><span id="l84.335" class="difflineplus">+                         ((int (*)(char *, int32_t, void *))</span>
<a href="#l84.336"></a><span id="l84.336" class="difflineplus">+                          /* This cast is to turn void into MimeObject */</span>
<a href="#l84.337"></a><span id="l84.337" class="difflineplus">+                          obj-&gt;clazz-&gt;parse_line),</span>
<a href="#l84.338"></a><span id="l84.338" class="difflineplus">+                         obj);</span>
<a href="#l84.339"></a><span id="l84.339"> }</span>
<a href="#l84.340"></a><span id="l84.340"> </span>
<a href="#l84.341"></a><span id="l84.341" class="difflineminus">-static int</span>
<a href="#l84.342"></a><span id="l84.342" class="difflineminus">-MimeObject_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l84.343"></a><span id="l84.343" class="difflineminus">-{</span>
<a href="#l84.344"></a><span id="l84.344" class="difflineplus">+static int MimeObject_parse_line(const char *line, int32_t length,</span>
<a href="#l84.345"></a><span id="l84.345" class="difflineplus">+                                 MimeObject *obj) {</span>
<a href="#l84.346"></a><span id="l84.346">   NS_ERROR(&quot;shouldn't call this method&quot;);</span>
<a href="#l84.347"></a><span id="l84.347">   return -1;</span>
<a href="#l84.348"></a><span id="l84.348"> }</span>
<a href="#l84.349"></a><span id="l84.349"> </span>
<a href="#l84.350"></a><span id="l84.350" class="difflineminus">-static int</span>
<a href="#l84.351"></a><span id="l84.351" class="difflineminus">-MimeObject_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l84.352"></a><span id="l84.352" class="difflineminus">-{</span>
<a href="#l84.353"></a><span id="l84.353" class="difflineplus">+static int MimeObject_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l84.354"></a><span id="l84.354">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l84.355"></a><span id="l84.355">   NS_ASSERTION(!obj-&gt;parsed_p, &quot;obj already parsed&quot;);</span>
<a href="#l84.356"></a><span id="l84.356"> </span>
<a href="#l84.357"></a><span id="l84.357">   /* If there is still data in the ibuffer, that means that the last line of</span>
<a href="#l84.358"></a><span id="l84.358">    this part didn't end in a newline; so push it out anyway (this means that</span>
<a href="#l84.359"></a><span id="l84.359">    the parse_line method will be called with a string with no trailing</span>
<a href="#l84.360"></a><span id="l84.360">    newline, which isn't the usual case.)</span>
<a href="#l84.361"></a><span id="l84.361">    */</span>
<a href="#l84.362"></a><span id="l84.362" class="difflineminus">-  if (!abort_p &amp;&amp;</span>
<a href="#l84.363"></a><span id="l84.363" class="difflineminus">-    obj-&gt;ibuffer_fp &gt; 0)</span>
<a href="#l84.364"></a><span id="l84.364" class="difflineminus">-  {</span>
<a href="#l84.365"></a><span id="l84.365" class="difflineminus">-    int status = obj-&gt;clazz-&gt;parse_line (obj-&gt;ibuffer, obj-&gt;ibuffer_fp, obj);</span>
<a href="#l84.366"></a><span id="l84.366" class="difflineplus">+  if (!abort_p &amp;&amp; obj-&gt;ibuffer_fp &gt; 0) {</span>
<a href="#l84.367"></a><span id="l84.367" class="difflineplus">+    int status = obj-&gt;clazz-&gt;parse_line(obj-&gt;ibuffer, obj-&gt;ibuffer_fp, obj);</span>
<a href="#l84.368"></a><span id="l84.368">     obj-&gt;ibuffer_fp = 0;</span>
<a href="#l84.369"></a><span id="l84.369" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l84.370"></a><span id="l84.370" class="difflineminus">-    {</span>
<a href="#l84.371"></a><span id="l84.371" class="difflineplus">+    if (status &lt; 0) {</span>
<a href="#l84.372"></a><span id="l84.372">       obj-&gt;closed_p = true;</span>
<a href="#l84.373"></a><span id="l84.373">       return status;</span>
<a href="#l84.374"></a><span id="l84.374">     }</span>
<a href="#l84.375"></a><span id="l84.375">   }</span>
<a href="#l84.376"></a><span id="l84.376"> </span>
<a href="#l84.377"></a><span id="l84.377">   obj-&gt;closed_p = true;</span>
<a href="#l84.378"></a><span id="l84.378">   return 0;</span>
<a href="#l84.379"></a><span id="l84.379"> }</span>
<a href="#l84.380"></a><span id="l84.380"> </span>
<a href="#l84.381"></a><span id="l84.381" class="difflineminus">-static int</span>
<a href="#l84.382"></a><span id="l84.382" class="difflineminus">-MimeObject_parse_end (MimeObject *obj, bool abort_p)</span>
<a href="#l84.383"></a><span id="l84.383" class="difflineminus">-{</span>
<a href="#l84.384"></a><span id="l84.384" class="difflineminus">-  if (obj-&gt;parsed_p)</span>
<a href="#l84.385"></a><span id="l84.385" class="difflineminus">-  {</span>
<a href="#l84.386"></a><span id="l84.386" class="difflineplus">+static int MimeObject_parse_end(MimeObject *obj, bool abort_p) {</span>
<a href="#l84.387"></a><span id="l84.387" class="difflineplus">+  if (obj-&gt;parsed_p) {</span>
<a href="#l84.388"></a><span id="l84.388">     NS_ASSERTION(obj-&gt;closed_p, &quot;object should be closed&quot;);</span>
<a href="#l84.389"></a><span id="l84.389">     return 0;</span>
<a href="#l84.390"></a><span id="l84.390">   }</span>
<a href="#l84.391"></a><span id="l84.391"> </span>
<a href="#l84.392"></a><span id="l84.392">   /* We won't be needing these buffers any more; nuke 'em. */</span>
<a href="#l84.393"></a><span id="l84.393">   PR_FREEIF(obj-&gt;ibuffer);</span>
<a href="#l84.394"></a><span id="l84.394">   obj-&gt;ibuffer_fp = 0;</span>
<a href="#l84.395"></a><span id="l84.395">   obj-&gt;ibuffer_size = 0;</span>
<a href="#l84.396"></a><span id="l84.396">   PR_FREEIF(obj-&gt;obuffer);</span>
<a href="#l84.397"></a><span id="l84.397">   obj-&gt;obuffer_fp = 0;</span>
<a href="#l84.398"></a><span id="l84.398">   obj-&gt;obuffer_size = 0;</span>
<a href="#l84.399"></a><span id="l84.399"> </span>
<a href="#l84.400"></a><span id="l84.400">   obj-&gt;parsed_p = true;</span>
<a href="#l84.401"></a><span id="l84.401">   return 0;</span>
<a href="#l84.402"></a><span id="l84.402"> }</span>
<a href="#l84.403"></a><span id="l84.403"> </span>
<a href="#l84.404"></a><span id="l84.404" class="difflineminus">-static bool</span>
<a href="#l84.405"></a><span id="l84.405" class="difflineminus">-MimeObject_displayable_inline_p (MimeObjectClass *clazz, MimeHeaders *hdrs)</span>
<a href="#l84.406"></a><span id="l84.406" class="difflineminus">-{</span>
<a href="#l84.407"></a><span id="l84.407" class="difflineplus">+static bool MimeObject_displayable_inline_p(MimeObjectClass *clazz,</span>
<a href="#l84.408"></a><span id="l84.408" class="difflineplus">+                                            MimeHeaders *hdrs) {</span>
<a href="#l84.409"></a><span id="l84.409">   NS_ERROR(&quot;shouldn't call this method&quot;);</span>
<a href="#l84.410"></a><span id="l84.410">   return false;</span>
<a href="#l84.411"></a><span id="l84.411"> }</span>
<a href="#l84.412"></a><span id="l84.412"> </span>
<a href="#l84.413"></a><span id="l84.413"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l84.414"></a><span id="l84.414" class="difflineminus">-static int</span>
<a href="#l84.415"></a><span id="l84.415" class="difflineminus">-MimeObject_debug_print (MimeObject *obj, PRFileDesc *stream, int32_t depth)</span>
<a href="#l84.416"></a><span id="l84.416" class="difflineminus">-{</span>
<a href="#l84.417"></a><span id="l84.417" class="difflineplus">+static int MimeObject_debug_print(MimeObject *obj, PRFileDesc *stream,</span>
<a href="#l84.418"></a><span id="l84.418" class="difflineplus">+                                  int32_t depth) {</span>
<a href="#l84.419"></a><span id="l84.419">   int i;</span>
<a href="#l84.420"></a><span id="l84.420">   char *addr = mime_part_address(obj);</span>
<a href="#l84.421"></a><span id="l84.421" class="difflineminus">-  for (i=0; i &lt; depth; i++)</span>
<a href="#l84.422"></a><span id="l84.422" class="difflineminus">-  PR_Write(stream, &quot;  &quot;, 2);</span>
<a href="#l84.423"></a><span id="l84.423" class="difflineminus">-/*</span>
<a href="#l84.424"></a><span id="l84.424" class="difflineminus">-  fprintf(stream, &quot;&lt;%s %s 0x%08X&gt;\n&quot;, obj-&gt;clazz-&gt;class_name,</span>
<a href="#l84.425"></a><span id="l84.425" class="difflineminus">-      addr ? addr : &quot;???&quot;,</span>
<a href="#l84.426"></a><span id="l84.426" class="difflineminus">-      (uint32_t) obj);</span>
<a href="#l84.427"></a><span id="l84.427" class="difflineminus">-*/</span>
<a href="#l84.428"></a><span id="l84.428" class="difflineplus">+  for (i = 0; i &lt; depth; i++) PR_Write(stream, &quot;  &quot;, 2);</span>
<a href="#l84.429"></a><span id="l84.429" class="difflineplus">+  /*</span>
<a href="#l84.430"></a><span id="l84.430" class="difflineplus">+    fprintf(stream, &quot;&lt;%s %s 0x%08X&gt;\n&quot;, obj-&gt;clazz-&gt;class_name,</span>
<a href="#l84.431"></a><span id="l84.431" class="difflineplus">+        addr ? addr : &quot;???&quot;,</span>
<a href="#l84.432"></a><span id="l84.432" class="difflineplus">+        (uint32_t) obj);</span>
<a href="#l84.433"></a><span id="l84.433" class="difflineplus">+  */</span>
<a href="#l84.434"></a><span id="l84.434">   PR_FREEIF(addr);</span>
<a href="#l84.435"></a><span id="l84.435">   return 0;</span>
<a href="#l84.436"></a><span id="l84.436"> }</span>
<a href="#l84.437"></a><span id="l84.437"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/mailnews/mime/src/mimeobj.h</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/mailnews/mime/src/mimeobj.h</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -89,98 +89,94 @@</span>
<a href="#l85.4"></a><span id="l85.4">      used by the &quot;multipart/alternative&quot; parser to decide which of its children</span>
<a href="#l85.5"></a><span id="l85.5">      is the ``best'' one to display.   Note that this is a class method, not</span>
<a href="#l85.6"></a><span id="l85.6">      an object method -- there is not yet an instance of this class at the time</span>
<a href="#l85.7"></a><span id="l85.7">      that it is called.  The `hdrs' provided are the headers of the object that</span>
<a href="#l85.8"></a><span id="l85.8">    might be instantiated -- from this, the method may extract additional</span>
<a href="#l85.9"></a><span id="l85.9">    information that it might need to make its decision.</span>
<a href="#l85.10"></a><span id="l85.10">  */</span>
<a href="#l85.11"></a><span id="l85.11"> </span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-</span>
<a href="#l85.13"></a><span id="l85.13"> /* this one is typdedef'ed in mimei.h, since it is the base-class. */</span>
<a href="#l85.14"></a><span id="l85.14"> struct MimeObjectClass {</span>
<a href="#l85.15"></a><span id="l85.15" class="difflineminus">-</span>
<a href="#l85.16"></a><span id="l85.16">   /* Note: the order of these first five slots is known by MimeDefClass().</span>
<a href="#l85.17"></a><span id="l85.17">    Technically, these are part of the object system, not the MIME code.</span>
<a href="#l85.18"></a><span id="l85.18">    */</span>
<a href="#l85.19"></a><span id="l85.19">   const char *class_name;</span>
<a href="#l85.20"></a><span id="l85.20">   int instance_size;</span>
<a href="#l85.21"></a><span id="l85.21">   struct MimeObjectClass *superclass;</span>
<a href="#l85.22"></a><span id="l85.22" class="difflineminus">-  int (*class_initialize) (MimeObjectClass *clazz);</span>
<a href="#l85.23"></a><span id="l85.23" class="difflineplus">+  int (*class_initialize)(MimeObjectClass *clazz);</span>
<a href="#l85.24"></a><span id="l85.24">   bool class_initialized;</span>
<a href="#l85.25"></a><span id="l85.25"> </span>
<a href="#l85.26"></a><span id="l85.26">   /* These are the methods shared by all MIME objects.  See comment above.</span>
<a href="#l85.27"></a><span id="l85.27">    */</span>
<a href="#l85.28"></a><span id="l85.28" class="difflineminus">-  int (*initialize) (MimeObject *obj);</span>
<a href="#l85.29"></a><span id="l85.29" class="difflineminus">-  void (*finalize) (MimeObject *obj);</span>
<a href="#l85.30"></a><span id="l85.30" class="difflineminus">-  int (*parse_begin) (MimeObject *obj);</span>
<a href="#l85.31"></a><span id="l85.31" class="difflineminus">-  int (*parse_buffer) (const char *buf, int32_t size, MimeObject *obj);</span>
<a href="#l85.32"></a><span id="l85.32" class="difflineminus">-  int (*parse_line) (const char *line, int32_t length, MimeObject *obj);</span>
<a href="#l85.33"></a><span id="l85.33" class="difflineminus">-  int (*parse_eof) (MimeObject *obj, bool abort_p);</span>
<a href="#l85.34"></a><span id="l85.34" class="difflineminus">-  int (*parse_end) (MimeObject *obj, bool abort_p);</span>
<a href="#l85.35"></a><span id="l85.35" class="difflineplus">+  int (*initialize)(MimeObject *obj);</span>
<a href="#l85.36"></a><span id="l85.36" class="difflineplus">+  void (*finalize)(MimeObject *obj);</span>
<a href="#l85.37"></a><span id="l85.37" class="difflineplus">+  int (*parse_begin)(MimeObject *obj);</span>
<a href="#l85.38"></a><span id="l85.38" class="difflineplus">+  int (*parse_buffer)(const char *buf, int32_t size, MimeObject *obj);</span>
<a href="#l85.39"></a><span id="l85.39" class="difflineplus">+  int (*parse_line)(const char *line, int32_t length, MimeObject *obj);</span>
<a href="#l85.40"></a><span id="l85.40" class="difflineplus">+  int (*parse_eof)(MimeObject *obj, bool abort_p);</span>
<a href="#l85.41"></a><span id="l85.41" class="difflineplus">+  int (*parse_end)(MimeObject *obj, bool abort_p);</span>
<a href="#l85.42"></a><span id="l85.42"> </span>
<a href="#l85.43"></a><span id="l85.43" class="difflineminus">-  bool (*displayable_inline_p) (MimeObjectClass *clazz, MimeHeaders *hdrs);</span>
<a href="#l85.44"></a><span id="l85.44" class="difflineplus">+  bool (*displayable_inline_p)(MimeObjectClass *clazz, MimeHeaders *hdrs);</span>
<a href="#l85.45"></a><span id="l85.45"> </span>
<a href="#l85.46"></a><span id="l85.46"> #if defined(DEBUG) &amp;&amp; defined(XP_UNIX)</span>
<a href="#l85.47"></a><span id="l85.47" class="difflineminus">-  int (*debug_print) (MimeObject *obj, PRFileDesc *stream, int32_t depth);</span>
<a href="#l85.48"></a><span id="l85.48" class="difflineplus">+  int (*debug_print)(MimeObject *obj, PRFileDesc *stream, int32_t depth);</span>
<a href="#l85.49"></a><span id="l85.49"> #endif</span>
<a href="#l85.50"></a><span id="l85.50"> };</span>
<a href="#l85.51"></a><span id="l85.51"> </span>
<a href="#l85.52"></a><span id="l85.52"> extern &quot;C&quot; MimeObjectClass mimeObjectClass;</span>
<a href="#l85.53"></a><span id="l85.53"> </span>
<a href="#l85.54"></a><span id="l85.54"> /* this one is typdedef'ed in mimei.h, since it is the base-class. */</span>
<a href="#l85.55"></a><span id="l85.55"> struct MimeObject {</span>
<a href="#l85.56"></a><span id="l85.56" class="difflineminus">-  MimeObjectClass *clazz;  /* Pointer to class object, for `type-of' */</span>
<a href="#l85.57"></a><span id="l85.57" class="difflineminus">-</span>
<a href="#l85.58"></a><span id="l85.58" class="difflineminus">-  MimeHeaders *headers;    /* The header data associated with this object;</span>
<a href="#l85.59"></a><span id="l85.59" class="difflineminus">-                 this is where the content-type, disposition,</span>
<a href="#l85.60"></a><span id="l85.60" class="difflineminus">-                 description, and other meta-data live.</span>
<a href="#l85.61"></a><span id="l85.61" class="difflineplus">+  MimeObjectClass *clazz; /* Pointer to class object, for `type-of' */</span>
<a href="#l85.62"></a><span id="l85.62"> </span>
<a href="#l85.63"></a><span id="l85.63" class="difflineminus">-                 For example, the outermost message/rfc822 object</span>
<a href="#l85.64"></a><span id="l85.64" class="difflineminus">-                 would have NULL here (since it has no parent,</span>
<a href="#l85.65"></a><span id="l85.65" class="difflineminus">-                 thus no headers to describe it.)  However, a</span>
<a href="#l85.66"></a><span id="l85.66" class="difflineminus">-                 multipart/mixed object, which was the sole</span>
<a href="#l85.67"></a><span id="l85.67" class="difflineminus">-                 child of that message/rfc822 object, would have</span>
<a href="#l85.68"></a><span id="l85.68" class="difflineminus">-                 here a copy of the headers which began the</span>
<a href="#l85.69"></a><span id="l85.69" class="difflineminus">-                 parent object (the headers which describe the</span>
<a href="#l85.70"></a><span id="l85.70" class="difflineminus">-                 child.)</span>
<a href="#l85.71"></a><span id="l85.71" class="difflineminus">-               */</span>
<a href="#l85.72"></a><span id="l85.72" class="difflineplus">+  MimeHeaders *headers; /* The header data associated with this object;</span>
<a href="#l85.73"></a><span id="l85.73" class="difflineplus">+              this is where the content-type, disposition,</span>
<a href="#l85.74"></a><span id="l85.74" class="difflineplus">+              description, and other meta-data live.</span>
<a href="#l85.75"></a><span id="l85.75"> </span>
<a href="#l85.76"></a><span id="l85.76" class="difflineminus">-  char *content_type;    /* The MIME content-type and encoding.  */</span>
<a href="#l85.77"></a><span id="l85.77" class="difflineminus">-  char *encoding;      /* In most cases, these will be the same as the</span>
<a href="#l85.78"></a><span id="l85.78" class="difflineminus">-                 values to be found in the `headers' object,</span>
<a href="#l85.79"></a><span id="l85.79" class="difflineminus">-                 but in some cases, the values in these slots</span>
<a href="#l85.80"></a><span id="l85.80" class="difflineminus">-                 will be more correct than the headers.</span>
<a href="#l85.81"></a><span id="l85.81" class="difflineminus">-               */</span>
<a href="#l85.82"></a><span id="l85.82" class="difflineminus">-</span>
<a href="#l85.83"></a><span id="l85.83" class="difflineplus">+              For example, the outermost message/rfc822 object</span>
<a href="#l85.84"></a><span id="l85.84" class="difflineplus">+              would have NULL here (since it has no parent,</span>
<a href="#l85.85"></a><span id="l85.85" class="difflineplus">+              thus no headers to describe it.)  However, a</span>
<a href="#l85.86"></a><span id="l85.86" class="difflineplus">+              multipart/mixed object, which was the sole</span>
<a href="#l85.87"></a><span id="l85.87" class="difflineplus">+              child of that message/rfc822 object, would have</span>
<a href="#l85.88"></a><span id="l85.88" class="difflineplus">+              here a copy of the headers which began the</span>
<a href="#l85.89"></a><span id="l85.89" class="difflineplus">+              parent object (the headers which describe the</span>
<a href="#l85.90"></a><span id="l85.90" class="difflineplus">+              child.)</span>
<a href="#l85.91"></a><span id="l85.91" class="difflineplus">+            */</span>
<a href="#l85.92"></a><span id="l85.92"> </span>
<a href="#l85.93"></a><span id="l85.93" class="difflineminus">-  MimeObject *parent;    /* Backpointer to a MimeContainer object. */</span>
<a href="#l85.94"></a><span id="l85.94" class="difflineminus">-</span>
<a href="#l85.95"></a><span id="l85.95" class="difflineminus">-  MimeDisplayOptions *options;  /* Display preferences set by caller. */</span>
<a href="#l85.96"></a><span id="l85.96" class="difflineplus">+  char *content_type; /* The MIME content-type and encoding.  */</span>
<a href="#l85.97"></a><span id="l85.97" class="difflineplus">+  char *encoding;     /* In most cases, these will be the same as the</span>
<a href="#l85.98"></a><span id="l85.98" class="difflineplus">+                values to be found in the `headers' object,</span>
<a href="#l85.99"></a><span id="l85.99" class="difflineplus">+                but in some cases, the values in these slots</span>
<a href="#l85.100"></a><span id="l85.100" class="difflineplus">+                will be more correct than the headers.</span>
<a href="#l85.101"></a><span id="l85.101" class="difflineplus">+              */</span>
<a href="#l85.102"></a><span id="l85.102"> </span>
<a href="#l85.103"></a><span id="l85.103" class="difflineminus">-  bool closed_p;      /* Whether it's done being written to. */</span>
<a href="#l85.104"></a><span id="l85.104" class="difflineminus">-  bool parsed_p;      /* Whether the parser has been shut down. */</span>
<a href="#l85.105"></a><span id="l85.105" class="difflineminus">-  bool output_p;      /* Whether it should be written. */</span>
<a href="#l85.106"></a><span id="l85.106" class="difflineplus">+  MimeObject *parent; /* Backpointer to a MimeContainer object. */</span>
<a href="#l85.107"></a><span id="l85.107" class="difflineplus">+</span>
<a href="#l85.108"></a><span id="l85.108" class="difflineplus">+  MimeDisplayOptions *options; /* Display preferences set by caller. */</span>
<a href="#l85.109"></a><span id="l85.109" class="difflineplus">+</span>
<a href="#l85.110"></a><span id="l85.110" class="difflineplus">+  bool closed_p;             /* Whether it's done being written to. */</span>
<a href="#l85.111"></a><span id="l85.111" class="difflineplus">+  bool parsed_p;             /* Whether the parser has been shut down. */</span>
<a href="#l85.112"></a><span id="l85.112" class="difflineplus">+  bool output_p;             /* Whether it should be written. */</span>
<a href="#l85.113"></a><span id="l85.113">   bool dontShowAsAttachment; /* Force an object to not be shown as attachment,</span>
<a href="#l85.114"></a><span id="l85.114">                                 but when is false, it doesn't mean it will be</span>
<a href="#l85.115"></a><span id="l85.115">                                 shown as attachment; specifically, body parts</span>
<a href="#l85.116"></a><span id="l85.116">                                 are never shown as attachments. */</span>
<a href="#l85.117"></a><span id="l85.117"> </span>
<a href="#l85.118"></a><span id="l85.118">   /* Read-buffer and write-buffer (on input, `parse_buffer' uses ibuffer to</span>
<a href="#l85.119"></a><span id="l85.119">    compose calls to `parse_line'; on output, `obuffer' is used in various</span>
<a href="#l85.120"></a><span id="l85.120">    ways by various routines.)  These buffers are created and grow as needed.</span>
<a href="#l85.121"></a><span id="l85.121">    `ibuffer' should be generally be considered hands-off, and `obuffer'</span>
<a href="#l85.122"></a><span id="l85.122">    should generally be considered fair game.</span>
<a href="#l85.123"></a><span id="l85.123">    */</span>
<a href="#l85.124"></a><span id="l85.124">   char *ibuffer, *obuffer;</span>
<a href="#l85.125"></a><span id="l85.125">   int32_t ibuffer_size, obuffer_size;</span>
<a href="#l85.126"></a><span id="l85.126">   int32_t ibuffer_fp, obuffer_fp;</span>
<a href="#l85.127"></a><span id="l85.127"> };</span>
<a href="#l85.128"></a><span id="l85.128"> </span>
<a href="#l85.129"></a><span id="l85.129" class="difflineminus">-</span>
<a href="#l85.130"></a><span id="l85.130" class="difflineminus">-#define MimeObject_grow_obuffer(obj, desired_size) \</span>
<a href="#l85.131"></a><span id="l85.131" class="difflineminus">-  (((desired_size) &gt;= (obj)-&gt;obuffer_size) ? \</span>
<a href="#l85.132"></a><span id="l85.132" class="difflineminus">-   mime_GrowBuffer ((uint32_t)(desired_size), (uint32_t)sizeof(char), 1024, \</span>
<a href="#l85.133"></a><span id="l85.133" class="difflineminus">-           &amp;(obj)-&gt;obuffer, (int32_t*)&amp;(obj)-&gt;obuffer_size) \</span>
<a href="#l85.134"></a><span id="l85.134" class="difflineminus">-   : 0)</span>
<a href="#l85.135"></a><span id="l85.135" class="difflineminus">-</span>
<a href="#l85.136"></a><span id="l85.136" class="difflineplus">+#define MimeObject_grow_obuffer(obj, desired_size)                         \</span>
<a href="#l85.137"></a><span id="l85.137" class="difflineplus">+  (((desired_size) &gt;= (obj)-&gt;obuffer_size)                                 \</span>
<a href="#l85.138"></a><span id="l85.138" class="difflineplus">+       ? mime_GrowBuffer((uint32_t)(desired_size), (uint32_t)sizeof(char), \</span>
<a href="#l85.139"></a><span id="l85.139" class="difflineplus">+                         1024, &amp;(obj)-&gt;obuffer,                            \</span>
<a href="#l85.140"></a><span id="l85.140" class="difflineplus">+                         (int32_t *)&amp;(obj)-&gt;obuffer_size)                  \</span>
<a href="#l85.141"></a><span id="l85.141" class="difflineplus">+       : 0)</span>
<a href="#l85.142"></a><span id="l85.142"> </span>
<a href="#l85.143"></a><span id="l85.143"> #endif /* _MIMEOBJ_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/mailnews/mime/src/mimepbuf.cpp</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/mailnews/mime/src/mimepbuf.cpp</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -9,18 +9,17 @@</span>
<a href="#l86.4"></a><span id="l86.4"> #include &quot;prio.h&quot;</span>
<a href="#l86.5"></a><span id="l86.5"> #include &quot;plstr.h&quot;</span>
<a href="#l86.6"></a><span id="l86.6"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l86.7"></a><span id="l86.7"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l86.8"></a><span id="l86.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l86.9"></a><span id="l86.9"> //</span>
<a href="#l86.10"></a><span id="l86.10"> // External Defines...</span>
<a href="#l86.11"></a><span id="l86.11"> //</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-extern nsresult</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineminus">-nsMsgCreateTempFile(const char *tFileName, nsIFile **tFile);</span>
<a href="#l86.14"></a><span id="l86.14" class="difflineplus">+extern nsresult nsMsgCreateTempFile(const char *tFileName, nsIFile **tFile);</span>
<a href="#l86.15"></a><span id="l86.15"> </span>
<a href="#l86.16"></a><span id="l86.16"> /* See mimepbuf.h for a description of the mission of this file.</span>
<a href="#l86.17"></a><span id="l86.17"> </span>
<a href="#l86.18"></a><span id="l86.18">    Implementation:</span>
<a href="#l86.19"></a><span id="l86.19"> </span>
<a href="#l86.20"></a><span id="l86.20">      When asked to buffer an object, we first try to malloc() a buffer to</span>
<a href="#l86.21"></a><span id="l86.21">    hold the upcoming part.  First we try to allocate a 50k buffer, and</span>
<a href="#l86.22"></a><span id="l86.22">    then back off by 5k until we are able to complete the allocation,</span>
<a href="#l86.23"></a><span id="l86.23" class="difflineat">@@ -39,260 +38,216 @@ nsMsgCreateTempFile(const char *tFileNam</span>
<a href="#l86.24"></a><span id="l86.24">    the same time; and small parts tend to live completely in memory</span>
<a href="#l86.25"></a><span id="l86.25">    while large parts tend to live on disk.</span>
<a href="#l86.26"></a><span id="l86.26"> </span>
<a href="#l86.27"></a><span id="l86.27">    When we are asked to read the data back out of the buffer, we call</span>
<a href="#l86.28"></a><span id="l86.28">    the provided read-function with either: the contents of the memory</span>
<a href="#l86.29"></a><span id="l86.29">    buffer; or blocks read from the disk file.</span>
<a href="#l86.30"></a><span id="l86.30">  */</span>
<a href="#l86.31"></a><span id="l86.31"> </span>
<a href="#l86.32"></a><span id="l86.32" class="difflineminus">-#define TARGET_MEMORY_BUFFER_SIZE    (1024 * 50)  /* try for 50k mem buffer */</span>
<a href="#l86.33"></a><span id="l86.33" class="difflineminus">-#define TARGET_MEMORY_BUFFER_QUANTUM (1024 * 5)   /* decrease in steps of 5k */</span>
<a href="#l86.34"></a><span id="l86.34" class="difflineminus">-#define DISK_BUFFER_SIZE       (1024 * 10)  /* read disk in 10k chunks */</span>
<a href="#l86.35"></a><span id="l86.35" class="difflineminus">-</span>
<a href="#l86.36"></a><span id="l86.36" class="difflineplus">+#define TARGET_MEMORY_BUFFER_SIZE (1024 * 50)   /* try for 50k mem buffer */</span>
<a href="#l86.37"></a><span id="l86.37" class="difflineplus">+#define TARGET_MEMORY_BUFFER_QUANTUM (1024 * 5) /* decrease in steps of 5k */</span>
<a href="#l86.38"></a><span id="l86.38" class="difflineplus">+#define DISK_BUFFER_SIZE (1024 * 10)            /* read disk in 10k chunks */</span>
<a href="#l86.39"></a><span id="l86.39"> </span>
<a href="#l86.40"></a><span id="l86.40" class="difflineminus">-struct MimePartBufferData</span>
<a href="#l86.41"></a><span id="l86.41" class="difflineminus">-{</span>
<a href="#l86.42"></a><span id="l86.42" class="difflineminus">-  char        *part_buffer;          /* Buffer used for part-lookahead. */</span>
<a href="#l86.43"></a><span id="l86.43" class="difflineminus">-  int32_t     part_buffer_fp;        /* Active length. */</span>
<a href="#l86.44"></a><span id="l86.44" class="difflineminus">-  int32_t     part_buffer_size;      /* How big it is. */</span>
<a href="#l86.45"></a><span id="l86.45" class="difflineplus">+struct MimePartBufferData {</span>
<a href="#l86.46"></a><span id="l86.46" class="difflineplus">+  char *part_buffer;        /* Buffer used for part-lookahead. */</span>
<a href="#l86.47"></a><span id="l86.47" class="difflineplus">+  int32_t part_buffer_fp;   /* Active length. */</span>
<a href="#l86.48"></a><span id="l86.48" class="difflineplus">+  int32_t part_buffer_size; /* How big it is. */</span>
<a href="#l86.49"></a><span id="l86.49"> </span>
<a href="#l86.50"></a><span id="l86.50" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; file_buffer;    /* The nsIFile of a temp file used when we</span>
<a href="#l86.51"></a><span id="l86.51" class="difflineminus">-                                                          run out of room in the head_buffer. */</span>
<a href="#l86.52"></a><span id="l86.52" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; input_file_stream;    /* A stream to it. */</span>
<a href="#l86.53"></a><span id="l86.53" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; output_file_stream;  /* A stream to it. */</span>
<a href="#l86.54"></a><span id="l86.54" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt;</span>
<a href="#l86.55"></a><span id="l86.55" class="difflineplus">+      file_buffer; /* The nsIFile of a temp file used when we</span>
<a href="#l86.56"></a><span id="l86.56" class="difflineplus">+                                        run out of room in the head_buffer. */</span>
<a href="#l86.57"></a><span id="l86.57" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; input_file_stream;   /* A stream to it. */</span>
<a href="#l86.58"></a><span id="l86.58" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; output_file_stream; /* A stream to it. */</span>
<a href="#l86.59"></a><span id="l86.59">   MimePartBufferData()</span>
<a href="#l86.60"></a><span id="l86.60" class="difflineminus">-    : part_buffer(nullptr)</span>
<a href="#l86.61"></a><span id="l86.61" class="difflineminus">-    , part_buffer_fp(0)</span>
<a href="#l86.62"></a><span id="l86.62" class="difflineminus">-    , part_buffer_size(0)</span>
<a href="#l86.63"></a><span id="l86.63" class="difflineminus">-  {}</span>
<a href="#l86.64"></a><span id="l86.64" class="difflineplus">+      : part_buffer(nullptr), part_buffer_fp(0), part_buffer_size(0) {}</span>
<a href="#l86.65"></a><span id="l86.65"> };</span>
<a href="#l86.66"></a><span id="l86.66"> </span>
<a href="#l86.67"></a><span id="l86.67" class="difflineminus">-MimePartBufferData *</span>
<a href="#l86.68"></a><span id="l86.68" class="difflineminus">-MimePartBufferCreate (void)</span>
<a href="#l86.69"></a><span id="l86.69" class="difflineminus">-{</span>
<a href="#l86.70"></a><span id="l86.70" class="difflineplus">+MimePartBufferData *MimePartBufferCreate(void) {</span>
<a href="#l86.71"></a><span id="l86.71">   return new MimePartBufferData();</span>
<a href="#l86.72"></a><span id="l86.72"> }</span>
<a href="#l86.73"></a><span id="l86.73"> </span>
<a href="#l86.74"></a><span id="l86.74" class="difflineminus">-</span>
<a href="#l86.75"></a><span id="l86.75" class="difflineminus">-void</span>
<a href="#l86.76"></a><span id="l86.76" class="difflineminus">-MimePartBufferClose (MimePartBufferData *data)</span>
<a href="#l86.77"></a><span id="l86.77" class="difflineminus">-{</span>
<a href="#l86.78"></a><span id="l86.78" class="difflineplus">+void MimePartBufferClose(MimePartBufferData *data) {</span>
<a href="#l86.79"></a><span id="l86.79">   NS_ASSERTION(data, &quot;MimePartBufferClose: no data&quot;);</span>
<a href="#l86.80"></a><span id="l86.80">   if (!data) return;</span>
<a href="#l86.81"></a><span id="l86.81"> </span>
<a href="#l86.82"></a><span id="l86.82" class="difflineminus">-  if (data-&gt;input_file_stream)</span>
<a href="#l86.83"></a><span id="l86.83" class="difflineminus">-  {</span>
<a href="#l86.84"></a><span id="l86.84" class="difflineplus">+  if (data-&gt;input_file_stream) {</span>
<a href="#l86.85"></a><span id="l86.85">     data-&gt;input_file_stream-&gt;Close();</span>
<a href="#l86.86"></a><span id="l86.86">     data-&gt;input_file_stream = nullptr;</span>
<a href="#l86.87"></a><span id="l86.87">   }</span>
<a href="#l86.88"></a><span id="l86.88"> </span>
<a href="#l86.89"></a><span id="l86.89" class="difflineminus">-  if (data-&gt;output_file_stream)</span>
<a href="#l86.90"></a><span id="l86.90" class="difflineminus">-  {</span>
<a href="#l86.91"></a><span id="l86.91" class="difflineplus">+  if (data-&gt;output_file_stream) {</span>
<a href="#l86.92"></a><span id="l86.92">     data-&gt;output_file_stream-&gt;Close();</span>
<a href="#l86.93"></a><span id="l86.93">     data-&gt;output_file_stream = nullptr;</span>
<a href="#l86.94"></a><span id="l86.94">   }</span>
<a href="#l86.95"></a><span id="l86.95"> }</span>
<a href="#l86.96"></a><span id="l86.96"> </span>
<a href="#l86.97"></a><span id="l86.97" class="difflineminus">-</span>
<a href="#l86.98"></a><span id="l86.98" class="difflineminus">-void</span>
<a href="#l86.99"></a><span id="l86.99" class="difflineminus">-MimePartBufferReset (MimePartBufferData *data)</span>
<a href="#l86.100"></a><span id="l86.100" class="difflineminus">-{</span>
<a href="#l86.101"></a><span id="l86.101" class="difflineplus">+void MimePartBufferReset(MimePartBufferData *data) {</span>
<a href="#l86.102"></a><span id="l86.102">   NS_ASSERTION(data, &quot;MimePartBufferReset: no data&quot;);</span>
<a href="#l86.103"></a><span id="l86.103">   if (!data) return;</span>
<a href="#l86.104"></a><span id="l86.104"> </span>
<a href="#l86.105"></a><span id="l86.105">   PR_FREEIF(data-&gt;part_buffer);</span>
<a href="#l86.106"></a><span id="l86.106">   data-&gt;part_buffer_fp = 0;</span>
<a href="#l86.107"></a><span id="l86.107"> </span>
<a href="#l86.108"></a><span id="l86.108" class="difflineminus">-  if (data-&gt;input_file_stream)</span>
<a href="#l86.109"></a><span id="l86.109" class="difflineminus">-  {</span>
<a href="#l86.110"></a><span id="l86.110" class="difflineplus">+  if (data-&gt;input_file_stream) {</span>
<a href="#l86.111"></a><span id="l86.111">     data-&gt;input_file_stream-&gt;Close();</span>
<a href="#l86.112"></a><span id="l86.112">     data-&gt;input_file_stream = nullptr;</span>
<a href="#l86.113"></a><span id="l86.113">   }</span>
<a href="#l86.114"></a><span id="l86.114"> </span>
<a href="#l86.115"></a><span id="l86.115" class="difflineminus">-  if (data-&gt;output_file_stream)</span>
<a href="#l86.116"></a><span id="l86.116" class="difflineminus">-  {</span>
<a href="#l86.117"></a><span id="l86.117" class="difflineplus">+  if (data-&gt;output_file_stream) {</span>
<a href="#l86.118"></a><span id="l86.118">     data-&gt;output_file_stream-&gt;Close();</span>
<a href="#l86.119"></a><span id="l86.119">     data-&gt;output_file_stream = nullptr;</span>
<a href="#l86.120"></a><span id="l86.120">   }</span>
<a href="#l86.121"></a><span id="l86.121"> </span>
<a href="#l86.122"></a><span id="l86.122" class="difflineminus">-  if (data-&gt;file_buffer)</span>
<a href="#l86.123"></a><span id="l86.123" class="difflineminus">-  {</span>
<a href="#l86.124"></a><span id="l86.124" class="difflineplus">+  if (data-&gt;file_buffer) {</span>
<a href="#l86.125"></a><span id="l86.125">     data-&gt;file_buffer-&gt;Remove(false);</span>
<a href="#l86.126"></a><span id="l86.126">     data-&gt;file_buffer = nullptr;</span>
<a href="#l86.127"></a><span id="l86.127">   }</span>
<a href="#l86.128"></a><span id="l86.128"> }</span>
<a href="#l86.129"></a><span id="l86.129"> </span>
<a href="#l86.130"></a><span id="l86.130" class="difflineminus">-</span>
<a href="#l86.131"></a><span id="l86.131" class="difflineminus">-void</span>
<a href="#l86.132"></a><span id="l86.132" class="difflineminus">-MimePartBufferDestroy (MimePartBufferData *data)</span>
<a href="#l86.133"></a><span id="l86.133" class="difflineminus">-{</span>
<a href="#l86.134"></a><span id="l86.134" class="difflineplus">+void MimePartBufferDestroy(MimePartBufferData *data) {</span>
<a href="#l86.135"></a><span id="l86.135">   NS_ASSERTION(data, &quot;MimePartBufferDestroy: no data&quot;);</span>
<a href="#l86.136"></a><span id="l86.136">   if (!data) return;</span>
<a href="#l86.137"></a><span id="l86.137" class="difflineminus">-  MimePartBufferReset (data);</span>
<a href="#l86.138"></a><span id="l86.138" class="difflineplus">+  MimePartBufferReset(data);</span>
<a href="#l86.139"></a><span id="l86.139">   delete data;</span>
<a href="#l86.140"></a><span id="l86.140"> }</span>
<a href="#l86.141"></a><span id="l86.141"> </span>
<a href="#l86.142"></a><span id="l86.142" class="difflineminus">-</span>
<a href="#l86.143"></a><span id="l86.143" class="difflineminus">-int</span>
<a href="#l86.144"></a><span id="l86.144" class="difflineminus">-MimePartBufferWrite (MimePartBufferData *data,</span>
<a href="#l86.145"></a><span id="l86.145" class="difflineminus">-           const char *buf, int32_t size)</span>
<a href="#l86.146"></a><span id="l86.146" class="difflineminus">-{</span>
<a href="#l86.147"></a><span id="l86.147" class="difflineplus">+int MimePartBufferWrite(MimePartBufferData *data, const char *buf,</span>
<a href="#l86.148"></a><span id="l86.148" class="difflineplus">+                        int32_t size) {</span>
<a href="#l86.149"></a><span id="l86.149">   NS_ASSERTION(data &amp;&amp; buf &amp;&amp; size &gt; 0, &quot;MimePartBufferWrite: Bad param&quot;);</span>
<a href="#l86.150"></a><span id="l86.150" class="difflineminus">-  if (!data || !buf || size &lt;= 0)</span>
<a href="#l86.151"></a><span id="l86.151" class="difflineminus">-    return -1;</span>
<a href="#l86.152"></a><span id="l86.152" class="difflineplus">+  if (!data || !buf || size &lt;= 0) return -1;</span>
<a href="#l86.153"></a><span id="l86.153"> </span>
<a href="#l86.154"></a><span id="l86.154">   /* If we don't yet have a buffer (either memory or file) try and make a</span>
<a href="#l86.155"></a><span id="l86.155">     memory buffer.</span>
<a href="#l86.156"></a><span id="l86.156">     */</span>
<a href="#l86.157"></a><span id="l86.157" class="difflineminus">-  if (!data-&gt;part_buffer &amp;&amp;</span>
<a href="#l86.158"></a><span id="l86.158" class="difflineminus">-      !data-&gt;file_buffer)</span>
<a href="#l86.159"></a><span id="l86.159" class="difflineminus">-  {</span>
<a href="#l86.160"></a><span id="l86.160" class="difflineplus">+  if (!data-&gt;part_buffer &amp;&amp; !data-&gt;file_buffer) {</span>
<a href="#l86.161"></a><span id="l86.161">     int target_size = TARGET_MEMORY_BUFFER_SIZE;</span>
<a href="#l86.162"></a><span id="l86.162" class="difflineminus">-    while (target_size &gt; 0)</span>
<a href="#l86.163"></a><span id="l86.163" class="difflineminus">-    {</span>
<a href="#l86.164"></a><span id="l86.164" class="difflineminus">-      data-&gt;part_buffer = (char *) PR_MALLOC(target_size);</span>
<a href="#l86.165"></a><span id="l86.165" class="difflineminus">-      if (data-&gt;part_buffer) break;          /* got it! */</span>
<a href="#l86.166"></a><span id="l86.166" class="difflineminus">-      target_size -= TARGET_MEMORY_BUFFER_QUANTUM;  /* decrease it and try</span>
<a href="#l86.167"></a><span id="l86.167" class="difflineminus">-        again */</span>
<a href="#l86.168"></a><span id="l86.168" class="difflineplus">+    while (target_size &gt; 0) {</span>
<a href="#l86.169"></a><span id="l86.169" class="difflineplus">+      data-&gt;part_buffer = (char *)PR_MALLOC(target_size);</span>
<a href="#l86.170"></a><span id="l86.170" class="difflineplus">+      if (data-&gt;part_buffer) break;                /* got it! */</span>
<a href="#l86.171"></a><span id="l86.171" class="difflineplus">+      target_size -= TARGET_MEMORY_BUFFER_QUANTUM; /* decrease it and try</span>
<a href="#l86.172"></a><span id="l86.172" class="difflineplus">+       again */</span>
<a href="#l86.173"></a><span id="l86.173">     }</span>
<a href="#l86.174"></a><span id="l86.174"> </span>
<a href="#l86.175"></a><span id="l86.175">     if (data-&gt;part_buffer)</span>
<a href="#l86.176"></a><span id="l86.176">       data-&gt;part_buffer_size = target_size;</span>
<a href="#l86.177"></a><span id="l86.177">     else</span>
<a href="#l86.178"></a><span id="l86.178">       data-&gt;part_buffer_size = 0;</span>
<a href="#l86.179"></a><span id="l86.179"> </span>
<a href="#l86.180"></a><span id="l86.180">     data-&gt;part_buffer_fp = 0;</span>
<a href="#l86.181"></a><span id="l86.181">   }</span>
<a href="#l86.182"></a><span id="l86.182"> </span>
<a href="#l86.183"></a><span id="l86.183">   /* Ok, if at this point we still don't have either kind of buffer, try and</span>
<a href="#l86.184"></a><span id="l86.184">     make a file buffer. */</span>
<a href="#l86.185"></a><span id="l86.185" class="difflineminus">-  if (!data-&gt;part_buffer &amp;&amp; !data-&gt;file_buffer)</span>
<a href="#l86.186"></a><span id="l86.186" class="difflineminus">-  {</span>
<a href="#l86.187"></a><span id="l86.187" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l86.188"></a><span id="l86.188" class="difflineplus">+  if (!data-&gt;part_buffer &amp;&amp; !data-&gt;file_buffer) {</span>
<a href="#l86.189"></a><span id="l86.189" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l86.190"></a><span id="l86.190">     nsresult rv = nsMsgCreateTempFile(&quot;nsma&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l86.191"></a><span id="l86.191">     NS_ENSURE_SUCCESS(rv, MIME_UNABLE_TO_OPEN_TMP_FILE);</span>
<a href="#l86.192"></a><span id="l86.192">     data-&gt;file_buffer = tmpFile;</span>
<a href="#l86.193"></a><span id="l86.193"> </span>
<a href="#l86.194"></a><span id="l86.194" class="difflineminus">-    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(data-&gt;output_file_stream), data-&gt;file_buffer, PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l86.195"></a><span id="l86.195" class="difflineplus">+    rv = MsgNewBufferedFileOutputStream(</span>
<a href="#l86.196"></a><span id="l86.196" class="difflineplus">+        getter_AddRefs(data-&gt;output_file_stream), data-&gt;file_buffer,</span>
<a href="#l86.197"></a><span id="l86.197" class="difflineplus">+        PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l86.198"></a><span id="l86.198">     NS_ENSURE_SUCCESS(rv, MIME_UNABLE_TO_OPEN_TMP_FILE);</span>
<a href="#l86.199"></a><span id="l86.199">   }</span>
<a href="#l86.200"></a><span id="l86.200"> </span>
<a href="#l86.201"></a><span id="l86.201" class="difflineminus">-  NS_ASSERTION(data-&gt;part_buffer || data-&gt;output_file_stream, &quot;no part_buffer or file_stream&quot;);</span>
<a href="#l86.202"></a><span id="l86.202" class="difflineplus">+  NS_ASSERTION(data-&gt;part_buffer || data-&gt;output_file_stream,</span>
<a href="#l86.203"></a><span id="l86.203" class="difflineplus">+               &quot;no part_buffer or file_stream&quot;);</span>
<a href="#l86.204"></a><span id="l86.204"> </span>
<a href="#l86.205"></a><span id="l86.205">   /* If this buf will fit in the memory buffer, put it there.</span>
<a href="#l86.206"></a><span id="l86.206" class="difflineminus">-    */</span>
<a href="#l86.207"></a><span id="l86.207" class="difflineplus">+   */</span>
<a href="#l86.208"></a><span id="l86.208">   if (data-&gt;part_buffer &amp;&amp;</span>
<a href="#l86.209"></a><span id="l86.209" class="difflineminus">-      data-&gt;part_buffer_fp + size &lt; data-&gt;part_buffer_size)</span>
<a href="#l86.210"></a><span id="l86.210" class="difflineminus">-  {</span>
<a href="#l86.211"></a><span id="l86.211" class="difflineminus">-    memcpy(data-&gt;part_buffer + data-&gt;part_buffer_fp,</span>
<a href="#l86.212"></a><span id="l86.212" class="difflineminus">-           buf, size);</span>
<a href="#l86.213"></a><span id="l86.213" class="difflineplus">+      data-&gt;part_buffer_fp + size &lt; data-&gt;part_buffer_size) {</span>
<a href="#l86.214"></a><span id="l86.214" class="difflineplus">+    memcpy(data-&gt;part_buffer + data-&gt;part_buffer_fp, buf, size);</span>
<a href="#l86.215"></a><span id="l86.215">     data-&gt;part_buffer_fp += size;</span>
<a href="#l86.216"></a><span id="l86.216">   }</span>
<a href="#l86.217"></a><span id="l86.217"> </span>
<a href="#l86.218"></a><span id="l86.218">   /* Otherwise it won't fit; write it to the file instead. */</span>
<a href="#l86.219"></a><span id="l86.219" class="difflineminus">-  else</span>
<a href="#l86.220"></a><span id="l86.220" class="difflineminus">-  {</span>
<a href="#l86.221"></a><span id="l86.221" class="difflineplus">+  else {</span>
<a href="#l86.222"></a><span id="l86.222">     /* If the file isn't open yet, open it, and dump the memory buffer</span>
<a href="#l86.223"></a><span id="l86.223">     to it. */</span>
<a href="#l86.224"></a><span id="l86.224" class="difflineminus">-    if (!data-&gt;output_file_stream)</span>
<a href="#l86.225"></a><span id="l86.225" class="difflineminus">-    {</span>
<a href="#l86.226"></a><span id="l86.226" class="difflineplus">+    if (!data-&gt;output_file_stream) {</span>
<a href="#l86.227"></a><span id="l86.227">       nsresult rv;</span>
<a href="#l86.228"></a><span id="l86.228" class="difflineminus">-      if (!data-&gt;file_buffer)</span>
<a href="#l86.229"></a><span id="l86.229" class="difflineminus">-      {</span>
<a href="#l86.230"></a><span id="l86.230" class="difflineminus">-        nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l86.231"></a><span id="l86.231" class="difflineplus">+      if (!data-&gt;file_buffer) {</span>
<a href="#l86.232"></a><span id="l86.232" class="difflineplus">+        nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l86.233"></a><span id="l86.233">         rv = nsMsgCreateTempFile(&quot;nsma&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l86.234"></a><span id="l86.234">         NS_ENSURE_SUCCESS(rv, MIME_UNABLE_TO_OPEN_TMP_FILE);</span>
<a href="#l86.235"></a><span id="l86.235">         data-&gt;file_buffer = tmpFile;</span>
<a href="#l86.236"></a><span id="l86.236" class="difflineminus">-</span>
<a href="#l86.237"></a><span id="l86.237">       }</span>
<a href="#l86.238"></a><span id="l86.238"> </span>
<a href="#l86.239"></a><span id="l86.239" class="difflineminus">-      rv = MsgNewBufferedFileOutputStream(getter_AddRefs(data-&gt;output_file_stream), data-&gt;file_buffer, PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l86.240"></a><span id="l86.240" class="difflineplus">+      rv = MsgNewBufferedFileOutputStream(</span>
<a href="#l86.241"></a><span id="l86.241" class="difflineplus">+          getter_AddRefs(data-&gt;output_file_stream), data-&gt;file_buffer,</span>
<a href="#l86.242"></a><span id="l86.242" class="difflineplus">+          PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l86.243"></a><span id="l86.243">       NS_ENSURE_SUCCESS(rv, MIME_UNABLE_TO_OPEN_TMP_FILE);</span>
<a href="#l86.244"></a><span id="l86.244"> </span>
<a href="#l86.245"></a><span id="l86.245" class="difflineminus">-      if (data-&gt;part_buffer &amp;&amp; data-&gt;part_buffer_fp)</span>
<a href="#l86.246"></a><span id="l86.246" class="difflineminus">-      {</span>
<a href="#l86.247"></a><span id="l86.247" class="difflineplus">+      if (data-&gt;part_buffer &amp;&amp; data-&gt;part_buffer_fp) {</span>
<a href="#l86.248"></a><span id="l86.248">         uint32_t bytesWritten;</span>
<a href="#l86.249"></a><span id="l86.249" class="difflineminus">-        nsresult rv = data-&gt;output_file_stream-&gt;Write(data-&gt;part_buffer,</span>
<a href="#l86.250"></a><span id="l86.250" class="difflineminus">-                                                 data-&gt;part_buffer_fp, &amp;bytesWritten);</span>
<a href="#l86.251"></a><span id="l86.251" class="difflineplus">+        nsresult rv = data-&gt;output_file_stream-&gt;Write(</span>
<a href="#l86.252"></a><span id="l86.252" class="difflineplus">+            data-&gt;part_buffer, data-&gt;part_buffer_fp, &amp;bytesWritten);</span>
<a href="#l86.253"></a><span id="l86.253">         NS_ENSURE_SUCCESS(rv, MIME_ERROR_WRITING_FILE);</span>
<a href="#l86.254"></a><span id="l86.254">       }</span>
<a href="#l86.255"></a><span id="l86.255"> </span>
<a href="#l86.256"></a><span id="l86.256">       PR_FREEIF(data-&gt;part_buffer);</span>
<a href="#l86.257"></a><span id="l86.257">       data-&gt;part_buffer_fp = 0;</span>
<a href="#l86.258"></a><span id="l86.258">       data-&gt;part_buffer_size = 0;</span>
<a href="#l86.259"></a><span id="l86.259">     }</span>
<a href="#l86.260"></a><span id="l86.260"> </span>
<a href="#l86.261"></a><span id="l86.261">     /* Dump this buf to the file. */</span>
<a href="#l86.262"></a><span id="l86.262">     uint32_t bytesWritten;</span>
<a href="#l86.263"></a><span id="l86.263" class="difflineminus">-    nsresult rv = data-&gt;output_file_stream-&gt;Write (buf, size, &amp;bytesWritten);</span>
<a href="#l86.264"></a><span id="l86.264" class="difflineminus">-    if (NS_FAILED(rv) || (int32_t) bytesWritten &lt; size)</span>
<a href="#l86.265"></a><span id="l86.265" class="difflineplus">+    nsresult rv = data-&gt;output_file_stream-&gt;Write(buf, size, &amp;bytesWritten);</span>
<a href="#l86.266"></a><span id="l86.266" class="difflineplus">+    if (NS_FAILED(rv) || (int32_t)bytesWritten &lt; size)</span>
<a href="#l86.267"></a><span id="l86.267">       return MIME_OUT_OF_MEMORY;</span>
<a href="#l86.268"></a><span id="l86.268">   }</span>
<a href="#l86.269"></a><span id="l86.269"> </span>
<a href="#l86.270"></a><span id="l86.270">   return 0;</span>
<a href="#l86.271"></a><span id="l86.271"> }</span>
<a href="#l86.272"></a><span id="l86.272"> </span>
<a href="#l86.273"></a><span id="l86.273" class="difflineminus">-</span>
<a href="#l86.274"></a><span id="l86.274" class="difflineminus">-int</span>
<a href="#l86.275"></a><span id="l86.275" class="difflineminus">-MimePartBufferRead (MimePartBufferData *data,</span>
<a href="#l86.276"></a><span id="l86.276" class="difflineminus">-          MimeConverterOutputCallback read_fn,</span>
<a href="#l86.277"></a><span id="l86.277" class="difflineminus">-          void *closure)</span>
<a href="#l86.278"></a><span id="l86.278" class="difflineminus">-{</span>
<a href="#l86.279"></a><span id="l86.279" class="difflineplus">+int MimePartBufferRead(MimePartBufferData *data,</span>
<a href="#l86.280"></a><span id="l86.280" class="difflineplus">+                       MimeConverterOutputCallback read_fn, void *closure) {</span>
<a href="#l86.281"></a><span id="l86.281">   int status = 0;</span>
<a href="#l86.282"></a><span id="l86.282">   NS_ASSERTION(data, &quot;no data&quot;);</span>
<a href="#l86.283"></a><span id="l86.283">   if (!data) return -1;</span>
<a href="#l86.284"></a><span id="l86.284"> </span>
<a href="#l86.285"></a><span id="l86.285" class="difflineminus">-  if (data-&gt;part_buffer)</span>
<a href="#l86.286"></a><span id="l86.286" class="difflineminus">-  {</span>
<a href="#l86.287"></a><span id="l86.287" class="difflineplus">+  if (data-&gt;part_buffer) {</span>
<a href="#l86.288"></a><span id="l86.288">     // Read it out of memory.</span>
<a href="#l86.289"></a><span id="l86.289">     status = read_fn(data-&gt;part_buffer, data-&gt;part_buffer_fp, closure);</span>
<a href="#l86.290"></a><span id="l86.290" class="difflineminus">-  }</span>
<a href="#l86.291"></a><span id="l86.291" class="difflineminus">-  else if (data-&gt;file_buffer)</span>
<a href="#l86.292"></a><span id="l86.292" class="difflineminus">-  {</span>
<a href="#l86.293"></a><span id="l86.293" class="difflineplus">+  } else if (data-&gt;file_buffer) {</span>
<a href="#l86.294"></a><span id="l86.294">     /* Read it off disk.</span>
<a href="#l86.295"></a><span id="l86.295">      */</span>
<a href="#l86.296"></a><span id="l86.296">     char *buf;</span>
<a href="#l86.297"></a><span id="l86.297">     int32_t buf_size = DISK_BUFFER_SIZE;</span>
<a href="#l86.298"></a><span id="l86.298"> </span>
<a href="#l86.299"></a><span id="l86.299" class="difflineminus">-    NS_ASSERTION(data-&gt;part_buffer_size == 0 &amp;&amp; data-&gt;part_buffer_fp == 0, &quot;buffer size is not null&quot;);</span>
<a href="#l86.300"></a><span id="l86.300" class="difflineplus">+    NS_ASSERTION(data-&gt;part_buffer_size == 0 &amp;&amp; data-&gt;part_buffer_fp == 0,</span>
<a href="#l86.301"></a><span id="l86.301" class="difflineplus">+                 &quot;buffer size is not null&quot;);</span>
<a href="#l86.302"></a><span id="l86.302">     NS_ASSERTION(data-&gt;file_buffer, &quot;no file buffer name&quot;);</span>
<a href="#l86.303"></a><span id="l86.303" class="difflineminus">-    if (!data-&gt;file_buffer)</span>
<a href="#l86.304"></a><span id="l86.304" class="difflineminus">-      return -1;</span>
<a href="#l86.305"></a><span id="l86.305" class="difflineplus">+    if (!data-&gt;file_buffer) return -1;</span>
<a href="#l86.306"></a><span id="l86.306"> </span>
<a href="#l86.307"></a><span id="l86.307" class="difflineminus">-    buf = (char *) PR_MALLOC(buf_size);</span>
<a href="#l86.308"></a><span id="l86.308" class="difflineminus">-    if (!buf)</span>
<a href="#l86.309"></a><span id="l86.309" class="difflineminus">-      return MIME_OUT_OF_MEMORY;</span>
<a href="#l86.310"></a><span id="l86.310" class="difflineplus">+    buf = (char *)PR_MALLOC(buf_size);</span>
<a href="#l86.311"></a><span id="l86.311" class="difflineplus">+    if (!buf) return MIME_OUT_OF_MEMORY;</span>
<a href="#l86.312"></a><span id="l86.312"> </span>
<a href="#l86.313"></a><span id="l86.313">     // First, close the output file to open the input file!</span>
<a href="#l86.314"></a><span id="l86.314" class="difflineminus">-    if (data-&gt;output_file_stream)</span>
<a href="#l86.315"></a><span id="l86.315" class="difflineminus">-      data-&gt;output_file_stream-&gt;Close();</span>
<a href="#l86.316"></a><span id="l86.316" class="difflineplus">+    if (data-&gt;output_file_stream) data-&gt;output_file_stream-&gt;Close();</span>
<a href="#l86.317"></a><span id="l86.317"> </span>
<a href="#l86.318"></a><span id="l86.318" class="difflineminus">-    nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(data-&gt;input_file_stream), data-&gt;file_buffer);</span>
<a href="#l86.319"></a><span id="l86.319" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l86.320"></a><span id="l86.320" class="difflineminus">-    {</span>
<a href="#l86.321"></a><span id="l86.321" class="difflineplus">+    nsresult rv = NS_NewLocalFileInputStream(</span>
<a href="#l86.322"></a><span id="l86.322" class="difflineplus">+        getter_AddRefs(data-&gt;input_file_stream), data-&gt;file_buffer);</span>
<a href="#l86.323"></a><span id="l86.323" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l86.324"></a><span id="l86.324">       PR_Free(buf);</span>
<a href="#l86.325"></a><span id="l86.325">       return MIME_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l86.326"></a><span id="l86.326">     }</span>
<a href="#l86.327"></a><span id="l86.327" class="difflineminus">-    while(1)</span>
<a href="#l86.328"></a><span id="l86.328" class="difflineminus">-    {</span>
<a href="#l86.329"></a><span id="l86.329" class="difflineplus">+    while (1) {</span>
<a href="#l86.330"></a><span id="l86.330">       uint32_t bytesRead = 0;</span>
<a href="#l86.331"></a><span id="l86.331">       rv = data-&gt;input_file_stream-&gt;Read(buf, buf_size - 1, &amp;bytesRead);</span>
<a href="#l86.332"></a><span id="l86.332" class="difflineminus">-      if (NS_FAILED(rv) || !bytesRead)</span>
<a href="#l86.333"></a><span id="l86.333" class="difflineminus">-      {</span>
<a href="#l86.334"></a><span id="l86.334" class="difflineplus">+      if (NS_FAILED(rv) || !bytesRead) {</span>
<a href="#l86.335"></a><span id="l86.335">         break;</span>
<a href="#l86.336"></a><span id="l86.336" class="difflineminus">-      }</span>
<a href="#l86.337"></a><span id="l86.337" class="difflineminus">-      else</span>
<a href="#l86.338"></a><span id="l86.338" class="difflineminus">-      {</span>
<a href="#l86.339"></a><span id="l86.339" class="difflineplus">+      } else {</span>
<a href="#l86.340"></a><span id="l86.340">         /* It would be really nice to be able to yield here, and let</span>
<a href="#l86.341"></a><span id="l86.341">         some user events and other input sources get processed.</span>
<a href="#l86.342"></a><span id="l86.342">         Oh well. */</span>
<a href="#l86.343"></a><span id="l86.343"> </span>
<a href="#l86.344"></a><span id="l86.344" class="difflineminus">-        status = read_fn (buf, bytesRead, closure);</span>
<a href="#l86.345"></a><span id="l86.345" class="difflineplus">+        status = read_fn(buf, bytesRead, closure);</span>
<a href="#l86.346"></a><span id="l86.346">         if (status &lt; 0) break;</span>
<a href="#l86.347"></a><span id="l86.347">       }</span>
<a href="#l86.348"></a><span id="l86.348">     }</span>
<a href="#l86.349"></a><span id="l86.349">     PR_Free(buf);</span>
<a href="#l86.350"></a><span id="l86.350">   }</span>
<a href="#l86.351"></a><span id="l86.351"> </span>
<a href="#l86.352"></a><span id="l86.352">   return 0;</span>
<a href="#l86.353"></a><span id="l86.353"> }</span>
<a href="#l86.354"></a><span id="l86.354" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/mailnews/mime/src/mimepbuf.h</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/mailnews/mime/src/mimepbuf.h</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l87.4"></a><span id="l87.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l87.5"></a><span id="l87.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l87.6"></a><span id="l87.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l87.7"></a><span id="l87.7"> </span>
<a href="#l87.8"></a><span id="l87.8"> #ifndef _MIMEPBUF_H_</span>
<a href="#l87.9"></a><span id="l87.9"> #define _MIMEPBUF_H_</span>
<a href="#l87.10"></a><span id="l87.10"> </span>
<a href="#l87.11"></a><span id="l87.11"> #include &quot;mimei.h&quot;</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">-#include &quot;modmimee.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineplus">+#include &quot;modmimee.h&quot;  // for MimeConverterOutputCallback</span>
<a href="#l87.14"></a><span id="l87.14"> </span>
<a href="#l87.15"></a><span id="l87.15"> /* This file provides the ability to save up the entire contents of a MIME</span>
<a href="#l87.16"></a><span id="l87.16">    object (of arbitrary size), and then emit it all at once later.  The</span>
<a href="#l87.17"></a><span id="l87.17">    buffering is done in an efficient way that works well for both very large</span>
<a href="#l87.18"></a><span id="l87.18">    and very small objects.</span>
<a href="#l87.19"></a><span id="l87.19"> </span>
<a href="#l87.20"></a><span id="l87.20">    This is used in two places:</span>
<a href="#l87.21"></a><span id="l87.21"> </span>
<a href="#l87.22"></a><span id="l87.22" class="difflineat">@@ -24,41 +24,40 @@</span>
<a href="#l87.23"></a><span id="l87.23"> */</span>
<a href="#l87.24"></a><span id="l87.24"> </span>
<a href="#l87.25"></a><span id="l87.25"> /* An opaque object used to represent the buffered data.</span>
<a href="#l87.26"></a><span id="l87.26">  */</span>
<a href="#l87.27"></a><span id="l87.27"> typedef struct MimePartBufferData MimePartBufferData;</span>
<a href="#l87.28"></a><span id="l87.28"> </span>
<a href="#l87.29"></a><span id="l87.29"> /* Create an empty part buffer object.</span>
<a href="#l87.30"></a><span id="l87.30">  */</span>
<a href="#l87.31"></a><span id="l87.31" class="difflineminus">-extern MimePartBufferData *MimePartBufferCreate (void);</span>
<a href="#l87.32"></a><span id="l87.32" class="difflineplus">+extern MimePartBufferData *MimePartBufferCreate(void);</span>
<a href="#l87.33"></a><span id="l87.33"> </span>
<a href="#l87.34"></a><span id="l87.34"> /* Assert that the buffer is now full (EOF has been reached on the current</span>
<a href="#l87.35"></a><span id="l87.35">    part.)  This will free some resources, but leaves the part in the buffer.</span>
<a href="#l87.36"></a><span id="l87.36">    After calling MimePartBufferReset, the buffer may be used to store a</span>
<a href="#l87.37"></a><span id="l87.37">    different object.</span>
<a href="#l87.38"></a><span id="l87.38">  */</span>
<a href="#l87.39"></a><span id="l87.39" class="difflineminus">-void MimePartBufferClose (MimePartBufferData *data);</span>
<a href="#l87.40"></a><span id="l87.40" class="difflineplus">+void MimePartBufferClose(MimePartBufferData *data);</span>
<a href="#l87.41"></a><span id="l87.41"> </span>
<a href="#l87.42"></a><span id="l87.42"> /* Reset a part buffer object to the default state, discarding any currently-</span>
<a href="#l87.43"></a><span id="l87.43">    buffered data.</span>
<a href="#l87.44"></a><span id="l87.44">  */</span>
<a href="#l87.45"></a><span id="l87.45" class="difflineminus">-extern void MimePartBufferReset (MimePartBufferData *data);</span>
<a href="#l87.46"></a><span id="l87.46" class="difflineplus">+extern void MimePartBufferReset(MimePartBufferData *data);</span>
<a href="#l87.47"></a><span id="l87.47"> </span>
<a href="#l87.48"></a><span id="l87.48"> /* Free the part buffer itself, and discard any buffered data.</span>
<a href="#l87.49"></a><span id="l87.49">  */</span>
<a href="#l87.50"></a><span id="l87.50" class="difflineminus">-extern void MimePartBufferDestroy (MimePartBufferData *data);</span>
<a href="#l87.51"></a><span id="l87.51" class="difflineplus">+extern void MimePartBufferDestroy(MimePartBufferData *data);</span>
<a href="#l87.52"></a><span id="l87.52"> </span>
<a href="#l87.53"></a><span id="l87.53"> /* Push a chunk of a MIME object into the buffer.</span>
<a href="#l87.54"></a><span id="l87.54">  */</span>
<a href="#l87.55"></a><span id="l87.55" class="difflineminus">-extern int MimePartBufferWrite (MimePartBufferData *data,</span>
<a href="#l87.56"></a><span id="l87.56" class="difflineminus">-                const char *buf, int32_t size);</span>
<a href="#l87.57"></a><span id="l87.57" class="difflineplus">+extern int MimePartBufferWrite(MimePartBufferData *data, const char *buf,</span>
<a href="#l87.58"></a><span id="l87.58" class="difflineplus">+                               int32_t size);</span>
<a href="#l87.59"></a><span id="l87.59"> </span>
<a href="#l87.60"></a><span id="l87.60"> /* Read the contents of the buffer back out.  This will invoke the provided</span>
<a href="#l87.61"></a><span id="l87.61">    read_fn with successive chunks of data until the buffer has been drained.</span>
<a href="#l87.62"></a><span id="l87.62">    The provided function may be called once, or multiple times.</span>
<a href="#l87.63"></a><span id="l87.63">  */</span>
<a href="#l87.64"></a><span id="l87.64" class="difflineminus">-extern int</span>
<a href="#l87.65"></a><span id="l87.65" class="difflineminus">-MimePartBufferRead (MimePartBufferData *data,</span>
<a href="#l87.66"></a><span id="l87.66" class="difflineminus">-          MimeConverterOutputCallback read_fn,</span>
<a href="#l87.67"></a><span id="l87.67" class="difflineminus">-          void *closure);</span>
<a href="#l87.68"></a><span id="l87.68" class="difflineplus">+extern int MimePartBufferRead(MimePartBufferData *data,</span>
<a href="#l87.69"></a><span id="l87.69" class="difflineplus">+                              MimeConverterOutputCallback read_fn,</span>
<a href="#l87.70"></a><span id="l87.70" class="difflineplus">+                              void *closure);</span>
<a href="#l87.71"></a><span id="l87.71"> </span>
<a href="#l87.72"></a><span id="l87.72"> #endif /* _MIMEPBUF_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/mailnews/mime/src/mimesun.cpp</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/mailnews/mime/src/mimesun.cpp</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -8,197 +8,174 @@</span>
<a href="#l88.4"></a><span id="l88.4"> #include &quot;plstr.h&quot;</span>
<a href="#l88.5"></a><span id="l88.5"> #include &quot;prlog.h&quot;</span>
<a href="#l88.6"></a><span id="l88.6"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l88.7"></a><span id="l88.7"> #include &quot;msgCore.h&quot;</span>
<a href="#l88.8"></a><span id="l88.8"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l88.9"></a><span id="l88.9"> #include &lt;ctype.h&gt;</span>
<a href="#l88.10"></a><span id="l88.10"> </span>
<a href="#l88.11"></a><span id="l88.11"> #define MIME_SUPERCLASS mimeMultipartClass</span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">-MimeDefClass(MimeSunAttachment, MimeSunAttachmentClass,</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineminus">-       mimeSunAttachmentClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l88.14"></a><span id="l88.14" class="difflineplus">+MimeDefClass(MimeSunAttachment, MimeSunAttachmentClass, mimeSunAttachmentClass,</span>
<a href="#l88.15"></a><span id="l88.15" class="difflineplus">+             &amp;MIME_SUPERCLASS);</span>
<a href="#l88.16"></a><span id="l88.16"> </span>
<a href="#l88.17"></a><span id="l88.17"> static MimeMultipartBoundaryType MimeSunAttachment_check_boundary(MimeObject *,</span>
<a href="#l88.18"></a><span id="l88.18" class="difflineminus">-                                  const char *,</span>
<a href="#l88.19"></a><span id="l88.19" class="difflineminus">-                                  int32_t);</span>
<a href="#l88.20"></a><span id="l88.20" class="difflineplus">+                                                                  const char *,</span>
<a href="#l88.21"></a><span id="l88.21" class="difflineplus">+                                                                  int32_t);</span>
<a href="#l88.22"></a><span id="l88.22"> static int MimeSunAttachment_create_child(MimeObject *);</span>
<a href="#l88.23"></a><span id="l88.23" class="difflineminus">-static int MimeSunAttachment_parse_child_line (MimeObject *, const char *, int32_t,</span>
<a href="#l88.24"></a><span id="l88.24" class="difflineminus">-                         bool);</span>
<a href="#l88.25"></a><span id="l88.25" class="difflineminus">-static int MimeSunAttachment_parse_begin (MimeObject *);</span>
<a href="#l88.26"></a><span id="l88.26" class="difflineminus">-static int MimeSunAttachment_parse_eof (MimeObject *, bool);</span>
<a href="#l88.27"></a><span id="l88.27" class="difflineplus">+static int MimeSunAttachment_parse_child_line(MimeObject *, const char *,</span>
<a href="#l88.28"></a><span id="l88.28" class="difflineplus">+                                              int32_t, bool);</span>
<a href="#l88.29"></a><span id="l88.29" class="difflineplus">+static int MimeSunAttachment_parse_begin(MimeObject *);</span>
<a href="#l88.30"></a><span id="l88.30" class="difflineplus">+static int MimeSunAttachment_parse_eof(MimeObject *, bool);</span>
<a href="#l88.31"></a><span id="l88.31"> </span>
<a href="#l88.32"></a><span id="l88.32" class="difflineminus">-static int</span>
<a href="#l88.33"></a><span id="l88.33" class="difflineminus">-MimeSunAttachmentClassInitialize(MimeSunAttachmentClass *clazz)</span>
<a href="#l88.34"></a><span id="l88.34" class="difflineminus">-{</span>
<a href="#l88.35"></a><span id="l88.35" class="difflineminus">-  MimeObjectClass    *oclass = (MimeObjectClass *)    clazz;</span>
<a href="#l88.36"></a><span id="l88.36" class="difflineminus">-  MimeMultipartClass *mclass = (MimeMultipartClass *) clazz;</span>
<a href="#l88.37"></a><span id="l88.37" class="difflineplus">+static int MimeSunAttachmentClassInitialize(MimeSunAttachmentClass *clazz) {</span>
<a href="#l88.38"></a><span id="l88.38" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l88.39"></a><span id="l88.39" class="difflineplus">+  MimeMultipartClass *mclass = (MimeMultipartClass *)clazz;</span>
<a href="#l88.40"></a><span id="l88.40"> </span>
<a href="#l88.41"></a><span id="l88.41">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l88.42"></a><span id="l88.42" class="difflineminus">-  oclass-&gt;parse_begin      = MimeSunAttachment_parse_begin;</span>
<a href="#l88.43"></a><span id="l88.43" class="difflineminus">-  oclass-&gt;parse_eof        = MimeSunAttachment_parse_eof;</span>
<a href="#l88.44"></a><span id="l88.44" class="difflineminus">-  mclass-&gt;check_boundary   = MimeSunAttachment_check_boundary;</span>
<a href="#l88.45"></a><span id="l88.45" class="difflineminus">-  mclass-&gt;create_child     = MimeSunAttachment_create_child;</span>
<a href="#l88.46"></a><span id="l88.46" class="difflineplus">+  oclass-&gt;parse_begin = MimeSunAttachment_parse_begin;</span>
<a href="#l88.47"></a><span id="l88.47" class="difflineplus">+  oclass-&gt;parse_eof = MimeSunAttachment_parse_eof;</span>
<a href="#l88.48"></a><span id="l88.48" class="difflineplus">+  mclass-&gt;check_boundary = MimeSunAttachment_check_boundary;</span>
<a href="#l88.49"></a><span id="l88.49" class="difflineplus">+  mclass-&gt;create_child = MimeSunAttachment_create_child;</span>
<a href="#l88.50"></a><span id="l88.50">   mclass-&gt;parse_child_line = MimeSunAttachment_parse_child_line;</span>
<a href="#l88.51"></a><span id="l88.51">   return 0;</span>
<a href="#l88.52"></a><span id="l88.52"> }</span>
<a href="#l88.53"></a><span id="l88.53"> </span>
<a href="#l88.54"></a><span id="l88.54" class="difflineminus">-</span>
<a href="#l88.55"></a><span id="l88.55" class="difflineminus">-static int</span>
<a href="#l88.56"></a><span id="l88.56" class="difflineminus">-MimeSunAttachment_parse_begin (MimeObject *obj)</span>
<a href="#l88.57"></a><span id="l88.57" class="difflineminus">-{</span>
<a href="#l88.58"></a><span id="l88.58" class="difflineminus">-  int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l88.59"></a><span id="l88.59" class="difflineplus">+static int MimeSunAttachment_parse_begin(MimeObject *obj) {</span>
<a href="#l88.60"></a><span id="l88.60" class="difflineplus">+  int status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l88.61"></a><span id="l88.61">   if (status &lt; 0) return status;</span>
<a href="#l88.62"></a><span id="l88.62"> </span>
<a href="#l88.63"></a><span id="l88.63">   /* Sun messages always have separators at the beginning. */</span>
<a href="#l88.64"></a><span id="l88.64">   return MimeObject_write_separator(obj);</span>
<a href="#l88.65"></a><span id="l88.65"> }</span>
<a href="#l88.66"></a><span id="l88.66"> </span>
<a href="#l88.67"></a><span id="l88.67" class="difflineminus">-static int</span>
<a href="#l88.68"></a><span id="l88.68" class="difflineminus">-MimeSunAttachment_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l88.69"></a><span id="l88.69" class="difflineminus">-{</span>
<a href="#l88.70"></a><span id="l88.70" class="difflineplus">+static int MimeSunAttachment_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l88.71"></a><span id="l88.71">   int status = 0;</span>
<a href="#l88.72"></a><span id="l88.72"> </span>
<a href="#l88.73"></a><span id="l88.73" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l88.74"></a><span id="l88.74" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l88.75"></a><span id="l88.75">   if (status &lt; 0) return status;</span>
<a href="#l88.76"></a><span id="l88.76"> </span>
<a href="#l88.77"></a><span id="l88.77">   /* Sun messages always have separators at the end. */</span>
<a href="#l88.78"></a><span id="l88.78" class="difflineminus">-  if (!abort_p)</span>
<a href="#l88.79"></a><span id="l88.79" class="difflineminus">-  {</span>
<a href="#l88.80"></a><span id="l88.80" class="difflineplus">+  if (!abort_p) {</span>
<a href="#l88.81"></a><span id="l88.81">     status = MimeObject_write_separator(obj);</span>
<a href="#l88.82"></a><span id="l88.82">     if (status &lt; 0) return status;</span>
<a href="#l88.83"></a><span id="l88.83">   }</span>
<a href="#l88.84"></a><span id="l88.84"> </span>
<a href="#l88.85"></a><span id="l88.85">   return 0;</span>
<a href="#l88.86"></a><span id="l88.86"> }</span>
<a href="#l88.87"></a><span id="l88.87"> </span>
<a href="#l88.88"></a><span id="l88.88" class="difflineminus">-</span>
<a href="#l88.89"></a><span id="l88.89" class="difflineminus">-static MimeMultipartBoundaryType</span>
<a href="#l88.90"></a><span id="l88.90" class="difflineminus">-MimeSunAttachment_check_boundary(MimeObject *obj, const char *line,</span>
<a href="#l88.91"></a><span id="l88.91" class="difflineminus">-                 int32_t length)</span>
<a href="#l88.92"></a><span id="l88.92" class="difflineminus">-{</span>
<a href="#l88.93"></a><span id="l88.93" class="difflineplus">+static MimeMultipartBoundaryType MimeSunAttachment_check_boundary(</span>
<a href="#l88.94"></a><span id="l88.94" class="difflineplus">+    MimeObject *obj, const char *line, int32_t length) {</span>
<a href="#l88.95"></a><span id="l88.95">   /* ten dashes */</span>
<a href="#l88.96"></a><span id="l88.96"> </span>
<a href="#l88.97"></a><span id="l88.97" class="difflineminus">-  if (line &amp;&amp;</span>
<a href="#l88.98"></a><span id="l88.98" class="difflineminus">-    line[0] == '-' &amp;&amp; line[1] == '-' &amp;&amp; line[2] == '-' &amp;&amp; line[3] == '-' &amp;&amp;</span>
<a href="#l88.99"></a><span id="l88.99" class="difflineminus">-    line[4] == '-' &amp;&amp; line[5] == '-' &amp;&amp; line[6] == '-' &amp;&amp; line[7] == '-' &amp;&amp;</span>
<a href="#l88.100"></a><span id="l88.100" class="difflineminus">-    line[8] == '-' &amp;&amp; line[9] == '-' &amp;&amp;</span>
<a href="#l88.101"></a><span id="l88.101" class="difflineminus">-    (line[10] == '\r' || line[10] == '\n'))</span>
<a href="#l88.102"></a><span id="l88.102" class="difflineminus">-  return MimeMultipartBoundaryTypeSeparator;</span>
<a href="#l88.103"></a><span id="l88.103" class="difflineplus">+  if (line &amp;&amp; line[0] == '-' &amp;&amp; line[1] == '-' &amp;&amp; line[2] == '-' &amp;&amp;</span>
<a href="#l88.104"></a><span id="l88.104" class="difflineplus">+      line[3] == '-' &amp;&amp; line[4] == '-' &amp;&amp; line[5] == '-' &amp;&amp; line[6] == '-' &amp;&amp;</span>
<a href="#l88.105"></a><span id="l88.105" class="difflineplus">+      line[7] == '-' &amp;&amp; line[8] == '-' &amp;&amp; line[9] == '-' &amp;&amp;</span>
<a href="#l88.106"></a><span id="l88.106" class="difflineplus">+      (line[10] == '\r' || line[10] == '\n'))</span>
<a href="#l88.107"></a><span id="l88.107" class="difflineplus">+    return MimeMultipartBoundaryTypeSeparator;</span>
<a href="#l88.108"></a><span id="l88.108">   else</span>
<a href="#l88.109"></a><span id="l88.109" class="difflineminus">-  return MimeMultipartBoundaryTypeNone;</span>
<a href="#l88.110"></a><span id="l88.110" class="difflineplus">+    return MimeMultipartBoundaryTypeNone;</span>
<a href="#l88.111"></a><span id="l88.111"> }</span>
<a href="#l88.112"></a><span id="l88.112"> </span>
<a href="#l88.113"></a><span id="l88.113" class="difflineminus">-</span>
<a href="#l88.114"></a><span id="l88.114" class="difflineminus">-static int</span>
<a href="#l88.115"></a><span id="l88.115" class="difflineminus">-MimeSunAttachment_create_child(MimeObject *obj)</span>
<a href="#l88.116"></a><span id="l88.116" class="difflineminus">-{</span>
<a href="#l88.117"></a><span id="l88.117" class="difflineminus">-  MimeMultipart *mult = (MimeMultipart *) obj;</span>
<a href="#l88.118"></a><span id="l88.118" class="difflineplus">+static int MimeSunAttachment_create_child(MimeObject *obj) {</span>
<a href="#l88.119"></a><span id="l88.119" class="difflineplus">+  MimeMultipart *mult = (MimeMultipart *)obj;</span>
<a href="#l88.120"></a><span id="l88.120">   int status = 0;</span>
<a href="#l88.121"></a><span id="l88.121"> </span>
<a href="#l88.122"></a><span id="l88.122">   char *sun_data_type = 0;</span>
<a href="#l88.123"></a><span id="l88.123">   const char *mime_ct = 0, *sun_enc_info = 0, *mime_cte = 0;</span>
<a href="#l88.124"></a><span id="l88.124" class="difflineminus">-  char *mime_ct2 = 0;    /* sometimes we need to copy; this is for freeing. */</span>
<a href="#l88.125"></a><span id="l88.125" class="difflineplus">+  char *mime_ct2 = 0; /* sometimes we need to copy; this is for freeing. */</span>
<a href="#l88.126"></a><span id="l88.126">   MimeObject *child = 0;</span>
<a href="#l88.127"></a><span id="l88.127"> </span>
<a href="#l88.128"></a><span id="l88.128">   mult-&gt;state = MimeMultipartPartLine;</span>
<a href="#l88.129"></a><span id="l88.129"> </span>
<a href="#l88.130"></a><span id="l88.130" class="difflineminus">-  sun_data_type = (mult-&gt;hdrs</span>
<a href="#l88.131"></a><span id="l88.131" class="difflineminus">-           ? MimeHeaders_get (mult-&gt;hdrs, HEADER_X_SUN_DATA_TYPE,</span>
<a href="#l88.132"></a><span id="l88.132" class="difflineminus">-                    true, false)</span>
<a href="#l88.133"></a><span id="l88.133" class="difflineplus">+  sun_data_type =</span>
<a href="#l88.134"></a><span id="l88.134" class="difflineplus">+      (mult-&gt;hdrs</span>
<a href="#l88.135"></a><span id="l88.135" class="difflineplus">+           ? MimeHeaders_get(mult-&gt;hdrs, HEADER_X_SUN_DATA_TYPE, true, false)</span>
<a href="#l88.136"></a><span id="l88.136">            : 0);</span>
<a href="#l88.137"></a><span id="l88.137" class="difflineminus">-  if (sun_data_type)</span>
<a href="#l88.138"></a><span id="l88.138" class="difflineminus">-  {</span>
<a href="#l88.139"></a><span id="l88.139" class="difflineplus">+  if (sun_data_type) {</span>
<a href="#l88.140"></a><span id="l88.140">     int i;</span>
<a href="#l88.141"></a><span id="l88.141" class="difflineminus">-    static const struct { const char *in, *out; } sun_types[] = {</span>
<a href="#l88.142"></a><span id="l88.142" class="difflineplus">+    static const struct {</span>
<a href="#l88.143"></a><span id="l88.143" class="difflineplus">+      const char *in, *out;</span>
<a href="#l88.144"></a><span id="l88.144" class="difflineplus">+    } sun_types[] = {</span>
<a href="#l88.145"></a><span id="l88.145"> </span>
<a href="#l88.146"></a><span id="l88.146" class="difflineminus">-    /* Convert recognised Sun types to the corresponding MIME types,</span>
<a href="#l88.147"></a><span id="l88.147" class="difflineminus">-       and convert unrecognized ones based on the file extension and</span>
<a href="#l88.148"></a><span id="l88.148" class="difflineminus">-       the mime.types file.</span>
<a href="#l88.149"></a><span id="l88.149" class="difflineplus">+        /* Convert recognised Sun types to the corresponding MIME types,</span>
<a href="#l88.150"></a><span id="l88.150" class="difflineplus">+           and convert unrecognized ones based on the file extension and</span>
<a href="#l88.151"></a><span id="l88.151" class="difflineplus">+           the mime.types file.</span>
<a href="#l88.152"></a><span id="l88.152"> </span>
<a href="#l88.153"></a><span id="l88.153" class="difflineminus">-       These are the magic types used by MailTool that I can determine.</span>
<a href="#l88.154"></a><span id="l88.154" class="difflineminus">-       The only actual written spec I've found only listed the first few.</span>
<a href="#l88.155"></a><span id="l88.155" class="difflineminus">-       The rest were found by inspection (both of real-world messages,</span>
<a href="#l88.156"></a><span id="l88.156" class="difflineminus">-       and by running `strings' on the MailTool binary, and on the file</span>
<a href="#l88.157"></a><span id="l88.157" class="difflineminus">-       /usr/openwin/lib/cetables/cetables (the &quot;Class Engine&quot;, Sun's</span>
<a href="#l88.158"></a><span id="l88.158" class="difflineminus">-       equivalent to .mailcap and mime.types.)</span>
<a href="#l88.159"></a><span id="l88.159" class="difflineminus">-     */</span>
<a href="#l88.160"></a><span id="l88.160" class="difflineminus">-    { &quot;default&quot;,        TEXT_PLAIN },</span>
<a href="#l88.161"></a><span id="l88.161" class="difflineminus">-    { &quot;default-doc&quot;,      TEXT_PLAIN },</span>
<a href="#l88.162"></a><span id="l88.162" class="difflineminus">-    { &quot;text&quot;,          TEXT_PLAIN },</span>
<a href="#l88.163"></a><span id="l88.163" class="difflineminus">-    { &quot;scribe&quot;,          TEXT_PLAIN },</span>
<a href="#l88.164"></a><span id="l88.164" class="difflineminus">-    { &quot;sgml&quot;,          TEXT_PLAIN },</span>
<a href="#l88.165"></a><span id="l88.165" class="difflineminus">-    { &quot;tex&quot;,          TEXT_PLAIN },</span>
<a href="#l88.166"></a><span id="l88.166" class="difflineminus">-    { &quot;troff&quot;,          TEXT_PLAIN },</span>
<a href="#l88.167"></a><span id="l88.167" class="difflineminus">-    { &quot;c-file&quot;,          TEXT_PLAIN },</span>
<a href="#l88.168"></a><span id="l88.168" class="difflineminus">-    { &quot;h-file&quot;,          TEXT_PLAIN },</span>
<a href="#l88.169"></a><span id="l88.169" class="difflineminus">-    { &quot;readme-file&quot;,      TEXT_PLAIN },</span>
<a href="#l88.170"></a><span id="l88.170" class="difflineminus">-    { &quot;shell-script&quot;,      TEXT_PLAIN },</span>
<a href="#l88.171"></a><span id="l88.171" class="difflineminus">-    { &quot;cshell-script&quot;,      TEXT_PLAIN },</span>
<a href="#l88.172"></a><span id="l88.172" class="difflineminus">-    { &quot;makefile&quot;,        TEXT_PLAIN },</span>
<a href="#l88.173"></a><span id="l88.173" class="difflineminus">-    { &quot;hidden-docs&quot;,      TEXT_PLAIN },</span>
<a href="#l88.174"></a><span id="l88.174" class="difflineminus">-    { &quot;message&quot;,        MESSAGE_RFC822 },</span>
<a href="#l88.175"></a><span id="l88.175" class="difflineminus">-    { &quot;mail-message&quot;,      MESSAGE_RFC822 },</span>
<a href="#l88.176"></a><span id="l88.176" class="difflineminus">-    { &quot;mail-file&quot;,        TEXT_PLAIN },</span>
<a href="#l88.177"></a><span id="l88.177" class="difflineminus">-    { &quot;gif-file&quot;,        IMAGE_GIF },</span>
<a href="#l88.178"></a><span id="l88.178" class="difflineminus">-    { &quot;jpeg-file&quot;,        IMAGE_JPG },</span>
<a href="#l88.179"></a><span id="l88.179" class="difflineminus">-    { &quot;ppm-file&quot;,        IMAGE_PPM },</span>
<a href="#l88.180"></a><span id="l88.180" class="difflineminus">-    { &quot;pgm-file&quot;,        &quot;image/x-portable-graymap&quot; },</span>
<a href="#l88.181"></a><span id="l88.181" class="difflineminus">-    { &quot;pbm-file&quot;,        &quot;image/x-portable-bitmap&quot; },</span>
<a href="#l88.182"></a><span id="l88.182" class="difflineminus">-    { &quot;xpm-file&quot;,        &quot;image/x-xpixmap&quot; },</span>
<a href="#l88.183"></a><span id="l88.183" class="difflineminus">-    { &quot;ilbm-file&quot;,        &quot;image/ilbm&quot; },</span>
<a href="#l88.184"></a><span id="l88.184" class="difflineminus">-    { &quot;tiff-file&quot;,        &quot;image/tiff&quot; },</span>
<a href="#l88.185"></a><span id="l88.185" class="difflineminus">-    { &quot;photocd-file&quot;,      &quot;image/x-photo-cd&quot; },</span>
<a href="#l88.186"></a><span id="l88.186" class="difflineminus">-    { &quot;sun-raster&quot;,        &quot;image/x-sun-raster&quot; },</span>
<a href="#l88.187"></a><span id="l88.187" class="difflineminus">-    { &quot;audio-file&quot;,        AUDIO_BASIC },</span>
<a href="#l88.188"></a><span id="l88.188" class="difflineminus">-    { &quot;postscript&quot;,        APPLICATION_POSTSCRIPT },</span>
<a href="#l88.189"></a><span id="l88.189" class="difflineminus">-    { &quot;postscript-file&quot;,    APPLICATION_POSTSCRIPT },</span>
<a href="#l88.190"></a><span id="l88.190" class="difflineminus">-    { &quot;framemaker-document&quot;,  &quot;application/x-framemaker&quot; },</span>
<a href="#l88.191"></a><span id="l88.191" class="difflineminus">-    { &quot;sundraw-document&quot;,    &quot;application/x-sun-draw&quot; },</span>
<a href="#l88.192"></a><span id="l88.192" class="difflineminus">-    { &quot;sunpaint-document&quot;,    &quot;application/x-sun-paint&quot; },</span>
<a href="#l88.193"></a><span id="l88.193" class="difflineminus">-    { &quot;sunwrite-document&quot;,    &quot;application/x-sun-write&quot; },</span>
<a href="#l88.194"></a><span id="l88.194" class="difflineminus">-    { &quot;islanddraw-document&quot;,  &quot;application/x-island-draw&quot; },</span>
<a href="#l88.195"></a><span id="l88.195" class="difflineminus">-    { &quot;islandpaint-document&quot;,  &quot;application/x-island-paint&quot; },</span>
<a href="#l88.196"></a><span id="l88.196" class="difflineminus">-    { &quot;islandwrite-document&quot;,  &quot;application/x-island-write&quot; },</span>
<a href="#l88.197"></a><span id="l88.197" class="difflineminus">-    { &quot;sun-executable&quot;,      APPLICATION_OCTET_STREAM },</span>
<a href="#l88.198"></a><span id="l88.198" class="difflineminus">-    { &quot;default-app&quot;,      APPLICATION_OCTET_STREAM },</span>
<a href="#l88.199"></a><span id="l88.199" class="difflineminus">-    { 0, 0 }};</span>
<a href="#l88.200"></a><span id="l88.200" class="difflineplus">+           These are the magic types used by MailTool that I can determine.</span>
<a href="#l88.201"></a><span id="l88.201" class="difflineplus">+           The only actual written spec I've found only listed the first few.</span>
<a href="#l88.202"></a><span id="l88.202" class="difflineplus">+           The rest were found by inspection (both of real-world messages,</span>
<a href="#l88.203"></a><span id="l88.203" class="difflineplus">+           and by running `strings' on the MailTool binary, and on the file</span>
<a href="#l88.204"></a><span id="l88.204" class="difflineplus">+           /usr/openwin/lib/cetables/cetables (the &quot;Class Engine&quot;, Sun's</span>
<a href="#l88.205"></a><span id="l88.205" class="difflineplus">+           equivalent to .mailcap and mime.types.)</span>
<a href="#l88.206"></a><span id="l88.206" class="difflineplus">+         */</span>
<a href="#l88.207"></a><span id="l88.207" class="difflineplus">+        {&quot;default&quot;, TEXT_PLAIN},</span>
<a href="#l88.208"></a><span id="l88.208" class="difflineplus">+        {&quot;default-doc&quot;, TEXT_PLAIN},</span>
<a href="#l88.209"></a><span id="l88.209" class="difflineplus">+        {&quot;text&quot;, TEXT_PLAIN},</span>
<a href="#l88.210"></a><span id="l88.210" class="difflineplus">+        {&quot;scribe&quot;, TEXT_PLAIN},</span>
<a href="#l88.211"></a><span id="l88.211" class="difflineplus">+        {&quot;sgml&quot;, TEXT_PLAIN},</span>
<a href="#l88.212"></a><span id="l88.212" class="difflineplus">+        {&quot;tex&quot;, TEXT_PLAIN},</span>
<a href="#l88.213"></a><span id="l88.213" class="difflineplus">+        {&quot;troff&quot;, TEXT_PLAIN},</span>
<a href="#l88.214"></a><span id="l88.214" class="difflineplus">+        {&quot;c-file&quot;, TEXT_PLAIN},</span>
<a href="#l88.215"></a><span id="l88.215" class="difflineplus">+        {&quot;h-file&quot;, TEXT_PLAIN},</span>
<a href="#l88.216"></a><span id="l88.216" class="difflineplus">+        {&quot;readme-file&quot;, TEXT_PLAIN},</span>
<a href="#l88.217"></a><span id="l88.217" class="difflineplus">+        {&quot;shell-script&quot;, TEXT_PLAIN},</span>
<a href="#l88.218"></a><span id="l88.218" class="difflineplus">+        {&quot;cshell-script&quot;, TEXT_PLAIN},</span>
<a href="#l88.219"></a><span id="l88.219" class="difflineplus">+        {&quot;makefile&quot;, TEXT_PLAIN},</span>
<a href="#l88.220"></a><span id="l88.220" class="difflineplus">+        {&quot;hidden-docs&quot;, TEXT_PLAIN},</span>
<a href="#l88.221"></a><span id="l88.221" class="difflineplus">+        {&quot;message&quot;, MESSAGE_RFC822},</span>
<a href="#l88.222"></a><span id="l88.222" class="difflineplus">+        {&quot;mail-message&quot;, MESSAGE_RFC822},</span>
<a href="#l88.223"></a><span id="l88.223" class="difflineplus">+        {&quot;mail-file&quot;, TEXT_PLAIN},</span>
<a href="#l88.224"></a><span id="l88.224" class="difflineplus">+        {&quot;gif-file&quot;, IMAGE_GIF},</span>
<a href="#l88.225"></a><span id="l88.225" class="difflineplus">+        {&quot;jpeg-file&quot;, IMAGE_JPG},</span>
<a href="#l88.226"></a><span id="l88.226" class="difflineplus">+        {&quot;ppm-file&quot;, IMAGE_PPM},</span>
<a href="#l88.227"></a><span id="l88.227" class="difflineplus">+        {&quot;pgm-file&quot;, &quot;image/x-portable-graymap&quot;},</span>
<a href="#l88.228"></a><span id="l88.228" class="difflineplus">+        {&quot;pbm-file&quot;, &quot;image/x-portable-bitmap&quot;},</span>
<a href="#l88.229"></a><span id="l88.229" class="difflineplus">+        {&quot;xpm-file&quot;, &quot;image/x-xpixmap&quot;},</span>
<a href="#l88.230"></a><span id="l88.230" class="difflineplus">+        {&quot;ilbm-file&quot;, &quot;image/ilbm&quot;},</span>
<a href="#l88.231"></a><span id="l88.231" class="difflineplus">+        {&quot;tiff-file&quot;, &quot;image/tiff&quot;},</span>
<a href="#l88.232"></a><span id="l88.232" class="difflineplus">+        {&quot;photocd-file&quot;, &quot;image/x-photo-cd&quot;},</span>
<a href="#l88.233"></a><span id="l88.233" class="difflineplus">+        {&quot;sun-raster&quot;, &quot;image/x-sun-raster&quot;},</span>
<a href="#l88.234"></a><span id="l88.234" class="difflineplus">+        {&quot;audio-file&quot;, AUDIO_BASIC},</span>
<a href="#l88.235"></a><span id="l88.235" class="difflineplus">+        {&quot;postscript&quot;, APPLICATION_POSTSCRIPT},</span>
<a href="#l88.236"></a><span id="l88.236" class="difflineplus">+        {&quot;postscript-file&quot;, APPLICATION_POSTSCRIPT},</span>
<a href="#l88.237"></a><span id="l88.237" class="difflineplus">+        {&quot;framemaker-document&quot;, &quot;application/x-framemaker&quot;},</span>
<a href="#l88.238"></a><span id="l88.238" class="difflineplus">+        {&quot;sundraw-document&quot;, &quot;application/x-sun-draw&quot;},</span>
<a href="#l88.239"></a><span id="l88.239" class="difflineplus">+        {&quot;sunpaint-document&quot;, &quot;application/x-sun-paint&quot;},</span>
<a href="#l88.240"></a><span id="l88.240" class="difflineplus">+        {&quot;sunwrite-document&quot;, &quot;application/x-sun-write&quot;},</span>
<a href="#l88.241"></a><span id="l88.241" class="difflineplus">+        {&quot;islanddraw-document&quot;, &quot;application/x-island-draw&quot;},</span>
<a href="#l88.242"></a><span id="l88.242" class="difflineplus">+        {&quot;islandpaint-document&quot;, &quot;application/x-island-paint&quot;},</span>
<a href="#l88.243"></a><span id="l88.243" class="difflineplus">+        {&quot;islandwrite-document&quot;, &quot;application/x-island-write&quot;},</span>
<a href="#l88.244"></a><span id="l88.244" class="difflineplus">+        {&quot;sun-executable&quot;, APPLICATION_OCTET_STREAM},</span>
<a href="#l88.245"></a><span id="l88.245" class="difflineplus">+        {&quot;default-app&quot;, APPLICATION_OCTET_STREAM},</span>
<a href="#l88.246"></a><span id="l88.246" class="difflineplus">+        {0, 0}};</span>
<a href="#l88.247"></a><span id="l88.247">     for (i = 0; sun_types[i].in; i++)</span>
<a href="#l88.248"></a><span id="l88.248" class="difflineminus">-    if (!PL_strcasecmp(sun_data_type, sun_types[i].in))</span>
<a href="#l88.249"></a><span id="l88.249" class="difflineminus">-      {</span>
<a href="#l88.250"></a><span id="l88.250" class="difflineminus">-      mime_ct = sun_types[i].out;</span>
<a href="#l88.251"></a><span id="l88.251" class="difflineminus">-      break;</span>
<a href="#l88.252"></a><span id="l88.252" class="difflineplus">+      if (!PL_strcasecmp(sun_data_type, sun_types[i].in)) {</span>
<a href="#l88.253"></a><span id="l88.253" class="difflineplus">+        mime_ct = sun_types[i].out;</span>
<a href="#l88.254"></a><span id="l88.254" class="difflineplus">+        break;</span>
<a href="#l88.255"></a><span id="l88.255">       }</span>
<a href="#l88.256"></a><span id="l88.256">   }</span>
<a href="#l88.257"></a><span id="l88.257"> </span>
<a href="#l88.258"></a><span id="l88.258">   /* If we didn't find a type, look at the extension on the file name.</span>
<a href="#l88.259"></a><span id="l88.259">    */</span>
<a href="#l88.260"></a><span id="l88.260" class="difflineminus">-  if (!mime_ct &amp;&amp;</span>
<a href="#l88.261"></a><span id="l88.261" class="difflineminus">-    obj-&gt;options &amp;&amp;</span>
<a href="#l88.262"></a><span id="l88.262" class="difflineminus">-    obj-&gt;options-&gt;file_type_fn)</span>
<a href="#l88.263"></a><span id="l88.263" class="difflineminus">-  {</span>
<a href="#l88.264"></a><span id="l88.264" class="difflineplus">+  if (!mime_ct &amp;&amp; obj-&gt;options &amp;&amp; obj-&gt;options-&gt;file_type_fn) {</span>
<a href="#l88.265"></a><span id="l88.265">     char *name = MimeHeaders_get_name(mult-&gt;hdrs, obj-&gt;options);</span>
<a href="#l88.266"></a><span id="l88.266" class="difflineminus">-    if (name)</span>
<a href="#l88.267"></a><span id="l88.267" class="difflineminus">-    {</span>
<a href="#l88.268"></a><span id="l88.268" class="difflineminus">-      mime_ct2 = obj-&gt;options-&gt;file_type_fn(name,</span>
<a href="#l88.269"></a><span id="l88.269" class="difflineminus">-                          obj-&gt;options-&gt;stream_closure);</span>
<a href="#l88.270"></a><span id="l88.270" class="difflineplus">+    if (name) {</span>
<a href="#l88.271"></a><span id="l88.271" class="difflineplus">+      mime_ct2 = obj-&gt;options-&gt;file_type_fn(name, obj-&gt;options-&gt;stream_closure);</span>
<a href="#l88.272"></a><span id="l88.272">       mime_ct = mime_ct2;</span>
<a href="#l88.273"></a><span id="l88.273">       PR_Free(name);</span>
<a href="#l88.274"></a><span id="l88.274" class="difflineminus">-      if (!mime_ct2 || !PL_strcasecmp (mime_ct2, UNKNOWN_CONTENT_TYPE))</span>
<a href="#l88.275"></a><span id="l88.275" class="difflineminus">-      {</span>
<a href="#l88.276"></a><span id="l88.276" class="difflineplus">+      if (!mime_ct2 || !PL_strcasecmp(mime_ct2, UNKNOWN_CONTENT_TYPE)) {</span>
<a href="#l88.277"></a><span id="l88.277">         PR_FREEIF(mime_ct2);</span>
<a href="#l88.278"></a><span id="l88.278">         mime_ct = APPLICATION_OCTET_STREAM;</span>
<a href="#l88.279"></a><span id="l88.279">       }</span>
<a href="#l88.280"></a><span id="l88.280">     }</span>
<a href="#l88.281"></a><span id="l88.281">   }</span>
<a href="#l88.282"></a><span id="l88.282" class="difflineminus">-  if (!mime_ct)</span>
<a href="#l88.283"></a><span id="l88.283" class="difflineminus">-  mime_ct = APPLICATION_OCTET_STREAM;</span>
<a href="#l88.284"></a><span id="l88.284" class="difflineplus">+  if (!mime_ct) mime_ct = APPLICATION_OCTET_STREAM;</span>
<a href="#l88.285"></a><span id="l88.285"> </span>
<a href="#l88.286"></a><span id="l88.286">   PR_FREEIF(sun_data_type);</span>
<a href="#l88.287"></a><span id="l88.287"> </span>
<a href="#l88.288"></a><span id="l88.288" class="difflineminus">-</span>
<a href="#l88.289"></a><span id="l88.289">   /* Convert recognised Sun encodings to the corresponding MIME encodings.</span>
<a href="#l88.290"></a><span id="l88.290">    However, if the X-Sun-Encoding-Info field contains more than one</span>
<a href="#l88.291"></a><span id="l88.291">    encoding (that is, contains a comma) then assign it the encoding of</span>
<a href="#l88.292"></a><span id="l88.292">    the *rightmost* element in the list; and change its Content-Type to</span>
<a href="#l88.293"></a><span id="l88.293">    application/octet-stream.  Examples:</span>
<a href="#l88.294"></a><span id="l88.294"> </span>
<a href="#l88.295"></a><span id="l88.295">              Sun Type:                    Translates To:</span>
<a href="#l88.296"></a><span id="l88.296">         ==================            ====================</span>
<a href="#l88.297"></a><span id="l88.297" class="difflineat">@@ -207,136 +184,128 @@ MimeSunAttachment_create_child(MimeObjec</span>
<a href="#l88.298"></a><span id="l88.298"> </span>
<a href="#l88.299"></a><span id="l88.299">         type:     POSTSCRIPT          type:     application/x-compress</span>
<a href="#l88.300"></a><span id="l88.300">         encoding: COMPRESS,UUENCODE   encoding: x-uuencode</span>
<a href="#l88.301"></a><span id="l88.301"> </span>
<a href="#l88.302"></a><span id="l88.302">         type:     TEXT                type:     application/octet-stream</span>
<a href="#l88.303"></a><span id="l88.303">         encoding: UNKNOWN,UUENCODE    encoding: x-uuencode</span>
<a href="#l88.304"></a><span id="l88.304">    */</span>
<a href="#l88.305"></a><span id="l88.305"> </span>
<a href="#l88.306"></a><span id="l88.306" class="difflineminus">-  sun_data_type = (mult-&gt;hdrs</span>
<a href="#l88.307"></a><span id="l88.307" class="difflineminus">-           ? MimeHeaders_get (mult-&gt;hdrs, HEADER_X_SUN_ENCODING_INFO,</span>
<a href="#l88.308"></a><span id="l88.308" class="difflineminus">-                    false,false)</span>
<a href="#l88.309"></a><span id="l88.309" class="difflineminus">-           : 0);</span>
<a href="#l88.310"></a><span id="l88.310" class="difflineplus">+  sun_data_type =</span>
<a href="#l88.311"></a><span id="l88.311" class="difflineplus">+      (mult-&gt;hdrs ? MimeHeaders_get(mult-&gt;hdrs, HEADER_X_SUN_ENCODING_INFO,</span>
<a href="#l88.312"></a><span id="l88.312" class="difflineplus">+                                    false, false)</span>
<a href="#l88.313"></a><span id="l88.313" class="difflineplus">+                  : 0);</span>
<a href="#l88.314"></a><span id="l88.314">   sun_enc_info = sun_data_type;</span>
<a href="#l88.315"></a><span id="l88.315"> </span>
<a href="#l88.316"></a><span id="l88.316" class="difflineminus">-</span>
<a href="#l88.317"></a><span id="l88.317">   /* this &quot;adpcm-compress&quot; pseudo-encoding is some random junk that</span>
<a href="#l88.318"></a><span id="l88.318">    MailTool adds to the encoding description of .AU files: we can</span>
<a href="#l88.319"></a><span id="l88.319">    ignore it if it is the leftmost element of the encoding field.</span>
<a href="#l88.320"></a><span id="l88.320">    (It looks like it's created via `audioconvert -f g721'.  Why?</span>
<a href="#l88.321"></a><span id="l88.321">    Who knows.)</span>
<a href="#l88.322"></a><span id="l88.322">    */</span>
<a href="#l88.323"></a><span id="l88.323" class="difflineminus">-  if (sun_enc_info &amp;&amp; !PL_strncasecmp (sun_enc_info, &quot;adpcm-compress&quot;, 14))</span>
<a href="#l88.324"></a><span id="l88.324" class="difflineminus">-  {</span>
<a href="#l88.325"></a><span id="l88.325" class="difflineplus">+  if (sun_enc_info &amp;&amp; !PL_strncasecmp(sun_enc_info, &quot;adpcm-compress&quot;, 14)) {</span>
<a href="#l88.326"></a><span id="l88.326">     sun_enc_info += 14;</span>
<a href="#l88.327"></a><span id="l88.327" class="difflineminus">-    while (IS_SPACE(*sun_enc_info) || *sun_enc_info == ',')</span>
<a href="#l88.328"></a><span id="l88.328" class="difflineminus">-    sun_enc_info++;</span>
<a href="#l88.329"></a><span id="l88.329" class="difflineplus">+    while (IS_SPACE(*sun_enc_info) || *sun_enc_info == ',') sun_enc_info++;</span>
<a href="#l88.330"></a><span id="l88.330">   }</span>
<a href="#l88.331"></a><span id="l88.331"> </span>
<a href="#l88.332"></a><span id="l88.332">   /* Extract the last element of the encoding field, changing the content</span>
<a href="#l88.333"></a><span id="l88.333">    type if necessary (as described above.)</span>
<a href="#l88.334"></a><span id="l88.334">    */</span>
<a href="#l88.335"></a><span id="l88.335" class="difflineminus">-  if (sun_enc_info &amp;&amp; *sun_enc_info)</span>
<a href="#l88.336"></a><span id="l88.336" class="difflineminus">-  {</span>
<a href="#l88.337"></a><span id="l88.337" class="difflineplus">+  if (sun_enc_info &amp;&amp; *sun_enc_info) {</span>
<a href="#l88.338"></a><span id="l88.338">     const char *prev;</span>
<a href="#l88.339"></a><span id="l88.339">     const char *end = PL_strrchr(sun_enc_info, ',');</span>
<a href="#l88.340"></a><span id="l88.340" class="difflineminus">-    if (end)</span>
<a href="#l88.341"></a><span id="l88.341" class="difflineminus">-    {</span>
<a href="#l88.342"></a><span id="l88.342" class="difflineplus">+    if (end) {</span>
<a href="#l88.343"></a><span id="l88.343">       const char *start = sun_enc_info;</span>
<a href="#l88.344"></a><span id="l88.344">       sun_enc_info = end + 1;</span>
<a href="#l88.345"></a><span id="l88.345" class="difflineminus">-      while (IS_SPACE(*sun_enc_info))</span>
<a href="#l88.346"></a><span id="l88.346" class="difflineminus">-      sun_enc_info++;</span>
<a href="#l88.347"></a><span id="l88.347" class="difflineminus">-      for (prev = end-1; prev &gt; start &amp;&amp; *prev != ','; prev--)</span>
<a href="#l88.348"></a><span id="l88.348" class="difflineminus">-      ;</span>
<a href="#l88.349"></a><span id="l88.349" class="difflineplus">+      while (IS_SPACE(*sun_enc_info)) sun_enc_info++;</span>
<a href="#l88.350"></a><span id="l88.350" class="difflineplus">+      for (prev = end - 1; prev &gt; start &amp;&amp; *prev != ','; prev--)</span>
<a href="#l88.351"></a><span id="l88.351" class="difflineplus">+        ;</span>
<a href="#l88.352"></a><span id="l88.352">       if (*prev == ',') prev++;</span>
<a href="#l88.353"></a><span id="l88.353"> </span>
<a href="#l88.354"></a><span id="l88.354" class="difflineminus">-      if (!PL_strncasecmp (prev, &quot;uuencode&quot;, end-prev))</span>
<a href="#l88.355"></a><span id="l88.355" class="difflineminus">-      mime_ct = APPLICATION_UUENCODE;</span>
<a href="#l88.356"></a><span id="l88.356" class="difflineminus">-      else if (!PL_strncasecmp (prev, &quot;gzip&quot;, end-prev))</span>
<a href="#l88.357"></a><span id="l88.357" class="difflineminus">-      mime_ct = APPLICATION_GZIP;</span>
<a href="#l88.358"></a><span id="l88.358" class="difflineminus">-      else if (!PL_strncasecmp (prev, &quot;compress&quot;, end-prev))</span>
<a href="#l88.359"></a><span id="l88.359" class="difflineminus">-      mime_ct = APPLICATION_COMPRESS;</span>
<a href="#l88.360"></a><span id="l88.360" class="difflineminus">-      else if (!PL_strncasecmp (prev, &quot;default-compress&quot;, end-prev))</span>
<a href="#l88.361"></a><span id="l88.361" class="difflineminus">-      mime_ct = APPLICATION_COMPRESS;</span>
<a href="#l88.362"></a><span id="l88.362" class="difflineplus">+      if (!PL_strncasecmp(prev, &quot;uuencode&quot;, end - prev))</span>
<a href="#l88.363"></a><span id="l88.363" class="difflineplus">+        mime_ct = APPLICATION_UUENCODE;</span>
<a href="#l88.364"></a><span id="l88.364" class="difflineplus">+      else if (!PL_strncasecmp(prev, &quot;gzip&quot;, end - prev))</span>
<a href="#l88.365"></a><span id="l88.365" class="difflineplus">+        mime_ct = APPLICATION_GZIP;</span>
<a href="#l88.366"></a><span id="l88.366" class="difflineplus">+      else if (!PL_strncasecmp(prev, &quot;compress&quot;, end - prev))</span>
<a href="#l88.367"></a><span id="l88.367" class="difflineplus">+        mime_ct = APPLICATION_COMPRESS;</span>
<a href="#l88.368"></a><span id="l88.368" class="difflineplus">+      else if (!PL_strncasecmp(prev, &quot;default-compress&quot;, end - prev))</span>
<a href="#l88.369"></a><span id="l88.369" class="difflineplus">+        mime_ct = APPLICATION_COMPRESS;</span>
<a href="#l88.370"></a><span id="l88.370">       else</span>
<a href="#l88.371"></a><span id="l88.371" class="difflineminus">-      mime_ct = APPLICATION_OCTET_STREAM;</span>
<a href="#l88.372"></a><span id="l88.372" class="difflineplus">+        mime_ct = APPLICATION_OCTET_STREAM;</span>
<a href="#l88.373"></a><span id="l88.373">     }</span>
<a href="#l88.374"></a><span id="l88.374">   }</span>
<a href="#l88.375"></a><span id="l88.375"> </span>
<a href="#l88.376"></a><span id="l88.376">   /* Convert the remaining Sun encoding to a MIME encoding.</span>
<a href="#l88.377"></a><span id="l88.377">    If it isn't known, change the content-type instead.</span>
<a href="#l88.378"></a><span id="l88.378">    */</span>
<a href="#l88.379"></a><span id="l88.379">   if (!sun_enc_info || !*sun_enc_info)</span>
<a href="#l88.380"></a><span id="l88.380" class="difflineminus">-  ;</span>
<a href="#l88.381"></a><span id="l88.381" class="difflineminus">-  else if (!PL_strcasecmp(sun_enc_info,&quot;compress&quot;)) mime_cte = ENCODING_COMPRESS;</span>
<a href="#l88.382"></a><span id="l88.382" class="difflineminus">-  else if (!PL_strcasecmp(sun_enc_info,&quot;uuencode&quot;)) mime_cte = ENCODING_UUENCODE;</span>
<a href="#l88.383"></a><span id="l88.383" class="difflineminus">-  else if (!PL_strcasecmp(sun_enc_info,&quot;gzip&quot;))    mime_cte = ENCODING_GZIP;</span>
<a href="#l88.384"></a><span id="l88.384" class="difflineminus">-  else                    mime_ct = APPLICATION_OCTET_STREAM;</span>
<a href="#l88.385"></a><span id="l88.385" class="difflineplus">+    ;</span>
<a href="#l88.386"></a><span id="l88.386" class="difflineplus">+  else if (!PL_strcasecmp(sun_enc_info, &quot;compress&quot;))</span>
<a href="#l88.387"></a><span id="l88.387" class="difflineplus">+    mime_cte = ENCODING_COMPRESS;</span>
<a href="#l88.388"></a><span id="l88.388" class="difflineplus">+  else if (!PL_strcasecmp(sun_enc_info, &quot;uuencode&quot;))</span>
<a href="#l88.389"></a><span id="l88.389" class="difflineplus">+    mime_cte = ENCODING_UUENCODE;</span>
<a href="#l88.390"></a><span id="l88.390" class="difflineplus">+  else if (!PL_strcasecmp(sun_enc_info, &quot;gzip&quot;))</span>
<a href="#l88.391"></a><span id="l88.391" class="difflineplus">+    mime_cte = ENCODING_GZIP;</span>
<a href="#l88.392"></a><span id="l88.392" class="difflineplus">+  else</span>
<a href="#l88.393"></a><span id="l88.393" class="difflineplus">+    mime_ct = APPLICATION_OCTET_STREAM;</span>
<a href="#l88.394"></a><span id="l88.394"> </span>
<a href="#l88.395"></a><span id="l88.395">   PR_FREEIF(sun_data_type);</span>
<a href="#l88.396"></a><span id="l88.396"> </span>
<a href="#l88.397"></a><span id="l88.397" class="difflineminus">-</span>
<a href="#l88.398"></a><span id="l88.398">   /* Now that we know its type and encoding, create a MimeObject to represent</span>
<a href="#l88.399"></a><span id="l88.399">    this part.</span>
<a href="#l88.400"></a><span id="l88.400">    */</span>
<a href="#l88.401"></a><span id="l88.401">   child = mime_create(mime_ct, mult-&gt;hdrs, obj-&gt;options);</span>
<a href="#l88.402"></a><span id="l88.402" class="difflineminus">-  if (!child)</span>
<a href="#l88.403"></a><span id="l88.403" class="difflineminus">-  {</span>
<a href="#l88.404"></a><span id="l88.404" class="difflineplus">+  if (!child) {</span>
<a href="#l88.405"></a><span id="l88.405">     status = MIME_OUT_OF_MEMORY;</span>
<a href="#l88.406"></a><span id="l88.406">     goto FAIL;</span>
<a href="#l88.407"></a><span id="l88.407">   }</span>
<a href="#l88.408"></a><span id="l88.408"> </span>
<a href="#l88.409"></a><span id="l88.409">   /* Fake out the child's content-type and encoding (it probably doesn't have</span>
<a href="#l88.410"></a><span id="l88.410">    one right now, because the X-Sun- headers aren't generally recognised by</span>
<a href="#l88.411"></a><span id="l88.411">    the rest of this library.)</span>
<a href="#l88.412"></a><span id="l88.412">    */</span>
<a href="#l88.413"></a><span id="l88.413">   PR_FREEIF(child-&gt;content_type);</span>
<a href="#l88.414"></a><span id="l88.414">   PR_FREEIF(child-&gt;encoding);</span>
<a href="#l88.415"></a><span id="l88.415">   PR_ASSERT(mime_ct);</span>
<a href="#l88.416"></a><span id="l88.416" class="difflineminus">-  child-&gt;content_type = (mime_ct  ? strdup(mime_ct)  : 0);</span>
<a href="#l88.417"></a><span id="l88.417" class="difflineminus">-  child-&gt;encoding     = (mime_cte ? strdup(mime_cte) : 0);</span>
<a href="#l88.418"></a><span id="l88.418" class="difflineplus">+  child-&gt;content_type = (mime_ct ? strdup(mime_ct) : 0);</span>
<a href="#l88.419"></a><span id="l88.419" class="difflineplus">+  child-&gt;encoding = (mime_cte ? strdup(mime_cte) : 0);</span>
<a href="#l88.420"></a><span id="l88.420"> </span>
<a href="#l88.421"></a><span id="l88.421" class="difflineminus">-  status = ((MimeContainerClass *) obj-&gt;clazz)-&gt;add_child(obj, child);</span>
<a href="#l88.422"></a><span id="l88.422" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l88.423"></a><span id="l88.423" class="difflineminus">-  {</span>
<a href="#l88.424"></a><span id="l88.424" class="difflineplus">+  status = ((MimeContainerClass *)obj-&gt;clazz)-&gt;add_child(obj, child);</span>
<a href="#l88.425"></a><span id="l88.425" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l88.426"></a><span id="l88.426">     mime_free(child);</span>
<a href="#l88.427"></a><span id="l88.427">     child = 0;</span>
<a href="#l88.428"></a><span id="l88.428">     goto FAIL;</span>
<a href="#l88.429"></a><span id="l88.429">   }</span>
<a href="#l88.430"></a><span id="l88.430"> </span>
<a href="#l88.431"></a><span id="l88.431">   /* Sun attachments always have separators between parts. */</span>
<a href="#l88.432"></a><span id="l88.432">   status = MimeObject_write_separator(obj);</span>
<a href="#l88.433"></a><span id="l88.433">   if (status &lt; 0) goto FAIL;</span>
<a href="#l88.434"></a><span id="l88.434"> </span>
<a href="#l88.435"></a><span id="l88.435">   /* And now that we've added this new object to our list of</span>
<a href="#l88.436"></a><span id="l88.436">    children, start its parser going. */</span>
<a href="#l88.437"></a><span id="l88.437">   status = child-&gt;clazz-&gt;parse_begin(child);</span>
<a href="#l88.438"></a><span id="l88.438">   if (status &lt; 0) goto FAIL;</span>
<a href="#l88.439"></a><span id="l88.439"> </span>
<a href="#l88.440"></a><span id="l88.440" class="difflineminus">- FAIL:</span>
<a href="#l88.441"></a><span id="l88.441" class="difflineplus">+FAIL:</span>
<a href="#l88.442"></a><span id="l88.442">   PR_FREEIF(mime_ct2);</span>
<a href="#l88.443"></a><span id="l88.443">   PR_FREEIF(sun_data_type);</span>
<a href="#l88.444"></a><span id="l88.444">   return status;</span>
<a href="#l88.445"></a><span id="l88.445"> }</span>
<a href="#l88.446"></a><span id="l88.446"> </span>
<a href="#l88.447"></a><span id="l88.447" class="difflineminus">-</span>
<a href="#l88.448"></a><span id="l88.448" class="difflineminus">-static int</span>
<a href="#l88.449"></a><span id="l88.449" class="difflineminus">-MimeSunAttachment_parse_child_line (MimeObject *obj, const char *line, int32_t length,</span>
<a href="#l88.450"></a><span id="l88.450" class="difflineminus">-                  bool first_line_p)</span>
<a href="#l88.451"></a><span id="l88.451" class="difflineminus">-{</span>
<a href="#l88.452"></a><span id="l88.452" class="difflineminus">-  MimeContainer *cont = (MimeContainer *) obj;</span>
<a href="#l88.453"></a><span id="l88.453" class="difflineplus">+static int MimeSunAttachment_parse_child_line(MimeObject *obj, const char *line,</span>
<a href="#l88.454"></a><span id="l88.454" class="difflineplus">+                                              int32_t length,</span>
<a href="#l88.455"></a><span id="l88.455" class="difflineplus">+                                              bool first_line_p) {</span>
<a href="#l88.456"></a><span id="l88.456" class="difflineplus">+  MimeContainer *cont = (MimeContainer *)obj;</span>
<a href="#l88.457"></a><span id="l88.457">   MimeObject *kid;</span>
<a href="#l88.458"></a><span id="l88.458"> </span>
<a href="#l88.459"></a><span id="l88.459">   /* This is simpler than MimeMultipart-&gt;parse_child_line in that it doesn't</span>
<a href="#l88.460"></a><span id="l88.460">    play games about body parts without trailing newlines.</span>
<a href="#l88.461"></a><span id="l88.461">    */</span>
<a href="#l88.462"></a><span id="l88.462"> </span>
<a href="#l88.463"></a><span id="l88.463">   PR_ASSERT(cont-&gt;nchildren &gt; 0);</span>
<a href="#l88.464"></a><span id="l88.464" class="difflineminus">-  if (cont-&gt;nchildren &lt;= 0)</span>
<a href="#l88.465"></a><span id="l88.465" class="difflineminus">-  return -1;</span>
<a href="#l88.466"></a><span id="l88.466" class="difflineplus">+  if (cont-&gt;nchildren &lt;= 0) return -1;</span>
<a href="#l88.467"></a><span id="l88.467"> </span>
<a href="#l88.468"></a><span id="l88.468" class="difflineminus">-  kid = cont-&gt;children[cont-&gt;nchildren-1];</span>
<a href="#l88.469"></a><span id="l88.469" class="difflineplus">+  kid = cont-&gt;children[cont-&gt;nchildren - 1];</span>
<a href="#l88.470"></a><span id="l88.470">   PR_ASSERT(kid);</span>
<a href="#l88.471"></a><span id="l88.471">   if (!kid) return -1;</span>
<a href="#l88.472"></a><span id="l88.472"> </span>
<a href="#l88.473"></a><span id="l88.473" class="difflineminus">-  return kid-&gt;clazz-&gt;parse_buffer (line, length, kid);</span>
<a href="#l88.474"></a><span id="l88.474" class="difflineplus">+  return kid-&gt;clazz-&gt;parse_buffer(line, length, kid);</span>
<a href="#l88.475"></a><span id="l88.475"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/mailnews/mime/src/mimesun.h</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/mailnews/mime/src/mimesun.h</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -36,24 +36,24 @@</span>
<a href="#l89.4"></a><span id="l89.4">       Number of lines in the body, not counting headers and the blank</span>
<a href="#l89.5"></a><span id="l89.5">       line that follows them.</span>
<a href="#l89.6"></a><span id="l89.6"> </span>
<a href="#l89.7"></a><span id="l89.7">       X-Sun-Content-Length: (manditory, unless Lines is present)</span>
<a href="#l89.8"></a><span id="l89.8">         Bytes, presumably using Unix line terminators.</span>
<a href="#l89.9"></a><span id="l89.9">  */</span>
<a href="#l89.10"></a><span id="l89.10"> </span>
<a href="#l89.11"></a><span id="l89.11"> typedef struct MimeSunAttachmentClass MimeSunAttachmentClass;</span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-typedef struct MimeSunAttachment      MimeSunAttachment;</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineplus">+typedef struct MimeSunAttachment MimeSunAttachment;</span>
<a href="#l89.14"></a><span id="l89.14"> </span>
<a href="#l89.15"></a><span id="l89.15"> struct MimeSunAttachmentClass {</span>
<a href="#l89.16"></a><span id="l89.16">   MimeMultipartClass multipart;</span>
<a href="#l89.17"></a><span id="l89.17"> };</span>
<a href="#l89.18"></a><span id="l89.18"> </span>
<a href="#l89.19"></a><span id="l89.19"> extern MimeSunAttachmentClass mimeSunAttachmentClass;</span>
<a href="#l89.20"></a><span id="l89.20"> </span>
<a href="#l89.21"></a><span id="l89.21"> struct MimeSunAttachment {</span>
<a href="#l89.22"></a><span id="l89.22">   MimeMultipart multipart;</span>
<a href="#l89.23"></a><span id="l89.23"> };</span>
<a href="#l89.24"></a><span id="l89.24"> </span>
<a href="#l89.25"></a><span id="l89.25" class="difflineminus">-#define MimeSunAttachmentClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l89.26"></a><span id="l89.26" class="difflineminus">-  { MimeMultipartClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l89.27"></a><span id="l89.27" class="difflineplus">+#define MimeSunAttachmentClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l89.28"></a><span id="l89.28" class="difflineplus">+  { MimeMultipartClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l89.29"></a><span id="l89.29"> </span>
<a href="#l89.30"></a><span id="l89.30"> #endif /* _MIMESUN_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/mailnews/mime/src/mimetenr.cpp</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/mailnews/mime/src/mimetenr.cpp</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -8,21 +8,20 @@</span>
<a href="#l90.4"></a><span id="l90.4"> </span>
<a href="#l90.5"></a><span id="l90.5"> /* All the magic for this class is in mimetric.c; since text/enriched and</span>
<a href="#l90.6"></a><span id="l90.6">    text/richtext are so similar, it was easiest to implement them in the</span>
<a href="#l90.7"></a><span id="l90.7">    same method (but this is a subclass anyway just for general goodness.)</span>
<a href="#l90.8"></a><span id="l90.8">  */</span>
<a href="#l90.9"></a><span id="l90.9"> </span>
<a href="#l90.10"></a><span id="l90.10"> #define MIME_SUPERCLASS mimeInlineTextRichtextClass</span>
<a href="#l90.11"></a><span id="l90.11"> MimeDefClass(MimeInlineTextEnriched, MimeInlineTextEnrichedClass,</span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-       mimeInlineTextEnrichedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+             mimeInlineTextEnrichedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l90.14"></a><span id="l90.14"> </span>
<a href="#l90.15"></a><span id="l90.15" class="difflineminus">-static int</span>
<a href="#l90.16"></a><span id="l90.16" class="difflineminus">-MimeInlineTextEnrichedClassInitialize(MimeInlineTextEnrichedClass *clazz)</span>
<a href="#l90.17"></a><span id="l90.17" class="difflineminus">-{</span>
<a href="#l90.18"></a><span id="l90.18" class="difflineplus">+static int MimeInlineTextEnrichedClassInitialize(</span>
<a href="#l90.19"></a><span id="l90.19" class="difflineplus">+    MimeInlineTextEnrichedClass *clazz) {</span>
<a href="#l90.20"></a><span id="l90.20"> #ifdef DEBUG</span>
<a href="#l90.21"></a><span id="l90.21" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l90.22"></a><span id="l90.22" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l90.23"></a><span id="l90.23">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l90.24"></a><span id="l90.24"> #endif</span>
<a href="#l90.25"></a><span id="l90.25" class="difflineminus">-  MimeInlineTextRichtextClass *rclass = (MimeInlineTextRichtextClass *) clazz;</span>
<a href="#l90.26"></a><span id="l90.26" class="difflineplus">+  MimeInlineTextRichtextClass *rclass = (MimeInlineTextRichtextClass *)clazz;</span>
<a href="#l90.27"></a><span id="l90.27">   rclass-&gt;enriched_p = true;</span>
<a href="#l90.28"></a><span id="l90.28">   return 0;</span>
<a href="#l90.29"></a><span id="l90.29"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/mailnews/mime/src/mimetenr.h</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/mailnews/mime/src/mimetenr.h</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -9,24 +9,24 @@</span>
<a href="#l91.4"></a><span id="l91.4"> #include &quot;mimetric.h&quot;</span>
<a href="#l91.5"></a><span id="l91.5"> </span>
<a href="#l91.6"></a><span id="l91.6"> /* The MimeInlineTextEnriched class implements the text/enriched MIME content</span>
<a href="#l91.7"></a><span id="l91.7">    type, as defined in RFC 1563.  It does this largely by virtue of being a</span>
<a href="#l91.8"></a><span id="l91.8">    subclass of the MimeInlineTextRichtext class.</span>
<a href="#l91.9"></a><span id="l91.9">  */</span>
<a href="#l91.10"></a><span id="l91.10"> </span>
<a href="#l91.11"></a><span id="l91.11"> typedef struct MimeInlineTextEnrichedClass MimeInlineTextEnrichedClass;</span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-typedef struct MimeInlineTextEnriched      MimeInlineTextEnriched;</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineplus">+typedef struct MimeInlineTextEnriched MimeInlineTextEnriched;</span>
<a href="#l91.14"></a><span id="l91.14"> </span>
<a href="#l91.15"></a><span id="l91.15"> struct MimeInlineTextEnrichedClass {</span>
<a href="#l91.16"></a><span id="l91.16">   MimeInlineTextRichtextClass text;</span>
<a href="#l91.17"></a><span id="l91.17"> };</span>
<a href="#l91.18"></a><span id="l91.18"> </span>
<a href="#l91.19"></a><span id="l91.19"> extern MimeInlineTextEnrichedClass mimeInlineTextEnrichedClass;</span>
<a href="#l91.20"></a><span id="l91.20"> </span>
<a href="#l91.21"></a><span id="l91.21"> struct MimeInlineTextEnriched {</span>
<a href="#l91.22"></a><span id="l91.22">   MimeInlineTextRichtext richtext;</span>
<a href="#l91.23"></a><span id="l91.23"> };</span>
<a href="#l91.24"></a><span id="l91.24"> </span>
<a href="#l91.25"></a><span id="l91.25" class="difflineminus">-#define MimeInlineTextEnrichedClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l91.26"></a><span id="l91.26" class="difflineminus">-  { MimeInlineTextRichtextClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l91.27"></a><span id="l91.27" class="difflineplus">+#define MimeInlineTextEnrichedClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l91.28"></a><span id="l91.28" class="difflineplus">+  { MimeInlineTextRichtextClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l91.29"></a><span id="l91.29"> </span>
<a href="#l91.30"></a><span id="l91.30"> #endif /* _MIMETENR_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1" class="difflineminus">--- a/mailnews/mime/src/mimetext.cpp</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineplus">+++ b/mailnews/mime/src/mimetext.cpp</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l92.4"></a><span id="l92.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l92.5"></a><span id="l92.5">  *</span>
<a href="#l92.6"></a><span id="l92.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l92.7"></a><span id="l92.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l92.8"></a><span id="l92.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l92.9"></a><span id="l92.9" class="difflineminus">- * This Original Code has been modified by IBM Corporation. Modifications made by IBM</span>
<a href="#l92.10"></a><span id="l92.10" class="difflineminus">- * described herein are Copyright (c) International Business Machines Corporation, 2000.</span>
<a href="#l92.11"></a><span id="l92.11" class="difflineminus">- * Modifications to Mozilla code or documentation identified per MPL Section 3.3</span>
<a href="#l92.12"></a><span id="l92.12" class="difflineplus">+ * This Original Code has been modified by IBM Corporation. Modifications made</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineplus">+ * by IBM described herein are Copyright (c) International Business Machines</span>
<a href="#l92.14"></a><span id="l92.14" class="difflineplus">+ * Corporation, 2000. Modifications to Mozilla code or documentation identified</span>
<a href="#l92.15"></a><span id="l92.15" class="difflineplus">+ * per MPL Section 3.3</span>
<a href="#l92.16"></a><span id="l92.16">  *</span>
<a href="#l92.17"></a><span id="l92.17">  * Date             Modified by     Description of modification</span>
<a href="#l92.18"></a><span id="l92.18">  * 04/20/2000       IBM Corp.      OS/2 VisualAge build.</span>
<a href="#l92.19"></a><span id="l92.19">  */</span>
<a href="#l92.20"></a><span id="l92.20"> #include &quot;mimetext.h&quot;</span>
<a href="#l92.21"></a><span id="l92.21"> #include &quot;mimebuf.h&quot;</span>
<a href="#l92.22"></a><span id="l92.22"> #include &quot;mimethtm.h&quot;</span>
<a href="#l92.23"></a><span id="l92.23"> #include &quot;comi18n.h&quot;</span>
<a href="#l92.24"></a><span id="l92.24" class="difflineat">@@ -23,479 +24,433 @@</span>
<a href="#l92.25"></a><span id="l92.25"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l92.26"></a><span id="l92.26"> #include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l92.27"></a><span id="l92.27"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l92.28"></a><span id="l92.28"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l92.29"></a><span id="l92.29"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l92.30"></a><span id="l92.30"> </span>
<a href="#l92.31"></a><span id="l92.31"> #define MIME_SUPERCLASS mimeLeafClass</span>
<a href="#l92.32"></a><span id="l92.32"> MimeDefClass(MimeInlineText, MimeInlineTextClass, mimeInlineTextClass,</span>
<a href="#l92.33"></a><span id="l92.33" class="difflineminus">-       &amp;MIME_SUPERCLASS);</span>
<a href="#l92.34"></a><span id="l92.34" class="difflineplus">+             &amp;MIME_SUPERCLASS);</span>
<a href="#l92.35"></a><span id="l92.35"> </span>
<a href="#l92.36"></a><span id="l92.36" class="difflineminus">-static int MimeInlineText_initialize (MimeObject *);</span>
<a href="#l92.37"></a><span id="l92.37" class="difflineminus">-static void MimeInlineText_finalize (MimeObject *);</span>
<a href="#l92.38"></a><span id="l92.38" class="difflineminus">-static int MimeInlineText_rot13_line (MimeObject *, char *line, int32_t length);</span>
<a href="#l92.39"></a><span id="l92.39" class="difflineminus">-static int MimeInlineText_parse_eof (MimeObject *obj, bool abort_p);</span>
<a href="#l92.40"></a><span id="l92.40" class="difflineminus">-static int MimeInlineText_parse_end  (MimeObject *, bool);</span>
<a href="#l92.41"></a><span id="l92.41" class="difflineminus">-static int MimeInlineText_parse_decoded_buffer (const char *, int32_t, MimeObject *);</span>
<a href="#l92.42"></a><span id="l92.42" class="difflineplus">+static int MimeInlineText_initialize(MimeObject *);</span>
<a href="#l92.43"></a><span id="l92.43" class="difflineplus">+static void MimeInlineText_finalize(MimeObject *);</span>
<a href="#l92.44"></a><span id="l92.44" class="difflineplus">+static int MimeInlineText_rot13_line(MimeObject *, char *line, int32_t length);</span>
<a href="#l92.45"></a><span id="l92.45" class="difflineplus">+static int MimeInlineText_parse_eof(MimeObject *obj, bool abort_p);</span>
<a href="#l92.46"></a><span id="l92.46" class="difflineplus">+static int MimeInlineText_parse_end(MimeObject *, bool);</span>
<a href="#l92.47"></a><span id="l92.47" class="difflineplus">+static int MimeInlineText_parse_decoded_buffer(const char *, int32_t,</span>
<a href="#l92.48"></a><span id="l92.48" class="difflineplus">+                                               MimeObject *);</span>
<a href="#l92.49"></a><span id="l92.49"> static int MimeInlineText_rotate_convert_and_parse_line(char *, int32_t,</span>
<a href="#l92.50"></a><span id="l92.50" class="difflineminus">-                 MimeObject *);</span>
<a href="#l92.51"></a><span id="l92.51" class="difflineplus">+                                                        MimeObject *);</span>
<a href="#l92.52"></a><span id="l92.52"> static int MimeInlineText_open_dam(char *line, int32_t length, MimeObject *obj);</span>
<a href="#l92.53"></a><span id="l92.53"> static int MimeInlineText_initializeCharset(MimeObject *obj);</span>
<a href="#l92.54"></a><span id="l92.54"> </span>
<a href="#l92.55"></a><span id="l92.55" class="difflineminus">-static int</span>
<a href="#l92.56"></a><span id="l92.56" class="difflineminus">-MimeInlineTextClassInitialize(MimeInlineTextClass *clazz)</span>
<a href="#l92.57"></a><span id="l92.57" class="difflineminus">-{</span>
<a href="#l92.58"></a><span id="l92.58" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l92.59"></a><span id="l92.59" class="difflineminus">-  MimeLeafClass   *lclass = (MimeLeafClass *) clazz;</span>
<a href="#l92.60"></a><span id="l92.60" class="difflineplus">+static int MimeInlineTextClassInitialize(MimeInlineTextClass *clazz) {</span>
<a href="#l92.61"></a><span id="l92.61" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l92.62"></a><span id="l92.62" class="difflineplus">+  MimeLeafClass *lclass = (MimeLeafClass *)clazz;</span>
<a href="#l92.63"></a><span id="l92.63">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l92.64"></a><span id="l92.64" class="difflineminus">-  oclass-&gt;initialize           = MimeInlineText_initialize;</span>
<a href="#l92.65"></a><span id="l92.65" class="difflineminus">-  oclass-&gt;finalize             = MimeInlineText_finalize;</span>
<a href="#l92.66"></a><span id="l92.66" class="difflineminus">-  oclass-&gt;parse_eof            = MimeInlineText_parse_eof;</span>
<a href="#l92.67"></a><span id="l92.67" class="difflineminus">-  oclass-&gt;parse_end            = MimeInlineText_parse_end;</span>
<a href="#l92.68"></a><span id="l92.68" class="difflineminus">-  clazz-&gt;rot13_line            = MimeInlineText_rot13_line;</span>
<a href="#l92.69"></a><span id="l92.69" class="difflineminus">-  clazz-&gt;initialize_charset    =  MimeInlineText_initializeCharset;</span>
<a href="#l92.70"></a><span id="l92.70" class="difflineplus">+  oclass-&gt;initialize = MimeInlineText_initialize;</span>
<a href="#l92.71"></a><span id="l92.71" class="difflineplus">+  oclass-&gt;finalize = MimeInlineText_finalize;</span>
<a href="#l92.72"></a><span id="l92.72" class="difflineplus">+  oclass-&gt;parse_eof = MimeInlineText_parse_eof;</span>
<a href="#l92.73"></a><span id="l92.73" class="difflineplus">+  oclass-&gt;parse_end = MimeInlineText_parse_end;</span>
<a href="#l92.74"></a><span id="l92.74" class="difflineplus">+  clazz-&gt;rot13_line = MimeInlineText_rot13_line;</span>
<a href="#l92.75"></a><span id="l92.75" class="difflineplus">+  clazz-&gt;initialize_charset = MimeInlineText_initializeCharset;</span>
<a href="#l92.76"></a><span id="l92.76">   lclass-&gt;parse_decoded_buffer = MimeInlineText_parse_decoded_buffer;</span>
<a href="#l92.77"></a><span id="l92.77">   return 0;</span>
<a href="#l92.78"></a><span id="l92.78"> }</span>
<a href="#l92.79"></a><span id="l92.79"> </span>
<a href="#l92.80"></a><span id="l92.80" class="difflineminus">-static int</span>
<a href="#l92.81"></a><span id="l92.81" class="difflineminus">-MimeInlineText_initialize (MimeObject *obj)</span>
<a href="#l92.82"></a><span id="l92.82" class="difflineminus">-{</span>
<a href="#l92.83"></a><span id="l92.83" class="difflineplus">+static int MimeInlineText_initialize(MimeObject *obj) {</span>
<a href="#l92.84"></a><span id="l92.84">   // This is an abstract class; it shouldn't be directly instantiated.</span>
<a href="#l92.85"></a><span id="l92.85" class="difflineminus">-  PR_ASSERT(obj-&gt;clazz != (MimeObjectClass *) &amp;mimeInlineTextClass);</span>
<a href="#l92.86"></a><span id="l92.86" class="difflineplus">+  PR_ASSERT(obj-&gt;clazz != (MimeObjectClass *)&amp;mimeInlineTextClass);</span>
<a href="#l92.87"></a><span id="l92.87"> </span>
<a href="#l92.88"></a><span id="l92.88" class="difflineminus">-  ((MimeInlineText *) obj)-&gt;initializeCharset = false;</span>
<a href="#l92.89"></a><span id="l92.89" class="difflineminus">-  ((MimeInlineText *) obj)-&gt;needUpdateMsgWinCharset = false;</span>
<a href="#l92.90"></a><span id="l92.90" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(obj);</span>
<a href="#l92.91"></a><span id="l92.91" class="difflineplus">+  ((MimeInlineText *)obj)-&gt;initializeCharset = false;</span>
<a href="#l92.92"></a><span id="l92.92" class="difflineplus">+  ((MimeInlineText *)obj)-&gt;needUpdateMsgWinCharset = false;</span>
<a href="#l92.93"></a><span id="l92.93" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(obj);</span>
<a href="#l92.94"></a><span id="l92.94"> }</span>
<a href="#l92.95"></a><span id="l92.95"> </span>
<a href="#l92.96"></a><span id="l92.96" class="difflineminus">-static int MimeInlineText_initializeCharset(MimeObject *obj)</span>
<a href="#l92.97"></a><span id="l92.97" class="difflineminus">-{</span>
<a href="#l92.98"></a><span id="l92.98" class="difflineminus">-  MimeInlineText  *text = (MimeInlineText *) obj;</span>
<a href="#l92.99"></a><span id="l92.99" class="difflineplus">+static int MimeInlineText_initializeCharset(MimeObject *obj) {</span>
<a href="#l92.100"></a><span id="l92.100" class="difflineplus">+  MimeInlineText *text = (MimeInlineText *)obj;</span>
<a href="#l92.101"></a><span id="l92.101"> </span>
<a href="#l92.102"></a><span id="l92.102">   text-&gt;inputAutodetect = false;</span>
<a href="#l92.103"></a><span id="l92.103">   text-&gt;charsetOverridable = false;</span>
<a href="#l92.104"></a><span id="l92.104"> </span>
<a href="#l92.105"></a><span id="l92.105">   // Figure out an appropriate charset for this object.</span>
<a href="#l92.106"></a><span id="l92.106" class="difflineminus">-  if (!text-&gt;charset &amp;&amp; obj-&gt;headers)</span>
<a href="#l92.107"></a><span id="l92.107" class="difflineminus">-  {</span>
<a href="#l92.108"></a><span id="l92.108" class="difflineminus">-    if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;override_charset)</span>
<a href="#l92.109"></a><span id="l92.109" class="difflineminus">-    {</span>
<a href="#l92.110"></a><span id="l92.110" class="difflineplus">+  if (!text-&gt;charset &amp;&amp; obj-&gt;headers) {</span>
<a href="#l92.111"></a><span id="l92.111" class="difflineplus">+    if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;override_charset) {</span>
<a href="#l92.112"></a><span id="l92.112">       text-&gt;charset = strdup(obj-&gt;options-&gt;default_charset);</span>
<a href="#l92.113"></a><span id="l92.113" class="difflineminus">-    }</span>
<a href="#l92.114"></a><span id="l92.114" class="difflineminus">-    else</span>
<a href="#l92.115"></a><span id="l92.115" class="difflineminus">-    {</span>
<a href="#l92.116"></a><span id="l92.116" class="difflineminus">-      char *ct = MimeHeaders_get (obj-&gt;headers, HEADER_CONTENT_TYPE,</span>
<a href="#l92.117"></a><span id="l92.117" class="difflineminus">-                                  false, false);</span>
<a href="#l92.118"></a><span id="l92.118" class="difflineminus">-      if (ct)</span>
<a href="#l92.119"></a><span id="l92.119" class="difflineminus">-      {</span>
<a href="#l92.120"></a><span id="l92.120" class="difflineminus">-        text-&gt;charset = MimeHeaders_get_parameter (ct, &quot;charset&quot;, NULL, NULL);</span>
<a href="#l92.121"></a><span id="l92.121" class="difflineplus">+    } else {</span>
<a href="#l92.122"></a><span id="l92.122" class="difflineplus">+      char *ct =</span>
<a href="#l92.123"></a><span id="l92.123" class="difflineplus">+          MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l92.124"></a><span id="l92.124" class="difflineplus">+      if (ct) {</span>
<a href="#l92.125"></a><span id="l92.125" class="difflineplus">+        text-&gt;charset = MimeHeaders_get_parameter(ct, &quot;charset&quot;, NULL, NULL);</span>
<a href="#l92.126"></a><span id="l92.126">         PR_Free(ct);</span>
<a href="#l92.127"></a><span id="l92.127">       }</span>
<a href="#l92.128"></a><span id="l92.128"> </span>
<a href="#l92.129"></a><span id="l92.129" class="difflineminus">-      if (!text-&gt;charset)</span>
<a href="#l92.130"></a><span id="l92.130" class="difflineminus">-      {</span>
<a href="#l92.131"></a><span id="l92.131" class="difflineplus">+      if (!text-&gt;charset) {</span>
<a href="#l92.132"></a><span id="l92.132">         // If we didn't find &quot;Content-Type: ...; charset=XX&quot;, then look</span>
<a href="#l92.133"></a><span id="l92.133">         // for &quot;X-Sun-Charset: XX&quot; instead. (Maybe this should be done</span>
<a href="#l92.134"></a><span id="l92.134">         // in MimeSunAttachmentClass, but it's harder there than here.)</span>
<a href="#l92.135"></a><span id="l92.135" class="difflineminus">-        text-&gt;charset = MimeHeaders_get (obj-&gt;headers,</span>
<a href="#l92.136"></a><span id="l92.136" class="difflineminus">-                                          HEADER_X_SUN_CHARSET,</span>
<a href="#l92.137"></a><span id="l92.137" class="difflineminus">-                                          false, false);</span>
<a href="#l92.138"></a><span id="l92.138" class="difflineplus">+        text-&gt;charset =</span>
<a href="#l92.139"></a><span id="l92.139" class="difflineplus">+            MimeHeaders_get(obj-&gt;headers, HEADER_X_SUN_CHARSET, false, false);</span>
<a href="#l92.140"></a><span id="l92.140">       }</span>
<a href="#l92.141"></a><span id="l92.141"> </span>
<a href="#l92.142"></a><span id="l92.142">       // iMIP entities without an explicit charset parameter default to</span>
<a href="#l92.143"></a><span id="l92.143">       // US-ASCII (RFC 2447, section 2.4). However, Microsoft Outlook generates</span>
<a href="#l92.144"></a><span id="l92.144">       // UTF-8 but omits the charset parameter.</span>
<a href="#l92.145"></a><span id="l92.145">       // When no charset is defined by the container (e.g. iMIP), iCalendar</span>
<a href="#l92.146"></a><span id="l92.146">       // files default to UTF-8 (RFC 2445, section 4.1.4).</span>
<a href="#l92.147"></a><span id="l92.147" class="difflineminus">-      if (!text-&gt;charset &amp;&amp;</span>
<a href="#l92.148"></a><span id="l92.148" class="difflineminus">-          obj-&gt;content_type &amp;&amp;</span>
<a href="#l92.149"></a><span id="l92.149" class="difflineplus">+      if (!text-&gt;charset &amp;&amp; obj-&gt;content_type &amp;&amp;</span>
<a href="#l92.150"></a><span id="l92.150">           !PL_strcasecmp(obj-&gt;content_type, TEXT_CALENDAR))</span>
<a href="#l92.151"></a><span id="l92.151">         text-&gt;charset = strdup(&quot;UTF-8&quot;);</span>
<a href="#l92.152"></a><span id="l92.152"> </span>
<a href="#l92.153"></a><span id="l92.153" class="difflineminus">-      if (!text-&gt;charset)</span>
<a href="#l92.154"></a><span id="l92.154" class="difflineminus">-      {</span>
<a href="#l92.155"></a><span id="l92.155" class="difflineplus">+      if (!text-&gt;charset) {</span>
<a href="#l92.156"></a><span id="l92.156">         nsresult res;</span>
<a href="#l92.157"></a><span id="l92.157"> </span>
<a href="#l92.158"></a><span id="l92.158">         text-&gt;charsetOverridable = true;</span>
<a href="#l92.159"></a><span id="l92.159"> </span>
<a href="#l92.160"></a><span id="l92.160" class="difflineminus">-        nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;res));</span>
<a href="#l92.161"></a><span id="l92.161" class="difflineminus">-        if (NS_SUCCEEDED(res))</span>
<a href="#l92.162"></a><span id="l92.162" class="difflineminus">-        {</span>
<a href="#l92.163"></a><span id="l92.163" class="difflineplus">+        nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l92.164"></a><span id="l92.164" class="difflineplus">+            do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;res));</span>
<a href="#l92.165"></a><span id="l92.165" class="difflineplus">+        if (NS_SUCCEEDED(res)) {</span>
<a href="#l92.166"></a><span id="l92.166">           nsCOMPtr&lt;nsIPrefLocalizedString&gt; str;</span>
<a href="#l92.167"></a><span id="l92.167" class="difflineminus">-          if (NS_SUCCEEDED(prefBranch-&gt;GetComplexValue(&quot;intl.charset.detector&quot;, NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(str)))) {</span>
<a href="#l92.168"></a><span id="l92.168" class="difflineminus">-            // Only if we can get autodetector name correctly, do we set this to true.</span>
<a href="#l92.169"></a><span id="l92.169" class="difflineplus">+          if (NS_SUCCEEDED(prefBranch-&gt;GetComplexValue(</span>
<a href="#l92.170"></a><span id="l92.170" class="difflineplus">+                  &quot;intl.charset.detector&quot;, NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l92.171"></a><span id="l92.171" class="difflineplus">+                  getter_AddRefs(str)))) {</span>
<a href="#l92.172"></a><span id="l92.172" class="difflineplus">+            // Only if we can get autodetector name correctly, do we set this to</span>
<a href="#l92.173"></a><span id="l92.173" class="difflineplus">+            // true.</span>
<a href="#l92.174"></a><span id="l92.174">             text-&gt;inputAutodetect = true;</span>
<a href="#l92.175"></a><span id="l92.175">           }</span>
<a href="#l92.176"></a><span id="l92.176">         }</span>
<a href="#l92.177"></a><span id="l92.177"> </span>
<a href="#l92.178"></a><span id="l92.178">         if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;default_charset)</span>
<a href="#l92.179"></a><span id="l92.179">           text-&gt;charset = strdup(obj-&gt;options-&gt;default_charset);</span>
<a href="#l92.180"></a><span id="l92.180" class="difflineminus">-        else</span>
<a href="#l92.181"></a><span id="l92.181" class="difflineminus">-        {</span>
<a href="#l92.182"></a><span id="l92.182" class="difflineminus">-          if (NS_SUCCEEDED(res))</span>
<a href="#l92.183"></a><span id="l92.183" class="difflineminus">-          {</span>
<a href="#l92.184"></a><span id="l92.184" class="difflineplus">+        else {</span>
<a href="#l92.185"></a><span id="l92.185" class="difflineplus">+          if (NS_SUCCEEDED(res)) {</span>
<a href="#l92.186"></a><span id="l92.186">             nsString value;</span>
<a href="#l92.187"></a><span id="l92.187" class="difflineminus">-            NS_GetLocalizedUnicharPreferenceWithDefault(prefBranch, &quot;mailnews.view_default_charset&quot;, EmptyString(), value);</span>
<a href="#l92.188"></a><span id="l92.188" class="difflineplus">+            NS_GetLocalizedUnicharPreferenceWithDefault(</span>
<a href="#l92.189"></a><span id="l92.189" class="difflineplus">+                prefBranch, &quot;mailnews.view_default_charset&quot;, EmptyString(),</span>
<a href="#l92.190"></a><span id="l92.190" class="difflineplus">+                value);</span>
<a href="#l92.191"></a><span id="l92.191">             text-&gt;charset = ToNewUTF8String(value);</span>
<a href="#l92.192"></a><span id="l92.192" class="difflineminus">-          }</span>
<a href="#l92.193"></a><span id="l92.193" class="difflineminus">-          else</span>
<a href="#l92.194"></a><span id="l92.194" class="difflineplus">+          } else</span>
<a href="#l92.195"></a><span id="l92.195">             text-&gt;charset = strdup(&quot;&quot;);</span>
<a href="#l92.196"></a><span id="l92.196">         }</span>
<a href="#l92.197"></a><span id="l92.197">       }</span>
<a href="#l92.198"></a><span id="l92.198">     }</span>
<a href="#l92.199"></a><span id="l92.199">   }</span>
<a href="#l92.200"></a><span id="l92.200"> </span>
<a href="#l92.201"></a><span id="l92.201" class="difflineminus">-  if (text-&gt;inputAutodetect)</span>
<a href="#l92.202"></a><span id="l92.202" class="difflineminus">-  {</span>
<a href="#l92.203"></a><span id="l92.203" class="difflineplus">+  if (text-&gt;inputAutodetect) {</span>
<a href="#l92.204"></a><span id="l92.204">     // We need to prepare lineDam for charset detection.</span>
<a href="#l92.205"></a><span id="l92.205" class="difflineminus">-    text-&gt;lineDamBuffer = (char*)PR_Malloc(DAM_MAX_BUFFER_SIZE);</span>
<a href="#l92.206"></a><span id="l92.206" class="difflineminus">-    text-&gt;lineDamPtrs = (char**)PR_Malloc(DAM_MAX_LINES*sizeof(char*));</span>
<a href="#l92.207"></a><span id="l92.207" class="difflineplus">+    text-&gt;lineDamBuffer = (char *)PR_Malloc(DAM_MAX_BUFFER_SIZE);</span>
<a href="#l92.208"></a><span id="l92.208" class="difflineplus">+    text-&gt;lineDamPtrs = (char **)PR_Malloc(DAM_MAX_LINES * sizeof(char *));</span>
<a href="#l92.209"></a><span id="l92.209">     text-&gt;curDamOffset = 0;</span>
<a href="#l92.210"></a><span id="l92.210">     text-&gt;lastLineInDam = 0;</span>
<a href="#l92.211"></a><span id="l92.211" class="difflineminus">-    if (!text-&gt;lineDamBuffer || !text-&gt;lineDamPtrs)</span>
<a href="#l92.212"></a><span id="l92.212" class="difflineminus">-    {</span>
<a href="#l92.213"></a><span id="l92.213" class="difflineplus">+    if (!text-&gt;lineDamBuffer || !text-&gt;lineDamPtrs) {</span>
<a href="#l92.214"></a><span id="l92.214">       text-&gt;inputAutodetect = false;</span>
<a href="#l92.215"></a><span id="l92.215">       PR_FREEIF(text-&gt;lineDamBuffer);</span>
<a href="#l92.216"></a><span id="l92.216">       PR_FREEIF(text-&gt;lineDamPtrs);</span>
<a href="#l92.217"></a><span id="l92.217">     }</span>
<a href="#l92.218"></a><span id="l92.218">   }</span>
<a href="#l92.219"></a><span id="l92.219"> </span>
<a href="#l92.220"></a><span id="l92.220">   text-&gt;initializeCharset = true;</span>
<a href="#l92.221"></a><span id="l92.221"> </span>
<a href="#l92.222"></a><span id="l92.222">   return 0;</span>
<a href="#l92.223"></a><span id="l92.223"> }</span>
<a href="#l92.224"></a><span id="l92.224"> </span>
<a href="#l92.225"></a><span id="l92.225" class="difflineminus">-static void</span>
<a href="#l92.226"></a><span id="l92.226" class="difflineminus">-MimeInlineText_finalize (MimeObject *obj)</span>
<a href="#l92.227"></a><span id="l92.227" class="difflineminus">-{</span>
<a href="#l92.228"></a><span id="l92.228" class="difflineminus">-  MimeInlineText *text = (MimeInlineText *) obj;</span>
<a href="#l92.229"></a><span id="l92.229" class="difflineplus">+static void MimeInlineText_finalize(MimeObject *obj) {</span>
<a href="#l92.230"></a><span id="l92.230" class="difflineplus">+  MimeInlineText *text = (MimeInlineText *)obj;</span>
<a href="#l92.231"></a><span id="l92.231"> </span>
<a href="#l92.232"></a><span id="l92.232" class="difflineminus">-  obj-&gt;clazz-&gt;parse_eof (obj, false);</span>
<a href="#l92.233"></a><span id="l92.233" class="difflineminus">-  obj-&gt;clazz-&gt;parse_end (obj, false);</span>
<a href="#l92.234"></a><span id="l92.234" class="difflineplus">+  obj-&gt;clazz-&gt;parse_eof(obj, false);</span>
<a href="#l92.235"></a><span id="l92.235" class="difflineplus">+  obj-&gt;clazz-&gt;parse_end(obj, false);</span>
<a href="#l92.236"></a><span id="l92.236"> </span>
<a href="#l92.237"></a><span id="l92.237">   PR_FREEIF(text-&gt;charset);</span>
<a href="#l92.238"></a><span id="l92.238"> </span>
<a href="#l92.239"></a><span id="l92.239">   // Should have been freed by parse_eof, but just in case...</span>
<a href="#l92.240"></a><span id="l92.240">   PR_ASSERT(!text-&gt;cbuffer);</span>
<a href="#l92.241"></a><span id="l92.241" class="difflineminus">-  PR_FREEIF (text-&gt;cbuffer);</span>
<a href="#l92.242"></a><span id="l92.242" class="difflineplus">+  PR_FREEIF(text-&gt;cbuffer);</span>
<a href="#l92.243"></a><span id="l92.243"> </span>
<a href="#l92.244"></a><span id="l92.244">   if (text-&gt;inputAutodetect) {</span>
<a href="#l92.245"></a><span id="l92.245">     PR_FREEIF(text-&gt;lineDamBuffer);</span>
<a href="#l92.246"></a><span id="l92.246">     PR_FREEIF(text-&gt;lineDamPtrs);</span>
<a href="#l92.247"></a><span id="l92.247">     text-&gt;inputAutodetect = false;</span>
<a href="#l92.248"></a><span id="l92.248">   }</span>
<a href="#l92.249"></a><span id="l92.249"> </span>
<a href="#l92.250"></a><span id="l92.250" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize (obj);</span>
<a href="#l92.251"></a><span id="l92.251" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l92.252"></a><span id="l92.252"> }</span>
<a href="#l92.253"></a><span id="l92.253"> </span>
<a href="#l92.254"></a><span id="l92.254" class="difflineminus">-</span>
<a href="#l92.255"></a><span id="l92.255" class="difflineminus">-static int</span>
<a href="#l92.256"></a><span id="l92.256" class="difflineminus">-MimeInlineText_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l92.257"></a><span id="l92.257" class="difflineminus">-{</span>
<a href="#l92.258"></a><span id="l92.258" class="difflineplus">+static int MimeInlineText_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l92.259"></a><span id="l92.259">   int status;</span>
<a href="#l92.260"></a><span id="l92.260"> </span>
<a href="#l92.261"></a><span id="l92.261">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l92.262"></a><span id="l92.262">   NS_ASSERTION(!obj-&gt;parsed_p, &quot;obj already parsed&quot;);</span>
<a href="#l92.263"></a><span id="l92.263"> </span>
<a href="#l92.264"></a><span id="l92.264" class="difflineminus">-  MimeInlineText *text = (MimeInlineText *) obj;</span>
<a href="#l92.265"></a><span id="l92.265" class="difflineplus">+  MimeInlineText *text = (MimeInlineText *)obj;</span>
<a href="#l92.266"></a><span id="l92.266"> </span>
<a href="#l92.267"></a><span id="l92.267">   // Flush any buffered data from the MimeLeaf's decoder.</span>
<a href="#l92.268"></a><span id="l92.268" class="difflineminus">-  status = ((MimeLeafClass*)&amp;MIME_SUPERCLASS)-&gt;close_decoder(obj);</span>
<a href="#l92.269"></a><span id="l92.269" class="difflineplus">+  status = ((MimeLeafClass *)&amp;MIME_SUPERCLASS)-&gt;close_decoder(obj);</span>
<a href="#l92.270"></a><span id="l92.270">   if (status &lt; 0) return status;</span>
<a href="#l92.271"></a><span id="l92.271"> </span>
<a href="#l92.272"></a><span id="l92.272">   // If there is still data in the ibuffer, that means that the last</span>
<a href="#l92.273"></a><span id="l92.273">   // line of this part didn't end in a newline; so push it out anyway</span>
<a href="#l92.274"></a><span id="l92.274">   // (this means that the parse_line method will be called with a string</span>
<a href="#l92.275"></a><span id="l92.275">   // with no trailing newline, which isn't the usual case). We do this</span>
<a href="#l92.276"></a><span id="l92.276">   // here, rather than in MimeObject_parse_eof, because MimeObject isn't</span>
<a href="#l92.277"></a><span id="l92.277">   // aware of the rotating-and-converting / charset detection we need to</span>
<a href="#l92.278"></a><span id="l92.278">   // do first.</span>
<a href="#l92.279"></a><span id="l92.279" class="difflineminus">-  if (!abort_p &amp;&amp; obj-&gt;ibuffer_fp &gt; 0)</span>
<a href="#l92.280"></a><span id="l92.280" class="difflineminus">-  {</span>
<a href="#l92.281"></a><span id="l92.281" class="difflineminus">-    status = MimeInlineText_rotate_convert_and_parse_line (obj-&gt;ibuffer,</span>
<a href="#l92.282"></a><span id="l92.282" class="difflineminus">-                                                           obj-&gt;ibuffer_fp,</span>
<a href="#l92.283"></a><span id="l92.283" class="difflineminus">-                                                           obj);</span>
<a href="#l92.284"></a><span id="l92.284" class="difflineplus">+  if (!abort_p &amp;&amp; obj-&gt;ibuffer_fp &gt; 0) {</span>
<a href="#l92.285"></a><span id="l92.285" class="difflineplus">+    status = MimeInlineText_rotate_convert_and_parse_line(obj-&gt;ibuffer,</span>
<a href="#l92.286"></a><span id="l92.286" class="difflineplus">+                                                          obj-&gt;ibuffer_fp, obj);</span>
<a href="#l92.287"></a><span id="l92.287">     obj-&gt;ibuffer_fp = 0;</span>
<a href="#l92.288"></a><span id="l92.288" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l92.289"></a><span id="l92.289" class="difflineminus">-    {</span>
<a href="#l92.290"></a><span id="l92.290" class="difflineplus">+    if (status &lt; 0) {</span>
<a href="#l92.291"></a><span id="l92.291">       // We haven't found charset yet? Do it before return.</span>
<a href="#l92.292"></a><span id="l92.292">       if (text-&gt;inputAutodetect)</span>
<a href="#l92.293"></a><span id="l92.293">         status = MimeInlineText_open_dam(nullptr, 0, obj);</span>
<a href="#l92.294"></a><span id="l92.294"> </span>
<a href="#l92.295"></a><span id="l92.295">       obj-&gt;closed_p = true;</span>
<a href="#l92.296"></a><span id="l92.296">       return status;</span>
<a href="#l92.297"></a><span id="l92.297">     }</span>
<a href="#l92.298"></a><span id="l92.298">   }</span>
<a href="#l92.299"></a><span id="l92.299"> </span>
<a href="#l92.300"></a><span id="l92.300">   // We haven't found charset yet? Now is the time.</span>
<a href="#l92.301"></a><span id="l92.301" class="difflineminus">-  if (text-&gt;inputAutodetect)</span>
<a href="#l92.302"></a><span id="l92.302" class="difflineminus">-     status = MimeInlineText_open_dam(nullptr, 0, obj);</span>
<a href="#l92.303"></a><span id="l92.303" class="difflineplus">+  if (text-&gt;inputAutodetect) status = MimeInlineText_open_dam(nullptr, 0, obj);</span>
<a href="#l92.304"></a><span id="l92.304"> </span>
<a href="#l92.305"></a><span id="l92.305" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof (obj, abort_p);</span>
<a href="#l92.306"></a><span id="l92.306" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l92.307"></a><span id="l92.307"> }</span>
<a href="#l92.308"></a><span id="l92.308"> </span>
<a href="#l92.309"></a><span id="l92.309" class="difflineminus">-static int</span>
<a href="#l92.310"></a><span id="l92.310" class="difflineminus">-MimeInlineText_parse_end (MimeObject *obj, bool abort_p)</span>
<a href="#l92.311"></a><span id="l92.311" class="difflineminus">-{</span>
<a href="#l92.312"></a><span id="l92.312" class="difflineminus">-  MimeInlineText *text = (MimeInlineText *) obj;</span>
<a href="#l92.313"></a><span id="l92.313" class="difflineplus">+static int MimeInlineText_parse_end(MimeObject *obj, bool abort_p) {</span>
<a href="#l92.314"></a><span id="l92.314" class="difflineplus">+  MimeInlineText *text = (MimeInlineText *)obj;</span>
<a href="#l92.315"></a><span id="l92.315"> </span>
<a href="#l92.316"></a><span id="l92.316" class="difflineminus">-  if (obj-&gt;parsed_p)</span>
<a href="#l92.317"></a><span id="l92.317" class="difflineminus">-  {</span>
<a href="#l92.318"></a><span id="l92.318" class="difflineplus">+  if (obj-&gt;parsed_p) {</span>
<a href="#l92.319"></a><span id="l92.319">     PR_ASSERT(obj-&gt;closed_p);</span>
<a href="#l92.320"></a><span id="l92.320">     return 0;</span>
<a href="#l92.321"></a><span id="l92.321">   }</span>
<a href="#l92.322"></a><span id="l92.322"> </span>
<a href="#l92.323"></a><span id="l92.323">   // We won't be needing this buffer any more; nuke it.</span>
<a href="#l92.324"></a><span id="l92.324">   PR_FREEIF(text-&gt;cbuffer);</span>
<a href="#l92.325"></a><span id="l92.325">   text-&gt;cbuffer_size = 0;</span>
<a href="#l92.326"></a><span id="l92.326"> </span>
<a href="#l92.327"></a><span id="l92.327" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_end (obj, abort_p);</span>
<a href="#l92.328"></a><span id="l92.328" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_end(obj, abort_p);</span>
<a href="#l92.329"></a><span id="l92.329"> }</span>
<a href="#l92.330"></a><span id="l92.330"> </span>
<a href="#l92.331"></a><span id="l92.331" class="difflineminus">-</span>
<a href="#l92.332"></a><span id="l92.332"> // This maps A-M to N-Z and N-Z to A-M. All other characters are left alone.</span>
<a href="#l92.333"></a><span id="l92.333"> // (Comments in GNUS imply that for Japanese, one should rotate by 47?)</span>
<a href="#l92.334"></a><span id="l92.334"> static const unsigned char MimeInlineText_rot13_table[256] = {</span>
<a href="#l92.335"></a><span id="l92.335" class="difflineminus">-  0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20,</span>
<a href="#l92.336"></a><span id="l92.336" class="difflineminus">-  21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39,</span>
<a href="#l92.337"></a><span id="l92.337" class="difflineminus">-  40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58,</span>
<a href="#l92.338"></a><span id="l92.338" class="difflineminus">-  59, 60, 61, 62, 63, 64, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90,</span>
<a href="#l92.339"></a><span id="l92.339" class="difflineminus">-  65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 91, 92, 93, 94, 95, 96,</span>
<a href="#l92.340"></a><span id="l92.340" class="difflineminus">-  110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 97, 98,</span>
<a href="#l92.341"></a><span id="l92.341" class="difflineminus">-  99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 123, 124, 125, 126,</span>
<a href="#l92.342"></a><span id="l92.342" class="difflineminus">-  127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141,</span>
<a href="#l92.343"></a><span id="l92.343" class="difflineminus">-  142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156,</span>
<a href="#l92.344"></a><span id="l92.344" class="difflineminus">-  157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171,</span>
<a href="#l92.345"></a><span id="l92.345" class="difflineminus">-  172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186,</span>
<a href="#l92.346"></a><span id="l92.346" class="difflineminus">-  187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201,</span>
<a href="#l92.347"></a><span id="l92.347" class="difflineminus">-  202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216,</span>
<a href="#l92.348"></a><span id="l92.348" class="difflineminus">-  217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231,</span>
<a href="#l92.349"></a><span id="l92.349" class="difflineminus">-  232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246,</span>
<a href="#l92.350"></a><span id="l92.350" class="difflineminus">-  247, 248, 249, 250, 251, 252, 253, 254, 255 };</span>
<a href="#l92.351"></a><span id="l92.351" class="difflineplus">+    0,   1,   2,   3,   4,   5,   6,   7,   8,   9,   10,  11,  12,  13,  14,</span>
<a href="#l92.352"></a><span id="l92.352" class="difflineplus">+    15,  16,  17,  18,  19,  20,  21,  22,  23,  24,  25,  26,  27,  28,  29,</span>
<a href="#l92.353"></a><span id="l92.353" class="difflineplus">+    30,  31,  32,  33,  34,  35,  36,  37,  38,  39,  40,  41,  42,  43,  44,</span>
<a href="#l92.354"></a><span id="l92.354" class="difflineplus">+    45,  46,  47,  48,  49,  50,  51,  52,  53,  54,  55,  56,  57,  58,  59,</span>
<a href="#l92.355"></a><span id="l92.355" class="difflineplus">+    60,  61,  62,  63,  64,  78,  79,  80,  81,  82,  83,  84,  85,  86,  87,</span>
<a href="#l92.356"></a><span id="l92.356" class="difflineplus">+    88,  89,  90,  65,  66,  67,  68,  69,  70,  71,  72,  73,  74,  75,  76,</span>
<a href="#l92.357"></a><span id="l92.357" class="difflineplus">+    77,  91,  92,  93,  94,  95,  96,  110, 111, 112, 113, 114, 115, 116, 117,</span>
<a href="#l92.358"></a><span id="l92.358" class="difflineplus">+    118, 119, 120, 121, 122, 97,  98,  99,  100, 101, 102, 103, 104, 105, 106,</span>
<a href="#l92.359"></a><span id="l92.359" class="difflineplus">+    107, 108, 109, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134,</span>
<a href="#l92.360"></a><span id="l92.360" class="difflineplus">+    135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149,</span>
<a href="#l92.361"></a><span id="l92.361" class="difflineplus">+    150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164,</span>
<a href="#l92.362"></a><span id="l92.362" class="difflineplus">+    165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179,</span>
<a href="#l92.363"></a><span id="l92.363" class="difflineplus">+    180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194,</span>
<a href="#l92.364"></a><span id="l92.364" class="difflineplus">+    195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209,</span>
<a href="#l92.365"></a><span id="l92.365" class="difflineplus">+    210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224,</span>
<a href="#l92.366"></a><span id="l92.366" class="difflineplus">+    225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239,</span>
<a href="#l92.367"></a><span id="l92.367" class="difflineplus">+    240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254,</span>
<a href="#l92.368"></a><span id="l92.368" class="difflineplus">+    255};</span>
<a href="#l92.369"></a><span id="l92.369"> </span>
<a href="#l92.370"></a><span id="l92.370" class="difflineminus">-static int</span>
<a href="#l92.371"></a><span id="l92.371" class="difflineminus">-MimeInlineText_rot13_line (MimeObject *obj, char *line, int32_t length)</span>
<a href="#l92.372"></a><span id="l92.372" class="difflineminus">-{</span>
<a href="#l92.373"></a><span id="l92.373" class="difflineplus">+static int MimeInlineText_rot13_line(MimeObject *obj, char *line,</span>
<a href="#l92.374"></a><span id="l92.374" class="difflineplus">+                                     int32_t length) {</span>
<a href="#l92.375"></a><span id="l92.375">   unsigned char *s, *end;</span>
<a href="#l92.376"></a><span id="l92.376">   PR_ASSERT(line);</span>
<a href="#l92.377"></a><span id="l92.377">   if (!line) return -1;</span>
<a href="#l92.378"></a><span id="l92.378" class="difflineminus">-  s = (unsigned char *) line;</span>
<a href="#l92.379"></a><span id="l92.379" class="difflineplus">+  s = (unsigned char *)line;</span>
<a href="#l92.380"></a><span id="l92.380">   end = s + length;</span>
<a href="#l92.381"></a><span id="l92.381" class="difflineminus">-  while (s &lt; end)</span>
<a href="#l92.382"></a><span id="l92.382" class="difflineminus">-  {</span>
<a href="#l92.383"></a><span id="l92.383" class="difflineplus">+  while (s &lt; end) {</span>
<a href="#l92.384"></a><span id="l92.384">     *s = MimeInlineText_rot13_table[*s];</span>
<a href="#l92.385"></a><span id="l92.385">     s++;</span>
<a href="#l92.386"></a><span id="l92.386">   }</span>
<a href="#l92.387"></a><span id="l92.387">   return 0;</span>
<a href="#l92.388"></a><span id="l92.388"> }</span>
<a href="#l92.389"></a><span id="l92.389"> </span>
<a href="#l92.390"></a><span id="l92.390" class="difflineminus">-</span>
<a href="#l92.391"></a><span id="l92.391" class="difflineminus">-static int</span>
<a href="#l92.392"></a><span id="l92.392" class="difflineminus">-MimeInlineText_parse_decoded_buffer (const char *buf, int32_t size, MimeObject *obj)</span>
<a href="#l92.393"></a><span id="l92.393" class="difflineminus">-{</span>
<a href="#l92.394"></a><span id="l92.394" class="difflineplus">+static int MimeInlineText_parse_decoded_buffer(const char *buf, int32_t size,</span>
<a href="#l92.395"></a><span id="l92.395" class="difflineplus">+                                               MimeObject *obj) {</span>
<a href="#l92.396"></a><span id="l92.396">   PR_ASSERT(!obj-&gt;closed_p);</span>
<a href="#l92.397"></a><span id="l92.397">   if (obj-&gt;closed_p) return -1;</span>
<a href="#l92.398"></a><span id="l92.398"> </span>
<a href="#l92.399"></a><span id="l92.399">   // MimeLeaf takes care of this.</span>
<a href="#l92.400"></a><span id="l92.400">   PR_ASSERT(obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; obj-&gt;options-&gt;output_fn);</span>
<a href="#l92.401"></a><span id="l92.401">   if (!obj-&gt;options) return -1;</span>
<a href="#l92.402"></a><span id="l92.402"> </span>
<a href="#l92.403"></a><span id="l92.403">   // If we're supposed to write this object, but aren't supposed to convert</span>
<a href="#l92.404"></a><span id="l92.404">   // it to HTML, simply pass it through unaltered.</span>
<a href="#l92.405"></a><span id="l92.405" class="difflineminus">-  if (!obj-&gt;options-&gt;write_html_p &amp;&amp; obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l92.406"></a><span id="l92.406" class="difflineminus">-  return MimeObject_write(obj, buf, size, true);</span>
<a href="#l92.407"></a><span id="l92.407" class="difflineplus">+  if (!obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l92.408"></a><span id="l92.408" class="difflineplus">+      obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l92.409"></a><span id="l92.409" class="difflineplus">+    return MimeObject_write(obj, buf, size, true);</span>
<a href="#l92.410"></a><span id="l92.410"> </span>
<a href="#l92.411"></a><span id="l92.411">   // This is just like the parse_decoded_buffer method we inherit from the</span>
<a href="#l92.412"></a><span id="l92.412">   // MimeLeaf class, except that we line-buffer to our own wrapper on the</span>
<a href="#l92.413"></a><span id="l92.413">   // `parse_line` method instead of calling the `parse_line` method directly.</span>
<a href="#l92.414"></a><span id="l92.414" class="difflineminus">-  return mime_LineBuffer (buf, size,</span>
<a href="#l92.415"></a><span id="l92.415" class="difflineminus">-             &amp;obj-&gt;ibuffer, &amp;obj-&gt;ibuffer_size, &amp;obj-&gt;ibuffer_fp,</span>
<a href="#l92.416"></a><span id="l92.416" class="difflineminus">-             true,</span>
<a href="#l92.417"></a><span id="l92.417" class="difflineminus">-             ((int (*) (char *, int32_t, void *))</span>
<a href="#l92.418"></a><span id="l92.418" class="difflineminus">-              /* This cast is to turn void into MimeObject */</span>
<a href="#l92.419"></a><span id="l92.419" class="difflineminus">-              MimeInlineText_rotate_convert_and_parse_line),</span>
<a href="#l92.420"></a><span id="l92.420" class="difflineminus">-             obj);</span>
<a href="#l92.421"></a><span id="l92.421" class="difflineplus">+  return mime_LineBuffer(buf, size, &amp;obj-&gt;ibuffer, &amp;obj-&gt;ibuffer_size,</span>
<a href="#l92.422"></a><span id="l92.422" class="difflineplus">+                         &amp;obj-&gt;ibuffer_fp, true,</span>
<a href="#l92.423"></a><span id="l92.423" class="difflineplus">+                         ((int (*)(char *, int32_t, void *))</span>
<a href="#l92.424"></a><span id="l92.424" class="difflineplus">+                          /* This cast is to turn void into MimeObject */</span>
<a href="#l92.425"></a><span id="l92.425" class="difflineplus">+                          MimeInlineText_rotate_convert_and_parse_line),</span>
<a href="#l92.426"></a><span id="l92.426" class="difflineplus">+                         obj);</span>
<a href="#l92.427"></a><span id="l92.427"> }</span>
<a href="#l92.428"></a><span id="l92.428"> </span>
<a href="#l92.429"></a><span id="l92.429" class="difflineplus">+#define MimeInlineText_grow_cbuffer(text, desired_size)                       \</span>
<a href="#l92.430"></a><span id="l92.430" class="difflineplus">+  (((desired_size) &gt;= (text)-&gt;cbuffer_size)                                   \</span>
<a href="#l92.431"></a><span id="l92.431" class="difflineplus">+       ? mime_GrowBuffer((desired_size), sizeof(char), 100, &amp;(text)-&gt;cbuffer, \</span>
<a href="#l92.432"></a><span id="l92.432" class="difflineplus">+                         &amp;(text)-&gt;cbuffer_size)                               \</span>
<a href="#l92.433"></a><span id="l92.433" class="difflineplus">+       : 0)</span>
<a href="#l92.434"></a><span id="l92.434"> </span>
<a href="#l92.435"></a><span id="l92.435" class="difflineminus">-#define MimeInlineText_grow_cbuffer(text, desired_size) \</span>
<a href="#l92.436"></a><span id="l92.436" class="difflineminus">-  (((desired_size) &gt;= (text)-&gt;cbuffer_size) ? \</span>
<a href="#l92.437"></a><span id="l92.437" class="difflineminus">-   mime_GrowBuffer ((desired_size), sizeof(char), 100, \</span>
<a href="#l92.438"></a><span id="l92.438" class="difflineminus">-           &amp;(text)-&gt;cbuffer, &amp;(text)-&gt;cbuffer_size) \</span>
<a href="#l92.439"></a><span id="l92.439" class="difflineminus">-   : 0)</span>
<a href="#l92.440"></a><span id="l92.440" class="difflineminus">-</span>
<a href="#l92.441"></a><span id="l92.441" class="difflineminus">-static int</span>
<a href="#l92.442"></a><span id="l92.442" class="difflineminus">-MimeInlineText_convert_and_parse_line(char *line, int32_t length, MimeObject *obj)</span>
<a href="#l92.443"></a><span id="l92.443" class="difflineminus">-{</span>
<a href="#l92.444"></a><span id="l92.444" class="difflineplus">+static int MimeInlineText_convert_and_parse_line(char *line, int32_t length,</span>
<a href="#l92.445"></a><span id="l92.445" class="difflineplus">+                                                 MimeObject *obj) {</span>
<a href="#l92.446"></a><span id="l92.446">   int status;</span>
<a href="#l92.447"></a><span id="l92.447">   nsAutoCString converted;</span>
<a href="#l92.448"></a><span id="l92.448"> </span>
<a href="#l92.449"></a><span id="l92.449" class="difflineminus">-  MimeInlineText *text = (MimeInlineText *) obj;</span>
<a href="#l92.450"></a><span id="l92.450" class="difflineplus">+  MimeInlineText *text = (MimeInlineText *)obj;</span>
<a href="#l92.451"></a><span id="l92.451"> </span>
<a href="#l92.452"></a><span id="l92.452" class="difflineminus">-  // In case of charset autodetection, charset can be overridden by meta charset.</span>
<a href="#l92.453"></a><span id="l92.453" class="difflineplus">+  // In case of charset autodetection, charset can be overridden by meta</span>
<a href="#l92.454"></a><span id="l92.454" class="difflineplus">+  // charset.</span>
<a href="#l92.455"></a><span id="l92.455">   if (text-&gt;charsetOverridable) {</span>
<a href="#l92.456"></a><span id="l92.456" class="difflineminus">-    if (mime_typep(obj, (MimeObjectClass *) &amp;mimeInlineTextHTMLClass))</span>
<a href="#l92.457"></a><span id="l92.457" class="difflineminus">-    {</span>
<a href="#l92.458"></a><span id="l92.458" class="difflineminus">-      MimeInlineTextHTML  *textHTML = (MimeInlineTextHTML *) obj;</span>
<a href="#l92.459"></a><span id="l92.459" class="difflineminus">-      if (textHTML-&gt;charset &amp;&amp;</span>
<a href="#l92.460"></a><span id="l92.460" class="difflineminus">-          *textHTML-&gt;charset &amp;&amp;</span>
<a href="#l92.461"></a><span id="l92.461" class="difflineminus">-          strcmp(textHTML-&gt;charset, text-&gt;charset))</span>
<a href="#l92.462"></a><span id="l92.462" class="difflineminus">-      {</span>
<a href="#l92.463"></a><span id="l92.463" class="difflineminus">-        // If meta tag specified charset is different from our detected result, use meta charset,</span>
<a href="#l92.464"></a><span id="l92.464" class="difflineminus">-        // but we don't want to redo previous lines.</span>
<a href="#l92.465"></a><span id="l92.465" class="difflineplus">+    if (mime_typep(obj, (MimeObjectClass *)&amp;mimeInlineTextHTMLClass)) {</span>
<a href="#l92.466"></a><span id="l92.466" class="difflineplus">+      MimeInlineTextHTML *textHTML = (MimeInlineTextHTML *)obj;</span>
<a href="#l92.467"></a><span id="l92.467" class="difflineplus">+      if (textHTML-&gt;charset &amp;&amp; *textHTML-&gt;charset &amp;&amp;</span>
<a href="#l92.468"></a><span id="l92.468" class="difflineplus">+          strcmp(textHTML-&gt;charset, text-&gt;charset)) {</span>
<a href="#l92.469"></a><span id="l92.469" class="difflineplus">+        // If meta tag specified charset is different from our detected result,</span>
<a href="#l92.470"></a><span id="l92.470" class="difflineplus">+        // use meta charset, but we don't want to redo previous lines.</span>
<a href="#l92.471"></a><span id="l92.471">         PR_FREEIF(text-&gt;charset);</span>
<a href="#l92.472"></a><span id="l92.472">         text-&gt;charset = strdup(textHTML-&gt;charset);</span>
<a href="#l92.473"></a><span id="l92.473"> </span>
<a href="#l92.474"></a><span id="l92.474">         // Update MsgWindow charset if we are instructed to do so.</span>
<a href="#l92.475"></a><span id="l92.475">         if (text-&gt;needUpdateMsgWinCharset &amp;&amp; *text-&gt;charset)</span>
<a href="#l92.476"></a><span id="l92.476">           SetMailCharacterSetToMsgWindow(obj, text-&gt;charset);</span>
<a href="#l92.477"></a><span id="l92.477">       }</span>
<a href="#l92.478"></a><span id="l92.478">     }</span>
<a href="#l92.479"></a><span id="l92.479">   }</span>
<a href="#l92.480"></a><span id="l92.480"> </span>
<a href="#l92.481"></a><span id="l92.481" class="difflineminus">-  status = obj-&gt;options-&gt;charset_conversion_fn(line, length,</span>
<a href="#l92.482"></a><span id="l92.482" class="difflineminus">-                       text-&gt;charset,</span>
<a href="#l92.483"></a><span id="l92.483" class="difflineminus">-                       converted,</span>
<a href="#l92.484"></a><span id="l92.484" class="difflineminus">-                       obj-&gt;options-&gt;stream_closure);</span>
<a href="#l92.485"></a><span id="l92.485" class="difflineplus">+  status = obj-&gt;options-&gt;charset_conversion_fn(</span>
<a href="#l92.486"></a><span id="l92.486" class="difflineplus">+      line, length, text-&gt;charset, converted, obj-&gt;options-&gt;stream_closure);</span>
<a href="#l92.487"></a><span id="l92.487"> </span>
<a href="#l92.488"></a><span id="l92.488" class="difflineminus">-  if (status == 0)</span>
<a href="#l92.489"></a><span id="l92.489" class="difflineminus">-  {</span>
<a href="#l92.490"></a><span id="l92.490" class="difflineminus">-    line = (char *) converted.get();</span>
<a href="#l92.491"></a><span id="l92.491" class="difflineplus">+  if (status == 0) {</span>
<a href="#l92.492"></a><span id="l92.492" class="difflineplus">+    line = (char *)converted.get();</span>
<a href="#l92.493"></a><span id="l92.493">     length = converted.Length();</span>
<a href="#l92.494"></a><span id="l92.494">   }</span>
<a href="#l92.495"></a><span id="l92.495"> </span>
<a href="#l92.496"></a><span id="l92.496">   // Now that the line has been converted, call the subclass's parse_line</span>
<a href="#l92.497"></a><span id="l92.497">   // method with the decoded data.</span>
<a href="#l92.498"></a><span id="l92.498">   status = obj-&gt;clazz-&gt;parse_line(line, length, obj);</span>
<a href="#l92.499"></a><span id="l92.499"> </span>
<a href="#l92.500"></a><span id="l92.500">   return status;</span>
<a href="#l92.501"></a><span id="l92.501"> }</span>
<a href="#l92.502"></a><span id="l92.502"> </span>
<a href="#l92.503"></a><span id="l92.503" class="difflineminus">-// In this function call, all buffered lines in lineDam will be sent to charset detector</span>
<a href="#l92.504"></a><span id="l92.504" class="difflineminus">-// and a charset will be used to parse all those line and following lines in this mime obj.</span>
<a href="#l92.505"></a><span id="l92.505" class="difflineminus">-static int</span>
<a href="#l92.506"></a><span id="l92.506" class="difflineminus">-MimeInlineText_open_dam(char *line, int32_t length, MimeObject *obj)</span>
<a href="#l92.507"></a><span id="l92.507" class="difflineminus">-{</span>
<a href="#l92.508"></a><span id="l92.508" class="difflineminus">-  MimeInlineText *text = (MimeInlineText *) obj;</span>
<a href="#l92.509"></a><span id="l92.509" class="difflineplus">+// In this function call, all buffered lines in lineDam will be sent to charset</span>
<a href="#l92.510"></a><span id="l92.510" class="difflineplus">+// detector and a charset will be used to parse all those line and following</span>
<a href="#l92.511"></a><span id="l92.511" class="difflineplus">+// lines in this mime obj.</span>
<a href="#l92.512"></a><span id="l92.512" class="difflineplus">+static int MimeInlineText_open_dam(char *line, int32_t length,</span>
<a href="#l92.513"></a><span id="l92.513" class="difflineplus">+                                   MimeObject *obj) {</span>
<a href="#l92.514"></a><span id="l92.514" class="difflineplus">+  MimeInlineText *text = (MimeInlineText *)obj;</span>
<a href="#l92.515"></a><span id="l92.515">   nsAutoCString detectedCharset;</span>
<a href="#l92.516"></a><span id="l92.516">   nsresult res = NS_OK;</span>
<a href="#l92.517"></a><span id="l92.517">   int status = 0;</span>
<a href="#l92.518"></a><span id="l92.518">   int32_t i;</span>
<a href="#l92.519"></a><span id="l92.519"> </span>
<a href="#l92.520"></a><span id="l92.520">   if (text-&gt;curDamOffset &lt;= 0) {</span>
<a href="#l92.521"></a><span id="l92.521">     // There is nothing in dam, use current line for detection.</span>
<a href="#l92.522"></a><span id="l92.522">     if (length &gt; 0) {</span>
<a href="#l92.523"></a><span id="l92.523">       res = MIME_detect_charset(line, length, detectedCharset);</span>
<a href="#l92.524"></a><span id="l92.524">     }</span>
<a href="#l92.525"></a><span id="l92.525">   } else {</span>
<a href="#l92.526"></a><span id="l92.526">     // We have stuff in dam, use the one.</span>
<a href="#l92.527"></a><span id="l92.527" class="difflineminus">-    res = MIME_detect_charset(text-&gt;lineDamBuffer, text-&gt;curDamOffset, detectedCharset);</span>
<a href="#l92.528"></a><span id="l92.528" class="difflineplus">+    res = MIME_detect_charset(text-&gt;lineDamBuffer, text-&gt;curDamOffset,</span>
<a href="#l92.529"></a><span id="l92.529" class="difflineplus">+                              detectedCharset);</span>
<a href="#l92.530"></a><span id="l92.530">   }</span>
<a href="#l92.531"></a><span id="l92.531"> </span>
<a href="#l92.532"></a><span id="l92.532">   // Set the charset for this object.</span>
<a href="#l92.533"></a><span id="l92.533">   if (NS_SUCCEEDED(res) &amp;&amp; !detectedCharset.IsEmpty()) {</span>
<a href="#l92.534"></a><span id="l92.534">     PR_FREEIF(text-&gt;charset);</span>
<a href="#l92.535"></a><span id="l92.535">     text-&gt;charset = ToNewCString(detectedCharset);</span>
<a href="#l92.536"></a><span id="l92.536"> </span>
<a href="#l92.537"></a><span id="l92.537">     // Update MsgWindow charset if we are instructed to do so.</span>
<a href="#l92.538"></a><span id="l92.538">     if (text-&gt;needUpdateMsgWinCharset &amp;&amp; text-&gt;charset)</span>
<a href="#l92.539"></a><span id="l92.539">       SetMailCharacterSetToMsgWindow(obj, text-&gt;charset);</span>
<a href="#l92.540"></a><span id="l92.540">   }</span>
<a href="#l92.541"></a><span id="l92.541"> </span>
<a href="#l92.542"></a><span id="l92.542">   // Process dam and line using the charset.</span>
<a href="#l92.543"></a><span id="l92.543">   if (text-&gt;curDamOffset) {</span>
<a href="#l92.544"></a><span id="l92.544" class="difflineminus">-    for (i = 0; i &lt; text-&gt;lastLineInDam-1; i++)</span>
<a href="#l92.545"></a><span id="l92.545" class="difflineminus">-    {</span>
<a href="#l92.546"></a><span id="l92.546" class="difflineplus">+    for (i = 0; i &lt; text-&gt;lastLineInDam - 1; i++) {</span>
<a href="#l92.547"></a><span id="l92.547">       status = MimeInlineText_convert_and_parse_line(</span>
<a href="#l92.548"></a><span id="l92.548" class="difflineminus">-                text-&gt;lineDamPtrs[i],</span>
<a href="#l92.549"></a><span id="l92.549" class="difflineminus">-                text-&gt;lineDamPtrs[i+1] - text-&gt;lineDamPtrs[i],</span>
<a href="#l92.550"></a><span id="l92.550" class="difflineminus">-                obj  );</span>
<a href="#l92.551"></a><span id="l92.551" class="difflineplus">+          text-&gt;lineDamPtrs[i], text-&gt;lineDamPtrs[i + 1] - text-&gt;lineDamPtrs[i],</span>
<a href="#l92.552"></a><span id="l92.552" class="difflineplus">+          obj);</span>
<a href="#l92.553"></a><span id="l92.553">     }</span>
<a href="#l92.554"></a><span id="l92.554">     status = MimeInlineText_convert_and_parse_line(</span>
<a href="#l92.555"></a><span id="l92.555" class="difflineminus">-                text-&gt;lineDamPtrs[i],</span>
<a href="#l92.556"></a><span id="l92.556" class="difflineminus">-                text-&gt;lineDamBuffer + text-&gt;curDamOffset - text-&gt;lineDamPtrs[i],</span>
<a href="#l92.557"></a><span id="l92.557" class="difflineminus">-                obj );</span>
<a href="#l92.558"></a><span id="l92.558" class="difflineplus">+        text-&gt;lineDamPtrs[i],</span>
<a href="#l92.559"></a><span id="l92.559" class="difflineplus">+        text-&gt;lineDamBuffer + text-&gt;curDamOffset - text-&gt;lineDamPtrs[i], obj);</span>
<a href="#l92.560"></a><span id="l92.560">   }</span>
<a href="#l92.561"></a><span id="l92.561"> </span>
<a href="#l92.562"></a><span id="l92.562" class="difflineminus">-  if (length)</span>
<a href="#l92.563"></a><span id="l92.563" class="difflineminus">-    status = MimeInlineText_convert_and_parse_line(line, length, obj);</span>
<a href="#l92.564"></a><span id="l92.564" class="difflineplus">+  if (length) status = MimeInlineText_convert_and_parse_line(line, length, obj);</span>
<a href="#l92.565"></a><span id="l92.565"> </span>
<a href="#l92.566"></a><span id="l92.566">   PR_Free(text-&gt;lineDamPtrs);</span>
<a href="#l92.567"></a><span id="l92.567">   PR_Free(text-&gt;lineDamBuffer);</span>
<a href="#l92.568"></a><span id="l92.568">   text-&gt;lineDamPtrs = nullptr;</span>
<a href="#l92.569"></a><span id="l92.569">   text-&gt;lineDamBuffer = nullptr;</span>
<a href="#l92.570"></a><span id="l92.570">   text-&gt;inputAutodetect = false;</span>
<a href="#l92.571"></a><span id="l92.571"> </span>
<a href="#l92.572"></a><span id="l92.572">   return status;</span>
<a href="#l92.573"></a><span id="l92.573"> }</span>
<a href="#l92.574"></a><span id="l92.574"> </span>
<a href="#l92.575"></a><span id="l92.575" class="difflineminus">-</span>
<a href="#l92.576"></a><span id="l92.576" class="difflineminus">-static int</span>
<a href="#l92.577"></a><span id="l92.577" class="difflineminus">-MimeInlineText_rotate_convert_and_parse_line(char *line, int32_t length,</span>
<a href="#l92.578"></a><span id="l92.578" class="difflineminus">-                       MimeObject *obj)</span>
<a href="#l92.579"></a><span id="l92.579" class="difflineminus">-{</span>
<a href="#l92.580"></a><span id="l92.580" class="difflineplus">+static int MimeInlineText_rotate_convert_and_parse_line(char *line,</span>
<a href="#l92.581"></a><span id="l92.581" class="difflineplus">+                                                        int32_t length,</span>
<a href="#l92.582"></a><span id="l92.582" class="difflineplus">+                                                        MimeObject *obj) {</span>
<a href="#l92.583"></a><span id="l92.583">   int status = 0;</span>
<a href="#l92.584"></a><span id="l92.584" class="difflineminus">-  MimeInlineTextClass *textc = (MimeInlineTextClass *) obj-&gt;clazz;</span>
<a href="#l92.585"></a><span id="l92.585" class="difflineplus">+  MimeInlineTextClass *textc = (MimeInlineTextClass *)obj-&gt;clazz;</span>
<a href="#l92.586"></a><span id="l92.586"> </span>
<a href="#l92.587"></a><span id="l92.587">   PR_ASSERT(!obj-&gt;closed_p);</span>
<a href="#l92.588"></a><span id="l92.588">   if (obj-&gt;closed_p) return -1;</span>
<a href="#l92.589"></a><span id="l92.589"> </span>
<a href="#l92.590"></a><span id="l92.590">   // Rotate the line, if desired (this happens on the raw data, before any</span>
<a href="#l92.591"></a><span id="l92.591">   // charset conversion).</span>
<a href="#l92.592"></a><span id="l92.592" class="difflineminus">-  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;rot13_p)</span>
<a href="#l92.593"></a><span id="l92.593" class="difflineminus">-  {</span>
<a href="#l92.594"></a><span id="l92.594" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;rot13_p) {</span>
<a href="#l92.595"></a><span id="l92.595">     status = textc-&gt;rot13_line(obj, line, length);</span>
<a href="#l92.596"></a><span id="l92.596">     if (status &lt; 0) return status;</span>
<a href="#l92.597"></a><span id="l92.597">   }</span>
<a href="#l92.598"></a><span id="l92.598"> </span>
<a href="#l92.599"></a><span id="l92.599">   // Now convert to the canonical charset, if desired.</span>
<a href="#l92.600"></a><span id="l92.600" class="difflineminus">-  bool    doConvert = true;</span>
<a href="#l92.601"></a><span id="l92.601" class="difflineplus">+  bool doConvert = true;</span>
<a href="#l92.602"></a><span id="l92.602">   // Don't convert vCard data</span>
<a href="#l92.603"></a><span id="l92.603" class="difflineminus">-  if ( ( (obj-&gt;content_type) &amp;&amp; (!PL_strcasecmp(obj-&gt;content_type, TEXT_VCARD)) ) ||</span>
<a href="#l92.604"></a><span id="l92.604" class="difflineminus">-       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs)</span>
<a href="#l92.605"></a><span id="l92.605" class="difflineminus">-       || obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l92.606"></a><span id="l92.606" class="difflineplus">+  if (((obj-&gt;content_type) &amp;&amp;</span>
<a href="#l92.607"></a><span id="l92.607" class="difflineplus">+       (!PL_strcasecmp(obj-&gt;content_type, TEXT_VCARD))) ||</span>
<a href="#l92.608"></a><span id="l92.608" class="difflineplus">+      (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs) ||</span>
<a href="#l92.609"></a><span id="l92.609" class="difflineplus">+      obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l92.610"></a><span id="l92.610">     doConvert = false;</span>
<a href="#l92.611"></a><span id="l92.611"> </span>
<a href="#l92.612"></a><span id="l92.612">   // Only convert if the user prefs is false.</span>
<a href="#l92.613"></a><span id="l92.613" class="difflineminus">-  if ( (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;charset_conversion_fn) &amp;&amp;</span>
<a href="#l92.614"></a><span id="l92.614" class="difflineminus">-       (!obj-&gt;options-&gt;force_user_charset) &amp;&amp;</span>
<a href="#l92.615"></a><span id="l92.615" class="difflineminus">-       (doConvert)</span>
<a href="#l92.616"></a><span id="l92.616" class="difflineminus">-     )</span>
<a href="#l92.617"></a><span id="l92.617" class="difflineminus">-  {</span>
<a href="#l92.618"></a><span id="l92.618" class="difflineminus">-    MimeInlineText  *text = (MimeInlineText *) obj;</span>
<a href="#l92.619"></a><span id="l92.619" class="difflineplus">+  if ((obj-&gt;options &amp;&amp; obj-&gt;options-&gt;charset_conversion_fn) &amp;&amp;</span>
<a href="#l92.620"></a><span id="l92.620" class="difflineplus">+      (!obj-&gt;options-&gt;force_user_charset) &amp;&amp; (doConvert)) {</span>
<a href="#l92.621"></a><span id="l92.621" class="difflineplus">+    MimeInlineText *text = (MimeInlineText *)obj;</span>
<a href="#l92.622"></a><span id="l92.622"> </span>
<a href="#l92.623"></a><span id="l92.623" class="difflineminus">-    if (!text-&gt;initializeCharset)</span>
<a href="#l92.624"></a><span id="l92.624" class="difflineminus">-    {</span>
<a href="#l92.625"></a><span id="l92.625" class="difflineplus">+    if (!text-&gt;initializeCharset) {</span>
<a href="#l92.626"></a><span id="l92.626">       MimeInlineText_initializeCharset(obj);</span>
<a href="#l92.627"></a><span id="l92.627">       // Update MsgWindow charset if we are instructed to do so.</span>
<a href="#l92.628"></a><span id="l92.628">       if (text-&gt;needUpdateMsgWinCharset &amp;&amp; *text-&gt;charset)</span>
<a href="#l92.629"></a><span id="l92.629">         SetMailCharacterSetToMsgWindow(obj, text-&gt;charset);</span>
<a href="#l92.630"></a><span id="l92.630">     }</span>
<a href="#l92.631"></a><span id="l92.631"> </span>
<a href="#l92.632"></a><span id="l92.632">     // If autodetect is on, push line to dam.</span>
<a href="#l92.633"></a><span id="l92.633" class="difflineminus">-    if (text-&gt;inputAutodetect)</span>
<a href="#l92.634"></a><span id="l92.634" class="difflineminus">-    {</span>
<a href="#l92.635"></a><span id="l92.635" class="difflineminus">-      // See if we reach the lineDam buffer limit, if so, there is no need to keep buffering.</span>
<a href="#l92.636"></a><span id="l92.636" class="difflineplus">+    if (text-&gt;inputAutodetect) {</span>
<a href="#l92.637"></a><span id="l92.637" class="difflineplus">+      // See if we reach the lineDam buffer limit, if so, there is no need to</span>
<a href="#l92.638"></a><span id="l92.638" class="difflineplus">+      // keep buffering.</span>
<a href="#l92.639"></a><span id="l92.639">       if (text-&gt;lastLineInDam &gt;= DAM_MAX_LINES ||</span>
<a href="#l92.640"></a><span id="l92.640">           DAM_MAX_BUFFER_SIZE - text-&gt;curDamOffset &lt;= length) {</span>
<a href="#l92.641"></a><span id="l92.641" class="difflineminus">-        // We let open dam process this line as well as thing that already in Dam.</span>
<a href="#l92.642"></a><span id="l92.642" class="difflineminus">-        // In case there is nothing in dam because this line is too big, we need to</span>
<a href="#l92.643"></a><span id="l92.643" class="difflineminus">-        // perform autodetect on this line.</span>
<a href="#l92.644"></a><span id="l92.644" class="difflineplus">+        // We let open dam process this line as well as thing that already in</span>
<a href="#l92.645"></a><span id="l92.645" class="difflineplus">+        // Dam. In case there is nothing in dam because this line is too big, we</span>
<a href="#l92.646"></a><span id="l92.646" class="difflineplus">+        // need to perform autodetect on this line.</span>
<a href="#l92.647"></a><span id="l92.647">         status = MimeInlineText_open_dam(line, length, obj);</span>
<a href="#l92.648"></a><span id="l92.648" class="difflineminus">-      }</span>
<a href="#l92.649"></a><span id="l92.649" class="difflineminus">-      else {</span>
<a href="#l92.650"></a><span id="l92.650" class="difflineplus">+      } else {</span>
<a href="#l92.651"></a><span id="l92.651">         // Buffering current line.</span>
<a href="#l92.652"></a><span id="l92.652" class="difflineminus">-        text-&gt;lineDamPtrs[text-&gt;lastLineInDam] = text-&gt;lineDamBuffer + text-&gt;curDamOffset;</span>
<a href="#l92.653"></a><span id="l92.653" class="difflineplus">+        text-&gt;lineDamPtrs[text-&gt;lastLineInDam] =</span>
<a href="#l92.654"></a><span id="l92.654" class="difflineplus">+            text-&gt;lineDamBuffer + text-&gt;curDamOffset;</span>
<a href="#l92.655"></a><span id="l92.655">         memcpy(text-&gt;lineDamPtrs[text-&gt;lastLineInDam], line, length);</span>
<a href="#l92.656"></a><span id="l92.656">         text-&gt;lastLineInDam++;</span>
<a href="#l92.657"></a><span id="l92.657">         text-&gt;curDamOffset += length;</span>
<a href="#l92.658"></a><span id="l92.658">       }</span>
<a href="#l92.659"></a><span id="l92.659" class="difflineminus">-    }</span>
<a href="#l92.660"></a><span id="l92.660" class="difflineminus">-    else</span>
<a href="#l92.661"></a><span id="l92.661" class="difflineplus">+    } else</span>
<a href="#l92.662"></a><span id="l92.662">       status = MimeInlineText_convert_and_parse_line(line, length, obj);</span>
<a href="#l92.663"></a><span id="l92.663" class="difflineminus">-  }</span>
<a href="#l92.664"></a><span id="l92.664" class="difflineminus">-  else</span>
<a href="#l92.665"></a><span id="l92.665" class="difflineplus">+  } else</span>
<a href="#l92.666"></a><span id="l92.666">     status = obj-&gt;clazz-&gt;parse_line(line, length, obj);</span>
<a href="#l92.667"></a><span id="l92.667"> </span>
<a href="#l92.668"></a><span id="l92.668">   return status;</span>
<a href="#l92.669"></a><span id="l92.669"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1" class="difflineminus">--- a/mailnews/mime/src/mimetext.h</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineplus">+++ b/mailnews/mime/src/mimetext.h</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineat">@@ -36,44 +36,44 @@</span>
<a href="#l93.4"></a><span id="l93.4">     low ASCII values (under hex 0x40, octal 0100, which is '@') but it</span>
<a href="#l93.5"></a><span id="l93.5">     is NOT safe to search for values higher than that -- they may be</span>
<a href="#l93.6"></a><span id="l93.6">     being used as the subsequent bytes in a multi-byte escape sequence.</span>
<a href="#l93.7"></a><span id="l93.7">     It's a nice coincidence that HTML's critical characters (&quot;&lt;&quot;, &quot;&gt;&quot;,</span>
<a href="#l93.8"></a><span id="l93.8">     and &quot;&amp;&quot;) have values under 0x40...</span>
<a href="#l93.9"></a><span id="l93.9">  */</span>
<a href="#l93.10"></a><span id="l93.10"> </span>
<a href="#l93.11"></a><span id="l93.11"> typedef struct MimeInlineTextClass MimeInlineTextClass;</span>
<a href="#l93.12"></a><span id="l93.12" class="difflineminus">-typedef struct MimeInlineText      MimeInlineText;</span>
<a href="#l93.13"></a><span id="l93.13" class="difflineplus">+typedef struct MimeInlineText MimeInlineText;</span>
<a href="#l93.14"></a><span id="l93.14"> </span>
<a href="#l93.15"></a><span id="l93.15"> struct MimeInlineTextClass {</span>
<a href="#l93.16"></a><span id="l93.16" class="difflineminus">-  MimeLeafClass   leaf;</span>
<a href="#l93.17"></a><span id="l93.17" class="difflineminus">-  int (*rot13_line) (MimeObject *obj, char *line, int32_t length);</span>
<a href="#l93.18"></a><span id="l93.18" class="difflineminus">-  int (*convert_line_charset) (MimeObject *obj, char *line, int32_t length);</span>
<a href="#l93.19"></a><span id="l93.19" class="difflineminus">-  int (*initialize_charset) (MimeObject *obj);</span>
<a href="#l93.20"></a><span id="l93.20" class="difflineplus">+  MimeLeafClass leaf;</span>
<a href="#l93.21"></a><span id="l93.21" class="difflineplus">+  int (*rot13_line)(MimeObject *obj, char *line, int32_t length);</span>
<a href="#l93.22"></a><span id="l93.22" class="difflineplus">+  int (*convert_line_charset)(MimeObject *obj, char *line, int32_t length);</span>
<a href="#l93.23"></a><span id="l93.23" class="difflineplus">+  int (*initialize_charset)(MimeObject *obj);</span>
<a href="#l93.24"></a><span id="l93.24"> };</span>
<a href="#l93.25"></a><span id="l93.25"> </span>
<a href="#l93.26"></a><span id="l93.26"> extern MimeInlineTextClass mimeInlineTextClass;</span>
<a href="#l93.27"></a><span id="l93.27"> </span>
<a href="#l93.28"></a><span id="l93.28" class="difflineminus">-#define DAM_MAX_BUFFER_SIZE 8*1024</span>
<a href="#l93.29"></a><span id="l93.29" class="difflineminus">-#define DAM_MAX_LINES  1024</span>
<a href="#l93.30"></a><span id="l93.30" class="difflineplus">+#define DAM_MAX_BUFFER_SIZE 8 * 1024</span>
<a href="#l93.31"></a><span id="l93.31" class="difflineplus">+#define DAM_MAX_LINES 1024</span>
<a href="#l93.32"></a><span id="l93.32"> </span>
<a href="#l93.33"></a><span id="l93.33"> struct MimeInlineText {</span>
<a href="#l93.34"></a><span id="l93.34" class="difflineminus">-  MimeLeaf leaf;      /* superclass variables */</span>
<a href="#l93.35"></a><span id="l93.35" class="difflineminus">-  char *charset;      /* The charset from the content-type of this</span>
<a href="#l93.36"></a><span id="l93.36" class="difflineminus">-                         object, or the caller-specified overrides</span>
<a href="#l93.37"></a><span id="l93.37" class="difflineminus">-                         or defaults. */</span>
<a href="#l93.38"></a><span id="l93.38" class="difflineplus">+  MimeLeaf leaf; /* superclass variables */</span>
<a href="#l93.39"></a><span id="l93.39" class="difflineplus">+  char *charset; /* The charset from the content-type of this</span>
<a href="#l93.40"></a><span id="l93.40" class="difflineplus">+                    object, or the caller-specified overrides</span>
<a href="#l93.41"></a><span id="l93.41" class="difflineplus">+                    or defaults. */</span>
<a href="#l93.42"></a><span id="l93.42">   bool charsetOverridable;</span>
<a href="#l93.43"></a><span id="l93.43">   bool needUpdateMsgWinCharset;</span>
<a href="#l93.44"></a><span id="l93.44" class="difflineminus">-  char *cbuffer;      /* Buffer used for charset conversion. */</span>
<a href="#l93.45"></a><span id="l93.45" class="difflineplus">+  char *cbuffer; /* Buffer used for charset conversion. */</span>
<a href="#l93.46"></a><span id="l93.46">   int32_t cbuffer_size;</span>
<a href="#l93.47"></a><span id="l93.47"> </span>
<a href="#l93.48"></a><span id="l93.48" class="difflineminus">-  bool    inputAutodetect;</span>
<a href="#l93.49"></a><span id="l93.49" class="difflineminus">-  bool    initializeCharset;</span>
<a href="#l93.50"></a><span id="l93.50" class="difflineplus">+  bool inputAutodetect;</span>
<a href="#l93.51"></a><span id="l93.51" class="difflineplus">+  bool initializeCharset;</span>
<a href="#l93.52"></a><span id="l93.52">   int32_t lastLineInDam;</span>
<a href="#l93.53"></a><span id="l93.53">   int32_t curDamOffset;</span>
<a href="#l93.54"></a><span id="l93.54">   char *lineDamBuffer;</span>
<a href="#l93.55"></a><span id="l93.55">   char **lineDamPtrs;</span>
<a href="#l93.56"></a><span id="l93.56"> };</span>
<a href="#l93.57"></a><span id="l93.57"> </span>
<a href="#l93.58"></a><span id="l93.58" class="difflineminus">-#define MimeInlineTextClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l93.59"></a><span id="l93.59" class="difflineminus">-  { MimeLeafClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l93.60"></a><span id="l93.60" class="difflineplus">+#define MimeInlineTextClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l93.61"></a><span id="l93.61" class="difflineplus">+  { MimeLeafClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l93.62"></a><span id="l93.62"> </span>
<a href="#l93.63"></a><span id="l93.63"> #endif /* _MIMETEXT_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1" class="difflineminus">--- a/mailnews/mime/src/mimethpl.cpp</span>
<a href="#l94.2"></a><span id="l94.2" class="difflineplus">+++ b/mailnews/mime/src/mimethpl.cpp</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineat">@@ -10,156 +10,142 @@</span>
<a href="#l94.4"></a><span id="l94.4"> /* If you fix a bug here, check, if the same is also in mimethsa, because that</span>
<a href="#l94.5"></a><span id="l94.5">    class is based on this class. */</span>
<a href="#l94.6"></a><span id="l94.6"> </span>
<a href="#l94.7"></a><span id="l94.7"> #include &quot;mimethpl.h&quot;</span>
<a href="#l94.8"></a><span id="l94.8"> #include &quot;prlog.h&quot;</span>
<a href="#l94.9"></a><span id="l94.9"> #include &quot;msgCore.h&quot;</span>
<a href="#l94.10"></a><span id="l94.10"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l94.11"></a><span id="l94.11"> #include &quot;nsString.h&quot;</span>
<a href="#l94.12"></a><span id="l94.12" class="difflineminus">-#include &quot;nsIDocumentEncoder.h&quot; // for output flags</span>
<a href="#l94.13"></a><span id="l94.13" class="difflineplus">+#include &quot;nsIDocumentEncoder.h&quot;  // for output flags</span>
<a href="#l94.14"></a><span id="l94.14"> </span>
<a href="#l94.15"></a><span id="l94.15"> #define MIME_SUPERCLASS mimeInlineTextPlainClass</span>
<a href="#l94.16"></a><span id="l94.16"> /* I should use the Flowed class as base (because our HTML-&gt;TXT converter</span>
<a href="#l94.17"></a><span id="l94.17">    can generate flowed, and we tell it to) - this would get a bit nicer</span>
<a href="#l94.18"></a><span id="l94.18">    rendering. However, that class is more picky about line endings</span>
<a href="#l94.19"></a><span id="l94.19">    and I currently don't feel like splitting up the generated plaintext</span>
<a href="#l94.20"></a><span id="l94.20">    into separate lines again. So, I just throw the whole message at once</span>
<a href="#l94.21"></a><span id="l94.21">    at the TextPlain_parse_line function - it happens to work *g*. */</span>
<a href="#l94.22"></a><span id="l94.22"> MimeDefClass(MimeInlineTextHTMLAsPlaintext, MimeInlineTextHTMLAsPlaintextClass,</span>
<a href="#l94.23"></a><span id="l94.23" class="difflineminus">-       mimeInlineTextHTMLAsPlaintextClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l94.24"></a><span id="l94.24" class="difflineplus">+             mimeInlineTextHTMLAsPlaintextClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l94.25"></a><span id="l94.25"> </span>
<a href="#l94.26"></a><span id="l94.26" class="difflineminus">-static int MimeInlineTextHTMLAsPlaintext_parse_line (const char *, int32_t,</span>
<a href="#l94.27"></a><span id="l94.27" class="difflineminus">-                                                     MimeObject *);</span>
<a href="#l94.28"></a><span id="l94.28" class="difflineminus">-static int MimeInlineTextHTMLAsPlaintext_parse_begin (MimeObject *obj);</span>
<a href="#l94.29"></a><span id="l94.29" class="difflineminus">-static int MimeInlineTextHTMLAsPlaintext_parse_eof (MimeObject *, bool);</span>
<a href="#l94.30"></a><span id="l94.30" class="difflineminus">-static void MimeInlineTextHTMLAsPlaintext_finalize (MimeObject *obj);</span>
<a href="#l94.31"></a><span id="l94.31" class="difflineplus">+static int MimeInlineTextHTMLAsPlaintext_parse_line(const char *, int32_t,</span>
<a href="#l94.32"></a><span id="l94.32" class="difflineplus">+                                                    MimeObject *);</span>
<a href="#l94.33"></a><span id="l94.33" class="difflineplus">+static int MimeInlineTextHTMLAsPlaintext_parse_begin(MimeObject *obj);</span>
<a href="#l94.34"></a><span id="l94.34" class="difflineplus">+static int MimeInlineTextHTMLAsPlaintext_parse_eof(MimeObject *, bool);</span>
<a href="#l94.35"></a><span id="l94.35" class="difflineplus">+static void MimeInlineTextHTMLAsPlaintext_finalize(MimeObject *obj);</span>
<a href="#l94.36"></a><span id="l94.36"> </span>
<a href="#l94.37"></a><span id="l94.37" class="difflineminus">-static int</span>
<a href="#l94.38"></a><span id="l94.38" class="difflineminus">-MimeInlineTextHTMLAsPlaintextClassInitialize(MimeInlineTextHTMLAsPlaintextClass *clazz)</span>
<a href="#l94.39"></a><span id="l94.39" class="difflineminus">-{</span>
<a href="#l94.40"></a><span id="l94.40" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l94.41"></a><span id="l94.41" class="difflineplus">+static int MimeInlineTextHTMLAsPlaintextClassInitialize(</span>
<a href="#l94.42"></a><span id="l94.42" class="difflineplus">+    MimeInlineTextHTMLAsPlaintextClass *clazz) {</span>
<a href="#l94.43"></a><span id="l94.43" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l94.44"></a><span id="l94.44">   NS_ASSERTION(!oclass-&gt;class_initialized, &quot;problem with superclass&quot;);</span>
<a href="#l94.45"></a><span id="l94.45" class="difflineminus">-  oclass-&gt;parse_line  = MimeInlineTextHTMLAsPlaintext_parse_line;</span>
<a href="#l94.46"></a><span id="l94.46" class="difflineplus">+  oclass-&gt;parse_line = MimeInlineTextHTMLAsPlaintext_parse_line;</span>
<a href="#l94.47"></a><span id="l94.47">   oclass-&gt;parse_begin = MimeInlineTextHTMLAsPlaintext_parse_begin;</span>
<a href="#l94.48"></a><span id="l94.48" class="difflineminus">-  oclass-&gt;parse_eof   = MimeInlineTextHTMLAsPlaintext_parse_eof;</span>
<a href="#l94.49"></a><span id="l94.49" class="difflineminus">-  oclass-&gt;finalize    = MimeInlineTextHTMLAsPlaintext_finalize;</span>
<a href="#l94.50"></a><span id="l94.50" class="difflineplus">+  oclass-&gt;parse_eof = MimeInlineTextHTMLAsPlaintext_parse_eof;</span>
<a href="#l94.51"></a><span id="l94.51" class="difflineplus">+  oclass-&gt;finalize = MimeInlineTextHTMLAsPlaintext_finalize;</span>
<a href="#l94.52"></a><span id="l94.52"> </span>
<a href="#l94.53"></a><span id="l94.53">   return 0;</span>
<a href="#l94.54"></a><span id="l94.54"> }</span>
<a href="#l94.55"></a><span id="l94.55"> </span>
<a href="#l94.56"></a><span id="l94.56" class="difflineminus">-static int</span>
<a href="#l94.57"></a><span id="l94.57" class="difflineminus">-MimeInlineTextHTMLAsPlaintext_parse_begin (MimeObject *obj)</span>
<a href="#l94.58"></a><span id="l94.58" class="difflineminus">-{</span>
<a href="#l94.59"></a><span id="l94.59" class="difflineplus">+static int MimeInlineTextHTMLAsPlaintext_parse_begin(MimeObject *obj) {</span>
<a href="#l94.60"></a><span id="l94.60">   MimeInlineTextHTMLAsPlaintext *textHTMLPlain =</span>
<a href="#l94.61"></a><span id="l94.61" class="difflineminus">-                                       (MimeInlineTextHTMLAsPlaintext *) obj;</span>
<a href="#l94.62"></a><span id="l94.62" class="difflineplus">+      (MimeInlineTextHTMLAsPlaintext *)obj;</span>
<a href="#l94.63"></a><span id="l94.63">   textHTMLPlain-&gt;complete_buffer = new nsString();</span>
<a href="#l94.64"></a><span id="l94.64" class="difflineminus">-     // Let's just hope that libmime won't have the idea to call begin twice...</span>
<a href="#l94.65"></a><span id="l94.65" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l94.66"></a><span id="l94.66" class="difflineplus">+  // Let's just hope that libmime won't have the idea to call begin twice...</span>
<a href="#l94.67"></a><span id="l94.67" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l94.68"></a><span id="l94.68"> }</span>
<a href="#l94.69"></a><span id="l94.69"> </span>
<a href="#l94.70"></a><span id="l94.70" class="difflineminus">-static int</span>
<a href="#l94.71"></a><span id="l94.71" class="difflineminus">-MimeInlineTextHTMLAsPlaintext_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l94.72"></a><span id="l94.72" class="difflineminus">-{</span>
<a href="#l94.73"></a><span id="l94.73" class="difflineminus">-  if (obj-&gt;closed_p)</span>
<a href="#l94.74"></a><span id="l94.74" class="difflineminus">-    return 0;</span>
<a href="#l94.75"></a><span id="l94.75" class="difflineplus">+static int MimeInlineTextHTMLAsPlaintext_parse_eof(MimeObject *obj,</span>
<a href="#l94.76"></a><span id="l94.76" class="difflineplus">+                                                   bool abort_p) {</span>
<a href="#l94.77"></a><span id="l94.77" class="difflineplus">+  if (obj-&gt;closed_p) return 0;</span>
<a href="#l94.78"></a><span id="l94.78"> </span>
<a href="#l94.79"></a><span id="l94.79" class="difflineminus">-  // This is a hack. We need to call parse_eof() of the super class to flush out any buffered data.</span>
<a href="#l94.80"></a><span id="l94.80" class="difflineminus">-  // We can't call it yet for our direct super class, because it would &quot;close&quot; the output</span>
<a href="#l94.81"></a><span id="l94.81" class="difflineminus">-  // (write tags such as &lt;/pre&gt; and &lt;/div&gt;). We'll do that after parsing the buffer.</span>
<a href="#l94.82"></a><span id="l94.82" class="difflineminus">-  int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;superclass-&gt;parse_eof(obj, abort_p);</span>
<a href="#l94.83"></a><span id="l94.83" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l94.84"></a><span id="l94.84" class="difflineminus">-    return status;</span>
<a href="#l94.85"></a><span id="l94.85" class="difflineplus">+  // This is a hack. We need to call parse_eof() of the super class to flush out</span>
<a href="#l94.86"></a><span id="l94.86" class="difflineplus">+  // any buffered data. We can't call it yet for our direct super class, because</span>
<a href="#l94.87"></a><span id="l94.87" class="difflineplus">+  // it would &quot;close&quot; the output (write tags such as &lt;/pre&gt; and &lt;/div&gt;). We'll</span>
<a href="#l94.88"></a><span id="l94.88" class="difflineplus">+  // do that after parsing the buffer.</span>
<a href="#l94.89"></a><span id="l94.89" class="difflineplus">+  int status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)</span>
<a href="#l94.90"></a><span id="l94.90" class="difflineplus">+                   -&gt;superclass-&gt;parse_eof(obj, abort_p);</span>
<a href="#l94.91"></a><span id="l94.91" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l94.92"></a><span id="l94.92"> </span>
<a href="#l94.93"></a><span id="l94.93">   MimeInlineTextHTMLAsPlaintext *textHTMLPlain =</span>
<a href="#l94.94"></a><span id="l94.94" class="difflineminus">-                                       (MimeInlineTextHTMLAsPlaintext *) obj;</span>
<a href="#l94.95"></a><span id="l94.95" class="difflineplus">+      (MimeInlineTextHTMLAsPlaintext *)obj;</span>
<a href="#l94.96"></a><span id="l94.96"> </span>
<a href="#l94.97"></a><span id="l94.97" class="difflineminus">-  if (!textHTMLPlain || !textHTMLPlain-&gt;complete_buffer)</span>
<a href="#l94.98"></a><span id="l94.98" class="difflineminus">-    return 0;</span>
<a href="#l94.99"></a><span id="l94.99" class="difflineplus">+  if (!textHTMLPlain || !textHTMLPlain-&gt;complete_buffer) return 0;</span>
<a href="#l94.100"></a><span id="l94.100"> </span>
<a href="#l94.101"></a><span id="l94.101" class="difflineminus">-  nsString&amp; cb = *(textHTMLPlain-&gt;complete_buffer);</span>
<a href="#l94.102"></a><span id="l94.102" class="difflineplus">+  nsString &amp;cb = *(textHTMLPlain-&gt;complete_buffer);</span>
<a href="#l94.103"></a><span id="l94.103"> </span>
<a href="#l94.104"></a><span id="l94.104">   // could be empty, e.g., if part isn't actually being displayed</span>
<a href="#l94.105"></a><span id="l94.105" class="difflineminus">-  if (cb.Length())</span>
<a href="#l94.106"></a><span id="l94.106" class="difflineminus">-  {</span>
<a href="#l94.107"></a><span id="l94.107" class="difflineplus">+  if (cb.Length()) {</span>
<a href="#l94.108"></a><span id="l94.108">     nsString asPlaintext;</span>
<a href="#l94.109"></a><span id="l94.109" class="difflineminus">-    uint32_t flags = nsIDocumentEncoder::OutputFormatted</span>
<a href="#l94.110"></a><span id="l94.110" class="difflineminus">-      | nsIDocumentEncoder::OutputWrap</span>
<a href="#l94.111"></a><span id="l94.111" class="difflineminus">-      | nsIDocumentEncoder::OutputFormatFlowed</span>
<a href="#l94.112"></a><span id="l94.112" class="difflineminus">-      | nsIDocumentEncoder::OutputLFLineBreak</span>
<a href="#l94.113"></a><span id="l94.113" class="difflineminus">-      | nsIDocumentEncoder::OutputNoScriptContent</span>
<a href="#l94.114"></a><span id="l94.114" class="difflineminus">-      | nsIDocumentEncoder::OutputNoFramesContent</span>
<a href="#l94.115"></a><span id="l94.115" class="difflineminus">-      | nsIDocumentEncoder::OutputBodyOnly;</span>
<a href="#l94.116"></a><span id="l94.116" class="difflineplus">+    uint32_t flags = nsIDocumentEncoder::OutputFormatted |</span>
<a href="#l94.117"></a><span id="l94.117" class="difflineplus">+                     nsIDocumentEncoder::OutputWrap |</span>
<a href="#l94.118"></a><span id="l94.118" class="difflineplus">+                     nsIDocumentEncoder::OutputFormatFlowed |</span>
<a href="#l94.119"></a><span id="l94.119" class="difflineplus">+                     nsIDocumentEncoder::OutputLFLineBreak |</span>
<a href="#l94.120"></a><span id="l94.120" class="difflineplus">+                     nsIDocumentEncoder::OutputNoScriptContent |</span>
<a href="#l94.121"></a><span id="l94.121" class="difflineplus">+                     nsIDocumentEncoder::OutputNoFramesContent |</span>
<a href="#l94.122"></a><span id="l94.122" class="difflineplus">+                     nsIDocumentEncoder::OutputBodyOnly;</span>
<a href="#l94.123"></a><span id="l94.123">     HTML2Plaintext(cb, asPlaintext, flags, 80);</span>
<a href="#l94.124"></a><span id="l94.124"> </span>
<a href="#l94.125"></a><span id="l94.125">     NS_ConvertUTF16toUTF8 resultCStr(asPlaintext);</span>
<a href="#l94.126"></a><span id="l94.126">     // TODO parse each line independently</span>
<a href="#l94.127"></a><span id="l94.127" class="difflineminus">-    status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_line(</span>
<a href="#l94.128"></a><span id="l94.128" class="difflineminus">-                               resultCStr.BeginWriting(),</span>
<a href="#l94.129"></a><span id="l94.129" class="difflineminus">-                               resultCStr.Length(),</span>
<a href="#l94.130"></a><span id="l94.130" class="difflineminus">-                               obj);</span>
<a href="#l94.131"></a><span id="l94.131" class="difflineplus">+    status =</span>
<a href="#l94.132"></a><span id="l94.132" class="difflineplus">+        ((MimeObjectClass *)&amp;MIME_SUPERCLASS)</span>
<a href="#l94.133"></a><span id="l94.133" class="difflineplus">+            -&gt;parse_line(resultCStr.BeginWriting(), resultCStr.Length(), obj);</span>
<a href="#l94.134"></a><span id="l94.134">     cb.Truncate();</span>
<a href="#l94.135"></a><span id="l94.135">   }</span>
<a href="#l94.136"></a><span id="l94.136"> </span>
<a href="#l94.137"></a><span id="l94.137" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l94.138"></a><span id="l94.138" class="difflineminus">-    return status;</span>
<a href="#l94.139"></a><span id="l94.139" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l94.140"></a><span id="l94.140"> </span>
<a href="#l94.141"></a><span id="l94.141" class="difflineminus">-  // Second part of the flush hack. Pretend obj wasn't closed yet, so that our super class</span>
<a href="#l94.142"></a><span id="l94.142" class="difflineminus">-  // gets a chance to write the closing.</span>
<a href="#l94.143"></a><span id="l94.143" class="difflineplus">+  // Second part of the flush hack. Pretend obj wasn't closed yet, so that our</span>
<a href="#l94.144"></a><span id="l94.144" class="difflineplus">+  // super class gets a chance to write the closing.</span>
<a href="#l94.145"></a><span id="l94.145">   bool save_closed_p = obj-&gt;closed_p;</span>
<a href="#l94.146"></a><span id="l94.146">   obj-&gt;closed_p = false;</span>
<a href="#l94.147"></a><span id="l94.147" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l94.148"></a><span id="l94.148" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l94.149"></a><span id="l94.149">   // Restore closed_p.</span>
<a href="#l94.150"></a><span id="l94.150">   obj-&gt;closed_p = save_closed_p;</span>
<a href="#l94.151"></a><span id="l94.151">   return status;</span>
<a href="#l94.152"></a><span id="l94.152"> }</span>
<a href="#l94.153"></a><span id="l94.153"> </span>
<a href="#l94.154"></a><span id="l94.154" class="difflineminus">-void</span>
<a href="#l94.155"></a><span id="l94.155" class="difflineminus">-MimeInlineTextHTMLAsPlaintext_finalize (MimeObject *obj)</span>
<a href="#l94.156"></a><span id="l94.156" class="difflineminus">-{</span>
<a href="#l94.157"></a><span id="l94.157" class="difflineplus">+void MimeInlineTextHTMLAsPlaintext_finalize(MimeObject *obj) {</span>
<a href="#l94.158"></a><span id="l94.158">   MimeInlineTextHTMLAsPlaintext *textHTMLPlain =</span>
<a href="#l94.159"></a><span id="l94.159" class="difflineminus">-                                        (MimeInlineTextHTMLAsPlaintext *) obj;</span>
<a href="#l94.160"></a><span id="l94.160" class="difflineminus">-  if (textHTMLPlain &amp;&amp; textHTMLPlain-&gt;complete_buffer)</span>
<a href="#l94.161"></a><span id="l94.161" class="difflineminus">-  {</span>
<a href="#l94.162"></a><span id="l94.162" class="difflineplus">+      (MimeInlineTextHTMLAsPlaintext *)obj;</span>
<a href="#l94.163"></a><span id="l94.163" class="difflineplus">+  if (textHTMLPlain &amp;&amp; textHTMLPlain-&gt;complete_buffer) {</span>
<a href="#l94.164"></a><span id="l94.164">     // If there's content in the buffer, make sure that we output it.</span>
<a href="#l94.165"></a><span id="l94.165">     // don't care about return codes</span>
<a href="#l94.166"></a><span id="l94.166">     obj-&gt;clazz-&gt;parse_eof(obj, false);</span>
<a href="#l94.167"></a><span id="l94.167"> </span>
<a href="#l94.168"></a><span id="l94.168">     delete textHTMLPlain-&gt;complete_buffer;</span>
<a href="#l94.169"></a><span id="l94.169">     textHTMLPlain-&gt;complete_buffer = NULL;</span>
<a href="#l94.170"></a><span id="l94.170" class="difflineminus">-      /* It is important to zero the pointer, so we can reliably check for</span>
<a href="#l94.171"></a><span id="l94.171" class="difflineminus">-         the validity of it in the other functions. See above. */</span>
<a href="#l94.172"></a><span id="l94.172" class="difflineplus">+    /* It is important to zero the pointer, so we can reliably check for</span>
<a href="#l94.173"></a><span id="l94.173" class="difflineplus">+       the validity of it in the other functions. See above. */</span>
<a href="#l94.174"></a><span id="l94.174">   }</span>
<a href="#l94.175"></a><span id="l94.175" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize (obj);</span>
<a href="#l94.176"></a><span id="l94.176" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l94.177"></a><span id="l94.177"> }</span>
<a href="#l94.178"></a><span id="l94.178"> </span>
<a href="#l94.179"></a><span id="l94.179" class="difflineminus">-static int</span>
<a href="#l94.180"></a><span id="l94.180" class="difflineminus">-MimeInlineTextHTMLAsPlaintext_parse_line (const char *line, int32_t length,</span>
<a href="#l94.181"></a><span id="l94.181" class="difflineminus">-                                          MimeObject *obj)</span>
<a href="#l94.182"></a><span id="l94.182" class="difflineminus">-{</span>
<a href="#l94.183"></a><span id="l94.183" class="difflineplus">+static int MimeInlineTextHTMLAsPlaintext_parse_line(const char *line,</span>
<a href="#l94.184"></a><span id="l94.184" class="difflineplus">+                                                    int32_t length,</span>
<a href="#l94.185"></a><span id="l94.185" class="difflineplus">+                                                    MimeObject *obj) {</span>
<a href="#l94.186"></a><span id="l94.186">   MimeInlineTextHTMLAsPlaintext *textHTMLPlain =</span>
<a href="#l94.187"></a><span id="l94.187" class="difflineminus">-                                       (MimeInlineTextHTMLAsPlaintext *) obj;</span>
<a href="#l94.188"></a><span id="l94.188" class="difflineplus">+      (MimeInlineTextHTMLAsPlaintext *)obj;</span>
<a href="#l94.189"></a><span id="l94.189"> </span>
<a href="#l94.190"></a><span id="l94.190" class="difflineminus">-  if (!textHTMLPlain || !(textHTMLPlain-&gt;complete_buffer))</span>
<a href="#l94.191"></a><span id="l94.191" class="difflineminus">-  {</span>
<a href="#l94.192"></a><span id="l94.192" class="difflineplus">+  if (!textHTMLPlain || !(textHTMLPlain-&gt;complete_buffer)) {</span>
<a href="#l94.193"></a><span id="l94.193"> #if DEBUG</span>
<a href="#l94.194"></a><span id="l94.194" class="difflineminus">-printf(&quot;Can't output: %s\n&quot;, line);</span>
<a href="#l94.195"></a><span id="l94.195" class="difflineplus">+    printf(&quot;Can't output: %s\n&quot;, line);</span>
<a href="#l94.196"></a><span id="l94.196"> #endif</span>
<a href="#l94.197"></a><span id="l94.197">     return -1;</span>
<a href="#l94.198"></a><span id="l94.198">   }</span>
<a href="#l94.199"></a><span id="l94.199"> </span>
<a href="#l94.200"></a><span id="l94.200">   /*</span>
<a href="#l94.201"></a><span id="l94.201">     To convert HTML-&gt;TXT synchronously, I need the full source at once,</span>
<a href="#l94.202"></a><span id="l94.202">     not line by line (how do you convert &quot;&lt;li&gt;foo\n&quot; to plaintext?).</span>
<a href="#l94.203"></a><span id="l94.203">     parse_decoded_buffer claims to give me that, but in fact also gives</span>
<a href="#l94.204"></a><span id="l94.204">     me single lines.</span>
<a href="#l94.205"></a><span id="l94.205">     It might be theoretically possible to drive this asynchronously, but</span>
<a href="#l94.206"></a><span id="l94.206">     I don't know, which odd circumstances might arise and how libmime</span>
<a href="#l94.207"></a><span id="l94.207">     will behave then. It's not worth the trouble for me to figure this all out.</span>
<a href="#l94.208"></a><span id="l94.208">    */</span>
<a href="#l94.209"></a><span id="l94.209">   nsCString linestr(line, length);</span>
<a href="#l94.210"></a><span id="l94.210">   NS_ConvertUTF8toUTF16 line_ucs2(linestr.get());</span>
<a href="#l94.211"></a><span id="l94.211" class="difflineminus">-  if (length &amp;&amp; line_ucs2.IsEmpty())</span>
<a href="#l94.212"></a><span id="l94.212" class="difflineminus">-    CopyASCIItoUTF16 (linestr, line_ucs2);</span>
<a href="#l94.213"></a><span id="l94.213" class="difflineplus">+  if (length &amp;&amp; line_ucs2.IsEmpty()) CopyASCIItoUTF16(linestr, line_ucs2);</span>
<a href="#l94.214"></a><span id="l94.214">   (textHTMLPlain-&gt;complete_buffer)-&gt;Append(line_ucs2);</span>
<a href="#l94.215"></a><span id="l94.215"> </span>
<a href="#l94.216"></a><span id="l94.216">   return 0;</span>
<a href="#l94.217"></a><span id="l94.217"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l95.1"></a><span id="l95.1" class="difflineminus">--- a/mailnews/mime/src/mimethpl.h</span>
<a href="#l95.2"></a><span id="l95.2" class="difflineplus">+++ b/mailnews/mime/src/mimethpl.h</span>
<a href="#l95.3"></a><span id="l95.3" class="difflineat">@@ -10,26 +10,27 @@</span>
<a href="#l95.4"></a><span id="l95.4">  */</span>
<a href="#l95.5"></a><span id="l95.5"> </span>
<a href="#l95.6"></a><span id="l95.6"> #ifndef _MIMETHPL_H_</span>
<a href="#l95.7"></a><span id="l95.7"> #define _MIMETHPL_H_</span>
<a href="#l95.8"></a><span id="l95.8"> </span>
<a href="#l95.9"></a><span id="l95.9"> #include &quot;mimetpla.h&quot;</span>
<a href="#l95.10"></a><span id="l95.10"> #include &quot;nsString.h&quot;</span>
<a href="#l95.11"></a><span id="l95.11"> </span>
<a href="#l95.12"></a><span id="l95.12" class="difflineminus">-typedef struct MimeInlineTextHTMLAsPlaintextClass MimeInlineTextHTMLAsPlaintextClass;</span>
<a href="#l95.13"></a><span id="l95.13" class="difflineminus">-typedef struct MimeInlineTextHTMLAsPlaintext      MimeInlineTextHTMLAsPlaintext;</span>
<a href="#l95.14"></a><span id="l95.14" class="difflineplus">+typedef struct MimeInlineTextHTMLAsPlaintextClass</span>
<a href="#l95.15"></a><span id="l95.15" class="difflineplus">+    MimeInlineTextHTMLAsPlaintextClass;</span>
<a href="#l95.16"></a><span id="l95.16" class="difflineplus">+typedef struct MimeInlineTextHTMLAsPlaintext MimeInlineTextHTMLAsPlaintext;</span>
<a href="#l95.17"></a><span id="l95.17"> </span>
<a href="#l95.18"></a><span id="l95.18"> struct MimeInlineTextHTMLAsPlaintextClass {</span>
<a href="#l95.19"></a><span id="l95.19">   MimeInlineTextPlainClass plaintext;</span>
<a href="#l95.20"></a><span id="l95.20"> };</span>
<a href="#l95.21"></a><span id="l95.21"> </span>
<a href="#l95.22"></a><span id="l95.22"> extern MimeInlineTextHTMLAsPlaintextClass mimeInlineTextHTMLAsPlaintextClass;</span>
<a href="#l95.23"></a><span id="l95.23"> </span>
<a href="#l95.24"></a><span id="l95.24"> struct MimeInlineTextHTMLAsPlaintext {</span>
<a href="#l95.25"></a><span id="l95.25" class="difflineminus">-  MimeInlineTextPlain  plaintext;</span>
<a href="#l95.26"></a><span id="l95.26" class="difflineminus">-  nsString             *complete_buffer;  // Gecko parser expects wide strings</span>
<a href="#l95.27"></a><span id="l95.27" class="difflineplus">+  MimeInlineTextPlain plaintext;</span>
<a href="#l95.28"></a><span id="l95.28" class="difflineplus">+  nsString *complete_buffer;  // Gecko parser expects wide strings</span>
<a href="#l95.29"></a><span id="l95.29"> };</span>
<a href="#l95.30"></a><span id="l95.30"> </span>
<a href="#l95.31"></a><span id="l95.31" class="difflineminus">-#define MimeInlineTextHTMLAsPlaintextClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l95.32"></a><span id="l95.32" class="difflineminus">-  { MimeInlineTextPlainClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l95.33"></a><span id="l95.33" class="difflineplus">+#define MimeInlineTextHTMLAsPlaintextClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l95.34"></a><span id="l95.34" class="difflineplus">+  { MimeInlineTextPlainClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l95.35"></a><span id="l95.35"> </span>
<a href="#l95.36"></a><span id="l95.36"> #endif /* _MIMETHPL_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l96.1"></a><span id="l96.1" class="difflineminus">--- a/mailnews/mime/src/mimethsa.cpp</span>
<a href="#l96.2"></a><span id="l96.2" class="difflineplus">+++ b/mailnews/mime/src/mimethsa.cpp</span>
<a href="#l96.3"></a><span id="l96.3" class="difflineat">@@ -33,111 +33,95 @@</span>
<a href="#l96.4"></a><span id="l96.4"> #include &quot;prlog.h&quot;</span>
<a href="#l96.5"></a><span id="l96.5"> #include &quot;msgCore.h&quot;</span>
<a href="#l96.6"></a><span id="l96.6"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l96.7"></a><span id="l96.7"> #include &quot;nsString.h&quot;</span>
<a href="#l96.8"></a><span id="l96.8"> #include &quot;mimethtm.h&quot;</span>
<a href="#l96.9"></a><span id="l96.9"> </span>
<a href="#l96.10"></a><span id="l96.10"> #define MIME_SUPERCLASS mimeInlineTextHTMLClass</span>
<a href="#l96.11"></a><span id="l96.11"> MimeDefClass(MimeInlineTextHTMLSanitized, MimeInlineTextHTMLSanitizedClass,</span>
<a href="#l96.12"></a><span id="l96.12" class="difflineminus">-       mimeInlineTextHTMLSanitizedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l96.13"></a><span id="l96.13" class="difflineplus">+             mimeInlineTextHTMLSanitizedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l96.14"></a><span id="l96.14"> </span>
<a href="#l96.15"></a><span id="l96.15"> static int MimeInlineTextHTMLSanitized_parse_line(const char *, int32_t,</span>
<a href="#l96.16"></a><span id="l96.16">                                                   MimeObject *);</span>
<a href="#l96.17"></a><span id="l96.17"> static int MimeInlineTextHTMLSanitized_parse_begin(MimeObject *obj);</span>
<a href="#l96.18"></a><span id="l96.18"> static int MimeInlineTextHTMLSanitized_parse_eof(MimeObject *, bool);</span>
<a href="#l96.19"></a><span id="l96.19"> static void MimeInlineTextHTMLSanitized_finalize(MimeObject *obj);</span>
<a href="#l96.20"></a><span id="l96.20"> </span>
<a href="#l96.21"></a><span id="l96.21" class="difflineminus">-static int</span>
<a href="#l96.22"></a><span id="l96.22" class="difflineminus">-MimeInlineTextHTMLSanitizedClassInitialize(MimeInlineTextHTMLSanitizedClass *clazz)</span>
<a href="#l96.23"></a><span id="l96.23" class="difflineminus">-{</span>
<a href="#l96.24"></a><span id="l96.24" class="difflineplus">+static int MimeInlineTextHTMLSanitizedClassInitialize(</span>
<a href="#l96.25"></a><span id="l96.25" class="difflineplus">+    MimeInlineTextHTMLSanitizedClass *clazz) {</span>
<a href="#l96.26"></a><span id="l96.26">   MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l96.27"></a><span id="l96.27">   NS_ASSERTION(!oclass-&gt;class_initialized, &quot;problem with superclass&quot;);</span>
<a href="#l96.28"></a><span id="l96.28" class="difflineminus">-  oclass-&gt;parse_line  = MimeInlineTextHTMLSanitized_parse_line;</span>
<a href="#l96.29"></a><span id="l96.29" class="difflineplus">+  oclass-&gt;parse_line = MimeInlineTextHTMLSanitized_parse_line;</span>
<a href="#l96.30"></a><span id="l96.30">   oclass-&gt;parse_begin = MimeInlineTextHTMLSanitized_parse_begin;</span>
<a href="#l96.31"></a><span id="l96.31" class="difflineminus">-  oclass-&gt;parse_eof   = MimeInlineTextHTMLSanitized_parse_eof;</span>
<a href="#l96.32"></a><span id="l96.32" class="difflineminus">-  oclass-&gt;finalize    = MimeInlineTextHTMLSanitized_finalize;</span>
<a href="#l96.33"></a><span id="l96.33" class="difflineplus">+  oclass-&gt;parse_eof = MimeInlineTextHTMLSanitized_parse_eof;</span>
<a href="#l96.34"></a><span id="l96.34" class="difflineplus">+  oclass-&gt;finalize = MimeInlineTextHTMLSanitized_finalize;</span>
<a href="#l96.35"></a><span id="l96.35"> </span>
<a href="#l96.36"></a><span id="l96.36">   return 0;</span>
<a href="#l96.37"></a><span id="l96.37"> }</span>
<a href="#l96.38"></a><span id="l96.38"> </span>
<a href="#l96.39"></a><span id="l96.39" class="difflineminus">-static int</span>
<a href="#l96.40"></a><span id="l96.40" class="difflineminus">-MimeInlineTextHTMLSanitized_parse_begin(MimeObject *obj)</span>
<a href="#l96.41"></a><span id="l96.41" class="difflineminus">-{</span>
<a href="#l96.42"></a><span id="l96.42" class="difflineplus">+static int MimeInlineTextHTMLSanitized_parse_begin(MimeObject *obj) {</span>
<a href="#l96.43"></a><span id="l96.43">   MimeInlineTextHTMLSanitized *me = (MimeInlineTextHTMLSanitized *)obj;</span>
<a href="#l96.44"></a><span id="l96.44">   me-&gt;complete_buffer = new nsString();</span>
<a href="#l96.45"></a><span id="l96.45" class="difflineminus">-  int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l96.46"></a><span id="l96.46" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l96.47"></a><span id="l96.47" class="difflineminus">-    return status;</span>
<a href="#l96.48"></a><span id="l96.48" class="difflineplus">+  int status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l96.49"></a><span id="l96.49" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l96.50"></a><span id="l96.50"> </span>
<a href="#l96.51"></a><span id="l96.51">   return 0;</span>
<a href="#l96.52"></a><span id="l96.52"> }</span>
<a href="#l96.53"></a><span id="l96.53"> </span>
<a href="#l96.54"></a><span id="l96.54" class="difflineminus">-static int</span>
<a href="#l96.55"></a><span id="l96.55" class="difflineminus">-MimeInlineTextHTMLSanitized_parse_eof(MimeObject *obj, bool abort_p)</span>
<a href="#l96.56"></a><span id="l96.56" class="difflineminus">-{</span>
<a href="#l96.57"></a><span id="l96.57" class="difflineminus">-  if (obj-&gt;closed_p)</span>
<a href="#l96.58"></a><span id="l96.58" class="difflineminus">-    return 0;</span>
<a href="#l96.59"></a><span id="l96.59" class="difflineminus">-  int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l96.60"></a><span id="l96.60" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l96.61"></a><span id="l96.61" class="difflineminus">-    return status;</span>
<a href="#l96.62"></a><span id="l96.62" class="difflineplus">+static int MimeInlineTextHTMLSanitized_parse_eof(MimeObject *obj,</span>
<a href="#l96.63"></a><span id="l96.63" class="difflineplus">+                                                 bool abort_p) {</span>
<a href="#l96.64"></a><span id="l96.64" class="difflineplus">+  if (obj-&gt;closed_p) return 0;</span>
<a href="#l96.65"></a><span id="l96.65" class="difflineplus">+  int status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l96.66"></a><span id="l96.66" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l96.67"></a><span id="l96.67">   MimeInlineTextHTMLSanitized *me = (MimeInlineTextHTMLSanitized *)obj;</span>
<a href="#l96.68"></a><span id="l96.68"> </span>
<a href="#l96.69"></a><span id="l96.69">   // We have to cache all lines and parse the whole document at once.</span>
<a href="#l96.70"></a><span id="l96.70" class="difflineminus">-  // There's a useful sounding function parseFromStream(), but it only allows XML</span>
<a href="#l96.71"></a><span id="l96.71" class="difflineminus">-  // mimetypes, not HTML. Methinks that's because the HTML soup parser</span>
<a href="#l96.72"></a><span id="l96.72" class="difflineminus">-  // needs the entire doc to make sense of the gibberish that people write.</span>
<a href="#l96.73"></a><span id="l96.73" class="difflineminus">-  if (!me || !me-&gt;complete_buffer)</span>
<a href="#l96.74"></a><span id="l96.74" class="difflineminus">-    return 0;</span>
<a href="#l96.75"></a><span id="l96.75" class="difflineplus">+  // There's a useful sounding function parseFromStream(), but it only allows</span>
<a href="#l96.76"></a><span id="l96.76" class="difflineplus">+  // XML mimetypes, not HTML. Methinks that's because the HTML soup parser needs</span>
<a href="#l96.77"></a><span id="l96.77" class="difflineplus">+  // the entire doc to make sense of the gibberish that people write.</span>
<a href="#l96.78"></a><span id="l96.78" class="difflineplus">+  if (!me || !me-&gt;complete_buffer) return 0;</span>
<a href="#l96.79"></a><span id="l96.79"> </span>
<a href="#l96.80"></a><span id="l96.80" class="difflineminus">-  nsString&amp; cb = *(me-&gt;complete_buffer);</span>
<a href="#l96.81"></a><span id="l96.81" class="difflineminus">-  if (cb.IsEmpty())</span>
<a href="#l96.82"></a><span id="l96.82" class="difflineminus">-    return 0;</span>
<a href="#l96.83"></a><span id="l96.83" class="difflineplus">+  nsString &amp;cb = *(me-&gt;complete_buffer);</span>
<a href="#l96.84"></a><span id="l96.84" class="difflineplus">+  if (cb.IsEmpty()) return 0;</span>
<a href="#l96.85"></a><span id="l96.85">   nsString sanitized;</span>
<a href="#l96.86"></a><span id="l96.86"> </span>
<a href="#l96.87"></a><span id="l96.87">   // Sanitize.</span>
<a href="#l96.88"></a><span id="l96.88">   HTMLSanitize(cb, sanitized);</span>
<a href="#l96.89"></a><span id="l96.89"> </span>
<a href="#l96.90"></a><span id="l96.90">   // Write it out.</span>
<a href="#l96.91"></a><span id="l96.91">   NS_ConvertUTF16toUTF8 resultCStr(sanitized);</span>
<a href="#l96.92"></a><span id="l96.92">   MimeInlineTextHTML_insert_lang_div(obj, resultCStr);</span>
<a href="#l96.93"></a><span id="l96.93">   // Call to MimeInlineTextHTML_remove_plaintext_tag() not needed since</span>
<a href="#l96.94"></a><span id="l96.94">   // sanitization already removes that tag.</span>
<a href="#l96.95"></a><span id="l96.95" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_line(</span>
<a href="#l96.96"></a><span id="l96.96" class="difflineminus">-                             resultCStr.BeginWriting(),</span>
<a href="#l96.97"></a><span id="l96.97" class="difflineminus">-                             resultCStr.Length(),</span>
<a href="#l96.98"></a><span id="l96.98" class="difflineminus">-                             obj);</span>
<a href="#l96.99"></a><span id="l96.99" class="difflineplus">+  status =</span>
<a href="#l96.100"></a><span id="l96.100" class="difflineplus">+      ((MimeObjectClass *)&amp;MIME_SUPERCLASS)</span>
<a href="#l96.101"></a><span id="l96.101" class="difflineplus">+          -&gt;parse_line(resultCStr.BeginWriting(), resultCStr.Length(), obj);</span>
<a href="#l96.102"></a><span id="l96.102">   cb.Truncate();</span>
<a href="#l96.103"></a><span id="l96.103">   return status;</span>
<a href="#l96.104"></a><span id="l96.104"> }</span>
<a href="#l96.105"></a><span id="l96.105"> </span>
<a href="#l96.106"></a><span id="l96.106" class="difflineminus">-void</span>
<a href="#l96.107"></a><span id="l96.107" class="difflineminus">-MimeInlineTextHTMLSanitized_finalize(MimeObject *obj)</span>
<a href="#l96.108"></a><span id="l96.108" class="difflineminus">-{</span>
<a href="#l96.109"></a><span id="l96.109" class="difflineplus">+void MimeInlineTextHTMLSanitized_finalize(MimeObject *obj) {</span>
<a href="#l96.110"></a><span id="l96.110">   MimeInlineTextHTMLSanitized *me = (MimeInlineTextHTMLSanitized *)obj;</span>
<a href="#l96.111"></a><span id="l96.111"> </span>
<a href="#l96.112"></a><span id="l96.112" class="difflineminus">-  if (me &amp;&amp; me-&gt;complete_buffer)</span>
<a href="#l96.113"></a><span id="l96.113" class="difflineminus">-  {</span>
<a href="#l96.114"></a><span id="l96.114" class="difflineplus">+  if (me &amp;&amp; me-&gt;complete_buffer) {</span>
<a href="#l96.115"></a><span id="l96.115">     obj-&gt;clazz-&gt;parse_eof(obj, false);</span>
<a href="#l96.116"></a><span id="l96.116">     delete me-&gt;complete_buffer;</span>
<a href="#l96.117"></a><span id="l96.117">     me-&gt;complete_buffer = NULL;</span>
<a href="#l96.118"></a><span id="l96.118">   }</span>
<a href="#l96.119"></a><span id="l96.119"> </span>
<a href="#l96.120"></a><span id="l96.120" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l96.121"></a><span id="l96.121" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l96.122"></a><span id="l96.122"> }</span>
<a href="#l96.123"></a><span id="l96.123"> </span>
<a href="#l96.124"></a><span id="l96.124" class="difflineminus">-static int</span>
<a href="#l96.125"></a><span id="l96.125" class="difflineminus">-MimeInlineTextHTMLSanitized_parse_line(const char *line, int32_t length,</span>
<a href="#l96.126"></a><span id="l96.126" class="difflineminus">-                                       MimeObject *obj)</span>
<a href="#l96.127"></a><span id="l96.127" class="difflineminus">-{</span>
<a href="#l96.128"></a><span id="l96.128" class="difflineplus">+static int MimeInlineTextHTMLSanitized_parse_line(const char *line,</span>
<a href="#l96.129"></a><span id="l96.129" class="difflineplus">+                                                  int32_t length,</span>
<a href="#l96.130"></a><span id="l96.130" class="difflineplus">+                                                  MimeObject *obj) {</span>
<a href="#l96.131"></a><span id="l96.131">   MimeInlineTextHTMLSanitized *me = (MimeInlineTextHTMLSanitized *)obj;</span>
<a href="#l96.132"></a><span id="l96.132"> </span>
<a href="#l96.133"></a><span id="l96.133" class="difflineminus">-  if (!me || !(me-&gt;complete_buffer))</span>
<a href="#l96.134"></a><span id="l96.134" class="difflineminus">-    return -1;</span>
<a href="#l96.135"></a><span id="l96.135" class="difflineplus">+  if (!me || !(me-&gt;complete_buffer)) return -1;</span>
<a href="#l96.136"></a><span id="l96.136"> </span>
<a href="#l96.137"></a><span id="l96.137">   nsCString linestr(line, length);</span>
<a href="#l96.138"></a><span id="l96.138">   NS_ConvertUTF8toUTF16 line_ucs2(linestr.get());</span>
<a href="#l96.139"></a><span id="l96.139" class="difflineminus">-  if (length &amp;&amp; line_ucs2.IsEmpty())</span>
<a href="#l96.140"></a><span id="l96.140" class="difflineminus">-    CopyASCIItoUTF16(linestr, line_ucs2);</span>
<a href="#l96.141"></a><span id="l96.141" class="difflineplus">+  if (length &amp;&amp; line_ucs2.IsEmpty()) CopyASCIItoUTF16(linestr, line_ucs2);</span>
<a href="#l96.142"></a><span id="l96.142">   (me-&gt;complete_buffer)-&gt;Append(line_ucs2);</span>
<a href="#l96.143"></a><span id="l96.143"> </span>
<a href="#l96.144"></a><span id="l96.144">   return 0;</span>
<a href="#l96.145"></a><span id="l96.145"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l97.1"></a><span id="l97.1" class="difflineminus">--- a/mailnews/mime/src/mimethsa.h</span>
<a href="#l97.2"></a><span id="l97.2" class="difflineplus">+++ b/mailnews/mime/src/mimethsa.h</span>
<a href="#l97.3"></a><span id="l97.3" class="difflineat">@@ -4,26 +4,27 @@</span>
<a href="#l97.4"></a><span id="l97.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l97.5"></a><span id="l97.5"> </span>
<a href="#l97.6"></a><span id="l97.6"> #ifndef _MIMETHSA_H_</span>
<a href="#l97.7"></a><span id="l97.7"> #define _MIMETHSA_H_</span>
<a href="#l97.8"></a><span id="l97.8"> </span>
<a href="#l97.9"></a><span id="l97.9"> #include &quot;mimethtm.h&quot;</span>
<a href="#l97.10"></a><span id="l97.10"> #include &quot;nsString.h&quot;</span>
<a href="#l97.11"></a><span id="l97.11"> </span>
<a href="#l97.12"></a><span id="l97.12" class="difflineminus">-typedef struct MimeInlineTextHTMLSanitizedClass MimeInlineTextHTMLSanitizedClass;</span>
<a href="#l97.13"></a><span id="l97.13" class="difflineminus">-typedef struct MimeInlineTextHTMLSanitized      MimeInlineTextHTMLSanitized;</span>
<a href="#l97.14"></a><span id="l97.14" class="difflineplus">+typedef struct MimeInlineTextHTMLSanitizedClass</span>
<a href="#l97.15"></a><span id="l97.15" class="difflineplus">+    MimeInlineTextHTMLSanitizedClass;</span>
<a href="#l97.16"></a><span id="l97.16" class="difflineplus">+typedef struct MimeInlineTextHTMLSanitized MimeInlineTextHTMLSanitized;</span>
<a href="#l97.17"></a><span id="l97.17"> </span>
<a href="#l97.18"></a><span id="l97.18"> struct MimeInlineTextHTMLSanitizedClass {</span>
<a href="#l97.19"></a><span id="l97.19">   MimeInlineTextHTMLClass html;</span>
<a href="#l97.20"></a><span id="l97.20"> };</span>
<a href="#l97.21"></a><span id="l97.21"> </span>
<a href="#l97.22"></a><span id="l97.22"> extern MimeInlineTextHTMLSanitizedClass mimeInlineTextHTMLSanitizedClass;</span>
<a href="#l97.23"></a><span id="l97.23"> </span>
<a href="#l97.24"></a><span id="l97.24"> struct MimeInlineTextHTMLSanitized {</span>
<a href="#l97.25"></a><span id="l97.25" class="difflineminus">-  MimeInlineTextHTML    html;</span>
<a href="#l97.26"></a><span id="l97.26" class="difflineminus">-  nsString             *complete_buffer;  // Gecko parser expects wide strings</span>
<a href="#l97.27"></a><span id="l97.27" class="difflineplus">+  MimeInlineTextHTML html;</span>
<a href="#l97.28"></a><span id="l97.28" class="difflineplus">+  nsString *complete_buffer;  // Gecko parser expects wide strings</span>
<a href="#l97.29"></a><span id="l97.29"> };</span>
<a href="#l97.30"></a><span id="l97.30"> </span>
<a href="#l97.31"></a><span id="l97.31" class="difflineminus">-#define MimeInlineTextHTMLSanitizedClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l97.32"></a><span id="l97.32" class="difflineminus">-  { MimeInlineTextHTMLClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l97.33"></a><span id="l97.33" class="difflineplus">+#define MimeInlineTextHTMLSanitizedClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l97.34"></a><span id="l97.34" class="difflineplus">+  { MimeInlineTextHTMLClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l97.35"></a><span id="l97.35"> </span>
<a href="#l97.36"></a><span id="l97.36"> #endif /* _MIMETHPL_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l98.1"></a><span id="l98.1" class="difflineminus">--- a/mailnews/mime/src/mimethtm.cpp</span>
<a href="#l98.2"></a><span id="l98.2" class="difflineplus">+++ b/mailnews/mime/src/mimethtm.cpp</span>
<a href="#l98.3"></a><span id="l98.3" class="difflineat">@@ -9,90 +9,79 @@</span>
<a href="#l98.4"></a><span id="l98.4"> #include &quot;prprf.h&quot;</span>
<a href="#l98.5"></a><span id="l98.5"> #include &quot;msgCore.h&quot;</span>
<a href="#l98.6"></a><span id="l98.6"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l98.7"></a><span id="l98.7"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l98.8"></a><span id="l98.8"> #include &lt;ctype.h&gt;</span>
<a href="#l98.9"></a><span id="l98.9"> </span>
<a href="#l98.10"></a><span id="l98.10"> #define MIME_SUPERCLASS mimeInlineTextClass</span>
<a href="#l98.11"></a><span id="l98.11"> MimeDefClass(MimeInlineTextHTML, MimeInlineTextHTMLClass,</span>
<a href="#l98.12"></a><span id="l98.12" class="difflineminus">-       mimeInlineTextHTMLClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l98.13"></a><span id="l98.13" class="difflineplus">+             mimeInlineTextHTMLClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l98.14"></a><span id="l98.14"> </span>
<a href="#l98.15"></a><span id="l98.15" class="difflineminus">-static int MimeInlineTextHTML_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l98.16"></a><span id="l98.16" class="difflineminus">-static int MimeInlineTextHTML_parse_eof (MimeObject *, bool);</span>
<a href="#l98.17"></a><span id="l98.17" class="difflineminus">-static int MimeInlineTextHTML_parse_begin (MimeObject *obj);</span>
<a href="#l98.18"></a><span id="l98.18" class="difflineplus">+static int MimeInlineTextHTML_parse_line(const char *, int32_t, MimeObject *);</span>
<a href="#l98.19"></a><span id="l98.19" class="difflineplus">+static int MimeInlineTextHTML_parse_eof(MimeObject *, bool);</span>
<a href="#l98.20"></a><span id="l98.20" class="difflineplus">+static int MimeInlineTextHTML_parse_begin(MimeObject *obj);</span>
<a href="#l98.21"></a><span id="l98.21"> </span>
<a href="#l98.22"></a><span id="l98.22" class="difflineminus">-static int</span>
<a href="#l98.23"></a><span id="l98.23" class="difflineminus">-MimeInlineTextHTMLClassInitialize(MimeInlineTextHTMLClass *clazz)</span>
<a href="#l98.24"></a><span id="l98.24" class="difflineminus">-{</span>
<a href="#l98.25"></a><span id="l98.25" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l98.26"></a><span id="l98.26" class="difflineplus">+static int MimeInlineTextHTMLClassInitialize(MimeInlineTextHTMLClass *clazz) {</span>
<a href="#l98.27"></a><span id="l98.27" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l98.28"></a><span id="l98.28">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l98.29"></a><span id="l98.29">   oclass-&gt;parse_begin = MimeInlineTextHTML_parse_begin;</span>
<a href="#l98.30"></a><span id="l98.30" class="difflineminus">-  oclass-&gt;parse_line  = MimeInlineTextHTML_parse_line;</span>
<a href="#l98.31"></a><span id="l98.31" class="difflineminus">-  oclass-&gt;parse_eof   = MimeInlineTextHTML_parse_eof;</span>
<a href="#l98.32"></a><span id="l98.32" class="difflineplus">+  oclass-&gt;parse_line = MimeInlineTextHTML_parse_line;</span>
<a href="#l98.33"></a><span id="l98.33" class="difflineplus">+  oclass-&gt;parse_eof = MimeInlineTextHTML_parse_eof;</span>
<a href="#l98.34"></a><span id="l98.34"> </span>
<a href="#l98.35"></a><span id="l98.35">   return 0;</span>
<a href="#l98.36"></a><span id="l98.36"> }</span>
<a href="#l98.37"></a><span id="l98.37"> </span>
<a href="#l98.38"></a><span id="l98.38" class="difflineminus">-static int</span>
<a href="#l98.39"></a><span id="l98.39" class="difflineminus">-MimeInlineTextHTML_parse_begin (MimeObject *obj)</span>
<a href="#l98.40"></a><span id="l98.40" class="difflineminus">-{</span>
<a href="#l98.41"></a><span id="l98.41" class="difflineminus">-  int status = ((MimeObjectClass*)&amp;mimeLeafClass)-&gt;parse_begin(obj);</span>
<a href="#l98.42"></a><span id="l98.42" class="difflineplus">+static int MimeInlineTextHTML_parse_begin(MimeObject *obj) {</span>
<a href="#l98.43"></a><span id="l98.43" class="difflineplus">+  int status = ((MimeObjectClass *)&amp;mimeLeafClass)-&gt;parse_begin(obj);</span>
<a href="#l98.44"></a><span id="l98.44">   if (status &lt; 0) return status;</span>
<a href="#l98.45"></a><span id="l98.45"> </span>
<a href="#l98.46"></a><span id="l98.46">   if (!obj-&gt;output_p) return 0;</span>
<a href="#l98.47"></a><span id="l98.47"> </span>
<a href="#l98.48"></a><span id="l98.48">   status = MimeObject_write_separator(obj);</span>
<a href="#l98.49"></a><span id="l98.49">   if (status &lt; 0) return status;</span>
<a href="#l98.50"></a><span id="l98.50"> </span>
<a href="#l98.51"></a><span id="l98.51" class="difflineminus">-  MimeInlineTextHTML  *textHTML = (MimeInlineTextHTML *) obj;</span>
<a href="#l98.52"></a><span id="l98.52" class="difflineplus">+  MimeInlineTextHTML *textHTML = (MimeInlineTextHTML *)obj;</span>
<a href="#l98.53"></a><span id="l98.53"> </span>
<a href="#l98.54"></a><span id="l98.54">   textHTML-&gt;charset = nullptr;</span>
<a href="#l98.55"></a><span id="l98.55"> </span>
<a href="#l98.56"></a><span id="l98.56">   /* If this HTML part has a Content-Base header, and if we're displaying</span>
<a href="#l98.57"></a><span id="l98.57">    to the screen (that is, not writing this part &quot;raw&quot;) then translate</span>
<a href="#l98.58"></a><span id="l98.58">    that Content-Base header into a &lt;BASE&gt; tag in the HTML.</span>
<a href="#l98.59"></a><span id="l98.59">   */</span>
<a href="#l98.60"></a><span id="l98.60" class="difflineminus">-  if (obj-&gt;options &amp;&amp;</span>
<a href="#l98.61"></a><span id="l98.61" class="difflineminus">-    obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l98.62"></a><span id="l98.62" class="difflineminus">-    obj-&gt;options-&gt;output_fn)</span>
<a href="#l98.63"></a><span id="l98.63" class="difflineminus">-  {</span>
<a href="#l98.64"></a><span id="l98.64" class="difflineminus">-    char *base_hdr = MimeHeaders_get (obj-&gt;headers, HEADER_CONTENT_BASE,</span>
<a href="#l98.65"></a><span id="l98.65" class="difflineminus">-      false, false);</span>
<a href="#l98.66"></a><span id="l98.66" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;write_html_p &amp;&amp; obj-&gt;options-&gt;output_fn) {</span>
<a href="#l98.67"></a><span id="l98.67" class="difflineplus">+    char *base_hdr =</span>
<a href="#l98.68"></a><span id="l98.68" class="difflineplus">+        MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_BASE, false, false);</span>
<a href="#l98.69"></a><span id="l98.69"> </span>
<a href="#l98.70"></a><span id="l98.70">     /* rhp - for MHTML Spec changes!!! */</span>
<a href="#l98.71"></a><span id="l98.71" class="difflineminus">-    if (!base_hdr)</span>
<a href="#l98.72"></a><span id="l98.72" class="difflineminus">-    {</span>
<a href="#l98.73"></a><span id="l98.73" class="difflineminus">-      base_hdr = MimeHeaders_get (obj-&gt;headers, HEADER_CONTENT_LOCATION, false, false);</span>
<a href="#l98.74"></a><span id="l98.74" class="difflineplus">+    if (!base_hdr) {</span>
<a href="#l98.75"></a><span id="l98.75" class="difflineplus">+      base_hdr =</span>
<a href="#l98.76"></a><span id="l98.76" class="difflineplus">+          MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_LOCATION, false, false);</span>
<a href="#l98.77"></a><span id="l98.77">     }</span>
<a href="#l98.78"></a><span id="l98.78">     /* rhp - for MHTML Spec changes!!! */</span>
<a href="#l98.79"></a><span id="l98.79"> </span>
<a href="#l98.80"></a><span id="l98.80" class="difflineminus">-    if (base_hdr)</span>
<a href="#l98.81"></a><span id="l98.81" class="difflineminus">-    {</span>
<a href="#l98.82"></a><span id="l98.82" class="difflineplus">+    if (base_hdr) {</span>
<a href="#l98.83"></a><span id="l98.83">       uint32_t buflen = strlen(base_hdr) + 20;</span>
<a href="#l98.84"></a><span id="l98.84" class="difflineminus">-      char *buf = (char *) PR_MALLOC(buflen);</span>
<a href="#l98.85"></a><span id="l98.85" class="difflineplus">+      char *buf = (char *)PR_MALLOC(buflen);</span>
<a href="#l98.86"></a><span id="l98.86">       const char *in;</span>
<a href="#l98.87"></a><span id="l98.87">       char *out;</span>
<a href="#l98.88"></a><span id="l98.88" class="difflineminus">-      if (!buf)</span>
<a href="#l98.89"></a><span id="l98.89" class="difflineminus">-        return MIME_OUT_OF_MEMORY;</span>
<a href="#l98.90"></a><span id="l98.90" class="difflineplus">+      if (!buf) return MIME_OUT_OF_MEMORY;</span>
<a href="#l98.91"></a><span id="l98.91"> </span>
<a href="#l98.92"></a><span id="l98.92" class="difflineminus">-        /* The value of the Content-Base header is a number of &quot;words&quot;.</span>
<a href="#l98.93"></a><span id="l98.93" class="difflineminus">-        Whitespace in this header is not significant -- it is assumed</span>
<a href="#l98.94"></a><span id="l98.94" class="difflineminus">-        that any real whitespace in the URL has already been encoded,</span>
<a href="#l98.95"></a><span id="l98.95" class="difflineminus">-        and whitespace has been inserted to allow the lines in the</span>
<a href="#l98.96"></a><span id="l98.96" class="difflineminus">-        mail header to be wrapped reasonably.  Creators are supposed</span>
<a href="#l98.97"></a><span id="l98.97" class="difflineminus">-        to insert whitespace every 40 characters or less.</span>
<a href="#l98.98"></a><span id="l98.98" class="difflineminus">-      */</span>
<a href="#l98.99"></a><span id="l98.99" class="difflineplus">+      /* The value of the Content-Base header is a number of &quot;words&quot;.</span>
<a href="#l98.100"></a><span id="l98.100" class="difflineplus">+      Whitespace in this header is not significant -- it is assumed</span>
<a href="#l98.101"></a><span id="l98.101" class="difflineplus">+      that any real whitespace in the URL has already been encoded,</span>
<a href="#l98.102"></a><span id="l98.102" class="difflineplus">+      and whitespace has been inserted to allow the lines in the</span>
<a href="#l98.103"></a><span id="l98.103" class="difflineplus">+      mail header to be wrapped reasonably.  Creators are supposed</span>
<a href="#l98.104"></a><span id="l98.104" class="difflineplus">+      to insert whitespace every 40 characters or less.</span>
<a href="#l98.105"></a><span id="l98.105" class="difflineplus">+    */</span>
<a href="#l98.106"></a><span id="l98.106">       PL_strncpyz(buf, &quot;&lt;BASE HREF=\&quot;&quot;, buflen);</span>
<a href="#l98.107"></a><span id="l98.107">       out = buf + strlen(buf);</span>
<a href="#l98.108"></a><span id="l98.108"> </span>
<a href="#l98.109"></a><span id="l98.109" class="difflineminus">-      for (in = base_hdr; *in; in++)</span>
<a href="#l98.110"></a><span id="l98.110" class="difflineminus">-        /* ignore whitespace and quotes */</span>
<a href="#l98.111"></a><span id="l98.111" class="difflineminus">-        if (!IS_SPACE(*in) &amp;&amp; *in != '&quot;')</span>
<a href="#l98.112"></a><span id="l98.112" class="difflineminus">-          *out++ = *in;</span>
<a href="#l98.113"></a><span id="l98.113" class="difflineplus">+      for (in = base_hdr; *in; in++) /* ignore whitespace and quotes */</span>
<a href="#l98.114"></a><span id="l98.114" class="difflineplus">+        if (!IS_SPACE(*in) &amp;&amp; *in != '&quot;') *out++ = *in;</span>
<a href="#l98.115"></a><span id="l98.115"> </span>
<a href="#l98.116"></a><span id="l98.116">       /* Close the tag and argument. */</span>
<a href="#l98.117"></a><span id="l98.117">       *out++ = '&quot;';</span>
<a href="#l98.118"></a><span id="l98.118">       *out++ = '&gt;';</span>
<a href="#l98.119"></a><span id="l98.119">       *out++ = 0;</span>
<a href="#l98.120"></a><span id="l98.120"> </span>
<a href="#l98.121"></a><span id="l98.121">       PR_Free(base_hdr);</span>
<a href="#l98.122"></a><span id="l98.122"> </span>
<a href="#l98.123"></a><span id="l98.123" class="difflineat">@@ -100,155 +89,136 @@ MimeInlineTextHTML_parse_begin (MimeObje</span>
<a href="#l98.124"></a><span id="l98.124">       PR_Free(buf);</span>
<a href="#l98.125"></a><span id="l98.125">       if (status &lt; 0) return status;</span>
<a href="#l98.126"></a><span id="l98.126">     }</span>
<a href="#l98.127"></a><span id="l98.127">   }</span>
<a href="#l98.128"></a><span id="l98.128"> </span>
<a href="#l98.129"></a><span id="l98.129">   return 0;</span>
<a href="#l98.130"></a><span id="l98.130"> }</span>
<a href="#l98.131"></a><span id="l98.131"> </span>
<a href="#l98.132"></a><span id="l98.132" class="difflineminus">-</span>
<a href="#l98.133"></a><span id="l98.133" class="difflineminus">-static int</span>
<a href="#l98.134"></a><span id="l98.134" class="difflineminus">-MimeInlineTextHTML_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l98.135"></a><span id="l98.135" class="difflineminus">-{</span>
<a href="#l98.136"></a><span id="l98.136" class="difflineminus">-  MimeInlineTextHTML  *textHTML = (MimeInlineTextHTML *) obj;</span>
<a href="#l98.137"></a><span id="l98.137" class="difflineplus">+static int MimeInlineTextHTML_parse_line(const char *line, int32_t length,</span>
<a href="#l98.138"></a><span id="l98.138" class="difflineplus">+                                         MimeObject *obj) {</span>
<a href="#l98.139"></a><span id="l98.139" class="difflineplus">+  MimeInlineTextHTML *textHTML = (MimeInlineTextHTML *)obj;</span>
<a href="#l98.140"></a><span id="l98.140"> </span>
<a href="#l98.141"></a><span id="l98.141" class="difflineminus">-  if (!obj-&gt;output_p)</span>
<a href="#l98.142"></a><span id="l98.142" class="difflineminus">-    return 0;</span>
<a href="#l98.143"></a><span id="l98.143" class="difflineplus">+  if (!obj-&gt;output_p) return 0;</span>
<a href="#l98.144"></a><span id="l98.144"> </span>
<a href="#l98.145"></a><span id="l98.145" class="difflineminus">-  if (!obj-&gt;options || !obj-&gt;options-&gt;output_fn)</span>
<a href="#l98.146"></a><span id="l98.146" class="difflineminus">-    return 0;</span>
<a href="#l98.147"></a><span id="l98.147" class="difflineplus">+  if (!obj-&gt;options || !obj-&gt;options-&gt;output_fn) return 0;</span>
<a href="#l98.148"></a><span id="l98.148"> </span>
<a href="#l98.149"></a><span id="l98.149" class="difflineminus">-  if (!textHTML-&gt;charset)</span>
<a href="#l98.150"></a><span id="l98.150" class="difflineminus">-  {</span>
<a href="#l98.151"></a><span id="l98.151" class="difflineminus">-    char * cp;</span>
<a href="#l98.152"></a><span id="l98.152" class="difflineplus">+  if (!textHTML-&gt;charset) {</span>
<a href="#l98.153"></a><span id="l98.153" class="difflineplus">+    char *cp;</span>
<a href="#l98.154"></a><span id="l98.154">     // First, try to detect a charset via a META tag!</span>
<a href="#l98.155"></a><span id="l98.155">     if ((cp = PL_strncasestr(line, &quot;META&quot;, length)) &amp;&amp;</span>
<a href="#l98.156"></a><span id="l98.156">         (cp = PL_strncasestr(cp, &quot;HTTP-EQUIV=&quot;, length - (int)(cp - line))) &amp;&amp;</span>
<a href="#l98.157"></a><span id="l98.157">         (cp = PL_strncasestr(cp, &quot;CONTENT=&quot;, length - (int)(cp - line))) &amp;&amp;</span>
<a href="#l98.158"></a><span id="l98.158" class="difflineminus">-        (cp = PL_strncasestr(cp, &quot;CHARSET=&quot;, length - (int)(cp - line)))</span>
<a href="#l98.159"></a><span id="l98.159" class="difflineminus">-        )</span>
<a href="#l98.160"></a><span id="l98.160" class="difflineminus">-    {</span>
<a href="#l98.161"></a><span id="l98.161" class="difflineminus">-      char* cp1 = cp + 8;  //8 for the length of &quot;CHARSET=&quot;</span>
<a href="#l98.162"></a><span id="l98.162" class="difflineminus">-      char* cp2 = PL_strnpbrk(cp1, &quot; \&quot;\'&quot;, length - (int)(cp1 - line));</span>
<a href="#l98.163"></a><span id="l98.163" class="difflineminus">-      if (cp2)</span>
<a href="#l98.164"></a><span id="l98.164" class="difflineminus">-      {</span>
<a href="#l98.165"></a><span id="l98.165" class="difflineminus">-        char* charset = PL_strndup(cp1, (int)(cp2 - cp1));</span>
<a href="#l98.166"></a><span id="l98.166" class="difflineplus">+        (cp = PL_strncasestr(cp, &quot;CHARSET=&quot;, length - (int)(cp - line)))) {</span>
<a href="#l98.167"></a><span id="l98.167" class="difflineplus">+      char *cp1 = cp + 8;  // 8 for the length of &quot;CHARSET=&quot;</span>
<a href="#l98.168"></a><span id="l98.168" class="difflineplus">+      char *cp2 = PL_strnpbrk(cp1, &quot; \&quot;\'&quot;, length - (int)(cp1 - line));</span>
<a href="#l98.169"></a><span id="l98.169" class="difflineplus">+      if (cp2) {</span>
<a href="#l98.170"></a><span id="l98.170" class="difflineplus">+        char *charset = PL_strndup(cp1, (int)(cp2 - cp1));</span>
<a href="#l98.171"></a><span id="l98.171"> </span>
<a href="#l98.172"></a><span id="l98.172">         // Fix bug 101434, in this case since this parsing is a char*</span>
<a href="#l98.173"></a><span id="l98.173">         // operation, a real UTF-16 or UTF-32 document won't be parse</span>
<a href="#l98.174"></a><span id="l98.174">         // correctly, if it got parse, it cannot be UTF-16 nor UTF-32</span>
<a href="#l98.175"></a><span id="l98.175">         // there fore, we ignore them if somehow we got that value</span>
<a href="#l98.176"></a><span id="l98.176">         // 6 == strlen(&quot;UTF-16&quot;) or strlen(&quot;UTF-32&quot;), this will cover</span>
<a href="#l98.177"></a><span id="l98.177">         // UTF-16, UTF-16BE, UTF-16LE, UTF-32, UTF-32BE, UTF-32LE</span>
<a href="#l98.178"></a><span id="l98.178" class="difflineminus">-        if ((charset != nullptr) &amp;&amp;</span>
<a href="#l98.179"></a><span id="l98.179" class="difflineminus">-            PL_strncasecmp(charset, &quot;UTF-16&quot;, 6) &amp;&amp;</span>
<a href="#l98.180"></a><span id="l98.180" class="difflineminus">-            PL_strncasecmp(charset, &quot;UTF-32&quot;, 6))</span>
<a href="#l98.181"></a><span id="l98.181" class="difflineminus">-        {</span>
<a href="#l98.182"></a><span id="l98.182" class="difflineplus">+        if ((charset != nullptr) &amp;&amp; PL_strncasecmp(charset, &quot;UTF-16&quot;, 6) &amp;&amp;</span>
<a href="#l98.183"></a><span id="l98.183" class="difflineplus">+            PL_strncasecmp(charset, &quot;UTF-32&quot;, 6)) {</span>
<a href="#l98.184"></a><span id="l98.184">           textHTML-&gt;charset = charset;</span>
<a href="#l98.185"></a><span id="l98.185"> </span>
<a href="#l98.186"></a><span id="l98.186">           // write out the data without the charset part...</span>
<a href="#l98.187"></a><span id="l98.187" class="difflineminus">-          if (textHTML-&gt;charset)</span>
<a href="#l98.188"></a><span id="l98.188" class="difflineminus">-          {</span>
<a href="#l98.189"></a><span id="l98.189" class="difflineplus">+          if (textHTML-&gt;charset) {</span>
<a href="#l98.190"></a><span id="l98.190">             int err = MimeObject_write(obj, line, cp - line, true);</span>
<a href="#l98.191"></a><span id="l98.191">             if (err == 0)</span>
<a href="#l98.192"></a><span id="l98.192" class="difflineminus">-              err = MimeObject_write(obj, cp2, length - (int)(cp2 - line), true);</span>
<a href="#l98.193"></a><span id="l98.193" class="difflineplus">+              err =</span>
<a href="#l98.194"></a><span id="l98.194" class="difflineplus">+                  MimeObject_write(obj, cp2, length - (int)(cp2 - line), true);</span>
<a href="#l98.195"></a><span id="l98.195"> </span>
<a href="#l98.196"></a><span id="l98.196">             return err;</span>
<a href="#l98.197"></a><span id="l98.197">           }</span>
<a href="#l98.198"></a><span id="l98.198">         }</span>
<a href="#l98.199"></a><span id="l98.199">         PR_FREEIF(charset);</span>
<a href="#l98.200"></a><span id="l98.200">       }</span>
<a href="#l98.201"></a><span id="l98.201">     }</span>
<a href="#l98.202"></a><span id="l98.202">   }</span>
<a href="#l98.203"></a><span id="l98.203"> </span>
<a href="#l98.204"></a><span id="l98.204">   // Now, just write out the data...</span>
<a href="#l98.205"></a><span id="l98.205">   return MimeObject_write(obj, line, length, true);</span>
<a href="#l98.206"></a><span id="l98.206"> }</span>
<a href="#l98.207"></a><span id="l98.207"> </span>
<a href="#l98.208"></a><span id="l98.208" class="difflineminus">-static int</span>
<a href="#l98.209"></a><span id="l98.209" class="difflineminus">-MimeInlineTextHTML_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l98.210"></a><span id="l98.210" class="difflineminus">-{</span>
<a href="#l98.211"></a><span id="l98.211" class="difflineplus">+static int MimeInlineTextHTML_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l98.212"></a><span id="l98.212">   int status;</span>
<a href="#l98.213"></a><span id="l98.213" class="difflineminus">-  MimeInlineTextHTML  *textHTML = (MimeInlineTextHTML *) obj;</span>
<a href="#l98.214"></a><span id="l98.214" class="difflineplus">+  MimeInlineTextHTML *textHTML = (MimeInlineTextHTML *)obj;</span>
<a href="#l98.215"></a><span id="l98.215">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l98.216"></a><span id="l98.216"> </span>
<a href="#l98.217"></a><span id="l98.217">   PR_FREEIF(textHTML-&gt;charset);</span>
<a href="#l98.218"></a><span id="l98.218"> </span>
<a href="#l98.219"></a><span id="l98.219">   /* Run parent method first, to flush out any buffered data. */</span>
<a href="#l98.220"></a><span id="l98.220" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l98.221"></a><span id="l98.221" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l98.222"></a><span id="l98.222">   if (status &lt; 0) return status;</span>
<a href="#l98.223"></a><span id="l98.223"> </span>
<a href="#l98.224"></a><span id="l98.224">   return 0;</span>
<a href="#l98.225"></a><span id="l98.225"> }</span>
<a href="#l98.226"></a><span id="l98.226"> </span>
<a href="#l98.227"></a><span id="l98.227"> /*</span>
<a href="#l98.228"></a><span id="l98.228">  * The following function adds &lt;div class=&quot;moz-text-html&quot; lang=&quot;...&quot;&gt; or</span>
<a href="#l98.229"></a><span id="l98.229">  * &lt;div class=&quot;moz-text-html&quot;&gt; as the first tag following the &lt;body&gt; tag in the</span>
<a href="#l98.230"></a><span id="l98.230">  * serialised HTML of a message. This becomes a no-op if no &lt;body&gt; tag is found.</span>
<a href="#l98.231"></a><span id="l98.231">  */</span>
<a href="#l98.232"></a><span id="l98.232" class="difflineminus">-void</span>
<a href="#l98.233"></a><span id="l98.233" class="difflineminus">-MimeInlineTextHTML_insert_lang_div(MimeObject *obj, nsCString &amp;message)</span>
<a href="#l98.234"></a><span id="l98.234" class="difflineminus">-{</span>
<a href="#l98.235"></a><span id="l98.235" class="difflineplus">+void MimeInlineTextHTML_insert_lang_div(MimeObject *obj, nsCString &amp;message) {</span>
<a href="#l98.236"></a><span id="l98.236">   if (obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageBodyDisplay &amp;&amp;</span>
<a href="#l98.237"></a><span id="l98.237">       obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessagePrintOutput)</span>
<a href="#l98.238"></a><span id="l98.238">     return;</span>
<a href="#l98.239"></a><span id="l98.239"> </span>
<a href="#l98.240"></a><span id="l98.240">   // Make sure we have a &lt;body&gt; before we start.</span>
<a href="#l98.241"></a><span id="l98.241">   int32_t index = message.Find(&quot;&lt;body&quot;, /* ignoreCase = */ true);</span>
<a href="#l98.242"></a><span id="l98.242" class="difflineminus">-  if (index == kNotFound)</span>
<a href="#l98.243"></a><span id="l98.243" class="difflineminus">-    return;</span>
<a href="#l98.244"></a><span id="l98.244" class="difflineplus">+  if (index == kNotFound) return;</span>
<a href="#l98.245"></a><span id="l98.245">   index = message.FindChar('&gt;', index) + 1;</span>
<a href="#l98.246"></a><span id="l98.246"> </span>
<a href="#l98.247"></a><span id="l98.247" class="difflineminus">-  // Insert &lt;div class=&quot;moz-text-html&quot; lang=&quot;...&quot;&gt; for the following two purposes:</span>
<a href="#l98.248"></a><span id="l98.248" class="difflineminus">-  // 1) Users can configure their HTML display via CSS for .moz-text-html.</span>
<a href="#l98.249"></a><span id="l98.249" class="difflineminus">-  // 2) The language group in the 'lang' attribure is used by Gecko to determine</span>
<a href="#l98.250"></a><span id="l98.250" class="difflineplus">+  // Insert &lt;div class=&quot;moz-text-html&quot; lang=&quot;...&quot;&gt; for the following two</span>
<a href="#l98.251"></a><span id="l98.251" class="difflineplus">+  // purposes: 1) Users can configure their HTML display via CSS for</span>
<a href="#l98.252"></a><span id="l98.252" class="difflineplus">+  // .moz-text-html. 2) The language group in the 'lang' attribure is used by</span>
<a href="#l98.253"></a><span id="l98.253" class="difflineplus">+  // Gecko to determine</span>
<a href="#l98.254"></a><span id="l98.254">   //    which font to use.</span>
<a href="#l98.255"></a><span id="l98.255" class="difflineminus">-  int32_t fontSize;             // default font size</span>
<a href="#l98.256"></a><span id="l98.256" class="difflineminus">-  int32_t fontSizePercentage;   // size percentage</span>
<a href="#l98.257"></a><span id="l98.257" class="difflineminus">-  nsAutoCString fontLang;       // langgroup of the font.</span>
<a href="#l98.258"></a><span id="l98.258" class="difflineminus">-  if (NS_SUCCEEDED(GetMailNewsFont(obj, false, &amp;fontSize, &amp;fontSizePercentage, fontLang)))</span>
<a href="#l98.259"></a><span id="l98.259" class="difflineminus">-  {</span>
<a href="#l98.260"></a><span id="l98.260" class="difflineplus">+  int32_t fontSize;            // default font size</span>
<a href="#l98.261"></a><span id="l98.261" class="difflineplus">+  int32_t fontSizePercentage;  // size percentage</span>
<a href="#l98.262"></a><span id="l98.262" class="difflineplus">+  nsAutoCString fontLang;      // langgroup of the font.</span>
<a href="#l98.263"></a><span id="l98.263" class="difflineplus">+  if (NS_SUCCEEDED(GetMailNewsFont(obj, false, &amp;fontSize, &amp;fontSizePercentage,</span>
<a href="#l98.264"></a><span id="l98.264" class="difflineplus">+                                   fontLang))) {</span>
<a href="#l98.265"></a><span id="l98.265">     message.Insert(NS_LITERAL_CSTRING(&quot;&lt;div class=\&quot;moz-text-html\&quot; lang=\&quot;&quot;) +</span>
<a href="#l98.266"></a><span id="l98.266" class="difflineminus">-                   fontLang +</span>
<a href="#l98.267"></a><span id="l98.267" class="difflineminus">-                   NS_LITERAL_CSTRING(&quot;\&quot;&gt;&quot;),</span>
<a href="#l98.268"></a><span id="l98.268" class="difflineplus">+                       fontLang + NS_LITERAL_CSTRING(&quot;\&quot;&gt;&quot;),</span>
<a href="#l98.269"></a><span id="l98.269">                    index);</span>
<a href="#l98.270"></a><span id="l98.270" class="difflineminus">-  }</span>
<a href="#l98.271"></a><span id="l98.271" class="difflineminus">-  else</span>
<a href="#l98.272"></a><span id="l98.272" class="difflineminus">-  {</span>
<a href="#l98.273"></a><span id="l98.273" class="difflineminus">-    message.Insert(NS_LITERAL_CSTRING(&quot;&lt;div class=\&quot;moz-text-html\&quot;&gt;&quot;),</span>
<a href="#l98.274"></a><span id="l98.274" class="difflineminus">-                   index);</span>
<a href="#l98.275"></a><span id="l98.275" class="difflineplus">+  } else {</span>
<a href="#l98.276"></a><span id="l98.276" class="difflineplus">+    message.Insert(NS_LITERAL_CSTRING(&quot;&lt;div class=\&quot;moz-text-html\&quot;&gt;&quot;), index);</span>
<a href="#l98.277"></a><span id="l98.277">   }</span>
<a href="#l98.278"></a><span id="l98.278"> </span>
<a href="#l98.279"></a><span id="l98.279">   index = message.RFind(&quot;&lt;/body&gt;&quot;, /* ignoreCase = */ true);</span>
<a href="#l98.280"></a><span id="l98.280" class="difflineminus">-  if (index != kNotFound)</span>
<a href="#l98.281"></a><span id="l98.281" class="difflineminus">-    message.Insert(NS_LITERAL_CSTRING(&quot;&lt;/div&gt;&quot;), index);</span>
<a href="#l98.282"></a><span id="l98.282" class="difflineplus">+  if (index != kNotFound) message.Insert(NS_LITERAL_CSTRING(&quot;&lt;/div&gt;&quot;), index);</span>
<a href="#l98.283"></a><span id="l98.283"> }</span>
<a href="#l98.284"></a><span id="l98.284"> </span>
<a href="#l98.285"></a><span id="l98.285"> /*</span>
<a href="#l98.286"></a><span id="l98.286">  * The following function replaces &lt;plaintext&gt; tags with &lt;x-plaintext&gt;.</span>
<a href="#l98.287"></a><span id="l98.287">  * &lt;plaintext&gt; is a funny beast: It leads to everything following it</span>
<a href="#l98.288"></a><span id="l98.288">  * being displayed verbatim, even a &lt;/plaintext&gt; tag is ignored.</span>
<a href="#l98.289"></a><span id="l98.289">  */</span>
<a href="#l98.290"></a><span id="l98.290" class="difflineminus">-void</span>
<a href="#l98.291"></a><span id="l98.291" class="difflineminus">-MimeInlineTextHTML_remove_plaintext_tag(MimeObject *obj, nsCString &amp;message)</span>
<a href="#l98.292"></a><span id="l98.292" class="difflineminus">-{</span>
<a href="#l98.293"></a><span id="l98.293" class="difflineplus">+void MimeInlineTextHTML_remove_plaintext_tag(MimeObject *obj,</span>
<a href="#l98.294"></a><span id="l98.294" class="difflineplus">+                                             nsCString &amp;message) {</span>
<a href="#l98.295"></a><span id="l98.295">   if (obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageBodyDisplay &amp;&amp;</span>
<a href="#l98.296"></a><span id="l98.296">       obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessagePrintOutput)</span>
<a href="#l98.297"></a><span id="l98.297">     return;</span>
<a href="#l98.298"></a><span id="l98.298"> </span>
<a href="#l98.299"></a><span id="l98.299">   // Replace all &lt;plaintext&gt; and &lt;/plaintext&gt; tags.</span>
<a href="#l98.300"></a><span id="l98.300">   int32_t index = 0;</span>
<a href="#l98.301"></a><span id="l98.301">   bool replaced = false;</span>
<a href="#l98.302"></a><span id="l98.302" class="difflineminus">-  while ((index = message.Find(&quot;&lt;plaintext&quot;, /* ignoreCase = */ true, index)) != kNotFound) {</span>
<a href="#l98.303"></a><span id="l98.303" class="difflineminus">-    message.Insert(&quot;x-&quot;, index+1);</span>
<a href="#l98.304"></a><span id="l98.304" class="difflineplus">+  while ((index = message.Find(&quot;&lt;plaintext&quot;, /* ignoreCase = */ true, index)) !=</span>
<a href="#l98.305"></a><span id="l98.305" class="difflineplus">+         kNotFound) {</span>
<a href="#l98.306"></a><span id="l98.306" class="difflineplus">+    message.Insert(&quot;x-&quot;, index + 1);</span>
<a href="#l98.307"></a><span id="l98.307">     index += 12;</span>
<a href="#l98.308"></a><span id="l98.308">     replaced = true;</span>
<a href="#l98.309"></a><span id="l98.309">   }</span>
<a href="#l98.310"></a><span id="l98.310">   if (replaced) {</span>
<a href="#l98.311"></a><span id="l98.311">     index = 0;</span>
<a href="#l98.312"></a><span id="l98.312" class="difflineminus">-    while ((index = message.Find(&quot;&lt;/plaintext&quot;, /* ignoreCase = */ true, index)) != kNotFound) {</span>
<a href="#l98.313"></a><span id="l98.313" class="difflineminus">-      message.Insert(&quot;x-&quot;, index+2);</span>
<a href="#l98.314"></a><span id="l98.314" class="difflineplus">+    while ((index = message.Find(&quot;&lt;/plaintext&quot;, /* ignoreCase = */ true,</span>
<a href="#l98.315"></a><span id="l98.315" class="difflineplus">+                                 index)) != kNotFound) {</span>
<a href="#l98.316"></a><span id="l98.316" class="difflineplus">+      message.Insert(&quot;x-&quot;, index + 2);</span>
<a href="#l98.317"></a><span id="l98.317">       index += 13;</span>
<a href="#l98.318"></a><span id="l98.318">     }</span>
<a href="#l98.319"></a><span id="l98.319">   }</span>
<a href="#l98.320"></a><span id="l98.320"> }</span>
<a href="#l98.321"></a><span id="l98.321" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l99.1"></a><span id="l99.1" class="difflineminus">--- a/mailnews/mime/src/mimethtm.h</span>
<a href="#l99.2"></a><span id="l99.2" class="difflineplus">+++ b/mailnews/mime/src/mimethtm.h</span>
<a href="#l99.3"></a><span id="l99.3" class="difflineat">@@ -7,29 +7,28 @@</span>
<a href="#l99.4"></a><span id="l99.4"> #define _MIMETHTM_H_</span>
<a href="#l99.5"></a><span id="l99.5"> </span>
<a href="#l99.6"></a><span id="l99.6"> #include &quot;mimetext.h&quot;</span>
<a href="#l99.7"></a><span id="l99.7"> </span>
<a href="#l99.8"></a><span id="l99.8"> /* The MimeInlineTextHTML class implements the text/html MIME content type.</span>
<a href="#l99.9"></a><span id="l99.9">  */</span>
<a href="#l99.10"></a><span id="l99.10"> </span>
<a href="#l99.11"></a><span id="l99.11"> typedef struct MimeInlineTextHTMLClass MimeInlineTextHTMLClass;</span>
<a href="#l99.12"></a><span id="l99.12" class="difflineminus">-typedef struct MimeInlineTextHTML      MimeInlineTextHTML;</span>
<a href="#l99.13"></a><span id="l99.13" class="difflineplus">+typedef struct MimeInlineTextHTML MimeInlineTextHTML;</span>
<a href="#l99.14"></a><span id="l99.14"> </span>
<a href="#l99.15"></a><span id="l99.15"> struct MimeInlineTextHTMLClass {</span>
<a href="#l99.16"></a><span id="l99.16">   MimeInlineTextClass text;</span>
<a href="#l99.17"></a><span id="l99.17"> };</span>
<a href="#l99.18"></a><span id="l99.18"> </span>
<a href="#l99.19"></a><span id="l99.19"> extern MimeInlineTextHTMLClass mimeInlineTextHTMLClass;</span>
<a href="#l99.20"></a><span id="l99.20"> </span>
<a href="#l99.21"></a><span id="l99.21"> struct MimeInlineTextHTML {</span>
<a href="#l99.22"></a><span id="l99.22" class="difflineminus">-  MimeInlineText  text;</span>
<a href="#l99.23"></a><span id="l99.23" class="difflineminus">-  char            *charset;  /* If we sniffed a charset, do some converting! */</span>
<a href="#l99.24"></a><span id="l99.24" class="difflineplus">+  MimeInlineText text;</span>
<a href="#l99.25"></a><span id="l99.25" class="difflineplus">+  char *charset; /* If we sniffed a charset, do some converting! */</span>
<a href="#l99.26"></a><span id="l99.26"> };</span>
<a href="#l99.27"></a><span id="l99.27"> </span>
<a href="#l99.28"></a><span id="l99.28" class="difflineminus">-#define MimeInlineTextHTMLClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l99.29"></a><span id="l99.29" class="difflineminus">-  { MimeInlineTextClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l99.30"></a><span id="l99.30" class="difflineplus">+#define MimeInlineTextHTMLClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l99.31"></a><span id="l99.31" class="difflineplus">+  { MimeInlineTextClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l99.32"></a><span id="l99.32"> </span>
<a href="#l99.33"></a><span id="l99.33" class="difflineminus">-void</span>
<a href="#l99.34"></a><span id="l99.34" class="difflineminus">-MimeInlineTextHTML_insert_lang_div(MimeObject *obj, nsCString &amp;message);</span>
<a href="#l99.35"></a><span id="l99.35" class="difflineminus">-void</span>
<a href="#l99.36"></a><span id="l99.36" class="difflineminus">-MimeInlineTextHTML_remove_plaintext_tag(MimeObject *obj, nsCString &amp;message);</span>
<a href="#l99.37"></a><span id="l99.37" class="difflineplus">+void MimeInlineTextHTML_insert_lang_div(MimeObject *obj, nsCString &amp;message);</span>
<a href="#l99.38"></a><span id="l99.38" class="difflineplus">+void MimeInlineTextHTML_remove_plaintext_tag(MimeObject *obj,</span>
<a href="#l99.39"></a><span id="l99.39" class="difflineplus">+                                             nsCString &amp;message);</span>
<a href="#l99.40"></a><span id="l99.40"> #endif /* _MIMETHTM_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l100.1"></a><span id="l100.1" class="difflineminus">--- a/mailnews/mime/src/mimetpfl.cpp</span>
<a href="#l100.2"></a><span id="l100.2" class="difflineplus">+++ b/mailnews/mime/src/mimetpfl.cpp</span>
<a href="#l100.3"></a><span id="l100.3" class="difflineat">@@ -10,619 +10,599 @@</span>
<a href="#l100.4"></a><span id="l100.4"> #include &quot;mozITXTToHTMLConv.h&quot;</span>
<a href="#l100.5"></a><span id="l100.5"> #include &quot;nsString.h&quot;</span>
<a href="#l100.6"></a><span id="l100.6"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l100.7"></a><span id="l100.7"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l100.8"></a><span id="l100.8"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l100.9"></a><span id="l100.9"> #include &quot;prprf.h&quot;</span>
<a href="#l100.10"></a><span id="l100.10"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l100.11"></a><span id="l100.11"> </span>
<a href="#l100.12"></a><span id="l100.12" class="difflineminus">-static const uint32_t kSpacesForATab = 4; // Must be at least 1.</span>
<a href="#l100.13"></a><span id="l100.13" class="difflineplus">+static const uint32_t kSpacesForATab = 4;  // Must be at least 1.</span>
<a href="#l100.14"></a><span id="l100.14"> </span>
<a href="#l100.15"></a><span id="l100.15"> #define MIME_SUPERCLASS mimeInlineTextClass</span>
<a href="#l100.16"></a><span id="l100.16"> MimeDefClass(MimeInlineTextPlainFlowed, MimeInlineTextPlainFlowedClass,</span>
<a href="#l100.17"></a><span id="l100.17" class="difflineminus">-       mimeInlineTextPlainFlowedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l100.18"></a><span id="l100.18" class="difflineplus">+             mimeInlineTextPlainFlowedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l100.19"></a><span id="l100.19"> </span>
<a href="#l100.20"></a><span id="l100.20" class="difflineminus">-static int MimeInlineTextPlainFlowed_parse_begin (MimeObject *);</span>
<a href="#l100.21"></a><span id="l100.21" class="difflineminus">-static int MimeInlineTextPlainFlowed_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l100.22"></a><span id="l100.22" class="difflineminus">-static int MimeInlineTextPlainFlowed_parse_eof (MimeObject *, bool);</span>
<a href="#l100.23"></a><span id="l100.23" class="difflineplus">+static int MimeInlineTextPlainFlowed_parse_begin(MimeObject *);</span>
<a href="#l100.24"></a><span id="l100.24" class="difflineplus">+static int MimeInlineTextPlainFlowed_parse_line(const char *, int32_t,</span>
<a href="#l100.25"></a><span id="l100.25" class="difflineplus">+                                                MimeObject *);</span>
<a href="#l100.26"></a><span id="l100.26" class="difflineplus">+static int MimeInlineTextPlainFlowed_parse_eof(MimeObject *, bool);</span>
<a href="#l100.27"></a><span id="l100.27"> </span>
<a href="#l100.28"></a><span id="l100.28" class="difflineminus">-static MimeInlineTextPlainFlowedExData *MimeInlineTextPlainFlowedExDataList = nullptr;</span>
<a href="#l100.29"></a><span id="l100.29" class="difflineplus">+static MimeInlineTextPlainFlowedExData *MimeInlineTextPlainFlowedExDataList =</span>
<a href="#l100.30"></a><span id="l100.30" class="difflineplus">+    nullptr;</span>
<a href="#l100.31"></a><span id="l100.31"> </span>
<a href="#l100.32"></a><span id="l100.32"> // From mimetpla.cpp</span>
<a href="#l100.33"></a><span id="l100.33"> extern &quot;C&quot; void MimeTextBuildPrefixCSS(</span>
<a href="#l100.34"></a><span id="l100.34" class="difflineminus">-                       int32_t quotedSizeSetting,      // mail.quoted_size</span>
<a href="#l100.35"></a><span id="l100.35" class="difflineminus">-                       int32_t    quotedStyleSetting,  // mail.quoted_style</span>
<a href="#l100.36"></a><span id="l100.36" class="difflineminus">-                       nsACString &amp;citationColor,      // mail.citation_color</span>
<a href="#l100.37"></a><span id="l100.37" class="difflineminus">-                       nsACString &amp;style);</span>
<a href="#l100.38"></a><span id="l100.38" class="difflineplus">+    int32_t quotedSizeSetting,   // mail.quoted_size</span>
<a href="#l100.39"></a><span id="l100.39" class="difflineplus">+    int32_t quotedStyleSetting,  // mail.quoted_style</span>
<a href="#l100.40"></a><span id="l100.40" class="difflineplus">+    nsACString &amp;citationColor,   // mail.citation_color</span>
<a href="#l100.41"></a><span id="l100.41" class="difflineplus">+    nsACString &amp;style);</span>
<a href="#l100.42"></a><span id="l100.42"> // Definition below</span>
<a href="#l100.43"></a><span id="l100.43" class="difflineminus">-static</span>
<a href="#l100.44"></a><span id="l100.44" class="difflineminus">-nsresult Line_convert_whitespace(const nsString&amp; a_line,</span>
<a href="#l100.45"></a><span id="l100.45" class="difflineminus">-                                 const bool a_convert_all_whitespace,</span>
<a href="#l100.46"></a><span id="l100.46" class="difflineminus">-                                 nsString&amp; a_out_line);</span>
<a href="#l100.47"></a><span id="l100.47" class="difflineplus">+static nsresult Line_convert_whitespace(const nsString &amp;a_line,</span>
<a href="#l100.48"></a><span id="l100.48" class="difflineplus">+                                        const bool a_convert_all_whitespace,</span>
<a href="#l100.49"></a><span id="l100.49" class="difflineplus">+                                        nsString &amp;a_out_line);</span>
<a href="#l100.50"></a><span id="l100.50"> </span>
<a href="#l100.51"></a><span id="l100.51" class="difflineminus">-static int</span>
<a href="#l100.52"></a><span id="l100.52" class="difflineminus">-MimeInlineTextPlainFlowedClassInitialize(MimeInlineTextPlainFlowedClass *clazz)</span>
<a href="#l100.53"></a><span id="l100.53" class="difflineminus">-{</span>
<a href="#l100.54"></a><span id="l100.54" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l100.55"></a><span id="l100.55" class="difflineplus">+static int MimeInlineTextPlainFlowedClassInitialize(</span>
<a href="#l100.56"></a><span id="l100.56" class="difflineplus">+    MimeInlineTextPlainFlowedClass *clazz) {</span>
<a href="#l100.57"></a><span id="l100.57" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l100.58"></a><span id="l100.58">   NS_ASSERTION(!oclass-&gt;class_initialized, &quot;class not initialized&quot;);</span>
<a href="#l100.59"></a><span id="l100.59">   oclass-&gt;parse_begin = MimeInlineTextPlainFlowed_parse_begin;</span>
<a href="#l100.60"></a><span id="l100.60" class="difflineminus">-  oclass-&gt;parse_line  = MimeInlineTextPlainFlowed_parse_line;</span>
<a href="#l100.61"></a><span id="l100.61" class="difflineminus">-  oclass-&gt;parse_eof   = MimeInlineTextPlainFlowed_parse_eof;</span>
<a href="#l100.62"></a><span id="l100.62" class="difflineplus">+  oclass-&gt;parse_line = MimeInlineTextPlainFlowed_parse_line;</span>
<a href="#l100.63"></a><span id="l100.63" class="difflineplus">+  oclass-&gt;parse_eof = MimeInlineTextPlainFlowed_parse_eof;</span>
<a href="#l100.64"></a><span id="l100.64"> </span>
<a href="#l100.65"></a><span id="l100.65">   return 0;</span>
<a href="#l100.66"></a><span id="l100.66"> }</span>
<a href="#l100.67"></a><span id="l100.67"> </span>
<a href="#l100.68"></a><span id="l100.68" class="difflineminus">-static int</span>
<a href="#l100.69"></a><span id="l100.69" class="difflineminus">-MimeInlineTextPlainFlowed_parse_begin (MimeObject *obj)</span>
<a href="#l100.70"></a><span id="l100.70" class="difflineminus">-{</span>
<a href="#l100.71"></a><span id="l100.71" class="difflineminus">-  int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l100.72"></a><span id="l100.72" class="difflineplus">+static int MimeInlineTextPlainFlowed_parse_begin(MimeObject *obj) {</span>
<a href="#l100.73"></a><span id="l100.73" class="difflineplus">+  int status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l100.74"></a><span id="l100.74" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l100.75"></a><span id="l100.75" class="difflineplus">+</span>
<a href="#l100.76"></a><span id="l100.76" class="difflineplus">+  status = MimeObject_write(obj, &quot;&quot;, 0, true); /* force out any separators... */</span>
<a href="#l100.77"></a><span id="l100.77">   if (status &lt; 0) return status;</span>
<a href="#l100.78"></a><span id="l100.78"> </span>
<a href="#l100.79"></a><span id="l100.79" class="difflineminus">-  status =  MimeObject_write(obj, &quot;&quot;, 0, true); /* force out any separators... */</span>
<a href="#l100.80"></a><span id="l100.80" class="difflineminus">-  if(status&lt;0) return status;</span>
<a href="#l100.81"></a><span id="l100.81" class="difflineminus">-</span>
<a href="#l100.82"></a><span id="l100.82" class="difflineminus">-  bool quoting = ( obj-&gt;options</span>
<a href="#l100.83"></a><span id="l100.83" class="difflineminus">-    &amp;&amp; ( obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l100.84"></a><span id="l100.84" class="difflineminus">-         obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting</span>
<a href="#l100.85"></a><span id="l100.85" class="difflineminus">-       )       );  // The output will be inserted in the composer as quotation</span>
<a href="#l100.86"></a><span id="l100.86" class="difflineminus">-  bool plainHTML = quoting || (obj-&gt;options &amp;&amp;</span>
<a href="#l100.87"></a><span id="l100.87" class="difflineminus">-       obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs);</span>
<a href="#l100.88"></a><span id="l100.88" class="difflineminus">-       // Just good(tm) HTML. No reliance on CSS.</span>
<a href="#l100.89"></a><span id="l100.89" class="difflineplus">+  bool quoting =</span>
<a href="#l100.90"></a><span id="l100.90" class="difflineplus">+      (obj-&gt;options &amp;&amp;</span>
<a href="#l100.91"></a><span id="l100.91" class="difflineplus">+       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l100.92"></a><span id="l100.92" class="difflineplus">+        obj-&gt;options-&gt;format_out ==</span>
<a href="#l100.93"></a><span id="l100.93" class="difflineplus">+            nsMimeOutput::nsMimeMessageBodyQuoting));  // The output will be</span>
<a href="#l100.94"></a><span id="l100.94" class="difflineplus">+                                                       // inserted in the</span>
<a href="#l100.95"></a><span id="l100.95" class="difflineplus">+                                                       // composer as quotation</span>
<a href="#l100.96"></a><span id="l100.96" class="difflineplus">+  bool plainHTML =</span>
<a href="#l100.97"></a><span id="l100.97" class="difflineplus">+      quoting || (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;format_out ==</span>
<a href="#l100.98"></a><span id="l100.98" class="difflineplus">+                                      nsMimeOutput::nsMimeMessageSaveAs);</span>
<a href="#l100.99"></a><span id="l100.99" class="difflineplus">+  // Just good(tm) HTML. No reliance on CSS.</span>
<a href="#l100.100"></a><span id="l100.100"> </span>
<a href="#l100.101"></a><span id="l100.101">   // Setup the data structure that is connected to the actual document</span>
<a href="#l100.102"></a><span id="l100.102">   // Saved in a linked list in case this is called with several documents</span>
<a href="#l100.103"></a><span id="l100.103">   // at the same time.</span>
<a href="#l100.104"></a><span id="l100.104">   /* This memory is freed when parse_eof is called. So it better be! */</span>
<a href="#l100.105"></a><span id="l100.105">   struct MimeInlineTextPlainFlowedExData *exdata =</span>
<a href="#l100.106"></a><span id="l100.106" class="difflineminus">-    (MimeInlineTextPlainFlowedExData *)PR_MALLOC(sizeof(struct MimeInlineTextPlainFlowedExData));</span>
<a href="#l100.107"></a><span id="l100.107" class="difflineminus">-  if(!exdata) return MIME_OUT_OF_MEMORY;</span>
<a href="#l100.108"></a><span id="l100.108" class="difflineplus">+      (MimeInlineTextPlainFlowedExData *)PR_MALLOC(</span>
<a href="#l100.109"></a><span id="l100.109" class="difflineplus">+          sizeof(struct MimeInlineTextPlainFlowedExData));</span>
<a href="#l100.110"></a><span id="l100.110" class="difflineplus">+  if (!exdata) return MIME_OUT_OF_MEMORY;</span>
<a href="#l100.111"></a><span id="l100.111"> </span>
<a href="#l100.112"></a><span id="l100.112" class="difflineminus">-  MimeInlineTextPlainFlowed *text = (MimeInlineTextPlainFlowed *) obj;</span>
<a href="#l100.113"></a><span id="l100.113" class="difflineplus">+  MimeInlineTextPlainFlowed *text = (MimeInlineTextPlainFlowed *)obj;</span>
<a href="#l100.114"></a><span id="l100.114"> </span>
<a href="#l100.115"></a><span id="l100.115">   // Link it up.</span>
<a href="#l100.116"></a><span id="l100.116">   exdata-&gt;next = MimeInlineTextPlainFlowedExDataList;</span>
<a href="#l100.117"></a><span id="l100.117">   MimeInlineTextPlainFlowedExDataList = exdata;</span>
<a href="#l100.118"></a><span id="l100.118"> </span>
<a href="#l100.119"></a><span id="l100.119">   // Initialize data</span>
<a href="#l100.120"></a><span id="l100.120"> </span>
<a href="#l100.121"></a><span id="l100.121">   exdata-&gt;ownerobj = obj;</span>
<a href="#l100.122"></a><span id="l100.122">   exdata-&gt;inflow = false;</span>
<a href="#l100.123"></a><span id="l100.123">   exdata-&gt;quotelevel = 0;</span>
<a href="#l100.124"></a><span id="l100.124">   exdata-&gt;isSig = false;</span>
<a href="#l100.125"></a><span id="l100.125"> </span>
<a href="#l100.126"></a><span id="l100.126">   // check for DelSp=yes (RFC 3676)</span>
<a href="#l100.127"></a><span id="l100.127"> </span>
<a href="#l100.128"></a><span id="l100.128">   char *content_type_row =</span>
<a href="#l100.129"></a><span id="l100.129" class="difflineminus">-    (obj-&gt;headers</span>
<a href="#l100.130"></a><span id="l100.130" class="difflineminus">-     ? MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false)</span>
<a href="#l100.131"></a><span id="l100.131" class="difflineminus">-     : 0);</span>
<a href="#l100.132"></a><span id="l100.132" class="difflineplus">+      (obj-&gt;headers</span>
<a href="#l100.133"></a><span id="l100.133" class="difflineplus">+           ? MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false)</span>
<a href="#l100.134"></a><span id="l100.134" class="difflineplus">+           : 0);</span>
<a href="#l100.135"></a><span id="l100.135">   char *content_type_delsp =</span>
<a href="#l100.136"></a><span id="l100.136" class="difflineminus">-    (content_type_row</span>
<a href="#l100.137"></a><span id="l100.137" class="difflineminus">-     ? MimeHeaders_get_parameter(content_type_row, &quot;delsp&quot;, NULL,NULL)</span>
<a href="#l100.138"></a><span id="l100.138" class="difflineminus">-     : 0);</span>
<a href="#l100.139"></a><span id="l100.139" class="difflineminus">-  ((MimeInlineTextPlainFlowed *)obj)-&gt;delSp = content_type_delsp &amp;&amp; !PL_strcasecmp(content_type_delsp, &quot;yes&quot;);</span>
<a href="#l100.140"></a><span id="l100.140" class="difflineplus">+      (content_type_row</span>
<a href="#l100.141"></a><span id="l100.141" class="difflineplus">+           ? MimeHeaders_get_parameter(content_type_row, &quot;delsp&quot;, NULL, NULL)</span>
<a href="#l100.142"></a><span id="l100.142" class="difflineplus">+           : 0);</span>
<a href="#l100.143"></a><span id="l100.143" class="difflineplus">+  ((MimeInlineTextPlainFlowed *)obj)-&gt;delSp =</span>
<a href="#l100.144"></a><span id="l100.144" class="difflineplus">+      content_type_delsp &amp;&amp; !PL_strcasecmp(content_type_delsp, &quot;yes&quot;);</span>
<a href="#l100.145"></a><span id="l100.145">   PR_Free(content_type_delsp);</span>
<a href="#l100.146"></a><span id="l100.146">   PR_Free(content_type_row);</span>
<a href="#l100.147"></a><span id="l100.147"> </span>
<a href="#l100.148"></a><span id="l100.148">   // Get Prefs for viewing</span>
<a href="#l100.149"></a><span id="l100.149"> </span>
<a href="#l100.150"></a><span id="l100.150">   exdata-&gt;fixedwidthfont = false;</span>
<a href="#l100.151"></a><span id="l100.151">   //  Quotes</span>
<a href="#l100.152"></a><span id="l100.152" class="difflineminus">-  text-&gt;mQuotedSizeSetting = 0;   // mail.quoted_size</span>
<a href="#l100.153"></a><span id="l100.153" class="difflineminus">-  text-&gt;mQuotedStyleSetting = 0;  // mail.quoted_style</span>
<a href="#l100.154"></a><span id="l100.154" class="difflineplus">+  text-&gt;mQuotedSizeSetting = 0;     // mail.quoted_size</span>
<a href="#l100.155"></a><span id="l100.155" class="difflineplus">+  text-&gt;mQuotedStyleSetting = 0;    // mail.quoted_style</span>
<a href="#l100.156"></a><span id="l100.156">   text-&gt;mCitationColor.Truncate();  // mail.citation_color</span>
<a href="#l100.157"></a><span id="l100.157" class="difflineminus">-  text-&gt;mStripSig = true; // mail.strip_sig_on_reply</span>
<a href="#l100.158"></a><span id="l100.158" class="difflineplus">+  text-&gt;mStripSig = true;           // mail.strip_sig_on_reply</span>
<a href="#l100.159"></a><span id="l100.159"> </span>
<a href="#l100.160"></a><span id="l100.160">   nsIPrefBranch *prefBranch = GetPrefBranch(obj-&gt;options);</span>
<a href="#l100.161"></a><span id="l100.161" class="difflineminus">-  if (prefBranch)</span>
<a href="#l100.162"></a><span id="l100.162" class="difflineminus">-  {</span>
<a href="#l100.163"></a><span id="l100.163" class="difflineplus">+  if (prefBranch) {</span>
<a href="#l100.164"></a><span id="l100.164">     prefBranch-&gt;GetIntPref(&quot;mail.quoted_size&quot;, &amp;(text-&gt;mQuotedSizeSetting));</span>
<a href="#l100.165"></a><span id="l100.165">     prefBranch-&gt;GetIntPref(&quot;mail.quoted_style&quot;, &amp;(text-&gt;mQuotedStyleSetting));</span>
<a href="#l100.166"></a><span id="l100.166">     prefBranch-&gt;GetCharPref(&quot;mail.citation_color&quot;, text-&gt;mCitationColor);</span>
<a href="#l100.167"></a><span id="l100.167">     prefBranch-&gt;GetBoolPref(&quot;mail.strip_sig_on_reply&quot;, &amp;(text-&gt;mStripSig));</span>
<a href="#l100.168"></a><span id="l100.168" class="difflineminus">-    mozilla::DebugOnly&lt;nsresult&gt; rv =</span>
<a href="#l100.169"></a><span id="l100.169" class="difflineminus">-      prefBranch-&gt;GetBoolPref(&quot;mail.fixed_width_messages&quot;, &amp;(exdata-&gt;fixedwidthfont));</span>
<a href="#l100.170"></a><span id="l100.170" class="difflineplus">+    mozilla::DebugOnly&lt;nsresult&gt; rv = prefBranch-&gt;GetBoolPref(</span>
<a href="#l100.171"></a><span id="l100.171" class="difflineplus">+        &quot;mail.fixed_width_messages&quot;, &amp;(exdata-&gt;fixedwidthfont));</span>
<a href="#l100.172"></a><span id="l100.172">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to get pref&quot;);</span>
<a href="#l100.173"></a><span id="l100.173" class="difflineminus">-         // Check at least the success of one</span>
<a href="#l100.174"></a><span id="l100.174" class="difflineplus">+    // Check at least the success of one</span>
<a href="#l100.175"></a><span id="l100.175">   }</span>
<a href="#l100.176"></a><span id="l100.176"> </span>
<a href="#l100.177"></a><span id="l100.177">   // Get font</span>
<a href="#l100.178"></a><span id="l100.178">   // only used for viewing (!plainHTML)</span>
<a href="#l100.179"></a><span id="l100.179">   nsAutoCString fontstyle;</span>
<a href="#l100.180"></a><span id="l100.180" class="difflineminus">-  nsAutoCString fontLang;     // langgroup of the font</span>
<a href="#l100.181"></a><span id="l100.181" class="difflineminus">-</span>
<a href="#l100.182"></a><span id="l100.182" class="difflineplus">+  nsAutoCString fontLang;  // langgroup of the font</span>
<a href="#l100.183"></a><span id="l100.183"> </span>
<a href="#l100.184"></a><span id="l100.184">   // generic font-family name ( -moz-fixed for fixed font and NULL for</span>
<a href="#l100.185"></a><span id="l100.185">   // variable font ) is sufficient now that bug 105199 has been fixed.</span>
<a href="#l100.186"></a><span id="l100.186"> </span>
<a href="#l100.187"></a><span id="l100.187" class="difflineminus">-  if (exdata-&gt;fixedwidthfont)</span>
<a href="#l100.188"></a><span id="l100.188" class="difflineminus">-    fontstyle = &quot;font-family: -moz-fixed&quot;;</span>
<a href="#l100.189"></a><span id="l100.189" class="difflineplus">+  if (exdata-&gt;fixedwidthfont) fontstyle = &quot;font-family: -moz-fixed&quot;;</span>
<a href="#l100.190"></a><span id="l100.190"> </span>
<a href="#l100.191"></a><span id="l100.191">   if (nsMimeOutput::nsMimeMessageBodyDisplay == obj-&gt;options-&gt;format_out ||</span>
<a href="#l100.192"></a><span id="l100.192" class="difflineminus">-      nsMimeOutput::nsMimeMessagePrintOutput == obj-&gt;options-&gt;format_out)</span>
<a href="#l100.193"></a><span id="l100.193" class="difflineminus">-  {</span>
<a href="#l100.194"></a><span id="l100.194" class="difflineminus">-    int32_t fontSize;       // default font size</span>
<a href="#l100.195"></a><span id="l100.195" class="difflineminus">-    int32_t fontSizePercentage;   // size percentage</span>
<a href="#l100.196"></a><span id="l100.196" class="difflineminus">-    nsresult rv = GetMailNewsFont(obj, exdata-&gt;fixedwidthfont,</span>
<a href="#l100.197"></a><span id="l100.197" class="difflineminus">-                                  &amp;fontSize, &amp;fontSizePercentage, fontLang);</span>
<a href="#l100.198"></a><span id="l100.198" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l100.199"></a><span id="l100.199" class="difflineminus">-    {</span>
<a href="#l100.200"></a><span id="l100.200" class="difflineminus">-      if ( ! fontstyle.IsEmpty() ) {</span>
<a href="#l100.201"></a><span id="l100.201" class="difflineplus">+      nsMimeOutput::nsMimeMessagePrintOutput == obj-&gt;options-&gt;format_out) {</span>
<a href="#l100.202"></a><span id="l100.202" class="difflineplus">+    int32_t fontSize;            // default font size</span>
<a href="#l100.203"></a><span id="l100.203" class="difflineplus">+    int32_t fontSizePercentage;  // size percentage</span>
<a href="#l100.204"></a><span id="l100.204" class="difflineplus">+    nsresult rv = GetMailNewsFont(obj, exdata-&gt;fixedwidthfont, &amp;fontSize,</span>
<a href="#l100.205"></a><span id="l100.205" class="difflineplus">+                                  &amp;fontSizePercentage, fontLang);</span>
<a href="#l100.206"></a><span id="l100.206" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l100.207"></a><span id="l100.207" class="difflineplus">+      if (!fontstyle.IsEmpty()) {</span>
<a href="#l100.208"></a><span id="l100.208">         fontstyle += &quot;; &quot;;</span>
<a href="#l100.209"></a><span id="l100.209">       }</span>
<a href="#l100.210"></a><span id="l100.210">       fontstyle += &quot;font-size: &quot;;</span>
<a href="#l100.211"></a><span id="l100.211">       fontstyle.AppendInt(fontSize);</span>
<a href="#l100.212"></a><span id="l100.212">       fontstyle += &quot;px;&quot;;</span>
<a href="#l100.213"></a><span id="l100.213">     }</span>
<a href="#l100.214"></a><span id="l100.214">   }</span>
<a href="#l100.215"></a><span id="l100.215"> </span>
<a href="#l100.216"></a><span id="l100.216">   // Opening &lt;div&gt;.</span>
<a href="#l100.217"></a><span id="l100.217">   if (!quoting)</span>
<a href="#l100.218"></a><span id="l100.218" class="difflineminus">-       /* 4.x' editor can't break &lt;div&gt;s (e.g. to interleave comments).</span>
<a href="#l100.219"></a><span id="l100.219" class="difflineminus">-          We'll add the class to the &lt;blockquote type=cite&gt; later. */</span>
<a href="#l100.220"></a><span id="l100.220" class="difflineplus">+  /* 4.x' editor can't break &lt;div&gt;s (e.g. to interleave comments).</span>
<a href="#l100.221"></a><span id="l100.221" class="difflineplus">+     We'll add the class to the &lt;blockquote type=cite&gt; later. */</span>
<a href="#l100.222"></a><span id="l100.222">   {</span>
<a href="#l100.223"></a><span id="l100.223">     nsAutoCString openingDiv(&quot;&lt;div class=\&quot;moz-text-flowed\&quot;&quot;);</span>
<a href="#l100.224"></a><span id="l100.224">     // We currently have to add formatting here. :-(</span>
<a href="#l100.225"></a><span id="l100.225" class="difflineminus">-    if (!plainHTML &amp;&amp; !fontstyle.IsEmpty())</span>
<a href="#l100.226"></a><span id="l100.226" class="difflineminus">-    {</span>
<a href="#l100.227"></a><span id="l100.227" class="difflineplus">+    if (!plainHTML &amp;&amp; !fontstyle.IsEmpty()) {</span>
<a href="#l100.228"></a><span id="l100.228">       openingDiv += &quot; style=\&quot;&quot;;</span>
<a href="#l100.229"></a><span id="l100.229">       openingDiv += fontstyle;</span>
<a href="#l100.230"></a><span id="l100.230">       openingDiv += '&quot;';</span>
<a href="#l100.231"></a><span id="l100.231">     }</span>
<a href="#l100.232"></a><span id="l100.232" class="difflineminus">-    if (!plainHTML &amp;&amp; !fontLang.IsEmpty())</span>
<a href="#l100.233"></a><span id="l100.233" class="difflineminus">-    {</span>
<a href="#l100.234"></a><span id="l100.234" class="difflineplus">+    if (!plainHTML &amp;&amp; !fontLang.IsEmpty()) {</span>
<a href="#l100.235"></a><span id="l100.235">       openingDiv += &quot; lang=\&quot;&quot;;</span>
<a href="#l100.236"></a><span id="l100.236">       openingDiv += fontLang;</span>
<a href="#l100.237"></a><span id="l100.237">       openingDiv += '\&quot;';</span>
<a href="#l100.238"></a><span id="l100.238">     }</span>
<a href="#l100.239"></a><span id="l100.239">     openingDiv += &quot;&gt;&quot;;</span>
<a href="#l100.240"></a><span id="l100.240" class="difflineminus">-    status = MimeObject_write(obj, openingDiv.get(), openingDiv.Length(), false);</span>
<a href="#l100.241"></a><span id="l100.241" class="difflineplus">+    status =</span>
<a href="#l100.242"></a><span id="l100.242" class="difflineplus">+        MimeObject_write(obj, openingDiv.get(), openingDiv.Length(), false);</span>
<a href="#l100.243"></a><span id="l100.243">     if (status &lt; 0) return status;</span>
<a href="#l100.244"></a><span id="l100.244">   }</span>
<a href="#l100.245"></a><span id="l100.245"> </span>
<a href="#l100.246"></a><span id="l100.246">   return 0;</span>
<a href="#l100.247"></a><span id="l100.247"> }</span>
<a href="#l100.248"></a><span id="l100.248"> </span>
<a href="#l100.249"></a><span id="l100.249" class="difflineminus">-static int</span>
<a href="#l100.250"></a><span id="l100.250" class="difflineminus">-MimeInlineTextPlainFlowed_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l100.251"></a><span id="l100.251" class="difflineminus">-{</span>
<a href="#l100.252"></a><span id="l100.252" class="difflineplus">+static int MimeInlineTextPlainFlowed_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l100.253"></a><span id="l100.253">   int status = 0;</span>
<a href="#l100.254"></a><span id="l100.254">   struct MimeInlineTextPlainFlowedExData *exdata = nullptr;</span>
<a href="#l100.255"></a><span id="l100.255"> </span>
<a href="#l100.256"></a><span id="l100.256" class="difflineminus">-  bool quoting = ( obj-&gt;options</span>
<a href="#l100.257"></a><span id="l100.257" class="difflineminus">-    &amp;&amp; ( obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l100.258"></a><span id="l100.258" class="difflineminus">-         obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting</span>
<a href="#l100.259"></a><span id="l100.259" class="difflineminus">-       )           );  // see above</span>
<a href="#l100.260"></a><span id="l100.260" class="difflineplus">+  bool quoting =</span>
<a href="#l100.261"></a><span id="l100.261" class="difflineplus">+      (obj-&gt;options &amp;&amp;</span>
<a href="#l100.262"></a><span id="l100.262" class="difflineplus">+       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l100.263"></a><span id="l100.263" class="difflineplus">+        obj-&gt;options-&gt;format_out ==</span>
<a href="#l100.264"></a><span id="l100.264" class="difflineplus">+            nsMimeOutput::nsMimeMessageBodyQuoting));  // see above</span>
<a href="#l100.265"></a><span id="l100.265"> </span>
<a href="#l100.266"></a><span id="l100.266">   // Has this method already been called for this object?</span>
<a href="#l100.267"></a><span id="l100.267">   // In that case return.</span>
<a href="#l100.268"></a><span id="l100.268">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l100.269"></a><span id="l100.269"> </span>
<a href="#l100.270"></a><span id="l100.270">   /* Run parent method first, to flush out any buffered data. */</span>
<a href="#l100.271"></a><span id="l100.271" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l100.272"></a><span id="l100.272" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l100.273"></a><span id="l100.273">   if (status &lt; 0) goto EarlyOut;</span>
<a href="#l100.274"></a><span id="l100.274"> </span>
<a href="#l100.275"></a><span id="l100.275">   // Look up and unlink &quot;our&quot; extended data structure</span>
<a href="#l100.276"></a><span id="l100.276">   // We do it in the beginning so that if an error occur, we can</span>
<a href="#l100.277"></a><span id="l100.277">   // just free |exdata|.</span>
<a href="#l100.278"></a><span id="l100.278">   struct MimeInlineTextPlainFlowedExData **prevexdata;</span>
<a href="#l100.279"></a><span id="l100.279">   prevexdata = &amp;MimeInlineTextPlainFlowedExDataList;</span>
<a href="#l100.280"></a><span id="l100.280"> </span>
<a href="#l100.281"></a><span id="l100.281">   while ((exdata = *prevexdata) != nullptr) {</span>
<a href="#l100.282"></a><span id="l100.282">     if (exdata-&gt;ownerobj == obj) {</span>
<a href="#l100.283"></a><span id="l100.283">       // Fill hole</span>
<a href="#l100.284"></a><span id="l100.284">       *prevexdata = exdata-&gt;next;</span>
<a href="#l100.285"></a><span id="l100.285">       break;</span>
<a href="#l100.286"></a><span id="l100.286">     }</span>
<a href="#l100.287"></a><span id="l100.287">     prevexdata = &amp;exdata-&gt;next;</span>
<a href="#l100.288"></a><span id="l100.288">   }</span>
<a href="#l100.289"></a><span id="l100.289" class="difflineminus">-  NS_ASSERTION (exdata, &quot;The extra data has disappeared!&quot;);</span>
<a href="#l100.290"></a><span id="l100.290" class="difflineplus">+  NS_ASSERTION(exdata, &quot;The extra data has disappeared!&quot;);</span>
<a href="#l100.291"></a><span id="l100.291"> </span>
<a href="#l100.292"></a><span id="l100.292">   if (!obj-&gt;output_p) {</span>
<a href="#l100.293"></a><span id="l100.293">     status = 0;</span>
<a href="#l100.294"></a><span id="l100.294">     goto EarlyOut;</span>
<a href="#l100.295"></a><span id="l100.295">   }</span>
<a href="#l100.296"></a><span id="l100.296"> </span>
<a href="#l100.297"></a><span id="l100.297" class="difflineminus">-  for(; exdata-&gt;quotelevel &gt; 0; exdata-&gt;quotelevel--) {</span>
<a href="#l100.298"></a><span id="l100.298" class="difflineplus">+  for (; exdata-&gt;quotelevel &gt; 0; exdata-&gt;quotelevel--) {</span>
<a href="#l100.299"></a><span id="l100.299">     status = MimeObject_write(obj, &quot;&lt;/blockquote&gt;&quot;, 13, false);</span>
<a href="#l100.300"></a><span id="l100.300" class="difflineminus">-    if(status&lt;0) goto EarlyOut;</span>
<a href="#l100.301"></a><span id="l100.301" class="difflineplus">+    if (status &lt; 0) goto EarlyOut;</span>
<a href="#l100.302"></a><span id="l100.302">   }</span>
<a href="#l100.303"></a><span id="l100.303"> </span>
<a href="#l100.304"></a><span id="l100.304">   if (exdata-&gt;isSig &amp;&amp; !quoting) {</span>
<a href="#l100.305"></a><span id="l100.305" class="difflineminus">-    status = MimeObject_write(obj, &quot;&lt;/div&gt;&quot;, 6, false); // .moz-txt-sig</span>
<a href="#l100.306"></a><span id="l100.306" class="difflineminus">-    if (status&lt;0) goto EarlyOut;</span>
<a href="#l100.307"></a><span id="l100.307" class="difflineplus">+    status = MimeObject_write(obj, &quot;&lt;/div&gt;&quot;, 6, false);  // .moz-txt-sig</span>
<a href="#l100.308"></a><span id="l100.308" class="difflineplus">+    if (status &lt; 0) goto EarlyOut;</span>
<a href="#l100.309"></a><span id="l100.309">   }</span>
<a href="#l100.310"></a><span id="l100.310" class="difflineminus">-  if (!quoting) // HACK (see above)</span>
<a href="#l100.311"></a><span id="l100.311" class="difflineplus">+  if (!quoting)  // HACK (see above)</span>
<a href="#l100.312"></a><span id="l100.312">   {</span>
<a href="#l100.313"></a><span id="l100.313" class="difflineminus">-    status = MimeObject_write(obj, &quot;&lt;/div&gt;&quot;, 6, false); // .moz-text-flowed</span>
<a href="#l100.314"></a><span id="l100.314" class="difflineminus">-    if (status&lt;0) goto EarlyOut;</span>
<a href="#l100.315"></a><span id="l100.315" class="difflineplus">+    status = MimeObject_write(obj, &quot;&lt;/div&gt;&quot;, 6, false);  // .moz-text-flowed</span>
<a href="#l100.316"></a><span id="l100.316" class="difflineplus">+    if (status &lt; 0) goto EarlyOut;</span>
<a href="#l100.317"></a><span id="l100.317">   }</span>
<a href="#l100.318"></a><span id="l100.318"> </span>
<a href="#l100.319"></a><span id="l100.319">   status = 0;</span>
<a href="#l100.320"></a><span id="l100.320"> </span>
<a href="#l100.321"></a><span id="l100.321"> EarlyOut:</span>
<a href="#l100.322"></a><span id="l100.322">   PR_Free(exdata);</span>
<a href="#l100.323"></a><span id="l100.323"> </span>
<a href="#l100.324"></a><span id="l100.324">   // Clear mCitationColor</span>
<a href="#l100.325"></a><span id="l100.325" class="difflineminus">-  MimeInlineTextPlainFlowed *text = (MimeInlineTextPlainFlowed *) obj;</span>
<a href="#l100.326"></a><span id="l100.326" class="difflineplus">+  MimeInlineTextPlainFlowed *text = (MimeInlineTextPlainFlowed *)obj;</span>
<a href="#l100.327"></a><span id="l100.327">   text-&gt;mCitationColor.Truncate();</span>
<a href="#l100.328"></a><span id="l100.328"> </span>
<a href="#l100.329"></a><span id="l100.329">   return status;</span>
<a href="#l100.330"></a><span id="l100.330"> }</span>
<a href="#l100.331"></a><span id="l100.331"> </span>
<a href="#l100.332"></a><span id="l100.332" class="difflineminus">-</span>
<a href="#l100.333"></a><span id="l100.333" class="difflineminus">-static int</span>
<a href="#l100.334"></a><span id="l100.334" class="difflineminus">-MimeInlineTextPlainFlowed_parse_line (const char *aLine, int32_t length, MimeObject *obj)</span>
<a href="#l100.335"></a><span id="l100.335" class="difflineminus">-{</span>
<a href="#l100.336"></a><span id="l100.336" class="difflineplus">+static int MimeInlineTextPlainFlowed_parse_line(const char *aLine,</span>
<a href="#l100.337"></a><span id="l100.337" class="difflineplus">+                                                int32_t length,</span>
<a href="#l100.338"></a><span id="l100.338" class="difflineplus">+                                                MimeObject *obj) {</span>
<a href="#l100.339"></a><span id="l100.339">   int status;</span>
<a href="#l100.340"></a><span id="l100.340" class="difflineminus">-  bool quoting = ( obj-&gt;options</span>
<a href="#l100.341"></a><span id="l100.341" class="difflineminus">-    &amp;&amp; ( obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l100.342"></a><span id="l100.342" class="difflineminus">-         obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting</span>
<a href="#l100.343"></a><span id="l100.343" class="difflineminus">-       )           );  // see above</span>
<a href="#l100.344"></a><span id="l100.344" class="difflineminus">-  bool plainHTML = quoting || (obj-&gt;options &amp;&amp;</span>
<a href="#l100.345"></a><span id="l100.345" class="difflineminus">-       obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs);</span>
<a href="#l100.346"></a><span id="l100.346" class="difflineminus">-       // see above</span>
<a href="#l100.347"></a><span id="l100.347" class="difflineplus">+  bool quoting =</span>
<a href="#l100.348"></a><span id="l100.348" class="difflineplus">+      (obj-&gt;options &amp;&amp;</span>
<a href="#l100.349"></a><span id="l100.349" class="difflineplus">+       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l100.350"></a><span id="l100.350" class="difflineplus">+        obj-&gt;options-&gt;format_out ==</span>
<a href="#l100.351"></a><span id="l100.351" class="difflineplus">+            nsMimeOutput::nsMimeMessageBodyQuoting));  // see above</span>
<a href="#l100.352"></a><span id="l100.352" class="difflineplus">+  bool plainHTML =</span>
<a href="#l100.353"></a><span id="l100.353" class="difflineplus">+      quoting || (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;format_out ==</span>
<a href="#l100.354"></a><span id="l100.354" class="difflineplus">+                                      nsMimeOutput::nsMimeMessageSaveAs);</span>
<a href="#l100.355"></a><span id="l100.355" class="difflineplus">+  // see above</span>
<a href="#l100.356"></a><span id="l100.356"> </span>
<a href="#l100.357"></a><span id="l100.357">   struct MimeInlineTextPlainFlowedExData *exdata;</span>
<a href="#l100.358"></a><span id="l100.358">   exdata = MimeInlineTextPlainFlowedExDataList;</span>
<a href="#l100.359"></a><span id="l100.359" class="difflineminus">-  while(exdata &amp;&amp; (exdata-&gt;ownerobj != obj)) {</span>
<a href="#l100.360"></a><span id="l100.360" class="difflineplus">+  while (exdata &amp;&amp; (exdata-&gt;ownerobj != obj)) {</span>
<a href="#l100.361"></a><span id="l100.361">     exdata = exdata-&gt;next;</span>
<a href="#l100.362"></a><span id="l100.362">   }</span>
<a href="#l100.363"></a><span id="l100.363"> </span>
<a href="#l100.364"></a><span id="l100.364">   NS_ASSERTION(exdata, &quot;The extra data has disappeared!&quot;);</span>
<a href="#l100.365"></a><span id="l100.365"> </span>
<a href="#l100.366"></a><span id="l100.366">   NS_ASSERTION(length &gt; 0, &quot;zero length&quot;);</span>
<a href="#l100.367"></a><span id="l100.367">   if (length &lt;= 0) return 0;</span>
<a href="#l100.368"></a><span id="l100.368"> </span>
<a href="#l100.369"></a><span id="l100.369">   uint32_t linequotelevel = 0;</span>
<a href="#l100.370"></a><span id="l100.370">   nsAutoCString real_line(aLine, length);</span>
<a href="#l100.371"></a><span id="l100.371">   char *line = real_line.BeginWriting();</span>
<a href="#l100.372"></a><span id="l100.372">   const char *linep = real_line.BeginReading();</span>
<a href="#l100.373"></a><span id="l100.373">   // Space stuffed?</span>
<a href="#l100.374"></a><span id="l100.374" class="difflineminus">-  if(' ' == *linep) {</span>
<a href="#l100.375"></a><span id="l100.375" class="difflineplus">+  if (' ' == *linep) {</span>
<a href="#l100.376"></a><span id="l100.376">     linep++;</span>
<a href="#l100.377"></a><span id="l100.377">   } else {</span>
<a href="#l100.378"></a><span id="l100.378">     // count '&gt;':s before the first non-'&gt;'</span>
<a href="#l100.379"></a><span id="l100.379" class="difflineminus">-    while('&gt;' == *linep) {</span>
<a href="#l100.380"></a><span id="l100.380" class="difflineplus">+    while ('&gt;' == *linep) {</span>
<a href="#l100.381"></a><span id="l100.381">       linep++;</span>
<a href="#l100.382"></a><span id="l100.382">       linequotelevel++;</span>
<a href="#l100.383"></a><span id="l100.383">     }</span>
<a href="#l100.384"></a><span id="l100.384">     // Space stuffed?</span>
<a href="#l100.385"></a><span id="l100.385" class="difflineminus">-    if(' ' == *linep) {</span>
<a href="#l100.386"></a><span id="l100.386" class="difflineplus">+    if (' ' == *linep) {</span>
<a href="#l100.387"></a><span id="l100.387">       linep++;</span>
<a href="#l100.388"></a><span id="l100.388">     }</span>
<a href="#l100.389"></a><span id="l100.389">   }</span>
<a href="#l100.390"></a><span id="l100.390"> </span>
<a href="#l100.391"></a><span id="l100.391">   // Look if the last character (after stripping ending end</span>
<a href="#l100.392"></a><span id="l100.392">   // of lines and quoting stuff) is a SPACE. If it is, we are looking at a</span>
<a href="#l100.393"></a><span id="l100.393">   // flowed line. Normally we assume that the last two chars</span>
<a href="#l100.394"></a><span id="l100.394">   // are CR and LF as said in RFC822, but that doesn't seem to</span>
<a href="#l100.395"></a><span id="l100.395">   // be the case always.</span>
<a href="#l100.396"></a><span id="l100.396">   bool flowed = false;</span>
<a href="#l100.397"></a><span id="l100.397">   bool sigSeparator = false;</span>
<a href="#l100.398"></a><span id="l100.398" class="difflineminus">-  int32_t index = length-1;</span>
<a href="#l100.399"></a><span id="l100.399" class="difflineminus">-  while(index &gt;= 0 &amp;&amp; ('\r' == line[index] || '\n' == line[index])) {</span>
<a href="#l100.400"></a><span id="l100.400" class="difflineplus">+  int32_t index = length - 1;</span>
<a href="#l100.401"></a><span id="l100.401" class="difflineplus">+  while (index &gt;= 0 &amp;&amp; ('\r' == line[index] || '\n' == line[index])) {</span>
<a href="#l100.402"></a><span id="l100.402">     index--;</span>
<a href="#l100.403"></a><span id="l100.403">   }</span>
<a href="#l100.404"></a><span id="l100.404">   if (index &gt; linep - line &amp;&amp; ' ' == line[index])</span>
<a href="#l100.405"></a><span id="l100.405" class="difflineminus">-       /* Ignore space stuffing, i.e. lines with just</span>
<a href="#l100.406"></a><span id="l100.406" class="difflineminus">-          (quote marks and) a space count as empty */</span>
<a href="#l100.407"></a><span id="l100.407" class="difflineplus">+  /* Ignore space stuffing, i.e. lines with just</span>
<a href="#l100.408"></a><span id="l100.408" class="difflineplus">+     (quote marks and) a space count as empty */</span>
<a href="#l100.409"></a><span id="l100.409">   {</span>
<a href="#l100.410"></a><span id="l100.410">     flowed = true;</span>
<a href="#l100.411"></a><span id="l100.411" class="difflineminus">-    sigSeparator = (index - (linep - line) + 1 == 3) &amp;&amp; !strncmp(linep, &quot;-- &quot;, 3);</span>
<a href="#l100.412"></a><span id="l100.412" class="difflineminus">-    if (((MimeInlineTextPlainFlowed *) obj)-&gt;delSp &amp;&amp; !sigSeparator)</span>
<a href="#l100.413"></a><span id="l100.413" class="difflineminus">-       /* If line is flowed and DelSp=yes, logically</span>
<a href="#l100.414"></a><span id="l100.414" class="difflineminus">-          delete trailing space. Line consisting of</span>
<a href="#l100.415"></a><span id="l100.415" class="difflineminus">-          dash dash space (&quot;-- &quot;), commonly used as</span>
<a href="#l100.416"></a><span id="l100.416" class="difflineminus">-          signature separator, gets special handling</span>
<a href="#l100.417"></a><span id="l100.417" class="difflineminus">-          (RFC 3676) */</span>
<a href="#l100.418"></a><span id="l100.418" class="difflineplus">+    sigSeparator =</span>
<a href="#l100.419"></a><span id="l100.419" class="difflineplus">+        (index - (linep - line) + 1 == 3) &amp;&amp; !strncmp(linep, &quot;-- &quot;, 3);</span>
<a href="#l100.420"></a><span id="l100.420" class="difflineplus">+    if (((MimeInlineTextPlainFlowed *)obj)-&gt;delSp &amp;&amp; !sigSeparator)</span>
<a href="#l100.421"></a><span id="l100.421" class="difflineplus">+    /* If line is flowed and DelSp=yes, logically</span>
<a href="#l100.422"></a><span id="l100.422" class="difflineplus">+       delete trailing space. Line consisting of</span>
<a href="#l100.423"></a><span id="l100.423" class="difflineplus">+       dash dash space (&quot;-- &quot;), commonly used as</span>
<a href="#l100.424"></a><span id="l100.424" class="difflineplus">+       signature separator, gets special handling</span>
<a href="#l100.425"></a><span id="l100.425" class="difflineplus">+       (RFC 3676) */</span>
<a href="#l100.426"></a><span id="l100.426">     {</span>
<a href="#l100.427"></a><span id="l100.427">       length = index;</span>
<a href="#l100.428"></a><span id="l100.428">       line[index] = '\0';</span>
<a href="#l100.429"></a><span id="l100.429">     }</span>
<a href="#l100.430"></a><span id="l100.430">   }</span>
<a href="#l100.431"></a><span id="l100.431"> </span>
<a href="#l100.432"></a><span id="l100.432" class="difflineminus">-  if (obj-&gt;options &amp;&amp;</span>
<a href="#l100.433"></a><span id="l100.433" class="difflineminus">-      obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l100.434"></a><span id="l100.434" class="difflineminus">-      obj-&gt;options-&gt;decompose_file_output_fn)</span>
<a href="#l100.435"></a><span id="l100.435" class="difflineminus">-  {</span>
<a href="#l100.436"></a><span id="l100.436" class="difflineminus">-    return obj-&gt;options-&gt;decompose_file_output_fn(line,</span>
<a href="#l100.437"></a><span id="l100.437" class="difflineminus">-                                                  length,</span>
<a href="#l100.438"></a><span id="l100.438" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;decompose_file_p &amp;&amp;</span>
<a href="#l100.439"></a><span id="l100.439" class="difflineplus">+      obj-&gt;options-&gt;decompose_file_output_fn) {</span>
<a href="#l100.440"></a><span id="l100.440" class="difflineplus">+    return obj-&gt;options-&gt;decompose_file_output_fn(line, length,</span>
<a href="#l100.441"></a><span id="l100.441">                                                   obj-&gt;options-&gt;stream_closure);</span>
<a href="#l100.442"></a><span id="l100.442">   }</span>
<a href="#l100.443"></a><span id="l100.443"> </span>
<a href="#l100.444"></a><span id="l100.444">   mozITXTToHTMLConv *conv = GetTextConverter(obj-&gt;options);</span>
<a href="#l100.445"></a><span id="l100.445"> </span>
<a href="#l100.446"></a><span id="l100.446" class="difflineminus">-  bool skipConversion = !conv ||</span>
<a href="#l100.447"></a><span id="l100.447" class="difflineminus">-                          (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;force_user_charset);</span>
<a href="#l100.448"></a><span id="l100.448" class="difflineplus">+  bool skipConversion =</span>
<a href="#l100.449"></a><span id="l100.449" class="difflineplus">+      !conv || (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;force_user_charset);</span>
<a href="#l100.450"></a><span id="l100.450"> </span>
<a href="#l100.451"></a><span id="l100.451">   nsAutoString lineSource;</span>
<a href="#l100.452"></a><span id="l100.452">   nsString lineResult;</span>
<a href="#l100.453"></a><span id="l100.453"> </span>
<a href="#l100.454"></a><span id="l100.454">   char *mailCharset = NULL;</span>
<a href="#l100.455"></a><span id="l100.455">   nsresult rv;</span>
<a href="#l100.456"></a><span id="l100.456"> </span>
<a href="#l100.457"></a><span id="l100.457" class="difflineminus">-  if (!skipConversion)</span>
<a href="#l100.458"></a><span id="l100.458" class="difflineminus">-  {</span>
<a href="#l100.459"></a><span id="l100.459" class="difflineplus">+  if (!skipConversion) {</span>
<a href="#l100.460"></a><span id="l100.460">     // Convert only if the source string is not empty</span>
<a href="#l100.461"></a><span id="l100.461" class="difflineminus">-    if (length - (linep - line) &gt; 0)</span>
<a href="#l100.462"></a><span id="l100.462" class="difflineminus">-    {</span>
<a href="#l100.463"></a><span id="l100.463" class="difflineplus">+    if (length - (linep - line) &gt; 0) {</span>
<a href="#l100.464"></a><span id="l100.464">       uint32_t whattodo = obj-&gt;options-&gt;whattodo;</span>
<a href="#l100.465"></a><span id="l100.465" class="difflineminus">-      if (plainHTML)</span>
<a href="#l100.466"></a><span id="l100.466" class="difflineminus">-      {</span>
<a href="#l100.467"></a><span id="l100.467" class="difflineplus">+      if (plainHTML) {</span>
<a href="#l100.468"></a><span id="l100.468">         if (quoting)</span>
<a href="#l100.469"></a><span id="l100.469">           whattodo = 0;</span>
<a href="#l100.470"></a><span id="l100.470">         else</span>
<a href="#l100.471"></a><span id="l100.471">           whattodo = whattodo &amp; ~mozITXTToHTMLConv::kGlyphSubstitution;</span>
<a href="#l100.472"></a><span id="l100.472" class="difflineminus">-                    /* Do recognition for the case, the result is viewed in</span>
<a href="#l100.473"></a><span id="l100.473" class="difflineminus">-                        Mozilla, but not GlyphSubstitution, because other UAs</span>
<a href="#l100.474"></a><span id="l100.474" class="difflineminus">-                        might not be able to display the glyphs. */</span>
<a href="#l100.475"></a><span id="l100.475" class="difflineplus">+        /* Do recognition for the case, the result is viewed in</span>
<a href="#l100.476"></a><span id="l100.476" class="difflineplus">+            Mozilla, but not GlyphSubstitution, because other UAs</span>
<a href="#l100.477"></a><span id="l100.477" class="difflineplus">+            might not be able to display the glyphs. */</span>
<a href="#l100.478"></a><span id="l100.478">       }</span>
<a href="#l100.479"></a><span id="l100.479"> </span>
<a href="#l100.480"></a><span id="l100.480" class="difflineminus">-      const nsDependentCSubstring&amp; inputStr = Substring(linep, linep + (length - (linep - line)));</span>
<a href="#l100.481"></a><span id="l100.481" class="difflineplus">+      const nsDependentCSubstring &amp;inputStr =</span>
<a href="#l100.482"></a><span id="l100.482" class="difflineplus">+          Substring(linep, linep + (length - (linep - line)));</span>
<a href="#l100.483"></a><span id="l100.483"> </span>
<a href="#l100.484"></a><span id="l100.484">       // For 'SaveAs', |line| is in |mailCharset|.</span>
<a href="#l100.485"></a><span id="l100.485">       // convert |line| to UTF-16 before 'html'izing (calling ScanTXT())</span>
<a href="#l100.486"></a><span id="l100.486" class="difflineminus">-      if (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs)</span>
<a href="#l100.487"></a><span id="l100.487" class="difflineminus">-      {</span>
<a href="#l100.488"></a><span id="l100.488" class="difflineplus">+      if (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs) {</span>
<a href="#l100.489"></a><span id="l100.489">         // Get the mail charset of this message.</span>
<a href="#l100.490"></a><span id="l100.490" class="difflineminus">-        MimeInlineText  *inlinetext = (MimeInlineText *) obj;</span>
<a href="#l100.491"></a><span id="l100.491" class="difflineplus">+        MimeInlineText *inlinetext = (MimeInlineText *)obj;</span>
<a href="#l100.492"></a><span id="l100.492">         if (!inlinetext-&gt;initializeCharset)</span>
<a href="#l100.493"></a><span id="l100.493" class="difflineminus">-          ((MimeInlineTextClass*)&amp;mimeInlineTextClass)-&gt;initialize_charset(obj);</span>
<a href="#l100.494"></a><span id="l100.494" class="difflineplus">+          ((MimeInlineTextClass *)&amp;mimeInlineTextClass)</span>
<a href="#l100.495"></a><span id="l100.495" class="difflineplus">+              -&gt;initialize_charset(obj);</span>
<a href="#l100.496"></a><span id="l100.496">         mailCharset = inlinetext-&gt;charset;</span>
<a href="#l100.497"></a><span id="l100.497">         if (mailCharset &amp;&amp; *mailCharset) {</span>
<a href="#l100.498"></a><span id="l100.498">           rv = nsMsgI18NConvertToUnicode(nsDependentCString(mailCharset),</span>
<a href="#l100.499"></a><span id="l100.499">                                          PromiseFlatCString(inputStr),</span>
<a href="#l100.500"></a><span id="l100.500">                                          lineSource);</span>
<a href="#l100.501"></a><span id="l100.501">           NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l100.502"></a><span id="l100.502" class="difflineminus">-        }</span>
<a href="#l100.503"></a><span id="l100.503" class="difflineminus">-        else // this probably never happens...</span>
<a href="#l100.504"></a><span id="l100.504" class="difflineplus">+        } else  // this probably never happens...</span>
<a href="#l100.505"></a><span id="l100.505">           CopyUTF8toUTF16(inputStr, lineSource);</span>
<a href="#l100.506"></a><span id="l100.506" class="difflineminus">-      }</span>
<a href="#l100.507"></a><span id="l100.507" class="difflineminus">-      else   // line is in UTF-8</span>
<a href="#l100.508"></a><span id="l100.508" class="difflineplus">+      } else  // line is in UTF-8</span>
<a href="#l100.509"></a><span id="l100.509">         CopyUTF8toUTF16(inputStr, lineSource);</span>
<a href="#l100.510"></a><span id="l100.510"> </span>
<a href="#l100.511"></a><span id="l100.511">       // This is the main TXT to HTML conversion:</span>
<a href="#l100.512"></a><span id="l100.512">       // escaping (very important), eventually recognizing etc.</span>
<a href="#l100.513"></a><span id="l100.513">       rv = conv-&gt;ScanTXT(lineSource, whattodo, lineResult);</span>
<a href="#l100.514"></a><span id="l100.514">       NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l100.515"></a><span id="l100.515">     }</span>
<a href="#l100.516"></a><span id="l100.516" class="difflineminus">-  }</span>
<a href="#l100.517"></a><span id="l100.517" class="difflineminus">-  else</span>
<a href="#l100.518"></a><span id="l100.518" class="difflineminus">-  {</span>
<a href="#l100.519"></a><span id="l100.519" class="difflineplus">+  } else {</span>
<a href="#l100.520"></a><span id="l100.520">     CopyUTF8toUTF16(nsDependentCString(line, length), lineResult);</span>
<a href="#l100.521"></a><span id="l100.521">     status = 0;</span>
<a href="#l100.522"></a><span id="l100.522">   }</span>
<a href="#l100.523"></a><span id="l100.523"> </span>
<a href="#l100.524"></a><span id="l100.524">   nsAutoCString preface;</span>
<a href="#l100.525"></a><span id="l100.525"> </span>
<a href="#l100.526"></a><span id="l100.526">   /* Correct number of blockquotes */</span>
<a href="#l100.527"></a><span id="l100.527" class="difflineminus">-  int32_t quoteleveldiff=linequotelevel - exdata-&gt;quotelevel;</span>
<a href="#l100.528"></a><span id="l100.528" class="difflineminus">-  if((quoteleveldiff != 0) &amp;&amp; flowed &amp;&amp; exdata-&gt;inflow) {</span>
<a href="#l100.529"></a><span id="l100.529" class="difflineplus">+  int32_t quoteleveldiff = linequotelevel - exdata-&gt;quotelevel;</span>
<a href="#l100.530"></a><span id="l100.530" class="difflineplus">+  if ((quoteleveldiff != 0) &amp;&amp; flowed &amp;&amp; exdata-&gt;inflow) {</span>
<a href="#l100.531"></a><span id="l100.531">     // From RFC 2646 4.5</span>
<a href="#l100.532"></a><span id="l100.532" class="difflineminus">-    // The receiver SHOULD handle this error by using the 'quote-depth-wins' rule,</span>
<a href="#l100.533"></a><span id="l100.533" class="difflineminus">-    // which is to ignore the flowed indicator and treat the line as fixed.  That</span>
<a href="#l100.534"></a><span id="l100.534" class="difflineminus">-    // is, the change in quote depth ends the paragraph.</span>
<a href="#l100.535"></a><span id="l100.535" class="difflineplus">+    // The receiver SHOULD handle this error by using the 'quote-depth-wins'</span>
<a href="#l100.536"></a><span id="l100.536" class="difflineplus">+    // rule, which is to ignore the flowed indicator and treat the line as</span>
<a href="#l100.537"></a><span id="l100.537" class="difflineplus">+    // fixed.  That is, the change in quote depth ends the paragraph.</span>
<a href="#l100.538"></a><span id="l100.538"> </span>
<a href="#l100.539"></a><span id="l100.539">     // We get that behaviour by just going on.</span>
<a href="#l100.540"></a><span id="l100.540">   }</span>
<a href="#l100.541"></a><span id="l100.541"> </span>
<a href="#l100.542"></a><span id="l100.542">   // Cast so we have access to the prefs we need.</span>
<a href="#l100.543"></a><span id="l100.543" class="difflineminus">-  MimeInlineTextPlainFlowed *tObj = (MimeInlineTextPlainFlowed *) obj;</span>
<a href="#l100.544"></a><span id="l100.544" class="difflineminus">-  while(quoteleveldiff&gt;0) {</span>
<a href="#l100.545"></a><span id="l100.545" class="difflineplus">+  MimeInlineTextPlainFlowed *tObj = (MimeInlineTextPlainFlowed *)obj;</span>
<a href="#l100.546"></a><span id="l100.546" class="difflineplus">+  while (quoteleveldiff &gt; 0) {</span>
<a href="#l100.547"></a><span id="l100.547">     quoteleveldiff--;</span>
<a href="#l100.548"></a><span id="l100.548">     preface += &quot;&lt;blockquote type=cite&quot;;</span>
<a href="#l100.549"></a><span id="l100.549"> </span>
<a href="#l100.550"></a><span id="l100.550">     nsAutoCString style;</span>
<a href="#l100.551"></a><span id="l100.551">     MimeTextBuildPrefixCSS(tObj-&gt;mQuotedSizeSetting, tObj-&gt;mQuotedStyleSetting,</span>
<a href="#l100.552"></a><span id="l100.552">                            tObj-&gt;mCitationColor, style);</span>
<a href="#l100.553"></a><span id="l100.553" class="difflineminus">-    if (!plainHTML &amp;&amp; !style.IsEmpty())</span>
<a href="#l100.554"></a><span id="l100.554" class="difflineminus">-    {</span>
<a href="#l100.555"></a><span id="l100.555" class="difflineplus">+    if (!plainHTML &amp;&amp; !style.IsEmpty()) {</span>
<a href="#l100.556"></a><span id="l100.556">       preface += &quot; style=\&quot;&quot;;</span>
<a href="#l100.557"></a><span id="l100.557">       preface += style;</span>
<a href="#l100.558"></a><span id="l100.558">       preface += '&quot;';</span>
<a href="#l100.559"></a><span id="l100.559">     }</span>
<a href="#l100.560"></a><span id="l100.560">     preface += '&gt;';</span>
<a href="#l100.561"></a><span id="l100.561">   }</span>
<a href="#l100.562"></a><span id="l100.562" class="difflineminus">-  while(quoteleveldiff&lt;0) {</span>
<a href="#l100.563"></a><span id="l100.563" class="difflineplus">+  while (quoteleveldiff &lt; 0) {</span>
<a href="#l100.564"></a><span id="l100.564">     quoteleveldiff++;</span>
<a href="#l100.565"></a><span id="l100.565">     preface += &quot;&lt;/blockquote&gt;&quot;;</span>
<a href="#l100.566"></a><span id="l100.566">   }</span>
<a href="#l100.567"></a><span id="l100.567">   exdata-&gt;quotelevel = linequotelevel;</span>
<a href="#l100.568"></a><span id="l100.568"> </span>
<a href="#l100.569"></a><span id="l100.569">   nsAutoString lineResult2;</span>
<a href="#l100.570"></a><span id="l100.570"> </span>
<a href="#l100.571"></a><span id="l100.571" class="difflineminus">-  if(flowed) {</span>
<a href="#l100.572"></a><span id="l100.572" class="difflineplus">+  if (flowed) {</span>
<a href="#l100.573"></a><span id="l100.573">     // Check RFC 2646 &quot;4.3. Usenet Signature Convention&quot;: &quot;-- &quot;+CRLF is</span>
<a href="#l100.574"></a><span id="l100.574">     // not a flowed line</span>
<a href="#l100.575"></a><span id="l100.575" class="difflineminus">-    if (sigSeparator)</span>
<a href="#l100.576"></a><span id="l100.576" class="difflineminus">-    {</span>
<a href="#l100.577"></a><span id="l100.577" class="difflineminus">-      if (linequotelevel &gt; 0 || exdata-&gt;isSig)</span>
<a href="#l100.578"></a><span id="l100.578" class="difflineminus">-      {</span>
<a href="#l100.579"></a><span id="l100.579" class="difflineplus">+    if (sigSeparator) {</span>
<a href="#l100.580"></a><span id="l100.580" class="difflineplus">+      if (linequotelevel &gt; 0 || exdata-&gt;isSig) {</span>
<a href="#l100.581"></a><span id="l100.581">         preface += &quot;--&amp;nbsp;&lt;br&gt;&quot;;</span>
<a href="#l100.582"></a><span id="l100.582">       } else {</span>
<a href="#l100.583"></a><span id="l100.583">         exdata-&gt;isSig = true;</span>
<a href="#l100.584"></a><span id="l100.584" class="difflineminus">-        preface += &quot;&lt;div class=\&quot;moz-txt-sig\&quot;&gt;&lt;span class=\&quot;moz-txt-tag\&quot;&gt;&quot;</span>
<a href="#l100.585"></a><span id="l100.585" class="difflineminus">-                   &quot;--&amp;nbsp;&lt;br&gt;&lt;/span&gt;&quot;;</span>
<a href="#l100.586"></a><span id="l100.586" class="difflineplus">+        preface +=</span>
<a href="#l100.587"></a><span id="l100.587" class="difflineplus">+            &quot;&lt;div class=\&quot;moz-txt-sig\&quot;&gt;&lt;span class=\&quot;moz-txt-tag\&quot;&gt;&quot;</span>
<a href="#l100.588"></a><span id="l100.588" class="difflineplus">+            &quot;--&amp;nbsp;&lt;br&gt;&lt;/span&gt;&quot;;</span>
<a href="#l100.589"></a><span id="l100.589">       }</span>
<a href="#l100.590"></a><span id="l100.590">     } else {</span>
<a href="#l100.591"></a><span id="l100.591" class="difflineminus">-      Line_convert_whitespace(lineResult, false /* Allow wraps */,</span>
<a href="#l100.592"></a><span id="l100.592" class="difflineminus">-                              lineResult2);</span>
<a href="#l100.593"></a><span id="l100.593" class="difflineplus">+      Line_convert_whitespace(lineResult, false /* Allow wraps */, lineResult2);</span>
<a href="#l100.594"></a><span id="l100.594">     }</span>
<a href="#l100.595"></a><span id="l100.595"> </span>
<a href="#l100.596"></a><span id="l100.596" class="difflineminus">-    exdata-&gt;inflow=true;</span>
<a href="#l100.597"></a><span id="l100.597" class="difflineplus">+    exdata-&gt;inflow = true;</span>
<a href="#l100.598"></a><span id="l100.598">   } else {</span>
<a href="#l100.599"></a><span id="l100.599">     // Fixed paragraph.</span>
<a href="#l100.600"></a><span id="l100.600">     Line_convert_whitespace(lineResult,</span>
<a href="#l100.601"></a><span id="l100.601">                             !plainHTML &amp;&amp; !obj-&gt;options-&gt;wrap_long_lines_p</span>
<a href="#l100.602"></a><span id="l100.602" class="difflineminus">-                              /* If wrap, convert all spaces but the last in</span>
<a href="#l100.603"></a><span id="l100.603" class="difflineminus">-                                 a row into nbsp, otherwise all. */,</span>
<a href="#l100.604"></a><span id="l100.604" class="difflineplus">+                            /* If wrap, convert all spaces but the last in</span>
<a href="#l100.605"></a><span id="l100.605" class="difflineplus">+                               a row into nbsp, otherwise all. */</span>
<a href="#l100.606"></a><span id="l100.606" class="difflineplus">+                            ,</span>
<a href="#l100.607"></a><span id="l100.607">                             lineResult2);</span>
<a href="#l100.608"></a><span id="l100.608">     lineResult2.AppendLiteral(&quot;&lt;br&gt;&quot;);</span>
<a href="#l100.609"></a><span id="l100.609">     exdata-&gt;inflow = false;</span>
<a href="#l100.610"></a><span id="l100.610" class="difflineminus">-  } // End Fixed line</span>
<a href="#l100.611"></a><span id="l100.611" class="difflineplus">+  }  // End Fixed line</span>
<a href="#l100.612"></a><span id="l100.612"> </span>
<a href="#l100.613"></a><span id="l100.613" class="difflineminus">-  if (!(exdata-&gt;isSig &amp;&amp; quoting &amp;&amp; tObj-&gt;mStripSig))</span>
<a href="#l100.614"></a><span id="l100.614" class="difflineminus">-  {</span>
<a href="#l100.615"></a><span id="l100.615" class="difflineplus">+  if (!(exdata-&gt;isSig &amp;&amp; quoting &amp;&amp; tObj-&gt;mStripSig)) {</span>
<a href="#l100.616"></a><span id="l100.616">     status = MimeObject_write(obj, preface.get(), preface.Length(), true);</span>
<a href="#l100.617"></a><span id="l100.617">     if (status &lt; 0) return status;</span>
<a href="#l100.618"></a><span id="l100.618">     nsAutoCString outString;</span>
<a href="#l100.619"></a><span id="l100.619">     if (obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageSaveAs ||</span>
<a href="#l100.620"></a><span id="l100.620">         !mailCharset || !*mailCharset)</span>
<a href="#l100.621"></a><span id="l100.621">       CopyUTF16toUTF8(lineResult2, outString);</span>
<a href="#l100.622"></a><span id="l100.622" class="difflineminus">-    else</span>
<a href="#l100.623"></a><span id="l100.623" class="difflineminus">-    { // convert back to mailCharset before writing.</span>
<a href="#l100.624"></a><span id="l100.624" class="difflineplus">+    else {  // convert back to mailCharset before writing.</span>
<a href="#l100.625"></a><span id="l100.625">       rv = nsMsgI18NConvertFromUnicode(nsDependentCString(mailCharset),</span>
<a href="#l100.626"></a><span id="l100.626" class="difflineminus">-                                       lineResult2,</span>
<a href="#l100.627"></a><span id="l100.627" class="difflineminus">-                                       outString);</span>
<a href="#l100.628"></a><span id="l100.628" class="difflineplus">+                                       lineResult2, outString);</span>
<a href="#l100.629"></a><span id="l100.629">       NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l100.630"></a><span id="l100.630">     }</span>
<a href="#l100.631"></a><span id="l100.631">     status = MimeObject_write(obj, outString.get(), outString.Length(), true);</span>
<a href="#l100.632"></a><span id="l100.632">     return status;</span>
<a href="#l100.633"></a><span id="l100.633">   }</span>
<a href="#l100.634"></a><span id="l100.634">   return 0;</span>
<a href="#l100.635"></a><span id="l100.635"> }</span>
<a href="#l100.636"></a><span id="l100.636"> </span>
<a href="#l100.637"></a><span id="l100.637" class="difflineminus">-</span>
<a href="#l100.638"></a><span id="l100.638"> /**</span>
<a href="#l100.639"></a><span id="l100.639">  * Maintains a small state machine with three states. &quot;Not in tag&quot;,</span>
<a href="#l100.640"></a><span id="l100.640">  * &quot;In tag, but not in quote&quot; and &quot;In quote inside a tag&quot;. It also</span>
<a href="#l100.641"></a><span id="l100.641">  * remembers what character started the quote (&quot; or '). The state</span>
<a href="#l100.642"></a><span id="l100.642">  * variables are kept outside this function and are included as</span>
<a href="#l100.643"></a><span id="l100.643">  * parameters.</span>
<a href="#l100.644"></a><span id="l100.644">  *</span>
<a href="#l100.645"></a><span id="l100.645">  * @param in/out a_in_tag, if we are in a tag right now.</span>
<a href="#l100.646"></a><span id="l100.646">  * @param in/out a_in_quote_in_tag, if we are in a quote inside a tag.</span>
<a href="#l100.647"></a><span id="l100.647">  * @param in/out a_quote_char, the kind of quote (&quot; or ').</span>
<a href="#l100.648"></a><span id="l100.648">  * @param in a_current_char, the next char. It decides which state</span>
<a href="#l100.649"></a><span id="l100.649">  *                           will be next.</span>
<a href="#l100.650"></a><span id="l100.650">  */</span>
<a href="#l100.651"></a><span id="l100.651" class="difflineminus">-static void Update_in_tag_info(bool *a_in_tag, /* IN/OUT */</span>
<a href="#l100.652"></a><span id="l100.652" class="difflineminus">-                   bool *a_in_quote_in_tag, /* IN/OUT */</span>
<a href="#l100.653"></a><span id="l100.653" class="difflineminus">-                   char16_t *a_quote_char, /* IN/OUT (pointer to single char) */</span>
<a href="#l100.654"></a><span id="l100.654" class="difflineminus">-                   char16_t a_current_char) /* IN */</span>
<a href="#l100.655"></a><span id="l100.655" class="difflineplus">+static void Update_in_tag_info(</span>
<a href="#l100.656"></a><span id="l100.656" class="difflineplus">+    bool *a_in_tag,          /* IN/OUT */</span>
<a href="#l100.657"></a><span id="l100.657" class="difflineplus">+    bool *a_in_quote_in_tag, /* IN/OUT */</span>
<a href="#l100.658"></a><span id="l100.658" class="difflineplus">+    char16_t *a_quote_char,  /* IN/OUT (pointer to single char) */</span>
<a href="#l100.659"></a><span id="l100.659" class="difflineplus">+    char16_t a_current_char) /* IN */</span>
<a href="#l100.660"></a><span id="l100.660"> {</span>
<a href="#l100.661"></a><span id="l100.661" class="difflineminus">-  if(*a_in_tag) {</span>
<a href="#l100.662"></a><span id="l100.662" class="difflineplus">+  if (*a_in_tag) {</span>
<a href="#l100.663"></a><span id="l100.663">     // Keep us informed of what's quoted so that we</span>
<a href="#l100.664"></a><span id="l100.664">     // don't end the tag too soon. For instance in</span>
<a href="#l100.665"></a><span id="l100.665">     // &lt;font face=&quot;weird&gt;font&lt;name&quot;&gt;</span>
<a href="#l100.666"></a><span id="l100.666" class="difflineminus">-    if(*a_in_quote_in_tag) {</span>
<a href="#l100.667"></a><span id="l100.667" class="difflineplus">+    if (*a_in_quote_in_tag) {</span>
<a href="#l100.668"></a><span id="l100.668">       // We are in a quote. A quote is ended by the same</span>
<a href="#l100.669"></a><span id="l100.669">       // character that started it ('...' or &quot;...&quot;)</span>
<a href="#l100.670"></a><span id="l100.670" class="difflineminus">-      if(*a_quote_char == a_current_char) {</span>
<a href="#l100.671"></a><span id="l100.671" class="difflineplus">+      if (*a_quote_char == a_current_char) {</span>
<a href="#l100.672"></a><span id="l100.672">         *a_in_quote_in_tag = false;</span>
<a href="#l100.673"></a><span id="l100.673">       }</span>
<a href="#l100.674"></a><span id="l100.674">     } else {</span>
<a href="#l100.675"></a><span id="l100.675">       // We are not currently in a quote, but we may enter</span>
<a href="#l100.676"></a><span id="l100.676">       // one right this minute.</span>
<a href="#l100.677"></a><span id="l100.677" class="difflineminus">-      switch(a_current_char) {</span>
<a href="#l100.678"></a><span id="l100.678" class="difflineminus">-      case '&quot;':</span>
<a href="#l100.679"></a><span id="l100.679" class="difflineminus">-      case '\'':</span>
<a href="#l100.680"></a><span id="l100.680" class="difflineminus">-        *a_in_quote_in_tag = true;</span>
<a href="#l100.681"></a><span id="l100.681" class="difflineminus">-        *a_quote_char = a_current_char;</span>
<a href="#l100.682"></a><span id="l100.682" class="difflineminus">-        break;</span>
<a href="#l100.683"></a><span id="l100.683" class="difflineminus">-      case '&gt;':</span>
<a href="#l100.684"></a><span id="l100.684" class="difflineminus">-        // Tag is ended</span>
<a href="#l100.685"></a><span id="l100.685" class="difflineminus">-        *a_in_tag = false;</span>
<a href="#l100.686"></a><span id="l100.686" class="difflineminus">-        break;</span>
<a href="#l100.687"></a><span id="l100.687" class="difflineminus">-      default:</span>
<a href="#l100.688"></a><span id="l100.688" class="difflineminus">-        // Do nothing</span>
<a href="#l100.689"></a><span id="l100.689" class="difflineminus">-        ;</span>
<a href="#l100.690"></a><span id="l100.690" class="difflineplus">+      switch (a_current_char) {</span>
<a href="#l100.691"></a><span id="l100.691" class="difflineplus">+        case '&quot;':</span>
<a href="#l100.692"></a><span id="l100.692" class="difflineplus">+        case '\'':</span>
<a href="#l100.693"></a><span id="l100.693" class="difflineplus">+          *a_in_quote_in_tag = true;</span>
<a href="#l100.694"></a><span id="l100.694" class="difflineplus">+          *a_quote_char = a_current_char;</span>
<a href="#l100.695"></a><span id="l100.695" class="difflineplus">+          break;</span>
<a href="#l100.696"></a><span id="l100.696" class="difflineplus">+        case '&gt;':</span>
<a href="#l100.697"></a><span id="l100.697" class="difflineplus">+          // Tag is ended</span>
<a href="#l100.698"></a><span id="l100.698" class="difflineplus">+          *a_in_tag = false;</span>
<a href="#l100.699"></a><span id="l100.699" class="difflineplus">+          break;</span>
<a href="#l100.700"></a><span id="l100.700" class="difflineplus">+        default:</span>
<a href="#l100.701"></a><span id="l100.701" class="difflineplus">+            // Do nothing</span>
<a href="#l100.702"></a><span id="l100.702" class="difflineplus">+            ;</span>
<a href="#l100.703"></a><span id="l100.703">       }</span>
<a href="#l100.704"></a><span id="l100.704">     }</span>
<a href="#l100.705"></a><span id="l100.705">     return;</span>
<a href="#l100.706"></a><span id="l100.706">   }</span>
<a href="#l100.707"></a><span id="l100.707"> </span>
<a href="#l100.708"></a><span id="l100.708">   // Not in a tag.</span>
<a href="#l100.709"></a><span id="l100.709">   // Check if we are entering a tag by looking for '&lt;'.</span>
<a href="#l100.710"></a><span id="l100.710">   // All normal occurrences of '&lt;' should have been replaced</span>
<a href="#l100.711"></a><span id="l100.711">   // by &amp;lt;</span>
<a href="#l100.712"></a><span id="l100.712">   if ('&lt;' == a_current_char) {</span>
<a href="#l100.713"></a><span id="l100.713">     *a_in_tag = true;</span>
<a href="#l100.714"></a><span id="l100.714">     *a_in_quote_in_tag = false;</span>
<a href="#l100.715"></a><span id="l100.715">   }</span>
<a href="#l100.716"></a><span id="l100.716"> }</span>
<a href="#l100.717"></a><span id="l100.717"> </span>
<a href="#l100.718"></a><span id="l100.718" class="difflineminus">-</span>
<a href="#l100.719"></a><span id="l100.719"> /**</span>
<a href="#l100.720"></a><span id="l100.720">  * Converts whitespace to |&amp;nbsp;|, if appropriate.</span>
<a href="#l100.721"></a><span id="l100.721">  *</span>
<a href="#l100.722"></a><span id="l100.722">  * @param in a_current_char, the char to convert.</span>
<a href="#l100.723"></a><span id="l100.723">  * @param in a_next_char, the char after the char to convert.</span>
<a href="#l100.724"></a><span id="l100.724">  * @param in a_convert_all_whitespace, if also the last whitespace</span>
<a href="#l100.725"></a><span id="l100.725">  *                                     in a sequence should be</span>
<a href="#l100.726"></a><span id="l100.726">  *                                     converted.</span>
<a href="#l100.727"></a><span id="l100.727">  * @param out a_out_string, result will be appended.</span>
<a href="#l100.728"></a><span id="l100.728" class="difflineminus">-*/</span>
<a href="#l100.729"></a><span id="l100.729" class="difflineplus">+ */</span>
<a href="#l100.730"></a><span id="l100.730"> static void Convert_whitespace(const char16_t a_current_char,</span>
<a href="#l100.731"></a><span id="l100.731">                                const char16_t a_next_char,</span>
<a href="#l100.732"></a><span id="l100.732">                                const bool a_convert_all_whitespace,</span>
<a href="#l100.733"></a><span id="l100.733" class="difflineminus">-                               nsString&amp; a_out_string)</span>
<a href="#l100.734"></a><span id="l100.734" class="difflineminus">-{</span>
<a href="#l100.735"></a><span id="l100.735" class="difflineplus">+                               nsString &amp;a_out_string) {</span>
<a href="#l100.736"></a><span id="l100.736">   NS_ASSERTION('\t' == a_current_char || ' ' == a_current_char,</span>
<a href="#l100.737"></a><span id="l100.737">                &quot;Convert_whitespace got something else than a whitespace!&quot;);</span>
<a href="#l100.738"></a><span id="l100.738"> </span>
<a href="#l100.739"></a><span id="l100.739">   uint32_t number_of_nbsp = 0;</span>
<a href="#l100.740"></a><span id="l100.740" class="difflineminus">-  uint32_t number_of_space = 1; // Assume we're going to output one space.</span>
<a href="#l100.741"></a><span id="l100.741" class="difflineplus">+  uint32_t number_of_space = 1;  // Assume we're going to output one space.</span>
<a href="#l100.742"></a><span id="l100.742"> </span>
<a href="#l100.743"></a><span id="l100.743">   /* Output the spaces for a tab. All but the last are made into &amp;nbsp;.</span>
<a href="#l100.744"></a><span id="l100.744">      The last is treated like a normal space.</span>
<a href="#l100.745"></a><span id="l100.745">   */</span>
<a href="#l100.746"></a><span id="l100.746" class="difflineminus">-  if('\t' == a_current_char) {</span>
<a href="#l100.747"></a><span id="l100.747" class="difflineplus">+  if ('\t' == a_current_char) {</span>
<a href="#l100.748"></a><span id="l100.748">     number_of_nbsp = kSpacesForATab - 1;</span>
<a href="#l100.749"></a><span id="l100.749">   }</span>
<a href="#l100.750"></a><span id="l100.750"> </span>
<a href="#l100.751"></a><span id="l100.751" class="difflineminus">-  if(' ' == a_next_char || '\t' == a_next_char || a_convert_all_whitespace) {</span>
<a href="#l100.752"></a><span id="l100.752" class="difflineplus">+  if (' ' == a_next_char || '\t' == a_next_char || a_convert_all_whitespace) {</span>
<a href="#l100.753"></a><span id="l100.753">     number_of_nbsp += number_of_space;</span>
<a href="#l100.754"></a><span id="l100.754">     number_of_space = 0;</span>
<a href="#l100.755"></a><span id="l100.755">   }</span>
<a href="#l100.756"></a><span id="l100.756"> </span>
<a href="#l100.757"></a><span id="l100.757" class="difflineminus">-  while(number_of_nbsp--) {</span>
<a href="#l100.758"></a><span id="l100.758" class="difflineplus">+  while (number_of_nbsp--) {</span>
<a href="#l100.759"></a><span id="l100.759">     a_out_string.AppendLiteral(&quot;&amp;nbsp;&quot;);</span>
<a href="#l100.760"></a><span id="l100.760">   }</span>
<a href="#l100.761"></a><span id="l100.761"> </span>
<a href="#l100.762"></a><span id="l100.762" class="difflineminus">-  while(number_of_space--) {</span>
<a href="#l100.763"></a><span id="l100.763" class="difflineplus">+  while (number_of_space--) {</span>
<a href="#l100.764"></a><span id="l100.764">     // a_out_string += ' '; gives error</span>
<a href="#l100.765"></a><span id="l100.765">     a_out_string.Append(' ');</span>
<a href="#l100.766"></a><span id="l100.766">   }</span>
<a href="#l100.767"></a><span id="l100.767"> </span>
<a href="#l100.768"></a><span id="l100.768">   return;</span>
<a href="#l100.769"></a><span id="l100.769"> }</span>
<a href="#l100.770"></a><span id="l100.770"> </span>
<a href="#l100.771"></a><span id="l100.771"> /**</span>
<a href="#l100.772"></a><span id="l100.772">  * Passes over the line and converts whitespace to |&amp;nbsp;|, if appropriate</span>
<a href="#l100.773"></a><span id="l100.773">  *</span>
<a href="#l100.774"></a><span id="l100.774">  * @param in a_convert_all_whitespace, if also the last whitespace</span>
<a href="#l100.775"></a><span id="l100.775">  *                                     in a sequence should be</span>
<a href="#l100.776"></a><span id="l100.776">  *                                     converted.</span>
<a href="#l100.777"></a><span id="l100.777">  * @param out a_out_string, result will be appended.</span>
<a href="#l100.778"></a><span id="l100.778" class="difflineminus">-*/</span>
<a href="#l100.779"></a><span id="l100.779" class="difflineminus">-static</span>
<a href="#l100.780"></a><span id="l100.780" class="difflineminus">-nsresult Line_convert_whitespace(const nsString&amp; a_line,</span>
<a href="#l100.781"></a><span id="l100.781" class="difflineminus">-                                 const bool a_convert_all_whitespace,</span>
<a href="#l100.782"></a><span id="l100.782" class="difflineminus">-                                 nsString&amp; a_out_line)</span>
<a href="#l100.783"></a><span id="l100.783" class="difflineminus">-{</span>
<a href="#l100.784"></a><span id="l100.784" class="difflineplus">+ */</span>
<a href="#l100.785"></a><span id="l100.785" class="difflineplus">+static nsresult Line_convert_whitespace(const nsString &amp;a_line,</span>
<a href="#l100.786"></a><span id="l100.786" class="difflineplus">+                                        const bool a_convert_all_whitespace,</span>
<a href="#l100.787"></a><span id="l100.787" class="difflineplus">+                                        nsString &amp;a_out_line) {</span>
<a href="#l100.788"></a><span id="l100.788">   bool in_tag = false;</span>
<a href="#l100.789"></a><span id="l100.789">   bool in_quote_in_tag = false;</span>
<a href="#l100.790"></a><span id="l100.790">   char16_t quote_char;</span>
<a href="#l100.791"></a><span id="l100.791"> </span>
<a href="#l100.792"></a><span id="l100.792" class="difflineminus">-  for (uint32_t i = 0; a_line.Length() &gt; i; i++)</span>
<a href="#l100.793"></a><span id="l100.793" class="difflineminus">-  {</span>
<a href="#l100.794"></a><span id="l100.794" class="difflineplus">+  for (uint32_t i = 0; a_line.Length() &gt; i; i++) {</span>
<a href="#l100.795"></a><span id="l100.795">     const char16_t ic = a_line[i];  // Cache</span>
<a href="#l100.796"></a><span id="l100.796"> </span>
<a href="#l100.797"></a><span id="l100.797">     Update_in_tag_info(&amp;in_tag, &amp;in_quote_in_tag, &amp;quote_char, ic);</span>
<a href="#l100.798"></a><span id="l100.798">     // We don't touch anything inside a tag.</span>
<a href="#l100.799"></a><span id="l100.799">     if (!in_tag) {</span>
<a href="#l100.800"></a><span id="l100.800">       if (ic == ' ' || ic == '\t') {</span>
<a href="#l100.801"></a><span id="l100.801">         // Convert the whitespace to something appropriate</span>
<a href="#l100.802"></a><span id="l100.802" class="difflineminus">-        Convert_whitespace(ic, a_line.Length() &gt; i + 1 ? a_line[i + 1] : '\0',</span>
<a href="#l100.803"></a><span id="l100.803" class="difflineminus">-                           a_convert_all_whitespace ||</span>
<a href="#l100.804"></a><span id="l100.804" class="difflineminus">-                           !i, // First char on line</span>
<a href="#l100.805"></a><span id="l100.805" class="difflineminus">-                           a_out_line);</span>
<a href="#l100.806"></a><span id="l100.806" class="difflineplus">+        Convert_whitespace(</span>
<a href="#l100.807"></a><span id="l100.807" class="difflineplus">+            ic, a_line.Length() &gt; i + 1 ? a_line[i + 1] : '\0',</span>
<a href="#l100.808"></a><span id="l100.808" class="difflineplus">+            a_convert_all_whitespace || !i,  // First char on line</span>
<a href="#l100.809"></a><span id="l100.809" class="difflineplus">+            a_out_line);</span>
<a href="#l100.810"></a><span id="l100.810">       } else if (ic == '\r') {</span>
<a href="#l100.811"></a><span id="l100.811">         // strip CRs</span>
<a href="#l100.812"></a><span id="l100.812">       } else {</span>
<a href="#l100.813"></a><span id="l100.813">         a_out_line += ic;</span>
<a href="#l100.814"></a><span id="l100.814">       }</span>
<a href="#l100.815"></a><span id="l100.815">     } else {</span>
<a href="#l100.816"></a><span id="l100.816">       // In tag. Don't change anything</span>
<a href="#l100.817"></a><span id="l100.817">       a_out_line += ic;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l101.1"></a><span id="l101.1" class="difflineminus">--- a/mailnews/mime/src/mimetpfl.h</span>
<a href="#l101.2"></a><span id="l101.2" class="difflineplus">+++ b/mailnews/mime/src/mimetpfl.h</span>
<a href="#l101.3"></a><span id="l101.3" class="difflineat">@@ -11,42 +11,41 @@</span>
<a href="#l101.4"></a><span id="l101.4"> /* The MimeInlineTextPlainFlowed class implements the</span>
<a href="#l101.5"></a><span id="l101.5">    text/plain MIME content type for the special case of a supplied</span>
<a href="#l101.6"></a><span id="l101.6">    format=flowed. See</span>
<a href="#l101.7"></a><span id="l101.7">    ftp://ftp.ietf.org/internet-drafts/draft-gellens-format-06.txt for</span>
<a href="#l101.8"></a><span id="l101.8">    more information.</span>
<a href="#l101.9"></a><span id="l101.9">  */</span>
<a href="#l101.10"></a><span id="l101.10"> </span>
<a href="#l101.11"></a><span id="l101.11"> typedef struct MimeInlineTextPlainFlowedClass MimeInlineTextPlainFlowedClass;</span>
<a href="#l101.12"></a><span id="l101.12" class="difflineminus">-typedef struct MimeInlineTextPlainFlowed      MimeInlineTextPlainFlowed;</span>
<a href="#l101.13"></a><span id="l101.13" class="difflineplus">+typedef struct MimeInlineTextPlainFlowed MimeInlineTextPlainFlowed;</span>
<a href="#l101.14"></a><span id="l101.14"> </span>
<a href="#l101.15"></a><span id="l101.15"> struct MimeInlineTextPlainFlowedClass {</span>
<a href="#l101.16"></a><span id="l101.16">   MimeInlineTextClass text;</span>
<a href="#l101.17"></a><span id="l101.17"> };</span>
<a href="#l101.18"></a><span id="l101.18"> </span>
<a href="#l101.19"></a><span id="l101.19"> extern MimeInlineTextPlainFlowedClass mimeInlineTextPlainFlowedClass;</span>
<a href="#l101.20"></a><span id="l101.20"> </span>
<a href="#l101.21"></a><span id="l101.21"> struct MimeInlineTextPlainFlowed {</span>
<a href="#l101.22"></a><span id="l101.22" class="difflineminus">-  MimeInlineText  text;</span>
<a href="#l101.23"></a><span id="l101.23" class="difflineminus">-  bool            delSp;                // DelSp=yes (RFC 3676)</span>
<a href="#l101.24"></a><span id="l101.24" class="difflineminus">-  int32_t         mQuotedSizeSetting;   // mail.quoted_size</span>
<a href="#l101.25"></a><span id="l101.25" class="difflineminus">-  int32_t         mQuotedStyleSetting;  // mail.quoted_style</span>
<a href="#l101.26"></a><span id="l101.26" class="difflineminus">-  nsCString       mCitationColor;       // mail.citation_color</span>
<a href="#l101.27"></a><span id="l101.27" class="difflineminus">-  bool            mStripSig;            // mail.strip_sig_on_reply</span>
<a href="#l101.28"></a><span id="l101.28" class="difflineplus">+  MimeInlineText text;</span>
<a href="#l101.29"></a><span id="l101.29" class="difflineplus">+  bool delSp;                   // DelSp=yes (RFC 3676)</span>
<a href="#l101.30"></a><span id="l101.30" class="difflineplus">+  int32_t mQuotedSizeSetting;   // mail.quoted_size</span>
<a href="#l101.31"></a><span id="l101.31" class="difflineplus">+  int32_t mQuotedStyleSetting;  // mail.quoted_style</span>
<a href="#l101.32"></a><span id="l101.32" class="difflineplus">+  nsCString mCitationColor;     // mail.citation_color</span>
<a href="#l101.33"></a><span id="l101.33" class="difflineplus">+  bool mStripSig;               // mail.strip_sig_on_reply</span>
<a href="#l101.34"></a><span id="l101.34"> };</span>
<a href="#l101.35"></a><span id="l101.35"> </span>
<a href="#l101.36"></a><span id="l101.36" class="difflineminus">-</span>
<a href="#l101.37"></a><span id="l101.37"> /*</span>
<a href="#l101.38"></a><span id="l101.38">  * Made to contain information to be kept during the whole message parsing.</span>
<a href="#l101.39"></a><span id="l101.39">  */</span>
<a href="#l101.40"></a><span id="l101.40"> struct MimeInlineTextPlainFlowedExData {</span>
<a href="#l101.41"></a><span id="l101.41">   struct MimeObject *ownerobj; /* The owner of this struct */</span>
<a href="#l101.42"></a><span id="l101.42" class="difflineminus">-  bool inflow; /* If we currently are in flow */</span>
<a href="#l101.43"></a><span id="l101.43" class="difflineminus">-  bool fixedwidthfont; /* If we output text for fixed width font */</span>
<a href="#l101.44"></a><span id="l101.44" class="difflineplus">+  bool inflow;                 /* If we currently are in flow */</span>
<a href="#l101.45"></a><span id="l101.45" class="difflineplus">+  bool fixedwidthfont;         /* If we output text for fixed width font */</span>
<a href="#l101.46"></a><span id="l101.46">   uint32_t quotelevel; /* How deep is your love, uhr, quotelevel I meen. */</span>
<a href="#l101.47"></a><span id="l101.47" class="difflineminus">-  bool isSig;  // we're currently in a signature</span>
<a href="#l101.48"></a><span id="l101.48" class="difflineplus">+  bool isSig;          // we're currently in a signature</span>
<a href="#l101.49"></a><span id="l101.49">   struct MimeInlineTextPlainFlowedExData *next;</span>
<a href="#l101.50"></a><span id="l101.50"> };</span>
<a href="#l101.51"></a><span id="l101.51"> </span>
<a href="#l101.52"></a><span id="l101.52" class="difflineminus">-#define MimeInlineTextPlainFlowedClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l101.53"></a><span id="l101.53" class="difflineminus">-  { MimeInlineTextClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l101.54"></a><span id="l101.54" class="difflineplus">+#define MimeInlineTextPlainFlowedClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l101.55"></a><span id="l101.55" class="difflineplus">+  { MimeInlineTextClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l101.56"></a><span id="l101.56"> </span>
<a href="#l101.57"></a><span id="l101.57"> #endif /* _MIMETPFL_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l102.1"></a><span id="l102.1" class="difflineminus">--- a/mailnews/mime/src/mimetpla.cpp</span>
<a href="#l102.2"></a><span id="l102.2" class="difflineplus">+++ b/mailnews/mime/src/mimetpla.cpp</span>
<a href="#l102.3"></a><span id="l102.3" class="difflineat">@@ -13,439 +13,397 @@</span>
<a href="#l102.4"></a><span id="l102.4"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l102.5"></a><span id="l102.5"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l102.6"></a><span id="l102.6"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l102.7"></a><span id="l102.7"> #include &quot;prprf.h&quot;</span>
<a href="#l102.8"></a><span id="l102.8"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l102.9"></a><span id="l102.9"> </span>
<a href="#l102.10"></a><span id="l102.10"> #define MIME_SUPERCLASS mimeInlineTextClass</span>
<a href="#l102.11"></a><span id="l102.11"> MimeDefClass(MimeInlineTextPlain, MimeInlineTextPlainClass,</span>
<a href="#l102.12"></a><span id="l102.12" class="difflineminus">-       mimeInlineTextPlainClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l102.13"></a><span id="l102.13" class="difflineplus">+             mimeInlineTextPlainClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l102.14"></a><span id="l102.14"> </span>
<a href="#l102.15"></a><span id="l102.15" class="difflineminus">-static int MimeInlineTextPlain_parse_begin (MimeObject *);</span>
<a href="#l102.16"></a><span id="l102.16" class="difflineminus">-static int MimeInlineTextPlain_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l102.17"></a><span id="l102.17" class="difflineminus">-static int MimeInlineTextPlain_parse_eof (MimeObject *, bool);</span>
<a href="#l102.18"></a><span id="l102.18" class="difflineplus">+static int MimeInlineTextPlain_parse_begin(MimeObject *);</span>
<a href="#l102.19"></a><span id="l102.19" class="difflineplus">+static int MimeInlineTextPlain_parse_line(const char *, int32_t, MimeObject *);</span>
<a href="#l102.20"></a><span id="l102.20" class="difflineplus">+static int MimeInlineTextPlain_parse_eof(MimeObject *, bool);</span>
<a href="#l102.21"></a><span id="l102.21"> </span>
<a href="#l102.22"></a><span id="l102.22" class="difflineminus">-static int</span>
<a href="#l102.23"></a><span id="l102.23" class="difflineminus">-MimeInlineTextPlainClassInitialize(MimeInlineTextPlainClass *clazz)</span>
<a href="#l102.24"></a><span id="l102.24" class="difflineminus">-{</span>
<a href="#l102.25"></a><span id="l102.25" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l102.26"></a><span id="l102.26" class="difflineplus">+static int MimeInlineTextPlainClassInitialize(MimeInlineTextPlainClass *clazz) {</span>
<a href="#l102.27"></a><span id="l102.27" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l102.28"></a><span id="l102.28">   NS_ASSERTION(!oclass-&gt;class_initialized, &quot;class not initialized&quot;);</span>
<a href="#l102.29"></a><span id="l102.29">   oclass-&gt;parse_begin = MimeInlineTextPlain_parse_begin;</span>
<a href="#l102.30"></a><span id="l102.30" class="difflineminus">-  oclass-&gt;parse_line  = MimeInlineTextPlain_parse_line;</span>
<a href="#l102.31"></a><span id="l102.31" class="difflineminus">-  oclass-&gt;parse_eof   = MimeInlineTextPlain_parse_eof;</span>
<a href="#l102.32"></a><span id="l102.32" class="difflineplus">+  oclass-&gt;parse_line = MimeInlineTextPlain_parse_line;</span>
<a href="#l102.33"></a><span id="l102.33" class="difflineplus">+  oclass-&gt;parse_eof = MimeInlineTextPlain_parse_eof;</span>
<a href="#l102.34"></a><span id="l102.34">   return 0;</span>
<a href="#l102.35"></a><span id="l102.35"> }</span>
<a href="#l102.36"></a><span id="l102.36"> </span>
<a href="#l102.37"></a><span id="l102.37" class="difflineminus">-extern &quot;C&quot;</span>
<a href="#l102.38"></a><span id="l102.38" class="difflineminus">-void</span>
<a href="#l102.39"></a><span id="l102.39" class="difflineminus">-MimeTextBuildPrefixCSS(int32_t    quotedSizeSetting,   // mail.quoted_size</span>
<a href="#l102.40"></a><span id="l102.40" class="difflineminus">-                       int32_t    quotedStyleSetting,  // mail.quoted_style</span>
<a href="#l102.41"></a><span id="l102.41" class="difflineminus">-                       nsACString &amp;citationColor,      // mail.citation_color</span>
<a href="#l102.42"></a><span id="l102.42" class="difflineminus">-                       nsACString &amp;style)</span>
<a href="#l102.43"></a><span id="l102.43" class="difflineminus">-{</span>
<a href="#l102.44"></a><span id="l102.44" class="difflineminus">-  switch (quotedStyleSetting)</span>
<a href="#l102.45"></a><span id="l102.45" class="difflineminus">-  {</span>
<a href="#l102.46"></a><span id="l102.46" class="difflineminus">-  case 0:     // regular</span>
<a href="#l102.47"></a><span id="l102.47" class="difflineminus">-    break;</span>
<a href="#l102.48"></a><span id="l102.48" class="difflineminus">-  case 1:     // bold</span>
<a href="#l102.49"></a><span id="l102.49" class="difflineminus">-    style.AppendLiteral(&quot;font-weight: bold; &quot;);</span>
<a href="#l102.50"></a><span id="l102.50" class="difflineminus">-    break;</span>
<a href="#l102.51"></a><span id="l102.51" class="difflineminus">-  case 2:     // italic</span>
<a href="#l102.52"></a><span id="l102.52" class="difflineminus">-    style.AppendLiteral(&quot;font-style: italic; &quot;);</span>
<a href="#l102.53"></a><span id="l102.53" class="difflineminus">-    break;</span>
<a href="#l102.54"></a><span id="l102.54" class="difflineminus">-  case 3:     // bold-italic</span>
<a href="#l102.55"></a><span id="l102.55" class="difflineminus">-    style.AppendLiteral(&quot;font-weight: bold; font-style: italic; &quot;);</span>
<a href="#l102.56"></a><span id="l102.56" class="difflineminus">-    break;</span>
<a href="#l102.57"></a><span id="l102.57" class="difflineplus">+extern &quot;C&quot; void MimeTextBuildPrefixCSS(</span>
<a href="#l102.58"></a><span id="l102.58" class="difflineplus">+    int32_t quotedSizeSetting,   // mail.quoted_size</span>
<a href="#l102.59"></a><span id="l102.59" class="difflineplus">+    int32_t quotedStyleSetting,  // mail.quoted_style</span>
<a href="#l102.60"></a><span id="l102.60" class="difflineplus">+    nsACString &amp;citationColor,   // mail.citation_color</span>
<a href="#l102.61"></a><span id="l102.61" class="difflineplus">+    nsACString &amp;style) {</span>
<a href="#l102.62"></a><span id="l102.62" class="difflineplus">+  switch (quotedStyleSetting) {</span>
<a href="#l102.63"></a><span id="l102.63" class="difflineplus">+    case 0:  // regular</span>
<a href="#l102.64"></a><span id="l102.64" class="difflineplus">+      break;</span>
<a href="#l102.65"></a><span id="l102.65" class="difflineplus">+    case 1:  // bold</span>
<a href="#l102.66"></a><span id="l102.66" class="difflineplus">+      style.AppendLiteral(&quot;font-weight: bold; &quot;);</span>
<a href="#l102.67"></a><span id="l102.67" class="difflineplus">+      break;</span>
<a href="#l102.68"></a><span id="l102.68" class="difflineplus">+    case 2:  // italic</span>
<a href="#l102.69"></a><span id="l102.69" class="difflineplus">+      style.AppendLiteral(&quot;font-style: italic; &quot;);</span>
<a href="#l102.70"></a><span id="l102.70" class="difflineplus">+      break;</span>
<a href="#l102.71"></a><span id="l102.71" class="difflineplus">+    case 3:  // bold-italic</span>
<a href="#l102.72"></a><span id="l102.72" class="difflineplus">+      style.AppendLiteral(&quot;font-weight: bold; font-style: italic; &quot;);</span>
<a href="#l102.73"></a><span id="l102.73" class="difflineplus">+      break;</span>
<a href="#l102.74"></a><span id="l102.74">   }</span>
<a href="#l102.75"></a><span id="l102.75"> </span>
<a href="#l102.76"></a><span id="l102.76" class="difflineminus">-  switch (quotedSizeSetting)</span>
<a href="#l102.77"></a><span id="l102.77" class="difflineminus">-  {</span>
<a href="#l102.78"></a><span id="l102.78" class="difflineminus">-  case 0:     // regular</span>
<a href="#l102.79"></a><span id="l102.79" class="difflineminus">-    break;</span>
<a href="#l102.80"></a><span id="l102.80" class="difflineminus">-  case 1:     // large</span>
<a href="#l102.81"></a><span id="l102.81" class="difflineminus">-    style.AppendLiteral(&quot;font-size: large; &quot;);</span>
<a href="#l102.82"></a><span id="l102.82" class="difflineminus">-    break;</span>
<a href="#l102.83"></a><span id="l102.83" class="difflineminus">-  case 2:     // small</span>
<a href="#l102.84"></a><span id="l102.84" class="difflineminus">-    style.AppendLiteral(&quot;font-size: small; &quot;);</span>
<a href="#l102.85"></a><span id="l102.85" class="difflineminus">-    break;</span>
<a href="#l102.86"></a><span id="l102.86" class="difflineplus">+  switch (quotedSizeSetting) {</span>
<a href="#l102.87"></a><span id="l102.87" class="difflineplus">+    case 0:  // regular</span>
<a href="#l102.88"></a><span id="l102.88" class="difflineplus">+      break;</span>
<a href="#l102.89"></a><span id="l102.89" class="difflineplus">+    case 1:  // large</span>
<a href="#l102.90"></a><span id="l102.90" class="difflineplus">+      style.AppendLiteral(&quot;font-size: large; &quot;);</span>
<a href="#l102.91"></a><span id="l102.91" class="difflineplus">+      break;</span>
<a href="#l102.92"></a><span id="l102.92" class="difflineplus">+    case 2:  // small</span>
<a href="#l102.93"></a><span id="l102.93" class="difflineplus">+      style.AppendLiteral(&quot;font-size: small; &quot;);</span>
<a href="#l102.94"></a><span id="l102.94" class="difflineplus">+      break;</span>
<a href="#l102.95"></a><span id="l102.95">   }</span>
<a href="#l102.96"></a><span id="l102.96"> </span>
<a href="#l102.97"></a><span id="l102.97" class="difflineminus">-  if (!citationColor.IsEmpty())</span>
<a href="#l102.98"></a><span id="l102.98" class="difflineminus">-  {</span>
<a href="#l102.99"></a><span id="l102.99" class="difflineplus">+  if (!citationColor.IsEmpty()) {</span>
<a href="#l102.100"></a><span id="l102.100">     style += &quot;color: &quot;;</span>
<a href="#l102.101"></a><span id="l102.101">     style += citationColor;</span>
<a href="#l102.102"></a><span id="l102.102">     style += ';';</span>
<a href="#l102.103"></a><span id="l102.103">   }</span>
<a href="#l102.104"></a><span id="l102.104"> }</span>
<a href="#l102.105"></a><span id="l102.105"> </span>
<a href="#l102.106"></a><span id="l102.106" class="difflineminus">-static int</span>
<a href="#l102.107"></a><span id="l102.107" class="difflineminus">-MimeInlineTextPlain_parse_begin (MimeObject *obj)</span>
<a href="#l102.108"></a><span id="l102.108" class="difflineminus">-{</span>
<a href="#l102.109"></a><span id="l102.109" class="difflineplus">+static int MimeInlineTextPlain_parse_begin(MimeObject *obj) {</span>
<a href="#l102.110"></a><span id="l102.110">   int status = 0;</span>
<a href="#l102.111"></a><span id="l102.111" class="difflineminus">-  bool quoting = ( obj-&gt;options</span>
<a href="#l102.112"></a><span id="l102.112" class="difflineminus">-    &amp;&amp; ( obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l102.113"></a><span id="l102.113" class="difflineminus">-         obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting</span>
<a href="#l102.114"></a><span id="l102.114" class="difflineminus">-       )       );  // The output will be inserted in the composer as quotation</span>
<a href="#l102.115"></a><span id="l102.115" class="difflineminus">-  bool plainHTML = quoting || (obj-&gt;options &amp;&amp;</span>
<a href="#l102.116"></a><span id="l102.116" class="difflineminus">-       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs));</span>
<a href="#l102.117"></a><span id="l102.117" class="difflineminus">-       // Just good(tm) HTML. No reliance on CSS.</span>
<a href="#l102.118"></a><span id="l102.118" class="difflineminus">-  bool rawPlainText = obj-&gt;options &amp;&amp;</span>
<a href="#l102.119"></a><span id="l102.119" class="difflineminus">-       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageFilterSniffer</span>
<a href="#l102.120"></a><span id="l102.120" class="difflineminus">-         || obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach);</span>
<a href="#l102.121"></a><span id="l102.121" class="difflineplus">+  bool quoting =</span>
<a href="#l102.122"></a><span id="l102.122" class="difflineplus">+      (obj-&gt;options &amp;&amp;</span>
<a href="#l102.123"></a><span id="l102.123" class="difflineplus">+       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l102.124"></a><span id="l102.124" class="difflineplus">+        obj-&gt;options-&gt;format_out ==</span>
<a href="#l102.125"></a><span id="l102.125" class="difflineplus">+            nsMimeOutput::nsMimeMessageBodyQuoting));  // The output will be</span>
<a href="#l102.126"></a><span id="l102.126" class="difflineplus">+                                                       // inserted in the</span>
<a href="#l102.127"></a><span id="l102.127" class="difflineplus">+                                                       // composer as quotation</span>
<a href="#l102.128"></a><span id="l102.128" class="difflineplus">+  bool plainHTML =</span>
<a href="#l102.129"></a><span id="l102.129" class="difflineplus">+      quoting || (obj-&gt;options &amp;&amp; (obj-&gt;options-&gt;format_out ==</span>
<a href="#l102.130"></a><span id="l102.130" class="difflineplus">+                                   nsMimeOutput::nsMimeMessageSaveAs));</span>
<a href="#l102.131"></a><span id="l102.131" class="difflineplus">+  // Just good(tm) HTML. No reliance on CSS.</span>
<a href="#l102.132"></a><span id="l102.132" class="difflineplus">+  bool rawPlainText =</span>
<a href="#l102.133"></a><span id="l102.133" class="difflineplus">+      obj-&gt;options &amp;&amp;</span>
<a href="#l102.134"></a><span id="l102.134" class="difflineplus">+      (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageFilterSniffer ||</span>
<a href="#l102.135"></a><span id="l102.135" class="difflineplus">+       obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach);</span>
<a href="#l102.136"></a><span id="l102.136"> </span>
<a href="#l102.137"></a><span id="l102.137" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l102.138"></a><span id="l102.138" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l102.139"></a><span id="l102.139">   if (status &lt; 0) return status;</span>
<a href="#l102.140"></a><span id="l102.140"> </span>
<a href="#l102.141"></a><span id="l102.141">   if (!obj-&gt;output_p) return 0;</span>
<a href="#l102.142"></a><span id="l102.142"> </span>
<a href="#l102.143"></a><span id="l102.143" class="difflineminus">-  if (obj-&gt;options &amp;&amp;</span>
<a href="#l102.144"></a><span id="l102.144" class="difflineminus">-    obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l102.145"></a><span id="l102.145" class="difflineminus">-    obj-&gt;options-&gt;output_fn)</span>
<a href="#l102.146"></a><span id="l102.146" class="difflineminus">-  {</span>
<a href="#l102.147"></a><span id="l102.147" class="difflineminus">-      MimeInlineTextPlain *text = (MimeInlineTextPlain *) obj;</span>
<a href="#l102.148"></a><span id="l102.148" class="difflineminus">-      text-&gt;mCiteLevel = 0;</span>
<a href="#l102.149"></a><span id="l102.149" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;write_html_p &amp;&amp; obj-&gt;options-&gt;output_fn) {</span>
<a href="#l102.150"></a><span id="l102.150" class="difflineplus">+    MimeInlineTextPlain *text = (MimeInlineTextPlain *)obj;</span>
<a href="#l102.151"></a><span id="l102.151" class="difflineplus">+    text-&gt;mCiteLevel = 0;</span>
<a href="#l102.152"></a><span id="l102.152" class="difflineplus">+</span>
<a href="#l102.153"></a><span id="l102.153" class="difflineplus">+    // Get the prefs</span>
<a href="#l102.154"></a><span id="l102.154" class="difflineplus">+</span>
<a href="#l102.155"></a><span id="l102.155" class="difflineplus">+    // Quoting</span>
<a href="#l102.156"></a><span id="l102.156" class="difflineplus">+    text-&gt;mBlockquoting = true;  // mail.quoteasblock</span>
<a href="#l102.157"></a><span id="l102.157"> </span>
<a href="#l102.158"></a><span id="l102.158" class="difflineminus">-      // Get the prefs</span>
<a href="#l102.159"></a><span id="l102.159" class="difflineplus">+    // Viewing</span>
<a href="#l102.160"></a><span id="l102.160" class="difflineplus">+    text-&gt;mQuotedSizeSetting = 0;     // mail.quoted_size</span>
<a href="#l102.161"></a><span id="l102.161" class="difflineplus">+    text-&gt;mQuotedStyleSetting = 0;    // mail.quoted_style</span>
<a href="#l102.162"></a><span id="l102.162" class="difflineplus">+    text-&gt;mCitationColor.Truncate();  // mail.citation_color</span>
<a href="#l102.163"></a><span id="l102.163" class="difflineplus">+    text-&gt;mStripSig = true;           // mail.strip_sig_on_reply</span>
<a href="#l102.164"></a><span id="l102.164" class="difflineplus">+    bool graphicalQuote = true;       // mail.quoted_graphical</span>
<a href="#l102.165"></a><span id="l102.165"> </span>
<a href="#l102.166"></a><span id="l102.166" class="difflineminus">-      // Quoting</span>
<a href="#l102.167"></a><span id="l102.167" class="difflineminus">-      text-&gt;mBlockquoting = true; // mail.quoteasblock</span>
<a href="#l102.168"></a><span id="l102.168" class="difflineplus">+    nsIPrefBranch *prefBranch = GetPrefBranch(obj-&gt;options);</span>
<a href="#l102.169"></a><span id="l102.169" class="difflineplus">+    if (prefBranch) {</span>
<a href="#l102.170"></a><span id="l102.170" class="difflineplus">+      prefBranch-&gt;GetIntPref(&quot;mail.quoted_size&quot;, &amp;(text-&gt;mQuotedSizeSetting));</span>
<a href="#l102.171"></a><span id="l102.171" class="difflineplus">+      prefBranch-&gt;GetIntPref(&quot;mail.quoted_style&quot;, &amp;(text-&gt;mQuotedStyleSetting));</span>
<a href="#l102.172"></a><span id="l102.172" class="difflineplus">+      prefBranch-&gt;GetCharPref(&quot;mail.citation_color&quot;, text-&gt;mCitationColor);</span>
<a href="#l102.173"></a><span id="l102.173" class="difflineplus">+      prefBranch-&gt;GetBoolPref(&quot;mail.strip_sig_on_reply&quot;, &amp;(text-&gt;mStripSig));</span>
<a href="#l102.174"></a><span id="l102.174" class="difflineplus">+      prefBranch-&gt;GetBoolPref(&quot;mail.quoted_graphical&quot;, &amp;graphicalQuote);</span>
<a href="#l102.175"></a><span id="l102.175" class="difflineplus">+      prefBranch-&gt;GetBoolPref(&quot;mail.quoteasblock&quot;, &amp;(text-&gt;mBlockquoting));</span>
<a href="#l102.176"></a><span id="l102.176" class="difflineplus">+    }</span>
<a href="#l102.177"></a><span id="l102.177"> </span>
<a href="#l102.178"></a><span id="l102.178" class="difflineminus">-      // Viewing</span>
<a href="#l102.179"></a><span id="l102.179" class="difflineminus">-      text-&gt;mQuotedSizeSetting = 0;   // mail.quoted_size</span>
<a href="#l102.180"></a><span id="l102.180" class="difflineminus">-      text-&gt;mQuotedStyleSetting = 0;  // mail.quoted_style</span>
<a href="#l102.181"></a><span id="l102.181" class="difflineminus">-      text-&gt;mCitationColor.Truncate();  // mail.citation_color</span>
<a href="#l102.182"></a><span id="l102.182" class="difflineminus">-      text-&gt;mStripSig = true; // mail.strip_sig_on_reply</span>
<a href="#l102.183"></a><span id="l102.183" class="difflineminus">-      bool graphicalQuote = true; // mail.quoted_graphical</span>
<a href="#l102.184"></a><span id="l102.184" class="difflineplus">+    if (!rawPlainText) {</span>
<a href="#l102.185"></a><span id="l102.185" class="difflineplus">+      // Get font</span>
<a href="#l102.186"></a><span id="l102.186" class="difflineplus">+      // only used for viewing (!plainHTML)</span>
<a href="#l102.187"></a><span id="l102.187" class="difflineplus">+      nsAutoCString fontstyle;</span>
<a href="#l102.188"></a><span id="l102.188" class="difflineplus">+      nsAutoCString fontLang;  // langgroup of the font</span>
<a href="#l102.189"></a><span id="l102.189" class="difflineplus">+</span>
<a href="#l102.190"></a><span id="l102.190" class="difflineplus">+      // generic font-family name ( -moz-fixed for fixed font and NULL for</span>
<a href="#l102.191"></a><span id="l102.191" class="difflineplus">+      // variable font ) is sufficient now that bug 105199 has been fixed.</span>
<a href="#l102.192"></a><span id="l102.192" class="difflineplus">+</span>
<a href="#l102.193"></a><span id="l102.193" class="difflineplus">+      if (!obj-&gt;options-&gt;variable_width_plaintext_p)</span>
<a href="#l102.194"></a><span id="l102.194" class="difflineplus">+        fontstyle = &quot;font-family: -moz-fixed&quot;;</span>
<a href="#l102.195"></a><span id="l102.195"> </span>
<a href="#l102.196"></a><span id="l102.196" class="difflineminus">-      nsIPrefBranch *prefBranch = GetPrefBranch(obj-&gt;options);</span>
<a href="#l102.197"></a><span id="l102.197" class="difflineminus">-      if (prefBranch)</span>
<a href="#l102.198"></a><span id="l102.198" class="difflineminus">-      {</span>
<a href="#l102.199"></a><span id="l102.199" class="difflineminus">-        prefBranch-&gt;GetIntPref(&quot;mail.quoted_size&quot;, &amp;(text-&gt;mQuotedSizeSetting));</span>
<a href="#l102.200"></a><span id="l102.200" class="difflineminus">-        prefBranch-&gt;GetIntPref(&quot;mail.quoted_style&quot;, &amp;(text-&gt;mQuotedStyleSetting));</span>
<a href="#l102.201"></a><span id="l102.201" class="difflineminus">-        prefBranch-&gt;GetCharPref(&quot;mail.citation_color&quot;, text-&gt;mCitationColor);</span>
<a href="#l102.202"></a><span id="l102.202" class="difflineminus">-        prefBranch-&gt;GetBoolPref(&quot;mail.strip_sig_on_reply&quot;, &amp;(text-&gt;mStripSig));</span>
<a href="#l102.203"></a><span id="l102.203" class="difflineminus">-        prefBranch-&gt;GetBoolPref(&quot;mail.quoted_graphical&quot;, &amp;graphicalQuote);</span>
<a href="#l102.204"></a><span id="l102.204" class="difflineminus">-        prefBranch-&gt;GetBoolPref(&quot;mail.quoteasblock&quot;, &amp;(text-&gt;mBlockquoting));</span>
<a href="#l102.205"></a><span id="l102.205" class="difflineplus">+      if (nsMimeOutput::nsMimeMessageBodyDisplay == obj-&gt;options-&gt;format_out ||</span>
<a href="#l102.206"></a><span id="l102.206" class="difflineplus">+          nsMimeOutput::nsMimeMessagePrintOutput == obj-&gt;options-&gt;format_out) {</span>
<a href="#l102.207"></a><span id="l102.207" class="difflineplus">+        int32_t fontSize;            // default font size</span>
<a href="#l102.208"></a><span id="l102.208" class="difflineplus">+        int32_t fontSizePercentage;  // size percentage</span>
<a href="#l102.209"></a><span id="l102.209" class="difflineplus">+        nsresult rv =</span>
<a href="#l102.210"></a><span id="l102.210" class="difflineplus">+            GetMailNewsFont(obj, !obj-&gt;options-&gt;variable_width_plaintext_p,</span>
<a href="#l102.211"></a><span id="l102.211" class="difflineplus">+                            &amp;fontSize, &amp;fontSizePercentage, fontLang);</span>
<a href="#l102.212"></a><span id="l102.212" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l102.213"></a><span id="l102.213" class="difflineplus">+          if (!fontstyle.IsEmpty()) {</span>
<a href="#l102.214"></a><span id="l102.214" class="difflineplus">+            fontstyle += &quot;; &quot;;</span>
<a href="#l102.215"></a><span id="l102.215" class="difflineplus">+          }</span>
<a href="#l102.216"></a><span id="l102.216" class="difflineplus">+          fontstyle += &quot;font-size: &quot;;</span>
<a href="#l102.217"></a><span id="l102.217" class="difflineplus">+          fontstyle.AppendInt(fontSize);</span>
<a href="#l102.218"></a><span id="l102.218" class="difflineplus">+          fontstyle += &quot;px;&quot;;</span>
<a href="#l102.219"></a><span id="l102.219" class="difflineplus">+        }</span>
<a href="#l102.220"></a><span id="l102.220">       }</span>
<a href="#l102.221"></a><span id="l102.221"> </span>
<a href="#l102.222"></a><span id="l102.222" class="difflineminus">-      if (!rawPlainText)</span>
<a href="#l102.223"></a><span id="l102.223" class="difflineplus">+      // Opening &lt;div&gt;. We currently have to add formatting here. :-(</span>
<a href="#l102.224"></a><span id="l102.224" class="difflineplus">+      nsAutoCString openingDiv;</span>
<a href="#l102.225"></a><span id="l102.225" class="difflineplus">+      if (!quoting)</span>
<a href="#l102.226"></a><span id="l102.226" class="difflineplus">+      /* 4.x' editor can't break &lt;div&gt;s (e.g. to interleave comments).</span>
<a href="#l102.227"></a><span id="l102.227" class="difflineplus">+         We'll add the class to the &lt;blockquote type=cite&gt; later. */</span>
<a href="#l102.228"></a><span id="l102.228">       {</span>
<a href="#l102.229"></a><span id="l102.229" class="difflineminus">-        // Get font</span>
<a href="#l102.230"></a><span id="l102.230" class="difflineminus">-        // only used for viewing (!plainHTML)</span>
<a href="#l102.231"></a><span id="l102.231" class="difflineminus">-        nsAutoCString fontstyle;</span>
<a href="#l102.232"></a><span id="l102.232" class="difflineminus">-        nsAutoCString fontLang;  // langgroup of the font</span>
<a href="#l102.233"></a><span id="l102.233" class="difflineminus">-</span>
<a href="#l102.234"></a><span id="l102.234" class="difflineminus">-        // generic font-family name ( -moz-fixed for fixed font and NULL for</span>
<a href="#l102.235"></a><span id="l102.235" class="difflineminus">-        // variable font ) is sufficient now that bug 105199 has been fixed.</span>
<a href="#l102.236"></a><span id="l102.236" class="difflineminus">-</span>
<a href="#l102.237"></a><span id="l102.237" class="difflineminus">-        if (!obj-&gt;options-&gt;variable_width_plaintext_p)</span>
<a href="#l102.238"></a><span id="l102.238" class="difflineminus">-          fontstyle = &quot;font-family: -moz-fixed&quot;;</span>
<a href="#l102.239"></a><span id="l102.239" class="difflineplus">+        openingDiv = &quot;&lt;div class=\&quot;moz-text-plain\&quot;&quot;;</span>
<a href="#l102.240"></a><span id="l102.240" class="difflineplus">+        if (!plainHTML) {</span>
<a href="#l102.241"></a><span id="l102.241" class="difflineplus">+          if (obj-&gt;options-&gt;wrap_long_lines_p)</span>
<a href="#l102.242"></a><span id="l102.242" class="difflineplus">+            openingDiv += &quot; wrap=true&quot;;</span>
<a href="#l102.243"></a><span id="l102.243" class="difflineplus">+          else</span>
<a href="#l102.244"></a><span id="l102.244" class="difflineplus">+            openingDiv += &quot; wrap=false&quot;;</span>
<a href="#l102.245"></a><span id="l102.245"> </span>
<a href="#l102.246"></a><span id="l102.246" class="difflineminus">-        if (nsMimeOutput::nsMimeMessageBodyDisplay == obj-&gt;options-&gt;format_out ||</span>
<a href="#l102.247"></a><span id="l102.247" class="difflineminus">-            nsMimeOutput::nsMimeMessagePrintOutput == obj-&gt;options-&gt;format_out)</span>
<a href="#l102.248"></a><span id="l102.248" class="difflineminus">-        {</span>
<a href="#l102.249"></a><span id="l102.249" class="difflineminus">-          int32_t fontSize;       // default font size</span>
<a href="#l102.250"></a><span id="l102.250" class="difflineminus">-          int32_t fontSizePercentage;   // size percentage</span>
<a href="#l102.251"></a><span id="l102.251" class="difflineminus">-          nsresult rv = GetMailNewsFont(obj,</span>
<a href="#l102.252"></a><span id="l102.252" class="difflineminus">-                             !obj-&gt;options-&gt;variable_width_plaintext_p,</span>
<a href="#l102.253"></a><span id="l102.253" class="difflineminus">-                             &amp;fontSize, &amp;fontSizePercentage, fontLang);</span>
<a href="#l102.254"></a><span id="l102.254" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l102.255"></a><span id="l102.255" class="difflineminus">-          {</span>
<a href="#l102.256"></a><span id="l102.256" class="difflineminus">-            if ( ! fontstyle.IsEmpty() ) {</span>
<a href="#l102.257"></a><span id="l102.257" class="difflineminus">-              fontstyle += &quot;; &quot;;</span>
<a href="#l102.258"></a><span id="l102.258" class="difflineminus">-            }</span>
<a href="#l102.259"></a><span id="l102.259" class="difflineminus">-            fontstyle += &quot;font-size: &quot;;</span>
<a href="#l102.260"></a><span id="l102.260" class="difflineminus">-            fontstyle.AppendInt(fontSize);</span>
<a href="#l102.261"></a><span id="l102.261" class="difflineminus">-            fontstyle += &quot;px;&quot;;</span>
<a href="#l102.262"></a><span id="l102.262" class="difflineplus">+          if (graphicalQuote)</span>
<a href="#l102.263"></a><span id="l102.263" class="difflineplus">+            openingDiv += &quot; graphical-quote=true&quot;;</span>
<a href="#l102.264"></a><span id="l102.264" class="difflineplus">+          else</span>
<a href="#l102.265"></a><span id="l102.265" class="difflineplus">+            openingDiv += &quot; graphical-quote=false&quot;;</span>
<a href="#l102.266"></a><span id="l102.266" class="difflineplus">+</span>
<a href="#l102.267"></a><span id="l102.267" class="difflineplus">+          if (!fontstyle.IsEmpty()) {</span>
<a href="#l102.268"></a><span id="l102.268" class="difflineplus">+            openingDiv += &quot; style=\&quot;&quot;;</span>
<a href="#l102.269"></a><span id="l102.269" class="difflineplus">+            openingDiv += fontstyle;</span>
<a href="#l102.270"></a><span id="l102.270" class="difflineplus">+            openingDiv += '\&quot;';</span>
<a href="#l102.271"></a><span id="l102.271" class="difflineplus">+          }</span>
<a href="#l102.272"></a><span id="l102.272" class="difflineplus">+          if (!fontLang.IsEmpty()) {</span>
<a href="#l102.273"></a><span id="l102.273" class="difflineplus">+            openingDiv += &quot; lang=\&quot;&quot;;</span>
<a href="#l102.274"></a><span id="l102.274" class="difflineplus">+            openingDiv += fontLang;</span>
<a href="#l102.275"></a><span id="l102.275" class="difflineplus">+            openingDiv += '\&quot;';</span>
<a href="#l102.276"></a><span id="l102.276">           }</span>
<a href="#l102.277"></a><span id="l102.277">         }</span>
<a href="#l102.278"></a><span id="l102.278" class="difflineminus">-</span>
<a href="#l102.279"></a><span id="l102.279" class="difflineminus">-        // Opening &lt;div&gt;. We currently have to add formatting here. :-(</span>
<a href="#l102.280"></a><span id="l102.280" class="difflineminus">-        nsAutoCString openingDiv;</span>
<a href="#l102.281"></a><span id="l102.281" class="difflineminus">-        if (!quoting)</span>
<a href="#l102.282"></a><span id="l102.282" class="difflineminus">-             /* 4.x' editor can't break &lt;div&gt;s (e.g. to interleave comments).</span>
<a href="#l102.283"></a><span id="l102.283" class="difflineminus">-                We'll add the class to the &lt;blockquote type=cite&gt; later. */</span>
<a href="#l102.284"></a><span id="l102.284" class="difflineminus">-        {</span>
<a href="#l102.285"></a><span id="l102.285" class="difflineminus">-          openingDiv = &quot;&lt;div class=\&quot;moz-text-plain\&quot;&quot;;</span>
<a href="#l102.286"></a><span id="l102.286" class="difflineminus">-          if (!plainHTML)</span>
<a href="#l102.287"></a><span id="l102.287" class="difflineminus">-          {</span>
<a href="#l102.288"></a><span id="l102.288" class="difflineminus">-            if (obj-&gt;options-&gt;wrap_long_lines_p)</span>
<a href="#l102.289"></a><span id="l102.289" class="difflineminus">-              openingDiv += &quot; wrap=true&quot;;</span>
<a href="#l102.290"></a><span id="l102.290" class="difflineminus">-            else</span>
<a href="#l102.291"></a><span id="l102.291" class="difflineminus">-              openingDiv += &quot; wrap=false&quot;;</span>
<a href="#l102.292"></a><span id="l102.292" class="difflineminus">-</span>
<a href="#l102.293"></a><span id="l102.293" class="difflineminus">-            if (graphicalQuote)</span>
<a href="#l102.294"></a><span id="l102.294" class="difflineminus">-              openingDiv += &quot; graphical-quote=true&quot;;</span>
<a href="#l102.295"></a><span id="l102.295" class="difflineminus">-            else</span>
<a href="#l102.296"></a><span id="l102.296" class="difflineminus">-              openingDiv += &quot; graphical-quote=false&quot;;</span>
<a href="#l102.297"></a><span id="l102.297" class="difflineminus">-</span>
<a href="#l102.298"></a><span id="l102.298" class="difflineminus">-            if (!fontstyle.IsEmpty())</span>
<a href="#l102.299"></a><span id="l102.299" class="difflineminus">-            {</span>
<a href="#l102.300"></a><span id="l102.300" class="difflineminus">-              openingDiv += &quot; style=\&quot;&quot;;</span>
<a href="#l102.301"></a><span id="l102.301" class="difflineminus">-              openingDiv += fontstyle;</span>
<a href="#l102.302"></a><span id="l102.302" class="difflineminus">-              openingDiv += '\&quot;';</span>
<a href="#l102.303"></a><span id="l102.303" class="difflineminus">-            }</span>
<a href="#l102.304"></a><span id="l102.304" class="difflineminus">-            if (!fontLang.IsEmpty())</span>
<a href="#l102.305"></a><span id="l102.305" class="difflineminus">-            {</span>
<a href="#l102.306"></a><span id="l102.306" class="difflineminus">-              openingDiv += &quot; lang=\&quot;&quot;;</span>
<a href="#l102.307"></a><span id="l102.307" class="difflineminus">-              openingDiv += fontLang;</span>
<a href="#l102.308"></a><span id="l102.308" class="difflineminus">-              openingDiv += '\&quot;';</span>
<a href="#l102.309"></a><span id="l102.309" class="difflineminus">-            }</span>
<a href="#l102.310"></a><span id="l102.310" class="difflineminus">-          }</span>
<a href="#l102.311"></a><span id="l102.311" class="difflineminus">-          openingDiv += &quot;&gt;&lt;pre wrap class=\&quot;moz-quote-pre\&quot;&gt;\n&quot;;</span>
<a href="#l102.312"></a><span id="l102.312" class="difflineminus">-        }</span>
<a href="#l102.313"></a><span id="l102.313" class="difflineminus">-        else</span>
<a href="#l102.314"></a><span id="l102.314" class="difflineminus">-          openingDiv = &quot;&lt;pre wrap class=\&quot;moz-quote-pre\&quot;&gt;\n&quot;;</span>
<a href="#l102.315"></a><span id="l102.315" class="difflineplus">+        openingDiv += &quot;&gt;&lt;pre wrap class=\&quot;moz-quote-pre\&quot;&gt;\n&quot;;</span>
<a href="#l102.316"></a><span id="l102.316" class="difflineplus">+      } else</span>
<a href="#l102.317"></a><span id="l102.317" class="difflineplus">+        openingDiv = &quot;&lt;pre wrap class=\&quot;moz-quote-pre\&quot;&gt;\n&quot;;</span>
<a href="#l102.318"></a><span id="l102.318"> </span>
<a href="#l102.319"></a><span id="l102.319">       /* text/plain objects always have separators before and after them.</span>
<a href="#l102.320"></a><span id="l102.320">        Note that this is not the case for text/enriched objects. */</span>
<a href="#l102.321"></a><span id="l102.321">       status = MimeObject_write_separator(obj);</span>
<a href="#l102.322"></a><span id="l102.322">       if (status &lt; 0) return status;</span>
<a href="#l102.323"></a><span id="l102.323"> </span>
<a href="#l102.324"></a><span id="l102.324" class="difflineminus">-      status = MimeObject_write(obj, openingDiv.get(), openingDiv.Length(), true);</span>
<a href="#l102.325"></a><span id="l102.325" class="difflineplus">+      status =</span>
<a href="#l102.326"></a><span id="l102.326" class="difflineplus">+          MimeObject_write(obj, openingDiv.get(), openingDiv.Length(), true);</span>
<a href="#l102.327"></a><span id="l102.327">       if (status &lt; 0) return status;</span>
<a href="#l102.328"></a><span id="l102.328">     }</span>
<a href="#l102.329"></a><span id="l102.329">   }</span>
<a href="#l102.330"></a><span id="l102.330"> </span>
<a href="#l102.331"></a><span id="l102.331">   return 0;</span>
<a href="#l102.332"></a><span id="l102.332"> }</span>
<a href="#l102.333"></a><span id="l102.333"> </span>
<a href="#l102.334"></a><span id="l102.334" class="difflineminus">-static int</span>
<a href="#l102.335"></a><span id="l102.335" class="difflineminus">-MimeInlineTextPlain_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l102.336"></a><span id="l102.336" class="difflineminus">-{</span>
<a href="#l102.337"></a><span id="l102.337" class="difflineplus">+static int MimeInlineTextPlain_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l102.338"></a><span id="l102.338">   int status;</span>
<a href="#l102.339"></a><span id="l102.339"> </span>
<a href="#l102.340"></a><span id="l102.340">   // Has this method already been called for this object?</span>
<a href="#l102.341"></a><span id="l102.341">   // In that case return.</span>
<a href="#l102.342"></a><span id="l102.342">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l102.343"></a><span id="l102.343"> </span>
<a href="#l102.344"></a><span id="l102.344">   nsCString citationColor;</span>
<a href="#l102.345"></a><span id="l102.345" class="difflineminus">-  MimeInlineTextPlain *text = (MimeInlineTextPlain *) obj;</span>
<a href="#l102.346"></a><span id="l102.346" class="difflineplus">+  MimeInlineTextPlain *text = (MimeInlineTextPlain *)obj;</span>
<a href="#l102.347"></a><span id="l102.347">   if (text &amp;&amp; !text-&gt;mCitationColor.IsEmpty())</span>
<a href="#l102.348"></a><span id="l102.348">     citationColor = text-&gt;mCitationColor;</span>
<a href="#l102.349"></a><span id="l102.349"> </span>
<a href="#l102.350"></a><span id="l102.350" class="difflineminus">-  bool quoting = ( obj-&gt;options</span>
<a href="#l102.351"></a><span id="l102.351" class="difflineminus">-    &amp;&amp; ( obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l102.352"></a><span id="l102.352" class="difflineminus">-         obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting</span>
<a href="#l102.353"></a><span id="l102.353" class="difflineminus">-       )           );  // see above</span>
<a href="#l102.354"></a><span id="l102.354" class="difflineplus">+  bool quoting =</span>
<a href="#l102.355"></a><span id="l102.355" class="difflineplus">+      (obj-&gt;options &amp;&amp;</span>
<a href="#l102.356"></a><span id="l102.356" class="difflineplus">+       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l102.357"></a><span id="l102.357" class="difflineplus">+        obj-&gt;options-&gt;format_out ==</span>
<a href="#l102.358"></a><span id="l102.358" class="difflineplus">+            nsMimeOutput::nsMimeMessageBodyQuoting));  // see above</span>
<a href="#l102.359"></a><span id="l102.359"> </span>
<a href="#l102.360"></a><span id="l102.360" class="difflineminus">-  bool rawPlainText = obj-&gt;options &amp;&amp;</span>
<a href="#l102.361"></a><span id="l102.361" class="difflineminus">-       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageFilterSniffer</span>
<a href="#l102.362"></a><span id="l102.362" class="difflineminus">-        || obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach);</span>
<a href="#l102.363"></a><span id="l102.363" class="difflineplus">+  bool rawPlainText =</span>
<a href="#l102.364"></a><span id="l102.364" class="difflineplus">+      obj-&gt;options &amp;&amp;</span>
<a href="#l102.365"></a><span id="l102.365" class="difflineplus">+      (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageFilterSniffer ||</span>
<a href="#l102.366"></a><span id="l102.366" class="difflineplus">+       obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach);</span>
<a href="#l102.367"></a><span id="l102.367"> </span>
<a href="#l102.368"></a><span id="l102.368">   /* Run parent method first, to flush out any buffered data. */</span>
<a href="#l102.369"></a><span id="l102.369" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l102.370"></a><span id="l102.370" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l102.371"></a><span id="l102.371">   if (status &lt; 0) return status;</span>
<a href="#l102.372"></a><span id="l102.372"> </span>
<a href="#l102.373"></a><span id="l102.373">   if (!obj-&gt;output_p) return 0;</span>
<a href="#l102.374"></a><span id="l102.374"> </span>
<a href="#l102.375"></a><span id="l102.375" class="difflineminus">-  if (obj-&gt;options &amp;&amp;</span>
<a href="#l102.376"></a><span id="l102.376" class="difflineminus">-    obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l102.377"></a><span id="l102.377" class="difflineminus">-    obj-&gt;options-&gt;output_fn &amp;&amp;</span>
<a href="#l102.378"></a><span id="l102.378" class="difflineminus">-    !abort_p &amp;&amp; !rawPlainText)</span>
<a href="#l102.379"></a><span id="l102.379" class="difflineminus">-  {</span>
<a href="#l102.380"></a><span id="l102.380" class="difflineminus">-      MimeInlineTextPlain *text = (MimeInlineTextPlain *) obj;</span>
<a href="#l102.381"></a><span id="l102.381" class="difflineminus">-      if (text-&gt;mIsSig &amp;&amp; !quoting)</span>
<a href="#l102.382"></a><span id="l102.382" class="difflineminus">-      {</span>
<a href="#l102.383"></a><span id="l102.383" class="difflineminus">-        status = MimeObject_write(obj, &quot;&lt;/div&gt;&quot;, 6, false);  // .moz-txt-sig</span>
<a href="#l102.384"></a><span id="l102.384" class="difflineminus">-        if (status &lt; 0) return status;</span>
<a href="#l102.385"></a><span id="l102.385" class="difflineminus">-      }</span>
<a href="#l102.386"></a><span id="l102.386" class="difflineminus">-      status = MimeObject_write(obj, &quot;&lt;/pre&gt;&quot;, 6, false);</span>
<a href="#l102.387"></a><span id="l102.387" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;write_html_p &amp;&amp; obj-&gt;options-&gt;output_fn &amp;&amp;</span>
<a href="#l102.388"></a><span id="l102.388" class="difflineplus">+      !abort_p &amp;&amp; !rawPlainText) {</span>
<a href="#l102.389"></a><span id="l102.389" class="difflineplus">+    MimeInlineTextPlain *text = (MimeInlineTextPlain *)obj;</span>
<a href="#l102.390"></a><span id="l102.390" class="difflineplus">+    if (text-&gt;mIsSig &amp;&amp; !quoting) {</span>
<a href="#l102.391"></a><span id="l102.391" class="difflineplus">+      status = MimeObject_write(obj, &quot;&lt;/div&gt;&quot;, 6, false);  // .moz-txt-sig</span>
<a href="#l102.392"></a><span id="l102.392">       if (status &lt; 0) return status;</span>
<a href="#l102.393"></a><span id="l102.393" class="difflineminus">-      if (!quoting)</span>
<a href="#l102.394"></a><span id="l102.394" class="difflineminus">-      {</span>
<a href="#l102.395"></a><span id="l102.395" class="difflineminus">-        status = MimeObject_write(obj, &quot;&lt;/div&gt;&quot;, 6, false);</span>
<a href="#l102.396"></a><span id="l102.396" class="difflineminus">-                                        // .moz-text-plain</span>
<a href="#l102.397"></a><span id="l102.397" class="difflineminus">-        if (status &lt; 0) return status;</span>
<a href="#l102.398"></a><span id="l102.398" class="difflineminus">-      }</span>
<a href="#l102.399"></a><span id="l102.399" class="difflineplus">+    }</span>
<a href="#l102.400"></a><span id="l102.400" class="difflineplus">+    status = MimeObject_write(obj, &quot;&lt;/pre&gt;&quot;, 6, false);</span>
<a href="#l102.401"></a><span id="l102.401" class="difflineplus">+    if (status &lt; 0) return status;</span>
<a href="#l102.402"></a><span id="l102.402" class="difflineplus">+    if (!quoting) {</span>
<a href="#l102.403"></a><span id="l102.403" class="difflineplus">+      status = MimeObject_write(obj, &quot;&lt;/div&gt;&quot;, 6, false);</span>
<a href="#l102.404"></a><span id="l102.404" class="difflineplus">+      // .moz-text-plain</span>
<a href="#l102.405"></a><span id="l102.405" class="difflineplus">+      if (status &lt; 0) return status;</span>
<a href="#l102.406"></a><span id="l102.406" class="difflineplus">+    }</span>
<a href="#l102.407"></a><span id="l102.407"> </span>
<a href="#l102.408"></a><span id="l102.408" class="difflineminus">-      /* text/plain objects always have separators before and after them.</span>
<a href="#l102.409"></a><span id="l102.409" class="difflineminus">-     Note that this is not the case for text/enriched objects.</span>
<a href="#l102.410"></a><span id="l102.410" class="difflineminus">-     */</span>
<a href="#l102.411"></a><span id="l102.411" class="difflineplus">+    /* text/plain objects always have separators before and after them.</span>
<a href="#l102.412"></a><span id="l102.412" class="difflineplus">+   Note that this is not the case for text/enriched objects.</span>
<a href="#l102.413"></a><span id="l102.413" class="difflineplus">+   */</span>
<a href="#l102.414"></a><span id="l102.414">     status = MimeObject_write_separator(obj);</span>
<a href="#l102.415"></a><span id="l102.415">     if (status &lt; 0) return status;</span>
<a href="#l102.416"></a><span id="l102.416">   }</span>
<a href="#l102.417"></a><span id="l102.417"> </span>
<a href="#l102.418"></a><span id="l102.418">   return 0;</span>
<a href="#l102.419"></a><span id="l102.419"> }</span>
<a href="#l102.420"></a><span id="l102.420"> </span>
<a href="#l102.421"></a><span id="l102.421" class="difflineminus">-</span>
<a href="#l102.422"></a><span id="l102.422" class="difflineminus">-static int</span>
<a href="#l102.423"></a><span id="l102.423" class="difflineminus">-MimeInlineTextPlain_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l102.424"></a><span id="l102.424" class="difflineminus">-{</span>
<a href="#l102.425"></a><span id="l102.425" class="difflineplus">+static int MimeInlineTextPlain_parse_line(const char *line, int32_t length,</span>
<a href="#l102.426"></a><span id="l102.426" class="difflineplus">+                                          MimeObject *obj) {</span>
<a href="#l102.427"></a><span id="l102.427">   int status;</span>
<a href="#l102.428"></a><span id="l102.428" class="difflineminus">-  bool quoting = ( obj-&gt;options</span>
<a href="#l102.429"></a><span id="l102.429" class="difflineminus">-    &amp;&amp; ( obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l102.430"></a><span id="l102.430" class="difflineminus">-         obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting</span>
<a href="#l102.431"></a><span id="l102.431" class="difflineminus">-       )           );  // see above</span>
<a href="#l102.432"></a><span id="l102.432" class="difflineminus">-  bool plainHTML = quoting || (obj-&gt;options &amp;&amp;</span>
<a href="#l102.433"></a><span id="l102.433" class="difflineminus">-       obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs);</span>
<a href="#l102.434"></a><span id="l102.434" class="difflineminus">-       // see above</span>
<a href="#l102.435"></a><span id="l102.435" class="difflineplus">+  bool quoting =</span>
<a href="#l102.436"></a><span id="l102.436" class="difflineplus">+      (obj-&gt;options &amp;&amp;</span>
<a href="#l102.437"></a><span id="l102.437" class="difflineplus">+       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span>
<a href="#l102.438"></a><span id="l102.438" class="difflineplus">+        obj-&gt;options-&gt;format_out ==</span>
<a href="#l102.439"></a><span id="l102.439" class="difflineplus">+            nsMimeOutput::nsMimeMessageBodyQuoting));  // see above</span>
<a href="#l102.440"></a><span id="l102.440" class="difflineplus">+  bool plainHTML =</span>
<a href="#l102.441"></a><span id="l102.441" class="difflineplus">+      quoting || (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;format_out ==</span>
<a href="#l102.442"></a><span id="l102.442" class="difflineplus">+                                      nsMimeOutput::nsMimeMessageSaveAs);</span>
<a href="#l102.443"></a><span id="l102.443" class="difflineplus">+  // see above</span>
<a href="#l102.444"></a><span id="l102.444"> </span>
<a href="#l102.445"></a><span id="l102.445" class="difflineminus">-  bool rawPlainText = obj-&gt;options &amp;&amp;</span>
<a href="#l102.446"></a><span id="l102.446" class="difflineminus">-       (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageFilterSniffer</span>
<a href="#l102.447"></a><span id="l102.447" class="difflineminus">-       || obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach);</span>
<a href="#l102.448"></a><span id="l102.448" class="difflineplus">+  bool rawPlainText =</span>
<a href="#l102.449"></a><span id="l102.449" class="difflineplus">+      obj-&gt;options &amp;&amp;</span>
<a href="#l102.450"></a><span id="l102.450" class="difflineplus">+      (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageFilterSniffer ||</span>
<a href="#l102.451"></a><span id="l102.451" class="difflineplus">+       obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach);</span>
<a href="#l102.452"></a><span id="l102.452"> </span>
<a href="#l102.453"></a><span id="l102.453">   // this routine gets called for every line of data that comes through the</span>
<a href="#l102.454"></a><span id="l102.454">   // mime converter. It's important to make sure we are efficient with</span>
<a href="#l102.455"></a><span id="l102.455">   // how we allocate memory in this routine. be careful if you go to add</span>
<a href="#l102.456"></a><span id="l102.456">   // more to this routine.</span>
<a href="#l102.457"></a><span id="l102.457"> </span>
<a href="#l102.458"></a><span id="l102.458">   NS_ASSERTION(length &gt; 0, &quot;zero length&quot;);</span>
<a href="#l102.459"></a><span id="l102.459">   if (length &lt;= 0) return 0;</span>
<a href="#l102.460"></a><span id="l102.460"> </span>
<a href="#l102.461"></a><span id="l102.461">   mozITXTToHTMLConv *conv = GetTextConverter(obj-&gt;options);</span>
<a href="#l102.462"></a><span id="l102.462" class="difflineminus">-  MimeInlineTextPlain *text = (MimeInlineTextPlain *) obj;</span>
<a href="#l102.463"></a><span id="l102.463" class="difflineplus">+  MimeInlineTextPlain *text = (MimeInlineTextPlain *)obj;</span>
<a href="#l102.464"></a><span id="l102.464"> </span>
<a href="#l102.465"></a><span id="l102.465">   bool skipConversion = !conv || rawPlainText ||</span>
<a href="#l102.466"></a><span id="l102.466" class="difflineminus">-                          (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;force_user_charset);</span>
<a href="#l102.467"></a><span id="l102.467" class="difflineplus">+                        (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;force_user_charset);</span>
<a href="#l102.468"></a><span id="l102.468"> </span>
<a href="#l102.469"></a><span id="l102.469">   char *mailCharset = NULL;</span>
<a href="#l102.470"></a><span id="l102.470">   nsresult rv;</span>
<a href="#l102.471"></a><span id="l102.471"> </span>
<a href="#l102.472"></a><span id="l102.472" class="difflineminus">-  if (!skipConversion)</span>
<a href="#l102.473"></a><span id="l102.473" class="difflineminus">-  {</span>
<a href="#l102.474"></a><span id="l102.474" class="difflineplus">+  if (!skipConversion) {</span>
<a href="#l102.475"></a><span id="l102.475">     nsDependentCString inputStr(line, length);</span>
<a href="#l102.476"></a><span id="l102.476">     nsAutoString lineSourceStr;</span>
<a href="#l102.477"></a><span id="l102.477"> </span>
<a href="#l102.478"></a><span id="l102.478">     // For 'SaveAs', |line| is in |mailCharset|.</span>
<a href="#l102.479"></a><span id="l102.479">     // convert |line| to UTF-16 before 'html'izing (calling ScanTXT())</span>
<a href="#l102.480"></a><span id="l102.480" class="difflineminus">-    if (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs)</span>
<a href="#l102.481"></a><span id="l102.481" class="difflineminus">-    { // Get the mail charset of this message.</span>
<a href="#l102.482"></a><span id="l102.482" class="difflineminus">-      MimeInlineText  *inlinetext = (MimeInlineText *) obj;</span>
<a href="#l102.483"></a><span id="l102.483" class="difflineplus">+    if (obj-&gt;options-&gt;format_out ==</span>
<a href="#l102.484"></a><span id="l102.484" class="difflineplus">+        nsMimeOutput::nsMimeMessageSaveAs) {  // Get the mail charset of this</span>
<a href="#l102.485"></a><span id="l102.485" class="difflineplus">+                                              // message.</span>
<a href="#l102.486"></a><span id="l102.486" class="difflineplus">+      MimeInlineText *inlinetext = (MimeInlineText *)obj;</span>
<a href="#l102.487"></a><span id="l102.487">       if (!inlinetext-&gt;initializeCharset)</span>
<a href="#l102.488"></a><span id="l102.488" class="difflineminus">-         ((MimeInlineTextClass*)&amp;mimeInlineTextClass)-&gt;initialize_charset(obj);</span>
<a href="#l102.489"></a><span id="l102.489" class="difflineplus">+        ((MimeInlineTextClass *)&amp;mimeInlineTextClass)-&gt;initialize_charset(obj);</span>
<a href="#l102.490"></a><span id="l102.490">       mailCharset = inlinetext-&gt;charset;</span>
<a href="#l102.491"></a><span id="l102.491">       if (mailCharset &amp;&amp; *mailCharset) {</span>
<a href="#l102.492"></a><span id="l102.492">         rv = nsMsgI18NConvertToUnicode(nsDependentCString(mailCharset),</span>
<a href="#l102.493"></a><span id="l102.493" class="difflineminus">-                                       inputStr,</span>
<a href="#l102.494"></a><span id="l102.494" class="difflineminus">-                                       lineSourceStr);</span>
<a href="#l102.495"></a><span id="l102.495" class="difflineplus">+                                       inputStr, lineSourceStr);</span>
<a href="#l102.496"></a><span id="l102.496">         NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l102.497"></a><span id="l102.497" class="difflineminus">-      }</span>
<a href="#l102.498"></a><span id="l102.498" class="difflineminus">-      else // this probably never happens ...</span>
<a href="#l102.499"></a><span id="l102.499" class="difflineplus">+      } else  // this probably never happens ...</span>
<a href="#l102.500"></a><span id="l102.500">         CopyUTF8toUTF16(inputStr, lineSourceStr);</span>
<a href="#l102.501"></a><span id="l102.501" class="difflineminus">-    }</span>
<a href="#l102.502"></a><span id="l102.502" class="difflineminus">-    else  // line is in UTF-8</span>
<a href="#l102.503"></a><span id="l102.503" class="difflineplus">+    } else  // line is in UTF-8</span>
<a href="#l102.504"></a><span id="l102.504">       CopyUTF8toUTF16(inputStr, lineSourceStr);</span>
<a href="#l102.505"></a><span id="l102.505"> </span>
<a href="#l102.506"></a><span id="l102.506">     nsAutoCString prefaceResultStr;  // Quoting stuff before the real text</span>
<a href="#l102.507"></a><span id="l102.507"> </span>
<a href="#l102.508"></a><span id="l102.508">     // Recognize quotes</span>
<a href="#l102.509"></a><span id="l102.509">     uint32_t oldCiteLevel = text-&gt;mCiteLevel;</span>
<a href="#l102.510"></a><span id="l102.510">     uint32_t logicalLineStart = 0;</span>
<a href="#l102.511"></a><span id="l102.511" class="difflineminus">-    rv = conv-&gt;CiteLevelTXT(lineSourceStr.get(),</span>
<a href="#l102.512"></a><span id="l102.512" class="difflineminus">-                            &amp;logicalLineStart, &amp;(text-&gt;mCiteLevel));</span>
<a href="#l102.513"></a><span id="l102.513" class="difflineplus">+    rv = conv-&gt;CiteLevelTXT(lineSourceStr.get(), &amp;logicalLineStart,</span>
<a href="#l102.514"></a><span id="l102.514" class="difflineplus">+                            &amp;(text-&gt;mCiteLevel));</span>
<a href="#l102.515"></a><span id="l102.515">     NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l102.516"></a><span id="l102.516"> </span>
<a href="#l102.517"></a><span id="l102.517">     // Find out, which recognitions to do</span>
<a href="#l102.518"></a><span id="l102.518">     uint32_t whattodo = obj-&gt;options-&gt;whattodo;</span>
<a href="#l102.519"></a><span id="l102.519" class="difflineminus">-    if (plainHTML)</span>
<a href="#l102.520"></a><span id="l102.520" class="difflineminus">-    {</span>
<a href="#l102.521"></a><span id="l102.521" class="difflineplus">+    if (plainHTML) {</span>
<a href="#l102.522"></a><span id="l102.522">       if (quoting)</span>
<a href="#l102.523"></a><span id="l102.523">         whattodo = 0;  // This is done on Send. Don't do it twice.</span>
<a href="#l102.524"></a><span id="l102.524">       else</span>
<a href="#l102.525"></a><span id="l102.525">         whattodo = whattodo &amp; ~mozITXTToHTMLConv::kGlyphSubstitution;</span>
<a href="#l102.526"></a><span id="l102.526" class="difflineminus">-                   /* Do recognition for the case, the result is viewed in</span>
<a href="#l102.527"></a><span id="l102.527" class="difflineminus">-                      Mozilla, but not GlyphSubstitution, because other UAs</span>
<a href="#l102.528"></a><span id="l102.528" class="difflineminus">-                      might not be able to display the glyphs. */</span>
<a href="#l102.529"></a><span id="l102.529" class="difflineminus">-      if (!text-&gt;mBlockquoting)</span>
<a href="#l102.530"></a><span id="l102.530" class="difflineminus">-        text-&gt;mCiteLevel = 0;</span>
<a href="#l102.531"></a><span id="l102.531" class="difflineplus">+      /* Do recognition for the case, the result is viewed in</span>
<a href="#l102.532"></a><span id="l102.532" class="difflineplus">+         Mozilla, but not GlyphSubstitution, because other UAs</span>
<a href="#l102.533"></a><span id="l102.533" class="difflineplus">+         might not be able to display the glyphs. */</span>
<a href="#l102.534"></a><span id="l102.534" class="difflineplus">+      if (!text-&gt;mBlockquoting) text-&gt;mCiteLevel = 0;</span>
<a href="#l102.535"></a><span id="l102.535">     }</span>
<a href="#l102.536"></a><span id="l102.536"> </span>
<a href="#l102.537"></a><span id="l102.537">     // Write blockquote</span>
<a href="#l102.538"></a><span id="l102.538" class="difflineminus">-    if (text-&gt;mCiteLevel &gt; oldCiteLevel)</span>
<a href="#l102.539"></a><span id="l102.539" class="difflineminus">-    {</span>
<a href="#l102.540"></a><span id="l102.540" class="difflineplus">+    if (text-&gt;mCiteLevel &gt; oldCiteLevel) {</span>
<a href="#l102.541"></a><span id="l102.541">       prefaceResultStr += &quot;&lt;/pre&gt;&quot;;</span>
<a href="#l102.542"></a><span id="l102.542" class="difflineminus">-      for (uint32_t i = 0; i &lt; text-&gt;mCiteLevel - oldCiteLevel; i++)</span>
<a href="#l102.543"></a><span id="l102.543" class="difflineminus">-      {</span>
<a href="#l102.544"></a><span id="l102.544" class="difflineplus">+      for (uint32_t i = 0; i &lt; text-&gt;mCiteLevel - oldCiteLevel; i++) {</span>
<a href="#l102.545"></a><span id="l102.545">         nsAutoCString style;</span>
<a href="#l102.546"></a><span id="l102.546" class="difflineminus">-        MimeTextBuildPrefixCSS(text-&gt;mQuotedSizeSetting, text-&gt;mQuotedStyleSetting,</span>
<a href="#l102.547"></a><span id="l102.547" class="difflineminus">-                               text-&gt;mCitationColor, style);</span>
<a href="#l102.548"></a><span id="l102.548" class="difflineminus">-        if (!plainHTML &amp;&amp; !style.IsEmpty())</span>
<a href="#l102.549"></a><span id="l102.549" class="difflineminus">-        {</span>
<a href="#l102.550"></a><span id="l102.550" class="difflineplus">+        MimeTextBuildPrefixCSS(text-&gt;mQuotedSizeSetting,</span>
<a href="#l102.551"></a><span id="l102.551" class="difflineplus">+                               text-&gt;mQuotedStyleSetting, text-&gt;mCitationColor,</span>
<a href="#l102.552"></a><span id="l102.552" class="difflineplus">+                               style);</span>
<a href="#l102.553"></a><span id="l102.553" class="difflineplus">+        if (!plainHTML &amp;&amp; !style.IsEmpty()) {</span>
<a href="#l102.554"></a><span id="l102.554">           prefaceResultStr += &quot;&lt;blockquote type=cite style=\&quot;&quot;;</span>
<a href="#l102.555"></a><span id="l102.555">           prefaceResultStr += style;</span>
<a href="#l102.556"></a><span id="l102.556">           prefaceResultStr += &quot;\&quot;&gt;&quot;;</span>
<a href="#l102.557"></a><span id="l102.557" class="difflineminus">-        }</span>
<a href="#l102.558"></a><span id="l102.558" class="difflineminus">-        else</span>
<a href="#l102.559"></a><span id="l102.559" class="difflineplus">+        } else</span>
<a href="#l102.560"></a><span id="l102.560">           prefaceResultStr += &quot;&lt;blockquote type=cite&gt;&quot;;</span>
<a href="#l102.561"></a><span id="l102.561">       }</span>
<a href="#l102.562"></a><span id="l102.562">       prefaceResultStr += &quot;&lt;pre wrap class=\&quot;moz-quote-pre\&quot;&gt;\n&quot;;</span>
<a href="#l102.563"></a><span id="l102.563" class="difflineminus">-    }</span>
<a href="#l102.564"></a><span id="l102.564" class="difflineminus">-    else if (text-&gt;mCiteLevel &lt; oldCiteLevel)</span>
<a href="#l102.565"></a><span id="l102.565" class="difflineminus">-    {</span>
<a href="#l102.566"></a><span id="l102.566" class="difflineplus">+    } else if (text-&gt;mCiteLevel &lt; oldCiteLevel) {</span>
<a href="#l102.567"></a><span id="l102.567">       prefaceResultStr += &quot;&lt;/pre&gt;&quot;;</span>
<a href="#l102.568"></a><span id="l102.568">       for (uint32_t i = 0; i &lt; oldCiteLevel - text-&gt;mCiteLevel; i++)</span>
<a href="#l102.569"></a><span id="l102.569">         prefaceResultStr += &quot;&lt;/blockquote&gt;&quot;;</span>
<a href="#l102.570"></a><span id="l102.570">       prefaceResultStr += &quot;&lt;pre wrap class=\&quot;moz-quote-pre\&quot;&gt;\n&quot;;</span>
<a href="#l102.571"></a><span id="l102.571">     }</span>
<a href="#l102.572"></a><span id="l102.572"> </span>
<a href="#l102.573"></a><span id="l102.573">     // Write plain text quoting tags</span>
<a href="#l102.574"></a><span id="l102.574" class="difflineminus">-    if (logicalLineStart != 0 &amp;&amp; !(plainHTML &amp;&amp; text-&gt;mBlockquoting))</span>
<a href="#l102.575"></a><span id="l102.575" class="difflineminus">-    {</span>
<a href="#l102.576"></a><span id="l102.576" class="difflineminus">-      if (!plainHTML)</span>
<a href="#l102.577"></a><span id="l102.577" class="difflineminus">-        prefaceResultStr += &quot;&lt;span class=\&quot;moz-txt-citetags\&quot;&gt;&quot;;</span>
<a href="#l102.578"></a><span id="l102.578" class="difflineplus">+    if (logicalLineStart != 0 &amp;&amp; !(plainHTML &amp;&amp; text-&gt;mBlockquoting)) {</span>
<a href="#l102.579"></a><span id="l102.579" class="difflineplus">+      if (!plainHTML) prefaceResultStr += &quot;&lt;span class=\&quot;moz-txt-citetags\&quot;&gt;&quot;;</span>
<a href="#l102.580"></a><span id="l102.580"> </span>
<a href="#l102.581"></a><span id="l102.581">       nsString citeTagsSource(StringHead(lineSourceStr, logicalLineStart));</span>
<a href="#l102.582"></a><span id="l102.582"> </span>
<a href="#l102.583"></a><span id="l102.583">       // Convert to HTML</span>
<a href="#l102.584"></a><span id="l102.584">       nsString citeTagsResultUnichar;</span>
<a href="#l102.585"></a><span id="l102.585">       rv = conv-&gt;ScanTXT(citeTagsSource, 0 /* no recognition */,</span>
<a href="#l102.586"></a><span id="l102.586">                          citeTagsResultUnichar);</span>
<a href="#l102.587"></a><span id="l102.587">       if (NS_FAILED(rv)) return -1;</span>
<a href="#l102.588"></a><span id="l102.588"> </span>
<a href="#l102.589"></a><span id="l102.589">       prefaceResultStr.Append(NS_ConvertUTF16toUTF8(citeTagsResultUnichar));</span>
<a href="#l102.590"></a><span id="l102.590" class="difflineminus">-      if (!plainHTML)</span>
<a href="#l102.591"></a><span id="l102.591" class="difflineminus">-        prefaceResultStr += &quot;&lt;/span&gt;&quot;;</span>
<a href="#l102.592"></a><span id="l102.592" class="difflineplus">+      if (!plainHTML) prefaceResultStr += &quot;&lt;/span&gt;&quot;;</span>
<a href="#l102.593"></a><span id="l102.593">     }</span>
<a href="#l102.594"></a><span id="l102.594"> </span>
<a href="#l102.595"></a><span id="l102.595" class="difflineminus">-</span>
<a href="#l102.596"></a><span id="l102.596">     // recognize signature</span>
<a href="#l102.597"></a><span id="l102.597" class="difflineminus">-    if ((lineSourceStr.Length() &gt;= 4)</span>
<a href="#l102.598"></a><span id="l102.598" class="difflineminus">-        &amp;&amp; lineSourceStr.First() == '-'</span>
<a href="#l102.599"></a><span id="l102.599" class="difflineminus">-        &amp;&amp; Substring(lineSourceStr, 0, 3).EqualsLiteral(&quot;-- &quot;)</span>
<a href="#l102.600"></a><span id="l102.600" class="difflineminus">-        &amp;&amp; (lineSourceStr[3] == '\r' || lineSourceStr[3] == '\n') )</span>
<a href="#l102.601"></a><span id="l102.601" class="difflineminus">-    {</span>
<a href="#l102.602"></a><span id="l102.602" class="difflineplus">+    if ((lineSourceStr.Length() &gt;= 4) &amp;&amp; lineSourceStr.First() == '-' &amp;&amp;</span>
<a href="#l102.603"></a><span id="l102.603" class="difflineplus">+        Substring(lineSourceStr, 0, 3).EqualsLiteral(&quot;-- &quot;) &amp;&amp;</span>
<a href="#l102.604"></a><span id="l102.604" class="difflineplus">+        (lineSourceStr[3] == '\r' || lineSourceStr[3] == '\n')) {</span>
<a href="#l102.605"></a><span id="l102.605">       text-&gt;mIsSig = true;</span>
<a href="#l102.606"></a><span id="l102.606" class="difflineminus">-      if (!quoting)</span>
<a href="#l102.607"></a><span id="l102.607" class="difflineminus">-        prefaceResultStr += &quot;&lt;div class=\&quot;moz-txt-sig\&quot;&gt;&quot;;</span>
<a href="#l102.608"></a><span id="l102.608" class="difflineplus">+      if (!quoting) prefaceResultStr += &quot;&lt;div class=\&quot;moz-txt-sig\&quot;&gt;&quot;;</span>
<a href="#l102.609"></a><span id="l102.609">     }</span>
<a href="#l102.610"></a><span id="l102.610"> </span>
<a href="#l102.611"></a><span id="l102.611" class="difflineminus">-</span>
<a href="#l102.612"></a><span id="l102.612">     /* This is the main TXT to HTML conversion:</span>
<a href="#l102.613"></a><span id="l102.613">        escaping (very important), eventually recognizing etc. */</span>
<a href="#l102.614"></a><span id="l102.614">     nsString lineResultUnichar;</span>
<a href="#l102.615"></a><span id="l102.615"> </span>
<a href="#l102.616"></a><span id="l102.616" class="difflineminus">-    rv = conv-&gt;ScanTXT(Substring(lineSourceStr, logicalLineStart), whattodo, lineResultUnichar);</span>
<a href="#l102.617"></a><span id="l102.617" class="difflineplus">+    rv = conv-&gt;ScanTXT(Substring(lineSourceStr, logicalLineStart), whattodo,</span>
<a href="#l102.618"></a><span id="l102.618" class="difflineplus">+                       lineResultUnichar);</span>
<a href="#l102.619"></a><span id="l102.619">     NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l102.620"></a><span id="l102.620"> </span>
<a href="#l102.621"></a><span id="l102.621" class="difflineminus">-    if (!(text-&gt;mIsSig &amp;&amp; quoting &amp;&amp; text-&gt;mStripSig))</span>
<a href="#l102.622"></a><span id="l102.622" class="difflineminus">-    {</span>
<a href="#l102.623"></a><span id="l102.623" class="difflineminus">-      status = MimeObject_write(obj, prefaceResultStr.get(), prefaceResultStr.Length(), true);</span>
<a href="#l102.624"></a><span id="l102.624" class="difflineplus">+    if (!(text-&gt;mIsSig &amp;&amp; quoting &amp;&amp; text-&gt;mStripSig)) {</span>
<a href="#l102.625"></a><span id="l102.625" class="difflineplus">+      status = MimeObject_write(obj, prefaceResultStr.get(),</span>
<a href="#l102.626"></a><span id="l102.626" class="difflineplus">+                                prefaceResultStr.Length(), true);</span>
<a href="#l102.627"></a><span id="l102.627">       if (status &lt; 0) return status;</span>
<a href="#l102.628"></a><span id="l102.628">       nsAutoCString outString;</span>
<a href="#l102.629"></a><span id="l102.629">       if (obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageSaveAs ||</span>
<a href="#l102.630"></a><span id="l102.630">           !mailCharset || !*mailCharset)</span>
<a href="#l102.631"></a><span id="l102.631">         CopyUTF16toUTF8(lineResultUnichar, outString);</span>
<a href="#l102.632"></a><span id="l102.632" class="difflineminus">-      else</span>
<a href="#l102.633"></a><span id="l102.633" class="difflineminus">-      { // convert back to mailCharset before writing.</span>
<a href="#l102.634"></a><span id="l102.634" class="difflineplus">+      else {  // convert back to mailCharset before writing.</span>
<a href="#l102.635"></a><span id="l102.635">         rv = nsMsgI18NConvertFromUnicode(nsDependentCString(mailCharset),</span>
<a href="#l102.636"></a><span id="l102.636" class="difflineminus">-                                         lineResultUnichar,</span>
<a href="#l102.637"></a><span id="l102.637" class="difflineminus">-                                         outString);</span>
<a href="#l102.638"></a><span id="l102.638" class="difflineplus">+                                         lineResultUnichar, outString);</span>
<a href="#l102.639"></a><span id="l102.639">         NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l102.640"></a><span id="l102.640">       }</span>
<a href="#l102.641"></a><span id="l102.641"> </span>
<a href="#l102.642"></a><span id="l102.642">       status = MimeObject_write(obj, outString.get(), outString.Length(), true);</span>
<a href="#l102.643"></a><span id="l102.643" class="difflineminus">-    }</span>
<a href="#l102.644"></a><span id="l102.644" class="difflineminus">-    else</span>
<a href="#l102.645"></a><span id="l102.645" class="difflineminus">-    {</span>
<a href="#l102.646"></a><span id="l102.646" class="difflineplus">+    } else {</span>
<a href="#l102.647"></a><span id="l102.647">       status = 0;</span>
<a href="#l102.648"></a><span id="l102.648">     }</span>
<a href="#l102.649"></a><span id="l102.649" class="difflineminus">-  }</span>
<a href="#l102.650"></a><span id="l102.650" class="difflineminus">-  else</span>
<a href="#l102.651"></a><span id="l102.651" class="difflineminus">-  {</span>
<a href="#l102.652"></a><span id="l102.652" class="difflineplus">+  } else {</span>
<a href="#l102.653"></a><span id="l102.653">     status = MimeObject_write(obj, line, length, true);</span>
<a href="#l102.654"></a><span id="l102.654">   }</span>
<a href="#l102.655"></a><span id="l102.655"> </span>
<a href="#l102.656"></a><span id="l102.656">   return status;</span>
<a href="#l102.657"></a><span id="l102.657"> }</span>
<a href="#l102.658"></a><span id="l102.658" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l103.1"></a><span id="l103.1" class="difflineminus">--- a/mailnews/mime/src/mimetpla.h</span>
<a href="#l103.2"></a><span id="l103.2" class="difflineplus">+++ b/mailnews/mime/src/mimetpla.h</span>
<a href="#l103.3"></a><span id="l103.3" class="difflineat">@@ -8,32 +8,32 @@</span>
<a href="#l103.4"></a><span id="l103.4">  */</span>
<a href="#l103.5"></a><span id="l103.5"> </span>
<a href="#l103.6"></a><span id="l103.6"> #ifndef _MIMETPLA_H_</span>
<a href="#l103.7"></a><span id="l103.7"> #define _MIMETPLA_H_</span>
<a href="#l103.8"></a><span id="l103.8"> </span>
<a href="#l103.9"></a><span id="l103.9"> #include &quot;mimetext.h&quot;</span>
<a href="#l103.10"></a><span id="l103.10"> </span>
<a href="#l103.11"></a><span id="l103.11"> typedef struct MimeInlineTextPlainClass MimeInlineTextPlainClass;</span>
<a href="#l103.12"></a><span id="l103.12" class="difflineminus">-typedef struct MimeInlineTextPlain      MimeInlineTextPlain;</span>
<a href="#l103.13"></a><span id="l103.13" class="difflineplus">+typedef struct MimeInlineTextPlain MimeInlineTextPlain;</span>
<a href="#l103.14"></a><span id="l103.14"> </span>
<a href="#l103.15"></a><span id="l103.15"> struct MimeInlineTextPlainClass {</span>
<a href="#l103.16"></a><span id="l103.16">   MimeInlineTextClass text;</span>
<a href="#l103.17"></a><span id="l103.17"> };</span>
<a href="#l103.18"></a><span id="l103.18"> </span>
<a href="#l103.19"></a><span id="l103.19"> extern MimeInlineTextPlainClass mimeInlineTextPlainClass;</span>
<a href="#l103.20"></a><span id="l103.20"> </span>
<a href="#l103.21"></a><span id="l103.21"> struct MimeInlineTextPlain {</span>
<a href="#l103.22"></a><span id="l103.22">   MimeInlineText text;</span>
<a href="#l103.23"></a><span id="l103.23">   uint32_t mCiteLevel;</span>
<a href="#l103.24"></a><span id="l103.24" class="difflineminus">-  bool            mBlockquoting;</span>
<a href="#l103.25"></a><span id="l103.25" class="difflineminus">-  //bool            mInsideQuote;</span>
<a href="#l103.26"></a><span id="l103.26" class="difflineminus">-  int32_t         mQuotedSizeSetting;   // mail.quoted_size</span>
<a href="#l103.27"></a><span id="l103.27" class="difflineminus">-  int32_t         mQuotedStyleSetting;  // mail.quoted_style</span>
<a href="#l103.28"></a><span id="l103.28" class="difflineminus">-  nsCString       mCitationColor;       // mail.citation_color</span>
<a href="#l103.29"></a><span id="l103.29" class="difflineminus">-  bool            mStripSig;            // mail.strip_sig_on_reply</span>
<a href="#l103.30"></a><span id="l103.30" class="difflineminus">-  bool            mIsSig;</span>
<a href="#l103.31"></a><span id="l103.31" class="difflineplus">+  bool mBlockquoting;</span>
<a href="#l103.32"></a><span id="l103.32" class="difflineplus">+  // bool            mInsideQuote;</span>
<a href="#l103.33"></a><span id="l103.33" class="difflineplus">+  int32_t mQuotedSizeSetting;   // mail.quoted_size</span>
<a href="#l103.34"></a><span id="l103.34" class="difflineplus">+  int32_t mQuotedStyleSetting;  // mail.quoted_style</span>
<a href="#l103.35"></a><span id="l103.35" class="difflineplus">+  nsCString mCitationColor;     // mail.citation_color</span>
<a href="#l103.36"></a><span id="l103.36" class="difflineplus">+  bool mStripSig;               // mail.strip_sig_on_reply</span>
<a href="#l103.37"></a><span id="l103.37" class="difflineplus">+  bool mIsSig;</span>
<a href="#l103.38"></a><span id="l103.38"> };</span>
<a href="#l103.39"></a><span id="l103.39"> </span>
<a href="#l103.40"></a><span id="l103.40" class="difflineminus">-#define MimeInlineTextPlainClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l103.41"></a><span id="l103.41" class="difflineminus">-  { MimeInlineTextClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l103.42"></a><span id="l103.42" class="difflineplus">+#define MimeInlineTextPlainClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l103.43"></a><span id="l103.43" class="difflineplus">+  { MimeInlineTextClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l103.44"></a><span id="l103.44"> </span>
<a href="#l103.45"></a><span id="l103.45"> #endif /* _MIMETPLA_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l104.1"></a><span id="l104.1" class="difflineminus">--- a/mailnews/mime/src/mimetric.cpp</span>
<a href="#l104.2"></a><span id="l104.2" class="difflineplus">+++ b/mailnews/mime/src/mimetric.cpp</span>
<a href="#l104.3"></a><span id="l104.3" class="difflineat">@@ -7,43 +7,39 @@</span>
<a href="#l104.4"></a><span id="l104.4"> #include &quot;prmem.h&quot;</span>
<a href="#l104.5"></a><span id="l104.5"> #include &quot;plstr.h&quot;</span>
<a href="#l104.6"></a><span id="l104.6"> #include &quot;prlog.h&quot;</span>
<a href="#l104.7"></a><span id="l104.7"> #include &quot;msgCore.h&quot;</span>
<a href="#l104.8"></a><span id="l104.8"> #include &lt;ctype.h&gt;</span>
<a href="#l104.9"></a><span id="l104.9"> </span>
<a href="#l104.10"></a><span id="l104.10"> #define MIME_SUPERCLASS mimeInlineTextClass</span>
<a href="#l104.11"></a><span id="l104.11"> MimeDefClass(MimeInlineTextRichtext, MimeInlineTextRichtextClass,</span>
<a href="#l104.12"></a><span id="l104.12" class="difflineminus">-       mimeInlineTextRichtextClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l104.13"></a><span id="l104.13" class="difflineplus">+             mimeInlineTextRichtextClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l104.14"></a><span id="l104.14"> </span>
<a href="#l104.15"></a><span id="l104.15" class="difflineminus">-static int MimeInlineTextRichtext_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l104.16"></a><span id="l104.16" class="difflineminus">-static int MimeInlineTextRichtext_parse_begin (MimeObject *);</span>
<a href="#l104.17"></a><span id="l104.17" class="difflineminus">-static int MimeInlineTextRichtext_parse_eof (MimeObject *, bool);</span>
<a href="#l104.18"></a><span id="l104.18" class="difflineplus">+static int MimeInlineTextRichtext_parse_line(const char *, int32_t,</span>
<a href="#l104.19"></a><span id="l104.19" class="difflineplus">+                                             MimeObject *);</span>
<a href="#l104.20"></a><span id="l104.20" class="difflineplus">+static int MimeInlineTextRichtext_parse_begin(MimeObject *);</span>
<a href="#l104.21"></a><span id="l104.21" class="difflineplus">+static int MimeInlineTextRichtext_parse_eof(MimeObject *, bool);</span>
<a href="#l104.22"></a><span id="l104.22"> </span>
<a href="#l104.23"></a><span id="l104.23" class="difflineminus">-static int</span>
<a href="#l104.24"></a><span id="l104.24" class="difflineminus">-MimeInlineTextRichtextClassInitialize(MimeInlineTextRichtextClass *clazz)</span>
<a href="#l104.25"></a><span id="l104.25" class="difflineminus">-{</span>
<a href="#l104.26"></a><span id="l104.26" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l104.27"></a><span id="l104.27" class="difflineplus">+static int MimeInlineTextRichtextClassInitialize(</span>
<a href="#l104.28"></a><span id="l104.28" class="difflineplus">+    MimeInlineTextRichtextClass *clazz) {</span>
<a href="#l104.29"></a><span id="l104.29" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l104.30"></a><span id="l104.30">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l104.31"></a><span id="l104.31">   oclass-&gt;parse_begin = MimeInlineTextRichtext_parse_begin;</span>
<a href="#l104.32"></a><span id="l104.32" class="difflineminus">-  oclass-&gt;parse_line  = MimeInlineTextRichtext_parse_line;</span>
<a href="#l104.33"></a><span id="l104.33" class="difflineminus">-  oclass-&gt;parse_eof   = MimeInlineTextRichtext_parse_eof;</span>
<a href="#l104.34"></a><span id="l104.34" class="difflineplus">+  oclass-&gt;parse_line = MimeInlineTextRichtext_parse_line;</span>
<a href="#l104.35"></a><span id="l104.35" class="difflineplus">+  oclass-&gt;parse_eof = MimeInlineTextRichtext_parse_eof;</span>
<a href="#l104.36"></a><span id="l104.36">   return 0;</span>
<a href="#l104.37"></a><span id="l104.37"> }</span>
<a href="#l104.38"></a><span id="l104.38"> </span>
<a href="#l104.39"></a><span id="l104.39"> /* This function has this clunky interface because it needs to be called</span>
<a href="#l104.40"></a><span id="l104.40">    from outside this module (no MimeObject, etc.)</span>
<a href="#l104.41"></a><span id="l104.41">  */</span>
<a href="#l104.42"></a><span id="l104.42" class="difflineminus">-int</span>
<a href="#l104.43"></a><span id="l104.43" class="difflineminus">-MimeRichtextConvert (const char *line, int32_t length,</span>
<a href="#l104.44"></a><span id="l104.44" class="difflineminus">-           MimeObject *obj,</span>
<a href="#l104.45"></a><span id="l104.45" class="difflineminus">-           char **obufferP,</span>
<a href="#l104.46"></a><span id="l104.46" class="difflineminus">-           int32_t *obuffer_sizeP,</span>
<a href="#l104.47"></a><span id="l104.47" class="difflineminus">-           bool enriched_p)</span>
<a href="#l104.48"></a><span id="l104.48" class="difflineminus">-{</span>
<a href="#l104.49"></a><span id="l104.49" class="difflineplus">+int MimeRichtextConvert(const char *line, int32_t length, MimeObject *obj,</span>
<a href="#l104.50"></a><span id="l104.50" class="difflineplus">+                        char **obufferP, int32_t *obuffer_sizeP,</span>
<a href="#l104.51"></a><span id="l104.51" class="difflineplus">+                        bool enriched_p) {</span>
<a href="#l104.52"></a><span id="l104.52">   /* RFC 1341 (the original MIME spec) defined text/richtext.</span>
<a href="#l104.53"></a><span id="l104.53">    RFC 1563 superseded text/richtext with text/enriched.</span>
<a href="#l104.54"></a><span id="l104.54">    The changes from text/richtext to text/enriched are:</span>
<a href="#l104.55"></a><span id="l104.55">     - CRLF semantics are different</span>
<a href="#l104.56"></a><span id="l104.56">     - &lt;&lt; maps to &lt;</span>
<a href="#l104.57"></a><span id="l104.57">     - These tags were added:</span>
<a href="#l104.58"></a><span id="l104.58">        &lt;VERBATIM&gt;, &lt;NOFILL&gt;, &lt;PARAM&gt;, &lt;FLUSHBOTH&gt;</span>
<a href="#l104.59"></a><span id="l104.59">     - These tags were removed:</span>
<a href="#l104.60"></a><span id="l104.60" class="difflineat">@@ -68,283 +64,294 @@ MimeRichtextConvert (const char *line, i</span>
<a href="#l104.61"></a><span id="l104.61">   const char *last_end;</span>
<a href="#l104.62"></a><span id="l104.62">   const char *this_start;</span>
<a href="#l104.63"></a><span id="l104.63">   const char *this_end;</span>
<a href="#l104.64"></a><span id="l104.64">   unsigned int desired_size;</span>
<a href="#l104.65"></a><span id="l104.65"> </span>
<a href="#l104.66"></a><span id="l104.66">   // The code below must never expand the input by more than 5x;</span>
<a href="#l104.67"></a><span id="l104.67">   // if it does, the desired_size multiplier (5) below must be changed too</span>
<a href="#l104.68"></a><span id="l104.68"> #define BGROWTH 5</span>
<a href="#l104.69"></a><span id="l104.69" class="difflineminus">-  if ( (uint32_t)length &gt;= ( (uint32_t) 0xfffffffe)/BGROWTH )</span>
<a href="#l104.70"></a><span id="l104.70" class="difflineminus">-      return -1;</span>
<a href="#l104.71"></a><span id="l104.71" class="difflineplus">+  if ((uint32_t)length &gt;= ((uint32_t)0xfffffffe) / BGROWTH) return -1;</span>
<a href="#l104.72"></a><span id="l104.72">   desired_size = (length * BGROWTH) + 1;</span>
<a href="#l104.73"></a><span id="l104.73"> #undef BGROWTH</span>
<a href="#l104.74"></a><span id="l104.74" class="difflineminus">-  if (desired_size &gt;= (uint32_t) *obuffer_sizeP)</span>
<a href="#l104.75"></a><span id="l104.75" class="difflineminus">-  status = mime_GrowBuffer (desired_size, sizeof(char), 1024,</span>
<a href="#l104.76"></a><span id="l104.76" class="difflineminus">-               obufferP, obuffer_sizeP);</span>
<a href="#l104.77"></a><span id="l104.77" class="difflineplus">+  if (desired_size &gt;= (uint32_t)*obuffer_sizeP)</span>
<a href="#l104.78"></a><span id="l104.78" class="difflineplus">+    status = mime_GrowBuffer(desired_size, sizeof(char), 1024, obufferP,</span>
<a href="#l104.79"></a><span id="l104.79" class="difflineplus">+                             obuffer_sizeP);</span>
<a href="#l104.80"></a><span id="l104.80">   if (status &lt; 0) return status;</span>
<a href="#l104.81"></a><span id="l104.81"> </span>
<a href="#l104.82"></a><span id="l104.82" class="difflineminus">-  if (enriched_p)</span>
<a href="#l104.83"></a><span id="l104.83" class="difflineminus">-  {</span>
<a href="#l104.84"></a><span id="l104.84" class="difflineplus">+  if (enriched_p) {</span>
<a href="#l104.85"></a><span id="l104.85">     for (this_start = line; this_start &lt; line + length; this_start++)</span>
<a href="#l104.86"></a><span id="l104.86" class="difflineminus">-    if (!IS_SPACE (*this_start)) break;</span>
<a href="#l104.87"></a><span id="l104.87" class="difflineplus">+      if (!IS_SPACE(*this_start)) break;</span>
<a href="#l104.88"></a><span id="l104.88">     if (this_start &gt;= line + length) /* blank line */</span>
<a href="#l104.89"></a><span id="l104.89">     {</span>
<a href="#l104.90"></a><span id="l104.90" class="difflineminus">-      PL_strncpyz (*obufferP, &quot;&lt;BR&gt;&quot;, *obuffer_sizeP);</span>
<a href="#l104.91"></a><span id="l104.91" class="difflineplus">+      PL_strncpyz(*obufferP, &quot;&lt;BR&gt;&quot;, *obuffer_sizeP);</span>
<a href="#l104.92"></a><span id="l104.92">       return MimeObject_write(obj, *obufferP, strlen(*obufferP), true);</span>
<a href="#l104.93"></a><span id="l104.93">     }</span>
<a href="#l104.94"></a><span id="l104.94">   }</span>
<a href="#l104.95"></a><span id="l104.95"> </span>
<a href="#l104.96"></a><span id="l104.96" class="difflineminus">-  uint32_t outlen = (uint32_t) *obuffer_sizeP;</span>
<a href="#l104.97"></a><span id="l104.97" class="difflineplus">+  uint32_t outlen = (uint32_t)*obuffer_sizeP;</span>
<a href="#l104.98"></a><span id="l104.98">   out = *obufferP;</span>
<a href="#l104.99"></a><span id="l104.99">   *out = 0;</span>
<a href="#l104.100"></a><span id="l104.100"> </span>
<a href="#l104.101"></a><span id="l104.101">   data_end = line + length;</span>
<a href="#l104.102"></a><span id="l104.102">   last_end = line;</span>
<a href="#l104.103"></a><span id="l104.103">   this_start = last_end;</span>
<a href="#l104.104"></a><span id="l104.104">   this_end = this_start;</span>
<a href="#l104.105"></a><span id="l104.105">   uint32_t addedlen = 0;</span>
<a href="#l104.106"></a><span id="l104.106" class="difflineminus">-  while (this_end &lt; data_end)</span>
<a href="#l104.107"></a><span id="l104.107" class="difflineminus">-  {</span>
<a href="#l104.108"></a><span id="l104.108" class="difflineplus">+  while (this_end &lt; data_end) {</span>
<a href="#l104.109"></a><span id="l104.109">     /* Skip forward to next special character. */</span>
<a href="#l104.110"></a><span id="l104.110" class="difflineminus">-    while (this_start &lt; data_end &amp;&amp;</span>
<a href="#l104.111"></a><span id="l104.111" class="difflineminus">-       *this_start != '&lt;' &amp;&amp; *this_start != '&gt;' &amp;&amp;</span>
<a href="#l104.112"></a><span id="l104.112" class="difflineminus">-       *this_start != '&amp;')</span>
<a href="#l104.113"></a><span id="l104.113" class="difflineminus">-    this_start++;</span>
<a href="#l104.114"></a><span id="l104.114" class="difflineplus">+    while (this_start &lt; data_end &amp;&amp; *this_start != '&lt;' &amp;&amp; *this_start != '&gt;' &amp;&amp;</span>
<a href="#l104.115"></a><span id="l104.115" class="difflineplus">+           *this_start != '&amp;')</span>
<a href="#l104.116"></a><span id="l104.116" class="difflineplus">+      this_start++;</span>
<a href="#l104.117"></a><span id="l104.117"> </span>
<a href="#l104.118"></a><span id="l104.118">     this_end = this_start;</span>
<a href="#l104.119"></a><span id="l104.119"> </span>
<a href="#l104.120"></a><span id="l104.120">     /* Skip to the end of the tag. */</span>
<a href="#l104.121"></a><span id="l104.121" class="difflineminus">-    if (this_start &lt; data_end &amp;&amp; *this_start == '&lt;')</span>
<a href="#l104.122"></a><span id="l104.122" class="difflineminus">-    {</span>
<a href="#l104.123"></a><span id="l104.123" class="difflineplus">+    if (this_start &lt; data_end &amp;&amp; *this_start == '&lt;') {</span>
<a href="#l104.124"></a><span id="l104.124">       this_end++;</span>
<a href="#l104.125"></a><span id="l104.125" class="difflineminus">-      while (this_end &lt; data_end &amp;&amp;</span>
<a href="#l104.126"></a><span id="l104.126" class="difflineminus">-         !IS_SPACE(*this_end) &amp;&amp;</span>
<a href="#l104.127"></a><span id="l104.127" class="difflineminus">-         *this_end != '&lt;' &amp;&amp; *this_end != '&gt;' &amp;&amp;</span>
<a href="#l104.128"></a><span id="l104.128" class="difflineminus">-         *this_end != '&amp;')</span>
<a href="#l104.129"></a><span id="l104.129" class="difflineminus">-      this_end++;</span>
<a href="#l104.130"></a><span id="l104.130" class="difflineplus">+      while (this_end &lt; data_end &amp;&amp; !IS_SPACE(*this_end) &amp;&amp; *this_end != '&lt;' &amp;&amp;</span>
<a href="#l104.131"></a><span id="l104.131" class="difflineplus">+             *this_end != '&gt;' &amp;&amp; *this_end != '&amp;')</span>
<a href="#l104.132"></a><span id="l104.132" class="difflineplus">+        this_end++;</span>
<a href="#l104.133"></a><span id="l104.133">     }</span>
<a href="#l104.134"></a><span id="l104.134"> </span>
<a href="#l104.135"></a><span id="l104.135">     this_end++;</span>
<a href="#l104.136"></a><span id="l104.136"> </span>
<a href="#l104.137"></a><span id="l104.137">     /* Push out the text preceding the tag. */</span>
<a href="#l104.138"></a><span id="l104.138" class="difflineminus">-    if (last_end &amp;&amp; last_end != this_start)</span>
<a href="#l104.139"></a><span id="l104.139" class="difflineminus">-    {</span>
<a href="#l104.140"></a><span id="l104.140" class="difflineminus">-      memcpy (out, last_end, this_start - last_end);</span>
<a href="#l104.141"></a><span id="l104.141" class="difflineplus">+    if (last_end &amp;&amp; last_end != this_start) {</span>
<a href="#l104.142"></a><span id="l104.142" class="difflineplus">+      memcpy(out, last_end, this_start - last_end);</span>
<a href="#l104.143"></a><span id="l104.143">       out += this_start - last_end;</span>
<a href="#l104.144"></a><span id="l104.144">       *out = 0;</span>
<a href="#l104.145"></a><span id="l104.145">       outlen -= (this_start - last_end);</span>
<a href="#l104.146"></a><span id="l104.146">     }</span>
<a href="#l104.147"></a><span id="l104.147"> </span>
<a href="#l104.148"></a><span id="l104.148">     if (this_start &gt;= data_end)</span>
<a href="#l104.149"></a><span id="l104.149" class="difflineminus">-    break;</span>
<a href="#l104.150"></a><span id="l104.150" class="difflineminus">-    else if (*this_start == '&amp;')</span>
<a href="#l104.151"></a><span id="l104.151" class="difflineminus">-    {</span>
<a href="#l104.152"></a><span id="l104.152" class="difflineminus">-      PL_strncpyz (out, &quot;&amp;amp;&quot;, outlen);</span>
<a href="#l104.153"></a><span id="l104.153" class="difflineplus">+      break;</span>
<a href="#l104.154"></a><span id="l104.154" class="difflineplus">+    else if (*this_start == '&amp;') {</span>
<a href="#l104.155"></a><span id="l104.155" class="difflineplus">+      PL_strncpyz(out, &quot;&amp;amp;&quot;, outlen);</span>
<a href="#l104.156"></a><span id="l104.156">       addedlen = strlen(out);</span>
<a href="#l104.157"></a><span id="l104.157">       outlen -= addedlen;</span>
<a href="#l104.158"></a><span id="l104.158">       out += addedlen;</span>
<a href="#l104.159"></a><span id="l104.159" class="difflineminus">-    }</span>
<a href="#l104.160"></a><span id="l104.160" class="difflineminus">-    else if (*this_start == '&gt;')</span>
<a href="#l104.161"></a><span id="l104.161" class="difflineminus">-    {</span>
<a href="#l104.162"></a><span id="l104.162" class="difflineminus">-      PL_strncpyz (out, &quot;&amp;gt;&quot;, outlen);</span>
<a href="#l104.163"></a><span id="l104.163" class="difflineplus">+    } else if (*this_start == '&gt;') {</span>
<a href="#l104.164"></a><span id="l104.164" class="difflineplus">+      PL_strncpyz(out, &quot;&amp;gt;&quot;, outlen);</span>
<a href="#l104.165"></a><span id="l104.165">       addedlen = strlen(out);</span>
<a href="#l104.166"></a><span id="l104.166">       outlen -= addedlen;</span>
<a href="#l104.167"></a><span id="l104.167">       out += addedlen;</span>
<a href="#l104.168"></a><span id="l104.168" class="difflineminus">-    }</span>
<a href="#l104.169"></a><span id="l104.169" class="difflineminus">-    else if (enriched_p &amp;&amp;</span>
<a href="#l104.170"></a><span id="l104.170" class="difflineminus">-         this_start &lt; data_end + 1 &amp;&amp;</span>
<a href="#l104.171"></a><span id="l104.171" class="difflineminus">-         this_start[0] == '&lt;' &amp;&amp;</span>
<a href="#l104.172"></a><span id="l104.172" class="difflineminus">-         this_start[1] == '&lt;')</span>
<a href="#l104.173"></a><span id="l104.173" class="difflineminus">-    {</span>
<a href="#l104.174"></a><span id="l104.174" class="difflineminus">-      PL_strncpyz (out, &quot;&amp;lt;&quot;, outlen);</span>
<a href="#l104.175"></a><span id="l104.175" class="difflineplus">+    } else if (enriched_p &amp;&amp; this_start &lt; data_end + 1 &amp;&amp;</span>
<a href="#l104.176"></a><span id="l104.176" class="difflineplus">+               this_start[0] == '&lt;' &amp;&amp; this_start[1] == '&lt;') {</span>
<a href="#l104.177"></a><span id="l104.177" class="difflineplus">+      PL_strncpyz(out, &quot;&amp;lt;&quot;, outlen);</span>
<a href="#l104.178"></a><span id="l104.178">       addedlen = strlen(out);</span>
<a href="#l104.179"></a><span id="l104.179">       outlen -= addedlen;</span>
<a href="#l104.180"></a><span id="l104.180">       out += addedlen;</span>
<a href="#l104.181"></a><span id="l104.181" class="difflineminus">-    }</span>
<a href="#l104.182"></a><span id="l104.182" class="difflineminus">-    else if (this_start != this_end)</span>
<a href="#l104.183"></a><span id="l104.183" class="difflineminus">-    {</span>
<a href="#l104.184"></a><span id="l104.184" class="difflineplus">+    } else if (this_start != this_end) {</span>
<a href="#l104.185"></a><span id="l104.185">       /* Push out this ID. */</span>
<a href="#l104.186"></a><span id="l104.186">       const char *old = this_start + 1;</span>
<a href="#l104.187"></a><span id="l104.187" class="difflineminus">-      const char *tag_open  = 0;</span>
<a href="#l104.188"></a><span id="l104.188" class="difflineplus">+      const char *tag_open = 0;</span>
<a href="#l104.189"></a><span id="l104.189">       const char *tag_close = 0;</span>
<a href="#l104.190"></a><span id="l104.190" class="difflineminus">-      if (*old == '/')</span>
<a href="#l104.191"></a><span id="l104.191" class="difflineminus">-      {</span>
<a href="#l104.192"></a><span id="l104.192" class="difflineplus">+      if (*old == '/') {</span>
<a href="#l104.193"></a><span id="l104.193">         /* This is &lt;/tag&gt; */</span>
<a href="#l104.194"></a><span id="l104.194">         old++;</span>
<a href="#l104.195"></a><span id="l104.195">       }</span>
<a href="#l104.196"></a><span id="l104.196"> </span>
<a href="#l104.197"></a><span id="l104.197" class="difflineminus">-      switch (*old)</span>
<a href="#l104.198"></a><span id="l104.198" class="difflineminus">-      {</span>
<a href="#l104.199"></a><span id="l104.199" class="difflineminus">-      case 'b':</span>
<a href="#l104.200"></a><span id="l104.200" class="difflineminus">-      case 'B':</span>
<a href="#l104.201"></a><span id="l104.201" class="difflineminus">-        if (!PL_strncasecmp (&quot;BIGGER&gt;&quot;, old, 7))</span>
<a href="#l104.202"></a><span id="l104.202" class="difflineminus">-          { tag_open = &quot;&lt;FONT SIZE=\&quot;+1\&quot;&gt;&quot;; tag_close = &quot;&lt;/FONT&gt;&quot;; }</span>
<a href="#l104.203"></a><span id="l104.203" class="difflineminus">-        else if (!PL_strncasecmp (&quot;BLINK&gt;&quot;, old, 6))</span>
<a href="#l104.204"></a><span id="l104.204" class="difflineplus">+      switch (*old) {</span>
<a href="#l104.205"></a><span id="l104.205" class="difflineplus">+        case 'b':</span>
<a href="#l104.206"></a><span id="l104.206" class="difflineplus">+        case 'B':</span>
<a href="#l104.207"></a><span id="l104.207" class="difflineplus">+          if (!PL_strncasecmp(&quot;BIGGER&gt;&quot;, old, 7)) {</span>
<a href="#l104.208"></a><span id="l104.208" class="difflineplus">+            tag_open = &quot;&lt;FONT SIZE=\&quot;+1\&quot;&gt;&quot;;</span>
<a href="#l104.209"></a><span id="l104.209" class="difflineplus">+            tag_close = &quot;&lt;/FONT&gt;&quot;;</span>
<a href="#l104.210"></a><span id="l104.210" class="difflineplus">+          } else if (!PL_strncasecmp(&quot;BLINK&gt;&quot;, old, 6))</span>
<a href="#l104.211"></a><span id="l104.211">           // Of course, both text/richtext and text/enriched must be</span>
<a href="#l104.212"></a><span id="l104.212">           // enhanced *somehow*...  Or else what would people think.</span>
<a href="#l104.213"></a><span id="l104.213" class="difflineminus">-          { tag_open = &quot;&lt;BLINK&gt;&quot;; tag_close = &quot;&lt;/BLINK&gt;&quot;; }</span>
<a href="#l104.214"></a><span id="l104.214" class="difflineminus">-        else if (!PL_strncasecmp (&quot;BOLD&gt;&quot;, old, 5))</span>
<a href="#l104.215"></a><span id="l104.215" class="difflineminus">-          { tag_open = &quot;&lt;B&gt;&quot;; tag_close = &quot;&lt;/B&gt;&quot;; }</span>
<a href="#l104.216"></a><span id="l104.216" class="difflineminus">-        break;</span>
<a href="#l104.217"></a><span id="l104.217" class="difflineplus">+          {</span>
<a href="#l104.218"></a><span id="l104.218" class="difflineplus">+            tag_open = &quot;&lt;BLINK&gt;&quot;;</span>
<a href="#l104.219"></a><span id="l104.219" class="difflineplus">+            tag_close = &quot;&lt;/BLINK&gt;&quot;;</span>
<a href="#l104.220"></a><span id="l104.220" class="difflineplus">+          } else if (!PL_strncasecmp(&quot;BOLD&gt;&quot;, old, 5)) {</span>
<a href="#l104.221"></a><span id="l104.221" class="difflineplus">+            tag_open = &quot;&lt;B&gt;&quot;;</span>
<a href="#l104.222"></a><span id="l104.222" class="difflineplus">+            tag_close = &quot;&lt;/B&gt;&quot;;</span>
<a href="#l104.223"></a><span id="l104.223" class="difflineplus">+          }</span>
<a href="#l104.224"></a><span id="l104.224" class="difflineplus">+          break;</span>
<a href="#l104.225"></a><span id="l104.225"> </span>
<a href="#l104.226"></a><span id="l104.226" class="difflineminus">-      case 'c':</span>
<a href="#l104.227"></a><span id="l104.227" class="difflineminus">-      case 'C':</span>
<a href="#l104.228"></a><span id="l104.228" class="difflineminus">-        if (!PL_strncasecmp (&quot;CENTER&gt;&quot;, old, 7))</span>
<a href="#l104.229"></a><span id="l104.229" class="difflineminus">-          { tag_open = &quot;&lt;CENTER&gt;&quot;; tag_close = &quot;&lt;/CENTER&gt;&quot;; }</span>
<a href="#l104.230"></a><span id="l104.230" class="difflineminus">-        else if (!enriched_p &amp;&amp; !PL_strncasecmp (&quot;COMMENT&gt;&quot;, old, 8))</span>
<a href="#l104.231"></a><span id="l104.231" class="difflineminus">-          { tag_open = &quot;&lt;!-- &quot;; tag_close = &quot; --&gt;&quot;; }</span>
<a href="#l104.232"></a><span id="l104.232" class="difflineminus">-        break;</span>
<a href="#l104.233"></a><span id="l104.233" class="difflineplus">+        case 'c':</span>
<a href="#l104.234"></a><span id="l104.234" class="difflineplus">+        case 'C':</span>
<a href="#l104.235"></a><span id="l104.235" class="difflineplus">+          if (!PL_strncasecmp(&quot;CENTER&gt;&quot;, old, 7)) {</span>
<a href="#l104.236"></a><span id="l104.236" class="difflineplus">+            tag_open = &quot;&lt;CENTER&gt;&quot;;</span>
<a href="#l104.237"></a><span id="l104.237" class="difflineplus">+            tag_close = &quot;&lt;/CENTER&gt;&quot;;</span>
<a href="#l104.238"></a><span id="l104.238" class="difflineplus">+          } else if (!enriched_p &amp;&amp; !PL_strncasecmp(&quot;COMMENT&gt;&quot;, old, 8)) {</span>
<a href="#l104.239"></a><span id="l104.239" class="difflineplus">+            tag_open = &quot;&lt;!-- &quot;;</span>
<a href="#l104.240"></a><span id="l104.240" class="difflineplus">+            tag_close = &quot; --&gt;&quot;;</span>
<a href="#l104.241"></a><span id="l104.241" class="difflineplus">+          }</span>
<a href="#l104.242"></a><span id="l104.242" class="difflineplus">+          break;</span>
<a href="#l104.243"></a><span id="l104.243"> </span>
<a href="#l104.244"></a><span id="l104.244" class="difflineminus">-      case 'e':</span>
<a href="#l104.245"></a><span id="l104.245" class="difflineminus">-      case 'E':</span>
<a href="#l104.246"></a><span id="l104.246" class="difflineminus">-        if (!PL_strncasecmp (&quot;EXCERPT&gt;&quot;, old, 8))</span>
<a href="#l104.247"></a><span id="l104.247" class="difflineminus">-         { tag_open = &quot;&lt;BLOCKQUOTE&gt;&quot;; tag_close = &quot;&lt;/BLOCKQUOTE&gt;&quot;; }</span>
<a href="#l104.248"></a><span id="l104.248" class="difflineminus">-        break;</span>
<a href="#l104.249"></a><span id="l104.249" class="difflineplus">+        case 'e':</span>
<a href="#l104.250"></a><span id="l104.250" class="difflineplus">+        case 'E':</span>
<a href="#l104.251"></a><span id="l104.251" class="difflineplus">+          if (!PL_strncasecmp(&quot;EXCERPT&gt;&quot;, old, 8)) {</span>
<a href="#l104.252"></a><span id="l104.252" class="difflineplus">+            tag_open = &quot;&lt;BLOCKQUOTE&gt;&quot;;</span>
<a href="#l104.253"></a><span id="l104.253" class="difflineplus">+            tag_close = &quot;&lt;/BLOCKQUOTE&gt;&quot;;</span>
<a href="#l104.254"></a><span id="l104.254" class="difflineplus">+          }</span>
<a href="#l104.255"></a><span id="l104.255" class="difflineplus">+          break;</span>
<a href="#l104.256"></a><span id="l104.256"> </span>
<a href="#l104.257"></a><span id="l104.257" class="difflineminus">-      case 'f':</span>
<a href="#l104.258"></a><span id="l104.258" class="difflineminus">-      case 'F':</span>
<a href="#l104.259"></a><span id="l104.259" class="difflineminus">-        if (!PL_strncasecmp (&quot;FIXED&gt;&quot;, old, 6))</span>
<a href="#l104.260"></a><span id="l104.260" class="difflineminus">-          { tag_open = &quot;&lt;TT&gt;&quot;; tag_close = &quot;&lt;/TT&gt;&quot;; }</span>
<a href="#l104.261"></a><span id="l104.261" class="difflineminus">-        else if (enriched_p &amp;&amp; !PL_strncasecmp (&quot;FLUSHBOTH&gt;&quot;, old, 10))</span>
<a href="#l104.262"></a><span id="l104.262" class="difflineminus">-          { tag_open = &quot;&lt;P ALIGN=JUSTIFY&gt;&quot;; tag_close = &quot;&lt;/P&gt;&quot;; }</span>
<a href="#l104.263"></a><span id="l104.263" class="difflineminus">-        else if (!PL_strncasecmp (&quot;FLUSHLEFT&gt;&quot;, old, 10))</span>
<a href="#l104.264"></a><span id="l104.264" class="difflineminus">-          { tag_open = &quot;&lt;P ALIGN=LEFT&gt;&quot;; tag_close = &quot;&lt;/P&gt;&quot;; }</span>
<a href="#l104.265"></a><span id="l104.265" class="difflineminus">-        else if (!PL_strncasecmp (&quot;FLUSHRIGHT&gt;&quot;, old, 11))</span>
<a href="#l104.266"></a><span id="l104.266" class="difflineminus">-          { tag_open = &quot;&lt;P ALIGN=RIGHT&gt;&quot;; tag_close = &quot;&lt;/P&gt;&quot;; }</span>
<a href="#l104.267"></a><span id="l104.267" class="difflineminus">-        else if (!enriched_p &amp;&amp; !PL_strncasecmp (&quot;FOOTING&gt;&quot;, old, 8))</span>
<a href="#l104.268"></a><span id="l104.268" class="difflineminus">-          { tag_open = &quot;&lt;H6&gt;&quot;; tag_close = &quot;&lt;/H6&gt;&quot;; }</span>
<a href="#l104.269"></a><span id="l104.269" class="difflineminus">-        break;</span>
<a href="#l104.270"></a><span id="l104.270" class="difflineplus">+        case 'f':</span>
<a href="#l104.271"></a><span id="l104.271" class="difflineplus">+        case 'F':</span>
<a href="#l104.272"></a><span id="l104.272" class="difflineplus">+          if (!PL_strncasecmp(&quot;FIXED&gt;&quot;, old, 6)) {</span>
<a href="#l104.273"></a><span id="l104.273" class="difflineplus">+            tag_open = &quot;&lt;TT&gt;&quot;;</span>
<a href="#l104.274"></a><span id="l104.274" class="difflineplus">+            tag_close = &quot;&lt;/TT&gt;&quot;;</span>
<a href="#l104.275"></a><span id="l104.275" class="difflineplus">+          } else if (enriched_p &amp;&amp; !PL_strncasecmp(&quot;FLUSHBOTH&gt;&quot;, old, 10)) {</span>
<a href="#l104.276"></a><span id="l104.276" class="difflineplus">+            tag_open = &quot;&lt;P ALIGN=JUSTIFY&gt;&quot;;</span>
<a href="#l104.277"></a><span id="l104.277" class="difflineplus">+            tag_close = &quot;&lt;/P&gt;&quot;;</span>
<a href="#l104.278"></a><span id="l104.278" class="difflineplus">+          } else if (!PL_strncasecmp(&quot;FLUSHLEFT&gt;&quot;, old, 10)) {</span>
<a href="#l104.279"></a><span id="l104.279" class="difflineplus">+            tag_open = &quot;&lt;P ALIGN=LEFT&gt;&quot;;</span>
<a href="#l104.280"></a><span id="l104.280" class="difflineplus">+            tag_close = &quot;&lt;/P&gt;&quot;;</span>
<a href="#l104.281"></a><span id="l104.281" class="difflineplus">+          } else if (!PL_strncasecmp(&quot;FLUSHRIGHT&gt;&quot;, old, 11)) {</span>
<a href="#l104.282"></a><span id="l104.282" class="difflineplus">+            tag_open = &quot;&lt;P ALIGN=RIGHT&gt;&quot;;</span>
<a href="#l104.283"></a><span id="l104.283" class="difflineplus">+            tag_close = &quot;&lt;/P&gt;&quot;;</span>
<a href="#l104.284"></a><span id="l104.284" class="difflineplus">+          } else if (!enriched_p &amp;&amp; !PL_strncasecmp(&quot;FOOTING&gt;&quot;, old, 8)) {</span>
<a href="#l104.285"></a><span id="l104.285" class="difflineplus">+            tag_open = &quot;&lt;H6&gt;&quot;;</span>
<a href="#l104.286"></a><span id="l104.286" class="difflineplus">+            tag_close = &quot;&lt;/H6&gt;&quot;;</span>
<a href="#l104.287"></a><span id="l104.287" class="difflineplus">+          }</span>
<a href="#l104.288"></a><span id="l104.288" class="difflineplus">+          break;</span>
<a href="#l104.289"></a><span id="l104.289"> </span>
<a href="#l104.290"></a><span id="l104.290" class="difflineminus">-      case 'h':</span>
<a href="#l104.291"></a><span id="l104.291" class="difflineminus">-      case 'H':</span>
<a href="#l104.292"></a><span id="l104.292" class="difflineminus">-        if (!enriched_p &amp;&amp; !PL_strncasecmp (&quot;HEADING&gt;&quot;, old, 8))</span>
<a href="#l104.293"></a><span id="l104.293" class="difflineminus">-          { tag_open = &quot;&lt;H6&gt;&quot;; tag_close = &quot;&lt;/H6&gt;&quot;; }</span>
<a href="#l104.294"></a><span id="l104.294" class="difflineminus">-        break;</span>
<a href="#l104.295"></a><span id="l104.295" class="difflineplus">+        case 'h':</span>
<a href="#l104.296"></a><span id="l104.296" class="difflineplus">+        case 'H':</span>
<a href="#l104.297"></a><span id="l104.297" class="difflineplus">+          if (!enriched_p &amp;&amp; !PL_strncasecmp(&quot;HEADING&gt;&quot;, old, 8)) {</span>
<a href="#l104.298"></a><span id="l104.298" class="difflineplus">+            tag_open = &quot;&lt;H6&gt;&quot;;</span>
<a href="#l104.299"></a><span id="l104.299" class="difflineplus">+            tag_close = &quot;&lt;/H6&gt;&quot;;</span>
<a href="#l104.300"></a><span id="l104.300" class="difflineplus">+          }</span>
<a href="#l104.301"></a><span id="l104.301" class="difflineplus">+          break;</span>
<a href="#l104.302"></a><span id="l104.302"> </span>
<a href="#l104.303"></a><span id="l104.303" class="difflineminus">-      case 'i':</span>
<a href="#l104.304"></a><span id="l104.304" class="difflineminus">-      case 'I':</span>
<a href="#l104.305"></a><span id="l104.305" class="difflineminus">-        if (!PL_strncasecmp (&quot;INDENT&gt;&quot;, old, 7))</span>
<a href="#l104.306"></a><span id="l104.306" class="difflineminus">-          { tag_open = &quot;&lt;UL&gt;&quot;; tag_close = &quot;&lt;/UL&gt;&quot;; }</span>
<a href="#l104.307"></a><span id="l104.307" class="difflineminus">-        else if (!PL_strncasecmp (&quot;INDENTRIGHT&gt;&quot;, old, 12))</span>
<a href="#l104.308"></a><span id="l104.308" class="difflineminus">-          { tag_open = 0; tag_close = 0; }</span>
<a href="#l104.309"></a><span id="l104.309" class="difflineminus">-        else if (!PL_strncasecmp (&quot;ITALIC&gt;&quot;, old, 7))</span>
<a href="#l104.310"></a><span id="l104.310" class="difflineminus">-          { tag_open = &quot;&lt;I&gt;&quot;; tag_close = &quot;&lt;/I&gt;&quot;; }</span>
<a href="#l104.311"></a><span id="l104.311" class="difflineminus">-        break;</span>
<a href="#l104.312"></a><span id="l104.312" class="difflineplus">+        case 'i':</span>
<a href="#l104.313"></a><span id="l104.313" class="difflineplus">+        case 'I':</span>
<a href="#l104.314"></a><span id="l104.314" class="difflineplus">+          if (!PL_strncasecmp(&quot;INDENT&gt;&quot;, old, 7)) {</span>
<a href="#l104.315"></a><span id="l104.315" class="difflineplus">+            tag_open = &quot;&lt;UL&gt;&quot;;</span>
<a href="#l104.316"></a><span id="l104.316" class="difflineplus">+            tag_close = &quot;&lt;/UL&gt;&quot;;</span>
<a href="#l104.317"></a><span id="l104.317" class="difflineplus">+          } else if (!PL_strncasecmp(&quot;INDENTRIGHT&gt;&quot;, old, 12)) {</span>
<a href="#l104.318"></a><span id="l104.318" class="difflineplus">+            tag_open = 0;</span>
<a href="#l104.319"></a><span id="l104.319" class="difflineplus">+            tag_close = 0;</span>
<a href="#l104.320"></a><span id="l104.320" class="difflineplus">+          } else if (!PL_strncasecmp(&quot;ITALIC&gt;&quot;, old, 7)) {</span>
<a href="#l104.321"></a><span id="l104.321" class="difflineplus">+            tag_open = &quot;&lt;I&gt;&quot;;</span>
<a href="#l104.322"></a><span id="l104.322" class="difflineplus">+            tag_close = &quot;&lt;/I&gt;&quot;;</span>
<a href="#l104.323"></a><span id="l104.323" class="difflineplus">+          }</span>
<a href="#l104.324"></a><span id="l104.324" class="difflineplus">+          break;</span>
<a href="#l104.325"></a><span id="l104.325"> </span>
<a href="#l104.326"></a><span id="l104.326" class="difflineminus">-      case 'l':</span>
<a href="#l104.327"></a><span id="l104.327" class="difflineminus">-      case 'L':</span>
<a href="#l104.328"></a><span id="l104.328" class="difflineminus">-        if (!enriched_p &amp;&amp; !PL_strncasecmp (&quot;LT&gt;&quot;, old, 3))</span>
<a href="#l104.329"></a><span id="l104.329" class="difflineminus">-          { tag_open = &quot;&amp;lt;&quot;; tag_close = 0; }</span>
<a href="#l104.330"></a><span id="l104.330" class="difflineminus">-        break;</span>
<a href="#l104.331"></a><span id="l104.331" class="difflineplus">+        case 'l':</span>
<a href="#l104.332"></a><span id="l104.332" class="difflineplus">+        case 'L':</span>
<a href="#l104.333"></a><span id="l104.333" class="difflineplus">+          if (!enriched_p &amp;&amp; !PL_strncasecmp(&quot;LT&gt;&quot;, old, 3)) {</span>
<a href="#l104.334"></a><span id="l104.334" class="difflineplus">+            tag_open = &quot;&amp;lt;&quot;;</span>
<a href="#l104.335"></a><span id="l104.335" class="difflineplus">+            tag_close = 0;</span>
<a href="#l104.336"></a><span id="l104.336" class="difflineplus">+          }</span>
<a href="#l104.337"></a><span id="l104.337" class="difflineplus">+          break;</span>
<a href="#l104.338"></a><span id="l104.338"> </span>
<a href="#l104.339"></a><span id="l104.339" class="difflineminus">-      case 'n':</span>
<a href="#l104.340"></a><span id="l104.340" class="difflineminus">-      case 'N':</span>
<a href="#l104.341"></a><span id="l104.341" class="difflineminus">-        if (!enriched_p &amp;&amp; !PL_strncasecmp (&quot;NL&gt;&quot;, old, 3))</span>
<a href="#l104.342"></a><span id="l104.342" class="difflineminus">-          { tag_open = &quot;&lt;BR&gt;&quot;; tag_close = 0; }</span>
<a href="#l104.343"></a><span id="l104.343" class="difflineminus">-        if (enriched_p &amp;&amp; !PL_strncasecmp (&quot;NOFILL&gt;&quot;, old, 7))</span>
<a href="#l104.344"></a><span id="l104.344" class="difflineminus">-          { tag_open = &quot;&lt;NOBR&gt;&quot;; tag_close = &quot;&lt;/NOBR&gt;&quot;; }</span>
<a href="#l104.345"></a><span id="l104.345" class="difflineminus">-        break;</span>
<a href="#l104.346"></a><span id="l104.346" class="difflineplus">+        case 'n':</span>
<a href="#l104.347"></a><span id="l104.347" class="difflineplus">+        case 'N':</span>
<a href="#l104.348"></a><span id="l104.348" class="difflineplus">+          if (!enriched_p &amp;&amp; !PL_strncasecmp(&quot;NL&gt;&quot;, old, 3)) {</span>
<a href="#l104.349"></a><span id="l104.349" class="difflineplus">+            tag_open = &quot;&lt;BR&gt;&quot;;</span>
<a href="#l104.350"></a><span id="l104.350" class="difflineplus">+            tag_close = 0;</span>
<a href="#l104.351"></a><span id="l104.351" class="difflineplus">+          }</span>
<a href="#l104.352"></a><span id="l104.352" class="difflineplus">+          if (enriched_p &amp;&amp; !PL_strncasecmp(&quot;NOFILL&gt;&quot;, old, 7)) {</span>
<a href="#l104.353"></a><span id="l104.353" class="difflineplus">+            tag_open = &quot;&lt;NOBR&gt;&quot;;</span>
<a href="#l104.354"></a><span id="l104.354" class="difflineplus">+            tag_close = &quot;&lt;/NOBR&gt;&quot;;</span>
<a href="#l104.355"></a><span id="l104.355" class="difflineplus">+          }</span>
<a href="#l104.356"></a><span id="l104.356" class="difflineplus">+          break;</span>
<a href="#l104.357"></a><span id="l104.357"> </span>
<a href="#l104.358"></a><span id="l104.358" class="difflineminus">-      case 'o':</span>
<a href="#l104.359"></a><span id="l104.359" class="difflineminus">-      case 'O':</span>
<a href="#l104.360"></a><span id="l104.360" class="difflineminus">-        if (!enriched_p &amp;&amp; !PL_strncasecmp (&quot;OUTDENT&gt;&quot;, old, 8))</span>
<a href="#l104.361"></a><span id="l104.361" class="difflineminus">-          { tag_open = 0; tag_close = 0; }</span>
<a href="#l104.362"></a><span id="l104.362" class="difflineminus">-        else if (!enriched_p &amp;&amp; !PL_strncasecmp (&quot;OUTDENTRIGHT&gt;&quot;, old, 13))</span>
<a href="#l104.363"></a><span id="l104.363" class="difflineminus">-          { tag_open = 0; tag_close = 0; }</span>
<a href="#l104.364"></a><span id="l104.364" class="difflineminus">-        break;</span>
<a href="#l104.365"></a><span id="l104.365" class="difflineplus">+        case 'o':</span>
<a href="#l104.366"></a><span id="l104.366" class="difflineplus">+        case 'O':</span>
<a href="#l104.367"></a><span id="l104.367" class="difflineplus">+          if (!enriched_p &amp;&amp; !PL_strncasecmp(&quot;OUTDENT&gt;&quot;, old, 8)) {</span>
<a href="#l104.368"></a><span id="l104.368" class="difflineplus">+            tag_open = 0;</span>
<a href="#l104.369"></a><span id="l104.369" class="difflineplus">+            tag_close = 0;</span>
<a href="#l104.370"></a><span id="l104.370" class="difflineplus">+          } else if (!enriched_p &amp;&amp; !PL_strncasecmp(&quot;OUTDENTRIGHT&gt;&quot;, old, 13)) {</span>
<a href="#l104.371"></a><span id="l104.371" class="difflineplus">+            tag_open = 0;</span>
<a href="#l104.372"></a><span id="l104.372" class="difflineplus">+            tag_close = 0;</span>
<a href="#l104.373"></a><span id="l104.373" class="difflineplus">+          }</span>
<a href="#l104.374"></a><span id="l104.374" class="difflineplus">+          break;</span>
<a href="#l104.375"></a><span id="l104.375"> </span>
<a href="#l104.376"></a><span id="l104.376" class="difflineminus">-      case 'p':</span>
<a href="#l104.377"></a><span id="l104.377" class="difflineminus">-      case 'P':</span>
<a href="#l104.378"></a><span id="l104.378" class="difflineminus">-        if (enriched_p &amp;&amp; !PL_strncasecmp (&quot;PARAM&gt;&quot;, old, 6))</span>
<a href="#l104.379"></a><span id="l104.379" class="difflineminus">-          { tag_open = &quot;&lt;!-- &quot;; tag_close = &quot; --&gt;&quot;; }</span>
<a href="#l104.380"></a><span id="l104.380" class="difflineminus">-        else if (!enriched_p &amp;&amp; !PL_strncasecmp (&quot;PARAGRAPH&gt;&quot;, old, 10))</span>
<a href="#l104.381"></a><span id="l104.381" class="difflineminus">-          { tag_open = &quot;&lt;P&gt;&quot;; tag_close = 0; }</span>
<a href="#l104.382"></a><span id="l104.382" class="difflineminus">-        break;</span>
<a href="#l104.383"></a><span id="l104.383" class="difflineplus">+        case 'p':</span>
<a href="#l104.384"></a><span id="l104.384" class="difflineplus">+        case 'P':</span>
<a href="#l104.385"></a><span id="l104.385" class="difflineplus">+          if (enriched_p &amp;&amp; !PL_strncasecmp(&quot;PARAM&gt;&quot;, old, 6)) {</span>
<a href="#l104.386"></a><span id="l104.386" class="difflineplus">+            tag_open = &quot;&lt;!-- &quot;;</span>
<a href="#l104.387"></a><span id="l104.387" class="difflineplus">+            tag_close = &quot; --&gt;&quot;;</span>
<a href="#l104.388"></a><span id="l104.388" class="difflineplus">+          } else if (!enriched_p &amp;&amp; !PL_strncasecmp(&quot;PARAGRAPH&gt;&quot;, old, 10)) {</span>
<a href="#l104.389"></a><span id="l104.389" class="difflineplus">+            tag_open = &quot;&lt;P&gt;&quot;;</span>
<a href="#l104.390"></a><span id="l104.390" class="difflineplus">+            tag_close = 0;</span>
<a href="#l104.391"></a><span id="l104.391" class="difflineplus">+          }</span>
<a href="#l104.392"></a><span id="l104.392" class="difflineplus">+          break;</span>
<a href="#l104.393"></a><span id="l104.393"> </span>
<a href="#l104.394"></a><span id="l104.394" class="difflineminus">-      case 's':</span>
<a href="#l104.395"></a><span id="l104.395" class="difflineminus">-      case 'S':</span>
<a href="#l104.396"></a><span id="l104.396" class="difflineminus">-        if (!enriched_p &amp;&amp; !PL_strncasecmp (&quot;SAMEPAGE&gt;&quot;, old, 9))</span>
<a href="#l104.397"></a><span id="l104.397" class="difflineminus">-          { tag_open = 0; tag_close = 0; }</span>
<a href="#l104.398"></a><span id="l104.398" class="difflineminus">-        else if (!enriched_p &amp;&amp; !PL_strncasecmp (&quot;SIGNATURE&gt;&quot;, old, 10))</span>
<a href="#l104.399"></a><span id="l104.399" class="difflineminus">-          { tag_open = &quot;&lt;I&gt;&lt;FONT SIZE=\&quot;-1\&quot;&gt;&quot;; tag_close = &quot;&lt;/FONT&gt;&lt;/I&gt;&quot;; }</span>
<a href="#l104.400"></a><span id="l104.400" class="difflineminus">-        else if (!PL_strncasecmp (&quot;SMALLER&gt;&quot;, old, 8))</span>
<a href="#l104.401"></a><span id="l104.401" class="difflineminus">-          { tag_open = &quot;&lt;FONT SIZE=\&quot;-1\&quot;&gt;&quot;; tag_close = &quot;&lt;/FONT&gt;&quot;; }</span>
<a href="#l104.402"></a><span id="l104.402" class="difflineminus">-        else if (!enriched_p &amp;&amp; !PL_strncasecmp (&quot;SUBSCRIPT&gt;&quot;, old, 10))</span>
<a href="#l104.403"></a><span id="l104.403" class="difflineminus">-          { tag_open = &quot;&lt;SUB&gt;&quot;; tag_close = &quot;&lt;/SUB&gt;&quot;; }</span>
<a href="#l104.404"></a><span id="l104.404" class="difflineminus">-        else if (!enriched_p &amp;&amp; !PL_strncasecmp (&quot;SUPERSCRIPT&gt;&quot;, old, 12))</span>
<a href="#l104.405"></a><span id="l104.405" class="difflineminus">-          { tag_open = &quot;&lt;SUP&gt;&quot;; tag_close = &quot;&lt;/SUP&gt;&quot;; }</span>
<a href="#l104.406"></a><span id="l104.406" class="difflineminus">-        break;</span>
<a href="#l104.407"></a><span id="l104.407" class="difflineplus">+        case 's':</span>
<a href="#l104.408"></a><span id="l104.408" class="difflineplus">+        case 'S':</span>
<a href="#l104.409"></a><span id="l104.409" class="difflineplus">+          if (!enriched_p &amp;&amp; !PL_strncasecmp(&quot;SAMEPAGE&gt;&quot;, old, 9)) {</span>
<a href="#l104.410"></a><span id="l104.410" class="difflineplus">+            tag_open = 0;</span>
<a href="#l104.411"></a><span id="l104.411" class="difflineplus">+            tag_close = 0;</span>
<a href="#l104.412"></a><span id="l104.412" class="difflineplus">+          } else if (!enriched_p &amp;&amp; !PL_strncasecmp(&quot;SIGNATURE&gt;&quot;, old, 10)) {</span>
<a href="#l104.413"></a><span id="l104.413" class="difflineplus">+            tag_open = &quot;&lt;I&gt;&lt;FONT SIZE=\&quot;-1\&quot;&gt;&quot;;</span>
<a href="#l104.414"></a><span id="l104.414" class="difflineplus">+            tag_close = &quot;&lt;/FONT&gt;&lt;/I&gt;&quot;;</span>
<a href="#l104.415"></a><span id="l104.415" class="difflineplus">+          } else if (!PL_strncasecmp(&quot;SMALLER&gt;&quot;, old, 8)) {</span>
<a href="#l104.416"></a><span id="l104.416" class="difflineplus">+            tag_open = &quot;&lt;FONT SIZE=\&quot;-1\&quot;&gt;&quot;;</span>
<a href="#l104.417"></a><span id="l104.417" class="difflineplus">+            tag_close = &quot;&lt;/FONT&gt;&quot;;</span>
<a href="#l104.418"></a><span id="l104.418" class="difflineplus">+          } else if (!enriched_p &amp;&amp; !PL_strncasecmp(&quot;SUBSCRIPT&gt;&quot;, old, 10)) {</span>
<a href="#l104.419"></a><span id="l104.419" class="difflineplus">+            tag_open = &quot;&lt;SUB&gt;&quot;;</span>
<a href="#l104.420"></a><span id="l104.420" class="difflineplus">+            tag_close = &quot;&lt;/SUB&gt;&quot;;</span>
<a href="#l104.421"></a><span id="l104.421" class="difflineplus">+          } else if (!enriched_p &amp;&amp; !PL_strncasecmp(&quot;SUPERSCRIPT&gt;&quot;, old, 12)) {</span>
<a href="#l104.422"></a><span id="l104.422" class="difflineplus">+            tag_open = &quot;&lt;SUP&gt;&quot;;</span>
<a href="#l104.423"></a><span id="l104.423" class="difflineplus">+            tag_close = &quot;&lt;/SUP&gt;&quot;;</span>
<a href="#l104.424"></a><span id="l104.424" class="difflineplus">+          }</span>
<a href="#l104.425"></a><span id="l104.425" class="difflineplus">+          break;</span>
<a href="#l104.426"></a><span id="l104.426"> </span>
<a href="#l104.427"></a><span id="l104.427" class="difflineminus">-      case 'u':</span>
<a href="#l104.428"></a><span id="l104.428" class="difflineminus">-      case 'U':</span>
<a href="#l104.429"></a><span id="l104.429" class="difflineminus">-        if (!PL_strncasecmp (&quot;UNDERLINE&gt;&quot;, old, 10))</span>
<a href="#l104.430"></a><span id="l104.430" class="difflineminus">-          { tag_open = &quot;&lt;U&gt;&quot;; tag_close = &quot;&lt;/U&gt;&quot;; }</span>
<a href="#l104.431"></a><span id="l104.431" class="difflineminus">-        break;</span>
<a href="#l104.432"></a><span id="l104.432" class="difflineplus">+        case 'u':</span>
<a href="#l104.433"></a><span id="l104.433" class="difflineplus">+        case 'U':</span>
<a href="#l104.434"></a><span id="l104.434" class="difflineplus">+          if (!PL_strncasecmp(&quot;UNDERLINE&gt;&quot;, old, 10)) {</span>
<a href="#l104.435"></a><span id="l104.435" class="difflineplus">+            tag_open = &quot;&lt;U&gt;&quot;;</span>
<a href="#l104.436"></a><span id="l104.436" class="difflineplus">+            tag_close = &quot;&lt;/U&gt;&quot;;</span>
<a href="#l104.437"></a><span id="l104.437" class="difflineplus">+          }</span>
<a href="#l104.438"></a><span id="l104.438" class="difflineplus">+          break;</span>
<a href="#l104.439"></a><span id="l104.439"> </span>
<a href="#l104.440"></a><span id="l104.440" class="difflineminus">-      case 'v':</span>
<a href="#l104.441"></a><span id="l104.441" class="difflineminus">-      case 'V':</span>
<a href="#l104.442"></a><span id="l104.442" class="difflineminus">-        if (enriched_p &amp;&amp; !PL_strncasecmp (&quot;VERBATIM&gt;&quot;, old, 9))</span>
<a href="#l104.443"></a><span id="l104.443" class="difflineminus">-          { tag_open = &quot;&lt;PRE&gt;&quot;; tag_close = &quot;&lt;/PRE&gt;&quot;; }</span>
<a href="#l104.444"></a><span id="l104.444" class="difflineminus">-        break;</span>
<a href="#l104.445"></a><span id="l104.445" class="difflineplus">+        case 'v':</span>
<a href="#l104.446"></a><span id="l104.446" class="difflineplus">+        case 'V':</span>
<a href="#l104.447"></a><span id="l104.447" class="difflineplus">+          if (enriched_p &amp;&amp; !PL_strncasecmp(&quot;VERBATIM&gt;&quot;, old, 9)) {</span>
<a href="#l104.448"></a><span id="l104.448" class="difflineplus">+            tag_open = &quot;&lt;PRE&gt;&quot;;</span>
<a href="#l104.449"></a><span id="l104.449" class="difflineplus">+            tag_close = &quot;&lt;/PRE&gt;&quot;;</span>
<a href="#l104.450"></a><span id="l104.450" class="difflineplus">+          }</span>
<a href="#l104.451"></a><span id="l104.451" class="difflineplus">+          break;</span>
<a href="#l104.452"></a><span id="l104.452">       }</span>
<a href="#l104.453"></a><span id="l104.453"> </span>
<a href="#l104.454"></a><span id="l104.454" class="difflineminus">-      if (this_start[1] == '/')</span>
<a href="#l104.455"></a><span id="l104.455" class="difflineminus">-      {</span>
<a href="#l104.456"></a><span id="l104.456" class="difflineminus">-        if (tag_close) PL_strncpyz (out, tag_close, outlen);</span>
<a href="#l104.457"></a><span id="l104.457" class="difflineminus">-        addedlen = strlen (out);</span>
<a href="#l104.458"></a><span id="l104.458" class="difflineplus">+      if (this_start[1] == '/') {</span>
<a href="#l104.459"></a><span id="l104.459" class="difflineplus">+        if (tag_close) PL_strncpyz(out, tag_close, outlen);</span>
<a href="#l104.460"></a><span id="l104.460" class="difflineplus">+        addedlen = strlen(out);</span>
<a href="#l104.461"></a><span id="l104.461">         outlen -= addedlen;</span>
<a href="#l104.462"></a><span id="l104.462">         out += addedlen;</span>
<a href="#l104.463"></a><span id="l104.463" class="difflineminus">-      }</span>
<a href="#l104.464"></a><span id="l104.464" class="difflineminus">-      else</span>
<a href="#l104.465"></a><span id="l104.465" class="difflineminus">-      {</span>
<a href="#l104.466"></a><span id="l104.466" class="difflineminus">-        if (tag_open) PL_strncpyz (out, tag_open, outlen);</span>
<a href="#l104.467"></a><span id="l104.467" class="difflineminus">-        addedlen = strlen (out);</span>
<a href="#l104.468"></a><span id="l104.468" class="difflineplus">+      } else {</span>
<a href="#l104.469"></a><span id="l104.469" class="difflineplus">+        if (tag_open) PL_strncpyz(out, tag_open, outlen);</span>
<a href="#l104.470"></a><span id="l104.470" class="difflineplus">+        addedlen = strlen(out);</span>
<a href="#l104.471"></a><span id="l104.471">         outlen -= addedlen;</span>
<a href="#l104.472"></a><span id="l104.472">         out += addedlen;</span>
<a href="#l104.473"></a><span id="l104.473">       }</span>
<a href="#l104.474"></a><span id="l104.474">     }</span>
<a href="#l104.475"></a><span id="l104.475"> </span>
<a href="#l104.476"></a><span id="l104.476">     /* now go around again */</span>
<a href="#l104.477"></a><span id="l104.477">     last_end = this_end;</span>
<a href="#l104.478"></a><span id="l104.478">     this_start = last_end;</span>
<a href="#l104.479"></a><span id="l104.479">   }</span>
<a href="#l104.480"></a><span id="l104.480">   *out = 0;</span>
<a href="#l104.481"></a><span id="l104.481"> </span>
<a href="#l104.482"></a><span id="l104.482">   return MimeObject_write(obj, *obufferP, out - *obufferP, true);</span>
<a href="#l104.483"></a><span id="l104.483"> }</span>
<a href="#l104.484"></a><span id="l104.484"> </span>
<a href="#l104.485"></a><span id="l104.485" class="difflineplus">+static int MimeInlineTextRichtext_parse_line(const char *line, int32_t length,</span>
<a href="#l104.486"></a><span id="l104.486" class="difflineplus">+                                             MimeObject *obj) {</span>
<a href="#l104.487"></a><span id="l104.487" class="difflineplus">+  bool enriched_p = (((MimeInlineTextRichtextClass *)obj-&gt;clazz)-&gt;enriched_p);</span>
<a href="#l104.488"></a><span id="l104.488"> </span>
<a href="#l104.489"></a><span id="l104.489" class="difflineminus">-static int</span>
<a href="#l104.490"></a><span id="l104.490" class="difflineminus">-MimeInlineTextRichtext_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l104.491"></a><span id="l104.491" class="difflineminus">-{</span>
<a href="#l104.492"></a><span id="l104.492" class="difflineminus">-  bool enriched_p = (((MimeInlineTextRichtextClass *) obj-&gt;clazz)</span>
<a href="#l104.493"></a><span id="l104.493" class="difflineminus">-            -&gt;enriched_p);</span>
<a href="#l104.494"></a><span id="l104.494" class="difflineminus">-</span>
<a href="#l104.495"></a><span id="l104.495" class="difflineminus">-  return MimeRichtextConvert (line, length,</span>
<a href="#l104.496"></a><span id="l104.496" class="difflineminus">-                obj,</span>
<a href="#l104.497"></a><span id="l104.497" class="difflineminus">-                &amp;obj-&gt;obuffer, &amp;obj-&gt;obuffer_size,</span>
<a href="#l104.498"></a><span id="l104.498" class="difflineminus">-                enriched_p);</span>
<a href="#l104.499"></a><span id="l104.499" class="difflineplus">+  return MimeRichtextConvert(line, length, obj, &amp;obj-&gt;obuffer,</span>
<a href="#l104.500"></a><span id="l104.500" class="difflineplus">+                             &amp;obj-&gt;obuffer_size, enriched_p);</span>
<a href="#l104.501"></a><span id="l104.501"> }</span>
<a href="#l104.502"></a><span id="l104.502"> </span>
<a href="#l104.503"></a><span id="l104.503" class="difflineminus">-</span>
<a href="#l104.504"></a><span id="l104.504" class="difflineminus">-static int</span>
<a href="#l104.505"></a><span id="l104.505" class="difflineminus">-MimeInlineTextRichtext_parse_begin (MimeObject *obj)</span>
<a href="#l104.506"></a><span id="l104.506" class="difflineminus">-{</span>
<a href="#l104.507"></a><span id="l104.507" class="difflineminus">-  int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l104.508"></a><span id="l104.508" class="difflineplus">+static int MimeInlineTextRichtext_parse_begin(MimeObject *obj) {</span>
<a href="#l104.509"></a><span id="l104.509" class="difflineplus">+  int status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l104.510"></a><span id="l104.510">   char s[] = &quot;&quot;;</span>
<a href="#l104.511"></a><span id="l104.511">   if (status &lt; 0) return status;</span>
<a href="#l104.512"></a><span id="l104.512">   return MimeObject_write(obj, s, 0, true); /* force out any separators... */</span>
<a href="#l104.513"></a><span id="l104.513"> }</span>
<a href="#l104.514"></a><span id="l104.514"> </span>
<a href="#l104.515"></a><span id="l104.515" class="difflineminus">-</span>
<a href="#l104.516"></a><span id="l104.516" class="difflineminus">-static int</span>
<a href="#l104.517"></a><span id="l104.517" class="difflineminus">-MimeInlineTextRichtext_parse_eof (MimeObject *obj, bool abort_p)</span>
<a href="#l104.518"></a><span id="l104.518" class="difflineminus">-{</span>
<a href="#l104.519"></a><span id="l104.519" class="difflineplus">+static int MimeInlineTextRichtext_parse_eof(MimeObject *obj, bool abort_p) {</span>
<a href="#l104.520"></a><span id="l104.520">   int status;</span>
<a href="#l104.521"></a><span id="l104.521">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l104.522"></a><span id="l104.522"> </span>
<a href="#l104.523"></a><span id="l104.523">   /* Run parent method first, to flush out any buffered data. */</span>
<a href="#l104.524"></a><span id="l104.524" class="difflineminus">-  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l104.525"></a><span id="l104.525" class="difflineplus">+  status = ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l104.526"></a><span id="l104.526">   if (status &lt; 0) return status;</span>
<a href="#l104.527"></a><span id="l104.527"> </span>
<a href="#l104.528"></a><span id="l104.528">   return 0;</span>
<a href="#l104.529"></a><span id="l104.529"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l105.1"></a><span id="l105.1" class="difflineminus">--- a/mailnews/mime/src/mimetric.h</span>
<a href="#l105.2"></a><span id="l105.2" class="difflineplus">+++ b/mailnews/mime/src/mimetric.h</span>
<a href="#l105.3"></a><span id="l105.3" class="difflineat">@@ -9,25 +9,25 @@</span>
<a href="#l105.4"></a><span id="l105.4"> #include &quot;mimetext.h&quot;</span>
<a href="#l105.5"></a><span id="l105.5"> </span>
<a href="#l105.6"></a><span id="l105.6"> /* The MimeInlineTextRichtext class implements the (obsolete and deprecated)</span>
<a href="#l105.7"></a><span id="l105.7">    text/richtext MIME content type, as defined in RFC 1341, and also the</span>
<a href="#l105.8"></a><span id="l105.8">    text/enriched MIME content type, as defined in RFC 1563.</span>
<a href="#l105.9"></a><span id="l105.9">  */</span>
<a href="#l105.10"></a><span id="l105.10"> </span>
<a href="#l105.11"></a><span id="l105.11"> typedef struct MimeInlineTextRichtextClass MimeInlineTextRichtextClass;</span>
<a href="#l105.12"></a><span id="l105.12" class="difflineminus">-typedef struct MimeInlineTextRichtext      MimeInlineTextRichtext;</span>
<a href="#l105.13"></a><span id="l105.13" class="difflineplus">+typedef struct MimeInlineTextRichtext MimeInlineTextRichtext;</span>
<a href="#l105.14"></a><span id="l105.14"> </span>
<a href="#l105.15"></a><span id="l105.15"> struct MimeInlineTextRichtextClass {</span>
<a href="#l105.16"></a><span id="l105.16">   MimeInlineTextClass text;</span>
<a href="#l105.17"></a><span id="l105.17" class="difflineminus">-  bool enriched_p;  /* Whether we should act like text/enriched instead. */</span>
<a href="#l105.18"></a><span id="l105.18" class="difflineplus">+  bool enriched_p; /* Whether we should act like text/enriched instead. */</span>
<a href="#l105.19"></a><span id="l105.19"> };</span>
<a href="#l105.20"></a><span id="l105.20"> </span>
<a href="#l105.21"></a><span id="l105.21"> extern MimeInlineTextRichtextClass mimeInlineTextRichtextClass;</span>
<a href="#l105.22"></a><span id="l105.22"> </span>
<a href="#l105.23"></a><span id="l105.23"> struct MimeInlineTextRichtext {</span>
<a href="#l105.24"></a><span id="l105.24">   MimeInlineText text;</span>
<a href="#l105.25"></a><span id="l105.25"> };</span>
<a href="#l105.26"></a><span id="l105.26"> </span>
<a href="#l105.27"></a><span id="l105.27" class="difflineminus">-#define MimeInlineTextRichtextClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l105.28"></a><span id="l105.28" class="difflineminus">-  { MimeInlineTextClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l105.29"></a><span id="l105.29" class="difflineplus">+#define MimeInlineTextRichtextClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l105.30"></a><span id="l105.30" class="difflineplus">+  { MimeInlineTextClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l105.31"></a><span id="l105.31"> </span>
<a href="#l105.32"></a><span id="l105.32"> #endif /* _MIMETRIC_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l106.1"></a><span id="l106.1" class="difflineminus">--- a/mailnews/mime/src/mimeunty.cpp</span>
<a href="#l106.2"></a><span id="l106.2" class="difflineplus">+++ b/mailnews/mime/src/mimeunty.cpp</span>
<a href="#l106.3"></a><span id="l106.3" class="difflineat">@@ -8,272 +8,220 @@</span>
<a href="#l106.4"></a><span id="l106.4"> #include &quot;plstr.h&quot;</span>
<a href="#l106.5"></a><span id="l106.5"> #include &quot;prlog.h&quot;</span>
<a href="#l106.6"></a><span id="l106.6"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l106.7"></a><span id="l106.7"> #include &quot;msgCore.h&quot;</span>
<a href="#l106.8"></a><span id="l106.8"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l106.9"></a><span id="l106.9"> #include &lt;ctype.h&gt;</span>
<a href="#l106.10"></a><span id="l106.10"> </span>
<a href="#l106.11"></a><span id="l106.11"> #define MIME_SUPERCLASS mimeContainerClass</span>
<a href="#l106.12"></a><span id="l106.12" class="difflineminus">-MimeDefClass(MimeUntypedText, MimeUntypedTextClass,</span>
<a href="#l106.13"></a><span id="l106.13" class="difflineminus">-       mimeUntypedTextClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l106.14"></a><span id="l106.14" class="difflineminus">-</span>
<a href="#l106.15"></a><span id="l106.15" class="difflineminus">-static int MimeUntypedText_initialize (MimeObject *);</span>
<a href="#l106.16"></a><span id="l106.16" class="difflineminus">-static void MimeUntypedText_finalize (MimeObject *);</span>
<a href="#l106.17"></a><span id="l106.17" class="difflineminus">-static int MimeUntypedText_parse_begin (MimeObject *);</span>
<a href="#l106.18"></a><span id="l106.18" class="difflineminus">-static int MimeUntypedText_parse_line (const char *, int32_t, MimeObject *);</span>
<a href="#l106.19"></a><span id="l106.19" class="difflineplus">+MimeDefClass(MimeUntypedText, MimeUntypedTextClass, mimeUntypedTextClass,</span>
<a href="#l106.20"></a><span id="l106.20" class="difflineplus">+             &amp;MIME_SUPERCLASS);</span>
<a href="#l106.21"></a><span id="l106.21"> </span>
<a href="#l106.22"></a><span id="l106.22" class="difflineminus">-static int MimeUntypedText_open_subpart (MimeObject *obj,</span>
<a href="#l106.23"></a><span id="l106.23" class="difflineminus">-                     MimeUntypedTextSubpartType ttype,</span>
<a href="#l106.24"></a><span id="l106.24" class="difflineminus">-                     const char *type,</span>
<a href="#l106.25"></a><span id="l106.25" class="difflineminus">-                     const char *enc,</span>
<a href="#l106.26"></a><span id="l106.26" class="difflineminus">-                     const char *name,</span>
<a href="#l106.27"></a><span id="l106.27" class="difflineminus">-                     const char *desc);</span>
<a href="#l106.28"></a><span id="l106.28" class="difflineminus">-static int MimeUntypedText_close_subpart (MimeObject *obj);</span>
<a href="#l106.29"></a><span id="l106.29" class="difflineplus">+static int MimeUntypedText_initialize(MimeObject *);</span>
<a href="#l106.30"></a><span id="l106.30" class="difflineplus">+static void MimeUntypedText_finalize(MimeObject *);</span>
<a href="#l106.31"></a><span id="l106.31" class="difflineplus">+static int MimeUntypedText_parse_begin(MimeObject *);</span>
<a href="#l106.32"></a><span id="l106.32" class="difflineplus">+static int MimeUntypedText_parse_line(const char *, int32_t, MimeObject *);</span>
<a href="#l106.33"></a><span id="l106.33" class="difflineplus">+</span>
<a href="#l106.34"></a><span id="l106.34" class="difflineplus">+static int MimeUntypedText_open_subpart(MimeObject *obj,</span>
<a href="#l106.35"></a><span id="l106.35" class="difflineplus">+                                        MimeUntypedTextSubpartType ttype,</span>
<a href="#l106.36"></a><span id="l106.36" class="difflineplus">+                                        const char *type, const char *enc,</span>
<a href="#l106.37"></a><span id="l106.37" class="difflineplus">+                                        const char *name, const char *desc);</span>
<a href="#l106.38"></a><span id="l106.38" class="difflineplus">+static int MimeUntypedText_close_subpart(MimeObject *obj);</span>
<a href="#l106.39"></a><span id="l106.39"> </span>
<a href="#l106.40"></a><span id="l106.40"> static bool MimeUntypedText_uu_begin_line_p(const char *line, int32_t length,</span>
<a href="#l106.41"></a><span id="l106.41" class="difflineminus">-                         MimeDisplayOptions *opt,</span>
<a href="#l106.42"></a><span id="l106.42" class="difflineminus">-                         char **type_ret,</span>
<a href="#l106.43"></a><span id="l106.43" class="difflineminus">-                         char **name_ret);</span>
<a href="#l106.44"></a><span id="l106.44" class="difflineplus">+                                            MimeDisplayOptions *opt,</span>
<a href="#l106.45"></a><span id="l106.45" class="difflineplus">+                                            char **type_ret, char **name_ret);</span>
<a href="#l106.46"></a><span id="l106.46"> static bool MimeUntypedText_uu_end_line_p(const char *line, int32_t length);</span>
<a href="#l106.47"></a><span id="l106.47"> </span>
<a href="#l106.48"></a><span id="l106.48"> static bool MimeUntypedText_yenc_begin_line_p(const char *line, int32_t length,</span>
<a href="#l106.49"></a><span id="l106.49" class="difflineminus">-                         MimeDisplayOptions *opt,</span>
<a href="#l106.50"></a><span id="l106.50" class="difflineminus">-                         char **type_ret,</span>
<a href="#l106.51"></a><span id="l106.51" class="difflineminus">-                         char **name_ret);</span>
<a href="#l106.52"></a><span id="l106.52" class="difflineplus">+                                              MimeDisplayOptions *opt,</span>
<a href="#l106.53"></a><span id="l106.53" class="difflineplus">+                                              char **type_ret, char **name_ret);</span>
<a href="#l106.54"></a><span id="l106.54"> static bool MimeUntypedText_yenc_end_line_p(const char *line, int32_t length);</span>
<a href="#l106.55"></a><span id="l106.55"> </span>
<a href="#l106.56"></a><span id="l106.56"> static bool MimeUntypedText_binhex_begin_line_p(const char *line,</span>
<a href="#l106.57"></a><span id="l106.57" class="difflineminus">-                           int32_t length,</span>
<a href="#l106.58"></a><span id="l106.58" class="difflineminus">-                           MimeDisplayOptions *opt);</span>
<a href="#l106.59"></a><span id="l106.59" class="difflineminus">-static bool MimeUntypedText_binhex_end_line_p(const char *line,</span>
<a href="#l106.60"></a><span id="l106.60" class="difflineminus">-                         int32_t length);</span>
<a href="#l106.61"></a><span id="l106.61" class="difflineplus">+                                                int32_t length,</span>
<a href="#l106.62"></a><span id="l106.62" class="difflineplus">+                                                MimeDisplayOptions *opt);</span>
<a href="#l106.63"></a><span id="l106.63" class="difflineplus">+static bool MimeUntypedText_binhex_end_line_p(const char *line, int32_t length);</span>
<a href="#l106.64"></a><span id="l106.64"> </span>
<a href="#l106.65"></a><span id="l106.65" class="difflineminus">-static int</span>
<a href="#l106.66"></a><span id="l106.66" class="difflineminus">-MimeUntypedTextClassInitialize(MimeUntypedTextClass *clazz)</span>
<a href="#l106.67"></a><span id="l106.67" class="difflineminus">-{</span>
<a href="#l106.68"></a><span id="l106.68" class="difflineminus">-  MimeObjectClass *oclass = (MimeObjectClass *) clazz;</span>
<a href="#l106.69"></a><span id="l106.69" class="difflineplus">+static int MimeUntypedTextClassInitialize(MimeUntypedTextClass *clazz) {</span>
<a href="#l106.70"></a><span id="l106.70" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l106.71"></a><span id="l106.71">   PR_ASSERT(!oclass-&gt;class_initialized);</span>
<a href="#l106.72"></a><span id="l106.72" class="difflineminus">-  oclass-&gt;initialize  = MimeUntypedText_initialize;</span>
<a href="#l106.73"></a><span id="l106.73" class="difflineminus">-  oclass-&gt;finalize    = MimeUntypedText_finalize;</span>
<a href="#l106.74"></a><span id="l106.74" class="difflineplus">+  oclass-&gt;initialize = MimeUntypedText_initialize;</span>
<a href="#l106.75"></a><span id="l106.75" class="difflineplus">+  oclass-&gt;finalize = MimeUntypedText_finalize;</span>
<a href="#l106.76"></a><span id="l106.76">   oclass-&gt;parse_begin = MimeUntypedText_parse_begin;</span>
<a href="#l106.77"></a><span id="l106.77" class="difflineminus">-  oclass-&gt;parse_line  = MimeUntypedText_parse_line;</span>
<a href="#l106.78"></a><span id="l106.78" class="difflineplus">+  oclass-&gt;parse_line = MimeUntypedText_parse_line;</span>
<a href="#l106.79"></a><span id="l106.79">   return 0;</span>
<a href="#l106.80"></a><span id="l106.80"> }</span>
<a href="#l106.81"></a><span id="l106.81"> </span>
<a href="#l106.82"></a><span id="l106.82" class="difflineminus">-</span>
<a href="#l106.83"></a><span id="l106.83" class="difflineminus">-static int</span>
<a href="#l106.84"></a><span id="l106.84" class="difflineminus">-MimeUntypedText_initialize (MimeObject *object)</span>
<a href="#l106.85"></a><span id="l106.85" class="difflineminus">-{</span>
<a href="#l106.86"></a><span id="l106.86" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l106.87"></a><span id="l106.87" class="difflineplus">+static int MimeUntypedText_initialize(MimeObject *object) {</span>
<a href="#l106.88"></a><span id="l106.88" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l106.89"></a><span id="l106.89"> }</span>
<a href="#l106.90"></a><span id="l106.90"> </span>
<a href="#l106.91"></a><span id="l106.91" class="difflineminus">-static void</span>
<a href="#l106.92"></a><span id="l106.92" class="difflineminus">-MimeUntypedText_finalize (MimeObject *object)</span>
<a href="#l106.93"></a><span id="l106.93" class="difflineminus">-{</span>
<a href="#l106.94"></a><span id="l106.94" class="difflineminus">-  MimeUntypedText *uty = (MimeUntypedText *) object;</span>
<a href="#l106.95"></a><span id="l106.95" class="difflineplus">+static void MimeUntypedText_finalize(MimeObject *object) {</span>
<a href="#l106.96"></a><span id="l106.96" class="difflineplus">+  MimeUntypedText *uty = (MimeUntypedText *)object;</span>
<a href="#l106.97"></a><span id="l106.97"> </span>
<a href="#l106.98"></a><span id="l106.98" class="difflineminus">-  if (uty-&gt;open_hdrs)</span>
<a href="#l106.99"></a><span id="l106.99" class="difflineminus">-  {</span>
<a href="#l106.100"></a><span id="l106.100" class="difflineplus">+  if (uty-&gt;open_hdrs) {</span>
<a href="#l106.101"></a><span id="l106.101">     /* Oops, those shouldn't still be here... */</span>
<a href="#l106.102"></a><span id="l106.102">     MimeHeaders_free(uty-&gt;open_hdrs);</span>
<a href="#l106.103"></a><span id="l106.103">     uty-&gt;open_hdrs = 0;</span>
<a href="#l106.104"></a><span id="l106.104">   }</span>
<a href="#l106.105"></a><span id="l106.105"> </span>
<a href="#l106.106"></a><span id="l106.106">   /* What about the open_subpart?  We're going to have to assume that it</span>
<a href="#l106.107"></a><span id="l106.107">    is also on the MimeContainer-&gt;children list, and will get cleaned</span>
<a href="#l106.108"></a><span id="l106.108">    up by that class. */</span>
<a href="#l106.109"></a><span id="l106.109"> </span>
<a href="#l106.110"></a><span id="l106.110" class="difflineminus">-  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l106.111"></a><span id="l106.111" class="difflineplus">+  ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;finalize(object);</span>
<a href="#l106.112"></a><span id="l106.112"> }</span>
<a href="#l106.113"></a><span id="l106.113"> </span>
<a href="#l106.114"></a><span id="l106.114" class="difflineminus">-static int</span>
<a href="#l106.115"></a><span id="l106.115" class="difflineminus">-MimeUntypedText_parse_begin (MimeObject *obj)</span>
<a href="#l106.116"></a><span id="l106.116" class="difflineminus">-{</span>
<a href="#l106.117"></a><span id="l106.117" class="difflineminus">-  return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l106.118"></a><span id="l106.118" class="difflineplus">+static int MimeUntypedText_parse_begin(MimeObject *obj) {</span>
<a href="#l106.119"></a><span id="l106.119" class="difflineplus">+  return ((MimeObjectClass *)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l106.120"></a><span id="l106.120"> }</span>
<a href="#l106.121"></a><span id="l106.121"> </span>
<a href="#l106.122"></a><span id="l106.122" class="difflineminus">-static int</span>
<a href="#l106.123"></a><span id="l106.123" class="difflineminus">-MimeUntypedText_parse_line (const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l106.124"></a><span id="l106.124" class="difflineminus">-{</span>
<a href="#l106.125"></a><span id="l106.125" class="difflineminus">-  MimeUntypedText *uty = (MimeUntypedText *) obj;</span>
<a href="#l106.126"></a><span id="l106.126" class="difflineplus">+static int MimeUntypedText_parse_line(const char *line, int32_t length,</span>
<a href="#l106.127"></a><span id="l106.127" class="difflineplus">+                                      MimeObject *obj) {</span>
<a href="#l106.128"></a><span id="l106.128" class="difflineplus">+  MimeUntypedText *uty = (MimeUntypedText *)obj;</span>
<a href="#l106.129"></a><span id="l106.129">   int status = 0;</span>
<a href="#l106.130"></a><span id="l106.130">   char *name = 0, *type = 0;</span>
<a href="#l106.131"></a><span id="l106.131">   bool begin_line_p = false;</span>
<a href="#l106.132"></a><span id="l106.132"> </span>
<a href="#l106.133"></a><span id="l106.133">   NS_ASSERTION(line &amp;&amp; *line, &quot;empty line in mime untyped parse_line&quot;);</span>
<a href="#l106.134"></a><span id="l106.134">   if (!line || !*line) return -1;</span>
<a href="#l106.135"></a><span id="l106.135"> </span>
<a href="#l106.136"></a><span id="l106.136">   /* If we're supposed to write this object, but aren't supposed to convert</span>
<a href="#l106.137"></a><span id="l106.137">    it to HTML, simply pass it through unaltered. */</span>
<a href="#l106.138"></a><span id="l106.138" class="difflineminus">-  if (obj-&gt;output_p &amp;&amp;</span>
<a href="#l106.139"></a><span id="l106.139" class="difflineminus">-    obj-&gt;options &amp;&amp;</span>
<a href="#l106.140"></a><span id="l106.140" class="difflineminus">-    !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l106.141"></a><span id="l106.141" class="difflineminus">-    obj-&gt;options-&gt;output_fn)</span>
<a href="#l106.142"></a><span id="l106.142" class="difflineminus">-  return MimeObject_write(obj, line, length, true);</span>
<a href="#l106.143"></a><span id="l106.143" class="difflineminus">-</span>
<a href="#l106.144"></a><span id="l106.144" class="difflineplus">+  if (obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l106.145"></a><span id="l106.145" class="difflineplus">+      obj-&gt;options-&gt;output_fn)</span>
<a href="#l106.146"></a><span id="l106.146" class="difflineplus">+    return MimeObject_write(obj, line, length, true);</span>
<a href="#l106.147"></a><span id="l106.147"> </span>
<a href="#l106.148"></a><span id="l106.148">   /* Open a new sub-part if this line demands it.</span>
<a href="#l106.149"></a><span id="l106.149">    */</span>
<a href="#l106.150"></a><span id="l106.150" class="difflineminus">-  if (line[0] == 'b' &amp;&amp;</span>
<a href="#l106.151"></a><span id="l106.151" class="difflineminus">-    MimeUntypedText_uu_begin_line_p(line, length, obj-&gt;options,</span>
<a href="#l106.152"></a><span id="l106.152" class="difflineminus">-                    &amp;type, &amp;name))</span>
<a href="#l106.153"></a><span id="l106.153" class="difflineminus">-  {</span>
<a href="#l106.154"></a><span id="l106.154" class="difflineplus">+  if (line[0] == 'b' &amp;&amp; MimeUntypedText_uu_begin_line_p(</span>
<a href="#l106.155"></a><span id="l106.155" class="difflineplus">+                            line, length, obj-&gt;options, &amp;type, &amp;name)) {</span>
<a href="#l106.156"></a><span id="l106.156">     /* Close the old part and open a new one. */</span>
<a href="#l106.157"></a><span id="l106.157" class="difflineminus">-    status = MimeUntypedText_open_subpart (obj,</span>
<a href="#l106.158"></a><span id="l106.158" class="difflineminus">-                       MimeUntypedTextSubpartTypeUUE,</span>
<a href="#l106.159"></a><span id="l106.159" class="difflineminus">-                       type, ENCODING_UUENCODE,</span>
<a href="#l106.160"></a><span id="l106.160" class="difflineminus">-                       name, NULL);</span>
<a href="#l106.161"></a><span id="l106.161" class="difflineplus">+    status = MimeUntypedText_open_subpart(obj, MimeUntypedTextSubpartTypeUUE,</span>
<a href="#l106.162"></a><span id="l106.162" class="difflineplus">+                                          type, ENCODING_UUENCODE, name, NULL);</span>
<a href="#l106.163"></a><span id="l106.163">     PR_FREEIF(name);</span>
<a href="#l106.164"></a><span id="l106.164">     PR_FREEIF(type);</span>
<a href="#l106.165"></a><span id="l106.165">     if (status &lt; 0) return status;</span>
<a href="#l106.166"></a><span id="l106.166">     begin_line_p = true;</span>
<a href="#l106.167"></a><span id="l106.167">   }</span>
<a href="#l106.168"></a><span id="l106.168"> </span>
<a href="#l106.169"></a><span id="l106.169" class="difflineminus">-  else if (line[0] == '=' &amp;&amp;</span>
<a href="#l106.170"></a><span id="l106.170" class="difflineminus">-    MimeUntypedText_yenc_begin_line_p(line, length, obj-&gt;options,</span>
<a href="#l106.171"></a><span id="l106.171" class="difflineminus">-                    &amp;type, &amp;name))</span>
<a href="#l106.172"></a><span id="l106.172" class="difflineminus">-  {</span>
<a href="#l106.173"></a><span id="l106.173" class="difflineplus">+  else if (line[0] == '=' &amp;&amp; MimeUntypedText_yenc_begin_line_p(</span>
<a href="#l106.174"></a><span id="l106.174" class="difflineplus">+                                 line, length, obj-&gt;options, &amp;type, &amp;name)) {</span>
<a href="#l106.175"></a><span id="l106.175">     /* Close the old part and open a new one. */</span>
<a href="#l106.176"></a><span id="l106.176" class="difflineminus">-    status = MimeUntypedText_open_subpart (obj,</span>
<a href="#l106.177"></a><span id="l106.177" class="difflineminus">-                       MimeUntypedTextSubpartTypeYEnc,</span>
<a href="#l106.178"></a><span id="l106.178" class="difflineminus">-                       type, ENCODING_YENCODE,</span>
<a href="#l106.179"></a><span id="l106.179" class="difflineminus">-                       name, NULL);</span>
<a href="#l106.180"></a><span id="l106.180" class="difflineplus">+    status = MimeUntypedText_open_subpart(obj, MimeUntypedTextSubpartTypeYEnc,</span>
<a href="#l106.181"></a><span id="l106.181" class="difflineplus">+                                          type, ENCODING_YENCODE, name, NULL);</span>
<a href="#l106.182"></a><span id="l106.182">     PR_FREEIF(name);</span>
<a href="#l106.183"></a><span id="l106.183">     PR_FREEIF(type);</span>
<a href="#l106.184"></a><span id="l106.184">     if (status &lt; 0) return status;</span>
<a href="#l106.185"></a><span id="l106.185">     begin_line_p = true;</span>
<a href="#l106.186"></a><span id="l106.186">   }</span>
<a href="#l106.187"></a><span id="l106.187"> </span>
<a href="#l106.188"></a><span id="l106.188">   else if (line[0] == '(' &amp;&amp; line[1] == 'T' &amp;&amp;</span>
<a href="#l106.189"></a><span id="l106.189" class="difflineminus">-       MimeUntypedText_binhex_begin_line_p(line, length, obj-&gt;options))</span>
<a href="#l106.190"></a><span id="l106.190" class="difflineminus">-  {</span>
<a href="#l106.191"></a><span id="l106.191" class="difflineplus">+           MimeUntypedText_binhex_begin_line_p(line, length, obj-&gt;options)) {</span>
<a href="#l106.192"></a><span id="l106.192">     /* Close the old part and open a new one. */</span>
<a href="#l106.193"></a><span id="l106.193" class="difflineminus">-    status = MimeUntypedText_open_subpart (obj,</span>
<a href="#l106.194"></a><span id="l106.194" class="difflineminus">-                       MimeUntypedTextSubpartTypeBinhex,</span>
<a href="#l106.195"></a><span id="l106.195" class="difflineminus">-                       APPLICATION_BINHEX, NULL,</span>
<a href="#l106.196"></a><span id="l106.196" class="difflineminus">-                       NULL, NULL);</span>
<a href="#l106.197"></a><span id="l106.197" class="difflineplus">+    status = MimeUntypedText_open_subpart(obj, MimeUntypedTextSubpartTypeBinhex,</span>
<a href="#l106.198"></a><span id="l106.198" class="difflineplus">+                                          APPLICATION_BINHEX, NULL, NULL, NULL);</span>
<a href="#l106.199"></a><span id="l106.199">     if (status &lt; 0) return status;</span>
<a href="#l106.200"></a><span id="l106.200">     begin_line_p = true;</span>
<a href="#l106.201"></a><span id="l106.201">   }</span>
<a href="#l106.202"></a><span id="l106.202"> </span>
<a href="#l106.203"></a><span id="l106.203">   /* Open a text/plain sub-part if there is no sub-part open.</span>
<a href="#l106.204"></a><span id="l106.204">    */</span>
<a href="#l106.205"></a><span id="l106.205" class="difflineminus">-  if (!uty-&gt;open_subpart)</span>
<a href="#l106.206"></a><span id="l106.206" class="difflineminus">-  {</span>
<a href="#l106.207"></a><span id="l106.207" class="difflineplus">+  if (!uty-&gt;open_subpart) {</span>
<a href="#l106.208"></a><span id="l106.208">     // rhp: If we get here and we are being fed a line ending, we should</span>
<a href="#l106.209"></a><span id="l106.209">     // just eat it and continue and if we really get more data, we'll open</span>
<a href="#l106.210"></a><span id="l106.210">     // up the subpart then.</span>
<a href="#l106.211"></a><span id="l106.211">     //</span>
<a href="#l106.212"></a><span id="l106.212">     if (line[0] == '\r') return 0;</span>
<a href="#l106.213"></a><span id="l106.213">     if (line[0] == '\n') return 0;</span>
<a href="#l106.214"></a><span id="l106.214"> </span>
<a href="#l106.215"></a><span id="l106.215">     PR_ASSERT(!begin_line_p);</span>
<a href="#l106.216"></a><span id="l106.216" class="difflineminus">-    status = MimeUntypedText_open_subpart (obj,</span>
<a href="#l106.217"></a><span id="l106.217" class="difflineminus">-                       MimeUntypedTextSubpartTypeText,</span>
<a href="#l106.218"></a><span id="l106.218" class="difflineminus">-                       TEXT_PLAIN, NULL, NULL, NULL);</span>
<a href="#l106.219"></a><span id="l106.219" class="difflineplus">+    status = MimeUntypedText_open_subpart(obj, MimeUntypedTextSubpartTypeText,</span>
<a href="#l106.220"></a><span id="l106.220" class="difflineplus">+                                          TEXT_PLAIN, NULL, NULL, NULL);</span>
<a href="#l106.221"></a><span id="l106.221">     PR_ASSERT(uty-&gt;open_subpart);</span>
<a href="#l106.222"></a><span id="l106.222">     if (!uty-&gt;open_subpart) return -1;</span>
<a href="#l106.223"></a><span id="l106.223">     if (status &lt; 0) return status;</span>
<a href="#l106.224"></a><span id="l106.224">   }</span>
<a href="#l106.225"></a><span id="l106.225"> </span>
<a href="#l106.226"></a><span id="l106.226">   /* Hand this line to the currently-open sub-part.</span>
<a href="#l106.227"></a><span id="l106.227">    */</span>
<a href="#l106.228"></a><span id="l106.228" class="difflineminus">-  status = uty-&gt;open_subpart-&gt;clazz-&gt;parse_buffer(line, length,</span>
<a href="#l106.229"></a><span id="l106.229" class="difflineminus">-                          uty-&gt;open_subpart);</span>
<a href="#l106.230"></a><span id="l106.230" class="difflineplus">+  status =</span>
<a href="#l106.231"></a><span id="l106.231" class="difflineplus">+      uty-&gt;open_subpart-&gt;clazz-&gt;parse_buffer(line, length, uty-&gt;open_subpart);</span>
<a href="#l106.232"></a><span id="l106.232">   if (status &lt; 0) return status;</span>
<a href="#l106.233"></a><span id="l106.233"> </span>
<a href="#l106.234"></a><span id="l106.234">   /* Close this sub-part if this line demands it.</span>
<a href="#l106.235"></a><span id="l106.235">    */</span>
<a href="#l106.236"></a><span id="l106.236">   if (begin_line_p)</span>
<a href="#l106.237"></a><span id="l106.237" class="difflineminus">-  ;</span>
<a href="#l106.238"></a><span id="l106.238" class="difflineminus">-  else if (line[0] == 'e' &amp;&amp;</span>
<a href="#l106.239"></a><span id="l106.239" class="difflineminus">-       uty-&gt;type == MimeUntypedTextSubpartTypeUUE &amp;&amp;</span>
<a href="#l106.240"></a><span id="l106.240" class="difflineminus">-       MimeUntypedText_uu_end_line_p(line, length))</span>
<a href="#l106.241"></a><span id="l106.241" class="difflineminus">-  {</span>
<a href="#l106.242"></a><span id="l106.242" class="difflineminus">-    status = MimeUntypedText_close_subpart (obj);</span>
<a href="#l106.243"></a><span id="l106.243" class="difflineplus">+    ;</span>
<a href="#l106.244"></a><span id="l106.244" class="difflineplus">+  else if (line[0] == 'e' &amp;&amp; uty-&gt;type == MimeUntypedTextSubpartTypeUUE &amp;&amp;</span>
<a href="#l106.245"></a><span id="l106.245" class="difflineplus">+           MimeUntypedText_uu_end_line_p(line, length)) {</span>
<a href="#l106.246"></a><span id="l106.246" class="difflineplus">+    status = MimeUntypedText_close_subpart(obj);</span>
<a href="#l106.247"></a><span id="l106.247">     if (status &lt; 0) return status;</span>
<a href="#l106.248"></a><span id="l106.248">     NS_ASSERTION(!uty-&gt;open_subpart, &quot;no open subpart&quot;);</span>
<a href="#l106.249"></a><span id="l106.249" class="difflineminus">-  }</span>
<a href="#l106.250"></a><span id="l106.250" class="difflineminus">-  else if (line[0] == '=' &amp;&amp;</span>
<a href="#l106.251"></a><span id="l106.251" class="difflineminus">-       uty-&gt;type == MimeUntypedTextSubpartTypeYEnc &amp;&amp;</span>
<a href="#l106.252"></a><span id="l106.252" class="difflineminus">-       MimeUntypedText_yenc_end_line_p(line, length))</span>
<a href="#l106.253"></a><span id="l106.253" class="difflineminus">-  {</span>
<a href="#l106.254"></a><span id="l106.254" class="difflineminus">-    status = MimeUntypedText_close_subpart (obj);</span>
<a href="#l106.255"></a><span id="l106.255" class="difflineplus">+  } else if (line[0] == '=' &amp;&amp; uty-&gt;type == MimeUntypedTextSubpartTypeYEnc &amp;&amp;</span>
<a href="#l106.256"></a><span id="l106.256" class="difflineplus">+             MimeUntypedText_yenc_end_line_p(line, length)) {</span>
<a href="#l106.257"></a><span id="l106.257" class="difflineplus">+    status = MimeUntypedText_close_subpart(obj);</span>
<a href="#l106.258"></a><span id="l106.258">     if (status &lt; 0) return status;</span>
<a href="#l106.259"></a><span id="l106.259">     NS_ASSERTION(!uty-&gt;open_subpart, &quot;no open subpart&quot;);</span>
<a href="#l106.260"></a><span id="l106.260" class="difflineminus">-  }</span>
<a href="#l106.261"></a><span id="l106.261" class="difflineminus">-  else if (uty-&gt;type == MimeUntypedTextSubpartTypeBinhex &amp;&amp;</span>
<a href="#l106.262"></a><span id="l106.262" class="difflineminus">-       MimeUntypedText_binhex_end_line_p(line, length))</span>
<a href="#l106.263"></a><span id="l106.263" class="difflineminus">-  {</span>
<a href="#l106.264"></a><span id="l106.264" class="difflineminus">-    status = MimeUntypedText_close_subpart (obj);</span>
<a href="#l106.265"></a><span id="l106.265" class="difflineplus">+  } else if (uty-&gt;type == MimeUntypedTextSubpartTypeBinhex &amp;&amp;</span>
<a href="#l106.266"></a><span id="l106.266" class="difflineplus">+             MimeUntypedText_binhex_end_line_p(line, length)) {</span>
<a href="#l106.267"></a><span id="l106.267" class="difflineplus">+    status = MimeUntypedText_close_subpart(obj);</span>
<a href="#l106.268"></a><span id="l106.268">     if (status &lt; 0) return status;</span>
<a href="#l106.269"></a><span id="l106.269">     NS_ASSERTION(!uty-&gt;open_subpart, &quot;no open subpart&quot;);</span>
<a href="#l106.270"></a><span id="l106.270">   }</span>
<a href="#l106.271"></a><span id="l106.271"> </span>
<a href="#l106.272"></a><span id="l106.272">   return 0;</span>
<a href="#l106.273"></a><span id="l106.273"> }</span>
<a href="#l106.274"></a><span id="l106.274"> </span>
<a href="#l106.275"></a><span id="l106.275" class="difflineminus">-</span>
<a href="#l106.276"></a><span id="l106.276" class="difflineminus">-static int</span>
<a href="#l106.277"></a><span id="l106.277" class="difflineminus">-MimeUntypedText_close_subpart (MimeObject *obj)</span>
<a href="#l106.278"></a><span id="l106.278" class="difflineminus">-{</span>
<a href="#l106.279"></a><span id="l106.279" class="difflineminus">-  MimeUntypedText *uty = (MimeUntypedText *) obj;</span>
<a href="#l106.280"></a><span id="l106.280" class="difflineplus">+static int MimeUntypedText_close_subpart(MimeObject *obj) {</span>
<a href="#l106.281"></a><span id="l106.281" class="difflineplus">+  MimeUntypedText *uty = (MimeUntypedText *)obj;</span>
<a href="#l106.282"></a><span id="l106.282">   int status;</span>
<a href="#l106.283"></a><span id="l106.283"> </span>
<a href="#l106.284"></a><span id="l106.284" class="difflineminus">-  if (uty-&gt;open_subpart)</span>
<a href="#l106.285"></a><span id="l106.285" class="difflineminus">-  {</span>
<a href="#l106.286"></a><span id="l106.286" class="difflineplus">+  if (uty-&gt;open_subpart) {</span>
<a href="#l106.287"></a><span id="l106.287">     status = uty-&gt;open_subpart-&gt;clazz-&gt;parse_eof(uty-&gt;open_subpart, false);</span>
<a href="#l106.288"></a><span id="l106.288">     uty-&gt;open_subpart = 0;</span>
<a href="#l106.289"></a><span id="l106.289"> </span>
<a href="#l106.290"></a><span id="l106.290">     PR_ASSERT(uty-&gt;open_hdrs);</span>
<a href="#l106.291"></a><span id="l106.291" class="difflineminus">-    if (uty-&gt;open_hdrs)</span>
<a href="#l106.292"></a><span id="l106.292" class="difflineminus">-    {</span>
<a href="#l106.293"></a><span id="l106.293" class="difflineplus">+    if (uty-&gt;open_hdrs) {</span>
<a href="#l106.294"></a><span id="l106.294">       MimeHeaders_free(uty-&gt;open_hdrs);</span>
<a href="#l106.295"></a><span id="l106.295">       uty-&gt;open_hdrs = 0;</span>
<a href="#l106.296"></a><span id="l106.296">     }</span>
<a href="#l106.297"></a><span id="l106.297">     uty-&gt;type = MimeUntypedTextSubpartTypeText;</span>
<a href="#l106.298"></a><span id="l106.298">     if (status &lt; 0) return status;</span>
<a href="#l106.299"></a><span id="l106.299"> </span>
<a href="#l106.300"></a><span id="l106.300">     /* Never put out a separator between sub-parts of UntypedText.</span>
<a href="#l106.301"></a><span id="l106.301">      (This bypasses the rule that text/plain subparts always</span>
<a href="#l106.302"></a><span id="l106.302">      have separators before and after them.)</span>
<a href="#l106.303"></a><span id="l106.303">      */</span>
<a href="#l106.304"></a><span id="l106.304">     if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state)</span>
<a href="#l106.305"></a><span id="l106.305" class="difflineminus">-    obj-&gt;options-&gt;state-&gt;separator_suppressed_p = true;</span>
<a href="#l106.306"></a><span id="l106.306" class="difflineplus">+      obj-&gt;options-&gt;state-&gt;separator_suppressed_p = true;</span>
<a href="#l106.307"></a><span id="l106.307">   }</span>
<a href="#l106.308"></a><span id="l106.308"> </span>
<a href="#l106.309"></a><span id="l106.309">   PR_ASSERT(!uty-&gt;open_hdrs);</span>
<a href="#l106.310"></a><span id="l106.310">   return 0;</span>
<a href="#l106.311"></a><span id="l106.311"> }</span>
<a href="#l106.312"></a><span id="l106.312"> </span>
<a href="#l106.313"></a><span id="l106.313" class="difflineminus">-static int</span>
<a href="#l106.314"></a><span id="l106.314" class="difflineminus">-MimeUntypedText_open_subpart (MimeObject *obj,</span>
<a href="#l106.315"></a><span id="l106.315" class="difflineminus">-                MimeUntypedTextSubpartType ttype,</span>
<a href="#l106.316"></a><span id="l106.316" class="difflineminus">-                const char *type,</span>
<a href="#l106.317"></a><span id="l106.317" class="difflineminus">-                const char *enc,</span>
<a href="#l106.318"></a><span id="l106.318" class="difflineminus">-                const char *name,</span>
<a href="#l106.319"></a><span id="l106.319" class="difflineminus">-                const char *desc)</span>
<a href="#l106.320"></a><span id="l106.320" class="difflineminus">-{</span>
<a href="#l106.321"></a><span id="l106.321" class="difflineminus">-  MimeUntypedText *uty = (MimeUntypedText *) obj;</span>
<a href="#l106.322"></a><span id="l106.322" class="difflineplus">+static int MimeUntypedText_open_subpart(MimeObject *obj,</span>
<a href="#l106.323"></a><span id="l106.323" class="difflineplus">+                                        MimeUntypedTextSubpartType ttype,</span>
<a href="#l106.324"></a><span id="l106.324" class="difflineplus">+                                        const char *type, const char *enc,</span>
<a href="#l106.325"></a><span id="l106.325" class="difflineplus">+                                        const char *name, const char *desc) {</span>
<a href="#l106.326"></a><span id="l106.326" class="difflineplus">+  MimeUntypedText *uty = (MimeUntypedText *)obj;</span>
<a href="#l106.327"></a><span id="l106.327">   int status = 0;</span>
<a href="#l106.328"></a><span id="l106.328">   char *h = 0;</span>
<a href="#l106.329"></a><span id="l106.329"> </span>
<a href="#l106.330"></a><span id="l106.330">   if (!type || !*type || !PL_strcasecmp(type, UNKNOWN_CONTENT_TYPE))</span>
<a href="#l106.331"></a><span id="l106.331" class="difflineminus">-  type = APPLICATION_OCTET_STREAM;</span>
<a href="#l106.332"></a><span id="l106.332" class="difflineminus">-  if (enc &amp;&amp; !*enc)</span>
<a href="#l106.333"></a><span id="l106.333" class="difflineminus">-  enc = 0;</span>
<a href="#l106.334"></a><span id="l106.334" class="difflineminus">-  if (desc &amp;&amp; !*desc)</span>
<a href="#l106.335"></a><span id="l106.335" class="difflineminus">-  desc = 0;</span>
<a href="#l106.336"></a><span id="l106.336" class="difflineminus">-  if (name &amp;&amp; !*name)</span>
<a href="#l106.337"></a><span id="l106.337" class="difflineminus">-  name = 0;</span>
<a href="#l106.338"></a><span id="l106.338" class="difflineplus">+    type = APPLICATION_OCTET_STREAM;</span>
<a href="#l106.339"></a><span id="l106.339" class="difflineplus">+  if (enc &amp;&amp; !*enc) enc = 0;</span>
<a href="#l106.340"></a><span id="l106.340" class="difflineplus">+  if (desc &amp;&amp; !*desc) desc = 0;</span>
<a href="#l106.341"></a><span id="l106.341" class="difflineplus">+  if (name &amp;&amp; !*name) name = 0;</span>
<a href="#l106.342"></a><span id="l106.342"> </span>
<a href="#l106.343"></a><span id="l106.343" class="difflineminus">-  if (uty-&gt;open_subpart)</span>
<a href="#l106.344"></a><span id="l106.344" class="difflineminus">-  {</span>
<a href="#l106.345"></a><span id="l106.345" class="difflineminus">-    status = MimeUntypedText_close_subpart (obj);</span>
<a href="#l106.346"></a><span id="l106.346" class="difflineplus">+  if (uty-&gt;open_subpart) {</span>
<a href="#l106.347"></a><span id="l106.347" class="difflineplus">+    status = MimeUntypedText_close_subpart(obj);</span>
<a href="#l106.348"></a><span id="l106.348">     if (status &lt; 0) return status;</span>
<a href="#l106.349"></a><span id="l106.349">   }</span>
<a href="#l106.350"></a><span id="l106.350">   NS_ASSERTION(!uty-&gt;open_subpart, &quot;no open subpart&quot;);</span>
<a href="#l106.351"></a><span id="l106.351">   NS_ASSERTION(!uty-&gt;open_hdrs, &quot;no open headers&quot;);</span>
<a href="#l106.352"></a><span id="l106.352"> </span>
<a href="#l106.353"></a><span id="l106.353">   /* To make one of these implicitly-typed sub-objects, we make up a fake</span>
<a href="#l106.354"></a><span id="l106.354">    header block, containing only the minimum number of MIME headers needed.</span>
<a href="#l106.355"></a><span id="l106.355">    We could do most of this (Type and Encoding) by making a null header</span>
<a href="#l106.356"></a><span id="l106.356" class="difflineat">@@ -283,179 +231,160 @@ MimeUntypedText_open_subpart (MimeObject</span>
<a href="#l106.357"></a><span id="l106.357">    and second, it's the only way to communicate the filename parameter,</span>
<a href="#l106.358"></a><span id="l106.358">    aside from adding a new slot to MimeObject (which is something to be</span>
<a href="#l106.359"></a><span id="l106.359">    avoided when possible.)</span>
<a href="#l106.360"></a><span id="l106.360">    */</span>
<a href="#l106.361"></a><span id="l106.361"> </span>
<a href="#l106.362"></a><span id="l106.362">   uty-&gt;open_hdrs = MimeHeaders_new();</span>
<a href="#l106.363"></a><span id="l106.363">   if (!uty-&gt;open_hdrs) return MIME_OUT_OF_MEMORY;</span>
<a href="#l106.364"></a><span id="l106.364"> </span>
<a href="#l106.365"></a><span id="l106.365" class="difflineminus">-  uint32_t hlen = strlen(type) +</span>
<a href="#l106.366"></a><span id="l106.366" class="difflineminus">-                (enc ? strlen(enc) : 0) +</span>
<a href="#l106.367"></a><span id="l106.367" class="difflineminus">-                (desc ? strlen(desc) : 0) +</span>
<a href="#l106.368"></a><span id="l106.368" class="difflineminus">-                (name ? strlen(name) : 0) +</span>
<a href="#l106.369"></a><span id="l106.369" class="difflineminus">-                100;</span>
<a href="#l106.370"></a><span id="l106.370" class="difflineminus">-  h = (char *) PR_MALLOC(hlen);</span>
<a href="#l106.371"></a><span id="l106.371" class="difflineplus">+  uint32_t hlen = strlen(type) + (enc ? strlen(enc) : 0) +</span>
<a href="#l106.372"></a><span id="l106.372" class="difflineplus">+                  (desc ? strlen(desc) : 0) + (name ? strlen(name) : 0) + 100;</span>
<a href="#l106.373"></a><span id="l106.373" class="difflineplus">+  h = (char *)PR_MALLOC(hlen);</span>
<a href="#l106.374"></a><span id="l106.374">   if (!h) return MIME_OUT_OF_MEMORY;</span>
<a href="#l106.375"></a><span id="l106.375"> </span>
<a href="#l106.376"></a><span id="l106.376">   PL_strncpyz(h, HEADER_CONTENT_TYPE &quot;: &quot;, hlen);</span>
<a href="#l106.377"></a><span id="l106.377">   PL_strcatn(h, hlen, type);</span>
<a href="#l106.378"></a><span id="l106.378">   PL_strcatn(h, hlen, MSG_LINEBREAK);</span>
<a href="#l106.379"></a><span id="l106.379">   status = MimeHeaders_parse_line(h, strlen(h), uty-&gt;open_hdrs);</span>
<a href="#l106.380"></a><span id="l106.380">   if (status &lt; 0) goto FAIL;</span>
<a href="#l106.381"></a><span id="l106.381"> </span>
<a href="#l106.382"></a><span id="l106.382" class="difflineminus">-  if (enc)</span>
<a href="#l106.383"></a><span id="l106.383" class="difflineminus">-  {</span>
<a href="#l106.384"></a><span id="l106.384" class="difflineplus">+  if (enc) {</span>
<a href="#l106.385"></a><span id="l106.385">     PL_strncpyz(h, HEADER_CONTENT_TRANSFER_ENCODING &quot;: &quot;, hlen);</span>
<a href="#l106.386"></a><span id="l106.386">     PL_strcatn(h, hlen, enc);</span>
<a href="#l106.387"></a><span id="l106.387">     PL_strcatn(h, hlen, MSG_LINEBREAK);</span>
<a href="#l106.388"></a><span id="l106.388">     status = MimeHeaders_parse_line(h, strlen(h), uty-&gt;open_hdrs);</span>
<a href="#l106.389"></a><span id="l106.389">     if (status &lt; 0) goto FAIL;</span>
<a href="#l106.390"></a><span id="l106.390">   }</span>
<a href="#l106.391"></a><span id="l106.391"> </span>
<a href="#l106.392"></a><span id="l106.392" class="difflineminus">-  if (desc)</span>
<a href="#l106.393"></a><span id="l106.393" class="difflineminus">-  {</span>
<a href="#l106.394"></a><span id="l106.394" class="difflineplus">+  if (desc) {</span>
<a href="#l106.395"></a><span id="l106.395">     PL_strncpyz(h, HEADER_CONTENT_DESCRIPTION &quot;: &quot;, hlen);</span>
<a href="#l106.396"></a><span id="l106.396">     PL_strcatn(h, hlen, desc);</span>
<a href="#l106.397"></a><span id="l106.397">     PL_strcatn(h, hlen, MSG_LINEBREAK);</span>
<a href="#l106.398"></a><span id="l106.398">     status = MimeHeaders_parse_line(h, strlen(h), uty-&gt;open_hdrs);</span>
<a href="#l106.399"></a><span id="l106.399">     if (status &lt; 0) goto FAIL;</span>
<a href="#l106.400"></a><span id="l106.400">   }</span>
<a href="#l106.401"></a><span id="l106.401" class="difflineminus">-  if (name)</span>
<a href="#l106.402"></a><span id="l106.402" class="difflineminus">-  {</span>
<a href="#l106.403"></a><span id="l106.403" class="difflineplus">+  if (name) {</span>
<a href="#l106.404"></a><span id="l106.404">     PL_strncpyz(h, HEADER_CONTENT_DISPOSITION &quot;: inline; filename=\&quot;&quot;, hlen);</span>
<a href="#l106.405"></a><span id="l106.405">     PL_strcatn(h, hlen, name);</span>
<a href="#l106.406"></a><span id="l106.406">     PL_strcatn(h, hlen, &quot;\&quot;&quot; MSG_LINEBREAK);</span>
<a href="#l106.407"></a><span id="l106.407">     status = MimeHeaders_parse_line(h, strlen(h), uty-&gt;open_hdrs);</span>
<a href="#l106.408"></a><span id="l106.408">     if (status &lt; 0) goto FAIL;</span>
<a href="#l106.409"></a><span id="l106.409">   }</span>
<a href="#l106.410"></a><span id="l106.410"> </span>
<a href="#l106.411"></a><span id="l106.411">   /* push out a blank line. */</span>
<a href="#l106.412"></a><span id="l106.412">   PL_strncpyz(h, MSG_LINEBREAK, hlen);</span>
<a href="#l106.413"></a><span id="l106.413">   status = MimeHeaders_parse_line(h, strlen(h), uty-&gt;open_hdrs);</span>
<a href="#l106.414"></a><span id="l106.414">   if (status &lt; 0) goto FAIL;</span>
<a href="#l106.415"></a><span id="l106.415"> </span>
<a href="#l106.416"></a><span id="l106.416" class="difflineminus">-</span>
<a href="#l106.417"></a><span id="l106.417">   /* Create a child... */</span>
<a href="#l106.418"></a><span id="l106.418">   {</span>
<a href="#l106.419"></a><span id="l106.419" class="difflineminus">-  bool horrid_kludge = (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l106.420"></a><span id="l106.420" class="difflineminus">-               obj-&gt;options-&gt;state-&gt;first_part_written_p);</span>
<a href="#l106.421"></a><span id="l106.421" class="difflineminus">-  if (horrid_kludge)</span>
<a href="#l106.422"></a><span id="l106.422" class="difflineminus">-    obj-&gt;options-&gt;state-&gt;first_part_written_p = false;</span>
<a href="#l106.423"></a><span id="l106.423" class="difflineplus">+    bool horrid_kludge = (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l106.424"></a><span id="l106.424" class="difflineplus">+                          obj-&gt;options-&gt;state-&gt;first_part_written_p);</span>
<a href="#l106.425"></a><span id="l106.425" class="difflineplus">+    if (horrid_kludge) obj-&gt;options-&gt;state-&gt;first_part_written_p = false;</span>
<a href="#l106.426"></a><span id="l106.426"> </span>
<a href="#l106.427"></a><span id="l106.427" class="difflineminus">-  uty-&gt;open_subpart = mime_create(type, uty-&gt;open_hdrs, obj-&gt;options);</span>
<a href="#l106.428"></a><span id="l106.428" class="difflineplus">+    uty-&gt;open_subpart = mime_create(type, uty-&gt;open_hdrs, obj-&gt;options);</span>
<a href="#l106.429"></a><span id="l106.429"> </span>
<a href="#l106.430"></a><span id="l106.430" class="difflineminus">-  if (horrid_kludge)</span>
<a href="#l106.431"></a><span id="l106.431" class="difflineminus">-    obj-&gt;options-&gt;state-&gt;first_part_written_p = true;</span>
<a href="#l106.432"></a><span id="l106.432" class="difflineplus">+    if (horrid_kludge) obj-&gt;options-&gt;state-&gt;first_part_written_p = true;</span>
<a href="#l106.433"></a><span id="l106.433"> </span>
<a href="#l106.434"></a><span id="l106.434" class="difflineminus">-  if (!uty-&gt;open_subpart)</span>
<a href="#l106.435"></a><span id="l106.435" class="difflineminus">-    {</span>
<a href="#l106.436"></a><span id="l106.436" class="difflineminus">-    status = MIME_OUT_OF_MEMORY;</span>
<a href="#l106.437"></a><span id="l106.437" class="difflineminus">-    goto FAIL;</span>
<a href="#l106.438"></a><span id="l106.438" class="difflineplus">+    if (!uty-&gt;open_subpart) {</span>
<a href="#l106.439"></a><span id="l106.439" class="difflineplus">+      status = MIME_OUT_OF_MEMORY;</span>
<a href="#l106.440"></a><span id="l106.440" class="difflineplus">+      goto FAIL;</span>
<a href="#l106.441"></a><span id="l106.441">     }</span>
<a href="#l106.442"></a><span id="l106.442">   }</span>
<a href="#l106.443"></a><span id="l106.443"> </span>
<a href="#l106.444"></a><span id="l106.444">   /* Add it to the list... */</span>
<a href="#l106.445"></a><span id="l106.445" class="difflineminus">-  status = ((MimeContainerClass *) obj-&gt;clazz)-&gt;add_child(obj,</span>
<a href="#l106.446"></a><span id="l106.446" class="difflineminus">-                              uty-&gt;open_subpart);</span>
<a href="#l106.447"></a><span id="l106.447" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l106.448"></a><span id="l106.448" class="difflineminus">-  {</span>
<a href="#l106.449"></a><span id="l106.449" class="difflineplus">+  status =</span>
<a href="#l106.450"></a><span id="l106.450" class="difflineplus">+      ((MimeContainerClass *)obj-&gt;clazz)-&gt;add_child(obj, uty-&gt;open_subpart);</span>
<a href="#l106.451"></a><span id="l106.451" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l106.452"></a><span id="l106.452">     mime_free(uty-&gt;open_subpart);</span>
<a href="#l106.453"></a><span id="l106.453">     uty-&gt;open_subpart = 0;</span>
<a href="#l106.454"></a><span id="l106.454">     goto FAIL;</span>
<a href="#l106.455"></a><span id="l106.455">   }</span>
<a href="#l106.456"></a><span id="l106.456"> </span>
<a href="#l106.457"></a><span id="l106.457">   /* And start its parser going. */</span>
<a href="#l106.458"></a><span id="l106.458">   status = uty-&gt;open_subpart-&gt;clazz-&gt;parse_begin(uty-&gt;open_subpart);</span>
<a href="#l106.459"></a><span id="l106.459" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l106.460"></a><span id="l106.460" class="difflineminus">-  {</span>
<a href="#l106.461"></a><span id="l106.461" class="difflineplus">+  if (status &lt; 0) {</span>
<a href="#l106.462"></a><span id="l106.462">     /* MimeContainer-&gt;finalize will take care of shutting it down now. */</span>
<a href="#l106.463"></a><span id="l106.463">     uty-&gt;open_subpart = 0;</span>
<a href="#l106.464"></a><span id="l106.464">     goto FAIL;</span>
<a href="#l106.465"></a><span id="l106.465">   }</span>
<a href="#l106.466"></a><span id="l106.466"> </span>
<a href="#l106.467"></a><span id="l106.467">   uty-&gt;type = ttype;</span>
<a href="#l106.468"></a><span id="l106.468"> </span>
<a href="#l106.469"></a><span id="l106.469" class="difflineminus">- FAIL:</span>
<a href="#l106.470"></a><span id="l106.470" class="difflineplus">+FAIL:</span>
<a href="#l106.471"></a><span id="l106.471">   PR_FREEIF(h);</span>
<a href="#l106.472"></a><span id="l106.472"> </span>
<a href="#l106.473"></a><span id="l106.473" class="difflineminus">-  if (status &lt; 0 &amp;&amp; uty-&gt;open_hdrs)</span>
<a href="#l106.474"></a><span id="l106.474" class="difflineminus">-  {</span>
<a href="#l106.475"></a><span id="l106.475" class="difflineplus">+  if (status &lt; 0 &amp;&amp; uty-&gt;open_hdrs) {</span>
<a href="#l106.476"></a><span id="l106.476">     MimeHeaders_free(uty-&gt;open_hdrs);</span>
<a href="#l106.477"></a><span id="l106.477">     uty-&gt;open_hdrs = 0;</span>
<a href="#l106.478"></a><span id="l106.478">   }</span>
<a href="#l106.479"></a><span id="l106.479"> </span>
<a href="#l106.480"></a><span id="l106.480">   return status;</span>
<a href="#l106.481"></a><span id="l106.481"> }</span>
<a href="#l106.482"></a><span id="l106.482"> </span>
<a href="#l106.483"></a><span id="l106.483" class="difflineminus">-static bool</span>
<a href="#l106.484"></a><span id="l106.484" class="difflineminus">-MimeUntypedText_uu_begin_line_p(const char *line, int32_t length,</span>
<a href="#l106.485"></a><span id="l106.485" class="difflineminus">-                MimeDisplayOptions *opt,</span>
<a href="#l106.486"></a><span id="l106.486" class="difflineminus">-                char **type_ret, char **name_ret)</span>
<a href="#l106.487"></a><span id="l106.487" class="difflineminus">-{</span>
<a href="#l106.488"></a><span id="l106.488" class="difflineplus">+static bool MimeUntypedText_uu_begin_line_p(const char *line, int32_t length,</span>
<a href="#l106.489"></a><span id="l106.489" class="difflineplus">+                                            MimeDisplayOptions *opt,</span>
<a href="#l106.490"></a><span id="l106.490" class="difflineplus">+                                            char **type_ret, char **name_ret) {</span>
<a href="#l106.491"></a><span id="l106.491">   const char *s;</span>
<a href="#l106.492"></a><span id="l106.492">   char *name = 0;</span>
<a href="#l106.493"></a><span id="l106.493">   char *type = 0;</span>
<a href="#l106.494"></a><span id="l106.494"> </span>
<a href="#l106.495"></a><span id="l106.495">   if (type_ret) *type_ret = 0;</span>
<a href="#l106.496"></a><span id="l106.496">   if (name_ret) *name_ret = 0;</span>
<a href="#l106.497"></a><span id="l106.497"> </span>
<a href="#l106.498"></a><span id="l106.498" class="difflineminus">-  if (strncmp (line, &quot;begin &quot;, 6)) return false;</span>
<a href="#l106.499"></a><span id="l106.499" class="difflineplus">+  if (strncmp(line, &quot;begin &quot;, 6)) return false;</span>
<a href="#l106.500"></a><span id="l106.500">   /* ...then three or four octal digits. */</span>
<a href="#l106.501"></a><span id="l106.501">   s = line + 6;</span>
<a href="#l106.502"></a><span id="l106.502">   if (*s &lt; '0' || *s &gt; '7') return false;</span>
<a href="#l106.503"></a><span id="l106.503">   s++;</span>
<a href="#l106.504"></a><span id="l106.504">   if (*s &lt; '0' || *s &gt; '7') return false;</span>
<a href="#l106.505"></a><span id="l106.505">   s++;</span>
<a href="#l106.506"></a><span id="l106.506">   if (*s &lt; '0' || *s &gt; '7') return false;</span>
<a href="#l106.507"></a><span id="l106.507">   s++;</span>
<a href="#l106.508"></a><span id="l106.508">   if (*s == ' ')</span>
<a href="#l106.509"></a><span id="l106.509" class="difflineminus">-  s++;</span>
<a href="#l106.510"></a><span id="l106.510" class="difflineminus">-  else</span>
<a href="#l106.511"></a><span id="l106.511" class="difflineminus">-  {</span>
<a href="#l106.512"></a><span id="l106.512" class="difflineplus">+    s++;</span>
<a href="#l106.513"></a><span id="l106.513" class="difflineplus">+  else {</span>
<a href="#l106.514"></a><span id="l106.514">     if (*s &lt; '0' || *s &gt; '7') return false;</span>
<a href="#l106.515"></a><span id="l106.515">     s++;</span>
<a href="#l106.516"></a><span id="l106.516">     if (*s != ' ') return false;</span>
<a href="#l106.517"></a><span id="l106.517">   }</span>
<a href="#l106.518"></a><span id="l106.518"> </span>
<a href="#l106.519"></a><span id="l106.519" class="difflineminus">-  while (IS_SPACE(*s))</span>
<a href="#l106.520"></a><span id="l106.520" class="difflineminus">-  s++;</span>
<a href="#l106.521"></a><span id="l106.521" class="difflineplus">+  while (IS_SPACE(*s)) s++;</span>
<a href="#l106.522"></a><span id="l106.522"> </span>
<a href="#l106.523"></a><span id="l106.523" class="difflineminus">-  name = (char *) PR_MALLOC(((line+length)-s) + 1);</span>
<a href="#l106.524"></a><span id="l106.524" class="difflineplus">+  name = (char *)PR_MALLOC(((line + length) - s) + 1);</span>
<a href="#l106.525"></a><span id="l106.525">   if (!name) return false; /* grr... */</span>
<a href="#l106.526"></a><span id="l106.526" class="difflineminus">-  memcpy(name, s, (line+length)-s);</span>
<a href="#l106.527"></a><span id="l106.527" class="difflineminus">-  name[(line+length)-s] = 0;</span>
<a href="#l106.528"></a><span id="l106.528" class="difflineplus">+  memcpy(name, s, (line + length) - s);</span>
<a href="#l106.529"></a><span id="l106.529" class="difflineplus">+  name[(line + length) - s] = 0;</span>
<a href="#l106.530"></a><span id="l106.530"> </span>
<a href="#l106.531"></a><span id="l106.531">   /* take off newline. */</span>
<a href="#l106.532"></a><span id="l106.532" class="difflineminus">-  if (name[strlen(name)-1] == '\n') name[strlen(name)-1] = 0;</span>
<a href="#l106.533"></a><span id="l106.533" class="difflineminus">-  if (name[strlen(name)-1] == '\r') name[strlen(name)-1] = 0;</span>
<a href="#l106.534"></a><span id="l106.534" class="difflineplus">+  if (name[strlen(name) - 1] == '\n') name[strlen(name) - 1] = 0;</span>
<a href="#l106.535"></a><span id="l106.535" class="difflineplus">+  if (name[strlen(name) - 1] == '\r') name[strlen(name) - 1] = 0;</span>
<a href="#l106.536"></a><span id="l106.536"> </span>
<a href="#l106.537"></a><span id="l106.537">   /* Now try and figure out a type.</span>
<a href="#l106.538"></a><span id="l106.538">    */</span>
<a href="#l106.539"></a><span id="l106.539">   if (opt &amp;&amp; opt-&gt;file_type_fn)</span>
<a href="#l106.540"></a><span id="l106.540" class="difflineminus">-  type = opt-&gt;file_type_fn(name, opt-&gt;stream_closure);</span>
<a href="#l106.541"></a><span id="l106.541" class="difflineplus">+    type = opt-&gt;file_type_fn(name, opt-&gt;stream_closure);</span>
<a href="#l106.542"></a><span id="l106.542">   else</span>
<a href="#l106.543"></a><span id="l106.543" class="difflineminus">-  type = 0;</span>
<a href="#l106.544"></a><span id="l106.544" class="difflineplus">+    type = 0;</span>
<a href="#l106.545"></a><span id="l106.545"> </span>
<a href="#l106.546"></a><span id="l106.546">   if (name_ret)</span>
<a href="#l106.547"></a><span id="l106.547" class="difflineminus">-  *name_ret = name;</span>
<a href="#l106.548"></a><span id="l106.548" class="difflineplus">+    *name_ret = name;</span>
<a href="#l106.549"></a><span id="l106.549">   else</span>
<a href="#l106.550"></a><span id="l106.550" class="difflineminus">-  PR_FREEIF(name);</span>
<a href="#l106.551"></a><span id="l106.551" class="difflineplus">+    PR_FREEIF(name);</span>
<a href="#l106.552"></a><span id="l106.552"> </span>
<a href="#l106.553"></a><span id="l106.553">   if (type_ret)</span>
<a href="#l106.554"></a><span id="l106.554" class="difflineminus">-  *type_ret = type;</span>
<a href="#l106.555"></a><span id="l106.555" class="difflineplus">+    *type_ret = type;</span>
<a href="#l106.556"></a><span id="l106.556">   else</span>
<a href="#l106.557"></a><span id="l106.557" class="difflineminus">-  PR_FREEIF(type);</span>
<a href="#l106.558"></a><span id="l106.558" class="difflineplus">+    PR_FREEIF(type);</span>
<a href="#l106.559"></a><span id="l106.559"> </span>
<a href="#l106.560"></a><span id="l106.560">   return true;</span>
<a href="#l106.561"></a><span id="l106.561"> }</span>
<a href="#l106.562"></a><span id="l106.562"> </span>
<a href="#l106.563"></a><span id="l106.563" class="difflineminus">-static bool</span>
<a href="#l106.564"></a><span id="l106.564" class="difflineminus">-MimeUntypedText_uu_end_line_p(const char *line, int32_t length)</span>
<a href="#l106.565"></a><span id="l106.565" class="difflineminus">-{</span>
<a href="#l106.566"></a><span id="l106.566" class="difflineplus">+static bool MimeUntypedText_uu_end_line_p(const char *line, int32_t length) {</span>
<a href="#l106.567"></a><span id="l106.567"> #if 0</span>
<a href="#l106.568"></a><span id="l106.568">   /* A strictly conforming uuencode end line. */</span>
<a href="#l106.569"></a><span id="l106.569">   return (line[0] == 'e' &amp;&amp;</span>
<a href="#l106.570"></a><span id="l106.570">       line[1] == 'n' &amp;&amp;</span>
<a href="#l106.571"></a><span id="l106.571">       line[2] == 'd' &amp;&amp;</span>
<a href="#l106.572"></a><span id="l106.572">       (line[3] == 0 || IS_SPACE(line[3])));</span>
<a href="#l106.573"></a><span id="l106.573"> #else</span>
<a href="#l106.574"></a><span id="l106.574">   /* ...but, why don't we accept any line that begins with the three</span>
<a href="#l106.575"></a><span id="l106.575" class="difflineat">@@ -467,122 +396,110 @@ MimeUntypedText_uu_end_line_p(const char</span>
<a href="#l106.576"></a><span id="l106.576">     Mxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
<a href="#l106.577"></a><span id="l106.577">     Mxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
<a href="#l106.578"></a><span id="l106.578">     Mxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
<a href="#l106.579"></a><span id="l106.579">     END------- Cut Here-----</span>
<a href="#l106.580"></a><span id="l106.580"> </span>
<a href="#l106.581"></a><span id="l106.581">    so let's be lenient here.  (This is only for the untyped-text-plain</span>
<a href="#l106.582"></a><span id="l106.582">    case -- the uudecode parser itself is strict.)</span>
<a href="#l106.583"></a><span id="l106.583">    */</span>
<a href="#l106.584"></a><span id="l106.584" class="difflineminus">-  return (line[0] == ' ' ||</span>
<a href="#l106.585"></a><span id="l106.585" class="difflineminus">-      line[0] == '\t' ||</span>
<a href="#l106.586"></a><span id="l106.586" class="difflineminus">-      ((line[0] == 'e' || line[0] == 'E') &amp;&amp;</span>
<a href="#l106.587"></a><span id="l106.587" class="difflineminus">-       (line[1] == 'n' || line[1] == 'N') &amp;&amp;</span>
<a href="#l106.588"></a><span id="l106.588" class="difflineminus">-       (line[2] == 'd' || line[2] == 'D')));</span>
<a href="#l106.589"></a><span id="l106.589" class="difflineplus">+  return (line[0] == ' ' || line[0] == '\t' ||</span>
<a href="#l106.590"></a><span id="l106.590" class="difflineplus">+          ((line[0] == 'e' || line[0] == 'E') &amp;&amp;</span>
<a href="#l106.591"></a><span id="l106.591" class="difflineplus">+           (line[1] == 'n' || line[1] == 'N') &amp;&amp;</span>
<a href="#l106.592"></a><span id="l106.592" class="difflineplus">+           (line[2] == 'd' || line[2] == 'D')));</span>
<a href="#l106.593"></a><span id="l106.593"> #endif</span>
<a href="#l106.594"></a><span id="l106.594"> }</span>
<a href="#l106.595"></a><span id="l106.595"> </span>
<a href="#l106.596"></a><span id="l106.596" class="difflineminus">-static bool</span>
<a href="#l106.597"></a><span id="l106.597" class="difflineminus">-MimeUntypedText_yenc_begin_line_p(const char *line, int32_t length,</span>
<a href="#l106.598"></a><span id="l106.598" class="difflineminus">-                MimeDisplayOptions *opt,</span>
<a href="#l106.599"></a><span id="l106.599" class="difflineminus">-                char **type_ret, char **name_ret)</span>
<a href="#l106.600"></a><span id="l106.600" class="difflineminus">-{</span>
<a href="#l106.601"></a><span id="l106.601" class="difflineplus">+static bool MimeUntypedText_yenc_begin_line_p(const char *line, int32_t length,</span>
<a href="#l106.602"></a><span id="l106.602" class="difflineplus">+                                              MimeDisplayOptions *opt,</span>
<a href="#l106.603"></a><span id="l106.603" class="difflineplus">+                                              char **type_ret,</span>
<a href="#l106.604"></a><span id="l106.604" class="difflineplus">+                                              char **name_ret) {</span>
<a href="#l106.605"></a><span id="l106.605">   const char *s;</span>
<a href="#l106.606"></a><span id="l106.606">   const char *endofline = line + length;</span>
<a href="#l106.607"></a><span id="l106.607">   char *name = 0;</span>
<a href="#l106.608"></a><span id="l106.608">   char *type = 0;</span>
<a href="#l106.609"></a><span id="l106.609"> </span>
<a href="#l106.610"></a><span id="l106.610">   if (type_ret) *type_ret = 0;</span>
<a href="#l106.611"></a><span id="l106.611">   if (name_ret) *name_ret = 0;</span>
<a href="#l106.612"></a><span id="l106.612"> </span>
<a href="#l106.613"></a><span id="l106.613">   /* we don't support yenc V2 neither multipart yencode,</span>
<a href="#l106.614"></a><span id="l106.614">      therefore the second parameter should always be &quot;line=&quot;*/</span>
<a href="#l106.615"></a><span id="l106.615" class="difflineminus">-  if (length &lt; 13 || strncmp (line, &quot;=ybegin line=&quot;, 13)) return false;</span>
<a href="#l106.616"></a><span id="l106.616" class="difflineplus">+  if (length &lt; 13 || strncmp(line, &quot;=ybegin line=&quot;, 13)) return false;</span>
<a href="#l106.617"></a><span id="l106.617"> </span>
<a href="#l106.618"></a><span id="l106.618">   /* ...then couple digits. */</span>
<a href="#l106.619"></a><span id="l106.619" class="difflineminus">-  for (s = line + 13; s &lt; endofline; s ++)</span>
<a href="#l106.620"></a><span id="l106.620" class="difflineminus">-    if (*s &lt; '0' || *s &gt; '9')</span>
<a href="#l106.621"></a><span id="l106.621" class="difflineminus">-      break;</span>
<a href="#l106.622"></a><span id="l106.622" class="difflineplus">+  for (s = line + 13; s &lt; endofline; s++)</span>
<a href="#l106.623"></a><span id="l106.623" class="difflineplus">+    if (*s &lt; '0' || *s &gt; '9') break;</span>
<a href="#l106.624"></a><span id="l106.624"> </span>
<a href="#l106.625"></a><span id="l106.625">   /* ...next, look for &lt;space&gt;size= */</span>
<a href="#l106.626"></a><span id="l106.626" class="difflineminus">-  if ((endofline - s) &lt; 6 || strncmp (s, &quot; size=&quot;, 6)) return false;</span>
<a href="#l106.627"></a><span id="l106.627" class="difflineplus">+  if ((endofline - s) &lt; 6 || strncmp(s, &quot; size=&quot;, 6)) return false;</span>
<a href="#l106.628"></a><span id="l106.628"> </span>
<a href="#l106.629"></a><span id="l106.629">   /* ...then couple digits. */</span>
<a href="#l106.630"></a><span id="l106.630" class="difflineminus">-  for (s += 6; s &lt; endofline; s ++)</span>
<a href="#l106.631"></a><span id="l106.631" class="difflineminus">-    if (*s &lt; '0' || *s &gt; '9')</span>
<a href="#l106.632"></a><span id="l106.632" class="difflineminus">-      break;</span>
<a href="#l106.633"></a><span id="l106.633" class="difflineplus">+  for (s += 6; s &lt; endofline; s++)</span>
<a href="#l106.634"></a><span id="l106.634" class="difflineplus">+    if (*s &lt; '0' || *s &gt; '9') break;</span>
<a href="#l106.635"></a><span id="l106.635"> </span>
<a href="#l106.636"></a><span id="l106.636" class="difflineminus">-   /* ...next, look for &lt;space&gt;name= */</span>
<a href="#l106.637"></a><span id="l106.637" class="difflineminus">-  if ((endofline - s) &lt; 6 || strncmp (s, &quot; name=&quot;, 6)) return false;</span>
<a href="#l106.638"></a><span id="l106.638" class="difflineplus">+  /* ...next, look for &lt;space&gt;name= */</span>
<a href="#l106.639"></a><span id="l106.639" class="difflineplus">+  if ((endofline - s) &lt; 6 || strncmp(s, &quot; name=&quot;, 6)) return false;</span>
<a href="#l106.640"></a><span id="l106.640"> </span>
<a href="#l106.641"></a><span id="l106.641">   /* anything left is the file name */</span>
<a href="#l106.642"></a><span id="l106.642">   s += 6;</span>
<a href="#l106.643"></a><span id="l106.643" class="difflineminus">-  name = (char *) PR_MALLOC((endofline-s) + 1);</span>
<a href="#l106.644"></a><span id="l106.644" class="difflineplus">+  name = (char *)PR_MALLOC((endofline - s) + 1);</span>
<a href="#l106.645"></a><span id="l106.645">   if (!name) return false; /* grr... */</span>
<a href="#l106.646"></a><span id="l106.646" class="difflineminus">-  memcpy(name, s, endofline-s);</span>
<a href="#l106.647"></a><span id="l106.647" class="difflineminus">-  name[endofline-s] = 0;</span>
<a href="#l106.648"></a><span id="l106.648" class="difflineplus">+  memcpy(name, s, endofline - s);</span>
<a href="#l106.649"></a><span id="l106.649" class="difflineplus">+  name[endofline - s] = 0;</span>
<a href="#l106.650"></a><span id="l106.650"> </span>
<a href="#l106.651"></a><span id="l106.651">   /* take off newline. */</span>
<a href="#l106.652"></a><span id="l106.652" class="difflineminus">-  if (name[strlen(name)-1] == '\n') name[strlen(name)-1] = 0;</span>
<a href="#l106.653"></a><span id="l106.653" class="difflineminus">-  if (name[strlen(name)-1] == '\r') name[strlen(name)-1] = 0;</span>
<a href="#l106.654"></a><span id="l106.654" class="difflineplus">+  if (name[strlen(name) - 1] == '\n') name[strlen(name) - 1] = 0;</span>
<a href="#l106.655"></a><span id="l106.655" class="difflineplus">+  if (name[strlen(name) - 1] == '\r') name[strlen(name) - 1] = 0;</span>
<a href="#l106.656"></a><span id="l106.656"> </span>
<a href="#l106.657"></a><span id="l106.657">   /* Now try and figure out a type.</span>
<a href="#l106.658"></a><span id="l106.658">    */</span>
<a href="#l106.659"></a><span id="l106.659">   if (opt &amp;&amp; opt-&gt;file_type_fn)</span>
<a href="#l106.660"></a><span id="l106.660" class="difflineminus">-  type = opt-&gt;file_type_fn(name, opt-&gt;stream_closure);</span>
<a href="#l106.661"></a><span id="l106.661" class="difflineplus">+    type = opt-&gt;file_type_fn(name, opt-&gt;stream_closure);</span>
<a href="#l106.662"></a><span id="l106.662">   else</span>
<a href="#l106.663"></a><span id="l106.663" class="difflineminus">-  type = 0;</span>
<a href="#l106.664"></a><span id="l106.664" class="difflineplus">+    type = 0;</span>
<a href="#l106.665"></a><span id="l106.665"> </span>
<a href="#l106.666"></a><span id="l106.666">   if (name_ret)</span>
<a href="#l106.667"></a><span id="l106.667" class="difflineminus">-  *name_ret = name;</span>
<a href="#l106.668"></a><span id="l106.668" class="difflineplus">+    *name_ret = name;</span>
<a href="#l106.669"></a><span id="l106.669">   else</span>
<a href="#l106.670"></a><span id="l106.670" class="difflineminus">-  PR_FREEIF(name);</span>
<a href="#l106.671"></a><span id="l106.671" class="difflineplus">+    PR_FREEIF(name);</span>
<a href="#l106.672"></a><span id="l106.672"> </span>
<a href="#l106.673"></a><span id="l106.673">   if (type_ret)</span>
<a href="#l106.674"></a><span id="l106.674" class="difflineminus">-  *type_ret = type;</span>
<a href="#l106.675"></a><span id="l106.675" class="difflineplus">+    *type_ret = type;</span>
<a href="#l106.676"></a><span id="l106.676">   else</span>
<a href="#l106.677"></a><span id="l106.677" class="difflineminus">-  PR_FREEIF(type);</span>
<a href="#l106.678"></a><span id="l106.678" class="difflineplus">+    PR_FREEIF(type);</span>
<a href="#l106.679"></a><span id="l106.679"> </span>
<a href="#l106.680"></a><span id="l106.680">   return true;</span>
<a href="#l106.681"></a><span id="l106.681"> }</span>
<a href="#l106.682"></a><span id="l106.682"> </span>
<a href="#l106.683"></a><span id="l106.683" class="difflineminus">-static bool</span>
<a href="#l106.684"></a><span id="l106.684" class="difflineminus">-MimeUntypedText_yenc_end_line_p(const char *line, int32_t length)</span>
<a href="#l106.685"></a><span id="l106.685" class="difflineminus">-{</span>
<a href="#l106.686"></a><span id="l106.686" class="difflineminus">-  if (length &lt; 11 || strncmp (line, &quot;=yend size=&quot;, 11)) return false;</span>
<a href="#l106.687"></a><span id="l106.687" class="difflineplus">+static bool MimeUntypedText_yenc_end_line_p(const char *line, int32_t length) {</span>
<a href="#l106.688"></a><span id="l106.688" class="difflineplus">+  if (length &lt; 11 || strncmp(line, &quot;=yend size=&quot;, 11)) return false;</span>
<a href="#l106.689"></a><span id="l106.689"> </span>
<a href="#l106.690"></a><span id="l106.690">   return true;</span>
<a href="#l106.691"></a><span id="l106.691"> }</span>
<a href="#l106.692"></a><span id="l106.692"> </span>
<a href="#l106.693"></a><span id="l106.693" class="difflineminus">-</span>
<a href="#l106.694"></a><span id="l106.694"> #define BINHEX_MAGIC &quot;(This file must be converted with BinHex 4.0)&quot;</span>
<a href="#l106.695"></a><span id="l106.695"> #define BINHEX_MAGIC_LEN 45</span>
<a href="#l106.696"></a><span id="l106.696"> </span>
<a href="#l106.697"></a><span id="l106.697" class="difflineminus">-static bool</span>
<a href="#l106.698"></a><span id="l106.698" class="difflineminus">-MimeUntypedText_binhex_begin_line_p(const char *line, int32_t length,</span>
<a href="#l106.699"></a><span id="l106.699" class="difflineminus">-                  MimeDisplayOptions *opt)</span>
<a href="#l106.700"></a><span id="l106.700" class="difflineminus">-{</span>
<a href="#l106.701"></a><span id="l106.701" class="difflineminus">-  if (length &lt;= BINHEX_MAGIC_LEN)</span>
<a href="#l106.702"></a><span id="l106.702" class="difflineminus">-  return false;</span>
<a href="#l106.703"></a><span id="l106.703" class="difflineplus">+static bool MimeUntypedText_binhex_begin_line_p(const char *line,</span>
<a href="#l106.704"></a><span id="l106.704" class="difflineplus">+                                                int32_t length,</span>
<a href="#l106.705"></a><span id="l106.705" class="difflineplus">+                                                MimeDisplayOptions *opt) {</span>
<a href="#l106.706"></a><span id="l106.706" class="difflineplus">+  if (length &lt;= BINHEX_MAGIC_LEN) return false;</span>
<a href="#l106.707"></a><span id="l106.707"> </span>
<a href="#l106.708"></a><span id="l106.708" class="difflineminus">-  while(length &gt; 0 &amp;&amp; IS_SPACE(line[length-1]))</span>
<a href="#l106.709"></a><span id="l106.709" class="difflineminus">-  length--;</span>
<a href="#l106.710"></a><span id="l106.710" class="difflineplus">+  while (length &gt; 0 &amp;&amp; IS_SPACE(line[length - 1])) length--;</span>
<a href="#l106.711"></a><span id="l106.711"> </span>
<a href="#l106.712"></a><span id="l106.712" class="difflineminus">-  if (length != BINHEX_MAGIC_LEN)</span>
<a href="#l106.713"></a><span id="l106.713" class="difflineminus">-  return false;</span>
<a href="#l106.714"></a><span id="l106.714" class="difflineplus">+  if (length != BINHEX_MAGIC_LEN) return false;</span>
<a href="#l106.715"></a><span id="l106.715"> </span>
<a href="#l106.716"></a><span id="l106.716">   if (!strncmp(line, BINHEX_MAGIC, BINHEX_MAGIC_LEN))</span>
<a href="#l106.717"></a><span id="l106.717" class="difflineminus">-  return true;</span>
<a href="#l106.718"></a><span id="l106.718" class="difflineplus">+    return true;</span>
<a href="#l106.719"></a><span id="l106.719">   else</span>
<a href="#l106.720"></a><span id="l106.720" class="difflineminus">-  return false;</span>
<a href="#l106.721"></a><span id="l106.721" class="difflineplus">+    return false;</span>
<a href="#l106.722"></a><span id="l106.722"> }</span>
<a href="#l106.723"></a><span id="l106.723"> </span>
<a href="#l106.724"></a><span id="l106.724" class="difflineminus">-static bool</span>
<a href="#l106.725"></a><span id="l106.725" class="difflineminus">-MimeUntypedText_binhex_end_line_p(const char *line, int32_t length)</span>
<a href="#l106.726"></a><span id="l106.726" class="difflineminus">-{</span>
<a href="#l106.727"></a><span id="l106.727" class="difflineminus">-  if (length &gt; 0 &amp;&amp; line[length-1] == '\n') length--;</span>
<a href="#l106.728"></a><span id="l106.728" class="difflineminus">-  if (length &gt; 0 &amp;&amp; line[length-1] == '\r') length--;</span>
<a href="#l106.729"></a><span id="l106.729" class="difflineplus">+static bool MimeUntypedText_binhex_end_line_p(const char *line,</span>
<a href="#l106.730"></a><span id="l106.730" class="difflineplus">+                                              int32_t length) {</span>
<a href="#l106.731"></a><span id="l106.731" class="difflineplus">+  if (length &gt; 0 &amp;&amp; line[length - 1] == '\n') length--;</span>
<a href="#l106.732"></a><span id="l106.732" class="difflineplus">+  if (length &gt; 0 &amp;&amp; line[length - 1] == '\r') length--;</span>
<a href="#l106.733"></a><span id="l106.733"> </span>
<a href="#l106.734"></a><span id="l106.734">   if (length != 0 &amp;&amp; length != 64)</span>
<a href="#l106.735"></a><span id="l106.735" class="difflineminus">-  return true;</span>
<a href="#l106.736"></a><span id="l106.736" class="difflineplus">+    return true;</span>
<a href="#l106.737"></a><span id="l106.737">   else</span>
<a href="#l106.738"></a><span id="l106.738" class="difflineminus">-  return false;</span>
<a href="#l106.739"></a><span id="l106.739" class="difflineplus">+    return false;</span>
<a href="#l106.740"></a><span id="l106.740"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l107.1"></a><span id="l107.1" class="difflineminus">--- a/mailnews/mime/src/mimeunty.h</span>
<a href="#l107.2"></a><span id="l107.2" class="difflineplus">+++ b/mailnews/mime/src/mimeunty.h</span>
<a href="#l107.3"></a><span id="l107.3" class="difflineat">@@ -37,34 +37,34 @@</span>
<a href="#l107.4"></a><span id="l107.4">        open a text/plain subpart</span>
<a href="#l107.5"></a><span id="l107.5">      hand this line to it</span>
<a href="#l107.6"></a><span id="l107.6"> </span>
<a href="#l107.7"></a><span id="l107.7">    Adding other types than uuencode to this (for example, PGP) would be</span>
<a href="#l107.8"></a><span id="l107.8">    pretty straightforward.</span>
<a href="#l107.9"></a><span id="l107.9">  */</span>
<a href="#l107.10"></a><span id="l107.10"> </span>
<a href="#l107.11"></a><span id="l107.11"> typedef struct MimeUntypedTextClass MimeUntypedTextClass;</span>
<a href="#l107.12"></a><span id="l107.12" class="difflineminus">-typedef struct MimeUntypedText      MimeUntypedText;</span>
<a href="#l107.13"></a><span id="l107.13" class="difflineplus">+typedef struct MimeUntypedText MimeUntypedText;</span>
<a href="#l107.14"></a><span id="l107.14"> </span>
<a href="#l107.15"></a><span id="l107.15"> struct MimeUntypedTextClass {</span>
<a href="#l107.16"></a><span id="l107.16">   MimeContainerClass container;</span>
<a href="#l107.17"></a><span id="l107.17"> };</span>
<a href="#l107.18"></a><span id="l107.18"> </span>
<a href="#l107.19"></a><span id="l107.19"> extern MimeUntypedTextClass mimeUntypedTextClass;</span>
<a href="#l107.20"></a><span id="l107.20"> </span>
<a href="#l107.21"></a><span id="l107.21"> typedef enum {</span>
<a href="#l107.22"></a><span id="l107.22">   MimeUntypedTextSubpartTypeText,  /* text/plain */</span>
<a href="#l107.23"></a><span id="l107.23" class="difflineminus">-  MimeUntypedTextSubpartTypeUUE,  /* uuencoded data */</span>
<a href="#l107.24"></a><span id="l107.24" class="difflineplus">+  MimeUntypedTextSubpartTypeUUE,   /* uuencoded data */</span>
<a href="#l107.25"></a><span id="l107.25">   MimeUntypedTextSubpartTypeYEnc,  /* yencoded data */</span>
<a href="#l107.26"></a><span id="l107.26" class="difflineminus">-  MimeUntypedTextSubpartTypeBinhex  /* Mac BinHex data */</span>
<a href="#l107.27"></a><span id="l107.27" class="difflineplus">+  MimeUntypedTextSubpartTypeBinhex /* Mac BinHex data */</span>
<a href="#l107.28"></a><span id="l107.28"> } MimeUntypedTextSubpartType;</span>
<a href="#l107.29"></a><span id="l107.29"> </span>
<a href="#l107.30"></a><span id="l107.30"> struct MimeUntypedText {</span>
<a href="#l107.31"></a><span id="l107.31" class="difflineminus">-  MimeContainer container;      /* superclass variables */</span>
<a href="#l107.32"></a><span id="l107.32" class="difflineminus">-  MimeObject *open_subpart;      /* The part still-being-parsed */</span>
<a href="#l107.33"></a><span id="l107.33" class="difflineminus">-  MimeUntypedTextSubpartType type;  /* What kind of type it is */</span>
<a href="#l107.34"></a><span id="l107.34" class="difflineminus">-  MimeHeaders *open_hdrs;      /* The faked-up headers describing it */</span>
<a href="#l107.35"></a><span id="l107.35" class="difflineplus">+  MimeContainer container;         /* superclass variables */</span>
<a href="#l107.36"></a><span id="l107.36" class="difflineplus">+  MimeObject *open_subpart;        /* The part still-being-parsed */</span>
<a href="#l107.37"></a><span id="l107.37" class="difflineplus">+  MimeUntypedTextSubpartType type; /* What kind of type it is */</span>
<a href="#l107.38"></a><span id="l107.38" class="difflineplus">+  MimeHeaders *open_hdrs;          /* The faked-up headers describing it */</span>
<a href="#l107.39"></a><span id="l107.39"> };</span>
<a href="#l107.40"></a><span id="l107.40"> </span>
<a href="#l107.41"></a><span id="l107.41" class="difflineminus">-#define MimeUntypedTextClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l107.42"></a><span id="l107.42" class="difflineminus">-  { MimeContainerClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l107.43"></a><span id="l107.43" class="difflineplus">+#define MimeUntypedTextClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l107.44"></a><span id="l107.44" class="difflineplus">+  { MimeContainerClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l107.45"></a><span id="l107.45"> </span>
<a href="#l107.46"></a><span id="l107.46"> #endif /* _MIMEUNTY_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l108.1"></a><span id="l108.1" class="difflineminus">--- a/mailnews/mime/src/modlmime.h</span>
<a href="#l108.2"></a><span id="l108.2" class="difflineplus">+++ b/mailnews/mime/src/modlmime.h</span>
<a href="#l108.3"></a><span id="l108.3" class="difflineat">@@ -2,64 +2,63 @@</span>
<a href="#l108.4"></a><span id="l108.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l108.5"></a><span id="l108.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l108.6"></a><span id="l108.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l108.7"></a><span id="l108.7"> </span>
<a href="#l108.8"></a><span id="l108.8"> #ifndef _LIBMIME_H_</span>
<a href="#l108.9"></a><span id="l108.9"> #define _LIBMIME_H_</span>
<a href="#l108.10"></a><span id="l108.10"> </span>
<a href="#l108.11"></a><span id="l108.11"> #ifdef XP_UNIX</span>
<a href="#l108.12"></a><span id="l108.12" class="difflineminus">-#undef Bool</span>
<a href="#l108.13"></a><span id="l108.13" class="difflineplus">+#  undef Bool</span>
<a href="#l108.14"></a><span id="l108.14"> #endif</span>
<a href="#l108.15"></a><span id="l108.15"> </span>
<a href="#l108.16"></a><span id="l108.16"> #include &quot;nsString.h&quot;</span>
<a href="#l108.17"></a><span id="l108.17"> #include &quot;nsMailHeaders.h&quot;</span>
<a href="#l108.18"></a><span id="l108.18"> #include &quot;nsIMimeStreamConverter.h&quot;</span>
<a href="#l108.19"></a><span id="l108.19"> #include &quot;mozilla/Encoding.h&quot;</span>
<a href="#l108.20"></a><span id="l108.20"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l108.21"></a><span id="l108.21"> #include &quot;mozITXTToHTMLConv.h&quot;</span>
<a href="#l108.22"></a><span id="l108.22"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l108.23"></a><span id="l108.23" class="difflineminus">-#include &quot;modmimee.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l108.24"></a><span id="l108.24" class="difflineplus">+#include &quot;modmimee.h&quot;  // for MimeConverterOutputCallback</span>
<a href="#l108.25"></a><span id="l108.25"> </span>
<a href="#l108.26"></a><span id="l108.26"> #define MIME_DRAFTS</span>
<a href="#l108.27"></a><span id="l108.27"> </span>
<a href="#l108.28"></a><span id="l108.28"> /* Opaque object describing a block of message headers, and a couple of</span>
<a href="#l108.29"></a><span id="l108.29">    routines for extracting data from one.</span>
<a href="#l108.30"></a><span id="l108.30">  */</span>
<a href="#l108.31"></a><span id="l108.31"> </span>
<a href="#l108.32"></a><span id="l108.32" class="difflineminus">-typedef struct MimeHeaders</span>
<a href="#l108.33"></a><span id="l108.33" class="difflineminus">-{</span>
<a href="#l108.34"></a><span id="l108.34" class="difflineminus">-  char *all_headers;      /* A char* of the entire header section. */</span>
<a href="#l108.35"></a><span id="l108.35" class="difflineminus">-  int32_t all_headers_fp;      /* The length (it is not NULL-terminated.) */</span>
<a href="#l108.36"></a><span id="l108.36" class="difflineminus">-  int32_t all_headers_size;    /* The size of the allocated block. */</span>
<a href="#l108.37"></a><span id="l108.37" class="difflineplus">+typedef struct MimeHeaders {</span>
<a href="#l108.38"></a><span id="l108.38" class="difflineplus">+  char *all_headers;        /* A char* of the entire header section. */</span>
<a href="#l108.39"></a><span id="l108.39" class="difflineplus">+  int32_t all_headers_fp;   /* The length (it is not NULL-terminated.) */</span>
<a href="#l108.40"></a><span id="l108.40" class="difflineplus">+  int32_t all_headers_size; /* The size of the allocated block. */</span>
<a href="#l108.41"></a><span id="l108.41"> </span>
<a href="#l108.42"></a><span id="l108.42" class="difflineminus">-  bool done_p;        /* Whether we've read the end-of-headers marker</span>
<a href="#l108.43"></a><span id="l108.43" class="difflineminus">-                   (the terminating blank line.) */</span>
<a href="#l108.44"></a><span id="l108.44" class="difflineplus">+  bool done_p; /* Whether we've read the end-of-headers marker</span>
<a href="#l108.45"></a><span id="l108.45" class="difflineplus">+            (the terminating blank line.) */</span>
<a href="#l108.46"></a><span id="l108.46"> </span>
<a href="#l108.47"></a><span id="l108.47" class="difflineminus">-  char **heads;          /* An array of length n_headers which points</span>
<a href="#l108.48"></a><span id="l108.48" class="difflineminus">-                   to the beginning of each distinct header:</span>
<a href="#l108.49"></a><span id="l108.49" class="difflineminus">-                   just after the newline which terminated</span>
<a href="#l108.50"></a><span id="l108.50" class="difflineminus">-                   the previous one.  This is to speed search.</span>
<a href="#l108.51"></a><span id="l108.51" class="difflineplus">+  char **heads;       /* An array of length n_headers which points</span>
<a href="#l108.52"></a><span id="l108.52" class="difflineplus">+                to the beginning of each distinct header:</span>
<a href="#l108.53"></a><span id="l108.53" class="difflineplus">+                just after the newline which terminated</span>
<a href="#l108.54"></a><span id="l108.54" class="difflineplus">+                the previous one.  This is to speed search.</span>
<a href="#l108.55"></a><span id="l108.55" class="difflineplus">+      </span>
<a href="#l108.56"></a><span id="l108.56" class="difflineplus">+                This is not initialized until all the</span>
<a href="#l108.57"></a><span id="l108.57" class="difflineplus">+                headers have been read.</span>
<a href="#l108.58"></a><span id="l108.58" class="difflineplus">+              */</span>
<a href="#l108.59"></a><span id="l108.59" class="difflineplus">+  int32_t heads_size; /* The length (and consequently, how many</span>
<a href="#l108.60"></a><span id="l108.60" class="difflineplus">+            distinct headers are in here.) */</span>
<a href="#l108.61"></a><span id="l108.61"> </span>
<a href="#l108.62"></a><span id="l108.62" class="difflineminus">-                   This is not initialized until all the</span>
<a href="#l108.63"></a><span id="l108.63" class="difflineminus">-                   headers have been read.</span>
<a href="#l108.64"></a><span id="l108.64" class="difflineminus">-                 */</span>
<a href="#l108.65"></a><span id="l108.65" class="difflineminus">-  int32_t heads_size;        /* The length (and consequently, how many</span>
<a href="#l108.66"></a><span id="l108.66" class="difflineminus">-                   distinct headers are in here.) */</span>
<a href="#l108.67"></a><span id="l108.67" class="difflineminus">-</span>
<a href="#l108.68"></a><span id="l108.68" class="difflineminus">-</span>
<a href="#l108.69"></a><span id="l108.69" class="difflineminus">-  char *obuffer;        /* This buffer is used for output. */</span>
<a href="#l108.70"></a><span id="l108.70" class="difflineplus">+  char *obuffer; /* This buffer is used for output. */</span>
<a href="#l108.71"></a><span id="l108.71">   int32_t obuffer_size;</span>
<a href="#l108.72"></a><span id="l108.72">   int32_t obuffer_fp;</span>
<a href="#l108.73"></a><span id="l108.73"> </span>
<a href="#l108.74"></a><span id="l108.74" class="difflineminus">-  char *munged_subject;      /* What a hack.  This is a place to write down</span>
<a href="#l108.75"></a><span id="l108.75" class="difflineminus">-                   the subject header, after it's been</span>
<a href="#l108.76"></a><span id="l108.76" class="difflineminus">-                   charset-ified and stuff.  Remembered so that</span>
<a href="#l108.77"></a><span id="l108.77" class="difflineminus">-                   we can later use it to generate the</span>
<a href="#l108.78"></a><span id="l108.78" class="difflineminus">-                   &lt;TITLE&gt; tag. (Also works for giving names to RFC822 attachments) */</span>
<a href="#l108.79"></a><span id="l108.79" class="difflineplus">+  char</span>
<a href="#l108.80"></a><span id="l108.80" class="difflineplus">+      *munged_subject; /* What a hack.  This is a place to write down</span>
<a href="#l108.81"></a><span id="l108.81" class="difflineplus">+             the subject header, after it's been</span>
<a href="#l108.82"></a><span id="l108.82" class="difflineplus">+             charset-ified and stuff.  Remembered so that</span>
<a href="#l108.83"></a><span id="l108.83" class="difflineplus">+             we can later use it to generate the</span>
<a href="#l108.84"></a><span id="l108.84" class="difflineplus">+             &lt;TITLE&gt; tag. (Also works for giving names to RFC822 attachments) */</span>
<a href="#l108.85"></a><span id="l108.85"> } MimeHeaders;</span>
<a href="#l108.86"></a><span id="l108.86"> </span>
<a href="#l108.87"></a><span id="l108.87"> class MimeDisplayOptions;</span>
<a href="#l108.88"></a><span id="l108.88"> class MimeParseStateObject;</span>
<a href="#l108.89"></a><span id="l108.89"> typedef struct MSG_AttachmentData MSG_AttachmentData;</span>
<a href="#l108.90"></a><span id="l108.90"> </span>
<a href="#l108.91"></a><span id="l108.91"> /* Given the name of a header, returns the contents of that header as</span>
<a href="#l108.92"></a><span id="l108.92">    a newly-allocated string (which the caller must free.)  If the header</span>
<a href="#l108.93"></a><span id="l108.93" class="difflineat">@@ -69,20 +68,18 @@ typedef struct MSG_AttachmentData MSG_At</span>
<a href="#l108.94"></a><span id="l108.94">    of the header; else it will be the full text of the header.  (This is</span>
<a href="#l108.95"></a><span id="l108.95">    useful for getting just &quot;text/plain&quot; from &quot;text/plain; name=foo&quot;.)</span>
<a href="#l108.96"></a><span id="l108.96"> </span>
<a href="#l108.97"></a><span id="l108.97">    If `all_p' is false, then the first header encountered is used, and</span>
<a href="#l108.98"></a><span id="l108.98">    any subsequent headers of the same name are ignored.  If true, then</span>
<a href="#l108.99"></a><span id="l108.99">    all headers of the same name are appended together (this is useful</span>
<a href="#l108.100"></a><span id="l108.100">    for gathering up all CC headers into one, for example.)</span>
<a href="#l108.101"></a><span id="l108.101">  */</span>
<a href="#l108.102"></a><span id="l108.102" class="difflineminus">-extern char *MimeHeaders_get(MimeHeaders *hdrs,</span>
<a href="#l108.103"></a><span id="l108.103" class="difflineminus">-               const char *header_name,</span>
<a href="#l108.104"></a><span id="l108.104" class="difflineminus">-               bool strip_p,</span>
<a href="#l108.105"></a><span id="l108.105" class="difflineminus">-               bool all_p);</span>
<a href="#l108.106"></a><span id="l108.106" class="difflineplus">+extern char *MimeHeaders_get(MimeHeaders *hdrs, const char *header_name,</span>
<a href="#l108.107"></a><span id="l108.107" class="difflineplus">+                             bool strip_p, bool all_p);</span>
<a href="#l108.108"></a><span id="l108.108"> </span>
<a href="#l108.109"></a><span id="l108.109"> /* Given a header of the form of the MIME &quot;Content-&quot; headers, extracts a</span>
<a href="#l108.110"></a><span id="l108.110">    named parameter from it, if it exists.  For example,</span>
<a href="#l108.111"></a><span id="l108.111">    MimeHeaders_get_parameter(&quot;text/plain; charset=us-ascii&quot;, &quot;charset&quot;)</span>
<a href="#l108.112"></a><span id="l108.112">    would return &quot;us-ascii&quot;.</span>
<a href="#l108.113"></a><span id="l108.113"> </span>
<a href="#l108.114"></a><span id="l108.114">    Returns NULL if there is no match, or if there is an allocation failure.</span>
<a href="#l108.115"></a><span id="l108.115"> </span>
<a href="#l108.116"></a><span id="l108.116" class="difflineat">@@ -90,132 +87,130 @@ extern char *MimeHeaders_get(MimeHeaders</span>
<a href="#l108.117"></a><span id="l108.117">    Languages, and Continuations</span>
<a href="#l108.118"></a><span id="l108.118"> </span>
<a href="#l108.119"></a><span id="l108.119">    RFC2231 has added the character sets, languages, and continuations mechanism.</span>
<a href="#l108.120"></a><span id="l108.120">    charset, and language information may also be returned to the caller.</span>
<a href="#l108.121"></a><span id="l108.121">    Note that charset and language should be free()'d while</span>
<a href="#l108.122"></a><span id="l108.122">    the return value (parameter) has to be PR_FREE'd.</span>
<a href="#l108.123"></a><span id="l108.123"> </span>
<a href="#l108.124"></a><span id="l108.124">    For example,</span>
<a href="#l108.125"></a><span id="l108.125" class="difflineminus">-   MimeHeaders_get_parameter(&quot;text/plain; name*=us-ascii'en-us'This%20is%20%2A%2A%2Afun%2A%2A%2A&quot;, &quot;name&quot;)</span>
<a href="#l108.126"></a><span id="l108.126" class="difflineminus">-   MimeHeaders_get_parameter(&quot;text/plain; name*0*=us-ascii'en-us'This%20is%20; CRLFLWSPname*1*=%2A%2A%2Afun%2A%2A%2A&quot;, &quot;name&quot;)</span>
<a href="#l108.127"></a><span id="l108.127" class="difflineminus">-   would return &quot;This is ***fun***&quot; and *charset = &quot;us-ascii&quot;, *language = &quot;en-us&quot;</span>
<a href="#l108.128"></a><span id="l108.128" class="difflineplus">+   MimeHeaders_get_parameter(&quot;text/plain;</span>
<a href="#l108.129"></a><span id="l108.129" class="difflineplus">+   name*=us-ascii'en-us'This%20is%20%2A%2A%2Afun%2A%2A%2A&quot;, &quot;name&quot;)</span>
<a href="#l108.130"></a><span id="l108.130" class="difflineplus">+   MimeHeaders_get_parameter(&quot;text/plain; name*0*=us-ascii'en-us'This%20is%20;</span>
<a href="#l108.131"></a><span id="l108.131" class="difflineplus">+   CRLFLWSPname*1*=%2A%2A%2Afun%2A%2A%2A&quot;, &quot;name&quot;) would return &quot;This is</span>
<a href="#l108.132"></a><span id="l108.132" class="difflineplus">+   ***fun***&quot; and *charset = &quot;us-ascii&quot;, *language = &quot;en-us&quot;</span>
<a href="#l108.133"></a><span id="l108.133">  */</span>
<a href="#l108.134"></a><span id="l108.134" class="difflineminus">-extern char *MimeHeaders_get_parameter (const char *header_value,</span>
<a href="#l108.135"></a><span id="l108.135" class="difflineminus">-                    const char *parm_name,</span>
<a href="#l108.136"></a><span id="l108.136" class="difflineminus">-                    char **charset,</span>
<a href="#l108.137"></a><span id="l108.137" class="difflineminus">-                    char **language);</span>
<a href="#l108.138"></a><span id="l108.138" class="difflineplus">+extern char *MimeHeaders_get_parameter(const char *header_value,</span>
<a href="#l108.139"></a><span id="l108.139" class="difflineplus">+                                       const char *parm_name, char **charset,</span>
<a href="#l108.140"></a><span id="l108.140" class="difflineplus">+                                       char **language);</span>
<a href="#l108.141"></a><span id="l108.141"> </span>
<a href="#l108.142"></a><span id="l108.142" class="difflineminus">-extern      MimeHeaders *MimeHeaders_copy (MimeHeaders *srcHeaders);</span>
<a href="#l108.143"></a><span id="l108.143" class="difflineplus">+extern MimeHeaders *MimeHeaders_copy(MimeHeaders *srcHeaders);</span>
<a href="#l108.144"></a><span id="l108.144"> </span>
<a href="#l108.145"></a><span id="l108.145" class="difflineminus">-extern void MimeHeaders_free (MimeHeaders *hdrs);</span>
<a href="#l108.146"></a><span id="l108.146" class="difflineplus">+extern void MimeHeaders_free(MimeHeaders *hdrs);</span>
<a href="#l108.147"></a><span id="l108.147"> </span>
<a href="#l108.148"></a><span id="l108.148"> typedef enum {</span>
<a href="#l108.149"></a><span id="l108.149" class="difflineminus">-  MimeHeadersAll,          /* Show all headers */</span>
<a href="#l108.150"></a><span id="l108.150" class="difflineminus">-  MimeHeadersSome,        /* Show all &quot;interesting&quot; headers */</span>
<a href="#l108.151"></a><span id="l108.151" class="difflineminus">-  MimeHeadersSomeNoRef,    /* Same, but suppress the `References' header</span>
<a href="#l108.152"></a><span id="l108.152" class="difflineminus">-                             (for when we're printing this message.) */</span>
<a href="#l108.153"></a><span id="l108.153" class="difflineminus">-  MimeHeadersMicro,        /* Show a one-line header summary */</span>
<a href="#l108.154"></a><span id="l108.154" class="difflineminus">-  MimeHeadersMicroPlus,    /* Same, but show the full recipient list as</span>
<a href="#l108.155"></a><span id="l108.155" class="difflineminus">-                             well (To, CC, etc.) */</span>
<a href="#l108.156"></a><span id="l108.156" class="difflineminus">-  MimeHeadersCitation,    /* A one-line summary geared toward use in a</span>
<a href="#l108.157"></a><span id="l108.157" class="difflineminus">-                             reply citation (&quot;So-and-so wrote:&quot;) */</span>
<a href="#l108.158"></a><span id="l108.158" class="difflineminus">-  MimeHeadersOnly,        /* Just parse and output headers...nothing else! */</span>
<a href="#l108.159"></a><span id="l108.159" class="difflineminus">-  MimeHeadersNone         /* Skip showing any headers */</span>
<a href="#l108.160"></a><span id="l108.160" class="difflineplus">+  MimeHeadersAll,       /* Show all headers */</span>
<a href="#l108.161"></a><span id="l108.161" class="difflineplus">+  MimeHeadersSome,      /* Show all &quot;interesting&quot; headers */</span>
<a href="#l108.162"></a><span id="l108.162" class="difflineplus">+  MimeHeadersSomeNoRef, /* Same, but suppress the `References' header</span>
<a href="#l108.163"></a><span id="l108.163" class="difflineplus">+                          (for when we're printing this message.) */</span>
<a href="#l108.164"></a><span id="l108.164" class="difflineplus">+  MimeHeadersMicro,     /* Show a one-line header summary */</span>
<a href="#l108.165"></a><span id="l108.165" class="difflineplus">+  MimeHeadersMicroPlus, /* Same, but show the full recipient list as</span>
<a href="#l108.166"></a><span id="l108.166" class="difflineplus">+                          well (To, CC, etc.) */</span>
<a href="#l108.167"></a><span id="l108.167" class="difflineplus">+  MimeHeadersCitation,  /* A one-line summary geared toward use in a</span>
<a href="#l108.168"></a><span id="l108.168" class="difflineplus">+                           reply citation (&quot;So-and-so wrote:&quot;) */</span>
<a href="#l108.169"></a><span id="l108.169" class="difflineplus">+  MimeHeadersOnly,      /* Just parse and output headers...nothing else! */</span>
<a href="#l108.170"></a><span id="l108.170" class="difflineplus">+  MimeHeadersNone       /* Skip showing any headers */</span>
<a href="#l108.171"></a><span id="l108.171"> } MimeHeadersState;</span>
<a href="#l108.172"></a><span id="l108.172"> </span>
<a href="#l108.173"></a><span id="l108.173" class="difflineminus">-</span>
<a href="#l108.174"></a><span id="l108.174"> /* The signature for various callbacks in the MimeDisplayOptions structure.</span>
<a href="#l108.175"></a><span id="l108.175">  */</span>
<a href="#l108.176"></a><span id="l108.176" class="difflineminus">-typedef char *(*MimeHTMLGeneratorFunction) (const char *data, void *closure,</span>
<a href="#l108.177"></a><span id="l108.177" class="difflineminus">-                      MimeHeaders *headers);</span>
<a href="#l108.178"></a><span id="l108.178" class="difflineplus">+typedef char *(*MimeHTMLGeneratorFunction)(const char *data, void *closure,</span>
<a href="#l108.179"></a><span id="l108.179" class="difflineplus">+                                           MimeHeaders *headers);</span>
<a href="#l108.180"></a><span id="l108.180"> </span>
<a href="#l108.181"></a><span id="l108.181" class="difflineminus">-class MimeDisplayOptions</span>
<a href="#l108.182"></a><span id="l108.182" class="difflineminus">-{</span>
<a href="#l108.183"></a><span id="l108.183" class="difflineminus">-public:</span>
<a href="#l108.184"></a><span id="l108.184" class="difflineplus">+class MimeDisplayOptions {</span>
<a href="#l108.185"></a><span id="l108.185" class="difflineplus">+ public:</span>
<a href="#l108.186"></a><span id="l108.186">   MimeDisplayOptions();</span>
<a href="#l108.187"></a><span id="l108.187">   virtual ~MimeDisplayOptions();</span>
<a href="#l108.188"></a><span id="l108.188" class="difflineminus">-  mozITXTToHTMLConv   *conv;        // For text conversion...</span>
<a href="#l108.189"></a><span id="l108.189" class="difflineplus">+  mozITXTToHTMLConv *conv;              // For text conversion...</span>
<a href="#l108.190"></a><span id="l108.190">   nsCOMPtr&lt;nsIPrefBranch&gt; m_prefBranch; /* prefBranch-service */</span>
<a href="#l108.191"></a><span id="l108.191" class="difflineminus">-  nsMimeOutputType    format_out;   // The format out type</span>
<a href="#l108.192"></a><span id="l108.192" class="difflineplus">+  nsMimeOutputType format_out;          // The format out type</span>
<a href="#l108.193"></a><span id="l108.193"> </span>
<a href="#l108.194"></a><span id="l108.194" class="difflineminus">-  const char *url;      /* Base URL for the document.  This string should</span>
<a href="#l108.195"></a><span id="l108.195" class="difflineminus">-                 be freed by the caller, after the parser</span>
<a href="#l108.196"></a><span id="l108.196" class="difflineminus">-                 completes (possibly at the same time as the</span>
<a href="#l108.197"></a><span id="l108.197" class="difflineminus">-                 MimeDisplayOptions itself.) */</span>
<a href="#l108.198"></a><span id="l108.198" class="difflineplus">+  const char *url; /* Base URL for the document.  This string should</span>
<a href="#l108.199"></a><span id="l108.199" class="difflineplus">+            be freed by the caller, after the parser</span>
<a href="#l108.200"></a><span id="l108.200" class="difflineplus">+            completes (possibly at the same time as the</span>
<a href="#l108.201"></a><span id="l108.201" class="difflineplus">+            MimeDisplayOptions itself.) */</span>
<a href="#l108.202"></a><span id="l108.202"> </span>
<a href="#l108.203"></a><span id="l108.203" class="difflineminus">-  MimeHeadersState headers;  /* How headers should be displayed. */</span>
<a href="#l108.204"></a><span id="l108.204" class="difflineminus">-  bool fancy_headers_p;  /* Whether to do clever formatting of headers</span>
<a href="#l108.205"></a><span id="l108.205" class="difflineminus">-                 using tables, instead of spaces. */</span>
<a href="#l108.206"></a><span id="l108.206" class="difflineplus">+  MimeHeadersState headers; /* How headers should be displayed. */</span>
<a href="#l108.207"></a><span id="l108.207" class="difflineplus">+  bool fancy_headers_p;     /* Whether to do clever formatting of headers</span>
<a href="#l108.208"></a><span id="l108.208" class="difflineplus">+                    using tables, instead of spaces. */</span>
<a href="#l108.209"></a><span id="l108.209"> </span>
<a href="#l108.210"></a><span id="l108.210" class="difflineminus">-  bool output_vcard_buttons_p;  /* Whether to output the buttons */</span>
<a href="#l108.211"></a><span id="l108.211" class="difflineminus">-                  /* on vcards. */</span>
<a href="#l108.212"></a><span id="l108.212" class="difflineplus">+  bool output_vcard_buttons_p; /* Whether to output the buttons */</span>
<a href="#l108.213"></a><span id="l108.213" class="difflineplus">+                               /* on vcards. */</span>
<a href="#l108.214"></a><span id="l108.214"> </span>
<a href="#l108.215"></a><span id="l108.215" class="difflineminus">-  bool variable_width_plaintext_p;  /* Whether text/plain messages should</span>
<a href="#l108.216"></a><span id="l108.216" class="difflineminus">-                       be in variable width, or fixed. */</span>
<a href="#l108.217"></a><span id="l108.217" class="difflineminus">-  bool wrap_long_lines_p;  /* Whether to wrap long lines in text/plain</span>
<a href="#l108.218"></a><span id="l108.218" class="difflineminus">-                   messages. */</span>
<a href="#l108.219"></a><span id="l108.219" class="difflineplus">+  bool variable_width_plaintext_p; /* Whether text/plain messages should</span>
<a href="#l108.220"></a><span id="l108.220" class="difflineplus">+                      be in variable width, or fixed. */</span>
<a href="#l108.221"></a><span id="l108.221" class="difflineplus">+  bool wrap_long_lines_p;          /* Whether to wrap long lines in text/plain</span>
<a href="#l108.222"></a><span id="l108.222" class="difflineplus">+                           messages. */</span>
<a href="#l108.223"></a><span id="l108.223"> </span>
<a href="#l108.224"></a><span id="l108.224" class="difflineminus">-  bool rot13_p;      /* Whether text/plain parts should be rotated</span>
<a href="#l108.225"></a><span id="l108.225" class="difflineminus">-                 Set by &quot;?rot13=true&quot; */</span>
<a href="#l108.226"></a><span id="l108.226" class="difflineminus">-  char *part_to_load;    /* The particular part of the multipart which</span>
<a href="#l108.227"></a><span id="l108.227" class="difflineminus">-                 we are extracting.  Set by &quot;?part=3.2.4&quot; */</span>
<a href="#l108.228"></a><span id="l108.228" class="difflineplus">+  bool rot13_p;       /* Whether text/plain parts should be rotated</span>
<a href="#l108.229"></a><span id="l108.229" class="difflineplus">+                  Set by &quot;?rot13=true&quot; */</span>
<a href="#l108.230"></a><span id="l108.230" class="difflineplus">+  char *part_to_load; /* The particular part of the multipart which</span>
<a href="#l108.231"></a><span id="l108.231" class="difflineplus">+              we are extracting.  Set by &quot;?part=3.2.4&quot; */</span>
<a href="#l108.232"></a><span id="l108.232"> </span>
<a href="#l108.233"></a><span id="l108.233">   bool no_output_p; /* Will never write output when this is true.</span>
<a href="#l108.234"></a><span id="l108.234">           (When false, output or not may depend on other things.)</span>
<a href="#l108.235"></a><span id="l108.235">           This needs to be in the options, because the method</span>
<a href="#l108.236"></a><span id="l108.236">           MimeObject_parse_begin is controlling the property &quot;output_p&quot;</span>
<a href="#l108.237"></a><span id="l108.237">           (on the MimeObject) so we need a way for other functions to</span>
<a href="#l108.238"></a><span id="l108.238">           override it and tell that we do not want output. */</span>
<a href="#l108.239"></a><span id="l108.239"> </span>
<a href="#l108.240"></a><span id="l108.240" class="difflineminus">-  bool write_html_p;    /* Whether the output should be HTML, or raw. */</span>
<a href="#l108.241"></a><span id="l108.241" class="difflineplus">+  bool write_html_p; /* Whether the output should be HTML, or raw. */</span>
<a href="#l108.242"></a><span id="l108.242"> </span>
<a href="#l108.243"></a><span id="l108.243" class="difflineminus">-  bool decrypt_p;    /* Whether all traces of xlateion should be</span>
<a href="#l108.244"></a><span id="l108.244" class="difflineminus">-                 eradicated -- this is only meaningful when</span>
<a href="#l108.245"></a><span id="l108.245" class="difflineminus">-                 write_html_p is false; we set this when</span>
<a href="#l108.246"></a><span id="l108.246" class="difflineminus">-                 attaching a message for forwarding, since</span>
<a href="#l108.247"></a><span id="l108.247" class="difflineminus">-                 forwarding someone else a message that wasn't</span>
<a href="#l108.248"></a><span id="l108.248" class="difflineminus">-                 xlated for them doesn't work.  We have to</span>
<a href="#l108.249"></a><span id="l108.249" class="difflineminus">-                 dexlate it before sending it.</span>
<a href="#l108.250"></a><span id="l108.250" class="difflineminus">-               */</span>
<a href="#l108.251"></a><span id="l108.251" class="difflineplus">+  bool decrypt_p; /* Whether all traces of xlateion should be</span>
<a href="#l108.252"></a><span id="l108.252" class="difflineplus">+              eradicated -- this is only meaningful when</span>
<a href="#l108.253"></a><span id="l108.253" class="difflineplus">+              write_html_p is false; we set this when</span>
<a href="#l108.254"></a><span id="l108.254" class="difflineplus">+              attaching a message for forwarding, since</span>
<a href="#l108.255"></a><span id="l108.255" class="difflineplus">+              forwarding someone else a message that wasn't</span>
<a href="#l108.256"></a><span id="l108.256" class="difflineplus">+              xlated for them doesn't work.  We have to</span>
<a href="#l108.257"></a><span id="l108.257" class="difflineplus">+              dexlate it before sending it.</span>
<a href="#l108.258"></a><span id="l108.258" class="difflineplus">+            */</span>
<a href="#l108.259"></a><span id="l108.259"> </span>
<a href="#l108.260"></a><span id="l108.260">   /* Whether this MIME part is a child of another part (and not top level). */</span>
<a href="#l108.261"></a><span id="l108.261">   bool is_child = false;</span>
<a href="#l108.262"></a><span id="l108.262"> </span>
<a href="#l108.263"></a><span id="l108.263" class="difflineminus">-  uint32_t whattodo ;       /* from the prefs, we'll get if the user wants to do glyph or structure substitutions and set this member variable. */</span>
<a href="#l108.264"></a><span id="l108.264" class="difflineplus">+  uint32_t</span>
<a href="#l108.265"></a><span id="l108.265" class="difflineplus">+      whattodo; /* from the prefs, we'll get if the user wants to do glyph or</span>
<a href="#l108.266"></a><span id="l108.266" class="difflineplus">+                   structure substitutions and set this member variable. */</span>
<a href="#l108.267"></a><span id="l108.267"> </span>
<a href="#l108.268"></a><span id="l108.268" class="difflineminus">-  char *default_charset;  /* If this is non-NULL, then it is the charset to</span>
<a href="#l108.269"></a><span id="l108.269" class="difflineminus">-                 assume when no other one is specified via a</span>
<a href="#l108.270"></a><span id="l108.270" class="difflineminus">-                 `charset' parameter.</span>
<a href="#l108.271"></a><span id="l108.271" class="difflineminus">-               */</span>
<a href="#l108.272"></a><span id="l108.272" class="difflineminus">-  bool override_charset;  /* If this is true, then we will assume that</span>
<a href="#l108.273"></a><span id="l108.273" class="difflineminus">-                 all data is in the default_charset, regardless</span>
<a href="#l108.274"></a><span id="l108.274" class="difflineminus">-                               of what the `charset' parameter of that part</span>
<a href="#l108.275"></a><span id="l108.275" class="difflineminus">-                               says. (This is to cope with the fact that, in</span>
<a href="#l108.276"></a><span id="l108.276" class="difflineminus">-                               the real world, many messages are mislabelled</span>
<a href="#l108.277"></a><span id="l108.277" class="difflineminus">-                               with the wrong charset.)</span>
<a href="#l108.278"></a><span id="l108.278" class="difflineminus">-               */</span>
<a href="#l108.279"></a><span id="l108.279" class="difflineminus">-  bool    force_user_charset; /* this is the new strategy to deal with incorrectly</span>
<a href="#l108.280"></a><span id="l108.280" class="difflineminus">-                                 labeled attachments */</span>
<a href="#l108.281"></a><span id="l108.281" class="difflineplus">+  char *default_charset;   /* If this is non-NULL, then it is the charset to</span>
<a href="#l108.282"></a><span id="l108.282" class="difflineplus">+                  assume when no other one is specified via a</span>
<a href="#l108.283"></a><span id="l108.283" class="difflineplus">+                  `charset' parameter.</span>
<a href="#l108.284"></a><span id="l108.284" class="difflineplus">+                */</span>
<a href="#l108.285"></a><span id="l108.285" class="difflineplus">+  bool override_charset;   /* If this is true, then we will assume that</span>
<a href="#l108.286"></a><span id="l108.286" class="difflineplus">+                  all data is in the default_charset, regardless</span>
<a href="#l108.287"></a><span id="l108.287" class="difflineplus">+                                of what the `charset' parameter of that part</span>
<a href="#l108.288"></a><span id="l108.288" class="difflineplus">+                                says. (This is to cope with the fact that, in</span>
<a href="#l108.289"></a><span id="l108.289" class="difflineplus">+                                the real world, many messages are mislabelled</span>
<a href="#l108.290"></a><span id="l108.290" class="difflineplus">+                                with the wrong charset.)</span>
<a href="#l108.291"></a><span id="l108.291" class="difflineplus">+                */</span>
<a href="#l108.292"></a><span id="l108.292" class="difflineplus">+  bool force_user_charset; /* this is the new strategy to deal with incorrectly</span>
<a href="#l108.293"></a><span id="l108.293" class="difflineplus">+                              labeled attachments */</span>
<a href="#l108.294"></a><span id="l108.294"> </span>
<a href="#l108.295"></a><span id="l108.295">   /* =======================================================================</span>
<a href="#l108.296"></a><span id="l108.296">    Stream-related callbacks; for these functions, the `closure' argument</span>
<a href="#l108.297"></a><span id="l108.297">    is what is found in `options-&gt;stream_closure'.  (One possible exception</span>
<a href="#l108.298"></a><span id="l108.298">    is for output_fn; see &quot;output_closure&quot; below.)</span>
<a href="#l108.299"></a><span id="l108.299">    */</span>
<a href="#l108.300"></a><span id="l108.300">   void *stream_closure;</span>
<a href="#l108.301"></a><span id="l108.301"> </span>
<a href="#l108.302"></a><span id="l108.302">   /* For setting up the display stream, so that the MIME parser can inform</span>
<a href="#l108.303"></a><span id="l108.303">    the caller of the type of the data it will be getting. */</span>
<a href="#l108.304"></a><span id="l108.304" class="difflineminus">-  int (*output_init_fn) (const char *type,</span>
<a href="#l108.305"></a><span id="l108.305" class="difflineminus">-             const char *charset,</span>
<a href="#l108.306"></a><span id="l108.306" class="difflineminus">-             const char *name,</span>
<a href="#l108.307"></a><span id="l108.307" class="difflineminus">-             const char *x_mac_type,</span>
<a href="#l108.308"></a><span id="l108.308" class="difflineminus">-             const char *x_mac_creator,</span>
<a href="#l108.309"></a><span id="l108.309" class="difflineminus">-             void *stream_closure);</span>
<a href="#l108.310"></a><span id="l108.310" class="difflineplus">+  int (*output_init_fn)(const char *type, const char *charset, const char *name,</span>
<a href="#l108.311"></a><span id="l108.311" class="difflineplus">+                        const char *x_mac_type, const char *x_mac_creator,</span>
<a href="#l108.312"></a><span id="l108.312" class="difflineplus">+                        void *stream_closure);</span>
<a href="#l108.313"></a><span id="l108.313"> </span>
<a href="#l108.314"></a><span id="l108.314">   /* How the MIME parser feeds its output (HTML or raw) back to the caller. */</span>
<a href="#l108.315"></a><span id="l108.315">   MimeConverterOutputCallback output_fn;</span>
<a href="#l108.316"></a><span id="l108.316"> </span>
<a href="#l108.317"></a><span id="l108.317">   /* Closure to pass to the above output_fn.  If NULL, then the</span>
<a href="#l108.318"></a><span id="l108.318">    stream_closure is used. */</span>
<a href="#l108.319"></a><span id="l108.319">   void *output_closure;</span>
<a href="#l108.320"></a><span id="l108.320"> </span>
<a href="#l108.321"></a><span id="l108.321" class="difflineat">@@ -231,28 +226,27 @@ public:</span>
<a href="#l108.322"></a><span id="l108.322">    `input_charset' is a string representing the charset of this string (as</span>
<a href="#l108.323"></a><span id="l108.323">      specified by MIME headers.)</span>
<a href="#l108.324"></a><span id="l108.324">    The conversion is always to UTF-8.</span>
<a href="#l108.325"></a><span id="l108.325">    `output_ret' is where a newly-malloced string is returned.  It may be</span>
<a href="#l108.326"></a><span id="l108.326">      NULL if no translation is needed.</span>
<a href="#l108.327"></a><span id="l108.327">    `output_size_ret' is how long the returned string is (it need not be</span>
<a href="#l108.328"></a><span id="l108.328">      NULL-terminated.).</span>
<a href="#l108.329"></a><span id="l108.329">    */</span>
<a href="#l108.330"></a><span id="l108.330" class="difflineminus">-  int (*charset_conversion_fn) (const char *input_line,</span>
<a href="#l108.331"></a><span id="l108.331" class="difflineminus">-                int32_t input_length, const char *input_charset,</span>
<a href="#l108.332"></a><span id="l108.332" class="difflineminus">-                nsACString&amp; output_ret,</span>
<a href="#l108.333"></a><span id="l108.333" class="difflineminus">-                void *stream_closure);</span>
<a href="#l108.334"></a><span id="l108.334" class="difflineplus">+  int (*charset_conversion_fn)(const char *input_line, int32_t input_length,</span>
<a href="#l108.335"></a><span id="l108.335" class="difflineplus">+                               const char *input_charset,</span>
<a href="#l108.336"></a><span id="l108.336" class="difflineplus">+                               nsACString &amp;output_ret, void *stream_closure);</span>
<a href="#l108.337"></a><span id="l108.337"> </span>
<a href="#l108.338"></a><span id="l108.338">   /* If true, perform both charset-conversion and decoding of</span>
<a href="#l108.339"></a><span id="l108.339">    MIME-2 header fields (using RFC-1522 encoding.)</span>
<a href="#l108.340"></a><span id="l108.340">    */</span>
<a href="#l108.341"></a><span id="l108.341">   bool rfc1522_conversion_p;</span>
<a href="#l108.342"></a><span id="l108.342"> </span>
<a href="#l108.343"></a><span id="l108.343">   /* A hook for the caller to turn a file name into a content-type. */</span>
<a href="#l108.344"></a><span id="l108.344" class="difflineminus">-  char *(*file_type_fn) (const char *filename, void *stream_closure);</span>
<a href="#l108.345"></a><span id="l108.345" class="difflineplus">+  char *(*file_type_fn)(const char *filename, void *stream_closure);</span>
<a href="#l108.346"></a><span id="l108.346"> </span>
<a href="#l108.347"></a><span id="l108.347">   /* A hook by which the user may be prompted for a password by the security</span>
<a href="#l108.348"></a><span id="l108.348">    library.  (This is really of type `SECKEYGetPasswordKey'; see sec.h.) */</span>
<a href="#l108.349"></a><span id="l108.349">   void *(*passwd_prompt_fn)(void *arg1, void *arg2);</span>
<a href="#l108.350"></a><span id="l108.350"> </span>
<a href="#l108.351"></a><span id="l108.351">   /* =======================================================================</span>
<a href="#l108.352"></a><span id="l108.352">    Various callbacks; for all of these functions, the `closure' argument</span>
<a href="#l108.353"></a><span id="l108.353">    is what is found in `html_closure'.</span>
<a href="#l108.354"></a><span id="l108.354" class="difflineat">@@ -284,96 +278,94 @@ public:</span>
<a href="#l108.355"></a><span id="l108.355">      Callbacks to handle the backend-specific inlined image display</span>
<a href="#l108.356"></a><span id="l108.356">    (internal-external-reconnect junk.)  For `image_begin', the `closure'</span>
<a href="#l108.357"></a><span id="l108.357">    argument is what is found in `stream_closure'; but for all of the</span>
<a href="#l108.358"></a><span id="l108.358">    others, the `closure' argument is the data that `image_begin' returned.</span>
<a href="#l108.359"></a><span id="l108.359">    */</span>
<a href="#l108.360"></a><span id="l108.360"> </span>
<a href="#l108.361"></a><span id="l108.361">   /* Begins processing an embedded image; the URL and content_type are of the</span>
<a href="#l108.362"></a><span id="l108.362">    image itself. */</span>
<a href="#l108.363"></a><span id="l108.363" class="difflineminus">-  void *(*image_begin) (const char *image_url, const char *content_type,</span>
<a href="#l108.364"></a><span id="l108.364" class="difflineminus">-            void *stream_closure);</span>
<a href="#l108.365"></a><span id="l108.365" class="difflineplus">+  void *(*image_begin)(const char *image_url, const char *content_type,</span>
<a href="#l108.366"></a><span id="l108.366" class="difflineplus">+                       void *stream_closure);</span>
<a href="#l108.367"></a><span id="l108.367"> </span>
<a href="#l108.368"></a><span id="l108.368">   /* Stop processing an image. */</span>
<a href="#l108.369"></a><span id="l108.369" class="difflineminus">-  void (*image_end) (void *image_closure, int status);</span>
<a href="#l108.370"></a><span id="l108.370" class="difflineplus">+  void (*image_end)(void *image_closure, int status);</span>
<a href="#l108.371"></a><span id="l108.371"> </span>
<a href="#l108.372"></a><span id="l108.372">   /* Dump some raw image data down the stream. */</span>
<a href="#l108.373"></a><span id="l108.373" class="difflineminus">-  int (*image_write_buffer) (const char *buf, int32_t size, void *image_closure);</span>
<a href="#l108.374"></a><span id="l108.374" class="difflineplus">+  int (*image_write_buffer)(const char *buf, int32_t size, void *image_closure);</span>
<a href="#l108.375"></a><span id="l108.375"> </span>
<a href="#l108.376"></a><span id="l108.376">   /* What HTML should be dumped out for this image. */</span>
<a href="#l108.377"></a><span id="l108.377" class="difflineminus">-  char *(*make_image_html) (void *image_closure);</span>
<a href="#l108.378"></a><span id="l108.378" class="difflineminus">-</span>
<a href="#l108.379"></a><span id="l108.379" class="difflineplus">+  char *(*make_image_html)(void *image_closure);</span>
<a href="#l108.380"></a><span id="l108.380"> </span>
<a href="#l108.381"></a><span id="l108.381">   /* =======================================================================</span>
<a href="#l108.382"></a><span id="l108.382">    Other random opaque state.</span>
<a href="#l108.383"></a><span id="l108.383">    */</span>
<a href="#l108.384"></a><span id="l108.384" class="difflineminus">-  MimeParseStateObject *state;    /* Some state used by libmime internals;</span>
<a href="#l108.385"></a><span id="l108.385" class="difflineminus">-                     initialize this to 0 and leave it alone.</span>
<a href="#l108.386"></a><span id="l108.386" class="difflineminus">-                   */</span>
<a href="#l108.387"></a><span id="l108.387" class="difflineminus">-</span>
<a href="#l108.388"></a><span id="l108.388" class="difflineplus">+  MimeParseStateObject *state; /* Some state used by libmime internals;</span>
<a href="#l108.389"></a><span id="l108.389" class="difflineplus">+                  initialize this to 0 and leave it alone.</span>
<a href="#l108.390"></a><span id="l108.390" class="difflineplus">+                */</span>
<a href="#l108.391"></a><span id="l108.391"> </span>
<a href="#l108.392"></a><span id="l108.392"> #ifdef MIME_DRAFTS</span>
<a href="#l108.393"></a><span id="l108.393">   /* =======================================================================</span>
<a href="#l108.394"></a><span id="l108.394">   Mail Draft hooks -- 09-19-1996</span>
<a href="#l108.395"></a><span id="l108.395">    */</span>
<a href="#l108.396"></a><span id="l108.396" class="difflineminus">-  bool decompose_file_p;            /* are we decomposing a mime msg</span>
<a href="#l108.397"></a><span id="l108.397" class="difflineminus">-                     into separate files */</span>
<a href="#l108.398"></a><span id="l108.398" class="difflineminus">-  bool done_parsing_outer_headers;  /* are we done parsing the outer message</span>
<a href="#l108.399"></a><span id="l108.399" class="difflineminus">-                      headers; this is really useful when</span>
<a href="#l108.400"></a><span id="l108.400" class="difflineminus">-                      we have multiple Message/RFC822</span>
<a href="#l108.401"></a><span id="l108.401" class="difflineminus">-                      headers */</span>
<a href="#l108.402"></a><span id="l108.402" class="difflineminus">-  bool is_multipart_msg;            /* are we decomposing a multipart</span>
<a href="#l108.403"></a><span id="l108.403" class="difflineminus">-                      message */</span>
<a href="#l108.404"></a><span id="l108.404" class="difflineplus">+  bool decompose_file_p;           /* are we decomposing a mime msg</span>
<a href="#l108.405"></a><span id="l108.405" class="difflineplus">+                    into separate files */</span>
<a href="#l108.406"></a><span id="l108.406" class="difflineplus">+  bool done_parsing_outer_headers; /* are we done parsing the outer message</span>
<a href="#l108.407"></a><span id="l108.407" class="difflineplus">+                     headers; this is really useful when</span>
<a href="#l108.408"></a><span id="l108.408" class="difflineplus">+                     we have multiple Message/RFC822</span>
<a href="#l108.409"></a><span id="l108.409" class="difflineplus">+                     headers */</span>
<a href="#l108.410"></a><span id="l108.410" class="difflineplus">+  bool is_multipart_msg;           /* are we decomposing a multipart</span>
<a href="#l108.411"></a><span id="l108.411" class="difflineplus">+                     message */</span>
<a href="#l108.412"></a><span id="l108.412"> </span>
<a href="#l108.413"></a><span id="l108.413" class="difflineminus">-  int decompose_init_count;            /* used for non multipart message only</span>
<a href="#l108.414"></a><span id="l108.414" class="difflineminus">-                    */</span>
<a href="#l108.415"></a><span id="l108.415" class="difflineplus">+  int decompose_init_count; /* used for non multipart message only</span>
<a href="#l108.416"></a><span id="l108.416" class="difflineplus">+                             */</span>
<a href="#l108.417"></a><span id="l108.417"> </span>
<a href="#l108.418"></a><span id="l108.418" class="difflineminus">-  bool signed_p;             /* to tell draft this is a signed</span>
<a href="#l108.419"></a><span id="l108.419" class="difflineminus">-                      message */</span>
<a href="#l108.420"></a><span id="l108.420" class="difflineplus">+  bool signed_p; /* to tell draft this is a signed</span>
<a href="#l108.421"></a><span id="l108.421" class="difflineplus">+          message */</span>
<a href="#l108.422"></a><span id="l108.422"> </span>
<a href="#l108.423"></a><span id="l108.423" class="difflineminus">-  bool caller_need_root_headers;    /* set it to true to receive the message main</span>
<a href="#l108.424"></a><span id="l108.424" class="difflineminus">-                                         headers through the callback</span>
<a href="#l108.425"></a><span id="l108.425" class="difflineminus">-                                         decompose_headers_info_fn */</span>
<a href="#l108.426"></a><span id="l108.426" class="difflineplus">+  bool caller_need_root_headers; /* set it to true to receive the message main</span>
<a href="#l108.427"></a><span id="l108.427" class="difflineplus">+                                      headers through the callback</span>
<a href="#l108.428"></a><span id="l108.428" class="difflineplus">+                                      decompose_headers_info_fn */</span>
<a href="#l108.429"></a><span id="l108.429"> </span>
<a href="#l108.430"></a><span id="l108.430">   /* Callback to gather the outer most headers so we could use the</span>
<a href="#l108.431"></a><span id="l108.431">    information to initialize the addressing/subject/newsgroups fields</span>
<a href="#l108.432"></a><span id="l108.432">    for the composition window. */</span>
<a href="#l108.433"></a><span id="l108.433" class="difflineminus">-  int (*decompose_headers_info_fn) (void *closure,</span>
<a href="#l108.434"></a><span id="l108.434" class="difflineminus">-                  MimeHeaders *headers);</span>
<a href="#l108.435"></a><span id="l108.435" class="difflineplus">+  int (*decompose_headers_info_fn)(void *closure, MimeHeaders *headers);</span>
<a href="#l108.436"></a><span id="l108.436"> </span>
<a href="#l108.437"></a><span id="l108.437">   /* Callbacks to create temporary files for drafts attachments. */</span>
<a href="#l108.438"></a><span id="l108.438" class="difflineminus">-  int (*decompose_file_init_fn) (void *stream_closure,</span>
<a href="#l108.439"></a><span id="l108.439" class="difflineminus">-                 MimeHeaders *headers );</span>
<a href="#l108.440"></a><span id="l108.440" class="difflineplus">+  int (*decompose_file_init_fn)(void *stream_closure, MimeHeaders *headers);</span>
<a href="#l108.441"></a><span id="l108.441"> </span>
<a href="#l108.442"></a><span id="l108.442">   MimeConverterOutputCallback decompose_file_output_fn;</span>
<a href="#l108.443"></a><span id="l108.443"> </span>
<a href="#l108.444"></a><span id="l108.444" class="difflineminus">-  int (*decompose_file_close_fn) (void *stream_closure);</span>
<a href="#l108.445"></a><span id="l108.445" class="difflineplus">+  int (*decompose_file_close_fn)(void *stream_closure);</span>
<a href="#l108.446"></a><span id="l108.446"> #endif /* MIME_DRAFTS */</span>
<a href="#l108.447"></a><span id="l108.447"> </span>
<a href="#l108.448"></a><span id="l108.448">   int32_t attachment_icon_layer_id; /* Hackhackhack.  This is zero if we have</span>
<a href="#l108.449"></a><span id="l108.449">                    not yet emitted the attachment layer</span>
<a href="#l108.450"></a><span id="l108.450">                    stuff.  If we have, then this is the</span>
<a href="#l108.451"></a><span id="l108.451">                    id number for that layer, which is a</span>
<a href="#l108.452"></a><span id="l108.452">                    unique random number every time, to keep</span>
<a href="#l108.453"></a><span id="l108.453">                    evil people from writing javascript code</span>
<a href="#l108.454"></a><span id="l108.454">                    to hack it. */</span>
<a href="#l108.455"></a><span id="l108.455"> </span>
<a href="#l108.456"></a><span id="l108.456" class="difflineminus">-  bool missing_parts;  /* Whether or not this message is going to contain</span>
<a href="#l108.457"></a><span id="l108.457" class="difflineminus">-                 missing parts (from IMAP Mime Parts On Demand) */</span>
<a href="#l108.458"></a><span id="l108.458" class="difflineplus">+  bool missing_parts; /* Whether or not this message is going to contain</span>
<a href="#l108.459"></a><span id="l108.459" class="difflineplus">+                missing parts (from IMAP Mime Parts On Demand) */</span>
<a href="#l108.460"></a><span id="l108.460"> </span>
<a href="#l108.461"></a><span id="l108.461" class="difflineminus">-  bool show_attachment_inline_p; /* Whether or not we should display attachment inline (whatever say</span>
<a href="#l108.462"></a><span id="l108.462" class="difflineminus">-                         the content-disposition) */</span>
<a href="#l108.463"></a><span id="l108.463" class="difflineplus">+  bool show_attachment_inline_p; /* Whether or not we should display attachment</span>
<a href="#l108.464"></a><span id="l108.464" class="difflineplus">+                         inline (whatever say the content-disposition) */</span>
<a href="#l108.465"></a><span id="l108.465"> </span>
<a href="#l108.466"></a><span id="l108.466" class="difflineminus">-  bool show_attachment_inline_text; /* Whether or not we should display text attachment inline (whatever</span>
<a href="#l108.467"></a><span id="l108.467" class="difflineminus">-                         the content-disposition says) */</span>
<a href="#l108.468"></a><span id="l108.468" class="difflineplus">+  bool show_attachment_inline_text; /* Whether or not we should display text</span>
<a href="#l108.469"></a><span id="l108.469" class="difflineplus">+                         attachment inline (whatever the content-disposition</span>
<a href="#l108.470"></a><span id="l108.470" class="difflineplus">+                         says) */</span>
<a href="#l108.471"></a><span id="l108.471"> </span>
<a href="#l108.472"></a><span id="l108.472" class="difflineminus">-  bool quote_attachment_inline_p; /* Whether or not we should include inlined attachments in</span>
<a href="#l108.473"></a><span id="l108.473" class="difflineminus">-                         quotes of replies) */</span>
<a href="#l108.474"></a><span id="l108.474" class="difflineplus">+  bool quote_attachment_inline_p; /* Whether or not we should include inlined</span>
<a href="#l108.475"></a><span id="l108.475" class="difflineplus">+                         attachments in quotes of replies) */</span>
<a href="#l108.476"></a><span id="l108.476"> </span>
<a href="#l108.477"></a><span id="l108.477" class="difflineminus">-  int32_t html_as_p; /* How we should display HTML, which allows us to know if we should display all body parts */</span>
<a href="#l108.478"></a><span id="l108.478" class="difflineplus">+  int32_t html_as_p; /* How we should display HTML, which allows us to know if</span>
<a href="#l108.479"></a><span id="l108.479" class="difflineplus">+                        we should display all body parts */</span>
<a href="#l108.480"></a><span id="l108.480"> </span>
<a href="#l108.481"></a><span id="l108.481">   /**</span>
<a href="#l108.482"></a><span id="l108.482">    * Should StartBody/EndBody events be generated for nested MimeMessages.  If</span>
<a href="#l108.483"></a><span id="l108.483">    *  false (the default value), the events are only generated for the outermost</span>
<a href="#l108.484"></a><span id="l108.484">    *  MimeMessage.</span>
<a href="#l108.485"></a><span id="l108.485">    */</span>
<a href="#l108.486"></a><span id="l108.486">   bool notify_nested_bodies;</span>
<a href="#l108.487"></a><span id="l108.487"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l109.1"></a><span id="l109.1" class="difflineminus">--- a/mailnews/mime/src/modmimee.h</span>
<a href="#l109.2"></a><span id="l109.2" class="difflineplus">+++ b/mailnews/mime/src/modmimee.h</span>
<a href="#l109.3"></a><span id="l109.3" class="difflineat">@@ -1,56 +1,54 @@</span>
<a href="#l109.4"></a><span id="l109.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l109.5"></a><span id="l109.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l109.6"></a><span id="l109.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l109.7"></a><span id="l109.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l109.8"></a><span id="l109.8" class="difflineminus">- /* -*- Mode: C; tab-width: 4 -*-</span>
<a href="#l109.9"></a><span id="l109.9" class="difflineminus">-   mimeenc.c --- MIME encoders and decoders, version 2 (see mimei.h)</span>
<a href="#l109.10"></a><span id="l109.10" class="difflineminus">-   Copyright (c) 1996 Netscape Communications Corporation, all rights reserved.</span>
<a href="#l109.11"></a><span id="l109.11" class="difflineminus">-   Created: Jamie Zawinski &lt;jwz@netscape.com&gt;, 15-May-96.</span>
<a href="#l109.12"></a><span id="l109.12" class="difflineminus">- */</span>
<a href="#l109.13"></a><span id="l109.13" class="difflineplus">+/* -*- Mode: C; tab-width: 4 -*-</span>
<a href="#l109.14"></a><span id="l109.14" class="difflineplus">+  mimeenc.c --- MIME encoders and decoders, version 2 (see mimei.h)</span>
<a href="#l109.15"></a><span id="l109.15" class="difflineplus">+  Copyright (c) 1996 Netscape Communications Corporation, all rights reserved.</span>
<a href="#l109.16"></a><span id="l109.16" class="difflineplus">+  Created: Jamie Zawinski &lt;jwz@netscape.com&gt;, 15-May-96.</span>
<a href="#l109.17"></a><span id="l109.17" class="difflineplus">+*/</span>
<a href="#l109.18"></a><span id="l109.18"> </span>
<a href="#l109.19"></a><span id="l109.19"> #ifndef _MIMEENC_H_</span>
<a href="#l109.20"></a><span id="l109.20"> #define _MIMEENC_H_</span>
<a href="#l109.21"></a><span id="l109.21"> </span>
<a href="#l109.22"></a><span id="l109.22"> #include &quot;nsError.h&quot;</span>
<a href="#l109.23"></a><span id="l109.23" class="difflineminus">-#include &quot;nscore.h&quot; // for nullptr</span>
<a href="#l109.24"></a><span id="l109.24" class="difflineplus">+#include &quot;nscore.h&quot;  // for nullptr</span>
<a href="#l109.25"></a><span id="l109.25"> </span>
<a href="#l109.26"></a><span id="l109.26" class="difflineminus">-typedef int (*MimeConverterOutputCallback)</span>
<a href="#l109.27"></a><span id="l109.27" class="difflineminus">-  (const char *buf, int32_t size, void *closure);</span>
<a href="#l109.28"></a><span id="l109.28" class="difflineplus">+typedef int (*MimeConverterOutputCallback)(const char *buf, int32_t size,</span>
<a href="#l109.29"></a><span id="l109.29" class="difflineplus">+                                           void *closure);</span>
<a href="#l109.30"></a><span id="l109.30"> </span>
<a href="#l109.31"></a><span id="l109.31"> /* This file defines interfaces to generic implementations of Base64,</span>
<a href="#l109.32"></a><span id="l109.32">    Quoted-Printable, and UU decoders; and of Base64 and Quoted-Printable</span>
<a href="#l109.33"></a><span id="l109.33">    encoders.</span>
<a href="#l109.34"></a><span id="l109.34">  */</span>
<a href="#l109.35"></a><span id="l109.35"> </span>
<a href="#l109.36"></a><span id="l109.36" class="difflineminus">-</span>
<a href="#l109.37"></a><span id="l109.37"> /* Opaque objects used by the encoder/decoder to store state. */</span>
<a href="#l109.38"></a><span id="l109.38"> typedef struct MimeDecoderData MimeDecoderData;</span>
<a href="#l109.39"></a><span id="l109.39"> </span>
<a href="#l109.40"></a><span id="l109.40"> struct MimeObject;</span>
<a href="#l109.41"></a><span id="l109.41"> </span>
<a href="#l109.42"></a><span id="l109.42" class="difflineminus">-</span>
<a href="#l109.43"></a><span id="l109.43"> /* functions for creating that opaque data.</span>
<a href="#l109.44"></a><span id="l109.44">  */</span>
<a href="#l109.45"></a><span id="l109.45"> MimeDecoderData *MimeB64DecoderInit(MimeConverterOutputCallback output_fn,</span>
<a href="#l109.46"></a><span id="l109.46" class="difflineminus">-                  void *closure);</span>
<a href="#l109.47"></a><span id="l109.47" class="difflineplus">+                                    void *closure);</span>
<a href="#l109.48"></a><span id="l109.48"> </span>
<a href="#l109.49"></a><span id="l109.49" class="difflineminus">-MimeDecoderData *MimeQPDecoderInit (MimeConverterOutputCallback output_fn,</span>
<a href="#l109.50"></a><span id="l109.50" class="difflineminus">-                  void *closure, MimeObject *object = nullptr);</span>
<a href="#l109.51"></a><span id="l109.51" class="difflineplus">+MimeDecoderData *MimeQPDecoderInit(MimeConverterOutputCallback output_fn,</span>
<a href="#l109.52"></a><span id="l109.52" class="difflineplus">+                                   void *closure, MimeObject *object = nullptr);</span>
<a href="#l109.53"></a><span id="l109.53"> </span>
<a href="#l109.54"></a><span id="l109.54" class="difflineminus">-MimeDecoderData *MimeUUDecoderInit (MimeConverterOutputCallback output_fn,</span>
<a href="#l109.55"></a><span id="l109.55" class="difflineminus">-                  void *closure);</span>
<a href="#l109.56"></a><span id="l109.56" class="difflineminus">-MimeDecoderData *MimeYDecoderInit (MimeConverterOutputCallback output_fn,</span>
<a href="#l109.57"></a><span id="l109.57" class="difflineminus">-                  void *closure);</span>
<a href="#l109.58"></a><span id="l109.58" class="difflineplus">+MimeDecoderData *MimeUUDecoderInit(MimeConverterOutputCallback output_fn,</span>
<a href="#l109.59"></a><span id="l109.59" class="difflineplus">+                                   void *closure);</span>
<a href="#l109.60"></a><span id="l109.60" class="difflineplus">+MimeDecoderData *MimeYDecoderInit(MimeConverterOutputCallback output_fn,</span>
<a href="#l109.61"></a><span id="l109.61" class="difflineplus">+                                  void *closure);</span>
<a href="#l109.62"></a><span id="l109.62"> </span>
<a href="#l109.63"></a><span id="l109.63"> /* Push data through the encoder/decoder, causing the above-provided write_fn</span>
<a href="#l109.64"></a><span id="l109.64">    to be called with encoded/decoded data. */</span>
<a href="#l109.65"></a><span id="l109.65" class="difflineminus">-int MimeDecoderWrite (MimeDecoderData *data, const char *buffer, int32_t size,</span>
<a href="#l109.66"></a><span id="l109.66" class="difflineminus">-                  int32_t *outSize);</span>
<a href="#l109.67"></a><span id="l109.67" class="difflineplus">+int MimeDecoderWrite(MimeDecoderData *data, const char *buffer, int32_t size,</span>
<a href="#l109.68"></a><span id="l109.68" class="difflineplus">+                     int32_t *outSize);</span>
<a href="#l109.69"></a><span id="l109.69"> </span>
<a href="#l109.70"></a><span id="l109.70"> /* When you're done encoding/decoding, call this to free the data.  If</span>
<a href="#l109.71"></a><span id="l109.71">    abort_p is false, then calling this may cause the write_fn to be called</span>
<a href="#l109.72"></a><span id="l109.72">    one last time (as the last buffered data is flushed out.)</span>
<a href="#l109.73"></a><span id="l109.73">  */</span>
<a href="#l109.74"></a><span id="l109.74"> int MimeDecoderDestroy(MimeDecoderData *data, bool abort_p);</span>
<a href="#l109.75"></a><span id="l109.75"> </span>
<a href="#l109.76"></a><span id="l109.76"> #endif /* _MODMIMEE_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l110.1"></a><span id="l110.1" class="difflineminus">--- a/mailnews/mime/src/nsCMS.cpp</span>
<a href="#l110.2"></a><span id="l110.2" class="difflineplus">+++ b/mailnews/mime/src/nsCMS.cpp</span>
<a href="#l110.3"></a><span id="l110.3" class="difflineat">@@ -30,210 +30,189 @@</span>
<a href="#l110.4"></a><span id="l110.4"> using namespace mozilla;</span>
<a href="#l110.5"></a><span id="l110.5"> using namespace mozilla::psm;</span>
<a href="#l110.6"></a><span id="l110.6"> using namespace mozilla::pkix;</span>
<a href="#l110.7"></a><span id="l110.7"> </span>
<a href="#l110.8"></a><span id="l110.8"> extern mozilla::LazyLogModule gPIPNSSLog;</span>
<a href="#l110.9"></a><span id="l110.9"> </span>
<a href="#l110.10"></a><span id="l110.10"> NS_IMPL_ISUPPORTS(nsCMSMessage, nsICMSMessage)</span>
<a href="#l110.11"></a><span id="l110.11"> </span>
<a href="#l110.12"></a><span id="l110.12" class="difflineminus">-nsCMSMessage::nsCMSMessage()</span>
<a href="#l110.13"></a><span id="l110.13" class="difflineminus">-{</span>
<a href="#l110.14"></a><span id="l110.14" class="difflineminus">-  m_cmsMsg = nullptr;</span>
<a href="#l110.15"></a><span id="l110.15" class="difflineminus">-}</span>
<a href="#l110.16"></a><span id="l110.16" class="difflineminus">-nsCMSMessage::nsCMSMessage(NSSCMSMessage *aCMSMsg)</span>
<a href="#l110.17"></a><span id="l110.17" class="difflineminus">-{</span>
<a href="#l110.18"></a><span id="l110.18" class="difflineminus">-  m_cmsMsg = aCMSMsg;</span>
<a href="#l110.19"></a><span id="l110.19" class="difflineminus">-}</span>
<a href="#l110.20"></a><span id="l110.20" class="difflineplus">+nsCMSMessage::nsCMSMessage() { m_cmsMsg = nullptr; }</span>
<a href="#l110.21"></a><span id="l110.21" class="difflineplus">+nsCMSMessage::nsCMSMessage(NSSCMSMessage *aCMSMsg) { m_cmsMsg = aCMSMsg; }</span>
<a href="#l110.22"></a><span id="l110.22" class="difflineplus">+</span>
<a href="#l110.23"></a><span id="l110.23" class="difflineplus">+nsCMSMessage::~nsCMSMessage() { destructorSafeDestroyNSSReference(); }</span>
<a href="#l110.24"></a><span id="l110.24"> </span>
<a href="#l110.25"></a><span id="l110.25" class="difflineminus">-nsCMSMessage::~nsCMSMessage()</span>
<a href="#l110.26"></a><span id="l110.26" class="difflineminus">-{</span>
<a href="#l110.27"></a><span id="l110.27" class="difflineminus">-  destructorSafeDestroyNSSReference();</span>
<a href="#l110.28"></a><span id="l110.28" class="difflineminus">-}</span>
<a href="#l110.29"></a><span id="l110.29" class="difflineminus">-</span>
<a href="#l110.30"></a><span id="l110.30" class="difflineminus">-nsresult nsCMSMessage::Init()</span>
<a href="#l110.31"></a><span id="l110.31" class="difflineminus">-{</span>
<a href="#l110.32"></a><span id="l110.32" class="difflineplus">+nsresult nsCMSMessage::Init() {</span>
<a href="#l110.33"></a><span id="l110.33">   nsresult rv;</span>
<a href="#l110.34"></a><span id="l110.34" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; nssInitialized = do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l110.35"></a><span id="l110.35" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; nssInitialized =</span>
<a href="#l110.36"></a><span id="l110.36" class="difflineplus">+      do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l110.37"></a><span id="l110.37">   return rv;</span>
<a href="#l110.38"></a><span id="l110.38"> }</span>
<a href="#l110.39"></a><span id="l110.39"> </span>
<a href="#l110.40"></a><span id="l110.40" class="difflineminus">-void nsCMSMessage::destructorSafeDestroyNSSReference()</span>
<a href="#l110.41"></a><span id="l110.41" class="difflineminus">-{</span>
<a href="#l110.42"></a><span id="l110.42" class="difflineplus">+void nsCMSMessage::destructorSafeDestroyNSSReference() {</span>
<a href="#l110.43"></a><span id="l110.43">   if (m_cmsMsg) {</span>
<a href="#l110.44"></a><span id="l110.44">     NSS_CMSMessage_Destroy(m_cmsMsg);</span>
<a href="#l110.45"></a><span id="l110.45">   }</span>
<a href="#l110.46"></a><span id="l110.46"> }</span>
<a href="#l110.47"></a><span id="l110.47"> </span>
<a href="#l110.48"></a><span id="l110.48" class="difflineminus">-NS_IMETHODIMP nsCMSMessage::VerifySignature()</span>
<a href="#l110.49"></a><span id="l110.49" class="difflineminus">-{</span>
<a href="#l110.50"></a><span id="l110.50" class="difflineplus">+NS_IMETHODIMP nsCMSMessage::VerifySignature() {</span>
<a href="#l110.51"></a><span id="l110.51">   return CommonVerifySignature(nullptr, 0, 0);</span>
<a href="#l110.52"></a><span id="l110.52"> }</span>
<a href="#l110.53"></a><span id="l110.53"> </span>
<a href="#l110.54"></a><span id="l110.54" class="difflineminus">-NSSCMSSignerInfo* nsCMSMessage::GetTopLevelSignerInfo()</span>
<a href="#l110.55"></a><span id="l110.55" class="difflineminus">-{</span>
<a href="#l110.56"></a><span id="l110.56" class="difflineminus">-  if (!m_cmsMsg)</span>
<a href="#l110.57"></a><span id="l110.57" class="difflineminus">-    return nullptr;</span>
<a href="#l110.58"></a><span id="l110.58" class="difflineplus">+NSSCMSSignerInfo *nsCMSMessage::GetTopLevelSignerInfo() {</span>
<a href="#l110.59"></a><span id="l110.59" class="difflineplus">+  if (!m_cmsMsg) return nullptr;</span>
<a href="#l110.60"></a><span id="l110.60"> </span>
<a href="#l110.61"></a><span id="l110.61" class="difflineminus">-  if (!NSS_CMSMessage_IsSigned(m_cmsMsg))</span>
<a href="#l110.62"></a><span id="l110.62" class="difflineminus">-    return nullptr;</span>
<a href="#l110.63"></a><span id="l110.63" class="difflineplus">+  if (!NSS_CMSMessage_IsSigned(m_cmsMsg)) return nullptr;</span>
<a href="#l110.64"></a><span id="l110.64"> </span>
<a href="#l110.65"></a><span id="l110.65">   NSSCMSContentInfo *cinfo = NSS_CMSMessage_ContentLevel(m_cmsMsg, 0);</span>
<a href="#l110.66"></a><span id="l110.66" class="difflineminus">-  if (!cinfo)</span>
<a href="#l110.67"></a><span id="l110.67" class="difflineminus">-    return nullptr;</span>
<a href="#l110.68"></a><span id="l110.68" class="difflineplus">+  if (!cinfo) return nullptr;</span>
<a href="#l110.69"></a><span id="l110.69"> </span>
<a href="#l110.70"></a><span id="l110.70" class="difflineminus">-  NSSCMSSignedData *sigd = (NSSCMSSignedData*)NSS_CMSContentInfo_GetContent(cinfo);</span>
<a href="#l110.71"></a><span id="l110.71" class="difflineminus">-  if (!sigd)</span>
<a href="#l110.72"></a><span id="l110.72" class="difflineminus">-    return nullptr;</span>
<a href="#l110.73"></a><span id="l110.73" class="difflineplus">+  NSSCMSSignedData *sigd =</span>
<a href="#l110.74"></a><span id="l110.74" class="difflineplus">+      (NSSCMSSignedData *)NSS_CMSContentInfo_GetContent(cinfo);</span>
<a href="#l110.75"></a><span id="l110.75" class="difflineplus">+  if (!sigd) return nullptr;</span>
<a href="#l110.76"></a><span id="l110.76"> </span>
<a href="#l110.77"></a><span id="l110.77">   PR_ASSERT(NSS_CMSSignedData_SignerInfoCount(sigd) &gt; 0);</span>
<a href="#l110.78"></a><span id="l110.78">   return NSS_CMSSignedData_GetSignerInfo(sigd, 0);</span>
<a href="#l110.79"></a><span id="l110.79"> }</span>
<a href="#l110.80"></a><span id="l110.80"> </span>
<a href="#l110.81"></a><span id="l110.81" class="difflineminus">-NS_IMETHODIMP nsCMSMessage::GetSignerEmailAddress(char * * aEmail)</span>
<a href="#l110.82"></a><span id="l110.82" class="difflineminus">-{</span>
<a href="#l110.83"></a><span id="l110.83" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerEmailAddress\n&quot;));</span>
<a href="#l110.84"></a><span id="l110.84" class="difflineplus">+NS_IMETHODIMP nsCMSMessage::GetSignerEmailAddress(char **aEmail) {</span>
<a href="#l110.85"></a><span id="l110.85" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.86"></a><span id="l110.86" class="difflineplus">+          (&quot;nsCMSMessage::GetSignerEmailAddress\n&quot;));</span>
<a href="#l110.87"></a><span id="l110.87">   NS_ENSURE_ARG(aEmail);</span>
<a href="#l110.88"></a><span id="l110.88"> </span>
<a href="#l110.89"></a><span id="l110.89">   NSSCMSSignerInfo *si = GetTopLevelSignerInfo();</span>
<a href="#l110.90"></a><span id="l110.90" class="difflineminus">-  if (!si)</span>
<a href="#l110.91"></a><span id="l110.91" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l110.92"></a><span id="l110.92" class="difflineplus">+  if (!si) return NS_ERROR_FAILURE;</span>
<a href="#l110.93"></a><span id="l110.93"> </span>
<a href="#l110.94"></a><span id="l110.94">   *aEmail = NSS_CMSSignerInfo_GetSignerEmailAddress(si);</span>
<a href="#l110.95"></a><span id="l110.95">   return NS_OK;</span>
<a href="#l110.96"></a><span id="l110.96"> }</span>
<a href="#l110.97"></a><span id="l110.97"> </span>
<a href="#l110.98"></a><span id="l110.98" class="difflineminus">-NS_IMETHODIMP nsCMSMessage::GetSignerCommonName(char ** aName)</span>
<a href="#l110.99"></a><span id="l110.99" class="difflineminus">-{</span>
<a href="#l110.100"></a><span id="l110.100" class="difflineplus">+NS_IMETHODIMP nsCMSMessage::GetSignerCommonName(char **aName) {</span>
<a href="#l110.101"></a><span id="l110.101">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerCommonName\n&quot;));</span>
<a href="#l110.102"></a><span id="l110.102">   NS_ENSURE_ARG(aName);</span>
<a href="#l110.103"></a><span id="l110.103"> </span>
<a href="#l110.104"></a><span id="l110.104">   NSSCMSSignerInfo *si = GetTopLevelSignerInfo();</span>
<a href="#l110.105"></a><span id="l110.105" class="difflineminus">-  if (!si)</span>
<a href="#l110.106"></a><span id="l110.106" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l110.107"></a><span id="l110.107" class="difflineplus">+  if (!si) return NS_ERROR_FAILURE;</span>
<a href="#l110.108"></a><span id="l110.108"> </span>
<a href="#l110.109"></a><span id="l110.109">   *aName = NSS_CMSSignerInfo_GetSignerCommonName(si);</span>
<a href="#l110.110"></a><span id="l110.110">   return NS_OK;</span>
<a href="#l110.111"></a><span id="l110.111"> }</span>
<a href="#l110.112"></a><span id="l110.112"> </span>
<a href="#l110.113"></a><span id="l110.113" class="difflineminus">-NS_IMETHODIMP nsCMSMessage::ContentIsEncrypted(bool *isEncrypted)</span>
<a href="#l110.114"></a><span id="l110.114" class="difflineminus">-{</span>
<a href="#l110.115"></a><span id="l110.115" class="difflineplus">+NS_IMETHODIMP nsCMSMessage::ContentIsEncrypted(bool *isEncrypted) {</span>
<a href="#l110.116"></a><span id="l110.116">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::ContentIsEncrypted\n&quot;));</span>
<a href="#l110.117"></a><span id="l110.117">   NS_ENSURE_ARG(isEncrypted);</span>
<a href="#l110.118"></a><span id="l110.118"> </span>
<a href="#l110.119"></a><span id="l110.119" class="difflineminus">-  if (!m_cmsMsg)</span>
<a href="#l110.120"></a><span id="l110.120" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l110.121"></a><span id="l110.121" class="difflineplus">+  if (!m_cmsMsg) return NS_ERROR_FAILURE;</span>
<a href="#l110.122"></a><span id="l110.122"> </span>
<a href="#l110.123"></a><span id="l110.123">   *isEncrypted = NSS_CMSMessage_IsEncrypted(m_cmsMsg);</span>
<a href="#l110.124"></a><span id="l110.124"> </span>
<a href="#l110.125"></a><span id="l110.125">   return NS_OK;</span>
<a href="#l110.126"></a><span id="l110.126"> }</span>
<a href="#l110.127"></a><span id="l110.127"> </span>
<a href="#l110.128"></a><span id="l110.128" class="difflineminus">-NS_IMETHODIMP nsCMSMessage::ContentIsSigned(bool *isSigned)</span>
<a href="#l110.129"></a><span id="l110.129" class="difflineminus">-{</span>
<a href="#l110.130"></a><span id="l110.130" class="difflineplus">+NS_IMETHODIMP nsCMSMessage::ContentIsSigned(bool *isSigned) {</span>
<a href="#l110.131"></a><span id="l110.131">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::ContentIsSigned\n&quot;));</span>
<a href="#l110.132"></a><span id="l110.132">   NS_ENSURE_ARG(isSigned);</span>
<a href="#l110.133"></a><span id="l110.133"> </span>
<a href="#l110.134"></a><span id="l110.134" class="difflineminus">-  if (!m_cmsMsg)</span>
<a href="#l110.135"></a><span id="l110.135" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l110.136"></a><span id="l110.136" class="difflineplus">+  if (!m_cmsMsg) return NS_ERROR_FAILURE;</span>
<a href="#l110.137"></a><span id="l110.137"> </span>
<a href="#l110.138"></a><span id="l110.138">   *isSigned = NSS_CMSMessage_IsSigned(m_cmsMsg);</span>
<a href="#l110.139"></a><span id="l110.139"> </span>
<a href="#l110.140"></a><span id="l110.140">   return NS_OK;</span>
<a href="#l110.141"></a><span id="l110.141"> }</span>
<a href="#l110.142"></a><span id="l110.142"> </span>
<a href="#l110.143"></a><span id="l110.143" class="difflineminus">-NS_IMETHODIMP nsCMSMessage::GetSignerCert(nsIX509Cert **scert)</span>
<a href="#l110.144"></a><span id="l110.144" class="difflineminus">-{</span>
<a href="#l110.145"></a><span id="l110.145" class="difflineplus">+NS_IMETHODIMP nsCMSMessage::GetSignerCert(nsIX509Cert **scert) {</span>
<a href="#l110.146"></a><span id="l110.146">   NSSCMSSignerInfo *si = GetTopLevelSignerInfo();</span>
<a href="#l110.147"></a><span id="l110.147" class="difflineminus">-  if (!si)</span>
<a href="#l110.148"></a><span id="l110.148" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l110.149"></a><span id="l110.149" class="difflineplus">+  if (!si) return NS_ERROR_FAILURE;</span>
<a href="#l110.150"></a><span id="l110.150"> </span>
<a href="#l110.151"></a><span id="l110.151">   nsCOMPtr&lt;nsIX509Cert&gt; cert;</span>
<a href="#l110.152"></a><span id="l110.152">   if (si-&gt;cert) {</span>
<a href="#l110.153"></a><span id="l110.153" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerCert got signer cert\n&quot;));</span>
<a href="#l110.154"></a><span id="l110.154" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.155"></a><span id="l110.155" class="difflineplus">+            (&quot;nsCMSMessage::GetSignerCert got signer cert\n&quot;));</span>
<a href="#l110.156"></a><span id="l110.156"> </span>
<a href="#l110.157"></a><span id="l110.157">     nsCOMPtr&lt;nsIX509CertDB&gt; certdb = do_GetService(NS_X509CERTDB_CONTRACTID);</span>
<a href="#l110.158"></a><span id="l110.158">     nsDependentCSubstring certDER(</span>
<a href="#l110.159"></a><span id="l110.159" class="difflineminus">-      reinterpret_cast&lt;char*&gt;(si-&gt;cert-&gt;derCert.data),</span>
<a href="#l110.160"></a><span id="l110.160" class="difflineminus">-      si-&gt;cert-&gt;derCert.len);</span>
<a href="#l110.161"></a><span id="l110.161" class="difflineplus">+        reinterpret_cast&lt;char *&gt;(si-&gt;cert-&gt;derCert.data),</span>
<a href="#l110.162"></a><span id="l110.162" class="difflineplus">+        si-&gt;cert-&gt;derCert.len);</span>
<a href="#l110.163"></a><span id="l110.163">     nsresult rv = certdb-&gt;ConstructX509(certDER, getter_AddRefs(cert));</span>
<a href="#l110.164"></a><span id="l110.164">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l110.165"></a><span id="l110.165" class="difflineminus">-  }</span>
<a href="#l110.166"></a><span id="l110.166" class="difflineminus">-  else {</span>
<a href="#l110.167"></a><span id="l110.167" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerCert no signer cert, do we have a cert list? %s\n&quot;,</span>
<a href="#l110.168"></a><span id="l110.168" class="difflineminus">-      (si-&gt;certList ? &quot;yes&quot; : &quot;no&quot;) ));</span>
<a href="#l110.169"></a><span id="l110.169" class="difflineplus">+  } else {</span>
<a href="#l110.170"></a><span id="l110.170" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.171"></a><span id="l110.171" class="difflineplus">+            (&quot;nsCMSMessage::GetSignerCert no signer cert, do we have a cert &quot;</span>
<a href="#l110.172"></a><span id="l110.172" class="difflineplus">+             &quot;list? %s\n&quot;,</span>
<a href="#l110.173"></a><span id="l110.173" class="difflineplus">+             (si-&gt;certList ? &quot;yes&quot; : &quot;no&quot;)));</span>
<a href="#l110.174"></a><span id="l110.174"> </span>
<a href="#l110.175"></a><span id="l110.175">     *scert = nullptr;</span>
<a href="#l110.176"></a><span id="l110.176">   }</span>
<a href="#l110.177"></a><span id="l110.177"> </span>
<a href="#l110.178"></a><span id="l110.178">   cert.forget(scert);</span>
<a href="#l110.179"></a><span id="l110.179"> </span>
<a href="#l110.180"></a><span id="l110.180">   return NS_OK;</span>
<a href="#l110.181"></a><span id="l110.181"> }</span>
<a href="#l110.182"></a><span id="l110.182"> </span>
<a href="#l110.183"></a><span id="l110.183" class="difflineminus">-NS_IMETHODIMP nsCMSMessage::GetEncryptionCert(nsIX509Cert**)</span>
<a href="#l110.184"></a><span id="l110.184" class="difflineminus">-{</span>
<a href="#l110.185"></a><span id="l110.185" class="difflineplus">+NS_IMETHODIMP nsCMSMessage::GetEncryptionCert(nsIX509Cert **) {</span>
<a href="#l110.186"></a><span id="l110.186">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l110.187"></a><span id="l110.187"> }</span>
<a href="#l110.188"></a><span id="l110.188"> </span>
<a href="#l110.189"></a><span id="l110.189"> NS_IMETHODIMP</span>
<a href="#l110.190"></a><span id="l110.190" class="difflineminus">-nsCMSMessage::VerifyDetachedSignature(unsigned char* aDigestData,</span>
<a href="#l110.191"></a><span id="l110.191" class="difflineplus">+nsCMSMessage::VerifyDetachedSignature(unsigned char *aDigestData,</span>
<a href="#l110.192"></a><span id="l110.192">                                       uint32_t aDigestDataLen,</span>
<a href="#l110.193"></a><span id="l110.193" class="difflineminus">-                                      int16_t aDigestType)</span>
<a href="#l110.194"></a><span id="l110.194" class="difflineminus">-{</span>
<a href="#l110.195"></a><span id="l110.195" class="difflineminus">-  if (!aDigestData || !aDigestDataLen)</span>
<a href="#l110.196"></a><span id="l110.196" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l110.197"></a><span id="l110.197" class="difflineplus">+                                      int16_t aDigestType) {</span>
<a href="#l110.198"></a><span id="l110.198" class="difflineplus">+  if (!aDigestData || !aDigestDataLen) return NS_ERROR_FAILURE;</span>
<a href="#l110.199"></a><span id="l110.199"> </span>
<a href="#l110.200"></a><span id="l110.200">   return CommonVerifySignature(aDigestData, aDigestDataLen, aDigestType);</span>
<a href="#l110.201"></a><span id="l110.201"> }</span>
<a href="#l110.202"></a><span id="l110.202"> </span>
<a href="#l110.203"></a><span id="l110.203" class="difflineminus">-nsresult</span>
<a href="#l110.204"></a><span id="l110.204" class="difflineminus">-nsCMSMessage::CommonVerifySignature(unsigned char* aDigestData,</span>
<a href="#l110.205"></a><span id="l110.205" class="difflineminus">-                                    uint32_t aDigestDataLen,</span>
<a href="#l110.206"></a><span id="l110.206" class="difflineminus">-                                    int16_t aDigestType)</span>
<a href="#l110.207"></a><span id="l110.207" class="difflineminus">-{</span>
<a href="#l110.208"></a><span id="l110.208" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature, content level count %d\n&quot;, NSS_CMSMessage_ContentLevelCount(m_cmsMsg)));</span>
<a href="#l110.209"></a><span id="l110.209" class="difflineplus">+nsresult nsCMSMessage::CommonVerifySignature(unsigned char *aDigestData,</span>
<a href="#l110.210"></a><span id="l110.210" class="difflineplus">+                                             uint32_t aDigestDataLen,</span>
<a href="#l110.211"></a><span id="l110.211" class="difflineplus">+                                             int16_t aDigestType) {</span>
<a href="#l110.212"></a><span id="l110.212" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.213"></a><span id="l110.213" class="difflineplus">+          (&quot;nsCMSMessage::CommonVerifySignature, content level count %d\n&quot;,</span>
<a href="#l110.214"></a><span id="l110.214" class="difflineplus">+           NSS_CMSMessage_ContentLevelCount(m_cmsMsg)));</span>
<a href="#l110.215"></a><span id="l110.215">   NSSCMSContentInfo *cinfo = nullptr;</span>
<a href="#l110.216"></a><span id="l110.216">   NSSCMSSignedData *sigd = nullptr;</span>
<a href="#l110.217"></a><span id="l110.217">   NSSCMSSignerInfo *si;</span>
<a href="#l110.218"></a><span id="l110.218">   int32_t nsigners;</span>
<a href="#l110.219"></a><span id="l110.219">   RefPtr&lt;SharedCertVerifier&gt; certVerifier;</span>
<a href="#l110.220"></a><span id="l110.220">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l110.221"></a><span id="l110.221"> </span>
<a href="#l110.222"></a><span id="l110.222">   if (!NSS_CMSMessage_IsSigned(m_cmsMsg)) {</span>
<a href="#l110.223"></a><span id="l110.223" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - not signed\n&quot;));</span>
<a href="#l110.224"></a><span id="l110.224" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.225"></a><span id="l110.225" class="difflineplus">+            (&quot;nsCMSMessage::CommonVerifySignature - not signed\n&quot;));</span>
<a href="#l110.226"></a><span id="l110.226">     return NS_ERROR_CMS_VERIFY_NOT_SIGNED;</span>
<a href="#l110.227"></a><span id="l110.227">   }</span>
<a href="#l110.228"></a><span id="l110.228"> </span>
<a href="#l110.229"></a><span id="l110.229">   cinfo = NSS_CMSMessage_ContentLevel(m_cmsMsg, 0);</span>
<a href="#l110.230"></a><span id="l110.230">   if (cinfo) {</span>
<a href="#l110.231"></a><span id="l110.231">     switch (NSS_CMSContentInfo_GetContentTypeTag(cinfo)) {</span>
<a href="#l110.232"></a><span id="l110.232">       case SEC_OID_PKCS7_SIGNED_DATA:</span>
<a href="#l110.233"></a><span id="l110.233" class="difflineminus">-        sigd = reinterpret_cast&lt;NSSCMSSignedData*&gt;(NSS_CMSContentInfo_GetContent(cinfo));</span>
<a href="#l110.234"></a><span id="l110.234" class="difflineplus">+        sigd = reinterpret_cast&lt;NSSCMSSignedData *&gt;(</span>
<a href="#l110.235"></a><span id="l110.235" class="difflineplus">+            NSS_CMSContentInfo_GetContent(cinfo));</span>
<a href="#l110.236"></a><span id="l110.236">         break;</span>
<a href="#l110.237"></a><span id="l110.237"> </span>
<a href="#l110.238"></a><span id="l110.238">       case SEC_OID_PKCS7_ENVELOPED_DATA:</span>
<a href="#l110.239"></a><span id="l110.239">       case SEC_OID_PKCS7_ENCRYPTED_DATA:</span>
<a href="#l110.240"></a><span id="l110.240">       case SEC_OID_PKCS7_DIGESTED_DATA:</span>
<a href="#l110.241"></a><span id="l110.241">       default: {</span>
<a href="#l110.242"></a><span id="l110.242" class="difflineminus">-        MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - unexpected ContentTypeTag\n&quot;));</span>
<a href="#l110.243"></a><span id="l110.243" class="difflineplus">+        MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.244"></a><span id="l110.244" class="difflineplus">+                (&quot;nsCMSMessage::CommonVerifySignature - unexpected &quot;</span>
<a href="#l110.245"></a><span id="l110.245" class="difflineplus">+                 &quot;ContentTypeTag\n&quot;));</span>
<a href="#l110.246"></a><span id="l110.246">         rv = NS_ERROR_CMS_VERIFY_NO_CONTENT_INFO;</span>
<a href="#l110.247"></a><span id="l110.247">         goto loser;</span>
<a href="#l110.248"></a><span id="l110.248">       }</span>
<a href="#l110.249"></a><span id="l110.249">     }</span>
<a href="#l110.250"></a><span id="l110.250">   }</span>
<a href="#l110.251"></a><span id="l110.251"> </span>
<a href="#l110.252"></a><span id="l110.252">   if (!sigd) {</span>
<a href="#l110.253"></a><span id="l110.253" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - no content info\n&quot;));</span>
<a href="#l110.254"></a><span id="l110.254" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.255"></a><span id="l110.255" class="difflineplus">+            (&quot;nsCMSMessage::CommonVerifySignature - no content info\n&quot;));</span>
<a href="#l110.256"></a><span id="l110.256">     rv = NS_ERROR_CMS_VERIFY_NO_CONTENT_INFO;</span>
<a href="#l110.257"></a><span id="l110.257">     goto loser;</span>
<a href="#l110.258"></a><span id="l110.258">   }</span>
<a href="#l110.259"></a><span id="l110.259"> </span>
<a href="#l110.260"></a><span id="l110.260" class="difflineminus">-  if (aDigestData &amp;&amp; aDigestDataLen)</span>
<a href="#l110.261"></a><span id="l110.261" class="difflineminus">-  {</span>
<a href="#l110.262"></a><span id="l110.262" class="difflineplus">+  if (aDigestData &amp;&amp; aDigestDataLen) {</span>
<a href="#l110.263"></a><span id="l110.263">     SECOidTag oidTag;</span>
<a href="#l110.264"></a><span id="l110.264">     SECItem digest;</span>
<a href="#l110.265"></a><span id="l110.265">     digest.data = aDigestData;</span>
<a href="#l110.266"></a><span id="l110.266">     digest.len = aDigestDataLen;</span>
<a href="#l110.267"></a><span id="l110.267"> </span>
<a href="#l110.268"></a><span id="l110.268">     if (NSS_CMSSignedData_HasDigests(sigd)) {</span>
<a href="#l110.269"></a><span id="l110.269">       SECAlgorithmID **existingAlgs = NSS_CMSSignedData_GetDigestAlgs(sigd);</span>
<a href="#l110.270"></a><span id="l110.270">       if (existingAlgs) {</span>
<a href="#l110.271"></a><span id="l110.271" class="difflineat">@@ -241,288 +220,269 @@ nsCMSMessage::CommonVerifySignature(unsi</span>
<a href="#l110.272"></a><span id="l110.272">           SECAlgorithmID *alg = *existingAlgs;</span>
<a href="#l110.273"></a><span id="l110.273">           SECOidTag algOIDTag = SECOID_FindOIDTag(&amp;alg-&gt;algorithm);</span>
<a href="#l110.274"></a><span id="l110.274">           NSS_CMSSignedData_SetDigestValue(sigd, algOIDTag, NULL);</span>
<a href="#l110.275"></a><span id="l110.275">           ++existingAlgs;</span>
<a href="#l110.276"></a><span id="l110.276">         }</span>
<a href="#l110.277"></a><span id="l110.277">       }</span>
<a href="#l110.278"></a><span id="l110.278">     }</span>
<a href="#l110.279"></a><span id="l110.279"> </span>
<a href="#l110.280"></a><span id="l110.280" class="difflineminus">-    oidTag = HASH_GetHashOidTagByHashType(static_cast&lt;HASH_HashType&gt;(aDigestType));</span>
<a href="#l110.281"></a><span id="l110.281" class="difflineplus">+    oidTag =</span>
<a href="#l110.282"></a><span id="l110.282" class="difflineplus">+        HASH_GetHashOidTagByHashType(static_cast&lt;HASH_HashType&gt;(aDigestType));</span>
<a href="#l110.283"></a><span id="l110.283">     if (oidTag == SEC_OID_UNKNOWN) {</span>
<a href="#l110.284"></a><span id="l110.284">       rv = NS_ERROR_CMS_VERIFY_BAD_DIGEST;</span>
<a href="#l110.285"></a><span id="l110.285">       goto loser;</span>
<a href="#l110.286"></a><span id="l110.286">     }</span>
<a href="#l110.287"></a><span id="l110.287"> </span>
<a href="#l110.288"></a><span id="l110.288">     if (NSS_CMSSignedData_SetDigestValue(sigd, oidTag, &amp;digest)) {</span>
<a href="#l110.289"></a><span id="l110.289" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - bad digest\n&quot;));</span>
<a href="#l110.290"></a><span id="l110.290" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.291"></a><span id="l110.291" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - bad digest\n&quot;));</span>
<a href="#l110.292"></a><span id="l110.292">       rv = NS_ERROR_CMS_VERIFY_BAD_DIGEST;</span>
<a href="#l110.293"></a><span id="l110.293">       goto loser;</span>
<a href="#l110.294"></a><span id="l110.294">     }</span>
<a href="#l110.295"></a><span id="l110.295">   }</span>
<a href="#l110.296"></a><span id="l110.296"> </span>
<a href="#l110.297"></a><span id="l110.297" class="difflineminus">-  // Import certs. Note that import failure is not a signature verification failure. //</span>
<a href="#l110.298"></a><span id="l110.298" class="difflineminus">-  if (NSS_CMSSignedData_ImportCerts(sigd, CERT_GetDefaultCertDB(), certUsageEmailRecipient, true) != SECSuccess) {</span>
<a href="#l110.299"></a><span id="l110.299" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - can not import certs\n&quot;));</span>
<a href="#l110.300"></a><span id="l110.300" class="difflineplus">+  // Import certs. Note that import failure is not a signature verification</span>
<a href="#l110.301"></a><span id="l110.301" class="difflineplus">+  // failure. //</span>
<a href="#l110.302"></a><span id="l110.302" class="difflineplus">+  if (NSS_CMSSignedData_ImportCerts(sigd, CERT_GetDefaultCertDB(),</span>
<a href="#l110.303"></a><span id="l110.303" class="difflineplus">+                                    certUsageEmailRecipient,</span>
<a href="#l110.304"></a><span id="l110.304" class="difflineplus">+                                    true) != SECSuccess) {</span>
<a href="#l110.305"></a><span id="l110.305" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.306"></a><span id="l110.306" class="difflineplus">+            (&quot;nsCMSMessage::CommonVerifySignature - can not import certs\n&quot;));</span>
<a href="#l110.307"></a><span id="l110.307">   }</span>
<a href="#l110.308"></a><span id="l110.308"> </span>
<a href="#l110.309"></a><span id="l110.309">   nsigners = NSS_CMSSignedData_SignerInfoCount(sigd);</span>
<a href="#l110.310"></a><span id="l110.310">   PR_ASSERT(nsigners &gt; 0);</span>
<a href="#l110.311"></a><span id="l110.311">   NS_ENSURE_TRUE(nsigners &gt; 0, NS_ERROR_UNEXPECTED);</span>
<a href="#l110.312"></a><span id="l110.312">   si = NSS_CMSSignedData_GetSignerInfo(sigd, 0);</span>
<a href="#l110.313"></a><span id="l110.313"> </span>
<a href="#l110.314"></a><span id="l110.314">   // See bug 324474. We want to make sure the signing cert is</span>
<a href="#l110.315"></a><span id="l110.315">   // still valid at the current time.</span>
<a href="#l110.316"></a><span id="l110.316"> </span>
<a href="#l110.317"></a><span id="l110.317">   certVerifier = GetDefaultCertVerifier();</span>
<a href="#l110.318"></a><span id="l110.318">   NS_ENSURE_TRUE(certVerifier, NS_ERROR_UNEXPECTED);</span>
<a href="#l110.319"></a><span id="l110.319"> </span>
<a href="#l110.320"></a><span id="l110.320">   {</span>
<a href="#l110.321"></a><span id="l110.321">     UniqueCERTCertList builtChain;</span>
<a href="#l110.322"></a><span id="l110.322" class="difflineminus">-    mozilla::pkix::Result result =</span>
<a href="#l110.323"></a><span id="l110.323" class="difflineminus">-      certVerifier-&gt;VerifyCert(si-&gt;cert,</span>
<a href="#l110.324"></a><span id="l110.324" class="difflineminus">-                               certificateUsageEmailSigner,</span>
<a href="#l110.325"></a><span id="l110.325" class="difflineminus">-                               Now(),</span>
<a href="#l110.326"></a><span id="l110.326" class="difflineminus">-                               nullptr /*XXX pinarg*/,</span>
<a href="#l110.327"></a><span id="l110.327" class="difflineminus">-                               nullptr /*hostname*/,</span>
<a href="#l110.328"></a><span id="l110.328" class="difflineminus">-                               builtChain,</span>
<a href="#l110.329"></a><span id="l110.329" class="difflineminus">-                               // Only local checks can run on the main thread.</span>
<a href="#l110.330"></a><span id="l110.330" class="difflineminus">-                               CertVerifier::FLAG_LOCAL_ONLY);</span>
<a href="#l110.331"></a><span id="l110.331" class="difflineplus">+    mozilla::pkix::Result result = certVerifier-&gt;VerifyCert(</span>
<a href="#l110.332"></a><span id="l110.332" class="difflineplus">+        si-&gt;cert, certificateUsageEmailSigner, Now(), nullptr /*XXX pinarg*/,</span>
<a href="#l110.333"></a><span id="l110.333" class="difflineplus">+        nullptr /*hostname*/, builtChain,</span>
<a href="#l110.334"></a><span id="l110.334" class="difflineplus">+        // Only local checks can run on the main thread.</span>
<a href="#l110.335"></a><span id="l110.335" class="difflineplus">+        CertVerifier::FLAG_LOCAL_ONLY);</span>
<a href="#l110.336"></a><span id="l110.336">     if (result != mozilla::pkix::Success) {</span>
<a href="#l110.337"></a><span id="l110.337">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.338"></a><span id="l110.338" class="difflineminus">-             (&quot;nsCMSMessage::CommonVerifySignature - signing cert not trusted now\n&quot;));</span>
<a href="#l110.339"></a><span id="l110.339" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - signing cert not trusted &quot;</span>
<a href="#l110.340"></a><span id="l110.340" class="difflineplus">+               &quot;now\n&quot;));</span>
<a href="#l110.341"></a><span id="l110.341">       rv = NS_ERROR_CMS_VERIFY_UNTRUSTED;</span>
<a href="#l110.342"></a><span id="l110.342">       goto loser;</span>
<a href="#l110.343"></a><span id="l110.343">     }</span>
<a href="#l110.344"></a><span id="l110.344">   }</span>
<a href="#l110.345"></a><span id="l110.345"> </span>
<a href="#l110.346"></a><span id="l110.346">   // We verify the first signer info,  only //</span>
<a href="#l110.347"></a><span id="l110.347">   // XXX: NSS_CMSSignedData_VerifySignerInfo calls CERT_VerifyCert, which</span>
<a href="#l110.348"></a><span id="l110.348">   // requires NSS's certificate verification configuration to be done in</span>
<a href="#l110.349"></a><span id="l110.349">   // order to work well (e.g. honoring OCSP preferences and proxy settings</span>
<a href="#l110.350"></a><span id="l110.350">   // for OCSP requests), but Gecko stopped doing that configuration. Something</span>
<a href="#l110.351"></a><span id="l110.351">   // similar to what was done for Gecko bug 1028643 needs to be done here too.</span>
<a href="#l110.352"></a><span id="l110.352" class="difflineminus">-  if (NSS_CMSSignedData_VerifySignerInfo(sigd, 0, CERT_GetDefaultCertDB(), certUsageEmailSigner) != SECSuccess) {</span>
<a href="#l110.353"></a><span id="l110.353" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - unable to verify signature\n&quot;));</span>
<a href="#l110.354"></a><span id="l110.354" class="difflineplus">+  if (NSS_CMSSignedData_VerifySignerInfo(sigd, 0, CERT_GetDefaultCertDB(),</span>
<a href="#l110.355"></a><span id="l110.355" class="difflineplus">+                                         certUsageEmailSigner) != SECSuccess) {</span>
<a href="#l110.356"></a><span id="l110.356" class="difflineplus">+    MOZ_LOG(</span>
<a href="#l110.357"></a><span id="l110.357" class="difflineplus">+        gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.358"></a><span id="l110.358" class="difflineplus">+        (&quot;nsCMSMessage::CommonVerifySignature - unable to verify signature\n&quot;));</span>
<a href="#l110.359"></a><span id="l110.359"> </span>
<a href="#l110.360"></a><span id="l110.360">     if (NSSCMSVS_SigningCertNotFound == si-&gt;verificationStatus) {</span>
<a href="#l110.361"></a><span id="l110.361" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - signing cert not found\n&quot;));</span>
<a href="#l110.362"></a><span id="l110.362" class="difflineplus">+      MOZ_LOG(</span>
<a href="#l110.363"></a><span id="l110.363" class="difflineplus">+          gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.364"></a><span id="l110.364" class="difflineplus">+          (&quot;nsCMSMessage::CommonVerifySignature - signing cert not found\n&quot;));</span>
<a href="#l110.365"></a><span id="l110.365">       rv = NS_ERROR_CMS_VERIFY_NOCERT;</span>
<a href="#l110.366"></a><span id="l110.366" class="difflineminus">-    }</span>
<a href="#l110.367"></a><span id="l110.367" class="difflineminus">-    else if(NSSCMSVS_SigningCertNotTrusted == si-&gt;verificationStatus) {</span>
<a href="#l110.368"></a><span id="l110.368" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - signing cert not trusted at signing time\n&quot;));</span>
<a href="#l110.369"></a><span id="l110.369" class="difflineplus">+    } else if (NSSCMSVS_SigningCertNotTrusted == si-&gt;verificationStatus) {</span>
<a href="#l110.370"></a><span id="l110.370" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.371"></a><span id="l110.371" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - signing cert not trusted &quot;</span>
<a href="#l110.372"></a><span id="l110.372" class="difflineplus">+               &quot;at signing time\n&quot;));</span>
<a href="#l110.373"></a><span id="l110.373">       rv = NS_ERROR_CMS_VERIFY_UNTRUSTED;</span>
<a href="#l110.374"></a><span id="l110.374" class="difflineminus">-    }</span>
<a href="#l110.375"></a><span id="l110.375" class="difflineminus">-    else if(NSSCMSVS_Unverified == si-&gt;verificationStatus) {</span>
<a href="#l110.376"></a><span id="l110.376" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - can not verify\n&quot;));</span>
<a href="#l110.377"></a><span id="l110.377" class="difflineplus">+    } else if (NSSCMSVS_Unverified == si-&gt;verificationStatus) {</span>
<a href="#l110.378"></a><span id="l110.378" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.379"></a><span id="l110.379" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - can not verify\n&quot;));</span>
<a href="#l110.380"></a><span id="l110.380">       rv = NS_ERROR_CMS_VERIFY_ERROR_UNVERIFIED;</span>
<a href="#l110.381"></a><span id="l110.381" class="difflineminus">-    }</span>
<a href="#l110.382"></a><span id="l110.382" class="difflineminus">-    else if(NSSCMSVS_ProcessingError == si-&gt;verificationStatus) {</span>
<a href="#l110.383"></a><span id="l110.383" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - processing error\n&quot;));</span>
<a href="#l110.384"></a><span id="l110.384" class="difflineplus">+    } else if (NSSCMSVS_ProcessingError == si-&gt;verificationStatus) {</span>
<a href="#l110.385"></a><span id="l110.385" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.386"></a><span id="l110.386" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - processing error\n&quot;));</span>
<a href="#l110.387"></a><span id="l110.387">       rv = NS_ERROR_CMS_VERIFY_ERROR_PROCESSING;</span>
<a href="#l110.388"></a><span id="l110.388" class="difflineminus">-    }</span>
<a href="#l110.389"></a><span id="l110.389" class="difflineminus">-    else if(NSSCMSVS_BadSignature == si-&gt;verificationStatus) {</span>
<a href="#l110.390"></a><span id="l110.390" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - bad signature\n&quot;));</span>
<a href="#l110.391"></a><span id="l110.391" class="difflineplus">+    } else if (NSSCMSVS_BadSignature == si-&gt;verificationStatus) {</span>
<a href="#l110.392"></a><span id="l110.392" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.393"></a><span id="l110.393" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - bad signature\n&quot;));</span>
<a href="#l110.394"></a><span id="l110.394">       rv = NS_ERROR_CMS_VERIFY_BAD_SIGNATURE;</span>
<a href="#l110.395"></a><span id="l110.395" class="difflineminus">-    }</span>
<a href="#l110.396"></a><span id="l110.396" class="difflineminus">-    else if(NSSCMSVS_DigestMismatch == si-&gt;verificationStatus) {</span>
<a href="#l110.397"></a><span id="l110.397" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - digest mismatch\n&quot;));</span>
<a href="#l110.398"></a><span id="l110.398" class="difflineplus">+    } else if (NSSCMSVS_DigestMismatch == si-&gt;verificationStatus) {</span>
<a href="#l110.399"></a><span id="l110.399" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.400"></a><span id="l110.400" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - digest mismatch\n&quot;));</span>
<a href="#l110.401"></a><span id="l110.401">       rv = NS_ERROR_CMS_VERIFY_DIGEST_MISMATCH;</span>
<a href="#l110.402"></a><span id="l110.402" class="difflineminus">-    }</span>
<a href="#l110.403"></a><span id="l110.403" class="difflineminus">-    else if(NSSCMSVS_SignatureAlgorithmUnknown == si-&gt;verificationStatus) {</span>
<a href="#l110.404"></a><span id="l110.404" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - algo unknown\n&quot;));</span>
<a href="#l110.405"></a><span id="l110.405" class="difflineplus">+    } else if (NSSCMSVS_SignatureAlgorithmUnknown == si-&gt;verificationStatus) {</span>
<a href="#l110.406"></a><span id="l110.406" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.407"></a><span id="l110.407" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - algo unknown\n&quot;));</span>
<a href="#l110.408"></a><span id="l110.408">       rv = NS_ERROR_CMS_VERIFY_UNKNOWN_ALGO;</span>
<a href="#l110.409"></a><span id="l110.409" class="difflineminus">-    }</span>
<a href="#l110.410"></a><span id="l110.410" class="difflineminus">-    else if(NSSCMSVS_SignatureAlgorithmUnsupported == si-&gt;verificationStatus) {</span>
<a href="#l110.411"></a><span id="l110.411" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - algo not supported\n&quot;));</span>
<a href="#l110.412"></a><span id="l110.412" class="difflineplus">+    } else if (NSSCMSVS_SignatureAlgorithmUnsupported ==</span>
<a href="#l110.413"></a><span id="l110.413" class="difflineplus">+               si-&gt;verificationStatus) {</span>
<a href="#l110.414"></a><span id="l110.414" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.415"></a><span id="l110.415" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - algo not supported\n&quot;));</span>
<a href="#l110.416"></a><span id="l110.416">       rv = NS_ERROR_CMS_VERIFY_UNSUPPORTED_ALGO;</span>
<a href="#l110.417"></a><span id="l110.417" class="difflineminus">-    }</span>
<a href="#l110.418"></a><span id="l110.418" class="difflineminus">-    else if(NSSCMSVS_MalformedSignature == si-&gt;verificationStatus) {</span>
<a href="#l110.419"></a><span id="l110.419" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - malformed signature\n&quot;));</span>
<a href="#l110.420"></a><span id="l110.420" class="difflineplus">+    } else if (NSSCMSVS_MalformedSignature == si-&gt;verificationStatus) {</span>
<a href="#l110.421"></a><span id="l110.421" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.422"></a><span id="l110.422" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - malformed signature\n&quot;));</span>
<a href="#l110.423"></a><span id="l110.423">       rv = NS_ERROR_CMS_VERIFY_MALFORMED_SIGNATURE;</span>
<a href="#l110.424"></a><span id="l110.424">     }</span>
<a href="#l110.425"></a><span id="l110.425"> </span>
<a href="#l110.426"></a><span id="l110.426">     goto loser;</span>
<a href="#l110.427"></a><span id="l110.427">   }</span>
<a href="#l110.428"></a><span id="l110.428"> </span>
<a href="#l110.429"></a><span id="l110.429" class="difflineminus">-  // Save the profile. Note that save import failure is not a signature verification failure. //</span>
<a href="#l110.430"></a><span id="l110.430" class="difflineplus">+  // Save the profile. Note that save import failure is not a signature</span>
<a href="#l110.431"></a><span id="l110.431" class="difflineplus">+  // verification failure. //</span>
<a href="#l110.432"></a><span id="l110.432">   if (NSS_SMIMESignerInfo_SaveSMIMEProfile(si) != SECSuccess) {</span>
<a href="#l110.433"></a><span id="l110.433" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - unable to save smime profile\n&quot;));</span>
<a href="#l110.434"></a><span id="l110.434" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.435"></a><span id="l110.435" class="difflineplus">+            (&quot;nsCMSMessage::CommonVerifySignature - unable to save smime &quot;</span>
<a href="#l110.436"></a><span id="l110.436" class="difflineplus">+             &quot;profile\n&quot;));</span>
<a href="#l110.437"></a><span id="l110.437">   }</span>
<a href="#l110.438"></a><span id="l110.438"> </span>
<a href="#l110.439"></a><span id="l110.439">   rv = NS_OK;</span>
<a href="#l110.440"></a><span id="l110.440"> loser:</span>
<a href="#l110.441"></a><span id="l110.441">   return rv;</span>
<a href="#l110.442"></a><span id="l110.442"> }</span>
<a href="#l110.443"></a><span id="l110.443"> </span>
<a href="#l110.444"></a><span id="l110.444"> NS_IMETHODIMP nsCMSMessage::AsyncVerifySignature(</span>
<a href="#l110.445"></a><span id="l110.445" class="difflineminus">-                              nsISMimeVerificationListener *aListener)</span>
<a href="#l110.446"></a><span id="l110.446" class="difflineminus">-{</span>
<a href="#l110.447"></a><span id="l110.447" class="difflineplus">+    nsISMimeVerificationListener *aListener) {</span>
<a href="#l110.448"></a><span id="l110.448">   return CommonAsyncVerifySignature(aListener, nullptr, 0, 0);</span>
<a href="#l110.449"></a><span id="l110.449"> }</span>
<a href="#l110.450"></a><span id="l110.450"> </span>
<a href="#l110.451"></a><span id="l110.451"> NS_IMETHODIMP nsCMSMessage::AsyncVerifyDetachedSignature(</span>
<a href="#l110.452"></a><span id="l110.452" class="difflineminus">-                              nsISMimeVerificationListener *aListener,</span>
<a href="#l110.453"></a><span id="l110.453" class="difflineminus">-                              unsigned char* aDigestData,</span>
<a href="#l110.454"></a><span id="l110.454" class="difflineminus">-                              uint32_t aDigestDataLen,</span>
<a href="#l110.455"></a><span id="l110.455" class="difflineminus">-                              int16_t aDigestType)</span>
<a href="#l110.456"></a><span id="l110.456" class="difflineminus">-{</span>
<a href="#l110.457"></a><span id="l110.457" class="difflineminus">-  if (!aDigestData || !aDigestDataLen)</span>
<a href="#l110.458"></a><span id="l110.458" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l110.459"></a><span id="l110.459" class="difflineplus">+    nsISMimeVerificationListener *aListener, unsigned char *aDigestData,</span>
<a href="#l110.460"></a><span id="l110.460" class="difflineplus">+    uint32_t aDigestDataLen, int16_t aDigestType) {</span>
<a href="#l110.461"></a><span id="l110.461" class="difflineplus">+  if (!aDigestData || !aDigestDataLen) return NS_ERROR_FAILURE;</span>
<a href="#l110.462"></a><span id="l110.462"> </span>
<a href="#l110.463"></a><span id="l110.463" class="difflineminus">-  return CommonAsyncVerifySignature(aListener, aDigestData, aDigestDataLen, aDigestType);</span>
<a href="#l110.464"></a><span id="l110.464" class="difflineplus">+  return CommonAsyncVerifySignature(aListener, aDigestData, aDigestDataLen,</span>
<a href="#l110.465"></a><span id="l110.465" class="difflineplus">+                                    aDigestType);</span>
<a href="#l110.466"></a><span id="l110.466"> }</span>
<a href="#l110.467"></a><span id="l110.467"> </span>
<a href="#l110.468"></a><span id="l110.468" class="difflineminus">-class SMimeVerificationTask final : public CryptoTask</span>
<a href="#l110.469"></a><span id="l110.469" class="difflineminus">-{</span>
<a href="#l110.470"></a><span id="l110.470" class="difflineminus">-public:</span>
<a href="#l110.471"></a><span id="l110.471" class="difflineplus">+class SMimeVerificationTask final : public CryptoTask {</span>
<a href="#l110.472"></a><span id="l110.472" class="difflineplus">+ public:</span>
<a href="#l110.473"></a><span id="l110.473">   SMimeVerificationTask(nsICMSMessage *aMessage,</span>
<a href="#l110.474"></a><span id="l110.474">                         nsISMimeVerificationListener *aListener,</span>
<a href="#l110.475"></a><span id="l110.475" class="difflineminus">-                        unsigned char *aDigestData,</span>
<a href="#l110.476"></a><span id="l110.476" class="difflineminus">-                        uint32_t aDigestDataLen,</span>
<a href="#l110.477"></a><span id="l110.477" class="difflineminus">-                        int16_t aDigestType)</span>
<a href="#l110.478"></a><span id="l110.478" class="difflineminus">-  {</span>
<a href="#l110.479"></a><span id="l110.479" class="difflineplus">+                        unsigned char *aDigestData, uint32_t aDigestDataLen,</span>
<a href="#l110.480"></a><span id="l110.480" class="difflineplus">+                        int16_t aDigestType) {</span>
<a href="#l110.481"></a><span id="l110.481">     MOZ_ASSERT(NS_IsMainThread());</span>
<a href="#l110.482"></a><span id="l110.482">     mMessage = aMessage;</span>
<a href="#l110.483"></a><span id="l110.483">     mListener = aListener;</span>
<a href="#l110.484"></a><span id="l110.484">     mDigestData.Assign(reinterpret_cast&lt;char *&gt;(aDigestData), aDigestDataLen);</span>
<a href="#l110.485"></a><span id="l110.485">     mDigestType = aDigestType;</span>
<a href="#l110.486"></a><span id="l110.486">   }</span>
<a href="#l110.487"></a><span id="l110.487"> </span>
<a href="#l110.488"></a><span id="l110.488" class="difflineminus">-private:</span>
<a href="#l110.489"></a><span id="l110.489" class="difflineminus">-  virtual nsresult CalculateResult() override</span>
<a href="#l110.490"></a><span id="l110.490" class="difflineminus">-  {</span>
<a href="#l110.491"></a><span id="l110.491" class="difflineplus">+ private:</span>
<a href="#l110.492"></a><span id="l110.492" class="difflineplus">+  virtual nsresult CalculateResult() override {</span>
<a href="#l110.493"></a><span id="l110.493">     MOZ_ASSERT(!NS_IsMainThread());</span>
<a href="#l110.494"></a><span id="l110.494"> </span>
<a href="#l110.495"></a><span id="l110.495">     mozilla::StaticMutexAutoLock lock(sMutex);</span>
<a href="#l110.496"></a><span id="l110.496">     nsresult rv;</span>
<a href="#l110.497"></a><span id="l110.497">     if (!mDigestData.IsEmpty()) {</span>
<a href="#l110.498"></a><span id="l110.498">       rv = mMessage-&gt;VerifyDetachedSignature(</span>
<a href="#l110.499"></a><span id="l110.499" class="difflineminus">-        reinterpret_cast&lt;uint8_t*&gt;(const_cast&lt;char *&gt;(mDigestData.get())),</span>
<a href="#l110.500"></a><span id="l110.500" class="difflineminus">-        mDigestData.Length(), mDigestType);</span>
<a href="#l110.501"></a><span id="l110.501" class="difflineplus">+          reinterpret_cast&lt;uint8_t *&gt;(const_cast&lt;char *&gt;(mDigestData.get())),</span>
<a href="#l110.502"></a><span id="l110.502" class="difflineplus">+          mDigestData.Length(), mDigestType);</span>
<a href="#l110.503"></a><span id="l110.503">     } else {</span>
<a href="#l110.504"></a><span id="l110.504">       rv = mMessage-&gt;VerifySignature();</span>
<a href="#l110.505"></a><span id="l110.505">     }</span>
<a href="#l110.506"></a><span id="l110.506"> </span>
<a href="#l110.507"></a><span id="l110.507">     return rv;</span>
<a href="#l110.508"></a><span id="l110.508">   }</span>
<a href="#l110.509"></a><span id="l110.509" class="difflineminus">-  virtual void CallCallback(nsresult rv) override</span>
<a href="#l110.510"></a><span id="l110.510" class="difflineminus">-  {</span>
<a href="#l110.511"></a><span id="l110.511" class="difflineplus">+  virtual void CallCallback(nsresult rv) override {</span>
<a href="#l110.512"></a><span id="l110.512">     MOZ_ASSERT(NS_IsMainThread());</span>
<a href="#l110.513"></a><span id="l110.513">     mListener-&gt;Notify(mMessage, rv);</span>
<a href="#l110.514"></a><span id="l110.514">   }</span>
<a href="#l110.515"></a><span id="l110.515"> </span>
<a href="#l110.516"></a><span id="l110.516">   nsCOMPtr&lt;nsICMSMessage&gt; mMessage;</span>
<a href="#l110.517"></a><span id="l110.517">   nsCOMPtr&lt;nsISMimeVerificationListener&gt; mListener;</span>
<a href="#l110.518"></a><span id="l110.518">   nsCString mDigestData;</span>
<a href="#l110.519"></a><span id="l110.519">   int16_t mDigestType;</span>
<a href="#l110.520"></a><span id="l110.520"> </span>
<a href="#l110.521"></a><span id="l110.521">   static mozilla::StaticMutex sMutex;</span>
<a href="#l110.522"></a><span id="l110.522"> };</span>
<a href="#l110.523"></a><span id="l110.523"> </span>
<a href="#l110.524"></a><span id="l110.524"> mozilla::StaticMutex SMimeVerificationTask::sMutex;</span>
<a href="#l110.525"></a><span id="l110.525"> </span>
<a href="#l110.526"></a><span id="l110.526" class="difflineminus">-nsresult nsCMSMessage::CommonAsyncVerifySignature(nsISMimeVerificationListener *aListener,</span>
<a href="#l110.527"></a><span id="l110.527" class="difflineminus">-                                                  unsigned char* aDigestData, uint32_t aDigestDataLen,</span>
<a href="#l110.528"></a><span id="l110.528" class="difflineminus">-                                                  int16_t aDigestType)</span>
<a href="#l110.529"></a><span id="l110.529" class="difflineminus">-{</span>
<a href="#l110.530"></a><span id="l110.530" class="difflineminus">-  RefPtr&lt;CryptoTask&gt; task = new SMimeVerificationTask(this, aListener, aDigestData, aDigestDataLen, aDigestType);</span>
<a href="#l110.531"></a><span id="l110.531" class="difflineplus">+nsresult nsCMSMessage::CommonAsyncVerifySignature(</span>
<a href="#l110.532"></a><span id="l110.532" class="difflineplus">+    nsISMimeVerificationListener *aListener, unsigned char *aDigestData,</span>
<a href="#l110.533"></a><span id="l110.533" class="difflineplus">+    uint32_t aDigestDataLen, int16_t aDigestType) {</span>
<a href="#l110.534"></a><span id="l110.534" class="difflineplus">+  RefPtr&lt;CryptoTask&gt; task = new SMimeVerificationTask(</span>
<a href="#l110.535"></a><span id="l110.535" class="difflineplus">+      this, aListener, aDigestData, aDigestDataLen, aDigestType);</span>
<a href="#l110.536"></a><span id="l110.536">   return task-&gt;Dispatch(&quot;SMimeVerify&quot;);</span>
<a href="#l110.537"></a><span id="l110.537"> }</span>
<a href="#l110.538"></a><span id="l110.538"> </span>
<a href="#l110.539"></a><span id="l110.539" class="difflineminus">-class nsZeroTerminatedCertArray</span>
<a href="#l110.540"></a><span id="l110.540" class="difflineminus">-{</span>
<a href="#l110.541"></a><span id="l110.541" class="difflineminus">-public:</span>
<a href="#l110.542"></a><span id="l110.542" class="difflineminus">-  nsZeroTerminatedCertArray()</span>
<a href="#l110.543"></a><span id="l110.543" class="difflineminus">-  :mCerts(nullptr), mPoolp(nullptr), mSize(0)</span>
<a href="#l110.544"></a><span id="l110.544" class="difflineminus">-  {</span>
<a href="#l110.545"></a><span id="l110.545" class="difflineminus">-  }</span>
<a href="#l110.546"></a><span id="l110.546" class="difflineplus">+class nsZeroTerminatedCertArray {</span>
<a href="#l110.547"></a><span id="l110.547" class="difflineplus">+ public:</span>
<a href="#l110.548"></a><span id="l110.548" class="difflineplus">+  nsZeroTerminatedCertArray() : mCerts(nullptr), mPoolp(nullptr), mSize(0) {}</span>
<a href="#l110.549"></a><span id="l110.549"> </span>
<a href="#l110.550"></a><span id="l110.550" class="difflineminus">-  ~nsZeroTerminatedCertArray()</span>
<a href="#l110.551"></a><span id="l110.551" class="difflineminus">-  {</span>
<a href="#l110.552"></a><span id="l110.552" class="difflineminus">-    destructorSafeDestroyNSSReference();</span>
<a href="#l110.553"></a><span id="l110.553" class="difflineminus">-  }</span>
<a href="#l110.554"></a><span id="l110.554" class="difflineplus">+  ~nsZeroTerminatedCertArray() { destructorSafeDestroyNSSReference(); }</span>
<a href="#l110.555"></a><span id="l110.555"> </span>
<a href="#l110.556"></a><span id="l110.556" class="difflineminus">-  void destructorSafeDestroyNSSReference()</span>
<a href="#l110.557"></a><span id="l110.557" class="difflineminus">-  {</span>
<a href="#l110.558"></a><span id="l110.558" class="difflineminus">-    if (mCerts)</span>
<a href="#l110.559"></a><span id="l110.559" class="difflineminus">-    {</span>
<a href="#l110.560"></a><span id="l110.560" class="difflineminus">-      for (uint32_t i=0; i &lt; mSize; i++) {</span>
<a href="#l110.561"></a><span id="l110.561" class="difflineplus">+  void destructorSafeDestroyNSSReference() {</span>
<a href="#l110.562"></a><span id="l110.562" class="difflineplus">+    if (mCerts) {</span>
<a href="#l110.563"></a><span id="l110.563" class="difflineplus">+      for (uint32_t i = 0; i &lt; mSize; i++) {</span>
<a href="#l110.564"></a><span id="l110.564">         if (mCerts[i]) {</span>
<a href="#l110.565"></a><span id="l110.565">           CERT_DestroyCertificate(mCerts[i]);</span>
<a href="#l110.566"></a><span id="l110.566">         }</span>
<a href="#l110.567"></a><span id="l110.567">       }</span>
<a href="#l110.568"></a><span id="l110.568">     }</span>
<a href="#l110.569"></a><span id="l110.569"> </span>
<a href="#l110.570"></a><span id="l110.570" class="difflineminus">-    if (mPoolp)</span>
<a href="#l110.571"></a><span id="l110.571" class="difflineminus">-      PORT_FreeArena(mPoolp, false);</span>
<a href="#l110.572"></a><span id="l110.572" class="difflineplus">+    if (mPoolp) PORT_FreeArena(mPoolp, false);</span>
<a href="#l110.573"></a><span id="l110.573">   }</span>
<a href="#l110.574"></a><span id="l110.574"> </span>
<a href="#l110.575"></a><span id="l110.575" class="difflineminus">-  bool allocate(uint32_t count)</span>
<a href="#l110.576"></a><span id="l110.576" class="difflineminus">-  {</span>
<a href="#l110.577"></a><span id="l110.577" class="difflineplus">+  bool allocate(uint32_t count) {</span>
<a href="#l110.578"></a><span id="l110.578">     // only allow allocation once</span>
<a href="#l110.579"></a><span id="l110.579" class="difflineminus">-    if (mPoolp)</span>
<a href="#l110.580"></a><span id="l110.580" class="difflineminus">-      return false;</span>
<a href="#l110.581"></a><span id="l110.581" class="difflineplus">+    if (mPoolp) return false;</span>
<a href="#l110.582"></a><span id="l110.582"> </span>
<a href="#l110.583"></a><span id="l110.583">     mSize = count;</span>
<a href="#l110.584"></a><span id="l110.584"> </span>
<a href="#l110.585"></a><span id="l110.585" class="difflineminus">-    if (!mSize)</span>
<a href="#l110.586"></a><span id="l110.586" class="difflineminus">-      return false;</span>
<a href="#l110.587"></a><span id="l110.587" class="difflineplus">+    if (!mSize) return false;</span>
<a href="#l110.588"></a><span id="l110.588"> </span>
<a href="#l110.589"></a><span id="l110.589">     mPoolp = PORT_NewArena(1024);</span>
<a href="#l110.590"></a><span id="l110.590" class="difflineminus">-    if (!mPoolp)</span>
<a href="#l110.591"></a><span id="l110.591" class="difflineminus">-      return false;</span>
<a href="#l110.592"></a><span id="l110.592" class="difflineplus">+    if (!mPoolp) return false;</span>
<a href="#l110.593"></a><span id="l110.593"> </span>
<a href="#l110.594"></a><span id="l110.594" class="difflineminus">-    mCerts = (CERTCertificate**)PORT_ArenaZAlloc(</span>
<a href="#l110.595"></a><span id="l110.595" class="difflineminus">-      mPoolp, (count+1)*sizeof(CERTCertificate*));</span>
<a href="#l110.596"></a><span id="l110.596" class="difflineplus">+    mCerts = (CERTCertificate **)PORT_ArenaZAlloc(</span>
<a href="#l110.597"></a><span id="l110.597" class="difflineplus">+        mPoolp, (count + 1) * sizeof(CERTCertificate *));</span>
<a href="#l110.598"></a><span id="l110.598"> </span>
<a href="#l110.599"></a><span id="l110.599" class="difflineminus">-    if (!mCerts)</span>
<a href="#l110.600"></a><span id="l110.600" class="difflineminus">-      return false;</span>
<a href="#l110.601"></a><span id="l110.601" class="difflineplus">+    if (!mCerts) return false;</span>
<a href="#l110.602"></a><span id="l110.602"> </span>
<a href="#l110.603"></a><span id="l110.603">     // null array, including zero termination</span>
<a href="#l110.604"></a><span id="l110.604" class="difflineminus">-    for (uint32_t i = 0; i &lt; count+1; i++) {</span>
<a href="#l110.605"></a><span id="l110.605" class="difflineplus">+    for (uint32_t i = 0; i &lt; count + 1; i++) {</span>
<a href="#l110.606"></a><span id="l110.606">       mCerts[i] = nullptr;</span>
<a href="#l110.607"></a><span id="l110.607">     }</span>
<a href="#l110.608"></a><span id="l110.608"> </span>
<a href="#l110.609"></a><span id="l110.609">     return true;</span>
<a href="#l110.610"></a><span id="l110.610">   }</span>
<a href="#l110.611"></a><span id="l110.611"> </span>
<a href="#l110.612"></a><span id="l110.612" class="difflineminus">-  void set(uint32_t i, CERTCertificate *c)</span>
<a href="#l110.613"></a><span id="l110.613" class="difflineminus">-  {</span>
<a href="#l110.614"></a><span id="l110.614" class="difflineminus">-    if (i &gt;= mSize)</span>
<a href="#l110.615"></a><span id="l110.615" class="difflineminus">-      return;</span>
<a href="#l110.616"></a><span id="l110.616" class="difflineplus">+  void set(uint32_t i, CERTCertificate *c) {</span>
<a href="#l110.617"></a><span id="l110.617" class="difflineplus">+    if (i &gt;= mSize) return;</span>
<a href="#l110.618"></a><span id="l110.618"> </span>
<a href="#l110.619"></a><span id="l110.619">     if (mCerts[i]) {</span>
<a href="#l110.620"></a><span id="l110.620">       CERT_DestroyCertificate(mCerts[i]);</span>
<a href="#l110.621"></a><span id="l110.621">     }</span>
<a href="#l110.622"></a><span id="l110.622"> </span>
<a href="#l110.623"></a><span id="l110.623">     mCerts[i] = CERT_DupCertificate(c);</span>
<a href="#l110.624"></a><span id="l110.624">   }</span>
<a href="#l110.625"></a><span id="l110.625"> </span>
<a href="#l110.626"></a><span id="l110.626" class="difflineminus">-  CERTCertificate *get(uint32_t i)</span>
<a href="#l110.627"></a><span id="l110.627" class="difflineminus">-  {</span>
<a href="#l110.628"></a><span id="l110.628" class="difflineminus">-    if (i &gt;= mSize)</span>
<a href="#l110.629"></a><span id="l110.629" class="difflineminus">-      return nullptr;</span>
<a href="#l110.630"></a><span id="l110.630" class="difflineplus">+  CERTCertificate *get(uint32_t i) {</span>
<a href="#l110.631"></a><span id="l110.631" class="difflineplus">+    if (i &gt;= mSize) return nullptr;</span>
<a href="#l110.632"></a><span id="l110.632"> </span>
<a href="#l110.633"></a><span id="l110.633">     return CERT_DupCertificate(mCerts[i]);</span>
<a href="#l110.634"></a><span id="l110.634">   }</span>
<a href="#l110.635"></a><span id="l110.635"> </span>
<a href="#l110.636"></a><span id="l110.636" class="difflineminus">-  CERTCertificate **getRawArray()</span>
<a href="#l110.637"></a><span id="l110.637" class="difflineminus">-  {</span>
<a href="#l110.638"></a><span id="l110.638" class="difflineminus">-    return mCerts;</span>
<a href="#l110.639"></a><span id="l110.639" class="difflineminus">-  }</span>
<a href="#l110.640"></a><span id="l110.640" class="difflineplus">+  CERTCertificate **getRawArray() { return mCerts; }</span>
<a href="#l110.641"></a><span id="l110.641"> </span>
<a href="#l110.642"></a><span id="l110.642" class="difflineminus">-private:</span>
<a href="#l110.643"></a><span id="l110.643" class="difflineplus">+ private:</span>
<a href="#l110.644"></a><span id="l110.644">   CERTCertificate **mCerts;</span>
<a href="#l110.645"></a><span id="l110.645">   PLArenaPool *mPoolp;</span>
<a href="#l110.646"></a><span id="l110.646">   uint32_t mSize;</span>
<a href="#l110.647"></a><span id="l110.647"> };</span>
<a href="#l110.648"></a><span id="l110.648"> </span>
<a href="#l110.649"></a><span id="l110.649" class="difflineminus">-NS_IMETHODIMP nsCMSMessage::CreateEncrypted(nsIArray * aRecipientCerts)</span>
<a href="#l110.650"></a><span id="l110.650" class="difflineminus">-{</span>
<a href="#l110.651"></a><span id="l110.651" class="difflineplus">+NS_IMETHODIMP nsCMSMessage::CreateEncrypted(nsIArray *aRecipientCerts) {</span>
<a href="#l110.652"></a><span id="l110.652">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted\n&quot;));</span>
<a href="#l110.653"></a><span id="l110.653">   NSSCMSContentInfo *cinfo;</span>
<a href="#l110.654"></a><span id="l110.654">   NSSCMSEnvelopedData *envd;</span>
<a href="#l110.655"></a><span id="l110.655">   NSSCMSRecipientInfo *recipientInfo;</span>
<a href="#l110.656"></a><span id="l110.656">   nsZeroTerminatedCertArray recipientCerts;</span>
<a href="#l110.657"></a><span id="l110.657">   SECOidTag bulkAlgTag;</span>
<a href="#l110.658"></a><span id="l110.658">   int keySize;</span>
<a href="#l110.659"></a><span id="l110.659">   uint32_t i;</span>
<a href="#l110.660"></a><span id="l110.660" class="difflineat">@@ -532,99 +492,110 @@ NS_IMETHODIMP nsCMSMessage::CreateEncryp</span>
<a href="#l110.661"></a><span id="l110.661">   uint32_t recipientCertCount;</span>
<a href="#l110.662"></a><span id="l110.662">   aRecipientCerts-&gt;GetLength(&amp;recipientCertCount);</span>
<a href="#l110.663"></a><span id="l110.663">   PR_ASSERT(recipientCertCount &gt; 0);</span>
<a href="#l110.664"></a><span id="l110.664"> </span>
<a href="#l110.665"></a><span id="l110.665">   if (!recipientCerts.allocate(recipientCertCount)) {</span>
<a href="#l110.666"></a><span id="l110.666">     goto loser;</span>
<a href="#l110.667"></a><span id="l110.667">   }</span>
<a href="#l110.668"></a><span id="l110.668"> </span>
<a href="#l110.669"></a><span id="l110.669" class="difflineminus">-  for (i=0; i&lt;recipientCertCount; i++) {</span>
<a href="#l110.670"></a><span id="l110.670" class="difflineplus">+  for (i = 0; i &lt; recipientCertCount; i++) {</span>
<a href="#l110.671"></a><span id="l110.671">     nsCOMPtr&lt;nsIX509Cert&gt; x509cert = do_QueryElementAt(aRecipientCerts, i);</span>
<a href="#l110.672"></a><span id="l110.672"> </span>
<a href="#l110.673"></a><span id="l110.673" class="difflineminus">-    if (!x509cert)</span>
<a href="#l110.674"></a><span id="l110.674" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l110.675"></a><span id="l110.675" class="difflineplus">+    if (!x509cert) return NS_ERROR_FAILURE;</span>
<a href="#l110.676"></a><span id="l110.676"> </span>
<a href="#l110.677"></a><span id="l110.677">     UniqueCERTCertificate c(x509cert-&gt;GetCert());</span>
<a href="#l110.678"></a><span id="l110.678">     recipientCerts.set(i, c.get());</span>
<a href="#l110.679"></a><span id="l110.679">   }</span>
<a href="#l110.680"></a><span id="l110.680"> </span>
<a href="#l110.681"></a><span id="l110.681">   // Find a bulk key algorithm //</span>
<a href="#l110.682"></a><span id="l110.682" class="difflineminus">-  if (NSS_SMIMEUtil_FindBulkAlgForRecipients(recipientCerts.getRawArray(), &amp;bulkAlgTag,</span>
<a href="#l110.683"></a><span id="l110.683" class="difflineminus">-                                            &amp;keySize) != SECSuccess) {</span>
<a href="#l110.684"></a><span id="l110.684" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't find bulk alg for recipients\n&quot;));</span>
<a href="#l110.685"></a><span id="l110.685" class="difflineplus">+  if (NSS_SMIMEUtil_FindBulkAlgForRecipients(</span>
<a href="#l110.686"></a><span id="l110.686" class="difflineplus">+          recipientCerts.getRawArray(), &amp;bulkAlgTag, &amp;keySize) != SECSuccess) {</span>
<a href="#l110.687"></a><span id="l110.687" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.688"></a><span id="l110.688" class="difflineplus">+            (&quot;nsCMSMessage::CreateEncrypted - can't find bulk alg for &quot;</span>
<a href="#l110.689"></a><span id="l110.689" class="difflineplus">+             &quot;recipients\n&quot;));</span>
<a href="#l110.690"></a><span id="l110.690">     rv = NS_ERROR_CMS_ENCRYPT_NO_BULK_ALG;</span>
<a href="#l110.691"></a><span id="l110.691">     goto loser;</span>
<a href="#l110.692"></a><span id="l110.692">   }</span>
<a href="#l110.693"></a><span id="l110.693"> </span>
<a href="#l110.694"></a><span id="l110.694">   m_cmsMsg = NSS_CMSMessage_Create(nullptr);</span>
<a href="#l110.695"></a><span id="l110.695">   if (!m_cmsMsg) {</span>
<a href="#l110.696"></a><span id="l110.696" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't create new cms message\n&quot;));</span>
<a href="#l110.697"></a><span id="l110.697" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.698"></a><span id="l110.698" class="difflineplus">+            (&quot;nsCMSMessage::CreateEncrypted - can't create new cms message\n&quot;));</span>
<a href="#l110.699"></a><span id="l110.699">     rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l110.700"></a><span id="l110.700">     goto loser;</span>
<a href="#l110.701"></a><span id="l110.701">   }</span>
<a href="#l110.702"></a><span id="l110.702"> </span>
<a href="#l110.703"></a><span id="l110.703" class="difflineminus">-  if ((envd = NSS_CMSEnvelopedData_Create(m_cmsMsg, bulkAlgTag, keySize)) == nullptr) {</span>
<a href="#l110.704"></a><span id="l110.704" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't create enveloped data\n&quot;));</span>
<a href="#l110.705"></a><span id="l110.705" class="difflineplus">+  if ((envd = NSS_CMSEnvelopedData_Create(m_cmsMsg, bulkAlgTag, keySize)) ==</span>
<a href="#l110.706"></a><span id="l110.706" class="difflineplus">+      nullptr) {</span>
<a href="#l110.707"></a><span id="l110.707" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.708"></a><span id="l110.708" class="difflineplus">+            (&quot;nsCMSMessage::CreateEncrypted - can't create enveloped data\n&quot;));</span>
<a href="#l110.709"></a><span id="l110.709">     goto loser;</span>
<a href="#l110.710"></a><span id="l110.710">   }</span>
<a href="#l110.711"></a><span id="l110.711"> </span>
<a href="#l110.712"></a><span id="l110.712">   cinfo = NSS_CMSMessage_GetContentInfo(m_cmsMsg);</span>
<a href="#l110.713"></a><span id="l110.713" class="difflineminus">-  if (NSS_CMSContentInfo_SetContent_EnvelopedData(m_cmsMsg, cinfo, envd) != SECSuccess) {</span>
<a href="#l110.714"></a><span id="l110.714" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't create content enveloped data\n&quot;));</span>
<a href="#l110.715"></a><span id="l110.715" class="difflineplus">+  if (NSS_CMSContentInfo_SetContent_EnvelopedData(m_cmsMsg, cinfo, envd) !=</span>
<a href="#l110.716"></a><span id="l110.716" class="difflineplus">+      SECSuccess) {</span>
<a href="#l110.717"></a><span id="l110.717" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.718"></a><span id="l110.718" class="difflineplus">+            (&quot;nsCMSMessage::CreateEncrypted - can't create content enveloped &quot;</span>
<a href="#l110.719"></a><span id="l110.719" class="difflineplus">+             &quot;data\n&quot;));</span>
<a href="#l110.720"></a><span id="l110.720">     goto loser;</span>
<a href="#l110.721"></a><span id="l110.721">   }</span>
<a href="#l110.722"></a><span id="l110.722"> </span>
<a href="#l110.723"></a><span id="l110.723">   cinfo = NSS_CMSEnvelopedData_GetContentInfo(envd);</span>
<a href="#l110.724"></a><span id="l110.724" class="difflineminus">-  if (NSS_CMSContentInfo_SetContent_Data(m_cmsMsg, cinfo, nullptr, false) != SECSuccess) {</span>
<a href="#l110.725"></a><span id="l110.725" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't set content data\n&quot;));</span>
<a href="#l110.726"></a><span id="l110.726" class="difflineplus">+  if (NSS_CMSContentInfo_SetContent_Data(m_cmsMsg, cinfo, nullptr, false) !=</span>
<a href="#l110.727"></a><span id="l110.727" class="difflineplus">+      SECSuccess) {</span>
<a href="#l110.728"></a><span id="l110.728" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.729"></a><span id="l110.729" class="difflineplus">+            (&quot;nsCMSMessage::CreateEncrypted - can't set content data\n&quot;));</span>
<a href="#l110.730"></a><span id="l110.730">     goto loser;</span>
<a href="#l110.731"></a><span id="l110.731">   }</span>
<a href="#l110.732"></a><span id="l110.732"> </span>
<a href="#l110.733"></a><span id="l110.733">   // Create and attach recipient information //</span>
<a href="#l110.734"></a><span id="l110.734" class="difflineminus">-  for (i=0; i &lt; recipientCertCount; i++) {</span>
<a href="#l110.735"></a><span id="l110.735" class="difflineplus">+  for (i = 0; i &lt; recipientCertCount; i++) {</span>
<a href="#l110.736"></a><span id="l110.736">     UniqueCERTCertificate rc(recipientCerts.get(i));</span>
<a href="#l110.737"></a><span id="l110.737" class="difflineminus">-    if ((recipientInfo = NSS_CMSRecipientInfo_Create(m_cmsMsg, rc.get())) == nullptr) {</span>
<a href="#l110.738"></a><span id="l110.738" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't create recipient info\n&quot;));</span>
<a href="#l110.739"></a><span id="l110.739" class="difflineplus">+    if ((recipientInfo = NSS_CMSRecipientInfo_Create(m_cmsMsg, rc.get())) ==</span>
<a href="#l110.740"></a><span id="l110.740" class="difflineplus">+        nullptr) {</span>
<a href="#l110.741"></a><span id="l110.741" class="difflineplus">+      MOZ_LOG(</span>
<a href="#l110.742"></a><span id="l110.742" class="difflineplus">+          gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.743"></a><span id="l110.743" class="difflineplus">+          (&quot;nsCMSMessage::CreateEncrypted - can't create recipient info\n&quot;));</span>
<a href="#l110.744"></a><span id="l110.744">       goto loser;</span>
<a href="#l110.745"></a><span id="l110.745">     }</span>
<a href="#l110.746"></a><span id="l110.746">     if (NSS_CMSEnvelopedData_AddRecipient(envd, recipientInfo) != SECSuccess) {</span>
<a href="#l110.747"></a><span id="l110.747" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't add recipient info\n&quot;));</span>
<a href="#l110.748"></a><span id="l110.748" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.749"></a><span id="l110.749" class="difflineplus">+              (&quot;nsCMSMessage::CreateEncrypted - can't add recipient info\n&quot;));</span>
<a href="#l110.750"></a><span id="l110.750">       goto loser;</span>
<a href="#l110.751"></a><span id="l110.751">     }</span>
<a href="#l110.752"></a><span id="l110.752">   }</span>
<a href="#l110.753"></a><span id="l110.753"> </span>
<a href="#l110.754"></a><span id="l110.754">   return NS_OK;</span>
<a href="#l110.755"></a><span id="l110.755"> loser:</span>
<a href="#l110.756"></a><span id="l110.756">   if (m_cmsMsg) {</span>
<a href="#l110.757"></a><span id="l110.757">     NSS_CMSMessage_Destroy(m_cmsMsg);</span>
<a href="#l110.758"></a><span id="l110.758">     m_cmsMsg = nullptr;</span>
<a href="#l110.759"></a><span id="l110.759">   }</span>
<a href="#l110.760"></a><span id="l110.760"> </span>
<a href="#l110.761"></a><span id="l110.761">   return rv;</span>
<a href="#l110.762"></a><span id="l110.762"> }</span>
<a href="#l110.763"></a><span id="l110.763"> </span>
<a href="#l110.764"></a><span id="l110.764" class="difflineminus">-bool nsCMSMessage::IsAllowedHash(const int16_t aCryptoHashInt)</span>
<a href="#l110.765"></a><span id="l110.765" class="difflineminus">-{</span>
<a href="#l110.766"></a><span id="l110.766" class="difflineplus">+bool nsCMSMessage::IsAllowedHash(const int16_t aCryptoHashInt) {</span>
<a href="#l110.767"></a><span id="l110.767">   switch (aCryptoHashInt) {</span>
<a href="#l110.768"></a><span id="l110.768">     case nsICryptoHash::SHA1:</span>
<a href="#l110.769"></a><span id="l110.769">     case nsICryptoHash::SHA256:</span>
<a href="#l110.770"></a><span id="l110.770">     case nsICryptoHash::SHA384:</span>
<a href="#l110.771"></a><span id="l110.771">     case nsICryptoHash::SHA512:</span>
<a href="#l110.772"></a><span id="l110.772">       return true;</span>
<a href="#l110.773"></a><span id="l110.773">     default:</span>
<a href="#l110.774"></a><span id="l110.774">       return false;</span>
<a href="#l110.775"></a><span id="l110.775">   }</span>
<a href="#l110.776"></a><span id="l110.776"> }</span>
<a href="#l110.777"></a><span id="l110.777"> </span>
<a href="#l110.778"></a><span id="l110.778"> NS_IMETHODIMP</span>
<a href="#l110.779"></a><span id="l110.779" class="difflineminus">-nsCMSMessage::CreateSigned(nsIX509Cert* aSigningCert, nsIX509Cert* aEncryptCert,</span>
<a href="#l110.780"></a><span id="l110.780" class="difflineminus">-                           unsigned char* aDigestData, uint32_t aDigestDataLen,</span>
<a href="#l110.781"></a><span id="l110.781" class="difflineminus">-                           int16_t aDigestType)</span>
<a href="#l110.782"></a><span id="l110.782" class="difflineminus">-{</span>
<a href="#l110.783"></a><span id="l110.783" class="difflineplus">+nsCMSMessage::CreateSigned(nsIX509Cert *aSigningCert, nsIX509Cert *aEncryptCert,</span>
<a href="#l110.784"></a><span id="l110.784" class="difflineplus">+                           unsigned char *aDigestData, uint32_t aDigestDataLen,</span>
<a href="#l110.785"></a><span id="l110.785" class="difflineplus">+                           int16_t aDigestType) {</span>
<a href="#l110.786"></a><span id="l110.786">   NS_ENSURE_ARG(aSigningCert);</span>
<a href="#l110.787"></a><span id="l110.787">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned\n&quot;));</span>
<a href="#l110.788"></a><span id="l110.788">   NSSCMSContentInfo *cinfo;</span>
<a href="#l110.789"></a><span id="l110.789">   NSSCMSSignedData *sigd;</span>
<a href="#l110.790"></a><span id="l110.790">   NSSCMSSignerInfo *signerinfo;</span>
<a href="#l110.791"></a><span id="l110.791">   UniqueCERTCertificate scert(aSigningCert-&gt;GetCert());</span>
<a href="#l110.792"></a><span id="l110.792">   UniqueCERTCertificate ecert;</span>
<a href="#l110.793"></a><span id="l110.793">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l110.794"></a><span id="l110.794" class="difflineat">@@ -633,186 +604,195 @@ nsCMSMessage::CreateSigned(nsIX509Cert* </span>
<a href="#l110.795"></a><span id="l110.795">     return NS_ERROR_FAILURE;</span>
<a href="#l110.796"></a><span id="l110.796">   }</span>
<a href="#l110.797"></a><span id="l110.797"> </span>
<a href="#l110.798"></a><span id="l110.798">   if (aEncryptCert) {</span>
<a href="#l110.799"></a><span id="l110.799">     ecert = UniqueCERTCertificate(aEncryptCert-&gt;GetCert());</span>
<a href="#l110.800"></a><span id="l110.800">   }</span>
<a href="#l110.801"></a><span id="l110.801"> </span>
<a href="#l110.802"></a><span id="l110.802">   if (!IsAllowedHash(aDigestType)) {</span>
<a href="#l110.803"></a><span id="l110.803" class="difflineminus">-      return NS_ERROR_INVALID_ARG;</span>
<a href="#l110.804"></a><span id="l110.804" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l110.805"></a><span id="l110.805">   }</span>
<a href="#l110.806"></a><span id="l110.806"> </span>
<a href="#l110.807"></a><span id="l110.807" class="difflineminus">-  SECOidTag digestType = HASH_GetHashOidTagByHashType(static_cast&lt;HASH_HashType&gt;(aDigestType));</span>
<a href="#l110.808"></a><span id="l110.808" class="difflineplus">+  SECOidTag digestType =</span>
<a href="#l110.809"></a><span id="l110.809" class="difflineplus">+      HASH_GetHashOidTagByHashType(static_cast&lt;HASH_HashType&gt;(aDigestType));</span>
<a href="#l110.810"></a><span id="l110.810">   if (digestType == SEC_OID_UNKNOWN) {</span>
<a href="#l110.811"></a><span id="l110.811" class="difflineminus">-      return NS_ERROR_INVALID_ARG;</span>
<a href="#l110.812"></a><span id="l110.812" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l110.813"></a><span id="l110.813">   }</span>
<a href="#l110.814"></a><span id="l110.814"> </span>
<a href="#l110.815"></a><span id="l110.815">   /*</span>
<a href="#l110.816"></a><span id="l110.816">    * create the message object</span>
<a href="#l110.817"></a><span id="l110.817">    */</span>
<a href="#l110.818"></a><span id="l110.818" class="difflineminus">-  m_cmsMsg = NSS_CMSMessage_Create(nullptr); /* create a message on its own pool */</span>
<a href="#l110.819"></a><span id="l110.819" class="difflineplus">+  m_cmsMsg =</span>
<a href="#l110.820"></a><span id="l110.820" class="difflineplus">+      NSS_CMSMessage_Create(nullptr); /* create a message on its own pool */</span>
<a href="#l110.821"></a><span id="l110.821">   if (!m_cmsMsg) {</span>
<a href="#l110.822"></a><span id="l110.822" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't create new message\n&quot;));</span>
<a href="#l110.823"></a><span id="l110.823" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.824"></a><span id="l110.824" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't create new message\n&quot;));</span>
<a href="#l110.825"></a><span id="l110.825">     rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l110.826"></a><span id="l110.826">     goto loser;</span>
<a href="#l110.827"></a><span id="l110.827">   }</span>
<a href="#l110.828"></a><span id="l110.828"> </span>
<a href="#l110.829"></a><span id="l110.829">   /*</span>
<a href="#l110.830"></a><span id="l110.830">    * build chain of objects: message-&gt;signedData-&gt;data</span>
<a href="#l110.831"></a><span id="l110.831">    */</span>
<a href="#l110.832"></a><span id="l110.832">   if ((sigd = NSS_CMSSignedData_Create(m_cmsMsg)) == nullptr) {</span>
<a href="#l110.833"></a><span id="l110.833" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't create signed data\n&quot;));</span>
<a href="#l110.834"></a><span id="l110.834" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.835"></a><span id="l110.835" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't create signed data\n&quot;));</span>
<a href="#l110.836"></a><span id="l110.836">     goto loser;</span>
<a href="#l110.837"></a><span id="l110.837">   }</span>
<a href="#l110.838"></a><span id="l110.838">   cinfo = NSS_CMSMessage_GetContentInfo(m_cmsMsg);</span>
<a href="#l110.839"></a><span id="l110.839" class="difflineminus">-  if (NSS_CMSContentInfo_SetContent_SignedData(m_cmsMsg, cinfo, sigd)</span>
<a href="#l110.840"></a><span id="l110.840" class="difflineminus">-          != SECSuccess) {</span>
<a href="#l110.841"></a><span id="l110.841" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't set content signed data\n&quot;));</span>
<a href="#l110.842"></a><span id="l110.842" class="difflineplus">+  if (NSS_CMSContentInfo_SetContent_SignedData(m_cmsMsg, cinfo, sigd) !=</span>
<a href="#l110.843"></a><span id="l110.843" class="difflineplus">+      SECSuccess) {</span>
<a href="#l110.844"></a><span id="l110.844" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.845"></a><span id="l110.845" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't set content signed data\n&quot;));</span>
<a href="#l110.846"></a><span id="l110.846">     goto loser;</span>
<a href="#l110.847"></a><span id="l110.847">   }</span>
<a href="#l110.848"></a><span id="l110.848"> </span>
<a href="#l110.849"></a><span id="l110.849">   cinfo = NSS_CMSSignedData_GetContentInfo(sigd);</span>
<a href="#l110.850"></a><span id="l110.850"> </span>
<a href="#l110.851"></a><span id="l110.851">   /* we're always passing data in and detaching optionally */</span>
<a href="#l110.852"></a><span id="l110.852" class="difflineminus">-  if (NSS_CMSContentInfo_SetContent_Data(m_cmsMsg, cinfo, nullptr, true)</span>
<a href="#l110.853"></a><span id="l110.853" class="difflineminus">-          != SECSuccess) {</span>
<a href="#l110.854"></a><span id="l110.854" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't set content data\n&quot;));</span>
<a href="#l110.855"></a><span id="l110.855" class="difflineplus">+  if (NSS_CMSContentInfo_SetContent_Data(m_cmsMsg, cinfo, nullptr, true) !=</span>
<a href="#l110.856"></a><span id="l110.856" class="difflineplus">+      SECSuccess) {</span>
<a href="#l110.857"></a><span id="l110.857" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.858"></a><span id="l110.858" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't set content data\n&quot;));</span>
<a href="#l110.859"></a><span id="l110.859">     goto loser;</span>
<a href="#l110.860"></a><span id="l110.860">   }</span>
<a href="#l110.861"></a><span id="l110.861"> </span>
<a href="#l110.862"></a><span id="l110.862">   /*</span>
<a href="#l110.863"></a><span id="l110.863">    * create &amp; attach signer information</span>
<a href="#l110.864"></a><span id="l110.864">    */</span>
<a href="#l110.865"></a><span id="l110.865">   signerinfo = NSS_CMSSignerInfo_Create(m_cmsMsg, scert.get(), digestType);</span>
<a href="#l110.866"></a><span id="l110.866">   if (!signerinfo) {</span>
<a href="#l110.867"></a><span id="l110.867" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't create signer info\n&quot;));</span>
<a href="#l110.868"></a><span id="l110.868" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.869"></a><span id="l110.869" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't create signer info\n&quot;));</span>
<a href="#l110.870"></a><span id="l110.870">     goto loser;</span>
<a href="#l110.871"></a><span id="l110.871">   }</span>
<a href="#l110.872"></a><span id="l110.872"> </span>
<a href="#l110.873"></a><span id="l110.873">   /* we want the cert chain included for this one */</span>
<a href="#l110.874"></a><span id="l110.874">   if (NSS_CMSSignerInfo_IncludeCerts(signerinfo, NSSCMSCM_CertChain,</span>
<a href="#l110.875"></a><span id="l110.875">                                      certUsageEmailSigner) != SECSuccess) {</span>
<a href="#l110.876"></a><span id="l110.876" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't include signer cert chain\n&quot;));</span>
<a href="#l110.877"></a><span id="l110.877" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.878"></a><span id="l110.878" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't include signer cert chain\n&quot;));</span>
<a href="#l110.879"></a><span id="l110.879">     goto loser;</span>
<a href="#l110.880"></a><span id="l110.880">   }</span>
<a href="#l110.881"></a><span id="l110.881"> </span>
<a href="#l110.882"></a><span id="l110.882">   if (NSS_CMSSignerInfo_AddSigningTime(signerinfo, PR_Now()) != SECSuccess) {</span>
<a href="#l110.883"></a><span id="l110.883" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't add signing time\n&quot;));</span>
<a href="#l110.884"></a><span id="l110.884" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.885"></a><span id="l110.885" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't add signing time\n&quot;));</span>
<a href="#l110.886"></a><span id="l110.886">     goto loser;</span>
<a href="#l110.887"></a><span id="l110.887">   }</span>
<a href="#l110.888"></a><span id="l110.888"> </span>
<a href="#l110.889"></a><span id="l110.889">   if (NSS_CMSSignerInfo_AddSMIMECaps(signerinfo) != SECSuccess) {</span>
<a href="#l110.890"></a><span id="l110.890" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't add smime caps\n&quot;));</span>
<a href="#l110.891"></a><span id="l110.891" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.892"></a><span id="l110.892" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't add smime caps\n&quot;));</span>
<a href="#l110.893"></a><span id="l110.893">     goto loser;</span>
<a href="#l110.894"></a><span id="l110.894">   }</span>
<a href="#l110.895"></a><span id="l110.895"> </span>
<a href="#l110.896"></a><span id="l110.896">   if (ecert) {</span>
<a href="#l110.897"></a><span id="l110.897" class="difflineminus">-    if (NSS_CMSSignerInfo_AddSMIMEEncKeyPrefs(signerinfo, ecert.get(),</span>
<a href="#l110.898"></a><span id="l110.898" class="difflineminus">-                                              CERT_GetDefaultCertDB()) != SECSuccess) {</span>
<a href="#l110.899"></a><span id="l110.899" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't add smime enc key prefs\n&quot;));</span>
<a href="#l110.900"></a><span id="l110.900" class="difflineplus">+    if (NSS_CMSSignerInfo_AddSMIMEEncKeyPrefs(</span>
<a href="#l110.901"></a><span id="l110.901" class="difflineplus">+            signerinfo, ecert.get(), CERT_GetDefaultCertDB()) != SECSuccess) {</span>
<a href="#l110.902"></a><span id="l110.902" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.903"></a><span id="l110.903" class="difflineplus">+              (&quot;nsCMSMessage::CreateSigned - can't add smime enc key prefs\n&quot;));</span>
<a href="#l110.904"></a><span id="l110.904">       goto loser;</span>
<a href="#l110.905"></a><span id="l110.905">     }</span>
<a href="#l110.906"></a><span id="l110.906"> </span>
<a href="#l110.907"></a><span id="l110.907" class="difflineminus">-    if (NSS_CMSSignerInfo_AddMSSMIMEEncKeyPrefs(signerinfo, ecert.get(),</span>
<a href="#l110.908"></a><span id="l110.908" class="difflineminus">-                                                CERT_GetDefaultCertDB()) != SECSuccess) {</span>
<a href="#l110.909"></a><span id="l110.909" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't add MS smime enc key prefs\n&quot;));</span>
<a href="#l110.910"></a><span id="l110.910" class="difflineplus">+    if (NSS_CMSSignerInfo_AddMSSMIMEEncKeyPrefs(</span>
<a href="#l110.911"></a><span id="l110.911" class="difflineplus">+            signerinfo, ecert.get(), CERT_GetDefaultCertDB()) != SECSuccess) {</span>
<a href="#l110.912"></a><span id="l110.912" class="difflineplus">+      MOZ_LOG(</span>
<a href="#l110.913"></a><span id="l110.913" class="difflineplus">+          gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.914"></a><span id="l110.914" class="difflineplus">+          (&quot;nsCMSMessage::CreateSigned - can't add MS smime enc key prefs\n&quot;));</span>
<a href="#l110.915"></a><span id="l110.915">       goto loser;</span>
<a href="#l110.916"></a><span id="l110.916">     }</span>
<a href="#l110.917"></a><span id="l110.917"> </span>
<a href="#l110.918"></a><span id="l110.918">     // If signing and encryption cert are identical, don't add it twice.</span>
<a href="#l110.919"></a><span id="l110.919">     bool addEncryptionCert =</span>
<a href="#l110.920"></a><span id="l110.920" class="difflineminus">-      (ecert &amp;&amp; (!scert || !CERT_CompareCerts(ecert.get(), scert.get())));</span>
<a href="#l110.921"></a><span id="l110.921" class="difflineplus">+        (ecert &amp;&amp; (!scert || !CERT_CompareCerts(ecert.get(), scert.get())));</span>
<a href="#l110.922"></a><span id="l110.922"> </span>
<a href="#l110.923"></a><span id="l110.923">     if (addEncryptionCert &amp;&amp;</span>
<a href="#l110.924"></a><span id="l110.924">         NSS_CMSSignedData_AddCertificate(sigd, ecert.get()) != SECSuccess) {</span>
<a href="#l110.925"></a><span id="l110.925" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't add own encryption certificate\n&quot;));</span>
<a href="#l110.926"></a><span id="l110.926" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.927"></a><span id="l110.927" class="difflineplus">+              (&quot;nsCMSMessage::CreateSigned - can't add own encryption &quot;</span>
<a href="#l110.928"></a><span id="l110.928" class="difflineplus">+               &quot;certificate\n&quot;));</span>
<a href="#l110.929"></a><span id="l110.929">       goto loser;</span>
<a href="#l110.930"></a><span id="l110.930">     }</span>
<a href="#l110.931"></a><span id="l110.931">   }</span>
<a href="#l110.932"></a><span id="l110.932"> </span>
<a href="#l110.933"></a><span id="l110.933">   if (NSS_CMSSignedData_AddSignerInfo(sigd, signerinfo) != SECSuccess) {</span>
<a href="#l110.934"></a><span id="l110.934" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't add signer info\n&quot;));</span>
<a href="#l110.935"></a><span id="l110.935" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.936"></a><span id="l110.936" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't add signer info\n&quot;));</span>
<a href="#l110.937"></a><span id="l110.937">     goto loser;</span>
<a href="#l110.938"></a><span id="l110.938">   }</span>
<a href="#l110.939"></a><span id="l110.939"> </span>
<a href="#l110.940"></a><span id="l110.940">   // Finally, add the pre-computed digest if passed in</span>
<a href="#l110.941"></a><span id="l110.941">   if (aDigestData) {</span>
<a href="#l110.942"></a><span id="l110.942">     SECItem digest;</span>
<a href="#l110.943"></a><span id="l110.943"> </span>
<a href="#l110.944"></a><span id="l110.944">     digest.data = aDigestData;</span>
<a href="#l110.945"></a><span id="l110.945">     digest.len = aDigestDataLen;</span>
<a href="#l110.946"></a><span id="l110.946"> </span>
<a href="#l110.947"></a><span id="l110.947" class="difflineminus">-    if (NSS_CMSSignedData_SetDigestValue(sigd, digestType, &amp;digest) != SECSuccess) {</span>
<a href="#l110.948"></a><span id="l110.948" class="difflineminus">-      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't set digest value\n&quot;));</span>
<a href="#l110.949"></a><span id="l110.949" class="difflineplus">+    if (NSS_CMSSignedData_SetDigestValue(sigd, digestType, &amp;digest) !=</span>
<a href="#l110.950"></a><span id="l110.950" class="difflineplus">+        SECSuccess) {</span>
<a href="#l110.951"></a><span id="l110.951" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.952"></a><span id="l110.952" class="difflineplus">+              (&quot;nsCMSMessage::CreateSigned - can't set digest value\n&quot;));</span>
<a href="#l110.953"></a><span id="l110.953">       goto loser;</span>
<a href="#l110.954"></a><span id="l110.954">     }</span>
<a href="#l110.955"></a><span id="l110.955">   }</span>
<a href="#l110.956"></a><span id="l110.956"> </span>
<a href="#l110.957"></a><span id="l110.957">   return NS_OK;</span>
<a href="#l110.958"></a><span id="l110.958"> loser:</span>
<a href="#l110.959"></a><span id="l110.959">   if (m_cmsMsg) {</span>
<a href="#l110.960"></a><span id="l110.960">     NSS_CMSMessage_Destroy(m_cmsMsg);</span>
<a href="#l110.961"></a><span id="l110.961">     m_cmsMsg = nullptr;</span>
<a href="#l110.962"></a><span id="l110.962">   }</span>
<a href="#l110.963"></a><span id="l110.963">   return rv;</span>
<a href="#l110.964"></a><span id="l110.964"> }</span>
<a href="#l110.965"></a><span id="l110.965"> </span>
<a href="#l110.966"></a><span id="l110.966"> NS_IMPL_ISUPPORTS(nsCMSDecoder, nsICMSDecoder)</span>
<a href="#l110.967"></a><span id="l110.967"> </span>
<a href="#l110.968"></a><span id="l110.968" class="difflineminus">-nsCMSDecoder::nsCMSDecoder()</span>
<a href="#l110.969"></a><span id="l110.969" class="difflineminus">-: m_dcx(nullptr)</span>
<a href="#l110.970"></a><span id="l110.970" class="difflineminus">-{</span>
<a href="#l110.971"></a><span id="l110.971" class="difflineminus">-}</span>
<a href="#l110.972"></a><span id="l110.972" class="difflineplus">+nsCMSDecoder::nsCMSDecoder() : m_dcx(nullptr) {}</span>
<a href="#l110.973"></a><span id="l110.973" class="difflineplus">+</span>
<a href="#l110.974"></a><span id="l110.974" class="difflineplus">+nsCMSDecoder::~nsCMSDecoder() { destructorSafeDestroyNSSReference(); }</span>
<a href="#l110.975"></a><span id="l110.975"> </span>
<a href="#l110.976"></a><span id="l110.976" class="difflineminus">-nsCMSDecoder::~nsCMSDecoder()</span>
<a href="#l110.977"></a><span id="l110.977" class="difflineminus">-{</span>
<a href="#l110.978"></a><span id="l110.978" class="difflineminus">-  destructorSafeDestroyNSSReference();</span>
<a href="#l110.979"></a><span id="l110.979" class="difflineminus">-}</span>
<a href="#l110.980"></a><span id="l110.980" class="difflineminus">-</span>
<a href="#l110.981"></a><span id="l110.981" class="difflineminus">-nsresult nsCMSDecoder::Init()</span>
<a href="#l110.982"></a><span id="l110.982" class="difflineminus">-{</span>
<a href="#l110.983"></a><span id="l110.983" class="difflineplus">+nsresult nsCMSDecoder::Init() {</span>
<a href="#l110.984"></a><span id="l110.984">   nsresult rv;</span>
<a href="#l110.985"></a><span id="l110.985" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; nssInitialized = do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l110.986"></a><span id="l110.986" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; nssInitialized =</span>
<a href="#l110.987"></a><span id="l110.987" class="difflineplus">+      do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l110.988"></a><span id="l110.988">   return rv;</span>
<a href="#l110.989"></a><span id="l110.989"> }</span>
<a href="#l110.990"></a><span id="l110.990"> </span>
<a href="#l110.991"></a><span id="l110.991" class="difflineminus">-void nsCMSDecoder::destructorSafeDestroyNSSReference()</span>
<a href="#l110.992"></a><span id="l110.992" class="difflineminus">-{</span>
<a href="#l110.993"></a><span id="l110.993" class="difflineplus">+void nsCMSDecoder::destructorSafeDestroyNSSReference() {</span>
<a href="#l110.994"></a><span id="l110.994">   if (m_dcx) {</span>
<a href="#l110.995"></a><span id="l110.995">     NSS_CMSDecoder_Cancel(m_dcx);</span>
<a href="#l110.996"></a><span id="l110.996">     m_dcx = nullptr;</span>
<a href="#l110.997"></a><span id="l110.997">   }</span>
<a href="#l110.998"></a><span id="l110.998"> }</span>
<a href="#l110.999"></a><span id="l110.999"> </span>
<a href="#l110.1000"></a><span id="l110.1000"> /* void start (in NSSCMSContentCallback cb, in voidPtr arg); */</span>
<a href="#l110.1001"></a><span id="l110.1001" class="difflineminus">-NS_IMETHODIMP nsCMSDecoder::Start(NSSCMSContentCallback cb, void * arg)</span>
<a href="#l110.1002"></a><span id="l110.1002" class="difflineminus">-{</span>
<a href="#l110.1003"></a><span id="l110.1003" class="difflineplus">+NS_IMETHODIMP nsCMSDecoder::Start(NSSCMSContentCallback cb, void *arg) {</span>
<a href="#l110.1004"></a><span id="l110.1004">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Start\n&quot;));</span>
<a href="#l110.1005"></a><span id="l110.1005">   m_ctx = new PipUIContext();</span>
<a href="#l110.1006"></a><span id="l110.1006"> </span>
<a href="#l110.1007"></a><span id="l110.1007">   m_dcx = NSS_CMSDecoder_Start(0, cb, arg, 0, m_ctx, 0, 0);</span>
<a href="#l110.1008"></a><span id="l110.1008">   if (!m_dcx) {</span>
<a href="#l110.1009"></a><span id="l110.1009" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Start - can't start decoder\n&quot;));</span>
<a href="#l110.1010"></a><span id="l110.1010" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.1011"></a><span id="l110.1011" class="difflineplus">+            (&quot;nsCMSDecoder::Start - can't start decoder\n&quot;));</span>
<a href="#l110.1012"></a><span id="l110.1012">     return NS_ERROR_FAILURE;</span>
<a href="#l110.1013"></a><span id="l110.1013">   }</span>
<a href="#l110.1014"></a><span id="l110.1014">   return NS_OK;</span>
<a href="#l110.1015"></a><span id="l110.1015"> }</span>
<a href="#l110.1016"></a><span id="l110.1016"> </span>
<a href="#l110.1017"></a><span id="l110.1017"> /* void update (in string bug, in long len); */</span>
<a href="#l110.1018"></a><span id="l110.1018" class="difflineminus">-NS_IMETHODIMP nsCMSDecoder::Update(const char *buf, int32_t len)</span>
<a href="#l110.1019"></a><span id="l110.1019" class="difflineminus">-{</span>
<a href="#l110.1020"></a><span id="l110.1020" class="difflineplus">+NS_IMETHODIMP nsCMSDecoder::Update(const char *buf, int32_t len) {</span>
<a href="#l110.1021"></a><span id="l110.1021">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Update\n&quot;));</span>
<a href="#l110.1022"></a><span id="l110.1022">   NSS_CMSDecoder_Update(m_dcx, (char *)buf, len);</span>
<a href="#l110.1023"></a><span id="l110.1023">   return NS_OK;</span>
<a href="#l110.1024"></a><span id="l110.1024"> }</span>
<a href="#l110.1025"></a><span id="l110.1025"> </span>
<a href="#l110.1026"></a><span id="l110.1026"> /* void finish (); */</span>
<a href="#l110.1027"></a><span id="l110.1027" class="difflineminus">-NS_IMETHODIMP nsCMSDecoder::Finish(nsICMSMessage ** aCMSMsg)</span>
<a href="#l110.1028"></a><span id="l110.1028" class="difflineminus">-{</span>
<a href="#l110.1029"></a><span id="l110.1029" class="difflineplus">+NS_IMETHODIMP nsCMSDecoder::Finish(nsICMSMessage **aCMSMsg) {</span>
<a href="#l110.1030"></a><span id="l110.1030">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Finish\n&quot;));</span>
<a href="#l110.1031"></a><span id="l110.1031">   NSSCMSMessage *cmsMsg;</span>
<a href="#l110.1032"></a><span id="l110.1032">   cmsMsg = NSS_CMSDecoder_Finish(m_dcx);</span>
<a href="#l110.1033"></a><span id="l110.1033">   m_dcx = nullptr;</span>
<a href="#l110.1034"></a><span id="l110.1034">   if (cmsMsg) {</span>
<a href="#l110.1035"></a><span id="l110.1035">     nsCMSMessage *obj = new nsCMSMessage(cmsMsg);</span>
<a href="#l110.1036"></a><span id="l110.1036">     // The NSS object cmsMsg still carries a reference to the context</span>
<a href="#l110.1037"></a><span id="l110.1037">     // we gave it on construction.</span>
<a href="#l110.1038"></a><span id="l110.1038" class="difflineat">@@ -820,76 +800,69 @@ NS_IMETHODIMP nsCMSDecoder::Finish(nsICM</span>
<a href="#l110.1039"></a><span id="l110.1039">     obj-&gt;referenceContext(m_ctx);</span>
<a href="#l110.1040"></a><span id="l110.1040">     NS_ADDREF(*aCMSMsg = obj);</span>
<a href="#l110.1041"></a><span id="l110.1041">   }</span>
<a href="#l110.1042"></a><span id="l110.1042">   return NS_OK;</span>
<a href="#l110.1043"></a><span id="l110.1043"> }</span>
<a href="#l110.1044"></a><span id="l110.1044"> </span>
<a href="#l110.1045"></a><span id="l110.1045"> NS_IMPL_ISUPPORTS(nsCMSEncoder, nsICMSEncoder)</span>
<a href="#l110.1046"></a><span id="l110.1046"> </span>
<a href="#l110.1047"></a><span id="l110.1047" class="difflineminus">-nsCMSEncoder::nsCMSEncoder()</span>
<a href="#l110.1048"></a><span id="l110.1048" class="difflineminus">-: m_ecx(nullptr)</span>
<a href="#l110.1049"></a><span id="l110.1049" class="difflineminus">-{</span>
<a href="#l110.1050"></a><span id="l110.1050" class="difflineminus">-}</span>
<a href="#l110.1051"></a><span id="l110.1051" class="difflineplus">+nsCMSEncoder::nsCMSEncoder() : m_ecx(nullptr) {}</span>
<a href="#l110.1052"></a><span id="l110.1052" class="difflineplus">+</span>
<a href="#l110.1053"></a><span id="l110.1053" class="difflineplus">+nsCMSEncoder::~nsCMSEncoder() { destructorSafeDestroyNSSReference(); }</span>
<a href="#l110.1054"></a><span id="l110.1054"> </span>
<a href="#l110.1055"></a><span id="l110.1055" class="difflineminus">-nsCMSEncoder::~nsCMSEncoder()</span>
<a href="#l110.1056"></a><span id="l110.1056" class="difflineminus">-{</span>
<a href="#l110.1057"></a><span id="l110.1057" class="difflineminus">-  destructorSafeDestroyNSSReference();</span>
<a href="#l110.1058"></a><span id="l110.1058" class="difflineminus">-}</span>
<a href="#l110.1059"></a><span id="l110.1059" class="difflineminus">-</span>
<a href="#l110.1060"></a><span id="l110.1060" class="difflineminus">-nsresult nsCMSEncoder::Init()</span>
<a href="#l110.1061"></a><span id="l110.1061" class="difflineminus">-{</span>
<a href="#l110.1062"></a><span id="l110.1062" class="difflineplus">+nsresult nsCMSEncoder::Init() {</span>
<a href="#l110.1063"></a><span id="l110.1063">   nsresult rv;</span>
<a href="#l110.1064"></a><span id="l110.1064" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; nssInitialized = do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l110.1065"></a><span id="l110.1065" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; nssInitialized =</span>
<a href="#l110.1066"></a><span id="l110.1066" class="difflineplus">+      do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l110.1067"></a><span id="l110.1067">   return rv;</span>
<a href="#l110.1068"></a><span id="l110.1068"> }</span>
<a href="#l110.1069"></a><span id="l110.1069"> </span>
<a href="#l110.1070"></a><span id="l110.1070" class="difflineminus">-void nsCMSEncoder::destructorSafeDestroyNSSReference()</span>
<a href="#l110.1071"></a><span id="l110.1071" class="difflineminus">-{</span>
<a href="#l110.1072"></a><span id="l110.1072" class="difflineminus">-  if (m_ecx)</span>
<a href="#l110.1073"></a><span id="l110.1073" class="difflineminus">-    NSS_CMSEncoder_Cancel(m_ecx);</span>
<a href="#l110.1074"></a><span id="l110.1074" class="difflineplus">+void nsCMSEncoder::destructorSafeDestroyNSSReference() {</span>
<a href="#l110.1075"></a><span id="l110.1075" class="difflineplus">+  if (m_ecx) NSS_CMSEncoder_Cancel(m_ecx);</span>
<a href="#l110.1076"></a><span id="l110.1076"> }</span>
<a href="#l110.1077"></a><span id="l110.1077"> </span>
<a href="#l110.1078"></a><span id="l110.1078"> /* void start (); */</span>
<a href="#l110.1079"></a><span id="l110.1079" class="difflineminus">-NS_IMETHODIMP nsCMSEncoder::Start(nsICMSMessage *aMsg, NSSCMSContentCallback cb, void * arg)</span>
<a href="#l110.1080"></a><span id="l110.1080" class="difflineminus">-{</span>
<a href="#l110.1081"></a><span id="l110.1081" class="difflineplus">+NS_IMETHODIMP nsCMSEncoder::Start(nsICMSMessage *aMsg, NSSCMSContentCallback cb,</span>
<a href="#l110.1082"></a><span id="l110.1082" class="difflineplus">+                                  void *arg) {</span>
<a href="#l110.1083"></a><span id="l110.1083">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Start\n&quot;));</span>
<a href="#l110.1084"></a><span id="l110.1084" class="difflineminus">-  nsCMSMessage *cmsMsg = static_cast&lt;nsCMSMessage*&gt;(aMsg);</span>
<a href="#l110.1085"></a><span id="l110.1085" class="difflineplus">+  nsCMSMessage *cmsMsg = static_cast&lt;nsCMSMessage *&gt;(aMsg);</span>
<a href="#l110.1086"></a><span id="l110.1086">   m_ctx = new PipUIContext();</span>
<a href="#l110.1087"></a><span id="l110.1087"> </span>
<a href="#l110.1088"></a><span id="l110.1088" class="difflineminus">-  m_ecx = NSS_CMSEncoder_Start(cmsMsg-&gt;getCMS(), cb, arg, 0, 0, 0, m_ctx, 0, 0, 0, 0);</span>
<a href="#l110.1089"></a><span id="l110.1089" class="difflineplus">+  m_ecx = NSS_CMSEncoder_Start(cmsMsg-&gt;getCMS(), cb, arg, 0, 0, 0, m_ctx, 0, 0,</span>
<a href="#l110.1090"></a><span id="l110.1090" class="difflineplus">+                               0, 0);</span>
<a href="#l110.1091"></a><span id="l110.1091">   if (!m_ecx) {</span>
<a href="#l110.1092"></a><span id="l110.1092" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Start - can't start encoder\n&quot;));</span>
<a href="#l110.1093"></a><span id="l110.1093" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.1094"></a><span id="l110.1094" class="difflineplus">+            (&quot;nsCMSEncoder::Start - can't start encoder\n&quot;));</span>
<a href="#l110.1095"></a><span id="l110.1095">     return NS_ERROR_FAILURE;</span>
<a href="#l110.1096"></a><span id="l110.1096">   }</span>
<a href="#l110.1097"></a><span id="l110.1097">   return NS_OK;</span>
<a href="#l110.1098"></a><span id="l110.1098"> }</span>
<a href="#l110.1099"></a><span id="l110.1099"> </span>
<a href="#l110.1100"></a><span id="l110.1100"> /* void update (in string aBuf, in long aLen); */</span>
<a href="#l110.1101"></a><span id="l110.1101" class="difflineminus">-NS_IMETHODIMP nsCMSEncoder::Update(const char *aBuf, int32_t aLen)</span>
<a href="#l110.1102"></a><span id="l110.1102" class="difflineminus">-{</span>
<a href="#l110.1103"></a><span id="l110.1103" class="difflineplus">+NS_IMETHODIMP nsCMSEncoder::Update(const char *aBuf, int32_t aLen) {</span>
<a href="#l110.1104"></a><span id="l110.1104">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Update\n&quot;));</span>
<a href="#l110.1105"></a><span id="l110.1105">   if (!m_ecx || NSS_CMSEncoder_Update(m_ecx, aBuf, aLen) != SECSuccess) {</span>
<a href="#l110.1106"></a><span id="l110.1106" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Update - can't update encoder\n&quot;));</span>
<a href="#l110.1107"></a><span id="l110.1107" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.1108"></a><span id="l110.1108" class="difflineplus">+            (&quot;nsCMSEncoder::Update - can't update encoder\n&quot;));</span>
<a href="#l110.1109"></a><span id="l110.1109">     return NS_ERROR_FAILURE;</span>
<a href="#l110.1110"></a><span id="l110.1110">   }</span>
<a href="#l110.1111"></a><span id="l110.1111">   return NS_OK;</span>
<a href="#l110.1112"></a><span id="l110.1112"> }</span>
<a href="#l110.1113"></a><span id="l110.1113"> </span>
<a href="#l110.1114"></a><span id="l110.1114"> /* void finish (); */</span>
<a href="#l110.1115"></a><span id="l110.1115" class="difflineminus">-NS_IMETHODIMP nsCMSEncoder::Finish()</span>
<a href="#l110.1116"></a><span id="l110.1116" class="difflineminus">-{</span>
<a href="#l110.1117"></a><span id="l110.1117" class="difflineplus">+NS_IMETHODIMP nsCMSEncoder::Finish() {</span>
<a href="#l110.1118"></a><span id="l110.1118">   nsresult rv = NS_OK;</span>
<a href="#l110.1119"></a><span id="l110.1119">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Finish\n&quot;));</span>
<a href="#l110.1120"></a><span id="l110.1120">   if (!m_ecx || NSS_CMSEncoder_Finish(m_ecx) != SECSuccess) {</span>
<a href="#l110.1121"></a><span id="l110.1121" class="difflineminus">-    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Finish - can't finish encoder\n&quot;));</span>
<a href="#l110.1122"></a><span id="l110.1122" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l110.1123"></a><span id="l110.1123" class="difflineplus">+            (&quot;nsCMSEncoder::Finish - can't finish encoder\n&quot;));</span>
<a href="#l110.1124"></a><span id="l110.1124">     rv = NS_ERROR_FAILURE;</span>
<a href="#l110.1125"></a><span id="l110.1125">   }</span>
<a href="#l110.1126"></a><span id="l110.1126">   m_ecx = nullptr;</span>
<a href="#l110.1127"></a><span id="l110.1127">   return rv;</span>
<a href="#l110.1128"></a><span id="l110.1128"> }</span>
<a href="#l110.1129"></a><span id="l110.1129"> </span>
<a href="#l110.1130"></a><span id="l110.1130"> /* void encode (in nsICMSMessage aMsg); */</span>
<a href="#l110.1131"></a><span id="l110.1131" class="difflineminus">-NS_IMETHODIMP nsCMSEncoder::Encode(nsICMSMessage *aMsg)</span>
<a href="#l110.1132"></a><span id="l110.1132" class="difflineminus">-{</span>
<a href="#l110.1133"></a><span id="l110.1133" class="difflineplus">+NS_IMETHODIMP nsCMSEncoder::Encode(nsICMSMessage *aMsg) {</span>
<a href="#l110.1134"></a><span id="l110.1134">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Encode\n&quot;));</span>
<a href="#l110.1135"></a><span id="l110.1135">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l110.1136"></a><span id="l110.1136"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l111.1"></a><span id="l111.1" class="difflineminus">--- a/mailnews/mime/src/nsCMS.h</span>
<a href="#l111.2"></a><span id="l111.2" class="difflineplus">+++ b/mailnews/mime/src/nsCMS.h</span>
<a href="#l111.3"></a><span id="l111.3" class="difflineat">@@ -10,86 +10,96 @@</span>
<a href="#l111.4"></a><span id="l111.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l111.5"></a><span id="l111.5"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l111.6"></a><span id="l111.6"> #include &quot;nsICMSMessage.h&quot;</span>
<a href="#l111.7"></a><span id="l111.7"> #include &quot;nsICMSEncoder.h&quot;</span>
<a href="#l111.8"></a><span id="l111.8"> #include &quot;nsICMSDecoder.h&quot;</span>
<a href="#l111.9"></a><span id="l111.9"> #include &quot;sechash.h&quot;</span>
<a href="#l111.10"></a><span id="l111.10"> #include &quot;cms.h&quot;</span>
<a href="#l111.11"></a><span id="l111.11"> </span>
<a href="#l111.12"></a><span id="l111.12" class="difflineminus">-#define NS_CMSMESSAGE_CID \</span>
<a href="#l111.13"></a><span id="l111.13" class="difflineminus">-  { 0xa4557478, 0xae16, 0x11d5, { 0xba,0x4b,0x00,0x10,0x83,0x03,0xb1,0x17 } }</span>
<a href="#l111.14"></a><span id="l111.14" class="difflineplus">+#define NS_CMSMESSAGE_CID                            \</span>
<a href="#l111.15"></a><span id="l111.15" class="difflineplus">+  {                                                  \</span>
<a href="#l111.16"></a><span id="l111.16" class="difflineplus">+    0xa4557478, 0xae16, 0x11d5, {                    \</span>
<a href="#l111.17"></a><span id="l111.17" class="difflineplus">+      0xba, 0x4b, 0x00, 0x10, 0x83, 0x03, 0xb1, 0x17 \</span>
<a href="#l111.18"></a><span id="l111.18" class="difflineplus">+    }                                                \</span>
<a href="#l111.19"></a><span id="l111.19" class="difflineplus">+  }</span>
<a href="#l111.20"></a><span id="l111.20"> </span>
<a href="#l111.21"></a><span id="l111.21" class="difflineminus">-class nsCMSMessage : public nsICMSMessage</span>
<a href="#l111.22"></a><span id="l111.22" class="difflineminus">-{</span>
<a href="#l111.23"></a><span id="l111.23" class="difflineminus">-public:</span>
<a href="#l111.24"></a><span id="l111.24" class="difflineplus">+class nsCMSMessage : public nsICMSMessage {</span>
<a href="#l111.25"></a><span id="l111.25" class="difflineplus">+ public:</span>
<a href="#l111.26"></a><span id="l111.26">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l111.27"></a><span id="l111.27">   NS_DECL_NSICMSMESSAGE</span>
<a href="#l111.28"></a><span id="l111.28"> </span>
<a href="#l111.29"></a><span id="l111.29">   nsCMSMessage();</span>
<a href="#l111.30"></a><span id="l111.30">   explicit nsCMSMessage(NSSCMSMessage* aCMSMsg);</span>
<a href="#l111.31"></a><span id="l111.31">   nsresult Init();</span>
<a href="#l111.32"></a><span id="l111.32"> </span>
<a href="#l111.33"></a><span id="l111.33" class="difflineminus">-  void referenceContext(nsIInterfaceRequestor* aContext) {m_ctx = aContext;}</span>
<a href="#l111.34"></a><span id="l111.34" class="difflineminus">-  NSSCMSMessage* getCMS() {return m_cmsMsg;}</span>
<a href="#l111.35"></a><span id="l111.35" class="difflineminus">-private:</span>
<a href="#l111.36"></a><span id="l111.36" class="difflineplus">+  void referenceContext(nsIInterfaceRequestor* aContext) { m_ctx = aContext; }</span>
<a href="#l111.37"></a><span id="l111.37" class="difflineplus">+  NSSCMSMessage* getCMS() { return m_cmsMsg; }</span>
<a href="#l111.38"></a><span id="l111.38" class="difflineplus">+</span>
<a href="#l111.39"></a><span id="l111.39" class="difflineplus">+ private:</span>
<a href="#l111.40"></a><span id="l111.40">   virtual ~nsCMSMessage();</span>
<a href="#l111.41"></a><span id="l111.41">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; m_ctx;</span>
<a href="#l111.42"></a><span id="l111.42" class="difflineminus">-  NSSCMSMessage * m_cmsMsg;</span>
<a href="#l111.43"></a><span id="l111.43" class="difflineplus">+  NSSCMSMessage* m_cmsMsg;</span>
<a href="#l111.44"></a><span id="l111.44">   NSSCMSSignerInfo* GetTopLevelSignerInfo();</span>
<a href="#l111.45"></a><span id="l111.45" class="difflineminus">-  nsresult CommonVerifySignature(unsigned char* aDigestData, uint32_t aDigestDataLen,</span>
<a href="#l111.46"></a><span id="l111.46" class="difflineminus">-                                 int16_t aDigestType);</span>
<a href="#l111.47"></a><span id="l111.47" class="difflineplus">+  nsresult CommonVerifySignature(unsigned char* aDigestData,</span>
<a href="#l111.48"></a><span id="l111.48" class="difflineplus">+                                 uint32_t aDigestDataLen, int16_t aDigestType);</span>
<a href="#l111.49"></a><span id="l111.49"> </span>
<a href="#l111.50"></a><span id="l111.50" class="difflineminus">-  nsresult CommonAsyncVerifySignature(nsISMimeVerificationListener *aListener,</span>
<a href="#l111.51"></a><span id="l111.51" class="difflineminus">-                                      unsigned char* aDigestData, uint32_t aDigestDataLen,</span>
<a href="#l111.52"></a><span id="l111.52" class="difflineplus">+  nsresult CommonAsyncVerifySignature(nsISMimeVerificationListener* aListener,</span>
<a href="#l111.53"></a><span id="l111.53" class="difflineplus">+                                      unsigned char* aDigestData,</span>
<a href="#l111.54"></a><span id="l111.54" class="difflineplus">+                                      uint32_t aDigestDataLen,</span>
<a href="#l111.55"></a><span id="l111.55">                                       int16_t aDigestType);</span>
<a href="#l111.56"></a><span id="l111.56">   bool IsAllowedHash(const int16_t aCryptoHashInt);</span>
<a href="#l111.57"></a><span id="l111.57"> </span>
<a href="#l111.58"></a><span id="l111.58">   void destructorSafeDestroyNSSReference();</span>
<a href="#l111.59"></a><span id="l111.59" class="difflineminus">-</span>
<a href="#l111.60"></a><span id="l111.60"> };</span>
<a href="#l111.61"></a><span id="l111.61"> </span>
<a href="#l111.62"></a><span id="l111.62"> // ===============================================</span>
<a href="#l111.63"></a><span id="l111.63"> // nsCMSDecoder - implementation of nsICMSDecoder</span>
<a href="#l111.64"></a><span id="l111.64"> // ===============================================</span>
<a href="#l111.65"></a><span id="l111.65"> </span>
<a href="#l111.66"></a><span id="l111.66" class="difflineminus">-#define NS_CMSDECODER_CID \</span>
<a href="#l111.67"></a><span id="l111.67" class="difflineminus">-  { 0x9dcef3a4, 0xa3bc, 0x11d5, { 0xba, 0x47, 0x00, 0x10, 0x83, 0x03, 0xb1, 0x17 } }</span>
<a href="#l111.68"></a><span id="l111.68" class="difflineplus">+#define NS_CMSDECODER_CID                            \</span>
<a href="#l111.69"></a><span id="l111.69" class="difflineplus">+  {                                                  \</span>
<a href="#l111.70"></a><span id="l111.70" class="difflineplus">+    0x9dcef3a4, 0xa3bc, 0x11d5, {                    \</span>
<a href="#l111.71"></a><span id="l111.71" class="difflineplus">+      0xba, 0x47, 0x00, 0x10, 0x83, 0x03, 0xb1, 0x17 \</span>
<a href="#l111.72"></a><span id="l111.72" class="difflineplus">+    }                                                \</span>
<a href="#l111.73"></a><span id="l111.73" class="difflineplus">+  }</span>
<a href="#l111.74"></a><span id="l111.74"> </span>
<a href="#l111.75"></a><span id="l111.75" class="difflineminus">-class nsCMSDecoder : public nsICMSDecoder</span>
<a href="#l111.76"></a><span id="l111.76" class="difflineminus">-{</span>
<a href="#l111.77"></a><span id="l111.77" class="difflineminus">-public:</span>
<a href="#l111.78"></a><span id="l111.78" class="difflineplus">+class nsCMSDecoder : public nsICMSDecoder {</span>
<a href="#l111.79"></a><span id="l111.79" class="difflineplus">+ public:</span>
<a href="#l111.80"></a><span id="l111.80">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l111.81"></a><span id="l111.81">   NS_DECL_NSICMSDECODER</span>
<a href="#l111.82"></a><span id="l111.82"> </span>
<a href="#l111.83"></a><span id="l111.83">   nsCMSDecoder();</span>
<a href="#l111.84"></a><span id="l111.84">   nsresult Init();</span>
<a href="#l111.85"></a><span id="l111.85"> </span>
<a href="#l111.86"></a><span id="l111.86" class="difflineminus">-private:</span>
<a href="#l111.87"></a><span id="l111.87" class="difflineplus">+ private:</span>
<a href="#l111.88"></a><span id="l111.88">   virtual ~nsCMSDecoder();</span>
<a href="#l111.89"></a><span id="l111.89">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; m_ctx;</span>
<a href="#l111.90"></a><span id="l111.90" class="difflineminus">-  NSSCMSDecoderContext *m_dcx;</span>
<a href="#l111.91"></a><span id="l111.91" class="difflineplus">+  NSSCMSDecoderContext* m_dcx;</span>
<a href="#l111.92"></a><span id="l111.92">   void destructorSafeDestroyNSSReference();</span>
<a href="#l111.93"></a><span id="l111.93"> };</span>
<a href="#l111.94"></a><span id="l111.94"> </span>
<a href="#l111.95"></a><span id="l111.95"> // ===============================================</span>
<a href="#l111.96"></a><span id="l111.96"> // nsCMSEncoder - implementation of nsICMSEncoder</span>
<a href="#l111.97"></a><span id="l111.97"> // ===============================================</span>
<a href="#l111.98"></a><span id="l111.98"> </span>
<a href="#l111.99"></a><span id="l111.99" class="difflineminus">-#define NS_CMSENCODER_CID \</span>
<a href="#l111.100"></a><span id="l111.100" class="difflineminus">-  { 0xa15789aa, 0x8903, 0x462b, { 0x81, 0xe9, 0x4a, 0xa2, 0xcf, 0xf4, 0xd5, 0xcb } }</span>
<a href="#l111.101"></a><span id="l111.101" class="difflineminus">-class nsCMSEncoder : public nsICMSEncoder</span>
<a href="#l111.102"></a><span id="l111.102" class="difflineminus">-{</span>
<a href="#l111.103"></a><span id="l111.103" class="difflineminus">-public:</span>
<a href="#l111.104"></a><span id="l111.104" class="difflineplus">+#define NS_CMSENCODER_CID                            \</span>
<a href="#l111.105"></a><span id="l111.105" class="difflineplus">+  {                                                  \</span>
<a href="#l111.106"></a><span id="l111.106" class="difflineplus">+    0xa15789aa, 0x8903, 0x462b, {                    \</span>
<a href="#l111.107"></a><span id="l111.107" class="difflineplus">+      0x81, 0xe9, 0x4a, 0xa2, 0xcf, 0xf4, 0xd5, 0xcb \</span>
<a href="#l111.108"></a><span id="l111.108" class="difflineplus">+    }                                                \</span>
<a href="#l111.109"></a><span id="l111.109" class="difflineplus">+  }</span>
<a href="#l111.110"></a><span id="l111.110" class="difflineplus">+class nsCMSEncoder : public nsICMSEncoder {</span>
<a href="#l111.111"></a><span id="l111.111" class="difflineplus">+ public:</span>
<a href="#l111.112"></a><span id="l111.112">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l111.113"></a><span id="l111.113">   NS_DECL_NSICMSENCODER</span>
<a href="#l111.114"></a><span id="l111.114"> </span>
<a href="#l111.115"></a><span id="l111.115">   nsCMSEncoder();</span>
<a href="#l111.116"></a><span id="l111.116">   nsresult Init();</span>
<a href="#l111.117"></a><span id="l111.117"> </span>
<a href="#l111.118"></a><span id="l111.118" class="difflineminus">-private:</span>
<a href="#l111.119"></a><span id="l111.119" class="difflineplus">+ private:</span>
<a href="#l111.120"></a><span id="l111.120">   virtual ~nsCMSEncoder();</span>
<a href="#l111.121"></a><span id="l111.121">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; m_ctx;</span>
<a href="#l111.122"></a><span id="l111.122" class="difflineminus">-  NSSCMSEncoderContext *m_ecx;</span>
<a href="#l111.123"></a><span id="l111.123" class="difflineplus">+  NSSCMSEncoderContext* m_ecx;</span>
<a href="#l111.124"></a><span id="l111.124">   void destructorSafeDestroyNSSReference();</span>
<a href="#l111.125"></a><span id="l111.125"> };</span>
<a href="#l111.126"></a><span id="l111.126"> </span>
<a href="#l111.127"></a><span id="l111.127"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l112.1"></a><span id="l112.1" class="difflineminus">--- a/mailnews/mime/src/nsCMSSecureMessage.cpp</span>
<a href="#l112.2"></a><span id="l112.2" class="difflineplus">+++ b/mailnews/mime/src/nsCMSSecureMessage.cpp</span>
<a href="#l112.3"></a><span id="l112.3" class="difflineat">@@ -34,58 +34,55 @@ using namespace mozilla::psm;</span>
<a href="#l112.4"></a><span id="l112.4"> /*****</span>
<a href="#l112.5"></a><span id="l112.5">  * nsCMSSecureMessage</span>
<a href="#l112.6"></a><span id="l112.6">  *****/</span>
<a href="#l112.7"></a><span id="l112.7"> </span>
<a href="#l112.8"></a><span id="l112.8"> // Standard ISupports implementation</span>
<a href="#l112.9"></a><span id="l112.9"> NS_IMPL_ISUPPORTS(nsCMSSecureMessage, nsICMSSecureMessage)</span>
<a href="#l112.10"></a><span id="l112.10"> </span>
<a href="#l112.11"></a><span id="l112.11"> // nsCMSSecureMessage constructor</span>
<a href="#l112.12"></a><span id="l112.12" class="difflineminus">-nsCMSSecureMessage::nsCMSSecureMessage()</span>
<a href="#l112.13"></a><span id="l112.13" class="difflineminus">-{</span>
<a href="#l112.14"></a><span id="l112.14" class="difflineplus">+nsCMSSecureMessage::nsCMSSecureMessage() {</span>
<a href="#l112.15"></a><span id="l112.15">   // initialize superclass</span>
<a href="#l112.16"></a><span id="l112.16"> }</span>
<a href="#l112.17"></a><span id="l112.17"> </span>
<a href="#l112.18"></a><span id="l112.18"> // nsCMSMessage destructor</span>
<a href="#l112.19"></a><span id="l112.19" class="difflineminus">-nsCMSSecureMessage::~nsCMSSecureMessage()</span>
<a href="#l112.20"></a><span id="l112.20" class="difflineminus">-{</span>
<a href="#l112.21"></a><span id="l112.21" class="difflineminus">-}</span>
<a href="#l112.22"></a><span id="l112.22" class="difflineplus">+nsCMSSecureMessage::~nsCMSSecureMessage() {}</span>
<a href="#l112.23"></a><span id="l112.23"> </span>
<a href="#l112.24"></a><span id="l112.24" class="difflineminus">-nsresult nsCMSSecureMessage::Init()</span>
<a href="#l112.25"></a><span id="l112.25" class="difflineminus">-{</span>
<a href="#l112.26"></a><span id="l112.26" class="difflineplus">+nsresult nsCMSSecureMessage::Init() {</span>
<a href="#l112.27"></a><span id="l112.27">   nsresult rv;</span>
<a href="#l112.28"></a><span id="l112.28" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; nssInitialized = do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l112.29"></a><span id="l112.29" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; nssInitialized =</span>
<a href="#l112.30"></a><span id="l112.30" class="difflineplus">+      do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l112.31"></a><span id="l112.31">   return rv;</span>
<a href="#l112.32"></a><span id="l112.32"> }</span>
<a href="#l112.33"></a><span id="l112.33"> </span>
<a href="#l112.34"></a><span id="l112.34" class="difflineminus">-nsresult nsCMSSecureMessage::CheckUsageOk(</span>
<a href="#l112.35"></a><span id="l112.35" class="difflineminus">-  nsIX509Cert* aCert, SECCertificateUsage aUsage, bool* aCanBeUsed) {</span>
<a href="#l112.36"></a><span id="l112.36" class="difflineplus">+nsresult nsCMSSecureMessage::CheckUsageOk(nsIX509Cert* aCert,</span>
<a href="#l112.37"></a><span id="l112.37" class="difflineplus">+                                          SECCertificateUsage aUsage,</span>
<a href="#l112.38"></a><span id="l112.38" class="difflineplus">+                                          bool* aCanBeUsed) {</span>
<a href="#l112.39"></a><span id="l112.39">   NS_ENSURE_ARG_POINTER(aCert);</span>
<a href="#l112.40"></a><span id="l112.40">   *aCanBeUsed = false;</span>
<a href="#l112.41"></a><span id="l112.41"> </span>
<a href="#l112.42"></a><span id="l112.42">   nsresult rv;</span>
<a href="#l112.43"></a><span id="l112.43" class="difflineminus">-  nsCOMPtr&lt;nsIX509CertDB&gt; certdb = do_GetService(</span>
<a href="#l112.44"></a><span id="l112.44" class="difflineminus">-    &quot;@mozilla.org/security/x509certdb;1&quot;, &amp;rv);</span>
<a href="#l112.45"></a><span id="l112.45" class="difflineplus">+  nsCOMPtr&lt;nsIX509CertDB&gt; certdb =</span>
<a href="#l112.46"></a><span id="l112.46" class="difflineplus">+      do_GetService(&quot;@mozilla.org/security/x509certdb;1&quot;, &amp;rv);</span>
<a href="#l112.47"></a><span id="l112.47">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l112.48"></a><span id="l112.48"> </span>
<a href="#l112.49"></a><span id="l112.49">   RefPtr&lt;SharedCertVerifier&gt; certVerifier(GetDefaultCertVerifier());</span>
<a href="#l112.50"></a><span id="l112.50">   NS_ENSURE_TRUE(certVerifier, NS_ERROR_UNEXPECTED);</span>
<a href="#l112.51"></a><span id="l112.51"> </span>
<a href="#l112.52"></a><span id="l112.52">   UniqueCERTCertList unusedBuiltChain;</span>
<a href="#l112.53"></a><span id="l112.53" class="difflineminus">-  if (certVerifier-&gt;VerifyCert(aCert-&gt;GetCert(),</span>
<a href="#l112.54"></a><span id="l112.54" class="difflineminus">-                               aUsage,</span>
<a href="#l112.55"></a><span id="l112.55" class="difflineminus">-                               mozilla::pkix::Now(),</span>
<a href="#l112.56"></a><span id="l112.56" class="difflineminus">-                               nullptr,</span>
<a href="#l112.57"></a><span id="l112.57" class="difflineminus">-                               nullptr,</span>
<a href="#l112.58"></a><span id="l112.58" class="difflineminus">-                               unusedBuiltChain,</span>
<a href="#l112.59"></a><span id="l112.59" class="difflineminus">-                               CertVerifier::FLAG_LOCAL_ONLY) == mozilla::pkix::Success) {</span>
<a href="#l112.60"></a><span id="l112.60" class="difflineplus">+  if (certVerifier-&gt;VerifyCert(aCert-&gt;GetCert(), aUsage, mozilla::pkix::Now(),</span>
<a href="#l112.61"></a><span id="l112.61" class="difflineplus">+                               nullptr, nullptr, unusedBuiltChain,</span>
<a href="#l112.62"></a><span id="l112.62" class="difflineplus">+                               CertVerifier::FLAG_LOCAL_ONLY) ==</span>
<a href="#l112.63"></a><span id="l112.63" class="difflineplus">+      mozilla::pkix::Success) {</span>
<a href="#l112.64"></a><span id="l112.64">     *aCanBeUsed = true;</span>
<a href="#l112.65"></a><span id="l112.65">   }</span>
<a href="#l112.66"></a><span id="l112.66">   return NS_OK;</span>
<a href="#l112.67"></a><span id="l112.67"> }</span>
<a href="#l112.68"></a><span id="l112.68"> </span>
<a href="#l112.69"></a><span id="l112.69" class="difflineminus">-NS_IMETHODIMP nsCMSSecureMessage::CanBeUsedForEmailEncryption(nsIX509Cert* aCert, bool* aCanBeUsed) {</span>
<a href="#l112.70"></a><span id="l112.70" class="difflineplus">+NS_IMETHODIMP nsCMSSecureMessage::CanBeUsedForEmailEncryption(</span>
<a href="#l112.71"></a><span id="l112.71" class="difflineplus">+    nsIX509Cert* aCert, bool* aCanBeUsed) {</span>
<a href="#l112.72"></a><span id="l112.72">   return CheckUsageOk(aCert, certificateUsageEmailRecipient, aCanBeUsed);</span>
<a href="#l112.73"></a><span id="l112.73"> }</span>
<a href="#l112.74"></a><span id="l112.74"> </span>
<a href="#l112.75"></a><span id="l112.75" class="difflineminus">-NS_IMETHODIMP nsCMSSecureMessage::CanBeUsedForEmailSigning(nsIX509Cert* aCert, bool* aCanBeUsed) {</span>
<a href="#l112.76"></a><span id="l112.76" class="difflineplus">+NS_IMETHODIMP nsCMSSecureMessage::CanBeUsedForEmailSigning(nsIX509Cert* aCert,</span>
<a href="#l112.77"></a><span id="l112.77" class="difflineplus">+                                                           bool* aCanBeUsed) {</span>
<a href="#l112.78"></a><span id="l112.78">   return CheckUsageOk(aCert, certificateUsageEmailSigner, aCanBeUsed);</span>
<a href="#l112.79"></a><span id="l112.79"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l113.1"></a><span id="l113.1" class="difflineminus">--- a/mailnews/mime/src/nsCMSSecureMessage.h</span>
<a href="#l113.2"></a><span id="l113.2" class="difflineplus">+++ b/mailnews/mime/src/nsCMSSecureMessage.h</span>
<a href="#l113.3"></a><span id="l113.3" class="difflineat">@@ -8,29 +8,32 @@</span>
<a href="#l113.4"></a><span id="l113.4"> </span>
<a href="#l113.5"></a><span id="l113.5"> #include &quot;nsICMSSecureMessage.h&quot;</span>
<a href="#l113.6"></a><span id="l113.6"> #include &quot;cert.h&quot;</span>
<a href="#l113.7"></a><span id="l113.7"> </span>
<a href="#l113.8"></a><span id="l113.8"> // ===============================================</span>
<a href="#l113.9"></a><span id="l113.9"> // nsCMSManager - implementation of nsICMSManager</span>
<a href="#l113.10"></a><span id="l113.10"> // ===============================================</span>
<a href="#l113.11"></a><span id="l113.11"> </span>
<a href="#l113.12"></a><span id="l113.12" class="difflineminus">-#define NS_CMSSECUREMESSAGE_CID \</span>
<a href="#l113.13"></a><span id="l113.13" class="difflineminus">-  { 0x5fb907e0, 0x1dd2, 0x11b2, { 0xa7, 0xc0, 0xf1, 0x4c, 0x41, 0x6a, 0x62, 0xa1 } }</span>
<a href="#l113.14"></a><span id="l113.14" class="difflineplus">+#define NS_CMSSECUREMESSAGE_CID                      \</span>
<a href="#l113.15"></a><span id="l113.15" class="difflineplus">+  {                                                  \</span>
<a href="#l113.16"></a><span id="l113.16" class="difflineplus">+    0x5fb907e0, 0x1dd2, 0x11b2, {                    \</span>
<a href="#l113.17"></a><span id="l113.17" class="difflineplus">+      0xa7, 0xc0, 0xf1, 0x4c, 0x41, 0x6a, 0x62, 0xa1 \</span>
<a href="#l113.18"></a><span id="l113.18" class="difflineplus">+    }                                                \</span>
<a href="#l113.19"></a><span id="l113.19" class="difflineplus">+  }</span>
<a href="#l113.20"></a><span id="l113.20"> </span>
<a href="#l113.21"></a><span id="l113.21" class="difflineminus">-class nsCMSSecureMessage</span>
<a href="#l113.22"></a><span id="l113.22" class="difflineminus">-: public nsICMSSecureMessage</span>
<a href="#l113.23"></a><span id="l113.23" class="difflineminus">-{</span>
<a href="#l113.24"></a><span id="l113.24" class="difflineminus">-public:</span>
<a href="#l113.25"></a><span id="l113.25" class="difflineplus">+class nsCMSSecureMessage : public nsICMSSecureMessage {</span>
<a href="#l113.26"></a><span id="l113.26" class="difflineplus">+ public:</span>
<a href="#l113.27"></a><span id="l113.27">   NS_DECL_ISUPPORTS</span>
<a href="#l113.28"></a><span id="l113.28">   NS_DECL_NSICMSSECUREMESSAGE</span>
<a href="#l113.29"></a><span id="l113.29"> </span>
<a href="#l113.30"></a><span id="l113.30">   nsCMSSecureMessage();</span>
<a href="#l113.31"></a><span id="l113.31">   nsresult Init();</span>
<a href="#l113.32"></a><span id="l113.32"> </span>
<a href="#l113.33"></a><span id="l113.33" class="difflineminus">-private:</span>
<a href="#l113.34"></a><span id="l113.34" class="difflineplus">+ private:</span>
<a href="#l113.35"></a><span id="l113.35">   virtual ~nsCMSSecureMessage();</span>
<a href="#l113.36"></a><span id="l113.36">   nsresult encode(const unsigned char *data, int32_t dataLen, char **_retval);</span>
<a href="#l113.37"></a><span id="l113.37" class="difflineminus">-  nsresult decode(const char *data, unsigned char **result, int32_t * _retval);</span>
<a href="#l113.38"></a><span id="l113.38" class="difflineminus">-  nsresult CheckUsageOk(nsIX509Cert* cert, SECCertificateUsage usage, bool* _retval);</span>
<a href="#l113.39"></a><span id="l113.39" class="difflineplus">+  nsresult decode(const char *data, unsigned char **result, int32_t *_retval);</span>
<a href="#l113.40"></a><span id="l113.40" class="difflineplus">+  nsresult CheckUsageOk(nsIX509Cert *cert, SECCertificateUsage usage,</span>
<a href="#l113.41"></a><span id="l113.41" class="difflineplus">+                        bool *_retval);</span>
<a href="#l113.42"></a><span id="l113.42"> };</span>
<a href="#l113.43"></a><span id="l113.43"> </span>
<a href="#l113.44"></a><span id="l113.44" class="difflineminus">-#endif // nsCMSSecureMessage_h</span>
<a href="#l113.45"></a><span id="l113.45" class="difflineplus">+#endif  // nsCMSSecureMessage_h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l114.1"></a><span id="l114.1" class="difflineminus">--- a/mailnews/mime/src/nsMimeObjectClassAccess.cpp</span>
<a href="#l114.2"></a><span id="l114.2" class="difflineplus">+++ b/mailnews/mime/src/nsMimeObjectClassAccess.cpp</span>
<a href="#l114.3"></a><span id="l114.3" class="difflineat">@@ -15,83 +15,61 @@ NS_IMPL_ISUPPORTS(nsMimeObjectClassAcces</span>
<a href="#l114.4"></a><span id="l114.4"> </span>
<a href="#l114.5"></a><span id="l114.5"> /*</span>
<a href="#l114.6"></a><span id="l114.6">  * nsMimeObjectClassAccess definitions....</span>
<a href="#l114.7"></a><span id="l114.7">  */</span>
<a href="#l114.8"></a><span id="l114.8"> </span>
<a href="#l114.9"></a><span id="l114.9"> /*</span>
<a href="#l114.10"></a><span id="l114.10">  * Inherited methods for nsMimeObjectClassAccess</span>
<a href="#l114.11"></a><span id="l114.11">  */</span>
<a href="#l114.12"></a><span id="l114.12" class="difflineminus">-nsMimeObjectClassAccess::nsMimeObjectClassAccess()</span>
<a href="#l114.13"></a><span id="l114.13" class="difflineminus">-{</span>
<a href="#l114.14"></a><span id="l114.14" class="difflineminus">-}</span>
<a href="#l114.15"></a><span id="l114.15" class="difflineplus">+nsMimeObjectClassAccess::nsMimeObjectClassAccess() {}</span>
<a href="#l114.16"></a><span id="l114.16" class="difflineplus">+</span>
<a href="#l114.17"></a><span id="l114.17" class="difflineplus">+nsMimeObjectClassAccess::~nsMimeObjectClassAccess() {}</span>
<a href="#l114.18"></a><span id="l114.18"> </span>
<a href="#l114.19"></a><span id="l114.19" class="difflineminus">-nsMimeObjectClassAccess::~nsMimeObjectClassAccess()</span>
<a href="#l114.20"></a><span id="l114.20" class="difflineminus">-{</span>
<a href="#l114.21"></a><span id="l114.21" class="difflineminus">-}</span>
<a href="#l114.22"></a><span id="l114.22" class="difflineminus">-</span>
<a href="#l114.23"></a><span id="l114.23" class="difflineminus">-nsresult</span>
<a href="#l114.24"></a><span id="l114.24" class="difflineminus">-nsMimeObjectClassAccess::MimeObjectWrite(void *mimeObject,</span>
<a href="#l114.25"></a><span id="l114.25" class="difflineminus">-                                         char *data,</span>
<a href="#l114.26"></a><span id="l114.26" class="difflineminus">-                                         int32_t length,</span>
<a href="#l114.27"></a><span id="l114.27" class="difflineminus">-                                         bool user_visible_p)</span>
<a href="#l114.28"></a><span id="l114.28" class="difflineminus">-{</span>
<a href="#l114.29"></a><span id="l114.29" class="difflineplus">+nsresult nsMimeObjectClassAccess::MimeObjectWrite(void *mimeObject, char *data,</span>
<a href="#l114.30"></a><span id="l114.30" class="difflineplus">+                                                  int32_t length,</span>
<a href="#l114.31"></a><span id="l114.31" class="difflineplus">+                                                  bool user_visible_p) {</span>
<a href="#l114.32"></a><span id="l114.32">   int rc = XPCOM_MimeObject_write(mimeObject, data, length, user_visible_p);</span>
<a href="#l114.33"></a><span id="l114.33">   NS_ENSURE_FALSE(rc &lt; 0, NS_ERROR_FAILURE);</span>
<a href="#l114.34"></a><span id="l114.34"> </span>
<a href="#l114.35"></a><span id="l114.35">   return NS_OK;</span>
<a href="#l114.36"></a><span id="l114.36"> }</span>
<a href="#l114.37"></a><span id="l114.37"> </span>
<a href="#l114.38"></a><span id="l114.38" class="difflineminus">-nsresult</span>
<a href="#l114.39"></a><span id="l114.39" class="difflineminus">-nsMimeObjectClassAccess::GetmimeInlineTextClass(void **ptr)</span>
<a href="#l114.40"></a><span id="l114.40" class="difflineminus">-{</span>
<a href="#l114.41"></a><span id="l114.41" class="difflineplus">+nsresult nsMimeObjectClassAccess::GetmimeInlineTextClass(void **ptr) {</span>
<a href="#l114.42"></a><span id="l114.42">   *ptr = XPCOM_GetmimeInlineTextClass();</span>
<a href="#l114.43"></a><span id="l114.43">   return NS_OK;</span>
<a href="#l114.44"></a><span id="l114.44"> }</span>
<a href="#l114.45"></a><span id="l114.45"> </span>
<a href="#l114.46"></a><span id="l114.46" class="difflineminus">-nsresult</span>
<a href="#l114.47"></a><span id="l114.47" class="difflineminus">-nsMimeObjectClassAccess::GetmimeLeafClass(void **ptr)</span>
<a href="#l114.48"></a><span id="l114.48" class="difflineminus">-{</span>
<a href="#l114.49"></a><span id="l114.49" class="difflineplus">+nsresult nsMimeObjectClassAccess::GetmimeLeafClass(void **ptr) {</span>
<a href="#l114.50"></a><span id="l114.50">   *ptr = XPCOM_GetmimeLeafClass();</span>
<a href="#l114.51"></a><span id="l114.51">   return NS_OK;</span>
<a href="#l114.52"></a><span id="l114.52"> }</span>
<a href="#l114.53"></a><span id="l114.53"> </span>
<a href="#l114.54"></a><span id="l114.54" class="difflineminus">-nsresult</span>
<a href="#l114.55"></a><span id="l114.55" class="difflineminus">-nsMimeObjectClassAccess::GetmimeObjectClass(void **ptr)</span>
<a href="#l114.56"></a><span id="l114.56" class="difflineminus">-{</span>
<a href="#l114.57"></a><span id="l114.57" class="difflineplus">+nsresult nsMimeObjectClassAccess::GetmimeObjectClass(void **ptr) {</span>
<a href="#l114.58"></a><span id="l114.58">   *ptr = XPCOM_GetmimeObjectClass();</span>
<a href="#l114.59"></a><span id="l114.59">   return NS_OK;</span>
<a href="#l114.60"></a><span id="l114.60"> }</span>
<a href="#l114.61"></a><span id="l114.61"> </span>
<a href="#l114.62"></a><span id="l114.62" class="difflineminus">-nsresult</span>
<a href="#l114.63"></a><span id="l114.63" class="difflineminus">-nsMimeObjectClassAccess::GetmimeContainerClass(void **ptr)</span>
<a href="#l114.64"></a><span id="l114.64" class="difflineminus">-{</span>
<a href="#l114.65"></a><span id="l114.65" class="difflineplus">+nsresult nsMimeObjectClassAccess::GetmimeContainerClass(void **ptr) {</span>
<a href="#l114.66"></a><span id="l114.66">   *ptr = XPCOM_GetmimeContainerClass();</span>
<a href="#l114.67"></a><span id="l114.67">   return NS_OK;</span>
<a href="#l114.68"></a><span id="l114.68"> }</span>
<a href="#l114.69"></a><span id="l114.69"> </span>
<a href="#l114.70"></a><span id="l114.70" class="difflineminus">-nsresult</span>
<a href="#l114.71"></a><span id="l114.71" class="difflineminus">-nsMimeObjectClassAccess::GetmimeMultipartClass(void **ptr)</span>
<a href="#l114.72"></a><span id="l114.72" class="difflineminus">-{</span>
<a href="#l114.73"></a><span id="l114.73" class="difflineplus">+nsresult nsMimeObjectClassAccess::GetmimeMultipartClass(void **ptr) {</span>
<a href="#l114.74"></a><span id="l114.74">   *ptr = XPCOM_GetmimeMultipartClass();</span>
<a href="#l114.75"></a><span id="l114.75">   return NS_OK;</span>
<a href="#l114.76"></a><span id="l114.76"> }</span>
<a href="#l114.77"></a><span id="l114.77"> </span>
<a href="#l114.78"></a><span id="l114.78" class="difflineminus">-nsresult</span>
<a href="#l114.79"></a><span id="l114.79" class="difflineminus">-nsMimeObjectClassAccess::GetmimeMultipartSignedClass(void **ptr)</span>
<a href="#l114.80"></a><span id="l114.80" class="difflineminus">-{</span>
<a href="#l114.81"></a><span id="l114.81" class="difflineplus">+nsresult nsMimeObjectClassAccess::GetmimeMultipartSignedClass(void **ptr) {</span>
<a href="#l114.82"></a><span id="l114.82">   *ptr = XPCOM_GetmimeMultipartSignedClass();</span>
<a href="#l114.83"></a><span id="l114.83">   return NS_OK;</span>
<a href="#l114.84"></a><span id="l114.84"> }</span>
<a href="#l114.85"></a><span id="l114.85"> </span>
<a href="#l114.86"></a><span id="l114.86" class="difflineminus">-nsresult</span>
<a href="#l114.87"></a><span id="l114.87" class="difflineminus">-nsMimeObjectClassAccess::GetmimeEncryptedClass(void **ptr)</span>
<a href="#l114.88"></a><span id="l114.88" class="difflineminus">-{</span>
<a href="#l114.89"></a><span id="l114.89" class="difflineplus">+nsresult nsMimeObjectClassAccess::GetmimeEncryptedClass(void **ptr) {</span>
<a href="#l114.90"></a><span id="l114.90">   *ptr = XPCOM_GetmimeEncryptedClass();</span>
<a href="#l114.91"></a><span id="l114.91">   return NS_OK;</span>
<a href="#l114.92"></a><span id="l114.92"> }</span>
<a href="#l114.93"></a><span id="l114.93"> </span>
<a href="#l114.94"></a><span id="l114.94" class="difflineminus">-nsresult</span>
<a href="#l114.95"></a><span id="l114.95" class="difflineminus">-nsMimeObjectClassAccess::MimeCreate(char * content_type, void * hdrs, void * opts, void **ptr)</span>
<a href="#l114.96"></a><span id="l114.96" class="difflineminus">-{</span>
<a href="#l114.97"></a><span id="l114.97" class="difflineplus">+nsresult nsMimeObjectClassAccess::MimeCreate(char *content_type, void *hdrs,</span>
<a href="#l114.98"></a><span id="l114.98" class="difflineplus">+                                             void *opts, void **ptr) {</span>
<a href="#l114.99"></a><span id="l114.99">   *ptr = XPCOM_Mime_create(content_type, hdrs, opts);</span>
<a href="#l114.100"></a><span id="l114.100">   return NS_OK;</span>
<a href="#l114.101"></a><span id="l114.101"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l115.1"></a><span id="l115.1" class="difflineminus">--- a/mailnews/mime/src/nsMimeObjectClassAccess.h</span>
<a href="#l115.2"></a><span id="l115.2" class="difflineplus">+++ b/mailnews/mime/src/nsMimeObjectClassAccess.h</span>
<a href="#l115.3"></a><span id="l115.3" class="difflineat">@@ -12,41 +12,39 @@</span>
<a href="#l115.4"></a><span id="l115.4"> #ifndef nsMimeObjectClassAccess_h_</span>
<a href="#l115.5"></a><span id="l115.5"> #define nsMimeObjectClassAccess_h_</span>
<a href="#l115.6"></a><span id="l115.6"> </span>
<a href="#l115.7"></a><span id="l115.7"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l115.8"></a><span id="l115.8"> #include &quot;nsISupports.h&quot;</span>
<a href="#l115.9"></a><span id="l115.9"> #include &quot;nsIMimeObjectClassAccess.h&quot;</span>
<a href="#l115.10"></a><span id="l115.10"> </span>
<a href="#l115.11"></a><span id="l115.11"> class nsMimeObjectClassAccess : public nsIMimeObjectClassAccess {</span>
<a href="#l115.12"></a><span id="l115.12" class="difflineminus">-public:</span>
<a href="#l115.13"></a><span id="l115.13" class="difflineplus">+ public:</span>
<a href="#l115.14"></a><span id="l115.14">   nsMimeObjectClassAccess();</span>
<a href="#l115.15"></a><span id="l115.15"> </span>
<a href="#l115.16"></a><span id="l115.16">   /* this macro defines QueryInterface, AddRef and Release for this class */</span>
<a href="#l115.17"></a><span id="l115.17">   NS_DECL_ISUPPORTS</span>
<a href="#l115.18"></a><span id="l115.18"> </span>
<a href="#l115.19"></a><span id="l115.19">   // These methods are all implemented by libmime to be used by</span>
<a href="#l115.20"></a><span id="l115.20">   // content type handler plugins for processing stream data.</span>
<a href="#l115.21"></a><span id="l115.21"> </span>
<a href="#l115.22"></a><span id="l115.22">   // This is the write call for outputting processed stream data.</span>
<a href="#l115.23"></a><span id="l115.23" class="difflineminus">-  NS_IMETHOD    MimeObjectWrite(void *mimeObject,</span>
<a href="#l115.24"></a><span id="l115.24" class="difflineminus">-                                char *data,</span>
<a href="#l115.25"></a><span id="l115.25" class="difflineminus">-                                int32_t length,</span>
<a href="#l115.26"></a><span id="l115.26" class="difflineminus">-                                bool user_visible_p) override;</span>
<a href="#l115.27"></a><span id="l115.27" class="difflineplus">+  NS_IMETHOD MimeObjectWrite(void *mimeObject, char *data, int32_t length,</span>
<a href="#l115.28"></a><span id="l115.28" class="difflineplus">+                             bool user_visible_p) override;</span>
<a href="#l115.29"></a><span id="l115.29"> </span>
<a href="#l115.30"></a><span id="l115.30">   // The following group of calls expose the pointers for the object</span>
<a href="#l115.31"></a><span id="l115.31">   // system within libmime.</span>
<a href="#l115.32"></a><span id="l115.32" class="difflineminus">-  NS_IMETHOD    GetmimeInlineTextClass(void **ptr) override;</span>
<a href="#l115.33"></a><span id="l115.33" class="difflineminus">-  NS_IMETHOD    GetmimeLeafClass(void **ptr) override;</span>
<a href="#l115.34"></a><span id="l115.34" class="difflineminus">-  NS_IMETHOD    GetmimeObjectClass(void **ptr) override;</span>
<a href="#l115.35"></a><span id="l115.35" class="difflineminus">-  NS_IMETHOD    GetmimeContainerClass(void **ptr) override;</span>
<a href="#l115.36"></a><span id="l115.36" class="difflineminus">-  NS_IMETHOD    GetmimeMultipartClass(void **ptr) override;</span>
<a href="#l115.37"></a><span id="l115.37" class="difflineminus">-  NS_IMETHOD    GetmimeMultipartSignedClass(void **ptr) override;</span>
<a href="#l115.38"></a><span id="l115.38" class="difflineminus">-  NS_IMETHOD    GetmimeEncryptedClass(void **ptr) override;</span>
<a href="#l115.39"></a><span id="l115.39" class="difflineplus">+  NS_IMETHOD GetmimeInlineTextClass(void **ptr) override;</span>
<a href="#l115.40"></a><span id="l115.40" class="difflineplus">+  NS_IMETHOD GetmimeLeafClass(void **ptr) override;</span>
<a href="#l115.41"></a><span id="l115.41" class="difflineplus">+  NS_IMETHOD GetmimeObjectClass(void **ptr) override;</span>
<a href="#l115.42"></a><span id="l115.42" class="difflineplus">+  NS_IMETHOD GetmimeContainerClass(void **ptr) override;</span>
<a href="#l115.43"></a><span id="l115.43" class="difflineplus">+  NS_IMETHOD GetmimeMultipartClass(void **ptr) override;</span>
<a href="#l115.44"></a><span id="l115.44" class="difflineplus">+  NS_IMETHOD GetmimeMultipartSignedClass(void **ptr) override;</span>
<a href="#l115.45"></a><span id="l115.45" class="difflineplus">+  NS_IMETHOD GetmimeEncryptedClass(void **ptr) override;</span>
<a href="#l115.46"></a><span id="l115.46"> </span>
<a href="#l115.47"></a><span id="l115.47" class="difflineminus">-  NS_IMETHOD    MimeCreate(char *content_type, void * hdrs,</span>
<a href="#l115.48"></a><span id="l115.48" class="difflineminus">-                           void * opts, void**ptr) override;</span>
<a href="#l115.49"></a><span id="l115.49" class="difflineplus">+  NS_IMETHOD MimeCreate(char *content_type, void *hdrs, void *opts,</span>
<a href="#l115.50"></a><span id="l115.50" class="difflineplus">+                        void **ptr) override;</span>
<a href="#l115.51"></a><span id="l115.51"> </span>
<a href="#l115.52"></a><span id="l115.52" class="difflineminus">-private:</span>
<a href="#l115.53"></a><span id="l115.53" class="difflineplus">+ private:</span>
<a href="#l115.54"></a><span id="l115.54">   virtual ~nsMimeObjectClassAccess();</span>
<a href="#l115.55"></a><span id="l115.55"> };</span>
<a href="#l115.56"></a><span id="l115.56"> </span>
<a href="#l115.57"></a><span id="l115.57"> #endif /* nsMimeObjectClassAccess_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l116.1"></a><span id="l116.1" class="difflineminus">--- a/mailnews/mime/src/nsMimeStringResources.h</span>
<a href="#l116.2"></a><span id="l116.2" class="difflineplus">+++ b/mailnews/mime/src/nsMimeStringResources.h</span>
<a href="#l116.3"></a><span id="l116.3" class="difflineat">@@ -4,37 +4,37 @@</span>
<a href="#l116.4"></a><span id="l116.4"> </span>
<a href="#l116.5"></a><span id="l116.5"> #ifndef _NAME_OF_THIS_HEADER_FILE__</span>
<a href="#l116.6"></a><span id="l116.6"> #define _NAME_OF_THIS_HEADER_FILE__</span>
<a href="#l116.7"></a><span id="l116.7"> </span>
<a href="#l116.8"></a><span id="l116.8"> /* Note that the negative values are not actually strings: they are error</span>
<a href="#l116.9"></a><span id="l116.9">  * codes masquerading as strings. Do not pass them to MimeGetStringByID()</span>
<a href="#l116.10"></a><span id="l116.10">  * expecting to get anything back for your trouble.</span>
<a href="#l116.11"></a><span id="l116.11">  */</span>
<a href="#l116.12"></a><span id="l116.12" class="difflineminus">-#define  MIME_OUT_OF_MEMORY                        -1000</span>
<a href="#l116.13"></a><span id="l116.13" class="difflineminus">-#define  MIME_UNABLE_TO_OPEN_TMP_FILE              -1001</span>
<a href="#l116.14"></a><span id="l116.14" class="difflineminus">-#define  MIME_ERROR_WRITING_FILE                   -1002</span>
<a href="#l116.15"></a><span id="l116.15" class="difflineminus">-#define  MIME_MHTML_SUBJECT                        1000</span>
<a href="#l116.16"></a><span id="l116.16" class="difflineminus">-#define  MIME_MHTML_RESENT_COMMENTS                1001</span>
<a href="#l116.17"></a><span id="l116.17" class="difflineminus">-#define  MIME_MHTML_RESENT_DATE                    1002</span>
<a href="#l116.18"></a><span id="l116.18" class="difflineminus">-#define  MIME_MHTML_RESENT_SENDER                  1003</span>
<a href="#l116.19"></a><span id="l116.19" class="difflineminus">-#define  MIME_MHTML_RESENT_FROM                    1004</span>
<a href="#l116.20"></a><span id="l116.20" class="difflineminus">-#define  MIME_MHTML_RESENT_TO                      1005</span>
<a href="#l116.21"></a><span id="l116.21" class="difflineminus">-#define  MIME_MHTML_RESENT_CC                      1006</span>
<a href="#l116.22"></a><span id="l116.22" class="difflineminus">-#define  MIME_MHTML_DATE                           1007</span>
<a href="#l116.23"></a><span id="l116.23" class="difflineminus">-#define  MIME_MHTML_SENDER                         1008</span>
<a href="#l116.24"></a><span id="l116.24" class="difflineminus">-#define  MIME_MHTML_FROM                           1009</span>
<a href="#l116.25"></a><span id="l116.25" class="difflineminus">-#define  MIME_MHTML_REPLY_TO                       1010</span>
<a href="#l116.26"></a><span id="l116.26" class="difflineminus">-#define  MIME_MHTML_ORGANIZATION                   1011</span>
<a href="#l116.27"></a><span id="l116.27" class="difflineminus">-#define  MIME_MHTML_TO                             1012</span>
<a href="#l116.28"></a><span id="l116.28" class="difflineminus">-#define  MIME_MHTML_CC                             1013</span>
<a href="#l116.29"></a><span id="l116.29" class="difflineminus">-#define  MIME_MHTML_NEWSGROUPS                     1014</span>
<a href="#l116.30"></a><span id="l116.30" class="difflineminus">-#define  MIME_MHTML_FOLLOWUP_TO                    1015</span>
<a href="#l116.31"></a><span id="l116.31" class="difflineminus">-#define  MIME_MHTML_REFERENCES                     1016</span>
<a href="#l116.32"></a><span id="l116.32" class="difflineminus">-#define  MIME_MHTML_MESSAGE_ID                     1021</span>
<a href="#l116.33"></a><span id="l116.33" class="difflineminus">-#define  MIME_MHTML_BCC                            1023</span>
<a href="#l116.34"></a><span id="l116.34" class="difflineminus">-#define  MIME_MSG_LINK_TO_DOCUMENT                 1026</span>
<a href="#l116.35"></a><span id="l116.35" class="difflineminus">-#define  MIME_MSG_DOCUMENT_INFO                    1027</span>
<a href="#l116.36"></a><span id="l116.36" class="difflineminus">-#define  MIME_MSG_ATTACHMENT                       1028</span>
<a href="#l116.37"></a><span id="l116.37" class="difflineminus">-#define  MIME_MSG_DEFAULT_ATTACHMENT_NAME          1040</span>
<a href="#l116.38"></a><span id="l116.38" class="difflineminus">-#define  MIME_FORWARDED_MESSAGE_HTML_USER_WROTE    1041</span>
<a href="#l116.39"></a><span id="l116.39" class="difflineplus">+#define MIME_OUT_OF_MEMORY -1000</span>
<a href="#l116.40"></a><span id="l116.40" class="difflineplus">+#define MIME_UNABLE_TO_OPEN_TMP_FILE -1001</span>
<a href="#l116.41"></a><span id="l116.41" class="difflineplus">+#define MIME_ERROR_WRITING_FILE -1002</span>
<a href="#l116.42"></a><span id="l116.42" class="difflineplus">+#define MIME_MHTML_SUBJECT 1000</span>
<a href="#l116.43"></a><span id="l116.43" class="difflineplus">+#define MIME_MHTML_RESENT_COMMENTS 1001</span>
<a href="#l116.44"></a><span id="l116.44" class="difflineplus">+#define MIME_MHTML_RESENT_DATE 1002</span>
<a href="#l116.45"></a><span id="l116.45" class="difflineplus">+#define MIME_MHTML_RESENT_SENDER 1003</span>
<a href="#l116.46"></a><span id="l116.46" class="difflineplus">+#define MIME_MHTML_RESENT_FROM 1004</span>
<a href="#l116.47"></a><span id="l116.47" class="difflineplus">+#define MIME_MHTML_RESENT_TO 1005</span>
<a href="#l116.48"></a><span id="l116.48" class="difflineplus">+#define MIME_MHTML_RESENT_CC 1006</span>
<a href="#l116.49"></a><span id="l116.49" class="difflineplus">+#define MIME_MHTML_DATE 1007</span>
<a href="#l116.50"></a><span id="l116.50" class="difflineplus">+#define MIME_MHTML_SENDER 1008</span>
<a href="#l116.51"></a><span id="l116.51" class="difflineplus">+#define MIME_MHTML_FROM 1009</span>
<a href="#l116.52"></a><span id="l116.52" class="difflineplus">+#define MIME_MHTML_REPLY_TO 1010</span>
<a href="#l116.53"></a><span id="l116.53" class="difflineplus">+#define MIME_MHTML_ORGANIZATION 1011</span>
<a href="#l116.54"></a><span id="l116.54" class="difflineplus">+#define MIME_MHTML_TO 1012</span>
<a href="#l116.55"></a><span id="l116.55" class="difflineplus">+#define MIME_MHTML_CC 1013</span>
<a href="#l116.56"></a><span id="l116.56" class="difflineplus">+#define MIME_MHTML_NEWSGROUPS 1014</span>
<a href="#l116.57"></a><span id="l116.57" class="difflineplus">+#define MIME_MHTML_FOLLOWUP_TO 1015</span>
<a href="#l116.58"></a><span id="l116.58" class="difflineplus">+#define MIME_MHTML_REFERENCES 1016</span>
<a href="#l116.59"></a><span id="l116.59" class="difflineplus">+#define MIME_MHTML_MESSAGE_ID 1021</span>
<a href="#l116.60"></a><span id="l116.60" class="difflineplus">+#define MIME_MHTML_BCC 1023</span>
<a href="#l116.61"></a><span id="l116.61" class="difflineplus">+#define MIME_MSG_LINK_TO_DOCUMENT 1026</span>
<a href="#l116.62"></a><span id="l116.62" class="difflineplus">+#define MIME_MSG_DOCUMENT_INFO 1027</span>
<a href="#l116.63"></a><span id="l116.63" class="difflineplus">+#define MIME_MSG_ATTACHMENT 1028</span>
<a href="#l116.64"></a><span id="l116.64" class="difflineplus">+#define MIME_MSG_DEFAULT_ATTACHMENT_NAME 1040</span>
<a href="#l116.65"></a><span id="l116.65" class="difflineplus">+#define MIME_FORWARDED_MESSAGE_HTML_USER_WROTE 1041</span>
<a href="#l116.66"></a><span id="l116.66"> </span>
<a href="#l116.67"></a><span id="l116.67"> #endif /* _NAME_OF_THIS_HEADER_FILE__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l117.1"></a><span id="l117.1" class="difflineminus">--- a/mailnews/mime/src/nsSimpleMimeConverterStub.cpp</span>
<a href="#l117.2"></a><span id="l117.2" class="difflineplus">+++ b/mailnews/mime/src/nsSimpleMimeConverterStub.cpp</span>
<a href="#l117.3"></a><span id="l117.3" class="difflineat">@@ -16,195 +16,169 @@</span>
<a href="#l117.4"></a><span id="l117.4"> #include &quot;nsISimpleMimeConverter.h&quot;</span>
<a href="#l117.5"></a><span id="l117.5"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l117.6"></a><span id="l117.6"> #include &quot;nsSimpleMimeConverterStub.h&quot;</span>
<a href="#l117.7"></a><span id="l117.7"> </span>
<a href="#l117.8"></a><span id="l117.8"> typedef struct MimeSimpleStub MimeSimpleStub;</span>
<a href="#l117.9"></a><span id="l117.9"> typedef struct MimeSimpleStubClass MimeSimpleStubClass;</span>
<a href="#l117.10"></a><span id="l117.10"> </span>
<a href="#l117.11"></a><span id="l117.11"> struct MimeSimpleStubClass {</span>
<a href="#l117.12"></a><span id="l117.12" class="difflineminus">-    MimeInlineTextClass text;</span>
<a href="#l117.13"></a><span id="l117.13" class="difflineplus">+  MimeInlineTextClass text;</span>
<a href="#l117.14"></a><span id="l117.14"> };</span>
<a href="#l117.15"></a><span id="l117.15"> </span>
<a href="#l117.16"></a><span id="l117.16"> struct MimeSimpleStub {</span>
<a href="#l117.17"></a><span id="l117.17" class="difflineminus">-    MimeInlineText text;</span>
<a href="#l117.18"></a><span id="l117.18" class="difflineminus">-    nsCString *buffer;</span>
<a href="#l117.19"></a><span id="l117.19" class="difflineminus">-    nsCOMPtr&lt;nsISimpleMimeConverter&gt; innerScriptable;</span>
<a href="#l117.20"></a><span id="l117.20" class="difflineplus">+  MimeInlineText text;</span>
<a href="#l117.21"></a><span id="l117.21" class="difflineplus">+  nsCString *buffer;</span>
<a href="#l117.22"></a><span id="l117.22" class="difflineplus">+  nsCOMPtr&lt;nsISimpleMimeConverter&gt; innerScriptable;</span>
<a href="#l117.23"></a><span id="l117.23"> };</span>
<a href="#l117.24"></a><span id="l117.24"> </span>
<a href="#l117.25"></a><span id="l117.25" class="difflineminus">-#define MimeSimpleStubClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l117.26"></a><span id="l117.26" class="difflineminus">-  { MimeInlineTextClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l117.27"></a><span id="l117.27" class="difflineplus">+#define MimeSimpleStubClassInitializer(ITYPE, CSUPER) \</span>
<a href="#l117.28"></a><span id="l117.28" class="difflineplus">+  { MimeInlineTextClassInitializer(ITYPE, CSUPER) }</span>
<a href="#l117.29"></a><span id="l117.29"> </span>
<a href="#l117.30"></a><span id="l117.30"> MimeDefClass(MimeSimpleStub, MimeSimpleStubClass, mimeSimpleStubClass, NULL);</span>
<a href="#l117.31"></a><span id="l117.31"> </span>
<a href="#l117.32"></a><span id="l117.32" class="difflineminus">-static int</span>
<a href="#l117.33"></a><span id="l117.33" class="difflineminus">-BeginGather(MimeObject *obj)</span>
<a href="#l117.34"></a><span id="l117.34" class="difflineminus">-{</span>
<a href="#l117.35"></a><span id="l117.35" class="difflineminus">-    MimeSimpleStub *ssobj = (MimeSimpleStub *)obj;</span>
<a href="#l117.36"></a><span id="l117.36" class="difflineminus">-    int status = ((MimeObjectClass *)XPCOM_GetmimeLeafClass())-&gt;parse_begin(obj);</span>
<a href="#l117.37"></a><span id="l117.37" class="difflineplus">+static int BeginGather(MimeObject *obj) {</span>
<a href="#l117.38"></a><span id="l117.38" class="difflineplus">+  MimeSimpleStub *ssobj = (MimeSimpleStub *)obj;</span>
<a href="#l117.39"></a><span id="l117.39" class="difflineplus">+  int status = ((MimeObjectClass *)XPCOM_GetmimeLeafClass())-&gt;parse_begin(obj);</span>
<a href="#l117.40"></a><span id="l117.40"> </span>
<a href="#l117.41"></a><span id="l117.41" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l117.42"></a><span id="l117.42" class="difflineminus">-        return status;</span>
<a href="#l117.43"></a><span id="l117.43" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l117.44"></a><span id="l117.44"> </span>
<a href="#l117.45"></a><span id="l117.45" class="difflineminus">-    if (!obj-&gt;output_p ||</span>
<a href="#l117.46"></a><span id="l117.46" class="difflineminus">-        !obj-&gt;options ||</span>
<a href="#l117.47"></a><span id="l117.47" class="difflineminus">-        !obj-&gt;options-&gt;write_html_p) {</span>
<a href="#l117.48"></a><span id="l117.48" class="difflineminus">-        return 0;</span>
<a href="#l117.49"></a><span id="l117.49" class="difflineminus">-    }</span>
<a href="#l117.50"></a><span id="l117.50" class="difflineplus">+  if (!obj-&gt;output_p || !obj-&gt;options || !obj-&gt;options-&gt;write_html_p) {</span>
<a href="#l117.51"></a><span id="l117.51" class="difflineplus">+    return 0;</span>
<a href="#l117.52"></a><span id="l117.52" class="difflineplus">+  }</span>
<a href="#l117.53"></a><span id="l117.53"> </span>
<a href="#l117.54"></a><span id="l117.54" class="difflineminus">-    ssobj-&gt;buffer-&gt;Truncate();</span>
<a href="#l117.55"></a><span id="l117.55" class="difflineminus">-    return 0;</span>
<a href="#l117.56"></a><span id="l117.56" class="difflineplus">+  ssobj-&gt;buffer-&gt;Truncate();</span>
<a href="#l117.57"></a><span id="l117.57" class="difflineplus">+  return 0;</span>
<a href="#l117.58"></a><span id="l117.58"> }</span>
<a href="#l117.59"></a><span id="l117.59"> </span>
<a href="#l117.60"></a><span id="l117.60" class="difflineminus">-static int</span>
<a href="#l117.61"></a><span id="l117.61" class="difflineminus">-GatherLine(const char *line, int32_t length, MimeObject *obj)</span>
<a href="#l117.62"></a><span id="l117.62" class="difflineminus">-{</span>
<a href="#l117.63"></a><span id="l117.63" class="difflineminus">-    MimeSimpleStub *ssobj = (MimeSimpleStub *)obj;</span>
<a href="#l117.64"></a><span id="l117.64" class="difflineplus">+static int GatherLine(const char *line, int32_t length, MimeObject *obj) {</span>
<a href="#l117.65"></a><span id="l117.65" class="difflineplus">+  MimeSimpleStub *ssobj = (MimeSimpleStub *)obj;</span>
<a href="#l117.66"></a><span id="l117.66"> </span>
<a href="#l117.67"></a><span id="l117.67" class="difflineminus">-    if (!obj-&gt;output_p ||</span>
<a href="#l117.68"></a><span id="l117.68" class="difflineminus">-        !obj-&gt;options ||</span>
<a href="#l117.69"></a><span id="l117.69" class="difflineminus">-        !obj-&gt;options-&gt;output_fn) {</span>
<a href="#l117.70"></a><span id="l117.70" class="difflineminus">-        return 0;</span>
<a href="#l117.71"></a><span id="l117.71" class="difflineminus">-    }</span>
<a href="#l117.72"></a><span id="l117.72" class="difflineplus">+  if (!obj-&gt;output_p || !obj-&gt;options || !obj-&gt;options-&gt;output_fn) {</span>
<a href="#l117.73"></a><span id="l117.73" class="difflineplus">+    return 0;</span>
<a href="#l117.74"></a><span id="l117.74" class="difflineplus">+  }</span>
<a href="#l117.75"></a><span id="l117.75"> </span>
<a href="#l117.76"></a><span id="l117.76" class="difflineminus">-    if (!obj-&gt;options-&gt;write_html_p)</span>
<a href="#l117.77"></a><span id="l117.77" class="difflineminus">-        return MimeObject_write(obj, line, length, true);</span>
<a href="#l117.78"></a><span id="l117.78" class="difflineplus">+  if (!obj-&gt;options-&gt;write_html_p)</span>
<a href="#l117.79"></a><span id="l117.79" class="difflineplus">+    return MimeObject_write(obj, line, length, true);</span>
<a href="#l117.80"></a><span id="l117.80"> </span>
<a href="#l117.81"></a><span id="l117.81" class="difflineminus">-    ssobj-&gt;buffer-&gt;Append(line);</span>
<a href="#l117.82"></a><span id="l117.82" class="difflineminus">-    return 0;</span>
<a href="#l117.83"></a><span id="l117.83" class="difflineplus">+  ssobj-&gt;buffer-&gt;Append(line);</span>
<a href="#l117.84"></a><span id="l117.84" class="difflineplus">+  return 0;</span>
<a href="#l117.85"></a><span id="l117.85"> }</span>
<a href="#l117.86"></a><span id="l117.86"> </span>
<a href="#l117.87"></a><span id="l117.87" class="difflineminus">-static int</span>
<a href="#l117.88"></a><span id="l117.88" class="difflineminus">-EndGather(MimeObject *obj, bool abort_p)</span>
<a href="#l117.89"></a><span id="l117.89" class="difflineminus">-{</span>
<a href="#l117.90"></a><span id="l117.90" class="difflineminus">-    MimeSimpleStub *ssobj = (MimeSimpleStub *)obj;</span>
<a href="#l117.91"></a><span id="l117.91" class="difflineplus">+static int EndGather(MimeObject *obj, bool abort_p) {</span>
<a href="#l117.92"></a><span id="l117.92" class="difflineplus">+  MimeSimpleStub *ssobj = (MimeSimpleStub *)obj;</span>
<a href="#l117.93"></a><span id="l117.93" class="difflineplus">+</span>
<a href="#l117.94"></a><span id="l117.94" class="difflineplus">+  if (obj-&gt;closed_p) return 0;</span>
<a href="#l117.95"></a><span id="l117.95"> </span>
<a href="#l117.96"></a><span id="l117.96" class="difflineminus">-    if (obj-&gt;closed_p)</span>
<a href="#l117.97"></a><span id="l117.97" class="difflineminus">-        return 0;</span>
<a href="#l117.98"></a><span id="l117.98" class="difflineplus">+  int status = ((MimeObjectClass *)MIME_GetmimeInlineTextClass())</span>
<a href="#l117.99"></a><span id="l117.99" class="difflineplus">+                   -&gt;parse_eof(obj, abort_p);</span>
<a href="#l117.100"></a><span id="l117.100" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l117.101"></a><span id="l117.101"> </span>
<a href="#l117.102"></a><span id="l117.102" class="difflineminus">-    int status = ((MimeObjectClass *)MIME_GetmimeInlineTextClass())-&gt;parse_eof(obj, abort_p);</span>
<a href="#l117.103"></a><span id="l117.103" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l117.104"></a><span id="l117.104" class="difflineminus">-        return status;</span>
<a href="#l117.105"></a><span id="l117.105" class="difflineminus">-</span>
<a href="#l117.106"></a><span id="l117.106" class="difflineminus">-    if (ssobj-&gt;buffer-&gt;IsEmpty())</span>
<a href="#l117.107"></a><span id="l117.107" class="difflineminus">-        return 0;</span>
<a href="#l117.108"></a><span id="l117.108" class="difflineplus">+  if (ssobj-&gt;buffer-&gt;IsEmpty()) return 0;</span>
<a href="#l117.109"></a><span id="l117.109"> </span>
<a href="#l117.110"></a><span id="l117.110" class="difflineminus">-    mime_stream_data  *msd = (mime_stream_data *) (obj-&gt;options-&gt;stream_closure);</span>
<a href="#l117.111"></a><span id="l117.111" class="difflineminus">-    nsIChannel *channel = msd-&gt;channel;  // note the lack of ref counting...</span>
<a href="#l117.112"></a><span id="l117.112" class="difflineminus">-    if (channel)</span>
<a href="#l117.113"></a><span id="l117.113" class="difflineminus">-    {</span>
<a href="#l117.114"></a><span id="l117.114" class="difflineminus">-        nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l117.115"></a><span id="l117.115" class="difflineminus">-        channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l117.116"></a><span id="l117.116" class="difflineminus">-        ssobj-&gt;innerScriptable-&gt;SetUri(uri);</span>
<a href="#l117.117"></a><span id="l117.117" class="difflineminus">-    }</span>
<a href="#l117.118"></a><span id="l117.118" class="difflineminus">-    nsCString asHTML;</span>
<a href="#l117.119"></a><span id="l117.119" class="difflineminus">-    nsresult rv = ssobj-&gt;innerScriptable-&gt;ConvertToHTML(nsDependentCString(obj-&gt;content_type),</span>
<a href="#l117.120"></a><span id="l117.120" class="difflineminus">-                                                        *ssobj-&gt;buffer,</span>
<a href="#l117.121"></a><span id="l117.121" class="difflineminus">-                                                        asHTML);</span>
<a href="#l117.122"></a><span id="l117.122" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l117.123"></a><span id="l117.123" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;converter failure&quot;);</span>
<a href="#l117.124"></a><span id="l117.124" class="difflineminus">-        return -1;</span>
<a href="#l117.125"></a><span id="l117.125" class="difflineminus">-    }</span>
<a href="#l117.126"></a><span id="l117.126" class="difflineplus">+  mime_stream_data *msd = (mime_stream_data *)(obj-&gt;options-&gt;stream_closure);</span>
<a href="#l117.127"></a><span id="l117.127" class="difflineplus">+  nsIChannel *channel = msd-&gt;channel;  // note the lack of ref counting...</span>
<a href="#l117.128"></a><span id="l117.128" class="difflineplus">+  if (channel) {</span>
<a href="#l117.129"></a><span id="l117.129" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l117.130"></a><span id="l117.130" class="difflineplus">+    channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l117.131"></a><span id="l117.131" class="difflineplus">+    ssobj-&gt;innerScriptable-&gt;SetUri(uri);</span>
<a href="#l117.132"></a><span id="l117.132" class="difflineplus">+  }</span>
<a href="#l117.133"></a><span id="l117.133" class="difflineplus">+  nsCString asHTML;</span>
<a href="#l117.134"></a><span id="l117.134" class="difflineplus">+  nsresult rv = ssobj-&gt;innerScriptable-&gt;ConvertToHTML(</span>
<a href="#l117.135"></a><span id="l117.135" class="difflineplus">+      nsDependentCString(obj-&gt;content_type), *ssobj-&gt;buffer, asHTML);</span>
<a href="#l117.136"></a><span id="l117.136" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l117.137"></a><span id="l117.137" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;converter failure&quot;);</span>
<a href="#l117.138"></a><span id="l117.138" class="difflineplus">+    return -1;</span>
<a href="#l117.139"></a><span id="l117.139" class="difflineplus">+  }</span>
<a href="#l117.140"></a><span id="l117.140"> </span>
<a href="#l117.141"></a><span id="l117.141" class="difflineminus">-    // MimeObject_write wants a non-const string for some reason, but it doesn't mutate it</span>
<a href="#l117.142"></a><span id="l117.142" class="difflineminus">-    status = MimeObject_write(obj, asHTML.get(),</span>
<a href="#l117.143"></a><span id="l117.143" class="difflineminus">-                              asHTML.Length(), true);</span>
<a href="#l117.144"></a><span id="l117.144" class="difflineminus">-    if (status &lt; 0)</span>
<a href="#l117.145"></a><span id="l117.145" class="difflineminus">-        return status;</span>
<a href="#l117.146"></a><span id="l117.146" class="difflineminus">-    return 0;</span>
<a href="#l117.147"></a><span id="l117.147" class="difflineplus">+  // MimeObject_write wants a non-const string for some reason, but it doesn't</span>
<a href="#l117.148"></a><span id="l117.148" class="difflineplus">+  // mutate it</span>
<a href="#l117.149"></a><span id="l117.149" class="difflineplus">+  status = MimeObject_write(obj, asHTML.get(), asHTML.Length(), true);</span>
<a href="#l117.150"></a><span id="l117.150" class="difflineplus">+  if (status &lt; 0) return status;</span>
<a href="#l117.151"></a><span id="l117.151" class="difflineplus">+  return 0;</span>
<a href="#l117.152"></a><span id="l117.152"> }</span>
<a href="#l117.153"></a><span id="l117.153"> </span>
<a href="#l117.154"></a><span id="l117.154" class="difflineminus">-static int</span>
<a href="#l117.155"></a><span id="l117.155" class="difflineminus">-Initialize(MimeObject *obj)</span>
<a href="#l117.156"></a><span id="l117.156" class="difflineminus">-{</span>
<a href="#l117.157"></a><span id="l117.157" class="difflineminus">-    MimeSimpleStub *ssobj = (MimeSimpleStub *)obj;</span>
<a href="#l117.158"></a><span id="l117.158" class="difflineplus">+static int Initialize(MimeObject *obj) {</span>
<a href="#l117.159"></a><span id="l117.159" class="difflineplus">+  MimeSimpleStub *ssobj = (MimeSimpleStub *)obj;</span>
<a href="#l117.160"></a><span id="l117.160"> </span>
<a href="#l117.161"></a><span id="l117.161" class="difflineminus">-    nsresult rv;</span>
<a href="#l117.162"></a><span id="l117.162" class="difflineminus">-    nsCOMPtr&lt;nsICategoryManager&gt; catman =</span>
<a href="#l117.163"></a><span id="l117.163" class="difflineminus">-        do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l117.164"></a><span id="l117.164" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l117.165"></a><span id="l117.165" class="difflineminus">-        return -1;</span>
<a href="#l117.166"></a><span id="l117.166" class="difflineplus">+  nsresult rv;</span>
<a href="#l117.167"></a><span id="l117.167" class="difflineplus">+  nsCOMPtr&lt;nsICategoryManager&gt; catman =</span>
<a href="#l117.168"></a><span id="l117.168" class="difflineplus">+      do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l117.169"></a><span id="l117.169" class="difflineplus">+  if (NS_FAILED(rv)) return -1;</span>
<a href="#l117.170"></a><span id="l117.170"> </span>
<a href="#l117.171"></a><span id="l117.171" class="difflineminus">-    nsAutoCString contentType; // lowercase</span>
<a href="#l117.172"></a><span id="l117.172" class="difflineminus">-    ToLowerCase(nsDependentCString(obj-&gt;content_type), contentType);</span>
<a href="#l117.173"></a><span id="l117.173" class="difflineplus">+  nsAutoCString contentType;  // lowercase</span>
<a href="#l117.174"></a><span id="l117.174" class="difflineplus">+  ToLowerCase(nsDependentCString(obj-&gt;content_type), contentType);</span>
<a href="#l117.175"></a><span id="l117.175"> </span>
<a href="#l117.176"></a><span id="l117.176" class="difflineminus">-    nsCString value;</span>
<a href="#l117.177"></a><span id="l117.177" class="difflineminus">-    rv = catman-&gt;GetCategoryEntry(NS_SIMPLEMIMECONVERTERS_CATEGORY,</span>
<a href="#l117.178"></a><span id="l117.178" class="difflineminus">-                                  contentType, value);</span>
<a href="#l117.179"></a><span id="l117.179" class="difflineminus">-    if (NS_FAILED(rv) || value.IsEmpty())</span>
<a href="#l117.180"></a><span id="l117.180" class="difflineminus">-        return -1;</span>
<a href="#l117.181"></a><span id="l117.181" class="difflineplus">+  nsCString value;</span>
<a href="#l117.182"></a><span id="l117.182" class="difflineplus">+  rv = catman-&gt;GetCategoryEntry(NS_SIMPLEMIMECONVERTERS_CATEGORY, contentType,</span>
<a href="#l117.183"></a><span id="l117.183" class="difflineplus">+                                value);</span>
<a href="#l117.184"></a><span id="l117.184" class="difflineplus">+  if (NS_FAILED(rv) || value.IsEmpty()) return -1;</span>
<a href="#l117.185"></a><span id="l117.185"> </span>
<a href="#l117.186"></a><span id="l117.186" class="difflineminus">-    ssobj-&gt;innerScriptable = do_CreateInstance(value.get(), &amp;rv);</span>
<a href="#l117.187"></a><span id="l117.187" class="difflineminus">-    if (NS_FAILED(rv) || !ssobj-&gt;innerScriptable)</span>
<a href="#l117.188"></a><span id="l117.188" class="difflineminus">-        return -1;</span>
<a href="#l117.189"></a><span id="l117.189" class="difflineminus">-    ssobj-&gt;buffer = new nsCString();</span>
<a href="#l117.190"></a><span id="l117.190" class="difflineminus">-    ((MimeObjectClass *)XPCOM_GetmimeLeafClass())-&gt;initialize(obj);</span>
<a href="#l117.191"></a><span id="l117.191" class="difflineplus">+  ssobj-&gt;innerScriptable = do_CreateInstance(value.get(), &amp;rv);</span>
<a href="#l117.192"></a><span id="l117.192" class="difflineplus">+  if (NS_FAILED(rv) || !ssobj-&gt;innerScriptable) return -1;</span>
<a href="#l117.193"></a><span id="l117.193" class="difflineplus">+  ssobj-&gt;buffer = new nsCString();</span>
<a href="#l117.194"></a><span id="l117.194" class="difflineplus">+  ((MimeObjectClass *)XPCOM_GetmimeLeafClass())-&gt;initialize(obj);</span>
<a href="#l117.195"></a><span id="l117.195"> </span>
<a href="#l117.196"></a><span id="l117.196" class="difflineminus">-    return 0;</span>
<a href="#l117.197"></a><span id="l117.197" class="difflineplus">+  return 0;</span>
<a href="#l117.198"></a><span id="l117.198"> }</span>
<a href="#l117.199"></a><span id="l117.199"> </span>
<a href="#l117.200"></a><span id="l117.200" class="difflineminus">-static void</span>
<a href="#l117.201"></a><span id="l117.201" class="difflineminus">-Finalize(MimeObject *obj)</span>
<a href="#l117.202"></a><span id="l117.202" class="difflineminus">-{</span>
<a href="#l117.203"></a><span id="l117.203" class="difflineminus">-    MimeSimpleStub *ssobj = (MimeSimpleStub *)obj;</span>
<a href="#l117.204"></a><span id="l117.204" class="difflineminus">-    ssobj-&gt;innerScriptable = nullptr;</span>
<a href="#l117.205"></a><span id="l117.205" class="difflineminus">-    delete ssobj-&gt;buffer;</span>
<a href="#l117.206"></a><span id="l117.206" class="difflineplus">+static void Finalize(MimeObject *obj) {</span>
<a href="#l117.207"></a><span id="l117.207" class="difflineplus">+  MimeSimpleStub *ssobj = (MimeSimpleStub *)obj;</span>
<a href="#l117.208"></a><span id="l117.208" class="difflineplus">+  ssobj-&gt;innerScriptable = nullptr;</span>
<a href="#l117.209"></a><span id="l117.209" class="difflineplus">+  delete ssobj-&gt;buffer;</span>
<a href="#l117.210"></a><span id="l117.210" class="difflineplus">+}</span>
<a href="#l117.211"></a><span id="l117.211" class="difflineplus">+</span>
<a href="#l117.212"></a><span id="l117.212" class="difflineplus">+static int MimeSimpleStubClassInitialize(MimeSimpleStubClass *clazz) {</span>
<a href="#l117.213"></a><span id="l117.213" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l117.214"></a><span id="l117.214" class="difflineplus">+  oclass-&gt;parse_begin = BeginGather;</span>
<a href="#l117.215"></a><span id="l117.215" class="difflineplus">+  oclass-&gt;parse_line = GatherLine;</span>
<a href="#l117.216"></a><span id="l117.216" class="difflineplus">+  oclass-&gt;parse_eof = EndGather;</span>
<a href="#l117.217"></a><span id="l117.217" class="difflineplus">+  oclass-&gt;initialize = Initialize;</span>
<a href="#l117.218"></a><span id="l117.218" class="difflineplus">+  oclass-&gt;finalize = Finalize;</span>
<a href="#l117.219"></a><span id="l117.219" class="difflineplus">+  return 0;</span>
<a href="#l117.220"></a><span id="l117.220"> }</span>
<a href="#l117.221"></a><span id="l117.221"> </span>
<a href="#l117.222"></a><span id="l117.222" class="difflineminus">-static int</span>
<a href="#l117.223"></a><span id="l117.223" class="difflineminus">-MimeSimpleStubClassInitialize(MimeSimpleStubClass *clazz)</span>
<a href="#l117.224"></a><span id="l117.224" class="difflineminus">-{</span>
<a href="#l117.225"></a><span id="l117.225" class="difflineminus">-    MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l117.226"></a><span id="l117.226" class="difflineminus">-    oclass-&gt;parse_begin = BeginGather;</span>
<a href="#l117.227"></a><span id="l117.227" class="difflineminus">-    oclass-&gt;parse_line = GatherLine;</span>
<a href="#l117.228"></a><span id="l117.228" class="difflineminus">-    oclass-&gt;parse_eof = EndGather;</span>
<a href="#l117.229"></a><span id="l117.229" class="difflineminus">-    oclass-&gt;initialize = Initialize;</span>
<a href="#l117.230"></a><span id="l117.230" class="difflineminus">-    oclass-&gt;finalize = Finalize;</span>
<a href="#l117.231"></a><span id="l117.231" class="difflineminus">-    return 0;</span>
<a href="#l117.232"></a><span id="l117.232" class="difflineminus">-}</span>
<a href="#l117.233"></a><span id="l117.233" class="difflineplus">+class nsSimpleMimeConverterStub : public nsIMimeContentTypeHandler {</span>
<a href="#l117.234"></a><span id="l117.234" class="difflineplus">+ public:</span>
<a href="#l117.235"></a><span id="l117.235" class="difflineplus">+  explicit nsSimpleMimeConverterStub(const char *aContentType)</span>
<a href="#l117.236"></a><span id="l117.236" class="difflineplus">+      : mContentType(aContentType) {}</span>
<a href="#l117.237"></a><span id="l117.237" class="difflineplus">+</span>
<a href="#l117.238"></a><span id="l117.238" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l117.239"></a><span id="l117.239"> </span>
<a href="#l117.240"></a><span id="l117.240" class="difflineminus">-class nsSimpleMimeConverterStub : public nsIMimeContentTypeHandler</span>
<a href="#l117.241"></a><span id="l117.241" class="difflineminus">-{</span>
<a href="#l117.242"></a><span id="l117.242" class="difflineminus">-public:</span>
<a href="#l117.243"></a><span id="l117.243" class="difflineminus">-    explicit nsSimpleMimeConverterStub(const char *aContentType) : mContentType(aContentType) { }</span>
<a href="#l117.244"></a><span id="l117.244" class="difflineminus">-</span>
<a href="#l117.245"></a><span id="l117.245" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l117.246"></a><span id="l117.246" class="difflineplus">+  NS_IMETHOD GetContentType(char **contentType) override {</span>
<a href="#l117.247"></a><span id="l117.247" class="difflineplus">+    *contentType = ToNewCString(mContentType);</span>
<a href="#l117.248"></a><span id="l117.248" class="difflineplus">+    return *contentType ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l117.249"></a><span id="l117.249" class="difflineplus">+  }</span>
<a href="#l117.250"></a><span id="l117.250" class="difflineplus">+  NS_IMETHOD CreateContentTypeHandlerClass(</span>
<a href="#l117.251"></a><span id="l117.251" class="difflineplus">+      const char *contentType, contentTypeHandlerInitStruct *initString,</span>
<a href="#l117.252"></a><span id="l117.252" class="difflineplus">+      MimeObjectClass **objClass) override;</span>
<a href="#l117.253"></a><span id="l117.253"> </span>
<a href="#l117.254"></a><span id="l117.254" class="difflineminus">-    NS_IMETHOD GetContentType(char **contentType) override</span>
<a href="#l117.255"></a><span id="l117.255" class="difflineminus">-    {</span>
<a href="#l117.256"></a><span id="l117.256" class="difflineminus">-        *contentType = ToNewCString(mContentType);</span>
<a href="#l117.257"></a><span id="l117.257" class="difflineminus">-        return *contentType ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l117.258"></a><span id="l117.258" class="difflineminus">-    }</span>
<a href="#l117.259"></a><span id="l117.259" class="difflineminus">-    NS_IMETHOD CreateContentTypeHandlerClass(const char *contentType,</span>
<a href="#l117.260"></a><span id="l117.260" class="difflineminus">-                                             contentTypeHandlerInitStruct *initString,</span>
<a href="#l117.261"></a><span id="l117.261" class="difflineminus">-                                             MimeObjectClass **objClass) override;</span>
<a href="#l117.262"></a><span id="l117.262" class="difflineminus">-private:</span>
<a href="#l117.263"></a><span id="l117.263" class="difflineminus">-    virtual ~nsSimpleMimeConverterStub() { }</span>
<a href="#l117.264"></a><span id="l117.264" class="difflineminus">-    nsCString mContentType;</span>
<a href="#l117.265"></a><span id="l117.265" class="difflineplus">+ private:</span>
<a href="#l117.266"></a><span id="l117.266" class="difflineplus">+  virtual ~nsSimpleMimeConverterStub() {}</span>
<a href="#l117.267"></a><span id="l117.267" class="difflineplus">+  nsCString mContentType;</span>
<a href="#l117.268"></a><span id="l117.268"> };</span>
<a href="#l117.269"></a><span id="l117.269"> </span>
<a href="#l117.270"></a><span id="l117.270"> NS_IMPL_ISUPPORTS(nsSimpleMimeConverterStub, nsIMimeContentTypeHandler)</span>
<a href="#l117.271"></a><span id="l117.271"> </span>
<a href="#l117.272"></a><span id="l117.272"> NS_IMETHODIMP</span>
<a href="#l117.273"></a><span id="l117.273" class="difflineminus">-nsSimpleMimeConverterStub::CreateContentTypeHandlerClass(const char *contentType,</span>
<a href="#l117.274"></a><span id="l117.274" class="difflineminus">-                                                     contentTypeHandlerInitStruct *initStruct,</span>
<a href="#l117.275"></a><span id="l117.275" class="difflineminus">-                                                         MimeObjectClass **objClass)</span>
<a href="#l117.276"></a><span id="l117.276" class="difflineminus">-{</span>
<a href="#l117.277"></a><span id="l117.277" class="difflineminus">-    NS_ENSURE_ARG_POINTER(objClass);</span>
<a href="#l117.278"></a><span id="l117.278" class="difflineplus">+nsSimpleMimeConverterStub::CreateContentTypeHandlerClass(</span>
<a href="#l117.279"></a><span id="l117.279" class="difflineplus">+    const char *contentType, contentTypeHandlerInitStruct *initStruct,</span>
<a href="#l117.280"></a><span id="l117.280" class="difflineplus">+    MimeObjectClass **objClass) {</span>
<a href="#l117.281"></a><span id="l117.281" class="difflineplus">+  NS_ENSURE_ARG_POINTER(objClass);</span>
<a href="#l117.282"></a><span id="l117.282"> </span>
<a href="#l117.283"></a><span id="l117.283" class="difflineminus">-    *objClass = (MimeObjectClass *)&amp;mimeSimpleStubClass;</span>
<a href="#l117.284"></a><span id="l117.284" class="difflineminus">-    (*objClass)-&gt;superclass = (MimeObjectClass *)XPCOM_GetmimeInlineTextClass();</span>
<a href="#l117.285"></a><span id="l117.285" class="difflineminus">-    NS_ENSURE_TRUE((*objClass)-&gt;superclass, NS_ERROR_UNEXPECTED);</span>
<a href="#l117.286"></a><span id="l117.286" class="difflineplus">+  *objClass = (MimeObjectClass *)&amp;mimeSimpleStubClass;</span>
<a href="#l117.287"></a><span id="l117.287" class="difflineplus">+  (*objClass)-&gt;superclass = (MimeObjectClass *)XPCOM_GetmimeInlineTextClass();</span>
<a href="#l117.288"></a><span id="l117.288" class="difflineplus">+  NS_ENSURE_TRUE((*objClass)-&gt;superclass, NS_ERROR_UNEXPECTED);</span>
<a href="#l117.289"></a><span id="l117.289"> </span>
<a href="#l117.290"></a><span id="l117.290" class="difflineminus">-    initStruct-&gt;force_inline_display = true;</span>
<a href="#l117.291"></a><span id="l117.291" class="difflineminus">-    return NS_OK;;</span>
<a href="#l117.292"></a><span id="l117.292" class="difflineplus">+  initStruct-&gt;force_inline_display = true;</span>
<a href="#l117.293"></a><span id="l117.293" class="difflineplus">+  return NS_OK;</span>
<a href="#l117.294"></a><span id="l117.294" class="difflineplus">+  ;</span>
<a href="#l117.295"></a><span id="l117.295"> }</span>
<a href="#l117.296"></a><span id="l117.296"> </span>
<a href="#l117.297"></a><span id="l117.297" class="difflineminus">-nsresult</span>
<a href="#l117.298"></a><span id="l117.298" class="difflineminus">-MIME_NewSimpleMimeConverterStub(const char *aContentType,</span>
<a href="#l117.299"></a><span id="l117.299" class="difflineminus">-                                nsIMimeContentTypeHandler **aResult)</span>
<a href="#l117.300"></a><span id="l117.300" class="difflineminus">-{</span>
<a href="#l117.301"></a><span id="l117.301" class="difflineminus">-    RefPtr&lt;nsSimpleMimeConverterStub&gt; inst = new nsSimpleMimeConverterStub(aContentType);</span>
<a href="#l117.302"></a><span id="l117.302" class="difflineminus">-    NS_ENSURE_TRUE(inst, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l117.303"></a><span id="l117.303" class="difflineplus">+nsresult MIME_NewSimpleMimeConverterStub(const char *aContentType,</span>
<a href="#l117.304"></a><span id="l117.304" class="difflineplus">+                                         nsIMimeContentTypeHandler **aResult) {</span>
<a href="#l117.305"></a><span id="l117.305" class="difflineplus">+  RefPtr&lt;nsSimpleMimeConverterStub&gt; inst =</span>
<a href="#l117.306"></a><span id="l117.306" class="difflineplus">+      new nsSimpleMimeConverterStub(aContentType);</span>
<a href="#l117.307"></a><span id="l117.307" class="difflineplus">+  NS_ENSURE_TRUE(inst, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l117.308"></a><span id="l117.308"> </span>
<a href="#l117.309"></a><span id="l117.309" class="difflineminus">-    inst.forget(aResult);</span>
<a href="#l117.310"></a><span id="l117.310" class="difflineminus">-    return NS_OK;</span>
<a href="#l117.311"></a><span id="l117.311" class="difflineplus">+  inst.forget(aResult);</span>
<a href="#l117.312"></a><span id="l117.312" class="difflineplus">+  return NS_OK;</span>
<a href="#l117.313"></a><span id="l117.313"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l118.1"></a><span id="l118.1" class="difflineminus">--- a/mailnews/mime/src/nsSimpleMimeConverterStub.h</span>
<a href="#l118.2"></a><span id="l118.2" class="difflineplus">+++ b/mailnews/mime/src/nsSimpleMimeConverterStub.h</span>
<a href="#l118.3"></a><span id="l118.3" class="difflineat">@@ -1,13 +1,12 @@</span>
<a href="#l118.4"></a><span id="l118.4"> /* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l118.5"></a><span id="l118.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l118.6"></a><span id="l118.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l118.7"></a><span id="l118.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l118.8"></a><span id="l118.8"> </span>
<a href="#l118.9"></a><span id="l118.9"> #ifndef NS_SIMPLE_MIME_CONVERTER_STUB_H_</span>
<a href="#l118.10"></a><span id="l118.10"> #define NS_SIMPLE_MIME_CONVERTER_STUB_H_</span>
<a href="#l118.11"></a><span id="l118.11"> </span>
<a href="#l118.12"></a><span id="l118.12" class="difflineminus">-nsresult</span>
<a href="#l118.13"></a><span id="l118.13" class="difflineminus">-MIME_NewSimpleMimeConverterStub(const char *aContentType,</span>
<a href="#l118.14"></a><span id="l118.14" class="difflineminus">-                                nsIMimeContentTypeHandler **aResult);</span>
<a href="#l118.15"></a><span id="l118.15" class="difflineplus">+nsresult MIME_NewSimpleMimeConverterStub(const char *aContentType,</span>
<a href="#l118.16"></a><span id="l118.16" class="difflineplus">+                                         nsIMimeContentTypeHandler **aResult);</span>
<a href="#l118.17"></a><span id="l118.17"> </span>
<a href="#l118.18"></a><span id="l118.18"> #endif /* NS_SIMPLE_MIME_CONVERTER_STUB_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l119.1"></a><span id="l119.1" class="difflineminus">--- a/mailnews/mime/src/nsStreamConverter.cpp</span>
<a href="#l119.2"></a><span id="l119.2" class="difflineplus">+++ b/mailnews/mime/src/nsStreamConverter.cpp</span>
<a href="#l119.3"></a><span id="l119.3" class="difflineat">@@ -33,325 +33,265 @@</span>
<a href="#l119.4"></a><span id="l119.4"> </span>
<a href="#l119.5"></a><span id="l119.5"> #define PREF_MAIL_DISPLAY_GLYPH &quot;mail.display_glyph&quot;</span>
<a href="#l119.6"></a><span id="l119.6"> #define PREF_MAIL_DISPLAY_STRUCT &quot;mail.display_struct&quot;</span>
<a href="#l119.7"></a><span id="l119.7"> </span>
<a href="#l119.8"></a><span id="l119.8"> ////////////////////////////////////////////////////////////////</span>
<a href="#l119.9"></a><span id="l119.9"> // Bridge routines for new stream converter XP-COM interface</span>
<a href="#l119.10"></a><span id="l119.10"> ////////////////////////////////////////////////////////////////</span>
<a href="#l119.11"></a><span id="l119.11"> </span>
<a href="#l119.12"></a><span id="l119.12" class="difflineminus">-extern &quot;C&quot; void  *</span>
<a href="#l119.13"></a><span id="l119.13" class="difflineminus">-mime_bridge_create_draft_stream(nsIMimeEmitter      *newEmitter,</span>
<a href="#l119.14"></a><span id="l119.14" class="difflineminus">-                                nsStreamConverter   *newPluginObj2,</span>
<a href="#l119.15"></a><span id="l119.15" class="difflineminus">-                                nsIURI              *uri,</span>
<a href="#l119.16"></a><span id="l119.16" class="difflineminus">-                                nsMimeOutputType    format_out);</span>
<a href="#l119.17"></a><span id="l119.17" class="difflineplus">+extern &quot;C&quot; void *mime_bridge_create_draft_stream(</span>
<a href="#l119.18"></a><span id="l119.18" class="difflineplus">+    nsIMimeEmitter *newEmitter, nsStreamConverter *newPluginObj2, nsIURI *uri,</span>
<a href="#l119.19"></a><span id="l119.19" class="difflineplus">+    nsMimeOutputType format_out);</span>
<a href="#l119.20"></a><span id="l119.20"> </span>
<a href="#l119.21"></a><span id="l119.21" class="difflineminus">-extern &quot;C&quot; void  *</span>
<a href="#l119.22"></a><span id="l119.22" class="difflineminus">-bridge_create_stream(nsIMimeEmitter      *newEmitter,</span>
<a href="#l119.23"></a><span id="l119.23" class="difflineminus">-                     nsStreamConverter   *newPluginObj2,</span>
<a href="#l119.24"></a><span id="l119.24" class="difflineminus">-                     nsIURI              *uri,</span>
<a href="#l119.25"></a><span id="l119.25" class="difflineminus">-                     nsMimeOutputType    format_out,</span>
<a href="#l119.26"></a><span id="l119.26" class="difflineminus">-                     uint32_t            whattodo,</span>
<a href="#l119.27"></a><span id="l119.27" class="difflineminus">-                     nsIChannel          *aChannel)</span>
<a href="#l119.28"></a><span id="l119.28" class="difflineminus">-{</span>
<a href="#l119.29"></a><span id="l119.29" class="difflineminus">-  if  ( (format_out == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l119.30"></a><span id="l119.30" class="difflineminus">-        (format_out == nsMimeOutput::nsMimeMessageEditorTemplate) )</span>
<a href="#l119.31"></a><span id="l119.31" class="difflineminus">-    return mime_bridge_create_draft_stream(newEmitter, newPluginObj2, uri, format_out);</span>
<a href="#l119.32"></a><span id="l119.32" class="difflineplus">+extern &quot;C&quot; void *bridge_create_stream(nsIMimeEmitter *newEmitter,</span>
<a href="#l119.33"></a><span id="l119.33" class="difflineplus">+                                      nsStreamConverter *newPluginObj2,</span>
<a href="#l119.34"></a><span id="l119.34" class="difflineplus">+                                      nsIURI *uri, nsMimeOutputType format_out,</span>
<a href="#l119.35"></a><span id="l119.35" class="difflineplus">+                                      uint32_t whattodo, nsIChannel *aChannel) {</span>
<a href="#l119.36"></a><span id="l119.36" class="difflineplus">+  if ((format_out == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l119.37"></a><span id="l119.37" class="difflineplus">+      (format_out == nsMimeOutput::nsMimeMessageEditorTemplate))</span>
<a href="#l119.38"></a><span id="l119.38" class="difflineplus">+    return mime_bridge_create_draft_stream(newEmitter, newPluginObj2, uri,</span>
<a href="#l119.39"></a><span id="l119.39" class="difflineplus">+                                           format_out);</span>
<a href="#l119.40"></a><span id="l119.40">   else</span>
<a href="#l119.41"></a><span id="l119.41" class="difflineminus">-    return mime_bridge_create_display_stream(newEmitter, newPluginObj2, uri, format_out, whattodo,</span>
<a href="#l119.42"></a><span id="l119.42" class="difflineminus">-                                             aChannel);</span>
<a href="#l119.43"></a><span id="l119.43" class="difflineplus">+    return mime_bridge_create_display_stream(newEmitter, newPluginObj2, uri,</span>
<a href="#l119.44"></a><span id="l119.44" class="difflineplus">+                                             format_out, whattodo, aChannel);</span>
<a href="#l119.45"></a><span id="l119.45"> }</span>
<a href="#l119.46"></a><span id="l119.46"> </span>
<a href="#l119.47"></a><span id="l119.47" class="difflineminus">-void</span>
<a href="#l119.48"></a><span id="l119.48" class="difflineminus">-bridge_destroy_stream(void *newStream)</span>
<a href="#l119.49"></a><span id="l119.49" class="difflineminus">-{</span>
<a href="#l119.50"></a><span id="l119.50" class="difflineminus">-  nsMIMESession     *stream = (nsMIMESession *)newStream;</span>
<a href="#l119.51"></a><span id="l119.51" class="difflineminus">-  if (!stream)</span>
<a href="#l119.52"></a><span id="l119.52" class="difflineminus">-    return;</span>
<a href="#l119.53"></a><span id="l119.53" class="difflineplus">+void bridge_destroy_stream(void *newStream) {</span>
<a href="#l119.54"></a><span id="l119.54" class="difflineplus">+  nsMIMESession *stream = (nsMIMESession *)newStream;</span>
<a href="#l119.55"></a><span id="l119.55" class="difflineplus">+  if (!stream) return;</span>
<a href="#l119.56"></a><span id="l119.56"> </span>
<a href="#l119.57"></a><span id="l119.57">   PR_FREEIF(stream);</span>
<a href="#l119.58"></a><span id="l119.58"> }</span>
<a href="#l119.59"></a><span id="l119.59"> </span>
<a href="#l119.60"></a><span id="l119.60" class="difflineminus">-void</span>
<a href="#l119.61"></a><span id="l119.61" class="difflineminus">-bridge_set_output_type(void *bridgeStream, nsMimeOutputType aType)</span>
<a href="#l119.62"></a><span id="l119.62" class="difflineminus">-{</span>
<a href="#l119.63"></a><span id="l119.63" class="difflineplus">+void bridge_set_output_type(void *bridgeStream, nsMimeOutputType aType) {</span>
<a href="#l119.64"></a><span id="l119.64">   nsMIMESession *session = (nsMIMESession *)bridgeStream;</span>
<a href="#l119.65"></a><span id="l119.65"> </span>
<a href="#l119.66"></a><span id="l119.66" class="difflineminus">-  if (session)</span>
<a href="#l119.67"></a><span id="l119.67" class="difflineminus">-  {</span>
<a href="#l119.68"></a><span id="l119.68" class="difflineplus">+  if (session) {</span>
<a href="#l119.69"></a><span id="l119.69">     // BAD ASSUMPTION!!!! NEED TO CHECK aType</span>
<a href="#l119.70"></a><span id="l119.70">     mime_stream_data *msd = (mime_stream_data *)session-&gt;data_object;</span>
<a href="#l119.71"></a><span id="l119.71" class="difflineminus">-    if (msd)</span>
<a href="#l119.72"></a><span id="l119.72" class="difflineminus">-      msd-&gt;format_out = aType;     // output format type</span>
<a href="#l119.73"></a><span id="l119.73" class="difflineplus">+    if (msd) msd-&gt;format_out = aType;  // output format type</span>
<a href="#l119.74"></a><span id="l119.74">   }</span>
<a href="#l119.75"></a><span id="l119.75"> }</span>
<a href="#l119.76"></a><span id="l119.76"> </span>
<a href="#l119.77"></a><span id="l119.77" class="difflineminus">-nsresult</span>
<a href="#l119.78"></a><span id="l119.78" class="difflineminus">-bridge_new_new_uri(void *bridgeStream, nsIURI *aURI, int32_t aOutputType)</span>
<a href="#l119.79"></a><span id="l119.79" class="difflineminus">-{</span>
<a href="#l119.80"></a><span id="l119.80" class="difflineplus">+nsresult bridge_new_new_uri(void *bridgeStream, nsIURI *aURI,</span>
<a href="#l119.81"></a><span id="l119.81" class="difflineplus">+                            int32_t aOutputType) {</span>
<a href="#l119.82"></a><span id="l119.82">   nsMIMESession *session = (nsMIMESession *)bridgeStream;</span>
<a href="#l119.83"></a><span id="l119.83" class="difflineminus">-  const char    **fixup_pointer = nullptr;</span>
<a href="#l119.84"></a><span id="l119.84" class="difflineplus">+  const char **fixup_pointer = nullptr;</span>
<a href="#l119.85"></a><span id="l119.85"> </span>
<a href="#l119.86"></a><span id="l119.86" class="difflineminus">-  if (session)</span>
<a href="#l119.87"></a><span id="l119.87" class="difflineminus">-  {</span>
<a href="#l119.88"></a><span id="l119.88" class="difflineminus">-    if (session-&gt;data_object)</span>
<a href="#l119.89"></a><span id="l119.89" class="difflineminus">-    {</span>
<a href="#l119.90"></a><span id="l119.90" class="difflineminus">-      bool     *override_charset = nullptr;</span>
<a href="#l119.91"></a><span id="l119.91" class="difflineminus">-      char    **default_charset = nullptr;</span>
<a href="#l119.92"></a><span id="l119.92" class="difflineminus">-      char    **url_name = nullptr;</span>
<a href="#l119.93"></a><span id="l119.93" class="difflineplus">+  if (session) {</span>
<a href="#l119.94"></a><span id="l119.94" class="difflineplus">+    if (session-&gt;data_object) {</span>
<a href="#l119.95"></a><span id="l119.95" class="difflineplus">+      bool *override_charset = nullptr;</span>
<a href="#l119.96"></a><span id="l119.96" class="difflineplus">+      char **default_charset = nullptr;</span>
<a href="#l119.97"></a><span id="l119.97" class="difflineplus">+      char **url_name = nullptr;</span>
<a href="#l119.98"></a><span id="l119.98"> </span>
<a href="#l119.99"></a><span id="l119.99" class="difflineminus">-      if  ( (aOutputType == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l119.100"></a><span id="l119.100" class="difflineminus">-            (aOutputType == nsMimeOutput::nsMimeMessageEditorTemplate) )</span>
<a href="#l119.101"></a><span id="l119.101" class="difflineminus">-      {</span>
<a href="#l119.102"></a><span id="l119.102" class="difflineplus">+      if ((aOutputType == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l119.103"></a><span id="l119.103" class="difflineplus">+          (aOutputType == nsMimeOutput::nsMimeMessageEditorTemplate)) {</span>
<a href="#l119.104"></a><span id="l119.104">         mime_draft_data *mdd = (mime_draft_data *)session-&gt;data_object;</span>
<a href="#l119.105"></a><span id="l119.105" class="difflineminus">-        if (mdd-&gt;options)</span>
<a href="#l119.106"></a><span id="l119.106" class="difflineminus">-        {</span>
<a href="#l119.107"></a><span id="l119.107" class="difflineplus">+        if (mdd-&gt;options) {</span>
<a href="#l119.108"></a><span id="l119.108">           default_charset = &amp;(mdd-&gt;options-&gt;default_charset);</span>
<a href="#l119.109"></a><span id="l119.109">           override_charset = &amp;(mdd-&gt;options-&gt;override_charset);</span>
<a href="#l119.110"></a><span id="l119.110">           url_name = &amp;(mdd-&gt;url_name);</span>
<a href="#l119.111"></a><span id="l119.111">         }</span>
<a href="#l119.112"></a><span id="l119.112" class="difflineminus">-      }</span>
<a href="#l119.113"></a><span id="l119.113" class="difflineminus">-      else</span>
<a href="#l119.114"></a><span id="l119.114" class="difflineminus">-      {</span>
<a href="#l119.115"></a><span id="l119.115" class="difflineplus">+      } else {</span>
<a href="#l119.116"></a><span id="l119.116">         mime_stream_data *msd = (mime_stream_data *)session-&gt;data_object;</span>
<a href="#l119.117"></a><span id="l119.117"> </span>
<a href="#l119.118"></a><span id="l119.118" class="difflineminus">-        if (msd-&gt;options)</span>
<a href="#l119.119"></a><span id="l119.119" class="difflineminus">-        {</span>
<a href="#l119.120"></a><span id="l119.120" class="difflineplus">+        if (msd-&gt;options) {</span>
<a href="#l119.121"></a><span id="l119.121">           default_charset = &amp;(msd-&gt;options-&gt;default_charset);</span>
<a href="#l119.122"></a><span id="l119.122">           override_charset = &amp;(msd-&gt;options-&gt;override_charset);</span>
<a href="#l119.123"></a><span id="l119.123">           url_name = &amp;(msd-&gt;url_name);</span>
<a href="#l119.124"></a><span id="l119.124">           fixup_pointer = &amp;(msd-&gt;options-&gt;url);</span>
<a href="#l119.125"></a><span id="l119.125">         }</span>
<a href="#l119.126"></a><span id="l119.126">       }</span>
<a href="#l119.127"></a><span id="l119.127"> </span>
<a href="#l119.128"></a><span id="l119.128" class="difflineminus">-      if ( (default_charset) &amp;&amp; (override_charset) &amp;&amp; (url_name) )</span>
<a href="#l119.129"></a><span id="l119.129" class="difflineminus">-      {</span>
<a href="#l119.130"></a><span id="l119.130" class="difflineplus">+      if ((default_charset) &amp;&amp; (override_charset) &amp;&amp; (url_name)) {</span>
<a href="#l119.131"></a><span id="l119.131">         //</span>
<a href="#l119.132"></a><span id="l119.132" class="difflineminus">-        // set the default charset to be the folder charset if we have one associated with</span>
<a href="#l119.133"></a><span id="l119.133" class="difflineminus">-        // this url...</span>
<a href="#l119.134"></a><span id="l119.134" class="difflineminus">-        nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nUrl (do_QueryInterface(aURI));</span>
<a href="#l119.135"></a><span id="l119.135" class="difflineminus">-        if (i18nUrl)</span>
<a href="#l119.136"></a><span id="l119.136" class="difflineminus">-        {</span>
<a href="#l119.137"></a><span id="l119.137" class="difflineplus">+        // set the default charset to be the folder charset if we have one</span>
<a href="#l119.138"></a><span id="l119.138" class="difflineplus">+        // associated with this url...</span>
<a href="#l119.139"></a><span id="l119.139" class="difflineplus">+        nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nUrl(do_QueryInterface(aURI));</span>
<a href="#l119.140"></a><span id="l119.140" class="difflineplus">+        if (i18nUrl) {</span>
<a href="#l119.141"></a><span id="l119.141">           nsCString charset;</span>
<a href="#l119.142"></a><span id="l119.142"> </span>
<a href="#l119.143"></a><span id="l119.143" class="difflineminus">-          // check to see if we have a charset override...and if we do, set that field appropriately too...</span>
<a href="#l119.144"></a><span id="l119.144" class="difflineplus">+          // check to see if we have a charset override...and if we do, set that</span>
<a href="#l119.145"></a><span id="l119.145" class="difflineplus">+          // field appropriately too...</span>
<a href="#l119.146"></a><span id="l119.146">           nsresult rv = i18nUrl-&gt;GetCharsetOverRide(getter_Copies(charset));</span>
<a href="#l119.147"></a><span id="l119.147" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; !charset.IsEmpty() ) {</span>
<a href="#l119.148"></a><span id="l119.148" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; !charset.IsEmpty()) {</span>
<a href="#l119.149"></a><span id="l119.149">             *override_charset = true;</span>
<a href="#l119.150"></a><span id="l119.150">             *default_charset = ToNewCString(charset);</span>
<a href="#l119.151"></a><span id="l119.151" class="difflineminus">-          }</span>
<a href="#l119.152"></a><span id="l119.152" class="difflineminus">-          else</span>
<a href="#l119.153"></a><span id="l119.153" class="difflineminus">-          {</span>
<a href="#l119.154"></a><span id="l119.154" class="difflineplus">+          } else {</span>
<a href="#l119.155"></a><span id="l119.155">             i18nUrl-&gt;GetFolderCharset(getter_Copies(charset));</span>
<a href="#l119.156"></a><span id="l119.156" class="difflineminus">-            if (!charset.IsEmpty())</span>
<a href="#l119.157"></a><span id="l119.157" class="difflineminus">-              *default_charset = ToNewCString(charset);</span>
<a href="#l119.158"></a><span id="l119.158" class="difflineplus">+            if (!charset.IsEmpty()) *default_charset = ToNewCString(charset);</span>
<a href="#l119.159"></a><span id="l119.159">           }</span>
<a href="#l119.160"></a><span id="l119.160"> </span>
<a href="#l119.161"></a><span id="l119.161">           // if there is no manual override and a folder charset exists</span>
<a href="#l119.162"></a><span id="l119.162">           // then check if we have a folder level override</span>
<a href="#l119.163"></a><span id="l119.163" class="difflineminus">-          if (!(*override_charset) &amp;&amp; *default_charset &amp;&amp; **default_charset)</span>
<a href="#l119.164"></a><span id="l119.164" class="difflineminus">-          {</span>
<a href="#l119.165"></a><span id="l119.165" class="difflineplus">+          if (!(*override_charset) &amp;&amp; *default_charset &amp;&amp; **default_charset) {</span>
<a href="#l119.166"></a><span id="l119.166">             bool folderCharsetOverride;</span>
<a href="#l119.167"></a><span id="l119.167">             rv = i18nUrl-&gt;GetFolderCharsetOverride(&amp;folderCharsetOverride);</span>
<a href="#l119.168"></a><span id="l119.168">             if (NS_SUCCEEDED(rv) &amp;&amp; folderCharsetOverride)</span>
<a href="#l119.169"></a><span id="l119.169">               *override_charset = true;</span>
<a href="#l119.170"></a><span id="l119.170"> </span>
<a href="#l119.171"></a><span id="l119.171">             // notify the default to msgWindow (for the menu check mark)</span>
<a href="#l119.172"></a><span id="l119.172">             // do not set the default in case of nsMimeMessageDraftOrTemplate</span>
<a href="#l119.173"></a><span id="l119.173">             // or nsMimeMessageEditorTemplate because it is already set</span>
<a href="#l119.174"></a><span id="l119.174">             // when the message is displayed and doing it again may overwrite</span>
<a href="#l119.175"></a><span id="l119.175">             // the correct MIME charset parsed from the message header</span>
<a href="#l119.176"></a><span id="l119.176">             if (aOutputType != nsMimeOutput::nsMimeMessageDraftOrTemplate &amp;&amp;</span>
<a href="#l119.177"></a><span id="l119.177" class="difflineminus">-                aOutputType != nsMimeOutput::nsMimeMessageEditorTemplate)</span>
<a href="#l119.178"></a><span id="l119.178" class="difflineminus">-            {</span>
<a href="#l119.179"></a><span id="l119.179" class="difflineminus">-              nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(aURI));</span>
<a href="#l119.180"></a><span id="l119.180" class="difflineminus">-              if (msgurl)</span>
<a href="#l119.181"></a><span id="l119.181" class="difflineminus">-              {</span>
<a href="#l119.182"></a><span id="l119.182" class="difflineplus">+                aOutputType != nsMimeOutput::nsMimeMessageEditorTemplate) {</span>
<a href="#l119.183"></a><span id="l119.183" class="difflineplus">+              nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(aURI));</span>
<a href="#l119.184"></a><span id="l119.184" class="difflineplus">+              if (msgurl) {</span>
<a href="#l119.185"></a><span id="l119.185">                 nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l119.186"></a><span id="l119.186">                 msgurl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l119.187"></a><span id="l119.187" class="difflineminus">-                if (msgWindow)</span>
<a href="#l119.188"></a><span id="l119.188" class="difflineminus">-                {</span>
<a href="#l119.189"></a><span id="l119.189" class="difflineminus">-                  msgWindow-&gt;SetMailCharacterSet(nsDependentCString(*default_charset));</span>
<a href="#l119.190"></a><span id="l119.190" class="difflineplus">+                if (msgWindow) {</span>
<a href="#l119.191"></a><span id="l119.191" class="difflineplus">+                  msgWindow-&gt;SetMailCharacterSet(</span>
<a href="#l119.192"></a><span id="l119.192" class="difflineplus">+                      nsDependentCString(*default_charset));</span>
<a href="#l119.193"></a><span id="l119.193">                   msgWindow-&gt;SetCharsetOverride(*override_charset);</span>
<a href="#l119.194"></a><span id="l119.194">                 }</span>
<a href="#l119.195"></a><span id="l119.195">               }</span>
<a href="#l119.196"></a><span id="l119.196">             }</span>
<a href="#l119.197"></a><span id="l119.197"> </span>
<a href="#l119.198"></a><span id="l119.198" class="difflineminus">-            // if the pref says always override and no manual override then set the folder charset to override</span>
<a href="#l119.199"></a><span id="l119.199" class="difflineplus">+            // if the pref says always override and no manual override then set</span>
<a href="#l119.200"></a><span id="l119.200" class="difflineplus">+            // the folder charset to override</span>
<a href="#l119.201"></a><span id="l119.201">             if (!*override_charset) {</span>
<a href="#l119.202"></a><span id="l119.202" class="difflineminus">-              nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l119.203"></a><span id="l119.203" class="difflineminus">-              if (pPrefBranch)</span>
<a href="#l119.204"></a><span id="l119.204" class="difflineminus">-              {</span>
<a href="#l119.205"></a><span id="l119.205" class="difflineminus">-                bool    force_override;</span>
<a href="#l119.206"></a><span id="l119.206" class="difflineminus">-                rv = pPrefBranch-&gt;GetBoolPref(&quot;mailnews.force_charset_override&quot;, &amp;force_override);</span>
<a href="#l119.207"></a><span id="l119.207" class="difflineminus">-                if (NS_SUCCEEDED(rv) &amp;&amp; force_override)</span>
<a href="#l119.208"></a><span id="l119.208" class="difflineminus">-                {</span>
<a href="#l119.209"></a><span id="l119.209" class="difflineplus">+              nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l119.210"></a><span id="l119.210" class="difflineplus">+                  do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l119.211"></a><span id="l119.211" class="difflineplus">+              if (pPrefBranch) {</span>
<a href="#l119.212"></a><span id="l119.212" class="difflineplus">+                bool force_override;</span>
<a href="#l119.213"></a><span id="l119.213" class="difflineplus">+                rv = pPrefBranch-&gt;GetBoolPref(&quot;mailnews.force_charset_override&quot;,</span>
<a href="#l119.214"></a><span id="l119.214" class="difflineplus">+                                              &amp;force_override);</span>
<a href="#l119.215"></a><span id="l119.215" class="difflineplus">+                if (NS_SUCCEEDED(rv) &amp;&amp; force_override) {</span>
<a href="#l119.216"></a><span id="l119.216">                   *override_charset = true;</span>
<a href="#l119.217"></a><span id="l119.217">                 }</span>
<a href="#l119.218"></a><span id="l119.218">               }</span>
<a href="#l119.219"></a><span id="l119.219">             }</span>
<a href="#l119.220"></a><span id="l119.220">           }</span>
<a href="#l119.221"></a><span id="l119.221">         }</span>
<a href="#l119.222"></a><span id="l119.222">         nsAutoCString urlString;</span>
<a href="#l119.223"></a><span id="l119.223" class="difflineminus">-        if (NS_SUCCEEDED(aURI-&gt;GetSpec(urlString)))</span>
<a href="#l119.224"></a><span id="l119.224" class="difflineminus">-        {</span>
<a href="#l119.225"></a><span id="l119.225" class="difflineminus">-          if (!urlString.IsEmpty())</span>
<a href="#l119.226"></a><span id="l119.226" class="difflineminus">-          {</span>
<a href="#l119.227"></a><span id="l119.227" class="difflineplus">+        if (NS_SUCCEEDED(aURI-&gt;GetSpec(urlString))) {</span>
<a href="#l119.228"></a><span id="l119.228" class="difflineplus">+          if (!urlString.IsEmpty()) {</span>
<a href="#l119.229"></a><span id="l119.229">             free(*url_name);</span>
<a href="#l119.230"></a><span id="l119.230">             *url_name = ToNewCString(urlString);</span>
<a href="#l119.231"></a><span id="l119.231" class="difflineminus">-            if (!(*url_name))</span>
<a href="#l119.232"></a><span id="l119.232" class="difflineminus">-              return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l119.233"></a><span id="l119.233" class="difflineplus">+            if (!(*url_name)) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l119.234"></a><span id="l119.234"> </span>
<a href="#l119.235"></a><span id="l119.235">             // rhp: Ugh, this is ugly...but it works.</span>
<a href="#l119.236"></a><span id="l119.236" class="difflineminus">-            if (fixup_pointer)</span>
<a href="#l119.237"></a><span id="l119.237" class="difflineminus">-              *fixup_pointer = (const char *)*url_name;</span>
<a href="#l119.238"></a><span id="l119.238" class="difflineplus">+            if (fixup_pointer) *fixup_pointer = (const char *)*url_name;</span>
<a href="#l119.239"></a><span id="l119.239">           }</span>
<a href="#l119.240"></a><span id="l119.240">         }</span>
<a href="#l119.241"></a><span id="l119.241">       }</span>
<a href="#l119.242"></a><span id="l119.242">     }</span>
<a href="#l119.243"></a><span id="l119.243">   }</span>
<a href="#l119.244"></a><span id="l119.244"> </span>
<a href="#l119.245"></a><span id="l119.245">   return NS_OK;</span>
<a href="#l119.246"></a><span id="l119.246"> }</span>
<a href="#l119.247"></a><span id="l119.247"> </span>
<a href="#l119.248"></a><span id="l119.248" class="difflineminus">-static int</span>
<a href="#l119.249"></a><span id="l119.249" class="difflineminus">-mime_headers_callback ( void *closure, MimeHeaders *headers )</span>
<a href="#l119.250"></a><span id="l119.250" class="difflineminus">-{</span>
<a href="#l119.251"></a><span id="l119.251" class="difflineplus">+static int mime_headers_callback(void *closure, MimeHeaders *headers) {</span>
<a href="#l119.252"></a><span id="l119.252">   // We get away with this because this doesn't get called on draft operations.</span>
<a href="#l119.253"></a><span id="l119.253">   mime_stream_data *msd = (mime_stream_data *)closure;</span>
<a href="#l119.254"></a><span id="l119.254"> </span>
<a href="#l119.255"></a><span id="l119.255">   NS_ASSERTION(msd &amp;&amp; headers, &quot;null mime stream data or headers&quot;);</span>
<a href="#l119.256"></a><span id="l119.256" class="difflineminus">-  if ( !msd || ! headers )</span>
<a href="#l119.257"></a><span id="l119.257" class="difflineminus">-    return 0;</span>
<a href="#l119.258"></a><span id="l119.258" class="difflineplus">+  if (!msd || !headers) return 0;</span>
<a href="#l119.259"></a><span id="l119.259"> </span>
<a href="#l119.260"></a><span id="l119.260">   NS_ASSERTION(!msd-&gt;headers, &quot;non-null mime stream data headers&quot;);</span>
<a href="#l119.261"></a><span id="l119.261" class="difflineminus">-  msd-&gt;headers = MimeHeaders_copy ( headers );</span>
<a href="#l119.262"></a><span id="l119.262" class="difflineplus">+  msd-&gt;headers = MimeHeaders_copy(headers);</span>
<a href="#l119.263"></a><span id="l119.263">   return 0;</span>
<a href="#l119.264"></a><span id="l119.264"> }</span>
<a href="#l119.265"></a><span id="l119.265"> </span>
<a href="#l119.266"></a><span id="l119.266" class="difflineminus">-nsresult</span>
<a href="#l119.267"></a><span id="l119.267" class="difflineminus">-bridge_set_mime_stream_converter_listener(void *bridgeStream, nsIMimeStreamConverterListener* listener,</span>
<a href="#l119.268"></a><span id="l119.268" class="difflineminus">-                                          nsMimeOutputType aOutputType)</span>
<a href="#l119.269"></a><span id="l119.269" class="difflineminus">-{</span>
<a href="#l119.270"></a><span id="l119.270" class="difflineplus">+nsresult bridge_set_mime_stream_converter_listener(</span>
<a href="#l119.271"></a><span id="l119.271" class="difflineplus">+    void *bridgeStream, nsIMimeStreamConverterListener *listener,</span>
<a href="#l119.272"></a><span id="l119.272" class="difflineplus">+    nsMimeOutputType aOutputType) {</span>
<a href="#l119.273"></a><span id="l119.273">   nsMIMESession *session = (nsMIMESession *)bridgeStream;</span>
<a href="#l119.274"></a><span id="l119.274"> </span>
<a href="#l119.275"></a><span id="l119.275" class="difflineminus">-  if ( (session) &amp;&amp; (session-&gt;data_object) )</span>
<a href="#l119.276"></a><span id="l119.276" class="difflineminus">-  {</span>
<a href="#l119.277"></a><span id="l119.277" class="difflineminus">-    if  ( (aOutputType == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l119.278"></a><span id="l119.278" class="difflineminus">-          (aOutputType == nsMimeOutput::nsMimeMessageEditorTemplate) )</span>
<a href="#l119.279"></a><span id="l119.279" class="difflineminus">-    {</span>
<a href="#l119.280"></a><span id="l119.280" class="difflineplus">+  if ((session) &amp;&amp; (session-&gt;data_object)) {</span>
<a href="#l119.281"></a><span id="l119.281" class="difflineplus">+    if ((aOutputType == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l119.282"></a><span id="l119.282" class="difflineplus">+        (aOutputType == nsMimeOutput::nsMimeMessageEditorTemplate)) {</span>
<a href="#l119.283"></a><span id="l119.283">       mime_draft_data *mdd = (mime_draft_data *)session-&gt;data_object;</span>
<a href="#l119.284"></a><span id="l119.284" class="difflineminus">-      if (mdd-&gt;options)</span>
<a href="#l119.285"></a><span id="l119.285" class="difflineminus">-      {</span>
<a href="#l119.286"></a><span id="l119.286" class="difflineminus">-        if (listener)</span>
<a href="#l119.287"></a><span id="l119.287" class="difflineminus">-        {</span>
<a href="#l119.288"></a><span id="l119.288" class="difflineplus">+      if (mdd-&gt;options) {</span>
<a href="#l119.289"></a><span id="l119.289" class="difflineplus">+        if (listener) {</span>
<a href="#l119.290"></a><span id="l119.290">           mdd-&gt;options-&gt;caller_need_root_headers = true;</span>
<a href="#l119.291"></a><span id="l119.291">           mdd-&gt;options-&gt;decompose_headers_info_fn = mime_headers_callback;</span>
<a href="#l119.292"></a><span id="l119.292" class="difflineminus">-        }</span>
<a href="#l119.293"></a><span id="l119.293" class="difflineminus">-        else</span>
<a href="#l119.294"></a><span id="l119.294" class="difflineminus">-        {</span>
<a href="#l119.295"></a><span id="l119.295" class="difflineplus">+        } else {</span>
<a href="#l119.296"></a><span id="l119.296">           mdd-&gt;options-&gt;caller_need_root_headers = false;</span>
<a href="#l119.297"></a><span id="l119.297">           mdd-&gt;options-&gt;decompose_headers_info_fn = nullptr;</span>
<a href="#l119.298"></a><span id="l119.298">         }</span>
<a href="#l119.299"></a><span id="l119.299">       }</span>
<a href="#l119.300"></a><span id="l119.300" class="difflineminus">-    }</span>
<a href="#l119.301"></a><span id="l119.301" class="difflineminus">-    else</span>
<a href="#l119.302"></a><span id="l119.302" class="difflineminus">-    {</span>
<a href="#l119.303"></a><span id="l119.303" class="difflineplus">+    } else {</span>
<a href="#l119.304"></a><span id="l119.304">       mime_stream_data *msd = (mime_stream_data *)session-&gt;data_object;</span>
<a href="#l119.305"></a><span id="l119.305"> </span>
<a href="#l119.306"></a><span id="l119.306" class="difflineminus">-      if (msd-&gt;options)</span>
<a href="#l119.307"></a><span id="l119.307" class="difflineminus">-      {</span>
<a href="#l119.308"></a><span id="l119.308" class="difflineminus">-        if (listener)</span>
<a href="#l119.309"></a><span id="l119.309" class="difflineminus">-        {</span>
<a href="#l119.310"></a><span id="l119.310" class="difflineplus">+      if (msd-&gt;options) {</span>
<a href="#l119.311"></a><span id="l119.311" class="difflineplus">+        if (listener) {</span>
<a href="#l119.312"></a><span id="l119.312">           msd-&gt;options-&gt;caller_need_root_headers = true;</span>
<a href="#l119.313"></a><span id="l119.313">           msd-&gt;options-&gt;decompose_headers_info_fn = mime_headers_callback;</span>
<a href="#l119.314"></a><span id="l119.314" class="difflineminus">-        }</span>
<a href="#l119.315"></a><span id="l119.315" class="difflineminus">-        else</span>
<a href="#l119.316"></a><span id="l119.316" class="difflineminus">-        {</span>
<a href="#l119.317"></a><span id="l119.317" class="difflineplus">+        } else {</span>
<a href="#l119.318"></a><span id="l119.318">           msd-&gt;options-&gt;caller_need_root_headers = false;</span>
<a href="#l119.319"></a><span id="l119.319">           msd-&gt;options-&gt;decompose_headers_info_fn = nullptr;</span>
<a href="#l119.320"></a><span id="l119.320">         }</span>
<a href="#l119.321"></a><span id="l119.321">       }</span>
<a href="#l119.322"></a><span id="l119.322">     }</span>
<a href="#l119.323"></a><span id="l119.323">   }</span>
<a href="#l119.324"></a><span id="l119.324"> </span>
<a href="#l119.325"></a><span id="l119.325">   return NS_OK;</span>
<a href="#l119.326"></a><span id="l119.326"> }</span>
<a href="#l119.327"></a><span id="l119.327"> </span>
<a href="#l119.328"></a><span id="l119.328"> // find a query element in a url and return a pointer to its data</span>
<a href="#l119.329"></a><span id="l119.329"> // (query must be in the form &quot;query=&quot;)</span>
<a href="#l119.330"></a><span id="l119.330" class="difflineminus">-static const char *</span>
<a href="#l119.331"></a><span id="l119.331" class="difflineminus">-FindQueryElementData(const char * aUrl, const char * aQuery)</span>
<a href="#l119.332"></a><span id="l119.332" class="difflineminus">-{</span>
<a href="#l119.333"></a><span id="l119.333" class="difflineminus">-  if (aUrl &amp;&amp; aQuery)</span>
<a href="#l119.334"></a><span id="l119.334" class="difflineminus">-  {</span>
<a href="#l119.335"></a><span id="l119.335" class="difflineminus">-    size_t queryLen = 0; // we don't call strlen until we need to</span>
<a href="#l119.336"></a><span id="l119.336" class="difflineplus">+static const char *FindQueryElementData(const char *aUrl, const char *aQuery) {</span>
<a href="#l119.337"></a><span id="l119.337" class="difflineplus">+  if (aUrl &amp;&amp; aQuery) {</span>
<a href="#l119.338"></a><span id="l119.338" class="difflineplus">+    size_t queryLen = 0;  // we don't call strlen until we need to</span>
<a href="#l119.339"></a><span id="l119.339">     aUrl = PL_strcasestr(aUrl, aQuery);</span>
<a href="#l119.340"></a><span id="l119.340" class="difflineminus">-    while (aUrl)</span>
<a href="#l119.341"></a><span id="l119.341" class="difflineminus">-    {</span>
<a href="#l119.342"></a><span id="l119.342" class="difflineminus">-      if (!queryLen)</span>
<a href="#l119.343"></a><span id="l119.343" class="difflineminus">-        queryLen = strlen(aQuery);</span>
<a href="#l119.344"></a><span id="l119.344" class="difflineminus">-      if (*(aUrl-1) == '&amp;' || *(aUrl-1) == '?')</span>
<a href="#l119.345"></a><span id="l119.345" class="difflineminus">-        return aUrl + queryLen;</span>
<a href="#l119.346"></a><span id="l119.346" class="difflineplus">+    while (aUrl) {</span>
<a href="#l119.347"></a><span id="l119.347" class="difflineplus">+      if (!queryLen) queryLen = strlen(aQuery);</span>
<a href="#l119.348"></a><span id="l119.348" class="difflineplus">+      if (*(aUrl - 1) == '&amp;' || *(aUrl - 1) == '?') return aUrl + queryLen;</span>
<a href="#l119.349"></a><span id="l119.349">       aUrl = PL_strcasestr(aUrl + queryLen, aQuery);</span>
<a href="#l119.350"></a><span id="l119.350">     }</span>
<a href="#l119.351"></a><span id="l119.351">   }</span>
<a href="#l119.352"></a><span id="l119.352">   return nullptr;</span>
<a href="#l119.353"></a><span id="l119.353"> }</span>
<a href="#l119.354"></a><span id="l119.354"> </span>
<a href="#l119.355"></a><span id="l119.355"> // case-sensitive test for string prefixing. If |string| is prefixed</span>
<a href="#l119.356"></a><span id="l119.356"> // by |prefix| then a pointer to the next character in |string| following</span>
<a href="#l119.357"></a><span id="l119.357"> // the prefix is returned. If it is not a prefix then |nullptr| is returned.</span>
<a href="#l119.358"></a><span id="l119.358" class="difflineminus">-static const char *</span>
<a href="#l119.359"></a><span id="l119.359" class="difflineminus">-SkipPrefix(const char *aString, const char *aPrefix)</span>
<a href="#l119.360"></a><span id="l119.360" class="difflineminus">-{</span>
<a href="#l119.361"></a><span id="l119.361" class="difflineplus">+static const char *SkipPrefix(const char *aString, const char *aPrefix) {</span>
<a href="#l119.362"></a><span id="l119.362">   while (*aPrefix)</span>
<a href="#l119.363"></a><span id="l119.363" class="difflineminus">-    if (*aPrefix++ != *aString++)</span>
<a href="#l119.364"></a><span id="l119.364" class="difflineminus">-       return nullptr;</span>
<a href="#l119.365"></a><span id="l119.365" class="difflineplus">+    if (*aPrefix++ != *aString++) return nullptr;</span>
<a href="#l119.366"></a><span id="l119.366">   return aString;</span>
<a href="#l119.367"></a><span id="l119.367"> }</span>
<a href="#l119.368"></a><span id="l119.368"> </span>
<a href="#l119.369"></a><span id="l119.369"> //</span>
<a href="#l119.370"></a><span id="l119.370"> // Utility routines needed by this interface</span>
<a href="#l119.371"></a><span id="l119.371"> //</span>
<a href="#l119.372"></a><span id="l119.372" class="difflineminus">-nsresult</span>
<a href="#l119.373"></a><span id="l119.373" class="difflineminus">-nsStreamConverter::DetermineOutputFormat(const char *aUrl, nsMimeOutputType *aNewType)</span>
<a href="#l119.374"></a><span id="l119.374" class="difflineminus">-{</span>
<a href="#l119.375"></a><span id="l119.375" class="difflineplus">+nsresult nsStreamConverter::DetermineOutputFormat(const char *aUrl,</span>
<a href="#l119.376"></a><span id="l119.376" class="difflineplus">+                                                  nsMimeOutputType *aNewType) {</span>
<a href="#l119.377"></a><span id="l119.377">   // sanity checking</span>
<a href="#l119.378"></a><span id="l119.378">   NS_ENSURE_ARG_POINTER(aNewType);</span>
<a href="#l119.379"></a><span id="l119.379" class="difflineminus">-  if (!aUrl || !*aUrl)</span>
<a href="#l119.380"></a><span id="l119.380" class="difflineminus">-  {</span>
<a href="#l119.381"></a><span id="l119.381" class="difflineplus">+  if (!aUrl || !*aUrl) {</span>
<a href="#l119.382"></a><span id="l119.382">     // default to html for the entire document</span>
<a href="#l119.383"></a><span id="l119.383">     *aNewType = nsMimeOutput::nsMimeMessageQuoting;</span>
<a href="#l119.384"></a><span id="l119.384">     mOutputFormat = &quot;text/html&quot;;</span>
<a href="#l119.385"></a><span id="l119.385">     return NS_OK;</span>
<a href="#l119.386"></a><span id="l119.386">   }</span>
<a href="#l119.387"></a><span id="l119.387"> </span>
<a href="#l119.388"></a><span id="l119.388">   // shorten the url that we test for the query strings by skipping directly</span>
<a href="#l119.389"></a><span id="l119.389">   // to the part where the query strings begin.</span>
<a href="#l119.390"></a><span id="l119.390">   const char *queryPart = PL_strchr(aUrl, '?');</span>
<a href="#l119.391"></a><span id="l119.391"> </span>
<a href="#l119.392"></a><span id="l119.392">   // First, did someone pass in a desired output format. They will be able to</span>
<a href="#l119.393"></a><span id="l119.393">   // pass in any content type (i.e. image/gif, text/html, etc...but the &quot;/&quot; will</span>
<a href="#l119.394"></a><span id="l119.394">   // have to be represented via the &quot;%2F&quot; value</span>
<a href="#l119.395"></a><span id="l119.395">   const char *format = FindQueryElementData(queryPart, &quot;outformat=&quot;);</span>
<a href="#l119.396"></a><span id="l119.396" class="difflineminus">-  if (format)</span>
<a href="#l119.397"></a><span id="l119.397" class="difflineminus">-  {</span>
<a href="#l119.398"></a><span id="l119.398" class="difflineminus">-    //NOTE: I've done a file contents search of every file (*.*) in the mozilla</span>
<a href="#l119.399"></a><span id="l119.399" class="difflineminus">-    // directory tree and there is not a single location where the string &quot;outformat&quot;</span>
<a href="#l119.400"></a><span id="l119.400" class="difflineminus">-    // is added to any URL. It appears that this code has been orphaned off by a change</span>
<a href="#l119.401"></a><span id="l119.401" class="difflineminus">-    // elsewhere and is no longer required. It will be removed in the future unless</span>
<a href="#l119.402"></a><span id="l119.402" class="difflineminus">-    // someone complains.</span>
<a href="#l119.403"></a><span id="l119.403" class="difflineplus">+  if (format) {</span>
<a href="#l119.404"></a><span id="l119.404" class="difflineplus">+    // NOTE: I've done a file contents search of every file (*.*) in the mozilla</span>
<a href="#l119.405"></a><span id="l119.405" class="difflineplus">+    // directory tree and there is not a single location where the string</span>
<a href="#l119.406"></a><span id="l119.406" class="difflineplus">+    // &quot;outformat&quot; is added to any URL. It appears that this code has been</span>
<a href="#l119.407"></a><span id="l119.407" class="difflineplus">+    // orphaned off by a change elsewhere and is no longer required. It will be</span>
<a href="#l119.408"></a><span id="l119.408" class="difflineplus">+    // removed in the future unless someone complains.</span>
<a href="#l119.409"></a><span id="l119.409">     MOZ_ASSERT(false, &quot;Is this code actually being used?&quot;);</span>
<a href="#l119.410"></a><span id="l119.410"> </span>
<a href="#l119.411"></a><span id="l119.411" class="difflineminus">-    while (*format == ' ')</span>
<a href="#l119.412"></a><span id="l119.412" class="difflineminus">-      ++format;</span>
<a href="#l119.413"></a><span id="l119.413" class="difflineplus">+    while (*format == ' ') ++format;</span>
<a href="#l119.414"></a><span id="l119.414"> </span>
<a href="#l119.415"></a><span id="l119.415" class="difflineminus">-    if (*format)</span>
<a href="#l119.416"></a><span id="l119.416" class="difflineminus">-    {</span>
<a href="#l119.417"></a><span id="l119.417" class="difflineplus">+    if (*format) {</span>
<a href="#l119.418"></a><span id="l119.418">       mOverrideFormat = &quot;raw&quot;;</span>
<a href="#l119.419"></a><span id="l119.419"> </span>
<a href="#l119.420"></a><span id="l119.420">       // set mOutputFormat to the supplied format, ensure that we replace any</span>
<a href="#l119.421"></a><span id="l119.421">       // %2F strings with the slash character</span>
<a href="#l119.422"></a><span id="l119.422">       const char *nextField = PL_strpbrk(format, &quot;&amp;; &quot;);</span>
<a href="#l119.423"></a><span id="l119.423">       mOutputFormat.Assign(format, nextField ? nextField - format : -1);</span>
<a href="#l119.424"></a><span id="l119.424">       MsgReplaceSubstring(mOutputFormat, &quot;%2F&quot;, &quot;/&quot;);</span>
<a href="#l119.425"></a><span id="l119.425">       MsgReplaceSubstring(mOutputFormat, &quot;%2f&quot;, &quot;/&quot;);</span>
<a href="#l119.426"></a><span id="l119.426" class="difflineat">@@ -359,265 +299,255 @@ nsStreamConverter::DetermineOutputFormat</span>
<a href="#l119.427"></a><span id="l119.427">       // Don't muck with this data!</span>
<a href="#l119.428"></a><span id="l119.428">       *aNewType = nsMimeOutput::nsMimeMessageRaw;</span>
<a href="#l119.429"></a><span id="l119.429">       return NS_OK;</span>
<a href="#l119.430"></a><span id="l119.430">     }</span>
<a href="#l119.431"></a><span id="l119.431">   }</span>
<a href="#l119.432"></a><span id="l119.432"> </span>
<a href="#l119.433"></a><span id="l119.433">   // is this is a part that should just come out raw</span>
<a href="#l119.434"></a><span id="l119.434">   const char *part = FindQueryElementData(queryPart, &quot;part=&quot;);</span>
<a href="#l119.435"></a><span id="l119.435" class="difflineminus">-  if (part &amp;&amp; !mToType.EqualsLiteral(&quot;application/vnd.mozilla.xul+xml&quot;))</span>
<a href="#l119.436"></a><span id="l119.436" class="difflineminus">-  {</span>
<a href="#l119.437"></a><span id="l119.437" class="difflineplus">+  if (part &amp;&amp; !mToType.EqualsLiteral(&quot;application/vnd.mozilla.xul+xml&quot;)) {</span>
<a href="#l119.438"></a><span id="l119.438">     // default for parts</span>
<a href="#l119.439"></a><span id="l119.439">     mOutputFormat = &quot;raw&quot;;</span>
<a href="#l119.440"></a><span id="l119.440">     *aNewType = nsMimeOutput::nsMimeMessageRaw;</span>
<a href="#l119.441"></a><span id="l119.441"> </span>
<a href="#l119.442"></a><span id="l119.442">     // if we are being asked to fetch a part....it should have a</span>
<a href="#l119.443"></a><span id="l119.443">     // content type appended to it...if it does, we want to remember</span>
<a href="#l119.444"></a><span id="l119.444">     // that as mOutputFormat</span>
<a href="#l119.445"></a><span id="l119.445" class="difflineminus">-    const char * typeField = FindQueryElementData(queryPart, &quot;type=&quot;);</span>
<a href="#l119.446"></a><span id="l119.446" class="difflineminus">-    if (typeField &amp;&amp; !strncmp(typeField, &quot;application/x-message-display&quot;, sizeof(&quot;application/x-message-display&quot;) - 1))</span>
<a href="#l119.447"></a><span id="l119.447" class="difflineminus">-    {</span>
<a href="#l119.448"></a><span id="l119.448" class="difflineplus">+    const char *typeField = FindQueryElementData(queryPart, &quot;type=&quot;);</span>
<a href="#l119.449"></a><span id="l119.449" class="difflineplus">+    if (typeField &amp;&amp; !strncmp(typeField, &quot;application/x-message-display&quot;,</span>
<a href="#l119.450"></a><span id="l119.450" class="difflineplus">+                              sizeof(&quot;application/x-message-display&quot;) - 1)) {</span>
<a href="#l119.451"></a><span id="l119.451">       const char *secondTypeField = FindQueryElementData(typeField, &quot;type=&quot;);</span>
<a href="#l119.452"></a><span id="l119.452" class="difflineminus">-      if (secondTypeField)</span>
<a href="#l119.453"></a><span id="l119.453" class="difflineminus">-        typeField = secondTypeField;</span>
<a href="#l119.454"></a><span id="l119.454" class="difflineplus">+      if (secondTypeField) typeField = secondTypeField;</span>
<a href="#l119.455"></a><span id="l119.455">     }</span>
<a href="#l119.456"></a><span id="l119.456" class="difflineminus">-    if (typeField)</span>
<a href="#l119.457"></a><span id="l119.457" class="difflineminus">-    {</span>
<a href="#l119.458"></a><span id="l119.458" class="difflineplus">+    if (typeField) {</span>
<a href="#l119.459"></a><span id="l119.459">       // store the real content type...mOutputFormat gets deleted later on...</span>
<a href="#l119.460"></a><span id="l119.460">       // and make sure we only get our own value.</span>
<a href="#l119.461"></a><span id="l119.461">       char *nextField = PL_strchr(typeField, '&amp;');</span>
<a href="#l119.462"></a><span id="l119.462" class="difflineminus">-      mRealContentType.Assign(typeField, nextField ? nextField - typeField : -1);</span>
<a href="#l119.463"></a><span id="l119.463" class="difflineminus">-      if (mRealContentType.EqualsLiteral(&quot;message/rfc822&quot;))</span>
<a href="#l119.464"></a><span id="l119.464" class="difflineminus">-      {</span>
<a href="#l119.465"></a><span id="l119.465" class="difflineplus">+      mRealContentType.Assign(typeField,</span>
<a href="#l119.466"></a><span id="l119.466" class="difflineplus">+                              nextField ? nextField - typeField : -1);</span>
<a href="#l119.467"></a><span id="l119.467" class="difflineplus">+      if (mRealContentType.EqualsLiteral(&quot;message/rfc822&quot;)) {</span>
<a href="#l119.468"></a><span id="l119.468">         mRealContentType = &quot;application/x-message-display&quot;;</span>
<a href="#l119.469"></a><span id="l119.469">         mOutputFormat = &quot;text/html&quot;;</span>
<a href="#l119.470"></a><span id="l119.470">         *aNewType = nsMimeOutput::nsMimeMessageBodyDisplay;</span>
<a href="#l119.471"></a><span id="l119.471" class="difflineminus">-      }</span>
<a href="#l119.472"></a><span id="l119.472" class="difflineminus">-      else if (mRealContentType.EqualsLiteral(&quot;application/x-message-display&quot;))</span>
<a href="#l119.473"></a><span id="l119.473" class="difflineminus">-      {</span>
<a href="#l119.474"></a><span id="l119.474" class="difflineplus">+      } else if (mRealContentType.EqualsLiteral(</span>
<a href="#l119.475"></a><span id="l119.475" class="difflineplus">+                     &quot;application/x-message-display&quot;)) {</span>
<a href="#l119.476"></a><span id="l119.476">         mRealContentType = &quot;&quot;;</span>
<a href="#l119.477"></a><span id="l119.477">         mOutputFormat = &quot;text/html&quot;;</span>
<a href="#l119.478"></a><span id="l119.478">         *aNewType = nsMimeOutput::nsMimeMessageBodyDisplay;</span>
<a href="#l119.479"></a><span id="l119.479">       }</span>
<a href="#l119.480"></a><span id="l119.480">     }</span>
<a href="#l119.481"></a><span id="l119.481"> </span>
<a href="#l119.482"></a><span id="l119.482">     return NS_OK;</span>
<a href="#l119.483"></a><span id="l119.483">   }</span>
<a href="#l119.484"></a><span id="l119.484"> </span>
<a href="#l119.485"></a><span id="l119.485">   const char *emitter = FindQueryElementData(queryPart, &quot;emitter=&quot;);</span>
<a href="#l119.486"></a><span id="l119.486" class="difflineminus">-  if (emitter)</span>
<a href="#l119.487"></a><span id="l119.487" class="difflineminus">-  {</span>
<a href="#l119.488"></a><span id="l119.488" class="difflineplus">+  if (emitter) {</span>
<a href="#l119.489"></a><span id="l119.489">     const char *remainder = SkipPrefix(emitter, &quot;js&quot;);</span>
<a href="#l119.490"></a><span id="l119.490">     if (remainder &amp;&amp; (!*remainder || *remainder == '&amp;'))</span>
<a href="#l119.491"></a><span id="l119.491">       mOverrideFormat = &quot;application/x-js-mime-message&quot;;</span>
<a href="#l119.492"></a><span id="l119.492">   }</span>
<a href="#l119.493"></a><span id="l119.493"> </span>
<a href="#l119.494"></a><span id="l119.494">   // if using the header query</span>
<a href="#l119.495"></a><span id="l119.495">   const char *header = FindQueryElementData(queryPart, &quot;header=&quot;);</span>
<a href="#l119.496"></a><span id="l119.496" class="difflineminus">-  if (header)</span>
<a href="#l119.497"></a><span id="l119.497" class="difflineminus">-  {</span>
<a href="#l119.498"></a><span id="l119.498" class="difflineplus">+  if (header) {</span>
<a href="#l119.499"></a><span id="l119.499">     struct HeaderType {</span>
<a href="#l119.500"></a><span id="l119.500" class="difflineminus">-      const char * headerType;</span>
<a href="#l119.501"></a><span id="l119.501" class="difflineminus">-      const char * outputFormat;</span>
<a href="#l119.502"></a><span id="l119.502" class="difflineplus">+      const char *headerType;</span>
<a href="#l119.503"></a><span id="l119.503" class="difflineplus">+      const char *outputFormat;</span>
<a href="#l119.504"></a><span id="l119.504">       nsMimeOutputType mimeOutputType;</span>
<a href="#l119.505"></a><span id="l119.505">     };</span>
<a href="#l119.506"></a><span id="l119.506"> </span>
<a href="#l119.507"></a><span id="l119.507">     // place most commonly used options at the top</span>
<a href="#l119.508"></a><span id="l119.508" class="difflineminus">-    static const struct HeaderType rgTypes[] =</span>
<a href="#l119.509"></a><span id="l119.509" class="difflineminus">-    {</span>
<a href="#l119.510"></a><span id="l119.510" class="difflineminus">-      { &quot;filter&quot;,    &quot;text/html&quot;,  nsMimeOutput::nsMimeMessageFilterSniffer },</span>
<a href="#l119.511"></a><span id="l119.511" class="difflineminus">-      { &quot;quotebody&quot;, &quot;text/html&quot;,  nsMimeOutput::nsMimeMessageBodyQuoting },</span>
<a href="#l119.512"></a><span id="l119.512" class="difflineminus">-      { &quot;print&quot;,     &quot;text/html&quot;,  nsMimeOutput::nsMimeMessagePrintOutput },</span>
<a href="#l119.513"></a><span id="l119.513" class="difflineminus">-      { &quot;only&quot;,      &quot;text/xml&quot;,   nsMimeOutput::nsMimeMessageHeaderDisplay },</span>
<a href="#l119.514"></a><span id="l119.514" class="difflineminus">-      { &quot;none&quot;,      &quot;text/html&quot;,  nsMimeOutput::nsMimeMessageBodyDisplay },</span>
<a href="#l119.515"></a><span id="l119.515" class="difflineminus">-      { &quot;quote&quot;,     &quot;text/html&quot;,  nsMimeOutput::nsMimeMessageQuoting },</span>
<a href="#l119.516"></a><span id="l119.516" class="difflineminus">-      { &quot;saveas&quot;,    &quot;text/html&quot;,  nsMimeOutput::nsMimeMessageSaveAs },</span>
<a href="#l119.517"></a><span id="l119.517" class="difflineminus">-      { &quot;src&quot;,       &quot;text/plain&quot;, nsMimeOutput::nsMimeMessageSource },</span>
<a href="#l119.518"></a><span id="l119.518" class="difflineminus">-      { &quot;attach&quot;,    &quot;raw&quot;,        nsMimeOutput::nsMimeMessageAttach }</span>
<a href="#l119.519"></a><span id="l119.519" class="difflineminus">-    };</span>
<a href="#l119.520"></a><span id="l119.520" class="difflineplus">+    static const struct HeaderType rgTypes[] = {</span>
<a href="#l119.521"></a><span id="l119.521" class="difflineplus">+        {&quot;filter&quot;, &quot;text/html&quot;, nsMimeOutput::nsMimeMessageFilterSniffer},</span>
<a href="#l119.522"></a><span id="l119.522" class="difflineplus">+        {&quot;quotebody&quot;, &quot;text/html&quot;, nsMimeOutput::nsMimeMessageBodyQuoting},</span>
<a href="#l119.523"></a><span id="l119.523" class="difflineplus">+        {&quot;print&quot;, &quot;text/html&quot;, nsMimeOutput::nsMimeMessagePrintOutput},</span>
<a href="#l119.524"></a><span id="l119.524" class="difflineplus">+        {&quot;only&quot;, &quot;text/xml&quot;, nsMimeOutput::nsMimeMessageHeaderDisplay},</span>
<a href="#l119.525"></a><span id="l119.525" class="difflineplus">+        {&quot;none&quot;, &quot;text/html&quot;, nsMimeOutput::nsMimeMessageBodyDisplay},</span>
<a href="#l119.526"></a><span id="l119.526" class="difflineplus">+        {&quot;quote&quot;, &quot;text/html&quot;, nsMimeOutput::nsMimeMessageQuoting},</span>
<a href="#l119.527"></a><span id="l119.527" class="difflineplus">+        {&quot;saveas&quot;, &quot;text/html&quot;, nsMimeOutput::nsMimeMessageSaveAs},</span>
<a href="#l119.528"></a><span id="l119.528" class="difflineplus">+        {&quot;src&quot;, &quot;text/plain&quot;, nsMimeOutput::nsMimeMessageSource},</span>
<a href="#l119.529"></a><span id="l119.529" class="difflineplus">+        {&quot;attach&quot;, &quot;raw&quot;, nsMimeOutput::nsMimeMessageAttach}};</span>
<a href="#l119.530"></a><span id="l119.530"> </span>
<a href="#l119.531"></a><span id="l119.531" class="difflineminus">-    // find the requested header in table, ensure that we don't match on a prefix</span>
<a href="#l119.532"></a><span id="l119.532" class="difflineminus">-    // by checking that the following character is either null or the next query element</span>
<a href="#l119.533"></a><span id="l119.533" class="difflineminus">-    const char * remainder;</span>
<a href="#l119.534"></a><span id="l119.534" class="difflineminus">-    for (uint32_t n = 0; n &lt; MOZ_ARRAY_LENGTH(rgTypes); ++n)</span>
<a href="#l119.535"></a><span id="l119.535" class="difflineminus">-    {</span>
<a href="#l119.536"></a><span id="l119.536" class="difflineplus">+    // find the requested header in table, ensure that we don't match on a</span>
<a href="#l119.537"></a><span id="l119.537" class="difflineplus">+    // prefix by checking that the following character is either null or the</span>
<a href="#l119.538"></a><span id="l119.538" class="difflineplus">+    // next query element</span>
<a href="#l119.539"></a><span id="l119.539" class="difflineplus">+    const char *remainder;</span>
<a href="#l119.540"></a><span id="l119.540" class="difflineplus">+    for (uint32_t n = 0; n &lt; MOZ_ARRAY_LENGTH(rgTypes); ++n) {</span>
<a href="#l119.541"></a><span id="l119.541">       remainder = SkipPrefix(header, rgTypes[n].headerType);</span>
<a href="#l119.542"></a><span id="l119.542" class="difflineminus">-      if (remainder &amp;&amp; (*remainder == '\0' || *remainder == '&amp;'))</span>
<a href="#l119.543"></a><span id="l119.543" class="difflineminus">-      {</span>
<a href="#l119.544"></a><span id="l119.544" class="difflineplus">+      if (remainder &amp;&amp; (*remainder == '\0' || *remainder == '&amp;')) {</span>
<a href="#l119.545"></a><span id="l119.545">         mOutputFormat = rgTypes[n].outputFormat;</span>
<a href="#l119.546"></a><span id="l119.546">         *aNewType = rgTypes[n].mimeOutputType;</span>
<a href="#l119.547"></a><span id="l119.547">         return NS_OK;</span>
<a href="#l119.548"></a><span id="l119.548">       }</span>
<a href="#l119.549"></a><span id="l119.549">     }</span>
<a href="#l119.550"></a><span id="l119.550">   }</span>
<a href="#l119.551"></a><span id="l119.551"> </span>
<a href="#l119.552"></a><span id="l119.552">   // default to html for just the body</span>
<a href="#l119.553"></a><span id="l119.553">   mOutputFormat = &quot;text/html&quot;;</span>
<a href="#l119.554"></a><span id="l119.554">   *aNewType = nsMimeOutput::nsMimeMessageBodyDisplay;</span>
<a href="#l119.555"></a><span id="l119.555"> </span>
<a href="#l119.556"></a><span id="l119.556">   return NS_OK;</span>
<a href="#l119.557"></a><span id="l119.557"> }</span>
<a href="#l119.558"></a><span id="l119.558"> </span>
<a href="#l119.559"></a><span id="l119.559" class="difflineminus">-nsresult</span>
<a href="#l119.560"></a><span id="l119.560" class="difflineminus">-nsStreamConverter::InternalCleanup(void)</span>
<a href="#l119.561"></a><span id="l119.561" class="difflineminus">-{</span>
<a href="#l119.562"></a><span id="l119.562" class="difflineminus">-  if (mBridgeStream)</span>
<a href="#l119.563"></a><span id="l119.563" class="difflineminus">-  {</span>
<a href="#l119.564"></a><span id="l119.564" class="difflineplus">+nsresult nsStreamConverter::InternalCleanup(void) {</span>
<a href="#l119.565"></a><span id="l119.565" class="difflineplus">+  if (mBridgeStream) {</span>
<a href="#l119.566"></a><span id="l119.566">     bridge_destroy_stream(mBridgeStream);</span>
<a href="#l119.567"></a><span id="l119.567">     mBridgeStream = nullptr;</span>
<a href="#l119.568"></a><span id="l119.568">   }</span>
<a href="#l119.569"></a><span id="l119.569"> </span>
<a href="#l119.570"></a><span id="l119.570">   return NS_OK;</span>
<a href="#l119.571"></a><span id="l119.571"> }</span>
<a href="#l119.572"></a><span id="l119.572"> </span>
<a href="#l119.573"></a><span id="l119.573"> /*</span>
<a href="#l119.574"></a><span id="l119.574">  * Inherited methods for nsMimeConverter</span>
<a href="#l119.575"></a><span id="l119.575">  */</span>
<a href="#l119.576"></a><span id="l119.576" class="difflineminus">-nsStreamConverter::nsStreamConverter()</span>
<a href="#l119.577"></a><span id="l119.577" class="difflineminus">-{</span>
<a href="#l119.578"></a><span id="l119.578" class="difflineplus">+nsStreamConverter::nsStreamConverter() {</span>
<a href="#l119.579"></a><span id="l119.579">   // Init member variables...</span>
<a href="#l119.580"></a><span id="l119.580">   mWrapperOutput = false;</span>
<a href="#l119.581"></a><span id="l119.581">   mBridgeStream = nullptr;</span>
<a href="#l119.582"></a><span id="l119.582">   mOutputFormat = &quot;text/html&quot;;</span>
<a href="#l119.583"></a><span id="l119.583">   mAlreadyKnowOutputType = false;</span>
<a href="#l119.584"></a><span id="l119.584">   mForwardInline = false;</span>
<a href="#l119.585"></a><span id="l119.585">   mForwardInlineFilter = false;</span>
<a href="#l119.586"></a><span id="l119.586">   mOverrideComposeFormat = false;</span>
<a href="#l119.587"></a><span id="l119.587"> </span>
<a href="#l119.588"></a><span id="l119.588">   mPendingRequest = nullptr;</span>
<a href="#l119.589"></a><span id="l119.589"> }</span>
<a href="#l119.590"></a><span id="l119.590"> </span>
<a href="#l119.591"></a><span id="l119.591" class="difflineminus">-nsStreamConverter::~nsStreamConverter()</span>
<a href="#l119.592"></a><span id="l119.592" class="difflineminus">-{</span>
<a href="#l119.593"></a><span id="l119.593" class="difflineminus">-  InternalCleanup();</span>
<a href="#l119.594"></a><span id="l119.594" class="difflineminus">-}</span>
<a href="#l119.595"></a><span id="l119.595" class="difflineplus">+nsStreamConverter::~nsStreamConverter() { InternalCleanup(); }</span>
<a href="#l119.596"></a><span id="l119.596"> </span>
<a href="#l119.597"></a><span id="l119.597"> NS_IMPL_ISUPPORTS(nsStreamConverter, nsIStreamListener, nsIRequestObserver,</span>
<a href="#l119.598"></a><span id="l119.598" class="difflineminus">-  nsIStreamConverter, nsIMimeStreamConverter)</span>
<a href="#l119.599"></a><span id="l119.599" class="difflineplus">+                  nsIStreamConverter, nsIMimeStreamConverter)</span>
<a href="#l119.600"></a><span id="l119.600"> </span>
<a href="#l119.601"></a><span id="l119.601"> ///////////////////////////////////////////////////////////////</span>
<a href="#l119.602"></a><span id="l119.602"> // nsStreamConverter definitions....</span>
<a href="#l119.603"></a><span id="l119.603"> ///////////////////////////////////////////////////////////////</span>
<a href="#l119.604"></a><span id="l119.604"> </span>
<a href="#l119.605"></a><span id="l119.605" class="difflineminus">-NS_IMETHODIMP nsStreamConverter::Init(nsIURI *aURI, nsIStreamListener * aOutListener, nsIChannel *aChannel)</span>
<a href="#l119.606"></a><span id="l119.606" class="difflineminus">-{</span>
<a href="#l119.607"></a><span id="l119.607" class="difflineplus">+NS_IMETHODIMP nsStreamConverter::Init(nsIURI *aURI,</span>
<a href="#l119.608"></a><span id="l119.608" class="difflineplus">+                                      nsIStreamListener *aOutListener,</span>
<a href="#l119.609"></a><span id="l119.609" class="difflineplus">+                                      nsIChannel *aChannel) {</span>
<a href="#l119.610"></a><span id="l119.610">   NS_ENSURE_ARG_POINTER(aURI);</span>
<a href="#l119.611"></a><span id="l119.611"> </span>
<a href="#l119.612"></a><span id="l119.612">   nsresult rv = NS_OK;</span>
<a href="#l119.613"></a><span id="l119.613">   mOutListener = aOutListener;</span>
<a href="#l119.614"></a><span id="l119.614"> </span>
<a href="#l119.615"></a><span id="l119.615" class="difflineminus">-  // mscott --&gt; we need to look at the url and figure out what the correct output type is...</span>
<a href="#l119.616"></a><span id="l119.616" class="difflineplus">+  // mscott --&gt; we need to look at the url and figure out what the correct</span>
<a href="#l119.617"></a><span id="l119.617" class="difflineplus">+  // output type is...</span>
<a href="#l119.618"></a><span id="l119.618">   nsMimeOutputType newType = mOutputType;</span>
<a href="#l119.619"></a><span id="l119.619" class="difflineminus">-  if (!mAlreadyKnowOutputType)</span>
<a href="#l119.620"></a><span id="l119.620" class="difflineminus">-  {</span>
<a href="#l119.621"></a><span id="l119.621" class="difflineplus">+  if (!mAlreadyKnowOutputType) {</span>
<a href="#l119.622"></a><span id="l119.622">     nsAutoCString urlSpec;</span>
<a href="#l119.623"></a><span id="l119.623">     rv = aURI-&gt;GetSpec(urlSpec);</span>
<a href="#l119.624"></a><span id="l119.624">     DetermineOutputFormat(urlSpec.get(), &amp;newType);</span>
<a href="#l119.625"></a><span id="l119.625">     mAlreadyKnowOutputType = true;</span>
<a href="#l119.626"></a><span id="l119.626">     mOutputType = newType;</span>
<a href="#l119.627"></a><span id="l119.627">   }</span>
<a href="#l119.628"></a><span id="l119.628"> </span>
<a href="#l119.629"></a><span id="l119.629" class="difflineminus">-  switch (newType)</span>
<a href="#l119.630"></a><span id="l119.630" class="difflineminus">-  {</span>
<a href="#l119.631"></a><span id="l119.631" class="difflineminus">-    case nsMimeOutput::nsMimeMessageSplitDisplay:    // the wrapper HTML output to produce the split header/body display</span>
<a href="#l119.632"></a><span id="l119.632" class="difflineplus">+  switch (newType) {</span>
<a href="#l119.633"></a><span id="l119.633" class="difflineplus">+    case nsMimeOutput::nsMimeMessageSplitDisplay:  // the wrapper HTML output to</span>
<a href="#l119.634"></a><span id="l119.634" class="difflineplus">+                                                   // produce the split</span>
<a href="#l119.635"></a><span id="l119.635" class="difflineplus">+                                                   // header/body display</span>
<a href="#l119.636"></a><span id="l119.636">       mWrapperOutput = true;</span>
<a href="#l119.637"></a><span id="l119.637">       mOutputFormat = &quot;text/html&quot;;</span>
<a href="#l119.638"></a><span id="l119.638">       break;</span>
<a href="#l119.639"></a><span id="l119.639" class="difflineminus">-    case nsMimeOutput::nsMimeMessageHeaderDisplay:   // the split header/body display</span>
<a href="#l119.640"></a><span id="l119.640" class="difflineplus">+    case nsMimeOutput::nsMimeMessageHeaderDisplay:  // the split header/body</span>
<a href="#l119.641"></a><span id="l119.641" class="difflineplus">+                                                    // display</span>
<a href="#l119.642"></a><span id="l119.642">       mOutputFormat = &quot;text/xml&quot;;</span>
<a href="#l119.643"></a><span id="l119.643">       break;</span>
<a href="#l119.644"></a><span id="l119.644" class="difflineminus">-    case nsMimeOutput::nsMimeMessageBodyDisplay:   // the split header/body display</span>
<a href="#l119.645"></a><span id="l119.645" class="difflineplus">+    case nsMimeOutput::nsMimeMessageBodyDisplay:  // the split header/body</span>
<a href="#l119.646"></a><span id="l119.646" class="difflineplus">+                                                  // display</span>
<a href="#l119.647"></a><span id="l119.647">       mOutputFormat = &quot;text/html&quot;;</span>
<a href="#l119.648"></a><span id="l119.648">       break;</span>
<a href="#l119.649"></a><span id="l119.649"> </span>
<a href="#l119.650"></a><span id="l119.650">     case nsMimeOutput::nsMimeMessageQuoting:      // all HTML quoted output</span>
<a href="#l119.651"></a><span id="l119.651">     case nsMimeOutput::nsMimeMessageSaveAs:       // Save as operation</span>
<a href="#l119.652"></a><span id="l119.652" class="difflineminus">-    case nsMimeOutput::nsMimeMessageBodyQuoting:  // only HTML body quoted output</span>
<a href="#l119.653"></a><span id="l119.653" class="difflineplus">+    case nsMimeOutput::nsMimeMessageBodyQuoting:  // only HTML body quoted</span>
<a href="#l119.654"></a><span id="l119.654" class="difflineplus">+                                                  // output</span>
<a href="#l119.655"></a><span id="l119.655">     case nsMimeOutput::nsMimeMessagePrintOutput:  // all Printing output</span>
<a href="#l119.656"></a><span id="l119.656">       mOutputFormat = &quot;text/html&quot;;</span>
<a href="#l119.657"></a><span id="l119.657">       break;</span>
<a href="#l119.658"></a><span id="l119.658"> </span>
<a href="#l119.659"></a><span id="l119.659">     case nsMimeOutput::nsMimeMessageAttach:</span>
<a href="#l119.660"></a><span id="l119.660">     case nsMimeOutput::nsMimeMessageDecrypt:</span>
<a href="#l119.661"></a><span id="l119.661" class="difflineminus">-    case nsMimeOutput::nsMimeMessageRaw:              // the raw RFC822 data and attachments</span>
<a href="#l119.662"></a><span id="l119.662" class="difflineplus">+    case nsMimeOutput::nsMimeMessageRaw:  // the raw RFC822 data and attachments</span>
<a href="#l119.663"></a><span id="l119.663">       mOutputFormat = &quot;raw&quot;;</span>
<a href="#l119.664"></a><span id="l119.664">       break;</span>
<a href="#l119.665"></a><span id="l119.665"> </span>
<a href="#l119.666"></a><span id="l119.666" class="difflineminus">-    case nsMimeOutput::nsMimeMessageSource:      // the raw RFC822 data (view source) and attachments</span>
<a href="#l119.667"></a><span id="l119.667" class="difflineplus">+    case nsMimeOutput::nsMimeMessageSource:  // the raw RFC822 data (view</span>
<a href="#l119.668"></a><span id="l119.668" class="difflineplus">+                                             // source) and attachments</span>
<a href="#l119.669"></a><span id="l119.669">       mOutputFormat = &quot;text/plain&quot;;</span>
<a href="#l119.670"></a><span id="l119.670">       mOverrideFormat = &quot;raw&quot;;</span>
<a href="#l119.671"></a><span id="l119.671">       break;</span>
<a href="#l119.672"></a><span id="l119.672"> </span>
<a href="#l119.673"></a><span id="l119.673" class="difflineminus">-    case nsMimeOutput::nsMimeMessageDraftOrTemplate:       // Loading drafts &amp; templates</span>
<a href="#l119.674"></a><span id="l119.674" class="difflineplus">+    case nsMimeOutput::nsMimeMessageDraftOrTemplate:  // Loading drafts &amp;</span>
<a href="#l119.675"></a><span id="l119.675" class="difflineplus">+                                                      // templates</span>
<a href="#l119.676"></a><span id="l119.676">       mOutputFormat = &quot;message/draft&quot;;</span>
<a href="#l119.677"></a><span id="l119.677">       break;</span>
<a href="#l119.678"></a><span id="l119.678"> </span>
<a href="#l119.679"></a><span id="l119.679" class="difflineminus">-    case nsMimeOutput::nsMimeMessageEditorTemplate:       // Loading templates into editor</span>
<a href="#l119.680"></a><span id="l119.680" class="difflineplus">+    case nsMimeOutput::nsMimeMessageEditorTemplate:  // Loading templates into</span>
<a href="#l119.681"></a><span id="l119.681" class="difflineplus">+                                                     // editor</span>
<a href="#l119.682"></a><span id="l119.682">       mOutputFormat = &quot;text/html&quot;;</span>
<a href="#l119.683"></a><span id="l119.683">       break;</span>
<a href="#l119.684"></a><span id="l119.684"> </span>
<a href="#l119.685"></a><span id="l119.685" class="difflineminus">-    case nsMimeOutput::nsMimeMessageFilterSniffer: // output all displayable part as raw</span>
<a href="#l119.686"></a><span id="l119.686" class="difflineplus">+    case nsMimeOutput::nsMimeMessageFilterSniffer:  // output all displayable</span>
<a href="#l119.687"></a><span id="l119.687" class="difflineplus">+                                                    // part as raw</span>
<a href="#l119.688"></a><span id="l119.688">       mOutputFormat = &quot;text/html&quot;;</span>
<a href="#l119.689"></a><span id="l119.689">       break;</span>
<a href="#l119.690"></a><span id="l119.690"> </span>
<a href="#l119.691"></a><span id="l119.691">     default:</span>
<a href="#l119.692"></a><span id="l119.692">       NS_ERROR(&quot;this means I made a mistake in my assumptions&quot;);</span>
<a href="#l119.693"></a><span id="l119.693">   }</span>
<a href="#l119.694"></a><span id="l119.694"> </span>
<a href="#l119.695"></a><span id="l119.695" class="difflineminus">-</span>
<a href="#l119.696"></a><span id="l119.696" class="difflineminus">-  // the following output channel stream is used to fake the content type for people who later</span>
<a href="#l119.697"></a><span id="l119.697" class="difflineminus">-  // call into us..</span>
<a href="#l119.698"></a><span id="l119.698" class="difflineplus">+  // the following output channel stream is used to fake the content type for</span>
<a href="#l119.699"></a><span id="l119.699" class="difflineplus">+  // people who later call into us..</span>
<a href="#l119.700"></a><span id="l119.700">   nsCString contentTypeToUse;</span>
<a href="#l119.701"></a><span id="l119.701">   GetContentType(getter_Copies(contentTypeToUse));</span>
<a href="#l119.702"></a><span id="l119.702" class="difflineminus">-  // mscott --&gt; my theory is that we don't need this fake outgoing channel. Let's use the</span>
<a href="#l119.703"></a><span id="l119.703" class="difflineminus">-  // original channel and just set our content type ontop of the original channel...</span>
<a href="#l119.704"></a><span id="l119.704" class="difflineplus">+  // mscott --&gt; my theory is that we don't need this fake outgoing channel.</span>
<a href="#l119.705"></a><span id="l119.705" class="difflineplus">+  // Let's use the original channel and just set our content type ontop of the</span>
<a href="#l119.706"></a><span id="l119.706" class="difflineplus">+  // original channel...</span>
<a href="#l119.707"></a><span id="l119.707"> </span>
<a href="#l119.708"></a><span id="l119.708">   aChannel-&gt;SetContentType(contentTypeToUse);</span>
<a href="#l119.709"></a><span id="l119.709"> </span>
<a href="#l119.710"></a><span id="l119.710" class="difflineminus">-  //rv = NS_NewInputStreamChannel(getter_AddRefs(mOutgoingChannel), aURI, nullptr, contentTypeToUse, -1);</span>
<a href="#l119.711"></a><span id="l119.711" class="difflineminus">-  //if (NS_FAILED(rv))</span>
<a href="#l119.712"></a><span id="l119.712" class="difflineplus">+  // rv = NS_NewInputStreamChannel(getter_AddRefs(mOutgoingChannel), aURI,</span>
<a href="#l119.713"></a><span id="l119.713" class="difflineplus">+  // nullptr, contentTypeToUse, -1); if (NS_FAILED(rv))</span>
<a href="#l119.714"></a><span id="l119.714">   //    return rv;</span>
<a href="#l119.715"></a><span id="l119.715"> </span>
<a href="#l119.716"></a><span id="l119.716">   // Set system principal for this document, which will be dynamically generated</span>
<a href="#l119.717"></a><span id="l119.717"> </span>
<a href="#l119.718"></a><span id="l119.718">   // We will first find an appropriate emitter in the repository that supports</span>
<a href="#l119.719"></a><span id="l119.719" class="difflineminus">-  // the requested output format...note, the special exceptions are nsMimeMessageDraftOrTemplate</span>
<a href="#l119.720"></a><span id="l119.720" class="difflineminus">-  // or nsMimeMessageEditorTemplate where we don't need any emitters</span>
<a href="#l119.721"></a><span id="l119.721" class="difflineplus">+  // the requested output format...note, the special exceptions are</span>
<a href="#l119.722"></a><span id="l119.722" class="difflineplus">+  // nsMimeMessageDraftOrTemplate or nsMimeMessageEditorTemplate where we don't</span>
<a href="#l119.723"></a><span id="l119.723" class="difflineplus">+  // need any emitters</span>
<a href="#l119.724"></a><span id="l119.724">   //</span>
<a href="#l119.725"></a><span id="l119.725"> </span>
<a href="#l119.726"></a><span id="l119.726" class="difflineminus">-  if ( (newType != nsMimeOutput::nsMimeMessageDraftOrTemplate) &amp;&amp;</span>
<a href="#l119.727"></a><span id="l119.727" class="difflineminus">-    (newType != nsMimeOutput::nsMimeMessageEditorTemplate) )</span>
<a href="#l119.728"></a><span id="l119.728" class="difflineminus">-  {</span>
<a href="#l119.729"></a><span id="l119.729" class="difflineminus">-    nsAutoCString categoryName (&quot;@mozilla.org/messenger/mimeemitter;1?type=&quot;);</span>
<a href="#l119.730"></a><span id="l119.730" class="difflineplus">+  if ((newType != nsMimeOutput::nsMimeMessageDraftOrTemplate) &amp;&amp;</span>
<a href="#l119.731"></a><span id="l119.731" class="difflineplus">+      (newType != nsMimeOutput::nsMimeMessageEditorTemplate)) {</span>
<a href="#l119.732"></a><span id="l119.732" class="difflineplus">+    nsAutoCString categoryName(&quot;@mozilla.org/messenger/mimeemitter;1?type=&quot;);</span>
<a href="#l119.733"></a><span id="l119.733">     if (!mOverrideFormat.IsEmpty())</span>
<a href="#l119.734"></a><span id="l119.734">       categoryName += mOverrideFormat;</span>
<a href="#l119.735"></a><span id="l119.735">     else</span>
<a href="#l119.736"></a><span id="l119.736">       categoryName += mOutputFormat;</span>
<a href="#l119.737"></a><span id="l119.737"> </span>
<a href="#l119.738"></a><span id="l119.738" class="difflineminus">-    nsCOMPtr&lt;nsICategoryManager&gt; catman = do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l119.739"></a><span id="l119.739" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l119.740"></a><span id="l119.740" class="difflineminus">-    {</span>
<a href="#l119.741"></a><span id="l119.741" class="difflineplus">+    nsCOMPtr&lt;nsICategoryManager&gt; catman =</span>
<a href="#l119.742"></a><span id="l119.742" class="difflineplus">+        do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l119.743"></a><span id="l119.743" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l119.744"></a><span id="l119.744">       nsCString contractID;</span>
<a href="#l119.745"></a><span id="l119.745">       catman-&gt;GetCategoryEntry(&quot;mime-emitter&quot;, categoryName, contractID);</span>
<a href="#l119.746"></a><span id="l119.746" class="difflineminus">-      if (!contractID.IsEmpty())</span>
<a href="#l119.747"></a><span id="l119.747" class="difflineminus">-        categoryName = contractID;</span>
<a href="#l119.748"></a><span id="l119.748" class="difflineplus">+      if (!contractID.IsEmpty()) categoryName = contractID;</span>
<a href="#l119.749"></a><span id="l119.749">     }</span>
<a href="#l119.750"></a><span id="l119.750"> </span>
<a href="#l119.751"></a><span id="l119.751">     mEmitter = do_CreateInstance(categoryName.get(), &amp;rv);</span>
<a href="#l119.752"></a><span id="l119.752"> </span>
<a href="#l119.753"></a><span id="l119.753" class="difflineminus">-    if ((NS_FAILED(rv)) || (!mEmitter))</span>
<a href="#l119.754"></a><span id="l119.754" class="difflineminus">-    {</span>
<a href="#l119.755"></a><span id="l119.755" class="difflineplus">+    if ((NS_FAILED(rv)) || (!mEmitter)) {</span>
<a href="#l119.756"></a><span id="l119.756">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l119.757"></a><span id="l119.757">     }</span>
<a href="#l119.758"></a><span id="l119.758">   }</span>
<a href="#l119.759"></a><span id="l119.759"> </span>
<a href="#l119.760"></a><span id="l119.760">   // initialize our emitter</span>
<a href="#l119.761"></a><span id="l119.761" class="difflineminus">-  if (mEmitter)</span>
<a href="#l119.762"></a><span id="l119.762" class="difflineminus">-  {</span>
<a href="#l119.763"></a><span id="l119.763" class="difflineplus">+  if (mEmitter) {</span>
<a href="#l119.764"></a><span id="l119.764">     // Now we want to create a pipe which we'll use for converting the data.</span>
<a href="#l119.765"></a><span id="l119.765">     nsCOMPtr&lt;nsIPipe&gt; pipe = do_CreateInstance(&quot;@mozilla.org/pipe;1&quot;);</span>
<a href="#l119.766"></a><span id="l119.766">     rv = pipe-&gt;Init(true, true, 4096, 8);</span>
<a href="#l119.767"></a><span id="l119.767">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l119.768"></a><span id="l119.768"> </span>
<a href="#l119.769"></a><span id="l119.769">     // These always succeed because the pipe is initialized above.</span>
<a href="#l119.770"></a><span id="l119.770">     MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetInputStream(getter_AddRefs(mInputStream)));</span>
<a href="#l119.771"></a><span id="l119.771">     MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetOutputStream(getter_AddRefs(mOutputStream)));</span>
<a href="#l119.772"></a><span id="l119.772" class="difflineat">@@ -626,518 +556,459 @@ NS_IMETHODIMP nsStreamConverter::Init(ns</span>
<a href="#l119.773"></a><span id="l119.773">     mEmitter-&gt;SetPipe(mInputStream, mOutputStream);</span>
<a href="#l119.774"></a><span id="l119.774">     mEmitter-&gt;SetOutputListener(aOutListener);</span>
<a href="#l119.775"></a><span id="l119.775">   }</span>
<a href="#l119.776"></a><span id="l119.776"> </span>
<a href="#l119.777"></a><span id="l119.777">   uint32_t whattodo = mozITXTToHTMLConv::kURLs;</span>
<a href="#l119.778"></a><span id="l119.778">   bool enable_emoticons = true;</span>
<a href="#l119.779"></a><span id="l119.779">   bool enable_structs = true;</span>
<a href="#l119.780"></a><span id="l119.780"> </span>
<a href="#l119.781"></a><span id="l119.781" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l119.782"></a><span id="l119.782" class="difflineminus">-  if (pPrefBranch)</span>
<a href="#l119.783"></a><span id="l119.783" class="difflineminus">-  {</span>
<a href="#l119.784"></a><span id="l119.784" class="difflineminus">-    rv = pPrefBranch-&gt;GetBoolPref(PREF_MAIL_DISPLAY_GLYPH,&amp;enable_emoticons);</span>
<a href="#l119.785"></a><span id="l119.785" class="difflineminus">-    if (NS_FAILED(rv) || enable_emoticons)</span>
<a href="#l119.786"></a><span id="l119.786" class="difflineminus">-    {</span>
<a href="#l119.787"></a><span id="l119.787" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l119.788"></a><span id="l119.788" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l119.789"></a><span id="l119.789" class="difflineplus">+  if (pPrefBranch) {</span>
<a href="#l119.790"></a><span id="l119.790" class="difflineplus">+    rv = pPrefBranch-&gt;GetBoolPref(PREF_MAIL_DISPLAY_GLYPH, &amp;enable_emoticons);</span>
<a href="#l119.791"></a><span id="l119.791" class="difflineplus">+    if (NS_FAILED(rv) || enable_emoticons) {</span>
<a href="#l119.792"></a><span id="l119.792">       whattodo = whattodo | mozITXTToHTMLConv::kGlyphSubstitution;</span>
<a href="#l119.793"></a><span id="l119.793">     }</span>
<a href="#l119.794"></a><span id="l119.794" class="difflineminus">-    rv = pPrefBranch-&gt;GetBoolPref(PREF_MAIL_DISPLAY_STRUCT,&amp;enable_structs);</span>
<a href="#l119.795"></a><span id="l119.795" class="difflineminus">-    if (NS_FAILED(rv) || enable_structs)</span>
<a href="#l119.796"></a><span id="l119.796" class="difflineminus">-    {</span>
<a href="#l119.797"></a><span id="l119.797" class="difflineplus">+    rv = pPrefBranch-&gt;GetBoolPref(PREF_MAIL_DISPLAY_STRUCT, &amp;enable_structs);</span>
<a href="#l119.798"></a><span id="l119.798" class="difflineplus">+    if (NS_FAILED(rv) || enable_structs) {</span>
<a href="#l119.799"></a><span id="l119.799">       whattodo = whattodo | mozITXTToHTMLConv::kStructPhrase;</span>
<a href="#l119.800"></a><span id="l119.800">     }</span>
<a href="#l119.801"></a><span id="l119.801">   }</span>
<a href="#l119.802"></a><span id="l119.802"> </span>
<a href="#l119.803"></a><span id="l119.803">   if (mOutputType == nsMimeOutput::nsMimeMessageSource)</span>
<a href="#l119.804"></a><span id="l119.804">     return NS_OK;</span>
<a href="#l119.805"></a><span id="l119.805" class="difflineminus">-  else</span>
<a href="#l119.806"></a><span id="l119.806" class="difflineminus">-  {</span>
<a href="#l119.807"></a><span id="l119.807" class="difflineminus">-    mBridgeStream = bridge_create_stream(mEmitter, this, aURI, newType, whattodo, aChannel);</span>
<a href="#l119.808"></a><span id="l119.808" class="difflineplus">+  else {</span>
<a href="#l119.809"></a><span id="l119.809" class="difflineplus">+    mBridgeStream =</span>
<a href="#l119.810"></a><span id="l119.810" class="difflineplus">+        bridge_create_stream(mEmitter, this, aURI, newType, whattodo, aChannel);</span>
<a href="#l119.811"></a><span id="l119.811">     if (!mBridgeStream)</span>
<a href="#l119.812"></a><span id="l119.812">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l119.813"></a><span id="l119.813" class="difflineminus">-    else</span>
<a href="#l119.814"></a><span id="l119.814" class="difflineminus">-    {</span>
<a href="#l119.815"></a><span id="l119.815" class="difflineplus">+    else {</span>
<a href="#l119.816"></a><span id="l119.816">       SetStreamURI(aURI);</span>
<a href="#l119.817"></a><span id="l119.817"> </span>
<a href="#l119.818"></a><span id="l119.818" class="difflineminus">-      //Do we need to setup an Mime Stream Converter Listener?</span>
<a href="#l119.819"></a><span id="l119.819" class="difflineplus">+      // Do we need to setup an Mime Stream Converter Listener?</span>
<a href="#l119.820"></a><span id="l119.820">       if (mMimeStreamConverterListener)</span>
<a href="#l119.821"></a><span id="l119.821" class="difflineminus">-        bridge_set_mime_stream_converter_listener((nsMIMESession *)mBridgeStream, mMimeStreamConverterListener, mOutputType);</span>
<a href="#l119.822"></a><span id="l119.822" class="difflineplus">+        bridge_set_mime_stream_converter_listener(</span>
<a href="#l119.823"></a><span id="l119.823" class="difflineplus">+            (nsMIMESession *)mBridgeStream, mMimeStreamConverterListener,</span>
<a href="#l119.824"></a><span id="l119.824" class="difflineplus">+            mOutputType);</span>
<a href="#l119.825"></a><span id="l119.825"> </span>
<a href="#l119.826"></a><span id="l119.826">       return NS_OK;</span>
<a href="#l119.827"></a><span id="l119.827">     }</span>
<a href="#l119.828"></a><span id="l119.828">   }</span>
<a href="#l119.829"></a><span id="l119.829"> }</span>
<a href="#l119.830"></a><span id="l119.830"> </span>
<a href="#l119.831"></a><span id="l119.831" class="difflineminus">-NS_IMETHODIMP nsStreamConverter::GetContentType(char **aOutputContentType)</span>
<a href="#l119.832"></a><span id="l119.832" class="difflineminus">-{</span>
<a href="#l119.833"></a><span id="l119.833" class="difflineminus">-  if (!aOutputContentType)</span>
<a href="#l119.834"></a><span id="l119.834" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l119.835"></a><span id="l119.835" class="difflineplus">+NS_IMETHODIMP nsStreamConverter::GetContentType(char **aOutputContentType) {</span>
<a href="#l119.836"></a><span id="l119.836" class="difflineplus">+  if (!aOutputContentType) return NS_ERROR_NULL_POINTER;</span>
<a href="#l119.837"></a><span id="l119.837"> </span>
<a href="#l119.838"></a><span id="l119.838" class="difflineminus">-  // since this method passes a string through an IDL file we need to use nsMemory to allocate it</span>
<a href="#l119.839"></a><span id="l119.839" class="difflineminus">-  // and not strdup!</span>
<a href="#l119.840"></a><span id="l119.840" class="difflineplus">+  // since this method passes a string through an IDL file we need to use</span>
<a href="#l119.841"></a><span id="l119.841" class="difflineplus">+  // nsMemory to allocate it and not strdup!</span>
<a href="#l119.842"></a><span id="l119.842">   //  (1) check to see if we have a real content type...use it first...</span>
<a href="#l119.843"></a><span id="l119.843">   if (!mRealContentType.IsEmpty())</span>
<a href="#l119.844"></a><span id="l119.844">     *aOutputContentType = ToNewCString(mRealContentType);</span>
<a href="#l119.845"></a><span id="l119.845">   else if (mOutputFormat.EqualsLiteral(&quot;raw&quot;))</span>
<a href="#l119.846"></a><span id="l119.846" class="difflineminus">-    *aOutputContentType = (char *) moz_xmemdup(UNKNOWN_CONTENT_TYPE, sizeof(UNKNOWN_CONTENT_TYPE));</span>
<a href="#l119.847"></a><span id="l119.847" class="difflineplus">+    *aOutputContentType =</span>
<a href="#l119.848"></a><span id="l119.848" class="difflineplus">+        (char *)moz_xmemdup(UNKNOWN_CONTENT_TYPE, sizeof(UNKNOWN_CONTENT_TYPE));</span>
<a href="#l119.849"></a><span id="l119.849">   else</span>
<a href="#l119.850"></a><span id="l119.850">     *aOutputContentType = ToNewCString(mOutputFormat);</span>
<a href="#l119.851"></a><span id="l119.851">   return NS_OK;</span>
<a href="#l119.852"></a><span id="l119.852"> }</span>
<a href="#l119.853"></a><span id="l119.853"> </span>
<a href="#l119.854"></a><span id="l119.854"> //</span>
<a href="#l119.855"></a><span id="l119.855" class="difflineminus">-// This is the type of output operation that is being requested by libmime. The types</span>
<a href="#l119.856"></a><span id="l119.856" class="difflineminus">-// of output are specified by nsIMimeOutputType enum</span>
<a href="#l119.857"></a><span id="l119.857" class="difflineplus">+// This is the type of output operation that is being requested by libmime. The</span>
<a href="#l119.858"></a><span id="l119.858" class="difflineplus">+// types of output are specified by nsIMimeOutputType enum</span>
<a href="#l119.859"></a><span id="l119.859"> //</span>
<a href="#l119.860"></a><span id="l119.860" class="difflineminus">-nsresult</span>
<a href="#l119.861"></a><span id="l119.861" class="difflineminus">-nsStreamConverter::SetMimeOutputType(nsMimeOutputType aType)</span>
<a href="#l119.862"></a><span id="l119.862" class="difflineminus">-{</span>
<a href="#l119.863"></a><span id="l119.863" class="difflineplus">+nsresult nsStreamConverter::SetMimeOutputType(nsMimeOutputType aType) {</span>
<a href="#l119.864"></a><span id="l119.864">   mAlreadyKnowOutputType = true;</span>
<a href="#l119.865"></a><span id="l119.865">   mOutputType = aType;</span>
<a href="#l119.866"></a><span id="l119.866" class="difflineminus">-  if (mBridgeStream)</span>
<a href="#l119.867"></a><span id="l119.867" class="difflineminus">-    bridge_set_output_type(mBridgeStream, aType);</span>
<a href="#l119.868"></a><span id="l119.868" class="difflineplus">+  if (mBridgeStream) bridge_set_output_type(mBridgeStream, aType);</span>
<a href="#l119.869"></a><span id="l119.869">   return NS_OK;</span>
<a href="#l119.870"></a><span id="l119.870"> }</span>
<a href="#l119.871"></a><span id="l119.871"> </span>
<a href="#l119.872"></a><span id="l119.872" class="difflineminus">-NS_IMETHODIMP nsStreamConverter::GetMimeOutputType(nsMimeOutputType *aOutFormat)</span>
<a href="#l119.873"></a><span id="l119.873" class="difflineminus">-{</span>
<a href="#l119.874"></a><span id="l119.874" class="difflineplus">+NS_IMETHODIMP nsStreamConverter::GetMimeOutputType(</span>
<a href="#l119.875"></a><span id="l119.875" class="difflineplus">+    nsMimeOutputType *aOutFormat) {</span>
<a href="#l119.876"></a><span id="l119.876">   nsresult rv = NS_OK;</span>
<a href="#l119.877"></a><span id="l119.877">   if (aOutFormat)</span>
<a href="#l119.878"></a><span id="l119.878">     *aOutFormat = mOutputType;</span>
<a href="#l119.879"></a><span id="l119.879">   else</span>
<a href="#l119.880"></a><span id="l119.880">     rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l119.881"></a><span id="l119.881"> </span>
<a href="#l119.882"></a><span id="l119.882">   return rv;</span>
<a href="#l119.883"></a><span id="l119.883"> }</span>
<a href="#l119.884"></a><span id="l119.884"> </span>
<a href="#l119.885"></a><span id="l119.885"> //</span>
<a href="#l119.886"></a><span id="l119.886" class="difflineminus">-// This is needed by libmime for MHTML link processing...this is the URI associated</span>
<a href="#l119.887"></a><span id="l119.887" class="difflineminus">-// with this input stream</span>
<a href="#l119.888"></a><span id="l119.888" class="difflineplus">+// This is needed by libmime for MHTML link processing...this is the URI</span>
<a href="#l119.889"></a><span id="l119.889" class="difflineplus">+// associated with this input stream</span>
<a href="#l119.890"></a><span id="l119.890"> //</span>
<a href="#l119.891"></a><span id="l119.891" class="difflineminus">-nsresult</span>
<a href="#l119.892"></a><span id="l119.892" class="difflineminus">-nsStreamConverter::SetStreamURI(nsIURI *aURI)</span>
<a href="#l119.893"></a><span id="l119.893" class="difflineminus">-{</span>
<a href="#l119.894"></a><span id="l119.894" class="difflineplus">+nsresult nsStreamConverter::SetStreamURI(nsIURI *aURI) {</span>
<a href="#l119.895"></a><span id="l119.895">   mURI = aURI;</span>
<a href="#l119.896"></a><span id="l119.896">   if (mBridgeStream)</span>
<a href="#l119.897"></a><span id="l119.897" class="difflineminus">-    return bridge_new_new_uri((nsMIMESession *)mBridgeStream, aURI, mOutputType);</span>
<a href="#l119.898"></a><span id="l119.898" class="difflineplus">+    return bridge_new_new_uri((nsMIMESession *)mBridgeStream, aURI,</span>
<a href="#l119.899"></a><span id="l119.899" class="difflineplus">+                              mOutputType);</span>
<a href="#l119.900"></a><span id="l119.900">   else</span>
<a href="#l119.901"></a><span id="l119.901">     return NS_OK;</span>
<a href="#l119.902"></a><span id="l119.902"> }</span>
<a href="#l119.903"></a><span id="l119.903"> </span>
<a href="#l119.904"></a><span id="l119.904" class="difflineminus">-nsresult</span>
<a href="#l119.905"></a><span id="l119.905" class="difflineminus">-nsStreamConverter::SetMimeHeadersListener(nsIMimeStreamConverterListener *listener, nsMimeOutputType aType)</span>
<a href="#l119.906"></a><span id="l119.906" class="difflineminus">-{</span>
<a href="#l119.907"></a><span id="l119.907" class="difflineminus">-   mMimeStreamConverterListener = listener;</span>
<a href="#l119.908"></a><span id="l119.908" class="difflineminus">-   bridge_set_mime_stream_converter_listener((nsMIMESession *)mBridgeStream, listener, aType);</span>
<a href="#l119.909"></a><span id="l119.909" class="difflineminus">-   return NS_OK;</span>
<a href="#l119.910"></a><span id="l119.910" class="difflineplus">+nsresult nsStreamConverter::SetMimeHeadersListener(</span>
<a href="#l119.911"></a><span id="l119.911" class="difflineplus">+    nsIMimeStreamConverterListener *listener, nsMimeOutputType aType) {</span>
<a href="#l119.912"></a><span id="l119.912" class="difflineplus">+  mMimeStreamConverterListener = listener;</span>
<a href="#l119.913"></a><span id="l119.913" class="difflineplus">+  bridge_set_mime_stream_converter_listener((nsMIMESession *)mBridgeStream,</span>
<a href="#l119.914"></a><span id="l119.914" class="difflineplus">+                                            listener, aType);</span>
<a href="#l119.915"></a><span id="l119.915" class="difflineplus">+  return NS_OK;</span>
<a href="#l119.916"></a><span id="l119.916"> }</span>
<a href="#l119.917"></a><span id="l119.917"> </span>
<a href="#l119.918"></a><span id="l119.918"> NS_IMETHODIMP</span>
<a href="#l119.919"></a><span id="l119.919" class="difflineminus">-nsStreamConverter::SetForwardInline(bool aForwardInline)</span>
<a href="#l119.920"></a><span id="l119.920" class="difflineminus">-{</span>
<a href="#l119.921"></a><span id="l119.921" class="difflineplus">+nsStreamConverter::SetForwardInline(bool aForwardInline) {</span>
<a href="#l119.922"></a><span id="l119.922">   mForwardInline = aForwardInline;</span>
<a href="#l119.923"></a><span id="l119.923">   return NS_OK;</span>
<a href="#l119.924"></a><span id="l119.924"> }</span>
<a href="#l119.925"></a><span id="l119.925"> </span>
<a href="#l119.926"></a><span id="l119.926"> NS_IMETHODIMP</span>
<a href="#l119.927"></a><span id="l119.927" class="difflineminus">-nsStreamConverter::GetForwardToAddress(nsAString &amp;aAddress)</span>
<a href="#l119.928"></a><span id="l119.928" class="difflineminus">-{</span>
<a href="#l119.929"></a><span id="l119.929" class="difflineplus">+nsStreamConverter::GetForwardToAddress(nsAString &amp;aAddress) {</span>
<a href="#l119.930"></a><span id="l119.930">   aAddress = mForwardToAddress;</span>
<a href="#l119.931"></a><span id="l119.931">   return NS_OK;</span>
<a href="#l119.932"></a><span id="l119.932"> }</span>
<a href="#l119.933"></a><span id="l119.933"> </span>
<a href="#l119.934"></a><span id="l119.934"> NS_IMETHODIMP</span>
<a href="#l119.935"></a><span id="l119.935" class="difflineminus">-nsStreamConverter::SetForwardToAddress(const nsAString &amp;aAddress)</span>
<a href="#l119.936"></a><span id="l119.936" class="difflineminus">-{</span>
<a href="#l119.937"></a><span id="l119.937" class="difflineplus">+nsStreamConverter::SetForwardToAddress(const nsAString &amp;aAddress) {</span>
<a href="#l119.938"></a><span id="l119.938">   mForwardToAddress = aAddress;</span>
<a href="#l119.939"></a><span id="l119.939">   return NS_OK;</span>
<a href="#l119.940"></a><span id="l119.940"> }</span>
<a href="#l119.941"></a><span id="l119.941"> </span>
<a href="#l119.942"></a><span id="l119.942"> NS_IMETHODIMP</span>
<a href="#l119.943"></a><span id="l119.943" class="difflineminus">-nsStreamConverter::GetOverrideComposeFormat(bool *aResult)</span>
<a href="#l119.944"></a><span id="l119.944" class="difflineminus">-{</span>
<a href="#l119.945"></a><span id="l119.945" class="difflineminus">-  if (!aResult)</span>
<a href="#l119.946"></a><span id="l119.946" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l119.947"></a><span id="l119.947" class="difflineplus">+nsStreamConverter::GetOverrideComposeFormat(bool *aResult) {</span>
<a href="#l119.948"></a><span id="l119.948" class="difflineplus">+  if (!aResult) return NS_ERROR_NULL_POINTER;</span>
<a href="#l119.949"></a><span id="l119.949">   *aResult = mOverrideComposeFormat;</span>
<a href="#l119.950"></a><span id="l119.950">   return NS_OK;</span>
<a href="#l119.951"></a><span id="l119.951"> }</span>
<a href="#l119.952"></a><span id="l119.952"> </span>
<a href="#l119.953"></a><span id="l119.953"> NS_IMETHODIMP</span>
<a href="#l119.954"></a><span id="l119.954" class="difflineminus">-nsStreamConverter::SetOverrideComposeFormat(bool aOverrideComposeFormat)</span>
<a href="#l119.955"></a><span id="l119.955" class="difflineminus">-{</span>
<a href="#l119.956"></a><span id="l119.956" class="difflineplus">+nsStreamConverter::SetOverrideComposeFormat(bool aOverrideComposeFormat) {</span>
<a href="#l119.957"></a><span id="l119.957">   mOverrideComposeFormat = aOverrideComposeFormat;</span>
<a href="#l119.958"></a><span id="l119.958">   return NS_OK;</span>
<a href="#l119.959"></a><span id="l119.959"> }</span>
<a href="#l119.960"></a><span id="l119.960"> </span>
<a href="#l119.961"></a><span id="l119.961"> NS_IMETHODIMP</span>
<a href="#l119.962"></a><span id="l119.962" class="difflineminus">-nsStreamConverter::GetForwardInline(bool *aResult)</span>
<a href="#l119.963"></a><span id="l119.963" class="difflineminus">-{</span>
<a href="#l119.964"></a><span id="l119.964" class="difflineplus">+nsStreamConverter::GetForwardInline(bool *aResult) {</span>
<a href="#l119.965"></a><span id="l119.965">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l119.966"></a><span id="l119.966">   *aResult = mForwardInline;</span>
<a href="#l119.967"></a><span id="l119.967">   return NS_OK;</span>
<a href="#l119.968"></a><span id="l119.968"> }</span>
<a href="#l119.969"></a><span id="l119.969"> </span>
<a href="#l119.970"></a><span id="l119.970"> NS_IMETHODIMP</span>
<a href="#l119.971"></a><span id="l119.971" class="difflineminus">-nsStreamConverter::GetForwardInlineFilter(bool *aResult)</span>
<a href="#l119.972"></a><span id="l119.972" class="difflineminus">-{</span>
<a href="#l119.973"></a><span id="l119.973" class="difflineplus">+nsStreamConverter::GetForwardInlineFilter(bool *aResult) {</span>
<a href="#l119.974"></a><span id="l119.974">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l119.975"></a><span id="l119.975">   *aResult = mForwardInlineFilter;</span>
<a href="#l119.976"></a><span id="l119.976">   return NS_OK;</span>
<a href="#l119.977"></a><span id="l119.977"> }</span>
<a href="#l119.978"></a><span id="l119.978"> </span>
<a href="#l119.979"></a><span id="l119.979"> NS_IMETHODIMP</span>
<a href="#l119.980"></a><span id="l119.980" class="difflineminus">-nsStreamConverter::SetForwardInlineFilter(bool aForwardInlineFilter)</span>
<a href="#l119.981"></a><span id="l119.981" class="difflineminus">-{</span>
<a href="#l119.982"></a><span id="l119.982" class="difflineplus">+nsStreamConverter::SetForwardInlineFilter(bool aForwardInlineFilter) {</span>
<a href="#l119.983"></a><span id="l119.983">   mForwardInlineFilter = aForwardInlineFilter;</span>
<a href="#l119.984"></a><span id="l119.984">   return NS_OK;</span>
<a href="#l119.985"></a><span id="l119.985"> }</span>
<a href="#l119.986"></a><span id="l119.986"> </span>
<a href="#l119.987"></a><span id="l119.987"> NS_IMETHODIMP</span>
<a href="#l119.988"></a><span id="l119.988" class="difflineminus">-nsStreamConverter::GetIdentity(nsIMsgIdentity * *aIdentity)</span>
<a href="#l119.989"></a><span id="l119.989" class="difflineminus">-{</span>
<a href="#l119.990"></a><span id="l119.990" class="difflineplus">+nsStreamConverter::GetIdentity(nsIMsgIdentity **aIdentity) {</span>
<a href="#l119.991"></a><span id="l119.991">   if (!aIdentity) return NS_ERROR_NULL_POINTER;</span>
<a href="#l119.992"></a><span id="l119.992">   // We don't have an identity for the local folders account,</span>
<a href="#l119.993"></a><span id="l119.993">   // we will return null but it is not an error!</span>
<a href="#l119.994"></a><span id="l119.994">   NS_IF_ADDREF(*aIdentity = mIdentity);</span>
<a href="#l119.995"></a><span id="l119.995">   return NS_OK;</span>
<a href="#l119.996"></a><span id="l119.996"> }</span>
<a href="#l119.997"></a><span id="l119.997"> </span>
<a href="#l119.998"></a><span id="l119.998"> NS_IMETHODIMP</span>
<a href="#l119.999"></a><span id="l119.999" class="difflineminus">-nsStreamConverter::SetIdentity(nsIMsgIdentity * aIdentity)</span>
<a href="#l119.1000"></a><span id="l119.1000" class="difflineminus">-{</span>
<a href="#l119.1001"></a><span id="l119.1001" class="difflineplus">+nsStreamConverter::SetIdentity(nsIMsgIdentity *aIdentity) {</span>
<a href="#l119.1002"></a><span id="l119.1002">   mIdentity = aIdentity;</span>
<a href="#l119.1003"></a><span id="l119.1003">   return NS_OK;</span>
<a href="#l119.1004"></a><span id="l119.1004"> }</span>
<a href="#l119.1005"></a><span id="l119.1005"> </span>
<a href="#l119.1006"></a><span id="l119.1006"> NS_IMETHODIMP</span>
<a href="#l119.1007"></a><span id="l119.1007" class="difflineminus">-nsStreamConverter::SetOriginalMsgURI(const char * originalMsgURI)</span>
<a href="#l119.1008"></a><span id="l119.1008" class="difflineminus">-{</span>
<a href="#l119.1009"></a><span id="l119.1009" class="difflineplus">+nsStreamConverter::SetOriginalMsgURI(const char *originalMsgURI) {</span>
<a href="#l119.1010"></a><span id="l119.1010">   mOriginalMsgURI = originalMsgURI;</span>
<a href="#l119.1011"></a><span id="l119.1011">   return NS_OK;</span>
<a href="#l119.1012"></a><span id="l119.1012"> }</span>
<a href="#l119.1013"></a><span id="l119.1013"> </span>
<a href="#l119.1014"></a><span id="l119.1014"> NS_IMETHODIMP</span>
<a href="#l119.1015"></a><span id="l119.1015" class="difflineminus">-nsStreamConverter::GetOriginalMsgURI(char ** result)</span>
<a href="#l119.1016"></a><span id="l119.1016" class="difflineminus">-{</span>
<a href="#l119.1017"></a><span id="l119.1017" class="difflineplus">+nsStreamConverter::GetOriginalMsgURI(char **result) {</span>
<a href="#l119.1018"></a><span id="l119.1018">   if (!result) return NS_ERROR_NULL_POINTER;</span>
<a href="#l119.1019"></a><span id="l119.1019">   *result = ToNewCString(mOriginalMsgURI);</span>
<a href="#l119.1020"></a><span id="l119.1020">   return NS_OK;</span>
<a href="#l119.1021"></a><span id="l119.1021"> }</span>
<a href="#l119.1022"></a><span id="l119.1022"> </span>
<a href="#l119.1023"></a><span id="l119.1023"> NS_IMETHODIMP</span>
<a href="#l119.1024"></a><span id="l119.1024" class="difflineminus">-nsStreamConverter::SetOrigMsgHdr(nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l119.1025"></a><span id="l119.1025" class="difflineminus">-{</span>
<a href="#l119.1026"></a><span id="l119.1026" class="difflineplus">+nsStreamConverter::SetOrigMsgHdr(nsIMsgDBHdr *aMsgHdr) {</span>
<a href="#l119.1027"></a><span id="l119.1027">   mOrigMsgHdr = aMsgHdr;</span>
<a href="#l119.1028"></a><span id="l119.1028">   return NS_OK;</span>
<a href="#l119.1029"></a><span id="l119.1029"> }</span>
<a href="#l119.1030"></a><span id="l119.1030"> </span>
<a href="#l119.1031"></a><span id="l119.1031"> NS_IMETHODIMP</span>
<a href="#l119.1032"></a><span id="l119.1032" class="difflineminus">-nsStreamConverter::GetOrigMsgHdr(nsIMsgDBHdr * *aMsgHdr)</span>
<a href="#l119.1033"></a><span id="l119.1033" class="difflineminus">-{</span>
<a href="#l119.1034"></a><span id="l119.1034" class="difflineplus">+nsStreamConverter::GetOrigMsgHdr(nsIMsgDBHdr **aMsgHdr) {</span>
<a href="#l119.1035"></a><span id="l119.1035">   if (!aMsgHdr) return NS_ERROR_NULL_POINTER;</span>
<a href="#l119.1036"></a><span id="l119.1036">   NS_IF_ADDREF(*aMsgHdr = mOrigMsgHdr);</span>
<a href="#l119.1037"></a><span id="l119.1037">   return NS_OK;</span>
<a href="#l119.1038"></a><span id="l119.1038"> }</span>
<a href="#l119.1039"></a><span id="l119.1039"> </span>
<a href="#l119.1040"></a><span id="l119.1040"> /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l119.1041"></a><span id="l119.1041"> // Methods for nsIStreamListener...</span>
<a href="#l119.1042"></a><span id="l119.1042"> /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l119.1043"></a><span id="l119.1043"> //</span>
<a href="#l119.1044"></a><span id="l119.1044"> // Notify the client that data is available in the input stream.  This</span>
<a href="#l119.1045"></a><span id="l119.1045"> // method is called whenever data is written into the input stream by the</span>
<a href="#l119.1046"></a><span id="l119.1046"> // networking library...</span>
<a href="#l119.1047"></a><span id="l119.1047"> //</span>
<a href="#l119.1048"></a><span id="l119.1048" class="difflineminus">-nsresult</span>
<a href="#l119.1049"></a><span id="l119.1049" class="difflineminus">-nsStreamConverter::OnDataAvailable(nsIRequest     *request,</span>
<a href="#l119.1050"></a><span id="l119.1050" class="difflineminus">-                                   nsIInputStream *aIStream,</span>
<a href="#l119.1051"></a><span id="l119.1051" class="difflineminus">-                                   uint64_t       sourceOffset,</span>
<a href="#l119.1052"></a><span id="l119.1052" class="difflineminus">-                                   uint32_t       aLength)</span>
<a href="#l119.1053"></a><span id="l119.1053" class="difflineminus">-{</span>
<a href="#l119.1054"></a><span id="l119.1054" class="difflineminus">-  nsresult        rc=NS_OK;     // should this be an error instead?</span>
<a href="#l119.1055"></a><span id="l119.1055" class="difflineminus">-  uint32_t        readLen = aLength;</span>
<a href="#l119.1056"></a><span id="l119.1056" class="difflineminus">-  uint32_t        written;</span>
<a href="#l119.1057"></a><span id="l119.1057" class="difflineplus">+nsresult nsStreamConverter::OnDataAvailable(nsIRequest *request,</span>
<a href="#l119.1058"></a><span id="l119.1058" class="difflineplus">+                                            nsIInputStream *aIStream,</span>
<a href="#l119.1059"></a><span id="l119.1059" class="difflineplus">+                                            uint64_t sourceOffset,</span>
<a href="#l119.1060"></a><span id="l119.1060" class="difflineplus">+                                            uint32_t aLength) {</span>
<a href="#l119.1061"></a><span id="l119.1061" class="difflineplus">+  nsresult rc = NS_OK;  // should this be an error instead?</span>
<a href="#l119.1062"></a><span id="l119.1062" class="difflineplus">+  uint32_t readLen = aLength;</span>
<a href="#l119.1063"></a><span id="l119.1063" class="difflineplus">+  uint32_t written;</span>
<a href="#l119.1064"></a><span id="l119.1064"> </span>
<a href="#l119.1065"></a><span id="l119.1065">   // If this is the first time through and we are supposed to be</span>
<a href="#l119.1066"></a><span id="l119.1066">   // outputting the wrapper two pane URL, then do it now.</span>
<a href="#l119.1067"></a><span id="l119.1067" class="difflineminus">-  if (mWrapperOutput)</span>
<a href="#l119.1068"></a><span id="l119.1068" class="difflineminus">-  {</span>
<a href="#l119.1069"></a><span id="l119.1069" class="difflineminus">-    char        outBuf[1024];</span>
<a href="#l119.1070"></a><span id="l119.1070" class="difflineminus">-const char output[] = &quot;\</span>
<a href="#l119.1071"></a><span id="l119.1071" class="difflineplus">+  if (mWrapperOutput) {</span>
<a href="#l119.1072"></a><span id="l119.1072" class="difflineplus">+    char outBuf[1024];</span>
<a href="#l119.1073"></a><span id="l119.1073" class="difflineplus">+    const char output[] =</span>
<a href="#l119.1074"></a><span id="l119.1074" class="difflineplus">+        &quot;\</span>
<a href="#l119.1075"></a><span id="l119.1075"> &lt;HTML&gt;\</span>
<a href="#l119.1076"></a><span id="l119.1076"> &lt;FRAMESET ROWS=\&quot;30%%,70%%\&quot;&gt;\</span>
<a href="#l119.1077"></a><span id="l119.1077"> &lt;FRAME NAME=messageHeader SRC=\&quot;%s?header=only\&quot;&gt;\</span>
<a href="#l119.1078"></a><span id="l119.1078"> &lt;FRAME NAME=messageBody SRC=\&quot;%s?header=none\&quot;&gt;\</span>
<a href="#l119.1079"></a><span id="l119.1079"> &lt;/FRAMESET&gt;\</span>
<a href="#l119.1080"></a><span id="l119.1080"> &lt;/HTML&gt;&quot;;</span>
<a href="#l119.1081"></a><span id="l119.1081"> </span>
<a href="#l119.1082"></a><span id="l119.1082">     nsAutoCString url;</span>
<a href="#l119.1083"></a><span id="l119.1083" class="difflineminus">-    if (NS_FAILED(mURI-&gt;GetSpec(url)))</span>
<a href="#l119.1084"></a><span id="l119.1084" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l119.1085"></a><span id="l119.1085" class="difflineplus">+    if (NS_FAILED(mURI-&gt;GetSpec(url))) return NS_ERROR_FAILURE;</span>
<a href="#l119.1086"></a><span id="l119.1086"> </span>
<a href="#l119.1087"></a><span id="l119.1087">     PR_snprintf(outBuf, sizeof(outBuf), output, url.get(), url.get());</span>
<a href="#l119.1088"></a><span id="l119.1088"> </span>
<a href="#l119.1089"></a><span id="l119.1089" class="difflineminus">-    if (mEmitter)</span>
<a href="#l119.1090"></a><span id="l119.1090" class="difflineminus">-      mEmitter-&gt;Write(nsDependentCString(outBuf), &amp;written);</span>
<a href="#l119.1091"></a><span id="l119.1091" class="difflineplus">+    if (mEmitter) mEmitter-&gt;Write(nsDependentCString(outBuf), &amp;written);</span>
<a href="#l119.1092"></a><span id="l119.1092"> </span>
<a href="#l119.1093"></a><span id="l119.1093">     // rhp: will this stop the stream???? Not sure.</span>
<a href="#l119.1094"></a><span id="l119.1094">     return NS_ERROR_FAILURE;</span>
<a href="#l119.1095"></a><span id="l119.1095">   }</span>
<a href="#l119.1096"></a><span id="l119.1096"> </span>
<a href="#l119.1097"></a><span id="l119.1097">   NS_ENSURE_TRUE(aIStream, NS_ERROR_NULL_POINTER);</span>
<a href="#l119.1098"></a><span id="l119.1098">   char *buf = (char *)PR_Malloc(aLength);</span>
<a href="#l119.1099"></a><span id="l119.1099" class="difflineminus">-  if (!buf)</span>
<a href="#l119.1100"></a><span id="l119.1100" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY; /* we couldn't allocate the object */</span>
<a href="#l119.1101"></a><span id="l119.1101" class="difflineplus">+  if (!buf) return NS_ERROR_OUT_OF_MEMORY; /* we couldn't allocate the object */</span>
<a href="#l119.1102"></a><span id="l119.1102"> </span>
<a href="#l119.1103"></a><span id="l119.1103">   readLen = aLength;</span>
<a href="#l119.1104"></a><span id="l119.1104">   aIStream-&gt;Read(buf, aLength, &amp;readLen);</span>
<a href="#l119.1105"></a><span id="l119.1105"> </span>
<a href="#l119.1106"></a><span id="l119.1106" class="difflineminus">-  // We need to filter out any null characters else we will have a lot of trouble</span>
<a href="#l119.1107"></a><span id="l119.1107" class="difflineminus">-  // as we use c string everywhere in mime</span>
<a href="#l119.1108"></a><span id="l119.1108" class="difflineminus">-  char * readPtr;</span>
<a href="#l119.1109"></a><span id="l119.1109" class="difflineminus">-  char * endPtr = buf + readLen;</span>
<a href="#l119.1110"></a><span id="l119.1110" class="difflineplus">+  // We need to filter out any null characters else we will have a lot of</span>
<a href="#l119.1111"></a><span id="l119.1111" class="difflineplus">+  // trouble as we use c string everywhere in mime</span>
<a href="#l119.1112"></a><span id="l119.1112" class="difflineplus">+  char *readPtr;</span>
<a href="#l119.1113"></a><span id="l119.1113" class="difflineplus">+  char *endPtr = buf + readLen;</span>
<a href="#l119.1114"></a><span id="l119.1114"> </span>
<a href="#l119.1115"></a><span id="l119.1115">   // First let see if the stream contains null characters</span>
<a href="#l119.1116"></a><span id="l119.1116" class="difflineminus">-  for (readPtr = buf; readPtr &lt; endPtr &amp;&amp; *readPtr; readPtr ++)</span>
<a href="#l119.1117"></a><span id="l119.1117" class="difflineplus">+  for (readPtr = buf; readPtr &lt; endPtr &amp;&amp; *readPtr; readPtr++)</span>
<a href="#l119.1118"></a><span id="l119.1118">     ;</span>
<a href="#l119.1119"></a><span id="l119.1119"> </span>
<a href="#l119.1120"></a><span id="l119.1120">   // Did we find a null character? Then, we need to cleanup the stream</span>
<a href="#l119.1121"></a><span id="l119.1121" class="difflineminus">-  if (readPtr &lt; endPtr)</span>
<a href="#l119.1122"></a><span id="l119.1122" class="difflineminus">-  {</span>
<a href="#l119.1123"></a><span id="l119.1123" class="difflineminus">-    char * writePtr = readPtr;</span>
<a href="#l119.1124"></a><span id="l119.1124" class="difflineminus">-    for (readPtr ++; readPtr &lt; endPtr; readPtr ++)</span>
<a href="#l119.1125"></a><span id="l119.1125" class="difflineminus">-    {</span>
<a href="#l119.1126"></a><span id="l119.1126" class="difflineminus">-      if (!*readPtr)</span>
<a href="#l119.1127"></a><span id="l119.1127" class="difflineminus">-        continue;</span>
<a href="#l119.1128"></a><span id="l119.1128" class="difflineplus">+  if (readPtr &lt; endPtr) {</span>
<a href="#l119.1129"></a><span id="l119.1129" class="difflineplus">+    char *writePtr = readPtr;</span>
<a href="#l119.1130"></a><span id="l119.1130" class="difflineplus">+    for (readPtr++; readPtr &lt; endPtr; readPtr++) {</span>
<a href="#l119.1131"></a><span id="l119.1131" class="difflineplus">+      if (!*readPtr) continue;</span>
<a href="#l119.1132"></a><span id="l119.1132"> </span>
<a href="#l119.1133"></a><span id="l119.1133">       *writePtr = *readPtr;</span>
<a href="#l119.1134"></a><span id="l119.1134" class="difflineminus">-      writePtr ++;</span>
<a href="#l119.1135"></a><span id="l119.1135" class="difflineplus">+      writePtr++;</span>
<a href="#l119.1136"></a><span id="l119.1136">     }</span>
<a href="#l119.1137"></a><span id="l119.1137">     readLen = writePtr - buf;</span>
<a href="#l119.1138"></a><span id="l119.1138">   }</span>
<a href="#l119.1139"></a><span id="l119.1139"> </span>
<a href="#l119.1140"></a><span id="l119.1140" class="difflineminus">-  if (mOutputType == nsMimeOutput::nsMimeMessageSource)</span>
<a href="#l119.1141"></a><span id="l119.1141" class="difflineminus">-  {</span>
<a href="#l119.1142"></a><span id="l119.1142" class="difflineplus">+  if (mOutputType == nsMimeOutput::nsMimeMessageSource) {</span>
<a href="#l119.1143"></a><span id="l119.1143">     rc = NS_OK;</span>
<a href="#l119.1144"></a><span id="l119.1144" class="difflineminus">-    if (mEmitter)</span>
<a href="#l119.1145"></a><span id="l119.1145" class="difflineminus">-    {</span>
<a href="#l119.1146"></a><span id="l119.1146" class="difflineminus">-      rc = mEmitter-&gt;Write(Substring(buf, buf+readLen), &amp;written);</span>
<a href="#l119.1147"></a><span id="l119.1147" class="difflineplus">+    if (mEmitter) {</span>
<a href="#l119.1148"></a><span id="l119.1148" class="difflineplus">+      rc = mEmitter-&gt;Write(Substring(buf, buf + readLen), &amp;written);</span>
<a href="#l119.1149"></a><span id="l119.1149">     }</span>
<a href="#l119.1150"></a><span id="l119.1150" class="difflineminus">-  }</span>
<a href="#l119.1151"></a><span id="l119.1151" class="difflineminus">-  else if (mBridgeStream)</span>
<a href="#l119.1152"></a><span id="l119.1152" class="difflineminus">-  {</span>
<a href="#l119.1153"></a><span id="l119.1153" class="difflineminus">-    nsMIMESession   *tSession = (nsMIMESession *) mBridgeStream;</span>
<a href="#l119.1154"></a><span id="l119.1154" class="difflineplus">+  } else if (mBridgeStream) {</span>
<a href="#l119.1155"></a><span id="l119.1155" class="difflineplus">+    nsMIMESession *tSession = (nsMIMESession *)mBridgeStream;</span>
<a href="#l119.1156"></a><span id="l119.1156">     // XXX Casting int to nsresult</span>
<a href="#l119.1157"></a><span id="l119.1157">     rc = static_cast&lt;nsresult&gt;(</span>
<a href="#l119.1158"></a><span id="l119.1158" class="difflineminus">-      tSession-&gt;put_block((nsMIMESession *)mBridgeStream, buf, readLen));</span>
<a href="#l119.1159"></a><span id="l119.1159" class="difflineplus">+        tSession-&gt;put_block((nsMIMESession *)mBridgeStream, buf, readLen));</span>
<a href="#l119.1160"></a><span id="l119.1160">   }</span>
<a href="#l119.1161"></a><span id="l119.1161"> </span>
<a href="#l119.1162"></a><span id="l119.1162">   PR_FREEIF(buf);</span>
<a href="#l119.1163"></a><span id="l119.1163">   return rc;</span>
<a href="#l119.1164"></a><span id="l119.1164"> }</span>
<a href="#l119.1165"></a><span id="l119.1165"> </span>
<a href="#l119.1166"></a><span id="l119.1166"> /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l119.1167"></a><span id="l119.1167"> // Methods for nsIRequestObserver</span>
<a href="#l119.1168"></a><span id="l119.1168"> /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l119.1169"></a><span id="l119.1169"> //</span>
<a href="#l119.1170"></a><span id="l119.1170"> // Notify the observer that the URL has started to load.  This method is</span>
<a href="#l119.1171"></a><span id="l119.1171"> // called only once, at the beginning of a URL load.</span>
<a href="#l119.1172"></a><span id="l119.1172"> //</span>
<a href="#l119.1173"></a><span id="l119.1173" class="difflineminus">-nsresult</span>
<a href="#l119.1174"></a><span id="l119.1174" class="difflineminus">-nsStreamConverter::OnStartRequest(nsIRequest *request)</span>
<a href="#l119.1175"></a><span id="l119.1175" class="difflineminus">-{</span>
<a href="#l119.1176"></a><span id="l119.1176" class="difflineplus">+nsresult nsStreamConverter::OnStartRequest(nsIRequest *request) {</span>
<a href="#l119.1177"></a><span id="l119.1177"> #ifdef DEBUG_rhp</span>
<a href="#l119.1178"></a><span id="l119.1178" class="difflineminus">-    printf(&quot;nsStreamConverter::OnStartRequest()\n&quot;);</span>
<a href="#l119.1179"></a><span id="l119.1179" class="difflineplus">+  printf(&quot;nsStreamConverter::OnStartRequest()\n&quot;);</span>
<a href="#l119.1180"></a><span id="l119.1180"> #endif</span>
<a href="#l119.1181"></a><span id="l119.1181"> </span>
<a href="#l119.1182"></a><span id="l119.1182"> #ifdef DEBUG_mscott</span>
<a href="#l119.1183"></a><span id="l119.1183">   mConvertContentTime = PR_IntervalNow();</span>
<a href="#l119.1184"></a><span id="l119.1184"> #endif</span>
<a href="#l119.1185"></a><span id="l119.1185"> </span>
<a href="#l119.1186"></a><span id="l119.1186">   // here's a little bit of hackery....</span>
<a href="#l119.1187"></a><span id="l119.1187">   // since the mime converter is now between the channel</span>
<a href="#l119.1188"></a><span id="l119.1188">   // and the</span>
<a href="#l119.1189"></a><span id="l119.1189" class="difflineminus">-  if (request)</span>
<a href="#l119.1190"></a><span id="l119.1190" class="difflineminus">-  {</span>
<a href="#l119.1191"></a><span id="l119.1191" class="difflineplus">+  if (request) {</span>
<a href="#l119.1192"></a><span id="l119.1192">     nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(request);</span>
<a href="#l119.1193"></a><span id="l119.1193" class="difflineminus">-    if (channel)</span>
<a href="#l119.1194"></a><span id="l119.1194" class="difflineminus">-    {</span>
<a href="#l119.1195"></a><span id="l119.1195" class="difflineplus">+    if (channel) {</span>
<a href="#l119.1196"></a><span id="l119.1196">       nsCString contentType;</span>
<a href="#l119.1197"></a><span id="l119.1197">       GetContentType(getter_Copies(contentType));</span>
<a href="#l119.1198"></a><span id="l119.1198"> </span>
<a href="#l119.1199"></a><span id="l119.1199">       channel-&gt;SetContentType(contentType);</span>
<a href="#l119.1200"></a><span id="l119.1200">     }</span>
<a href="#l119.1201"></a><span id="l119.1201">   }</span>
<a href="#l119.1202"></a><span id="l119.1202"> </span>
<a href="#l119.1203"></a><span id="l119.1203">   // forward the start request to any listeners</span>
<a href="#l119.1204"></a><span id="l119.1204" class="difflineminus">-  if (mOutListener)</span>
<a href="#l119.1205"></a><span id="l119.1205" class="difflineminus">-  {</span>
<a href="#l119.1206"></a><span id="l119.1206" class="difflineminus">-    if (mOutputType == nsMimeOutput::nsMimeMessageRaw)</span>
<a href="#l119.1207"></a><span id="l119.1207" class="difflineminus">-    {</span>
<a href="#l119.1208"></a><span id="l119.1208" class="difflineminus">-      //we need to delay the on start request until we have figure out the real content type</span>
<a href="#l119.1209"></a><span id="l119.1209" class="difflineplus">+  if (mOutListener) {</span>
<a href="#l119.1210"></a><span id="l119.1210" class="difflineplus">+    if (mOutputType == nsMimeOutput::nsMimeMessageRaw) {</span>
<a href="#l119.1211"></a><span id="l119.1211" class="difflineplus">+      // we need to delay the on start request until we have figure out the real</span>
<a href="#l119.1212"></a><span id="l119.1212" class="difflineplus">+      // content type</span>
<a href="#l119.1213"></a><span id="l119.1213">       mPendingRequest = request;</span>
<a href="#l119.1214"></a><span id="l119.1214" class="difflineminus">-    }</span>
<a href="#l119.1215"></a><span id="l119.1215" class="difflineminus">-    else</span>
<a href="#l119.1216"></a><span id="l119.1216" class="difflineplus">+    } else</span>
<a href="#l119.1217"></a><span id="l119.1217">       mOutListener-&gt;OnStartRequest(request);</span>
<a href="#l119.1218"></a><span id="l119.1218">   }</span>
<a href="#l119.1219"></a><span id="l119.1219"> </span>
<a href="#l119.1220"></a><span id="l119.1220">   return NS_OK;</span>
<a href="#l119.1221"></a><span id="l119.1221"> }</span>
<a href="#l119.1222"></a><span id="l119.1222"> </span>
<a href="#l119.1223"></a><span id="l119.1223"> //</span>
<a href="#l119.1224"></a><span id="l119.1224"> // Notify the observer that the URL has finished loading.  This method is</span>
<a href="#l119.1225"></a><span id="l119.1225"> // called once when the networking library has finished processing the</span>
<a href="#l119.1226"></a><span id="l119.1226"> //</span>
<a href="#l119.1227"></a><span id="l119.1227" class="difflineminus">-nsresult</span>
<a href="#l119.1228"></a><span id="l119.1228" class="difflineminus">-nsStreamConverter::OnStopRequest(nsIRequest *request, nsresult status)</span>
<a href="#l119.1229"></a><span id="l119.1229" class="difflineminus">-{</span>
<a href="#l119.1230"></a><span id="l119.1230" class="difflineplus">+nsresult nsStreamConverter::OnStopRequest(nsIRequest *request,</span>
<a href="#l119.1231"></a><span id="l119.1231" class="difflineplus">+                                          nsresult status) {</span>
<a href="#l119.1232"></a><span id="l119.1232">   // Make sure we fire any pending OnStartRequest before we do OnStop.</span>
<a href="#l119.1233"></a><span id="l119.1233">   FirePendingStartRequest();</span>
<a href="#l119.1234"></a><span id="l119.1234"> #ifdef DEBUG_rhp</span>
<a href="#l119.1235"></a><span id="l119.1235" class="difflineminus">-    printf(&quot;nsStreamConverter::OnStopRequest()\n&quot;);</span>
<a href="#l119.1236"></a><span id="l119.1236" class="difflineplus">+  printf(&quot;nsStreamConverter::OnStopRequest()\n&quot;);</span>
<a href="#l119.1237"></a><span id="l119.1237"> #endif</span>
<a href="#l119.1238"></a><span id="l119.1238"> </span>
<a href="#l119.1239"></a><span id="l119.1239">   //</span>
<a href="#l119.1240"></a><span id="l119.1240">   // Now complete the stream!</span>
<a href="#l119.1241"></a><span id="l119.1241">   //</span>
<a href="#l119.1242"></a><span id="l119.1242" class="difflineminus">-  if (mBridgeStream)</span>
<a href="#l119.1243"></a><span id="l119.1243" class="difflineminus">-  {</span>
<a href="#l119.1244"></a><span id="l119.1244" class="difflineminus">-    nsMIMESession   *tSession = (nsMIMESession *) mBridgeStream;</span>
<a href="#l119.1245"></a><span id="l119.1245" class="difflineplus">+  if (mBridgeStream) {</span>
<a href="#l119.1246"></a><span id="l119.1246" class="difflineplus">+    nsMIMESession *tSession = (nsMIMESession *)mBridgeStream;</span>
<a href="#l119.1247"></a><span id="l119.1247"> </span>
<a href="#l119.1248"></a><span id="l119.1248" class="difflineminus">-    if (mMimeStreamConverterListener)</span>
<a href="#l119.1249"></a><span id="l119.1249" class="difflineminus">-    {</span>
<a href="#l119.1250"></a><span id="l119.1250" class="difflineminus">-</span>
<a href="#l119.1251"></a><span id="l119.1251" class="difflineminus">-      MimeHeaders    **workHeaders = nullptr;</span>
<a href="#l119.1252"></a><span id="l119.1252" class="difflineplus">+    if (mMimeStreamConverterListener) {</span>
<a href="#l119.1253"></a><span id="l119.1253" class="difflineplus">+      MimeHeaders **workHeaders = nullptr;</span>
<a href="#l119.1254"></a><span id="l119.1254"> </span>
<a href="#l119.1255"></a><span id="l119.1255" class="difflineminus">-      if  ( (mOutputType == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l119.1256"></a><span id="l119.1256" class="difflineminus">-            (mOutputType == nsMimeOutput::nsMimeMessageEditorTemplate) )</span>
<a href="#l119.1257"></a><span id="l119.1257" class="difflineminus">-      {</span>
<a href="#l119.1258"></a><span id="l119.1258" class="difflineplus">+      if ((mOutputType == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l119.1259"></a><span id="l119.1259" class="difflineplus">+          (mOutputType == nsMimeOutput::nsMimeMessageEditorTemplate)) {</span>
<a href="#l119.1260"></a><span id="l119.1260">         mime_draft_data *mdd = (mime_draft_data *)tSession-&gt;data_object;</span>
<a href="#l119.1261"></a><span id="l119.1261" class="difflineminus">-        if (mdd)</span>
<a href="#l119.1262"></a><span id="l119.1262" class="difflineminus">-          workHeaders = &amp;(mdd-&gt;headers);</span>
<a href="#l119.1263"></a><span id="l119.1263" class="difflineminus">-      }</span>
<a href="#l119.1264"></a><span id="l119.1264" class="difflineminus">-      else</span>
<a href="#l119.1265"></a><span id="l119.1265" class="difflineminus">-      {</span>
<a href="#l119.1266"></a><span id="l119.1266" class="difflineplus">+        if (mdd) workHeaders = &amp;(mdd-&gt;headers);</span>
<a href="#l119.1267"></a><span id="l119.1267" class="difflineplus">+      } else {</span>
<a href="#l119.1268"></a><span id="l119.1268">         mime_stream_data *msd = (mime_stream_data *)tSession-&gt;data_object;</span>
<a href="#l119.1269"></a><span id="l119.1269" class="difflineminus">-        if (msd)</span>
<a href="#l119.1270"></a><span id="l119.1270" class="difflineminus">-          workHeaders = &amp;(msd-&gt;headers);</span>
<a href="#l119.1271"></a><span id="l119.1271" class="difflineplus">+        if (msd) workHeaders = &amp;(msd-&gt;headers);</span>
<a href="#l119.1272"></a><span id="l119.1272">       }</span>
<a href="#l119.1273"></a><span id="l119.1273"> </span>
<a href="#l119.1274"></a><span id="l119.1274" class="difflineminus">-      if (workHeaders)</span>
<a href="#l119.1275"></a><span id="l119.1275" class="difflineminus">-      {</span>
<a href="#l119.1276"></a><span id="l119.1276" class="difflineplus">+      if (workHeaders) {</span>
<a href="#l119.1277"></a><span id="l119.1277">         nsresult rv;</span>
<a href="#l119.1278"></a><span id="l119.1278" class="difflineminus">-        nsCOMPtr&lt;nsIMimeHeaders&gt; mimeHeaders = do_CreateInstance(NS_IMIMEHEADERS_CONTRACTID, &amp;rv);</span>
<a href="#l119.1279"></a><span id="l119.1279" class="difflineplus">+        nsCOMPtr&lt;nsIMimeHeaders&gt; mimeHeaders =</span>
<a href="#l119.1280"></a><span id="l119.1280" class="difflineplus">+            do_CreateInstance(NS_IMIMEHEADERS_CONTRACTID, &amp;rv);</span>
<a href="#l119.1281"></a><span id="l119.1281"> </span>
<a href="#l119.1282"></a><span id="l119.1282" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l119.1283"></a><span id="l119.1283" class="difflineminus">-        {</span>
<a href="#l119.1284"></a><span id="l119.1284" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l119.1285"></a><span id="l119.1285">           if (*workHeaders)</span>
<a href="#l119.1286"></a><span id="l119.1286">             mimeHeaders-&gt;Initialize(Substring((*workHeaders)-&gt;all_headers,</span>
<a href="#l119.1287"></a><span id="l119.1287" class="difflineminus">-              (*workHeaders)-&gt;all_headers_fp));</span>
<a href="#l119.1288"></a><span id="l119.1288" class="difflineplus">+                                              (*workHeaders)-&gt;all_headers_fp));</span>
<a href="#l119.1289"></a><span id="l119.1289">           mMimeStreamConverterListener-&gt;OnHeadersReady(mimeHeaders);</span>
<a href="#l119.1290"></a><span id="l119.1290" class="difflineminus">-        }</span>
<a href="#l119.1291"></a><span id="l119.1291" class="difflineminus">-        else</span>
<a href="#l119.1292"></a><span id="l119.1292" class="difflineplus">+        } else</span>
<a href="#l119.1293"></a><span id="l119.1293">           mMimeStreamConverterListener-&gt;OnHeadersReady(nullptr);</span>
<a href="#l119.1294"></a><span id="l119.1294">       }</span>
<a href="#l119.1295"></a><span id="l119.1295"> </span>
<a href="#l119.1296"></a><span id="l119.1296" class="difflineminus">-      mMimeStreamConverterListener = nullptr; // release our reference</span>
<a href="#l119.1297"></a><span id="l119.1297" class="difflineplus">+      mMimeStreamConverterListener = nullptr;  // release our reference</span>
<a href="#l119.1298"></a><span id="l119.1298">     }</span>
<a href="#l119.1299"></a><span id="l119.1299"> </span>
<a href="#l119.1300"></a><span id="l119.1300">     tSession-&gt;complete((nsMIMESession *)mBridgeStream);</span>
<a href="#l119.1301"></a><span id="l119.1301">   }</span>
<a href="#l119.1302"></a><span id="l119.1302"> </span>
<a href="#l119.1303"></a><span id="l119.1303">   //</span>
<a href="#l119.1304"></a><span id="l119.1304">   // Now complete the emitter and do necessary cleanup!</span>
<a href="#l119.1305"></a><span id="l119.1305">   //</span>
<a href="#l119.1306"></a><span id="l119.1306" class="difflineminus">-  if (mEmitter)</span>
<a href="#l119.1307"></a><span id="l119.1307" class="difflineminus">-  {</span>
<a href="#l119.1308"></a><span id="l119.1308" class="difflineplus">+  if (mEmitter) {</span>
<a href="#l119.1309"></a><span id="l119.1309">     mEmitter-&gt;Complete();</span>
<a href="#l119.1310"></a><span id="l119.1310">   }</span>
<a href="#l119.1311"></a><span id="l119.1311"> </span>
<a href="#l119.1312"></a><span id="l119.1312">   // First close the output stream...</span>
<a href="#l119.1313"></a><span id="l119.1313" class="difflineminus">-  if (mOutputStream)</span>
<a href="#l119.1314"></a><span id="l119.1314" class="difflineminus">-    mOutputStream-&gt;Close();</span>
<a href="#l119.1315"></a><span id="l119.1315" class="difflineplus">+  if (mOutputStream) mOutputStream-&gt;Close();</span>
<a href="#l119.1316"></a><span id="l119.1316"> </span>
<a href="#l119.1317"></a><span id="l119.1317">   // Make sure to do necessary cleanup!</span>
<a href="#l119.1318"></a><span id="l119.1318">   InternalCleanup();</span>
<a href="#l119.1319"></a><span id="l119.1319"> </span>
<a href="#l119.1320"></a><span id="l119.1320"> #if 0</span>
<a href="#l119.1321"></a><span id="l119.1321">   // print out the mime timing information BEFORE we flush to layout</span>
<a href="#l119.1322"></a><span id="l119.1322">   // otherwise we'll be including layout information.</span>
<a href="#l119.1323"></a><span id="l119.1323">   printf(&quot;Time Spent in mime:    %d ms\n&quot;, PR_IntervalToMilliseconds(PR_IntervalNow() - mConvertContentTime));</span>
<a href="#l119.1324"></a><span id="l119.1324"> #endif</span>
<a href="#l119.1325"></a><span id="l119.1325"> </span>
<a href="#l119.1326"></a><span id="l119.1326">   // forward on top request to any listeners</span>
<a href="#l119.1327"></a><span id="l119.1327" class="difflineminus">-  if (mOutListener)</span>
<a href="#l119.1328"></a><span id="l119.1328" class="difflineminus">-    mOutListener-&gt;OnStopRequest(request, status);</span>
<a href="#l119.1329"></a><span id="l119.1329" class="difflineminus">-</span>
<a href="#l119.1330"></a><span id="l119.1330" class="difflineplus">+  if (mOutListener) mOutListener-&gt;OnStopRequest(request, status);</span>
<a href="#l119.1331"></a><span id="l119.1331"> </span>
<a href="#l119.1332"></a><span id="l119.1332">   mAlreadyKnowOutputType = false;</span>
<a href="#l119.1333"></a><span id="l119.1333"> </span>
<a href="#l119.1334"></a><span id="l119.1334">   // since we are done converting data, lets close all the objects we own...</span>
<a href="#l119.1335"></a><span id="l119.1335" class="difflineminus">-  // this helps us fix some circular ref counting problems we are running into...</span>
<a href="#l119.1336"></a><span id="l119.1336" class="difflineplus">+  // this helps us fix some circular ref counting problems we are running</span>
<a href="#l119.1337"></a><span id="l119.1337" class="difflineplus">+  // into...</span>
<a href="#l119.1338"></a><span id="l119.1338">   Close();</span>
<a href="#l119.1339"></a><span id="l119.1339"> </span>
<a href="#l119.1340"></a><span id="l119.1340">   // Time to return...</span>
<a href="#l119.1341"></a><span id="l119.1341">   return NS_OK;</span>
<a href="#l119.1342"></a><span id="l119.1342"> }</span>
<a href="#l119.1343"></a><span id="l119.1343"> </span>
<a href="#l119.1344"></a><span id="l119.1344" class="difflineminus">-nsresult nsStreamConverter::Close()</span>
<a href="#l119.1345"></a><span id="l119.1345" class="difflineminus">-{</span>
<a href="#l119.1346"></a><span id="l119.1346" class="difflineplus">+nsresult nsStreamConverter::Close() {</span>
<a href="#l119.1347"></a><span id="l119.1347">   mOutgoingChannel = nullptr;</span>
<a href="#l119.1348"></a><span id="l119.1348">   mEmitter = nullptr;</span>
<a href="#l119.1349"></a><span id="l119.1349">   mOutListener = nullptr;</span>
<a href="#l119.1350"></a><span id="l119.1350">   return NS_OK;</span>
<a href="#l119.1351"></a><span id="l119.1351"> }</span>
<a href="#l119.1352"></a><span id="l119.1352"> </span>
<a href="#l119.1353"></a><span id="l119.1353"> // nsIStreamConverter implementation</span>
<a href="#l119.1354"></a><span id="l119.1354"> </span>
<a href="#l119.1355"></a><span id="l119.1355"> // No synchronous conversion at this time.</span>
<a href="#l119.1356"></a><span id="l119.1356" class="difflineminus">-NS_IMETHODIMP nsStreamConverter::Convert(nsIInputStream  *aFromStream,</span>
<a href="#l119.1357"></a><span id="l119.1357" class="difflineplus">+NS_IMETHODIMP nsStreamConverter::Convert(nsIInputStream *aFromStream,</span>
<a href="#l119.1358"></a><span id="l119.1358">                                          const char *aFromType,</span>
<a href="#l119.1359"></a><span id="l119.1359">                                          const char *aToType,</span>
<a href="#l119.1360"></a><span id="l119.1360" class="difflineminus">-                                         nsISupports     *aCtxt,</span>
<a href="#l119.1361"></a><span id="l119.1361" class="difflineminus">-                                         nsIInputStream **_retval)</span>
<a href="#l119.1362"></a><span id="l119.1362" class="difflineminus">-{</span>
<a href="#l119.1363"></a><span id="l119.1363" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l119.1364"></a><span id="l119.1364" class="difflineplus">+                                         nsISupports *aCtxt,</span>
<a href="#l119.1365"></a><span id="l119.1365" class="difflineplus">+                                         nsIInputStream **_retval) {</span>
<a href="#l119.1366"></a><span id="l119.1366" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l119.1367"></a><span id="l119.1367"> }</span>
<a href="#l119.1368"></a><span id="l119.1368"> </span>
<a href="#l119.1369"></a><span id="l119.1369" class="difflineminus">-// Stream converter service calls this to initialize the actual stream converter (us).</span>
<a href="#l119.1370"></a><span id="l119.1370" class="difflineminus">-NS_IMETHODIMP nsStreamConverter::AsyncConvertData(const char   *aFromType,</span>
<a href="#l119.1371"></a><span id="l119.1371" class="difflineminus">-                                                  const char   *aToType,</span>
<a href="#l119.1372"></a><span id="l119.1372" class="difflineplus">+// Stream converter service calls this to initialize the actual stream converter</span>
<a href="#l119.1373"></a><span id="l119.1373" class="difflineplus">+// (us).</span>
<a href="#l119.1374"></a><span id="l119.1374" class="difflineplus">+NS_IMETHODIMP nsStreamConverter::AsyncConvertData(const char *aFromType,</span>
<a href="#l119.1375"></a><span id="l119.1375" class="difflineplus">+                                                  const char *aToType,</span>
<a href="#l119.1376"></a><span id="l119.1376">                                                   nsIStreamListener *aListener,</span>
<a href="#l119.1377"></a><span id="l119.1377" class="difflineminus">-                                                  nsISupports       *aCtxt)</span>
<a href="#l119.1378"></a><span id="l119.1378" class="difflineminus">-{</span>
<a href="#l119.1379"></a><span id="l119.1379" class="difflineplus">+                                                  nsISupports *aCtxt) {</span>
<a href="#l119.1380"></a><span id="l119.1380">   nsresult rv = NS_OK;</span>
<a href="#l119.1381"></a><span id="l119.1381">   nsCOMPtr&lt;nsIMsgQuote&gt; aMsgQuote = do_QueryInterface(aCtxt, &amp;rv);</span>
<a href="#l119.1382"></a><span id="l119.1382">   nsCOMPtr&lt;nsIChannel&gt; aChannel;</span>
<a href="#l119.1383"></a><span id="l119.1383"> </span>
<a href="#l119.1384"></a><span id="l119.1384" class="difflineminus">-  if (aMsgQuote)</span>
<a href="#l119.1385"></a><span id="l119.1385" class="difflineminus">-  {</span>
<a href="#l119.1386"></a><span id="l119.1386" class="difflineplus">+  if (aMsgQuote) {</span>
<a href="#l119.1387"></a><span id="l119.1387">     nsCOMPtr&lt;nsIMimeStreamConverterListener&gt; quoteListener;</span>
<a href="#l119.1388"></a><span id="l119.1388">     rv = aMsgQuote-&gt;GetQuoteListener(getter_AddRefs(quoteListener));</span>
<a href="#l119.1389"></a><span id="l119.1389">     if (quoteListener)</span>
<a href="#l119.1390"></a><span id="l119.1390">       SetMimeHeadersListener(quoteListener, nsMimeOutput::nsMimeMessageQuoting);</span>
<a href="#l119.1391"></a><span id="l119.1391">     rv = aMsgQuote-&gt;GetQuoteChannel(getter_AddRefs(aChannel));</span>
<a href="#l119.1392"></a><span id="l119.1392" class="difflineminus">-  }</span>
<a href="#l119.1393"></a><span id="l119.1393" class="difflineminus">-  else</span>
<a href="#l119.1394"></a><span id="l119.1394" class="difflineminus">-  {</span>
<a href="#l119.1395"></a><span id="l119.1395" class="difflineplus">+  } else {</span>
<a href="#l119.1396"></a><span id="l119.1396">     aChannel = do_QueryInterface(aCtxt, &amp;rv);</span>
<a href="#l119.1397"></a><span id="l119.1397">   }</span>
<a href="#l119.1398"></a><span id="l119.1398"> </span>
<a href="#l119.1399"></a><span id="l119.1399">   mFromType = aFromType;</span>
<a href="#l119.1400"></a><span id="l119.1400">   mToType = aToType;</span>
<a href="#l119.1401"></a><span id="l119.1401"> </span>
<a href="#l119.1402"></a><span id="l119.1402" class="difflineminus">-  NS_ASSERTION(aChannel &amp;&amp; NS_SUCCEEDED(rv), &quot;mailnews mime converter has to have the channel passed in...&quot;);</span>
<a href="#l119.1403"></a><span id="l119.1403" class="difflineplus">+  NS_ASSERTION(aChannel &amp;&amp; NS_SUCCEEDED(rv),</span>
<a href="#l119.1404"></a><span id="l119.1404" class="difflineplus">+               &quot;mailnews mime converter has to have the channel passed in...&quot;);</span>
<a href="#l119.1405"></a><span id="l119.1405">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l119.1406"></a><span id="l119.1406"> </span>
<a href="#l119.1407"></a><span id="l119.1407">   nsCOMPtr&lt;nsIURI&gt; aUri;</span>
<a href="#l119.1408"></a><span id="l119.1408">   aChannel-&gt;GetURI(getter_AddRefs(aUri));</span>
<a href="#l119.1409"></a><span id="l119.1409">   return Init(aUri, aListener, aChannel);</span>
<a href="#l119.1410"></a><span id="l119.1410"> }</span>
<a href="#l119.1411"></a><span id="l119.1411"> </span>
<a href="#l119.1412"></a><span id="l119.1412" class="difflineminus">-NS_IMETHODIMP nsStreamConverter::FirePendingStartRequest()</span>
<a href="#l119.1413"></a><span id="l119.1413" class="difflineminus">-{</span>
<a href="#l119.1414"></a><span id="l119.1414" class="difflineminus">-  if (mPendingRequest &amp;&amp; mOutListener)</span>
<a href="#l119.1415"></a><span id="l119.1415" class="difflineminus">-  {</span>
<a href="#l119.1416"></a><span id="l119.1416" class="difflineplus">+NS_IMETHODIMP nsStreamConverter::FirePendingStartRequest() {</span>
<a href="#l119.1417"></a><span id="l119.1417" class="difflineplus">+  if (mPendingRequest &amp;&amp; mOutListener) {</span>
<a href="#l119.1418"></a><span id="l119.1418">     mOutListener-&gt;OnStartRequest(mPendingRequest);</span>
<a href="#l119.1419"></a><span id="l119.1419">     mPendingRequest = nullptr;</span>
<a href="#l119.1420"></a><span id="l119.1420">   }</span>
<a href="#l119.1421"></a><span id="l119.1421">   return NS_OK;</span>
<a href="#l119.1422"></a><span id="l119.1422"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l120.1"></a><span id="l120.1" class="difflineminus">--- a/mailnews/mime/src/nsStreamConverter.h</span>
<a href="#l120.2"></a><span id="l120.2" class="difflineplus">+++ b/mailnews/mime/src/nsStreamConverter.h</span>
<a href="#l120.3"></a><span id="l120.3" class="difflineat">@@ -12,18 +12,19 @@</span>
<a href="#l120.4"></a><span id="l120.4"> #include &quot;nsIAsyncInputStream.h&quot;</span>
<a href="#l120.5"></a><span id="l120.5"> #include &quot;nsIAsyncOutputStream.h&quot;</span>
<a href="#l120.6"></a><span id="l120.6"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l120.7"></a><span id="l120.7"> #include &quot;nsString.h&quot;</span>
<a href="#l120.8"></a><span id="l120.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l120.9"></a><span id="l120.9"> </span>
<a href="#l120.10"></a><span id="l120.10"> #define MIME_FORWARD_HTML_PREFIX &quot;&lt;HTML&gt;&lt;BODY&gt;&lt;BR&gt;&lt;BR&gt;&quot;</span>
<a href="#l120.11"></a><span id="l120.11"> </span>
<a href="#l120.12"></a><span id="l120.12" class="difflineminus">-class nsStreamConverter : public nsIStreamConverter, public nsIMimeStreamConverter {</span>
<a href="#l120.13"></a><span id="l120.13" class="difflineminus">-public:</span>
<a href="#l120.14"></a><span id="l120.14" class="difflineplus">+class nsStreamConverter : public nsIStreamConverter,</span>
<a href="#l120.15"></a><span id="l120.15" class="difflineplus">+                          public nsIMimeStreamConverter {</span>
<a href="#l120.16"></a><span id="l120.16" class="difflineplus">+ public:</span>
<a href="#l120.17"></a><span id="l120.17">   nsStreamConverter();</span>
<a href="#l120.18"></a><span id="l120.18"> </span>
<a href="#l120.19"></a><span id="l120.19">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l120.20"></a><span id="l120.20"> </span>
<a href="#l120.21"></a><span id="l120.21">   // nsIMimeStreamConverter support</span>
<a href="#l120.22"></a><span id="l120.22">   NS_DECL_NSIMIMESTREAMCONVERTER</span>
<a href="#l120.23"></a><span id="l120.23">   // nsIStreamConverter methods</span>
<a href="#l120.24"></a><span id="l120.24">   NS_DECL_NSISTREAMCONVERTER</span>
<a href="#l120.25"></a><span id="l120.25" class="difflineat">@@ -31,57 +32,63 @@ public:</span>
<a href="#l120.26"></a><span id="l120.26">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l120.27"></a><span id="l120.27"> </span>
<a href="#l120.28"></a><span id="l120.28">   // nsIRequestObserver methods</span>
<a href="#l120.29"></a><span id="l120.29">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l120.30"></a><span id="l120.30"> </span>
<a href="#l120.31"></a><span id="l120.31">   ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l120.32"></a><span id="l120.32">   // nsStreamConverter specific methods:</span>
<a href="#l120.33"></a><span id="l120.33">   ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l120.34"></a><span id="l120.34" class="difflineminus">-  NS_IMETHOD Init(nsIURI *aURI, nsIStreamListener * aOutListener, nsIChannel *aChannel);</span>
<a href="#l120.35"></a><span id="l120.35" class="difflineplus">+  NS_IMETHOD Init(nsIURI *aURI, nsIStreamListener *aOutListener,</span>
<a href="#l120.36"></a><span id="l120.36" class="difflineplus">+                  nsIChannel *aChannel);</span>
<a href="#l120.37"></a><span id="l120.37">   NS_IMETHOD GetContentType(char **aOutputContentType);</span>
<a href="#l120.38"></a><span id="l120.38">   NS_IMETHOD InternalCleanup(void);</span>
<a href="#l120.39"></a><span id="l120.39">   NS_IMETHOD DetermineOutputFormat(const char *url, nsMimeOutputType *newType);</span>
<a href="#l120.40"></a><span id="l120.40">   NS_IMETHOD FirePendingStartRequest(void);</span>
<a href="#l120.41"></a><span id="l120.41"> </span>
<a href="#l120.42"></a><span id="l120.42" class="difflineminus">-private:</span>
<a href="#l120.43"></a><span id="l120.43" class="difflineplus">+ private:</span>
<a href="#l120.44"></a><span id="l120.44">   virtual ~nsStreamConverter();</span>
<a href="#l120.45"></a><span id="l120.45">   nsresult Close();</span>
<a href="#l120.46"></a><span id="l120.46"> </span>
<a href="#l120.47"></a><span id="l120.47" class="difflineminus">-  // the input and output streams form a pipe...they need to be passed around together..</span>
<a href="#l120.48"></a><span id="l120.48" class="difflineminus">-  nsCOMPtr&lt;nsIAsyncOutputStream&gt;     mOutputStream;     // output stream</span>
<a href="#l120.49"></a><span id="l120.49" class="difflineminus">-  nsCOMPtr&lt;nsIAsyncInputStream&gt;      mInputStream;</span>
<a href="#l120.50"></a><span id="l120.50" class="difflineplus">+  // the input and output streams form a pipe...they need to be passed around</span>
<a href="#l120.51"></a><span id="l120.51" class="difflineplus">+  // together..</span>
<a href="#l120.52"></a><span id="l120.52" class="difflineplus">+  nsCOMPtr&lt;nsIAsyncOutputStream&gt; mOutputStream;  // output stream</span>
<a href="#l120.53"></a><span id="l120.53" class="difflineplus">+  nsCOMPtr&lt;nsIAsyncInputStream&gt; mInputStream;</span>
<a href="#l120.54"></a><span id="l120.54"> </span>
<a href="#l120.55"></a><span id="l120.55" class="difflineminus">-  nsCOMPtr&lt;nsIStreamListener&gt;   mOutListener;   // output stream listener</span>
<a href="#l120.56"></a><span id="l120.56" class="difflineminus">-  nsCOMPtr&lt;nsIChannel&gt;          mOutgoingChannel;</span>
<a href="#l120.57"></a><span id="l120.57" class="difflineplus">+  nsCOMPtr&lt;nsIStreamListener&gt; mOutListener;  // output stream listener</span>
<a href="#l120.58"></a><span id="l120.58" class="difflineplus">+  nsCOMPtr&lt;nsIChannel&gt; mOutgoingChannel;</span>
<a href="#l120.59"></a><span id="l120.59"> </span>
<a href="#l120.60"></a><span id="l120.60" class="difflineminus">-  nsCOMPtr&lt;nsIMimeEmitter&gt;      mEmitter;         // emitter being used...</span>
<a href="#l120.61"></a><span id="l120.61" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt;              mURI;             // URI being processed</span>
<a href="#l120.62"></a><span id="l120.62" class="difflineminus">-  nsMimeOutputType              mOutputType;      // the output type we should use for the operation</span>
<a href="#l120.63"></a><span id="l120.63" class="difflineminus">-  bool                          mAlreadyKnowOutputType;</span>
<a href="#l120.64"></a><span id="l120.64" class="difflineplus">+  nsCOMPtr&lt;nsIMimeEmitter&gt; mEmitter;  // emitter being used...</span>
<a href="#l120.65"></a><span id="l120.65" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; mURI;              // URI being processed</span>
<a href="#l120.66"></a><span id="l120.66" class="difflineplus">+  nsMimeOutputType</span>
<a href="#l120.67"></a><span id="l120.67" class="difflineplus">+      mOutputType;  // the output type we should use for the operation</span>
<a href="#l120.68"></a><span id="l120.68" class="difflineplus">+  bool mAlreadyKnowOutputType;</span>
<a href="#l120.69"></a><span id="l120.69"> </span>
<a href="#l120.70"></a><span id="l120.70" class="difflineminus">-  void                          *mBridgeStream;   // internal libmime data stream</span>
<a href="#l120.71"></a><span id="l120.71" class="difflineplus">+  void *mBridgeStream;  // internal libmime data stream</span>
<a href="#l120.72"></a><span id="l120.72"> </span>
<a href="#l120.73"></a><span id="l120.73">   // Type of output, entire message, header only, body only</span>
<a href="#l120.74"></a><span id="l120.74" class="difflineminus">-  nsCString                     mOutputFormat;</span>
<a href="#l120.75"></a><span id="l120.75" class="difflineminus">-  nsCString                     mRealContentType; // if we know the content type for real, this will be set (used by attachments)</span>
<a href="#l120.76"></a><span id="l120.76" class="difflineplus">+  nsCString mOutputFormat;</span>
<a href="#l120.77"></a><span id="l120.77" class="difflineplus">+  nsCString mRealContentType;  // if we know the content type for real, this</span>
<a href="#l120.78"></a><span id="l120.78" class="difflineplus">+                               // will be set (used by attachments)</span>
<a href="#l120.79"></a><span id="l120.79"> </span>
<a href="#l120.80"></a><span id="l120.80" class="difflineminus">-  nsCString                     mOverrideFormat;  // this is a possible override for emitter creation</span>
<a href="#l120.81"></a><span id="l120.81" class="difflineminus">-  bool                          mWrapperOutput;   // Should we output the frame split message display</span>
<a href="#l120.82"></a><span id="l120.82" class="difflineplus">+  nsCString</span>
<a href="#l120.83"></a><span id="l120.83" class="difflineplus">+      mOverrideFormat;  // this is a possible override for emitter creation</span>
<a href="#l120.84"></a><span id="l120.84" class="difflineplus">+  bool mWrapperOutput;  // Should we output the frame split message display</span>
<a href="#l120.85"></a><span id="l120.85"> </span>
<a href="#l120.86"></a><span id="l120.86" class="difflineminus">-  nsCOMPtr&lt;nsIMimeStreamConverterListener&gt;  mMimeStreamConverterListener;</span>
<a href="#l120.87"></a><span id="l120.87" class="difflineminus">-  bool                          mForwardInline;</span>
<a href="#l120.88"></a><span id="l120.88" class="difflineminus">-  bool                          mForwardInlineFilter;</span>
<a href="#l120.89"></a><span id="l120.89" class="difflineminus">-  bool                          mOverrideComposeFormat;</span>
<a href="#l120.90"></a><span id="l120.90" class="difflineminus">-  nsString                      mForwardToAddress;</span>
<a href="#l120.91"></a><span id="l120.91" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIdentity&gt;      mIdentity;</span>
<a href="#l120.92"></a><span id="l120.92" class="difflineminus">-  nsCString                     mOriginalMsgURI;</span>
<a href="#l120.93"></a><span id="l120.93" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt;         mOrigMsgHdr;</span>
<a href="#l120.94"></a><span id="l120.94" class="difflineplus">+  nsCOMPtr&lt;nsIMimeStreamConverterListener&gt; mMimeStreamConverterListener;</span>
<a href="#l120.95"></a><span id="l120.95" class="difflineplus">+  bool mForwardInline;</span>
<a href="#l120.96"></a><span id="l120.96" class="difflineplus">+  bool mForwardInlineFilter;</span>
<a href="#l120.97"></a><span id="l120.97" class="difflineplus">+  bool mOverrideComposeFormat;</span>
<a href="#l120.98"></a><span id="l120.98" class="difflineplus">+  nsString mForwardToAddress;</span>
<a href="#l120.99"></a><span id="l120.99" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; mIdentity;</span>
<a href="#l120.100"></a><span id="l120.100" class="difflineplus">+  nsCString mOriginalMsgURI;</span>
<a href="#l120.101"></a><span id="l120.101" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; mOrigMsgHdr;</span>
<a href="#l120.102"></a><span id="l120.102"> </span>
<a href="#l120.103"></a><span id="l120.103" class="difflineminus">-  nsCString                     mFromType;</span>
<a href="#l120.104"></a><span id="l120.104" class="difflineminus">-  nsCString                     mToType;</span>
<a href="#l120.105"></a><span id="l120.105" class="difflineplus">+  nsCString mFromType;</span>
<a href="#l120.106"></a><span id="l120.106" class="difflineplus">+  nsCString mToType;</span>
<a href="#l120.107"></a><span id="l120.107"> #ifdef DEBUG_mscott</span>
<a href="#l120.108"></a><span id="l120.108">   PRTime mConvertContentTime;</span>
<a href="#l120.109"></a><span id="l120.109"> #endif</span>
<a href="#l120.110"></a><span id="l120.110" class="difflineminus">-  nsIRequest *                  mPendingRequest;  // used when we need to delay to fire onStartRequest</span>
<a href="#l120.111"></a><span id="l120.111" class="difflineplus">+  nsIRequest</span>
<a href="#l120.112"></a><span id="l120.112" class="difflineplus">+      *mPendingRequest;  // used when we need to delay to fire onStartRequest</span>
<a href="#l120.113"></a><span id="l120.113"> };</span>
<a href="#l120.114"></a><span id="l120.114"> </span>
<a href="#l120.115"></a><span id="l120.115"> #endif /* nsStreamConverter_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l121.1"></a><span id="l121.1" class="difflineminus">--- a/mailnews/mime/test/TestMimeCrash.cpp</span>
<a href="#l121.2"></a><span id="l121.2" class="difflineplus">+++ b/mailnews/mime/test/TestMimeCrash.cpp</span>
<a href="#l121.3"></a><span id="l121.3" class="difflineat">@@ -5,60 +5,52 @@</span>
<a href="#l121.4"></a><span id="l121.4"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l121.5"></a><span id="l121.5"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l121.6"></a><span id="l121.6"> </span>
<a href="#l121.7"></a><span id="l121.7"> #include &quot;prshma.h&quot;</span>
<a href="#l121.8"></a><span id="l121.8"> #include &quot;prsystem.h&quot;</span>
<a href="#l121.9"></a><span id="l121.9"> </span>
<a href="#l121.10"></a><span id="l121.10"> #include &quot;TestHarness.h&quot;</span>
<a href="#l121.11"></a><span id="l121.11"> </span>
<a href="#l121.12"></a><span id="l121.12" class="difflineminus">-nsresult</span>
<a href="#l121.13"></a><span id="l121.13" class="difflineminus">-mime_encoder_output_fn(const char *buf, int32_t size, void *closure)</span>
<a href="#l121.14"></a><span id="l121.14" class="difflineminus">-{</span>
<a href="#l121.15"></a><span id="l121.15" class="difflineplus">+nsresult mime_encoder_output_fn(const char *buf, int32_t size, void *closure) {</span>
<a href="#l121.16"></a><span id="l121.16">   return NS_OK;</span>
<a href="#l121.17"></a><span id="l121.17"> }</span>
<a href="#l121.18"></a><span id="l121.18"> </span>
<a href="#l121.19"></a><span id="l121.19" class="difflineminus">-nsresult</span>
<a href="#l121.20"></a><span id="l121.20" class="difflineminus">-do_test(const char *aBuffer, const uint32_t aSize)</span>
<a href="#l121.21"></a><span id="l121.21" class="difflineminus">-{</span>
<a href="#l121.22"></a><span id="l121.22" class="difflineplus">+nsresult do_test(const char *aBuffer, const uint32_t aSize) {</span>
<a href="#l121.23"></a><span id="l121.23">   nsresult rv;</span>
<a href="#l121.24"></a><span id="l121.24">   MimeEncoderData *encodeData = nullptr;</span>
<a href="#l121.25"></a><span id="l121.25">   int32_t written = 0;</span>
<a href="#l121.26"></a><span id="l121.26"> </span>
<a href="#l121.27"></a><span id="l121.27">   nsCOMPtr&lt;nsIMimeConverter&gt; converter =</span>
<a href="#l121.28"></a><span id="l121.28" class="difflineminus">-    do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l121.29"></a><span id="l121.29" class="difflineplus">+      do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l121.30"></a><span id="l121.30">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l121.31"></a><span id="l121.31"> </span>
<a href="#l121.32"></a><span id="l121.32">   rv = converter-&gt;QPEncoderInit(mime_encoder_output_fn, nullptr, &amp;encodeData);</span>
<a href="#l121.33"></a><span id="l121.33">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l121.34"></a><span id="l121.34"> </span>
<a href="#l121.35"></a><span id="l121.35">   rv = converter-&gt;EncoderWrite(encodeData, aBuffer, aSize, &amp;written);</span>
<a href="#l121.36"></a><span id="l121.36">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l121.37"></a><span id="l121.37"> </span>
<a href="#l121.38"></a><span id="l121.38">   rv = converter-&gt;EncoderDestroy(encodeData, false);</span>
<a href="#l121.39"></a><span id="l121.39">   return rv;</span>
<a href="#l121.40"></a><span id="l121.40"> }</span>
<a href="#l121.41"></a><span id="l121.41"> </span>
<a href="#l121.42"></a><span id="l121.42" class="difflineminus">-int main(int argc, char **argv)</span>
<a href="#l121.43"></a><span id="l121.43" class="difflineminus">-{</span>
<a href="#l121.44"></a><span id="l121.44" class="difflineplus">+int main(int argc, char **argv) {</span>
<a href="#l121.45"></a><span id="l121.45">   ScopedXPCOM xpcom(&quot;TestMimeCrash&quot;);</span>
<a href="#l121.46"></a><span id="l121.46" class="difflineminus">-  if (xpcom.failed())</span>
<a href="#l121.47"></a><span id="l121.47" class="difflineminus">-    return 1;</span>
<a href="#l121.48"></a><span id="l121.48" class="difflineplus">+  if (xpcom.failed()) return 1;</span>
<a href="#l121.49"></a><span id="l121.49"> </span>
<a href="#l121.50"></a><span id="l121.50">   // We cannot use malloc() since this crashes depends on memory allocation.</span>
<a href="#l121.51"></a><span id="l121.51">   // By using mmap()/PR_MemMap(), end of buffer that is last in the page</span>
<a href="#l121.52"></a><span id="l121.52">   // sets LF.</span>
<a href="#l121.53"></a><span id="l121.53"> </span>
<a href="#l121.54"></a><span id="l121.54">   uint32_t bufsize = PR_GetPageSize();</span>
<a href="#l121.55"></a><span id="l121.55">   PRFileMap *fm = PR_OpenAnonFileMap(&quot;.&quot;, bufsize, PR_PROT_READWRITE);</span>
<a href="#l121.56"></a><span id="l121.56" class="difflineminus">-  if (!fm)</span>
<a href="#l121.57"></a><span id="l121.57" class="difflineminus">-    return 1;</span>
<a href="#l121.58"></a><span id="l121.58" class="difflineminus">-  char *addr = (char *) PR_MemMap(fm, 0, bufsize);</span>
<a href="#l121.59"></a><span id="l121.59" class="difflineminus">-  if (!addr)</span>
<a href="#l121.60"></a><span id="l121.60" class="difflineminus">-    return 1;</span>
<a href="#l121.61"></a><span id="l121.61" class="difflineplus">+  if (!fm) return 1;</span>
<a href="#l121.62"></a><span id="l121.62" class="difflineplus">+  char *addr = (char *)PR_MemMap(fm, 0, bufsize);</span>
<a href="#l121.63"></a><span id="l121.63" class="difflineplus">+  if (!addr) return 1;</span>
<a href="#l121.64"></a><span id="l121.64">   memset(addr, '\r', bufsize);</span>
<a href="#l121.65"></a><span id="l121.65"> </span>
<a href="#l121.66"></a><span id="l121.66">   nsresult rv = do_test(addr, bufsize);</span>
<a href="#l121.67"></a><span id="l121.67"> </span>
<a href="#l121.68"></a><span id="l121.68">   PR_MemUnmap(addr, bufsize);</span>
<a href="#l121.69"></a><span id="l121.69">   PR_CloseFileMap(fm);</span>
<a href="#l121.70"></a><span id="l121.70"> </span>
<a href="#l121.71"></a><span id="l121.71">   if (NS_FAILED(rv)) {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

