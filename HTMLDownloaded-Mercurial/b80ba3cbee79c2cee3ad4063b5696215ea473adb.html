<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 4731:b80ba3cbee79c2cee3ad4063b5696215ea473adb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b80ba3cbee79c2cee3ad4063b5696215ea473adb" />
<meta property="og:url" content="/comm-central/rev/b80ba3cbee79c2cee3ad4063b5696215ea473adb" />
<meta property="og:description" content="add forward inline filter action, r=rkent, sr=standard8, bug 312025" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b80ba3cbee79c2cee3ad4063b5696215ea473adb 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b80ba3cbee79c2cee3ad4063b5696215ea473adb">shortlog</a> |
<a href="/comm-central/log/b80ba3cbee79c2cee3ad4063b5696215ea473adb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b80ba3cbee79c2cee3ad4063b5696215ea473adb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b80ba3cbee79c2cee3ad4063b5696215ea473adb">files</a> |
changeset |
<a href="/comm-central/raw-rev/b80ba3cbee79c2cee3ad4063b5696215ea473adb">raw</a>  | <a href="/comm-central/archive/b80ba3cbee79c2cee3ad4063b5696215ea473adb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
add forward inline filter action, r=rkent, sr=standard8, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=312025">bug 312025</a>
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 20 Jan 2010 14:15:44 -0800</td></tr>

<tr>
 <td>changeset 4731</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b80ba3cbee79c2cee3ad4063b5696215ea473adb">b80ba3cbee79c2cee3ad4063b5696215ea473adb</a></td>
</tr>



<tr>
<td>parent 4730</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d48a8dbd8fcc8c4a0a6b59634bdbb56262242cd4">d48a8dbd8fcc8c4a0a6b59634bdbb56262242cd4</a>
</td>
</tr>

<tr>
<td>child 4732</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/28ce2a63f2077aa0e056561cd71ae516e9cf0af4">28ce2a63f2077aa0e056561cd71ae516e9cf0af4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b80ba3cbee79c2cee3ad4063b5696215ea473adb">3701</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 20 Jan 2010 22:17:27 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b80ba3cbee79 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b80ba3cbee79c2cee3ad4063b5696215ea473adb">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b80ba3cbee79c2cee3ad4063b5696215ea473adb&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b80ba3cbee79c2cee3ad4063b5696215ea473adb&newProject=comm-central&newRevision=b80ba3cbee79c2cee3ad4063b5696215ea473adb&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b80ba3cbee79c2cee3ad4063b5696215ea473adb&newProject=comm-central&newRevision=b80ba3cbee79c2cee3ad4063b5696215ea473adb&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b80ba3cbee79c2cee3ad4063b5696215ea473adb&newProject=comm-central&newRevision=b80ba3cbee79c2cee3ad4063b5696215ea473adb&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28rkent%29&revcount=50">rkent</a>, <a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a>, <a href="/comm-central/log?rev=reviewer%28bug%29&revcount=50">bug</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=312025">312025</a></td></tr>




</table></div>

<div class="page_body description">add forward inline filter action, r=rkent, sr=standard8, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=312025">bug 312025</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/base/search/src/nsMsgFilterService.cpp">mailnews/base/search/src/nsMsgFilterService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/base/search/src/nsMsgFilterService.cpp">file</a> |
<a href="/comm-central/annotate/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/base/search/src/nsMsgFilterService.cpp">annotate</a> |
<a href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/base/search/src/nsMsgFilterService.cpp">diff</a> |
<a href="/comm-central/comparison/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/base/search/src/nsMsgFilterService.cpp">comparison</a> |
<a href="/comm-central/log/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/base/search/src/nsMsgFilterService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/public/nsIMsgComposeService.idl">mailnews/compose/public/nsIMsgComposeService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/public/nsIMsgComposeService.idl">file</a> |
<a href="/comm-central/annotate/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/public/nsIMsgComposeService.idl">annotate</a> |
<a href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/public/nsIMsgComposeService.idl">diff</a> |
<a href="/comm-central/comparison/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/public/nsIMsgComposeService.idl">comparison</a> |
<a href="/comm-central/log/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/public/nsIMsgComposeService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/src/nsMsgComposeService.cpp">mailnews/compose/src/nsMsgComposeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/src/nsMsgComposeService.cpp">file</a> |
<a href="/comm-central/annotate/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/src/nsMsgComposeService.cpp">annotate</a> |
<a href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/src/nsMsgComposeService.cpp">diff</a> |
<a href="/comm-central/comparison/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/src/nsMsgComposeService.cpp">comparison</a> |
<a href="/comm-central/log/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/src/nsMsgComposeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/src/nsMsgComposeService.h">mailnews/compose/src/nsMsgComposeService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/src/nsMsgComposeService.h">file</a> |
<a href="/comm-central/annotate/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/src/nsMsgComposeService.h">annotate</a> |
<a href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/src/nsMsgComposeService.h">diff</a> |
<a href="/comm-central/comparison/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/src/nsMsgComposeService.h">comparison</a> |
<a href="/comm-central/log/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/compose/src/nsMsgComposeService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/public/nsIMimeStreamConverter.idl">mailnews/mime/public/nsIMimeStreamConverter.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/public/nsIMimeStreamConverter.idl">file</a> |
<a href="/comm-central/annotate/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/public/nsIMimeStreamConverter.idl">annotate</a> |
<a href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/public/nsIMimeStreamConverter.idl">diff</a> |
<a href="/comm-central/comparison/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/public/nsIMimeStreamConverter.idl">comparison</a> |
<a href="/comm-central/log/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/public/nsIMimeStreamConverter.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/mimedrft.cpp">mailnews/mime/src/mimedrft.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/mimedrft.cpp">file</a> |
<a href="/comm-central/annotate/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/mimedrft.cpp">annotate</a> |
<a href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/mimedrft.cpp">diff</a> |
<a href="/comm-central/comparison/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/mimedrft.cpp">comparison</a> |
<a href="/comm-central/log/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/mimedrft.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/mimemoz2.h">mailnews/mime/src/mimemoz2.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/mimemoz2.h">file</a> |
<a href="/comm-central/annotate/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/mimemoz2.h">annotate</a> |
<a href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/mimemoz2.h">diff</a> |
<a href="/comm-central/comparison/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/mimemoz2.h">comparison</a> |
<a href="/comm-central/log/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/mimemoz2.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/nsStreamConverter.cpp">mailnews/mime/src/nsStreamConverter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/nsStreamConverter.cpp">file</a> |
<a href="/comm-central/annotate/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/nsStreamConverter.cpp">annotate</a> |
<a href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/nsStreamConverter.cpp">diff</a> |
<a href="/comm-central/comparison/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/nsStreamConverter.cpp">comparison</a> |
<a href="/comm-central/log/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/nsStreamConverter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/nsStreamConverter.h">mailnews/mime/src/nsStreamConverter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/nsStreamConverter.h">file</a> |
<a href="/comm-central/annotate/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/nsStreamConverter.h">annotate</a> |
<a href="/comm-central/diff/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/nsStreamConverter.h">diff</a> |
<a href="/comm-central/comparison/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/nsStreamConverter.h">comparison</a> |
<a href="/comm-central/log/b80ba3cbee79c2cee3ad4063b5696215ea473adb/mailnews/mime/src/nsStreamConverter.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -664,33 +664,32 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l1.4"></a><span id="l1.4">         junkScoreStr.AppendInt(junkScore);</span>
<a href="#l1.5"></a><span id="l1.5">         m_curFolder-&gt;SetJunkScoreForMessages(m_searchHitHdrs, junkScoreStr);</span>
<a href="#l1.6"></a><span id="l1.6">         break;</span>
<a href="#l1.7"></a><span id="l1.7">       }</span>
<a href="#l1.8"></a><span id="l1.8">       case nsMsgFilterAction::Forward:</span>
<a href="#l1.9"></a><span id="l1.9">         {</span>
<a href="#l1.10"></a><span id="l1.10">           nsCString forwardTo;</span>
<a href="#l1.11"></a><span id="l1.11">           filterAction-&gt;GetStrValue(forwardTo);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-          nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+          nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.14"></a><span id="l1.14">           rv = m_curFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.15"></a><span id="l1.15">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.16"></a><span id="l1.16">           if (!forwardTo.IsEmpty())</span>
<a href="#l1.17"></a><span id="l1.17">           {</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-            nsCOMPtr &lt;nsIMsgComposeService&gt; compService = do_GetService (NS_MSGCOMPOSESERVICE_CONTRACTID) ;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-            if (compService)</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+            nsCOMPtr&lt;nsIMsgComposeService&gt; compService = </span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+              do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+            for (PRUint32 msgIndex = 0; msgIndex &lt; m_searchHits.Length(); msgIndex++)</span>
<a href="#l1.24"></a><span id="l1.24">             {</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-              for (PRUint32 msgIndex = 0; msgIndex &lt; m_searchHits.Length(); msgIndex++)</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-              {</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-                nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-                m_searchHitHdrs-&gt;QueryElementAt(msgIndex, NS_GET_IID(nsIMsgDBHdr), getter_AddRefs(msgHdr));</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-                if (msgHdr)</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-                {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-                  rv = compService-&gt;ForwardMessage(NS_ConvertASCIItoUTF16(forwardTo), msgHdr, m_msgWindow, server);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-                }</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-              }</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+              nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(do_QueryElementAt(m_searchHitHdrs,</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+                                           msgIndex));</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+              if (msgHdr)</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+                rv = compService-&gt;ForwardMessage(NS_ConvertASCIItoUTF16(forwardTo),</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+                                                 msgHdr, m_msgWindow, server,</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+                                                 nsIMsgComposeService::kForwardAsDefault);</span>
<a href="#l1.40"></a><span id="l1.40">             }</span>
<a href="#l1.41"></a><span id="l1.41">           }</span>
<a href="#l1.42"></a><span id="l1.42">         }</span>
<a href="#l1.43"></a><span id="l1.43">         break;</span>
<a href="#l1.44"></a><span id="l1.44">       case nsMsgFilterAction::Reply:</span>
<a href="#l1.45"></a><span id="l1.45">         {</span>
<a href="#l1.46"></a><span id="l1.46">           nsCString replyTemplateUri;</span>
<a href="#l1.47"></a><span id="l1.47">           filterAction-&gt;GetStrValue(replyTemplateUri);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgComposeService.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgComposeService.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -42,17 +42,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> interface nsIURI;</span>
<a href="#l2.6"></a><span id="l2.6"> interface nsIDOMWindowInternal;</span>
<a href="#l2.7"></a><span id="l2.7"> interface nsIMsgWindow;</span>
<a href="#l2.8"></a><span id="l2.8"> interface nsIMsgIdentity;</span>
<a href="#l2.9"></a><span id="l2.9"> interface nsIMsgIncomingServer;</span>
<a href="#l2.10"></a><span id="l2.10"> interface nsIMsgDBHdr;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable, uuid(ce5f77c8-f278-4ec7-b8dd-ea9dc84af137)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[scriptable, uuid(dbf4b3a7-dc38-4362-a620-ff5d22b3777c)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface nsIMsgComposeService : nsISupports {</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   /* we need a msg window because when we forward inline we may need progress */</span>
<a href="#l2.17"></a><span id="l2.17">   void OpenComposeWindow(in string msgComposeWindowURL,</span>
<a href="#l2.18"></a><span id="l2.18">                          in nsIMsgDBHdr msgHdr,</span>
<a href="#l2.19"></a><span id="l2.19">                          in string originalMsgURI,</span>
<a href="#l2.20"></a><span id="l2.20">                          in MSG_ComposeType type, </span>
<a href="#l2.21"></a><span id="l2.21">                          in MSG_ComposeFormat format,</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -92,24 +92,38 @@ interface nsIMsgComposeService : nsISupp</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24">   /** </span>
<a href="#l2.25"></a><span id="l2.25">    * given a mailto url, parse the attributes and turn them into a nsIMsgComposeParams object</span>
<a href="#l2.26"></a><span id="l2.26">    * @return nsIMsgComposeParams which corresponds to the passed in mailto url</span>
<a href="#l2.27"></a><span id="l2.27">    */</span>
<a href="#l2.28"></a><span id="l2.28">   nsIMsgComposeParams getParamsForMailto(in nsIURI aURI); </span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">   /**</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+   * @{</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+   * These constants control how to forward messages in forwardMessage.</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+   * kForwardAsDefault uses value of pref &quot;mail.forward_message_mode&quot;.</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+   */</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  const unsigned long kForwardAsDefault = 0;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  const unsigned long kForwardAsAttachment = 1;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  const unsigned long kForwardInline = 2;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  /** @} */</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+  /**</span>
<a href="#l2.41"></a><span id="l2.41">    * Allow filters to automatically forward a message to the given address(es).</span>
<a href="#l2.42"></a><span id="l2.42">    * @param forwardTo the address(es) to forward to</span>
<a href="#l2.43"></a><span id="l2.43">    * @param msgHdr the header of the message being replied to</span>
<a href="#l2.44"></a><span id="l2.44">    * @param msgWindow message window to use</span>
<a href="#l2.45"></a><span id="l2.45">    * @param server server to use for determining which account to send from</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+   * @param aForwardType - How to forward the message one of 3 values:</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+   *                       kForwardAsDefault, kForwardInline, or</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+   *                       kForwardAsAttachment.</span>
<a href="#l2.49"></a><span id="l2.49">    */</span>
<a href="#l2.50"></a><span id="l2.50">   void forwardMessage(in AString forwardTo, in nsIMsgDBHdr msgHdr,</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-                      in nsIMsgWindow msgWindow, in nsIMsgIncomingServer server);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+                      in nsIMsgWindow msgWindow, in nsIMsgIncomingServer server,</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+                      in unsigned long aForwardType);</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55">   /**</span>
<a href="#l2.56"></a><span id="l2.56">    * Allow filters to automatically reply to a message. The reply message is</span>
<a href="#l2.57"></a><span id="l2.57">    * based on the given template.</span>
<a href="#l2.58"></a><span id="l2.58">    * @param msgHdr the header of the message being replied to</span>
<a href="#l2.59"></a><span id="l2.59">    * @param templateUri uri of the template to base ther reply on</span>
<a href="#l2.60"></a><span id="l2.60">    * @param msgWindow message window to use</span>
<a href="#l2.61"></a><span id="l2.61">    * @param server server to use for determining which account to send from</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -563,17 +563,18 @@ nsMsgComposeService::OpenComposeWindow(c</span>
<a href="#l3.4"></a><span id="l3.4">     nsCAutoString uriToOpen(originalMsgURI);</span>
<a href="#l3.5"></a><span id="l3.5">     uriToOpen += (uriToOpen.FindChar('?') == kNotFound) ? &quot;?&quot; : &quot;&amp;&quot;;</span>
<a href="#l3.6"></a><span id="l3.6">     uriToOpen.Append(&quot;fetchCompleteMessage=true&quot;);</span>
<a href="#l3.7"></a><span id="l3.7">     if (type == nsIMsgCompType::Redirect)</span>
<a href="#l3.8"></a><span id="l3.8">       uriToOpen.Append(&quot;&amp;redirect=true&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10">     return LoadDraftOrTemplate(uriToOpen, type == nsIMsgCompType::ForwardInline || type == nsIMsgCompType::Draft ?</span>
<a href="#l3.11"></a><span id="l3.11">                                nsMimeOutput::nsMimeMessageDraftOrTemplate : nsMimeOutput::nsMimeMessageEditorTemplate,</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-                               identity, originalMsgURI, origMsgHdr, type == nsIMsgCompType::ForwardInline, format, aMsgWindow);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+                               identity, originalMsgURI, origMsgHdr, type == nsIMsgCompType::ForwardInline,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+                               format == nsIMsgCompFormat::OppositeOfDefault, aMsgWindow);</span>
<a href="#l3.15"></a><span id="l3.15">   }</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17">   nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams (do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l3.18"></a><span id="l3.18">   if (NS_SUCCEEDED(rv) &amp;&amp; pMsgComposeParams)</span>
<a href="#l3.19"></a><span id="l3.19">   {</span>
<a href="#l3.20"></a><span id="l3.20">     nsCOMPtr&lt;nsIMsgCompFields&gt; pMsgCompFields (do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv));</span>
<a href="#l3.21"></a><span id="l3.21">     if (NS_SUCCEEDED(rv) &amp;&amp; pMsgCompFields)</span>
<a href="#l3.22"></a><span id="l3.22">     {</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineat">@@ -1207,66 +1208,83 @@ NS_IMETHODIMP nsMsgComposeService::Reply</span>
<a href="#l3.24"></a><span id="l3.24">   if (!folder)</span>
<a href="#l3.25"></a><span id="l3.25">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">   // We're sending a new message. Conceptually it's a reply though, so mark the</span>
<a href="#l3.28"></a><span id="l3.28">   // original message as replied.</span>
<a href="#l3.29"></a><span id="l3.29">   return folder-&gt;AddMessageDispositionState(aMsgHdr, nsIMsgFolder::nsMsgDispositionState_Replied);</span>
<a href="#l3.30"></a><span id="l3.30"> }</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-NS_IMETHODIMP nsMsgComposeService::ForwardMessage(const nsAString &amp;forwardTo, nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-                                             nsIMsgWindow *aMsgWindow, nsIMsgIncomingServer *aServer)</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+nsMsgComposeService::ForwardMessage(const nsAString &amp;forwardTo,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+                                    nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+                                    nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+                                    nsIMsgIncomingServer *aServer,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+                                    PRUint32 aForwardType)</span>
<a href="#l3.40"></a><span id="l3.40"> {</span>
<a href="#l3.41"></a><span id="l3.41">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l3.42"></a><span id="l3.42"> </span>
<a href="#l3.43"></a><span id="l3.43">   nsresult rv;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  if (aForwardType == nsIMsgComposeService::kForwardAsDefault)</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+  {</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    PRInt32 forwardPref = 0;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+    prefBranch-&gt;GetIntPref(&quot;mail.forward_message_mode&quot;, &amp;forwardPref);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+    // 0=default as attachment 2=forward as inline with attachments,</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    // (obsolete 4.x value)1=forward as quoted (mapped to 2 in mozilla)</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    aForwardType = forwardPref == 0 ? nsIMsgComposeService::kForwardAsAttachment :</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+                                      nsIMsgComposeService::kForwardInline;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+  }</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  nsCString msgUri;</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+  aMsgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  if (!folder)</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  folder-&gt;GetUriForMsg(aMsgHdr, msgUri);</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+  // get the MsgIdentity for the above key using AccountManager</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = </span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+    do_GetService (NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  rv = accountManager-&gt;FindAccountForServer(aServer, getter_AddRefs(account));</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  rv = account-&gt;GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+  if (aForwardType == nsIMsgComposeService::kForwardInline)</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+    return RunMessageThroughMimeDraft(msgUri,</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+                                      nsMimeOutput::nsMimeMessageDraftOrTemplate,</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+                                      identity,</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+                                      msgUri.get(), aMsgHdr,</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+                                      PR_TRUE, forwardTo,</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+                                      PR_FALSE, aMsgWindow);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+</span>
<a href="#l3.84"></a><span id="l3.84">   nsCOMPtr&lt;nsIDOMWindowInternal&gt; parentWindow;</span>
<a href="#l3.85"></a><span id="l3.85">   if (aMsgWindow)</span>
<a href="#l3.86"></a><span id="l3.86">   {</span>
<a href="#l3.87"></a><span id="l3.87">     nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l3.88"></a><span id="l3.88">     rv = aMsgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l3.89"></a><span id="l3.89">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.90"></a><span id="l3.90">     parentWindow = do_GetInterface(docShell);</span>
<a href="#l3.91"></a><span id="l3.91">     NS_ENSURE_TRUE(parentWindow, NS_ERROR_FAILURE);</span>
<a href="#l3.92"></a><span id="l3.92">   }</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-  if ( NS_FAILED(rv) ) return rv ;</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-  // get the MsgIdentity for the above key using AccountManager</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager = do_GetService (NS_MSGACCOUNTMANAGER_CONTRACTID) ;</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-  if (NS_FAILED(rv) || (!accountManager) ) return rv ;</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccount&gt; account;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-  rv = accountManager-&gt;FindAccountForServer(aServer, getter_AddRefs(account));</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-  account-&gt;GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-</span>
<a href="#l3.106"></a><span id="l3.106">   // create the compose params object</span>
<a href="#l3.107"></a><span id="l3.107">   nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams (do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-  if (NS_FAILED(rv) || (!pMsgComposeParams) ) return rv ;</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompFields&gt; compFields = do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv) ;</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompFields&gt; compFields = do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l3.112"></a><span id="l3.112"> </span>
<a href="#l3.113"></a><span id="l3.113">   compFields-&gt;SetTo(forwardTo);</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-  nsCString msgUri;</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-  PRInt32 forwardType = 0;</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-  if (prefBranch)</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-    prefBranch-&gt;GetIntPref(&quot;mail.forward_message_mode&quot;, &amp;forwardType);</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-  aMsgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-  if (!folder)</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-  folder-&gt;GetUriForMsg(aMsgHdr, msgUri);</span>
<a href="#l3.126"></a><span id="l3.126">   // populate the compose params</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-  // right now, forward inline won't work, since that requires opening a compose window,</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-  // and would require major whackage of the compose code.</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-  pMsgComposeParams-&gt;SetType(/* forwardType ? nsIMsgCompType::ForwardInline : */nsIMsgCompType::ForwardAsAttachment);</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+  pMsgComposeParams-&gt;SetType(nsIMsgCompType::ForwardAsAttachment);</span>
<a href="#l3.131"></a><span id="l3.131">   pMsgComposeParams-&gt;SetFormat(nsIMsgCompFormat::Default);</span>
<a href="#l3.132"></a><span id="l3.132">   pMsgComposeParams-&gt;SetIdentity(identity);</span>
<a href="#l3.133"></a><span id="l3.133">   pMsgComposeParams-&gt;SetComposeFields(compFields);</span>
<a href="#l3.134"></a><span id="l3.134">   pMsgComposeParams-&gt;SetOriginalMsgURI(msgUri.get());</span>
<a href="#l3.135"></a><span id="l3.135">   // create the nsIMsgCompose object to send the object</span>
<a href="#l3.136"></a><span id="l3.136">   nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose (do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l3.137"></a><span id="l3.137">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.138"></a><span id="l3.138"> </span>
<a href="#l3.139"></a><span id="l3.139" class="difflineat">@@ -1512,33 +1530,76 @@ nsMsgComposeService::GetMsgComposeForWin</span>
<a href="#l3.140"></a><span id="l3.140">  * LoadDraftOrTemplate</span>
<a href="#l3.141"></a><span id="l3.141">  *   Helper routine used to run msgURI through libmime in order to fetch the contents for a</span>
<a href="#l3.142"></a><span id="l3.142">  *   draft or template.</span>
<a href="#l3.143"></a><span id="l3.143">  */</span>
<a href="#l3.144"></a><span id="l3.144"> nsresult</span>
<a href="#l3.145"></a><span id="l3.145"> nsMsgComposeService::LoadDraftOrTemplate(const nsACString&amp; aMsgURI, nsMimeOutputType aOutType,</span>
<a href="#l3.146"></a><span id="l3.146">                                          nsIMsgIdentity * aIdentity, const char * aOriginalMsgURI,</span>
<a href="#l3.147"></a><span id="l3.147">                                          nsIMsgDBHdr * aOrigMsgHdr,</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-                                         PRBool aAddInlineHeaders,</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-                                         MSG_ComposeFormat format,</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+                                         PRBool aForwardInline,</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+                                         PRBool overrideComposeFormat,</span>
<a href="#l3.152"></a><span id="l3.152">                                          nsIMsgWindow *aMsgWindow)</span>
<a href="#l3.153"></a><span id="l3.153"> {</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-  nsresult rv;</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+  return RunMessageThroughMimeDraft(aMsgURI, aOutType, aIdentity,</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+                                    aOriginalMsgURI, aOrigMsgHdr,</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+                                    aForwardInline, EmptyString(),</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+                                    overrideComposeFormat, aMsgWindow);</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+}</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+/**</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+ * Run the aMsgURI message through libmime. We set various attributes of the </span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+ * nsIMimeStreamConverter so mimedrft.cpp will know what to do with the message</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+ * when its done streaming. Usually that will be opening a compose window</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+ * with the contents of the message, but if forwardTo is non-empty, mimedrft.cpp</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+ * will forward the contents directly.</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+ *</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+ * @param aMsgURI URI to stream, which is the msgUri + any extra terms, e.g.,</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+ *                &quot;redirect=true&quot;.</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+ * @param aOutType  nsMimeOutput::nsMimeMessageDraftOrTemplate or</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+ *                  nsMimeOutput::nsMimeMessageEditorTemplate</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+ * @param aIdentity identity to use for the new message</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+ * @param aOriginalMsgURI msgURI w/o any extra terms</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+ * @param aOrigMsgHdr nsIMsgDBHdr corresponding to aOriginalMsgURI</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+ * @param aForwardInline true if doing a forward inline</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+ * @param aForwardTo  e-mail address to forward msg to. This is used for</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+ *                     forward inline message filter actions.</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+ * @param aOverrideComposeFormat True if the user had shift key down when</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+                                 doing a command that opens the compose window,</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+ *                               which means we switch the compose window used</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+ *                               from the default.</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+ * @param aMsgWindow msgWindow to pass into DisplayMessage.</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+ */</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+nsresult</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+nsMsgComposeService::RunMessageThroughMimeDraft(</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+            const nsACString&amp; aMsgURI, nsMimeOutputType aOutType,</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+            nsIMsgIdentity * aIdentity, const char * aOriginalMsgURI,</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+            nsIMsgDBHdr * aOrigMsgHdr,</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+            PRBool aForwardInline,</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+            const nsAString &amp;aForwardTo,</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+            PRBool aOverrideComposeFormat,</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+            nsIMsgWindow *aMsgWindow)</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+{</span>
<a href="#l3.194"></a><span id="l3.194">   nsCOMPtr &lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-  rv = GetMessageServiceFromURI(aMsgURI, getter_AddRefs(messageService));</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+  nsresult rv = GetMessageServiceFromURI(aMsgURI, getter_AddRefs(messageService));</span>
<a href="#l3.197"></a><span id="l3.197">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.198"></a><span id="l3.198"> </span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-  // Now, we can create a mime parser (nsIStreamConverter)!</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+  // Create a mime parser (nsIMimeStreamConverter)to do the conversion.</span>
<a href="#l3.201"></a><span id="l3.201">   nsCOMPtr&lt;nsIMimeStreamConverter&gt; mimeConverter =</span>
<a href="#l3.202"></a><span id="l3.202">     do_CreateInstance(NS_MAILNEWS_MIME_STREAM_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l3.203"></a><span id="l3.203">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.204"></a><span id="l3.204"> </span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-  mimeConverter-&gt;SetMimeOutputType(aOutType);  // Set the type of output for libmime</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-  mimeConverter-&gt;SetForwardInline(aAddInlineHeaders);</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-  mimeConverter-&gt;SetOverrideComposeFormat(format == nsIMsgCompFormat::OppositeOfDefault);</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+  mimeConverter-&gt;SetMimeOutputType(aOutType); // Set the type of output for libmime</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+  mimeConverter-&gt;SetForwardInline(aForwardInline);</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+  if (!aForwardTo.IsEmpty())</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+  {</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+    mimeConverter-&gt;SetForwardInlineFilter(PR_TRUE);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+    mimeConverter-&gt;SetForwardToAddress(aForwardTo);</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+  }</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+  mimeConverter-&gt;SetOverrideComposeFormat(aOverrideComposeFormat);</span>
<a href="#l3.216"></a><span id="l3.216">   mimeConverter-&gt;SetIdentity(aIdentity);</span>
<a href="#l3.217"></a><span id="l3.217">   mimeConverter-&gt;SetOriginalMsgURI(aOriginalMsgURI);</span>
<a href="#l3.218"></a><span id="l3.218">   mimeConverter-&gt;SetOrigMsgHdr(aOrigMsgHdr);</span>
<a href="#l3.219"></a><span id="l3.219"> </span>
<a href="#l3.220"></a><span id="l3.220">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l3.221"></a><span id="l3.221">   PRBool fileUrl = StringBeginsWith(aMsgURI, NS_LITERAL_CSTRING(&quot;file:&quot;));</span>
<a href="#l3.222"></a><span id="l3.222">   if (fileUrl || nsDependentCString(aMsgURI).Find(&quot;&amp;type=application/x-message-display&quot;) &gt;= 0)</span>
<a href="#l3.223"></a><span id="l3.223">     rv = NS_NewURI(getter_AddRefs(url), aMsgURI);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -95,20 +95,30 @@ private:</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">   PRInt32 mMaxRecycledWindows;</span>
<a href="#l4.6"></a><span id="l4.6">   nsMsgCachedWindowInfo *mCachedWindows;</span>
<a href="#l4.7"></a><span id="l4.7">   </span>
<a href="#l4.8"></a><span id="l4.8">   void CloseHiddenCachedWindow(nsIDOMWindowInternal *domWindow);</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">   nsresult LoadDraftOrTemplate(const nsACString&amp; aMsgURI, nsMimeOutputType aOutType, </span>
<a href="#l4.11"></a><span id="l4.11">                                nsIMsgIdentity * aIdentity, const char * aOriginalMsgURI, </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-                               nsIMsgDBHdr * aOrigMsgHdr, PRBool aAddInlineHeaders,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+                               nsIMsgDBHdr * aOrigMsgHdr, PRBool aForwardInline,</span>
<a href="#l4.14"></a><span id="l4.14">                                MSG_ComposeFormat format,</span>
<a href="#l4.15"></a><span id="l4.15">                                nsIMsgWindow *aMsgWindow);</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  nsresult RunMessageThroughMimeDraft(const nsACString&amp; aMsgURI,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+                                      nsMimeOutputType aOutType,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+                                      nsIMsgIdentity * aIdentity,</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+                                      const char * aOriginalMsgURI,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+                                      nsIMsgDBHdr * aOrigMsgHdr,</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+                                      PRBool aForwardInline,</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+                                      const nsAString &amp;forwardTo,</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+                                      PRBool overrideComposeFormat,</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+                                      nsIMsgWindow *aMsgWindow);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+</span>
<a href="#l4.27"></a><span id="l4.27">   nsresult ShowCachedComposeWindow(nsIDOMWindowInternal *aComposeWindow, PRBool aShow);</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29">   // hash table mapping dom windows to nsIMsgCompose objects</span>
<a href="#l4.30"></a><span id="l4.30">   nsInterfaceHashtable&lt;nsISupportsHashKey, nsIWeakReference&gt; mOpenComposeWindows;</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32">   // When doing a reply and the settings are enabled, get the HTML of the selected text</span>
<a href="#l4.33"></a><span id="l4.33">   // in the original message window so that it can be quoted instead of the entire message.</span>
<a href="#l4.34"></a><span id="l4.34">   nsresult GetOrigWindowSelection(MSG_ComposeType type, nsIMsgWindow *aMsgWindow, nsACString&amp; aSelHTML);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -3611,24 +3611,27 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l5.4"></a><span id="l5.4">             }</span>
<a href="#l5.5"></a><span id="l5.5">           }</span>
<a href="#l5.6"></a><span id="l5.6">         }</span>
<a href="#l5.7"></a><span id="l5.7">         break;</span>
<a href="#l5.8"></a><span id="l5.8">       case nsMsgFilterAction::Forward:</span>
<a href="#l5.9"></a><span id="l5.9">         {</span>
<a href="#l5.10"></a><span id="l5.10">           nsCString forwardTo;</span>
<a href="#l5.11"></a><span id="l5.11">           filterAction-&gt;GetStrValue(forwardTo);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-          nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+          nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.14"></a><span id="l5.14">           rv = GetServer(getter_AddRefs(server));</span>
<a href="#l5.15"></a><span id="l5.15">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.16"></a><span id="l5.16">           if (!forwardTo.IsEmpty())</span>
<a href="#l5.17"></a><span id="l5.17">           {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-            nsCOMPtr &lt;nsIMsgComposeService&gt; compService = do_GetService (NS_MSGCOMPOSESERVICE_CONTRACTID) ;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-            if (compService)</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-              rv = compService-&gt;ForwardMessage(NS_ConvertASCIItoUTF16(forwardTo), msgHdr, msgWindow, server);</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+            nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+              do_GetService (NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+            rv = compService-&gt;ForwardMessage(NS_ConvertASCIItoUTF16(forwardTo),</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+                                             msgHdr, msgWindow, server,</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+                                             nsIMsgComposeService::kForwardAsDefault);</span>
<a href="#l5.27"></a><span id="l5.27">           }</span>
<a href="#l5.28"></a><span id="l5.28">         }</span>
<a href="#l5.29"></a><span id="l5.29">         break;</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31">       case nsMsgFilterAction::Reply:</span>
<a href="#l5.32"></a><span id="l5.32">         {</span>
<a href="#l5.33"></a><span id="l5.33">           nsCString replyTemplateUri;</span>
<a href="#l5.34"></a><span id="l5.34">           filterAction-&gt;GetStrValue(replyTemplateUri);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -2268,19 +2268,22 @@ nsresult nsParseNewMailState::ApplyForwa</span>
<a href="#l6.4"></a><span id="l6.4">   {</span>
<a href="#l6.5"></a><span id="l6.5">     if (!m_forwardTo[i]-&gt;IsEmpty())</span>
<a href="#l6.6"></a><span id="l6.6">     {</span>
<a href="#l6.7"></a><span id="l6.7">       nsAutoString forwardStr;</span>
<a href="#l6.8"></a><span id="l6.8">       CopyASCIItoUTF16(*(m_forwardTo[i]), forwardStr);</span>
<a href="#l6.9"></a><span id="l6.9">       rv = m_rootFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l6.10"></a><span id="l6.10">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.11"></a><span id="l6.11">       {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        nsCOMPtr &lt;nsIMsgComposeService&gt; compService = do_GetService (NS_MSGCOMPOSESERVICE_CONTRACTID) ;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-        if (compService)</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-          rv = compService-&gt;ForwardMessage(forwardStr, m_msgToForwardOrReply, msgWindow, server);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+        nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+          do_GetService (NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+        rv = compService-&gt;ForwardMessage(forwardStr, m_msgToForwardOrReply,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+                                         msgWindow, server,</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+                                         nsIMsgComposeService::kForwardAsDefault);</span>
<a href="#l6.21"></a><span id="l6.21">       }</span>
<a href="#l6.22"></a><span id="l6.22">     }</span>
<a href="#l6.23"></a><span id="l6.23">   }</span>
<a href="#l6.24"></a><span id="l6.24">   m_forwardTo.Clear();</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26">   for (i = 0; i &lt; m_replyTemplateUri.Count(); i++)</span>
<a href="#l6.27"></a><span id="l6.27">   {</span>
<a href="#l6.28"></a><span id="l6.28">     if (!m_replyTemplateUri[i]-&gt;IsEmpty())</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/mime/public/nsIMimeStreamConverter.idl</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/mime/public/nsIMimeStreamConverter.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -70,17 +70,17 @@ interface nsIMimeStreamConverterListener</span>
<a href="#l7.4"></a><span id="l7.4">       void onHeadersReady(in nsIMimeHeaders headers);</span>
<a href="#l7.5"></a><span id="l7.5"> };</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> /**</span>
<a href="#l7.8"></a><span id="l7.8">  * This interface contains mailnews mime specific information for stream</span>
<a href="#l7.9"></a><span id="l7.9">  * converters. Most of the code is just stuff that has been moved out</span>
<a href="#l7.10"></a><span id="l7.10">  * of nsIStreamConverter.idl to make it more generic.</span>
<a href="#l7.11"></a><span id="l7.11">  */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-[scriptable, uuid(ed861e40-6901-4bb0-b9ec-7a8e7a79bb0e)]</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+[scriptable, uuid(d894c833-29c5-495b-880c-9a9f847bfdc9)]</span>
<a href="#l7.14"></a><span id="l7.14"> interface nsIMimeStreamConverter : nsISupports {</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16">   /**</span>
<a href="#l7.17"></a><span id="l7.17">    * Set the desired mime output type on the converer.</span>
<a href="#l7.18"></a><span id="l7.18">    */</span>
<a href="#l7.19"></a><span id="l7.19">   void SetMimeOutputType(in nsMimeOutputType aType);</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21">   void GetMimeOutputType(out nsMimeOutputType aOutFormat);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -92,21 +92,31 @@ interface nsIMimeStreamConverter : nsISu</span>
<a href="#l7.23"></a><span id="l7.23">   void SetStreamURI(in nsIURI aURI);</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   /**</span>
<a href="#l7.26"></a><span id="l7.26">    * Used to extract headers while parsing a message.</span>
<a href="#l7.27"></a><span id="l7.27">    */</span>
<a href="#l7.28"></a><span id="l7.28">   void SetMimeHeadersListener(in nsIMimeStreamConverterListener listener, in nsMimeOutputType aType);</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">   /**</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-   * This is used for forward inline.</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+   * This is used for forward inline, both as a filter action, and from the UI.</span>
<a href="#l7.33"></a><span id="l7.33">    */</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  attribute PRBool forwardInline;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  attribute boolean forwardInline;</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37">   /**</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+   * This is used for a forward inline filter action. When streaming is done,</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+   * we won't open a compose window with the editor contents.</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+   */</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+  attribute boolean forwardInlineFilter;</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+  /**</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+   * Address for the forward inline filter to forward the message to.</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+   */</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  attribute AString forwardToAddress;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  /**</span>
<a href="#l7.48"></a><span id="l7.48">    * Use the opposite compose format, used for forward inline.</span>
<a href="#l7.49"></a><span id="l7.49">    */</span>
<a href="#l7.50"></a><span id="l7.50">   attribute PRBool overrideComposeFormat;</span>
<a href="#l7.51"></a><span id="l7.51"> </span>
<a href="#l7.52"></a><span id="l7.52">   /**</span>
<a href="#l7.53"></a><span id="l7.53">    * This is used for OpenDraft, OpenEditorTemplate and Forward inline (which use OpenDraft)</span>
<a href="#l7.54"></a><span id="l7.54">    */</span>
<a href="#l7.55"></a><span id="l7.55">   attribute nsIMsgIdentity identity;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -176,32 +176,30 @@ mime_dump_attachments ( nsMsgAttachmentD</span>
<a href="#l8.4"></a><span id="l8.4">     printf(&quot;Mac Type          : %s\n&quot;, tmp-&gt;x_mac_type ? tmp-&gt;x_mac_type : &quot;nsnull&quot;);</span>
<a href="#l8.5"></a><span id="l8.5">     printf(&quot;Mac Creator       : %s\n&quot;, tmp-&gt;x_mac_creator ? tmp-&gt;x_mac_creator : &quot;nsnull&quot;);</span>
<a href="#l8.6"></a><span id="l8.6">     i++;</span>
<a href="#l8.7"></a><span id="l8.7">     tmp++;</span>
<a href="#l8.8"></a><span id="l8.8">   }</span>
<a href="#l8.9"></a><span id="l8.9"> }</span>
<a href="#l8.10"></a><span id="l8.10"> #endif</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-nsresult</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-CreateTheComposeWindow(nsIMsgCompFields *   compFields,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-                       nsMsgAttachmentData *attachmentList,</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-                       MSG_ComposeType      composeType,</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-                       MSG_ComposeFormat    composeFormat,</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-                       nsIMsgIdentity *     identity,</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-                       const char *         originalMsgURI,</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-                       nsIMsgDBHdr *        origMsgHdr</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-                       )</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+nsresult CreateComposeParams(nsCOMPtr&lt;nsIMsgComposeParams&gt; &amp;pMsgComposeParams,</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+                             nsIMsgCompFields * compFields,</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+                             nsMsgAttachmentData *attachmentList,</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+                             MSG_ComposeType composeType,</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+                             MSG_ComposeFormat composeFormat,</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+                             nsIMsgIdentity * identity,</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+                             const char *originalMsgURI,</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+                             nsIMsgDBHdr *origMsgHdr)</span>
<a href="#l8.29"></a><span id="l8.29"> {</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  nsresult            rv;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-</span>
<a href="#l8.32"></a><span id="l8.32"> #ifdef NS_DEBUG</span>
<a href="#l8.33"></a><span id="l8.33">   mime_dump_attachments ( attachmentList );</span>
<a href="#l8.34"></a><span id="l8.34"> #endif</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  nsresult rv;</span>
<a href="#l8.37"></a><span id="l8.37">   nsMsgAttachmentData *curAttachment = attachmentList;</span>
<a href="#l8.38"></a><span id="l8.38">   if (curAttachment)</span>
<a href="#l8.39"></a><span id="l8.39">   {</span>
<a href="#l8.40"></a><span id="l8.40">     nsCAutoString spec;</span>
<a href="#l8.41"></a><span id="l8.41"> </span>
<a href="#l8.42"></a><span id="l8.42">     while (curAttachment &amp;&amp; curAttachment-&gt;real_name) //JFD: Why do we check for real_name?</span>
<a href="#l8.43"></a><span id="l8.43">     {</span>
<a href="#l8.44"></a><span id="l8.44">       rv = curAttachment-&gt;url-&gt;GetSpec(spec);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineat">@@ -222,49 +220,101 @@ CreateTheComposeWindow(nsIMsgCompFields </span>
<a href="#l8.46"></a><span id="l8.46">           attachment-&gt;SetMacCreator(curAttachment-&gt;x_mac_creator);</span>
<a href="#l8.47"></a><span id="l8.47">           compFields-&gt;AddAttachment(attachment);</span>
<a href="#l8.48"></a><span id="l8.48">         }</span>
<a href="#l8.49"></a><span id="l8.49">       }</span>
<a href="#l8.50"></a><span id="l8.50">       curAttachment++;</span>
<a href="#l8.51"></a><span id="l8.51">     }</span>
<a href="#l8.52"></a><span id="l8.52">   }</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeService&gt; msgComposeService =</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-           do_GetService(kCMsgComposeServiceCID, &amp;rv);</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-  if ((NS_FAILED(rv)) || (!msgComposeService))</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-    return rv;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-</span>
<a href="#l8.59"></a><span id="l8.59">   MSG_ComposeFormat format = composeFormat; // Format to actually use.</span>
<a href="#l8.60"></a><span id="l8.60">   if (identity &amp;&amp; composeType == nsIMsgCompType::ForwardInline)</span>
<a href="#l8.61"></a><span id="l8.61">   {</span>
<a href="#l8.62"></a><span id="l8.62">     PRBool composeHtml = PR_FALSE;</span>
<a href="#l8.63"></a><span id="l8.63">     identity-&gt;GetComposeHtml(&amp;composeHtml);</span>
<a href="#l8.64"></a><span id="l8.64">     if (composeHtml)</span>
<a href="#l8.65"></a><span id="l8.65">       format = (composeFormat == nsIMsgCompFormat::OppositeOfDefault) ?</span>
<a href="#l8.66"></a><span id="l8.66">                  nsIMsgCompFormat::PlainText : nsIMsgCompFormat::HTML;</span>
<a href="#l8.67"></a><span id="l8.67">     else</span>
<a href="#l8.68"></a><span id="l8.68">       format = (composeFormat == nsIMsgCompFormat::OppositeOfDefault) ?</span>
<a href="#l8.69"></a><span id="l8.69">                  nsIMsgCompFormat::HTML : nsIMsgCompFormat::PlainText;</span>
<a href="#l8.70"></a><span id="l8.70">   }</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams (do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; pMsgComposeParams)</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  {</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-    pMsgComposeParams-&gt;SetType(composeType);</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-    pMsgComposeParams-&gt;SetFormat(format);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-    pMsgComposeParams-&gt;SetIdentity(identity);</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-    pMsgComposeParams-&gt;SetComposeFields(compFields);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-    if (originalMsgURI)</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-      pMsgComposeParams-&gt;SetOriginalMsgURI(originalMsgURI);</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-    if (origMsgHdr)</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-      pMsgComposeParams-&gt;SetOrigMsgHdr(origMsgHdr);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+  pMsgComposeParams = do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv);</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+  pMsgComposeParams-&gt;SetType(composeType);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+  pMsgComposeParams-&gt;SetFormat(format);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+  pMsgComposeParams-&gt;SetIdentity(identity);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+  pMsgComposeParams-&gt;SetComposeFields(compFields);</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+  if (originalMsgURI)</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+    pMsgComposeParams-&gt;SetOriginalMsgURI(originalMsgURI);</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+  if (origMsgHdr)</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+    pMsgComposeParams-&gt;SetOrigMsgHdr(origMsgHdr);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+}</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+nsresult</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+CreateTheComposeWindow(nsIMsgCompFields *   compFields,</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+                       nsMsgAttachmentData *attachmentList,</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+                       MSG_ComposeType      composeType,</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+                       MSG_ComposeFormat    composeFormat,</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+                       nsIMsgIdentity *     identity,</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+                       const char *         originalMsgURI,</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+                       nsIMsgDBHdr *        origMsgHdr</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+                       )</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+{</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams;</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+  nsresult rv = CreateComposeParams(pMsgComposeParams, compFields,</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+                       attachmentList,</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+                       composeType,</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+                       composeFormat,</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+                       identity,</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+                       originalMsgURI,</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+                       origMsgHdr);</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-    rv = msgComposeService-&gt;OpenComposeWindowWithParams(nsnull /* default chrome */, pMsgComposeParams);</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-  }</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-  return rv;</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeService&gt; msgComposeService =</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+           do_GetService(kCMsgComposeServiceCID, &amp;rv);</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  return msgComposeService-&gt;OpenComposeWindowWithParams(nsnull /* default chrome */, pMsgComposeParams);</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+}</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+nsresult</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+SendTheMessage(nsIMsgCompFields *   compFields,</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+               nsMsgAttachmentData *attachmentList,</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+               MSG_ComposeType      composeType,</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+               MSG_ComposeFormat    composeFormat,</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+               nsIMsgIdentity *     identity,</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+               const char *         originalMsgURI,</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+               nsIMsgDBHdr *        origMsgHdr)</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+{</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams;</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+  nsresult rv = CreateComposeParams(pMsgComposeParams, compFields,</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+                       attachmentList,</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+                       composeType,</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+                       composeFormat,</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+                       identity,</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+                       originalMsgURI,</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+                       origMsgHdr);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeService&gt; msgComposeService =</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+           do_GetService(kCMsgComposeServiceCID, &amp;rv);</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+  // create the nsIMsgCompose object to send the object</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose (do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+  /** initialize nsIMsgCompose, Send the message, wait for send completion response **/</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+  rv = pMsgCompose-&gt;Initialize(nsnull, pMsgComposeParams) ;</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+  return pMsgCompose-&gt;SendMsg(nsIMsgSend::nsMsgDeliverNow, identity, nsnull, nsnull, nsnull) ;</span>
<a href="#l8.158"></a><span id="l8.158"> }</span>
<a href="#l8.159"></a><span id="l8.159"> </span>
<a href="#l8.160"></a><span id="l8.160"> nsresult</span>
<a href="#l8.161"></a><span id="l8.161"> CreateCompositionFields(const char        *from,</span>
<a href="#l8.162"></a><span id="l8.162">                         const char        *reply_to,</span>
<a href="#l8.163"></a><span id="l8.163">                         const char        *to,</span>
<a href="#l8.164"></a><span id="l8.164">                         const char        *cc,</span>
<a href="#l8.165"></a><span id="l8.165">                         const char        *bcc,</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineat">@@ -1458,24 +1508,25 @@ mime_parse_stream_complete (nsMIMESessio</span>
<a href="#l8.167"></a><span id="l8.167">               char *escapedBody = MsgEscapeHTML(body);</span>
<a href="#l8.168"></a><span id="l8.168">               if (escapedBody)</span>
<a href="#l8.169"></a><span id="l8.169">               {</span>
<a href="#l8.170"></a><span id="l8.170">                 PR_Free(body);</span>
<a href="#l8.171"></a><span id="l8.171">                 body = escapedBody;</span>
<a href="#l8.172"></a><span id="l8.172">                 bodyLen = strlen(body);</span>
<a href="#l8.173"></a><span id="l8.173">               }</span>
<a href="#l8.174"></a><span id="l8.174"> </span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-              PRUint32 newbodylen = bodyLen + 12; //+11 chars for &lt;pre&gt; &amp; &lt;/pre&gt; tags</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+               //+13 chars for &lt;pre&gt; &amp; &lt;/pre&gt; tags and CRLF</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+              PRUint32 newbodylen = bodyLen + 14;</span>
<a href="#l8.178"></a><span id="l8.178">               char* newbody = (char *)PR_MALLOC (newbodylen);</span>
<a href="#l8.179"></a><span id="l8.179">               if (newbody)</span>
<a href="#l8.180"></a><span id="l8.180">               {</span>
<a href="#l8.181"></a><span id="l8.181">                 *newbody = 0;</span>
<a href="#l8.182"></a><span id="l8.182">                 PL_strcatn(newbody, newbodylen, &quot;&lt;PRE&gt;&quot;);</span>
<a href="#l8.183"></a><span id="l8.183">                 PL_strcatn(newbody, newbodylen, body);</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-                PL_strcatn(newbody, newbodylen, &quot;&lt;/PRE&gt;&quot;);</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+                PL_strcatn(newbody, newbodylen, &quot;&lt;/PRE&gt;&quot;CRLF);</span>
<a href="#l8.186"></a><span id="l8.186">                 PR_Free(body);</span>
<a href="#l8.187"></a><span id="l8.187">                 body = newbody;</span>
<a href="#l8.188"></a><span id="l8.188">               }</span>
<a href="#l8.189"></a><span id="l8.189">             }</span>
<a href="#l8.190"></a><span id="l8.190">             // Body is now HTML, set the format too (so headers are inserted in</span>
<a href="#l8.191"></a><span id="l8.191">             // correct format).</span>
<a href="#l8.192"></a><span id="l8.192">             composeFormat = nsIMsgCompFormat::HTML;</span>
<a href="#l8.193"></a><span id="l8.193">           }</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineat">@@ -1524,17 +1575,25 @@ mime_parse_stream_complete (nsMIMESessio</span>
<a href="#l8.195"></a><span id="l8.195">       else</span>
<a href="#l8.196"></a><span id="l8.196">       {</span>
<a href="#l8.197"></a><span id="l8.197">         if (mdd-&gt;forwardInline)</span>
<a href="#l8.198"></a><span id="l8.198">         {</span>
<a href="#l8.199"></a><span id="l8.199">           if (convertToPlainText)</span>
<a href="#l8.200"></a><span id="l8.200">             fields-&gt;ConvertBodyToPlainText();</span>
<a href="#l8.201"></a><span id="l8.201">           if (mdd-&gt;overrideComposeFormat)</span>
<a href="#l8.202"></a><span id="l8.202">             composeFormat = nsIMsgCompFormat::OppositeOfDefault;</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-          CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::ForwardInline, composeFormat, mdd-&gt;identity, mdd-&gt;originalMsgURI, mdd-&gt;origMsgHdr);</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+          if (mdd-&gt;forwardInlineFilter)</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+          {</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+            fields-&gt;SetTo(mdd-&gt;forwardToAddress);</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+            SendTheMessage(fields, newAttachData, nsIMsgCompType::ForwardInline,</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+                           composeFormat, mdd-&gt;identity, mdd-&gt;originalMsgURI,</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+                           mdd-&gt;origMsgHdr);</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+          }</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+          else</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+            CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::ForwardInline, composeFormat, mdd-&gt;identity, mdd-&gt;originalMsgURI, mdd-&gt;origMsgHdr);</span>
<a href="#l8.213"></a><span id="l8.213">         }</span>
<a href="#l8.214"></a><span id="l8.214">         else</span>
<a href="#l8.215"></a><span id="l8.215">         {</span>
<a href="#l8.216"></a><span id="l8.216">           fields-&gt;SetDraftId(mdd-&gt;url_name);</span>
<a href="#l8.217"></a><span id="l8.217">           CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::Draft, composeFormat, mdd-&gt;identity, mdd-&gt;originalMsgURI, mdd-&gt;origMsgHdr);</span>
<a href="#l8.218"></a><span id="l8.218">         }</span>
<a href="#l8.219"></a><span id="l8.219">       }</span>
<a href="#l8.220"></a><span id="l8.220">     }</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineat">@@ -2035,16 +2094,18 @@ mime_bridge_create_draft_stream(</span>
<a href="#l8.222"></a><span id="l8.222">       urlString.Cut(typeIndex, sizeof(&quot;&amp;type=application/x-message-display&quot;) - 1);</span>
<a href="#l8.223"></a><span id="l8.223"> </span>
<a href="#l8.224"></a><span id="l8.224">     mdd-&gt;url_name = ToNewCString(urlString);</span>
<a href="#l8.225"></a><span id="l8.225">     if (!(mdd-&gt;url_name))</span>
<a href="#l8.226"></a><span id="l8.226">       goto FAIL;</span>
<a href="#l8.227"></a><span id="l8.227">   }</span>
<a href="#l8.228"></a><span id="l8.228"> </span>
<a href="#l8.229"></a><span id="l8.229">   newPluginObj2-&gt;GetForwardInline(&amp;mdd-&gt;forwardInline);</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+  newPluginObj2-&gt;GetForwardInlineFilter(&amp;mdd-&gt;forwardInlineFilter);</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+  newPluginObj2-&gt;GetForwardToAddress(mdd-&gt;forwardToAddress);</span>
<a href="#l8.232"></a><span id="l8.232">   newPluginObj2-&gt;GetOverrideComposeFormat(&amp;mdd-&gt;overrideComposeFormat);</span>
<a href="#l8.233"></a><span id="l8.233">   newPluginObj2-&gt;GetIdentity(getter_AddRefs(mdd-&gt;identity));</span>
<a href="#l8.234"></a><span id="l8.234">   newPluginObj2-&gt;GetOriginalMsgURI(&amp;mdd-&gt;originalMsgURI);</span>
<a href="#l8.235"></a><span id="l8.235">   newPluginObj2-&gt;GetOrigMsgHdr(getter_AddRefs(mdd-&gt;origMsgHdr));</span>
<a href="#l8.236"></a><span id="l8.236">   mdd-&gt;format_out = format_out;</span>
<a href="#l8.237"></a><span id="l8.237">   mdd-&gt;options = new  MimeDisplayOptions ;</span>
<a href="#l8.238"></a><span id="l8.238">   if (!mdd-&gt;options)</span>
<a href="#l8.239"></a><span id="l8.239">     goto FAIL;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -151,17 +151,19 @@ struct mime_draft_data</span>
<a href="#l9.4"></a><span id="l9.4">   nsMsgAttachedFile   *curAttachment;       // temp</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6">   nsCOMPtr &lt;nsILocalFile&gt; tmpFile;</span>
<a href="#l9.7"></a><span id="l9.7">   nsCOMPtr &lt;nsIOutputStream&gt; tmpFileStream;      // output file handle</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9">   MimeDecoderData     *decoder_data;</span>
<a href="#l9.10"></a><span id="l9.10">   char                *mailcharset;        // get it from CHARSET of Content-Type</span>
<a href="#l9.11"></a><span id="l9.11">   PRBool              forwardInline;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  PRBool              forwardInlineFilter;</span>
<a href="#l9.13"></a><span id="l9.13">   PRBool              overrideComposeFormat; // Override compose format (for forward inline).</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  nsString            forwardToAddress;</span>
<a href="#l9.15"></a><span id="l9.15">   nsCOMPtr&lt;nsIMsgIdentity&gt;      identity;</span>
<a href="#l9.16"></a><span id="l9.16">   char                *originalMsgURI;     // the original URI of the message we are currently processing</span>
<a href="#l9.17"></a><span id="l9.17">   nsCOMPtr&lt;nsIMsgDBHdr&gt;         origMsgHdr;</span>
<a href="#l9.18"></a><span id="l9.18"> };</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20"> ////////////////////////////////////////////////////////////////</span>
<a href="#l9.21"></a><span id="l9.21"> // Bridge routines for legacy mime code</span>
<a href="#l9.22"></a><span id="l9.22"> ////////////////////////////////////////////////////////////////</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/mime/src/nsStreamConverter.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/mime/src/nsStreamConverter.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -521,20 +521,21 @@ nsStreamConverter::InternalCleanup(void)</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> /*</span>
<a href="#l10.6"></a><span id="l10.6">  * Inherited methods for nsMimeConverter</span>
<a href="#l10.7"></a><span id="l10.7">  */</span>
<a href="#l10.8"></a><span id="l10.8"> nsStreamConverter::nsStreamConverter()</span>
<a href="#l10.9"></a><span id="l10.9"> {</span>
<a href="#l10.10"></a><span id="l10.10">   // Init member variables...</span>
<a href="#l10.11"></a><span id="l10.11">   mWrapperOutput = PR_FALSE;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  mBridgeStream = NULL;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  mBridgeStream = nsnull;</span>
<a href="#l10.14"></a><span id="l10.14">   mOutputFormat = &quot;text/html&quot;;</span>
<a href="#l10.15"></a><span id="l10.15">   mAlreadyKnowOutputType = PR_FALSE;</span>
<a href="#l10.16"></a><span id="l10.16">   mForwardInline = PR_FALSE;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+  mForwardInlineFilter = PR_FALSE;</span>
<a href="#l10.18"></a><span id="l10.18">   mOverrideComposeFormat = PR_FALSE;</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20">   mPendingRequest = nsnull;</span>
<a href="#l10.21"></a><span id="l10.21">   mPendingContext = nsnull;</span>
<a href="#l10.22"></a><span id="l10.22"> }</span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24"> nsStreamConverter::~nsStreamConverter()</span>
<a href="#l10.25"></a><span id="l10.25"> {</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineat">@@ -782,19 +783,33 @@ nsresult</span>
<a href="#l10.27"></a><span id="l10.27"> nsStreamConverter::SetMimeHeadersListener(nsIMimeStreamConverterListener *listener, nsMimeOutputType aType)</span>
<a href="#l10.28"></a><span id="l10.28"> {</span>
<a href="#l10.29"></a><span id="l10.29">    mMimeStreamConverterListener = listener;</span>
<a href="#l10.30"></a><span id="l10.30">    bridge_set_mime_stream_converter_listener((nsMIMESession *)mBridgeStream, listener, aType);</span>
<a href="#l10.31"></a><span id="l10.31">    return NS_OK;</span>
<a href="#l10.32"></a><span id="l10.32"> }</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34"> NS_IMETHODIMP</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-nsStreamConverter::SetForwardInline(PRBool forwardInline)</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+nsStreamConverter::SetForwardInline(PRBool aForwardInline)</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+{</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  mForwardInline = aForwardInline;</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+}</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+nsStreamConverter::GetForwardToAddress(nsAString &amp;aAddress)</span>
<a href="#l10.44"></a><span id="l10.44"> {</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-  mForwardInline = forwardInline;</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  aAddress = mForwardToAddress;</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+}</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+nsStreamConverter::SetForwardToAddress(const nsAString &amp;aAddress)</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+{</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  mForwardToAddress = aAddress;</span>
<a href="#l10.54"></a><span id="l10.54">   return NS_OK;</span>
<a href="#l10.55"></a><span id="l10.55"> }</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57"> NS_IMETHODIMP</span>
<a href="#l10.58"></a><span id="l10.58"> nsStreamConverter::GetOverrideComposeFormat(PRBool *aResult)</span>
<a href="#l10.59"></a><span id="l10.59"> {</span>
<a href="#l10.60"></a><span id="l10.60">   if (!aResult)</span>
<a href="#l10.61"></a><span id="l10.61">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineat">@@ -805,20 +820,35 @@ nsStreamConverter::GetOverrideComposeFor</span>
<a href="#l10.63"></a><span id="l10.63"> NS_IMETHODIMP</span>
<a href="#l10.64"></a><span id="l10.64"> nsStreamConverter::SetOverrideComposeFormat(PRBool aOverrideComposeFormat)</span>
<a href="#l10.65"></a><span id="l10.65"> {</span>
<a href="#l10.66"></a><span id="l10.66">   mOverrideComposeFormat = aOverrideComposeFormat;</span>
<a href="#l10.67"></a><span id="l10.67">   return NS_OK;</span>
<a href="#l10.68"></a><span id="l10.68"> }</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70"> NS_IMETHODIMP</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-nsStreamConverter::GetForwardInline(PRBool *result)</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+nsStreamConverter::GetForwardInline(PRBool *aResult)</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+{</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+  *aResult = mForwardInline;</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+}</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+nsStreamConverter::GetForwardInlineFilter(PRBool *aResult)</span>
<a href="#l10.81"></a><span id="l10.81"> {</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-  if (!result) return NS_ERROR_NULL_POINTER;</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-  *result = mForwardInline;</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+  *aResult = mForwardInlineFilter;</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+}</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+nsStreamConverter::SetForwardInlineFilter(PRBool aForwardInlineFilter)</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+{</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+  mForwardInlineFilter = aForwardInlineFilter;</span>
<a href="#l10.93"></a><span id="l10.93">   return NS_OK;</span>
<a href="#l10.94"></a><span id="l10.94"> }</span>
<a href="#l10.95"></a><span id="l10.95"> </span>
<a href="#l10.96"></a><span id="l10.96"> NS_IMETHODIMP</span>
<a href="#l10.97"></a><span id="l10.97"> nsStreamConverter::GetIdentity(nsIMsgIdentity * *aIdentity)</span>
<a href="#l10.98"></a><span id="l10.98"> {</span>
<a href="#l10.99"></a><span id="l10.99">   if (!aIdentity) return NS_ERROR_NULL_POINTER;</span>
<a href="#l10.100"></a><span id="l10.100">   /*</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/mime/src/nsStreamConverter.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/mime/src/nsStreamConverter.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -43,18 +43,18 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsIMimeEmitter.h&quot; </span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsIURI.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsIAsyncInputStream.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsIAsyncOutputStream.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-class nsStreamConverter : public nsIStreamConverter, public nsIMimeStreamConverter { </span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-public: </span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+class nsStreamConverter : public nsIStreamConverter, public nsIMimeStreamConverter {</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+public:</span>
<a href="#l11.16"></a><span id="l11.16">   nsStreamConverter();</span>
<a href="#l11.17"></a><span id="l11.17">   virtual ~nsStreamConverter();</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19">   NS_DECL_ISUPPORTS </span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21">   // nsIMimeStreamConverter support</span>
<a href="#l11.22"></a><span id="l11.22">   NS_DECL_NSIMIMESTREAMCONVERTER</span>
<a href="#l11.23"></a><span id="l11.23">   // nsIStreamConverter methods</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineat">@@ -95,23 +95,25 @@ private:</span>
<a href="#l11.25"></a><span id="l11.25">   nsCString                     mOutputFormat;</span>
<a href="#l11.26"></a><span id="l11.26">   nsCString                     mRealContentType; // if we know the content type for real, this will be set (used by attachments)</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">   nsCString                     mOverrideFormat;  // this is a possible override for emitter creation</span>
<a href="#l11.29"></a><span id="l11.29">   PRBool                        mWrapperOutput;   // Should we output the frame split message display </span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31">   nsCOMPtr&lt;nsIMimeStreamConverterListener&gt;  mMimeStreamConverterListener;</span>
<a href="#l11.32"></a><span id="l11.32">   PRBool                        mForwardInline;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+  PRBool                        mForwardInlineFilter;</span>
<a href="#l11.34"></a><span id="l11.34">   PRBool                        mOverrideComposeFormat;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  nsString                      mForwardToAddress;</span>
<a href="#l11.36"></a><span id="l11.36">   nsCOMPtr&lt;nsIMsgIdentity&gt;      mIdentity;</span>
<a href="#l11.37"></a><span id="l11.37">   nsCString                     mOriginalMsgURI;</span>
<a href="#l11.38"></a><span id="l11.38">   nsCOMPtr&lt;nsIMsgDBHdr&gt;         mOrigMsgHdr;</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40">   nsCString                     mFromType;</span>
<a href="#l11.41"></a><span id="l11.41">   nsCString                     mToType;</span>
<a href="#l11.42"></a><span id="l11.42"> #ifdef DEBUG_mscott  </span>
<a href="#l11.43"></a><span id="l11.43">   PRTime mConvertContentTime;</span>
<a href="#l11.44"></a><span id="l11.44"> #endif</span>
<a href="#l11.45"></a><span id="l11.45">   nsIRequest *                  mPendingRequest;  // used when we need to delay to fire onStartRequest</span>
<a href="#l11.46"></a><span id="l11.46">   nsISupports *                 mPendingContext;  // used when we need to delay to fire onStartRequest</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-}; </span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+};</span>
<a href="#l11.49"></a><span id="l11.49"> </span>
<a href="#l11.50"></a><span id="l11.50"> #endif /* nsStreamConverter_h_ */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

