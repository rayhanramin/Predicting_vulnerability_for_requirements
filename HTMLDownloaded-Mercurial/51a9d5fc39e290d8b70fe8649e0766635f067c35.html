<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 912:51a9d5fc39e290d8b70fe8649e0766635f067c35</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 51a9d5fc39e290d8b70fe8649e0766635f067c35" />
<meta property="og:url" content="/comm-central/rev/51a9d5fc39e290d8b70fe8649e0766635f067c35" />
<meta property="og:description" content="* annotate attributes with comments indicating who tests them (if anyone)" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 51a9d5fc39e290d8b70fe8649e0766635f067c35 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/51a9d5fc39e290d8b70fe8649e0766635f067c35">shortlog</a> |
<a href="/comm-central/log/51a9d5fc39e290d8b70fe8649e0766635f067c35">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/51a9d5fc39e290d8b70fe8649e0766635f067c35">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/51a9d5fc39e290d8b70fe8649e0766635f067c35">files</a> |
changeset |
<a href="/comm-central/raw-rev/51a9d5fc39e290d8b70fe8649e0766635f067c35">raw</a>  | <a href="/comm-central/archive/51a9d5fc39e290d8b70fe8649e0766635f067c35.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
* annotate attributes with comments indicating who tests them (if anyone)
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 04 Sep 2008 01:54:19 -0700</td></tr>

<tr>
 <td>changeset 912</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/51a9d5fc39e290d8b70fe8649e0766635f067c35">51a9d5fc39e290d8b70fe8649e0766635f067c35</a></td>
</tr>



<tr>
<td>parent 911</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8fbc91720994765c93399f64171b599d0f8287bb">8fbc91720994765c93399f64171b599d0f8287bb</a>
</td>
</tr>

<tr>
<td>child 913</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/048686317d145e8c652a5e8ba87572e0d141dde9">048686317d145e8c652a5e8ba87572e0d141dde9</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=51a9d5fc39e290d8b70fe8649e0766635f067c35">743</a></td></tr>
<tr><td>push user</td><td>dmosedale@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Nov 2008 20:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a79b923a9cba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">* annotate attributes with comments indicating who tests them (if anyone)
 * test folderURI and identity kind
 * slight change to glodaTestHelper to ensure that test functions have
   gLocalInboxFolder and gLocalIncomingServer available to them for their
   entire execution window.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/51a9d5fc39e290d8b70fe8649e0766635f067c35/modules/explattr.js">modules/explattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/51a9d5fc39e290d8b70fe8649e0766635f067c35/modules/explattr.js">file</a> |
<a href="/comm-central/annotate/51a9d5fc39e290d8b70fe8649e0766635f067c35/modules/explattr.js">annotate</a> |
<a href="/comm-central/diff/51a9d5fc39e290d8b70fe8649e0766635f067c35/modules/explattr.js">diff</a> |
<a href="/comm-central/comparison/51a9d5fc39e290d8b70fe8649e0766635f067c35/modules/explattr.js">comparison</a> |
<a href="/comm-central/log/51a9d5fc39e290d8b70fe8649e0766635f067c35/modules/explattr.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/51a9d5fc39e290d8b70fe8649e0766635f067c35/modules/fundattr.js">modules/fundattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/51a9d5fc39e290d8b70fe8649e0766635f067c35/modules/fundattr.js">file</a> |
<a href="/comm-central/annotate/51a9d5fc39e290d8b70fe8649e0766635f067c35/modules/fundattr.js">annotate</a> |
<a href="/comm-central/diff/51a9d5fc39e290d8b70fe8649e0766635f067c35/modules/fundattr.js">diff</a> |
<a href="/comm-central/comparison/51a9d5fc39e290d8b70fe8649e0766635f067c35/modules/fundattr.js">comparison</a> |
<a href="/comm-central/log/51a9d5fc39e290d8b70fe8649e0766635f067c35/modules/fundattr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/51a9d5fc39e290d8b70fe8649e0766635f067c35/test/resources/glodaTestHelper.js">test/resources/glodaTestHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/51a9d5fc39e290d8b70fe8649e0766635f067c35/test/resources/glodaTestHelper.js">file</a> |
<a href="/comm-central/annotate/51a9d5fc39e290d8b70fe8649e0766635f067c35/test/resources/glodaTestHelper.js">annotate</a> |
<a href="/comm-central/diff/51a9d5fc39e290d8b70fe8649e0766635f067c35/test/resources/glodaTestHelper.js">diff</a> |
<a href="/comm-central/comparison/51a9d5fc39e290d8b70fe8649e0766635f067c35/test/resources/glodaTestHelper.js">comparison</a> |
<a href="/comm-central/log/51a9d5fc39e290d8b70fe8649e0766635f067c35/test/resources/glodaTestHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/51a9d5fc39e290d8b70fe8649e0766635f067c35/test/unit/test_index_messages.js">test/unit/test_index_messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/51a9d5fc39e290d8b70fe8649e0766635f067c35/test/unit/test_index_messages.js">file</a> |
<a href="/comm-central/annotate/51a9d5fc39e290d8b70fe8649e0766635f067c35/test/unit/test_index_messages.js">annotate</a> |
<a href="/comm-central/diff/51a9d5fc39e290d8b70fe8649e0766635f067c35/test/unit/test_index_messages.js">diff</a> |
<a href="/comm-central/comparison/51a9d5fc39e290d8b70fe8649e0766635f067c35/test/unit/test_index_messages.js">comparison</a> |
<a href="/comm-central/log/51a9d5fc39e290d8b70fe8649e0766635f067c35/test/unit/test_index_messages.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/modules/explattr.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/modules/explattr.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -99,17 +99,17 @@ let GlodaExplicitAttr = {</span>
<a href="#l1.4"></a><span id="l1.4">                         singular: false,</span>
<a href="#l1.5"></a><span id="l1.5">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l1.6"></a><span id="l1.6">                         objectNoun: Gloda.NOUN_TAG,</span>
<a href="#l1.7"></a><span id="l1.7">                         parameterNoun: null,</span>
<a href="#l1.8"></a><span id="l1.8">                         explanation: this._strBundle.GetStringFromName(</span>
<a href="#l1.9"></a><span id="l1.9">                                        &quot;attrTagExplanation&quot;),</span>
<a href="#l1.10"></a><span id="l1.10">                         // Property change notifications that we care about:</span>
<a href="#l1.11"></a><span id="l1.11">                         propertyChanges: [&quot;keywords&quot;],</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-                        });</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+                        }); // not-tested</span>
<a href="#l1.14"></a><span id="l1.14">     Gloda.defineNounAction(Gloda.NOUN_TAG, {</span>
<a href="#l1.15"></a><span id="l1.15">       actionType: &quot;filter&quot;, actionTarget: Gloda.NOUN_TAG,</span>
<a href="#l1.16"></a><span id="l1.16">       shortName: &quot;same tag&quot;,</span>
<a href="#l1.17"></a><span id="l1.17">       makeConstraint: function(aAttrDef, aTagged) {</span>
<a href="#l1.18"></a><span id="l1.18">         return [GlodaExplicitAttr._attrTag].concat(</span>
<a href="#l1.19"></a><span id="l1.19">           TagNoun.toParamAndValue(aTagged, true));</span>
<a href="#l1.20"></a><span id="l1.20">       },</span>
<a href="#l1.21"></a><span id="l1.21">       });</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -123,31 +123,31 @@ let GlodaExplicitAttr = {</span>
<a href="#l1.23"></a><span id="l1.23">                         bind: true,</span>
<a href="#l1.24"></a><span id="l1.24">                         bindName: &quot;starred&quot;,</span>
<a href="#l1.25"></a><span id="l1.25">                         singular: true,</span>
<a href="#l1.26"></a><span id="l1.26">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l1.27"></a><span id="l1.27">                         objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l1.28"></a><span id="l1.28">                         parameterNoun: null,</span>
<a href="#l1.29"></a><span id="l1.29">                         explanation: this._strBundle.GetStringFromName(</span>
<a href="#l1.30"></a><span id="l1.30">                                        &quot;attrStarExplanation&quot;),</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-                        });</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+                        }); // tested-by: test_attributes_explicit</span>
<a href="#l1.33"></a><span id="l1.33">     // Read/Unread</span>
<a href="#l1.34"></a><span id="l1.34">     this._attrRead = Gloda.defineAttribute({</span>
<a href="#l1.35"></a><span id="l1.35">                         provider: this,</span>
<a href="#l1.36"></a><span id="l1.36">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l1.37"></a><span id="l1.37">                         attributeType: Gloda.kAttrExplicit,</span>
<a href="#l1.38"></a><span id="l1.38">                         attributeName: &quot;read&quot;,</span>
<a href="#l1.39"></a><span id="l1.39">                         bind: true,</span>
<a href="#l1.40"></a><span id="l1.40">                         singular: true,</span>
<a href="#l1.41"></a><span id="l1.41">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l1.42"></a><span id="l1.42">                         objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l1.43"></a><span id="l1.43">                         parameterNoun: null,</span>
<a href="#l1.44"></a><span id="l1.44">                         explanation: this._strBundle.GetStringFromName(</span>
<a href="#l1.45"></a><span id="l1.45">                                        &quot;attrReadExplanation&quot;),</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-                        });</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+                        }); // tested-by: test_attributes_explicit</span>
<a href="#l1.48"></a><span id="l1.48">     </span>
<a href="#l1.49"></a><span id="l1.49">   },</span>
<a href="#l1.50"></a><span id="l1.50">   </span>
<a href="#l1.51"></a><span id="l1.51">   process: function Gloda_explattr_process(aGlodaMessage, aMsgHdr, aMimeMsg) {</span>
<a href="#l1.52"></a><span id="l1.52">     let attribs = [];</span>
<a href="#l1.53"></a><span id="l1.53">     </span>
<a href="#l1.54"></a><span id="l1.54">     attribs.push([this._attrStar.id, aMsgHdr.isFlagged ? 1 : 0]);</span>
<a href="#l1.55"></a><span id="l1.55">     attribs.push([this._attrRead.id, aMsgHdr.isRead ? 1 : 0]);</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineat">@@ -165,13 +165,12 @@ let GlodaExplicitAttr = {</span>
<a href="#l1.57"></a><span id="l1.57">     let nowPRTime = Date.now() * 1000;</span>
<a href="#l1.58"></a><span id="l1.58"> </span>
<a href="#l1.59"></a><span id="l1.59">     let tagArray = this._msgTagService.getAllTags({});</span>
<a href="#l1.60"></a><span id="l1.60">     for (let iTag=0; iTag &lt; tagArray.length; iTag++) {</span>
<a href="#l1.61"></a><span id="l1.61">       let tag = tagArray[iTag];</span>
<a href="#l1.62"></a><span id="l1.62">       if (tag.key in keywordMap)</span>
<a href="#l1.63"></a><span id="l1.63">         attribs.push([this._attrTag, tag.key, nowPRTime]);</span>
<a href="#l1.64"></a><span id="l1.64">     }</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-</span>
<a href="#l1.66"></a><span id="l1.66">     </span>
<a href="#l1.67"></a><span id="l1.67">     return attribs;</span>
<a href="#l1.68"></a><span id="l1.68">   },</span>
<a href="#l1.69"></a><span id="l1.69"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/modules/fundattr.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/modules/fundattr.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -114,156 +114,156 @@ let GlodaFundAttr = {</span>
<a href="#l2.4"></a><span id="l2.4">       attributeName: &quot;name&quot;,</span>
<a href="#l2.5"></a><span id="l2.5">       bind: false,</span>
<a href="#l2.6"></a><span id="l2.6">       singular: true,</span>
<a href="#l2.7"></a><span id="l2.7">       special: Gloda.kSpecialString,</span>
<a href="#l2.8"></a><span id="l2.8">       specialColumnName: &quot;name&quot;,</span>
<a href="#l2.9"></a><span id="l2.9">       subjectNouns: [Gloda.NOUN_CONTACT],</span>
<a href="#l2.10"></a><span id="l2.10">       objectNoun: Gloda.NOUN_STRING,</span>
<a href="#l2.11"></a><span id="l2.11">       explanation: null, // name is internal, no explanation required</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      });</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      }); // tested-by: test_attributes_fundamental</span>
<a href="#l2.14"></a><span id="l2.14">     this._attrContactPopularity = Gloda.defineAttribute({</span>
<a href="#l2.15"></a><span id="l2.15">       provider: this,</span>
<a href="#l2.16"></a><span id="l2.16">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.17"></a><span id="l2.17">       attributeType: Gloda.kAttrDerived,</span>
<a href="#l2.18"></a><span id="l2.18">       attributeName: &quot;popularity&quot;,</span>
<a href="#l2.19"></a><span id="l2.19">       bind: false,</span>
<a href="#l2.20"></a><span id="l2.20">       singular: true,</span>
<a href="#l2.21"></a><span id="l2.21">       special: Gloda.kSpecialColumn,</span>
<a href="#l2.22"></a><span id="l2.22">       specialColumnName: &quot;popularity&quot;,</span>
<a href="#l2.23"></a><span id="l2.23">       subjectNouns: [Gloda.NOUN_CONTACT],</span>
<a href="#l2.24"></a><span id="l2.24">       objectNoun: Gloda.NOUN_NUMBER,</span>
<a href="#l2.25"></a><span id="l2.25">       explanation: null, // popularity is internal, no explanation required</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-      });    </span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+      }); // not-tested</span>
<a href="#l2.28"></a><span id="l2.28">     this._attrContactFrecency = Gloda.defineAttribute({</span>
<a href="#l2.29"></a><span id="l2.29">       provider: this,</span>
<a href="#l2.30"></a><span id="l2.30">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.31"></a><span id="l2.31">       attributeType: Gloda.kAttrDerived,</span>
<a href="#l2.32"></a><span id="l2.32">       attributeName: &quot;frecency&quot;,</span>
<a href="#l2.33"></a><span id="l2.33">       bind: false,</span>
<a href="#l2.34"></a><span id="l2.34">       singular: true,</span>
<a href="#l2.35"></a><span id="l2.35">       special: Gloda.kSpecialColumn,</span>
<a href="#l2.36"></a><span id="l2.36">       specialColumnName: &quot;frecency&quot;,</span>
<a href="#l2.37"></a><span id="l2.37">       subjectNouns: [Gloda.NOUN_CONTACT],</span>
<a href="#l2.38"></a><span id="l2.38">       objectNoun: Gloda.NOUN_NUMBER,</span>
<a href="#l2.39"></a><span id="l2.39">       explanation: null, // frecency is internal, no explanation required</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-      });    </span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+      }); // not-tested</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">     /* ***** Identities ***** */</span>
<a href="#l2.44"></a><span id="l2.44">     this._attrIdentityContact = Gloda.defineAttribute({</span>
<a href="#l2.45"></a><span id="l2.45">       provider: this,</span>
<a href="#l2.46"></a><span id="l2.46">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.47"></a><span id="l2.47">       attributeType: Gloda.kAttrDerived,</span>
<a href="#l2.48"></a><span id="l2.48">       attributeName: &quot;contact&quot;,</span>
<a href="#l2.49"></a><span id="l2.49">       bind: false,</span>
<a href="#l2.50"></a><span id="l2.50">       singular: true,</span>
<a href="#l2.51"></a><span id="l2.51">       special: Gloda.kSpecialColumn,</span>
<a href="#l2.52"></a><span id="l2.52">       specialColumnName: &quot;contactID&quot;,</span>
<a href="#l2.53"></a><span id="l2.53">       subjectNouns: [Gloda.NOUN_IDENTITY],</span>
<a href="#l2.54"></a><span id="l2.54">       objectNoun: Gloda.NOUN_CONTACT,</span>
<a href="#l2.55"></a><span id="l2.55">       explanation: null, // popularity is internal, no explanation required</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-      });</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+      }); // tested-by: test_attributes_fundamental</span>
<a href="#l2.58"></a><span id="l2.58">     this._attrIdentityKind = Gloda.defineAttribute({</span>
<a href="#l2.59"></a><span id="l2.59">       provider: this,</span>
<a href="#l2.60"></a><span id="l2.60">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.61"></a><span id="l2.61">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l2.62"></a><span id="l2.62">       attributeName: &quot;kind&quot;,</span>
<a href="#l2.63"></a><span id="l2.63">       bind: false,</span>
<a href="#l2.64"></a><span id="l2.64">       singular: true,</span>
<a href="#l2.65"></a><span id="l2.65">       special: Gloda.kSpecialString,</span>
<a href="#l2.66"></a><span id="l2.66">       specialColumnName: &quot;kind&quot;,</span>
<a href="#l2.67"></a><span id="l2.67">       subjectNouns: [Gloda.NOUN_IDENTITY],</span>
<a href="#l2.68"></a><span id="l2.68">       objectNoun: Gloda.NOUN_STRING,</span>
<a href="#l2.69"></a><span id="l2.69">       explanation: null, // kind is internal, no explanation required</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-      });</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+      }); // tested-by: test_attributes_fundamental</span>
<a href="#l2.72"></a><span id="l2.72">     this._attrIdentityValue = Gloda.defineAttribute({</span>
<a href="#l2.73"></a><span id="l2.73">       provider: this,</span>
<a href="#l2.74"></a><span id="l2.74">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.75"></a><span id="l2.75">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l2.76"></a><span id="l2.76">       attributeName: &quot;value&quot;,</span>
<a href="#l2.77"></a><span id="l2.77">       bind: false,</span>
<a href="#l2.78"></a><span id="l2.78">       singular: true,</span>
<a href="#l2.79"></a><span id="l2.79">       special: Gloda.kSpecialString,</span>
<a href="#l2.80"></a><span id="l2.80">       specialColumnName: &quot;value&quot;,</span>
<a href="#l2.81"></a><span id="l2.81">       subjectNouns: [Gloda.NOUN_IDENTITY],</span>
<a href="#l2.82"></a><span id="l2.82">       objectNoun: Gloda.NOUN_STRING,</span>
<a href="#l2.83"></a><span id="l2.83">       explanation: null, // value is internal, no explanation required</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-      });</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+      }); // tested-by: test_attributes_fundamental</span>
<a href="#l2.86"></a><span id="l2.86">   </span>
<a href="#l2.87"></a><span id="l2.87">     /* ***** Messages ***** */</span>
<a href="#l2.88"></a><span id="l2.88">     // folder</span>
<a href="#l2.89"></a><span id="l2.89">     this._attrFolder = Gloda.defineAttribute({</span>
<a href="#l2.90"></a><span id="l2.90">       provider: this,</span>
<a href="#l2.91"></a><span id="l2.91">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.92"></a><span id="l2.92">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l2.93"></a><span id="l2.93">       attributeName: &quot;folderURI&quot;,</span>
<a href="#l2.94"></a><span id="l2.94">       bind: false,</span>
<a href="#l2.95"></a><span id="l2.95">       singular: true,</span>
<a href="#l2.96"></a><span id="l2.96">       special: Gloda.kSpecialColumn,</span>
<a href="#l2.97"></a><span id="l2.97">       specialColumnName: &quot;folderID&quot;,</span>
<a href="#l2.98"></a><span id="l2.98">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.99"></a><span id="l2.99">       objectNoun: Gloda.NOUN_FOLDER,</span>
<a href="#l2.100"></a><span id="l2.100">       explanation: this._strBundle.GetStringFromName(&quot;attrFolderExplanation&quot;),</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-      });</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+      }); // tested-by: test_attributes_fundamental</span>
<a href="#l2.103"></a><span id="l2.103">     </span>
<a href="#l2.104"></a><span id="l2.104">     // bodyMatches. super-synthetic full-text matching...</span>
<a href="#l2.105"></a><span id="l2.105">     this._attrBody = Gloda.defineAttribute({</span>
<a href="#l2.106"></a><span id="l2.106">       provider: this,</span>
<a href="#l2.107"></a><span id="l2.107">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.108"></a><span id="l2.108">       attributeType: Gloda.kAttrDerived,</span>
<a href="#l2.109"></a><span id="l2.109">       attributeName: &quot;bodyMatches&quot;,</span>
<a href="#l2.110"></a><span id="l2.110">       bind: false,</span>
<a href="#l2.111"></a><span id="l2.111">       singular: true,</span>
<a href="#l2.112"></a><span id="l2.112">       special: Gloda.kSpecialFulltext,</span>
<a href="#l2.113"></a><span id="l2.113">       specialColumnName: &quot;body&quot;,</span>
<a href="#l2.114"></a><span id="l2.114">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.115"></a><span id="l2.115">       objectNoun: Gloda.NOUN_FULLTEXT,</span>
<a href="#l2.116"></a><span id="l2.116">       explanation: null, // this does not merit explanation</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-      });</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+      }); // not-tested</span>
<a href="#l2.119"></a><span id="l2.119">   </span>
<a href="#l2.120"></a><span id="l2.120">     // --- Fundamental</span>
<a href="#l2.121"></a><span id="l2.121">     // From</span>
<a href="#l2.122"></a><span id="l2.122">     this._attrFrom = Gloda.defineAttribute({</span>
<a href="#l2.123"></a><span id="l2.123">                         provider: this,</span>
<a href="#l2.124"></a><span id="l2.124">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.125"></a><span id="l2.125">                         attributeType: Gloda.kAttrFundamental,</span>
<a href="#l2.126"></a><span id="l2.126">                         attributeName: &quot;from&quot;,</span>
<a href="#l2.127"></a><span id="l2.127">                         bind: true,</span>
<a href="#l2.128"></a><span id="l2.128">                         singular: true,</span>
<a href="#l2.129"></a><span id="l2.129">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.130"></a><span id="l2.130">                         objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l2.131"></a><span id="l2.131">                         explanation: this._strBundle.GetStringFromName(</span>
<a href="#l2.132"></a><span id="l2.132">                                        &quot;attrFromExplanation&quot;),</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-                        });</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+                        }); // tested-by: test_attributes_fundamental</span>
<a href="#l2.135"></a><span id="l2.135">     // To</span>
<a href="#l2.136"></a><span id="l2.136">     this._attrTo = Gloda.defineAttribute({</span>
<a href="#l2.137"></a><span id="l2.137">                         provider: this,</span>
<a href="#l2.138"></a><span id="l2.138">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.139"></a><span id="l2.139">                         attributeType: Gloda.kAttrFundamental,</span>
<a href="#l2.140"></a><span id="l2.140">                         attributeName: &quot;to&quot;,</span>
<a href="#l2.141"></a><span id="l2.141">                         bind: true,</span>
<a href="#l2.142"></a><span id="l2.142">                         singular: false,</span>
<a href="#l2.143"></a><span id="l2.143">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.144"></a><span id="l2.144">                         objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l2.145"></a><span id="l2.145">                         explanation: this._strBundle.GetStringFromName(</span>
<a href="#l2.146"></a><span id="l2.146">                                        &quot;attrToExplanation&quot;),</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-                        });</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+                        }); // tested-by: test_attributes_fundamental</span>
<a href="#l2.149"></a><span id="l2.149">     // Cc</span>
<a href="#l2.150"></a><span id="l2.150">     this._attrCc = Gloda.defineAttribute({</span>
<a href="#l2.151"></a><span id="l2.151">                         provider: this,</span>
<a href="#l2.152"></a><span id="l2.152">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.153"></a><span id="l2.153">                         attributeType: Gloda.kAttrFundamental,</span>
<a href="#l2.154"></a><span id="l2.154">                         attributeName: &quot;cc&quot;,</span>
<a href="#l2.155"></a><span id="l2.155">                         bind: true,</span>
<a href="#l2.156"></a><span id="l2.156">                         singular: false,</span>
<a href="#l2.157"></a><span id="l2.157">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.158"></a><span id="l2.158">                         objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l2.159"></a><span id="l2.159">                         explanation: this._strBundle.GetStringFromName(</span>
<a href="#l2.160"></a><span id="l2.160">                                        &quot;attrCcExplanation&quot;),</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-                        });</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+                        }); // not-tested</span>
<a href="#l2.163"></a><span id="l2.163"> </span>
<a href="#l2.164"></a><span id="l2.164">     Gloda.defineNounAction(Gloda.NOUN_IDENTITY, {actionType: &quot;filter&quot;,</span>
<a href="#l2.165"></a><span id="l2.165">       actionTarget: Gloda.NOUN_MESSAGE,</span>
<a href="#l2.166"></a><span id="l2.166">       shortName: &quot;from&quot;,</span>
<a href="#l2.167"></a><span id="l2.167">       makeConstraint: function(aAttrDef, aIdentity) {</span>
<a href="#l2.168"></a><span id="l2.168">         return [GlodaFundAttr._attrFrom, null, aIdentity.id];</span>
<a href="#l2.169"></a><span id="l2.169">       },</span>
<a href="#l2.170"></a><span id="l2.170">       });</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineat">@@ -291,17 +291,17 @@ let GlodaFundAttr = {</span>
<a href="#l2.172"></a><span id="l2.172">                         bind: false,</span>
<a href="#l2.173"></a><span id="l2.173">                         singular: true,</span>
<a href="#l2.174"></a><span id="l2.174">                         special: Gloda.kSpecialColumn,</span>
<a href="#l2.175"></a><span id="l2.175">                         specialColumnName: &quot;date&quot;,</span>
<a href="#l2.176"></a><span id="l2.176">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.177"></a><span id="l2.177">                         objectNoun: Gloda.NOUN_DATE,</span>
<a href="#l2.178"></a><span id="l2.178">                         explanation: this._strBundle.GetStringFromName(</span>
<a href="#l2.179"></a><span id="l2.179">                                        &quot;attrDateExplanation&quot;),</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-                        });</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+                        }); // tested-by: test_attributes_fundamental</span>
<a href="#l2.182"></a><span id="l2.182"> </span>
<a href="#l2.183"></a><span id="l2.183">     // --- Optimization</span>
<a href="#l2.184"></a><span id="l2.184">     // Involves.  Means any of from/to/cc.  The queries get ugly enough without</span>
<a href="#l2.185"></a><span id="l2.185">     //   this that it seems to justify the cost, especially given the frequent</span>
<a href="#l2.186"></a><span id="l2.186">     //   use case.  (In fact, post-filtering for the specific from/to/cc is</span>
<a href="#l2.187"></a><span id="l2.187">     //   probably justifiable rather than losing this attribute...)</span>
<a href="#l2.188"></a><span id="l2.188">     this._attrInvolves = Gloda.defineAttribute({</span>
<a href="#l2.189"></a><span id="l2.189">       provider: this,</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineat">@@ -309,66 +309,66 @@ let GlodaFundAttr = {</span>
<a href="#l2.191"></a><span id="l2.191">       attributeType: Gloda.kAttrOptimization,</span>
<a href="#l2.192"></a><span id="l2.192">       attributeName: &quot;involves&quot;,</span>
<a href="#l2.193"></a><span id="l2.193">       bind: true,</span>
<a href="#l2.194"></a><span id="l2.194">       singular: false,</span>
<a href="#l2.195"></a><span id="l2.195">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.196"></a><span id="l2.196">       objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l2.197"></a><span id="l2.197">       explanation: this._strBundle.GetStringFromName(</span>
<a href="#l2.198"></a><span id="l2.198">                      &quot;attrInvolvesExplanation&quot;),</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-      });</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+      }); // not-tested</span>
<a href="#l2.201"></a><span id="l2.201"> </span>
<a href="#l2.202"></a><span id="l2.202">     // From Me To</span>
<a href="#l2.203"></a><span id="l2.203">     this._attrFromMeTo = Gloda.defineAttribute({</span>
<a href="#l2.204"></a><span id="l2.204">       provider: this,</span>
<a href="#l2.205"></a><span id="l2.205">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.206"></a><span id="l2.206">       attributeType: Gloda.kAttrOptimization,</span>
<a href="#l2.207"></a><span id="l2.207">       attributeName: &quot;fromMeTo&quot;,</span>
<a href="#l2.208"></a><span id="l2.208">       bind: false,</span>
<a href="#l2.209"></a><span id="l2.209">       singular: false,</span>
<a href="#l2.210"></a><span id="l2.210">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.211"></a><span id="l2.211">       objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l2.212"></a><span id="l2.212">       explanation: this._strBundle.GetStringFromName(&quot;attrFromMeToExplanation&quot;)</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-      });</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+      }); // not-tested</span>
<a href="#l2.215"></a><span id="l2.215">     // From Me Cc</span>
<a href="#l2.216"></a><span id="l2.216">     this._attrFromMeCc = Gloda.defineAttribute({</span>
<a href="#l2.217"></a><span id="l2.217">       provider: this,</span>
<a href="#l2.218"></a><span id="l2.218">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.219"></a><span id="l2.219">       attributeType: Gloda.kAttrOptimization,</span>
<a href="#l2.220"></a><span id="l2.220">       attributeName: &quot;fromMeCc&quot;,</span>
<a href="#l2.221"></a><span id="l2.221">       bind: false,</span>
<a href="#l2.222"></a><span id="l2.222">       singular: false,</span>
<a href="#l2.223"></a><span id="l2.223">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.224"></a><span id="l2.224">       objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l2.225"></a><span id="l2.225">       explanation: this._strBundle.GetStringFromName(&quot;attrFromMeCcExplanation&quot;)</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-      });</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+      }); // not-tested</span>
<a href="#l2.228"></a><span id="l2.228">     // To Me</span>
<a href="#l2.229"></a><span id="l2.229">     this._attrToMe = Gloda.defineAttribute({</span>
<a href="#l2.230"></a><span id="l2.230">       provider: this,</span>
<a href="#l2.231"></a><span id="l2.231">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.232"></a><span id="l2.232">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l2.233"></a><span id="l2.233">       attributeName: &quot;toMe&quot;,</span>
<a href="#l2.234"></a><span id="l2.234">       bind: false,</span>
<a href="#l2.235"></a><span id="l2.235">       singular: false,</span>
<a href="#l2.236"></a><span id="l2.236">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.237"></a><span id="l2.237">       objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l2.238"></a><span id="l2.238">       explanation: this._strBundle.GetStringFromName(&quot;attrToMeExplanation&quot;)</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-      });</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+      }); // not-tested</span>
<a href="#l2.241"></a><span id="l2.241">     // Cc Me</span>
<a href="#l2.242"></a><span id="l2.242">     this._attrCcMe = Gloda.defineAttribute({</span>
<a href="#l2.243"></a><span id="l2.243">       provider: this,</span>
<a href="#l2.244"></a><span id="l2.244">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.245"></a><span id="l2.245">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l2.246"></a><span id="l2.246">       attributeName: &quot;ccMe&quot;,</span>
<a href="#l2.247"></a><span id="l2.247">       bind: false,</span>
<a href="#l2.248"></a><span id="l2.248">       singular: false,</span>
<a href="#l2.249"></a><span id="l2.249">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.250"></a><span id="l2.250">       objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l2.251"></a><span id="l2.251">       explanation: this._strBundle.GetStringFromName(&quot;attrCcMeExplanation&quot;) </span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-      });</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+      }); // not-tested</span>
<a href="#l2.254"></a><span id="l2.254"> </span>
<a href="#l2.255"></a><span id="l2.255"> </span>
<a href="#l2.256"></a><span id="l2.256">     // -- Mailing List</span>
<a href="#l2.257"></a><span id="l2.257">     // Non-singular, but a hard call.  Namely, it is obvious that a message can</span>
<a href="#l2.258"></a><span id="l2.258">     //  be addressed to multiple mailing lists.  However, I don't see how you</span>
<a href="#l2.259"></a><span id="l2.259">     //  could receive a message with more than one set of List-* headers,</span>
<a href="#l2.260"></a><span id="l2.260">     //  since each list-serve would each send you a copy.  Based on our current</span>
<a href="#l2.261"></a><span id="l2.261">     //  decision to treat each physical message as separate, it almost seems</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineat">@@ -389,17 +389,17 @@ let GlodaFundAttr = {</span>
<a href="#l2.263"></a><span id="l2.263">                         attributeName: &quot;mailing-list&quot;,</span>
<a href="#l2.264"></a><span id="l2.264">                         bind: true,</span>
<a href="#l2.265"></a><span id="l2.265">                         bindName: &quot;mailingLists&quot;,</span>
<a href="#l2.266"></a><span id="l2.266">                         singular: false,</span>
<a href="#l2.267"></a><span id="l2.267">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.268"></a><span id="l2.268">                         objectNoun: Gloda.NOUN_DATE,</span>
<a href="#l2.269"></a><span id="l2.269">                         explanation: this._strBundle.GetStringFromName(</span>
<a href="#l2.270"></a><span id="l2.270">                                        &quot;attrListExplanation&quot;),</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-                        });</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+                        }); // not-tested, not-implemented</span>
<a href="#l2.273"></a><span id="l2.273">   },</span>
<a href="#l2.274"></a><span id="l2.274">   </span>
<a href="#l2.275"></a><span id="l2.275">   /**</span>
<a href="#l2.276"></a><span id="l2.276">    *</span>
<a href="#l2.277"></a><span id="l2.277">    * Specializations:</span>
<a href="#l2.278"></a><span id="l2.278">    * - Mailing Lists.  Replies to a message on a mailing list frequently only</span>
<a href="#l2.279"></a><span id="l2.279">    *   have the list-serve as the 'to', so we try to generate a synthetic 'to'</span>
<a href="#l2.280"></a><span id="l2.280">    *   based on the author of the parent message when possible.  (The 'possible'</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/test/resources/glodaTestHelper.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/test/resources/glodaTestHelper.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -25,16 +25,47 @@ do_import_script(&quot;../mailnews/local/test</span>
<a href="#l3.4"></a><span id="l3.4">  * Convert a list of synthetic messages to a form appropriate to feed to the</span>
<a href="#l3.5"></a><span id="l3.5">  *  POP3 fakeserver.</span>
<a href="#l3.6"></a><span id="l3.6">  */</span>
<a href="#l3.7"></a><span id="l3.7"> function _synthMessagesToFakeRep(aSynthMessages) {</span>
<a href="#l3.8"></a><span id="l3.8">   return [{fileData: msg.toMessageString(), size: -1} for each</span>
<a href="#l3.9"></a><span id="l3.9">           (msg in aSynthMessages)];</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+function imsInit() {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  let ims = indexMessageState;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  if (!ims.inited) {</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    // Disable new mail notifications</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+      .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  </span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  </span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+    Gloda.addIndexerListener(messageIndexerListener.onIndexNotification);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+    ims.catchAllCollection = Gloda._wildcardCollection(Gloda.NOUN_MESSAGE);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+    ims.catchAllCollection.listener = messageCollectionListener;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+    </span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+    // The indexer doesn't need to worry about load; zero his rescheduling time. </span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+    //GlodaIndexer._indexInterval = 0;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    </span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    // set up POP3 fakeserver to feed things in...</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+    [ims.daemon, ims.server] = setupServerDaemon();</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+    ims.incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+    ims.pop3Service = Cc[&quot;@mozilla.org/messenger/popservice;1&quot;]</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+                        .getService(Ci.nsIPop3Service);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+    </span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+    ims.inited = true;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+  }</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+}</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+</span>
<a href="#l3.43"></a><span id="l3.43"> /**</span>
<a href="#l3.44"></a><span id="l3.44">  * Have gloda index the given synthetic messages, calling the verifier function</span>
<a href="#l3.45"></a><span id="l3.45">  *  (with accumulator field) once the message has been succesfully indexed.</span>
<a href="#l3.46"></a><span id="l3.46">  *</span>
<a href="#l3.47"></a><span id="l3.47">  * We use two mechanisms to do this.  One: we create an open-ended message</span>
<a href="#l3.48"></a><span id="l3.48">  *  collection that gets notified whenever a new message hits the scene.  Two:</span>
<a href="#l3.49"></a><span id="l3.49">  *  we register as a notification listener so that we might know when indexing</span>
<a href="#l3.50"></a><span id="l3.50">  *  has completed.</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineat">@@ -54,43 +85,16 @@ function indexMessages(aSynthMessages, a</span>
<a href="#l3.52"></a><span id="l3.52">   let ims = indexMessageState;</span>
<a href="#l3.53"></a><span id="l3.53">   </span>
<a href="#l3.54"></a><span id="l3.54">   ims.inputMessages = aSynthMessages;</span>
<a href="#l3.55"></a><span id="l3.55">   ims.glodaMessages = [];</span>
<a href="#l3.56"></a><span id="l3.56">   ims.verifier = aVerifier;</span>
<a href="#l3.57"></a><span id="l3.57">   ims.previousValue = undefined;</span>
<a href="#l3.58"></a><span id="l3.58">   ims.onDone = aOnDone;</span>
<a href="#l3.59"></a><span id="l3.59"> </span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-  if (!ims.inited) {</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-    // Disable new mail notifications</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-    var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-      .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-  </span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-    prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-    prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-    prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-  </span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-    Gloda.addIndexerListener(messageIndexerListener.onIndexNotification);</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-    ims.catchAllCollection = Gloda._wildcardCollection(Gloda.NOUN_MESSAGE);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-    ims.catchAllCollection.listener = messageCollectionListener;</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-    </span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-    // The indexer doesn't need to worry about load; zero his rescheduling time. </span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-    //GlodaIndexer._indexInterval = 0;</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    </span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-    // set up POP3 fakeserver to feed things in...</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-    [ims.daemon, ims.server] = setupServerDaemon();</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-    ims.incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-    ims.pop3Service = Cc[&quot;@mozilla.org/messenger/popservice;1&quot;]</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-                        .getService(Ci.nsIPop3Service);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-    </span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    ims.inited = true;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-  }</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-  </span>
<a href="#l3.87"></a><span id="l3.87">   ims.daemon.setMessages(_synthMessagesToFakeRep(aSynthMessages));</span>
<a href="#l3.88"></a><span id="l3.88">   do_timeout(0, &quot;driveFakeServer();&quot;);</span>
<a href="#l3.89"></a><span id="l3.89"> }</span>
<a href="#l3.90"></a><span id="l3.90"> </span>
<a href="#l3.91"></a><span id="l3.91"> var indexMessageState = {</span>
<a href="#l3.92"></a><span id="l3.92">   /** have we been initialized (hooked listeners, etc.) */</span>
<a href="#l3.93"></a><span id="l3.93">   inited: false,</span>
<a href="#l3.94"></a><span id="l3.94">   /** our catch-all message collection that nets us all messages passing by */</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineat">@@ -145,16 +149,17 @@ var indexMessageState = {</span>
<a href="#l3.96"></a><span id="l3.96">       </span>
<a href="#l3.97"></a><span id="l3.97">       // we are expecting the gloda indexer to receive some notification as the</span>
<a href="#l3.98"></a><span id="l3.98">       //  result of the new messages showing up, so we don't actually need to</span>
<a href="#l3.99"></a><span id="l3.99">       //  do anything here.</span>
<a href="#l3.100"></a><span id="l3.100">     }</span>
<a href="#l3.101"></a><span id="l3.101">   }</span>
<a href="#l3.102"></a><span id="l3.102"> };</span>
<a href="#l3.103"></a><span id="l3.103"> </span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+</span>
<a href="#l3.105"></a><span id="l3.105"> /**</span>
<a href="#l3.106"></a><span id="l3.106">  * Indicate that we should expect some modified messages to be indexed.</span>
<a href="#l3.107"></a><span id="l3.107">  * </span>
<a href="#l3.108"></a><span id="l3.108">  * @param aMessages The messages that will be modified and we should expect</span>
<a href="#l3.109"></a><span id="l3.109">  *   notifications about.  We currently don't do anything with these other than</span>
<a href="#l3.110"></a><span id="l3.110">  *   count them, so pass whatever you want and it will be the 'source message'</span>
<a href="#l3.111"></a><span id="l3.111">  *   (1st argument) to your verifier function.</span>
<a href="#l3.112"></a><span id="l3.112">  * @param aVerifier See indexMessage's aVerifier argument.</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineat">@@ -262,16 +267,20 @@ var messageCollectionListener = {</span>
<a href="#l3.114"></a><span id="l3.114">  *  been processed.</span>
<a href="#l3.115"></a><span id="l3.115">  */</span>
<a href="#l3.116"></a><span id="l3.116"> var messageIndexerListener = {</span>
<a href="#l3.117"></a><span id="l3.117">   onIndexNotification: function(aStatus, aPrettyName, aJobIndex, aJobTotal,</span>
<a href="#l3.118"></a><span id="l3.118">                                 aJobItemIndex, aJobItemGoal) {</span>
<a href="#l3.119"></a><span id="l3.119">     // we only care if indexing has just completed...</span>
<a href="#l3.120"></a><span id="l3.120">     if (!GlodaIndexer.indexing) {</span>
<a href="#l3.121"></a><span id="l3.121">       let ims = indexMessageState;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+      </span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+      // this is just the synthetic notification if inputMessages is null</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+      if (ims.inputMessages === null)</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+       return;</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127">       // if we haven't seen all the messages we should see, assume that the</span>
<a href="#l3.128"></a><span id="l3.128">       //  rest are on their way, and are just coming in a subsequent job...</span>
<a href="#l3.129"></a><span id="l3.129">       // (Also, the first time we register our listener, we will get a synthetic</span>
<a href="#l3.130"></a><span id="l3.130">       //  idle status; at least if the indexer is idle.)</span>
<a href="#l3.131"></a><span id="l3.131">       if (ims.glodaMessages.length &lt; ims.inputMessages.length) {</span>
<a href="#l3.132"></a><span id="l3.132">         return;</span>
<a href="#l3.133"></a><span id="l3.133">       }</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineat">@@ -477,12 +486,13 @@ function _gh_test_iterator() {</span>
<a href="#l3.135"></a><span id="l3.135">   yield null;</span>
<a href="#l3.136"></a><span id="l3.136"> }</span>
<a href="#l3.137"></a><span id="l3.137"> </span>
<a href="#l3.138"></a><span id="l3.138"> function next_test() {</span>
<a href="#l3.139"></a><span id="l3.139">   glodaHelperIterator.next();</span>
<a href="#l3.140"></a><span id="l3.140"> }</span>
<a href="#l3.141"></a><span id="l3.141"> </span>
<a href="#l3.142"></a><span id="l3.142"> function glodaHelperRunTests(aTests) {</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+  imsInit();</span>
<a href="#l3.144"></a><span id="l3.144">   glodaHelperTests = aTests;</span>
<a href="#l3.145"></a><span id="l3.145">   glodaHelperIterator = _gh_test_iterator();</span>
<a href="#l3.146"></a><span id="l3.146">   next_test();</span>
<a href="#l3.147"></a><span id="l3.147"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/test/unit/test_index_messages.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/test/unit/test_index_messages.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -53,23 +53,26 @@ function test_threading() {</span>
<a href="#l4.4"></a><span id="l4.4">  */</span>
<a href="#l4.5"></a><span id="l4.5"> function test_attributes_fundamental() {</span>
<a href="#l4.6"></a><span id="l4.6">   // create a synthetic message</span>
<a href="#l4.7"></a><span id="l4.7">   let smsg = msgGen.makeMessage();</span>
<a href="#l4.8"></a><span id="l4.8">   </span>
<a href="#l4.9"></a><span id="l4.9">   indexMessages([smsg], verify_attributes_fundamental, next_test);</span>
<a href="#l4.10"></a><span id="l4.10"> }</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-function verify_attributes_fundamental(smsg, gmsg) {  </span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+function verify_attributes_fundamental(smsg, gmsg) {</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  do_check_eq(gmsg.folderURI, gLocalInboxFolder.URI);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  </span>
<a href="#l4.16"></a><span id="l4.16">   // -- subject</span>
<a href="#l4.17"></a><span id="l4.17">   do_check_eq(smsg.subject, gmsg.conversation.subject);</span>
<a href="#l4.18"></a><span id="l4.18">   </span>
<a href="#l4.19"></a><span id="l4.19">   // -- contact/identity information</span>
<a href="#l4.20"></a><span id="l4.20">   // - from</span>
<a href="#l4.21"></a><span id="l4.21">   // check the e-mail address</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  do_check_eq(gmsg.from.kind, &quot;email&quot;);</span>
<a href="#l4.23"></a><span id="l4.23">   do_check_eq(smsg.fromAddress, gmsg.from.value);</span>
<a href="#l4.24"></a><span id="l4.24">   // check the name</span>
<a href="#l4.25"></a><span id="l4.25">   do_check_eq(smsg.fromName, gmsg.from.contact.name);</span>
<a href="#l4.26"></a><span id="l4.26">   </span>
<a href="#l4.27"></a><span id="l4.27">   // - to</span>
<a href="#l4.28"></a><span id="l4.28">   do_check_eq(smsg.toAddress, gmsg.to[0].value);</span>
<a href="#l4.29"></a><span id="l4.29">   do_check_eq(smsg.toName, gmsg.to[0].contact.name);</span>
<a href="#l4.30"></a><span id="l4.30">   </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineat">@@ -143,17 +146,17 @@ const gCopyService = Cc[&quot;@mozilla.org/me</span>
<a href="#l4.32"></a><span id="l4.32">                       .getService(Ci.nsIMsgCopyService);</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34"> function test_message_moving() {</span>
<a href="#l4.35"></a><span id="l4.35">   let rootFolder = gLocalIncomingServer.rootMsgFolder;</span>
<a href="#l4.36"></a><span id="l4.36">   let destFolder = rootFolder.addSubfolder(&quot;move1&quot;);</span>
<a href="#l4.37"></a><span id="l4.37">   </span>
<a href="#l4.38"></a><span id="l4.38">   let moveTestActions = [</span>
<a href="#l4.39"></a><span id="l4.39">     [do_moveMessage, verify_messageLocation, destFolder],</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    [do_moveMessage, verify_messageLocation, gLocalIncomingFolder],</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+    [do_moveMessage, verify_messageLocation, gLocalInboxFolder],</span>
<a href="#l4.42"></a><span id="l4.42">   ];</span>
<a href="#l4.43"></a><span id="l4.43">   </span>
<a href="#l4.44"></a><span id="l4.44">   let smsg = msgGen.makeMessage();</span>
<a href="#l4.45"></a><span id="l4.45">   twiddleAndTest(smsg, moveTestActions);</span>
<a href="#l4.46"></a><span id="l4.46"> }</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48"> /* ===== Message Deletion ===== */</span>
<a href="#l4.49"></a><span id="l4.49"> function test_message_deletion() {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

