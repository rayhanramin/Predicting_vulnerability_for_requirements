<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25466:4b4bc20aa6deba71751a8e0043d9c07b8faeae00</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4b4bc20aa6deba71751a8e0043d9c07b8faeae00" />
<meta property="og:url" content="/comm-central/rev/4b4bc20aa6deba71751a8e0043d9c07b8faeae00" />
<meta property="og:description" content="Bug 1509246 - Create mochitests for existing WebExtension APIs; fix some nits found; r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4b4bc20aa6deba71751a8e0043d9c07b8faeae00 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4b4bc20aa6deba71751a8e0043d9c07b8faeae00">shortlog</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4b4bc20aa6deba71751a8e0043d9c07b8faeae00">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00">files</a> |
changeset |
<a href="/comm-central/raw-rev/4b4bc20aa6deba71751a8e0043d9c07b8faeae00">raw</a>  | <a href="/comm-central/archive/4b4bc20aa6deba71751a8e0043d9c07b8faeae00.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1509246">Bug 1509246</a> - Create mochitests for existing WebExtension APIs; fix some nits found; r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 30 Dec 2018 20:32:25 +1300</td></tr>

<tr>
 <td>changeset 25466</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4b4bc20aa6deba71751a8e0043d9c07b8faeae00">4b4bc20aa6deba71751a8e0043d9c07b8faeae00</a></td>
</tr>



<tr>
<td>parent 25465</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/dde486474a5eb462e8a3c7e935af15edd1e4c9ee">dde486474a5eb462e8a3c7e935af15edd1e4c9ee</a>
</td>
</tr>

<tr>
<td>child 25467</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/71c8bc1307b83cf886b172ea2a788931bad50472">71c8bc1307b83cf886b172ea2a788931bad50472</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4b4bc20aa6deba71751a8e0043d9c07b8faeae00">15283</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 30 Dec 2018 07:33:51 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@da68367e23e5 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=da68367e23e51f72ccd8e1aec01b76eee6732fbd">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=da68367e23e51f72ccd8e1aec01b76eee6732fbd&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=da68367e23e51f72ccd8e1aec01b76eee6732fbd&newProject=comm-central&newRevision=4b4bc20aa6deba71751a8e0043d9c07b8faeae00&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=da68367e23e51f72ccd8e1aec01b76eee6732fbd&newProject=comm-central&newRevision=4b4bc20aa6deba71751a8e0043d9c07b8faeae00&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=da68367e23e51f72ccd8e1aec01b76eee6732fbd&newProject=comm-central&newRevision=4b4bc20aa6deba71751a8e0043d9c07b8faeae00&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1509246">1509246</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1509246">Bug 1509246</a> - Create mochitests for existing WebExtension APIs; fix some nits found; r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/.eslintrc.js">mail/components/extensions/.eslintrc.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/ExtensionToolbarButtons.jsm">mail/components/extensions/ExtensionToolbarButtons.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/ExtensionToolbarButtons.jsm">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/ExtensionToolbarButtons.jsm">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/ExtensionToolbarButtons.jsm">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/ExtensionToolbarButtons.jsm">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/ExtensionToolbarButtons.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/child/.eslintrc.js">mail/components/extensions/child/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/child/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/child/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/child/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/child/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/child/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/moz.build">mail/components/extensions/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/moz.build">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/moz.build">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/moz.build">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/moz.build">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/.eslintrc.js">mail/components/extensions/parent/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/ext-addressBook.js">mail/components/extensions/parent/ext-addressBook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/ext-addressBook.js">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/ext-addressBook.js">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/ext-addressBook.js">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/ext-addressBook.js">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/ext-addressBook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/ext-browserAction.js">mail/components/extensions/parent/ext-browserAction.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/ext-browserAction.js">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/ext-browserAction.js">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/ext-browserAction.js">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/ext-browserAction.js">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/parent/ext-browserAction.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/schemas/addressBook.json">mail/components/extensions/schemas/addressBook.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/schemas/addressBook.json">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/schemas/addressBook.json">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/schemas/addressBook.json">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/schemas/addressBook.json">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/schemas/addressBook.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/.eslintrc.js">mail/components/extensions/test/browser/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser.ini">mail/components/extensions/test/browser/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser.ini">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser.ini">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser.ini">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser.ini">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_addressBooksUI.js">mail/components/extensions/test/browser/browser_ext_addressBooksUI.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_addressBooksUI.js">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_addressBooksUI.js">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_addressBooksUI.js">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_addressBooksUI.js">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_addressBooksUI.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_browserAction.js">mail/components/extensions/test/browser/browser_ext_browserAction.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_browserAction.js">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_browserAction.js">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_browserAction.js">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_browserAction.js">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_browserAction.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_composeAction.js">mail/components/extensions/test/browser/browser_ext_composeAction.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_composeAction.js">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_composeAction.js">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_composeAction.js">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_composeAction.js">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/browser_ext_composeAction.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/head.js">mail/components/extensions/test/browser/head.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/head.js">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/head.js">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/head.js">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/head.js">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/browser/head.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/xpcshell/head.js">mail/components/extensions/test/xpcshell/head.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/xpcshell/head.js">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/xpcshell/head.js">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/xpcshell/head.js">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/xpcshell/head.js">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/xpcshell/head.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">mail/components/extensions/test/xpcshell/test_ext_addressBook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">file</a> |
<a href="/comm-central/annotate/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">annotate</a> |
<a href="/comm-central/diff/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">diff</a> |
<a href="/comm-central/comparison/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">comparison</a> |
<a href="/comm-central/log/4b4bc20aa6deba71751a8e0043d9c07b8faeae00/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">deleted file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- a/mail/components/extensions/.eslintrc.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ /dev/null</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -1,21 +0,0 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineminus">-</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineminus">-module.exports = {</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineminus">-  &quot;globals&quot;: {</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineminus">-    // These are defined in the WebExtension script scopes by ExtensionCommon.jsm.</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineminus">-    // From toolkit/components/extensions/.eslintrc.js.</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-    &quot;Cc&quot;: true,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    &quot;Ci&quot;: true,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    &quot;Cr&quot;: true,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    &quot;Cu&quot;: true,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-    &quot;AppConstants&quot;: true,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    &quot;ExtensionAPI&quot;: true,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-    &quot;ExtensionCommon&quot;: true,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-    &quot;ExtensionUtils&quot;: true,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-    &quot;extensions&quot;: true,</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-    &quot;global&quot;: true,</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-    &quot;require&quot;: false,</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-    &quot;Services&quot;: true,</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-    &quot;XPCOMUtils&quot;: true,</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-  },</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/extensions/ExtensionToolbarButtons.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/extensions/ExtensionToolbarButtons.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l2.5"></a><span id="l2.5"> /* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l2.6"></a><span id="l2.6"> &quot;use strict&quot;;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> this.EXPORTED_SYMBOLS = [&quot;ToolbarButtonAPI&quot;];</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;Services&quot;, &quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> ChromeUtils.defineModuleGetter(this, &quot;ViewPopup&quot;, &quot;resource:///modules/ExtensionPopups.jsm&quot;);</span>
<a href="#l2.12"></a><span id="l2.12"> ChromeUtils.defineModuleGetter(this, &quot;ExtensionSupport&quot;, &quot;resource:///modules/extensionSupport.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13"> ChromeUtils.import(&quot;resource://gre/modules/ExtensionCommon.jsm&quot;);</span>
<a href="#l2.14"></a><span id="l2.14"> ChromeUtils.import(&quot;resource://gre/modules/ExtensionUtils.jsm&quot;);</span>
<a href="#l2.15"></a><span id="l2.15"> ChromeUtils.import(&quot;resource://gre/modules/ExtensionParent.jsm&quot;);</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> const {</span>
<a href="#l2.18"></a><span id="l2.18">   EventManager,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineat">@@ -77,28 +78,24 @@ this.ToolbarButtonAPI = class extends Ex</span>
<a href="#l2.20"></a><span id="l2.20">         () =&gt; this.getIconData(this.defaults.icon)));</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">     ExtensionSupport.registerWindowListener(this.id, {</span>
<a href="#l2.23"></a><span id="l2.23">       chromeURLs: this.windowURLs,</span>
<a href="#l2.24"></a><span id="l2.24">       onLoadWindow: window =&gt; {</span>
<a href="#l2.25"></a><span id="l2.25">         this.paint(window);</span>
<a href="#l2.26"></a><span id="l2.26">       },</span>
<a href="#l2.27"></a><span id="l2.27">     });</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+    extension.callOnClose(this);</span>
<a href="#l2.30"></a><span id="l2.30">   }</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32">   /**</span>
<a href="#l2.33"></a><span id="l2.33">    * Called when the extension is disabled or removed.</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-   *</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-   * @param reason</span>
<a href="#l2.36"></a><span id="l2.36">    */</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  onShutdown(reason) {</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-    if (reason === &quot;APP_SHUTDOWN&quot;) {</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-      return;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-    }</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  close() {</span>
<a href="#l2.43"></a><span id="l2.43">     ExtensionSupport.unregisterWindowListener(this.id);</span>
<a href="#l2.44"></a><span id="l2.44">     for (let window of ExtensionSupport.openWindows) {</span>
<a href="#l2.45"></a><span id="l2.45">       if (this.windowURLs.includes(window.location.href)) {</span>
<a href="#l2.46"></a><span id="l2.46">         this.unpaint(window);</span>
<a href="#l2.47"></a><span id="l2.47">       }</span>
<a href="#l2.48"></a><span id="l2.48">     }</span>
<a href="#l2.49"></a><span id="l2.49">   }</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51" class="difflineat">@@ -347,44 +344,47 @@ this.ToolbarButtonAPI = class extends Ex</span>
<a href="#l2.52"></a><span id="l2.52">   }</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">   /**</span>
<a href="#l2.55"></a><span id="l2.55">    * Update the toolbar button for a given window.</span>
<a href="#l2.56"></a><span id="l2.56">    *</span>
<a href="#l2.57"></a><span id="l2.57">    * @param {ChromeWindow} window</span>
<a href="#l2.58"></a><span id="l2.58">    *        Browser chrome window.</span>
<a href="#l2.59"></a><span id="l2.59">    */</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-  updateWindow(window) {</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  async updateWindow(window) {</span>
<a href="#l2.62"></a><span id="l2.62">     let button = window.document.getElementById(this.id);</span>
<a href="#l2.63"></a><span id="l2.63">     if (button) {</span>
<a href="#l2.64"></a><span id="l2.64">       this.updateButton(button, this.globals);</span>
<a href="#l2.65"></a><span id="l2.65">     }</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    await new Promise(window.requestAnimationFrame);</span>
<a href="#l2.67"></a><span id="l2.67">   }</span>
<a href="#l2.68"></a><span id="l2.68"> </span>
<a href="#l2.69"></a><span id="l2.69">   /**</span>
<a href="#l2.70"></a><span id="l2.70">    * Update the toolbar button when the extension changes the icon, title, url, etc.</span>
<a href="#l2.71"></a><span id="l2.71">    * If it only changes a parameter for a single tab, `target` will be that tab.</span>
<a href="#l2.72"></a><span id="l2.72">    * If it only changes a parameter for a single window, `target` will be that window.</span>
<a href="#l2.73"></a><span id="l2.73">    * Otherwise `target` will be null.</span>
<a href="#l2.74"></a><span id="l2.74">    *</span>
<a href="#l2.75"></a><span id="l2.75">    * @param {XULElement|ChromeWindow|null} target</span>
<a href="#l2.76"></a><span id="l2.76">    *        Browser tab or browser chrome window, may be null.</span>
<a href="#l2.77"></a><span id="l2.77">    */</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-  updateOnChange(target) {</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  async updateOnChange(target) {</span>
<a href="#l2.80"></a><span id="l2.80">     if (target) {</span>
<a href="#l2.81"></a><span id="l2.81">       let window = target.ownerGlobal;</span>
<a href="#l2.82"></a><span id="l2.82">       if (target === window || target.selected) {</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-        this.updateWindow(window);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+        await this.updateWindow(window);</span>
<a href="#l2.85"></a><span id="l2.85">       }</span>
<a href="#l2.86"></a><span id="l2.86">     } else {</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+      let promises = [];</span>
<a href="#l2.88"></a><span id="l2.88">       for (let window of ExtensionSupport.openWindows) {</span>
<a href="#l2.89"></a><span id="l2.89">         if (this.windowURLs.includes(window.location.href)) {</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-          this.updateWindow(window);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+          promises.push(this.updateWindow(window));</span>
<a href="#l2.92"></a><span id="l2.92">         }</span>
<a href="#l2.93"></a><span id="l2.93">       }</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+      await Promise.all(promises);</span>
<a href="#l2.95"></a><span id="l2.95">     }</span>
<a href="#l2.96"></a><span id="l2.96">   }</span>
<a href="#l2.97"></a><span id="l2.97"> </span>
<a href="#l2.98"></a><span id="l2.98">   /**</span>
<a href="#l2.99"></a><span id="l2.99">    * Gets the target object and its associated values corresponding to</span>
<a href="#l2.100"></a><span id="l2.100">    * the `details` parameter of the various get* and set* API methods.</span>
<a href="#l2.101"></a><span id="l2.101">    *</span>
<a href="#l2.102"></a><span id="l2.102">    * @param {Object} details</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineat">@@ -422,25 +422,25 @@ this.ToolbarButtonAPI = class extends Ex</span>
<a href="#l2.104"></a><span id="l2.104">    * @param {Object} details</span>
<a href="#l2.105"></a><span id="l2.105">    *        An object with optional `tabId` or `windowId` properties.</span>
<a href="#l2.106"></a><span id="l2.106">    * @param {string} prop</span>
<a href="#l2.107"></a><span id="l2.107">    *        String property to set. Should should be one of &quot;icon&quot;, &quot;title&quot;,</span>
<a href="#l2.108"></a><span id="l2.108">    *        &quot;badgeText&quot;, &quot;popup&quot;, &quot;badgeBackgroundColor&quot; or &quot;enabled&quot;.</span>
<a href="#l2.109"></a><span id="l2.109">    * @param {string} value</span>
<a href="#l2.110"></a><span id="l2.110">    *        Value for prop.</span>
<a href="#l2.111"></a><span id="l2.111">    */</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-  setProperty(details, prop, value) {</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+  async setProperty(details, prop, value) {</span>
<a href="#l2.114"></a><span id="l2.114">     let {target, values} = this.getContextData(details);</span>
<a href="#l2.115"></a><span id="l2.115">     if (value === null) {</span>
<a href="#l2.116"></a><span id="l2.116">       delete values[prop];</span>
<a href="#l2.117"></a><span id="l2.117">     } else {</span>
<a href="#l2.118"></a><span id="l2.118">       values[prop] = value;</span>
<a href="#l2.119"></a><span id="l2.119">     }</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-    this.updateOnChange(target);</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+    await this.updateOnChange(target);</span>
<a href="#l2.123"></a><span id="l2.123">   }</span>
<a href="#l2.124"></a><span id="l2.124"> </span>
<a href="#l2.125"></a><span id="l2.125">   /**</span>
<a href="#l2.126"></a><span id="l2.126">    * Retrieve the value of a global, window specific or tab specific property.</span>
<a href="#l2.127"></a><span id="l2.127">    *</span>
<a href="#l2.128"></a><span id="l2.128">    * @param {Object} details</span>
<a href="#l2.129"></a><span id="l2.129">    *        An object with optional `tabId` or `windowId` properties.</span>
<a href="#l2.130"></a><span id="l2.130">    * @param {string} prop</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineat">@@ -475,82 +475,82 @@ this.ToolbarButtonAPI = class extends Ex</span>
<a href="#l2.132"></a><span id="l2.132">             };</span>
<a href="#l2.133"></a><span id="l2.133">             action.on(&quot;click&quot;, listener);</span>
<a href="#l2.134"></a><span id="l2.134">             return () =&gt; {</span>
<a href="#l2.135"></a><span id="l2.135">               action.off(&quot;click&quot;, listener);</span>
<a href="#l2.136"></a><span id="l2.136">             };</span>
<a href="#l2.137"></a><span id="l2.137">           },</span>
<a href="#l2.138"></a><span id="l2.138">         }).api(),</span>
<a href="#l2.139"></a><span id="l2.139"> </span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-        enable(tabId) {</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-          action.setProperty({tabId}, &quot;enabled&quot;, true);</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+        async enable(tabId) {</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+          await action.setProperty({tabId}, &quot;enabled&quot;, true);</span>
<a href="#l2.144"></a><span id="l2.144">         },</span>
<a href="#l2.145"></a><span id="l2.145"> </span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-        disable(tabId) {</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-          action.setProperty({tabId}, &quot;enabled&quot;, false);</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+        async disable(tabId) {</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+          await action.setProperty({tabId}, &quot;enabled&quot;, false);</span>
<a href="#l2.150"></a><span id="l2.150">         },</span>
<a href="#l2.151"></a><span id="l2.151"> </span>
<a href="#l2.152"></a><span id="l2.152">         isEnabled(details) {</span>
<a href="#l2.153"></a><span id="l2.153">           return action.getProperty(details, &quot;enabled&quot;);</span>
<a href="#l2.154"></a><span id="l2.154">         },</span>
<a href="#l2.155"></a><span id="l2.155"> </span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-        setTitle(details) {</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-          action.setProperty(details, &quot;title&quot;, details.title);</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+        async setTitle(details) {</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+          await action.setProperty(details, &quot;title&quot;, details.title);</span>
<a href="#l2.160"></a><span id="l2.160">         },</span>
<a href="#l2.161"></a><span id="l2.161"> </span>
<a href="#l2.162"></a><span id="l2.162">         getTitle(details) {</span>
<a href="#l2.163"></a><span id="l2.163">           return action.getProperty(details, &quot;title&quot;);</span>
<a href="#l2.164"></a><span id="l2.164">         },</span>
<a href="#l2.165"></a><span id="l2.165"> </span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-        setIcon(details) {</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+        async setIcon(details) {</span>
<a href="#l2.168"></a><span id="l2.168">           details.iconType = this.manifestName;</span>
<a href="#l2.169"></a><span id="l2.169"> </span>
<a href="#l2.170"></a><span id="l2.170">           let icon = IconDetails.normalize(details, extension, context);</span>
<a href="#l2.171"></a><span id="l2.171">           if (!Object.keys(icon).length) {</span>
<a href="#l2.172"></a><span id="l2.172">             icon = null;</span>
<a href="#l2.173"></a><span id="l2.173">           }</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-          action.setProperty(details, &quot;icon&quot;, icon);</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+          await action.setProperty(details, &quot;icon&quot;, icon);</span>
<a href="#l2.176"></a><span id="l2.176">         },</span>
<a href="#l2.177"></a><span id="l2.177"> </span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-        setBadgeText(details) {</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-          action.setProperty(details, &quot;badgeText&quot;, details.text);</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+        async setBadgeText(details) {</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+          await action.setProperty(details, &quot;badgeText&quot;, details.text);</span>
<a href="#l2.182"></a><span id="l2.182">         },</span>
<a href="#l2.183"></a><span id="l2.183"> </span>
<a href="#l2.184"></a><span id="l2.184">         getBadgeText(details) {</span>
<a href="#l2.185"></a><span id="l2.185">           return action.getProperty(details, &quot;badgeText&quot;);</span>
<a href="#l2.186"></a><span id="l2.186">         },</span>
<a href="#l2.187"></a><span id="l2.187"> </span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-        setPopup(details) {</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+        async setPopup(details) {</span>
<a href="#l2.190"></a><span id="l2.190">           // Note: Chrome resolves arguments to setIcon relative to the calling</span>
<a href="#l2.191"></a><span id="l2.191">           // context, but resolves arguments to setPopup relative to the extension</span>
<a href="#l2.192"></a><span id="l2.192">           // root.</span>
<a href="#l2.193"></a><span id="l2.193">           // For internal consistency, we currently resolve both relative to the</span>
<a href="#l2.194"></a><span id="l2.194">           // calling context.</span>
<a href="#l2.195"></a><span id="l2.195">           let url = details.popup &amp;&amp; context.uri.resolve(details.popup);</span>
<a href="#l2.196"></a><span id="l2.196">           if (url &amp;&amp; !context.checkLoadURL(url)) {</span>
<a href="#l2.197"></a><span id="l2.197">             return Promise.reject({message: `Access denied for URL ${url}`});</span>
<a href="#l2.198"></a><span id="l2.198">           }</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-          action.setProperty(details, &quot;popup&quot;, url);</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+          await action.setProperty(details, &quot;popup&quot;, url);</span>
<a href="#l2.201"></a><span id="l2.201">           return Promise.resolve(null);</span>
<a href="#l2.202"></a><span id="l2.202">         },</span>
<a href="#l2.203"></a><span id="l2.203"> </span>
<a href="#l2.204"></a><span id="l2.204">         getPopup(details) {</span>
<a href="#l2.205"></a><span id="l2.205">           return action.getProperty(details, &quot;popup&quot;);</span>
<a href="#l2.206"></a><span id="l2.206">         },</span>
<a href="#l2.207"></a><span id="l2.207"> </span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-        setBadgeBackgroundColor(details) {</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+        async setBadgeBackgroundColor(details) {</span>
<a href="#l2.210"></a><span id="l2.210">           let color = details.color;</span>
<a href="#l2.211"></a><span id="l2.211">           if (typeof color == &quot;string&quot;) {</span>
<a href="#l2.212"></a><span id="l2.212">             let col = InspectorUtils.colorToRGBA(color);</span>
<a href="#l2.213"></a><span id="l2.213">             if (!col) {</span>
<a href="#l2.214"></a><span id="l2.214">               throw new ExtensionError(`Invalid badge background color: &quot;${color}&quot;`);</span>
<a href="#l2.215"></a><span id="l2.215">             }</span>
<a href="#l2.216"></a><span id="l2.216">             color = col &amp;&amp; [col.r, col.g, col.b, Math.round(col.a * 255)];</span>
<a href="#l2.217"></a><span id="l2.217">           }</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-          action.setProperty(details, &quot;badgeBackgroundColor&quot;, color);</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+          await action.setProperty(details, &quot;badgeBackgroundColor&quot;, color);</span>
<a href="#l2.220"></a><span id="l2.220">         },</span>
<a href="#l2.221"></a><span id="l2.221"> </span>
<a href="#l2.222"></a><span id="l2.222">         getBadgeBackgroundColor(details, callback) {</span>
<a href="#l2.223"></a><span id="l2.223">           let color = action.getProperty(details, &quot;badgeBackgroundColor&quot;);</span>
<a href="#l2.224"></a><span id="l2.224">           return color || [0xd9, 0, 0, 255];</span>
<a href="#l2.225"></a><span id="l2.225">         },</span>
<a href="#l2.226"></a><span id="l2.226"> </span>
<a href="#l2.227"></a><span id="l2.227">         openPopup() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/extensions/child/.eslintrc.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/extensions/child/.eslintrc.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,8 +1,13 @@</span>
<a href="#l3.4"></a><span id="l3.4"> &quot;use strict&quot;;</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> module.exports = {</span>
<a href="#l3.7"></a><span id="l3.7">   &quot;globals&quot;: {</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+    // These are defined in the WebExtension script scopes by ExtensionCommon.jsm.</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+    // From toolkit/components/extensions/.eslintrc.js.</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+    &quot;ExtensionAPI&quot;: true,</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+    &quot;extensions&quot;: true,</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+</span>
<a href="#l3.13"></a><span id="l3.13">     // From toolkit/components/extensions/child/.eslintrc.js.</span>
<a href="#l3.14"></a><span id="l3.14">     &quot;EventManager&quot;: true,</span>
<a href="#l3.15"></a><span id="l3.15">   },</span>
<a href="#l3.16"></a><span id="l3.16"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/extensions/moz.build</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/extensions/moz.build</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -8,11 +8,14 @@ EXTRA_COMPONENTS += [</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> EXTRA_JS_MODULES += [</span>
<a href="#l4.6"></a><span id="l4.6">     'ExtensionPopups.jsm',</span>
<a href="#l4.7"></a><span id="l4.7">     'ExtensionToolbarButtons.jsm',</span>
<a href="#l4.8"></a><span id="l4.8"> ]</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+BROWSER_CHROME_MANIFESTS += [</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    'test/browser/browser.ini'</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+]</span>
<a href="#l4.15"></a><span id="l4.15"> XPCSHELL_TESTS_MANIFESTS += [</span>
<a href="#l4.16"></a><span id="l4.16">     'test/xpcshell/xpcshell.ini',</span>
<a href="#l4.17"></a><span id="l4.17"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/extensions/parent/.eslintrc.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/extensions/parent/.eslintrc.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,12 +1,21 @@</span>
<a href="#l5.4"></a><span id="l5.4"> &quot;use strict&quot;;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> module.exports = {</span>
<a href="#l5.7"></a><span id="l5.7">   &quot;globals&quot;: {</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+    // These are defined in the WebExtension script scopes by ExtensionCommon.jsm.</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+    // From toolkit/components/extensions/.eslintrc.js.</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+    &quot;ExtensionAPI&quot;: true,</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+    &quot;ExtensionCommon&quot;: true,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    &quot;ExtensionUtils&quot;: true,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    &quot;extensions&quot;: true,</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    &quot;global&quot;: true,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+    &quot;Services&quot;: true,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+</span>
<a href="#l5.17"></a><span id="l5.17">     // From toolkit/components/extensions/parent/.eslintrc.js.</span>
<a href="#l5.18"></a><span id="l5.18">     &quot;CONTAINER_STORE&quot;: true,</span>
<a href="#l5.19"></a><span id="l5.19">     &quot;DEFAULT_STORE&quot;: true,</span>
<a href="#l5.20"></a><span id="l5.20">     &quot;EventEmitter&quot;: true,</span>
<a href="#l5.21"></a><span id="l5.21">     &quot;EventManager&quot;: true,</span>
<a href="#l5.22"></a><span id="l5.22">     &quot;InputEventManager&quot;: true,</span>
<a href="#l5.23"></a><span id="l5.23">     &quot;PRIVATE_STORE&quot;: true,</span>
<a href="#l5.24"></a><span id="l5.24">     &quot;TabBase&quot;: true,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-addressBook.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-addressBook.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,14 +1,12 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-const uuidGenerator = Cc[&quot;@mozilla.org/uuid-generator;1&quot;].getService(Ci.nsIUUIDGenerator);</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l6.12"></a><span id="l6.12"> </span>
<a href="#l6.13"></a><span id="l6.13"> const AB_WINDOW_TYPE = &quot;mail:addressbook&quot;;</span>
<a href="#l6.14"></a><span id="l6.14"> const AB_WINDOW_URI = &quot;chrome://messenger/content/addressbook/addressbook.xul&quot;;</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> const kPABDirectory = 2; // defined in nsDirPrefs.h</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18" class="difflineat">@@ -281,25 +279,25 @@ var cache = new class extends EventEmitt</span>
<a href="#l6.19"></a><span id="l6.19">     }</span>
<a href="#l6.20"></a><span id="l6.20">   }</span>
<a href="#l6.21"></a><span id="l6.21"> };</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23"> this.addressBook = class extends ExtensionAPI {</span>
<a href="#l6.24"></a><span id="l6.24">   getAPI(context) {</span>
<a href="#l6.25"></a><span id="l6.25">     return {</span>
<a href="#l6.26"></a><span id="l6.26">       addressBooks: {</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-        openUI() {</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+        async openUI() {</span>
<a href="#l6.29"></a><span id="l6.29">           let topWindow = Services.wm.getMostRecentWindow(AB_WINDOW_TYPE);</span>
<a href="#l6.30"></a><span id="l6.30">           if (!topWindow) {</span>
<a href="#l6.31"></a><span id="l6.31">             // TODO: wait until window is loaded before resolving</span>
<a href="#l6.32"></a><span id="l6.32">             topWindow = Services.ww.openWindow(null, AB_WINDOW_URI, &quot;_blank&quot;, &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;, null);</span>
<a href="#l6.33"></a><span id="l6.33">           }</span>
<a href="#l6.34"></a><span id="l6.34">           topWindow.focus();</span>
<a href="#l6.35"></a><span id="l6.35">         },</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-        closeUI() {</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+        async closeUI() {</span>
<a href="#l6.38"></a><span id="l6.38">           for (let win of Services.wm.getEnumerator(AB_WINDOW_TYPE)) {</span>
<a href="#l6.39"></a><span id="l6.39">             win.close();</span>
<a href="#l6.40"></a><span id="l6.40">           }</span>
<a href="#l6.41"></a><span id="l6.41">         },</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43">         list(complete = false) {</span>
<a href="#l6.44"></a><span id="l6.44">           return cache.convert(cache.tree, complete);</span>
<a href="#l6.45"></a><span id="l6.45">         },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-browserAction.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-browserAction.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -11,18 +11,18 @@ this.browserAction = class extends Toolb</span>
<a href="#l7.4"></a><span id="l7.4">     return browserActionMap.get(extension);</span>
<a href="#l7.5"></a><span id="l7.5">   }</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7">   async onManifestEntry(entryName) {</span>
<a href="#l7.8"></a><span id="l7.8">     await super.onManifestEntry(entryName);</span>
<a href="#l7.9"></a><span id="l7.9">     browserActionMap.set(this.extension, this);</span>
<a href="#l7.10"></a><span id="l7.10">   }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  onShutdown(reason) {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-    super.onShutdown(reason);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  close() {</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+    super.close();</span>
<a href="#l7.16"></a><span id="l7.16">     browserActionMap.delete(this.extension);</span>
<a href="#l7.17"></a><span id="l7.17">   }</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">   constructor(extension) {</span>
<a href="#l7.20"></a><span id="l7.20">     super(extension);</span>
<a href="#l7.21"></a><span id="l7.21">     this.manifest_name = &quot;browser_action&quot;;</span>
<a href="#l7.22"></a><span id="l7.22">     this.manifestName = &quot;browserAction&quot;;</span>
<a href="#l7.23"></a><span id="l7.23">     this.windowURLs = [&quot;chrome://messenger/content/messenger.xul&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/extensions/schemas/addressBook.json</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/extensions/schemas/addressBook.json</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -75,22 +75,24 @@</span>
<a href="#l8.4"></a><span id="l8.4">           }</span>
<a href="#l8.5"></a><span id="l8.5">         }</span>
<a href="#l8.6"></a><span id="l8.6">       }</span>
<a href="#l8.7"></a><span id="l8.7">     ],</span>
<a href="#l8.8"></a><span id="l8.8">     &quot;functions&quot;: [</span>
<a href="#l8.9"></a><span id="l8.9">       {</span>
<a href="#l8.10"></a><span id="l8.10">         &quot;name&quot;: &quot;openUI&quot;,</span>
<a href="#l8.11"></a><span id="l8.11">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+        &quot;async&quot;: true,</span>
<a href="#l8.13"></a><span id="l8.13">         &quot;description&quot;: &quot;Opens the address book user interface.&quot;,</span>
<a href="#l8.14"></a><span id="l8.14">         &quot;parameters&quot;: []</span>
<a href="#l8.15"></a><span id="l8.15">       },</span>
<a href="#l8.16"></a><span id="l8.16">       {</span>
<a href="#l8.17"></a><span id="l8.17">         &quot;name&quot;: &quot;closeUI&quot;,</span>
<a href="#l8.18"></a><span id="l8.18">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+        &quot;async&quot;: true,</span>
<a href="#l8.20"></a><span id="l8.20">         &quot;description&quot;: &quot;Closes the address book user interface.&quot;,</span>
<a href="#l8.21"></a><span id="l8.21">         &quot;parameters&quot;: []</span>
<a href="#l8.22"></a><span id="l8.22">       },</span>
<a href="#l8.23"></a><span id="l8.23">       {</span>
<a href="#l8.24"></a><span id="l8.24">         &quot;name&quot;: &quot;list&quot;,</span>
<a href="#l8.25"></a><span id="l8.25">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l8.26"></a><span id="l8.26">         &quot;async&quot;: true,</span>
<a href="#l8.27"></a><span id="l8.27">         &quot;parameters&quot;: [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mail/components/extensions/test/browser/.eslintrc.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,13 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+module.exports = {</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+  &quot;extends&quot;: &quot;plugin:mozilla/browser-test&quot;,</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+  &quot;env&quot;: {</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+    &quot;webextensions&quot;: true,</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  },</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  &quot;rules&quot;: {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+    &quot;func-names&quot;: &quot;off&quot;,</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  },</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser.ini</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,8 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+head = head.js</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+tags = webextensions</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+[browser_ext_addressBooksUI.js]</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+[browser_ext_browserAction.js]</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+[browser_ext_composeAction.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_addressBooksUI.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,46 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+  async function background() {</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+    let awaitMessage = function(messageToSend, ...sendArgs) {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+      return new Promise(resolve =&gt; {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+        browser.test.onMessage.addListener(function listener(...args) {</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+          browser.test.onMessage.removeListener(listener);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+          resolve(args);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+        });</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+        if (messageToSend) {</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+          browser.test.sendMessage(messageToSend, ...sendArgs);</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+        }</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+      });</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+    };</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+    await awaitMessage(&quot;checkNumberOfAddressBookWindows&quot;, 0);</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+    await browser.addressBooks.openUI();</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+    await awaitMessage(&quot;checkNumberOfAddressBookWindows&quot;, 1);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+    await browser.addressBooks.openUI();</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+    await awaitMessage(&quot;checkNumberOfAddressBookWindows&quot;, 1);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+    await browser.addressBooks.closeUI();</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+    await awaitMessage(&quot;checkNumberOfAddressBookWindows&quot;, 0);</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+    browser.test.notifyPass(&quot;addressBooks&quot;);</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  }</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+  let extension = ExtensionTestUtils.loadExtension({</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+    background,</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+    manifest: { permissions: [&quot;addressBooks&quot;] },</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+  });</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+  extension.onMessage(&quot;checkNumberOfAddressBookWindows&quot;, (count) =&gt; {</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+    is([...Services.wm.getEnumerator(&quot;mail:addressbook&quot;)].length, count, &quot;Right number of address books open&quot;);</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+    extension.sendMessage();</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+  });</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+  await extension.startup();</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+  await extension.awaitFinish(&quot;addressBooks&quot;);</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+  await extension.unload();</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_browserAction.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,96 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+  async function test_it(extension) {</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+    await extension.startup();</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    let buttonId = &quot;test1_mochi_test-browserAction-toolbarbutton&quot;;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+    let toolbar = document.getElementById(&quot;mail-bar3&quot;);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+    ok(!toolbar.getAttribute(&quot;currentset&quot;), &quot;No toolbar current set&quot;);</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+    let button = document.getElementById(buttonId);</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+    ok(button, &quot;Button created&quot;);</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+    is(toolbar.id, button.parentNode.id, &quot;Button added to toolbar&quot;);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+    ok(toolbar.currentSet.split(&quot;,&quot;).includes(buttonId), &quot;Button added to toolbar current set&quot;);</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+    let icon = document.getAnonymousElementByAttribute(</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+      button, &quot;class&quot;, &quot;toolbarbutton-icon&quot;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+    );</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+    is(getComputedStyle(icon).listStyleImage,</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+       `url(&quot;chrome://messenger/content/extension.svg&quot;)`, &quot;Default icon&quot;);</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+    let label = document.getAnonymousElementByAttribute(</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+      button, &quot;class&quot;, &quot;toolbarbutton-text&quot;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+    );</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+    is(label.value, &quot;This is a test&quot;, &quot;Correct label&quot;);</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+    EventUtils.synthesizeMouseAtCenter(button, { clickCount: 1 });</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+    await extension.awaitFinish(&quot;browserAction&quot;);</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+    await promiseAnimationFrame();</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+    is(document.getElementById(buttonId), button);</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+    label = document.getAnonymousElementByAttribute(</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+      button, &quot;class&quot;, &quot;toolbarbutton-text&quot;</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+    );</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+    is(label.value, &quot;New title&quot;, &quot;Correct label&quot;);</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+    await extension.unload();</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+    await promiseAnimationFrame();</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+    ok(!document.getElementById(buttonId), &quot;Button destroyed&quot;);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+  }</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+  async function background_nopopup() {</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+    browser.browserAction.onClicked.addListener(async () =&gt; {</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+      await browser.browserAction.setTitle({ title: &quot;New title&quot; });</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+      await new Promise(setTimeout);</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+      browser.test.notifyPass(&quot;browserAction&quot;);</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+    });</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+  }</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+  async function background_popup() {</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+    browser.runtime.onMessage.addListener(async (msg) =&gt; {</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+      browser.test.assertEq(&quot;popup.html&quot;, msg);</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+      await browser.browserAction.setTitle({ title: &quot;New title&quot; });</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+      await new Promise(setTimeout);</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+      browser.test.notifyPass(&quot;browserAction&quot;);</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+    });</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+  }</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+  let extensionDetails = {</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+    background: background_nopopup,</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+    files: {</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+      &quot;popup.html&quot;: `&lt;html&gt;</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+          &lt;head&gt;</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+            &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+            &lt;script src=&quot;popup.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+          &lt;/head&gt;</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+          &lt;body&gt;popup.js&lt;/body&gt;</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+        &lt;/html&gt;`,</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+      &quot;popup.js&quot;: function() {</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+        window.onload = async () =&gt; {</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+          await browser.runtime.sendMessage(&quot;popup.html&quot;);</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+          window.close();</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+        };</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+      },</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+    },</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+    manifest: {</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+      applications: {</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+        gecko: {</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+          id: &quot;test1@mochi.test&quot;,</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+        },</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+      },</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+      browser_action: {</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+        default_title: &quot;This is a test&quot;,</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+      },</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+    },</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+  };</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+  let extension = ExtensionTestUtils.loadExtension(extensionDetails);</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+  await test_it(extension);</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+  extensionDetails.background = background_popup;</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+  extensionDetails.manifest.browser_action.default_popup = &quot;popup.html&quot;;</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  extension = ExtensionTestUtils.loadExtension(extensionDetails);</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+  await test_it(extension);</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_composeAction.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,152 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+let gAccount;</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+async function openComposeWindow() {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+  let params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+                 .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+  let composeFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+                        .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+  params.identity = gAccount.defaultIdentity;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+  params.composeFields = composeFields;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+  await new Promise(resolve =&gt; {</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+    let observer = {</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+      observe(subject, topic, data) {</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+        Services.ww.unregisterNotification(observer);</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+        subject.addEventListener(&quot;load&quot;, () =&gt; {</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+          promiseAnimationFrame().then(resolve);</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+        }, { once: true });</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+      },</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+    };</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+    Services.ww.registerNotification(observer);</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+    MailServices.compose.OpenComposeWindowWithParams(null, params);</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  });</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+  return Services.wm.getMostRecentWindow(&quot;msgcompose&quot;);</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+}</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+async function test_it(extensionDetails, toolbarId) {</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  let extension = ExtensionTestUtils.loadExtension(extensionDetails);</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+  let buttonId = &quot;test1_mochi_test-composeAction-toolbarbutton&quot;;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  await extension.startup();</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+  await extension.awaitMessage();</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+  let composeWindow = await openComposeWindow();</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+  let composeDocument = composeWindow.document;</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+  await promiseAnimationFrame(composeWindow);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+  try {</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+    let toolbar = composeDocument.getElementById(toolbarId);</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+    ok(!toolbar.getAttribute(&quot;currentset&quot;), &quot;No toolbar current set&quot;);</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+    let button = composeDocument.getElementById(buttonId);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+    ok(button, &quot;Button created&quot;);</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+    is(getComputedStyle(button).MozBinding,</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+      `url(&quot;chrome://global/content/bindings/toolbarbutton.xml#toolbarbutton-badged&quot;)`);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+    is(toolbar.id, button.parentNode.id, &quot;Button added to toolbar&quot;);</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+    ok(toolbar.currentSet.split(&quot;,&quot;).includes(buttonId), &quot;Button added to toolbar current set&quot;);</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+    let icon = composeDocument.getAnonymousElementByAttribute(button, &quot;class&quot;, &quot;toolbarbutton-icon&quot;);</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+    is(getComputedStyle(icon).listStyleImage,</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+       `url(&quot;chrome://messenger/content/extension.svg&quot;)`, &quot;Default icon&quot;);</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+    let label = composeDocument.getAnonymousElementByAttribute(</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+      button, &quot;class&quot;, &quot;toolbarbutton-text&quot;</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+    );</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+    is(label.value, &quot;This is a test&quot;, &quot;Correct label&quot;);</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+    EventUtils.synthesizeMouseAtCenter(button, { clickCount: 1 }, composeWindow);</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+    await extension.awaitFinish(&quot;composeAction&quot;);</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+    await promiseAnimationFrame(composeWindow);</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+    is(composeDocument.getElementById(buttonId), button);</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+    label = composeDocument.getAnonymousElementByAttribute(</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+      button, &quot;class&quot;, &quot;toolbarbutton-text&quot;</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+    );</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+    is(label.value, &quot;New title&quot;, &quot;Correct label&quot;);</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+  } finally {</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    await extension.unload();</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+    await promiseAnimationFrame(composeWindow);</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+    ok(!composeDocument.getElementById(buttonId), &quot;Button destroyed&quot;);</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+    composeWindow.close();</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+  }</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+}</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+add_task(async function setup() {</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+  gAccount = createAccount();</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+  addIdentity(gAccount);</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+  let rootFolder = gAccount.incomingServer.rootFolder;</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+  window.gFolderTreeView.selectFolder(rootFolder);</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+  await new Promise(executeSoon);</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+});</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+add_task(async function the_test() {</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+  async function background_nopopup() {</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+    browser.test.log(&quot;nopopup background script ran&quot;);</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+    browser.composeAction.onClicked.addListener(async () =&gt; {</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+      await browser.composeAction.setTitle({ title: &quot;New title&quot; });</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+      await new Promise(setTimeout);</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+      browser.test.notifyPass(&quot;composeAction&quot;);</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+    });</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+    browser.test.sendMessage();</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+  }</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+  async function background_popup() {</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+    browser.test.log(&quot;popup background script ran&quot;);</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+    browser.runtime.onMessage.addListener(async (msg) =&gt; {</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+      browser.test.assertEq(&quot;popup.html&quot;, msg);</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+      await browser.composeAction.setTitle({ title: &quot;New title&quot; });</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+      await new Promise(setTimeout);</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+      browser.test.notifyPass(&quot;composeAction&quot;);</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+    });</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+    browser.test.sendMessage();</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+  }</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+  let extensionDetails = {</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+    background: background_nopopup,</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+    files: {</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+      &quot;popup.html&quot;: `&lt;html&gt;</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+          &lt;head&gt;</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+            &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+            &lt;script src=&quot;popup.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+          &lt;/head&gt;</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+          &lt;body&gt;popup.js&lt;/body&gt;</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+        &lt;/html&gt;`,</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+      &quot;popup.js&quot;: function() {</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+        window.onload = async () =&gt; {</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+          await browser.runtime.sendMessage(&quot;popup.html&quot;);</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+          window.close();</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+        };</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+      },</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+    },</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+    manifest: {</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+      applications: {</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+        gecko: {</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+          id: &quot;test1@mochi.test&quot;,</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+        },</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+      },</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+      compose_action: {</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+        default_title: &quot;This is a test&quot;,</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+      },</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+    },</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+  };</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+  await test_it(extensionDetails, &quot;composeToolbar2&quot;);</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+  extensionDetails.background = background_popup;</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+  extensionDetails.manifest.compose_action.default_popup = &quot;popup.html&quot;;</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+  await test_it(extensionDetails, &quot;composeToolbar2&quot;);</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+  extensionDetails.background = background_nopopup;</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+  extensionDetails.manifest.compose_action.default_area = &quot;formattoolbar&quot;;</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+  delete extensionDetails.manifest.compose_action.default_popup;</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+  await test_it(extensionDetails, &quot;FormatToolbar&quot;);</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+  extensionDetails.background = background_popup;</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+  extensionDetails.manifest.compose_action.default_popup = &quot;popup.html&quot;;</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+  await test_it(extensionDetails, &quot;FormatToolbar&quot;);</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/mail/components/extensions/test/browser/head.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,38 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;Services&quot;, &quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;MailServices&quot;, &quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+function createAccount() {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  registerCleanupFunction(() =&gt; {</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+    [...MailServices.accounts.accounts.enumerate()].forEach(cleanUpAccount);</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+  });</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+  MailServices.accounts.createLocalMailAccount();</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+  let account = MailServices.accounts.accounts.enumerate().getNext();</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+  info(`Created account ${account.toString()}`);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+  return account;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+}</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+function cleanUpAccount(account) {</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+  info(`Cleaning up account ${account.toString()}`);</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+  MailServices.accounts.removeIncomingServer(account.incomingServer, true);</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  MailServices.accounts.removeAccount(account, true);</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+}</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+function addIdentity(account) {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  identity.email = &quot;mochitest@localhost&quot;;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+  account.addIdentity(identity);</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+  account.defaultIdentity = identity;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+  info(`Created identity ${identity.toString()}`);</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+}</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+async function promiseAnimationFrame(win = window) {</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+  await new Promise(win.requestAnimationFrame);</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+  // dispatchToMainThread throws if used as the first argument of Promise.</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  return new Promise(resolve =&gt; Services.tm.dispatchToMainThread(resolve));</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/components/extensions/test/xpcshell/head.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/components/extensions/test/xpcshell/head.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.6"></a><span id="l15.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;Services&quot;, &quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;MailServices&quot;, &quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12"> // Ensure the profile directory is set up</span>
<a href="#l15.13"></a><span id="l15.13"> do_get_profile();</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15"> // Windows (Outlook Express) Address Book deactivation. (Bug 448859)</span>
<a href="#l15.16"></a><span id="l15.16"> Services.prefs.deleteBranch(&quot;ldap_2.servers.oe.&quot;);</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18"> // OSX Address Book deactivation (Bug 955842)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/components/extensions/test/xpcshell/test_ext_addressBook.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/components/extensions/test/xpcshell/test_ext_addressBook.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,18 +1,15 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> &quot;use strict&quot;;</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l16.12"></a><span id="l16.12"> ChromeUtils.import(&quot;resource://testing-common/ExtensionXPCShellUtils.jsm&quot;);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-</span>
<a href="#l16.14"></a><span id="l16.14"> ExtensionTestUtils.init(this);</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> add_task(async function test_addressBooks() {</span>
<a href="#l16.17"></a><span id="l16.17">   async function background() {</span>
<a href="#l16.18"></a><span id="l16.18">     let firstBookId, secondBookId, newContactId;</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20">     let events = [];</span>
<a href="#l16.21"></a><span id="l16.21">     for (let eventNamespace of [&quot;addressBooks&quot;, &quot;contacts&quot;, &quot;mailingLists&quot;]) {</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -53,22 +50,25 @@ add_task(async function test_addressBook</span>
<a href="#l16.23"></a><span id="l16.23">         if (expectedEvents.length == 1) {</span>
<a href="#l16.24"></a><span id="l16.24">           return event.args;</span>
<a href="#l16.25"></a><span id="l16.25">         }</span>
<a href="#l16.26"></a><span id="l16.26">       }</span>
<a href="#l16.27"></a><span id="l16.27"> </span>
<a href="#l16.28"></a><span id="l16.28">       return null;</span>
<a href="#l16.29"></a><span id="l16.29">     };</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-    let awaitMessage = function() {</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+    let awaitMessage = function(messageToSend, ...sendArgs) {</span>
<a href="#l16.33"></a><span id="l16.33">       return new Promise(resolve =&gt; {</span>
<a href="#l16.34"></a><span id="l16.34">         browser.test.onMessage.addListener(function listener(...args) {</span>
<a href="#l16.35"></a><span id="l16.35">           browser.test.onMessage.removeListener(listener);</span>
<a href="#l16.36"></a><span id="l16.36">           resolve(args);</span>
<a href="#l16.37"></a><span id="l16.37">         });</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+        if (messageToSend) {</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+          browser.test.sendMessage(messageToSend, ...sendArgs);</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+        }</span>
<a href="#l16.41"></a><span id="l16.41">       });</span>
<a href="#l16.42"></a><span id="l16.42">     };</span>
<a href="#l16.43"></a><span id="l16.43"> </span>
<a href="#l16.44"></a><span id="l16.44">     async function addressBookTest() {</span>
<a href="#l16.45"></a><span id="l16.45">       browser.test.log(&quot;Starting addressBookTest&quot;);</span>
<a href="#l16.46"></a><span id="l16.46">       let list = await browser.addressBooks.list();</span>
<a href="#l16.47"></a><span id="l16.47">       browser.test.assertEq(2, list.length);</span>
<a href="#l16.48"></a><span id="l16.48">       for (let b of list) {</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineat">@@ -332,80 +332,69 @@ add_task(async function test_addressBook</span>
<a href="#l16.50"></a><span id="l16.50"> </span>
<a href="#l16.51"></a><span id="l16.51">       browser.test.assertEq(0, events.length, &quot;No events left unconsumed&quot;);</span>
<a href="#l16.52"></a><span id="l16.52">       browser.test.log(&quot;Completed contactRemovalTest&quot;);</span>
<a href="#l16.53"></a><span id="l16.53">     }</span>
<a href="#l16.54"></a><span id="l16.54"> </span>
<a href="#l16.55"></a><span id="l16.55">     async function outsideEventsTest() {</span>
<a href="#l16.56"></a><span id="l16.56">       browser.test.log(&quot;Starting outsideEventsTest&quot;);</span>
<a href="#l16.57"></a><span id="l16.57"> </span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-      browser.test.sendMessage(&quot;outsideEventsTest&quot;, &quot;createAddressBook&quot;);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-      let [bookId, newBookPrefId] = await awaitMessage();</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+      let [bookId, newBookPrefId] = await awaitMessage(&quot;outsideEventsTest&quot;, &quot;createAddressBook&quot;);</span>
<a href="#l16.61"></a><span id="l16.61">       let [newBook] = checkEvents([&quot;addressBooks&quot;, &quot;onCreated&quot;, { type: &quot;addressBook&quot;, id: bookId }]);</span>
<a href="#l16.62"></a><span id="l16.62">       browser.test.assertEq(&quot;external add&quot;, newBook.name);</span>
<a href="#l16.63"></a><span id="l16.63"> </span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-      browser.test.sendMessage(&quot;outsideEventsTest&quot;, &quot;updateAddressBook&quot;, newBookPrefId);</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-      await awaitMessage();</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+      await awaitMessage(&quot;outsideEventsTest&quot;, &quot;updateAddressBook&quot;, newBookPrefId);</span>
<a href="#l16.67"></a><span id="l16.67">       let [updatedBook] = checkEvents([&quot;addressBooks&quot;, &quot;onUpdated&quot;, { type: &quot;addressBook&quot;, id: bookId }]);</span>
<a href="#l16.68"></a><span id="l16.68">       browser.test.assertEq(&quot;external edit&quot;, updatedBook.name);</span>
<a href="#l16.69"></a><span id="l16.69"> </span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-      browser.test.sendMessage(&quot;outsideEventsTest&quot;, &quot;deleteAddressBook&quot;, newBookPrefId);</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-      await awaitMessage();</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+      await awaitMessage(&quot;outsideEventsTest&quot;, &quot;deleteAddressBook&quot;, newBookPrefId);</span>
<a href="#l16.73"></a><span id="l16.73">       checkEvents([&quot;addressBooks&quot;, &quot;onDeleted&quot;, bookId]);</span>
<a href="#l16.74"></a><span id="l16.74"> </span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-      browser.test.sendMessage(&quot;outsideEventsTest&quot;, &quot;createContact&quot;);</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-      let [parentId1, contactId] = await awaitMessage();</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+      let [parentId1, contactId] = await awaitMessage(&quot;outsideEventsTest&quot;, &quot;createContact&quot;);</span>
<a href="#l16.78"></a><span id="l16.78">       let [newContact] = checkEvents(</span>
<a href="#l16.79"></a><span id="l16.79">         [&quot;contacts&quot;, &quot;onCreated&quot;, { type: &quot;contact&quot;, parentId: parentId1, id: contactId }]</span>
<a href="#l16.80"></a><span id="l16.80">       );</span>
<a href="#l16.81"></a><span id="l16.81">       browser.test.assertEq(&quot;external&quot;, newContact.properties.FirstName);</span>
<a href="#l16.82"></a><span id="l16.82">       browser.test.assertEq(&quot;add&quot;, newContact.properties.LastName);</span>
<a href="#l16.83"></a><span id="l16.83"> </span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-      browser.test.sendMessage(&quot;outsideEventsTest&quot;, &quot;updateContact&quot;, contactId);</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-      await awaitMessage();</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+      await awaitMessage(&quot;outsideEventsTest&quot;, &quot;updateContact&quot;, contactId);</span>
<a href="#l16.87"></a><span id="l16.87">       let [updatedContact] = checkEvents(</span>
<a href="#l16.88"></a><span id="l16.88">         [&quot;contacts&quot;, &quot;onUpdated&quot;, { type: &quot;contact&quot;, parentId: parentId1, id: contactId }]</span>
<a href="#l16.89"></a><span id="l16.89">       );</span>
<a href="#l16.90"></a><span id="l16.90">       browser.test.assertEq(&quot;external&quot;, updatedContact.properties.FirstName);</span>
<a href="#l16.91"></a><span id="l16.91">       browser.test.assertEq(&quot;edit&quot;, updatedContact.properties.LastName);</span>
<a href="#l16.92"></a><span id="l16.92"> </span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-      browser.test.sendMessage(&quot;outsideEventsTest&quot;, &quot;createMailingList&quot;);</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-      let [parentId2, listId] = await awaitMessage();</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+      let [parentId2, listId] = await awaitMessage(&quot;outsideEventsTest&quot;, &quot;createMailingList&quot;);</span>
<a href="#l16.96"></a><span id="l16.96">       let [newList] = checkEvents(</span>
<a href="#l16.97"></a><span id="l16.97">         [&quot;mailingLists&quot;, &quot;onCreated&quot;, { type: &quot;mailingList&quot;, parentId: parentId2, id: listId }]</span>
<a href="#l16.98"></a><span id="l16.98">       );</span>
<a href="#l16.99"></a><span id="l16.99">       browser.test.assertEq(&quot;external add&quot;, newList.name);</span>
<a href="#l16.100"></a><span id="l16.100"> </span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-      browser.test.sendMessage(&quot;outsideEventsTest&quot;, &quot;updateMailingList&quot;, listId);</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-      await awaitMessage();</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+      await awaitMessage(&quot;outsideEventsTest&quot;, &quot;updateMailingList&quot;, listId);</span>
<a href="#l16.104"></a><span id="l16.104">       let [updatedList] = checkEvents(</span>
<a href="#l16.105"></a><span id="l16.105">         [&quot;mailingLists&quot;, &quot;onUpdated&quot;, { type: &quot;mailingList&quot;, parentId: parentId2, id: listId }]</span>
<a href="#l16.106"></a><span id="l16.106">       );</span>
<a href="#l16.107"></a><span id="l16.107">       browser.test.assertEq(&quot;external edit&quot;, updatedList.name);</span>
<a href="#l16.108"></a><span id="l16.108"> </span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-      browser.test.sendMessage(&quot;outsideEventsTest&quot;, &quot;addMailingListMember&quot;, listId, contactId);</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-      await awaitMessage();</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+      await awaitMessage(&quot;outsideEventsTest&quot;, &quot;addMailingListMember&quot;, listId, contactId);</span>
<a href="#l16.112"></a><span id="l16.112">       checkEvents(</span>
<a href="#l16.113"></a><span id="l16.113">         [&quot;mailingLists&quot;, &quot;onMemberAdded&quot;, { type: &quot;contact&quot;, parentId: listId, id: contactId }]</span>
<a href="#l16.114"></a><span id="l16.114">       );</span>
<a href="#l16.115"></a><span id="l16.115">       let listMembers = await browser.mailingLists.listMembers(listId);</span>
<a href="#l16.116"></a><span id="l16.116">       browser.test.assertEq(1, listMembers.length);</span>
<a href="#l16.117"></a><span id="l16.117"> </span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-      browser.test.sendMessage(&quot;outsideEventsTest&quot;, &quot;removeMailingListMember&quot;, listId, contactId);</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-      await awaitMessage();</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+      await awaitMessage(&quot;outsideEventsTest&quot;, &quot;removeMailingListMember&quot;, listId, contactId);</span>
<a href="#l16.121"></a><span id="l16.121">       checkEvents(</span>
<a href="#l16.122"></a><span id="l16.122">         [&quot;mailingLists&quot;, &quot;onMemberRemoved&quot;, listId, contactId]</span>
<a href="#l16.123"></a><span id="l16.123">       );</span>
<a href="#l16.124"></a><span id="l16.124"> </span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-      browser.test.sendMessage(&quot;outsideEventsTest&quot;, &quot;deleteMailingList&quot;, listId);</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-      await awaitMessage();</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+      await awaitMessage(&quot;outsideEventsTest&quot;, &quot;deleteMailingList&quot;, listId);</span>
<a href="#l16.128"></a><span id="l16.128">       checkEvents([&quot;mailingLists&quot;, &quot;onDeleted&quot;, parentId2, listId]);</span>
<a href="#l16.129"></a><span id="l16.129"> </span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-      browser.test.sendMessage(&quot;outsideEventsTest&quot;, &quot;deleteContact&quot;, contactId);</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-      await awaitMessage();</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+      await awaitMessage(&quot;outsideEventsTest&quot;, &quot;deleteContact&quot;, contactId);</span>
<a href="#l16.133"></a><span id="l16.133">       checkEvents([&quot;contacts&quot;, &quot;onDeleted&quot;, parentId1, contactId]);</span>
<a href="#l16.134"></a><span id="l16.134"> </span>
<a href="#l16.135"></a><span id="l16.135">       browser.test.log(&quot;Completed outsideEventsTest&quot;);</span>
<a href="#l16.136"></a><span id="l16.136">     }</span>
<a href="#l16.137"></a><span id="l16.137"> </span>
<a href="#l16.138"></a><span id="l16.138">     await addressBookTest();</span>
<a href="#l16.139"></a><span id="l16.139">     await contactsTest();</span>
<a href="#l16.140"></a><span id="l16.140">     await mailingListsTest();</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

