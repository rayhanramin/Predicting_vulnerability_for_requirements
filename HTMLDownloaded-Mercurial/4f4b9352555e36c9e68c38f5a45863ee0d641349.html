<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9421:4f4b9352555e36c9e68c38f5a45863ee0d641349</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4f4b9352555e36c9e68c38f5a45863ee0d641349" />
<meta property="og:url" content="/comm-central/rev/4f4b9352555e36c9e68c38f5a45863ee0d641349" />
<meta property="og:description" content="Bug 397975: Identity incorrectly picked based on matching domain without matching username. r=bwinton, sr=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4f4b9352555e36c9e68c38f5a45863ee0d641349 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4f4b9352555e36c9e68c38f5a45863ee0d641349">shortlog</a> |
<a href="/comm-central/log/4f4b9352555e36c9e68c38f5a45863ee0d641349">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4f4b9352555e36c9e68c38f5a45863ee0d641349">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4f4b9352555e36c9e68c38f5a45863ee0d641349">files</a> |
changeset |
<a href="/comm-central/raw-rev/4f4b9352555e36c9e68c38f5a45863ee0d641349">raw</a>  | <a href="/comm-central/archive/4f4b9352555e36c9e68c38f5a45863ee0d641349.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=397975">Bug 397975</a>: Identity incorrectly picked based on matching domain without matching username. r=bwinton, sr=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#103;&#110;&#117;&#115;&#32;&#77;&#101;&#108;&#105;&#110;&#32;&#60;&#109;&#107;&#109;&#101;&#108;&#105;&#110;&#43;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#105;&#107;&#105;&#46;&#102;&#105;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 20 Feb 2012 20:41:11 +0200</td></tr>

<tr>
 <td>changeset 9421</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4f4b9352555e36c9e68c38f5a45863ee0d641349">4f4b9352555e36c9e68c38f5a45863ee0d641349</a></td>
</tr>



<tr>
<td>parent 9420</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4821565a8f2408109f97414658e5789a6f672525">4821565a8f2408109f97414658e5789a6f672525</a>
</td>
</tr>

<tr>
<td>child 9422</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/052af292b83ea94d8ee25b32f20c5e94b2481a73">052af292b83ea94d8ee25b32f20c5e94b2481a73</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4f4b9352555e36c9e68c38f5a45863ee0d641349">7213</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Mon, 20 Feb 2012 18:45:52 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4f4b9352555e [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4f4b9352555e36c9e68c38f5a45863ee0d641349">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4f4b9352555e36c9e68c38f5a45863ee0d641349&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4f4b9352555e36c9e68c38f5a45863ee0d641349&newProject=comm-central&newRevision=4f4b9352555e36c9e68c38f5a45863ee0d641349&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4f4b9352555e36c9e68c38f5a45863ee0d641349&newProject=comm-central&newRevision=4f4b9352555e36c9e68c38f5a45863ee0d641349&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4f4b9352555e36c9e68c38f5a45863ee0d641349&newProject=comm-central&newRevision=4f4b9352555e36c9e68c38f5a45863ee0d641349&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bwinton%29&revcount=50">bwinton</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=397975">397975</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=397975">Bug 397975</a>: Identity incorrectly picked based on matching domain without matching username. r=bwinton, sr=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4f4b9352555e36c9e68c38f5a45863ee0d641349/mail/base/content/mailCommands.js">mail/base/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f4b9352555e36c9e68c38f5a45863ee0d641349/mail/base/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/4f4b9352555e36c9e68c38f5a45863ee0d641349/mail/base/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/4f4b9352555e36c9e68c38f5a45863ee0d641349/mail/base/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/4f4b9352555e36c9e68c38f5a45863ee0d641349/mail/base/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/4f4b9352555e36c9e68c38f5a45863ee0d641349/mail/base/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4f4b9352555e36c9e68c38f5a45863ee0d641349/mail/test/mozmill/message-header/test-reply-identity.js">mail/test/mozmill/message-header/test-reply-identity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f4b9352555e36c9e68c38f5a45863ee0d641349/mail/test/mozmill/message-header/test-reply-identity.js">file</a> |
<a href="/comm-central/annotate/4f4b9352555e36c9e68c38f5a45863ee0d641349/mail/test/mozmill/message-header/test-reply-identity.js">annotate</a> |
<a href="/comm-central/diff/4f4b9352555e36c9e68c38f5a45863ee0d641349/mail/test/mozmill/message-header/test-reply-identity.js">diff</a> |
<a href="/comm-central/comparison/4f4b9352555e36c9e68c38f5a45863ee0d641349/mail/test/mozmill/message-header/test-reply-identity.js">comparison</a> |
<a href="/comm-central/log/4f4b9352555e36c9e68c38f5a45863ee0d641349/mail/test/mozmill/message-header/test-reply-identity.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4f4b9352555e36c9e68c38f5a45863ee0d641349/mailnews/test/resources/messageGenerator.js">mailnews/test/resources/messageGenerator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f4b9352555e36c9e68c38f5a45863ee0d641349/mailnews/test/resources/messageGenerator.js">file</a> |
<a href="/comm-central/annotate/4f4b9352555e36c9e68c38f5a45863ee0d641349/mailnews/test/resources/messageGenerator.js">annotate</a> |
<a href="/comm-central/diff/4f4b9352555e36c9e68c38f5a45863ee0d641349/mailnews/test/resources/messageGenerator.js">diff</a> |
<a href="/comm-central/comparison/4f4b9352555e36c9e68c38f5a45863ee0d641349/mailnews/test/resources/messageGenerator.js">comparison</a> |
<a href="/comm-central/log/4f4b9352555e36c9e68c38f5a45863ee0d641349/mailnews/test/resources/messageGenerator.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mailCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mailCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -35,160 +35,120 @@</span>
<a href="#l1.4"></a><span id="l1.4"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.5"></a><span id="l1.5"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.6"></a><span id="l1.6"> #</span>
<a href="#l1.7"></a><span id="l1.7"> # ***** END LICENSE BLOCK *****</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> var gPromptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l1.10"></a><span id="l1.10">                       .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+/**</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ * Get the identity that most likely is the best one to use, given the hint.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+ * @param identities nsISupportsArray&lt;nsIMsgIdentity&gt; of identities</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+ * @param optionalHint string containing comma separated mailboxes</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+ */</span>
<a href="#l1.17"></a><span id="l1.17"> function getBestIdentity(identities, optionalHint)</span>
<a href="#l1.18"></a><span id="l1.18"> {</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-  var identity = null;</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-  var identitiesCount = identities.Count();</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-  try</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-  {</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-    // if we have more than one identity and a hint to help us pick one</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    if (identitiesCount &gt; 1 &amp;&amp; optionalHint) {</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-      // normalize case on the optional hint to improve our chances of finding a match</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-      optionalHint = optionalHint.toLowerCase();</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-      var id;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-      // iterate over all of the identities</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-      var tempID;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+  let identityCount = identities.Count();</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+  if (identityCount &lt; 1)</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+    return null;</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-      var lengthOfLongestMatchingEmail = 0;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-      for each (var tempID in fixIterator(identities,</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-                                          Components.interfaces.nsIMsgIdentity)) {</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-        if (optionalHint.indexOf(tempID.email.toLowerCase()) &gt;= 0) {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-          // Be careful, the user can have several adresses with the same</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-          // postfix e.g. aaa.bbb@ccc.ddd and bbb@ccc.ddd. Make sure we get the</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-          // longest match.</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-          if (tempID.email.length &gt; lengthOfLongestMatchingEmail) {</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-            identity = tempID;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-            lengthOfLongestMatchingEmail = tempID.email.length;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-          }</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-        }</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-      }</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  // If we have more than one identity and a hint to help us pick one.</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  if (identityCount &gt; 1 &amp;&amp; optionalHint) {</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    // Normalize case on the optional hint to improve our chances of</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    // finding a match.</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+    optionalHint = optionalHint.toLowerCase();</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+    let hints = optionalHint.toLowerCase().split(&quot;,&quot;);</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-      // if we could not find an exact email address match within the hint fields then maybe the message</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-      // was to a mailing list. In this scenario, we won't have a match based on email address.</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-      // Before we just give up, try and search for just a shared domain between the hint and</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-      // the email addresses for our identities. Hey, it is better than nothing and in the case</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-      // of multiple matches here, we'll end up picking the first one anyway which is what we would have done</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-      // if we didn't do this second search. This helps the case for corporate users where mailing lists will have the same domain</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-      // as one of your multiple identities.</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-      if (!identity) {</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-        let nsIMsgIdentity = Components.interfaces.nsIMsgIdentity;</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-        for each (var tempID in fixIterator(identities, nsIMsgIdentity)) {</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-          // extract out the partial domain</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-          var start = tempID.email.lastIndexOf(&quot;@&quot;); // be sure to include the @ sign in our search to reduce the risk of false positives</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-          if (optionalHint.search(tempID.email.slice(start).toLowerCase()) &gt;= 0) {</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-            identity = tempID;</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-            break;</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-          }</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-        }</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+    for (let i = 0 ; i &lt; hints.length; i++) {</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+      for each (let identity in fixIterator(identities,</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+                  Components.interfaces.nsIMsgIdentity)) {</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+        if (!identity.email)</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+          continue;</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+        if (hints[i].trim() == identity.email.toLowerCase() ||</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+            hints[i].indexOf(&quot;&lt;&quot; + identity.email.toLowerCase() + &quot;&gt;&quot;) != -1)</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+          return identity;</span>
<a href="#l1.83"></a><span id="l1.83">       }</span>
<a href="#l1.84"></a><span id="l1.84">     }</span>
<a href="#l1.85"></a><span id="l1.85">   }</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-  catch (ex) {dump (ex + &quot;\n&quot;);}</span>
<a href="#l1.87"></a><span id="l1.87"> </span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-  // Still no matches ?</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-  // Give up and pick the first one (if it exists), like we used to.</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-  if (!identity &amp;&amp; identitiesCount &gt; 0)</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-    identity = identities.GetElementAt(0).QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-  return identity;</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+  // Still no matches? Give up and pick the first one.</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+  return identities.QueryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.96"></a><span id="l1.96"> }</span>
<a href="#l1.97"></a><span id="l1.97"> </span>
<a href="#l1.98"></a><span id="l1.98"> function getIdentityForServer(server, optionalHint)</span>
<a href="#l1.99"></a><span id="l1.99"> {</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-    var identity = null;</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-    if (server) {</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-        // Get the identities associated with this server.</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-        var identities = accountManager.GetIdentitiesForServer(server);</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-        // dump(&quot;identities = &quot; + identities + &quot;\n&quot;);</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-        // Try and find the best one.</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-        identity = getBestIdentity(identities, optionalHint);</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-    }</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-    return identity;</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+  var identities = accountManager.GetIdentitiesForServer(server);</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+  return getBestIdentity(identities, optionalHint);</span>
<a href="#l1.113"></a><span id="l1.113"> }</span>
<a href="#l1.114"></a><span id="l1.114"> </span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+/**</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+ * Get the identity for the given header.</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+ * @param hdr nsIMsgHdr message header</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+ * @param type nsIMsgCompType compose type the identity ise used for.</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+ */</span>
<a href="#l1.120"></a><span id="l1.120"> function getIdentityForHeader(hdr, type)</span>
<a href="#l1.121"></a><span id="l1.121"> {</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-  // If we treat reply from sent specially, do we check for that folder flag here?</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-  var hintForIdentity = &quot;&quot;;</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-  // if the current mode is &quot;reply-to-list&quot;</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-  if (type == Components.interfaces.nsIMsgCompType.ReplyToList) {</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-    var key = &quot;delivered-to&quot;;</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-    var allIdentities = accountManager.allIdentities;</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-    var tempIdentity = &quot;&quot;;</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+  function findDeliveredToIdentityEmail() {</span>
<a href="#l1.134"></a><span id="l1.134">     // Get the delivered-to headers.</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-    var deliveredTos = new Array();</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-    var index = 0;</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-    while (tempIdentity = currentHeaderData[key]) {</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-      deliveredTos.push(tempIdentity.headerValue.toLowerCase());</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+    let key = &quot;delivered-to&quot;;</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+    let deliveredTos = new Array();</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+    let index = 0;</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+    let header = &quot;&quot;;</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+    while (header = currentHeaderData[key]) {</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+      deliveredTos.push(header.headerValue.toLowerCase().trim());</span>
<a href="#l1.145"></a><span id="l1.145">       key = &quot;delivered-to&quot; + index++;</span>
<a href="#l1.146"></a><span id="l1.146">     }</span>
<a href="#l1.147"></a><span id="l1.147"> </span>
<a href="#l1.148"></a><span id="l1.148">     // Reverse the array so that the last delivered-to header will show at front.</span>
<a href="#l1.149"></a><span id="l1.149">     deliveredTos.reverse();</span>
<a href="#l1.150"></a><span id="l1.150"> </span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-    // Get the last &quot;delivered-to&quot; that is in the defined identities.</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-    for (var i = 0; i &lt; deliveredTos.length; i++) {</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-      for each (var tempID in fixIterator(allIdentities,</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-                Components.interfaces.nsIMsgIdentity)) {</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-        // If the deliver-to header contains the defined identity</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-        if (tempID.email &amp;&amp;</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-            deliveredTos[i].indexOf(tempID.email.toLowerCase()) != -1) {</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-          hintForIdentity = tempID.email;</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-          break;</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-        }</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+    for (let i = 0; i &lt; deliveredTos.length; i++) {</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+      for each (let identity in fixIterator(accountManager.allIdentities,</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+                                  Components.interfaces.nsIMsgIdentity)) {</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+        if (!identity.email)</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+          continue;</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+        // If the deliver-to header contains the defined identity, that's it.</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+        if (deliveredTos[i] == identity.email.toLowerCase() ||</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+            deliveredTos[i].indexOf(&quot;&lt;&quot; + identity.email.toLowerCase() + &quot;&gt;&quot;) != -1)</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+          return identity.email;</span>
<a href="#l1.170"></a><span id="l1.170">       }</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-      // Identity has been found</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-      if (hintForIdentity)</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-        break;</span>
<a href="#l1.174"></a><span id="l1.174">     }</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l1.176"></a><span id="l1.176">   }</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+  let hintForIdentity = &quot;&quot;;</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+  if (type == Components.interfaces.nsIMsgCompType.ReplyToList)</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+    hintForIdentity = findDeliveredToIdentityEmail();</span>
<a href="#l1.181"></a><span id="l1.181">   else if (type == Components.interfaces.nsIMsgCompType.Template)</span>
<a href="#l1.182"></a><span id="l1.182">     hintForIdentity = hdr.author;</span>
<a href="#l1.183"></a><span id="l1.183">   else</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-    hintForIdentity = hdr.recipients + hdr.ccList;</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+    hintForIdentity = hdr.recipients + &quot;,&quot; + hdr.ccList + &quot;,&quot; +</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+                      findDeliveredToIdentityEmail();</span>
<a href="#l1.187"></a><span id="l1.187"> </span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-  var server = null;</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-  var identity = null;</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-  var folder = hdr.folder;</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+  let server = null;</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+  let identity = null;</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+  let folder = hdr.folder;</span>
<a href="#l1.194"></a><span id="l1.194">   if (folder) {</span>
<a href="#l1.195"></a><span id="l1.195">     server = folder.server;</span>
<a href="#l1.196"></a><span id="l1.196">     identity = folder.customIdentity;</span>
<a href="#l1.197"></a><span id="l1.197">   }</span>
<a href="#l1.198"></a><span id="l1.198"> </span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-  var accountKey = hdr.accountKey;</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+  let accountKey = hdr.accountKey;</span>
<a href="#l1.201"></a><span id="l1.201">   if (accountKey.length &gt; 0) {</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-    var account = accountManager.getAccount(accountKey);</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+    let account = accountManager.getAccount(accountKey);</span>
<a href="#l1.204"></a><span id="l1.204">     if (account)</span>
<a href="#l1.205"></a><span id="l1.205">       server = account.incomingServer;</span>
<a href="#l1.206"></a><span id="l1.206">   }</span>
<a href="#l1.207"></a><span id="l1.207"> </span>
<a href="#l1.208"></a><span id="l1.208">   if (server &amp;&amp; !identity)</span>
<a href="#l1.209"></a><span id="l1.209">     identity = getIdentityForServer(server, hintForIdentity);</span>
<a href="#l1.210"></a><span id="l1.210"> </span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-  if (!identity) {</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-    var allIdentities = accountManager.allIdentities;</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-    identity = getBestIdentity(allIdentities, hintForIdentity);</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-  }</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+  if (!identity)</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+    identity = getBestIdentity(accountManager.allIdentities, hintForIdentity);</span>
<a href="#l1.217"></a><span id="l1.217"> </span>
<a href="#l1.218"></a><span id="l1.218">   return identity;</span>
<a href="#l1.219"></a><span id="l1.219"> }</span>
<a href="#l1.220"></a><span id="l1.220"> </span>
<a href="#l1.221"></a><span id="l1.221"> function GetNextNMessages(folder)</span>
<a href="#l1.222"></a><span id="l1.222"> {</span>
<a href="#l1.223"></a><span id="l1.223">   if (folder) {</span>
<a href="#l1.224"></a><span id="l1.224">     var newsFolder = folder.QueryInterface(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-reply-identity.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,166 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+/**</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+ * Tests that actions such as replying choses the most suitable identity.</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+ */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+const MODULE_NAME = &quot;test-reply-identity&quot;;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+const RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+const MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+                         &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+var folderHelper = null;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+var windowindowHelperelper = null;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+var composeHelper = null;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+var testFolder = null;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+const identity1Email = &quot;carl@example.com&quot;;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+const identity2Email = &quot;lenny@springfield.invalid&quot;;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+var setupModule = function (module) {</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+  folderHelper = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  folderHelper.installInto(module);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  windowHelper = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  windowHelper.installInto(module);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  composeHelper = collector.getModule(&quot;compose-helpers&quot;);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  composeHelper.installInto(module);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  addIdentitiesAndFolder();</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  add_message_to_folder(testFolder, create_message({</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    to: &quot;workers@springfield.invalid&quot;,</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+    subject: &quot;no matching identity, like bcc/list&quot;,</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+    body: {body: &quot;Alcohol is a way of life, alcohol is my way of life, and I aim to keep it.&quot;},</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+    }</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  }));</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  add_message_to_folder(testFolder, create_message({</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    to: &quot;powerplant-workers@springfield.invalid&quot;,</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+    subject: &quot;only delivered-to header matching identity&quot;,</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    body: {body: &quot;Just because I don't care doesn't mean I don't understand.&quot;},</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+      &quot;Delivered-To&quot; : &quot;&lt;&quot; + identity2Email + &quot;&gt;&quot;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+    }</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  }));</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  add_message_to_folder(testFolder, create_message({</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+    to: &quot;powerplant-workers@springfield.invalid, Apu &lt;apu@test.invalid&gt;&quot;,</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+    cc: &quot;other.&quot; + identity2Email,</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+    subject: &quot;subpart of cc address matching identity&quot;,</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    body: {body: &quot;Blame the guy who doesn't speak Engish.&quot;},</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+    }</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  }));</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  add_message_to_folder(testFolder, create_message({</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    to: &quot;Lenny &lt;&quot; + identity2Email + &quot;&gt;&quot;,</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    subject: &quot;normal to:address match, with full name&quot;,</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+    body: {body: &quot;Remember as far as anyone knows, we're a nice normal family.&quot;}</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  }));</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  add_message_to_folder(testFolder, create_message({</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    from: [&quot;Homer&quot;, &quot;homer@example.com&quot;],</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+    to: &quot;powerplant-workers@springfield.invalid&quot;,</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    subject: &quot;delivered-to header matching only subpart of identity email&quot;,</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+    body: {body: &quot;Mmmm...Forbidden donut&quot;},</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+      &quot;Delivered-To&quot; : &quot;&lt;other.&quot; + identity2Email + &quot;&gt;&quot;</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+    }</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  }));</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+}</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+var addIdentitiesAndFolder = function() {</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+                .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+  let server = acctMgr.createIncomingServer(&quot;nobody&quot;,</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+                                            &quot;Reply Identity Testing&quot;, &quot;pop3&quot;);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+  testFolder = server.rootFolder.QueryInterface(Ci.nsIMsgLocalMailFolder)</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+                     .createLocalSubfolder(&quot;Replies&quot;);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  let identity = acctMgr.createIdentity();</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+  identity.email = identity1Email;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+  let identity2 = acctMgr.createIdentity();</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+  identity2.email = identity2Email;</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+  let account = acctMgr.createAccount();</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+  account.incomingServer = server;</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+  account.addIdentity(identity);</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+  account.addIdentity(identity2);</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+}</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+var checkReply = function (replyWin, expectedFromEmail) {</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+  let identityList = replyWin.e(&quot;msgIdentity&quot;);</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+  if (identityList.selectedItem.label.indexOf(expectedFromEmail) == -1)</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+    throw new Error(&quot;The From address is not correctly selected! Expected: &quot; +</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+                    expectedFromEmail + &quot;; Actual: &quot;  +</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+                    identityList.selectedItem.label);</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+}</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+function test_reply_no_matching_identity() {</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+  be_in_folder(testFolder);</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+  let msg = select_click_row(0);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+  let replyWin = composeHelper.open_compose_with_reply();</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+  // Should have selected the default identity.</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+  checkReply(replyWin, identity1Email);</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+  close_compose_window(replyWin);</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+}</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+function test_reply_matching_only_deliveredto() {</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+  be_in_folder(testFolder);</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+  let msg = select_click_row(1);</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+  let replyWin = composeHelper.open_compose_with_reply();</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+  // Should have selected the second id, which is listed in Delivered-To:.</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+  checkReply(replyWin, identity2Email);</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+  close_compose_window(replyWin);</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+}</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+function test_reply_matching_subaddress() {</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+  be_in_folder(testFolder);</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+  let msg = select_click_row(2);</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+  let replyWin = composeHelper.open_compose_with_reply();</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+  // Should have selected the first id, the email doesn't fully match.</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+  // other.lenny != &quot;our&quot; lenny</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+  checkReply(replyWin, identity1Email);</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+  close_compose_window(replyWin);</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+}</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+function test_reply_to_matching_second_id() {</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+  be_in_folder(testFolder);</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+  let msg = select_click_row(3);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+  let replyWin = composeHelper.open_compose_with_reply();</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+  // Should have selected the second id, which was in To;.</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+  checkReply(replyWin, identity2Email);</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+  close_compose_window(replyWin);</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+}</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+function test_deliveredto_to_matching_only_parlty() {</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+  be_in_folder(testFolder);</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+  let msg = select_click_row(4);</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+  let replyWin = composeHelper.open_compose_with_reply();</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+  // Should have selected the (default) first id.</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+  checkReply(replyWin, identity1Email);</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+  close_compose_window(replyWin);</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/test/resources/messageGenerator.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/test/resources/messageGenerator.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -460,27 +460,50 @@ SyntheticMessage.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">   _formatMailFromNameAndAddress: function(aNameAndAddress) {</span>
<a href="#l3.5"></a><span id="l3.5">     // if the name is encoded, do not put it in quotes!</span>
<a href="#l3.6"></a><span id="l3.6">     return (aNameAndAddress[0][0] == &quot;=&quot; ?</span>
<a href="#l3.7"></a><span id="l3.7">               (aNameAndAddress[0] + &quot; &quot;) :</span>
<a href="#l3.8"></a><span id="l3.8">               ('&quot;' + aNameAndAddress[0] + '&quot; ')) +</span>
<a href="#l3.9"></a><span id="l3.9">            '&lt;' + aNameAndAddress[1] + '&gt;';</span>
<a href="#l3.10"></a><span id="l3.10">   },</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  /**</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+   * Given a mailbox, parse out name and email. The mailbox</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+   * can (per rfc 2822) be of two forms:</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+   *  1) Name &lt;me@example.org&gt;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+   *  2) me@example.org</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+   * @return a tuple of name, email</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+   **/</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  _parseMailbox: function(mailbox) {</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+    let matcher = mailbox.match(/(.*)&lt;(.+@.+)&gt;/);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    if (!matcher) // no match -&gt; second form</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+      return [&quot;&quot;, mailbox];</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+    let name = matcher[1].trim();</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+    let email = matcher[2].trim();</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+    return [name, email];</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  },</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+</span>
<a href="#l3.29"></a><span id="l3.29">   /** @returns the name-and-address tuple used when setting the From header. */</span>
<a href="#l3.30"></a><span id="l3.30">   get from() { return this._from; },</span>
<a href="#l3.31"></a><span id="l3.31">   /**</span>
<a href="#l3.32"></a><span id="l3.32">    * Sets the From header using the given tuple containing [a display name,</span>
<a href="#l3.33"></a><span id="l3.33">    *  an e-mail address].</span>
<a href="#l3.34"></a><span id="l3.34">    *</span>
<a href="#l3.35"></a><span id="l3.35">    * @param aNameAndAddress A list with two elements.  The first should be the</span>
<a href="#l3.36"></a><span id="l3.36">    *     display name (sans wrapping quotes).  The second element should be the</span>
<a href="#l3.37"></a><span id="l3.37">    *     e-mail address (sans wrapping greater-than/less-than).</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+   *     Can also be a string, should then be a valid raw From: header value.</span>
<a href="#l3.39"></a><span id="l3.39">    */</span>
<a href="#l3.40"></a><span id="l3.40">   set from(aNameAndAddress) {</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+    if (typeof aNameAndAddress === &quot;string&quot;) {</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+      this._from = this._parseMailbox(aNameAndAddress);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+      this.headers[&quot;From&quot;] = aNameAndAddress;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+      return;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    }</span>
<a href="#l3.46"></a><span id="l3.46">     this._from = aNameAndAddress;</span>
<a href="#l3.47"></a><span id="l3.47">     this.headers[&quot;From&quot;] = this._formatMailFromNameAndAddress(aNameAndAddress);</span>
<a href="#l3.48"></a><span id="l3.48">   },</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50">   /** @returns The display name part of the From header. */</span>
<a href="#l3.51"></a><span id="l3.51">   get fromName() { return this._from[0]; },</span>
<a href="#l3.52"></a><span id="l3.52">   /** @returns The e-mail address part of the From header (no display name). */</span>
<a href="#l3.53"></a><span id="l3.53">   get fromAddress() { return this._from[1]; },</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineat">@@ -505,18 +528,29 @@ SyntheticMessage.prototype = {</span>
<a href="#l3.55"></a><span id="l3.55">   /**</span>
<a href="#l3.56"></a><span id="l3.56">    * Sets the To header using a list of tuples containing [a display name,</span>
<a href="#l3.57"></a><span id="l3.57">    *  an e-mail address].</span>
<a href="#l3.58"></a><span id="l3.58">    *</span>
<a href="#l3.59"></a><span id="l3.59">    * @param aNameAndAddress A list of name-and-address tuples.  Each tuple is a</span>
<a href="#l3.60"></a><span id="l3.60">    *     list with two elements.  The first should be the</span>
<a href="#l3.61"></a><span id="l3.61">    *     display name (sans wrapping quotes).  The second element should be the</span>
<a href="#l3.62"></a><span id="l3.62">    *     e-mail address (sans wrapping greater-than/less-than).</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+   *     Can also be a string, should then be a valid raw To: header value.</span>
<a href="#l3.64"></a><span id="l3.64">    */</span>
<a href="#l3.65"></a><span id="l3.65">   set to(aNameAndAddresses) {</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    if (typeof aNameAndAddresses === &quot;string&quot;) {</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+      this._to = [];</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+      let people = aNameAndAddresses.split(&quot;,&quot;);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+      for (let i = 0; i &lt; people.length; i++) {</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+        this._to.push(this._parseMailbox(people[i]));</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+      }</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+      this.headers[&quot;To&quot;] = aNameAndAddresses;</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+      return;</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    }</span>
<a href="#l3.76"></a><span id="l3.76">     this._to = aNameAndAddresses;</span>
<a href="#l3.77"></a><span id="l3.77">     this.headers[&quot;To&quot;] = this._commaize(</span>
<a href="#l3.78"></a><span id="l3.78">                            [this._formatMailFromNameAndAddress(nameAndAddr)</span>
<a href="#l3.79"></a><span id="l3.79">                             for each (nameAndAddr in aNameAndAddresses)]);</span>
<a href="#l3.80"></a><span id="l3.80">   },</span>
<a href="#l3.81"></a><span id="l3.81">   /** @returns The display name of the first intended recipient. */</span>
<a href="#l3.82"></a><span id="l3.82">   get toName() { return this._to[0][0]; },</span>
<a href="#l3.83"></a><span id="l3.83">   /** @returns The email address (no display name) of the first recipient. */</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineat">@@ -530,18 +564,28 @@ SyntheticMessage.prototype = {</span>
<a href="#l3.85"></a><span id="l3.85">   /**</span>
<a href="#l3.86"></a><span id="l3.86">    * Sets the Cc header using a list of tuples containing [a display name,</span>
<a href="#l3.87"></a><span id="l3.87">    *  an e-mail address].</span>
<a href="#l3.88"></a><span id="l3.88">    *</span>
<a href="#l3.89"></a><span id="l3.89">    * @param aNameAndAddress A list of name-and-address tuples.  Each tuple is a</span>
<a href="#l3.90"></a><span id="l3.90">    *     list with two elements.  The first should be the</span>
<a href="#l3.91"></a><span id="l3.91">    *     display name (sans wrapping quotes).  The second element should be the</span>
<a href="#l3.92"></a><span id="l3.92">    *     e-mail address (sans wrapping greater-than/less-than).</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+   *     Can also be a string, should then be a valid raw Cc: header value.</span>
<a href="#l3.94"></a><span id="l3.94">    */</span>
<a href="#l3.95"></a><span id="l3.95">   set cc(aNameAndAddresses) {</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    if (typeof aNameAndAddresses === &quot;string&quot;) {</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+      this._cc = [];</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+      let people = aNameAndAddresses.split(&quot;,&quot;);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+      for (let i = 0; i &lt; people.length; i++) {</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+        this._cc.push(this._parseMailbox(people[i]));</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+      }</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+      this.headers[&quot;Cc&quot;] = aNameAndAddresses;</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+      return;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+    }</span>
<a href="#l3.105"></a><span id="l3.105">     this._cc = aNameAndAddresses;</span>
<a href="#l3.106"></a><span id="l3.106">     this.headers[&quot;Cc&quot;] = this._commaize(</span>
<a href="#l3.107"></a><span id="l3.107">                            [this._formatMailFromNameAndAddress(nameAndAddr)</span>
<a href="#l3.108"></a><span id="l3.108">                             for each (nameAndAddr in aNameAndAddresses)]);</span>
<a href="#l3.109"></a><span id="l3.109">   },</span>
<a href="#l3.110"></a><span id="l3.110"> </span>
<a href="#l3.111"></a><span id="l3.111">   get bodyPart() {</span>
<a href="#l3.112"></a><span id="l3.112">     return this._bodyPart;</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineat">@@ -909,16 +953,20 @@ MessageGenerator.prototype = {</span>
<a href="#l3.114"></a><span id="l3.114">     }</span>
<a href="#l3.115"></a><span id="l3.115"> </span>
<a href="#l3.116"></a><span id="l3.116">     if (&quot;clobberHeaders&quot; in aArgs) {</span>
<a href="#l3.117"></a><span id="l3.117">       for each (let [key, value] in Iterator(aArgs.clobberHeaders)) {</span>
<a href="#l3.118"></a><span id="l3.118">         msg.headers[key] = value;</span>
<a href="#l3.119"></a><span id="l3.119">         // clobber helper...</span>
<a href="#l3.120"></a><span id="l3.120">         if (key == &quot;From&quot;)</span>
<a href="#l3.121"></a><span id="l3.121">           msg._from = [&quot;&quot;, &quot;&quot;];</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+        if (key == &quot;To&quot;)</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+          msg._to = [[&quot;&quot;, &quot;&quot;]];</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+        if (key == &quot;Cc&quot;)</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+          msg._cc = [[&quot;&quot;, &quot;&quot;]];</span>
<a href="#l3.126"></a><span id="l3.126">       }</span>
<a href="#l3.127"></a><span id="l3.127">     }</span>
<a href="#l3.128"></a><span id="l3.128"> </span>
<a href="#l3.129"></a><span id="l3.129">     if (&quot;junk&quot; in aArgs &amp;&amp; aArgs.junk)</span>
<a href="#l3.130"></a><span id="l3.130">       msg.metaState.junk = true;</span>
<a href="#l3.131"></a><span id="l3.131">     if (&quot;read&quot; in aArgs &amp;&amp; aArgs.read)</span>
<a href="#l3.132"></a><span id="l3.132">       msg.metaState.read = true;</span>
<a href="#l3.133"></a><span id="l3.133"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

