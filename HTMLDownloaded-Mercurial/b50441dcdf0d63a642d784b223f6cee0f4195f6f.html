<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 17551:b50441dcdf0d63a642d784b223f6cee0f4195f6f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b50441dcdf0d63a642d784b223f6cee0f4195f6f" />
<meta property="og:url" content="/comm-central/rev/b50441dcdf0d63a642d784b223f6cee0f4195f6f" />
<meta property="og:description" content="Bug 854172 - Add a missing check of the return value of MoveIncorporatedMessage, and the failure to log such failure. r=rkent IGNORE IDL" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b50441dcdf0d63a642d784b223f6cee0f4195f6f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b50441dcdf0d63a642d784b223f6cee0f4195f6f">shortlog</a> |
<a href="/comm-central/log/b50441dcdf0d63a642d784b223f6cee0f4195f6f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b50441dcdf0d63a642d784b223f6cee0f4195f6f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b50441dcdf0d63a642d784b223f6cee0f4195f6f">files</a> |
changeset |
<a href="/comm-central/raw-rev/b50441dcdf0d63a642d784b223f6cee0f4195f6f">raw</a>  | <a href="/comm-central/archive/b50441dcdf0d63a642d784b223f6cee0f4195f6f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=854172">Bug 854172</a> - Add a missing check of the return value of MoveIncorporatedMessage, and the failure to log such failure. r=rkent IGNORE IDL
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#73;&#83;&#72;&#73;&#75;&#65;&#87;&#65;&#44;&#32;&#67;&#104;&#105;&#97;&#107;&#105;&#32;&#60;&#105;&#115;&#104;&#105;&#107;&#97;&#119;&#97;&#64;&#121;&#107;&#46;&#114;&#105;&#109;&#46;&#111;&#114;&#46;&#106;&#112;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 23 Feb 2015 01:49:21 +0100</td></tr>

<tr>
 <td>changeset 17551</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b50441dcdf0d63a642d784b223f6cee0f4195f6f">b50441dcdf0d63a642d784b223f6cee0f4195f6f</a></td>
</tr>



<tr>
<td>parent 17550</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/516b43f6d312e9809baa9617666fbafbb609c865">516b43f6d312e9809baa9617666fbafbb609c865</a>
</td>
</tr>

<tr>
<td>child 17552</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d44486b9b95b3a49e331fdfeec50605df782a52a">d44486b9b95b3a49e331fdfeec50605df782a52a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b50441dcdf0d63a642d784b223f6cee0f4195f6f">10802</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Mon, 23 Feb 2015 00:49:52 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b50441dcdf0d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b50441dcdf0d63a642d784b223f6cee0f4195f6f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b50441dcdf0d63a642d784b223f6cee0f4195f6f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b50441dcdf0d63a642d784b223f6cee0f4195f6f&newProject=comm-central&newRevision=9903ed277c05c6ad56f7a652aad43a19d24a98d6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b50441dcdf0d63a642d784b223f6cee0f4195f6f&newProject=comm-central&newRevision=9903ed277c05c6ad56f7a652aad43a19d24a98d6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b50441dcdf0d63a642d784b223f6cee0f4195f6f&newProject=comm-central&newRevision=9903ed277c05c6ad56f7a652aad43a19d24a98d6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28rkent%29&revcount=50">rkent</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=854172">854172</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=854172">Bug 854172</a> - Add a missing check of the return value of MoveIncorporatedMessage, and the failure to log such failure. r=rkent IGNORE IDL</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mail/locales/en-US/chrome/messenger/filter.properties">mail/locales/en-US/chrome/messenger/filter.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mail/locales/en-US/chrome/messenger/filter.properties">file</a> |
<a href="/comm-central/annotate/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mail/locales/en-US/chrome/messenger/filter.properties">annotate</a> |
<a href="/comm-central/diff/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mail/locales/en-US/chrome/messenger/filter.properties">diff</a> |
<a href="/comm-central/comparison/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mail/locales/en-US/chrome/messenger/filter.properties">comparison</a> |
<a href="/comm-central/log/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mail/locales/en-US/chrome/messenger/filter.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/public/nsIMsgFilter.idl">mailnews/base/search/public/nsIMsgFilter.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/public/nsIMsgFilter.idl">file</a> |
<a href="/comm-central/annotate/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/public/nsIMsgFilter.idl">annotate</a> |
<a href="/comm-central/diff/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/public/nsIMsgFilter.idl">diff</a> |
<a href="/comm-central/comparison/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/public/nsIMsgFilter.idl">comparison</a> |
<a href="/comm-central/log/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/public/nsIMsgFilter.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilter.cpp">mailnews/base/search/src/nsMsgFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilter.cpp">file</a> |
<a href="/comm-central/annotate/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilter.cpp">annotate</a> |
<a href="/comm-central/diff/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilter.cpp">diff</a> |
<a href="/comm-central/comparison/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilter.cpp">comparison</a> |
<a href="/comm-central/log/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilter.h">mailnews/base/search/src/nsMsgFilter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilter.h">file</a> |
<a href="/comm-central/annotate/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilter.h">annotate</a> |
<a href="/comm-central/diff/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilter.h">diff</a> |
<a href="/comm-central/comparison/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilter.h">comparison</a> |
<a href="/comm-central/log/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilter.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilterService.cpp">mailnews/base/search/src/nsMsgFilterService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilterService.cpp">file</a> |
<a href="/comm-central/annotate/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilterService.cpp">annotate</a> |
<a href="/comm-central/diff/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilterService.cpp">diff</a> |
<a href="/comm-central/comparison/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilterService.cpp">comparison</a> |
<a href="/comm-central/log/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/base/search/src/nsMsgFilterService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/b50441dcdf0d63a642d784b223f6cee0f4195f6f/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/filter.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/filter.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -19,16 +19,22 @@ filterCustomHeaderOverflow=Your filters </span>
<a href="#l1.4"></a><span id="l1.4"> invalidCustomHeader=One of your filters uses a custom header that contains an invalid character, such as ':', a non-printable character, a non-ascii character, or an eight-bit ascii character. Please edit the msgFilterRules.dat file, which contains your filters, to remove invalid characters from your custom headers.</span>
<a href="#l1.5"></a><span id="l1.5"> continueFilterExecution=Applying filter %S failed. Would you like to continue applying filters?</span>
<a href="#l1.6"></a><span id="l1.6"> promptTitle=Running Filters</span>
<a href="#l1.7"></a><span id="l1.7"> promptMsg=You are currently in the process of filtering messages.\nWould you like to continue applying filters?</span>
<a href="#l1.8"></a><span id="l1.8"> stopButtonLabel=Stop</span>
<a href="#l1.9"></a><span id="l1.9"> continueButtonLabel=Continue</span>
<a href="#l1.10"></a><span id="l1.10"> cannotEnableFilter=This filter was probably created by future version of mozilla/netscape. You cannot enable this filter because we don't know how to apply it.</span>
<a href="#l1.11"></a><span id="l1.11"> dontWarnAboutDeleteCheckbox=Don't ask me again</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+# LOCALIZATION NOTE(filterFAilureWarningPrefix)</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+# %1$S=filter error action</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+# %2$S=error code as hexadecimal string.</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+filterFailureWarningPrefix=Filter Action Failed: &quot;%1$S&quot; with error code=%2$S while attempting:</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+</span>
<a href="#l1.18"></a><span id="l1.18"> searchTermsInvalidTitle=Search Terms Invalid</span>
<a href="#l1.19"></a><span id="l1.19"> # LOCALIZATION NOTE(searchTermsInvalidRule)</span>
<a href="#l1.20"></a><span id="l1.20"> # %1$S=search attribute name from the invalid rule</span>
<a href="#l1.21"></a><span id="l1.21"> # %2$S=search operator from the bad rule</span>
<a href="#l1.22"></a><span id="l1.22"> searchTermsInvalidRule=This filter cannot be saved because the search term &quot;%1$S %2$S&quot; is invalid in the current context.</span>
<a href="#l1.23"></a><span id="l1.23"> # LOCALIZATION NOTE(filterActionOrderExplanation)</span>
<a href="#l1.24"></a><span id="l1.24"> # Keep the \n\n that mean 2 linebreaks.</span>
<a href="#l1.25"></a><span id="l1.25"> filterActionOrderExplanation=When a message matches this filter the actions will be run in this order:\n\n</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgFilter.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgFilter.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -25,30 +25,30 @@ interface nsIMsgRuleAction : nsISupports</span>
<a href="#l2.4"></a><span id="l2.4">   attribute nsMsgPriorityValue priority;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   // target folder.. throws an exception if the action is not move to folder</span>
<a href="#l2.7"></a><span id="l2.7">   attribute ACString targetFolderUri;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">   // target label. throws an exception if the action is not label</span>
<a href="#l2.10"></a><span id="l2.10">   attribute nsMsgLabelValue label;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  attribute long junkScore; </span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  attribute long junkScore;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15">   attribute AUTF8String strValue;</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   // action id if type is Custom</span>
<a href="#l2.18"></a><span id="l2.18">   attribute ACString customId;</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   // custom action associated with customId</span>
<a href="#l2.21"></a><span id="l2.21">   // (which must be set prior to reading this attribute)</span>
<a href="#l2.22"></a><span id="l2.22">   readonly attribute nsIMsgFilterCustomAction customAction;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-  </span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+</span>
<a href="#l2.25"></a><span id="l2.25"> };</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-[scriptable, uuid(ed4b7a8e-3190-4b0b-b842-d4f1ca652170)]</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+[scriptable, uuid(d304fcfc-b588-11e4-981c-770e1e5d46b0)]</span>
<a href="#l2.29"></a><span id="l2.29"> interface nsIMsgFilter : nsISupports {</span>
<a href="#l2.30"></a><span id="l2.30">     attribute nsMsgFilterTypeType filterType;</span>
<a href="#l2.31"></a><span id="l2.31">     /**</span>
<a href="#l2.32"></a><span id="l2.32">      * some filters are &quot;temporary&quot;.  For example, the filters we create when the user</span>
<a href="#l2.33"></a><span id="l2.33">      * filters return receipts to the Sent folder.</span>
<a href="#l2.34"></a><span id="l2.34">      * we don't show temporary filters in the UI</span>
<a href="#l2.35"></a><span id="l2.35">      * and we don't write them to disk.</span>
<a href="#l2.36"></a><span id="l2.36">      */</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineat">@@ -85,17 +85,39 @@ interface nsIMsgFilter : nsISupports {</span>
<a href="#l2.38"></a><span id="l2.38">     // Marking noscript because &quot;headers&quot; is actually a null-separated</span>
<a href="#l2.39"></a><span id="l2.39">     // list of headers, which is not scriptable.</span>
<a href="#l2.40"></a><span id="l2.40">     [noscript] void MatchHdr(in nsIMsgDBHdr msgHdr, in nsIMsgFolder folder,</span>
<a href="#l2.41"></a><span id="l2.41">                   in nsIMsgDatabase db,</span>
<a href="#l2.42"></a><span id="l2.42">                   in string headers,</span>
<a href="#l2.43"></a><span id="l2.43">                   //                  [array, size_is(headerSize)] in string headers,</span>
<a href="#l2.44"></a><span id="l2.44">                   in unsigned long headerSize, out boolean result);</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    void logRuleHit(in nsIMsgRuleAction aFilterAction, in nsIMsgDBHdr aHeader);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    /*</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+     * Report that Rule was matched and executed when filter logging is enabled.</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+     *</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+     * @param aFilterAction  The filter rule that was invoked.</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+     * @param aHeader        The header information of the message acted on by</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+     *                       the filter.</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+     */</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+    void logRuleHit(in nsIMsgRuleAction aFilterAction,</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+                    in nsIMsgDBHdr aHeader);</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+    /* Report that filtering failed for some reason when filter logging is enabled.</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+     *</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+     * @param aFilterAction Filter rule that was invoked.</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+     * @param aHeader Header of the message acted on by the filter.</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+     * @param aRcode  Error code returned by low-level routine that</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+     *                led to the filter failure.</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+     * @param aErrmsg Error message</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+     */</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    void logRuleHitFail(in nsIMsgRuleAction aFilterAction,</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+                        in nsIMsgDBHdr aHeader,</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+                        in nsresult aRcode,</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+                        in string aErrmsg );</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71">     nsIMsgRuleAction createAction();</span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73">     nsIMsgRuleAction getActionAt(in unsigned long aIndex);</span>
<a href="#l2.74"></a><span id="l2.74"> </span>
<a href="#l2.75"></a><span id="l2.75">     long getActionIndex(in nsIMsgRuleAction aAction);</span>
<a href="#l2.76"></a><span id="l2.76"> </span>
<a href="#l2.77"></a><span id="l2.77">     void appendAction(in nsIMsgRuleAction action);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -420,23 +420,23 @@ NS_IMETHODIMP nsMsgFilter::GetTerm(int32</span>
<a href="#l3.4"></a><span id="l3.4">                                    bool *booleanAnd, /* true if AND is the boolean operator. false if OR is the boolean operator */</span>
<a href="#l3.5"></a><span id="l3.5">                                    nsACString &amp;arbitraryHeader) /* arbitrary header specified by user.ignore unless attrib = attribOtherHeader */</span>
<a href="#l3.6"></a><span id="l3.6"> {</span>
<a href="#l3.7"></a><span id="l3.7">   nsCOMPtr&lt;nsIMsgSearchTerm&gt; term;</span>
<a href="#l3.8"></a><span id="l3.8">   nsresult rv = m_termList-&gt;QueryElementAt(termIndex, NS_GET_IID(nsIMsgSearchTerm),</span>
<a href="#l3.9"></a><span id="l3.9">                                            (void **)getter_AddRefs(term));</span>
<a href="#l3.10"></a><span id="l3.10">   if (NS_SUCCEEDED(rv) &amp;&amp; term)</span>
<a href="#l3.11"></a><span id="l3.11">   {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    if(attrib)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    if (attrib)</span>
<a href="#l3.14"></a><span id="l3.14">       term-&gt;GetAttrib(attrib);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    if(op)</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    if (op)</span>
<a href="#l3.17"></a><span id="l3.17">       term-&gt;GetOp(op);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-    if(value)</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+    if (value)</span>
<a href="#l3.20"></a><span id="l3.20">       term-&gt;GetValue(value);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    if(booleanAnd)</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+    if (booleanAnd)</span>
<a href="#l3.23"></a><span id="l3.23">       term-&gt;GetBooleanAnd(booleanAnd);</span>
<a href="#l3.24"></a><span id="l3.24">     if (attrib &amp;&amp; *attrib &gt; nsMsgSearchAttrib::OtherHeader</span>
<a href="#l3.25"></a><span id="l3.25">         &amp;&amp; *attrib &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes)</span>
<a href="#l3.26"></a><span id="l3.26">       term-&gt;GetArbitraryHeader(arbitraryHeader);</span>
<a href="#l3.27"></a><span id="l3.27">   }</span>
<a href="#l3.28"></a><span id="l3.28">   return NS_OK;</span>
<a href="#l3.29"></a><span id="l3.29"> }</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineat">@@ -471,17 +471,45 @@ NS_IMETHODIMP nsMsgFilter::GetScope(nsIM</span>
<a href="#l3.32"></a><span id="l3.32">     return NS_OK;</span>
<a href="#l3.33"></a><span id="l3.33"> }</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35"> #define LOG_ENTRY_START_TAG &quot;&lt;p&gt;\n&quot;</span>
<a href="#l3.36"></a><span id="l3.36"> #define LOG_ENTRY_START_TAG_LEN (strlen(LOG_ENTRY_START_TAG))</span>
<a href="#l3.37"></a><span id="l3.37"> #define LOG_ENTRY_END_TAG &quot;&lt;/p&gt;\n&quot;</span>
<a href="#l3.38"></a><span id="l3.38"> #define LOG_ENTRY_END_TAG_LEN (strlen(LOG_ENTRY_END_TAG))</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::LogRuleHit(nsIMsgRuleAction *aFilterAction, nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+// This function handles the logging both for success of filtering</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+// (NS_SUCCEEDED(aRcode)), and for error reporting (NS_FAILED(aRcode)</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+// when the filter action (such as file move/copy) failed.</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+//</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+// @param aRcode  NS_OK for successful filtering</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+//                operation, otherwise, an error code for filtering failure.</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+// @param aErrmsg Not used for success case (ignored), and a non-null</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+//                error message for failure case.</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+//</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+// CAUTION: Unless logging is enabled, no error/warning is shown.</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+// So enable logging if you would like to see the error/warning.</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+//</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+// XXX The current code in this file does not report errors of minor</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+// operations such as adding labels and so forth which may fail when</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+// underlying file system for the message store experiences</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+// failure. For now, most visible major errors such as message</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+// move/copy failures are taken care of.</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+//</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+// XXX Possible Improvement: For error case reporting, someone might</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+// want to implement a transient message that appears and stick until</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+// the user clears in the message status bar, etc. For now, we log an</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+// error in a similar form as a conventional successful filter event</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+// with additional error information at the beginning.</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+//</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+nsresult</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+nsMsgFilter::LogRuleHitGeneric(nsIMsgRuleAction *aFilterAction,</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+                               nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+                               nsresult aRcode,</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+                               const char *aErrmsg)</span>
<a href="#l3.70"></a><span id="l3.70"> {</span>
<a href="#l3.71"></a><span id="l3.71">     NS_ENSURE_ARG_POINTER(aFilterAction);</span>
<a href="#l3.72"></a><span id="l3.72">     NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74">     NS_ENSURE_TRUE(m_filterList, NS_OK);</span>
<a href="#l3.75"></a><span id="l3.75">     nsCOMPtr &lt;nsIOutputStream&gt; logStream;</span>
<a href="#l3.76"></a><span id="l3.76">     nsresult rv = m_filterList-&gt;GetLogStream(getter_AddRefs(logStream));</span>
<a href="#l3.77"></a><span id="l3.77">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineat">@@ -527,16 +555,48 @@ NS_IMETHODIMP nsMsgFilter::LogRuleHit(ns</span>
<a href="#l3.79"></a><span id="l3.79">       mozilla::services::GetStringBundleService();</span>
<a href="#l3.80"></a><span id="l3.80">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l3.81"></a><span id="l3.81"> </span>
<a href="#l3.82"></a><span id="l3.82">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l3.83"></a><span id="l3.83">     rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/filter.properties&quot;,</span>
<a href="#l3.84"></a><span id="l3.84">       getter_AddRefs(bundle));</span>
<a href="#l3.85"></a><span id="l3.85">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.86"></a><span id="l3.86"> </span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+    // If error, prefix with the error code and error message.</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+    // A desired wording (without NEWLINEs):</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+    // Filter Action Failed &quot;Move failed&quot; with error code=0x80004005</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+    // while attempting: Applied filter &quot;test&quot; to message from</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+    // Some Test &lt;test@example.com&gt; - send test 3 at 2/13/2015 11:32:53 AM</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+    // moved message id = 54DE5165.7000907@example.com to</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+    // mailbox://nobody@Local%20Folders/test</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+    if (NS_FAILED(aRcode))</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    {</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+      // Let us put &quot;Filter Action Failed: &quot;%s&quot; with error code=%s while attempting: &quot; inside bundle.</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+      // Convert aErrmsg to UTF16 string, and</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+      // convert aRcode to UTF16 string in advance.</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+      char tcode[20];</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+      PR_snprintf(tcode, sizeof(tcode), &quot;0x%08x&quot;, aRcode);</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+      NS_ConvertASCIItoUTF16 tcode16(tcode) ;</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+      NS_ConvertASCIItoUTF16 tErrmsg16(aErrmsg) ;</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+      const char16_t *logErrorFormatStrings[2] = { tErrmsg16.get(),  tcode16.get()};</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+      nsString filterFailureWarningPrefix;</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+      rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+                      MOZ_UTF16(&quot;filterFailureWarningPrefix&quot;),</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+                      logErrorFormatStrings, 2,</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+                      getter_Copies(filterFailureWarningPrefix));</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+      buffer += NS_ConvertUTF16toUTF8(filterFailureWarningPrefix);</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+      buffer += &quot;\n&quot;;</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+    }</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+</span>
<a href="#l3.119"></a><span id="l3.119">     const char16_t *filterLogDetectFormatStrings[4] = { filterName.get(), authorValue.get(), subjectValue.get(), dateValue.get() };</span>
<a href="#l3.120"></a><span id="l3.120">     nsString filterLogDetectStr;</span>
<a href="#l3.121"></a><span id="l3.121">     rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l3.122"></a><span id="l3.122">       MOZ_UTF16(&quot;filterLogDetectStr&quot;),</span>
<a href="#l3.123"></a><span id="l3.123">       filterLogDetectFormatStrings, 4,</span>
<a href="#l3.124"></a><span id="l3.124">       getter_Copies(filterLogDetectStr));</span>
<a href="#l3.125"></a><span id="l3.125">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127" class="difflineat">@@ -586,16 +646,20 @@ NS_IMETHODIMP nsMsgFilter::LogRuleHit(ns</span>
<a href="#l3.128"></a><span id="l3.128">       filterActionID.AppendInt(actionType);</span>
<a href="#l3.129"></a><span id="l3.129">       rv = bundle-&gt;GetStringFromName(filterActionID.get(), getter_Copies(actionValue));</span>
<a href="#l3.130"></a><span id="l3.130">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.131"></a><span id="l3.131"> </span>
<a href="#l3.132"></a><span id="l3.132">       buffer += NS_ConvertUTF16toUTF8(actionValue);</span>
<a href="#l3.133"></a><span id="l3.133">     }</span>
<a href="#l3.134"></a><span id="l3.134">     buffer += &quot;\n&quot;;</span>
<a href="#l3.135"></a><span id="l3.135"> </span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+    // XXX: Finally, here we have enough context and buffer</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+    // (string) to display the filtering error if we want: for</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+    // example, a sticky error message in status bar, etc.</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+</span>
<a href="#l3.140"></a><span id="l3.140">     uint32_t writeCount;</span>
<a href="#l3.141"></a><span id="l3.141"> </span>
<a href="#l3.142"></a><span id="l3.142">     rv = logStream-&gt;Write(LOG_ENTRY_START_TAG, LOG_ENTRY_START_TAG_LEN, &amp;writeCount);</span>
<a href="#l3.143"></a><span id="l3.143">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.144"></a><span id="l3.144">     NS_ASSERTION(writeCount == LOG_ENTRY_START_TAG_LEN, &quot;failed to write out start log tag&quot;);</span>
<a href="#l3.145"></a><span id="l3.145"> </span>
<a href="#l3.146"></a><span id="l3.146">     // html escape the log for security reasons.</span>
<a href="#l3.147"></a><span id="l3.147">     // we don't want some to send us a message with a subject with</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineat">@@ -611,16 +675,30 @@ NS_IMETHODIMP nsMsgFilter::LogRuleHit(ns</span>
<a href="#l3.149"></a><span id="l3.149">     NS_ASSERTION(writeCount == escapedBufferLen, &quot;failed to write out log hit&quot;);</span>
<a href="#l3.150"></a><span id="l3.150"> </span>
<a href="#l3.151"></a><span id="l3.151">     rv = logStream-&gt;Write(LOG_ENTRY_END_TAG, LOG_ENTRY_END_TAG_LEN, &amp;writeCount);</span>
<a href="#l3.152"></a><span id="l3.152">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.153"></a><span id="l3.153">     NS_ASSERTION(writeCount == LOG_ENTRY_END_TAG_LEN, &quot;failed to write out end log tag&quot;);</span>
<a href="#l3.154"></a><span id="l3.154">     return NS_OK;</span>
<a href="#l3.155"></a><span id="l3.155"> }</span>
<a href="#l3.156"></a><span id="l3.156"> </span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::LogRuleHit(nsIMsgRuleAction *aFilterAction,</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+                                      nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+{</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+  return nsMsgFilter::LogRuleHitGeneric(aFilterAction, aMsgHdr, NS_OK, nullptr);</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+}</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::LogRuleHitFail(nsIMsgRuleAction *aFilterAction,</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+                                          nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+                                          nsresult aRcode,</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+                                          const char *aErrMsg)</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+{</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+  return nsMsgFilter::LogRuleHitGeneric(aFilterAction, aMsgHdr, aRcode, aErrMsg);</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+}</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+</span>
<a href="#l3.171"></a><span id="l3.171"> NS_IMETHODIMP</span>
<a href="#l3.172"></a><span id="l3.172"> nsMsgFilter::MatchHdr(nsIMsgDBHdr *msgHdr, nsIMsgFolder *folder,</span>
<a href="#l3.173"></a><span id="l3.173">                       nsIMsgDatabase *db, const char *headers,</span>
<a href="#l3.174"></a><span id="l3.174">                       uint32_t headersSize, bool *pResult)</span>
<a href="#l3.175"></a><span id="l3.175"> {</span>
<a href="#l3.176"></a><span id="l3.176">   NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l3.177"></a><span id="l3.177">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l3.178"></a><span id="l3.178">   // use offlineMail because</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineat">@@ -955,9 +1033,8 @@ nsMsgFilter::GetVersion()</span>
<a href="#l3.180"></a><span id="l3.180"> #ifdef DEBUG</span>
<a href="#l3.181"></a><span id="l3.181"> void nsMsgFilter::Dump()</span>
<a href="#l3.182"></a><span id="l3.182"> {</span>
<a href="#l3.183"></a><span id="l3.183">   nsAutoCString s;</span>
<a href="#l3.184"></a><span id="l3.184">   LossyCopyUTF16toASCII(m_filterName, s);</span>
<a href="#l3.185"></a><span id="l3.185">   printf(&quot;filter %s type = %c desc = %s\n&quot;, s.get(), m_type + '0', m_description.get());</span>
<a href="#l3.186"></a><span id="l3.186"> }</span>
<a href="#l3.187"></a><span id="l3.187"> #endif</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilter.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilter.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -65,16 +65,26 @@ public:</span>
<a href="#l4.4"></a><span id="l4.4">   void      Dump();</span>
<a href="#l4.5"></a><span id="l4.5"> #endif</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">   nsresult  ConvertMoveOrCopyToFolderValue(nsIMsgRuleAction *filterAction, nsCString &amp;relativePath);</span>
<a href="#l4.8"></a><span id="l4.8">   static const char *GetActionStr(nsMsgRuleActionType action);</span>
<a href="#l4.9"></a><span id="l4.9">   static nsresult GetActionFilingStr(nsMsgRuleActionType action, nsCString &amp;actionStr);</span>
<a href="#l4.10"></a><span id="l4.10">   static nsMsgRuleActionType GetActionForFilingStr(nsCString &amp;actionStr);</span>
<a href="#l4.11"></a><span id="l4.11"> protected:</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  /*</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+   * Reporting function for filtering success/failure.</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+   * Logging has to be enabled for the message to appear.</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+   */</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  nsresult LogRuleHitGeneric(nsIMsgRuleAction *aFilterAction,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+                             nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+                             nsresult aRcode,</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+                             const char *aErrmsg);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+</span>
<a href="#l4.22"></a><span id="l4.22">   virtual ~nsMsgFilter();</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24">   nsMsgFilterTypeType m_type;</span>
<a href="#l4.25"></a><span id="l4.25">   nsString    m_filterName;</span>
<a href="#l4.26"></a><span id="l4.26">   nsCString   m_scriptFileName;  // iff this filter is a script.</span>
<a href="#l4.27"></a><span id="l4.27">   nsCString   m_description;</span>
<a href="#l4.28"></a><span id="l4.28">   nsCString   m_unparsedBuffer;</span>
<a href="#l4.29"></a><span id="l4.29"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -420,16 +420,24 @@ nsresult nsMsgFilterAfterTheFact::Advanc</span>
<a href="#l5.4"></a><span id="l5.4">       // final end of nsMsgFilterAfterTheFact object</span>
<a href="#l5.5"></a><span id="l5.5">       return OnEndExecution();</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">     // reset the filter index to apply all filters to this new folder</span>
<a href="#l5.8"></a><span id="l5.8">     m_curFilterIndex = 0;</span>
<a href="#l5.9"></a><span id="l5.9">     m_nextAction = 0;</span>
<a href="#l5.10"></a><span id="l5.10">     rv = m_folders-&gt;QueryElementAt(m_curFolderIndex++, NS_GET_IID(nsIMsgFolder), getter_AddRefs(m_curFolder));</span>
<a href="#l5.11"></a><span id="l5.11">     CONTINUE_IF_FAILURE(rv, &quot;Could not get next folder&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    // Note: I got rv = NS_OK but null m_curFolder after deleting a folder</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    // outside of TB, when I select a single message and &quot;run filter on message&quot;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+    // and the filter is to move the message to the deleted folder.</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+     // m_curFolder may be null when the folder is deleted externally.</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+    CONTINUE_IF_FALSE(m_curFolder, &quot;Next folder returned null&quot;);</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+</span>
<a href="#l5.20"></a><span id="l5.20">     rv = m_curFolder-&gt;GetMsgDatabase(getter_AddRefs(m_curFolderDB));</span>
<a href="#l5.21"></a><span id="l5.21">     if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l5.22"></a><span id="l5.22">     {</span>
<a href="#l5.23"></a><span id="l5.23">       nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_curFolder, &amp;rv);</span>
<a href="#l5.24"></a><span id="l5.24">       if (NS_SUCCEEDED(rv) &amp;&amp; localFolder)</span>
<a href="#l5.25"></a><span id="l5.25">         // will continue with OnStopRunningUrl</span>
<a href="#l5.26"></a><span id="l5.26">         return localFolder-&gt;ParseFolder(m_msgWindow, this);</span>
<a href="#l5.27"></a><span id="l5.27">     }</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineat">@@ -1063,16 +1071,19 @@ nsresult nsMsgApplyFiltersToMessages::Ru</span>
<a href="#l5.29"></a><span id="l5.29">       m_nextAction = 0;</span>
<a href="#l5.30"></a><span id="l5.30">       rv = ApplyFilter();</span>
<a href="#l5.31"></a><span id="l5.31">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.32"></a><span id="l5.32">         return NS_OK; // async callback will continue, or we are done.</span>
<a href="#l5.33"></a><span id="l5.33">     }</span>
<a href="#l5.34"></a><span id="l5.34">   }</span>
<a href="#l5.35"></a><span id="l5.35">   m_curFilter = nullptr;</span>
<a href="#l5.36"></a><span id="l5.36">   NS_WARN_IF_FALSE(NS_SUCCEEDED(rv), &quot;Failed to run filters&quot;);</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  // We expect the failure is already recorded through one of the macro</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  // expressions, that will have console logging added to them.</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  // So an additional console warning is not needed here.</span>
<a href="#l5.40"></a><span id="l5.40">   return AdvanceToNextFolder();</span>
<a href="#l5.41"></a><span id="l5.41"> }</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43"> NS_IMETHODIMP nsMsgFilterService::ApplyFilters(nsMsgFilterTypeType aFilterType,</span>
<a href="#l5.44"></a><span id="l5.44">                                                nsIArray *aMsgHdrList,</span>
<a href="#l5.45"></a><span id="l5.45">                                                nsIMsgFolder *aFolder,</span>
<a href="#l5.46"></a><span id="l5.46">                                                nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.47"></a><span id="l5.47">                                                nsIMsgOperationListener *aCallback)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -932,17 +932,17 @@ nsresult nsParseMailMessageState::ParseH</span>
<a href="#l6.4"></a><span id="l6.4">   while (buf &lt; buf_end)</span>
<a href="#l6.5"></a><span id="l6.5">   {</span>
<a href="#l6.6"></a><span id="l6.6">     char *colon = PL_strnchr(buf, ':', buf_end - buf);</span>
<a href="#l6.7"></a><span id="l6.7">     char *end;</span>
<a href="#l6.8"></a><span id="l6.8">     char *value = 0;</span>
<a href="#l6.9"></a><span id="l6.9">     struct message_header *header = 0;</span>
<a href="#l6.10"></a><span id="l6.10">     struct message_header receivedBy;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    if (! colon)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    if (!colon)</span>
<a href="#l6.14"></a><span id="l6.14">       break;</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">     end = colon;</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18">     switch (buf [0])</span>
<a href="#l6.19"></a><span id="l6.19">     {</span>
<a href="#l6.20"></a><span id="l6.20">     case 'B': case 'b':</span>
<a href="#l6.21"></a><span id="l6.21">       if (!PL_strncasecmp (&quot;BCC&quot;, buf, end - buf))</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -1472,17 +1472,17 @@ nsresult nsParseMailMessageState::Finali</span>
<a href="#l6.23"></a><span id="l6.23">       if (bccList)</span>
<a href="#l6.24"></a><span id="l6.24">       {</span>
<a href="#l6.25"></a><span id="l6.25">         m_newMsgHdr-&gt;SetBccList(bccList-&gt;value);</span>
<a href="#l6.26"></a><span id="l6.26">       }</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28">       rv = InternSubject (subject);</span>
<a href="#l6.29"></a><span id="l6.29">       if (NS_SUCCEEDED(rv))</span>
<a href="#l6.30"></a><span id="l6.30">       {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-        if (! id)</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+        if (!id)</span>
<a href="#l6.33"></a><span id="l6.33">         {</span>
<a href="#l6.34"></a><span id="l6.34">           // what to do about this? we used to do a hash of all the headers...</span>
<a href="#l6.35"></a><span id="l6.35">           nsAutoCString hash;</span>
<a href="#l6.36"></a><span id="l6.36">           const char *md5_b64 = &quot;dummy.message.id&quot;;</span>
<a href="#l6.37"></a><span id="l6.37">           nsresult rv;</span>
<a href="#l6.38"></a><span id="l6.38">           nsCOMPtr&lt;nsICryptoHash&gt; hasher = do_CreateInstance(&quot;@mozilla.org/security/hash;1&quot;, &amp;rv);</span>
<a href="#l6.39"></a><span id="l6.39">           if (NS_SUCCEEDED(rv))</span>
<a href="#l6.40"></a><span id="l6.40">           {</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineat">@@ -1822,33 +1822,37 @@ int32_t nsParseNewMailState::PublishMsgH</span>
<a href="#l6.42"></a><span id="l6.42">               {</span>
<a href="#l6.43"></a><span id="l6.43">                 rv = msgStore-&gt;DiscardNewMessage(m_outputStream, m_newMsgHdr);</span>
<a href="#l6.44"></a><span id="l6.44">                 if (NS_FAILED(rv))</span>
<a href="#l6.45"></a><span id="l6.45">                   m_rootFolder-&gt;ThrowAlertMsg(&quot;dupDeleteFolderTruncateFailed&quot;, msgWindow);</span>
<a href="#l6.46"></a><span id="l6.46">               }</span>
<a href="#l6.47"></a><span id="l6.47">                 m_mailDB-&gt;RemoveHeaderMdbRow(m_newMsgHdr);</span>
<a href="#l6.48"></a><span id="l6.48">               }</span>
<a href="#l6.49"></a><span id="l6.49">               break;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+</span>
<a href="#l6.51"></a><span id="l6.51">             case nsIMsgIncomingServer::moveDupsToTrash:</span>
<a href="#l6.52"></a><span id="l6.52">               {</span>
<a href="#l6.53"></a><span id="l6.53">                 nsCOMPtr &lt;nsIMsgFolder&gt; trash;</span>
<a href="#l6.54"></a><span id="l6.54">                 GetTrashFolder(getter_AddRefs(trash));</span>
<a href="#l6.55"></a><span id="l6.55">                 if (trash) {</span>
<a href="#l6.56"></a><span id="l6.56">                   uint32_t newFlags;</span>
<a href="#l6.57"></a><span id="l6.57">                   bool msgMoved;</span>
<a href="#l6.58"></a><span id="l6.58">                   m_newMsgHdr-&gt;AndFlags(~nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l6.59"></a><span id="l6.59">                   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l6.60"></a><span id="l6.60">                   rv = m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l6.61"></a><span id="l6.61">                   if (NS_SUCCEEDED(rv))</span>
<a href="#l6.62"></a><span id="l6.62">                     rv = msgStore-&gt;MoveNewlyDownloadedMessage(m_newMsgHdr, trash, &amp;msgMoved);</span>
<a href="#l6.63"></a><span id="l6.63">                   if (NS_SUCCEEDED(rv) &amp;&amp; !msgMoved) {</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-                    MoveIncorporatedMessage(m_newMsgHdr, m_mailDB, trash,</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+                    rv = MoveIncorporatedMessage(m_newMsgHdr, m_mailDB, trash,</span>
<a href="#l6.66"></a><span id="l6.66">                                             nullptr, msgWindow);</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-                    m_mailDB-&gt;RemoveHeaderMdbRow(m_newMsgHdr);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+                    if (NS_SUCCEEDED(rv))</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+                      rv = m_mailDB-&gt;RemoveHeaderMdbRow(m_newMsgHdr);</span>
<a href="#l6.70"></a><span id="l6.70">                   }</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+                  if (NS_FAILED(rv))</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+                    NS_WARNING(&quot;moveDupsToTrash failed for some reason.&quot;);</span>
<a href="#l6.73"></a><span id="l6.73">                 }</span>
<a href="#l6.74"></a><span id="l6.74">               }</span>
<a href="#l6.75"></a><span id="l6.75">               break;</span>
<a href="#l6.76"></a><span id="l6.76">             case nsIMsgIncomingServer::markDupsRead:</span>
<a href="#l6.77"></a><span id="l6.77">               MarkFilteredMessageRead(m_newMsgHdr);</span>
<a href="#l6.78"></a><span id="l6.78">               break;</span>
<a href="#l6.79"></a><span id="l6.79">           }</span>
<a href="#l6.80"></a><span id="l6.80">           int32_t numNewMessages;</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineat">@@ -2012,16 +2016,19 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l6.82"></a><span id="l6.82">           // set value to trash folder</span>
<a href="#l6.83"></a><span id="l6.83">           rv = GetTrashFolder(getter_AddRefs(trash));</span>
<a href="#l6.84"></a><span id="l6.84">           if (NS_SUCCEEDED(rv) &amp;&amp; trash)</span>
<a href="#l6.85"></a><span id="l6.85">             rv = trash-&gt;GetURI(actionTargetFolderUri);</span>
<a href="#l6.86"></a><span id="l6.86"> </span>
<a href="#l6.87"></a><span id="l6.87">           msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read, &amp;newFlags); // mark read in trash.</span>
<a href="#l6.88"></a><span id="l6.88">           msgIsNew = false;</span>
<a href="#l6.89"></a><span id="l6.89">         }</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+        // FALLTHROUGH</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+</span>
<a href="#l6.93"></a><span id="l6.93">       case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l6.94"></a><span id="l6.94">         // if moving to a different file, do it.</span>
<a href="#l6.95"></a><span id="l6.95">         if (actionTargetFolderUri.get() &amp;&amp; !m_inboxUri.Equals(actionTargetFolderUri,</span>
<a href="#l6.96"></a><span id="l6.96">                                                               nsCaseInsensitiveCStringComparator()))</span>
<a href="#l6.97"></a><span id="l6.97">         {</span>
<a href="#l6.98"></a><span id="l6.98">           nsresult err;</span>
<a href="#l6.99"></a><span id="l6.99">           nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;err));</span>
<a href="#l6.100"></a><span id="l6.100">           NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineat">@@ -2029,17 +2036,17 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l6.102"></a><span id="l6.102">           err = rdf-&gt;GetResource(actionTargetFolderUri, getter_AddRefs(res));</span>
<a href="#l6.103"></a><span id="l6.103">           if (NS_FAILED(err))</span>
<a href="#l6.104"></a><span id="l6.104">             return err;</span>
<a href="#l6.105"></a><span id="l6.105"> </span>
<a href="#l6.106"></a><span id="l6.106">           nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder(do_QueryInterface(res, &amp;err));</span>
<a href="#l6.107"></a><span id="l6.107">           if (NS_FAILED(err))</span>
<a href="#l6.108"></a><span id="l6.108">             return err;</span>
<a href="#l6.109"></a><span id="l6.109">           bool msgMoved = false;</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-          // if we're moving to an imap folder, or this message has already </span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+          // If we're moving to an imap folder, or this message has already</span>
<a href="#l6.112"></a><span id="l6.112">           // has a pending copy action, use the imap coalescer so that</span>
<a href="#l6.113"></a><span id="l6.113">           // we won't truncate the inbox before the copy fires.</span>
<a href="#l6.114"></a><span id="l6.114">           if (m_msgCopiedByFilter ||</span>
<a href="#l6.115"></a><span id="l6.115">               StringBeginsWith(actionTargetFolderUri, NS_LITERAL_CSTRING(&quot;imap:&quot;)))</span>
<a href="#l6.116"></a><span id="l6.116">           {</span>
<a href="#l6.117"></a><span id="l6.117">             if (!m_moveCoalescer)</span>
<a href="#l6.118"></a><span id="l6.118">               m_moveCoalescer = new nsImapMoveCoalescer(m_downloadFolder, m_msgWindow);</span>
<a href="#l6.119"></a><span id="l6.119">             NS_ENSURE_TRUE(m_moveCoalescer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineat">@@ -2054,42 +2061,60 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l6.121"></a><span id="l6.121">             nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l6.122"></a><span id="l6.122">             err = m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l6.123"></a><span id="l6.123">             if (NS_SUCCEEDED(err))</span>
<a href="#l6.124"></a><span id="l6.124">               err = msgStore-&gt;MoveNewlyDownloadedMessage(msgHdr, destIFolder, &amp;msgMoved);</span>
<a href="#l6.125"></a><span id="l6.125">             if (NS_SUCCEEDED(err) &amp;&amp; !msgMoved)</span>
<a href="#l6.126"></a><span id="l6.126">               err = MoveIncorporatedMessage(msgHdr, m_mailDB, destIFolder,</span>
<a href="#l6.127"></a><span id="l6.127">                                             filter, msgWindow);</span>
<a href="#l6.128"></a><span id="l6.128">             m_msgMovedByFilter = NS_SUCCEEDED(err);</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+            if (!m_msgMovedByFilter /* == NS_FAILED(err) */)</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+            {</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+              // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+              if (loggingEnabled)</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+                (void) filter-&gt;LogRuleHitFail(filterAction, msgHdr, err, &quot;Move failed&quot;);</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+            }</span>
<a href="#l6.135"></a><span id="l6.135">           }</span>
<a href="#l6.136"></a><span id="l6.136">         }</span>
<a href="#l6.137"></a><span id="l6.137">         *applyMore = false;</span>
<a href="#l6.138"></a><span id="l6.138">         break;</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+</span>
<a href="#l6.140"></a><span id="l6.140">         case nsMsgFilterAction::CopyToFolder:</span>
<a href="#l6.141"></a><span id="l6.141">         {</span>
<a href="#l6.142"></a><span id="l6.142">           nsCString uri;</span>
<a href="#l6.143"></a><span id="l6.143">           rv = m_rootFolder-&gt;GetURI(uri);</span>
<a href="#l6.144"></a><span id="l6.144"> </span>
<a href="#l6.145"></a><span id="l6.145">           if (!actionTargetFolderUri.IsEmpty() &amp;&amp; !actionTargetFolderUri.Equals(uri))</span>
<a href="#l6.146"></a><span id="l6.146">           {</span>
<a href="#l6.147"></a><span id="l6.147">             nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l6.148"></a><span id="l6.148">             messageArray-&gt;AppendElement(msgHdr, false);</span>
<a href="#l6.149"></a><span id="l6.149"> </span>
<a href="#l6.150"></a><span id="l6.150">             nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder;</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+            nsCOMPtr&lt;nsIMsgCopyService&gt; copyService;</span>
<a href="#l6.152"></a><span id="l6.152">             rv = GetExistingFolder(actionTargetFolderUri,</span>
<a href="#l6.153"></a><span id="l6.153">                                    getter_AddRefs(dstFolder));</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+            if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+              copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+            }</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+            else {</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+              // Let's show a more specific warning.</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+              NS_WARNING(&quot;Target Folder does not exist.&quot;);</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+              return rv;</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+            }</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+            if (NS_SUCCEEDED(rv))</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+              rv = copyService-&gt;CopyMessages(m_downloadFolder, messageArray, dstFolder,</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+                                             false, nullptr, msgWindow, false);</span>
<a href="#l6.166"></a><span id="l6.166"> </span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-            nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-              do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-            rv = copyService-&gt;CopyMessages(m_downloadFolder, messageArray, dstFolder,</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-                                           false, nullptr, msgWindow, false);</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-            m_msgCopiedByFilter = true;</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+            if (NS_FAILED(rv)) {</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+              // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+              if (loggingEnabled)</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+                (void) filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv, &quot;Copy failed&quot;);</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+            }</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+            else</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+              m_msgCopiedByFilter = true;</span>
<a href="#l6.181"></a><span id="l6.181">           }</span>
<a href="#l6.182"></a><span id="l6.182">         }</span>
<a href="#l6.183"></a><span id="l6.183">         break;</span>
<a href="#l6.184"></a><span id="l6.184">       case nsMsgFilterAction::MarkRead:</span>
<a href="#l6.185"></a><span id="l6.185">         msgIsNew = false;</span>
<a href="#l6.186"></a><span id="l6.186">         MarkFilteredMessageRead(msgHdr);</span>
<a href="#l6.187"></a><span id="l6.187">         break;</span>
<a href="#l6.188"></a><span id="l6.188">       case nsMsgFilterAction::MarkUnread:</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineat">@@ -2226,25 +2251,35 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l6.190"></a><span id="l6.190">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.191"></a><span id="l6.191"> </span>
<a href="#l6.192"></a><span id="l6.192">         nsAutoCString value;</span>
<a href="#l6.193"></a><span id="l6.193">         filterAction-&gt;GetStrValue(value);</span>
<a href="#l6.194"></a><span id="l6.194"> </span>
<a href="#l6.195"></a><span id="l6.195">         nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l6.196"></a><span id="l6.196">             do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l6.197"></a><span id="l6.197">         NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-        messageArray-&gt;AppendElement(msgHdr, false);</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+          rv = messageArray-&gt;AppendElement(msgHdr, false);</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+</span>
<a href="#l6.202"></a><span id="l6.202"> </span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-        customAction-&gt;Apply(messageArray, value, nullptr,</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-                            nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+          rv = customAction-&gt;Apply(messageArray, value, nullptr,</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+                                   nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+        if (NS_FAILED(rv)) {</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+            // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+            if (loggingEnabled)</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+              (void) filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv, &quot;Copy failed&quot;);</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+        }</span>
<a href="#l6.213"></a><span id="l6.213">       }</span>
<a href="#l6.214"></a><span id="l6.214">       break;</span>
<a href="#l6.215"></a><span id="l6.215"> </span>
<a href="#l6.216"></a><span id="l6.216"> </span>
<a href="#l6.217"></a><span id="l6.217">       default:</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+        // XXX should not be reached. Check in debug build.</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+        NS_ERROR(&quot;This default should not be reached.&quot;);</span>
<a href="#l6.220"></a><span id="l6.220">         break;</span>
<a href="#l6.221"></a><span id="l6.221">       }</span>
<a href="#l6.222"></a><span id="l6.222">     }</span>
<a href="#l6.223"></a><span id="l6.223">   }</span>
<a href="#l6.224"></a><span id="l6.224">   if (!msgIsNew)</span>
<a href="#l6.225"></a><span id="l6.225">   {</span>
<a href="#l6.226"></a><span id="l6.226">     int32_t numNewMessages;</span>
<a href="#l6.227"></a><span id="l6.227">     m_downloadFolder-&gt;GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineat">@@ -2565,9 +2600,8 @@ nsresult nsParseNewMailState::MoveIncorp</span>
<a href="#l6.229"></a><span id="l6.229"> </span>
<a href="#l6.230"></a><span id="l6.230">   // update the folder size so we won't reparse.</span>
<a href="#l6.231"></a><span id="l6.231">   UpdateDBFolderInfo(destMailDB);</span>
<a href="#l6.232"></a><span id="l6.232">   destIFolder-&gt;UpdateSummaryTotals(true);</span>
<a href="#l6.233"></a><span id="l6.233"> </span>
<a href="#l6.234"></a><span id="l6.234">   destMailDB-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l6.235"></a><span id="l6.235">   return rv;</span>
<a href="#l6.236"></a><span id="l6.236"> }</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

