<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23739:ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b" />
<meta property="og:url" content="/comm-central/rev/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b" />
<meta property="og:description" content="Bug 1440587 - Move calProviderUtils to the cal.provider namespace - automatic provider changes. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b">shortlog</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b">files</a> |
changeset |
<a href="/comm-central/raw-rev/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b">raw</a>  | <a href="/comm-central/archive/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1440587">Bug 1440587</a> - Move calProviderUtils to the cal.provider namespace - automatic provider changes. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 22 Feb 2018 22:09:13 +0100</td></tr>

<tr>
 <td>changeset 23739</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b">ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b</a></td>
</tr>



<tr>
<td>parent 23738</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e48e853cdc1aa149ce1cc0e4a4ab7ccf1c95af85">e48e853cdc1aa149ce1cc0e4a4ab7ccf1c95af85</a>
</td>
</tr>

<tr>
<td>child 23740</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8465c91e98aed2afb9fd5e595678e6a126a44f0b">8465c91e98aed2afb9fd5e595678e6a126a44f0b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b">14318</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Sat, 14 Apr 2018 20:53:18 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@56a8323d4235 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=56a8323d4235bb4edbc60b455d3590100a4af34d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=56a8323d4235bb4edbc60b455d3590100a4af34d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=56a8323d4235bb4edbc60b455d3590100a4af34d&newProject=comm-central&newRevision=2a4475b8555b7ca273fa96b199621a4360d510f7&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=56a8323d4235bb4edbc60b455d3590100a4af34d&newProject=comm-central&newRevision=2a4475b8555b7ca273fa96b199621a4360d510f7&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=56a8323d4235bb4edbc60b455d3590100a4af34d&newProject=comm-central&newRevision=2a4475b8555b7ca273fa96b199621a4360d510f7&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1440587">1440587</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1440587">Bug 1440587</a> - Move calProviderUtils to the cal.provider namespace - automatic provider changes. r=MakeMyDay

MozReview-Commit-ID: Jt0omp68ReS</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/modules/calUtilsCompat.jsm">calendar/base/modules/calUtilsCompat.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/modules/calUtilsCompat.jsm">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/modules/calUtilsCompat.jsm">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/modules/calUtilsCompat.jsm">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/modules/calUtilsCompat.jsm">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/modules/calUtilsCompat.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calDefaultACLManager.js">calendar/base/src/calDefaultACLManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calDefaultACLManager.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calDefaultACLManager.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calDefaultACLManager.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calDefaultACLManager.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/base/src/calDefaultACLManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataRequest.jsm">calendar/providers/gdata/modules/gdataRequest.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataRequest.jsm">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataRequest.jsm">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataRequest.jsm">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataRequest.jsm">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataRequest.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataSession.jsm">calendar/providers/gdata/modules/gdataSession.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataSession.jsm">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataSession.jsm">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataSession.jsm">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataSession.jsm">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataSession.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataUtils.jsm">calendar/providers/gdata/modules/gdataUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataUtils.jsm">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataUtils.jsm">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/gdata/modules/gdataUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/storage/calStorageUpgrade.jsm">calendar/providers/storage/calStorageUpgrade.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/storage/calStorageUpgrade.jsm">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/storage/calStorageUpgrade.jsm">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/storage/calStorageUpgrade.jsm">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/storage/calStorageUpgrade.jsm">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/storage/calStorageUpgrade.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapCalendar.js">calendar/providers/wcap/calWcapCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapCalendar.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapCalendar.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapCalendar.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapCalendar.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapRequest.js">calendar/providers/wcap/calWcapRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapRequest.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapRequest.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapRequest.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapRequest.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/test/unit/test_freebusy_service.js">calendar/test/unit/test_freebusy_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/test/unit/test_freebusy_service.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/test/unit/test_freebusy_service.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/test/unit/test_freebusy_service.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/test/unit/test_freebusy_service.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/test/unit/test_freebusy_service.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/test/unit/test_gdata_provider.js">calendar/test/unit/test_gdata_provider.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/test/unit/test_gdata_provider.js">file</a> |
<a href="/comm-central/annotate/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/test/unit/test_gdata_provider.js">annotate</a> |
<a href="/comm-central/diff/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/test/unit/test_gdata_provider.js">diff</a> |
<a href="/comm-central/comparison/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/test/unit/test_gdata_provider.js">comparison</a> |
<a href="/comm-central/log/ba90a7aa8c228a7e2b1d6e52ce2b99be339b682b/calendar/test/unit/test_gdata_provider.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -10,541 +10,591 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l1.4"></a><span id="l1.4"> ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> XPCOMUtils.defineLazyModuleGetter(this, &quot;cal&quot;, &quot;resource://calendar/modules/calUtils.jsm&quot;, &quot;cal&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> /*</span>
<a href="#l1.9"></a><span id="l1.9">  * Provider helper code</span>
<a href="#l1.10"></a><span id="l1.10">  */</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;calprovider&quot;]; /* exported calprovider */</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+var calprovider = {</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    /**</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+     * Prepare HTTP channel with standard request headers and upload data/content-type if needed.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+     *</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+     * @param {nsIURI} aUri                                     Channel Uri, will only be used for a</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+     *                                                            new channel.</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+     * @param {nsIInputStream|String} aUploadData               Data to be uploaded, if any. This</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+     *                                                            may be a nsIInputStream or string</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+     *                                                            data. In the latter case the</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+     *                                                            string will be converted to an</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+     *                                                            input stream.</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+     * @param {String} aContentType                             Value for Content-Type header, if any</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+     * @param {nsIInterfaceRequestor} aNotificationCallbacks    Calendar using channel</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+     * @param {?nsIChannel} aExisting                           An existing channel to modify (optional)</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+     * @return {nsIChannel}                                     The prepared channel</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+     */</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    prepHttpChannel: function(aUri, aUploadData, aContentType, aNotificationCallbacks, aExisting=null) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+        let channel = aExisting || Services.io.newChannelFromURI2(aUri,</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+                                                                  null,</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+                                                                  Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+                                                                  null,</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+                                                                  Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+                                                                  Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+        let httpchannel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+        httpchannel.setRequestHeader(&quot;Accept&quot;, &quot;text/xml&quot;, false);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+        httpchannel.setRequestHeader(&quot;Accept-Charset&quot;, &quot;utf-8,*;q=0.1&quot;, false);</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+        httpchannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+        httpchannel.notificationCallbacks = aNotificationCallbacks;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+        if (aUploadData) {</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+            httpchannel = httpchannel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+            let stream;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+            if (aUploadData instanceof Components.interfaces.nsIInputStream) {</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+                // Make sure the stream is reset</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+                stream = aUploadData.QueryInterface(Components.interfaces.nsISeekableStream);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+                stream.seek(Components.interfaces.nsISeekableStream.NS_SEEK_SET, 0);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+            } else {</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+                // Otherwise its something that should be a string, convert it.</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+                let converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+                                          .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+                converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+                stream = converter.convertToInputStream(aUploadData.toString());</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+            }</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+            httpchannel.setUploadStream(stream, aContentType, -1);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+        }</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+        return httpchannel;</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+    },</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+    /**</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+     * Send prepared HTTP request asynchronously</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+     *</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+     * @param {nsIStreamLoader} aStreamLoader       Stream loader for request</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+     * @param {nsIChannel} aChannel                 Channel for request</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+     * @param {nsIStreamLoaderObserver} aListener   Listener for method completion</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+     */</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+    sendHttpRequest: function(aStreamLoader, aChannel, aListener) {</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+        aStreamLoader.init(aListener);</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+        aChannel.asyncOpen(aStreamLoader, aChannel);</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+    },</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+    /**</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+     * Shortcut to create an nsIStreamLoader</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+     *</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+     * @return {nsIStreamLoader}        A fresh streamloader</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+     */</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+    createStreamLoader: function() {</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+        return Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+                         .createInstance(Components.interfaces.nsIStreamLoader);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+    },</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+    /**</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+     * Convert a byte array to a string</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+     *</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+     * @param {octet[]} aResult         The bytes to convert</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+     * @param {Number} aResultLength    The number of bytes</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+     * @param {String} aCharset         The character set of the bytes, defaults to utf-8</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+     * @param {Boolean} aThrow          If true, the function will raise an exception on error</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+     * @return {?String}                The string result, or null on error</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+     */</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+    convertByteArray: function(aResult, aResultLength, aCharset, aThrow) {</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+        try {</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+            let resultConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+                                            .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+            resultConverter.charset = aCharset || &quot;UTF-8&quot;;</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+            return resultConverter.convertFromByteArray(aResult, aResultLength);</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+        } catch (e) {</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+            if (aThrow) {</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+                throw e;</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+            }</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+        }</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+        return null;</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+    },</span>
<a href="#l1.110"></a><span id="l1.110"> </span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-/**</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">- * Prepare HTTP channel with standard request headers and upload</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">- * data/content-type if needed</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">- *</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">- * @param arUri                      Channel Uri, will only be used for a new</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">- *                                     channel.</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">- * @param aUploadData                Data to be uploaded, if any. This may be a</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">- *                                     nsIInputStream or string data. In the</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">- *                                     latter case the string will be converted</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">- *                                     to an input stream.</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">- * @param aContentType               Value for Content-Type header, if any</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">- * @param aNotificationCallbacks     Calendar using channel</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">- * @param aExisting                  An existing channel to modify (optional)</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">- */</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-cal.prepHttpChannel = function(aUri, aUploadData, aContentType, aNotificationCallbacks, aExisting) {</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-    let channel = aExisting || Services.io.newChannelFromURI2(aUri,</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-                                                              null,</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-                                                              Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-                                                              null,</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-                                                              Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-                                                              Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-    let httpchannel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+    /**</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+     * getInterface method for providers. This should be called in the context of</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+     * the respective provider, i.e</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+     *</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+     * return cal.provider.InterfaceRequestor_getInterface.apply(this, arguments);</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+     *</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+     * or</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+     * ...</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+     * getInterface: cal.provider.InterfaceRequestor_getInterface,</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+     * ...</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+     *</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+     * NOTE: If the server only provides one realm for all calendars, be sure that</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+     * the |this| object implements calICalendar. In this case the calendar name</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+     * will be appended to the realm. If you need that feature disabled, see the</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+     * capabilities section of calICalendar.idl</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+     *</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+     * @param {nsIIDRef} aIID       The interface ID to return</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+     * @return {nsISupports}        The requested interface</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+     */</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+    InterfaceRequestor_getInterface: function(aIID) {</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+        try {</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+            // Try to query the this object for the requested interface but don't</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+            // throw if it fails since that borks the network code.</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+            return this.QueryInterface(aIID);</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+        } catch (e) {</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+            // Support Auth Prompt Interfaces</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+            if (aIID.equals(Components.interfaces.nsIAuthPrompt2)) {</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+                if (!this.calAuthPrompt) {</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+                    this.calAuthPrompt = new cal.auth.Prompt();</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+                }</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+                return this.calAuthPrompt;</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+            } else if (aIID.equals(Components.interfaces.nsIAuthPromptProvider) ||</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+                       aIID.equals(Components.interfaces.nsIPrompt)) {</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+                return Services.ww.getNewPrompter(null);</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+            } else if (aIID.equals(Components.interfaces.nsIBadCertListener2)) {</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+                if (!this.badCertHandler) {</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+                    this.badCertHandler = new cal.provider.BadCertHandler(this);</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+                }</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+                return this.badCertHandler;</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+            } else {</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+                Components.returnCode = e;</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+            }</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+        }</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+        return null;</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+    },</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+    /**</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+     * Bad Certificate Handler for Network Requests. Shows the Network Exception</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+     * Dialog if a certificate Problem occurs.</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+     */</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+    BadCertHandler: class {</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+        QueryInterface(iid) {</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+            return cal.generateClassQI(this, iid, [Components.interfaces.nsIBadCertListener2]);</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+        }</span>
<a href="#l1.187"></a><span id="l1.187"> </span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-    httpchannel.setRequestHeader(&quot;Accept&quot;, &quot;text/xml&quot;, false);</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-    httpchannel.setRequestHeader(&quot;Accept-Charset&quot;, &quot;utf-8,*;q=0.1&quot;, false);</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-    httpchannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-    httpchannel.notificationCallbacks = aNotificationCallbacks;</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+        constructor(thisProvider) {</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+            this.thisProvider = thisProvider;</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+            this.timer = null;</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+        }</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+        notifyCertProblem(socketInfo, status, targetSite) {</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+            // Unfortunately we can't pass js objects using the window watcher, so</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+            // we'll just take the first available calendar window. We also need to</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+            // do this on a timer so that the modal window doesn't block the</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+            // network request.</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+            let calWindow = cal.window.getCalendarWindow();</span>
<a href="#l1.203"></a><span id="l1.203"> </span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-    if (aUploadData) {</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-        httpchannel = httpchannel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-        let stream;</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-        if (aUploadData instanceof Components.interfaces.nsIInputStream) {</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-            // Make sure the stream is reset</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-            stream = aUploadData.QueryInterface(Components.interfaces.nsISeekableStream);</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-            stream.seek(Components.interfaces.nsISeekableStream.NS_SEEK_SET, 0);</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-        } else {</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-            // Otherwise its something that should be a string, convert it.</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-            let converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-                                      .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-            converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-            stream = converter.convertToInputStream(aUploadData.toString());</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+            let timerCallback = {</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+                thisProvider: this.thisProvider,</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+                notify: function(timer) {</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+                    let params = {</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+                        exceptionAdded: false,</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+                        sslStatus: status,</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+                        prefetchCert: true,</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+                        location: targetSite</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+                    };</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+                    calWindow.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;,</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+                                         &quot;&quot;,</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+                                         &quot;chrome,centerscreen,modal&quot;,</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+                                         params);</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+                    if (this.thisProvider.canRefresh &amp;&amp;</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+                        params.exceptionAdded) {</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+                        // Refresh the provider if the</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+                        // exception certificate was added</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+                        this.thisProvider.refresh();</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+                    }</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+                }</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+            };</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+            this.timer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+                                   .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+            this.timer.initWithCallback(</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+                timerCallback,</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+                0,</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+                Components.interfaces.nsITimer.TYPE_ONE_SHOT</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+            );</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+            return true;</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+        }</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+    },</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+    /**</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+     * Freebusy interval implementation. All parameters are optional.</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+     *</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+     * @param aCalId         The calendar id to set up with.</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+     * @param aFreeBusyType  The type from calIFreeBusyInterval.</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+     * @param aStart         The start of the interval.</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+     * @param aEnd           The end of the interval.</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+     * @return               The fresh calIFreeBusyInterval.</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+     */</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+    FreeBusyInterval: class {</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+        QueryInterface(iid) {</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+            return cal.generateClassQI(this, iid, [Components.interfaces.calIFreeBusyInterval]);</span>
<a href="#l1.261"></a><span id="l1.261">         }</span>
<a href="#l1.262"></a><span id="l1.262"> </span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-        httpchannel.setUploadStream(stream, aContentType, -1);</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-    }</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+        constructor(aCalId, aFreeBusyType, aStart, aEnd) {</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+            this.calId = aCalId;</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+            this.interval = Components.classes[&quot;@mozilla.org/calendar/period;1&quot;]</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+                                      .createInstance(Components.interfaces.calIPeriod);</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+            this.interval.start = aStart;</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+            this.interval.end = aEnd;</span>
<a href="#l1.271"></a><span id="l1.271"> </span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-    return httpchannel;</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-};</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+            this.freeBusyType = aFreeBusyType || Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+        }</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineplus">+    },</span>
<a href="#l1.277"></a><span id="l1.277"> </span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-/**</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">- * calSendHttpRequest; send prepared HTTP request</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">- *</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">- * @param aStreamLoader     streamLoader for request</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">- * @param aChannel          channel for request</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">- * @param aListener         listener for method completion</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">- */</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-cal.sendHttpRequest = function(aStreamLoader, aChannel, aListener) {</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-    aStreamLoader.init(aListener);</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-    aChannel.asyncOpen(aStreamLoader, aChannel);</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-};</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+    /**</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineplus">+     * Gets the iTIP/iMIP transport if the passed calendar has configured email.</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+     *</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+     * @param {calICalendar} aCalendar      The calendar to get the transport for</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+     * @return {?calIItipTransport}         The email transport, or null if no identity configured</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+     */</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+    getImipTransport: function(aCalendar) {</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+        // assure an identity is configured for the calendar</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+        if (aCalendar &amp;&amp; aCalendar.getProperty(&quot;imip.identity&quot;)) {</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+            return Components.classes[&quot;@mozilla.org/calendar/itip-transport;1?type=email&quot;]</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+                             .getService(Components.interfaces.calIItipTransport);</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+        }</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+        return null;</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineplus">+    },</span>
<a href="#l1.303"></a><span id="l1.303"> </span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-cal.createStreamLoader = function() {</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-    return Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-                     .createInstance(Components.interfaces.nsIStreamLoader);</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-};</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+    /**</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+     * Gets the configured identity and account of a particular calendar instance, or null.</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+     *</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineplus">+     * @param {calICalendar} aCalendar      Calendar instance</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineplus">+     * @param {?Object} outAccount          Optional out value for account</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+     * @return {nsIMsgIdentity}             The configured identity</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+     */</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineplus">+    getEmailIdentityOfCalendar: function(aCalendar, outAccount) {</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+        cal.ASSERT(aCalendar, &quot;no calendar!&quot;, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+        let key = aCalendar.getProperty(&quot;imip.identity.key&quot;);</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+        if (key === null) { // take default account/identity:</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+            let findIdentity = function(account) {</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+                if (account &amp;&amp; account.identities.length) {</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+                    return account.defaultIdentity ||</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineplus">+                           account.identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineplus">+                }</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineplus">+                return null;</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+            };</span>
<a href="#l1.326"></a><span id="l1.326"> </span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-cal.convertByteArray = function(aResult, aResultLength, aCharset, aThrow) {</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-    try {</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-        let resultConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-                                        .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-        resultConverter.charset = aCharset || &quot;UTF-8&quot;;</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-        return resultConverter.convertFromByteArray(aResult, aResultLength);</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-    } catch (e) {</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineminus">-        if (aThrow) {</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-            throw e;</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">-        }</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">-    }</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-    return null;</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-};</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineplus">+            let foundAccount = (function() {</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineplus">+                try {</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+                    return MailServices.accounts.defaultAccount;</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+                } catch (e) {</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineplus">+                    return null;</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineplus">+                }</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineplus">+            })();</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineplus">+            let foundIdentity = findIdentity(foundAccount);</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineplus">+</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineplus">+            if (!foundAccount || !foundIdentity) {</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+                let accounts = MailServices.accounts.accounts;</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineplus">+                for (let account of fixIterator(accounts, Components.interfaces.nsIMsgAccount)) {</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineplus">+                    let identity = findIdentity(account);</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineplus">+</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineplus">+                    if (account &amp;&amp; identity) {</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineplus">+                        foundAccount = account;</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineplus">+                        foundIdentity = identity;</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+                        break;</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+                    }</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineplus">+                }</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineplus">+            }</span>
<a href="#l1.361"></a><span id="l1.361"> </span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-/**</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">- * getInterface method for providers. This should be called in the context of</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">- * the respective provider, i.e</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">- *</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">- * return cal.InterfaceRequestor_getInterface.apply(this, arguments);</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">- *</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">- * or</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">- * ...</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">- * getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineminus">- * ...</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">- *</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineminus">- * NOTE: If the server only provides one realm for all calendars, be sure that</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineminus">- * the |this| object implements calICalendar. In this case the calendar name</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineminus">- * will be appended to the realm. If you need that feature disabled, see the</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">- * capabilities section of calICalendar.idl</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineminus">- *</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineminus">- * @param aIID      The interface ID to return</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">- */</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-cal.InterfaceRequestor_getInterface = function(aIID) {</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-    try {</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-        // Try to query the this object for the requested interface but don't</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineminus">-        // throw if it fails since that borks the network code.</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-        return this.QueryInterface(aIID);</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-    } catch (e) {</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-        // Support Auth Prompt Interfaces</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-        if (aIID.equals(Components.interfaces.nsIAuthPrompt2)) {</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineminus">-            if (!this.calAuthPrompt) {</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineminus">-                this.calAuthPrompt = new cal.auth.Prompt();</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+            if (outAccount) {</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineplus">+                outAccount.value = foundIdentity ? foundAccount : null;</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineplus">+            }</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineplus">+            return foundIdentity;</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineplus">+        } else {</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineplus">+            if (key.length == 0) { // i.e. &quot;None&quot;</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineplus">+                return null;</span>
<a href="#l1.397"></a><span id="l1.397">             }</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineminus">-            return this.calAuthPrompt;</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineminus">-        } else if (aIID.equals(Components.interfaces.nsIAuthPromptProvider) ||</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineminus">-                   aIID.equals(Components.interfaces.nsIPrompt)) {</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineminus">-            return Services.ww.getNewPrompter(null);</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineminus">-        } else if (aIID.equals(Components.interfaces.nsIBadCertListener2)) {</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-            if (!this.badCertHandler) {</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineminus">-                this.badCertHandler = new cal.BadCertHandler(this);</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineplus">+            let identity = null;</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineplus">+            cal.email.iterateIdentities((identity_, account) =&gt; {</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineplus">+                if (identity_.key == key) {</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineplus">+                    identity = identity_;</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineplus">+                    if (outAccount) {</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineplus">+                        outAccount.value = account;</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineplus">+                    }</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineplus">+                }</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineplus">+                return (identity_.key != key);</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineplus">+            });</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineplus">+</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineplus">+            if (!identity) {</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineplus">+                // dangling identity:</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineplus">+                cal.WARN(&quot;Calendar &quot; + (aCalendar.uri ? aCalendar.uri.spec : aCalendar.id) +</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineplus">+                         &quot; has a dangling E-Mail identity configured.&quot;);</span>
<a href="#l1.420"></a><span id="l1.420">             }</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineminus">-            return this.badCertHandler;</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineminus">-        } else {</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineminus">-            Components.returnCode = e;</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineplus">+            return identity;</span>
<a href="#l1.425"></a><span id="l1.425">         }</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineminus">-    }</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineminus">-    return null;</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineminus">-};</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineplus">+    },</span>
<a href="#l1.430"></a><span id="l1.430"> </span>
<a href="#l1.431"></a><span id="l1.431" class="difflineminus">-/**</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineminus">- * Bad Certificate Handler for Network Requests. Shows the Network Exception</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">- * Dialog if a certificate Problem occurs.</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineminus">- */</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineminus">-cal.BadCertHandler = function(thisProvider) {</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineminus">-    this.thisProvider = thisProvider;</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-};</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineminus">-cal.BadCertHandler.prototype = {</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineminus">-    QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIBadCertListener2]),</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineminus">-    timer: null,</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineplus">+    /**</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineplus">+     * Opens the calendar conflict dialog</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineplus">+     *</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineplus">+     * @param {String} aMode        The conflict mode, either &quot;modify&quot; or &quot;delete&quot;</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineplus">+     * @param {calIItemBase} aItem  The item to raise a conflict for</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineplus">+     * @return {Boolean}            True, if the item should be overwritten</span>
<a href="#l1.447"></a><span id="l1.447" class="difflineplus">+     */</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineplus">+    promptOverwrite: function(aMode, aItem) {</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineplus">+        let window = cal.window.getCalendarWindow();</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineplus">+        let args = {</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineplus">+            item: aItem,</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineplus">+            mode: aMode,</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineplus">+            overwrite: false</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineplus">+        };</span>
<a href="#l1.455"></a><span id="l1.455"> </span>
<a href="#l1.456"></a><span id="l1.456" class="difflineminus">-    notifyCertProblem: function(socketInfo, status, targetSite) {</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineminus">-        // Unfortunately we can't pass js objects using the window watcher, so</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineminus">-        // we'll just take the first available calendar window. We also need to</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineminus">-        // do this on a timer so that the modal window doesn't block the</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineminus">-        // network request.</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineminus">-        let calWindow = cal.window.getCalendarWindow();</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineplus">+        window.openDialog(&quot;chrome://calendar/content/calendar-conflicts-dialog.xul&quot;,</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineplus">+                          &quot;calendarConflictsDialog&quot;,</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineplus">+                          &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineplus">+                          args);</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineplus">+</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineplus">+        return args.overwrite;</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineplus">+    },</span>
<a href="#l1.469"></a><span id="l1.469"> </span>
<a href="#l1.470"></a><span id="l1.470" class="difflineminus">-        let timerCallback = {</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineminus">-            thisProvider: this.thisProvider,</span>
<a href="#l1.472"></a><span id="l1.472" class="difflineminus">-            notify: function(timer) {</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineminus">-                let params = {</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineminus">-                    exceptionAdded: false,</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineminus">-                    sslStatus: status,</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-                    prefetchCert: true,</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineminus">-                    location: targetSite</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineminus">-                };</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineminus">-                calWindow.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;,</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineminus">-                                     &quot;&quot;,</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineminus">-                                     &quot;chrome,centerscreen,modal&quot;,</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineminus">-                                     params);</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineminus">-                if (this.thisProvider.canRefresh &amp;&amp;</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineminus">-                    params.exceptionAdded) {</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineminus">-                    // Refresh the provider if the</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineminus">-                    // exception certificate was added</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineminus">-                    this.thisProvider.refresh();</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineplus">+    /**</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineplus">+     * Gets the calendar directory, defaults to &lt;profile-dir&gt;/calendar-data</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineplus">+     *</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineplus">+     * @return {nsIFile}        The calendar-data directory as nsIFile</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineplus">+     */</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineplus">+    getCalendarDirectory: function() {</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineplus">+        if (calprovider.getCalendarDirectory.mDir === undefined) {</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+            let dir = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineplus">+            dir.append(&quot;calendar-data&quot;);</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineplus">+            if (!dir.exists()) {</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineplus">+                try {</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineplus">+                    dir.create(Components.interfaces.nsIFile.DIRECTORY_TYPE, 0o700);</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineplus">+                } catch (exc) {</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineplus">+                    cal.ASSERT(false, exc);</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineplus">+                    throw exc;</span>
<a href="#l1.503"></a><span id="l1.503">                 }</span>
<a href="#l1.504"></a><span id="l1.504">             }</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineminus">-        };</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineminus">-        this.timer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineminus">-                               .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineminus">-        this.timer.initWithCallback(</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineminus">-            timerCallback,</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineminus">-            0,</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineminus">-            Components.interfaces.nsITimer.TYPE_ONE_SHOT</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineminus">-        );</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineminus">-        return true;</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineminus">-    }</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineminus">-};</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineplus">+            calprovider.getCalendarDirectory.mDir = dir;</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineplus">+        }</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineplus">+        return calprovider.getCalendarDirectory.mDir.clone();</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineplus">+    },</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineplus">+</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineplus">+    /**</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineplus">+     * Base prototype to be used implementing a provider.</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineplus">+     *</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineplus">+     * @see e.g. providers/gdata</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineplus">+     */</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineplus">+    BaseClass: class {</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineplus">+        /**</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineplus">+         * The transient proeprties that are not pesisted to storage</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineplus">+         */</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineplus">+        static get mTransientProperties() {</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineplus">+            return {</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineplus">+                &quot;cache.uncachedCalendar&quot;: true,</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineplus">+                &quot;currentStatus&quot;: true,</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineplus">+                &quot;itip.transport&quot;: true,</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineplus">+                &quot;imip.identity&quot;: true,</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineplus">+                &quot;imip.account&quot;: true,</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineplus">+                &quot;imip.identity.disabled&quot;: true,</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineplus">+                &quot;organizerId&quot;: true,</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineplus">+                &quot;organizerCN&quot;: true</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineplus">+            };</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineplus">+        }</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineplus">+</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineplus">+        QueryInterface(iid) {</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineplus">+            return cal.generateClassQI(this, iid, [</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineplus">+                Components.interfaces.calICalendar,</span>
<a href="#l1.546"></a><span id="l1.546" class="difflineplus">+                Components.interfaces.calISchedulingSupport</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineplus">+            ]);</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineplus">+        }</span>
<a href="#l1.549"></a><span id="l1.549"> </span>
<a href="#l1.550"></a><span id="l1.550" class="difflineminus">-/**</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineminus">- * Freebusy interval implementation. All parameters are optional.</span>
<a href="#l1.552"></a><span id="l1.552" class="difflineminus">- *</span>
<a href="#l1.553"></a><span id="l1.553" class="difflineminus">- * @param aCalId         The calendar id to set up with.</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineminus">- * @param aFreeBusyType  The type from calIFreeBusyInterval.</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineminus">- * @param aStart         The start of the interval.</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineminus">- * @param aEnd           The end of the interval.</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineminus">- * @return               The fresh calIFreeBusyInterval.</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineminus">- */</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineminus">-cal.FreeBusyInterval = function(aCalId, aFreeBusyType, aStart, aEnd) {</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineminus">-    this.calId = aCalId;</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineminus">-    this.interval = Components.classes[&quot;@mozilla.org/calendar/period;1&quot;]</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineminus">-                              .createInstance(Components.interfaces.calIPeriod);</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineminus">-    this.interval.start = aStart;</span>
<a href="#l1.564"></a><span id="l1.564" class="difflineminus">-    this.interval.end = aEnd;</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineplus">+        /**</span>
<a href="#l1.566"></a><span id="l1.566" class="difflineplus">+         * Initialize the base class, this should be migrated to an ES6 constructor once all</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineplus">+         * subclasses are also es6 classes. Call this from the constructor.</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineplus">+         */</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineplus">+        initProviderBase() {</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineplus">+            this.wrappedJSObject = this;</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineplus">+            this.mID = null;</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineplus">+            this.mUri = null;</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineplus">+            this.mACLEntry = null;</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineplus">+            this.mBatchCount = 0;</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineplus">+            this.transientProperties = false;</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineplus">+            this.mObservers = new cal.data.ObserverSet(Components.interfaces.calIObserver);</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineplus">+            this.mProperties = {};</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineplus">+            this.mProperties.currentStatus = Components.results.NS_OK;</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineplus">+        }</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineplus">+</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineplus">+        /**</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineplus">+         * Returns the calIObservers for this calendar</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineplus">+         */</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineplus">+        get observers() {</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineplus">+            return this.mObservers;</span>
<a href="#l1.586"></a><span id="l1.586" class="difflineplus">+        }</span>
<a href="#l1.587"></a><span id="l1.587"> </span>
<a href="#l1.588"></a><span id="l1.588" class="difflineminus">-    this.freeBusyType = aFreeBusyType || Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineminus">-};</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineminus">-cal.FreeBusyInterval.prototype = {</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineminus">-    QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIFreeBusyInterval]),</span>
<a href="#l1.592"></a><span id="l1.592" class="difflineminus">-    calId: null,</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineminus">-    interval: null,</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineminus">-    freeBusyType: Components.interfaces.calIFreeBusyInterval.UNKNOWN</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineminus">-};</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineplus">+        // attribute AUTF8String id;</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineplus">+        get id() {</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineplus">+            return this.mID;</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineplus">+        }</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineplus">+        set id(aValue) {</span>
<a href="#l1.601"></a><span id="l1.601" class="difflineplus">+            if (this.mID) {</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineplus">+                throw Components.results.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineplus">+            }</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineplus">+            this.mID = aValue;</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineplus">+</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineplus">+            let calMgr = cal.getCalendarManager();</span>
<a href="#l1.607"></a><span id="l1.607" class="difflineplus">+</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineplus">+            // make all properties persistent that have been set so far:</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineplus">+            for (let aName in this.mProperties) {</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineplus">+                if (!this.constructor.mTransientProperties[aName]) {</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineplus">+                    let value = this.mProperties[aName];</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineplus">+                    if (value !== null) {</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineplus">+                        calMgr.setCalendarPref_(this, aName, value);</span>
<a href="#l1.614"></a><span id="l1.614" class="difflineplus">+                    }</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineplus">+                }</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineplus">+            }</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineplus">+</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineplus">+            return aValue;</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineplus">+        }</span>
<a href="#l1.620"></a><span id="l1.620"> </span>
<a href="#l1.621"></a><span id="l1.621" class="difflineminus">-/**</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">- * Gets the iTIP/iMIP transport if the passed calendar has configured email.</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">- */</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-cal.getImipTransport = function(aCalendar) {</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineminus">-    // assure an identity is configured for the calendar</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineminus">-    return (aCalendar &amp;&amp; aCalendar.getProperty(&quot;imip.identity&quot;)</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineminus">-            ? Components.classes[&quot;@mozilla.org/calendar/itip-transport;1?type=email&quot;]</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineminus">-                        .getService(Components.interfaces.calIItipTransport)</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineminus">-            : null);</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineminus">-};</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineplus">+        // attribute AUTF8String name;</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineplus">+        get name() {</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineplus">+            return this.getProperty(&quot;name&quot;);</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineplus">+        }</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineplus">+        set name(aValue) {</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineplus">+            return this.setProperty(&quot;name&quot;, aValue);</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineplus">+        }</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineplus">+</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineplus">+        // readonly attribute calICalendarACLManager aclManager;</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineplus">+        get aclManager() {</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineplus">+            const defaultACLProviderClass = &quot;@mozilla.org/calendar/acl-manager;1?type=default&quot;;</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineplus">+            let providerClass = this.getProperty(&quot;aclManagerClass&quot;);</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineplus">+            if (!providerClass || !Components.classes[providerClass]) {</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineplus">+                providerClass = defaultACLProviderClass;</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineplus">+            }</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineplus">+            return Components.classes[providerClass].getService(Components.interfaces.calICalendarACLManager);</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineplus">+        }</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineplus">+</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineplus">+        // readonly attribute calICalendarACLEntry aclEntry;</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineplus">+        get aclEntry() {</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineplus">+            return this.mACLEntry;</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineplus">+        }</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineplus">+</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineplus">+        // attribute calICalendar superCalendar;</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineplus">+        get superCalendar() {</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineplus">+            // If we have a superCalendar, check this calendar for a superCalendar.</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineplus">+            // This will make sure the topmost calendar is returned</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineplus">+            return (this.mSuperCalendar ? this.mSuperCalendar.superCalendar : this);</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineplus">+        }</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineplus">+        set superCalendar(val) {</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineplus">+            return (this.mSuperCalendar = val);</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineplus">+        }</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineplus">+</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineplus">+        // attribute nsIURI uri;</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineplus">+        get uri() {</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineplus">+            return this.mUri;</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineplus">+        }</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineplus">+        set uri(aValue) {</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineplus">+            return (this.mUri = aValue);</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineplus">+        }</span>
<a href="#l1.671"></a><span id="l1.671"> </span>
<a href="#l1.672"></a><span id="l1.672" class="difflineminus">-/**</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineminus">- * Gets the configured identity and account of a particular calendar instance, or null.</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineminus">- *</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineminus">- * @param aCalendar     Calendar instance</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineminus">- * @param outAccount    Optional out value for account</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineminus">- * @return              The configured identity</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineminus">- */</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineminus">-cal.getEmailIdentityOfCalendar = function(aCalendar, outAccount) {</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineminus">-    cal.ASSERT(aCalendar, &quot;no calendar!&quot;, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineminus">-    let key = aCalendar.getProperty(&quot;imip.identity.key&quot;);</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineminus">-    if (key === null) { // take default account/identity:</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineminus">-        let findIdentity = function(account) {</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineminus">-            if (account &amp;&amp; account.identities.length) {</span>
<a href="#l1.685"></a><span id="l1.685" class="difflineminus">-                return account.defaultIdentity ||</span>
<a href="#l1.686"></a><span id="l1.686" class="difflineminus">-                       account.identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineplus">+        // attribute boolean readOnly;</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineplus">+        get readOnly() {</span>
<a href="#l1.689"></a><span id="l1.689" class="difflineplus">+            return this.getProperty(&quot;readOnly&quot;);</span>
<a href="#l1.690"></a><span id="l1.690" class="difflineplus">+        }</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineplus">+        set readOnly(aValue) {</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineplus">+            return this.setProperty(&quot;readOnly&quot;, aValue);</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineplus">+        }</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineplus">+</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineplus">+        // readonly attribute boolean canRefresh;</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineplus">+        get canRefresh() {</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineplus">+            return false;</span>
<a href="#l1.698"></a><span id="l1.698" class="difflineplus">+        }</span>
<a href="#l1.699"></a><span id="l1.699" class="difflineplus">+</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineplus">+        // void startBatch();</span>
<a href="#l1.701"></a><span id="l1.701" class="difflineplus">+        startBatch() {</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineplus">+            if (this.mBatchCount++ == 0) {</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineplus">+                this.mObservers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l1.704"></a><span id="l1.704">             }</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineminus">-            return null;</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineminus">-        };</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineplus">+        }</span>
<a href="#l1.708"></a><span id="l1.708"> </span>
<a href="#l1.709"></a><span id="l1.709" class="difflineminus">-        let foundAccount = (function() {</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineminus">-            try {</span>
<a href="#l1.711"></a><span id="l1.711" class="difflineminus">-                return MailServices.accounts.defaultAccount;</span>
<a href="#l1.712"></a><span id="l1.712" class="difflineminus">-            } catch (e) {</span>
<a href="#l1.713"></a><span id="l1.713" class="difflineminus">-                return null;</span>
<a href="#l1.714"></a><span id="l1.714" class="difflineplus">+        // void endBatch();</span>
<a href="#l1.715"></a><span id="l1.715" class="difflineplus">+        endBatch() {</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineplus">+            if (this.mBatchCount &gt; 0) {</span>
<a href="#l1.717"></a><span id="l1.717" class="difflineplus">+                if (--this.mBatchCount == 0) {</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineplus">+                    this.mObservers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineplus">+                }</span>
<a href="#l1.720"></a><span id="l1.720" class="difflineplus">+            } else {</span>
<a href="#l1.721"></a><span id="l1.721" class="difflineplus">+                cal.ASSERT(this.mBatchCount &gt; 0, &quot;unexepcted endBatch!&quot;);</span>
<a href="#l1.722"></a><span id="l1.722">             }</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineminus">-        })();</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineminus">-        let foundIdentity = findIdentity(foundAccount);</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineplus">+        }</span>
<a href="#l1.726"></a><span id="l1.726"> </span>
<a href="#l1.727"></a><span id="l1.727" class="difflineminus">-        if (!foundAccount || !foundIdentity) {</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineminus">-            let accounts = MailServices.accounts.accounts;</span>
<a href="#l1.729"></a><span id="l1.729" class="difflineminus">-            for (let account of fixIterator(accounts, Components.interfaces.nsIMsgAccount)) {</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineminus">-                let identity = findIdentity(account);</span>
<a href="#l1.731"></a><span id="l1.731" class="difflineminus">-</span>
<a href="#l1.732"></a><span id="l1.732" class="difflineminus">-                if (account &amp;&amp; identity) {</span>
<a href="#l1.733"></a><span id="l1.733" class="difflineminus">-                    foundAccount = account;</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineminus">-                    foundIdentity = identity;</span>
<a href="#l1.735"></a><span id="l1.735" class="difflineminus">-                    break;</span>
<a href="#l1.736"></a><span id="l1.736" class="difflineplus">+        /**</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineplus">+         * Notifies the given listener for onOperationComplete, ignoring (but logging) any</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineplus">+         * exceptions that occur. If no listener is passed the function is a no-op.</span>
<a href="#l1.739"></a><span id="l1.739" class="difflineplus">+         *</span>
<a href="#l1.740"></a><span id="l1.740" class="difflineplus">+         * @param {?calIOperationListener} aListener        The listener to notify</span>
<a href="#l1.741"></a><span id="l1.741" class="difflineplus">+         * @param {Number} aStatus                          A Components.results result</span>
<a href="#l1.742"></a><span id="l1.742" class="difflineplus">+         * @param {Number} aOperationType                   The operation type component</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineplus">+         * @param {String} aId                              The item id</span>
<a href="#l1.744"></a><span id="l1.744" class="difflineplus">+         * @param {*} aDetail                               The item detail for the listener</span>
<a href="#l1.745"></a><span id="l1.745" class="difflineplus">+         */</span>
<a href="#l1.746"></a><span id="l1.746" class="difflineplus">+        notifyPureOperationComplete(aListener, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l1.747"></a><span id="l1.747" class="difflineplus">+            if (aListener) {</span>
<a href="#l1.748"></a><span id="l1.748" class="difflineplus">+                try {</span>
<a href="#l1.749"></a><span id="l1.749" class="difflineplus">+                    aListener.onOperationComplete(this.superCalendar, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l1.750"></a><span id="l1.750" class="difflineplus">+                } catch (exc) {</span>
<a href="#l1.751"></a><span id="l1.751" class="difflineplus">+                    cal.ERROR(exc);</span>
<a href="#l1.752"></a><span id="l1.752">                 }</span>
<a href="#l1.753"></a><span id="l1.753">             }</span>
<a href="#l1.754"></a><span id="l1.754">         }</span>
<a href="#l1.755"></a><span id="l1.755"> </span>
<a href="#l1.756"></a><span id="l1.756" class="difflineminus">-        if (outAccount) {</span>
<a href="#l1.757"></a><span id="l1.757" class="difflineminus">-            outAccount.value = foundIdentity ? foundAccount : null;</span>
<a href="#l1.758"></a><span id="l1.758" class="difflineminus">-        }</span>
<a href="#l1.759"></a><span id="l1.759" class="difflineminus">-        return foundIdentity;</span>
<a href="#l1.760"></a><span id="l1.760" class="difflineminus">-    } else {</span>
<a href="#l1.761"></a><span id="l1.761" class="difflineminus">-        if (key.length == 0) { // i.e. &quot;None&quot;</span>
<a href="#l1.762"></a><span id="l1.762" class="difflineminus">-            return null;</span>
<a href="#l1.763"></a><span id="l1.763" class="difflineminus">-        }</span>
<a href="#l1.764"></a><span id="l1.764" class="difflineminus">-        let identity = null;</span>
<a href="#l1.765"></a><span id="l1.765" class="difflineminus">-        cal.email.iterateIdentities((identity_, account) =&gt; {</span>
<a href="#l1.766"></a><span id="l1.766" class="difflineminus">-            if (identity_.key == key) {</span>
<a href="#l1.767"></a><span id="l1.767" class="difflineminus">-                identity = identity_;</span>
<a href="#l1.768"></a><span id="l1.768" class="difflineminus">-                if (outAccount) {</span>
<a href="#l1.769"></a><span id="l1.769" class="difflineminus">-                    outAccount.value = account;</span>
<a href="#l1.770"></a><span id="l1.770" class="difflineminus">-                }</span>
<a href="#l1.771"></a><span id="l1.771" class="difflineminus">-            }</span>
<a href="#l1.772"></a><span id="l1.772" class="difflineminus">-            return (identity_.key != key);</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineminus">-        });</span>
<a href="#l1.774"></a><span id="l1.774" class="difflineminus">-</span>
<a href="#l1.775"></a><span id="l1.775" class="difflineminus">-        if (!identity) {</span>
<a href="#l1.776"></a><span id="l1.776" class="difflineminus">-            // dangling identity:</span>
<a href="#l1.777"></a><span id="l1.777" class="difflineminus">-            cal.WARN(&quot;Calendar &quot; + (aCalendar.uri ? aCalendar.uri.spec : aCalendar.id) +</span>
<a href="#l1.778"></a><span id="l1.778" class="difflineminus">-                     &quot; has a dangling E-Mail identity configured.&quot;);</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineminus">-        }</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineminus">-        return identity;</span>
<a href="#l1.781"></a><span id="l1.781" class="difflineminus">-    }</span>
<a href="#l1.782"></a><span id="l1.782" class="difflineminus">-};</span>
<a href="#l1.783"></a><span id="l1.783" class="difflineplus">+        /**</span>
<a href="#l1.784"></a><span id="l1.784" class="difflineplus">+         * Notifies the given listener for onOperationComplete, also setting various calendar status</span>
<a href="#l1.785"></a><span id="l1.785" class="difflineplus">+         * variables and notifying about the error.</span>
<a href="#l1.786"></a><span id="l1.786" class="difflineplus">+         *</span>
<a href="#l1.787"></a><span id="l1.787" class="difflineplus">+         * @param {?calIOperationListener} aListener        The listener to notify</span>
<a href="#l1.788"></a><span id="l1.788" class="difflineplus">+         * @param {Number} aStatus                          A Components.results result</span>
<a href="#l1.789"></a><span id="l1.789" class="difflineplus">+         * @param {Number} aOperationType                   The operation type component</span>
<a href="#l1.790"></a><span id="l1.790" class="difflineplus">+         * @param {String} aId                              The item id</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineplus">+         * @param {*} aDetail                               The item detail for the listener</span>
<a href="#l1.792"></a><span id="l1.792" class="difflineplus">+         * @param {String} aExtraMessage                    An extra message to pass to notifyError</span>
<a href="#l1.793"></a><span id="l1.793" class="difflineplus">+         */</span>
<a href="#l1.794"></a><span id="l1.794" class="difflineplus">+        notifyOperationComplete(aListener, aStatus, aOperationType, aId, aDetail, aExtraMessage) {</span>
<a href="#l1.795"></a><span id="l1.795" class="difflineplus">+            this.notifyPureOperationComplete(aListener, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l1.796"></a><span id="l1.796"> </span>
<a href="#l1.797"></a><span id="l1.797" class="difflineminus">-cal.promptOverwrite = function(aMode, aItem) {</span>
<a href="#l1.798"></a><span id="l1.798" class="difflineminus">-    let window = cal.window.getCalendarWindow();</span>
<a href="#l1.799"></a><span id="l1.799" class="difflineminus">-    let args = {</span>
<a href="#l1.800"></a><span id="l1.800" class="difflineminus">-        item: aItem,</span>
<a href="#l1.801"></a><span id="l1.801" class="difflineminus">-        mode: aMode,</span>
<a href="#l1.802"></a><span id="l1.802" class="difflineminus">-        overwrite: false</span>
<a href="#l1.803"></a><span id="l1.803" class="difflineminus">-    };</span>
<a href="#l1.804"></a><span id="l1.804" class="difflineminus">-</span>
<a href="#l1.805"></a><span id="l1.805" class="difflineminus">-    window.openDialog(&quot;chrome://calendar/content/calendar-conflicts-dialog.xul&quot;,</span>
<a href="#l1.806"></a><span id="l1.806" class="difflineminus">-                      &quot;calendarConflictsDialog&quot;,</span>
<a href="#l1.807"></a><span id="l1.807" class="difflineminus">-                      &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l1.808"></a><span id="l1.808" class="difflineminus">-                      args);</span>
<a href="#l1.809"></a><span id="l1.809" class="difflineminus">-</span>
<a href="#l1.810"></a><span id="l1.810" class="difflineminus">-    return args.overwrite;</span>
<a href="#l1.811"></a><span id="l1.811" class="difflineminus">-};</span>
<a href="#l1.812"></a><span id="l1.812" class="difflineminus">-</span>
<a href="#l1.813"></a><span id="l1.813" class="difflineminus">-/**</span>
<a href="#l1.814"></a><span id="l1.814" class="difflineminus">- * Gets the calendar directory, defaults to &lt;profile-dir&gt;/calendar-data</span>
<a href="#l1.815"></a><span id="l1.815" class="difflineminus">- */</span>
<a href="#l1.816"></a><span id="l1.816" class="difflineminus">-cal.getCalendarDirectory = function() {</span>
<a href="#l1.817"></a><span id="l1.817" class="difflineminus">-    if (cal.getCalendarDirectory.mDir === undefined) {</span>
<a href="#l1.818"></a><span id="l1.818" class="difflineminus">-        let dir = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l1.819"></a><span id="l1.819" class="difflineminus">-        dir.append(&quot;calendar-data&quot;);</span>
<a href="#l1.820"></a><span id="l1.820" class="difflineminus">-        if (!dir.exists()) {</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineminus">-            try {</span>
<a href="#l1.822"></a><span id="l1.822" class="difflineminus">-                dir.create(Components.interfaces.nsIFile.DIRECTORY_TYPE, 0o700);</span>
<a href="#l1.823"></a><span id="l1.823" class="difflineminus">-            } catch (exc) {</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineminus">-                cal.ASSERT(false, exc);</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineminus">-                throw exc;</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineplus">+            if (aStatus == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l1.827"></a><span id="l1.827" class="difflineplus">+                return; // cancellation doesn't change current status, no notification</span>
<a href="#l1.828"></a><span id="l1.828">             }</span>
<a href="#l1.829"></a><span id="l1.829" class="difflineminus">-        }</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineminus">-        cal.getCalendarDirectory.mDir = dir;</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineminus">-    }</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineminus">-    return cal.getCalendarDirectory.mDir.clone();</span>
<a href="#l1.833"></a><span id="l1.833" class="difflineminus">-};</span>
<a href="#l1.834"></a><span id="l1.834" class="difflineminus">-</span>
<a href="#l1.835"></a><span id="l1.835" class="difflineminus">-/**</span>
<a href="#l1.836"></a><span id="l1.836" class="difflineminus">- * Base prototype to be used implementing a provider.</span>
<a href="#l1.837"></a><span id="l1.837" class="difflineminus">- *</span>
<a href="#l1.838"></a><span id="l1.838" class="difflineminus">- * @see e.g. providers/gdata</span>
<a href="#l1.839"></a><span id="l1.839" class="difflineminus">- */</span>
<a href="#l1.840"></a><span id="l1.840" class="difflineminus">-cal.ProviderBase = function() {</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineminus">-    cal.ASSERT(&quot;This prototype should only be inherited!&quot;);</span>
<a href="#l1.842"></a><span id="l1.842" class="difflineminus">-};</span>
<a href="#l1.843"></a><span id="l1.843" class="difflineminus">-cal.ProviderBase.mTransientProperties = {</span>
<a href="#l1.844"></a><span id="l1.844" class="difflineminus">-    &quot;cache.uncachedCalendar&quot;: true,</span>
<a href="#l1.845"></a><span id="l1.845" class="difflineminus">-    &quot;currentStatus&quot;: true,</span>
<a href="#l1.846"></a><span id="l1.846" class="difflineminus">-    &quot;itip.transport&quot;: true,</span>
<a href="#l1.847"></a><span id="l1.847" class="difflineminus">-    &quot;imip.identity&quot;: true,</span>
<a href="#l1.848"></a><span id="l1.848" class="difflineminus">-    &quot;imip.account&quot;: true,</span>
<a href="#l1.849"></a><span id="l1.849" class="difflineminus">-    &quot;imip.identity.disabled&quot;: true,</span>
<a href="#l1.850"></a><span id="l1.850" class="difflineminus">-    &quot;organizerId&quot;: true,</span>
<a href="#l1.851"></a><span id="l1.851" class="difflineminus">-    &quot;organizerCN&quot;: true</span>
<a href="#l1.852"></a><span id="l1.852" class="difflineminus">-};</span>
<a href="#l1.853"></a><span id="l1.853" class="difflineminus">-cal.ProviderBase.prototype = {</span>
<a href="#l1.854"></a><span id="l1.854" class="difflineminus">-    QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l1.855"></a><span id="l1.855" class="difflineminus">-        Components.interfaces.calICalendar,</span>
<a href="#l1.856"></a><span id="l1.856" class="difflineminus">-        Components.interfaces.calISchedulingSupport</span>
<a href="#l1.857"></a><span id="l1.857" class="difflineminus">-    ]),</span>
<a href="#l1.858"></a><span id="l1.858" class="difflineminus">-</span>
<a href="#l1.859"></a><span id="l1.859" class="difflineminus">-    mID: null,</span>
<a href="#l1.860"></a><span id="l1.860" class="difflineminus">-    mUri: null,</span>
<a href="#l1.861"></a><span id="l1.861" class="difflineminus">-    mACLEntry: null,</span>
<a href="#l1.862"></a><span id="l1.862" class="difflineminus">-    mObservers: null,</span>
<a href="#l1.863"></a><span id="l1.863" class="difflineminus">-    mProperties: null,</span>
<a href="#l1.864"></a><span id="l1.864" class="difflineminus">-</span>
<a href="#l1.865"></a><span id="l1.865" class="difflineminus">-    initProviderBase: function() {</span>
<a href="#l1.866"></a><span id="l1.866" class="difflineminus">-        this.wrappedJSObject = this;</span>
<a href="#l1.867"></a><span id="l1.867" class="difflineminus">-        this.mObservers = new cal.data.ObserverSet(Components.interfaces.calIObserver);</span>
<a href="#l1.868"></a><span id="l1.868" class="difflineminus">-        this.mProperties = {};</span>
<a href="#l1.869"></a><span id="l1.869" class="difflineminus">-        this.mProperties.currentStatus = Components.results.NS_OK;</span>
<a href="#l1.870"></a><span id="l1.870" class="difflineminus">-    },</span>
<a href="#l1.871"></a><span id="l1.871" class="difflineminus">-</span>
<a href="#l1.872"></a><span id="l1.872" class="difflineminus">-    get observers() {</span>
<a href="#l1.873"></a><span id="l1.873" class="difflineminus">-        return this.mObservers;</span>
<a href="#l1.874"></a><span id="l1.874" class="difflineminus">-    },</span>
<a href="#l1.875"></a><span id="l1.875" class="difflineminus">-</span>
<a href="#l1.876"></a><span id="l1.876" class="difflineminus">-    // attribute AUTF8String id;</span>
<a href="#l1.877"></a><span id="l1.877" class="difflineminus">-    get id() {</span>
<a href="#l1.878"></a><span id="l1.878" class="difflineminus">-        return this.mID;</span>
<a href="#l1.879"></a><span id="l1.879" class="difflineminus">-    },</span>
<a href="#l1.880"></a><span id="l1.880" class="difflineminus">-    set id(aValue) {</span>
<a href="#l1.881"></a><span id="l1.881" class="difflineminus">-        if (this.mID) {</span>
<a href="#l1.882"></a><span id="l1.882" class="difflineminus">-            throw Components.results.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineminus">-        }</span>
<a href="#l1.884"></a><span id="l1.884" class="difflineminus">-        this.mID = aValue;</span>
<a href="#l1.885"></a><span id="l1.885" class="difflineminus">-</span>
<a href="#l1.886"></a><span id="l1.886" class="difflineminus">-        let calMgr = cal.getCalendarManager();</span>
<a href="#l1.887"></a><span id="l1.887" class="difflineminus">-</span>
<a href="#l1.888"></a><span id="l1.888" class="difflineminus">-        // make all properties persistent that have been set so far:</span>
<a href="#l1.889"></a><span id="l1.889" class="difflineminus">-        for (let aName in this.mProperties) {</span>
<a href="#l1.890"></a><span id="l1.890" class="difflineminus">-            if (!cal.ProviderBase.mTransientProperties[aName]) {</span>
<a href="#l1.891"></a><span id="l1.891" class="difflineminus">-                let value = this.mProperties[aName];</span>
<a href="#l1.892"></a><span id="l1.892" class="difflineminus">-                if (value !== null) {</span>
<a href="#l1.893"></a><span id="l1.893" class="difflineminus">-                    calMgr.setCalendarPref_(this, aName, value);</span>
<a href="#l1.894"></a><span id="l1.894" class="difflineplus">+            if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l1.895"></a><span id="l1.895" class="difflineplus">+                this.setProperty(&quot;currentStatus&quot;, aStatus);</span>
<a href="#l1.896"></a><span id="l1.896" class="difflineplus">+            } else {</span>
<a href="#l1.897"></a><span id="l1.897" class="difflineplus">+                if (aDetail instanceof Components.interfaces.nsIException) {</span>
<a href="#l1.898"></a><span id="l1.898" class="difflineplus">+                    this.notifyError(aDetail); // will set currentStatus</span>
<a href="#l1.899"></a><span id="l1.899" class="difflineplus">+                } else {</span>
<a href="#l1.900"></a><span id="l1.900" class="difflineplus">+                    this.notifyError(aStatus, aDetail); // will set currentStatus</span>
<a href="#l1.901"></a><span id="l1.901">                 }</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineplus">+                this.notifyError(aOperationType == Components.interfaces.calIOperationListener.GET</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineplus">+                                 ? Components.interfaces.calIErrors.READ_FAILED</span>
<a href="#l1.904"></a><span id="l1.904" class="difflineplus">+                                 : Components.interfaces.calIErrors.MODIFICATION_FAILED,</span>
<a href="#l1.905"></a><span id="l1.905" class="difflineplus">+                                 aExtraMessage || &quot;&quot;);</span>
<a href="#l1.906"></a><span id="l1.906">             }</span>
<a href="#l1.907"></a><span id="l1.907">         }</span>
<a href="#l1.908"></a><span id="l1.908"> </span>
<a href="#l1.909"></a><span id="l1.909" class="difflineminus">-        return aValue;</span>
<a href="#l1.910"></a><span id="l1.910" class="difflineminus">-    },</span>
<a href="#l1.911"></a><span id="l1.911" class="difflineminus">-</span>
<a href="#l1.912"></a><span id="l1.912" class="difflineminus">-    // attribute AUTF8String name;</span>
<a href="#l1.913"></a><span id="l1.913" class="difflineminus">-    get name() {</span>
<a href="#l1.914"></a><span id="l1.914" class="difflineminus">-        return this.getProperty(&quot;name&quot;);</span>
<a href="#l1.915"></a><span id="l1.915" class="difflineminus">-    },</span>
<a href="#l1.916"></a><span id="l1.916" class="difflineminus">-    set name(aValue) {</span>
<a href="#l1.917"></a><span id="l1.917" class="difflineminus">-        return this.setProperty(&quot;name&quot;, aValue);</span>
<a href="#l1.918"></a><span id="l1.918" class="difflineminus">-    },</span>
<a href="#l1.919"></a><span id="l1.919" class="difflineminus">-</span>
<a href="#l1.920"></a><span id="l1.920" class="difflineminus">-    // readonly attribute calICalendarACLManager aclManager;</span>
<a href="#l1.921"></a><span id="l1.921" class="difflineminus">-    get aclManager() {</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineminus">-        const defaultACLProviderClass = &quot;@mozilla.org/calendar/acl-manager;1?type=default&quot;;</span>
<a href="#l1.923"></a><span id="l1.923" class="difflineminus">-        let providerClass = this.getProperty(&quot;aclManagerClass&quot;);</span>
<a href="#l1.924"></a><span id="l1.924" class="difflineminus">-        if (!providerClass || !Components.classes[providerClass]) {</span>
<a href="#l1.925"></a><span id="l1.925" class="difflineminus">-            providerClass = defaultACLProviderClass;</span>
<a href="#l1.926"></a><span id="l1.926" class="difflineminus">-        }</span>
<a href="#l1.927"></a><span id="l1.927" class="difflineminus">-        return Components.classes[providerClass].getService(Components.interfaces.calICalendarACLManager);</span>
<a href="#l1.928"></a><span id="l1.928" class="difflineminus">-    },</span>
<a href="#l1.929"></a><span id="l1.929" class="difflineminus">-</span>
<a href="#l1.930"></a><span id="l1.930" class="difflineminus">-    // readonly attribute calICalendarACLEntry aclEntry;</span>
<a href="#l1.931"></a><span id="l1.931" class="difflineminus">-    get aclEntry() {</span>
<a href="#l1.932"></a><span id="l1.932" class="difflineminus">-        return this.mACLEntry;</span>
<a href="#l1.933"></a><span id="l1.933" class="difflineminus">-    },</span>
<a href="#l1.934"></a><span id="l1.934" class="difflineminus">-</span>
<a href="#l1.935"></a><span id="l1.935" class="difflineminus">-    // attribute calICalendar superCalendar;</span>
<a href="#l1.936"></a><span id="l1.936" class="difflineminus">-    get superCalendar() {</span>
<a href="#l1.937"></a><span id="l1.937" class="difflineminus">-        // If we have a superCalendar, check this calendar for a superCalendar.</span>
<a href="#l1.938"></a><span id="l1.938" class="difflineminus">-        // This will make sure the topmost calendar is returned</span>
<a href="#l1.939"></a><span id="l1.939" class="difflineminus">-        return (this.mSuperCalendar ? this.mSuperCalendar.superCalendar : this);</span>
<a href="#l1.940"></a><span id="l1.940" class="difflineminus">-    },</span>
<a href="#l1.941"></a><span id="l1.941" class="difflineminus">-    set superCalendar(val) {</span>
<a href="#l1.942"></a><span id="l1.942" class="difflineminus">-        return (this.mSuperCalendar = val);</span>
<a href="#l1.943"></a><span id="l1.943" class="difflineminus">-    },</span>
<a href="#l1.944"></a><span id="l1.944" class="difflineminus">-</span>
<a href="#l1.945"></a><span id="l1.945" class="difflineminus">-    // attribute nsIURI uri;</span>
<a href="#l1.946"></a><span id="l1.946" class="difflineminus">-    get uri() {</span>
<a href="#l1.947"></a><span id="l1.947" class="difflineminus">-        return this.mUri;</span>
<a href="#l1.948"></a><span id="l1.948" class="difflineminus">-    },</span>
<a href="#l1.949"></a><span id="l1.949" class="difflineminus">-    set uri(aValue) {</span>
<a href="#l1.950"></a><span id="l1.950" class="difflineminus">-        return (this.mUri = aValue);</span>
<a href="#l1.951"></a><span id="l1.951" class="difflineminus">-    },</span>
<a href="#l1.952"></a><span id="l1.952" class="difflineminus">-</span>
<a href="#l1.953"></a><span id="l1.953" class="difflineminus">-    // attribute boolean readOnly;</span>
<a href="#l1.954"></a><span id="l1.954" class="difflineminus">-    get readOnly() {</span>
<a href="#l1.955"></a><span id="l1.955" class="difflineminus">-        return this.getProperty(&quot;readOnly&quot;);</span>
<a href="#l1.956"></a><span id="l1.956" class="difflineminus">-    },</span>
<a href="#l1.957"></a><span id="l1.957" class="difflineminus">-    set readOnly(aValue) {</span>
<a href="#l1.958"></a><span id="l1.958" class="difflineminus">-        return this.setProperty(&quot;readOnly&quot;, aValue);</span>
<a href="#l1.959"></a><span id="l1.959" class="difflineminus">-    },</span>
<a href="#l1.960"></a><span id="l1.960" class="difflineminus">-</span>
<a href="#l1.961"></a><span id="l1.961" class="difflineminus">-    // readonly attribute boolean canRefresh;</span>
<a href="#l1.962"></a><span id="l1.962" class="difflineminus">-    get canRefresh() {</span>
<a href="#l1.963"></a><span id="l1.963" class="difflineminus">-        return false;</span>
<a href="#l1.964"></a><span id="l1.964" class="difflineminus">-    },</span>
<a href="#l1.965"></a><span id="l1.965" class="difflineminus">-</span>
<a href="#l1.966"></a><span id="l1.966" class="difflineminus">-    // void startBatch();</span>
<a href="#l1.967"></a><span id="l1.967" class="difflineminus">-    mBatchCount: 0,</span>
<a href="#l1.968"></a><span id="l1.968" class="difflineminus">-    startBatch: function() {</span>
<a href="#l1.969"></a><span id="l1.969" class="difflineminus">-        if (this.mBatchCount++ == 0) {</span>
<a href="#l1.970"></a><span id="l1.970" class="difflineminus">-            this.mObservers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l1.971"></a><span id="l1.971" class="difflineminus">-        }</span>
<a href="#l1.972"></a><span id="l1.972" class="difflineminus">-    },</span>
<a href="#l1.973"></a><span id="l1.973" class="difflineminus">-</span>
<a href="#l1.974"></a><span id="l1.974" class="difflineminus">-    endBatch: function() {</span>
<a href="#l1.975"></a><span id="l1.975" class="difflineminus">-        if (this.mBatchCount &gt; 0) {</span>
<a href="#l1.976"></a><span id="l1.976" class="difflineminus">-            if (--this.mBatchCount == 0) {</span>
<a href="#l1.977"></a><span id="l1.977" class="difflineminus">-                this.mObservers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l1.978"></a><span id="l1.978" class="difflineplus">+        /**</span>
<a href="#l1.979"></a><span id="l1.979" class="difflineplus">+         * Notify observers using the onError notification with a readable error message</span>
<a href="#l1.980"></a><span id="l1.980" class="difflineplus">+         *</span>
<a href="#l1.981"></a><span id="l1.981" class="difflineplus">+         * @param {Number|nsIException} aErrNo      The error number from Components.results, or</span>
<a href="#l1.982"></a><span id="l1.982" class="difflineplus">+         *                                            the exception which contains the error number</span>
<a href="#l1.983"></a><span id="l1.983" class="difflineplus">+         * @param {?String} aMessage                The message to show for the error</span>
<a href="#l1.984"></a><span id="l1.984" class="difflineplus">+         */</span>
<a href="#l1.985"></a><span id="l1.985" class="difflineplus">+        notifyError(aErrNo, aMessage=null) {</span>
<a href="#l1.986"></a><span id="l1.986" class="difflineplus">+            if (aErrNo == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l1.987"></a><span id="l1.987" class="difflineplus">+                return; // cancellation doesn't change current status, no notification</span>
<a href="#l1.988"></a><span id="l1.988">             }</span>
<a href="#l1.989"></a><span id="l1.989" class="difflineminus">-        } else {</span>
<a href="#l1.990"></a><span id="l1.990" class="difflineminus">-            cal.ASSERT(this.mBatchCount &gt; 0, &quot;unexepcted endBatch!&quot;);</span>
<a href="#l1.991"></a><span id="l1.991" class="difflineminus">-        }</span>
<a href="#l1.992"></a><span id="l1.992" class="difflineminus">-    },</span>
<a href="#l1.993"></a><span id="l1.993" class="difflineminus">-</span>
<a href="#l1.994"></a><span id="l1.994" class="difflineminus">-    notifyPureOperationComplete: function(aListener, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l1.995"></a><span id="l1.995" class="difflineminus">-        if (aListener) {</span>
<a href="#l1.996"></a><span id="l1.996" class="difflineminus">-            try {</span>
<a href="#l1.997"></a><span id="l1.997" class="difflineminus">-                aListener.onOperationComplete(this.superCalendar, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l1.998"></a><span id="l1.998" class="difflineminus">-            } catch (exc) {</span>
<a href="#l1.999"></a><span id="l1.999" class="difflineminus">-                cal.ERROR(exc);</span>
<a href="#l1.1000"></a><span id="l1.1000" class="difflineminus">-            }</span>
<a href="#l1.1001"></a><span id="l1.1001" class="difflineminus">-        }</span>
<a href="#l1.1002"></a><span id="l1.1002" class="difflineminus">-    },</span>
<a href="#l1.1003"></a><span id="l1.1003" class="difflineminus">-</span>
<a href="#l1.1004"></a><span id="l1.1004" class="difflineminus">-    notifyOperationComplete: function(aListener, aStatus, aOperationType, aId, aDetail, aExtraMessage) {</span>
<a href="#l1.1005"></a><span id="l1.1005" class="difflineminus">-        this.notifyPureOperationComplete(aListener, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l1.1006"></a><span id="l1.1006" class="difflineminus">-</span>
<a href="#l1.1007"></a><span id="l1.1007" class="difflineminus">-        if (aStatus == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l1.1008"></a><span id="l1.1008" class="difflineminus">-            return; // cancellation doesn't change current status, no notification</span>
<a href="#l1.1009"></a><span id="l1.1009" class="difflineminus">-        }</span>
<a href="#l1.1010"></a><span id="l1.1010" class="difflineminus">-        if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l1.1011"></a><span id="l1.1011" class="difflineminus">-            this.setProperty(&quot;currentStatus&quot;, aStatus);</span>
<a href="#l1.1012"></a><span id="l1.1012" class="difflineminus">-        } else {</span>
<a href="#l1.1013"></a><span id="l1.1013" class="difflineminus">-            if (aDetail instanceof Components.interfaces.nsIException) {</span>
<a href="#l1.1014"></a><span id="l1.1014" class="difflineminus">-                this.notifyError(aDetail); // will set currentStatus</span>
<a href="#l1.1015"></a><span id="l1.1015" class="difflineminus">-            } else {</span>
<a href="#l1.1016"></a><span id="l1.1016" class="difflineminus">-                this.notifyError(aStatus, aDetail); // will set currentStatus</span>
<a href="#l1.1017"></a><span id="l1.1017" class="difflineplus">+            if (aErrNo instanceof Components.interfaces.nsIException) {</span>
<a href="#l1.1018"></a><span id="l1.1018" class="difflineplus">+                if (!aMessage) {</span>
<a href="#l1.1019"></a><span id="l1.1019" class="difflineplus">+                    aMessage = aErrNo.message;</span>
<a href="#l1.1020"></a><span id="l1.1020" class="difflineplus">+                }</span>
<a href="#l1.1021"></a><span id="l1.1021" class="difflineplus">+                aErrNo = aErrNo.result;</span>
<a href="#l1.1022"></a><span id="l1.1022">             }</span>
<a href="#l1.1023"></a><span id="l1.1023" class="difflineminus">-            this.notifyError(aOperationType == Components.interfaces.calIOperationListener.GET</span>
<a href="#l1.1024"></a><span id="l1.1024" class="difflineminus">-                             ? Components.interfaces.calIErrors.READ_FAILED</span>
<a href="#l1.1025"></a><span id="l1.1025" class="difflineminus">-                             : Components.interfaces.calIErrors.MODIFICATION_FAILED,</span>
<a href="#l1.1026"></a><span id="l1.1026" class="difflineminus">-                             aExtraMessage || &quot;&quot;);</span>
<a href="#l1.1027"></a><span id="l1.1027" class="difflineminus">-        }</span>
<a href="#l1.1028"></a><span id="l1.1028" class="difflineminus">-    },</span>
<a href="#l1.1029"></a><span id="l1.1029" class="difflineminus">-</span>
<a href="#l1.1030"></a><span id="l1.1030" class="difflineminus">-    // for convenience also callable with just an exception</span>
<a href="#l1.1031"></a><span id="l1.1031" class="difflineminus">-    notifyError: function(aErrNo, aMessage) {</span>
<a href="#l1.1032"></a><span id="l1.1032" class="difflineminus">-        if (aErrNo == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l1.1033"></a><span id="l1.1033" class="difflineminus">-            return; // cancellation doesn't change current status, no notification</span>
<a href="#l1.1034"></a><span id="l1.1034" class="difflineminus">-        }</span>
<a href="#l1.1035"></a><span id="l1.1035" class="difflineminus">-        if (aErrNo instanceof Components.interfaces.nsIException) {</span>
<a href="#l1.1036"></a><span id="l1.1036" class="difflineminus">-            if (!aMessage) {</span>
<a href="#l1.1037"></a><span id="l1.1037" class="difflineminus">-                aMessage = aErrNo.message;</span>
<a href="#l1.1038"></a><span id="l1.1038" class="difflineminus">-            }</span>
<a href="#l1.1039"></a><span id="l1.1039" class="difflineminus">-            aErrNo = aErrNo.result;</span>
<a href="#l1.1040"></a><span id="l1.1040" class="difflineminus">-        }</span>
<a href="#l1.1041"></a><span id="l1.1041" class="difflineminus">-        this.setProperty(&quot;currentStatus&quot;, aErrNo);</span>
<a href="#l1.1042"></a><span id="l1.1042" class="difflineminus">-        this.observers.notify(&quot;onError&quot;, [this.superCalendar, aErrNo, aMessage]);</span>
<a href="#l1.1043"></a><span id="l1.1043" class="difflineminus">-    },</span>
<a href="#l1.1044"></a><span id="l1.1044" class="difflineminus">-</span>
<a href="#l1.1045"></a><span id="l1.1045" class="difflineminus">-    mTransientPropertiesMode: false,</span>
<a href="#l1.1046"></a><span id="l1.1046" class="difflineminus">-    get transientProperties() {</span>
<a href="#l1.1047"></a><span id="l1.1047" class="difflineminus">-        return this.mTransientPropertiesMode;</span>
<a href="#l1.1048"></a><span id="l1.1048" class="difflineminus">-    },</span>
<a href="#l1.1049"></a><span id="l1.1049" class="difflineminus">-    set transientProperties(value) {</span>
<a href="#l1.1050"></a><span id="l1.1050" class="difflineminus">-        return (this.mTransientPropertiesMode = value);</span>
<a href="#l1.1051"></a><span id="l1.1051" class="difflineminus">-    },</span>
<a href="#l1.1052"></a><span id="l1.1052" class="difflineminus">-</span>
<a href="#l1.1053"></a><span id="l1.1053" class="difflineminus">-    // nsIVariant getProperty(in AUTF8String aName);</span>
<a href="#l1.1054"></a><span id="l1.1054" class="difflineminus">-    getProperty: function(aName) {</span>
<a href="#l1.1055"></a><span id="l1.1055" class="difflineminus">-        switch (aName) {</span>
<a href="#l1.1056"></a><span id="l1.1056" class="difflineminus">-            case &quot;itip.transport&quot;: // iTIP/iMIP default:</span>
<a href="#l1.1057"></a><span id="l1.1057" class="difflineminus">-                return cal.getImipTransport(this);</span>
<a href="#l1.1058"></a><span id="l1.1058" class="difflineminus">-            case &quot;itip.notify-replies&quot;: // iTIP/iMIP default:</span>
<a href="#l1.1059"></a><span id="l1.1059" class="difflineminus">-                return Preferences.get(&quot;calendar.itip.notify-replies&quot;, false);</span>
<a href="#l1.1060"></a><span id="l1.1060" class="difflineminus">-            // temporary hack to get the uncached calendar instance:</span>
<a href="#l1.1061"></a><span id="l1.1061" class="difflineminus">-            case &quot;cache.uncachedCalendar&quot;:</span>
<a href="#l1.1062"></a><span id="l1.1062" class="difflineminus">-                return this;</span>
<a href="#l1.1063"></a><span id="l1.1063" class="difflineplus">+            this.setProperty(&quot;currentStatus&quot;, aErrNo);</span>
<a href="#l1.1064"></a><span id="l1.1064" class="difflineplus">+            this.observers.notify(&quot;onError&quot;, [this.superCalendar, aErrNo, aMessage]);</span>
<a href="#l1.1065"></a><span id="l1.1065">         }</span>
<a href="#l1.1066"></a><span id="l1.1066"> </span>
<a href="#l1.1067"></a><span id="l1.1067" class="difflineminus">-        let ret = this.mProperties[aName];</span>
<a href="#l1.1068"></a><span id="l1.1068" class="difflineminus">-        if (ret === undefined) {</span>
<a href="#l1.1069"></a><span id="l1.1069" class="difflineminus">-            ret = null;</span>
<a href="#l1.1070"></a><span id="l1.1070" class="difflineplus">+        // nsIVariant getProperty(in AUTF8String aName);</span>
<a href="#l1.1071"></a><span id="l1.1071" class="difflineplus">+        getProperty(aName) {</span>
<a href="#l1.1072"></a><span id="l1.1072">             switch (aName) {</span>
<a href="#l1.1073"></a><span id="l1.1073">                 case &quot;itip.transport&quot;: // iTIP/iMIP default:</span>
<a href="#l1.1074"></a><span id="l1.1074">                     return calprovider.getImipTransport(this);</span>
<a href="#l1.1075"></a><span id="l1.1075">                 case &quot;itip.notify-replies&quot;: // iTIP/iMIP default:</span>
<a href="#l1.1076"></a><span id="l1.1076">                     return Preferences.get(&quot;calendar.itip.notify-replies&quot;, false);</span>
<a href="#l1.1077"></a><span id="l1.1077">                 // temporary hack to get the uncached calendar instance:</span>
<a href="#l1.1078"></a><span id="l1.1078">                 case &quot;cache.uncachedCalendar&quot;:</span>
<a href="#l1.1079"></a><span id="l1.1079">                     return this;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/modules/calUtilsCompat.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/modules/calUtilsCompat.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -173,33 +173,33 @@ function injectCalUtilsCompat(global) {</span>
<a href="#l2.4"></a><span id="l2.4">                            &quot; and the parameter order has changed&quot;,</span>
<a href="#l2.5"></a><span id="l2.5">                            &quot;https://bugzilla.mozilla.org/show_bug.cgi?id=905097&quot;,</span>
<a href="#l2.6"></a><span id="l2.6">                            Components.stack.caller);</span>
<a href="#l2.7"></a><span id="l2.7">         return cal.l10n.getAnyString(aComponent, aBundleName, aStringName, aParams);</span>
<a href="#l2.8"></a><span id="l2.8">     };</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">     global.ProviderBase = class extends global.provider.BaseClass {</span>
<a href="#l2.11"></a><span id="l2.11">         initProviderBase() {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-            Deprecated.warning(&quot;calProviderUtils' cal.ProviderBase() has changed to cal.provider.BaseClass()&quot;,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+            Deprecated.warning(&quot;calProviderUtils' cal.provider.BaseClass() has changed to cal.provider.BaseClass()&quot;,</span>
<a href="#l2.14"></a><span id="l2.14">                                &quot;https://bugzilla.mozilla.org/show_bug.cgi?id=905097&quot;,</span>
<a href="#l2.15"></a><span id="l2.15">                                Components.stack.caller);</span>
<a href="#l2.16"></a><span id="l2.16">             super.initProviderBase();</span>
<a href="#l2.17"></a><span id="l2.17">         }</span>
<a href="#l2.18"></a><span id="l2.18">     };</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">     global.BadCertHandler = class extends global.provider.BadCertHandler {</span>
<a href="#l2.21"></a><span id="l2.21">         constructor() {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-            Deprecated.warning(&quot;calProviderUtils' cal.BadCertHandler() has changed to cal.provider.BadCertHandler()&quot;,</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+            Deprecated.warning(&quot;calProviderUtils' cal.provider.BadCertHandler() has changed to cal.provider.BadCertHandler()&quot;,</span>
<a href="#l2.24"></a><span id="l2.24">                                &quot;https://bugzilla.mozilla.org/show_bug.cgi?id=905097&quot;,</span>
<a href="#l2.25"></a><span id="l2.25">                                Components.stack.caller);</span>
<a href="#l2.26"></a><span id="l2.26">             super();</span>
<a href="#l2.27"></a><span id="l2.27">         }</span>
<a href="#l2.28"></a><span id="l2.28">     };</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">     global.FreeBusyInterval = class extends global.provider.FreeBusyInterval {</span>
<a href="#l2.31"></a><span id="l2.31">         constructor() {</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-            Deprecated.warning(&quot;calProviderUtils' cal.FreeBusyInterval() has changed to cal.provider.FreeBusyInterval()&quot;,</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+            Deprecated.warning(&quot;calProviderUtils' cal.provider.FreeBusyInterval() has changed to cal.provider.FreeBusyInterval()&quot;,</span>
<a href="#l2.34"></a><span id="l2.34">                                &quot;https://bugzilla.mozilla.org/show_bug.cgi?id=905097&quot;,</span>
<a href="#l2.35"></a><span id="l2.35">                                Components.stack.caller);</span>
<a href="#l2.36"></a><span id="l2.36">             super();</span>
<a href="#l2.37"></a><span id="l2.37">         }</span>
<a href="#l2.38"></a><span id="l2.38">     };</span>
<a href="#l2.39"></a><span id="l2.39"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -196,17 +196,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">                     case &quot;memory&quot;: {</span>
<a href="#l3.5"></a><span id="l3.5">                         if (this.supportsChangeLog) {</span>
<a href="#l3.6"></a><span id="l3.6">                             // start with full sync:</span>
<a href="#l3.7"></a><span id="l3.7">                             this.mUncachedCalendar.resetLog();</span>
<a href="#l3.8"></a><span id="l3.8">                         }</span>
<a href="#l3.9"></a><span id="l3.9">                         break;</span>
<a href="#l3.10"></a><span id="l3.10">                     }</span>
<a href="#l3.11"></a><span id="l3.11">                     case &quot;storage&quot;: {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-                        let file = cal.getCalendarDirectory();</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+                        let file = cal.provider.getCalendarDirectory();</span>
<a href="#l3.14"></a><span id="l3.14">                         file.append(&quot;cache.sqlite&quot;);</span>
<a href="#l3.15"></a><span id="l3.15">                         cachedCalendar.uri = Services.io.newFileURI(file);</span>
<a href="#l3.16"></a><span id="l3.16">                         cachedCalendar.id = this.id;</span>
<a href="#l3.17"></a><span id="l3.17">                         break;</span>
<a href="#l3.18"></a><span id="l3.18">                     }</span>
<a href="#l3.19"></a><span id="l3.19">                     default: {</span>
<a href="#l3.20"></a><span id="l3.20">                         throw new Error(&quot;unsupported cache calendar type: &quot; + calType);</span>
<a href="#l3.21"></a><span id="l3.21">                     }</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -402,17 +402,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l3.23"></a><span id="l3.23">                                         self.promptOverwrite(&quot;modify&quot;, item, null, null);</span>
<a href="#l3.24"></a><span id="l3.24">                                     } else {</span>
<a href="#l3.25"></a><span id="l3.25">                                         // Our item is newer, just modify the item</span>
<a href="#l3.26"></a><span id="l3.26">                                         self.modifyOfflineItem(item, null, null);</span>
<a href="#l3.27"></a><span id="l3.27">                                     }</span>
<a href="#l3.28"></a><span id="l3.28">                                 } else {</span>
<a href="#l3.29"></a><span id="l3.29">                                     // The item has been deleted from the server, ask if it should be added again</span>
<a href="#l3.30"></a><span id="l3.30">                                     cal.WARN(&quot;[calCachedCalendar] Item '&quot; + item.title + &quot;' has been deleted from the server&quot;);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-                                    if (cal.promptOverwrite(&quot;modify&quot;, item, null, null)) {</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+                                    if (cal.provider.promptOverwrite(&quot;modify&quot;, item, null, null)) {</span>
<a href="#l3.33"></a><span id="l3.33">                                         self.adoptOfflineItem(item.clone(), null);</span>
<a href="#l3.34"></a><span id="l3.34">                                     }</span>
<a href="#l3.35"></a><span id="l3.35">                                 }</span>
<a href="#l3.36"></a><span id="l3.36">                                 break;</span>
<a href="#l3.37"></a><span id="l3.37">                             case cICL.OFFLINE_FLAG_DELETED_RECORD:</span>
<a href="#l3.38"></a><span id="l3.38">                                 if (item.id in completeListener.modifiedTimes) {</span>
<a href="#l3.39"></a><span id="l3.39">                                     // The item seems to exist on the server...</span>
<a href="#l3.40"></a><span id="l3.40">                                     if (item.lastModifiedTime.compare(completeListener.modifiedTimes[item.id]) &lt; 0) {</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineat">@@ -453,17 +453,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l3.42"></a><span id="l3.42">         } else {</span>
<a href="#l3.43"></a><span id="l3.43">             // Going online (start replaying changes to the remote calendar)</span>
<a href="#l3.44"></a><span id="l3.44">             this.refresh();</span>
<a href="#l3.45"></a><span id="l3.45">         }</span>
<a href="#l3.46"></a><span id="l3.46">     },</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48">     // aOldItem is already in the cache</span>
<a href="#l3.49"></a><span id="l3.49">     promptOverwrite: function(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-        let overwrite = cal.promptOverwrite(aMethod, aItem, aListener, aOldItem);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+        let overwrite = cal.provider.promptOverwrite(aMethod, aItem, aListener, aOldItem);</span>
<a href="#l3.52"></a><span id="l3.52">         if (overwrite) {</span>
<a href="#l3.53"></a><span id="l3.53">             if (aMethod == &quot;modify&quot;) {</span>
<a href="#l3.54"></a><span id="l3.54">                 this.modifyOfflineItem(aItem, aOldItem, aListener);</span>
<a href="#l3.55"></a><span id="l3.55">             } else {</span>
<a href="#l3.56"></a><span id="l3.56">                 this.deleteOfflineItem(aItem, aListener);</span>
<a href="#l3.57"></a><span id="l3.57">             }</span>
<a href="#l3.58"></a><span id="l3.58">         }</span>
<a href="#l3.59"></a><span id="l3.59">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1024,17 +1024,17 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">     }</span>
<a href="#l4.5"></a><span id="l4.5"> };</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> function calDummyCalendar(type) {</span>
<a href="#l4.8"></a><span id="l4.8">     this.initProviderBase();</span>
<a href="#l4.9"></a><span id="l4.9">     this.type = type;</span>
<a href="#l4.10"></a><span id="l4.10"> }</span>
<a href="#l4.11"></a><span id="l4.11"> calDummyCalendar.prototype = {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15">     getProperty: function(aName) {</span>
<a href="#l4.16"></a><span id="l4.16">         switch (aName) {</span>
<a href="#l4.17"></a><span id="l4.17">             case &quot;force-disabled&quot;:</span>
<a href="#l4.18"></a><span id="l4.18">                 return true;</span>
<a href="#l4.19"></a><span id="l4.19">             default:</span>
<a href="#l4.20"></a><span id="l4.20">                 return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l4.21"></a><span id="l4.21">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/src/calDefaultACLManager.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/src/calDefaultACLManager.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -81,17 +81,17 @@ calDefaultCalendarACLEntry.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">     getUserAddresses: function(aCount) {</span>
<a href="#l5.6"></a><span id="l5.6">         let identities = this.getUserIdentities(aCount);</span>
<a href="#l5.7"></a><span id="l5.7">         let addresses = identities.map(id =&gt; id.email);</span>
<a href="#l5.8"></a><span id="l5.8">         return addresses;</span>
<a href="#l5.9"></a><span id="l5.9">     },</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">     getUserIdentities: function(aCount) {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        let identity = cal.getEmailIdentityOfCalendar(this.mCalendar);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+        let identity = cal.provider.getEmailIdentityOfCalendar(this.mCalendar);</span>
<a href="#l5.14"></a><span id="l5.14">         if (identity) {</span>
<a href="#l5.15"></a><span id="l5.15">             aCount.value = 1;</span>
<a href="#l5.16"></a><span id="l5.16">             return [identity];</span>
<a href="#l5.17"></a><span id="l5.17">         } else {</span>
<a href="#l5.18"></a><span id="l5.18">             return this._getIdentities(aCount);</span>
<a href="#l5.19"></a><span id="l5.19">         }</span>
<a href="#l5.20"></a><span id="l5.20">     },</span>
<a href="#l5.21"></a><span id="l5.21">     getOwnerIdentities: function(aCount) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -99,17 +99,17 @@ var calDavCalendarInterfaces = [</span>
<a href="#l6.4"></a><span id="l6.4">     Components.interfaces.nsIChannelEventSink,</span>
<a href="#l6.5"></a><span id="l6.5">     Components.interfaces.calIItipTransport,</span>
<a href="#l6.6"></a><span id="l6.6">     Components.interfaces.calISchedulingSupport,</span>
<a href="#l6.7"></a><span id="l6.7">     Components.interfaces.calICalendar,</span>
<a href="#l6.8"></a><span id="l6.8">     Components.interfaces.calIChangeLog,</span>
<a href="#l6.9"></a><span id="l6.9">     calICalDavCalendar,</span>
<a href="#l6.10"></a><span id="l6.10"> ];</span>
<a href="#l6.11"></a><span id="l6.11"> calDavCalendar.prototype = {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l6.14"></a><span id="l6.14">     classID: calDavCalendarClassID,</span>
<a href="#l6.15"></a><span id="l6.15">     QueryInterface: XPCOMUtils.generateQI(calDavCalendarInterfaces),</span>
<a href="#l6.16"></a><span id="l6.16">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l6.17"></a><span id="l6.17">         classID: calDavCalendarClassID,</span>
<a href="#l6.18"></a><span id="l6.18">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=caldav&quot;,</span>
<a href="#l6.19"></a><span id="l6.19">         classDescription: &quot;Calendar CalDAV back-end&quot;,</span>
<a href="#l6.20"></a><span id="l6.20">         interfaces: calDavCalendarInterfaces,</span>
<a href="#l6.21"></a><span id="l6.21">     }),</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -361,24 +361,24 @@ calDavCalendar.prototype = {</span>
<a href="#l6.23"></a><span id="l6.23">                 self.sendHttpRequest(...origArgs);</span>
<a href="#l6.24"></a><span id="l6.24">             } else {</span>
<a href="#l6.25"></a><span id="l6.25">                 let nextArguments = Array.from(arguments).slice(1);</span>
<a href="#l6.26"></a><span id="l6.26">                 nextMethod(...nextArguments);</span>
<a href="#l6.27"></a><span id="l6.27">             }</span>
<a href="#l6.28"></a><span id="l6.28">         }</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30">         function authSuccess() {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-            let channel = cal.prepHttpChannel(aUri, aUploadData, aContentType, self, aExisting);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+            let channel = cal.provider.prepHttpChannel(aUri, aUploadData, aContentType, self, aExisting);</span>
<a href="#l6.33"></a><span id="l6.33">             if (usesGoogleOAuth) {</span>
<a href="#l6.34"></a><span id="l6.34">                 let hdr = &quot;Bearer &quot; + self.oauth.accessToken;</span>
<a href="#l6.35"></a><span id="l6.35">                 channel.setRequestHeader(&quot;Authorization&quot;, hdr, false);</span>
<a href="#l6.36"></a><span id="l6.36">             }</span>
<a href="#l6.37"></a><span id="l6.37">             let listener = aSetupChannelFunc(channel);</span>
<a href="#l6.38"></a><span id="l6.38">             if (aUseStreamLoader) {</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-                let loader = cal.createStreamLoader();</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+                let loader = cal.provider.createStreamLoader();</span>
<a href="#l6.41"></a><span id="l6.41">                 listener.onStreamComplete = oauthCheck.bind(null, listener.onStreamComplete.bind(listener));</span>
<a href="#l6.42"></a><span id="l6.42">                 loader.init(listener);</span>
<a href="#l6.43"></a><span id="l6.43">                 listener = loader;</span>
<a href="#l6.44"></a><span id="l6.44">             } else {</span>
<a href="#l6.45"></a><span id="l6.45">                 listener.onStartRequest = oauthCheck.bind(null, listener.onStartRequest.bind(listener));</span>
<a href="#l6.46"></a><span id="l6.46">             }</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">             self.mLastRedirectStatus = null;</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineat">@@ -567,30 +567,30 @@ calDavCalendar.prototype = {</span>
<a href="#l6.50"></a><span id="l6.50">                     return this.calendarUserAddress;</span>
<a href="#l6.51"></a><span id="l6.51">                 } // else use configured email identity</span>
<a href="#l6.52"></a><span id="l6.52">                 break;</span>
<a href="#l6.53"></a><span id="l6.53">             case &quot;organizerCN&quot;:</span>
<a href="#l6.54"></a><span id="l6.54">                 return null; // xxx todo</span>
<a href="#l6.55"></a><span id="l6.55">             case &quot;itip.transport&quot;:</span>
<a href="#l6.56"></a><span id="l6.56">                 if (this.hasAutoScheduling || this.hasScheduling) {</span>
<a href="#l6.57"></a><span id="l6.57">                     return this.QueryInterface(Components.interfaces.calIItipTransport);</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-                } // else use outbound email-based iTIP (from cal.ProviderBase)</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+                } // else use outbound email-based iTIP (from cal.provider.BaseClass)</span>
<a href="#l6.60"></a><span id="l6.60">                 break;</span>
<a href="#l6.61"></a><span id="l6.61">             case &quot;capabilities.tasks.supported&quot;:</span>
<a href="#l6.62"></a><span id="l6.62">                 return this.supportedItemTypes.includes(&quot;VTODO&quot;);</span>
<a href="#l6.63"></a><span id="l6.63">             case &quot;capabilities.events.supported&quot;:</span>
<a href="#l6.64"></a><span id="l6.64">                 return this.supportedItemTypes.includes(&quot;VEVENT&quot;);</span>
<a href="#l6.65"></a><span id="l6.65">             case &quot;capabilities.autoschedule.supported&quot;:</span>
<a href="#l6.66"></a><span id="l6.66">                 return this.hasAutoScheduling;</span>
<a href="#l6.67"></a><span id="l6.67">         }</span>
<a href="#l6.68"></a><span id="l6.68">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l6.69"></a><span id="l6.69">     },</span>
<a href="#l6.70"></a><span id="l6.70"> </span>
<a href="#l6.71"></a><span id="l6.71">     promptOverwrite: function(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-        let overwrite = cal.promptOverwrite(aMethod, aItem, aListener, aOldItem);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+        let overwrite = cal.provider.promptOverwrite(aMethod, aItem, aListener, aOldItem);</span>
<a href="#l6.74"></a><span id="l6.74">         if (overwrite) {</span>
<a href="#l6.75"></a><span id="l6.75">             if (aMethod == CALDAV_MODIFY_ITEM) {</span>
<a href="#l6.76"></a><span id="l6.76">                 this.doModifyItem(aItem, aOldItem, aListener, true);</span>
<a href="#l6.77"></a><span id="l6.77">             } else {</span>
<a href="#l6.78"></a><span id="l6.78">                 this.doDeleteItem(aItem, aListener, true, false, null);</span>
<a href="#l6.79"></a><span id="l6.79">             }</span>
<a href="#l6.80"></a><span id="l6.80">         } else {</span>
<a href="#l6.81"></a><span id="l6.81">             this.getUpdatedItem(aItem, aListener);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineat">@@ -665,17 +665,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.83"></a><span id="l6.83">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l6.84"></a><span id="l6.84">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l6.85"></a><span id="l6.85">                 let listenerDetail = parentItem;</span>
<a href="#l6.86"></a><span id="l6.86">                 let responseStatus;</span>
<a href="#l6.87"></a><span id="l6.87">                 try {</span>
<a href="#l6.88"></a><span id="l6.88">                     responseStatus = request.responseStatus;</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90">                     if (self.verboseLogging()) {</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-                        let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+                        let str = cal.provider.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.93"></a><span id="l6.93">                         cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l6.94"></a><span id="l6.94">                     }</span>
<a href="#l6.95"></a><span id="l6.95">                 } catch (ex) {</span>
<a href="#l6.96"></a><span id="l6.96">                     listenerStatus = ex.result;</span>
<a href="#l6.97"></a><span id="l6.97">                     listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l6.98"></a><span id="l6.98">                     cal.LOG(&quot;CalDAV: Request error during add: &quot; + ex);</span>
<a href="#l6.99"></a><span id="l6.99">                 }</span>
<a href="#l6.100"></a><span id="l6.100"> </span>
<a href="#l6.101"></a><span id="l6.101" class="difflineat">@@ -784,17 +784,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.102"></a><span id="l6.102">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l6.103"></a><span id="l6.103">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l6.104"></a><span id="l6.104">                 let listenerDetail = aNewItem;</span>
<a href="#l6.105"></a><span id="l6.105">                 let responseStatus;</span>
<a href="#l6.106"></a><span id="l6.106">                 try {</span>
<a href="#l6.107"></a><span id="l6.107">                     responseStatus = request.responseStatus;</span>
<a href="#l6.108"></a><span id="l6.108"> </span>
<a href="#l6.109"></a><span id="l6.109">                     if (self.verboseLogging()) {</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-                        let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+                        let str = cal.provider.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.112"></a><span id="l6.112">                         cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l6.113"></a><span id="l6.113">                     }</span>
<a href="#l6.114"></a><span id="l6.114">                 } catch (ex) {</span>
<a href="#l6.115"></a><span id="l6.115">                     listenerStatus = ex.result;</span>
<a href="#l6.116"></a><span id="l6.116">                     listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l6.117"></a><span id="l6.117">                     cal.LOG(&quot;CalDAV: Request error during add: &quot; + ex);</span>
<a href="#l6.118"></a><span id="l6.118">                 }</span>
<a href="#l6.119"></a><span id="l6.119"> </span>
<a href="#l6.120"></a><span id="l6.120" class="difflineat">@@ -912,17 +912,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.121"></a><span id="l6.121">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l6.122"></a><span id="l6.122">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l6.123"></a><span id="l6.123">                 let listenerDetail = aItem;</span>
<a href="#l6.124"></a><span id="l6.124">                 let responseStatus;</span>
<a href="#l6.125"></a><span id="l6.125">                 try {</span>
<a href="#l6.126"></a><span id="l6.126">                     responseStatus = request.responseStatus;</span>
<a href="#l6.127"></a><span id="l6.127"> </span>
<a href="#l6.128"></a><span id="l6.128">                     if (self.verboseLogging()) {</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-                        let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+                        let str = cal.provider.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.131"></a><span id="l6.131">                         cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l6.132"></a><span id="l6.132">                     }</span>
<a href="#l6.133"></a><span id="l6.133">                 } catch (ex) {</span>
<a href="#l6.134"></a><span id="l6.134">                     listenerStatus = ex.result;</span>
<a href="#l6.135"></a><span id="l6.135">                     listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l6.136"></a><span id="l6.136">                     cal.LOG(&quot;CalDAV: Request error during delete: &quot; + ex);</span>
<a href="#l6.137"></a><span id="l6.137">                 }</span>
<a href="#l6.138"></a><span id="l6.138"> </span>
<a href="#l6.139"></a><span id="l6.139" class="difflineat">@@ -982,17 +982,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.140"></a><span id="l6.140">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l6.141"></a><span id="l6.141">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l6.142"></a><span id="l6.142">                 let listenerDetail = aItem;</span>
<a href="#l6.143"></a><span id="l6.143">                 let responseStatus;</span>
<a href="#l6.144"></a><span id="l6.144">                 try {</span>
<a href="#l6.145"></a><span id="l6.145">                     responseStatus = request.responseStatus;</span>
<a href="#l6.146"></a><span id="l6.146"> </span>
<a href="#l6.147"></a><span id="l6.147">                     if (self.verboseLogging()) {</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-                        let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+                        let str = cal.provider.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.150"></a><span id="l6.150">                         cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l6.151"></a><span id="l6.151">                     }</span>
<a href="#l6.152"></a><span id="l6.152">                 } catch (ex) {</span>
<a href="#l6.153"></a><span id="l6.153">                     listenerStatus = ex.result;</span>
<a href="#l6.154"></a><span id="l6.154">                     listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l6.155"></a><span id="l6.155">                     cal.LOG(&quot;CalDAV: Request error during add: &quot; + ex);</span>
<a href="#l6.156"></a><span id="l6.156">                 }</span>
<a href="#l6.157"></a><span id="l6.157"> </span>
<a href="#l6.158"></a><span id="l6.158" class="difflineat">@@ -1352,17 +1352,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.159"></a><span id="l6.159"> </span>
<a href="#l6.160"></a><span id="l6.160">         this.ensureTargetCalendar();</span>
<a href="#l6.161"></a><span id="l6.161"> </span>
<a href="#l6.162"></a><span id="l6.162">         if (this.mAuthScheme == &quot;Digest&quot;) {</span>
<a href="#l6.163"></a><span id="l6.163">             // the auth could have timed out and be in need of renegotiation</span>
<a href="#l6.164"></a><span id="l6.164">             // we can't risk several calendars doing this simultaneously so</span>
<a href="#l6.165"></a><span id="l6.165">             // we'll force the renegotiation in a sync query, using OPTIONS to keep</span>
<a href="#l6.166"></a><span id="l6.166">             // it quick</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-            let headchannel = cal.prepHttpChannel(this.makeUri(), null, null, this);</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+            let headchannel = cal.provider.prepHttpChannel(this.makeUri(), null, null, this);</span>
<a href="#l6.169"></a><span id="l6.169">             headchannel.requestMethod = &quot;OPTIONS&quot;;</span>
<a href="#l6.170"></a><span id="l6.170">             headchannel.open();</span>
<a href="#l6.171"></a><span id="l6.171">             headchannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l6.172"></a><span id="l6.172">             try {</span>
<a href="#l6.173"></a><span id="l6.173">                 if (headchannel.responseStatus != 200) {</span>
<a href="#l6.174"></a><span id="l6.174">                     throw &quot;OPTIONS returned unexpected status code: &quot; + headchannel.responseStatus;</span>
<a href="#l6.175"></a><span id="l6.175">                 }</span>
<a href="#l6.176"></a><span id="l6.176">             } catch (e) {</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineat">@@ -1413,17 +1413,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.178"></a><span id="l6.178">                 return;</span>
<a href="#l6.179"></a><span id="l6.179">             } else if (request.responseStatus == 207 &amp;&amp; self.mDisabled) {</span>
<a href="#l6.180"></a><span id="l6.180">                 // Looks like the calendar is there again, check its resource</span>
<a href="#l6.181"></a><span id="l6.181">                 // type first.</span>
<a href="#l6.182"></a><span id="l6.182">                 self.setupAuthentication(aChangeLogListener);</span>
<a href="#l6.183"></a><span id="l6.183">                 return;</span>
<a href="#l6.184"></a><span id="l6.184">             }</span>
<a href="#l6.185"></a><span id="l6.185"> </span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-            let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+            let str = cal.provider.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.188"></a><span id="l6.188">             if (!str) {</span>
<a href="#l6.189"></a><span id="l6.189">                 cal.LOG(&quot;CalDAV: Failed to get ctag from server for calendar &quot; +</span>
<a href="#l6.190"></a><span id="l6.190">                         self.name);</span>
<a href="#l6.191"></a><span id="l6.191">             } else if (self.verboseLogging()) {</span>
<a href="#l6.192"></a><span id="l6.192">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l6.193"></a><span id="l6.193">             }</span>
<a href="#l6.194"></a><span id="l6.194"> </span>
<a href="#l6.195"></a><span id="l6.195">             let multistatus;</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineat">@@ -1546,17 +1546,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.197"></a><span id="l6.197">             }</span>
<a href="#l6.198"></a><span id="l6.198">         }, false);</span>
<a href="#l6.199"></a><span id="l6.199">     },</span>
<a href="#l6.200"></a><span id="l6.200"> </span>
<a href="#l6.201"></a><span id="l6.201">     /**</span>
<a href="#l6.202"></a><span id="l6.202">      * @see nsIInterfaceRequestor</span>
<a href="#l6.203"></a><span id="l6.203">      * @see calProviderUtils.jsm</span>
<a href="#l6.204"></a><span id="l6.204">      */</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-    getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+    getInterface: cal.provider.InterfaceRequestor_getInterface,</span>
<a href="#l6.207"></a><span id="l6.207"> </span>
<a href="#l6.208"></a><span id="l6.208">     //</span>
<a href="#l6.209"></a><span id="l6.209">     // Helper functions</span>
<a href="#l6.210"></a><span id="l6.210">     //</span>
<a href="#l6.211"></a><span id="l6.211"> </span>
<a href="#l6.212"></a><span id="l6.212">     /**</span>
<a href="#l6.213"></a><span id="l6.213">      * Sets up any needed prerequisites regarding authentication. This is the</span>
<a href="#l6.214"></a><span id="l6.214">      * beginning of a chain of asynchronous calls. This function will, when</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineat">@@ -1789,17 +1789,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.216"></a><span id="l6.216">             // we only really need the authrealm for Digest auth</span>
<a href="#l6.217"></a><span id="l6.217">             // since only Digest is going to time out on us</span>
<a href="#l6.218"></a><span id="l6.218">             if (self.mAuthScheme == &quot;Digest&quot;) {</span>
<a href="#l6.219"></a><span id="l6.219">                 let realmChop = wwwauth.split(&quot;realm=\&quot;&quot;)[1];</span>
<a href="#l6.220"></a><span id="l6.220">                 self.mAuthRealm = realmChop.split(&quot;\&quot;, &quot;)[0];</span>
<a href="#l6.221"></a><span id="l6.221">                 cal.LOG(&quot;CalDAV: realm &quot; + self.mAuthRealm);</span>
<a href="#l6.222"></a><span id="l6.222">             }</span>
<a href="#l6.223"></a><span id="l6.223"> </span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-            let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+            let str = cal.provider.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.226"></a><span id="l6.226">             if (!str || request.responseStatus == 404) {</span>
<a href="#l6.227"></a><span id="l6.227">                 // No response, or the calendar no longer exists.</span>
<a href="#l6.228"></a><span id="l6.228">                 cal.LOG(&quot;CalDAV: Failed to determine resource type for&quot; +</span>
<a href="#l6.229"></a><span id="l6.229">                         self.name);</span>
<a href="#l6.230"></a><span id="l6.230">                 self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l6.231"></a><span id="l6.231">                                              Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l6.232"></a><span id="l6.232">                 return;</span>
<a href="#l6.233"></a><span id="l6.233">             } else if (self.verboseLogging()) {</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineat">@@ -1958,17 +1958,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.235"></a><span id="l6.235">             try {</span>
<a href="#l6.236"></a><span id="l6.236">                 dav = request.getResponseHeader(&quot;DAV&quot;);</span>
<a href="#l6.237"></a><span id="l6.237">                 if (self.verboseLogging()) {</span>
<a href="#l6.238"></a><span id="l6.238">                     cal.LOG(&quot;CalDAV: DAV header: &quot; + dav);</span>
<a href="#l6.239"></a><span id="l6.239">                 }</span>
<a href="#l6.240"></a><span id="l6.240">             } catch (ex) {</span>
<a href="#l6.241"></a><span id="l6.241">                 cal.LOG(&quot;CalDAV: Error getting DAV header for &quot; + self.name +</span>
<a href="#l6.242"></a><span id="l6.242">                         &quot;, status &quot; + request.responseStatus +</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-                        &quot;, data: &quot; + cal.convertByteArray(aResult, aResultLength));</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+                        &quot;, data: &quot; + cal.provider.convertByteArray(aResult, aResultLength));</span>
<a href="#l6.245"></a><span id="l6.245">             }</span>
<a href="#l6.246"></a><span id="l6.246">             // Google does not yet support OPTIONS but does support scheduling</span>
<a href="#l6.247"></a><span id="l6.247">             // so we'll spoof the DAV header until Google gets fixed</span>
<a href="#l6.248"></a><span id="l6.248">             if (self.calendarUri.host == &quot;www.google.com&quot;) {</span>
<a href="#l6.249"></a><span id="l6.249">                 dav = &quot;calendar-schedule&quot;;</span>
<a href="#l6.250"></a><span id="l6.250">                 // Google also reports an inbox URL distinct from the calendar</span>
<a href="#l6.251"></a><span id="l6.251">                 // URL but a) doesn't use it and b) 405s on etag queries to it</span>
<a href="#l6.252"></a><span id="l6.252">                 self.mShouldPollInbox = false;</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineat">@@ -2054,17 +2054,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.254"></a><span id="l6.254">             if (request.responseStatus != 207) {</span>
<a href="#l6.255"></a><span id="l6.255">                 cal.LOG(&quot;CalDAV: Unexpected status &quot; + request.responseStatus +</span>
<a href="#l6.256"></a><span id="l6.256">                     &quot; while querying principal namespace for &quot; + self.name);</span>
<a href="#l6.257"></a><span id="l6.257">                 self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l6.258"></a><span id="l6.258">                                              Components.results.NS_ERROR_FAILURE);</span>
<a href="#l6.259"></a><span id="l6.259">                 return;</span>
<a href="#l6.260"></a><span id="l6.260">             }</span>
<a href="#l6.261"></a><span id="l6.261"> </span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-            let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+            let str = cal.provider.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.264"></a><span id="l6.264">             if (!str) {</span>
<a href="#l6.265"></a><span id="l6.265">                 cal.LOG(&quot;CalDAV: Failed to propstat principal namespace for &quot; + self.name);</span>
<a href="#l6.266"></a><span id="l6.266">                 self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l6.267"></a><span id="l6.267">                                              Components.results.NS_ERROR_FAILURE);</span>
<a href="#l6.268"></a><span id="l6.268">                 return;</span>
<a href="#l6.269"></a><span id="l6.269">             } else if (self.verboseLogging()) {</span>
<a href="#l6.270"></a><span id="l6.270">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l6.271"></a><span id="l6.271">             }</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineat">@@ -2171,17 +2171,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.273"></a><span id="l6.273"> </span>
<a href="#l6.274"></a><span id="l6.274">         if (this.verboseLogging()) {</span>
<a href="#l6.275"></a><span id="l6.275">             cal.LOG(&quot;CalDAV: send: &quot; + queryMethod + &quot; &quot; + requestUri.spec + &quot;\n&quot; + queryXml);</span>
<a href="#l6.276"></a><span id="l6.276">         }</span>
<a href="#l6.277"></a><span id="l6.277"> </span>
<a href="#l6.278"></a><span id="l6.278">         let streamListener = {};</span>
<a href="#l6.279"></a><span id="l6.279">         streamListener.onStreamComplete = function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l6.280"></a><span id="l6.280">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-            let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+            let str = cal.provider.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.283"></a><span id="l6.283">             if (!str) {</span>
<a href="#l6.284"></a><span id="l6.284">                 cal.LOG(&quot;CalDAV: Failed to report principals namespace for &quot; + self.name);</span>
<a href="#l6.285"></a><span id="l6.285">                 doesntSupportScheduling();</span>
<a href="#l6.286"></a><span id="l6.286">                 return;</span>
<a href="#l6.287"></a><span id="l6.287">             } else if (self.verboseLogging()) {</span>
<a href="#l6.288"></a><span id="l6.288">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l6.289"></a><span id="l6.289">             }</span>
<a href="#l6.290"></a><span id="l6.290"> </span>
<a href="#l6.291"></a><span id="l6.291" class="difflineat">@@ -2441,17 +2441,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.292"></a><span id="l6.292">                     &quot;,Recipient=&quot; + mailto_aCalId + &quot;): &quot; + fbQuery);</span>
<a href="#l6.293"></a><span id="l6.293">         }</span>
<a href="#l6.294"></a><span id="l6.294"> </span>
<a href="#l6.295"></a><span id="l6.295">         let streamListener = {};</span>
<a href="#l6.296"></a><span id="l6.296"> </span>
<a href="#l6.297"></a><span id="l6.297">         streamListener.onStreamComplete = function(aLoader, aContext, aStatus,</span>
<a href="#l6.298"></a><span id="l6.298">                                                    aResultLength, aResult) {</span>
<a href="#l6.299"></a><span id="l6.299">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-            let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+            let str = cal.provider.convertByteArray(aResult, aResultLength);</span>
<a href="#l6.302"></a><span id="l6.302">             if (!str) {</span>
<a href="#l6.303"></a><span id="l6.303">                 cal.LOG(&quot;CalDAV: Failed to parse freebusy response from &quot; + self.name);</span>
<a href="#l6.304"></a><span id="l6.304">             } else if (self.verboseLogging()) {</span>
<a href="#l6.305"></a><span id="l6.305">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l6.306"></a><span id="l6.306">             }</span>
<a href="#l6.307"></a><span id="l6.307"> </span>
<a href="#l6.308"></a><span id="l6.308">             if (request.responseStatus == 200) {</span>
<a href="#l6.309"></a><span id="l6.309">                 let periodsToReturn = [];</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineat">@@ -2485,28 +2485,28 @@ calDavCalendar.prototype = {</span>
<a href="#l6.311"></a><span id="l6.311">                 let caldata = caldavXPathFirst(fbResult, &quot;/C:schedule-response/C:response/C:calendar-data/text()&quot;);</span>
<a href="#l6.312"></a><span id="l6.312">                 try {</span>
<a href="#l6.313"></a><span id="l6.313">                     let calComp = cal.getIcsService().parseICS(caldata, null);</span>
<a href="#l6.314"></a><span id="l6.314">                     for (let calFbComp of cal.ical.calendarComponentIterator(calComp)) {</span>
<a href="#l6.315"></a><span id="l6.315">                         let interval;</span>
<a href="#l6.316"></a><span id="l6.316"> </span>
<a href="#l6.317"></a><span id="l6.317">                         let replyRangeStart = calFbComp.startTime;</span>
<a href="#l6.318"></a><span id="l6.318">                         if (replyRangeStart &amp;&amp; (aRangeStart.compare(replyRangeStart) == -1)) {</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-                            interval = new cal.FreeBusyInterval(aCalId,</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-                                                                calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-                                                                aRangeStart,</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-                                                                replyRangeStart);</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+                            interval = new cal.provider.FreeBusyInterval(aCalId,</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+                                                                         calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+                                                                         aRangeStart,</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+                                                                         replyRangeStart);</span>
<a href="#l6.327"></a><span id="l6.327">                             periodsToReturn.push(interval);</span>
<a href="#l6.328"></a><span id="l6.328">                         }</span>
<a href="#l6.329"></a><span id="l6.329">                         let replyRangeEnd = calFbComp.endTime;</span>
<a href="#l6.330"></a><span id="l6.330">                         if (replyRangeEnd &amp;&amp; (aRangeEnd.compare(replyRangeEnd) == 1)) {</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-                            interval = new cal.FreeBusyInterval(aCalId,</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-                                                                calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-                                                                replyRangeEnd,</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-                                                                aRangeEnd);</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+                            interval = new cal.provider.FreeBusyInterval(aCalId,</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+                                                                         calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+                                                                         replyRangeEnd,</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+                                                                         aRangeEnd);</span>
<a href="#l6.339"></a><span id="l6.339">                             periodsToReturn.push(interval);</span>
<a href="#l6.340"></a><span id="l6.340">                         }</span>
<a href="#l6.341"></a><span id="l6.341"> </span>
<a href="#l6.342"></a><span id="l6.342">                         for (let fbProp of cal.ical.propertyIterator(calFbComp, &quot;FREEBUSY&quot;)) {</span>
<a href="#l6.343"></a><span id="l6.343">                             let fbType = fbProp.getParameter(&quot;FBTYPE&quot;);</span>
<a href="#l6.344"></a><span id="l6.344">                             if (fbType) {</span>
<a href="#l6.345"></a><span id="l6.345">                                 fbType = fbTypeMap[fbType];</span>
<a href="#l6.346"></a><span id="l6.346">                             } else {</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineat">@@ -2517,20 +2517,20 @@ calDavCalendar.prototype = {</span>
<a href="#l6.348"></a><span id="l6.348">                             let end;</span>
<a href="#l6.349"></a><span id="l6.349">                             if (parts[1].charAt(0) == &quot;P&quot;) { // this is a duration</span>
<a href="#l6.350"></a><span id="l6.350">                                 end = begin.clone();</span>
<a href="#l6.351"></a><span id="l6.351">                                 end.addDuration(cal.createDuration(parts[1]));</span>
<a href="#l6.352"></a><span id="l6.352">                             } else {</span>
<a href="#l6.353"></a><span id="l6.353">                                 // This is a date string</span>
<a href="#l6.354"></a><span id="l6.354">                                 end = cal.createDateTime(parts[1]);</span>
<a href="#l6.355"></a><span id="l6.355">                             }</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-                            interval = new cal.FreeBusyInterval(aCalId,</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-                                                                fbType,</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-                                                                begin,</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-                                                                end);</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+                            interval = new cal.provider.FreeBusyInterval(aCalId,</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+                                                                         fbType,</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+                                                                         begin,</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+                                                                         end);</span>
<a href="#l6.364"></a><span id="l6.364">                             periodsToReturn.push(interval);</span>
<a href="#l6.365"></a><span id="l6.365">                         }</span>
<a href="#l6.366"></a><span id="l6.366">                     }</span>
<a href="#l6.367"></a><span id="l6.367">                 } catch (exc) {</span>
<a href="#l6.368"></a><span id="l6.368">                     cal.ERROR(&quot;CalDAV: Error parsing free-busy info.&quot;);</span>
<a href="#l6.369"></a><span id="l6.369">                 }</span>
<a href="#l6.370"></a><span id="l6.370"> </span>
<a href="#l6.371"></a><span id="l6.371">                 aListener.onResult(null, periodsToReturn);</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineat">@@ -2625,17 +2625,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.373"></a><span id="l6.373">         if ((!this.hasScheduling &amp;&amp; !this.hasAutoScheduling) || !this.mShouldPollInbox || !this.firstInRealm()) {</span>
<a href="#l6.374"></a><span id="l6.374">             return;</span>
<a href="#l6.375"></a><span id="l6.375">         }</span>
<a href="#l6.376"></a><span id="l6.376"> </span>
<a href="#l6.377"></a><span id="l6.377">         this.getUpdatedItems(this.mInboxUrl, null);</span>
<a href="#l6.378"></a><span id="l6.378">     },</span>
<a href="#l6.379"></a><span id="l6.379"> </span>
<a href="#l6.380"></a><span id="l6.380">     //</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-    // take calISchedulingSupport interface base implementation (cal.ProviderBase)</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+    // take calISchedulingSupport interface base implementation (cal.provider.BaseClass)</span>
<a href="#l6.383"></a><span id="l6.383">     //</span>
<a href="#l6.384"></a><span id="l6.384"> </span>
<a href="#l6.385"></a><span id="l6.385">     processItipReply: function(aItem, aPath) {</span>
<a href="#l6.386"></a><span id="l6.386">         // modify partstat for in-calendar item</span>
<a href="#l6.387"></a><span id="l6.387">         // delete item from inbox</span>
<a href="#l6.388"></a><span id="l6.388">         let self = this;</span>
<a href="#l6.389"></a><span id="l6.389"> </span>
<a href="#l6.390"></a><span id="l6.390">         let getItemListener = {};</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineat">@@ -2718,17 +2718,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.392"></a><span id="l6.392">     },</span>
<a href="#l6.393"></a><span id="l6.393">     set senderAddress(aString) {</span>
<a href="#l6.394"></a><span id="l6.394">         return (this.mSenderAddress = aString);</span>
<a href="#l6.395"></a><span id="l6.395">     },</span>
<a href="#l6.396"></a><span id="l6.396"> </span>
<a href="#l6.397"></a><span id="l6.397">     sendItems: function(aCount, aRecipients, aItipItem) {</span>
<a href="#l6.398"></a><span id="l6.398">         function doImipScheduling(aCalendar, aRecipientList) {</span>
<a href="#l6.399"></a><span id="l6.399">             let result = false;</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-            let imipTransport = cal.getImipTransport(aCalendar);</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+            let imipTransport = cal.provider.getImipTransport(aCalendar);</span>
<a href="#l6.402"></a><span id="l6.402">             let recipients = [];</span>
<a href="#l6.403"></a><span id="l6.403">             aRecipientList.forEach(rec =&gt; recipients.push(rec.toString()));</span>
<a href="#l6.404"></a><span id="l6.404">             if (imipTransport) {</span>
<a href="#l6.405"></a><span id="l6.405">                 cal.LOG(&quot;Enforcing client-side email scheduling instead of server-side scheduling&quot; +</span>
<a href="#l6.406"></a><span id="l6.406">                         &quot; for &quot; + recipients.join());</span>
<a href="#l6.407"></a><span id="l6.407">                 result = imipTransport.sendItems(aCount, aRecipientList, aItipItem);</span>
<a href="#l6.408"></a><span id="l6.408">             } else {</span>
<a href="#l6.409"></a><span id="l6.409">                 cal.ERROR(&quot;No imip transport available for &quot; + aCalendar.id + &quot;, failed to notify&quot; +</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineat">@@ -2801,17 +2801,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.411"></a><span id="l6.411">                                 self.name);</span>
<a href="#l6.412"></a><span id="l6.412">                     }</span>
<a href="#l6.413"></a><span id="l6.413"> </span>
<a href="#l6.414"></a><span id="l6.414">                     if (status != 200) {</span>
<a href="#l6.415"></a><span id="l6.415">                         cal.LOG(&quot;CalDAV: Sending iTIP failed with status &quot; + status +</span>
<a href="#l6.416"></a><span id="l6.416">                                 &quot; for &quot; + self.name);</span>
<a href="#l6.417"></a><span id="l6.417">                     }</span>
<a href="#l6.418"></a><span id="l6.418"> </span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-                    let str = cal.convertByteArray(aResult, aResultLength, &quot;UTF-8&quot;, false);</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+                    let str = cal.provider.convertByteArray(aResult, aResultLength, &quot;UTF-8&quot;, false);</span>
<a href="#l6.421"></a><span id="l6.421">                     if (str) {</span>
<a href="#l6.422"></a><span id="l6.422">                         if (self.verboseLogging()) {</span>
<a href="#l6.423"></a><span id="l6.423">                             cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l6.424"></a><span id="l6.424">                         }</span>
<a href="#l6.425"></a><span id="l6.425">                     } else {</span>
<a href="#l6.426"></a><span id="l6.426">                         cal.LOG(&quot;CalDAV: Failed to parse iTIP response for&quot; +</span>
<a href="#l6.427"></a><span id="l6.427">                                 self.name);</span>
<a href="#l6.428"></a><span id="l6.428">                     }</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineat">@@ -2845,17 +2845,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.430"></a><span id="l6.430">                                 }</span>
<a href="#l6.431"></a><span id="l6.431">                             }</span>
<a href="#l6.432"></a><span id="l6.432">                         }</span>
<a href="#l6.433"></a><span id="l6.433">                     }</span>
<a href="#l6.434"></a><span id="l6.434"> </span>
<a href="#l6.435"></a><span id="l6.435">                     if (remainingAttendees.length) {</span>
<a href="#l6.436"></a><span id="l6.436">                         // try to fall back to email delivery if CalDAV-sched</span>
<a href="#l6.437"></a><span id="l6.437">                         // didn't work</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineminus">-                        let imipTransport = cal.getImipTransport(self);</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineplus">+                        let imipTransport = cal.provider.getImipTransport(self);</span>
<a href="#l6.440"></a><span id="l6.440">                         if (imipTransport) {</span>
<a href="#l6.441"></a><span id="l6.441">                             if (self.verboseLogging()) {</span>
<a href="#l6.442"></a><span id="l6.442">                                 cal.LOG(&quot;CalDAV: sending email to &quot; + remainingAttendees.length + &quot; recipients&quot;);</span>
<a href="#l6.443"></a><span id="l6.443">                             }</span>
<a href="#l6.444"></a><span id="l6.444">                             imipTransport.sendItems(remainingAttendees.length, remainingAttendees, aItipItem);</span>
<a href="#l6.445"></a><span id="l6.445">                         } else {</span>
<a href="#l6.446"></a><span id="l6.446">                             cal.LOG(&quot;CalDAV: no fallback to iTIP/iMIP transport for &quot; +</span>
<a href="#l6.447"></a><span id="l6.447">                                     self.name);</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineat">@@ -2909,17 +2909,17 @@ calDavCalendar.prototype = {</span>
<a href="#l6.449"></a><span id="l6.449">         let uploadContent;</span>
<a href="#l6.450"></a><span id="l6.450">         if (aOldChannel instanceof Components.interfaces.nsIUploadChannel &amp;&amp;</span>
<a href="#l6.451"></a><span id="l6.451">             aOldChannel instanceof Components.interfaces.nsIHttpChannel &amp;&amp;</span>
<a href="#l6.452"></a><span id="l6.452">             aOldChannel.uploadStream) {</span>
<a href="#l6.453"></a><span id="l6.453">             uploadData = aOldChannel.uploadStream;</span>
<a href="#l6.454"></a><span id="l6.454">             uploadContent = aOldChannel.getRequestHeader(&quot;Content-Type&quot;);</span>
<a href="#l6.455"></a><span id="l6.455">         }</span>
<a href="#l6.456"></a><span id="l6.456"> </span>
<a href="#l6.457"></a><span id="l6.457" class="difflineminus">-        cal.prepHttpChannel(null,</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineplus">+        cal.provider.prepHttpChannel(null,</span>
<a href="#l6.459"></a><span id="l6.459">                             uploadData,</span>
<a href="#l6.460"></a><span id="l6.460">                             uploadContent,</span>
<a href="#l6.461"></a><span id="l6.461">                             this,</span>
<a href="#l6.462"></a><span id="l6.462">                             aNewChannel);</span>
<a href="#l6.463"></a><span id="l6.463"> </span>
<a href="#l6.464"></a><span id="l6.464">         // Make sure we can get/set headers on both channels.</span>
<a href="#l6.465"></a><span id="l6.465">         aNewChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l6.466"></a><span id="l6.466">         aOldChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -35,17 +35,17 @@ function calGoogleCalendar() {</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5"> var calGoogleCalendarClassID = Components.ID(&quot;{d1a6e988-4b4d-45a5-ba46-43e501ea96e3}&quot;);</span>
<a href="#l7.6"></a><span id="l7.6"> var calGoogleCalendarInterfaces = [</span>
<a href="#l7.7"></a><span id="l7.7">     Components.interfaces.calICalendar,</span>
<a href="#l7.8"></a><span id="l7.8">     Components.interfaces.calISchedulingSupport,</span>
<a href="#l7.9"></a><span id="l7.9">     Components.interfaces.calIChangeLog</span>
<a href="#l7.10"></a><span id="l7.10"> ];</span>
<a href="#l7.11"></a><span id="l7.11"> calGoogleCalendar.prototype = {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15">     classID: calGoogleCalendarClassID,</span>
<a href="#l7.16"></a><span id="l7.16">     QueryInterface: XPCOMUtils.generateQI(calGoogleCalendarInterfaces),</span>
<a href="#l7.17"></a><span id="l7.17">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l7.18"></a><span id="l7.18">         classDescription: &quot;Google Calendar Provider&quot;,</span>
<a href="#l7.19"></a><span id="l7.19">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=gdata&quot;,</span>
<a href="#l7.20"></a><span id="l7.20">         classID: calGoogleCalendarClassID,</span>
<a href="#l7.21"></a><span id="l7.21">         interfaces: calGoogleCalendarInterfaces</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataRequest.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataRequest.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -212,19 +212,19 @@ calGoogleRequest.prototype = {</span>
<a href="#l8.4"></a><span id="l8.4">             cal.LOG(&quot;[calGoogleRequest] Requesting &quot; + this.method + &quot; &quot; +</span>
<a href="#l8.5"></a><span id="l8.5">                     channel.URI.spec);</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">             this.prepareChannel(channel);</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">             channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l8.10"></a><span id="l8.10">             channel.redirectionLimit = 3;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-            this.mLoader = cal.createStreamLoader();</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+            this.mLoader = cal.provider.createStreamLoader();</span>
<a href="#l8.14"></a><span id="l8.14">             channel.notificationCallbacks = this;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-            cal.sendHttpRequest(this.mLoader, channel, this);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+            cal.provider.sendHttpRequest(this.mLoader, channel, this);</span>
<a href="#l8.17"></a><span id="l8.17">         } catch (e) {</span>
<a href="#l8.18"></a><span id="l8.18">             // Let the response function handle the error that happens here</span>
<a href="#l8.19"></a><span id="l8.19">             this.fail(e.result, e.message);</span>
<a href="#l8.20"></a><span id="l8.20">         }</span>
<a href="#l8.21"></a><span id="l8.21">         return promise;</span>
<a href="#l8.22"></a><span id="l8.22">     },</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">     /**</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineat">@@ -322,17 +322,17 @@ calGoogleRequest.prototype = {</span>
<a href="#l8.26"></a><span id="l8.26">                      aChannel.URI.spec);</span>
<a href="#l8.27"></a><span id="l8.27">         }</span>
<a href="#l8.28"></a><span id="l8.28">     },</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30">     /**</span>
<a href="#l8.31"></a><span id="l8.31">      * @see nsIInterfaceRequestor</span>
<a href="#l8.32"></a><span id="l8.32">      * @see calProviderUtils.jsm</span>
<a href="#l8.33"></a><span id="l8.33">      */</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-    getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+    getInterface: cal.provider.InterfaceRequestor_getInterface,</span>
<a href="#l8.36"></a><span id="l8.36"> </span>
<a href="#l8.37"></a><span id="l8.37">     /**</span>
<a href="#l8.38"></a><span id="l8.38">      * @see nsIChannelEventSink</span>
<a href="#l8.39"></a><span id="l8.39">      */</span>
<a href="#l8.40"></a><span id="l8.40">     asyncOnChannelRedirect: function(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l8.41"></a><span id="l8.41">         // all we need to do to the new channel is the basic preparation</span>
<a href="#l8.42"></a><span id="l8.42">         this.prepareChannel(aNewChannel);</span>
<a href="#l8.43"></a><span id="l8.43">         aCallback.onRedirectVerifyCallback(Components.results.NS_OK);</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineat">@@ -345,17 +345,17 @@ calGoogleRequest.prototype = {</span>
<a href="#l8.45"></a><span id="l8.45">         if (!aResult || !Components.isSuccessCode(aStatus)) {</span>
<a href="#l8.46"></a><span id="l8.46">             this.fail(aStatus, aResult);</span>
<a href="#l8.47"></a><span id="l8.47">             return;</span>
<a href="#l8.48"></a><span id="l8.48">         }</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50">         let httpChannel = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l8.51"></a><span id="l8.51"> </span>
<a href="#l8.52"></a><span id="l8.52">         // Convert the stream, falling back to utf-8 in case its not given.</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-        let result = cal.convertByteArray(aResult, aResultLength, httpChannel.contentCharset);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+        let result = cal.provider.convertByteArray(aResult, aResultLength, httpChannel.contentCharset);</span>
<a href="#l8.55"></a><span id="l8.55">         if (result === null) {</span>
<a href="#l8.56"></a><span id="l8.56">             this.fail(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l8.57"></a><span id="l8.57">                       &quot;Could not convert bytestream to Unicode: &quot; + e);</span>
<a href="#l8.58"></a><span id="l8.58">             return;</span>
<a href="#l8.59"></a><span id="l8.59">         }</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61">         let objData;</span>
<a href="#l8.62"></a><span id="l8.62">         try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -459,17 +459,17 @@ calGoogleSession.prototype = {</span>
<a href="#l9.4"></a><span id="l9.4">                     cal.LOG(&quot;[calGoogleCalendar] Could not request freebusy for &quot; + strippedCalId + &quot;: &quot; + reason);</span>
<a href="#l9.5"></a><span id="l9.5">                     failSync(Components.results.NS_ERROR_FAILURE, reason);</span>
<a href="#l9.6"></a><span id="l9.6">                 } else {</span>
<a href="#l9.7"></a><span id="l9.7">                     let utcZone = cal.dtz.UTC;</span>
<a href="#l9.8"></a><span id="l9.8">                     cal.LOG(&quot;[calGoogleCalendar] Found &quot; + calData.busy.length + &quot; busy slots within range for &quot; + strippedCalId);</span>
<a href="#l9.9"></a><span id="l9.9">                     let busyRanges = calData.busy.map((entry) =&gt; {</span>
<a href="#l9.10"></a><span id="l9.10">                         let start = cal.dtz.fromRFC3339(entry.start, utcZone);</span>
<a href="#l9.11"></a><span id="l9.11">                         let end = cal.dtz.fromRFC3339(entry.end, utcZone);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-                        let interval = new cal.FreeBusyInterval(aCalId, cIFBI.BUSY, start, end);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+                        let interval = new cal.provider.FreeBusyInterval(aCalId, cIFBI.BUSY, start, end);</span>
<a href="#l9.14"></a><span id="l9.14">                         LOGinterval(interval);</span>
<a href="#l9.15"></a><span id="l9.15">                         return interval;</span>
<a href="#l9.16"></a><span id="l9.16">                     });</span>
<a href="#l9.17"></a><span id="l9.17">                     completeSync(busyRanges);</span>
<a href="#l9.18"></a><span id="l9.18">                 }</span>
<a href="#l9.19"></a><span id="l9.19">             } else {</span>
<a href="#l9.20"></a><span id="l9.20">                 cal.ERROR(&quot;[calGoogleCalendar] Invalid freebusy response: &quot; + aData.toSource());</span>
<a href="#l9.21"></a><span id="l9.21">                 failSync(Components.results.NS_ERROR_FAILURE, (aData &amp;&amp; aData.toSource()));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1284,17 +1284,17 @@ ActivityShell.prototype = {</span>
<a href="#l10.4"></a><span id="l10.4">  * @param aCalendar         The calendar this operation happens in</span>
<a href="#l10.5"></a><span id="l10.5">  * @param aItem             The item that was passed to the server</span>
<a href="#l10.6"></a><span id="l10.6">  * @return                  A promise resolved when the conflict has been resolved</span>
<a href="#l10.7"></a><span id="l10.7">  */</span>
<a href="#l10.8"></a><span id="l10.8"> async function checkResolveConflict(aOperation, aCalendar, aItem) {</span>
<a href="#l10.9"></a><span id="l10.9">     cal.LOG(&quot;[calGoogleCalendar] A conflict occurred for &quot; + aItem.title);</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">     let method = (aOperation.type == aOperation.DELETE ? &quot;delete&quot; : &quot;modify&quot;);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    let overwrite = cal.promptOverwrite(method, aItem);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    let overwrite = cal.provider.promptOverwrite(method, aItem);</span>
<a href="#l10.14"></a><span id="l10.14">     if (overwrite) {</span>
<a href="#l10.15"></a><span id="l10.15">         // The user has decided to overwrite the server version. Send again</span>
<a href="#l10.16"></a><span id="l10.16">         // overwriting the server version with If-Match: *</span>
<a href="#l10.17"></a><span id="l10.17">         cal.LOG(&quot;[calGoogleCalendar] Resending &quot; + method + &quot; and ignoring ETag&quot;);</span>
<a href="#l10.18"></a><span id="l10.18">         aOperation.addRequestHeader(&quot;If-Match&quot;, &quot;*&quot;);</span>
<a href="#l10.19"></a><span id="l10.19">         try {</span>
<a href="#l10.20"></a><span id="l10.20">             return await aCalendar.session.asyncItemRequest(aOperation);</span>
<a href="#l10.21"></a><span id="l10.21">         } catch (e) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -45,17 +45,17 @@ var calICSCalendarInterfaces = [</span>
<a href="#l11.4"></a><span id="l11.4">     Components.interfaces.calICalendar,</span>
<a href="#l11.5"></a><span id="l11.5">     Components.interfaces.calISchedulingSupport,</span>
<a href="#l11.6"></a><span id="l11.6">     Components.interfaces.nsIStreamListener,</span>
<a href="#l11.7"></a><span id="l11.7">     Components.interfaces.nsIStreamLoaderObserver,</span>
<a href="#l11.8"></a><span id="l11.8">     Components.interfaces.nsIChannelEventSink,</span>
<a href="#l11.9"></a><span id="l11.9">     Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l11.10"></a><span id="l11.10"> ];</span>
<a href="#l11.11"></a><span id="l11.11"> calICSCalendar.prototype = {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l11.14"></a><span id="l11.14">     classID: calICSCalendarClassID,</span>
<a href="#l11.15"></a><span id="l11.15">     QueryInterface: XPCOMUtils.generateQI(calICSCalendarInterfaces),</span>
<a href="#l11.16"></a><span id="l11.16">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l11.17"></a><span id="l11.17">         classID: calICSCalendarClassID,</span>
<a href="#l11.18"></a><span id="l11.18">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=ics&quot;,</span>
<a href="#l11.19"></a><span id="l11.19">         classDescription: &quot;Calendar ICS provider&quot;,</span>
<a href="#l11.20"></a><span id="l11.20">         interfaces: calICSCalendarInterfaces,</span>
<a href="#l11.21"></a><span id="l11.21">     }),</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -611,17 +611,17 @@ calICSCalendar.prototype = {</span>
<a href="#l11.23"></a><span id="l11.23">     endBatch: function() {</span>
<a href="#l11.24"></a><span id="l11.24">         this.mObserver.onEndBatch();</span>
<a href="#l11.25"></a><span id="l11.25">     },</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27">     /**</span>
<a href="#l11.28"></a><span id="l11.28">      * @see nsIInterfaceRequestor</span>
<a href="#l11.29"></a><span id="l11.29">      * @see calProviderUtils.jsm</span>
<a href="#l11.30"></a><span id="l11.30">      */</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+    getInterface: cal.provider.InterfaceRequestor_getInterface,</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34">     /**</span>
<a href="#l11.35"></a><span id="l11.35">      * Make a backup of the (remote) calendar</span>
<a href="#l11.36"></a><span id="l11.36">      *</span>
<a href="#l11.37"></a><span id="l11.37">      * This will download the remote file into the profile dir.</span>
<a href="#l11.38"></a><span id="l11.38">      * It should be called before every upload, so every change can be</span>
<a href="#l11.39"></a><span id="l11.39">      * restored. By default, it will keep 3 backups. It also keeps one</span>
<a href="#l11.40"></a><span id="l11.40">      * file each day, for 3 days. That way, even if the user doesn't notice</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineat">@@ -720,17 +720,17 @@ calICSCalendar.prototype = {</span>
<a href="#l11.42"></a><span id="l11.42">             }</span>
<a href="#l11.43"></a><span id="l11.43">         }</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45">         let backupDays = Preferences.get(&quot;calendar.backup.days&quot;, 1);</span>
<a href="#l11.46"></a><span id="l11.46">         let numBackupFiles = Preferences.get(&quot;calendar.backup.filenum&quot;, 3);</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48">         let backupDir;</span>
<a href="#l11.49"></a><span id="l11.49">         try {</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-            backupDir = cal.getCalendarDirectory();</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+            backupDir = cal.provider.getCalendarDirectory();</span>
<a href="#l11.52"></a><span id="l11.52">             backupDir.append(&quot;backup&quot;);</span>
<a href="#l11.53"></a><span id="l11.53">             if (!backupDir.exists()) {</span>
<a href="#l11.54"></a><span id="l11.54">                 backupDir.create(Ci.nsIFile.DIRECTORY_TYPE, parseInt(&quot;0755&quot;, 8));</span>
<a href="#l11.55"></a><span id="l11.55">             }</span>
<a href="#l11.56"></a><span id="l11.56">         } catch (e) {</span>
<a href="#l11.57"></a><span id="l11.57">             // Backup dir wasn't found. Likely because we are running in</span>
<a href="#l11.58"></a><span id="l11.58">             // xpcshell. Don't die, but continue the upload.</span>
<a href="#l11.59"></a><span id="l11.59">             cal.ERROR(&quot;[calICSCalendar] Backup failed, no backupdir:&quot; + e);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineat">@@ -1023,26 +1023,26 @@ httpHooks.prototype = {</span>
<a href="#l11.61"></a><span id="l11.61">             };</span>
<a href="#l11.62"></a><span id="l11.62">             let queryXml =</span>
<a href="#l11.63"></a><span id="l11.63">                 '&lt;D:propfind xmlns:D=&quot;DAV:&quot;&gt;' +</span>
<a href="#l11.64"></a><span id="l11.64">                   &quot;&lt;D:prop&gt;&quot; +</span>
<a href="#l11.65"></a><span id="l11.65">                     &quot;&lt;D:getetag/&gt;&quot; +</span>
<a href="#l11.66"></a><span id="l11.66">                   &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l11.67"></a><span id="l11.67">                 &quot;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l11.68"></a><span id="l11.68"> </span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-            let etagChannel = cal.prepHttpChannel(aChannel.URI, queryXml,</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-                                                  &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-                                                  this);</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+            let etagChannel = cal.provider.prepHttpChannel(aChannel.URI, queryXml,</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+                                                           &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+                                                           this);</span>
<a href="#l11.75"></a><span id="l11.75">             etagChannel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l11.76"></a><span id="l11.76">             etagChannel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l11.77"></a><span id="l11.77">             let streamLoader = Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l11.78"></a><span id="l11.78">                                          .createInstance(Components.interfaces</span>
<a href="#l11.79"></a><span id="l11.79">                                          .nsIStreamLoader);</span>
<a href="#l11.80"></a><span id="l11.80"> </span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-            cal.sendHttpRequest(streamLoader, etagChannel, etagListener);</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+            cal.provider.sendHttpRequest(streamLoader, etagChannel, etagListener);</span>
<a href="#l11.83"></a><span id="l11.83">         }</span>
<a href="#l11.84"></a><span id="l11.84">         return true;</span>
<a href="#l11.85"></a><span id="l11.85">     },</span>
<a href="#l11.86"></a><span id="l11.86"> </span>
<a href="#l11.87"></a><span id="l11.87">     // nsIProgressEventSink</span>
<a href="#l11.88"></a><span id="l11.88">     onProgress: function(aRequest, aContext, aProgress, aProgressMax) {},</span>
<a href="#l11.89"></a><span id="l11.89">     onStatus: function(aRequest, aContext, aStatus, aStatusArg) {},</span>
<a href="#l11.90"></a><span id="l11.90"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -22,17 +22,17 @@ var calMemoryCalendarClassID = Component</span>
<a href="#l12.4"></a><span id="l12.4"> var calMemoryCalendarInterfaces = [</span>
<a href="#l12.5"></a><span id="l12.5">     Components.interfaces.calICalendar,</span>
<a href="#l12.6"></a><span id="l12.6">     Components.interfaces.calISchedulingSupport,</span>
<a href="#l12.7"></a><span id="l12.7">     Components.interfaces.calIOfflineStorage,</span>
<a href="#l12.8"></a><span id="l12.8">     Components.interfaces.calISyncWriteCalendar,</span>
<a href="#l12.9"></a><span id="l12.9">     Components.interfaces.calICalendarProvider</span>
<a href="#l12.10"></a><span id="l12.10"> ];</span>
<a href="#l12.11"></a><span id="l12.11"> calMemoryCalendar.prototype = {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l12.14"></a><span id="l12.14">     classID: calMemoryCalendarClassID,</span>
<a href="#l12.15"></a><span id="l12.15">     QueryInterface: XPCOMUtils.generateQI(calMemoryCalendarInterfaces),</span>
<a href="#l12.16"></a><span id="l12.16">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l12.17"></a><span id="l12.17">         classID: calMemoryCalendarClassID,</span>
<a href="#l12.18"></a><span id="l12.18">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=memory&quot;,</span>
<a href="#l12.19"></a><span id="l12.19">         classDescription: &quot;Calendar Memory Provider&quot;,</span>
<a href="#l12.20"></a><span id="l12.20">         interfaces: calMemoryCalendarInterfaces</span>
<a href="#l12.21"></a><span id="l12.21">     }),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -28,17 +28,17 @@ var calStorageCalendarClassID = Componen</span>
<a href="#l13.4"></a><span id="l13.4"> var calStorageCalendarInterfaces = [</span>
<a href="#l13.5"></a><span id="l13.5">     Components.interfaces.calICalendar,</span>
<a href="#l13.6"></a><span id="l13.6">     Components.interfaces.calICalendarProvider,</span>
<a href="#l13.7"></a><span id="l13.7">     Components.interfaces.calIOfflineStorage,</span>
<a href="#l13.8"></a><span id="l13.8">     Components.interfaces.calISchedulingSupport,</span>
<a href="#l13.9"></a><span id="l13.9">     Components.interfaces.calISyncWriteCalendar,</span>
<a href="#l13.10"></a><span id="l13.10"> ];</span>
<a href="#l13.11"></a><span id="l13.11"> calStorageCalendar.prototype = {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+    __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l13.14"></a><span id="l13.14">     classID: calStorageCalendarClassID,</span>
<a href="#l13.15"></a><span id="l13.15">     QueryInterface: XPCOMUtils.generateQI(calStorageCalendarInterfaces),</span>
<a href="#l13.16"></a><span id="l13.16">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l13.17"></a><span id="l13.17">         classID: calStorageCalendarClassID,</span>
<a href="#l13.18"></a><span id="l13.18">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=storage&quot;,</span>
<a href="#l13.19"></a><span id="l13.19">         classDescription: &quot;Calendar Storage Provider&quot;,</span>
<a href="#l13.20"></a><span id="l13.20">         interfaces: calStorageCalendarInterfaces</span>
<a href="#l13.21"></a><span id="l13.21">     }),</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -197,17 +197,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.23"></a><span id="l13.23">             // open the database</span>
<a href="#l13.24"></a><span id="l13.24">             this.mDB = Services.storage.openDatabase(fileURL.file);</span>
<a href="#l13.25"></a><span id="l13.25">             this.mDB.executeSimpleSQL(&quot;PRAGMA journal_mode=WAL&quot;);</span>
<a href="#l13.26"></a><span id="l13.26">             upgradeDB(this.mDB);</span>
<a href="#l13.27"></a><span id="l13.27">         } else if (this.uri.schemeIs(&quot;moz-profile-calendar&quot;)) {</span>
<a href="#l13.28"></a><span id="l13.28">             // This is an old-style moz-profile-calendar. It requires some</span>
<a href="#l13.29"></a><span id="l13.29">             // migration steps.</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-            let localDB = cal.getCalendarDirectory();</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+            let localDB = cal.provider.getCalendarDirectory();</span>
<a href="#l13.33"></a><span id="l13.33">             localDB.append(&quot;local.sqlite&quot;);</span>
<a href="#l13.34"></a><span id="l13.34">             localDB = Services.storage.openDatabase(localDB);</span>
<a href="#l13.35"></a><span id="l13.35">             localDB.defaultTransactionType = Components.interfaces.mozIStorageConnection.TRANSACTION_EXCLUSIVE;</span>
<a href="#l13.36"></a><span id="l13.36"> </span>
<a href="#l13.37"></a><span id="l13.37">             // First, we need to check if this is from 0.9, i.e we need to</span>
<a href="#l13.38"></a><span id="l13.38">             // migrate from storage.sdb to local.sqlite.</span>
<a href="#l13.39"></a><span id="l13.39">             let storageSdb = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l13.40"></a><span id="l13.40">             storageSdb.append(&quot;storage.sdb&quot;);</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineat">@@ -344,17 +344,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.42"></a><span id="l13.42">                 }</span>
<a href="#l13.43"></a><span id="l13.43">             } catch (exc) {</span>
<a href="#l13.44"></a><span id="l13.44">                 this.logError(&quot;prepareInitDB  moz-profile-calendar migration exception&quot;, exc);</span>
<a href="#l13.45"></a><span id="l13.45">                 this.mDB.rollbackTransaction();</span>
<a href="#l13.46"></a><span id="l13.46">                 throw exc;</span>
<a href="#l13.47"></a><span id="l13.47">             }</span>
<a href="#l13.48"></a><span id="l13.48">         } else if (this.uri.schemeIs(&quot;moz-storage-calendar&quot;)) {</span>
<a href="#l13.49"></a><span id="l13.49">             // New style uri, no need for migration here</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-            let localDB = cal.getCalendarDirectory();</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+            let localDB = cal.provider.getCalendarDirectory();</span>
<a href="#l13.52"></a><span id="l13.52">             localDB.append(&quot;local.sqlite&quot;);</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54">             this.mDB = Services.storage.openDatabase(localDB);</span>
<a href="#l13.55"></a><span id="l13.55">             upgradeDB(this.mDB);</span>
<a href="#l13.56"></a><span id="l13.56">         } else {</span>
<a href="#l13.57"></a><span id="l13.57">             throw new Components.Exception(&quot;Invalid Scheme &quot; + this.uri.spec);</span>
<a href="#l13.58"></a><span id="l13.58">         }</span>
<a href="#l13.59"></a><span id="l13.59"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -179,17 +179,17 @@ function getVersion(db) {</span>
<a href="#l14.4"></a><span id="l14.4"> /**</span>
<a href="#l14.5"></a><span id="l14.5">  * Backup the database and notify the user via error console of the process</span>
<a href="#l14.6"></a><span id="l14.6">  */</span>
<a href="#l14.7"></a><span id="l14.7"> function backupDB(db, currentVersion) {</span>
<a href="#l14.8"></a><span id="l14.8">     cal.LOG(&quot;Storage: Backing up current database...&quot;);</span>
<a href="#l14.9"></a><span id="l14.9">     try {</span>
<a href="#l14.10"></a><span id="l14.10">         // Prepare filenames and path</span>
<a href="#l14.11"></a><span id="l14.11">         let backupFilename = &quot;local.v&quot; + currentVersion + &quot;.sqlite&quot;;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-        let backupPath = cal.getCalendarDirectory();</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+        let backupPath = cal.provider.getCalendarDirectory();</span>
<a href="#l14.14"></a><span id="l14.14">         backupPath.append(&quot;backup&quot;);</span>
<a href="#l14.15"></a><span id="l14.15">         if (!backupPath.exists()) {</span>
<a href="#l14.16"></a><span id="l14.16">             backupPath.create(Components.interfaces.nsIFile.DIRECTORY_TYPE, parseInt(&quot;0755&quot;, 8));</span>
<a href="#l14.17"></a><span id="l14.17">         }</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19">         // Create a backup file and notify the user via WARN, since LOG will not</span>
<a href="#l14.20"></a><span id="l14.20">         // be visible unless a pref is set.</span>
<a href="#l14.21"></a><span id="l14.21">         let file = Services.storage.backupDatabaseFile(db.databaseFile, backupFilename, backupPath);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -22,17 +22,17 @@ var calWcapCalendarClassID = Components.</span>
<a href="#l15.4"></a><span id="l15.4"> var calWcapCalendarInterfaces = [</span>
<a href="#l15.5"></a><span id="l15.5">     calIWcapCalendar,</span>
<a href="#l15.6"></a><span id="l15.6">     calICalendar,</span>
<a href="#l15.7"></a><span id="l15.7">     Components.interfaces.calISchedulingSupport,</span>
<a href="#l15.8"></a><span id="l15.8">     Components.interfaces.calIChangeLog,</span>
<a href="#l15.9"></a><span id="l15.9">     Components.interfaces.calICalendarProvider,</span>
<a href="#l15.10"></a><span id="l15.10"> ];</span>
<a href="#l15.11"></a><span id="l15.11"> calWcapCalendar.prototype = {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    __proto__: cal.ProviderBase.prototype,</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+    __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l15.14"></a><span id="l15.14">     classID: calWcapCalendarClassID,</span>
<a href="#l15.15"></a><span id="l15.15">     QueryInterface: XPCOMUtils.generateQI(calWcapCalendarInterfaces),</span>
<a href="#l15.16"></a><span id="l15.16">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l15.17"></a><span id="l15.17">         classID: calWcapCalendarClassID,</span>
<a href="#l15.18"></a><span id="l15.18">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=wcap&quot;,</span>
<a href="#l15.19"></a><span id="l15.19">         classDescription: &quot;Sun Java System Calendar Server WCAP Provider&quot;,</span>
<a href="#l15.20"></a><span id="l15.20">         interfaces: calWcapCalendarInterfaces</span>
<a href="#l15.21"></a><span id="l15.21">     }),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -214,17 +214,17 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l16.4"></a><span id="l16.4">         classDescription: &quot;Sun Java System Calendar Server WCAP Network Request&quot;,</span>
<a href="#l16.5"></a><span id="l16.5">         interfaces: calWcapNetworkRequestInterfaces</span>
<a href="#l16.6"></a><span id="l16.6">     }),</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8">     /**</span>
<a href="#l16.9"></a><span id="l16.9">      * @see nsIInterfaceRequestor</span>
<a href="#l16.10"></a><span id="l16.10">      * @see calProviderUtils.jsm</span>
<a href="#l16.11"></a><span id="l16.11">      */</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    getInterface: cal.provider.InterfaceRequestor_getInterface,</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15">     /**</span>
<a href="#l16.16"></a><span id="l16.16">      * prepareChannel</span>
<a href="#l16.17"></a><span id="l16.17">      * Prepares the passed channel to match this objects properties</span>
<a href="#l16.18"></a><span id="l16.18">      *</span>
<a href="#l16.19"></a><span id="l16.19">      * @param aChannel    The Channel to be prepared</span>
<a href="#l16.20"></a><span id="l16.20">      */</span>
<a href="#l16.21"></a><span id="l16.21">     prepareChannel: function(aChannel) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -993,17 +993,17 @@ calWcapSession.prototype = {</span>
<a href="#l17.4"></a><span id="l17.4">                                 if (!fbType) {</span>
<a href="#l17.5"></a><span id="l17.5">                                     fbType = calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l17.6"></a><span id="l17.6">                                 }</span>
<a href="#l17.7"></a><span id="l17.7">                                 let str = node.textContent;</span>
<a href="#l17.8"></a><span id="l17.8">                                 let slash = str.indexOf(&quot;/&quot;);</span>
<a href="#l17.9"></a><span id="l17.9">                                 let start = getDatetimeFromIcalString(str.substr(0, slash));</span>
<a href="#l17.10"></a><span id="l17.10">                                 let end = getDatetimeFromIcalString(str.substr(slash + 1));</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-                                ret.push(new cal.FreeBusyInterval(calId, fbType, start, end));</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+                                ret.push(new cal.provider.FreeBusyInterval(calId, fbType, start, end));</span>
<a href="#l17.14"></a><span id="l17.14">                             }</span>
<a href="#l17.15"></a><span id="l17.15">                         }</span>
<a href="#l17.16"></a><span id="l17.16">                         request.execRespFunc(null, ret);</span>
<a href="#l17.17"></a><span id="l17.17">                     }</span>
<a href="#l17.18"></a><span id="l17.18">                 },</span>
<a href="#l17.19"></a><span id="l17.19">                 stringToXml_, &quot;get_freebusy&quot;, params);</span>
<a href="#l17.20"></a><span id="l17.20">         } catch (exc) {</span>
<a href="#l17.21"></a><span id="l17.21">             request.execRespFunc(exc);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/test/unit/test_freebusy_service.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/test/unit/test_freebusy_service.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -32,17 +32,17 @@ function test_found() {</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5">     let provider2 = {</span>
<a href="#l18.6"></a><span id="l18.6">         id: 2,</span>
<a href="#l18.7"></a><span id="l18.7">         called: false,</span>
<a href="#l18.8"></a><span id="l18.8">         getFreeBusyIntervals: function(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l18.9"></a><span id="l18.9">             ok(!this.called);</span>
<a href="#l18.10"></a><span id="l18.10">             this.called = true;</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-            let interval = new cal.FreeBusyInterval(aCalId, cIFI.BUSY, aStart, aEnd);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+            let interval = new cal.provider.FreeBusyInterval(aCalId, cIFI.BUSY, aStart, aEnd);</span>
<a href="#l18.14"></a><span id="l18.14">             aListener.onResult(null, [interval]);</span>
<a href="#l18.15"></a><span id="l18.15">         }</span>
<a href="#l18.16"></a><span id="l18.16">     };</span>
<a href="#l18.17"></a><span id="l18.17">     provider2.wrappedJSObject = provider2;</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">     freebusy.addProvider(provider1);</span>
<a href="#l18.20"></a><span id="l18.20">     equal(_countProviders(), 1);</span>
<a href="#l18.21"></a><span id="l18.21">     freebusy.addProvider(provider2);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -29,26 +29,26 @@ ChromeUtils.import(&quot;resource://testing-c</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5"> var gServer;</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> var MockConflictPrompt = {</span>
<a href="#l19.8"></a><span id="l19.8">     _origFunc: null,</span>
<a href="#l19.9"></a><span id="l19.9">     overwrite: false,</span>
<a href="#l19.10"></a><span id="l19.10">     register: function() {</span>
<a href="#l19.11"></a><span id="l19.11">         if (!this._origFunc) {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-            this._origFunc = cal.promptOverwrite;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-            cal.promptOverwrite = (aMode, aItem) =&gt; {</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+            this._origFunc = cal.provider.promptOverwrite;</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+            cal.provider.promptOverwrite = (aMode, aItem) =&gt; {</span>
<a href="#l19.16"></a><span id="l19.16">                 return this.overwrite;</span>
<a href="#l19.17"></a><span id="l19.17">             };</span>
<a href="#l19.18"></a><span id="l19.18">         }</span>
<a href="#l19.19"></a><span id="l19.19">     },</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21">     unregister: function() {</span>
<a href="#l19.22"></a><span id="l19.22">         if (this._origFunc) {</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-            cal.promptOverwrite = this._origFunc;</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+            cal.provider.promptOverwrite = this._origFunc;</span>
<a href="#l19.25"></a><span id="l19.25">             this._origFunc = null;</span>
<a href="#l19.26"></a><span id="l19.26">         }</span>
<a href="#l19.27"></a><span id="l19.27">     }</span>
<a href="#l19.28"></a><span id="l19.28"> };</span>
<a href="#l19.29"></a><span id="l19.29"> </span>
<a href="#l19.30"></a><span id="l19.30"> function MockAlertsService() {}</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32"> MockAlertsService.prototype = {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

