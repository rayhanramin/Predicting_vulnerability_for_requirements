<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 30082:4290f6c66a272607bad0f26a254bfb9919598072</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4290f6c66a272607bad0f26a254bfb9919598072" />
<meta property="og:url" content="/comm-central/rev/4290f6c66a272607bad0f26a254bfb9919598072" />
<meta property="og:description" content="Bug 1650925 - Fix console errors due to returning null from getInterface in calendar network code. r=darktrojan" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4290f6c66a272607bad0f26a254bfb9919598072 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4290f6c66a272607bad0f26a254bfb9919598072">shortlog</a> |
<a href="/comm-central/log/4290f6c66a272607bad0f26a254bfb9919598072">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4290f6c66a272607bad0f26a254bfb9919598072">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4290f6c66a272607bad0f26a254bfb9919598072">files</a> |
changeset |
<a href="/comm-central/raw-rev/4290f6c66a272607bad0f26a254bfb9919598072">raw</a>  | <a href="/comm-central/archive/4290f6c66a272607bad0f26a254bfb9919598072.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1650925">Bug 1650925</a> - Fix console errors due to returning null from getInterface in calendar network code. r=darktrojan
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#117;&#108;&#32;&#77;&#111;&#114;&#114;&#105;&#115;&#32;&#60;&#112;&#97;&#117;&#108;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 06 Jul 2020 22:37:21 -0400</td></tr>

<tr>
 <td>changeset 30082</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4290f6c66a272607bad0f26a254bfb9919598072">4290f6c66a272607bad0f26a254bfb9919598072</a></td>
</tr>



<tr>
<td>parent 30081</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bc6eaa57887344986e33d2538308150a0ae18bfe">bc6eaa57887344986e33d2538308150a0ae18bfe</a>
</td>
</tr>

<tr>
<td>child 30083</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/618acf4cd425fa31c6768d80069c7330c9c679bf">618acf4cd425fa31c6768d80069c7330c9c679bf</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4290f6c66a272607bad0f26a254bfb9919598072">17685</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Wed, 08 Jul 2020 22:23:43 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4290f6c66a27 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4290f6c66a272607bad0f26a254bfb9919598072">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4290f6c66a272607bad0f26a254bfb9919598072&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4290f6c66a272607bad0f26a254bfb9919598072&newProject=comm-central&newRevision=4290f6c66a272607bad0f26a254bfb9919598072&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4290f6c66a272607bad0f26a254bfb9919598072&newProject=comm-central&newRevision=4290f6c66a272607bad0f26a254bfb9919598072&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4290f6c66a272607bad0f26a254bfb9919598072&newProject=comm-central&newRevision=4290f6c66a272607bad0f26a254bfb9919598072&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28darktrojan%29&revcount=50">darktrojan</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1650925">1650925</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1650925">Bug 1650925</a> - Fix console errors due to returning null from getInterface in calendar network code. r=darktrojan

Thanks to Philipp Kewisch for the fix for this.
I'm just finishing this up.

We should be throwing instead of returning null when
getting an interface and the devtools code complains
with &quot;impl is null&quot; errors in the console.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4290f6c66a272607bad0f26a254bfb9919598072/calendar/base/modules/utils/calProviderUtils.jsm">calendar/base/modules/utils/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4290f6c66a272607bad0f26a254bfb9919598072/calendar/base/modules/utils/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/4290f6c66a272607bad0f26a254bfb9919598072/calendar/base/modules/utils/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4290f6c66a272607bad0f26a254bfb9919598072/calendar/base/modules/utils/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4290f6c66a272607bad0f26a254bfb9919598072/calendar/base/modules/utils/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/4290f6c66a272607bad0f26a254bfb9919598072/calendar/base/modules/utils/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4290f6c66a272607bad0f26a254bfb9919598072/calendar/providers/caldav/modules/CalDavRequest.jsm">calendar/providers/caldav/modules/CalDavRequest.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4290f6c66a272607bad0f26a254bfb9919598072/calendar/providers/caldav/modules/CalDavRequest.jsm">file</a> |
<a href="/comm-central/annotate/4290f6c66a272607bad0f26a254bfb9919598072/calendar/providers/caldav/modules/CalDavRequest.jsm">annotate</a> |
<a href="/comm-central/diff/4290f6c66a272607bad0f26a254bfb9919598072/calendar/providers/caldav/modules/CalDavRequest.jsm">diff</a> |
<a href="/comm-central/comparison/4290f6c66a272607bad0f26a254bfb9919598072/calendar/providers/caldav/modules/CalDavRequest.jsm">comparison</a> |
<a href="/comm-central/log/4290f6c66a272607bad0f26a254bfb9919598072/calendar/providers/caldav/modules/CalDavRequest.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/utils/calProviderUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/utils/calProviderUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -41,17 +41,27 @@ var calprovider = {</span>
<a href="#l1.4"></a><span id="l1.4">     // authenticated users. This can be solved by providing the additional</span>
<a href="#l1.5"></a><span id="l1.5">     // userContextId, which also separates connections (a.k.a. containers).</span>
<a href="#l1.6"></a><span id="l1.6">     // Connections for userA @ server1 and userA @ server2 can exist in the</span>
<a href="#l1.7"></a><span id="l1.7">     // same container, as nsIHttpChannel will separate them. Connections</span>
<a href="#l1.8"></a><span id="l1.8">     // for userA @ server1 and userB @ server1 however must be placed into</span>
<a href="#l1.9"></a><span id="l1.9">     // different containers. It is therefore sufficient to add individual</span>
<a href="#l1.10"></a><span id="l1.10">     // userContextIds per username.</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    let calendar = aNotificationCallbacks.getInterface(Ci.calICalendar);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    let calendar;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    try {</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+      // Use a try/catch because there may not be a calICalendar interface.</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+      // For example, when there is no calendar associated with a request,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+      // as in calendar detection.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+      calendar = aNotificationCallbacks.getInterface(Ci.calICalendar);</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    } catch (e) {</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+      if (e.result != Cr.NS_ERROR_NO_INTERFACE) {</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+        throw e;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+      }</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+    }</span>
<a href="#l1.24"></a><span id="l1.24">     if (calendar &amp;&amp; calendar.getProperty(&quot;capabilities.username.supported&quot;) === true) {</span>
<a href="#l1.25"></a><span id="l1.25">       originAttributes.userContextId = cal.auth.containerMap.getUserContextIdForUsername(</span>
<a href="#l1.26"></a><span id="l1.26">         calendar.getProperty(&quot;username&quot;)</span>
<a href="#l1.27"></a><span id="l1.27">       );</span>
<a href="#l1.28"></a><span id="l1.28">     }</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30">     // We cannot use a system principal here since the connection setup will fail if</span>
<a href="#l1.31"></a><span id="l1.31">     // same-site cookie protection is enabled in TB and server-side.</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineat">@@ -134,32 +144,29 @@ var calprovider = {</span>
<a href="#l1.33"></a><span id="l1.33">    * will be appended to the realm. If you need that feature disabled, see the</span>
<a href="#l1.34"></a><span id="l1.34">    * capabilities section of calICalendar.idl</span>
<a href="#l1.35"></a><span id="l1.35">    *</span>
<a href="#l1.36"></a><span id="l1.36">    * @param {nsIIDRef} aIID       The interface ID to return</span>
<a href="#l1.37"></a><span id="l1.37">    * @return {nsISupports}        The requested interface</span>
<a href="#l1.38"></a><span id="l1.38">    */</span>
<a href="#l1.39"></a><span id="l1.39">   InterfaceRequestor_getInterface(aIID) {</span>
<a href="#l1.40"></a><span id="l1.40">     try {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-      // Try to query the this object for the requested interface but don't</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-      // throw if it fails since that borks the network code.</span>
<a href="#l1.43"></a><span id="l1.43">       return this.QueryInterface(aIID);</span>
<a href="#l1.44"></a><span id="l1.44">     } catch (e) {</span>
<a href="#l1.45"></a><span id="l1.45">       // Support Auth Prompt Interfaces</span>
<a href="#l1.46"></a><span id="l1.46">       if (aIID.equals(Ci.nsIAuthPrompt2)) {</span>
<a href="#l1.47"></a><span id="l1.47">         if (!this.calAuthPrompt) {</span>
<a href="#l1.48"></a><span id="l1.48">           this.calAuthPrompt = new cal.auth.Prompt();</span>
<a href="#l1.49"></a><span id="l1.49">         }</span>
<a href="#l1.50"></a><span id="l1.50">         return this.calAuthPrompt;</span>
<a href="#l1.51"></a><span id="l1.51">       } else if (aIID.equals(Ci.nsIAuthPromptProvider) || aIID.equals(Ci.nsIPrompt)) {</span>
<a href="#l1.52"></a><span id="l1.52">         return Services.ww.getNewPrompter(null);</span>
<a href="#l1.53"></a><span id="l1.53">       }</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-      Components.returnCode = e;</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+      throw e;</span>
<a href="#l1.56"></a><span id="l1.56">     }</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-    return null;</span>
<a href="#l1.58"></a><span id="l1.58">   },</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60">   // TODO: Add new error handling that uses this code. See bug 1547096.</span>
<a href="#l1.61"></a><span id="l1.61">   /**</span>
<a href="#l1.62"></a><span id="l1.62">    * Bad Certificate Handler for Network Requests. Shows the Network Exception</span>
<a href="#l1.63"></a><span id="l1.63">    * Dialog if a certificate Problem occurs.</span>
<a href="#l1.64"></a><span id="l1.64">    */</span>
<a href="#l1.65"></a><span id="l1.65">   BadCertHandler: class {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/providers/caldav/modules/CalDavRequest.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/providers/caldav/modules/CalDavRequest.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -165,17 +165,21 @@ class CalDavRequestBase {</span>
<a href="#l2.4"></a><span id="l2.4">     // Special case our nsIChannelEventSink, can't use tryGetInterface due to recursion errors</span>
<a href="#l2.5"></a><span id="l2.5">     if (aIID.equals(Ci.nsIChannelEventSink)) {</span>
<a href="#l2.6"></a><span id="l2.6">       return this.QueryInterface(Ci.nsIChannelEventSink);</span>
<a href="#l2.7"></a><span id="l2.7">     }</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">     // First check if the session has what we need. It may have an auth prompt implementation</span>
<a href="#l2.10"></a><span id="l2.10">     // that should go first. Ideally we should move the auth prompt to the session anyway, but</span>
<a href="#l2.11"></a><span id="l2.11">     // this is a task for another day (tm).</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    return tryGetInterface(this.session) || tryGetInterface(this.calendar);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    let iface = tryGetInterface(this.session) || tryGetInterface(this.calendar);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    if (iface) {</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+      return iface;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    }</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+    throw Components.Exception(&quot;&quot;, Cr.NS_ERROR_NO_INTERFACE);</span>
<a href="#l2.18"></a><span id="l2.18">   }</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   /** Implement nsIChannelEventSink */</span>
<a href="#l2.21"></a><span id="l2.21">   asyncOnChannelRedirect(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l2.22"></a><span id="l2.22">     /**</span>
<a href="#l2.23"></a><span id="l2.23">      * Copy the given header from the old channel to the new one, ignoring missing headers</span>
<a href="#l2.24"></a><span id="l2.24">      *</span>
<a href="#l2.25"></a><span id="l2.25">      * @param {String} aHdr         The header to copy</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

