<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20797:acd6a5e56d6666c64ca34a883354fb14a2bf6038</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ acd6a5e56d6666c64ca34a883354fb14a2bf6038" />
<meta property="og:url" content="/comm-central/rev/acd6a5e56d6666c64ca34a883354fb14a2bf6038" />
<meta property="og:description" content="Bug 1319409 - Rename GetSelectedDirectory() function to getSelectedDirURI(), and various related code cleanup/refactoring. r=jorgk,aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / acd6a5e56d6666c64ca34a883354fb14a2bf6038 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/acd6a5e56d6666c64ca34a883354fb14a2bf6038">shortlog</a> |
<a href="/comm-central/log/acd6a5e56d6666c64ca34a883354fb14a2bf6038">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/acd6a5e56d6666c64ca34a883354fb14a2bf6038">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/acd6a5e56d6666c64ca34a883354fb14a2bf6038">files</a> |
changeset |
<a href="/comm-central/raw-rev/acd6a5e56d6666c64ca34a883354fb14a2bf6038">raw</a>  | <a href="/comm-central/archive/acd6a5e56d6666c64ca34a883354fb14a2bf6038.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1319409">Bug 1319409</a> - Rename GetSelectedDirectory() function to getSelectedDirURI(), and various related code cleanup/refactoring. r=jorgk,aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#84;&#104;&#111;&#109;&#97;&#115;&#32;&#68;&#252;&#108;&#108;&#109;&#97;&#110;&#110;&#32;&#60;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#50;&#48;&#48;&#55;&#64;&#100;&#117;&#101;&#108;&#108;&#109;&#97;&#110;&#110;&#50;&#52;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 23 Nov 2016 22:30:39 +0200</td></tr>

<tr>
 <td>changeset 20797</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/acd6a5e56d6666c64ca34a883354fb14a2bf6038">acd6a5e56d6666c64ca34a883354fb14a2bf6038</a></td>
</tr>



<tr>
<td>parent 20796</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4a05ca73f3dcc9371364e2ad0e3f7c5065ef4f24">4a05ca73f3dcc9371364e2ad0e3f7c5065ef4f24</a>
</td>
</tr>

<tr>
<td>child 20798</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4dd65a2f806bb2daca6ef9d2620f534c1b064994">4dd65a2f806bb2daca6ef9d2620f534c1b064994</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=acd6a5e56d6666c64ca34a883354fb14a2bf6038">12602</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 02 Dec 2016 15:03:42 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4dd65a2f806b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4dd65a2f806bb2daca6ef9d2620f534c1b064994">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4dd65a2f806bb2daca6ef9d2620f534c1b064994&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4dd65a2f806bb2daca6ef9d2620f534c1b064994&newProject=comm-central&newRevision=acd6a5e56d6666c64ca34a883354fb14a2bf6038&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4dd65a2f806bb2daca6ef9d2620f534c1b064994&newProject=comm-central&newRevision=acd6a5e56d6666c64ca34a883354fb14a2bf6038&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4dd65a2f806bb2daca6ef9d2620f534c1b064994&newProject=comm-central&newRevision=acd6a5e56d6666c64ca34a883354fb14a2bf6038&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a>, <a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1319409">1319409</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1319409">Bug 1319409</a> - Rename GetSelectedDirectory() function to getSelectedDirURI(), and various related code cleanup/refactoring. r=jorgk,aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/abCommon.js">mail/components/addrbook/content/abCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/abCommon.js">file</a> |
<a href="/comm-central/annotate/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/abCommon.js">annotate</a> |
<a href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/abCommon.js">diff</a> |
<a href="/comm-central/comparison/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/abCommon.js">comparison</a> |
<a href="/comm-central/log/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/abCommon.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/abContactsPanel.js">mail/components/addrbook/content/abContactsPanel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/abContactsPanel.js">file</a> |
<a href="/comm-central/annotate/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/abContactsPanel.js">annotate</a> |
<a href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/abContactsPanel.js">diff</a> |
<a href="/comm-central/comparison/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/abContactsPanel.js">comparison</a> |
<a href="/comm-central/log/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/abContactsPanel.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/addressbook.js">mail/components/addrbook/content/addressbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/addressbook.js">file</a> |
<a href="/comm-central/annotate/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/addressbook.js">annotate</a> |
<a href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/addressbook.js">diff</a> |
<a href="/comm-central/comparison/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/addressbook.js">comparison</a> |
<a href="/comm-central/log/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mail/components/addrbook/content/addressbook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mailnews/addrbook/content/abDragDrop.js">mailnews/addrbook/content/abDragDrop.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mailnews/addrbook/content/abDragDrop.js">file</a> |
<a href="/comm-central/annotate/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mailnews/addrbook/content/abDragDrop.js">annotate</a> |
<a href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mailnews/addrbook/content/abDragDrop.js">diff</a> |
<a href="/comm-central/comparison/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mailnews/addrbook/content/abDragDrop.js">comparison</a> |
<a href="/comm-central/log/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mailnews/addrbook/content/abDragDrop.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mailnews/addrbook/content/abResultsPane.js">mailnews/addrbook/content/abResultsPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mailnews/addrbook/content/abResultsPane.js">file</a> |
<a href="/comm-central/annotate/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mailnews/addrbook/content/abResultsPane.js">annotate</a> |
<a href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mailnews/addrbook/content/abResultsPane.js">diff</a> |
<a href="/comm-central/comparison/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mailnews/addrbook/content/abResultsPane.js">comparison</a> |
<a href="/comm-central/log/acd6a5e56d6666c64ca34a883354fb14a2bf6038/mailnews/addrbook/content/abResultsPane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/suite/mailnews/addrbook/abCommon.js">suite/mailnews/addrbook/abCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/acd6a5e56d6666c64ca34a883354fb14a2bf6038/suite/mailnews/addrbook/abCommon.js">file</a> |
<a href="/comm-central/annotate/acd6a5e56d6666c64ca34a883354fb14a2bf6038/suite/mailnews/addrbook/abCommon.js">annotate</a> |
<a href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/suite/mailnews/addrbook/abCommon.js">diff</a> |
<a href="/comm-central/comparison/acd6a5e56d6666c64ca34a883354fb14a2bf6038/suite/mailnews/addrbook/abCommon.js">comparison</a> |
<a href="/comm-central/log/acd6a5e56d6666c64ca34a883354fb14a2bf6038/suite/mailnews/addrbook/abCommon.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/suite/mailnews/addrbook/addressbook.js">suite/mailnews/addrbook/addressbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/acd6a5e56d6666c64ca34a883354fb14a2bf6038/suite/mailnews/addrbook/addressbook.js">file</a> |
<a href="/comm-central/annotate/acd6a5e56d6666c64ca34a883354fb14a2bf6038/suite/mailnews/addrbook/addressbook.js">annotate</a> |
<a href="/comm-central/diff/acd6a5e56d6666c64ca34a883354fb14a2bf6038/suite/mailnews/addrbook/addressbook.js">diff</a> |
<a href="/comm-central/comparison/acd6a5e56d6666c64ca34a883354fb14a2bf6038/suite/mailnews/addrbook/addressbook.js">comparison</a> |
<a href="/comm-central/log/acd6a5e56d6666c64ca34a883354fb14a2bf6038/suite/mailnews/addrbook/addressbook.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/addrbook/content/abCommon.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/addrbook/content/abCommon.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -4,22 +4,22 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.5"></a><span id="l1.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.8"></a><span id="l1.8"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> Components.utils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> var gDirTree;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-var abList = 0;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+var abList = null;</span>
<a href="#l1.14"></a><span id="l1.14"> var gAbResultsTree = null;</span>
<a href="#l1.15"></a><span id="l1.15"> var gAbView = null;</span>
<a href="#l1.16"></a><span id="l1.16"> var gAddressBookBundle;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-// A boolean variable determining whether AB column should be shown in AB</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-// sidebar in compose window.</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+// A boolean variable determining whether AB column should be shown</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+// in Contacts Sidebar in compose window.</span>
<a href="#l1.21"></a><span id="l1.21"> var gShowAbColumnInComposeSidebar = false;</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> var kDefaultSortColumn = &quot;GeneratedName&quot;;</span>
<a href="#l1.24"></a><span id="l1.24"> var kDefaultAscending = &quot;ascending&quot;;</span>
<a href="#l1.25"></a><span id="l1.25"> var kDefaultDescending = &quot;descending&quot;;</span>
<a href="#l1.26"></a><span id="l1.26"> // kDefaultYear will be used in birthday calculations when no year is given;</span>
<a href="#l1.27"></a><span id="l1.27"> // this is a leap year so that Feb 29th works.</span>
<a href="#l1.28"></a><span id="l1.28"> const kDefaultYear = nearestLeap(new Date().getFullYear());</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineat">@@ -52,88 +52,95 @@ var DirPaneController =</span>
<a href="#l1.30"></a><span id="l1.30">         return true;</span>
<a href="#l1.31"></a><span id="l1.31">       default:</span>
<a href="#l1.32"></a><span id="l1.32">         return false;</span>
<a href="#l1.33"></a><span id="l1.33">     }</span>
<a href="#l1.34"></a><span id="l1.34">   },</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36">   isCommandEnabled: function(command)</span>
<a href="#l1.37"></a><span id="l1.37">   {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-    var selectedDir;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-</span>
<a href="#l1.40"></a><span id="l1.40">     switch (command) {</span>
<a href="#l1.41"></a><span id="l1.41">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-        // the gDirTree pane</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-        // only handles single selection</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-        // so we forward select all to the results pane</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-        // but if there is no gAbView</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-        // don't bother sending to the results pane</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+        // The gDirTree pane only handles single selection, but normally we</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+        // enable cmd_selectAll as it will get forwarded to the results pane.</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+        // But if there is no gAbView, disable as we can't forward to anywhere.</span>
<a href="#l1.50"></a><span id="l1.50">         return (gAbView != null);</span>
<a href="#l1.51"></a><span id="l1.51">       case &quot;cmd_delete&quot;:</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-      case &quot;button_delete&quot;:</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-        var selectedDir = GetSelectedDirectory();</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-        if (command == &quot;cmd_delete&quot; &amp;&amp; selectedDir)</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-          goSetMenuValue(command, GetDirectoryFromURI(selectedDir).isMailList ?</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-                                  &quot;valueList&quot; : &quot;valueAddressBook&quot;);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+      case &quot;button_delete&quot;: {</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+        let selectedDir = getSelectedDirectory();</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+        let selectedDirURI = selectedDir.URI;</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-        if (selectedDir &amp;&amp;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-            (selectedDir != kPersonalAddressbookURI) &amp;&amp;</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-            (selectedDir != kCollectedAddressbookURI) &amp;&amp;</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-            (selectedDir != (kAllDirectoryRoot + &quot;?&quot;))) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-          // If the directory is a mailing list, and it is read-only, return</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-          // false.</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-          var abDir = GetDirectoryFromURI(selectedDir);</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-          if (abDir.isMailList &amp;&amp; abDir.readOnly)</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-            return false;</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+        // Context-sensitive labels for Edit &gt; Delete menuitem.</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+        // We only have ABs or Mailing Lists in the directory pane.</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+        // For contacts and mixed selections, the label is set in</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+        // ResultsPaneController in abResultsPane.js.</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+        if (command == &quot;cmd_delete&quot; &amp;&amp; selectedDir) {</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+          goSetMenuValue(command, selectedDir.isMailList ?</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+                                  &quot;valueList&quot; : &quot;valueAddressBook&quot;);</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+        }</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+        // If there's no directory selected, or if it's one of these special ABs,</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+        // return false to disable deletion.</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+        if (!selectedDir ||</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+             (selectedDirURI == kPersonalAddressbookURI) ||</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+             (selectedDirURI == kCollectedAddressbookURI) ||</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+             (selectedDirURI == (kAllDirectoryRoot + &quot;?&quot;)))</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+          return false;</span>
<a href="#l1.86"></a><span id="l1.86"> </span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-          // If the selected directory is an ldap directory</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-          // and if the prefs for this directory are locked</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-          // disable the delete button.</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-          if (selectedDir.startsWith(kLdapUrlPrefix))</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-          {</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-            var disable = false;</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-            try {</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-              var prefName = selectedDir.substr(kLdapUrlPrefix.length);</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-              disable = Services.prefs.getBoolPref(prefName + &quot;.disable_delete&quot;);</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-            }</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-            catch(ex) {</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-              // if this preference is not set its ok.</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-            }</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-            if (disable)</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-              return false;</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+        // If the directory is a mailing list, and it is read-only,</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+        // return false to disable deletion.</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+        if (selectedDir.isMailList &amp;&amp; selectedDir.readOnly)</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+          return false;</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+        // If the selected directory is an ldap directory,</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+        // and if the prefs for this directory are locked,</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+        // return false to disable deletion.</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+        if (selectedDirURI.startsWith(kLdapUrlPrefix))</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+        {</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+          let disable = false;</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+          try {</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+            let prefName = selectedDirURI.substr(kLdapUrlPrefix.length);</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+            disable = Services.prefs.getBoolPref(prefName + &quot;.disable_delete&quot;);</span>
<a href="#l1.116"></a><span id="l1.116">           }</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-          return true;</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+          catch(ex) {</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+            // If this preference is not set, that's ok.</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+          }</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+          if (disable)</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+            return false;</span>
<a href="#l1.123"></a><span id="l1.123">         }</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-        else</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-          return false;</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+        // Else return true to enable deletion (default).</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+        return true;</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+      }</span>
<a href="#l1.130"></a><span id="l1.130">       case &quot;cmd_printcard&quot;:</span>
<a href="#l1.131"></a><span id="l1.131">       case &quot;cmd_printcardpreview&quot;:</span>
<a href="#l1.132"></a><span id="l1.132">         return (GetSelectedCardIndex() != -1);</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-      case &quot;cmd_properties&quot;:</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+      case &quot;cmd_properties&quot;: {</span>
<a href="#l1.135"></a><span id="l1.135">         let labelAttr = &quot;valueGeneric&quot;;</span>
<a href="#l1.136"></a><span id="l1.136">         let accKeyAttr = &quot;valueGenericAccessKey&quot;;</span>
<a href="#l1.137"></a><span id="l1.137">         let tooltipTextAttr = &quot;valueGenericTooltipText&quot;;</span>
<a href="#l1.138"></a><span id="l1.138">         let isMailList;</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-        var selectedDir = GetSelectedDirectory();</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+        let selectedDir = getSelectedDirectory();</span>
<a href="#l1.141"></a><span id="l1.141">         if (selectedDir) {</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-          isMailList = GetDirectoryFromURI(selectedDir).isMailList;</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+          isMailList = selectedDir.isMailList;</span>
<a href="#l1.144"></a><span id="l1.144">           labelAttr = isMailList ? &quot;valueMailingList&quot;</span>
<a href="#l1.145"></a><span id="l1.145">                                  : &quot;valueAddressBook&quot;;</span>
<a href="#l1.146"></a><span id="l1.146">           accKeyAttr = isMailList ? &quot;valueMailingListAccessKey&quot;</span>
<a href="#l1.147"></a><span id="l1.147">                                   : &quot;valueAddressBookAccessKey&quot;;</span>
<a href="#l1.148"></a><span id="l1.148">           tooltipTextAttr = isMailList ? &quot;valueMailingListTooltipText&quot;</span>
<a href="#l1.149"></a><span id="l1.149">                                        : &quot;valueAddressBookTooltipText&quot;;</span>
<a href="#l1.150"></a><span id="l1.150">         }</span>
<a href="#l1.151"></a><span id="l1.151">         goSetLabelAccesskeyTooltiptext(&quot;cmd_properties-button&quot;, null, null,</span>
<a href="#l1.152"></a><span id="l1.152">           tooltipTextAttr);</span>
<a href="#l1.153"></a><span id="l1.153">         goSetLabelAccesskeyTooltiptext(&quot;cmd_properties-contextMenu&quot;,</span>
<a href="#l1.154"></a><span id="l1.154">           labelAttr, accKeyAttr);</span>
<a href="#l1.155"></a><span id="l1.155">         goSetLabelAccesskeyTooltiptext(&quot;cmd_properties-menu&quot;,</span>
<a href="#l1.156"></a><span id="l1.156">           labelAttr, accKeyAttr);</span>
<a href="#l1.157"></a><span id="l1.157">         return (selectedDir != null);</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+      }</span>
<a href="#l1.159"></a><span id="l1.159">       case &quot;cmd_newlist&quot;:</span>
<a href="#l1.160"></a><span id="l1.160">       case &quot;cmd_newCard&quot;:</span>
<a href="#l1.161"></a><span id="l1.161">         return true;</span>
<a href="#l1.162"></a><span id="l1.162">       default:</span>
<a href="#l1.163"></a><span id="l1.163">         return false;</span>
<a href="#l1.164"></a><span id="l1.164">     }</span>
<a href="#l1.165"></a><span id="l1.165">   },</span>
<a href="#l1.166"></a><span id="l1.166"> </span>
<a href="#l1.167"></a><span id="l1.167" class="difflineat">@@ -192,55 +199,52 @@ function AbNewAddressBook()</span>
<a href="#l1.168"></a><span id="l1.168">   window.openDialog(&quot;chrome://messenger/content/addressbook/abAddressBookNameDialog.xul&quot;,</span>
<a href="#l1.169"></a><span id="l1.169">                     &quot;&quot;,</span>
<a href="#l1.170"></a><span id="l1.170">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l1.171"></a><span id="l1.171">                     null);</span>
<a href="#l1.172"></a><span id="l1.172"> }</span>
<a href="#l1.173"></a><span id="l1.173"> </span>
<a href="#l1.174"></a><span id="l1.174"> function AbEditSelectedDirectory()</span>
<a href="#l1.175"></a><span id="l1.175"> {</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-  if (gDirTree.view.selection.count == 1) {</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-    var selecteduri = GetSelectedDirectory();</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-    var directory = GetDirectoryFromURI(selecteduri);</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-    if (directory.isMailList) {</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-      var dirUri = GetParentDirectoryFromMailingListURI(selecteduri);</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-      goEditListDialog(null, selecteduri);</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-    }</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-    else {</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-      window.openDialog(directory.propertiesChromeURI,</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-                        &quot;&quot;,</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-                        &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-                        {selectedDirectory: directory});</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-    }</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+  let selectedDir = getSelectedDirectory();</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+  if (!selectedDir)</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+    return;</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+  if (selectedDir.isMailList) {</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+    goEditListDialog(null, selectedDir.URI);</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+  } else {</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+    window.openDialog(selectedDir.propertiesChromeURI,</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+                      &quot;&quot;,</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+                      &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+                      {selectedDirectory: selectedDir});</span>
<a href="#l1.200"></a><span id="l1.200">   }</span>
<a href="#l1.201"></a><span id="l1.201"> }</span>
<a href="#l1.202"></a><span id="l1.202"> </span>
<a href="#l1.203"></a><span id="l1.203"> function AbDeleteSelectedDirectory()</span>
<a href="#l1.204"></a><span id="l1.204"> {</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-  var selectedABURI = GetSelectedDirectory();</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-  if (!selectedABURI)</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+  let selectedDirURI = getSelectedDirectoryURI();</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+  if (!selectedDirURI)</span>
<a href="#l1.209"></a><span id="l1.209">     return;</span>
<a href="#l1.210"></a><span id="l1.210"> </span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-  AbDeleteDirectory(selectedABURI);</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+  AbDeleteDirectory(selectedDirURI);</span>
<a href="#l1.213"></a><span id="l1.213"> }</span>
<a href="#l1.214"></a><span id="l1.214"> </span>
<a href="#l1.215"></a><span id="l1.215"> function AbDeleteDirectory(aURI)</span>
<a href="#l1.216"></a><span id="l1.216"> {</span>
<a href="#l1.217"></a><span id="l1.217">   var directory = GetDirectoryFromURI(aURI);</span>
<a href="#l1.218"></a><span id="l1.218">   var confirmDeleteMessage;</span>
<a href="#l1.219"></a><span id="l1.219">   var clearPrefsRequired = false;</span>
<a href="#l1.220"></a><span id="l1.220"> </span>
<a href="#l1.221"></a><span id="l1.221">   if (directory.isMailList)</span>
<a href="#l1.222"></a><span id="l1.222">     confirmDeleteMessage = gAddressBookBundle.getString(&quot;confirmDeleteMailingList&quot;);</span>
<a href="#l1.223"></a><span id="l1.223">   else {</span>
<a href="#l1.224"></a><span id="l1.224">     // Check if this address book is being used for collection</span>
<a href="#l1.225"></a><span id="l1.225">     if (Services.prefs.getCharPref(&quot;mail.collect_addressbook&quot;) == aURI &amp;&amp;</span>
<a href="#l1.226"></a><span id="l1.226">         Services.prefs.getBoolPref(&quot;mail.collect_email_address_outgoing&quot;)) {</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-      var brandShortName = document.getElementById(&quot;bundle_brand&quot;).getString(&quot;brandShortName&quot;);</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+      let brandShortName = document.getElementById(&quot;bundle_brand&quot;).getString(&quot;brandShortName&quot;);</span>
<a href="#l1.230"></a><span id="l1.230">       confirmDeleteMessage = gAddressBookBundle.getFormattedString(&quot;confirmDeleteCollectionAddressbook&quot;, [brandShortName]);</span>
<a href="#l1.231"></a><span id="l1.231">       clearPrefsRequired = true;</span>
<a href="#l1.232"></a><span id="l1.232">     }</span>
<a href="#l1.233"></a><span id="l1.233">     else {</span>
<a href="#l1.234"></a><span id="l1.234">       confirmDeleteMessage = gAddressBookBundle.getString(&quot;confirmDeleteAddressbook&quot;);</span>
<a href="#l1.235"></a><span id="l1.235">     }</span>
<a href="#l1.236"></a><span id="l1.236">   }</span>
<a href="#l1.237"></a><span id="l1.237"> </span>
<a href="#l1.238"></a><span id="l1.238" class="difflineat">@@ -310,17 +314,17 @@ function AbDelete()</span>
<a href="#l1.239"></a><span id="l1.239">     if (gAbView.selection.count &lt; 2)</span>
<a href="#l1.240"></a><span id="l1.240">       confirmDeleteMessage = gAddressBookBundle.getString(&quot;confirmDeleteContact&quot;);</span>
<a href="#l1.241"></a><span id="l1.241">     else</span>
<a href="#l1.242"></a><span id="l1.242">       confirmDeleteMessage = gAddressBookBundle.getString(&quot;confirmDeleteContacts&quot;);</span>
<a href="#l1.243"></a><span id="l1.243">   }</span>
<a href="#l1.244"></a><span id="l1.244"> </span>
<a href="#l1.245"></a><span id="l1.245">   if (confirmDeleteMessage &amp;&amp;</span>
<a href="#l1.246"></a><span id="l1.246">       Services.prompt.confirm(window, null, confirmDeleteMessage)) {</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-    if (GetSelectedDirectory() != (kAllDirectoryRoot + &quot;?&quot;)) {</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+    if (getSelectedDirectoryURI() != (kAllDirectoryRoot + &quot;?&quot;)) {</span>
<a href="#l1.249"></a><span id="l1.249">       gAbView.deleteSelectedCards();</span>
<a href="#l1.250"></a><span id="l1.250">     } else {</span>
<a href="#l1.251"></a><span id="l1.251">       let cards = GetSelectedAbCards();</span>
<a href="#l1.252"></a><span id="l1.252">       for (let i = 0; i &lt; cards.length; i++) {</span>
<a href="#l1.253"></a><span id="l1.253">         let dirId = cards[i].directoryId</span>
<a href="#l1.254"></a><span id="l1.254">                             .substring(0, cards[i].directoryId.indexOf(&quot;&amp;&quot;));</span>
<a href="#l1.255"></a><span id="l1.255">         let directory = MailServices.ab.getDirectoryFromId(dirId);</span>
<a href="#l1.256"></a><span id="l1.256"> </span>
<a href="#l1.257"></a><span id="l1.257" class="difflineat">@@ -334,73 +338,68 @@ function AbDelete()</span>
<a href="#l1.258"></a><span id="l1.258"> </span>
<a href="#l1.259"></a><span id="l1.259">       SetAbView(kAllDirectoryRoot + &quot;?&quot;);</span>
<a href="#l1.260"></a><span id="l1.260">     }</span>
<a href="#l1.261"></a><span id="l1.261">   }</span>
<a href="#l1.262"></a><span id="l1.262"> }</span>
<a href="#l1.263"></a><span id="l1.263"> </span>
<a href="#l1.264"></a><span id="l1.264"> function AbNewCard()</span>
<a href="#l1.265"></a><span id="l1.265"> {</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-  goNewCardDialog(GetSelectedDirectory());</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+  goNewCardDialog(getSelectedDirectoryURI());</span>
<a href="#l1.268"></a><span id="l1.268"> }</span>
<a href="#l1.269"></a><span id="l1.269"> </span>
<a href="#l1.270"></a><span id="l1.270"> function AbEditCard(card)</span>
<a href="#l1.271"></a><span id="l1.271"> {</span>
<a href="#l1.272"></a><span id="l1.272">   // Need a card,</span>
<a href="#l1.273"></a><span id="l1.273">   // but not allowing AOL special groups to be edited.</span>
<a href="#l1.274"></a><span id="l1.274">   if (!card)</span>
<a href="#l1.275"></a><span id="l1.275">     return;</span>
<a href="#l1.276"></a><span id="l1.276"> </span>
<a href="#l1.277"></a><span id="l1.277">   if (card.isMailList) {</span>
<a href="#l1.278"></a><span id="l1.278">     goEditListDialog(card, card.mailListURI);</span>
<a href="#l1.279"></a><span id="l1.279">   }</span>
<a href="#l1.280"></a><span id="l1.280">   else {</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-    goEditCardDialog(GetSelectedDirectory(), card);</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+    goEditCardDialog(getSelectedDirectoryURI(), card);</span>
<a href="#l1.283"></a><span id="l1.283">   }</span>
<a href="#l1.284"></a><span id="l1.284"> }</span>
<a href="#l1.285"></a><span id="l1.285"> </span>
<a href="#l1.286"></a><span id="l1.286"> function AbNewMessage()</span>
<a href="#l1.287"></a><span id="l1.287"> {</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-  var msgComposeType = Components.interfaces.nsIMsgCompType;</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-  var msgComposFormat = Components.interfaces.nsIMsgCompFormat;</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineplus">+  let msgComposeType = Components.interfaces.nsIMsgCompType;</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+  let msgComposeFormat = Components.interfaces.nsIMsgCompFormat;</span>
<a href="#l1.292"></a><span id="l1.292"> </span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-  var params = Components.classes[&quot;@mozilla.org/messengercompose/composeparams;1&quot;].createInstance(Components.interfaces.nsIMsgComposeParams);</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-  if (params)</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-  {</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+  let params = Components.classes[&quot;@mozilla.org/messengercompose/composeparams;1&quot;].createInstance(Components.interfaces.nsIMsgComposeParams);</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+  if (params) {</span>
<a href="#l1.298"></a><span id="l1.298">     params.type = msgComposeType.New;</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineminus">-    params.format = msgComposFormat.Default;</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineminus">-    var composeFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineminus">-    if (composeFields)</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-    {</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-      if (DirPaneHasFocus())</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-      {</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-        var directory = gDirectoryTreeView.getDirectoryAtIndex(gDirTree.currentIndex);</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-        var hidesRecipients = false;</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+    params.format = msgComposeFormat.Default;</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+    let composeFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+    if (composeFields) {</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineplus">+      if (DirPaneHasFocus()) {</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineplus">+        let selectedDir = getSelectedDirectory();</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+        let hidesRecipients = false;</span>
<a href="#l1.314"></a><span id="l1.314">         try {</span>
<a href="#l1.315"></a><span id="l1.315">           // This is a bit of hackery so that extensions can have mailing lists</span>
<a href="#l1.316"></a><span id="l1.316">           // where recipients are sent messages via BCC.</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-          hidesRecipients = directory.getBoolValue(&quot;HidesRecipients&quot;, false);</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+          hidesRecipients = selectedDir.getBoolValue(&quot;HidesRecipients&quot;, false);</span>
<a href="#l1.319"></a><span id="l1.319">         } catch(e) {</span>
<a href="#l1.320"></a><span id="l1.320">           // Standard Thunderbird mailing lists do not have preferences</span>
<a href="#l1.321"></a><span id="l1.321">           // associated with them, so we'll silently eat the error.</span>
<a href="#l1.322"></a><span id="l1.322">         }</span>
<a href="#l1.323"></a><span id="l1.323"> </span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-        if (directory &amp;&amp; directory.isMailList &amp;&amp; hidesRecipients)</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+        if (selectedDir &amp;&amp; selectedDir.isMailList &amp;&amp; hidesRecipients)</span>
<a href="#l1.326"></a><span id="l1.326">           // Bug 669301 (https://bugzilla.mozilla.org/show_bug.cgi?id=669301)</span>
<a href="#l1.327"></a><span id="l1.327">           // We're using BCC right now to hide recipients from one another.</span>
<a href="#l1.328"></a><span id="l1.328">           // We should probably use group syntax, but that's broken</span>
<a href="#l1.329"></a><span id="l1.329">           // right now, so this will have to do.</span>
<a href="#l1.330"></a><span id="l1.330">           composeFields.bcc = GetSelectedAddressesFromDirTree();</span>
<a href="#l1.331"></a><span id="l1.331">         else</span>
<a href="#l1.332"></a><span id="l1.332">           composeFields.to = GetSelectedAddressesFromDirTree();</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineplus">+      } else {</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+        composeFields.to = GetSelectedAddresses();</span>
<a href="#l1.335"></a><span id="l1.335">       }</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">-      else</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">-        composeFields.to = GetSelectedAddresses();</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-</span>
<a href="#l1.339"></a><span id="l1.339">       params.composeFields = composeFields;</span>
<a href="#l1.340"></a><span id="l1.340">       MailServices.compose.OpenComposeWindowWithParams(null, params);</span>
<a href="#l1.341"></a><span id="l1.341">     }</span>
<a href="#l1.342"></a><span id="l1.342">   }</span>
<a href="#l1.343"></a><span id="l1.343"> }</span>
<a href="#l1.344"></a><span id="l1.344"> </span>
<a href="#l1.345"></a><span id="l1.345"> /**</span>
<a href="#l1.346"></a><span id="l1.346">  * Set up items in the View &gt; Layout menupopup.  This function is responsible</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineat">@@ -419,34 +418,31 @@ function InitViewLayoutMenuPopup(event) </span>
<a href="#l1.348"></a><span id="l1.348"> }</span>
<a href="#l1.349"></a><span id="l1.349"> </span>
<a href="#l1.350"></a><span id="l1.350"> // Generate a list of cards from the selected mailing list</span>
<a href="#l1.351"></a><span id="l1.351"> // and get a comma separated list of card addresses. If the</span>
<a href="#l1.352"></a><span id="l1.352"> // item selected in the directory pane is not a mailing list,</span>
<a href="#l1.353"></a><span id="l1.353"> // an empty string is returned.</span>
<a href="#l1.354"></a><span id="l1.354"> function GetSelectedAddressesFromDirTree()</span>
<a href="#l1.355"></a><span id="l1.355"> {</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-  var addresses = &quot;&quot;;</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+  let selectedDir = getSelectedDirectory();</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineplus">+  if (!selectedDir || !selectedDir.isMailList)</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l1.361"></a><span id="l1.361"> </span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-  if (gDirTree.currentIndex &gt;= 0) {</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-    var directory = gDirectoryTreeView.getDirectoryAtIndex(gDirTree.currentIndex);</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">-    if (directory.isMailList) {</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-      var listCardsCount = directory.addressLists.length;</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-      var cards = new Array(listCardsCount);</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-      for (var i = 0; i &lt; listCardsCount; ++i)</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-        cards[i] = directory.addressLists</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-                            .queryElementAt(i, Components.interfaces.nsIAbCard);</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">-      addresses = GetAddressesForCards(cards);</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineminus">-    }</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-  }</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineminus">-  return addresses;</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineplus">+  let listCardsCount = selectedDir.addressLists.length;</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineplus">+  let cards = new Array(listCardsCount);</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineplus">+  for (let i = 0; i &lt; listCardsCount; ++i)</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineplus">+    cards[i] = selectedDir.addressLists</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineplus">+                 .queryElementAt(i, Components.interfaces.nsIAbCard);</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineplus">+  return GetAddressesForCards(cards);</span>
<a href="#l1.380"></a><span id="l1.380"> }</span>
<a href="#l1.381"></a><span id="l1.381"> </span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-// Generate a comma separated list of addresses from a given set of</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineminus">-// cards.</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineplus">+// Generate a comma separated list of addresses from a given</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineplus">+// set of cards.</span>
<a href="#l1.386"></a><span id="l1.386"> function GetAddressesForCards(cards)</span>
<a href="#l1.387"></a><span id="l1.387"> {</span>
<a href="#l1.388"></a><span id="l1.388">   var addresses = &quot;&quot;;</span>
<a href="#l1.389"></a><span id="l1.389"> </span>
<a href="#l1.390"></a><span id="l1.390">   if (!cards) {</span>
<a href="#l1.391"></a><span id="l1.391">     Components.utils.reportError(&quot;GetAddressesForCards: |cards| is null.&quot;);</span>
<a href="#l1.392"></a><span id="l1.392">     return addresses;</span>
<a href="#l1.393"></a><span id="l1.393">   }</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineat">@@ -467,17 +463,17 @@ function GetAddressesForCards(cards)</span>
<a href="#l1.395"></a><span id="l1.395"> function SelectFirstAddressBook()</span>
<a href="#l1.396"></a><span id="l1.396"> {</span>
<a href="#l1.397"></a><span id="l1.397">   if (gDirTree.view.selection.currentIndex != 0) {</span>
<a href="#l1.398"></a><span id="l1.398">     gDirTree.view.selection.select(0);</span>
<a href="#l1.399"></a><span id="l1.399">     // If gPreviousDirTreeIndex == 0 then DirPaneSelectionChange() and</span>
<a href="#l1.400"></a><span id="l1.400">     // ChangeDirectoryByURI() have already been run</span>
<a href="#l1.401"></a><span id="l1.401">     // (e.g. by the onselect event on the tree) so skip the call.</span>
<a href="#l1.402"></a><span id="l1.402">     if (gPreviousDirTreeIndex != 0)</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-      ChangeDirectoryByURI(GetSelectedDirectory());</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineplus">+      ChangeDirectoryByURI(getSelectedDirectoryURI());</span>
<a href="#l1.405"></a><span id="l1.405">   }</span>
<a href="#l1.406"></a><span id="l1.406">   gAbResultsTree.focus();</span>
<a href="#l1.407"></a><span id="l1.407"> }</span>
<a href="#l1.408"></a><span id="l1.408"> </span>
<a href="#l1.409"></a><span id="l1.409"> function DirPaneClick(event)</span>
<a href="#l1.410"></a><span id="l1.410"> {</span>
<a href="#l1.411"></a><span id="l1.411">   // we only care about left button events</span>
<a href="#l1.412"></a><span id="l1.412">   if (event.button != 0)</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineat">@@ -503,17 +499,17 @@ function DirPaneDoubleClick(event)</span>
<a href="#l1.414"></a><span id="l1.414">   }</span>
<a href="#l1.415"></a><span id="l1.415"> </span>
<a href="#l1.416"></a><span id="l1.416">   if (gDirTree &amp;&amp; gDirTree.view.selection &amp;&amp; gDirTree.view.selection.count == 1)</span>
<a href="#l1.417"></a><span id="l1.417">     AbEditSelectedDirectory();</span>
<a href="#l1.418"></a><span id="l1.418"> }</span>
<a href="#l1.419"></a><span id="l1.419"> </span>
<a href="#l1.420"></a><span id="l1.420"> function DirPaneSelectionChange()</span>
<a href="#l1.421"></a><span id="l1.421"> {</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineminus">-  let uri = GetSelectedDirectory();</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineplus">+  let uri = getSelectedDirectoryURI();</span>
<a href="#l1.424"></a><span id="l1.424">   // clear out the search box when changing folders...</span>
<a href="#l1.425"></a><span id="l1.425">   onAbClearSearch(false);</span>
<a href="#l1.426"></a><span id="l1.426">   if (gDirTree &amp;&amp; gDirTree.view.selection &amp;&amp; gDirTree.view.selection.count == 1) {</span>
<a href="#l1.427"></a><span id="l1.427">     gPreviousDirTreeIndex = gDirTree.currentIndex;</span>
<a href="#l1.428"></a><span id="l1.428">     ChangeDirectoryByURI(uri);</span>
<a href="#l1.429"></a><span id="l1.429">     document.getElementById(&quot;localResultsOnlyMessage&quot;)</span>
<a href="#l1.430"></a><span id="l1.430">             .setAttribute(&quot;hidden&quot;,</span>
<a href="#l1.431"></a><span id="l1.431">                           !gDirectoryTreeView.hasRemoteAB ||</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineat">@@ -534,17 +530,17 @@ function ChangeDirectoryByURI(uri = kPer</span>
<a href="#l1.433"></a><span id="l1.433">     gAbView.selection.clearSelection();</span>
<a href="#l1.434"></a><span id="l1.434">   else</span>
<a href="#l1.435"></a><span id="l1.435">     // the selection changes if we were switching directories.</span>
<a href="#l1.436"></a><span id="l1.436">     ResultsPaneSelectionChanged()</span>
<a href="#l1.437"></a><span id="l1.437"> }</span>
<a href="#l1.438"></a><span id="l1.438"> </span>
<a href="#l1.439"></a><span id="l1.439"> function AbNewList()</span>
<a href="#l1.440"></a><span id="l1.440"> {</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineminus">-  goNewListDialog(GetSelectedDirectory());</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineplus">+  goNewListDialog(getSelectedDirectoryURI());</span>
<a href="#l1.443"></a><span id="l1.443"> }</span>
<a href="#l1.444"></a><span id="l1.444"> </span>
<a href="#l1.445"></a><span id="l1.445"> function goNewListDialog(selectedAB)</span>
<a href="#l1.446"></a><span id="l1.446"> {</span>
<a href="#l1.447"></a><span id="l1.447">   window.openDialog(&quot;chrome://messenger/content/addressbook/abMailListDialog.xul&quot;,</span>
<a href="#l1.448"></a><span id="l1.448">                     &quot;&quot;,</span>
<a href="#l1.449"></a><span id="l1.449">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l1.450"></a><span id="l1.450">                     {selectedAB:selectedAB});</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineat">@@ -577,17 +573,16 @@ function goNewCardDialog(selectedAB)</span>
<a href="#l1.452"></a><span id="l1.452"> function goEditCardDialog(abURI, card)</span>
<a href="#l1.453"></a><span id="l1.453"> {</span>
<a href="#l1.454"></a><span id="l1.454">   window.openDialog(&quot;chrome://messenger/content/addressbook/abEditCardDialog.xul&quot;,</span>
<a href="#l1.455"></a><span id="l1.455">                     &quot;&quot;,</span>
<a href="#l1.456"></a><span id="l1.456">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l1.457"></a><span id="l1.457">                     {abURI:abURI, card:card});</span>
<a href="#l1.458"></a><span id="l1.458"> }</span>
<a href="#l1.459"></a><span id="l1.459"> </span>
<a href="#l1.460"></a><span id="l1.460" class="difflineminus">-</span>
<a href="#l1.461"></a><span id="l1.461"> function setSortByMenuItemCheckState(id, value)</span>
<a href="#l1.462"></a><span id="l1.462"> {</span>
<a href="#l1.463"></a><span id="l1.463">     var menuitem = document.getElementById(id);</span>
<a href="#l1.464"></a><span id="l1.464">     if (menuitem) {</span>
<a href="#l1.465"></a><span id="l1.465">       menuitem.setAttribute(&quot;checked&quot;, value);</span>
<a href="#l1.466"></a><span id="l1.466">     }</span>
<a href="#l1.467"></a><span id="l1.467"> }</span>
<a href="#l1.468"></a><span id="l1.468"> </span>
<a href="#l1.469"></a><span id="l1.469" class="difflineat">@@ -648,31 +643,66 @@ function GetParentDirectoryFromMailingLi</span>
<a href="#l1.470"></a><span id="l1.470">   */</span>
<a href="#l1.471"></a><span id="l1.471">   if (abURIArr.length == 4 &amp;&amp; abURIArr[0] == &quot;moz-abmdbdirectory:&quot; &amp;&amp; abURIArr[3] != &quot;&quot;) {</span>
<a href="#l1.472"></a><span id="l1.472">     return abURIArr[0] + &quot;/&quot; + abURIArr[1] + &quot;/&quot; + abURIArr[2];</span>
<a href="#l1.473"></a><span id="l1.473">   }</span>
<a href="#l1.474"></a><span id="l1.474"> </span>
<a href="#l1.475"></a><span id="l1.475">   return null;</span>
<a href="#l1.476"></a><span id="l1.476"> }</span>
<a href="#l1.477"></a><span id="l1.477"> </span>
<a href="#l1.478"></a><span id="l1.478" class="difflineplus">+/**</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineplus">+ * Return true if the directory pane has focus, otherwise false.</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineplus">+ */</span>
<a href="#l1.481"></a><span id="l1.481"> function DirPaneHasFocus()</span>
<a href="#l1.482"></a><span id="l1.482"> {</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineminus">-  // returns true if diectory pane has the focus. Returns false, otherwise.</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineminus">-  return (top.document.commandDispatcher.focusedElement == gDirTree)</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineplus">+  return (top.document.commandDispatcher.focusedElement == gDirTree);</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineplus">+}</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineplus">+</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineplus">+/**</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineplus">+ * Get the selected directory object.</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineplus">+ *</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineplus">+ * @return The object of the currently selected directory</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineplus">+ */</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineplus">+function getSelectedDirectory()</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineplus">+{</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+  // Contacts Sidebar</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineplus">+  if (abList)</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineplus">+    return MailServices.ab.getDirectory(abList.value);</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineplus">+</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineplus">+  // Main Address Book</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineplus">+  if (gDirTree.currentIndex &lt; 0)</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineplus">+    return null;</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineplus">+  return gDirectoryTreeView.getDirectoryAtIndex(gDirTree.currentIndex);</span>
<a href="#l1.503"></a><span id="l1.503"> }</span>
<a href="#l1.504"></a><span id="l1.504"> </span>
<a href="#l1.505"></a><span id="l1.505" class="difflineplus">+/**</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineplus">+ * Get the URI of the selected directory.</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineplus">+ *</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineplus">+ * @return The URI of the currently selected directory</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineplus">+ */</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineplus">+function getSelectedDirectoryURI()</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineplus">+{</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineplus">+  // Contacts Sidebar</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineplus">+  if (abList)</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineplus">+    return abList.value;</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineplus">+</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineplus">+  // Main Address Book</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineplus">+  if (gDirTree.currentIndex &lt; 0)</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineplus">+    return null;</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineplus">+  return gDirectoryTreeView.getDirectoryAtIndex(gDirTree.currentIndex).URI;</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineplus">+}</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineplus">+</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineplus">+/**</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineplus">+ * DEPRECATED legacy function wrapper for addon compatibility;</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineplus">+ * use getSelectedDirectoryURI() instead!</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineplus">+ * Return the URI of the selected directory.</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineplus">+ */</span>
<a href="#l1.527"></a><span id="l1.527"> function GetSelectedDirectory()</span>
<a href="#l1.528"></a><span id="l1.528"> {</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineminus">-  if (abList)</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineminus">-    return abList.value;</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineminus">-  else {</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineminus">-    if (gDirTree.currentIndex &lt; 0)</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineminus">-      return null;</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineminus">-    return gDirectoryTreeView.getDirectoryAtIndex(gDirTree.currentIndex).URI;</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineminus">-  }</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineplus">+  return getSelectedDirectoryURI();</span>
<a href="#l1.537"></a><span id="l1.537"> }</span>
<a href="#l1.538"></a><span id="l1.538"> </span>
<a href="#l1.539"></a><span id="l1.539"> /**</span>
<a href="#l1.540"></a><span id="l1.540">  * Clears the contents of the search input field,</span>
<a href="#l1.541"></a><span id="l1.541">  * possibly causing refresh of results.</span>
<a href="#l1.542"></a><span id="l1.542">  *</span>
<a href="#l1.543"></a><span id="l1.543">  * @param aRefresh  Set to false if the refresh isn't needed,</span>
<a href="#l1.544"></a><span id="l1.544">  *                  e.g. window/AB is going away so user will not see anything.</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineat">@@ -686,17 +716,17 @@ function onAbClearSearch(aRefresh = true</span>
<a href="#l1.546"></a><span id="l1.546">   searchInput.value = &quot;&quot;;</span>
<a href="#l1.547"></a><span id="l1.547">   if (aRefresh)</span>
<a href="#l1.548"></a><span id="l1.548">     onEnterInSearchBar();</span>
<a href="#l1.549"></a><span id="l1.549"> }</span>
<a href="#l1.550"></a><span id="l1.550"> </span>
<a href="#l1.551"></a><span id="l1.551"> // sets focus into the quick search box</span>
<a href="#l1.552"></a><span id="l1.552"> function QuickSearchFocus()</span>
<a href="#l1.553"></a><span id="l1.553"> {</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineminus">-  var searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineplus">+  let searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l1.556"></a><span id="l1.556">   if (searchInput) {</span>
<a href="#l1.557"></a><span id="l1.557">     searchInput.focus();</span>
<a href="#l1.558"></a><span id="l1.558">     searchInput.select();</span>
<a href="#l1.559"></a><span id="l1.559">   }</span>
<a href="#l1.560"></a><span id="l1.560"> }</span>
<a href="#l1.561"></a><span id="l1.561"> </span>
<a href="#l1.562"></a><span id="l1.562"> /**</span>
<a href="#l1.563"></a><span id="l1.563">  * Returns an nsIFile of the directory in which contact photos are stored.</span>
<a href="#l1.564"></a><span id="l1.564" class="difflineat">@@ -826,17 +856,16 @@ function saneBirthYear(aYear) {</span>
<a href="#l1.565"></a><span id="l1.565"> /**</span>
<a href="#l1.566"></a><span id="l1.566">  * Returns the nearest leap year before aYear.</span>
<a href="#l1.567"></a><span id="l1.567">  */</span>
<a href="#l1.568"></a><span id="l1.568"> function nearestLeap(aYear) {</span>
<a href="#l1.569"></a><span id="l1.569">   for (let year = aYear; year &gt; 0; year--) {</span>
<a href="#l1.570"></a><span id="l1.570">     if (new Date(year, 1, 29).getMonth() == 1)</span>
<a href="#l1.571"></a><span id="l1.571">       return year;</span>
<a href="#l1.572"></a><span id="l1.572">   }</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineminus">-</span>
<a href="#l1.574"></a><span id="l1.574">   return 2000;</span>
<a href="#l1.575"></a><span id="l1.575"> }</span>
<a href="#l1.576"></a><span id="l1.576"> </span>
<a href="#l1.577"></a><span id="l1.577"> /**</span>
<a href="#l1.578"></a><span id="l1.578">  * Sets the label, accesskey, and tooltiptext attributes of an element from</span>
<a href="#l1.579"></a><span id="l1.579">  * custom attributes of the same element. Typically, the element will be a</span>
<a href="#l1.580"></a><span id="l1.580">  * command or broadcaster element. JS does not allow omitting function arguments</span>
<a href="#l1.581"></a><span id="l1.581">  * in the middle of the arguments list, so in that case, please pass an explicit</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/addrbook/content/abContactsPanel.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/addrbook/content/abContactsPanel.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -59,17 +59,17 @@ function addSelectedAddresses(aRecipient</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">   // Turn each card into a properly formatted address.</span>
<a href="#l2.6"></a><span id="l2.6">   var addressArray = cards.map(GenerateAddressFromCard).filter(addr =&gt; (addr != &quot;&quot;));</span>
<a href="#l2.7"></a><span id="l2.7">   parent.AddRecipientsArray(aRecipientType, addressArray);</span>
<a href="#l2.8"></a><span id="l2.8"> }</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> function AddressBookMenuListChange()</span>
<a href="#l2.11"></a><span id="l2.11"> {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  var searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  let searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l2.14"></a><span id="l2.14">   if (searchInput.value &amp;&amp; !searchInput.showingSearchCriteria)</span>
<a href="#l2.15"></a><span id="l2.15">     onEnterInSearchBar();</span>
<a href="#l2.16"></a><span id="l2.16">   else</span>
<a href="#l2.17"></a><span id="l2.17">     ChangeDirectoryByURI(document.getElementById('addressbookList').value);</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">   // Hide the addressbook column if the selected addressbook isn't</span>
<a href="#l2.20"></a><span id="l2.20">   // &quot;All address books&quot;. Since the column is redundant in all other cases.</span>
<a href="#l2.21"></a><span id="l2.21">   let addrbookColumn = document.getElementById(&quot;addrbook&quot;);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -101,17 +101,17 @@ function AbPanelLoad()</span>
<a href="#l2.23"></a><span id="l2.23">   abPopup.value = temp;</span>
<a href="#l2.24"></a><span id="l2.24">   if (!abPopup.selectedItem)</span>
<a href="#l2.25"></a><span id="l2.25">     abPopup.selectedIndex = 0;</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">   ChangeDirectoryByURI(abPopup.value);</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">   mutationObs = new MutationObserver(function(aMutations) {</span>
<a href="#l2.30"></a><span id="l2.30">     aMutations.forEach(function(mutation) {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-      if (GetSelectedDirectory() == (kAllDirectoryRoot + &quot;?&quot;) &amp;&amp;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+      if (getSelectedDirectoryURI() == (kAllDirectoryRoot + &quot;?&quot;) &amp;&amp;</span>
<a href="#l2.33"></a><span id="l2.33">           mutation.type == &quot;attributes&quot; &amp;&amp;</span>
<a href="#l2.34"></a><span id="l2.34">           mutation.attributeName == &quot;hidden&quot;) {</span>
<a href="#l2.35"></a><span id="l2.35">         let curState = document.getElementById(&quot;addrbook&quot;).hidden;</span>
<a href="#l2.36"></a><span id="l2.36">         gShowAbColumnInComposeSidebar = !curState;</span>
<a href="#l2.37"></a><span id="l2.37">       }</span>
<a href="#l2.38"></a><span id="l2.38">     });</span>
<a href="#l2.39"></a><span id="l2.39">   });</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41" class="difflineat">@@ -168,18 +168,18 @@ function CommandUpdate_AddressBook()</span>
<a href="#l2.42"></a><span id="l2.42"> function onEnterInSearchBar()</span>
<a href="#l2.43"></a><span id="l2.43"> {</span>
<a href="#l2.44"></a><span id="l2.44">   if (!gQueryURIFormat) {</span>
<a href="#l2.45"></a><span id="l2.45">     // Get model query from pref. We don't want the query starting with &quot;?&quot;</span>
<a href="#l2.46"></a><span id="l2.46">     // as we have to prefix &quot;?and&quot; to this format.</span>
<a href="#l2.47"></a><span id="l2.47">     gQueryURIFormat = getModelQuery(&quot;mail.addr_book.quicksearchquery.format&quot;);</span>
<a href="#l2.48"></a><span id="l2.48">   }</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  var searchURI = GetSelectedDirectory();</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-  var searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  let searchURI = getSelectedDirectoryURI();</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  let searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55">   // Use helper method to split up search query to multi-word search</span>
<a href="#l2.56"></a><span id="l2.56">   // query against multiple fields.</span>
<a href="#l2.57"></a><span id="l2.57">   if (searchInput) {</span>
<a href="#l2.58"></a><span id="l2.58">     let searchWords = getSearchTokens(searchInput.value);</span>
<a href="#l2.59"></a><span id="l2.59">     searchURI += generateQueryURI(gQueryURIFormat, searchWords);</span>
<a href="#l2.60"></a><span id="l2.60">   }</span>
<a href="#l2.61"></a><span id="l2.61"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/addrbook/content/addressbook.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/addrbook/content/addressbook.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -329,36 +329,28 @@ function AbClose()</span>
<a href="#l3.4"></a><span id="l3.4"> function AbPrintCardInternal(doPrintPreview, msgType)</span>
<a href="#l3.5"></a><span id="l3.5"> {</span>
<a href="#l3.6"></a><span id="l3.6">   var selectedItems = GetSelectedAbCards();</span>
<a href="#l3.7"></a><span id="l3.7">   var numSelected = selectedItems.length;</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">   if (!numSelected)</span>
<a href="#l3.10"></a><span id="l3.10">     return;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  var uri = GetSelectedDirectory();</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  if (!uri)</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    return;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  let statusFeedback;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  statusFeedback = Components.classes[&quot;@mozilla.org/messenger/statusfeedback;1&quot;].createInstance();</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  statusFeedback = statusFeedback.QueryInterface(Components.interfaces.nsIMsgStatusFeedback);</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-   var statusFeedback;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-   statusFeedback = Components.classes[&quot;@mozilla.org/messenger/statusfeedback;1&quot;].createInstance();</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-   statusFeedback = statusFeedback.QueryInterface(Components.interfaces.nsIMsgStatusFeedback);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-   var selectionArray = new Array(numSelected);</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  let selectionArray = new Array(numSelected);</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-   var totalCard = 0;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-   for (var i = 0; i &lt; numSelected; i++)</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-   {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-     var card = selectedItems[i];</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-     var printCardUrl = CreatePrintCardUrl(card);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-     if (printCardUrl)</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-     {</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-        selectionArray[totalCard++] = printCardUrl;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-     }</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  for (let i = 0; i &lt; numSelected; i++) {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+    let card = selectedItems[i];</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+    let printCardUrl = CreatePrintCardUrl(card);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+    if (printCardUrl) {</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+      selectionArray.push(printCardUrl);</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+    }</span>
<a href="#l3.42"></a><span id="l3.42">   }</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44">   printEngineWindow = window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;,</span>
<a href="#l3.45"></a><span id="l3.45">                                          &quot;&quot;,</span>
<a href="#l3.46"></a><span id="l3.46">                                          &quot;chrome,dialog=no,all&quot;,</span>
<a href="#l3.47"></a><span id="l3.47">                                           totalCard, selectionArray, statusFeedback,</span>
<a href="#l3.48"></a><span id="l3.48">                                           doPrintPreview, msgType);</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50" class="difflineat">@@ -377,17 +369,17 @@ function AbPrintPreviewCard()</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52"> function CreatePrintCardUrl(card)</span>
<a href="#l3.53"></a><span id="l3.53"> {</span>
<a href="#l3.54"></a><span id="l3.54">   return &quot;data:application/xml;base64,&quot; + card.translateTo(&quot;base64xml&quot;);</span>
<a href="#l3.55"></a><span id="l3.55"> }</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57"> function AbPrintAddressBookInternal(doPrintPreview, msgType)</span>
<a href="#l3.58"></a><span id="l3.58"> {</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-  var uri = GetSelectedDirectory();</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  let uri = getSelectedDirectoryURI();</span>
<a href="#l3.61"></a><span id="l3.61">   if (!uri)</span>
<a href="#l3.62"></a><span id="l3.62">     return;</span>
<a href="#l3.63"></a><span id="l3.63"> </span>
<a href="#l3.64"></a><span id="l3.64">   var statusFeedback;</span>
<a href="#l3.65"></a><span id="l3.65">   statusFeedback = Components.classes[&quot;@mozilla.org/messenger/statusfeedback;1&quot;].createInstance();</span>
<a href="#l3.66"></a><span id="l3.66">   statusFeedback = statusFeedback.QueryInterface(Components.interfaces.nsIMsgStatusFeedback);</span>
<a href="#l3.67"></a><span id="l3.67"> </span>
<a href="#l3.68"></a><span id="l3.68">   /*</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineat">@@ -415,24 +407,24 @@ function AbPrintPreviewAddressBook()</span>
<a href="#l3.70"></a><span id="l3.70"> {</span>
<a href="#l3.71"></a><span id="l3.71">   AbPrintAddressBookInternal(true, Components.interfaces.nsIMsgPrintEngine.MNAB_PRINTPREVIEW_ADDRBOOK);</span>
<a href="#l3.72"></a><span id="l3.72"> }</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74"> /**</span>
<a href="#l3.75"></a><span id="l3.75">  * Export the currently selected addressbook.</span>
<a href="#l3.76"></a><span id="l3.76">  */</span>
<a href="#l3.77"></a><span id="l3.77"> function AbExportSelection() {</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-  let selectedABURI = GetSelectedDirectory();</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-  if (!selectedABURI)</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+  let selectedDirURI = getSelectedDirectoryURI();</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  if (!selectedDirURI)</span>
<a href="#l3.82"></a><span id="l3.82">     return;</span>
<a href="#l3.83"></a><span id="l3.83"> </span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">- if (selectedABURI == (kAllDirectoryRoot + &quot;?&quot;))</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+ if (selectedDirURI == (kAllDirectoryRoot + &quot;?&quot;))</span>
<a href="#l3.86"></a><span id="l3.86">    return AbExportAll();</span>
<a href="#l3.87"></a><span id="l3.87"> </span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">- return AbExport(selectedABURI);</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+ return AbExport(selectedDirURI);</span>
<a href="#l3.90"></a><span id="l3.90"> }</span>
<a href="#l3.91"></a><span id="l3.91"> </span>
<a href="#l3.92"></a><span id="l3.92"> /**</span>
<a href="#l3.93"></a><span id="l3.93">  * Export all found addressbooks, each in a separate file.</span>
<a href="#l3.94"></a><span id="l3.94">  */</span>
<a href="#l3.95"></a><span id="l3.95"> function AbExportAll()</span>
<a href="#l3.96"></a><span id="l3.96"> {</span>
<a href="#l3.97"></a><span id="l3.97">   let directories = MailServices.ab.directories;</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineat">@@ -443,25 +435,25 @@ function AbExportAll()</span>
<a href="#l3.99"></a><span id="l3.99">     if (!directory.URI.startsWith(kLdapUrlPrefix))</span>
<a href="#l3.100"></a><span id="l3.100">       AbExport(directory.URI);</span>
<a href="#l3.101"></a><span id="l3.101">   }</span>
<a href="#l3.102"></a><span id="l3.102"> }</span>
<a href="#l3.103"></a><span id="l3.103"> </span>
<a href="#l3.104"></a><span id="l3.104"> /**</span>
<a href="#l3.105"></a><span id="l3.105">  * Export the specified addressbook to a file.</span>
<a href="#l3.106"></a><span id="l3.106">  *</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">- * @param aSelectedABURI  The URI if the addressbook to export.</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+ * @param aSelectedDirURI  The URI of the addressbook to export.</span>
<a href="#l3.109"></a><span id="l3.109">  */</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-function AbExport(aSelectedABURI)</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+function AbExport(aSelectedDirURI)</span>
<a href="#l3.112"></a><span id="l3.112"> {</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-  if (!aSelectedABURI)</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+  if (!aSelectedDirURI)</span>
<a href="#l3.115"></a><span id="l3.115">     return;</span>
<a href="#l3.116"></a><span id="l3.116"> </span>
<a href="#l3.117"></a><span id="l3.117">   try {</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-    let directory = GetDirectoryFromURI(aSelectedABURI);</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+    let directory = GetDirectoryFromURI(aSelectedDirURI);</span>
<a href="#l3.120"></a><span id="l3.120">     MailServices.ab.exportAddressBook(window, directory);</span>
<a href="#l3.121"></a><span id="l3.121">   }</span>
<a href="#l3.122"></a><span id="l3.122">   catch (ex) {</span>
<a href="#l3.123"></a><span id="l3.123">     let message;</span>
<a href="#l3.124"></a><span id="l3.124">     switch (ex.result) {</span>
<a href="#l3.125"></a><span id="l3.125">       case Components.results.NS_ERROR_FILE_ACCESS_DENIED:</span>
<a href="#l3.126"></a><span id="l3.126">         message = gAddressBookBundle.getString(&quot;failedToExportMessageFileAccessDenied&quot;);</span>
<a href="#l3.127"></a><span id="l3.127">         break;</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineat">@@ -480,33 +472,33 @@ function AbExport(aSelectedABURI)</span>
<a href="#l3.129"></a><span id="l3.129"> }</span>
<a href="#l3.130"></a><span id="l3.130"> </span>
<a href="#l3.131"></a><span id="l3.131"> function SetStatusText(total)</span>
<a href="#l3.132"></a><span id="l3.132"> {</span>
<a href="#l3.133"></a><span id="l3.133">   if (!gStatusText)</span>
<a href="#l3.134"></a><span id="l3.134">     gStatusText = document.getElementById('statusText');</span>
<a href="#l3.135"></a><span id="l3.135"> </span>
<a href="#l3.136"></a><span id="l3.136">   try {</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-    var statusText;</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+    let statusText;</span>
<a href="#l3.139"></a><span id="l3.139"> </span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-    var searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+    let searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l3.142"></a><span id="l3.142">     if (searchInput &amp;&amp; searchInput.value) {</span>
<a href="#l3.143"></a><span id="l3.143">       if (total == 0) {</span>
<a href="#l3.144"></a><span id="l3.144">         statusText = gAddressBookBundle.getString(&quot;noMatchFound&quot;);</span>
<a href="#l3.145"></a><span id="l3.145">       } else {</span>
<a href="#l3.146"></a><span id="l3.146">         statusText = PluralForm</span>
<a href="#l3.147"></a><span id="l3.147">           .get(total, gAddressBookBundle.getString(&quot;matchesFound1&quot;))</span>
<a href="#l3.148"></a><span id="l3.148">           .replace(&quot;#1&quot;, total);</span>
<a href="#l3.149"></a><span id="l3.149">       }</span>
<a href="#l3.150"></a><span id="l3.150">     }</span>
<a href="#l3.151"></a><span id="l3.151">     else</span>
<a href="#l3.152"></a><span id="l3.152">       statusText =</span>
<a href="#l3.153"></a><span id="l3.153">         gAddressBookBundle.getFormattedString(</span>
<a href="#l3.154"></a><span id="l3.154">           &quot;totalContactStatus&quot;,</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-          [GetDirectoryFromURI(GetSelectedDirectory()).dirName, total]);</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+          [getSelectedDirectory().dirName, total]);</span>
<a href="#l3.157"></a><span id="l3.157"> </span>
<a href="#l3.158"></a><span id="l3.158">     gStatusText.setAttribute(&quot;label&quot;, statusText);</span>
<a href="#l3.159"></a><span id="l3.159">   }</span>
<a href="#l3.160"></a><span id="l3.160">   catch(ex) {</span>
<a href="#l3.161"></a><span id="l3.161">     Components.utils.reportError(&quot;ERROR: failed to set status text:  &quot; + ex );</span>
<a href="#l3.162"></a><span id="l3.162">   }</span>
<a href="#l3.163"></a><span id="l3.163"> }</span>
<a href="#l3.164"></a><span id="l3.164"> </span>
<a href="#l3.165"></a><span id="l3.165" class="difflineat">@@ -518,46 +510,47 @@ function AbResultsPaneKeyPress(event)</span>
<a href="#l3.166"></a><span id="l3.166"> </span>
<a href="#l3.167"></a><span id="l3.167"> function AbResultsPaneDoubleClick(card)</span>
<a href="#l3.168"></a><span id="l3.168"> {</span>
<a href="#l3.169"></a><span id="l3.169">   AbEditCard(card);</span>
<a href="#l3.170"></a><span id="l3.170"> }</span>
<a href="#l3.171"></a><span id="l3.171"> </span>
<a href="#l3.172"></a><span id="l3.172"> function onAdvancedAbSearch()</span>
<a href="#l3.173"></a><span id="l3.173"> {</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-  var selectedABURI = GetSelectedDirectory();</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-  if (!selectedABURI) return;</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+  let selectedDirURI = getSelectedDirectoryURI();</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+  if (!selectedDirURI)</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+    return;</span>
<a href="#l3.179"></a><span id="l3.179"> </span>
<a href="#l3.180"></a><span id="l3.180">   let existingSearchWindow = Services.wm.getMostRecentWindow(&quot;mailnews:absearch&quot;);</span>
<a href="#l3.181"></a><span id="l3.181">   if (existingSearchWindow)</span>
<a href="#l3.182"></a><span id="l3.182">     existingSearchWindow.focus();</span>
<a href="#l3.183"></a><span id="l3.183">   else</span>
<a href="#l3.184"></a><span id="l3.184">     window.openDialog(&quot;chrome://messenger/content/ABSearchDialog.xul&quot;, &quot;&quot;,</span>
<a href="#l3.185"></a><span id="l3.185">                       &quot;chrome,resizable,status,centerscreen,dialog=no&quot;,</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-                      {directory: selectedABURI});</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+                      {directory: selectedDirURI});</span>
<a href="#l3.188"></a><span id="l3.188"> }</span>
<a href="#l3.189"></a><span id="l3.189"> </span>
<a href="#l3.190"></a><span id="l3.190"> function onEnterInSearchBar()</span>
<a href="#l3.191"></a><span id="l3.191"> {</span>
<a href="#l3.192"></a><span id="l3.192">   ClearCardViewPane();</span>
<a href="#l3.193"></a><span id="l3.193">   if (!gQueryURIFormat) {</span>
<a href="#l3.194"></a><span id="l3.194">     // Get model query from pref. We don't want the query starting with &quot;?&quot;</span>
<a href="#l3.195"></a><span id="l3.195">     // as we have to prefix &quot;?and&quot; to this format.</span>
<a href="#l3.196"></a><span id="l3.196">     gQueryURIFormat = getModelQuery(&quot;mail.addr_book.quicksearchquery.format&quot;);</span>
<a href="#l3.197"></a><span id="l3.197">   }</span>
<a href="#l3.198"></a><span id="l3.198"> </span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-  var searchURI = GetSelectedDirectory();</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+  let searchURI = getSelectedDirectoryURI();</span>
<a href="#l3.201"></a><span id="l3.201">   if (!searchURI) return;</span>
<a href="#l3.202"></a><span id="l3.202"> </span>
<a href="#l3.203"></a><span id="l3.203">   /*</span>
<a href="#l3.204"></a><span id="l3.204">    XXX todo, handle the case where the LDAP url</span>
<a href="#l3.205"></a><span id="l3.205">    already has a query, like</span>
<a href="#l3.206"></a><span id="l3.206">    moz-abldapdirectory://nsdirectory.netscape.com:389/ou=People,dc=netscape,dc=com?(or(Department,=,Applications))</span>
<a href="#l3.207"></a><span id="l3.207">   */</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-  var searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+  let searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l3.210"></a><span id="l3.210">   // Use helper method to split up search query to multi-word search</span>
<a href="#l3.211"></a><span id="l3.211">   // query against multiple fields.</span>
<a href="#l3.212"></a><span id="l3.212">   if (searchInput) {</span>
<a href="#l3.213"></a><span id="l3.213">     let searchWords = getSearchTokens(searchInput.value);</span>
<a href="#l3.214"></a><span id="l3.214">     searchURI += generateQueryURI(gQueryURIFormat, searchWords);</span>
<a href="#l3.215"></a><span id="l3.215">   }</span>
<a href="#l3.216"></a><span id="l3.216"> </span>
<a href="#l3.217"></a><span id="l3.217">   if (searchURI == kAllDirectoryRoot)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/content/abDragDrop.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/content/abDragDrop.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -51,33 +51,33 @@ var abResultsPaneObserver = {</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">       var selectedAddresses = GetSelectedAddresses();</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">       aXferData.data = new TransferData();</span>
<a href="#l4.8"></a><span id="l4.8">       aXferData.data.addDataForFlavour(&quot;moz/abcard&quot;, selectedRows);</span>
<a href="#l4.9"></a><span id="l4.9">       aXferData.data.addDataForFlavour(&quot;text/x-moz-address&quot;, selectedAddresses);</span>
<a href="#l4.10"></a><span id="l4.10">       aXferData.data.addDataForFlavour(&quot;text/unicode&quot;, selectedAddresses);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-      var srcDirectory = GetDirectoryFromURI(GetSelectedDirectory());</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+      let srcDirectory = getSelectedDirectory();</span>
<a href="#l4.14"></a><span id="l4.14">       // The default allowable actions are copy, move and link, so we need</span>
<a href="#l4.15"></a><span id="l4.15">       // to restrict them here.</span>
<a href="#l4.16"></a><span id="l4.16">       if (!srcDirectory.readOnly)</span>
<a href="#l4.17"></a><span id="l4.17">         // Only allow copy &amp; move from read-write directories.</span>
<a href="#l4.18"></a><span id="l4.18">         aDragAction.action = Components.interfaces.</span>
<a href="#l4.19"></a><span id="l4.19">                              nsIDragService.DRAGDROP_ACTION_COPY |</span>
<a href="#l4.20"></a><span id="l4.20">                              Components.interfaces.</span>
<a href="#l4.21"></a><span id="l4.21">                              nsIDragService.DRAGDROP_ACTION_MOVE;</span>
<a href="#l4.22"></a><span id="l4.22">       else</span>
<a href="#l4.23"></a><span id="l4.23">         // Only allow copy from read-only directories.</span>
<a href="#l4.24"></a><span id="l4.24">         aDragAction.action = Components.interfaces.</span>
<a href="#l4.25"></a><span id="l4.25">                              nsIDragService.DRAGDROP_ACTION_COPY;</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">       var card = GetSelectedCard();</span>
<a href="#l4.28"></a><span id="l4.28">       if (card &amp;&amp; card.displayName) {</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-        var vCard = card.translateTo(&quot;vcard&quot;);</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+        let vCard = card.translateTo(&quot;vcard&quot;);</span>
<a href="#l4.31"></a><span id="l4.31">         aXferData.data.addDataForFlavour(&quot;text/vcard&quot;, decodeURIComponent(vCard));</span>
<a href="#l4.32"></a><span id="l4.32">         aXferData.data.addDataForFlavour(&quot;application/x-moz-file-promise-dest-filename&quot;, card.displayName + &quot;.vcf&quot;);</span>
<a href="#l4.33"></a><span id="l4.33">         aXferData.data.addDataForFlavour(&quot;application/x-moz-file-promise-url&quot;, &quot;data:text/vcard,&quot; + vCard);</span>
<a href="#l4.34"></a><span id="l4.34">         aXferData.data.addDataForFlavour(&quot;application/x-moz-file-promise&quot;, abFlavorDataProvider);</span>
<a href="#l4.35"></a><span id="l4.35">       }</span>
<a href="#l4.36"></a><span id="l4.36">     },</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">   onDrop: function (aEvent, aXferData, aDragSession)</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineat">@@ -131,19 +131,19 @@ var abDirTreeObserver = {</span>
<a href="#l4.40"></a><span id="l4.40">   canDrop: function(index, orientation, dataTransfer)</span>
<a href="#l4.41"></a><span id="l4.41">   {</span>
<a href="#l4.42"></a><span id="l4.42">     if (orientation != Components.interfaces.nsITreeView.DROP_ON)</span>
<a href="#l4.43"></a><span id="l4.43">       return false;</span>
<a href="#l4.44"></a><span id="l4.44">     if (!dataTransfer.types.includes(&quot;moz/abcard&quot;)) {</span>
<a href="#l4.45"></a><span id="l4.45">       return false;</span>
<a href="#l4.46"></a><span id="l4.46">     }</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-    var targetURI = gDirectoryTreeView.getDirectoryAtIndex(index).URI;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+    let targetURI = gDirectoryTreeView.getDirectoryAtIndex(index).URI;</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-    var srcURI = GetSelectedDirectory();</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+    let srcURI = getSelectedDirectoryURI();</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54">     // We cannot allow copy/move to &quot;All Address Books&quot;.</span>
<a href="#l4.55"></a><span id="l4.55">     if (targetURI == kAllDirectoryRoot + &quot;?&quot;)</span>
<a href="#l4.56"></a><span id="l4.56">       return false;</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58">     // The same place case</span>
<a href="#l4.59"></a><span id="l4.59">     if (targetURI == srcURI)</span>
<a href="#l4.60"></a><span id="l4.60">       return false;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineat">@@ -223,18 +223,18 @@ var abDirTreeObserver = {</span>
<a href="#l4.62"></a><span id="l4.62">   {</span>
<a href="#l4.63"></a><span id="l4.63">     var dragSession = dragService.getCurrentSession();</span>
<a href="#l4.64"></a><span id="l4.64">     if (!dragSession)</span>
<a href="#l4.65"></a><span id="l4.65">       return;</span>
<a href="#l4.66"></a><span id="l4.66">     if (!dataTransfer.types.includes(&quot;moz/abcard&quot;)) {</span>
<a href="#l4.67"></a><span id="l4.67">       return;</span>
<a href="#l4.68"></a><span id="l4.68">     }</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-    var targetURI = gDirectoryTreeView.getDirectoryAtIndex(index).URI;</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-    var srcURI = GetSelectedDirectory();</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+    let targetURI = gDirectoryTreeView.getDirectoryAtIndex(index).URI;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+    let srcURI = getSelectedDirectoryURI();</span>
<a href="#l4.74"></a><span id="l4.74"> </span>
<a href="#l4.75"></a><span id="l4.75">     // The data contains the a string of &quot;selected rows&quot;, eg.: &quot;1,2&quot;.</span>
<a href="#l4.76"></a><span id="l4.76">     var rows = dataTransfer.getData(&quot;moz/abcard&quot;).split(&quot;,&quot;).map(j =&gt; parseInt(j, 10));</span>
<a href="#l4.77"></a><span id="l4.77">     var numrows = rows.length;</span>
<a href="#l4.78"></a><span id="l4.78"> </span>
<a href="#l4.79"></a><span id="l4.79">     var result;</span>
<a href="#l4.80"></a><span id="l4.80">     // needToCopyCard is used for whether or not we should be creating</span>
<a href="#l4.81"></a><span id="l4.81">     // copies of the cards in a mailing list in a different address book</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* vim: set ts=8 sts=2 et sw=2 tw=80: */</span>
<a href="#l5.5"></a><span id="l5.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> /**</span>
<a href="#l5.10"></a><span id="l5.10">  * Use of items in this file require:</span>
<a href="#l5.11"></a><span id="l5.11">  *</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">- * GetSelectedDirectory()</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+ * getSelectedDirectoryURI()</span>
<a href="#l5.14"></a><span id="l5.14">  *   returns the URI of the selected directory</span>
<a href="#l5.15"></a><span id="l5.15">  * AbResultsPaneDoubleClick(card)</span>
<a href="#l5.16"></a><span id="l5.16">  *   Is called when the results pane is double-clicked, with the clicked card.</span>
<a href="#l5.17"></a><span id="l5.17">  * AbEditCard(card)</span>
<a href="#l5.18"></a><span id="l5.18">  *   Is called when a card is to be edited, with the card as the parameter.</span>
<a href="#l5.19"></a><span id="l5.19">  *</span>
<a href="#l5.20"></a><span id="l5.20">  * The following function is only required if ResultsPaneController is used:</span>
<a href="#l5.21"></a><span id="l5.21">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/mailnews/addrbook/abCommon.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/mailnews/addrbook/abCommon.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.9"></a><span id="l6.9"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l6.10"></a><span id="l6.10"> Components.utils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-var gDirTree = 0;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+var gDirTree = null;</span>
<a href="#l6.14"></a><span id="l6.14"> var abList = null;</span>
<a href="#l6.15"></a><span id="l6.15"> var gAbResultsTree = null;</span>
<a href="#l6.16"></a><span id="l6.16"> var gAbView = null;</span>
<a href="#l6.17"></a><span id="l6.17"> var gAddressBookBundle;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> const kDefaultSortColumn = &quot;GeneratedName&quot;;</span>
<a href="#l6.20"></a><span id="l6.20"> const kDefaultAscending = &quot;ascending&quot;;</span>
<a href="#l6.21"></a><span id="l6.21"> const kDefaultDescending = &quot;descending&quot;;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -41,64 +41,66 @@ var DirPaneController =</span>
<a href="#l6.23"></a><span id="l6.23">         return true;</span>
<a href="#l6.24"></a><span id="l6.24">       default:</span>
<a href="#l6.25"></a><span id="l6.25">         return false;</span>
<a href="#l6.26"></a><span id="l6.26">     }</span>
<a href="#l6.27"></a><span id="l6.27">   },</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">   isCommandEnabled: function(command)</span>
<a href="#l6.30"></a><span id="l6.30">   {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-    var selectedDir;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-</span>
<a href="#l6.33"></a><span id="l6.33">     switch (command) {</span>
<a href="#l6.34"></a><span id="l6.34">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-        // the gDirTree pane</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-        // only handles single selection</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-        // so we forward select all to the results pane</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-        // but if there is no gAbView</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-        // don't bother sending to the results pane</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+        // The gDirTree pane only handles single selection, but normally we</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+        // enable cmd_selectAll as it will get forwarded to the results pane.</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+        // But if there is no gAbView, disable as we can't forward to anywhere.</span>
<a href="#l6.43"></a><span id="l6.43">         return (gAbView != null);</span>
<a href="#l6.44"></a><span id="l6.44">       case &quot;cmd_delete&quot;:</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-      case &quot;button_delete&quot;:</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-        selectedDir = GetSelectedDirectory();</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+      case &quot;button_delete&quot;: {</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+        let selectedDir = getSelectedDirectory();</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+        let selectedDirURI = selectedDir.URI;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+        // Context-sensitive labels for Edit &gt; Delete menuitem.</span>
<a href="#l6.52"></a><span id="l6.52">         if (command == &quot;cmd_delete&quot; &amp;&amp; selectedDir) {</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-          goSetMenuValue(command, GetDirectoryFromURI(selectedDir).isMailList ? &quot;valueList&quot; : &quot;valueAddressBook&quot;);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+          goSetMenuValue(command, selectedDir.isMailList ?</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+                                  &quot;valueList&quot; : &quot;valueAddressBook&quot;);</span>
<a href="#l6.56"></a><span id="l6.56">         }</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-        if (selectedDir &amp;&amp;</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-            (selectedDir != kPersonalAddressbookURI) &amp;&amp;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-            (selectedDir != kCollectedAddressbookURI)) {</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-          // If the directory is a mailing list, and it is read-only, return</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-          // false.</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-          var abDir = GetDirectoryFromURI(selectedDir);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-          if (abDir.isMailList &amp;&amp; abDir.readOnly)</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-            return false;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+        // If there's no directory selected, or if it's one of these special ABs,</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+        // return false to disable deletion.</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+        if (!selectedDir ||</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+             (selectedDirURI == kPersonalAddressbookURI) ||</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+             (selectedDirURI == kCollectedAddressbookURI))</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+          return false;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+        // If the directory is a mailing list, and it is read-only,</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+        // return false to disable deletion.</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+        if (selectedDir.isMailList &amp;&amp; selectedDir.readOnly)</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+          return false;</span>
<a href="#l6.77"></a><span id="l6.77"> </span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-          // If the selected directory is an ldap directory</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-          // and if the prefs for this directory are locked</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-          // disable the delete button.</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-          if (selectedDir.lastIndexOf(kLdapUrlPrefix, 0) == 0)</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-          {</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-            var disable = false;</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-            try {</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-              var prefName = selectedDir.substr(kLdapUrlPrefix.length);</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-              disable = Services.prefs.getBoolPref(prefName + &quot;.disable_delete&quot;);</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-            }</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-            catch(ex) {</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-              // if this preference is not set its ok.</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-            }</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-            if (disable)</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-              return false;</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+        // If the selected directory is an ldap directory,</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+        // and if the prefs for this directory are locked,</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+        // return false to disable deletion.</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+        if (selectedDirURI.startsWith(kLdapUrlPrefix)) {</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+          let disable = false;</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+          try {</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+            let prefName = selectedDirURI.substr(kLdapUrlPrefix.length);</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+            disable = Services.prefs.getBoolPref(prefName + &quot;.disable_delete&quot;);</span>
<a href="#l6.101"></a><span id="l6.101">           }</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-          return true;</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+          catch(ex) {</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+            // If this preference is not set, that's ok.</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+          }</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+          if (disable)</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+            return false;</span>
<a href="#l6.108"></a><span id="l6.108">         }</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-        else</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-          return false;</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+        // Else return true to enable deletion (default).</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+        return true;</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+      }</span>
<a href="#l6.115"></a><span id="l6.115">       case &quot;cmd_properties&quot;:</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-        return (GetSelectedDirectory() != null);</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+        return (getSelectedDirectoryURI() != null);</span>
<a href="#l6.118"></a><span id="l6.118">       case &quot;cmd_newlist&quot;:</span>
<a href="#l6.119"></a><span id="l6.119">         return true;</span>
<a href="#l6.120"></a><span id="l6.120">       default:</span>
<a href="#l6.121"></a><span id="l6.121">         return false;</span>
<a href="#l6.122"></a><span id="l6.122">     }</span>
<a href="#l6.123"></a><span id="l6.123">   },</span>
<a href="#l6.124"></a><span id="l6.124"> </span>
<a href="#l6.125"></a><span id="l6.125">   doCommand: function(command)</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineat">@@ -151,60 +153,57 @@ function AbNewAddressBook()</span>
<a href="#l6.127"></a><span id="l6.127">   window.openDialog(&quot;chrome://messenger/content/addressbook/abAddressBookNameDialog.xul&quot;,</span>
<a href="#l6.128"></a><span id="l6.128">                     &quot;&quot;,</span>
<a href="#l6.129"></a><span id="l6.129">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l6.130"></a><span id="l6.130">                     null);</span>
<a href="#l6.131"></a><span id="l6.131"> }</span>
<a href="#l6.132"></a><span id="l6.132"> </span>
<a href="#l6.133"></a><span id="l6.133"> function AbEditSelectedDirectory()</span>
<a href="#l6.134"></a><span id="l6.134"> {</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-  if (gDirectoryTreeView.selection.count == 1) {</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-    var selecteduri = GetSelectedDirectory();</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-    var directory = GetDirectoryFromURI(selecteduri);</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-    if (directory.isMailList) {</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-      goEditListDialog(null, selecteduri);</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-    }</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-    else {</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-      window.openDialog(directory.propertiesChromeURI,</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-                        &quot;&quot;,</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-                        &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-                        { selectedDirectory: directory });</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-    }</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+  let selectedDir = getSelectedDirectory();</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+  if (!selectedDir)</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+    return;</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+  if (selectedDir.isMailList) {</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+    goEditListDialog(null, selectedDir.URI);</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+  } else {</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+    window.openDialog(selectedDir.propertiesChromeURI,</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+                      &quot;&quot;,</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+                      &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+                      {selectedDirectory: selectedDir});</span>
<a href="#l6.158"></a><span id="l6.158">   }</span>
<a href="#l6.159"></a><span id="l6.159"> }</span>
<a href="#l6.160"></a><span id="l6.160"> </span>
<a href="#l6.161"></a><span id="l6.161"> function AbDeleteSelectedDirectory()</span>
<a href="#l6.162"></a><span id="l6.162"> {</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-  var selectedABURI = GetSelectedDirectory();</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-  if (!selectedABURI)</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+  let selectedDirURI = getSelectedDirectoryURI();</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+  if (!selectedDirURI)</span>
<a href="#l6.167"></a><span id="l6.167">     return;</span>
<a href="#l6.168"></a><span id="l6.168"> </span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-  AbDeleteDirectory(selectedABURI);</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+  AbDeleteDirectory(selectedDirURI);</span>
<a href="#l6.171"></a><span id="l6.171"> }</span>
<a href="#l6.172"></a><span id="l6.172"> </span>
<a href="#l6.173"></a><span id="l6.173"> function AbDeleteDirectory(aURI)</span>
<a href="#l6.174"></a><span id="l6.174"> {</span>
<a href="#l6.175"></a><span id="l6.175">   var directory = GetDirectoryFromURI(aURI);</span>
<a href="#l6.176"></a><span id="l6.176">   var confirmDeleteMessage;</span>
<a href="#l6.177"></a><span id="l6.177">   var clearPrefsRequired = false;</span>
<a href="#l6.178"></a><span id="l6.178"> </span>
<a href="#l6.179"></a><span id="l6.179">   if (directory.isMailList)</span>
<a href="#l6.180"></a><span id="l6.180">     confirmDeleteMessage = gAddressBookBundle.getString(&quot;confirmDeleteMailingList&quot;);</span>
<a href="#l6.181"></a><span id="l6.181">   else {</span>
<a href="#l6.182"></a><span id="l6.182">     // Check if this address book is being used for collection</span>
<a href="#l6.183"></a><span id="l6.183">     if (Services.prefs.getCharPref(&quot;mail.collect_addressbook&quot;) == aURI &amp;&amp;</span>
<a href="#l6.184"></a><span id="l6.184">         (Services.prefs.getBoolPref(&quot;mail.collect_email_address_outgoing&quot;) ||</span>
<a href="#l6.185"></a><span id="l6.185">          Services.prefs.getBoolPref(&quot;mail.collect_email_address_incoming&quot;) ||</span>
<a href="#l6.186"></a><span id="l6.186">          Services.prefs.getBoolPref(&quot;mail.collect_email_address_newsgroup&quot;))) {</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-      var brandShortName = document.getElementById(&quot;bundle_brand&quot;).getString(&quot;brandShortName&quot;);</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+      let brandShortName = document.getElementById(&quot;bundle_brand&quot;).getString(&quot;brandShortName&quot;);</span>
<a href="#l6.190"></a><span id="l6.190">       confirmDeleteMessage = gAddressBookBundle.getFormattedString(&quot;confirmDeleteCollectionAddressbook&quot;, [brandShortName]);</span>
<a href="#l6.191"></a><span id="l6.191">       clearPrefsRequired = true;</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-    }</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-    else {</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+    } else {</span>
<a href="#l6.195"></a><span id="l6.195">       confirmDeleteMessage = gAddressBookBundle.getString(&quot;confirmDeleteAddressbook&quot;);</span>
<a href="#l6.196"></a><span id="l6.196">     }</span>
<a href="#l6.197"></a><span id="l6.197">   }</span>
<a href="#l6.198"></a><span id="l6.198"> </span>
<a href="#l6.199"></a><span id="l6.199">   let title = gAddressBookBundle.getString(directory.isMailList ?</span>
<a href="#l6.200"></a><span id="l6.200">                                              &quot;confirmDeleteMailingListTitle&quot; :</span>
<a href="#l6.201"></a><span id="l6.201">                                              &quot;confirmDeleteAddressbookTitle&quot;);</span>
<a href="#l6.202"></a><span id="l6.202">   if (!Services.prompt.confirm(window, title, confirmDeleteMessage))</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineat">@@ -267,70 +266,61 @@ function AbDelete()</span>
<a href="#l6.204"></a><span id="l6.204"> </span>
<a href="#l6.205"></a><span id="l6.205">   if (confirmDeleteMessage &amp;&amp;</span>
<a href="#l6.206"></a><span id="l6.206">       Services.prompt.confirm(window, null, confirmDeleteMessage))</span>
<a href="#l6.207"></a><span id="l6.207">     gAbView.deleteSelectedCards();</span>
<a href="#l6.208"></a><span id="l6.208"> }</span>
<a href="#l6.209"></a><span id="l6.209"> </span>
<a href="#l6.210"></a><span id="l6.210"> function AbNewCard()</span>
<a href="#l6.211"></a><span id="l6.211"> {</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-  goNewCardDialog(GetSelectedDirectory());</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+  goNewCardDialog(getSelectedDirectoryURI());</span>
<a href="#l6.214"></a><span id="l6.214"> }</span>
<a href="#l6.215"></a><span id="l6.215"> </span>
<a href="#l6.216"></a><span id="l6.216"> function AbEditCard(card)</span>
<a href="#l6.217"></a><span id="l6.217"> {</span>
<a href="#l6.218"></a><span id="l6.218">   // Need a card,</span>
<a href="#l6.219"></a><span id="l6.219">   if (!card)</span>
<a href="#l6.220"></a><span id="l6.220">     return;</span>
<a href="#l6.221"></a><span id="l6.221"> </span>
<a href="#l6.222"></a><span id="l6.222">   if (card.isMailList) {</span>
<a href="#l6.223"></a><span id="l6.223">     goEditListDialog(card, card.mailListURI);</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-  }</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-  else {</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-    goEditCardDialog(GetSelectedDirectory(), card);</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+  } else {</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+    goEditCardDialog(getSelectedDirectoryURI(), card);</span>
<a href="#l6.229"></a><span id="l6.229">   }</span>
<a href="#l6.230"></a><span id="l6.230"> }</span>
<a href="#l6.231"></a><span id="l6.231"> </span>
<a href="#l6.232"></a><span id="l6.232"> function AbNewMessage()</span>
<a href="#l6.233"></a><span id="l6.233"> {</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-  var params = Components.classes[&quot;@mozilla.org/messengercompose/composeparams;1&quot;].createInstance(Components.interfaces.nsIMsgComposeParams);</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-  if (params)</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-  {</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-    var composeFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-    if (composeFields)</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-    {</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+  let params = Components.classes[&quot;@mozilla.org/messengercompose/composeparams;1&quot;].createInstance(Components.interfaces.nsIMsgComposeParams);</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+  if (params) {</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+    let composeFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+    if (composeFields) {</span>
<a href="#l6.244"></a><span id="l6.244">       params.type = Components.interfaces.nsIMsgCompType.New;</span>
<a href="#l6.245"></a><span id="l6.245">       params.format = Components.interfaces.nsIMsgCompFormat.Default;</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-      if (DirPaneHasFocus())</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-      {</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-        var directory = gDirectoryTreeView.getDirectoryAtIndex(gDirTree.currentIndex);</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-        var hidesRecipients = false;</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-        try</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-        {</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+      if (DirPaneHasFocus()) {</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+        let selectedDir = getSelectedDirectory();</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+        let hidesRecipients = false;</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+        try {</span>
<a href="#l6.256"></a><span id="l6.256">           // This is a bit of hackery so that extensions can have mailing lists</span>
<a href="#l6.257"></a><span id="l6.257">           // where recipients are sent messages via BCC.</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-          hidesRecipients = directory.getBoolValue(&quot;HidesRecipients&quot;, false);</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-        }</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-        catch (e)</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-        {</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-          // Standard mailing lists do not have preferences</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+          hidesRecipients = selectedDir.getBoolValue(&quot;HidesRecipients&quot;, false);</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+        } catch(e) {</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+          // Standard Thunderbird mailing lists do not have preferences</span>
<a href="#l6.266"></a><span id="l6.266">           // associated with them, so we'll silently eat the error.</span>
<a href="#l6.267"></a><span id="l6.267">         }</span>
<a href="#l6.268"></a><span id="l6.268"> </span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-        if (directory &amp;&amp; directory.isMailList &amp;&amp; hidesRecipients)</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+        if (selectedDir &amp;&amp; selectedDir.isMailList &amp;&amp; hidesRecipients)</span>
<a href="#l6.271"></a><span id="l6.271">           // Bug 669301 (https://bugzilla.mozilla.org/show_bug.cgi?id=669301)</span>
<a href="#l6.272"></a><span id="l6.272">           // We're using BCC right now to hide recipients from one another.</span>
<a href="#l6.273"></a><span id="l6.273">           // We should probably use group syntax, but that's broken</span>
<a href="#l6.274"></a><span id="l6.274">           // right now, so this will have to do.</span>
<a href="#l6.275"></a><span id="l6.275">           composeFields.bcc = GetSelectedAddressesFromDirTree();</span>
<a href="#l6.276"></a><span id="l6.276">         else</span>
<a href="#l6.277"></a><span id="l6.277">           composeFields.to = GetSelectedAddressesFromDirTree();</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-      }</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-      else</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-      {</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+      } else {</span>
<a href="#l6.282"></a><span id="l6.282">         composeFields.to = GetSelectedAddresses();</span>
<a href="#l6.283"></a><span id="l6.283">       }</span>
<a href="#l6.284"></a><span id="l6.284">       params.composeFields = composeFields;</span>
<a href="#l6.285"></a><span id="l6.285">       MailServices.compose.OpenComposeWindowWithParams(null, params);</span>
<a href="#l6.286"></a><span id="l6.286">     }</span>
<a href="#l6.287"></a><span id="l6.287">   }</span>
<a href="#l6.288"></a><span id="l6.288"> }</span>
<a href="#l6.289"></a><span id="l6.289"> </span>
<a href="#l6.290"></a><span id="l6.290" class="difflineat">@@ -373,31 +363,27 @@ function InitViewLayoutMenuPopup(aEvent)</span>
<a href="#l6.291"></a><span id="l6.291"> }</span>
<a href="#l6.292"></a><span id="l6.292"> </span>
<a href="#l6.293"></a><span id="l6.293"> // Generate a list of cards from the selected mailing list</span>
<a href="#l6.294"></a><span id="l6.294"> // and get a comma separated list of card addresses. If the</span>
<a href="#l6.295"></a><span id="l6.295"> // item selected in the directory pane is not a mailing list,</span>
<a href="#l6.296"></a><span id="l6.296"> // an empty string is returned.</span>
<a href="#l6.297"></a><span id="l6.297"> function GetSelectedAddressesFromDirTree()</span>
<a href="#l6.298"></a><span id="l6.298"> {</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-  var addresses = &quot;&quot;;</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+  let selectedDir = getSelectedDirectory();</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+  if (!selectedDir || !selectedDir.isMailList)</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l6.304"></a><span id="l6.304"> </span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-  if (gDirTree.currentIndex &gt;= 0) {</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-    var directory = gDirectoryTreeView.getDirectoryAtIndex(gDirTree.currentIndex);</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-    if (directory.isMailList) {</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-      var listCardsCount = directory.addressLists.length;</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-      var cards = new Array(listCardsCount);</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-      for (var i = 0; i &lt; listCardsCount; ++i)</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-        cards[i] = directory.addressLists</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-                            .queryElementAt(i, Components.interfaces.nsIAbCard);</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-      addresses = GetAddressesForCards(cards);</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-    }</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-  }</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-  return addresses;</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+  let listCardsCount = selectedDir.addressLists.length;</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+  let cards = new Array(listCardsCount);</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+  for (let i = 0; i &lt; listCardsCount; ++i)</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+    cards[i] = selectedDir.addressLists</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+                 .queryElementAt(i, Components.interfaces.nsIAbCard);</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+  return GetAddressesForCards(cards);</span>
<a href="#l6.324"></a><span id="l6.324"> }</span>
<a href="#l6.325"></a><span id="l6.325"> </span>
<a href="#l6.326"></a><span id="l6.326"> // Generate a comma separated list of addresses from a given</span>
<a href="#l6.327"></a><span id="l6.327"> // set of cards.</span>
<a href="#l6.328"></a><span id="l6.328"> function GetAddressesForCards(cards)</span>
<a href="#l6.329"></a><span id="l6.329"> {</span>
<a href="#l6.330"></a><span id="l6.330">   var addresses = &quot;&quot;;</span>
<a href="#l6.331"></a><span id="l6.331"> </span>
<a href="#l6.332"></a><span id="l6.332" class="difflineat">@@ -418,33 +404,33 @@ function GetAddressesForCards(cards)</span>
<a href="#l6.333"></a><span id="l6.333">   return addresses;</span>
<a href="#l6.334"></a><span id="l6.334"> }</span>
<a href="#l6.335"></a><span id="l6.335"> </span>
<a href="#l6.336"></a><span id="l6.336"> </span>
<a href="#l6.337"></a><span id="l6.337"> function SelectFirstAddressBook()</span>
<a href="#l6.338"></a><span id="l6.338"> {</span>
<a href="#l6.339"></a><span id="l6.339">   gDirectoryTreeView.selection.select(0);</span>
<a href="#l6.340"></a><span id="l6.340"> </span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-  ChangeDirectoryByURI(GetSelectedDirectory());</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+  ChangeDirectoryByURI(getSelectedDirectoryURI());</span>
<a href="#l6.343"></a><span id="l6.343">   gAbResultsTree.focus();</span>
<a href="#l6.344"></a><span id="l6.344"> }</span>
<a href="#l6.345"></a><span id="l6.345"> </span>
<a href="#l6.346"></a><span id="l6.346"> function DirPaneClick(event)</span>
<a href="#l6.347"></a><span id="l6.347"> {</span>
<a href="#l6.348"></a><span id="l6.348">   // we only care about left button events</span>
<a href="#l6.349"></a><span id="l6.349">   if (event.button != 0)</span>
<a href="#l6.350"></a><span id="l6.350">     return;</span>
<a href="#l6.351"></a><span id="l6.351"> </span>
<a href="#l6.352"></a><span id="l6.352">   // if the user clicks on the header / trecol, do nothing</span>
<a href="#l6.353"></a><span id="l6.353">   if (event.originalTarget.localName == &quot;treecol&quot;) {</span>
<a href="#l6.354"></a><span id="l6.354">     event.stopPropagation();</span>
<a href="#l6.355"></a><span id="l6.355">     return;</span>
<a href="#l6.356"></a><span id="l6.356">   }</span>
<a href="#l6.357"></a><span id="l6.357"> </span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-  var searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+  let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l6.360"></a><span id="l6.360">   // if there is a searchInput element, and it's not blank</span>
<a href="#l6.361"></a><span id="l6.361">   // then we need to act like the user cleared the</span>
<a href="#l6.362"></a><span id="l6.362">   // search text</span>
<a href="#l6.363"></a><span id="l6.363">   if (searchInput &amp;&amp; searchInput.value) {</span>
<a href="#l6.364"></a><span id="l6.364">     searchInput.value = &quot;&quot;;</span>
<a href="#l6.365"></a><span id="l6.365">     onEnterInSearchBar();</span>
<a href="#l6.366"></a><span id="l6.366">   }</span>
<a href="#l6.367"></a><span id="l6.367"> }</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineat">@@ -465,17 +451,17 @@ function DirPaneDoubleClick(event)</span>
<a href="#l6.369"></a><span id="l6.369">       gDirectoryTreeView.selection.count == 1)</span>
<a href="#l6.370"></a><span id="l6.370">     AbEditSelectedDirectory();</span>
<a href="#l6.371"></a><span id="l6.371"> }</span>
<a href="#l6.372"></a><span id="l6.372"> </span>
<a href="#l6.373"></a><span id="l6.373"> function DirPaneSelectionChange()</span>
<a href="#l6.374"></a><span id="l6.374"> {</span>
<a href="#l6.375"></a><span id="l6.375">   if (gDirectoryTreeView.selection &amp;&amp;</span>
<a href="#l6.376"></a><span id="l6.376">       gDirectoryTreeView.selection.count == 1) {</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-    ChangeDirectoryByURI(GetSelectedDirectory());</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+    ChangeDirectoryByURI(getSelectedDirectoryURI());</span>
<a href="#l6.379"></a><span id="l6.379">   }</span>
<a href="#l6.380"></a><span id="l6.380"> }</span>
<a href="#l6.381"></a><span id="l6.381"> </span>
<a href="#l6.382"></a><span id="l6.382"> function ChangeDirectoryByURI(uri)</span>
<a href="#l6.383"></a><span id="l6.383"> {</span>
<a href="#l6.384"></a><span id="l6.384">   if (!uri)</span>
<a href="#l6.385"></a><span id="l6.385">     uri = kPersonalAddressbookURI;</span>
<a href="#l6.386"></a><span id="l6.386"> </span>
<a href="#l6.387"></a><span id="l6.387" class="difflineat">@@ -486,42 +472,43 @@ function ChangeDirectoryByURI(uri)</span>
<a href="#l6.388"></a><span id="l6.388">     SelectFirstCard();</span>
<a href="#l6.389"></a><span id="l6.389">   else</span>
<a href="#l6.390"></a><span id="l6.390">     // the selection changes if we were switching directories.</span>
<a href="#l6.391"></a><span id="l6.391">     ResultsPaneSelectionChanged()</span>
<a href="#l6.392"></a><span id="l6.392"> }</span>
<a href="#l6.393"></a><span id="l6.393"> </span>
<a href="#l6.394"></a><span id="l6.394"> function AbNewList()</span>
<a href="#l6.395"></a><span id="l6.395"> {</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-  goNewListDialog(GetSelectedDirectory());</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+  goNewListDialog(getSelectedDirectoryURI());</span>
<a href="#l6.398"></a><span id="l6.398"> }</span>
<a href="#l6.399"></a><span id="l6.399"> </span>
<a href="#l6.400"></a><span id="l6.400"> function goNewListDialog(selectedAB)</span>
<a href="#l6.401"></a><span id="l6.401"> {</span>
<a href="#l6.402"></a><span id="l6.402">   window.openDialog(&quot;chrome://messenger/content/addressbook/abMailListDialog.xul&quot;,</span>
<a href="#l6.403"></a><span id="l6.403">                     &quot;&quot;,</span>
<a href="#l6.404"></a><span id="l6.404">                     &quot;chrome,modal,resizable,centerscreen&quot;,</span>
<a href="#l6.405"></a><span id="l6.405">                     {selectedAB:selectedAB});</span>
<a href="#l6.406"></a><span id="l6.406"> }</span>
<a href="#l6.407"></a><span id="l6.407"> </span>
<a href="#l6.408"></a><span id="l6.408"> function goEditListDialog(abCard, listURI)</span>
<a href="#l6.409"></a><span id="l6.409"> {</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-  var params = {</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+  let params = {</span>
<a href="#l6.412"></a><span id="l6.412">     abCard: abCard,</span>
<a href="#l6.413"></a><span id="l6.413">     listURI: listURI,</span>
<a href="#l6.414"></a><span id="l6.414">     refresh: false, // This is an out param, true if OK in dialog is clicked.</span>
<a href="#l6.415"></a><span id="l6.415">   };</span>
<a href="#l6.416"></a><span id="l6.416"> </span>
<a href="#l6.417"></a><span id="l6.417">   window.openDialog(&quot;chrome://messenger/content/addressbook/abEditListDialog.xul&quot;,</span>
<a href="#l6.418"></a><span id="l6.418">                     &quot;&quot;,</span>
<a href="#l6.419"></a><span id="l6.419">                     &quot;chrome,modal,resizable,centerscreen&quot;,</span>
<a href="#l6.420"></a><span id="l6.420">                     params);</span>
<a href="#l6.421"></a><span id="l6.421"> </span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">-  if (params.refresh)</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+  if (params.refresh) {</span>
<a href="#l6.424"></a><span id="l6.424">     ChangeDirectoryByURI(listURI); // force refresh</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+  }</span>
<a href="#l6.426"></a><span id="l6.426"> }</span>
<a href="#l6.427"></a><span id="l6.427"> </span>
<a href="#l6.428"></a><span id="l6.428"> function goNewCardDialog(selectedAB)</span>
<a href="#l6.429"></a><span id="l6.429"> {</span>
<a href="#l6.430"></a><span id="l6.430">   window.openDialog(&quot;chrome://messenger/content/addressbook/abNewCardDialog.xul&quot;,</span>
<a href="#l6.431"></a><span id="l6.431">                     &quot;&quot;,</span>
<a href="#l6.432"></a><span id="l6.432">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l6.433"></a><span id="l6.433">                     {selectedAB:selectedAB});</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineat">@@ -530,17 +517,16 @@ function goNewCardDialog(selectedAB)</span>
<a href="#l6.435"></a><span id="l6.435"> function goEditCardDialog(abURI, card)</span>
<a href="#l6.436"></a><span id="l6.436"> {</span>
<a href="#l6.437"></a><span id="l6.437">   window.openDialog(&quot;chrome://messenger/content/addressbook/abEditCardDialog.xul&quot;,</span>
<a href="#l6.438"></a><span id="l6.438">                     &quot;&quot;,</span>
<a href="#l6.439"></a><span id="l6.439">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l6.440"></a><span id="l6.440">                     {abURI:abURI, card:card});</span>
<a href="#l6.441"></a><span id="l6.441"> }</span>
<a href="#l6.442"></a><span id="l6.442"> </span>
<a href="#l6.443"></a><span id="l6.443" class="difflineminus">-</span>
<a href="#l6.444"></a><span id="l6.444"> function setSortByMenuItemCheckState(id, value)</span>
<a href="#l6.445"></a><span id="l6.445"> {</span>
<a href="#l6.446"></a><span id="l6.446">     var menuitem = document.getElementById(id);</span>
<a href="#l6.447"></a><span id="l6.447">     if (menuitem) {</span>
<a href="#l6.448"></a><span id="l6.448">       menuitem.setAttribute(&quot;checked&quot;, value);</span>
<a href="#l6.449"></a><span id="l6.449">     }</span>
<a href="#l6.450"></a><span id="l6.450"> }</span>
<a href="#l6.451"></a><span id="l6.451"> </span>
<a href="#l6.452"></a><span id="l6.452" class="difflineat">@@ -552,38 +538,40 @@ function InitViewSortByMenu()</span>
<a href="#l6.453"></a><span id="l6.453">     if (gAbView) {</span>
<a href="#l6.454"></a><span id="l6.454">       sortColumn = gAbView.sortColumn;</span>
<a href="#l6.455"></a><span id="l6.455">       sortDirection = gAbView.sortDirection;</span>
<a href="#l6.456"></a><span id="l6.456">     }</span>
<a href="#l6.457"></a><span id="l6.457"> </span>
<a href="#l6.458"></a><span id="l6.458">     // this approach is necessary to support generic columns that get overlayed.</span>
<a href="#l6.459"></a><span id="l6.459">     var elements = document.getElementsByAttribute(&quot;name&quot;,&quot;sortas&quot;);</span>
<a href="#l6.460"></a><span id="l6.460">     for (var i=0; i&lt;elements.length; i++) {</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineminus">-        var cmd = elements[i].getAttribute(&quot;id&quot;);</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineminus">-        var columnForCmd = cmd.split(&quot;cmd_SortBy&quot;)[1];</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineminus">-        setSortByMenuItemCheckState(cmd, (sortColumn == columnForCmd));</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineplus">+      let cmd = elements[i].getAttribute(&quot;id&quot;);</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineplus">+      let columnForCmd = cmd.split(&quot;cmd_SortBy&quot;)[1];</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineplus">+      setSortByMenuItemCheckState(cmd, (sortColumn == columnForCmd));</span>
<a href="#l6.467"></a><span id="l6.467">     }</span>
<a href="#l6.468"></a><span id="l6.468"> </span>
<a href="#l6.469"></a><span id="l6.469">     setSortByMenuItemCheckState(&quot;sortAscending&quot;, (sortDirection == kDefaultAscending));</span>
<a href="#l6.470"></a><span id="l6.470">     setSortByMenuItemCheckState(&quot;sortDescending&quot;, (sortDirection == kDefaultDescending));</span>
<a href="#l6.471"></a><span id="l6.471"> }</span>
<a href="#l6.472"></a><span id="l6.472"> </span>
<a href="#l6.473"></a><span id="l6.473"> function GenerateAddressFromCard(card)</span>
<a href="#l6.474"></a><span id="l6.474"> {</span>
<a href="#l6.475"></a><span id="l6.475">   if (!card)</span>
<a href="#l6.476"></a><span id="l6.476">     return &quot;&quot;;</span>
<a href="#l6.477"></a><span id="l6.477"> </span>
<a href="#l6.478"></a><span id="l6.478">   var email;</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineplus">+</span>
<a href="#l6.480"></a><span id="l6.480">   if (card.isMailList)</span>
<a href="#l6.481"></a><span id="l6.481">   {</span>
<a href="#l6.482"></a><span id="l6.482">     var directory = GetDirectoryFromURI(card.mailListURI);</span>
<a href="#l6.483"></a><span id="l6.483">     email = directory.description || card.displayName;</span>
<a href="#l6.484"></a><span id="l6.484">   }</span>
<a href="#l6.485"></a><span id="l6.485">   else</span>
<a href="#l6.486"></a><span id="l6.486">     email = card.primaryEmail;</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineplus">+</span>
<a href="#l6.488"></a><span id="l6.488">   return MailServices.headerParser.makeMimeAddress(card.displayName, email);</span>
<a href="#l6.489"></a><span id="l6.489"> }</span>
<a href="#l6.490"></a><span id="l6.490"> </span>
<a href="#l6.491"></a><span id="l6.491"> function GetDirectoryFromURI(uri)</span>
<a href="#l6.492"></a><span id="l6.492"> {</span>
<a href="#l6.493"></a><span id="l6.493">   return MailServices.ab.getDirectory(uri);</span>
<a href="#l6.494"></a><span id="l6.494"> }</span>
<a href="#l6.495"></a><span id="l6.495"> </span>
<a href="#l6.496"></a><span id="l6.496" class="difflineat">@@ -599,31 +587,66 @@ function GetParentDirectoryFromMailingLi</span>
<a href="#l6.497"></a><span id="l6.497">   */</span>
<a href="#l6.498"></a><span id="l6.498">   if (abURIArr.length == 4 &amp;&amp; abURIArr[0] == &quot;moz-abmdbdirectory:&quot; &amp;&amp; abURIArr[3] != &quot;&quot;) {</span>
<a href="#l6.499"></a><span id="l6.499">     return abURIArr[0] + &quot;/&quot; + abURIArr[1] + &quot;/&quot; + abURIArr[2];</span>
<a href="#l6.500"></a><span id="l6.500">   }</span>
<a href="#l6.501"></a><span id="l6.501"> </span>
<a href="#l6.502"></a><span id="l6.502">   return null;</span>
<a href="#l6.503"></a><span id="l6.503"> }</span>
<a href="#l6.504"></a><span id="l6.504"> </span>
<a href="#l6.505"></a><span id="l6.505" class="difflineplus">+/**</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineplus">+ * Return true if the directory pane has focus, otherwise false.</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineplus">+ */</span>
<a href="#l6.508"></a><span id="l6.508"> function DirPaneHasFocus()</span>
<a href="#l6.509"></a><span id="l6.509"> {</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineminus">-  // Returns true if directory pane has the focus. Returns false, otherwise.</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineminus">-  return top.document.commandDispatcher.focusedElement == gDirTree;</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineplus">+  return (top.document.commandDispatcher.focusedElement == gDirTree);</span>
<a href="#l6.513"></a><span id="l6.513"> }</span>
<a href="#l6.514"></a><span id="l6.514"> </span>
<a href="#l6.515"></a><span id="l6.515" class="difflineminus">-function GetSelectedDirectory()</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineplus">+/**</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineplus">+ * Get the selected directory object.</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineplus">+ *</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineplus">+ * @return The object of the currently selected directory</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineplus">+ */</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineplus">+function getSelectedDirectory()</span>
<a href="#l6.522"></a><span id="l6.522"> {</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineplus">+  // Select Addresses Dialog</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineplus">+  if (abList)</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineplus">+    return MailServices.ab.getDirectory(abList.value);</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineplus">+</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineplus">+  // Main Address Book</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineplus">+  if (gDirTree.currentIndex &lt; 0)</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineplus">+    return null;</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineplus">+  return gDirectoryTreeView.getDirectoryAtIndex(gDirTree.currentIndex);</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineplus">+}</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineplus">+</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineplus">+/**</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineplus">+ * Get the URI of the selected directory.</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineplus">+ *</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineplus">+ * @return The URI of the currently selected directory</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineplus">+ */</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineplus">+function getSelectedDirectoryURI()</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineplus">+{</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineplus">+  // Select Addresses Dialog</span>
<a href="#l6.541"></a><span id="l6.541">   if (abList)</span>
<a href="#l6.542"></a><span id="l6.542">     return abList.value;</span>
<a href="#l6.543"></a><span id="l6.543"> </span>
<a href="#l6.544"></a><span id="l6.544" class="difflineplus">+  // Main Address Book</span>
<a href="#l6.545"></a><span id="l6.545">   if (gDirTree.currentIndex &lt; 0)</span>
<a href="#l6.546"></a><span id="l6.546">     return null;</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineplus">+  return gDirectoryTreeView.getDirectoryAtIndex(gDirTree.currentIndex).URI;</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineplus">+}</span>
<a href="#l6.549"></a><span id="l6.549"> </span>
<a href="#l6.550"></a><span id="l6.550" class="difflineminus">-  return gDirectoryTreeView.getDirectoryAtIndex(gDirTree.currentIndex).URI;</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineplus">+/**</span>
<a href="#l6.552"></a><span id="l6.552" class="difflineplus">+ * DEPRECATED legacy function wrapper for addon compatibility;</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineplus">+ * use getSelectedDirectoryURI() instead!</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineplus">+ * Return the URI of the selected directory.</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineplus">+ */</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineplus">+function GetSelectedDirectory()</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineplus">+{</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineplus">+  return getSelectedDirectoryURI();</span>
<a href="#l6.559"></a><span id="l6.559"> }</span>
<a href="#l6.560"></a><span id="l6.560"> </span>
<a href="#l6.561"></a><span id="l6.561"> /**</span>
<a href="#l6.562"></a><span id="l6.562">  * Returns an nsIFile of the directory in which contact photos are stored.</span>
<a href="#l6.563"></a><span id="l6.563">  * This will create the directory if it does not yet exist.</span>
<a href="#l6.564"></a><span id="l6.564">  */</span>
<a href="#l6.565"></a><span id="l6.565"> function getPhotosDir() {</span>
<a href="#l6.566"></a><span id="l6.566">   var file = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineat">@@ -749,11 +772,10 @@ function saneBirthYear(aYear) {</span>
<a href="#l6.568"></a><span id="l6.568"> /**</span>
<a href="#l6.569"></a><span id="l6.569">  * Returns the nearest leap year before aYear.</span>
<a href="#l6.570"></a><span id="l6.570">  */</span>
<a href="#l6.571"></a><span id="l6.571"> function nearestLeap(aYear) {</span>
<a href="#l6.572"></a><span id="l6.572">   for (let year = aYear; year &gt; 0; year--) {</span>
<a href="#l6.573"></a><span id="l6.573">     if (new Date(year, 1, 29).getMonth() == 1)</span>
<a href="#l6.574"></a><span id="l6.574">       return year;</span>
<a href="#l6.575"></a><span id="l6.575">   }</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineminus">-</span>
<a href="#l6.577"></a><span id="l6.577">   return 2000;</span>
<a href="#l6.578"></a><span id="l6.578"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/suite/mailnews/addrbook/addressbook.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/suite/mailnews/addrbook/addressbook.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -188,36 +188,28 @@ function AbClose()</span>
<a href="#l7.4"></a><span id="l7.4"> function AbPrintCardInternal(doPrintPreview, msgType)</span>
<a href="#l7.5"></a><span id="l7.5"> {</span>
<a href="#l7.6"></a><span id="l7.6">   var selectedItems = GetSelectedAbCards();</span>
<a href="#l7.7"></a><span id="l7.7">   var numSelected = selectedItems.length;</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">   if (!numSelected)</span>
<a href="#l7.10"></a><span id="l7.10">     return;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  var uri = GetSelectedDirectory();</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  if (!uri)</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-    return;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  let statusFeedback;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  statusFeedback = Components.classes[&quot;@mozilla.org/messenger/statusfeedback;1&quot;].createInstance();</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  statusFeedback = statusFeedback.QueryInterface(Components.interfaces.nsIMsgStatusFeedback);</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-   var statusFeedback;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-   statusFeedback = Components.classes[&quot;@mozilla.org/messenger/statusfeedback;1&quot;].createInstance();</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-   statusFeedback = statusFeedback.QueryInterface(Components.interfaces.nsIMsgStatusFeedback);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-   var selectionArray = new Array(numSelected);</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+  let selectionArray = new Array(numSelected);</span>
<a href="#l7.25"></a><span id="l7.25"> </span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-   var totalCard = 0;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-   for (var i = 0; i &lt; numSelected; i++)</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-   {</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-     var card = selectedItems[i];</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-     var printCardUrl = CreatePrintCardUrl(card);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-     if (printCardUrl)</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-     {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-        selectionArray[totalCard++] = printCardUrl;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-     }</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  for (let i = 0; i &lt; numSelected; i++) {</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+    let card = selectedItems[i];</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+    let printCardUrl = CreatePrintCardUrl(card);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+    if (printCardUrl) {</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+      selectionArray.push(printCardUrl);</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+    }</span>
<a href="#l7.42"></a><span id="l7.42">   }</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">   printEngineWindow = window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;,</span>
<a href="#l7.45"></a><span id="l7.45">                                          &quot;&quot;,</span>
<a href="#l7.46"></a><span id="l7.46">                                          &quot;chrome,dialog=no,all&quot;,</span>
<a href="#l7.47"></a><span id="l7.47">                                           totalCard, selectionArray, statusFeedback,</span>
<a href="#l7.48"></a><span id="l7.48">                                           doPrintPreview, msgType);</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50" class="difflineat">@@ -236,17 +228,17 @@ function AbPrintPreviewCard()</span>
<a href="#l7.51"></a><span id="l7.51"> </span>
<a href="#l7.52"></a><span id="l7.52"> function CreatePrintCardUrl(card)</span>
<a href="#l7.53"></a><span id="l7.53"> {</span>
<a href="#l7.54"></a><span id="l7.54">   return &quot;data:application/xml;base64,&quot; + card.translateTo(&quot;base64xml&quot;);</span>
<a href="#l7.55"></a><span id="l7.55"> }</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57"> function AbPrintAddressBookInternal(doPrintPreview, msgType)</span>
<a href="#l7.58"></a><span id="l7.58"> {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-  var uri = GetSelectedDirectory();</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  let uri = getSelectedDirectoryURI();</span>
<a href="#l7.61"></a><span id="l7.61">   if (!uri)</span>
<a href="#l7.62"></a><span id="l7.62">     return;</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64">   var statusFeedback;</span>
<a href="#l7.65"></a><span id="l7.65"> 	statusFeedback = Components.classes[&quot;@mozilla.org/messenger/statusfeedback;1&quot;].createInstance();</span>
<a href="#l7.66"></a><span id="l7.66"> 	statusFeedback = statusFeedback.QueryInterface(Components.interfaces.nsIMsgStatusFeedback);</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68">   /*</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineat">@@ -274,24 +266,24 @@ function AbPrintPreviewAddressBook()</span>
<a href="#l7.70"></a><span id="l7.70"> {</span>
<a href="#l7.71"></a><span id="l7.71">   AbPrintAddressBookInternal(true, Components.interfaces.nsIMsgPrintEngine.MNAB_PRINTPREVIEW_ADDRBOOK);</span>
<a href="#l7.72"></a><span id="l7.72"> }</span>
<a href="#l7.73"></a><span id="l7.73"> </span>
<a href="#l7.74"></a><span id="l7.74"> /**</span>
<a href="#l7.75"></a><span id="l7.75">  * Export the currently selected addressbook.</span>
<a href="#l7.76"></a><span id="l7.76">  */</span>
<a href="#l7.77"></a><span id="l7.77"> function AbExportSelection() {</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-  let selectedABURI = GetSelectedDirectory();</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-  if (!selectedABURI)</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+  let selectedDirURI = getSelectedDirectoryURI();</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+  if (!selectedDirURI)</span>
<a href="#l7.82"></a><span id="l7.82">     return;</span>
<a href="#l7.83"></a><span id="l7.83"> </span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-  if (selectedABURI == (kAllDirectoryRoot + &quot;?&quot;))</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+  if (selectedDirURI == (kAllDirectoryRoot + &quot;?&quot;))</span>
<a href="#l7.86"></a><span id="l7.86">     AbExportAll();</span>
<a href="#l7.87"></a><span id="l7.87">   else</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-    AbExport(selectedABURI);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    AbExport(selectedDirURI);</span>
<a href="#l7.90"></a><span id="l7.90"> }</span>
<a href="#l7.91"></a><span id="l7.91"> </span>
<a href="#l7.92"></a><span id="l7.92"> /**</span>
<a href="#l7.93"></a><span id="l7.93">  * Export all found addressbooks, each in a separate file.</span>
<a href="#l7.94"></a><span id="l7.94">  */</span>
<a href="#l7.95"></a><span id="l7.95"> function AbExportAll()</span>
<a href="#l7.96"></a><span id="l7.96"> {</span>
<a href="#l7.97"></a><span id="l7.97">   let directories = MailServices.ab.directories;</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineat">@@ -304,25 +296,25 @@ function AbExportAll()</span>
<a href="#l7.99"></a><span id="l7.99"> </span>
<a href="#l7.100"></a><span id="l7.100">     AbExport(directory.URI);</span>
<a href="#l7.101"></a><span id="l7.101">   }</span>
<a href="#l7.102"></a><span id="l7.102"> }</span>
<a href="#l7.103"></a><span id="l7.103"> </span>
<a href="#l7.104"></a><span id="l7.104"> /**</span>
<a href="#l7.105"></a><span id="l7.105">  * Export the specified addressbook to a file.</span>
<a href="#l7.106"></a><span id="l7.106">  *</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">- * @param aSelectedABURI  The URI if the addressbook to export.</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+ * @param aSelectedDirURI  The URI of the addressbook to export.</span>
<a href="#l7.109"></a><span id="l7.109">  */</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-function AbExport(aSelectedABURI)</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+function AbExport(aSelectedDirURI)</span>
<a href="#l7.112"></a><span id="l7.112"> {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-  if (!aSelectedABURI)</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+  if (!aSelectedDirURI)</span>
<a href="#l7.115"></a><span id="l7.115">     return;</span>
<a href="#l7.116"></a><span id="l7.116"> </span>
<a href="#l7.117"></a><span id="l7.117">   try {</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-    let directory = GetDirectoryFromURI(aSelectedABURI);</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+    let directory = GetDirectoryFromURI(aSelectedDirURI);</span>
<a href="#l7.120"></a><span id="l7.120">     MailServices.ab.exportAddressBook(window, directory);</span>
<a href="#l7.121"></a><span id="l7.121">   }</span>
<a href="#l7.122"></a><span id="l7.122">   catch (ex) {</span>
<a href="#l7.123"></a><span id="l7.123">     var message;</span>
<a href="#l7.124"></a><span id="l7.124">     switch (ex.result) {</span>
<a href="#l7.125"></a><span id="l7.125">       case Components.results.NS_ERROR_FILE_ACCESS_DENIED:</span>
<a href="#l7.126"></a><span id="l7.126">         message = gAddressBookBundle.getString(&quot;failedToExportMessageFileAccessDenied&quot;);</span>
<a href="#l7.127"></a><span id="l7.127">         break;</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineat">@@ -341,17 +333,17 @@ function AbExport(aSelectedABURI)</span>
<a href="#l7.129"></a><span id="l7.129"> }</span>
<a href="#l7.130"></a><span id="l7.130"> </span>
<a href="#l7.131"></a><span id="l7.131"> function SetStatusText(total)</span>
<a href="#l7.132"></a><span id="l7.132"> {</span>
<a href="#l7.133"></a><span id="l7.133">   if (!gStatusText)</span>
<a href="#l7.134"></a><span id="l7.134">     gStatusText = document.getElementById('statusText');</span>
<a href="#l7.135"></a><span id="l7.135"> </span>
<a href="#l7.136"></a><span id="l7.136">   try {</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-    var statusText;</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+    let statusText;</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140">     if (gSearchInput.value) {</span>
<a href="#l7.141"></a><span id="l7.141">       if (total == 0) {</span>
<a href="#l7.142"></a><span id="l7.142">         statusText = gAddressBookBundle.getString(&quot;noMatchFound&quot;);</span>
<a href="#l7.143"></a><span id="l7.143">       } else {</span>
<a href="#l7.144"></a><span id="l7.144">         statusText = PluralForm</span>
<a href="#l7.145"></a><span id="l7.145">           .get(total, gAddressBookBundle.getString(&quot;matchesFound1&quot;))</span>
<a href="#l7.146"></a><span id="l7.146">           .replace(&quot;#1&quot;, total);</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineat">@@ -369,37 +361,38 @@ function SetStatusText(total)</span>
<a href="#l7.148"></a><span id="l7.148"> </span>
<a href="#l7.149"></a><span id="l7.149"> function AbResultsPaneDoubleClick(card)</span>
<a href="#l7.150"></a><span id="l7.150"> {</span>
<a href="#l7.151"></a><span id="l7.151">   AbEditCard(card);</span>
<a href="#l7.152"></a><span id="l7.152"> }</span>
<a href="#l7.153"></a><span id="l7.153"> </span>
<a href="#l7.154"></a><span id="l7.154"> function onAdvancedAbSearch()</span>
<a href="#l7.155"></a><span id="l7.155"> {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-  var selectedABURI = GetSelectedDirectory();</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-  if (!selectedABURI) return;</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+  let selectedDirURI = getSelectedDirectoryURI();</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+  if (!selectedDirURI)</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+    return;</span>
<a href="#l7.161"></a><span id="l7.161"> </span>
<a href="#l7.162"></a><span id="l7.162">   var existingSearchWindow = Services.wm.getMostRecentWindow(&quot;mailnews:absearch&quot;);</span>
<a href="#l7.163"></a><span id="l7.163">   if (existingSearchWindow)</span>
<a href="#l7.164"></a><span id="l7.164">     existingSearchWindow.focus();</span>
<a href="#l7.165"></a><span id="l7.165">   else</span>
<a href="#l7.166"></a><span id="l7.166">     window.openDialog(&quot;chrome://messenger/content/ABSearchDialog.xul&quot;, &quot;&quot;,</span>
<a href="#l7.167"></a><span id="l7.167">                       &quot;chrome,resizable,status,centerscreen,dialog=no&quot;,</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-                      {directory: selectedABURI});</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+                      {directory: selectedDirURI});</span>
<a href="#l7.170"></a><span id="l7.170"> }</span>
<a href="#l7.171"></a><span id="l7.171"> </span>
<a href="#l7.172"></a><span id="l7.172"> function onEnterInSearchBar()</span>
<a href="#l7.173"></a><span id="l7.173"> {</span>
<a href="#l7.174"></a><span id="l7.174">   ClearCardViewPane();</span>
<a href="#l7.175"></a><span id="l7.175"> </span>
<a href="#l7.176"></a><span id="l7.176">   if (!gQueryURIFormat) {</span>
<a href="#l7.177"></a><span id="l7.177">     // Get model query from pref, without preceding &quot;?&quot;, so we need to add it again</span>
<a href="#l7.178"></a><span id="l7.178">     gQueryURIFormat = &quot;?&quot; + getModelQuery(&quot;mail.addr_book.quicksearchquery.format&quot;);</span>
<a href="#l7.179"></a><span id="l7.179">   }</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-  var searchURI = GetSelectedDirectory();</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+  let searchURI = getSelectedDirectoryURI();</span>
<a href="#l7.182"></a><span id="l7.182">   if (!searchURI) return;</span>
<a href="#l7.183"></a><span id="l7.183"> </span>
<a href="#l7.184"></a><span id="l7.184">   /*</span>
<a href="#l7.185"></a><span id="l7.185">    XXX todo, handle the case where the LDAP url</span>
<a href="#l7.186"></a><span id="l7.186">    already has a query, like</span>
<a href="#l7.187"></a><span id="l7.187">    moz-abldapdirectory://nsdirectory.netscape.com:389/ou=People,dc=netscape,dc=com?(or(Department,=,Applications))</span>
<a href="#l7.188"></a><span id="l7.188">   */</span>
<a href="#l7.189"></a><span id="l7.189">   if (gSearchInput.value != &quot;&quot;) {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

