<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2168:79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2" />
<meta property="og:url" content="/comm-central/rev/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2" />
<meta property="og:description" content="Bug 481431 Provide a centralised alert/message service in mailnews to allow different front-end displays for alerts. r=bienvenu,sr=Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2">shortlog</a> |
<a href="/comm-central/log/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2">files</a> |
changeset |
<a href="/comm-central/raw-rev/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2">raw</a>  | <a href="/comm-central/archive/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=481431">Bug 481431</a> Provide a centralised alert/message service in mailnews to allow different front-end displays for alerts. r=bienvenu,sr=Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#32;&#66;&#97;&#110;&#110;&#101;&#114;&#32;&#60;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#115;&#116;&#97;&#110;&#100;&#97;&#114;&#100;&#56;&#46;&#112;&#108;&#117;&#115;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 10 Mar 2009 09:08:50 +0000</td></tr>

<tr>
 <td>changeset 2168</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2">79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2</a></td>
</tr>



<tr>
<td>parent 2167</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bb5b6688c2ba2c7a296efebe9083c13a75c95440">bb5b6688c2ba2c7a296efebe9083c13a75c95440</a>
</td>
</tr>

<tr>
<td>child 2169</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b2161ed4236af25bbeb62f0f4df3ac6c9869d74f">b2161ed4236af25bbeb62f0f4df3ac6c9869d74f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2">1756</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 10 Mar 2009 09:30:39 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c55d44c0a936 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c55d44c0a936ff3c39a32ce39e8af375961ec1f6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c55d44c0a936ff3c39a32ce39e8af375961ec1f6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c55d44c0a936ff3c39a32ce39e8af375961ec1f6&newProject=comm-central&newRevision=bb5b6688c2ba2c7a296efebe9083c13a75c95440&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c55d44c0a936ff3c39a32ce39e8af375961ec1f6&newProject=comm-central&newRevision=bb5b6688c2ba2c7a296efebe9083c13a75c95440&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c55d44c0a936ff3c39a32ce39e8af375961ec1f6&newProject=comm-central&newRevision=bb5b6688c2ba2c7a296efebe9083c13a75c95440&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a>, <a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=481431">481431</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=481431">Bug 481431</a> Provide a centralised alert/message service in mailnews to allow different front-end displays for alerts. r=bienvenu,sr=Neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/Makefile.in">mailnews/base/public/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/Makefile.in">file</a> |
<a href="/comm-central/annotate/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/Makefile.in">annotate</a> |
<a href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/Makefile.in">diff</a> |
<a href="/comm-central/comparison/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/Makefile.in">comparison</a> |
<a href="/comm-central/log/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/nsIMsgMailSession.idl">mailnews/base/public/nsIMsgMailSession.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/nsIMsgMailSession.idl">file</a> |
<a href="/comm-central/annotate/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/nsIMsgMailSession.idl">annotate</a> |
<a href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/nsIMsgMailSession.idl">diff</a> |
<a href="/comm-central/comparison/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/nsIMsgMailSession.idl">comparison</a> |
<a href="/comm-central/log/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/nsIMsgMailSession.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/nsIMsgUserFeedbackListener.idl">mailnews/base/public/nsIMsgUserFeedbackListener.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/nsIMsgUserFeedbackListener.idl">file</a> |
<a href="/comm-central/annotate/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/nsIMsgUserFeedbackListener.idl">annotate</a> |
<a href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/nsIMsgUserFeedbackListener.idl">diff</a> |
<a href="/comm-central/comparison/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/nsIMsgUserFeedbackListener.idl">comparison</a> |
<a href="/comm-central/log/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/public/nsIMsgUserFeedbackListener.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/src/nsMsgMailSession.cpp">mailnews/base/src/nsMsgMailSession.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/src/nsMsgMailSession.cpp">file</a> |
<a href="/comm-central/annotate/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/src/nsMsgMailSession.cpp">annotate</a> |
<a href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/src/nsMsgMailSession.cpp">diff</a> |
<a href="/comm-central/comparison/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/src/nsMsgMailSession.cpp">comparison</a> |
<a href="/comm-central/log/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/src/nsMsgMailSession.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/src/nsMsgMailSession.h">mailnews/base/src/nsMsgMailSession.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/src/nsMsgMailSession.h">file</a> |
<a href="/comm-central/annotate/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/src/nsMsgMailSession.h">annotate</a> |
<a href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/src/nsMsgMailSession.h">diff</a> |
<a href="/comm-central/comparison/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/src/nsMsgMailSession.h">comparison</a> |
<a href="/comm-central/log/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/src/nsMsgMailSession.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">file</a> |
<a href="/comm-central/annotate/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">annotate</a> |
<a href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">diff</a> |
<a href="/comm-central/comparison/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">comparison</a> |
<a href="/comm-central/log/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/util/nsMsgProtocol.cpp">mailnews/base/util/nsMsgProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/util/nsMsgProtocol.cpp">file</a> |
<a href="/comm-central/annotate/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/util/nsMsgProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/util/nsMsgProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/util/nsMsgProtocol.cpp">comparison</a> |
<a href="/comm-central/log/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/base/util/nsMsgProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/79f7c64d3252bb48749aa466c42f5b8f1d0eb0d2/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -97,12 +97,13 @@ XPIDLSRCS	= \</span>
<a href="#l1.4"></a><span id="l1.4"> 		nsIMsgMdnGenerator.idl	        \</span>
<a href="#l1.5"></a><span id="l1.5"> 		nsISpamSettings.idl	        \</span>
<a href="#l1.6"></a><span id="l1.6"> 		nsIMapiRegistry.idl \</span>
<a href="#l1.7"></a><span id="l1.7"> 		nsIMsgCustomColumnHandler.idl \</span>
<a href="#l1.8"></a><span id="l1.8"> 		nsIMsgShutdown.idl \</span>
<a href="#l1.9"></a><span id="l1.9"> 		nsMsgFolderFlags.idl \</span>
<a href="#l1.10"></a><span id="l1.10"> 		nsMsgMessageFlags.idl \</span>
<a href="#l1.11"></a><span id="l1.11"> 		nsIStopwatch.idl \</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+		nsIMsgUserFeedbackListener.idl \</span>
<a href="#l1.13"></a><span id="l1.13"> 		$(NULL)</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l1.16"></a><span id="l1.16"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgMailSession.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgMailSession.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -47,18 +47,19 @@</span>
<a href="#l2.4"></a><span id="l2.4">  */</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIFolderListener.idl&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsIMsgWindow.idl&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsIAtom.idl&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> interface nsIFile;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+interface nsIMsgUserFeedbackListener;</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-[scriptable, uuid(11fd2852-d7f3-402c-9d2b-6dd206e7e8cd)]</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+[scriptable, uuid(0dd3e1d2-608c-4bbc-a9fa-c70354424286)]</span>
<a href="#l2.16"></a><span id="l2.16"> interface nsIMsgMailSession : nsISupports {</span>
<a href="#l2.17"></a><span id="l2.17">   void Shutdown();</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">   /**</span>
<a href="#l2.20"></a><span id="l2.20">    * Adds a listener to be notified when folders update.</span>
<a href="#l2.21"></a><span id="l2.21">    *</span>
<a href="#l2.22"></a><span id="l2.22">    * @param  aListener    The listener to add.</span>
<a href="#l2.23"></a><span id="l2.23">    * @param  aNotifyFlags A combination of flags detailing on which operations</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineat">@@ -68,17 +69,44 @@ interface nsIMsgMailSession : nsISupport</span>
<a href="#l2.25"></a><span id="l2.25">   void AddFolderListener(in nsIFolderListener aListener,</span>
<a href="#l2.26"></a><span id="l2.26">                          in folderListenerNotifyFlagValue aNotifyFlags);</span>
<a href="#l2.27"></a><span id="l2.27">   /**</span>
<a href="#l2.28"></a><span id="l2.28">    * Removes a listener from the folder notification list.</span>
<a href="#l2.29"></a><span id="l2.29">    *</span>
<a href="#l2.30"></a><span id="l2.30">    * @param  aListener    The listener to remove.</span>
<a href="#l2.31"></a><span id="l2.31">    */</span>
<a href="#l2.32"></a><span id="l2.32">   void RemoveFolderListener(in nsIFolderListener aListener);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  </span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  /**</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+   * Adds a listener to be notified of alert or prompt style feedback that</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+   * should go to the user.</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+   *</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+   * @param  aListener    The listener to add.</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+   */</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  void addUserFeedbackListener(in nsIMsgUserFeedbackListener aListener);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  /**</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+   * Removes a user feedback listener.</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+   *</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+   * @param  aListener    The listener to remove.</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+   */</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+  void removeUserFeedbackListener(in nsIMsgUserFeedbackListener aListener);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+  /**</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+   * Call to alert the listeners of the message. If there are no listeners,</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+   * or the listeners do not handle the alert, then this function will present</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+   * the user with a modal dialog if aMsgWindow isn't null.</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+   *</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+   * @param aMessage    The localized message string to alert.</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+   * @param aMsgWindow  Optional message window argument, if the original</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+   *                    message window for the action which caused the alert</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+   *                    is known.</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+   */</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  void alertUser(in AString aMessage, [optional] in nsIMsgWindow aMsgWindow);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+</span>
<a href="#l2.62"></a><span id="l2.62">   readonly attribute nsIMsgWindow topmostMsgWindow;</span>
<a href="#l2.63"></a><span id="l2.63">   void AddMsgWindow(in nsIMsgWindow msgWindow);</span>
<a href="#l2.64"></a><span id="l2.64">   void RemoveMsgWindow(in nsIMsgWindow msgWindow);</span>
<a href="#l2.65"></a><span id="l2.65">   boolean IsFolderOpenInWindow(in nsIMsgFolder folder);</span>
<a href="#l2.66"></a><span id="l2.66"> </span>
<a href="#l2.67"></a><span id="l2.67">   string ConvertMsgURIToMsgURL(in string  aURI, in nsIMsgWindow aMsgWindow);</span>
<a href="#l2.68"></a><span id="l2.68">   nsIFile getDataFilesDir(in string dirName);</span>
<a href="#l2.69"></a><span id="l2.69"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mailnews/base/public/nsIMsgUserFeedbackListener.idl</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,62 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* -*- Mode: IDL; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ *</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ *</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ * License.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+ *</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+ * The Original Code is MailNews Prompt Service.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ *</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ * Mozilla Messaging.</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+ *</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ *   Mark Banner &lt;bugzilla@standard8.plus.com&gt;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+ *</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+ *</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+interface nsIMsgWindow;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+/**</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+ * Implement this interface to subscribe to errors and warnings passed out via</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+ * nsIMsgMailSession.</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+ */</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+[scriptable, uuid(a52874d3-22ca-41da-9837-b9f9791234a9)]</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+interface nsIMsgUserFeedbackListener : nsISupports {</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+  /**</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+   * Called when an alert from a protocol level implementation is generated.</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+   *</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+   * @param aMessage    The localized message string to alert.</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+   * @param aMsgWindow  Optional message window argument, if the original</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+   *                    message window for the action which caused the alert</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+   *                    is known.</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+   * @return            True if you serviced the alert and it does not need</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+   *                    to be prompted to the user separately.</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+   *                    Note: The caller won't prompt if aMsgWindow is null,</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+   *                    regardless of the value returned.</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+   */</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+  boolean onAlert(in AString aMessage, [optional] in nsIMsgWindow aMsgWindow);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -48,16 +48,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsIAppStartup.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsXPFEComponentsCID.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsIAppShellService.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsAppShellCID.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsIWindowMediator.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+#include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> NS_IMPL_THREADSAFE_ADDREF(nsMsgMailSession)</span>
<a href="#l4.15"></a><span id="l4.15"> NS_IMPL_THREADSAFE_RELEASE(nsMsgMailSession)</span>
<a href="#l4.16"></a><span id="l4.16"> NS_INTERFACE_MAP_BEGIN(nsMsgMailSession)</span>
<a href="#l4.17"></a><span id="l4.17">   NS_INTERFACE_MAP_ENTRY(nsIMsgMailSession)</span>
<a href="#l4.18"></a><span id="l4.18">   NS_INTERFACE_MAP_ENTRY(nsIFolderListener)</span>
<a href="#l4.19"></a><span id="l4.19">   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIMsgMailSession)</span>
<a href="#l4.20"></a><span id="l4.20"> NS_INTERFACE_MAP_END_THREADSAFE</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -197,16 +198,83 @@ NS_IMETHODIMP nsMsgMailSession::OnItemRe</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23"> NS_IMETHODIMP nsMsgMailSession::OnItemEvent(nsIMsgFolder *aFolder,</span>
<a href="#l4.24"></a><span id="l4.24">                                             nsIAtom *aEvent)</span>
<a href="#l4.25"></a><span id="l4.25"> {</span>
<a href="#l4.26"></a><span id="l4.26">   NOTIFY_FOLDER_LISTENERS(event, OnItemEvent, (aFolder, aEvent));</span>
<a href="#l4.27"></a><span id="l4.27">   return NS_OK;</span>
<a href="#l4.28"></a><span id="l4.28"> }</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+nsMsgMailSession::AddUserFeedbackListener(nsIMsgUserFeedbackListener *aListener)</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+{</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  PRInt32 index = mFeedbackListeners.IndexOf(aListener);</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  NS_ASSERTION(index == -1, &quot;tried to add duplicate listener&quot;);</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  if (index == -1)</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    mFeedbackListeners.AppendElement(aListener);</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+}</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+nsMsgMailSession::RemoveUserFeedbackListener(nsIMsgUserFeedbackListener *aListener)</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+{</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  PRInt32 index = mFeedbackListeners.IndexOf(aListener);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  NS_ASSERTION(index != -1, &quot;removing non-existent listener&quot;);</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  if (index != -1)</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    mFeedbackListeners.RemoveElementAt(index);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+}</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+nsMsgMailSession::AlertUser(const nsAString &amp;aMessage, nsIMsgWindow *aMsgWindow)</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+{</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  PRBool listenersNotified = PR_FALSE;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgUserFeedbackListener&gt; &gt;::ForwardIterator iter(mFeedbackListeners);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  nsCOMPtr&lt;nsIMsgUserFeedbackListener&gt; listener;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  while (iter.HasMore())</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  {</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+    PRBool notified = PR_FALSE;</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+    listener = iter.GetNext();</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+    listener-&gt;OnAlert(aMessage, aMsgWindow, &amp;notified);</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    listenersNotified = listenersNotified || notified;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  }</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  // If the listeners notified the user, then we don't need to.</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  // If we haven't got a message window, then the error was a generated as a</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  // result of background activity (e.g. autosync, biff, etc), and hence we</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+  // shouldn't prompt either.</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  if (listenersNotified || !aMsgWindow)</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+    return NS_OK;</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  aMsgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+  if (!dialog) // if we didn't get one, use the default....</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+    nsresult rv;</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch =</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+      do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv);</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+    wwatch-&gt;GetNewPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+  }</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+  if (dialog)</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+    return dialog-&gt;Alert(nsnull, PromiseFlatString(aMessage).get());</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+}</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+</span>
<a href="#l4.97"></a><span id="l4.97"> nsresult nsMsgMailSession::GetTopmostMsgWindow(nsIMsgWindow* *aMsgWindow)</span>
<a href="#l4.98"></a><span id="l4.98"> {</span>
<a href="#l4.99"></a><span id="l4.99">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l4.100"></a><span id="l4.100">   </span>
<a href="#l4.101"></a><span id="l4.101">   *aMsgWindow = nsnull;</span>
<a href="#l4.102"></a><span id="l4.102">  </span>
<a href="#l4.103"></a><span id="l4.103">   PRUint32 count = mWindows.Count();</span>
<a href="#l4.104"></a><span id="l4.104"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsMsgMailSession.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgMailSession.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -46,16 +46,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIMsgShutdown.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIMsgProgress.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+#include &quot;nsIMsgUserFeedbackListener.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14"> ///////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.15"></a><span id="l5.15"> // The mail session is a replacement for the old 4.x MSG_Master object. It contains</span>
<a href="#l5.16"></a><span id="l5.16"> // mail session generic information such as the user's current mail identity, ....</span>
<a href="#l5.17"></a><span id="l5.17"> // I'm starting this off as an empty interface and as people feel they need to</span>
<a href="#l5.18"></a><span id="l5.18"> // add more information to it, they can. I think this is a better approach than </span>
<a href="#l5.19"></a><span id="l5.19"> // trying to port over the old MSG_Master in its entirety as that had a lot of </span>
<a href="#l5.20"></a><span id="l5.20"> // cruft in it....</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -90,17 +91,18 @@ protected:</span>
<a href="#l5.22"></a><span id="l5.22">       return mListener == aListener;</span>
<a href="#l5.23"></a><span id="l5.23">     }</span>
<a href="#l5.24"></a><span id="l5.24">     int operator==(const folderListener &amp;aListener) const {</span>
<a href="#l5.25"></a><span id="l5.25">       return mListener == aListener.mListener &amp;&amp;</span>
<a href="#l5.26"></a><span id="l5.26">              mNotifyFlags == aListener.mNotifyFlags;</span>
<a href="#l5.27"></a><span id="l5.27">     }</span>
<a href="#l5.28"></a><span id="l5.28">   };</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  nsTObserverArray&lt;folderListener&gt; mListeners; </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  nsTObserverArray&lt;folderListener&gt; mListeners;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgUserFeedbackListener&gt; &gt; mFeedbackListeners;</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34">   nsCOMArray&lt;nsIMsgWindow&gt; mWindows;</span>
<a href="#l5.35"></a><span id="l5.35">   // stick this here temporarily</span>
<a href="#l5.36"></a><span id="l5.36">   nsCOMPtr &lt;nsIMsgWindow&gt; m_temporaryMsgWindow;</span>
<a href="#l5.37"></a><span id="l5.37"> };</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39"> /********************************************************************************/</span>
<a href="#l5.40"></a><span id="l5.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,259 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+/*</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * Test suite for nsMsgMailSession functions relating to alerts and their</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ * listeners.</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ */</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+// This allows us to check that we get alerts at the right time without</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+// involking the UI.</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+var prompts = {</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  mDialogTitle: null,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  mText: null,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  // not part of the nsIPrompt interface, just makes it easier to test.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+  reset: function() {</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+    this.mDialogTitle = null;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+    this.mText = null;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  },</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  // nsIPrompt</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  alert: function(aDialogTitle, aText) {</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+    do_check_eq(this.mDialogTitle, null);</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+    do_check_eq(this.mText, null);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+    this.mDialogTitle = aDialogTitle;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+    this.mText = aText;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  },</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  alertCheck: function(aDialogTitle, aText, aCheckMsg, aCheckState) {},</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  </span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  confirm: function(aDialogTitle, aText) {},</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  </span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  confirmCheck: function(aDialogTitle, aText, aCheckMsg, aCheckState) {},</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  </span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+  confirmEx: function(aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+		      aButton1Title, aButton2Title, aCheckMsg, aCheckState) {},</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  </span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+  prompt: function(aDialogTitle, aText, aValue, aCheckMsg, aCheckState) {},</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+  </span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+  promptUsernameAndPassword: function(aDialogTitle, aText, aUsername,</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+				      aPassword, aCheckMsg, aCheckState) {},</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+  promptPassword: function(aDialogTitle, aText, aPassword, aCheckMsg,</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+			   aCheckState) {},</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+  </span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  select: function(aDialogTitle, aText, aCount, aSelectList,</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+		   aOutSelection) {},</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  </span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+  QueryInterface: function(iid) {</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+    if (iid.equals(Components.interfaces.nsIPrompt)</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+     || iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+      return this;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+  </span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+    throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  }</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+};</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+var WindowWatcher = {</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  getNewPrompter: function(aParent) {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+    return prompts;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  },</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  getNewAuthPrompter: function(aParent) {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+    return prompts;</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  },</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  QueryInterface: function(iid) {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+    if (iid.equals(Ci.nsIWindowWatcher) || iid.equals(Ci.nsISupports)) {</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+      return this;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+    }</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+    throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+  }</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+};</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+var WindowWatcherFactory = {</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+  createInstance: function createInstance(outer, iid) {</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+    if (outer != null)</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+      throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+    return WindowWatcher.QueryInterface(iid);</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  }</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+};</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+Components.manager.QueryInterface(Components.interfaces.nsIComponentRegistrar)</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+          .registerFactory(Components.ID(&quot;{1dfeb90a-2193-45d5-9cb8-864928b2af55}&quot;),</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+			   &quot;Fake Window Watcher&quot;,</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+			   &quot;@mozilla.org/embedcomp/window-watcher;1&quot;,</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+			   WindowWatcherFactory);</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+var msgWindow = {</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  get promptDialog() {</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+    return prompts;</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  },</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+  QueryInterface: function(iid) {</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+    if (iid.equals(Ci.nsIMsgWindow) || iid.equals(Ci.nsISupports)) {</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+      return this;</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+    }</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+    throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+  }</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+};</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+function alertListener() {}</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+alertListener.prototype = {</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+  mReturn: false,</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+  mMessage: null,</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  mMsgWindow: null,</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+  reset: function () {</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+    this.mMessage = null;</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+    this.mMsgWindow = null;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+  },</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+  onAlert: function (aMessage, aMsgWindow) {</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+    do_check_eq(this.mMessage, null);</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+    do_check_eq(this.mMsgWindow, null);</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+    this.mMessage = aMessage;</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+    this.mMsgWindow = aMsgWindow;</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+    return this.mReturn;</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+  }</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+};</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+function run_test()</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+{</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+  var mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+    .getService(Ci.nsIMsgMailSession);</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+  // Test - No listeners, check alert tries to alert the user.</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+  prompts.reset();</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+  mailSession.alertUser(&quot;test message&quot;, msgWindow);</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+  // The dialog title doesn't get set at the moment.</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+  do_check_eq(prompts.mText, &quot;test message&quot;);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+  // Test - No listeners and no msgWindow, check no alerts.</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+  prompts.reset();</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+  mailSession.alertUser(&quot;test no message&quot;, null);</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+  // The dialog title doesn't get set at the moment.</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+  do_check_eq(prompts.mText, null);</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+  // Test - One listener, returning false (prompt should still happen).</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+  prompts.reset();</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+  var listener1 = new alertListener();</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+  listener1.mReturn = false;</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+  mailSession.addUserFeedbackListener(listener1);</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+  mailSession.alertUser(&quot;message test&quot;, msgWindow);</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+  do_check_eq(prompts.mText, &quot;message test&quot;);</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+  do_check_eq(listener1.mMessage, &quot;message test&quot;);</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+  do_check_neq(listener1.mMsgWindow, null);</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+  // Test - One listener, returning false, no msg window (prompt shouldn't</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+  //        happen).</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+  prompts.reset();</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+  listener1.reset();</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+  mailSession.alertUser(&quot;message test no prompt&quot;, null);</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+  do_check_eq(prompts.mText, null);</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+  do_check_eq(listener1.mMessage, &quot;message test no prompt&quot;);</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+  do_check_eq(listener1.mMsgWindow, null);</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+  // Test - Two listeners, both returning false (prompt should happen).</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+  prompts.reset();</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+  listener1.reset();</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+  var listener2 = new alertListener();</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+  listener2.mReturn = false;</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+  mailSession.addUserFeedbackListener(listener2);</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+  mailSession.alertUser(&quot;two listeners&quot;, msgWindow);</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+  do_check_eq(prompts.mText, &quot;two listeners&quot;);</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+  do_check_eq(listener1.mMessage, &quot;two listeners&quot;);</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+  do_check_neq(listener1.mMsgWindow, null);</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+  do_check_eq(listener2.mMessage, &quot;two listeners&quot;);</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+  do_check_neq(listener2.mMsgWindow, null);</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+  // Test - Two listeners, one returning true (prompt shouldn't happen).</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+  prompts.reset();</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+  listener1.reset();</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+  listener2.reset();</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+  listener2.mReturn = true;</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+  mailSession.alertUser(&quot;no prompt&quot;, msgWindow);</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+  do_check_eq(prompts.mText, null);</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+  do_check_eq(listener1.mMessage, &quot;no prompt&quot;);</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+  do_check_neq(listener1.mMsgWindow, null);</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+  do_check_eq(listener2.mMessage, &quot;no prompt&quot;);</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+  do_check_neq(listener2.mMsgWindow, null);</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+  // Test - Remove a listener.</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+  prompts.reset();</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+  listener1.reset();</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+  listener2.reset();</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+  mailSession.removeUserFeedbackListener(listener1);</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+  mailSession.alertUser(&quot;remove listener&quot;, msgWindow);</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+  do_check_eq(prompts.mText, null);</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+  do_check_eq(listener1.mMessage, null);</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+  do_check_eq(listener1.mMsgWindow, null);</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+  do_check_eq(listener2.mMessage, &quot;remove listener&quot;);</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+  do_check_neq(listener2.mMsgWindow, null);</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+  // Test - Remove the other listener.</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+  prompts.reset();</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+  listener1.reset();</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+  listener2.reset();</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+  mailSession.removeUserFeedbackListener(listener2);</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+  mailSession.alertUser(&quot;no listeners&quot;, msgWindow);</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+  do_check_eq(prompts.mText, &quot;no listeners&quot;);</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+  do_check_eq(listener1.mMessage, null);</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+  do_check_eq(listener1.mMsgWindow, null);</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+  do_check_eq(listener2.mMessage, null);</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+  do_check_eq(listener2.mMsgWindow, null);</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,9 +1,9 @@</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.6"></a><span id="l7.6"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.7"></a><span id="l7.7">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.8"></a><span id="l7.8">  *</span>
<a href="#l7.9"></a><span id="l7.9">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.10"></a><span id="l7.10">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.11"></a><span id="l7.11">  * the License. You may obtain a copy of the License at</span>
<a href="#l7.12"></a><span id="l7.12">  * http://www.mozilla.org/MPL/</span>
<a href="#l7.13"></a><span id="l7.13">  *</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineat">@@ -34,16 +34,18 @@</span>
<a href="#l7.15"></a><span id="l7.15">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.16"></a><span id="l7.16">  *</span>
<a href="#l7.17"></a><span id="l7.17">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> #include &quot;msgCore.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l7.21"></a><span id="l7.21"> #include &quot;nsMsgProtocol.h&quot;</span>
<a href="#l7.22"></a><span id="l7.22"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+#include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l7.25"></a><span id="l7.25"> #include &quot;nsIStreamTransportService.h&quot;</span>
<a href="#l7.26"></a><span id="l7.26"> #include &quot;nsISocketTransportService.h&quot;</span>
<a href="#l7.27"></a><span id="l7.27"> #include &quot;nsISocketTransport.h&quot;</span>
<a href="#l7.28"></a><span id="l7.28"> #include &quot;nsILoadGroup.h&quot;</span>
<a href="#l7.29"></a><span id="l7.29"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l7.30"></a><span id="l7.30"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l7.31"></a><span id="l7.31"> #include &quot;nsIFileURL.h&quot;</span>
<a href="#l7.32"></a><span id="l7.32"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineat">@@ -400,20 +402,16 @@ NS_IMETHODIMP nsMsgProtocol::OnStopReque</span>
<a href="#l7.34"></a><span id="l7.34">     //</span>
<a href="#l7.35"></a><span id="l7.35">     // !NS_BINDING_ABORTED because we don't want to see an alert if the user</span>
<a href="#l7.36"></a><span id="l7.36">     // cancelled the operation.  also, we'll get here because we call Cancel()</span>
<a href="#l7.37"></a><span id="l7.37">     // to force removal of the nsSocketTransport.  see CloseSocket()</span>
<a href="#l7.38"></a><span id="l7.38">     // bugs #30775 and #30648 relate to this</span>
<a href="#l7.39"></a><span id="l7.39">     if (!m_channelContext &amp;&amp; NS_FAILED(aStatus) &amp;&amp;</span>
<a href="#l7.40"></a><span id="l7.40">         (aStatus != NS_BINDING_ABORTED))</span>
<a href="#l7.41"></a><span id="l7.41">     {</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-      nsCOMPtr&lt;nsIPrompt&gt; msgPrompt;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-      GetPromptDialogFromUrl(msgUrl , getter_AddRefs(msgPrompt));</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-      NS_ENSURE_TRUE(msgPrompt, NS_ERROR_FAILURE);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-</span>
<a href="#l7.46"></a><span id="l7.46">       PRInt32 errorID;</span>
<a href="#l7.47"></a><span id="l7.47">       switch (aStatus)</span>
<a href="#l7.48"></a><span id="l7.48">       {</span>
<a href="#l7.49"></a><span id="l7.49">           case NS_ERROR_UNKNOWN_HOST:</span>
<a href="#l7.50"></a><span id="l7.50">           case NS_ERROR_UNKNOWN_PROXY_HOST:</span>
<a href="#l7.51"></a><span id="l7.51">              errorID = UNKNOWN_HOST_ERROR;</span>
<a href="#l7.52"></a><span id="l7.52">              break;</span>
<a href="#l7.53"></a><span id="l7.53">           case NS_ERROR_CONNECTION_REFUSED:</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineat">@@ -426,26 +424,35 @@ NS_IMETHODIMP nsMsgProtocol::OnStopReque</span>
<a href="#l7.55"></a><span id="l7.55">           default:</span>
<a href="#l7.56"></a><span id="l7.56">              errorID = UNKNOWN_ERROR;</span>
<a href="#l7.57"></a><span id="l7.57">              break;</span>
<a href="#l7.58"></a><span id="l7.58">       }</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60">       NS_ASSERTION(errorID != UNKNOWN_ERROR, &quot;unknown error, but don't alert user.&quot;);</span>
<a href="#l7.61"></a><span id="l7.61">       if (errorID != UNKNOWN_ERROR)</span>
<a href="#l7.62"></a><span id="l7.62">       {</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-        PRUnichar *errorMsg = FormatStringWithHostNameByID(errorID, msgUrl);</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-        if (errorMsg == nsnull)</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+        nsString errorMsg;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+        errorMsg.Adopt(FormatStringWithHostNameByID(errorID, msgUrl));</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+        if (errorMsg.IsEmpty())</span>
<a href="#l7.68"></a><span id="l7.68">         {</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-          nsAutoString resultString(NS_LITERAL_STRING(&quot;[StringID &quot;));</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-          resultString.AppendInt(errorID);</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-          resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-          errorMsg = ToNewUnicode(resultString);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+          errorMsg.Assign(NS_LITERAL_STRING(&quot;[StringID &quot;));</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+          errorMsg.AppendInt(errorID);</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+          errorMsg.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l7.76"></a><span id="l7.76">         }</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-        rv = msgPrompt-&gt;Alert(nsnull, errorMsg);</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-        nsMemory::Free(errorMsg);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+        nsCOMPtr &lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+          do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+        nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+        // If we don't manage to get a msgWindow, that's fine, its optional</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+        // for AlertUser.</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+        msgUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+        rv = mailSession-&gt;AlertUser(errorMsg, msgWindow);</span>
<a href="#l7.90"></a><span id="l7.90">       }</span>
<a href="#l7.91"></a><span id="l7.91">     } // if we got an error code</span>
<a href="#l7.92"></a><span id="l7.92">   } // if we have a mailnews url.</span>
<a href="#l7.93"></a><span id="l7.93"> </span>
<a href="#l7.94"></a><span id="l7.94">   // Drop notification callbacks to prevent cycles.</span>
<a href="#l7.95"></a><span id="l7.95">   mCallbacks = 0;</span>
<a href="#l7.96"></a><span id="l7.96">   mProgressEventSink = 0;</span>
<a href="#l7.97"></a><span id="l7.97">   // Call CloseSocket(), in case we got here because the server dropped the</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineat">@@ -1470,41 +1477,39 @@ PRInt32 nsMsgAsyncWriteProtocol::SendDat</span>
<a href="#l7.99"></a><span id="l7.99">   else</span>
<a href="#l7.100"></a><span id="l7.100">     return NS_ERROR_FAILURE;</span>
<a href="#l7.101"></a><span id="l7.101"> }</span>
<a href="#l7.102"></a><span id="l7.102"> </span>
<a href="#l7.103"></a><span id="l7.103"> #define MSGS_URL    &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l7.104"></a><span id="l7.104"> </span>
<a href="#l7.105"></a><span id="l7.105"> PRUnichar *FormatStringWithHostNameByID(PRInt32 stringID, nsIMsgMailNewsUrl *msgUri)</span>
<a href="#l7.106"></a><span id="l7.106"> {</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-  if (! msgUri)</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+  if (!msgUri)</span>
<a href="#l7.109"></a><span id="l7.109">     return nsnull;</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111">   nsresult rv;</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-  nsCOMPtr &lt;nsIStringBundle&gt; sBundle = nsnull;</span>
<a href="#l7.113"></a><span id="l7.113"> </span>
<a href="#l7.114"></a><span id="l7.114">   nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l7.115"></a><span id="l7.115">           do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-  if (NS_FAILED(rv) || (! sBundleService))</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-    return nsnull;</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  NS_ENSURE_TRUE(NS_SUCCEEDED(rv), nsnull);</span>
<a href="#l7.119"></a><span id="l7.119"> </span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; sBundle;</span>
<a href="#l7.121"></a><span id="l7.121">   rv = sBundleService-&gt;CreateBundle(MSGS_URL, getter_AddRefs(sBundle));</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-    return nsnull;</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+  NS_ENSURE_TRUE(NS_SUCCEEDED(rv), nsnull);</span>
<a href="#l7.125"></a><span id="l7.125"> </span>
<a href="#l7.126"></a><span id="l7.126">   PRUnichar *ptrv = nsnull;</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-  nsCString hostName;</span>
<a href="#l7.128"></a><span id="l7.128">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l7.129"></a><span id="l7.129">   rv = msgUri-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+  NS_ENSURE_TRUE(NS_SUCCEEDED(rv), nsnull);</span>
<a href="#l7.131"></a><span id="l7.131"> </span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-    rv = server-&gt;GetRealHostName(hostName);</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+  nsCString hostName;</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  rv = server-&gt;GetRealHostName(hostName);</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+  NS_ENSURE_TRUE(NS_SUCCEEDED(rv), nsnull);</span>
<a href="#l7.137"></a><span id="l7.137"> </span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-  NS_ConvertASCIItoUTF16 hostStr (hostName);</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+  NS_ConvertASCIItoUTF16 hostStr(hostName);</span>
<a href="#l7.140"></a><span id="l7.140">   const PRUnichar *params[] = { hostStr.get() };</span>
<a href="#l7.141"></a><span id="l7.141">   rv = sBundle-&gt;FormatStringFromID(stringID, params, 1, &amp;ptrv);</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-    return nsnull;</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  NS_ENSURE_TRUE(NS_SUCCEEDED(rv), nsnull);</span>
<a href="#l7.145"></a><span id="l7.145"> </span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-  return (ptrv);</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  return ptrv;</span>
<a href="#l7.148"></a><span id="l7.148"> }</span>
<a href="#l7.149"></a><span id="l7.149"> </span>
<a href="#l7.150"></a><span id="l7.150"> // vim: ts=2 sw=2</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1725,73 +1725,58 @@ void nsImapIncomingServer::UnsubscribeFr</span>
<a href="#l8.4"></a><span id="l8.4">   }</span>
<a href="#l8.5"></a><span id="l8.5"> }</span>
<a href="#l8.6"></a><span id="l8.6"> #endif // 0</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> NS_IMETHODIMP</span>
<a href="#l8.10"></a><span id="l8.10"> nsImapIncomingServer::FEAlert(const nsAString&amp; aString, nsIMsgWindow * aMsgWindow)</span>
<a href="#l8.11"></a><span id="l8.11"> {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-  nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-  if (aMsgWindow)</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-    aMsgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-  if (!dialog) // if we didn't get one, use the default....</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-  {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-    if (wwatch)</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-      wwatch-&gt;GetNewPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-  }</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-  if (dialog)</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-    rv = dialog-&gt;Alert(nsnull, PromiseFlatString(aString).get());</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-  return rv;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+  nsresult rv;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+  nsCOMPtr &lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+    do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  return mailSession-&gt;AlertUser(aString, aMsgWindow);</span>
<a href="#l8.33"></a><span id="l8.33"> }</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35"> NS_IMETHODIMP  nsImapIncomingServer::FEAlertFromServer(const nsACString&amp; aString, nsIMsgWindow * aMsgWindow)</span>
<a href="#l8.36"></a><span id="l8.36"> {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-  nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-  if (aMsgWindow)</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-    aMsgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  if (dialog)</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  NS_ENSURE_TRUE(!aString.IsEmpty(), NS_OK);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  </span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  nsresult rv;</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  nsCOMPtr &lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  // Skip over the first two words, I guess.</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  nsCString message(aString);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  // Find the first word break.</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  PRInt32 pos = message.FindChar(' ');</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  // Find the second word break.</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  if (pos != -1)</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+    pos = message.FindChar(' ', pos + 1);</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  // Adjust the message.</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  if (pos != -1)</span>
<a href="#l8.63"></a><span id="l8.63">   {</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-    if (!aString.IsEmpty())</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-    {</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-      // skip over the first two words, I guess.</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-      // mscott: fix this string code to use nsString APIs!!!</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-      nsCString charStr(aString);</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-      char *whereRealMessage = PL_strchr(charStr.get(), ' ');</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-      if (whereRealMessage)</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-        whereRealMessage++;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-      if (whereRealMessage)</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-        whereRealMessage = PL_strchr(whereRealMessage, ' ');</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-      if (whereRealMessage)</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-      {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-        PRInt32 len = PL_strlen(whereRealMessage)-1;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-        if (len &gt; 0 &amp;&amp; whereRealMessage[len] !=  '.')</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-          whereRealMessage[len] = '.';</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-      }</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-      nsString message;</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-      GetImapStringByID(IMAP_SERVER_SAID, message);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-      if (!message.IsEmpty())</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-      {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-        // the alert string from the server IS UTF-8!!! We must convert it to unicode</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-        // correctly before appending it to our error message string...</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-        AppendUTF8toUTF16(whereRealMessage ? whereRealMessage : PromiseFlatCString(aString).get(), message);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-        rv = dialog-&gt;Alert(nsnull, message.get());</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-      }</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-    }</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+    message = Substring(message, pos + 1);</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+    message.Append('.');</span>
<a href="#l8.93"></a><span id="l8.93">   }</span>
<a href="#l8.94"></a><span id="l8.94"> </span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-  return rv;</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+  nsString fullMessage;</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+  GetImapStringByID(IMAP_SERVER_SAID, fullMessage);</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+  NS_ENSURE_TRUE(!fullMessage.IsEmpty(), NS_OK);</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+  // The alert string from the server IS UTF-8!!! We must convert it to unicode</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+  // correctly before appending it to our error message string...</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+  AppendUTF8toUTF16(message, fullMessage);</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+  return mailSession-&gt;AlertUser(fullMessage, aMsgWindow);</span>
<a href="#l8.104"></a><span id="l8.104"> }</span>
<a href="#l8.105"></a><span id="l8.105"> </span>
<a href="#l8.106"></a><span id="l8.106"> #define IMAP_MSGS_URL       &quot;chrome://messenger/locale/imapMsgs.properties&quot;</span>
<a href="#l8.107"></a><span id="l8.107"> </span>
<a href="#l8.108"></a><span id="l8.108"> nsresult nsImapIncomingServer::GetStringBundle()</span>
<a href="#l8.109"></a><span id="l8.109"> {</span>
<a href="#l8.110"></a><span id="l8.110">   nsresult res;</span>
<a href="#l8.111"></a><span id="l8.111">   if (!m_stringBundle)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

