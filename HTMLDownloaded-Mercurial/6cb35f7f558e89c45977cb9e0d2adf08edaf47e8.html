<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 17730:6cb35f7f558e89c45977cb9e0d2adf08edaf47e8</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6cb35f7f558e89c45977cb9e0d2adf08edaf47e8" />
<meta property="og:url" content="/comm-central/rev/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8" />
<meta property="og:description" content="Bug 1151474 - Part 1: Remove use of expression closure from im/components/. r=florian" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6cb35f7f558e89c45977cb9e0d2adf08edaf47e8 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8">shortlog</a> |
<a href="/comm-central/log/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8">files</a> |
changeset |
<a href="/comm-central/raw-rev/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8">raw</a>  | <a href="/comm-central/archive/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1151474">Bug 1151474</a> - Part 1: Remove use of expression closure from im/components/. r=florian
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#84;&#111;&#111;&#114;&#117;&#32;&#70;&#117;&#106;&#105;&#115;&#97;&#119;&#97;&#32;&#60;&#97;&#114;&#97;&#105;&#95;&#97;&#64;&#109;&#97;&#99;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 10 Apr 2015 00:14:18 +0900</td></tr>

<tr>
 <td>changeset 17730</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8">6cb35f7f558e89c45977cb9e0d2adf08edaf47e8</a></td>
</tr>



<tr>
<td>parent 17729</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e2cdfef448c11be98d5b731881c77ee33b73ca1f">e2cdfef448c11be98d5b731881c77ee33b73ca1f</a>
</td>
</tr>

<tr>
<td>child 17731</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/eeefdaff1e6ca87a9c2f6cacaf3b8d13b045643d">eeefdaff1e6ca87a9c2f6cacaf3b8d13b045643d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6cb35f7f558e89c45977cb9e0d2adf08edaf47e8">10923</a></td></tr>
<tr><td>push user</td><td>arai_a@mac.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 09 Apr 2015 15:29:32 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a0cba0d60fcd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a0cba0d60fcd758e279fcf405c32497f6913ea8d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a0cba0d60fcd758e279fcf405c32497f6913ea8d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a0cba0d60fcd758e279fcf405c32497f6913ea8d&newProject=comm-central&newRevision=6cb35f7f558e89c45977cb9e0d2adf08edaf47e8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a0cba0d60fcd758e279fcf405c32497f6913ea8d&newProject=comm-central&newRevision=6cb35f7f558e89c45977cb9e0d2adf08edaf47e8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a0cba0d60fcd758e279fcf405c32497f6913ea8d&newProject=comm-central&newRevision=6cb35f7f558e89c45977cb9e0d2adf08edaf47e8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28florian%29&revcount=50">florian</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1151474">1151474</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1151474">Bug 1151474</a> - Part 1: Remove use of expression closure from im/components/. r=florian</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8/im/components/ibConvStatsService.js">im/components/ibConvStatsService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8/im/components/ibConvStatsService.js">file</a> |
<a href="/comm-central/annotate/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8/im/components/ibConvStatsService.js">annotate</a> |
<a href="/comm-central/diff/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8/im/components/ibConvStatsService.js">diff</a> |
<a href="/comm-central/comparison/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8/im/components/ibConvStatsService.js">comparison</a> |
<a href="/comm-central/log/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8/im/components/ibConvStatsService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8/im/components/mintrayr/content/mintrayr.js">im/components/mintrayr/content/mintrayr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8/im/components/mintrayr/content/mintrayr.js">file</a> |
<a href="/comm-central/annotate/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8/im/components/mintrayr/content/mintrayr.js">annotate</a> |
<a href="/comm-central/diff/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8/im/components/mintrayr/content/mintrayr.js">diff</a> |
<a href="/comm-central/comparison/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8/im/components/mintrayr/content/mintrayr.js">comparison</a> |
<a href="/comm-central/log/6cb35f7f558e89c45977cb9e0d2adf08edaf47e8/im/components/mintrayr/content/mintrayr.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/im/components/ibConvStatsService.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/im/components/ibConvStatsService.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -13,21 +13,21 @@ const kNotificationsToObserve =</span>
<a href="#l1.4"></a><span id="l1.4">    &quot;contact-preferred-buddy-changed&quot;, &quot;contact-moved&quot;,</span>
<a href="#l1.5"></a><span id="l1.5">    &quot;account-connected&quot;, &quot;account-disconnected&quot;, &quot;new-conversation&quot;,</span>
<a href="#l1.6"></a><span id="l1.6">    &quot;new-text&quot;, &quot;conversation-closed&quot;, &quot;prpl-quit&quot;];</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> // This is incremented when changes to the log sweeping code warrant rebuilding</span>
<a href="#l1.9"></a><span id="l1.9"> // the stats cache file.</span>
<a href="#l1.10"></a><span id="l1.10"> const gStatsCacheVersion = 2;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_newtab&quot;, function()</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_newtab&quot;, () =&gt;</span>
<a href="#l1.14"></a><span id="l1.14">   l10nHelper(&quot;chrome://instantbird/locale/newtab.properties&quot;)</span>
<a href="#l1.15"></a><span id="l1.15"> );</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_instantbird&quot;, function()</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_instantbird&quot;, () =&gt;</span>
<a href="#l1.19"></a><span id="l1.19">   l10nHelper(&quot;chrome://instantbird/locale/instantbird.properties&quot;)</span>
<a href="#l1.20"></a><span id="l1.20"> );</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> // ConversationStats stored by id.</span>
<a href="#l1.23"></a><span id="l1.23"> // A PossibleConversation's id is its protocol, account, and name joined by &quot;/&quot;, suffixed</span>
<a href="#l1.24"></a><span id="l1.24"> // with &quot;.chat&quot; for MUCs (identical to the log folder path for the conversation).</span>
<a href="#l1.25"></a><span id="l1.25"> var gStatsByConvId = {};</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27" class="difflineat">@@ -236,20 +236,20 @@ ConvStatsService.prototype = {</span>
<a href="#l1.28"></a><span id="l1.28">       this._lastUpdateNotification = now;</span>
<a href="#l1.29"></a><span id="l1.29">     }</span>
<a href="#l1.30"></a><span id="l1.30">   },</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32">   _removeChatsForAccount: function(aAccId) {</span>
<a href="#l1.33"></a><span id="l1.33">     if (!this._chatsByAccountIdAndName.has(aAccId))</span>
<a href="#l1.34"></a><span id="l1.34">       return;</span>
<a href="#l1.35"></a><span id="l1.35">     // Keep only convs that either aren't chats or have a different account id.</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-    this._convs = this._convs.filter(function(c)</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+    this._convs = this._convs.filter(c =&gt;</span>
<a href="#l1.38"></a><span id="l1.38">       c.source != &quot;chat&quot; || c.accountId != aAccId);</span>
<a href="#l1.39"></a><span id="l1.39">     this._chatsByAccountIdAndName.delete(aAccId);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-    this._pendingChats = this._pendingChats.filter(function(c) c.accountId != aAccId);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    this._pendingChats = this._pendingChats.filter(c =&gt; c.accountId != aAccId);</span>
<a href="#l1.42"></a><span id="l1.42">   },</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44">   _getPositionToInsert: function(aPossibleConversation, aArrayToInsert) {</span>
<a href="#l1.45"></a><span id="l1.45">     let end = aArrayToInsert.length;</span>
<a href="#l1.46"></a><span id="l1.46">     // Avoid the binary search loop if aArrayToInsert was already sorted.</span>
<a href="#l1.47"></a><span id="l1.47">     if (end == 0 ||</span>
<a href="#l1.48"></a><span id="l1.48">         this._sortComparator(aPossibleConversation, aArrayToInsert[end - 1]) &gt;= 0)</span>
<a href="#l1.49"></a><span id="l1.49">       return end;</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineat">@@ -266,17 +266,17 @@ ConvStatsService.prototype = {</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52">   _sortComparator: function(aPossibleConvA, aPossibleConvB) {</span>
<a href="#l1.53"></a><span id="l1.53">     let scoreA = aPossibleConvA.computedScore;</span>
<a href="#l1.54"></a><span id="l1.54">     let scoreB = aPossibleConvB.computedScore;</span>
<a href="#l1.55"></a><span id="l1.55">     // We want conversations with stats (both contacts and chats) to appear first,</span>
<a href="#l1.56"></a><span id="l1.56">     // followed by contacts with no stats, and finally chats with no stats.</span>
<a href="#l1.57"></a><span id="l1.57">     // Conversations with stats have a positive score.</span>
<a href="#l1.58"></a><span id="l1.58">     // Contacts with no stats get a 0, and chats get -1.</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-    let sign = function(x) x &gt; 0 ? 1 : x &lt; 0 ? -1 : 0;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    let sign = x =&gt; x &gt; 0 ? 1 : x &lt; 0 ? -1 : 0;</span>
<a href="#l1.61"></a><span id="l1.61">     return sign(scoreB) - sign(scoreA) ||</span>
<a href="#l1.62"></a><span id="l1.62">       scoreB - scoreA ||</span>
<a href="#l1.63"></a><span id="l1.63">       aPossibleConvB.statusType - aPossibleConvA.statusType ||</span>
<a href="#l1.64"></a><span id="l1.64">       aPossibleConvA.lowerCaseName.localeCompare(aPossibleConvB.lowerCaseName);</span>
<a href="#l1.65"></a><span id="l1.65">   },</span>
<a href="#l1.66"></a><span id="l1.66"> </span>
<a href="#l1.67"></a><span id="l1.67">   _repositionConvsWithUpdatedStats: function() {</span>
<a href="#l1.68"></a><span id="l1.68">     for (let conv of this._convsWithUpdatedStats) {</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineat">@@ -293,17 +293,17 @@ ConvStatsService.prototype = {</span>
<a href="#l1.70"></a><span id="l1.70">   },</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72">   getFilteredConvs: function(aFilterStr) {</span>
<a href="#l1.73"></a><span id="l1.73">     this._repositionConvsWithUpdatedStats();</span>
<a href="#l1.74"></a><span id="l1.74"> </span>
<a href="#l1.75"></a><span id="l1.75">     // Duplicate this._convs to avoid modifying it while adding existing convs.</span>
<a href="#l1.76"></a><span id="l1.76">     let filteredConvs = this._convs.slice(0);</span>
<a href="#l1.77"></a><span id="l1.77">     let existingConvs = Services.conversations.getUIConversations().map(</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-                          function(uiConv) new ExistingConversation(uiConv));</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+                          uiConv =&gt; new ExistingConversation(uiConv));</span>
<a href="#l1.80"></a><span id="l1.80">     for (let existingConv of existingConvs) {</span>
<a href="#l1.81"></a><span id="l1.81">       let uiConv = existingConv.uiConv;</span>
<a href="#l1.82"></a><span id="l1.82">       if (existingConv.isChat) {</span>
<a href="#l1.83"></a><span id="l1.83">         let chatList = this._chatsByAccountIdAndName.get(uiConv.account.id);</span>
<a href="#l1.84"></a><span id="l1.84">         if (chatList) {</span>
<a href="#l1.85"></a><span id="l1.85">           let chat = chatList.get(uiConv.name);</span>
<a href="#l1.86"></a><span id="l1.86">           if (chat)</span>
<a href="#l1.87"></a><span id="l1.87">             filteredConvs.splice(filteredConvs.indexOf(chat), 1);</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineat">@@ -404,17 +404,17 @@ ConvStatsService.prototype = {</span>
<a href="#l1.89"></a><span id="l1.89"> </span>
<a href="#l1.90"></a><span id="l1.90">     this._repositionConvsWithUpdatedStats();</span>
<a href="#l1.91"></a><span id="l1.91"> </span>
<a href="#l1.92"></a><span id="l1.92">     // We request chat lists from accounts when adding new observers.</span>
<a href="#l1.93"></a><span id="l1.93">     this._requestRoomInfo();</span>
<a href="#l1.94"></a><span id="l1.94">   },</span>
<a href="#l1.95"></a><span id="l1.95"> </span>
<a href="#l1.96"></a><span id="l1.96">   removeObserver: function(aObserver) {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-    this._observers = this._observers.filter(function(o) o !== aObserver);</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l1.99"></a><span id="l1.99">   },</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101">   _notifyObservers: function(aTopic, aData) {</span>
<a href="#l1.102"></a><span id="l1.102">     for each (let observer in this._observers) {</span>
<a href="#l1.103"></a><span id="l1.103">       if (&quot;observe&quot; in observer) // Avoid failing on destructed XBL bindings.</span>
<a href="#l1.104"></a><span id="l1.104">         observer.observe(this, &quot;stats-service-&quot; + aTopic, aData);</span>
<a href="#l1.105"></a><span id="l1.105">     }</span>
<a href="#l1.106"></a><span id="l1.106">   },</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineat">@@ -538,22 +538,23 @@ function ConversationStats(aConvId = &quot;&quot;,</span>
<a href="#l1.108"></a><span id="l1.108">   this.lastDate = aLastDate;</span>
<a href="#l1.109"></a><span id="l1.109">   this.incomingCount = aIncomingCount;</span>
<a href="#l1.110"></a><span id="l1.110">   this.outgoingCount = aOutgoingCount;</span>
<a href="#l1.111"></a><span id="l1.111"> }</span>
<a href="#l1.112"></a><span id="l1.112"> ConversationStats.prototype = {</span>
<a href="#l1.113"></a><span id="l1.113">   id: &quot;&quot;,</span>
<a href="#l1.114"></a><span id="l1.114">   lastDate: 0,</span>
<a href="#l1.115"></a><span id="l1.115">   ONE_DAY: 24 * 60 * 60 * 1000,</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-  get daysBefore() (Date.now() - this.lastDate) / this.ONE_DAY,</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-  get msgCount() this.incomingCount + this.outgoingCount,</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+  get daysBefore() { return (Date.now() - this.lastDate) / this.ONE_DAY; },</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+  get msgCount() { return this.incomingCount + this.outgoingCount; },</span>
<a href="#l1.120"></a><span id="l1.120">   incomingCount: 0,</span>
<a href="#l1.121"></a><span id="l1.121">   outgoingCount: 0,</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-  get frequencyMultiplier()</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-    this.outgoingCount / (this.incomingCount || 1),</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+  get frequencyMultiplier() {</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+    return this.outgoingCount / (this.incomingCount || 1);</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+  },</span>
<a href="#l1.127"></a><span id="l1.127">   get recencyMultiplier() {</span>
<a href="#l1.128"></a><span id="l1.128">     let daysBefore = this.daysBefore;</span>
<a href="#l1.129"></a><span id="l1.129">     if (daysBefore &lt; 4)</span>
<a href="#l1.130"></a><span id="l1.130">       return 1;</span>
<a href="#l1.131"></a><span id="l1.131">     if (daysBefore &lt; 14)</span>
<a href="#l1.132"></a><span id="l1.132">       return 0.7;</span>
<a href="#l1.133"></a><span id="l1.133">     if (daysBefore &lt; 31)</span>
<a href="#l1.134"></a><span id="l1.134">       return 0.5;</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineat">@@ -570,38 +571,39 @@ ConversationStats.prototype = {</span>
<a href="#l1.136"></a><span id="l1.136">     stats.lastDate = Math.max(this.lastDate, aOtherStats.lastDate);</span>
<a href="#l1.137"></a><span id="l1.137">     stats.incomingCount = this.incomingCount + aOtherStats.incomingCount;</span>
<a href="#l1.138"></a><span id="l1.138">     stats.outgoingCount = this.outgoingCount + aOtherStats.outgoingCount;</span>
<a href="#l1.139"></a><span id="l1.139">     return stats;</span>
<a href="#l1.140"></a><span id="l1.140">   }</span>
<a href="#l1.141"></a><span id="l1.141"> }</span>
<a href="#l1.142"></a><span id="l1.142"> </span>
<a href="#l1.143"></a><span id="l1.143"> let PossibleConversation = {</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-  get displayName() this._displayName,</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-  get lowerCaseName()</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-    this._lowerCaseName || (this._lowerCaseName = this._displayName.toLowerCase()),</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+  get displayName() { return this._displayName; },</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+  get lowerCaseName() {</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+    return this._lowerCaseName || (this._lowerCaseName = this._displayName.toLowerCase());</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+  },</span>
<a href="#l1.151"></a><span id="l1.151">   _isChat: false, // False by default. Extensions should override this.</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-  get isChat() this._isChat,</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-  get statusType() this._statusType,</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-  get statusText() this._statusText,</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-  get infoText() this._infoText,</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-  get buddyIconFilename() this._buddyIconFilename,</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+  get isChat() { return this._isChat; },</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+  get statusType() { return this._statusType; },</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+  get statusText() { return this._statusText; },</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+  get infoText() { return this._infoText; },</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+  get buddyIconFilename() { return this._buddyIconFilename; },</span>
<a href="#l1.162"></a><span id="l1.162">   QueryInterface: XPCOMUtils.generateQI([Ci.ibIPossibleConversation])</span>
<a href="#l1.163"></a><span id="l1.163"> };</span>
<a href="#l1.164"></a><span id="l1.164"> </span>
<a href="#l1.165"></a><span id="l1.165"> function PossibleConvFromContact(aContact) {</span>
<a href="#l1.166"></a><span id="l1.166">   this._displayName = aContact.displayName;</span>
<a href="#l1.167"></a><span id="l1.167">   this._statusType = aContact.statusType;</span>
<a href="#l1.168"></a><span id="l1.168">   this._statusText = aContact.statusText;</span>
<a href="#l1.169"></a><span id="l1.169">   this._contactId = aContact.id;</span>
<a href="#l1.170"></a><span id="l1.170"> }</span>
<a href="#l1.171"></a><span id="l1.171"> PossibleConvFromContact.prototype = {</span>
<a href="#l1.172"></a><span id="l1.172">   __proto__: PossibleConversation,</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-  get statusText() this._statusText,</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-  get source() &quot;contact&quot;,</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+  get statusText() { return this._statusText; },</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+  get source() { return &quot;contact&quot;; },</span>
<a href="#l1.177"></a><span id="l1.177">   get id() {</span>
<a href="#l1.178"></a><span id="l1.178">     let buddy = this.contact.preferredBuddy;</span>
<a href="#l1.179"></a><span id="l1.179">     return getConversationId(buddy.protocol.normalizedName,</span>
<a href="#l1.180"></a><span id="l1.180">                              buddy.preferredAccountBuddy.account.normalizedName,</span>
<a href="#l1.181"></a><span id="l1.181">                              buddy.normalizedName, false);</span>
<a href="#l1.182"></a><span id="l1.182">   },</span>
<a href="#l1.183"></a><span id="l1.183">   get buddyIds() {</span>
<a href="#l1.184"></a><span id="l1.184">     let buddies = this.contact.getBuddies();</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineat">@@ -619,24 +621,24 @@ PossibleConvFromContact.prototype = {</span>
<a href="#l1.186"></a><span id="l1.186">   get lowerCaseName() {</span>
<a href="#l1.187"></a><span id="l1.187">     if (!this._lowerCaseName) {</span>
<a href="#l1.188"></a><span id="l1.188">       let buddies = this.contact.getBuddies();</span>
<a href="#l1.189"></a><span id="l1.189">       let names = [b.displayName for (b of buddies)].join(&quot; &quot;);</span>
<a href="#l1.190"></a><span id="l1.190">       this._lowerCaseName = names.toLowerCase();</span>
<a href="#l1.191"></a><span id="l1.191">     }</span>
<a href="#l1.192"></a><span id="l1.192">     return this._lowerCaseName;</span>
<a href="#l1.193"></a><span id="l1.193">   },</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-  get buddyIconFilename() this.contact.buddyIconFilename,</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+  get buddyIconFilename() { return this.contact.buddyIconFilename; },</span>
<a href="#l1.196"></a><span id="l1.196">   get infoText() {</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-    let tagNames = this.contact.getTags().map(function(aTag) aTag.name);</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-    tagNames.sort(function(a, b) a.toLowerCase().localeCompare(b.toLowerCase()));</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+    let tagNames = this.contact.getTags().map(aTag =&gt; aTag.name);</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+    tagNames.sort((a, b) =&gt; a.toLowerCase().localeCompare(b.toLowerCase()));</span>
<a href="#l1.201"></a><span id="l1.201">     return tagNames.join(&quot;, &quot;);</span>
<a href="#l1.202"></a><span id="l1.202">   },</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-  get contact() Services.contacts.getContactById(this._contactId),</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-  get account() this.contact.preferredBuddy.preferredAccountBuddy.account,</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+  get contact() { return Services.contacts.getContactById(this._contactId); },</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+  get account() { return this.contact.preferredBuddy.preferredAccountBuddy.account; },</span>
<a href="#l1.207"></a><span id="l1.207">   get computedScore() {</span>
<a href="#l1.208"></a><span id="l1.208">     let contactId = this._contactId;</span>
<a href="#l1.209"></a><span id="l1.209">     if (gStatsByContactId &amp;&amp; gStatsByContactId[contactId])</span>
<a href="#l1.210"></a><span id="l1.210">       return gStatsByContactId[contactId].computedScore;</span>
<a href="#l1.211"></a><span id="l1.211">     // Contacts may have multiple buddies attached to them, so we sum their</span>
<a href="#l1.212"></a><span id="l1.212">     // individual message counts before arriving at the final score.</span>
<a href="#l1.213"></a><span id="l1.213">     let stats = new ConversationStats();</span>
<a href="#l1.214"></a><span id="l1.214">     for (let id of this.buddyIds) {</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineat">@@ -650,39 +652,41 @@ PossibleConvFromContact.prototype = {</span>
<a href="#l1.216"></a><span id="l1.216">     // We apply a negative bias if statusType / STATUS_AVAILABLE is less than 0.5</span>
<a href="#l1.217"></a><span id="l1.217">     // (i.e. our status is less than or equal to STATUS_MOBILE), and a positive</span>
<a href="#l1.218"></a><span id="l1.218">     // one otherwise.</span>
<a href="#l1.219"></a><span id="l1.219">     score *= 0.5 + this.statusType / Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l1.220"></a><span id="l1.220">     if (!this.contact.canSendMessage)</span>
<a href="#l1.221"></a><span id="l1.221">       score *= 0.75;</span>
<a href="#l1.222"></a><span id="l1.222">     return score;</span>
<a href="#l1.223"></a><span id="l1.223">   },</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-  createConversation: function() this.contact.createConversation()</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+  createConversation: function() { return this.contact.createConversation(); }</span>
<a href="#l1.226"></a><span id="l1.226"> };</span>
<a href="#l1.227"></a><span id="l1.227"> </span>
<a href="#l1.228"></a><span id="l1.228"> function PossibleChat(aRoomInfo) {</span>
<a href="#l1.229"></a><span id="l1.229">   this._roomInfo = aRoomInfo;</span>
<a href="#l1.230"></a><span id="l1.230">   let account = this.account;</span>
<a href="#l1.231"></a><span id="l1.231">   this.id = getConversationId(account.protocol.normalizedName,</span>
<a href="#l1.232"></a><span id="l1.232">                               account.normalizedName,</span>
<a href="#l1.233"></a><span id="l1.233">                               account.normalize(aRoomInfo.name), true);</span>
<a href="#l1.234"></a><span id="l1.234"> }</span>
<a href="#l1.235"></a><span id="l1.235"> PossibleChat.prototype = {</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-  get isChat() true,</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-  get statusType() Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-  get buddyIconFilename() &quot;&quot;,</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-  get displayName() this._roomInfo.name,</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-  get lowerCaseName()</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-    this._lowerCaseName || (this._lowerCaseName = this.displayName.toLowerCase()),</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-  get statusText()</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-    &quot;(&quot; + this._roomInfo.participantCount + &quot;) &quot; + this._roomInfo.topic,</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-  get infoText() this.account.normalizedName,</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-  get source() &quot;chat&quot;,</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-  get accountId() this._roomInfo.accountId,</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-  get account() Services.accounts.getAccountById(this.accountId),</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+  get isChat() { return true; },</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+  get statusType() { return Ci.imIStatusInfo.STATUS_AVAILABLE; },</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+  get buddyIconFilename() { return &quot;&quot;; },</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+  get displayName() { return this._roomInfo.name; },</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+  get lowerCaseName() {</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+    return this._lowerCaseName || (this._lowerCaseName = this.displayName.toLowerCase());</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+  },</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+  get statusText() {</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+    return &quot;(&quot; + this._roomInfo.participantCount + &quot;) &quot; + this._roomInfo.topic;</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+  },</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+  get infoText() { return this.account.normalizedName; },</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+  get source() { return &quot;chat&quot;; },</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+  get accountId() { return this._roomInfo.accountId; },</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+  get account() { return Services.accounts.getAccountById(this.accountId); },</span>
<a href="#l1.262"></a><span id="l1.262">   createConversation: function() {</span>
<a href="#l1.263"></a><span id="l1.263">     this.account.joinChat(this._roomInfo.chatRoomFieldValues);</span>
<a href="#l1.264"></a><span id="l1.264">     // Work around the fact that joinChat doesn't return the conv.</span>
<a href="#l1.265"></a><span id="l1.265">     return Services.conversations</span>
<a href="#l1.266"></a><span id="l1.266">                    .getConversationByNameAndAccount(this._roomInfo.name,</span>
<a href="#l1.267"></a><span id="l1.267">                                                     this.account, true);</span>
<a href="#l1.268"></a><span id="l1.268">   },</span>
<a href="#l1.269"></a><span id="l1.269">   get computedScore() {</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineat">@@ -724,22 +728,22 @@ function ExistingConversation(aUIConv) {</span>
<a href="#l1.271"></a><span id="l1.271">       this._statusText = &quot;&quot;;</span>
<a href="#l1.272"></a><span id="l1.272">       this._buddyIconFilename = &quot;&quot;;</span>
<a href="#l1.273"></a><span id="l1.273">     }</span>
<a href="#l1.274"></a><span id="l1.274">   }</span>
<a href="#l1.275"></a><span id="l1.275">   this._infoText = _newtab(&quot;existingConv.infoText&quot;);</span>
<a href="#l1.276"></a><span id="l1.276"> }</span>
<a href="#l1.277"></a><span id="l1.277"> ExistingConversation.prototype = {</span>
<a href="#l1.278"></a><span id="l1.278">   __proto__: PossibleConversation,</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-  get source() &quot;existing&quot;,</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+  get source() { return &quot;existing&quot;; },</span>
<a href="#l1.281"></a><span id="l1.281">   get uiConv() {</span>
<a href="#l1.282"></a><span id="l1.282">     return Services.conversations.getUIConversation(Services.conversations</span>
<a href="#l1.283"></a><span id="l1.283">                    .getConversationById(this._convId));</span>
<a href="#l1.284"></a><span id="l1.284">   },</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-  get account() this.uiConv.account,</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+  get account() { return this.uiConv.account; },</span>
<a href="#l1.287"></a><span id="l1.287">   get computedScore() {</span>
<a href="#l1.288"></a><span id="l1.288">     let stats = gStatsByConvId[this.id];</span>
<a href="#l1.289"></a><span id="l1.289">     if (!stats) {</span>
<a href="#l1.290"></a><span id="l1.290">       // Force chats without a score to the end of the list.</span>
<a href="#l1.291"></a><span id="l1.291">       return this.isChat ? -1 : 0;</span>
<a href="#l1.292"></a><span id="l1.292">     }</span>
<a href="#l1.293"></a><span id="l1.293">     let score = stats.computedScore;</span>
<a href="#l1.294"></a><span id="l1.294">     // Give existing chats a negative bias. It's unlikely the user wants to</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineat">@@ -747,12 +751,12 @@ ExistingConversation.prototype = {</span>
<a href="#l1.296"></a><span id="l1.296">     if (this.isChat)</span>
<a href="#l1.297"></a><span id="l1.297">       score *= 0.8;</span>
<a href="#l1.298"></a><span id="l1.298">     // We don't apply the status biasing that PossibleConvFromContact does because</span>
<a href="#l1.299"></a><span id="l1.299">     // existing conversations are not as likely to be reopened as an available</span>
<a href="#l1.300"></a><span id="l1.300">     // contact, but are more likely to be reopened than an offline contact.</span>
<a href="#l1.301"></a><span id="l1.301">     // Averaging this out eliminates the status bias.</span>
<a href="#l1.302"></a><span id="l1.302">     return score;</span>
<a href="#l1.303"></a><span id="l1.303">   },</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-  createConversation: function() this.uiConv.target</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+  createConversation: function() { return this.uiConv.target; }</span>
<a href="#l1.306"></a><span id="l1.306"> };</span>
<a href="#l1.307"></a><span id="l1.307"> </span>
<a href="#l1.308"></a><span id="l1.308"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([ConvStatsService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/im/components/mintrayr/content/mintrayr.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/im/components/mintrayr/content/mintrayr.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.5"></a><span id="l2.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> Components.utils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> var gMinTrayR = {</span>
<a href="#l2.10"></a><span id="l2.10">   trayService: null,</span>
<a href="#l2.11"></a><span id="l2.11">   _prefs: null,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  get menu() document.getElementById(&quot;MinTrayR_context&quot;),</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  get menu() { return document.getElementById(&quot;MinTrayR_context&quot;); },</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15">   load: function() {</span>
<a href="#l2.16"></a><span id="l2.16">     window.removeEventListener(&quot;load&quot;, gMinTrayR.load, true);</span>
<a href="#l2.17"></a><span id="l2.17">     gMinTrayR.init();</span>
<a href="#l2.18"></a><span id="l2.18">   },</span>
<a href="#l2.19"></a><span id="l2.19">   init: function() {</span>
<a href="#l2.20"></a><span id="l2.20">     window.addEventListener(&quot;unload&quot;, this.uninit);</span>
<a href="#l2.21"></a><span id="l2.21"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

