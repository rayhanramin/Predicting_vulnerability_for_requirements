<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29780:6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb" />
<meta property="og:url" content="/comm-central/rev/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb" />
<meta property="og:description" content="Bug 1639949 - Support toolchain build script in Thunderbird repos. r=darktrojan DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb">shortlog</a> |
<a href="/comm-central/log/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb">files</a> |
changeset |
<a href="/comm-central/raw-rev/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb">raw</a>  | <a href="/comm-central/archive/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1639949">Bug 1639949</a> - Support toolchain build script in Thunderbird repos. r=darktrojan DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#111;&#98;&#32;&#76;&#101;&#109;&#108;&#101;&#121;&#32;&#60;&#114;&#111;&#98;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 21 May 2020 14:30:53 -0400</td></tr>

<tr>
 <td>changeset 29780</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb">6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb</a></td>
</tr>



<tr>
<td>parent 29779</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/20fa6cd5d78a3a140d412716e787f57692541874">20fa6cd5d78a3a140d412716e787f57692541874</a>
</td>
</tr>

<tr>
<td>child 29781</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0dee0f41284b0510df55e581a583e8fcdbd89f6c">0dee0f41284b0510df55e581a583e8fcdbd89f6c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb">17529</a></td></tr>
<tr><td>push user</td><td>thunderbird@calypsoblue.org</td></tr>
<tr><td>push date</td><td class="date age">Thu, 04 Jun 2020 14:56:11 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6ef6741b3bd3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb&newProject=comm-central&newRevision=20fa6cd5d78a3a140d412716e787f57692541874&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb&newProject=comm-central&newRevision=20fa6cd5d78a3a140d412716e787f57692541874&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb&newProject=comm-central&newRevision=20fa6cd5d78a3a140d412716e787f57692541874&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28darktrojan%29&revcount=50">darktrojan</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1639949">1639949</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1639949">Bug 1639949</a> - Support toolchain build script in Thunderbird repos. r=darktrojan DONTBUILD

The original plan for libotr was to build it as a toolchain dependency. That
was not possible at the time, but can be done now. The biggest advantage to
switching is going to be improved artifact indexing.
This will also be used for some RNP work.
Most of this code is copied from taskgraph with modifications made to fix
some hardcoded paths. There are no plans to update the code in M-C.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/__init__.py">taskcluster/comm_taskgraph/__init__.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/__init__.py">file</a> |
<a href="/comm-central/annotate/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/__init__.py">annotate</a> |
<a href="/comm-central/diff/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/__init__.py">diff</a> |
<a href="/comm-central/comparison/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/__init__.py">comparison</a> |
<a href="/comm-central/log/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/__init__.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/transforms/job/__init__.py">taskcluster/comm_taskgraph/transforms/job/__init__.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/transforms/job/__init__.py">file</a> |
<a href="/comm-central/annotate/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/transforms/job/__init__.py">annotate</a> |
<a href="/comm-central/diff/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/transforms/job/__init__.py">diff</a> |
<a href="/comm-central/comparison/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/transforms/job/__init__.py">comparison</a> |
<a href="/comm-central/log/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/transforms/job/__init__.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/transforms/job/toolchain.py">taskcluster/comm_taskgraph/transforms/job/toolchain.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/transforms/job/toolchain.py">file</a> |
<a href="/comm-central/annotate/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/transforms/job/toolchain.py">annotate</a> |
<a href="/comm-central/diff/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/transforms/job/toolchain.py">diff</a> |
<a href="/comm-central/comparison/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/transforms/job/toolchain.py">comparison</a> |
<a href="/comm-central/log/6ef6741b3bd30c27c20c8d49df9473fcfa9db2fb/taskcluster/comm_taskgraph/transforms/job/toolchain.py">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/taskcluster/comm_taskgraph/__init__.py</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/taskcluster/comm_taskgraph/__init__.py</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -20,17 +20,17 @@ BALROG_PRODUCT = 'Thunderbird'</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> def register(graph_config):</span>
<a href="#l1.7"></a><span id="l1.7">     &quot;&quot;&quot;</span>
<a href="#l1.8"></a><span id="l1.8">     Import all modules that are siblings of this one, triggering decorators in</span>
<a href="#l1.9"></a><span id="l1.9">     the process.</span>
<a href="#l1.10"></a><span id="l1.10">     &quot;&quot;&quot;</span>
<a href="#l1.11"></a><span id="l1.11">     logger.info(&quot;{} path registered&quot;.format(__name__))</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    _import_modules(['documentation', 'actions'])</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    _import_modules(['documentation', 'actions', 'transforms.job.toolchain'])</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> def _import_modules(modules):</span>
<a href="#l1.17"></a><span id="l1.17">     for module in modules:</span>
<a href="#l1.18"></a><span id="l1.18">         import_module(&quot;.{}&quot;.format(module), package=__name__)</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> def get_decision_parameters(graph_config, parameters):</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/taskcluster/comm_taskgraph/transforms/job/toolchain.py</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,121 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+&quot;&quot;&quot;</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+Support for running toolchain-building jobs via dedicated scripts in comm-central</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+&quot;&quot;&quot;</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+from __future__ import absolute_import, print_function, unicode_literals</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+from voluptuous import Required</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+from taskgraph.transforms.job import (</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    configure_taskdesc_for_run,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    run_job_using,</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+)</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+from taskgraph.transforms.job.toolchain import (</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+    toolchain_defaults,</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    toolchain_run_schema,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+)</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+from taskgraph.transforms.job.common import (</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+    docker_worker_add_artifacts,</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+)</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+from taskgraph.util.hash import hash_paths</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+from taskgraph import GECKO</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+import taskgraph</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+CACHE_TYPE = 'toolchains.v3'</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+TOOLCHAIN_SCRIPT_PATH = 'comm/taskcluster/scripts'</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+comm_toolchain_run_schema = toolchain_run_schema.extend({</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+    Required('using'): 'comm-toolchain-script',</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+})</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+def get_digest_data(config, run, taskdesc):</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+    Copied from taskgraph.transforms.job.toolchain, with minor</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+    modifications to support the required script path.</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    files = list(run.pop('resources', []))</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    # This file</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+    files.append('comm/taskcluster/comm_taskgraph/transforms/job/toolchain.py')</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+    # The script</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+    files.append('{}/{}'.format(TOOLCHAIN_SCRIPT_PATH, run['script']))</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+    # Tooltool manifest if any is defined:</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    tooltool_manifest = taskdesc['worker']['env'].get('TOOLTOOL_MANIFEST')</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    if tooltool_manifest:</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+        files.append(tooltool_manifest)</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    # Accumulate dependency hashes for index generation.</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    data = [hash_paths(GECKO, files)]</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+    # If the task uses an in-tree docker image, we want it to influence</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+    # the index path as well. Ideally, the content of the docker image itself</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    # should have an influence, but at the moment, we can't get that</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+    # information here. So use the docker image name as a proxy. Not a lot of</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+    # changes to docker images actually have an impact on the resulting</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+    # toolchain artifact, so we'll just rely on such important changes to be</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+    # accompanied with a docker image name change.</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+    image = taskdesc['worker'].get('docker-image', {}).get('in-tree')</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    if image:</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+        data.append(image)</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    # Likewise script arguments should influence the index.</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+    args = run.get('arguments')</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+    if args:</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+        data.extend(args)</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+    return data</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+@run_job_using(&quot;docker-worker&quot;, &quot;comm-toolchain-script&quot;,</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+               schema=comm_toolchain_run_schema, defaults=toolchain_defaults)</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+def docker_worker_toolchain(config, job, taskdesc):</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+    run = job['run']</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+    run['comm-checkout'] = True</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+    worker = taskdesc['worker'] = job['worker']</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+    worker['chain-of-trust'] = True</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+    # If the task doesn't have a docker-image, set a default</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+    worker.setdefault('docker-image', {'in-tree': 'deb8-toolchain-build'})</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+    # Allow the job to specify where artifacts come from, but add</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+    # public/build if it's not there already.</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+    artifacts = worker.setdefault('artifacts', [])</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+    if not any(artifact.get('name') == 'public/build' for artifact in artifacts):</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+        docker_worker_add_artifacts(config, job, taskdesc)</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+    # Toolchain checkouts don't live under {workdir}/checkouts</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+    workspace = '{workdir}/workspace/build'.format(**run)</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    gecko_path = '{}/src'.format(workspace)</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+    env = worker['env']</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+    env.update({</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+        'MOZ_BUILD_DATE': config.params['moz_build_date'],</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+        'MOZ_SCM_LEVEL': config.params['level'],</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+        'GECKO_PATH': gecko_path,</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+    })</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+    attributes = taskdesc.setdefault('attributes', {})</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+    attributes['toolchain-artifact'] = run.pop('toolchain-artifact')</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+    if 'toolchain-alias' in run:</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+        attributes['toolchain-alias'] = run.pop('toolchain-alias')</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+    if not taskgraph.fast:</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+        name = taskdesc['label'].replace('{}-'.format(config.kind), '', 1)</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+        taskdesc['cache'] = {</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+            'type': CACHE_TYPE,</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+            'name': name,</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+            'digest-data': get_digest_data(config, run, taskdesc),</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+        }</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+    run['using'] = 'run-task'</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+    run['cwd'] = run['workdir']</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+    run[&quot;command&quot;] = (</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+            [&quot;workspace/build/src/{}/{}&quot;.format(TOOLCHAIN_SCRIPT_PATH, run.pop(&quot;script&quot;))]</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+            + run.pop(&quot;arguments&quot;, [])</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+    )</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+    configure_taskdesc_for_run(config, job, taskdesc, worker['implementation'])</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

