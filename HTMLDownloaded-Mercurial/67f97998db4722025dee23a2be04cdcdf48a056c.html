<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12704:67f97998db4722025dee23a2be04cdcdf48a056c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 67f97998db4722025dee23a2be04cdcdf48a056c" />
<meta property="og:url" content="/comm-central/rev/67f97998db4722025dee23a2be04cdcdf48a056c" />
<meta property="og:description" content="Bug 103870 - Fix some unsafe realloc usage in mailnews. r=Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 67f97998db4722025dee23a2be04cdcdf48a056c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/67f97998db4722025dee23a2be04cdcdf48a056c">shortlog</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/67f97998db4722025dee23a2be04cdcdf48a056c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c">files</a> |
changeset |
<a href="/comm-central/raw-rev/67f97998db4722025dee23a2be04cdcdf48a056c">raw</a>  | <a href="/comm-central/archive/67f97998db4722025dee23a2be04cdcdf48a056c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=103870">Bug 103870</a> - Fix some unsafe realloc usage in mailnews. r=Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 11 Jul 2013 11:31:55 -0400</td></tr>

<tr>
 <td>changeset 12704</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/67f97998db4722025dee23a2be04cdcdf48a056c">67f97998db4722025dee23a2be04cdcdf48a056c</a></td>
</tr>



<tr>
<td>parent 12703</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/65c5bfb05484d04ba58d906559a0177de392740c">65c5bfb05484d04ba58d906559a0177de392740c</a>
</td>
</tr>

<tr>
<td>child 12705</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4520686e4809dec730be84ce7c7e276ebbe64254">4520686e4809dec730be84ce7c7e276ebbe64254</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=67f97998db4722025dee23a2be04cdcdf48a056c">9324</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 11 Jul 2013 15:37:48 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@49c485a0247c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=49c485a0247c1fcacd008255c4b62fa0dfbb4429">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=49c485a0247c1fcacd008255c4b62fa0dfbb4429&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=49c485a0247c1fcacd008255c4b62fa0dfbb4429&newProject=comm-central&newRevision=67f97998db4722025dee23a2be04cdcdf48a056c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=49c485a0247c1fcacd008255c4b62fa0dfbb4429&newProject=comm-central&newRevision=67f97998db4722025dee23a2be04cdcdf48a056c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=49c485a0247c1fcacd008255c4b62fa0dfbb4429&newProject=comm-central&newRevision=67f97998db4722025dee23a2be04cdcdf48a056c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=103870">103870</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=103870">Bug 103870</a> - Fix some unsafe realloc usage in mailnews. r=Neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/addrbook/src/nsVCard.cpp">mailnews/addrbook/src/nsVCard.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/addrbook/src/nsVCard.cpp">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/addrbook/src/nsVCard.cpp">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/addrbook/src/nsVCard.cpp">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/addrbook/src/nsVCard.cpp">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/addrbook/src/nsVCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/addrbook/src/nsVCardObj.cpp">mailnews/addrbook/src/nsVCardObj.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/addrbook/src/nsVCardObj.cpp">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/addrbook/src/nsVCardObj.cpp">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/addrbook/src/nsVCardObj.cpp">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/addrbook/src/nsVCardObj.cpp">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/addrbook/src/nsVCardObj.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/src/nsMsgDBView.h">mailnews/base/src/nsMsgDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/src/nsMsgDBView.h">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/src/nsMsgDBView.h">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/src/nsMsgDBView.h">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/src/nsMsgDBView.h">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/src/nsMsgDBView.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgLineBuffer.cpp">mailnews/base/util/nsMsgLineBuffer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgLineBuffer.cpp">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgLineBuffer.cpp">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgLineBuffer.cpp">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgLineBuffer.cpp">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgLineBuffer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgLineBuffer.h">mailnews/base/util/nsMsgLineBuffer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgLineBuffer.h">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgLineBuffer.h">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgLineBuffer.h">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgLineBuffer.h">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgLineBuffer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgUtils.cpp">mailnews/base/util/nsMsgUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgUtils.cpp">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgUtils.cpp">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgUtils.cpp">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgUtils.cpp">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/base/util/nsMsgUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/compose/src/nsMsgCompUtils.cpp">mailnews/compose/src/nsMsgCompUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/compose/src/nsMsgCompUtils.cpp">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/compose/src/nsMsgCompUtils.cpp">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/compose/src/nsMsgCompUtils.cpp">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/compose/src/nsMsgCompUtils.cpp">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/compose/src/nsMsgCompUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/compose/src/nsMsgSendLater.cpp">mailnews/compose/src/nsMsgSendLater.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/compose/src/nsMsgSendLater.cpp">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/compose/src/nsMsgSendLater.cpp">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/compose/src/nsMsgSendLater.cpp">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/compose/src/nsMsgSendLater.cpp">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/compose/src/nsMsgSendLater.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/public/nsIPop3Sink.idl">mailnews/local/public/nsIPop3Sink.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/public/nsIPop3Sink.idl">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/public/nsIPop3Sink.idl">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/public/nsIPop3Sink.idl">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/public/nsIPop3Sink.idl">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/public/nsIPop3Sink.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsParseMailbox.h">mailnews/local/src/nsParseMailbox.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsParseMailbox.h">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsParseMailbox.h">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsParseMailbox.h">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsParseMailbox.h">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsParseMailbox.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Protocol.cpp">mailnews/local/src/nsPop3Protocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Protocol.cpp">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Protocol.cpp">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Protocol.cpp">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Protocol.cpp">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Protocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Sink.cpp">mailnews/local/src/nsPop3Sink.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Sink.cpp">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Sink.cpp">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Sink.cpp">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Sink.cpp">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Sink.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Sink.h">mailnews/local/src/nsPop3Sink.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Sink.h">file</a> |
<a href="/comm-central/annotate/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Sink.h">annotate</a> |
<a href="/comm-central/diff/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Sink.h">diff</a> |
<a href="/comm-central/comparison/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Sink.h">comparison</a> |
<a href="/comm-central/log/67f97998db4722025dee23a2be04cdcdf48a056c/mailnews/local/src/nsPop3Sink.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/src/nsVCard.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsVCard.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -867,18 +867,18 @@ static void finiLex() {</span>
<a href="#l1.4"></a><span id="l1.4">  */</span>
<a href="#l1.5"></a><span id="l1.5"> static char * lexGetDataFromBase64()</span>
<a href="#l1.6"></a><span id="l1.6">     {</span>
<a href="#l1.7"></a><span id="l1.7">     unsigned long bytesLen = 0, bytesMax = 0;</span>
<a href="#l1.8"></a><span id="l1.8">     int quadIx = 0, pad = 0;</span>
<a href="#l1.9"></a><span id="l1.9">     unsigned long trip = 0;</span>
<a href="#l1.10"></a><span id="l1.10">     unsigned char b;</span>
<a href="#l1.11"></a><span id="l1.11">     int c;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    unsigned char *bytes = NULL;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    unsigned char *oldBytes = NULL;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    unsigned char *bytes = nullptr;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    unsigned char *oldBytes = nullptr;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">     DBG_((&quot;db: lexGetDataFromBase64\n&quot;));</span>
<a href="#l1.18"></a><span id="l1.18">     while (1) {</span>
<a href="#l1.19"></a><span id="l1.19"> 	c = lexGetc();</span>
<a href="#l1.20"></a><span id="l1.20"> 	if (c == '\n') {</span>
<a href="#l1.21"></a><span id="l1.21"> 	    ++mime_lineNum;</span>
<a href="#l1.22"></a><span id="l1.22"> 	    if (lexLookahead() == '\n') {</span>
<a href="#l1.23"></a><span id="l1.23"> 		/* a '\n' character by itself means end of data */</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineat">@@ -929,28 +929,26 @@ static char * lexGetDataFromBase64()</span>
<a href="#l1.25"></a><span id="l1.25"> 		for (i = 0; i &lt; 3; i++) {</span>
<a href="#l1.26"></a><span id="l1.26"> 		    outBytes[2-i] = (unsigned char)(trip &amp; 0xFF);</span>
<a href="#l1.27"></a><span id="l1.27"> 		    trip &gt;&gt;= 8;</span>
<a href="#l1.28"></a><span id="l1.28"> 		    }</span>
<a href="#l1.29"></a><span id="l1.29"> 		numOut = 3 - pad;</span>
<a href="#l1.30"></a><span id="l1.30"> 		if (bytesLen + numOut &gt; bytesMax) {</span>
<a href="#l1.31"></a><span id="l1.31"> 		    if (!bytes) {</span>
<a href="#l1.32"></a><span id="l1.32"> 			bytesMax = 1024;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-			bytes = (unsigned char*)PR_CALLOC(bytesMax);</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-			}</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-		    else {</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+		    } else {</span>
<a href="#l1.37"></a><span id="l1.37"> 			bytesMax &lt;&lt;= 2;</span>
<a href="#l1.38"></a><span id="l1.38"> 			oldBytes = bytes;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-			bytes = (unsigned char*)PR_Realloc(bytes,bytesMax);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-			}</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-			if (bytes == 0) {</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-			  mime_error(&quot;out of memory while processing BASE64 data\n&quot;);</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-                          break;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-			}</span>
<a href="#l1.45"></a><span id="l1.45"> 		    }</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+		    bytes = (unsigned char*) PR_Realloc(oldBytes, bytesMax);</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+		    if (!bytes) {</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+			mime_error(&quot;out of memory while processing BASE64 data\n&quot;);</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+			break;</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+		    }</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+		}</span>
<a href="#l1.52"></a><span id="l1.52"> 		if (bytes) {</span>
<a href="#l1.53"></a><span id="l1.53"> 			memcpy(bytes + bytesLen, outBytes, numOut);</span>
<a href="#l1.54"></a><span id="l1.54"> 			bytesLen += numOut;</span>
<a href="#l1.55"></a><span id="l1.55"> 		}</span>
<a href="#l1.56"></a><span id="l1.56"> 		trip = 0;</span>
<a href="#l1.57"></a><span id="l1.57"> 		quadIx = 0;</span>
<a href="#l1.58"></a><span id="l1.58">         pad = 0;</span>
<a href="#l1.59"></a><span id="l1.59"> 		}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/src/nsVCardObj.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsVCardObj.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -858,18 +858,21 @@ static void appendcOFile_(OFile *fp, cha</span>
<a href="#l2.4"></a><span id="l2.4"> stuff:</span>
<a href="#l2.5"></a><span id="l2.5">   if (fp-&gt;len+1 &lt; fp-&gt;limit) {</span>
<a href="#l2.6"></a><span id="l2.6">     fp-&gt;s[fp-&gt;len] = c;</span>
<a href="#l2.7"></a><span id="l2.7">     fp-&gt;len++;</span>
<a href="#l2.8"></a><span id="l2.8">     return;</span>
<a href="#l2.9"></a><span id="l2.9">   }</span>
<a href="#l2.10"></a><span id="l2.10">   else if (fp-&gt;alloc) {</span>
<a href="#l2.11"></a><span id="l2.11">     fp-&gt;limit = fp-&gt;limit + OFILE_REALLOC_SIZE;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    fp-&gt;s = (char *)PR_Realloc(fp-&gt;s,fp-&gt;limit);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    if (fp-&gt;s) goto stuff;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    char* newBuf = (char *) PR_Realloc(fp-&gt;s, fp-&gt;limit);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    if (newBuf) {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+      fp-&gt;s = newBuf;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+      goto stuff;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+    }</span>
<a href="#l2.19"></a><span id="l2.19">   }</span>
<a href="#l2.20"></a><span id="l2.20">   if (fp-&gt;alloc)</span>
<a href="#l2.21"></a><span id="l2.21">     PR_FREEIF(fp-&gt;s);</span>
<a href="#l2.22"></a><span id="l2.22">   fp-&gt;s = 0;</span>
<a href="#l2.23"></a><span id="l2.23">   fp-&gt;fail = 1;</span>
<a href="#l2.24"></a><span id="l2.24"> }</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> static void appendcOFile(OFile *fp, char c)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -6,17 +6,16 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #ifndef _nsMsgDBView_H_</span>
<a href="#l3.5"></a><span id="l3.5"> #define _nsMsgDBView_H_</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsIMsgDBView.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsIMessenger.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#include &quot;nsMsgLineBuffer.h&quot; // for nsByteArray</span>
<a href="#l3.13"></a><span id="l3.13"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l3.14"></a><span id="l3.14"> #include &quot;nsTArray.h&quot;</span>
<a href="#l3.15"></a><span id="l3.15"> #include &quot;nsIDBChangeListener.h&quot;</span>
<a href="#l3.16"></a><span id="l3.16"> #include &quot;nsITreeView.h&quot;</span>
<a href="#l3.17"></a><span id="l3.17"> #include &quot;nsITreeBoxObject.h&quot;</span>
<a href="#l3.18"></a><span id="l3.18"> #include &quot;nsITreeSelection.h&quot;</span>
<a href="#l3.19"></a><span id="l3.19"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l3.20"></a><span id="l3.20"> #include &quot;nsIDateTimeFormat.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/util/nsMsgLineBuffer.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgLineBuffer.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -173,17 +173,17 @@ nsresult nsMsgLineBuffer::BufferInput(co</span>
<a href="#l4.4"></a><span id="l4.4">         </span>
<a href="#l4.5"></a><span id="l4.5">         net_buffer_size -= (newline - net_buffer);</span>
<a href="#l4.6"></a><span id="l4.6">         net_buffer = newline;</span>
<a href="#l4.7"></a><span id="l4.7">         m_bufferPos = 0;</span>
<a href="#l4.8"></a><span id="l4.8">     }</span>
<a href="#l4.9"></a><span id="l4.9">     return NS_OK;</span>
<a href="#l4.10"></a><span id="l4.10"> }</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-nsresult nsMsgLineBuffer::HandleLine(char *line, uint32_t line_length)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+nsresult nsMsgLineBuffer::HandleLine(const char *line, uint32_t line_length)</span>
<a href="#l4.14"></a><span id="l4.14"> {</span>
<a href="#l4.15"></a><span id="l4.15">   NS_ASSERTION(false, &quot;must override this method if you don't provide a handler&quot;);</span>
<a href="#l4.16"></a><span id="l4.16">   return NS_OK;</span>
<a href="#l4.17"></a><span id="l4.17"> }</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> nsresult nsMsgLineBuffer::ConvertAndSendBuffer()</span>
<a href="#l4.20"></a><span id="l4.20"> {</span>
<a href="#l4.21"></a><span id="l4.21">     /* Convert the line terminator to the native form.</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -270,19 +270,19 @@ nsMsgLineStreamBuffer::nsMsgLineStreamBu</span>
<a href="#l4.23"></a><span id="l4.23"> nsMsgLineStreamBuffer::~nsMsgLineStreamBuffer()</span>
<a href="#l4.24"></a><span id="l4.24"> {</span>
<a href="#l4.25"></a><span id="l4.25">   PR_FREEIF(m_dataBuffer); // release our buffer...</span>
<a href="#l4.26"></a><span id="l4.26"> }</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29"> nsresult nsMsgLineStreamBuffer::GrowBuffer(int32_t desiredSize)</span>
<a href="#l4.30"></a><span id="l4.30"> {</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  m_dataBuffer = (char *) PR_REALLOC(m_dataBuffer, desiredSize);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  if (!m_dataBuffer)</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  char* newBuffer = (char *) PR_REALLOC(m_dataBuffer, desiredSize);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  NS_ENSURE_TRUE(newBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  m_dataBuffer = newBuffer;</span>
<a href="#l4.37"></a><span id="l4.37">   m_dataBufferSize = desiredSize;</span>
<a href="#l4.38"></a><span id="l4.38">   return NS_OK;</span>
<a href="#l4.39"></a><span id="l4.39"> }</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41"> void nsMsgLineStreamBuffer::ClearBuffer()</span>
<a href="#l4.42"></a><span id="l4.42"> {</span>
<a href="#l4.43"></a><span id="l4.43">   m_startPos = 0;</span>
<a href="#l4.44"></a><span id="l4.44">   m_numBytesInBuffer = 0;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsMsgLineBuffer.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgLineBuffer.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -28,30 +28,30 @@ protected:</span>
<a href="#l5.4"></a><span id="l5.4">   uint32_t  m_bufferSize;</span>
<a href="#l5.5"></a><span id="l5.5">   uint32_t  m_bufferPos;  // write Pos in m_buffer - where the next byte should go.</span>
<a href="#l5.6"></a><span id="l5.6"> };</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> class NS_MSG_BASE nsMsgLineBufferHandler : public nsByteArray</span>
<a href="#l5.10"></a><span id="l5.10"> {</span>
<a href="#l5.11"></a><span id="l5.11"> public:</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  virtual nsresult HandleLine(char *line, uint32_t line_length) = 0;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  virtual nsresult HandleLine(const char *line, uint32_t line_length) = 0;</span>
<a href="#l5.14"></a><span id="l5.14"> };</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> class NS_MSG_BASE nsMsgLineBuffer : public nsMsgLineBufferHandler</span>
<a href="#l5.17"></a><span id="l5.17"> {</span>
<a href="#l5.18"></a><span id="l5.18"> public:</span>
<a href="#l5.19"></a><span id="l5.19">   nsMsgLineBuffer(nsMsgLineBufferHandler *handler, bool convertNewlinesP);</span>
<a href="#l5.20"></a><span id="l5.20">   </span>
<a href="#l5.21"></a><span id="l5.21">   virtual    ~nsMsgLineBuffer();</span>
<a href="#l5.22"></a><span id="l5.22">   nsresult    BufferInput(const char *net_buffer, int32_t net_buffer_size);</span>
<a href="#l5.23"></a><span id="l5.23">   // Not sure why anyone cares, by NNTPHost seems to want to know the buf pos.</span>
<a href="#l5.24"></a><span id="l5.24">   uint32_t    GetBufferPos() {return m_bufferPos;}</span>
<a href="#l5.25"></a><span id="l5.25">   </span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-  virtual nsresult HandleLine(char *line, uint32_t line_length);</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  virtual nsresult HandleLine(const char *line, uint32_t line_length);</span>
<a href="#l5.28"></a><span id="l5.28">   // flush last line, though it won't be CRLF terminated.</span>
<a href="#l5.29"></a><span id="l5.29">   virtual nsresult FlushLastLine();</span>
<a href="#l5.30"></a><span id="l5.30"> protected:</span>
<a href="#l5.31"></a><span id="l5.31">   nsMsgLineBuffer(bool convertNewlinesP);</span>
<a href="#l5.32"></a><span id="l5.32">   </span>
<a href="#l5.33"></a><span id="l5.33">   nsresult ConvertAndSendBuffer();</span>
<a href="#l5.34"></a><span id="l5.34">   void SetLookingForCRLF(bool b);</span>
<a href="#l5.35"></a><span id="l5.35">   </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -615,17 +615,16 @@ nsresult NS_MsgCreatePathStringFromFolde</span>
<a href="#l6.4"></a><span id="l6.4"> #else</span>
<a href="#l6.5"></a><span id="l6.5">   return nsMsgI18NConvertFromUnicode(nsMsgI18NFileSystemCharset(), path, aPathCString);</span>
<a href="#l6.6"></a><span id="l6.6"> #endif</span>
<a href="#l6.7"></a><span id="l6.7"> }</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> bool NS_MsgStripRE(const char **stringP, uint32_t *lengthP, char **modifiedSubject)</span>
<a href="#l6.10"></a><span id="l6.10"> {</span>
<a href="#l6.11"></a><span id="l6.11">   const char *s, *s_end;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  const char *last;</span>
<a href="#l6.13"></a><span id="l6.13">   uint32_t L;</span>
<a href="#l6.14"></a><span id="l6.14">   bool result = false;</span>
<a href="#l6.15"></a><span id="l6.15">   NS_ASSERTION(stringP, &quot;bad null param&quot;);</span>
<a href="#l6.16"></a><span id="l6.16">   if (!stringP) return false;</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18">   // get localizedRe pref</span>
<a href="#l6.19"></a><span id="l6.19">   nsresult rv;</span>
<a href="#l6.20"></a><span id="l6.20">   nsString utf16LocalizedRe;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -653,17 +652,16 @@ bool NS_MsgStripRE(const char **stringP,</span>
<a href="#l6.22"></a><span id="l6.22">       rv = mimeConverter-&gt;DecodeMimeHeaderToUTF8(nsDependentCString(*stringP),</span>
<a href="#l6.23"></a><span id="l6.23">         nullptr, false, true, decodedString);</span>
<a href="#l6.24"></a><span id="l6.24">   }</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26">   s = !decodedString.IsEmpty() ? decodedString.get() : *stringP;</span>
<a href="#l6.27"></a><span id="l6.27">   L = lengthP ? *lengthP : strlen(s);</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">   s_end = s + L;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-  last = s;</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">  AGAIN:</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34">   while (s &lt; s_end &amp;&amp; IS_SPACE(*s))</span>
<a href="#l6.35"></a><span id="l6.35">   s++;</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37">   const char *tokPtr = checkString.get();</span>
<a href="#l6.38"></a><span id="l6.38">   while (*tokPtr)</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineat">@@ -761,38 +759,30 @@ char * NS_MsgSACopy (char **destination,</span>
<a href="#l6.40"></a><span id="l6.40">     if (*destination == nullptr)</span>
<a href="#l6.41"></a><span id="l6.41">       return(nullptr);</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43">     PL_strcpy (*destination, source);</span>
<a href="#l6.44"></a><span id="l6.44">   }</span>
<a href="#l6.45"></a><span id="l6.45">   return *destination;</span>
<a href="#l6.46"></a><span id="l6.46"> }</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-/*  Again like strdup but it concatinates and free's and uses Realloc</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+/*  Again like strdup but it concatenates and free's and uses Realloc.</span>
<a href="#l6.50"></a><span id="l6.50"> */</span>
<a href="#l6.51"></a><span id="l6.51"> char * NS_MsgSACat (char **destination, const char *source)</span>
<a href="#l6.52"></a><span id="l6.52"> {</span>
<a href="#l6.53"></a><span id="l6.53">   if (source &amp;&amp; *source)</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-    if (*destination)</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-    {</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-      int length = PL_strlen (*destination);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-      *destination = (char *) PR_Realloc (*destination, length + PL_strlen(source) + 1);</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-      if (*destination == nullptr)</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-        return(nullptr);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  {</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+    int destLength = *destination ? PL_strlen(*destination) : 0;</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+    char* newDestination = (char*) PR_Realloc(*destination, destLength + PL_strlen(source) + 1);</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+    if (newDestination == nullptr)</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+      return nullptr;</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-      PL_strcpy (*destination + length, source);</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-    }</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-    else</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-    {</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-      *destination = (char *) PR_Malloc (PL_strlen(source) + 1);</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-      if (*destination == nullptr)</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-        return(nullptr);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-      PL_strcpy (*destination, source);</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-    }</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+    *destination = newDestination;</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+    PL_strcpy(*destination + destLength, source);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+  }</span>
<a href="#l6.79"></a><span id="l6.79">   return *destination;</span>
<a href="#l6.80"></a><span id="l6.80"> }</span>
<a href="#l6.81"></a><span id="l6.81"> </span>
<a href="#l6.82"></a><span id="l6.82"> nsresult NS_MsgEscapeEncodeURLPath(const nsAString&amp; aStr, nsCString&amp; aResult)</span>
<a href="#l6.83"></a><span id="l6.83"> {</span>
<a href="#l6.84"></a><span id="l6.84">   return MsgEscapeString(NS_ConvertUTF16toUTF8(aStr), nsINetUtil::ESCAPE_URL_PATH, aResult);</span>
<a href="#l6.85"></a><span id="l6.85"> }</span>
<a href="#l6.86"></a><span id="l6.86"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -275,17 +275,17 @@ mime_generate_headers (nsMsgCompFields *</span>
<a href="#l7.4"></a><span id="l7.4">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l7.5"></a><span id="l7.5">   if (NS_FAILED(rv)) {</span>
<a href="#l7.6"></a><span id="l7.6">     *status = rv;</span>
<a href="#l7.7"></a><span id="l7.7">     return nullptr;</span>
<a href="#l7.8"></a><span id="l7.8">   }</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10">   bool usemime = nsMsgMIMEGetConformToStandard();</span>
<a href="#l7.11"></a><span id="l7.11">   int32_t size = 0;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  char *buffer = 0, *buffer_tail = 0;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  char *buffer = nullptr, *buffer_tail = nullptr;</span>
<a href="#l7.14"></a><span id="l7.14">   bool isDraft =</span>
<a href="#l7.15"></a><span id="l7.15">     deliver_mode == nsIMsgSend::nsMsgSaveAsDraft ||</span>
<a href="#l7.16"></a><span id="l7.16">     deliver_mode == nsIMsgSend::nsMsgSaveAsTemplate ||</span>
<a href="#l7.17"></a><span id="l7.17">     deliver_mode == nsIMsgSend::nsMsgQueueForLater ||</span>
<a href="#l7.18"></a><span id="l7.18">     deliver_mode == nsIMsgSend::nsMsgDeliverBackground;</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20">   const char* pFrom;</span>
<a href="#l7.21"></a><span id="l7.21">   const char* pTo;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -302,19 +302,20 @@ mime_generate_headers (nsMsgCompFields *</span>
<a href="#l7.23"></a><span id="l7.23">   char *convbuf;</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   bool hasDisclosedRecipient = false;</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">   nsAutoCString headerBuf;    // accumulate header strings to get length</span>
<a href="#l7.28"></a><span id="l7.28">   headerBuf.Truncate();</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">   NS_ASSERTION (fields, &quot;null fields&quot;);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  if (!fields)</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+  if (!fields) {</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+    *status = NS_ERROR_NULL_POINTER;</span>
<a href="#l7.34"></a><span id="l7.34">     return nullptr;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  }</span>
<a href="#l7.37"></a><span id="l7.37">   pFrom = fields-&gt;GetFrom();</span>
<a href="#l7.38"></a><span id="l7.38">   if (pFrom)</span>
<a href="#l7.39"></a><span id="l7.39">     headerBuf.Append(pFrom);</span>
<a href="#l7.40"></a><span id="l7.40">   pReplyTo =fields-&gt;GetReplyTo();</span>
<a href="#l7.41"></a><span id="l7.41">   if (pReplyTo)</span>
<a href="#l7.42"></a><span id="l7.42">     headerBuf.Append(pReplyTo);</span>
<a href="#l7.43"></a><span id="l7.43">   pTo = fields-&gt;GetTo();</span>
<a href="#l7.44"></a><span id="l7.44">   if (pTo)</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineat">@@ -338,18 +339,20 @@ mime_generate_headers (nsMsgCompFields *</span>
<a href="#l7.46"></a><span id="l7.46">   /* Multiply by 3 here to make enough room for MimePartII conversion */</span>
<a href="#l7.47"></a><span id="l7.47">   size += 3 * headerBuf.Length();</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49">   /* Add a bunch of slop for the static parts of the headers. */</span>
<a href="#l7.50"></a><span id="l7.50">   /* size += 2048; */</span>
<a href="#l7.51"></a><span id="l7.51">   size += 2560;</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53">   buffer = (char *) PR_Malloc (size);</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-  if (!buffer)</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+  if (!buffer) {</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    *status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.57"></a><span id="l7.57">     return nullptr; /* NS_ERROR_OUT_OF_MEMORY */</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  }</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60">   buffer_tail = buffer;</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62">   if (pMessageID &amp;&amp; *pMessageID) {</span>
<a href="#l7.63"></a><span id="l7.63">     PUSH_STRING (&quot;Message-ID: &quot;);</span>
<a href="#l7.64"></a><span id="l7.64">     PUSH_STRING (pMessageID);</span>
<a href="#l7.65"></a><span id="l7.65">     PUSH_NEWLINE ();</span>
<a href="#l7.66"></a><span id="l7.66">     /* MDN request header requires to have MessageID header presented</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineat">@@ -477,16 +480,17 @@ mime_generate_headers (nsMsgCompFields *</span>
<a href="#l7.68"></a><span id="l7.68">   PUSH_STRING (&quot;MIME-Version: 1.0&quot; CRLF);</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70">   if (pNewsGrp &amp;&amp; *pNewsGrp) {</span>
<a href="#l7.71"></a><span id="l7.71">     /* turn whitespace into a comma list</span>
<a href="#l7.72"></a><span id="l7.72">     */</span>
<a href="#l7.73"></a><span id="l7.73">     char *duppedNewsGrp = PL_strdup(pNewsGrp);</span>
<a href="#l7.74"></a><span id="l7.74">     if (!duppedNewsGrp) {</span>
<a href="#l7.75"></a><span id="l7.75">       PR_FREEIF(buffer);</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+      *status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.77"></a><span id="l7.77">       return nullptr; /* NS_ERROR_OUT_OF_MEMORY */</span>
<a href="#l7.78"></a><span id="l7.78">     }</span>
<a href="#l7.79"></a><span id="l7.79">     char *n2 = nsMsgStripLine(duppedNewsGrp);</span>
<a href="#l7.80"></a><span id="l7.80"> </span>
<a href="#l7.81"></a><span id="l7.81">     for(char *ptr = n2; *ptr != '\0'; ptr++) {</span>
<a href="#l7.82"></a><span id="l7.82">       /* find first non white space */</span>
<a href="#l7.83"></a><span id="l7.83">       while(!IS_SPACE(*ptr) &amp;&amp; *ptr != ',' &amp;&amp; *ptr != '\0')</span>
<a href="#l7.84"></a><span id="l7.84">         ptr++;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineat">@@ -510,17 +514,17 @@ mime_generate_headers (nsMsgCompFields *</span>
<a href="#l7.86"></a><span id="l7.86">     // to write to the outgoing message. In ANY case, we need to write the</span>
<a href="#l7.87"></a><span id="l7.87">     // &quot;Newsgroup&quot; header which is the &quot;proper&quot; header as opposed to the</span>
<a href="#l7.88"></a><span id="l7.88">     // HEADER_X_MOZILLA_NEWSHOST which can contain the &quot;news:&quot; URL's.</span>
<a href="#l7.89"></a><span id="l7.89">     //</span>
<a href="#l7.90"></a><span id="l7.90">     // Since n2 can contain data in the form of:</span>
<a href="#l7.91"></a><span id="l7.91">     // &quot;news://news.mozilla.org/netscape.test,news://news.mozilla.org/netscape.junk&quot;</span>
<a href="#l7.92"></a><span id="l7.92">     // we need to turn that into: &quot;netscape.test,netscape.junk&quot;</span>
<a href="#l7.93"></a><span id="l7.93">     //</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-    nsCOMPtr &lt;nsINntpService&gt; nntpService = do_GetService(&quot;@mozilla.org/messenger/nntpservice;1&quot;);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+    nsCOMPtr&lt;nsINntpService&gt; nntpService = do_GetService(&quot;@mozilla.org/messenger/nntpservice;1&quot;, &amp;rv);</span>
<a href="#l7.96"></a><span id="l7.96">     if (NS_FAILED(rv) || !nntpService) {</span>
<a href="#l7.97"></a><span id="l7.97">       *status = NS_ERROR_FAILURE;</span>
<a href="#l7.98"></a><span id="l7.98">       return nullptr;</span>
<a href="#l7.99"></a><span id="l7.99">     }</span>
<a href="#l7.100"></a><span id="l7.100"> </span>
<a href="#l7.101"></a><span id="l7.101">     nsCString newsgroupsHeaderVal;</span>
<a href="#l7.102"></a><span id="l7.102">     nsCString newshostHeaderVal;</span>
<a href="#l7.103"></a><span id="l7.103">     rv = nntpService-&gt;GenerateNewsHeaderValsForPosting(nsDependentCString(n2), getter_Copies(newsgroupsHeaderVal), getter_Copies(newshostHeaderVal));</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineat">@@ -702,23 +706,26 @@ mime_generate_headers (nsMsgCompFields *</span>
<a href="#l7.105"></a><span id="l7.105">   }</span>
<a href="#l7.106"></a><span id="l7.106"> </span>
<a href="#l7.107"></a><span id="l7.107">   if (pOtherHdr &amp;&amp; *pOtherHdr) {</span>
<a href="#l7.108"></a><span id="l7.108">     /* Assume they already have the right newlines and continuations</span>
<a href="#l7.109"></a><span id="l7.109">      and so on.  for these headers, the PUSH_NEWLINE() happens in addressingWidgetOverlay.js */</span>
<a href="#l7.110"></a><span id="l7.110">     PUSH_STRING (pOtherHdr);</span>
<a href="#l7.111"></a><span id="l7.111">   }</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-  if (buffer_tail &gt; buffer + size - 1)</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+  if (buffer_tail &gt; buffer + size - 1) {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+    PR_FREEIF(buffer);</span>
<a href="#l7.116"></a><span id="l7.116">     return nullptr;</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  }</span>
<a href="#l7.119"></a><span id="l7.119">   /* realloc it smaller... */</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-  buffer = (char*)PR_REALLOC (buffer, buffer_tail - buffer + 1);</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+  char *newBuffer = (char*) PR_REALLOC(buffer, buffer_tail - buffer + 1);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  if (!newBuffer) // The original bigger buffer is still usable to the caller.</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+    return buffer;</span>
<a href="#l7.124"></a><span id="l7.124"> </span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-  return buffer;</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+  return newBuffer;</span>
<a href="#l7.127"></a><span id="l7.127"> }</span>
<a href="#l7.128"></a><span id="l7.128"> </span>
<a href="#l7.129"></a><span id="l7.129"> static void</span>
<a href="#l7.130"></a><span id="l7.130"> GenerateGlobalRandomBytes(unsigned char *buf, int32_t len)</span>
<a href="#l7.131"></a><span id="l7.131"> {</span>
<a href="#l7.132"></a><span id="l7.132">   static bool      firstTime = true;</span>
<a href="#l7.133"></a><span id="l7.133"> </span>
<a href="#l7.134"></a><span id="l7.134">   if (firstTime)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -300,23 +300,22 @@ nsMsgSendLater::RebufferLeftovers(char *</span>
<a href="#l8.4"></a><span id="l8.4">   mLeftoverBuffer[aLen] = '\0';</span>
<a href="#l8.5"></a><span id="l8.5">   return NS_OK;</span>
<a href="#l8.6"></a><span id="l8.6"> }</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> nsresult</span>
<a href="#l8.9"></a><span id="l8.9"> nsMsgSendLater::BuildNewBuffer(const char* aBuf, uint32_t aCount, uint32_t *totalBufSize)</span>
<a href="#l8.10"></a><span id="l8.10"> {</span>
<a href="#l8.11"></a><span id="l8.11">   // Only build a buffer when there are leftovers...</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  if (!mLeftoverBuffer)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+  NS_ENSURE_TRUE(mLeftoverBuffer, NS_ERROR_FAILURE);</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">   int32_t leftoverSize = PL_strlen(mLeftoverBuffer);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-  mLeftoverBuffer = (char *)PR_Realloc(mLeftoverBuffer, aCount + leftoverSize);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-  if (!mLeftoverBuffer)</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  char* newBuffer = (char *) PR_Realloc(mLeftoverBuffer, aCount + leftoverSize);</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  NS_ENSURE_TRUE(newBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  mLeftoverBuffer = newBuffer;</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">   memcpy(mLeftoverBuffer + leftoverSize, aBuf, aCount);</span>
<a href="#l8.25"></a><span id="l8.25">   *totalBufSize = aCount + leftoverSize;</span>
<a href="#l8.26"></a><span id="l8.26">   return NS_OK;</span>
<a href="#l8.27"></a><span id="l8.27"> }</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29"> // Got data?</span>
<a href="#l8.30"></a><span id="l8.30"> NS_IMETHODIMP</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -3243,18 +3243,19 @@ NS_IMETHODIMP nsImapMailFolder::CopyData</span>
<a href="#l9.4"></a><span id="l9.4"> {</span>
<a href="#l9.5"></a><span id="l9.5">   uint32_t readCount;</span>
<a href="#l9.6"></a><span id="l9.6">   uint32_t writeCount;</span>
<a href="#l9.7"></a><span id="l9.7">   if (!m_copyState)</span>
<a href="#l9.8"></a><span id="l9.8">     m_copyState = new nsImapMailCopyState();</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10">   if ( aLength + m_copyState-&gt;m_leftOver &gt; m_copyState-&gt;m_dataBufferSize )</span>
<a href="#l9.11"></a><span id="l9.11">   {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    m_copyState-&gt;m_dataBuffer = (char *) PR_REALLOC(m_copyState-&gt;m_dataBuffer, aLength + m_copyState-&gt;m_leftOver+ 1);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-    NS_ENSURE_TRUE(m_copyState-&gt;m_dataBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+    char *newBuffer = (char*) PR_REALLOC(m_copyState-&gt;m_dataBuffer, aLength + m_copyState-&gt;m_leftOver+ 1);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+    NS_ENSURE_TRUE(newBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+    m_copyState-&gt;m_dataBuffer = newBuffer;</span>
<a href="#l9.17"></a><span id="l9.17">     m_copyState-&gt;m_dataBufferSize = aLength + m_copyState-&gt;m_leftOver;</span>
<a href="#l9.18"></a><span id="l9.18">   }</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">   char *start, *end;</span>
<a href="#l9.21"></a><span id="l9.21">   uint32_t linebreak_len = 1;</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23">   nsresult rv = aIStream-&gt;Read(m_copyState-&gt;m_dataBuffer+m_copyState-&gt;m_leftOver, aLength, &amp;readCount);</span>
<a href="#l9.24"></a><span id="l9.24">   if (NS_FAILED(rv))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/local/public/nsIPop3Sink.idl</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/local/public/nsIPop3Sink.idl</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -4,21 +4,21 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsIPop3IncomingServer.idl&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsIMsgFolder.idl&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> interface nsIURI;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-[scriptable, uuid(ceabfc6b-f139-4c25-890f-efb7c3069d3f)]</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+[scriptable, uuid(ceabfc6b-f139-4c25-890f-efb7c3069d40)]</span>
<a href="#l10.14"></a><span id="l10.14"> interface nsIPop3Sink : nsISupports {</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16">   attribute boolean userAuthenticated;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-  attribute string mailAccountURL;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+  attribute ACString mailAccountURL;</span>
<a href="#l10.19"></a><span id="l10.19">   attribute boolean buildMessageUri;</span>
<a href="#l10.20"></a><span id="l10.20">   attribute string messageUri;</span>
<a href="#l10.21"></a><span id="l10.21">   attribute string baseMessageUri;</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23">   /// message uri for header-only message version</span>
<a href="#l10.24"></a><span id="l10.24">   attribute ACString origMessageUri;</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26">   boolean BeginMailDelivery(in boolean uidlDownload, in nsIMsgWindow msgWindow);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -426,17 +426,17 @@ void nsMsgMailboxParser::AbortNewHeader(</span>
<a href="#l11.4"></a><span id="l11.4"> }</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> void nsMsgMailboxParser::OnNewMessage(nsIMsgWindow *msgWindow)</span>
<a href="#l11.7"></a><span id="l11.7"> {</span>
<a href="#l11.8"></a><span id="l11.8">   PublishMsgHeader(msgWindow);</span>
<a href="#l11.9"></a><span id="l11.9">   Clear();</span>
<a href="#l11.10"></a><span id="l11.10"> }</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-nsresult nsMsgMailboxParser::HandleLine(char *line, uint32_t lineLength)</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+nsresult nsMsgMailboxParser::HandleLine(const char *line, uint32_t lineLength)</span>
<a href="#l11.14"></a><span id="l11.14"> {</span>
<a href="#l11.15"></a><span id="l11.15">   /* If this is the very first line of a non-empty folder, make sure it's an envelope */</span>
<a href="#l11.16"></a><span id="l11.16">   if (m_graph_progress_received == 0)</span>
<a href="#l11.17"></a><span id="l11.17">   {</span>
<a href="#l11.18"></a><span id="l11.18">     /* This is the first block from the file.  Check to see if this</span>
<a href="#l11.19"></a><span id="l11.19">        looks like a mail file. */</span>
<a href="#l11.20"></a><span id="l11.20">     const char *s = line;</span>
<a href="#l11.21"></a><span id="l11.21">     const char *end = s + lineLength;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -159,17 +159,17 @@ public:</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5">   // message socket libnet callbacks, which come through folder pane</span>
<a href="#l12.6"></a><span id="l12.6">   nsresult ProcessMailboxInputStream(nsIURI* aURL, nsIInputStream *aIStream, uint32_t aLength);</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8">   virtual void  DoneParsingFolder(nsresult status);</span>
<a href="#l12.9"></a><span id="l12.9">   virtual void  AbortNewHeader();</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">   // for nsMsgLineBuffer</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  virtual nsresult HandleLine(char *line, uint32_t line_length);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  virtual nsresult HandleLine(const char *line, uint32_t line_length);</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15">   void  UpdateDBFolderInfo();</span>
<a href="#l12.16"></a><span id="l12.16">   void  UpdateDBFolderInfo(nsIMsgDatabase *mailDB);</span>
<a href="#l12.17"></a><span id="l12.17">   void  UpdateStatusText(const char* stringName);</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">   // Update the progress bar based on what we know.</span>
<a href="#l12.20"></a><span id="l12.20">   virtual void    UpdateProgressPercent ();</span>
<a href="#l12.21"></a><span id="l12.21">   virtual void OnNewMessage(nsIMsgWindow *msgWindow);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1868,20 +1868,16 @@ int32_t nsPop3Protocol::NextAuthStep()</span>
<a href="#l13.4"></a><span id="l13.4">                which causes the prompt to be different that time (to indicate</span>
<a href="#l13.5"></a><span id="l13.5">                that the old password was bogus.)</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7">                But if we're just checking for new mail (biff) then don't bother</span>
<a href="#l13.8"></a><span id="l13.8">                prompting the user for a password: just fail silently.</span>
<a href="#l13.9"></a><span id="l13.9">             */</span>
<a href="#l13.10"></a><span id="l13.10">             SetFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l13.11"></a><span id="l13.11">             Error(&quot;pop3PasswordFailure&quot;);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-            if (m_nsIPop3Sink)</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-                m_nsIPop3Sink-&gt;SetMailAccountURL(NULL);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-</span>
<a href="#l13.16"></a><span id="l13.16">             return 0;</span>
<a href="#l13.17"></a><span id="l13.17">         }</span>
<a href="#l13.18"></a><span id="l13.18">         PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l13.19"></a><span id="l13.19">            (&quot;still have some auth methods to try&quot;));</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21">         // TODO needed?</span>
<a href="#l13.22"></a><span id="l13.22">         //m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l13.23"></a><span id="l13.23"> </span>
<a href="#l13.24"></a><span id="l13.24" class="difflineat">@@ -2371,17 +2367,17 @@ int32_t</span>
<a href="#l13.25"></a><span id="l13.25"> nsPop3Protocol::GurlResponse()</span>
<a href="#l13.26"></a><span id="l13.26"> {</span>
<a href="#l13.27"></a><span id="l13.27">     ClearCapFlag(POP3_GURL_UNDEFINED);</span>
<a href="#l13.28"></a><span id="l13.28"> </span>
<a href="#l13.29"></a><span id="l13.29">     if (m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l13.30"></a><span id="l13.30">     {</span>
<a href="#l13.31"></a><span id="l13.31">         SetCapFlag(POP3_HAS_GURL);</span>
<a href="#l13.32"></a><span id="l13.32">         if (m_nsIPop3Sink)</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-            m_nsIPop3Sink-&gt;SetMailAccountURL(m_commandResponse.get());</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+            m_nsIPop3Sink-&gt;SetMailAccountURL(m_commandResponse);</span>
<a href="#l13.35"></a><span id="l13.35">     }</span>
<a href="#l13.36"></a><span id="l13.36">     else</span>
<a href="#l13.37"></a><span id="l13.37">     {</span>
<a href="#l13.38"></a><span id="l13.38">         ClearCapFlag(POP3_HAS_GURL);</span>
<a href="#l13.39"></a><span id="l13.39">     }</span>
<a href="#l13.40"></a><span id="l13.40">     m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l13.41"></a><span id="l13.41">     m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l13.42"></a><span id="l13.42"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -45,38 +45,30 @@</span>
<a href="#l14.4"></a><span id="l14.4"> extern PRLogModuleInfo *POP3LOGMODULE;</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsPop3Sink, nsIPop3Sink)</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> nsPop3Sink::nsPop3Sink()</span>
<a href="#l14.9"></a><span id="l14.9"> {</span>
<a href="#l14.10"></a><span id="l14.10">     m_authed = false;</span>
<a href="#l14.11"></a><span id="l14.11">     m_downloadingToTempFile = false;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    m_accountUrl = nullptr;</span>
<a href="#l14.13"></a><span id="l14.13">     m_biffState = 0;</span>
<a href="#l14.14"></a><span id="l14.14">     m_numNewMessages = 0;</span>
<a href="#l14.15"></a><span id="l14.15">     m_numNewMessagesInFolder = 0;</span>
<a href="#l14.16"></a><span id="l14.16">     m_numMsgsDownloaded = 0;</span>
<a href="#l14.17"></a><span id="l14.17">     m_senderAuthed = false;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-    m_outputBuffer = nullptr;</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-    m_outputBufferSize = 0;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-    m_popServer = nullptr;</span>
<a href="#l14.21"></a><span id="l14.21">     m_outFileStream = nullptr;</span>
<a href="#l14.22"></a><span id="l14.22">     m_uidlDownload = false;</span>
<a href="#l14.23"></a><span id="l14.23">     m_buildMessageUri = false;</span>
<a href="#l14.24"></a><span id="l14.24">     if (!POP3LOGMODULE)</span>
<a href="#l14.25"></a><span id="l14.25">       POP3LOGMODULE = PR_NewLogModule(&quot;POP3&quot;);</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-</span>
<a href="#l14.27"></a><span id="l14.27"> }</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29"> nsPop3Sink::~nsPop3Sink()</span>
<a href="#l14.30"></a><span id="l14.30"> {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-    PR_Free(m_accountUrl);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-    PR_Free(m_outputBuffer);</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-    NS_IF_RELEASE(m_popServer);</span>
<a href="#l14.34"></a><span id="l14.34">     PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;Calling ReleaseFolderLock from ~nsPop3Sink&quot;));</span>
<a href="#l14.35"></a><span id="l14.35">     ReleaseFolderLock();</span>
<a href="#l14.36"></a><span id="l14.36"> }</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38"> nsresult</span>
<a href="#l14.39"></a><span id="l14.39"> nsPop3Sink::SetUserAuthenticated(bool authed)</span>
<a href="#l14.40"></a><span id="l14.40"> {</span>
<a href="#l14.41"></a><span id="l14.41">   m_authed = authed;</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineat">@@ -93,35 +85,26 @@ nsPop3Sink::GetUserAuthenticated(bool* a</span>
<a href="#l14.43"></a><span id="l14.43"> nsresult</span>
<a href="#l14.44"></a><span id="l14.44"> nsPop3Sink::SetSenderAuthedFlag(void* closure, bool authed)</span>
<a href="#l14.45"></a><span id="l14.45"> {</span>
<a href="#l14.46"></a><span id="l14.46">   m_authed = authed;</span>
<a href="#l14.47"></a><span id="l14.47">   return NS_OK;</span>
<a href="#l14.48"></a><span id="l14.48"> }</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50"> nsresult</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-nsPop3Sink::SetMailAccountURL(const char* urlString)</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+nsPop3Sink::SetMailAccountURL(const nsACString &amp;urlString)</span>
<a href="#l14.53"></a><span id="l14.53"> {</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-  if (urlString)</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-  {</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-    PR_Free(m_accountUrl);</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-    m_accountUrl = PL_strdup(urlString);</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-  }</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+  m_accountUrl.Assign(urlString);</span>
<a href="#l14.61"></a><span id="l14.61">   return NS_OK;</span>
<a href="#l14.62"></a><span id="l14.62"> }</span>
<a href="#l14.63"></a><span id="l14.63"> </span>
<a href="#l14.64"></a><span id="l14.64"> nsresult</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-nsPop3Sink::GetMailAccountURL(char* *urlString)</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+nsPop3Sink::GetMailAccountURL(nsACString &amp;urlString)</span>
<a href="#l14.67"></a><span id="l14.67"> {</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-  NS_ASSERTION(urlString, &quot;null getter in getMailAccountURL&quot;);</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-  if (!urlString)</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-  *urlString = strdup(m_accountUrl);</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+  urlString.Assign(m_accountUrl);</span>
<a href="#l14.74"></a><span id="l14.74">   return NS_OK;</span>
<a href="#l14.75"></a><span id="l14.75"> }</span>
<a href="#l14.76"></a><span id="l14.76"> </span>
<a href="#l14.77"></a><span id="l14.77"> partialRecord::partialRecord() :</span>
<a href="#l14.78"></a><span id="l14.78">   m_msgDBHdr(nullptr)</span>
<a href="#l14.79"></a><span id="l14.79"> {</span>
<a href="#l14.80"></a><span id="l14.80"> }</span>
<a href="#l14.81"></a><span id="l14.81"> </span>
<a href="#l14.82"></a><span id="l14.82" class="difflineat">@@ -560,58 +543,58 @@ nsPop3Sink::IncorporateBegin(const char*</span>
<a href="#l14.83"></a><span id="l14.83">       int64_t fileSize;</span>
<a href="#l14.84"></a><span id="l14.84">       path-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l14.85"></a><span id="l14.85">       m_newMailParser-&gt;SetEnvelopePos((uint32_t) fileSize);</span>
<a href="#l14.86"></a><span id="l14.86">     }</span>
<a href="#l14.87"></a><span id="l14.87">   }</span>
<a href="#l14.88"></a><span id="l14.88">     if (closure)</span>
<a href="#l14.89"></a><span id="l14.89">         *closure = (void*) this;</span>
<a href="#l14.90"></a><span id="l14.90"> </span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-    char *dummyEnvelope = GetDummyEnvelope();</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-  rv = WriteLineToMailbox(dummyEnvelope);</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-    // write out account-key before UIDL so the code that looks for</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+    nsCString outputString(GetDummyEnvelope());</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+    rv = WriteLineToMailbox(outputString);</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+    // Write out account-key before UIDL so the code that looks for</span>
<a href="#l14.100"></a><span id="l14.100">     // UIDL will find the account first and know it can stop looking</span>
<a href="#l14.101"></a><span id="l14.101">     // once it finds the UIDL line.</span>
<a href="#l14.102"></a><span id="l14.102">     if (!m_accountKey.IsEmpty())</span>
<a href="#l14.103"></a><span id="l14.103">     {</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-      nsAutoCString outputString;</span>
<a href="#l14.105"></a><span id="l14.105">       outputString.AssignLiteral(HEADER_X_MOZILLA_ACCOUNT_KEY &quot;: &quot;);</span>
<a href="#l14.106"></a><span id="l14.106">       outputString.Append(m_accountKey);</span>
<a href="#l14.107"></a><span id="l14.107">       outputString.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-      WriteLineToMailbox(outputString.get());</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+      rv = WriteLineToMailbox(outputString);</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.111"></a><span id="l14.111">     }</span>
<a href="#l14.112"></a><span id="l14.112">     if (uidlString)</span>
<a href="#l14.113"></a><span id="l14.113">     {</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineminus">-      nsAutoCString uidlCString(&quot;X-UIDL: &quot;);</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-      uidlCString += uidlString;</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineminus">-      uidlCString += MSG_LINEBREAK;</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineminus">-      rv = WriteLineToMailbox(const_cast&lt;char*&gt;(uidlCString.get()));</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+      outputString.AssignLiteral(&quot;X-UIDL: &quot;);</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+      outputString.Append(uidlString);</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+      outputString.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+      rv = WriteLineToMailbox(outputString);</span>
<a href="#l14.122"></a><span id="l14.122">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.123"></a><span id="l14.123">     }</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+</span>
<a href="#l14.125"></a><span id="l14.125">     // WriteLineToMailbox(&quot;X-Mozilla-Status: 8000&quot; MSG_LINEBREAK);</span>
<a href="#l14.126"></a><span id="l14.126">     char *statusLine = PR_smprintf(X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, flags);</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineminus">-    rv = WriteLineToMailbox(statusLine);</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-    rv = WriteLineToMailbox(&quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK);</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+    outputString.Assign(statusLine);</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+    rv = WriteLineToMailbox(outputString);</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+    PR_smprintf_free(statusLine);</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+    rv = WriteLineToMailbox(NS_LITERAL_CSTRING(&quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK));</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+</span>
<a href="#l14.139"></a><span id="l14.139">     // leave space for 60 bytes worth of keys/tags</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineminus">-    rv = WriteLineToMailbox(X_MOZILLA_KEYWORDS);</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineminus">-    PR_smprintf_free(statusLine);</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+    rv = WriteLineToMailbox(NS_LITERAL_CSTRING(X_MOZILLA_KEYWORDS));</span>
<a href="#l14.143"></a><span id="l14.143">     return NS_OK;</span>
<a href="#l14.144"></a><span id="l14.144"> }</span>
<a href="#l14.145"></a><span id="l14.145"> </span>
<a href="#l14.146"></a><span id="l14.146"> NS_IMETHODIMP</span>
<a href="#l14.147"></a><span id="l14.147"> nsPop3Sink::SetPopServer(nsIPop3IncomingServer *server)</span>
<a href="#l14.148"></a><span id="l14.148"> {</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineminus">-  NS_IF_RELEASE(m_popServer);</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-  m_popServer=server;</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-  NS_ADDREF(m_popServer);</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+  m_popServer = server;</span>
<a href="#l14.154"></a><span id="l14.154">   return NS_OK;</span>
<a href="#l14.155"></a><span id="l14.155"> }</span>
<a href="#l14.156"></a><span id="l14.156"> </span>
<a href="#l14.157"></a><span id="l14.157"> NS_IMETHODIMP</span>
<a href="#l14.158"></a><span id="l14.158"> nsPop3Sink::GetPopServer(nsIPop3IncomingServer **aServer)</span>
<a href="#l14.159"></a><span id="l14.159"> {</span>
<a href="#l14.160"></a><span id="l14.160">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l14.161"></a><span id="l14.161">   NS_IF_ADDREF(*aServer = m_popServer);</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineat">@@ -629,18 +612,18 @@ NS_IMETHODIMP nsPop3Sink::SetFolder(nsIM</span>
<a href="#l14.163"></a><span id="l14.163"> {</span>
<a href="#l14.164"></a><span id="l14.164">   m_folder = aFolder;</span>
<a href="#l14.165"></a><span id="l14.165">   return NS_OK;</span>
<a href="#l14.166"></a><span id="l14.166"> }</span>
<a href="#l14.167"></a><span id="l14.167"> </span>
<a href="#l14.168"></a><span id="l14.168"> nsresult</span>
<a href="#l14.169"></a><span id="l14.169"> nsPop3Sink::GetServerFolder(nsIMsgFolder **aFolder)</span>
<a href="#l14.170"></a><span id="l14.170"> {</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-  if (!aFolder)</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+</span>
<a href="#l14.175"></a><span id="l14.175">   if (m_popServer)</span>
<a href="#l14.176"></a><span id="l14.176">   {</span>
<a href="#l14.177"></a><span id="l14.177">     // not sure what this is used for - might be wrong if we have a deferred account.</span>
<a href="#l14.178"></a><span id="l14.178">     nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer = do_QueryInterface(m_popServer);</span>
<a href="#l14.179"></a><span id="l14.179">     if (incomingServer)</span>
<a href="#l14.180"></a><span id="l14.180">       return incomingServer-&gt;GetRootFolder(aFolder);</span>
<a href="#l14.181"></a><span id="l14.181">   }</span>
<a href="#l14.182"></a><span id="l14.182">   *aFolder = nullptr;</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineat">@@ -673,63 +656,43 @@ nsPop3Sink::GetDummyEnvelope(void)</span>
<a href="#l14.184"></a><span id="l14.184">   PL_strcpy(result + 7 + 24, MSG_LINEBREAK);</span>
<a href="#l14.185"></a><span id="l14.185">   return result;</span>
<a href="#l14.186"></a><span id="l14.186"> }</span>
<a href="#l14.187"></a><span id="l14.187"> </span>
<a href="#l14.188"></a><span id="l14.188"> nsresult</span>
<a href="#l14.189"></a><span id="l14.189"> nsPop3Sink::IncorporateWrite(const char* block,</span>
<a href="#l14.190"></a><span id="l14.190">                              int32_t length)</span>
<a href="#l14.191"></a><span id="l14.191"> {</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineminus">-  int32_t blockOffset = 0;</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+  m_outputBuffer.Truncate();</span>
<a href="#l14.194"></a><span id="l14.194">   if (!strncmp(block, &quot;From &quot;, 5))</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineminus">-  {</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-    length++;</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-    blockOffset = 1;</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-  }</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-  if (!m_outputBuffer || length &gt; m_outputBufferSize)</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-  {</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineminus">-    if (!m_outputBuffer)</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineminus">-      m_outputBuffer = (char*) PR_MALLOC(length+1);</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineminus">-    else</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineminus">-      m_outputBuffer = (char*) PR_REALLOC(m_outputBuffer, length+1);</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+    m_outputBuffer.Assign('&gt;');</span>
<a href="#l14.206"></a><span id="l14.206"> </span>
<a href="#l14.207"></a><span id="l14.207" class="difflineminus">-    m_outputBufferSize = length;</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineminus">-  }</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineminus">-  if (m_outputBuffer)</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-  {</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineminus">-    if (blockOffset == 1)</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-      *m_outputBuffer = '&gt;';</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineminus">-    memcpy(m_outputBuffer + blockOffset, block, length - blockOffset);</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-    *(m_outputBuffer + length) = 0;</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-    nsresult rv = WriteLineToMailbox (m_outputBuffer);</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-  }</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineminus">-  return NS_OK;</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+  m_outputBuffer.Append(block);</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+  return WriteLineToMailbox(m_outputBuffer);</span>
<a href="#l14.222"></a><span id="l14.222"> }</span>
<a href="#l14.223"></a><span id="l14.223"> </span>
<a href="#l14.224"></a><span id="l14.224" class="difflineminus">-nsresult nsPop3Sink::WriteLineToMailbox(const char *buffer)</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+nsresult nsPop3Sink::WriteLineToMailbox(const nsACString&amp; buffer)</span>
<a href="#l14.226"></a><span id="l14.226"> {</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineminus">-</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineminus">-  if (buffer)</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineplus">+  if (!buffer.IsEmpty())</span>
<a href="#l14.230"></a><span id="l14.230">   {</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-    int32_t bufferLen = PL_strlen(buffer);</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-    if (m_newMailParser) // HandleLine should really take a const char *...</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineminus">-      m_newMailParser-&gt;HandleLine((char *) buffer, bufferLen);</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+    uint32_t bufferLen = buffer.Length();</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+    if (m_newMailParser)</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineplus">+      m_newMailParser-&gt;HandleLine(buffer.BeginReading(), bufferLen);</span>
<a href="#l14.237"></a><span id="l14.237">     // The following (!m_outFileStream etc) was added to make sure that we don't write somewhere</span>
<a href="#l14.238"></a><span id="l14.238">     // where for some reason or another we can't write to and lose the messages</span>
<a href="#l14.239"></a><span id="l14.239">     // See bug 62480</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-    if (!m_outFileStream)</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+    NS_ENSURE_TRUE(m_outFileStream, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l14.243"></a><span id="l14.243"> </span>
<a href="#l14.244"></a><span id="l14.244">     // seek to the end in case someone else has seeked elsewhere in our stream.</span>
<a href="#l14.245"></a><span id="l14.245">     nsCOMPtr &lt;nsISeekableStream&gt; seekableOutStream = do_QueryInterface(m_outFileStream);</span>
<a href="#l14.246"></a><span id="l14.246">     seekableOutStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l14.247"></a><span id="l14.247">     uint32_t bytesWritten;</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-    m_outFileStream-&gt;Write(buffer, bufferLen, &amp;bytesWritten);</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineminus">-    if ((int32_t) bytesWritten != bufferLen) return NS_ERROR_FAILURE;</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+    m_outFileStream-&gt;Write(buffer.BeginReading(), bufferLen, &amp;bytesWritten);</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+    NS_ENSURE_TRUE(bytesWritten == bufferLen, NS_ERROR_FAILURE);</span>
<a href="#l14.252"></a><span id="l14.252">   }</span>
<a href="#l14.253"></a><span id="l14.253">   return NS_OK;</span>
<a href="#l14.254"></a><span id="l14.254"> }</span>
<a href="#l14.255"></a><span id="l14.255"> </span>
<a href="#l14.256"></a><span id="l14.256"> nsresult nsPop3Sink::HandleTempDownloadFailed(nsIMsgWindow *msgWindow)</span>
<a href="#l14.257"></a><span id="l14.257"> {</span>
<a href="#l14.258"></a><span id="l14.258">   nsresult rv;</span>
<a href="#l14.259"></a><span id="l14.259">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineat">@@ -781,17 +744,17 @@ nsPop3Sink::IncorporateComplete(nsIMsgWi</span>
<a href="#l14.261"></a><span id="l14.261">       m_newMailParser-&gt;m_newMsgHdr)</span>
<a href="#l14.262"></a><span id="l14.262">   {</span>
<a href="#l14.263"></a><span id="l14.263">     uint32_t msgKey;</span>
<a href="#l14.264"></a><span id="l14.264">     m_newMailParser-&gt;m_newMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l14.265"></a><span id="l14.265">     m_messageUri.Truncate();</span>
<a href="#l14.266"></a><span id="l14.266">     nsBuildLocalMessageURI(m_baseMessageUri.get(), msgKey, m_messageUri);</span>
<a href="#l14.267"></a><span id="l14.267">   }</span>
<a href="#l14.268"></a><span id="l14.268"> </span>
<a href="#l14.269"></a><span id="l14.269" class="difflineminus">-  nsresult rv = WriteLineToMailbox(MSG_LINEBREAK);</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+  nsresult rv = WriteLineToMailbox(NS_LITERAL_CSTRING(MSG_LINEBREAK));</span>
<a href="#l14.271"></a><span id="l14.271">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.272"></a><span id="l14.272">   bool leaveOnServer = false;</span>
<a href="#l14.273"></a><span id="l14.273">   m_popServer-&gt;GetLeaveMessagesOnServer(&amp;leaveOnServer);</span>
<a href="#l14.274"></a><span id="l14.274">   // We need to flush the output stream, in case mail filters move</span>
<a href="#l14.275"></a><span id="l14.275">   // the new message, which relies on all the data being flushed.</span>
<a href="#l14.276"></a><span id="l14.276">   rv = m_outFileStream-&gt;Flush(); // Make sure the message is written to the disk</span>
<a href="#l14.277"></a><span id="l14.277">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.278"></a><span id="l14.278">   NS_ASSERTION(m_newMailParser, &quot;could not get m_newMailParser&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Sink.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Sink.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -11,16 +11,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;prmem.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;prio.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;plstr.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;prenv.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;nsTArray.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13"> </span>
<a href="#l15.14"></a><span id="l15.14"> class nsParseNewMailState;</span>
<a href="#l15.15"></a><span id="l15.15"> class nsIMsgFolder;</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17"> struct partialRecord</span>
<a href="#l15.18"></a><span id="l15.18"> {</span>
<a href="#l15.19"></a><span id="l15.19">   partialRecord();</span>
<a href="#l15.20"></a><span id="l15.20">   ~partialRecord();</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -39,31 +40,29 @@ public:</span>
<a href="#l15.22"></a><span id="l15.22">     NS_DECL_NSIPOP3SINK</span>
<a href="#l15.23"></a><span id="l15.23">     nsresult GetServerFolder(nsIMsgFolder **aFolder);</span>
<a href="#l15.24"></a><span id="l15.24">     nsresult FindPartialMessages();</span>
<a href="#l15.25"></a><span id="l15.25">     void CheckPartialMessages(nsIPop3Protocol *protocol);</span>
<a href="#l15.26"></a><span id="l15.26"> </span>
<a href="#l15.27"></a><span id="l15.27">     static char*  GetDummyEnvelope(void);</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29"> protected:</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-    nsresult WriteLineToMailbox(const char *buffer);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+    nsresult WriteLineToMailbox(const nsACString&amp; buffer);</span>
<a href="#l15.33"></a><span id="l15.33">     nsresult ReleaseFolderLock();</span>
<a href="#l15.34"></a><span id="l15.34">     nsresult HandleTempDownloadFailed(nsIMsgWindow *msgWindow);</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36">     bool m_authed;</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-    char* m_accountUrl;</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+    nsCString m_accountUrl;</span>
<a href="#l15.39"></a><span id="l15.39">     uint32_t m_biffState;</span>
<a href="#l15.40"></a><span id="l15.40">     int32_t m_numNewMessages;</span>
<a href="#l15.41"></a><span id="l15.41">     int32_t m_numNewMessagesInFolder;</span>
<a href="#l15.42"></a><span id="l15.42">     int32_t m_numMsgsDownloaded;</span>
<a href="#l15.43"></a><span id="l15.43">     bool m_senderAuthed;</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-    char* m_outputBuffer;</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-    int32_t m_outputBufferSize;</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-    nsIPop3IncomingServer *m_popServer;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+    nsCString m_outputBuffer;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+    nsCOMPtr&lt;nsIPop3IncomingServer&gt; m_popServer;</span>
<a href="#l15.49"></a><span id="l15.49">     //Currently the folder we want to update about biff info</span>
<a href="#l15.50"></a><span id="l15.50">     nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l15.51"></a><span id="l15.51">     nsRefPtr&lt;nsParseNewMailState&gt; m_newMailParser;</span>
<a href="#l15.52"></a><span id="l15.52">     nsCOMPtr &lt;nsIOutputStream&gt; m_outFileStream; // the file we write to, which may be temporary</span>
<a href="#l15.53"></a><span id="l15.53">     nsCOMPtr&lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l15.54"></a><span id="l15.54">     nsCOMPtr &lt;nsIOutputStream&gt; m_inboxOutputStream; // the actual mailbox</span>
<a href="#l15.55"></a><span id="l15.55">     bool m_uidlDownload;</span>
<a href="#l15.56"></a><span id="l15.56">     bool m_buildMessageUri;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

