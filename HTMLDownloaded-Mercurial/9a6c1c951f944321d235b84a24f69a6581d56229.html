<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 4288:9a6c1c951f944321d235b84a24f69a6581d56229</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9a6c1c951f944321d235b84a24f69a6581d56229" />
<meta property="og:url" content="/comm-central/rev/9a6c1c951f944321d235b84a24f69a6581d56229" />
<meta property="og:description" content="Fix bug 470430 - Upgrade 0.3.1 to 0.9/1.0pre fails [Error: Upgrade failed! DB Error: duplicate column name: is_organizer]. r=ssitter,mschroeder,dbo" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9a6c1c951f944321d235b84a24f69a6581d56229 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9a6c1c951f944321d235b84a24f69a6581d56229">shortlog</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9a6c1c951f944321d235b84a24f69a6581d56229">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9a6c1c951f944321d235b84a24f69a6581d56229">files</a> |
changeset |
<a href="/comm-central/raw-rev/9a6c1c951f944321d235b84a24f69a6581d56229">raw</a>  | <a href="/comm-central/archive/9a6c1c951f944321d235b84a24f69a6581d56229.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=470430">bug 470430</a> - Upgrade 0.3.1 to 0.9/1.0pre fails [Error: Upgrade failed! DB Error: duplicate column name: is_organizer]. r=ssitter,mschroeder,dbo
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 02 Nov 2009 22:37:26 +0100</td></tr>

<tr>
 <td>changeset 4288</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9a6c1c951f944321d235b84a24f69a6581d56229">9a6c1c951f944321d235b84a24f69a6581d56229</a></td>
</tr>



<tr>
<td>parent 4287</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ee5f853625bcfa566d25036080fc0ac08f40825b">ee5f853625bcfa566d25036080fc0ac08f40825b</a>
</td>
</tr>

<tr>
<td>child 4289</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e2f6c8192cdd3150f2dc8fc3bbb7cdc38d7f34d3">e2f6c8192cdd3150f2dc8fc3bbb7cdc38d7f34d3</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9a6c1c951f944321d235b84a24f69a6581d56229">3351</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Mon, 02 Nov 2009 21:38:31 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9a6c1c951f94 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9a6c1c951f944321d235b84a24f69a6581d56229">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9a6c1c951f944321d235b84a24f69a6581d56229&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9a6c1c951f944321d235b84a24f69a6581d56229&newProject=comm-central&newRevision=9a6c1c951f944321d235b84a24f69a6581d56229&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9a6c1c951f944321d235b84a24f69a6581d56229&newProject=comm-central&newRevision=9a6c1c951f944321d235b84a24f69a6581d56229&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9a6c1c951f944321d235b84a24f69a6581d56229&newProject=comm-central&newRevision=9a6c1c951f944321d235b84a24f69a6581d56229&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28ssitter%29&revcount=50">ssitter</a>, <a href="/comm-central/log?rev=reviewer%28mschroeder%29&revcount=50">mschroeder</a>, <a href="/comm-central/log?rev=reviewer%28dbo%29&revcount=50">dbo</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=470430">470430</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=470430">bug 470430</a> - Upgrade 0.3.1 to 0.9/1.0pre fails [Error: Upgrade failed! DB Error: duplicate column name: is_organizer]. r=ssitter,mschroeder,dbo</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calTimezoneService.js">calendar/base/src/calTimezoneService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calTimezoneService.js">file</a> |
<a href="/comm-central/annotate/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calTimezoneService.js">annotate</a> |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calTimezoneService.js">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calTimezoneService.js">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calTimezoneService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/Makefile.in">calendar/providers/storage/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/Makefile.in">file</a> |
<a href="/comm-central/annotate/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/Makefile.in">annotate</a> |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/Makefile.in">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/Makefile.in">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageCalendarModule.js">calendar/providers/storage/calStorageCalendarModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageCalendarModule.js">file</a> |
<a href="/comm-central/annotate/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageCalendarModule.js">annotate</a> |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageCalendarModule.js">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageHelpers.jsm">calendar/providers/storage/calStorageHelpers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageHelpers.jsm">file</a> |
<a href="/comm-central/annotate/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageHelpers.jsm">annotate</a> |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageHelpers.jsm">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageHelpers.jsm">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageHelpers.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageUpgrade.jsm">calendar/providers/storage/calStorageUpgrade.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageUpgrade.jsm">file</a> |
<a href="/comm-central/annotate/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageUpgrade.jsm">annotate</a> |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageUpgrade.jsm">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageUpgrade.jsm">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/calStorageUpgrade.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/makejsschema.pl">calendar/providers/storage/makejsschema.pl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/makejsschema.pl">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/makejsschema.pl">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/makejsschema.pl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-2.sql">calendar/providers/storage/schema-2.sql</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-2.sql">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-2.sql">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-2.sql">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-3.sql">calendar/providers/storage/schema-3.sql</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-3.sql">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-3.sql">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-3.sql">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-4.sql">calendar/providers/storage/schema-4.sql</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-4.sql">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-4.sql">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-4.sql">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-5.sql">calendar/providers/storage/schema-5.sql</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-5.sql">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-5.sql">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-5.sql">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-6.sql">calendar/providers/storage/schema-6.sql</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-6.sql">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-6.sql">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-6.sql">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-7.sql">calendar/providers/storage/schema-7.sql</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-7.sql">diff</a> |
<a href="/comm-central/comparison/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-7.sql">comparison</a> |
<a href="/comm-central/log/9a6c1c951f944321d235b84a24f69a6581d56229/calendar/providers/storage/schema-7.sql">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -608,41 +608,44 @@ calCalendarManager.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">                 // interface is missing.</span>
<a href="#l1.5"></a><span id="l1.5">                 return null;</span>
<a href="#l1.6"></a><span id="l1.6">             }</span>
<a href="#l1.7"></a><span id="l1.7">             let calendar = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type]</span>
<a href="#l1.8"></a><span id="l1.8">                                      .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l1.9"></a><span id="l1.9">             calendar.uri = uri;</span>
<a href="#l1.10"></a><span id="l1.10">             return calendar;</span>
<a href="#l1.11"></a><span id="l1.11">         } catch (ex) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-            var rc = ex;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-            var message = ex;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+            let rc = ex;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+            let uiMessage = ex;</span>
<a href="#l1.16"></a><span id="l1.16">             if (ex instanceof Components.interfaces.nsIException) {</span>
<a href="#l1.17"></a><span id="l1.17">                 rc = ex.result;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-                message = ex.message;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+                uiMessage = ex.message;</span>
<a href="#l1.20"></a><span id="l1.20">             }</span>
<a href="#l1.21"></a><span id="l1.21">             switch (rc) {</span>
<a href="#l1.22"></a><span id="l1.22">                 case Components.interfaces.calIErrors.STORAGE_UNKNOWN_SCHEMA_ERROR:</span>
<a href="#l1.23"></a><span id="l1.23">                     // For now we alert and quit on schema errors like we've done before:</span>
<a href="#l1.24"></a><span id="l1.24">                     this.alertAndQuit();</span>
<a href="#l1.25"></a><span id="l1.25">                 case Components.interfaces.calIErrors.STORAGE_UNKNOWN_TIMEZONES_ERROR:</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-                    message = calGetString(&quot;calendar&quot;, &quot;unknownTimezonesError&quot;, [uri.spec]);</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+                    uiMessage = calGetString(&quot;calendar&quot;, &quot;unknownTimezonesError&quot;, [uri.spec]);</span>
<a href="#l1.28"></a><span id="l1.28">                     break;</span>
<a href="#l1.29"></a><span id="l1.29">                 default:</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-                    message = calGetString(&quot;calendar&quot;, &quot;unableToCreateProvider&quot;, [uri.spec]);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+                    uiMessage = calGetString(&quot;calendar&quot;, &quot;unableToCreateProvider&quot;, [uri.spec]);</span>
<a href="#l1.32"></a><span id="l1.32">                     break;</span>
<a href="#l1.33"></a><span id="l1.33">             }</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-            ASSERT(false, message);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-            var paramBlock = Components.classes[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+            // Log the original exception via error console to provide more debug info</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+            cal.ERROR(ex);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+            // Log the possibly translated message via the UI.</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+            let paramBlock = Components.classes[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l1.41"></a><span id="l1.41">                                        .createInstance(Components.interfaces.nsIDialogParamBlock);</span>
<a href="#l1.42"></a><span id="l1.42">             paramBlock.SetNumberStrings(3);</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-            paramBlock.SetString(0, message);</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+            paramBlock.SetString(0, uiMessage);</span>
<a href="#l1.45"></a><span id="l1.45">             paramBlock.SetString(1, &quot;0x&quot; + rc.toString(0x10));</span>
<a href="#l1.46"></a><span id="l1.46">             paramBlock.SetString(2, ex);</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-            var wWatcher = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+            let wWatcher = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l1.49"></a><span id="l1.49">                                      .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l1.50"></a><span id="l1.50">             wWatcher.openWindow(null,</span>
<a href="#l1.51"></a><span id="l1.51">                                 &quot;chrome://calendar/content/calErrorPrompt.xul&quot;,</span>
<a href="#l1.52"></a><span id="l1.52">                                 &quot;_blank&quot;,</span>
<a href="#l1.53"></a><span id="l1.53">                                 &quot;chrome,dialog=yes,alwaysRaised=yes&quot;,</span>
<a href="#l1.54"></a><span id="l1.54">                                 paramBlock);</span>
<a href="#l1.55"></a><span id="l1.55">             return null;</span>
<a href="#l1.56"></a><span id="l1.56">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/src/calTimezoneService.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/src/calTimezoneService.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -118,83 +118,87 @@ function calTimezoneService() {</span>
<a href="#l2.4"></a><span id="l2.4"> }</span>
<a href="#l2.5"></a><span id="l2.5"> calTimezoneService.prototype = {</span>
<a href="#l2.6"></a><span id="l2.6">     mTimezoneCache: null,</span>
<a href="#l2.7"></a><span id="l2.7">     mBlacklist: null,</span>
<a href="#l2.8"></a><span id="l2.8">     mDefaultTimezone: null,</span>
<a href="#l2.9"></a><span id="l2.9">     mHasSetupObservers: false,</span>
<a href="#l2.10"></a><span id="l2.10">     floating: null,</span>
<a href="#l2.11"></a><span id="l2.11">     UTC: null,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    mDb: null,</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14">     createStatement: function calTimezoneService_createStatement(sql) {</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-        var statement = this.mDb.createStatement(sql);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-        var ret = Components.classes[&quot;@mozilla.org/storage/statement-wrapper;1&quot;]</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+        let statement = this.mDb.createStatement(sql);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+        let ret = Components.classes[&quot;@mozilla.org/storage/statement-wrapper;1&quot;]</span>
<a href="#l2.19"></a><span id="l2.19">                             .createInstance(Components.interfaces.mozIStorageStatementWrapper);</span>
<a href="#l2.20"></a><span id="l2.20">         ret.initialize(statement);</span>
<a href="#l2.21"></a><span id="l2.21">         return ret;</span>
<a href="#l2.22"></a><span id="l2.22">     },</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24">     ensureInitialized: function calTimezoneService_ensureInitialized() {</span>
<a href="#l2.25"></a><span id="l2.25">         if (!this.mDb) {</span>
<a href="#l2.26"></a><span id="l2.26">             // Calendar-timezones.xpi is preinstalled into the application, but</span>
<a href="#l2.27"></a><span id="l2.27">             // lightning.xpi yet doesn't contain the calendar-timezones.xpi, thus we package up</span>
<a href="#l2.28"></a><span id="l2.28">             // the timezones.sqlite as well as the timezones.properties into lightning for now.</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">             const kCalendarTimezonesXpiId = &quot;calendar-timezones@mozilla.org&quot;;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-            var sqlTzFile;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-            var bundleURL;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+            let sqlTzFile;</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+            let bundleURL;</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36">             try {</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-                var extMgr = Components.classes[&quot;@mozilla.org/extensions/manager;1&quot;]</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+                let extMgr = Components.classes[&quot;@mozilla.org/extensions/manager;1&quot;]</span>
<a href="#l2.39"></a><span id="l2.39">                                        .getService(Components.interfaces.nsIExtensionManager);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-                sqlTzFile = extMgr.getInstallLocation(kCalendarTimezonesXpiId).getItemLocation(kCalendarTimezonesXpiId);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+                sqlTzFile = extMgr.getInstallLocation(kCalendarTimezonesXpiId)</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+                                  .getItemLocation(kCalendarTimezonesXpiId);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+</span>
<a href="#l2.45"></a><span id="l2.45">                 bundleURL = &quot;chrome://calendar-timezones/locale/timezones.properties&quot;;</span>
<a href="#l2.46"></a><span id="l2.46">             } catch (exc) {</span>
<a href="#l2.47"></a><span id="l2.47">                 try {</span>
<a href="#l2.48"></a><span id="l2.48">                     if (!isSunbird()) { // probe for lightning; xxx todo, this will vanish when we repackage lightning</span>
<a href="#l2.49"></a><span id="l2.49">                         const kLightningXpiId = &quot;{e2fda1a4-762b-4020-b5ad-a41df1933103}&quot;;</span>
<a href="#l2.50"></a><span id="l2.50">                         sqlTzFile = extMgr.getInstallLocation(kLightningXpiId).getItemLocation(kLightningXpiId);</span>
<a href="#l2.51"></a><span id="l2.51">                         bundleURL = &quot;chrome://lightning/locale/timezones.properties&quot;;</span>
<a href="#l2.52"></a><span id="l2.52">                     }</span>
<a href="#l2.53"></a><span id="l2.53">                 } catch (exc) { // we land here in case of the unit tests:</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-                    var dirSvc = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+                    let dirSvc = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l2.56"></a><span id="l2.56">                                            .getService(Components.interfaces.nsIProperties);</span>
<a href="#l2.57"></a><span id="l2.57">                     sqlTzFile = dirSvc.get(&quot;CurProcD&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l2.58"></a><span id="l2.58">                     sqlTzFile.append(&quot;extensions&quot;);</span>
<a href="#l2.59"></a><span id="l2.59">                     sqlTzFile.append(kCalendarTimezonesXpiId);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-                    WARN(&quot;\### USING &quot; + sqlTzFile.path);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-                    var bundleFile = sqlTzFile.clone();</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+                    cal.WARN(&quot;\### USING &quot; + sqlTzFile.path);</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+                    let bundleFile = sqlTzFile.clone();</span>
<a href="#l2.64"></a><span id="l2.64">                     bundleFile.append(&quot;chrome&quot;);</span>
<a href="#l2.65"></a><span id="l2.65">                     bundleFile.append(&quot;calendar-timezones-en-US.jar&quot;);</span>
<a href="#l2.66"></a><span id="l2.66">                     bundleURL = &quot;jar:&quot; + getIOService().newFileURI(bundleFile).spec + &quot;!/locale/en-US/timezones.properties&quot;;</span>
<a href="#l2.67"></a><span id="l2.67">                 }</span>
<a href="#l2.68"></a><span id="l2.68">             }</span>
<a href="#l2.69"></a><span id="l2.69"> </span>
<a href="#l2.70"></a><span id="l2.70">             try {</span>
<a href="#l2.71"></a><span id="l2.71">                 sqlTzFile.append(&quot;timezones.sqlite&quot;);</span>
<a href="#l2.72"></a><span id="l2.72">                 cal.LOG(&quot;[calTimezoneService] using &quot; + sqlTzFile.path);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-                var dbService = Components.classes[&quot;@mozilla.org/storage/service;1&quot;]</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+                let dbService = Components.classes[&quot;@mozilla.org/storage/service;1&quot;]</span>
<a href="#l2.75"></a><span id="l2.75">                                           .getService(Components.interfaces.mozIStorageService);</span>
<a href="#l2.76"></a><span id="l2.76">                 this.mDb = dbService.openDatabase(sqlTzFile);</span>
<a href="#l2.77"></a><span id="l2.77">                 this.mSelectByTzid = this.createStatement(&quot;SELECT * FROM tz_data WHERE tzid = :tzid LIMIT 1&quot;);</span>
<a href="#l2.78"></a><span id="l2.78"> </span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-                var selectVersion = this.createStatement(&quot;SELECT version FROM tz_version LIMIT 1&quot;);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+                let selectVersion = this.createStatement(&quot;SELECT version FROM tz_version LIMIT 1&quot;);</span>
<a href="#l2.81"></a><span id="l2.81">                 try {</span>
<a href="#l2.82"></a><span id="l2.82">                     if (selectVersion.step()) {</span>
<a href="#l2.83"></a><span id="l2.83">                         this.mVersion = selectVersion.row.version;</span>
<a href="#l2.84"></a><span id="l2.84">                     }</span>
<a href="#l2.85"></a><span id="l2.85">                 } finally {</span>
<a href="#l2.86"></a><span id="l2.86">                     selectVersion.reset();</span>
<a href="#l2.87"></a><span id="l2.87">                 }</span>
<a href="#l2.88"></a><span id="l2.88">                 cal.LOG(&quot;[calTimezoneService] timezones version: &quot; + this.mVersion);</span>
<a href="#l2.89"></a><span id="l2.89"> </span>
<a href="#l2.90"></a><span id="l2.90">                 g_stringBundle = calGetStringBundle(bundleURL);</span>
<a href="#l2.91"></a><span id="l2.91">             } catch (exc) {</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-                var msg = calGetString(&quot;calendar&quot;, &quot;missingCalendarTimezonesError&quot;);</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-                Components.utils.reportError(msg);</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+                let msg = calGetString(&quot;calendar&quot;, &quot;missingCalendarTimezonesError&quot;);</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+                cal.ERROR(msg);</span>
<a href="#l2.96"></a><span id="l2.96">                 showError(msg);</span>
<a href="#l2.97"></a><span id="l2.97">             }</span>
<a href="#l2.98"></a><span id="l2.98">         }</span>
<a href="#l2.99"></a><span id="l2.99">     },</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101">     // nsIClassInfo:</span>
<a href="#l2.102"></a><span id="l2.102">     getInterfaces: function calTimezoneService_getInterfaces(count) {</span>
<a href="#l2.103"></a><span id="l2.103">         const ifaces = [Components.interfaces.calITimezoneService,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -977,20 +977,22 @@ function ASSERT(aCondition, aMessage, aC</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> /**</span>
<a href="#l3.6"></a><span id="l3.6">  * Uses the prompt service to display an error message.</span>
<a href="#l3.7"></a><span id="l3.7">  * This function cannot be migrated into a module file, because it relies on an outer window object.</span>
<a href="#l3.8"></a><span id="l3.8">  *</span>
<a href="#l3.9"></a><span id="l3.9">  * @param aMsg The message to be shown</span>
<a href="#l3.10"></a><span id="l3.10">  */</span>
<a href="#l3.11"></a><span id="l3.11"> function showError(aMsg) {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    ASSERT(window, &quot;missing window!&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-                                  .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    promptService.alert(window, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;), aMsg);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    let window = window || null;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    if (window) {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+        let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+                                      .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+        promptService.alert(window, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;), aMsg);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    }</span>
<a href="#l3.22"></a><span id="l3.22"> }</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24"> /**</span>
<a href="#l3.25"></a><span id="l3.25">  * Pick whichever of &quot;black&quot; or &quot;white&quot; will look better when used as a text</span>
<a href="#l3.26"></a><span id="l3.26">  * color against a background of bgColor.</span>
<a href="#l3.27"></a><span id="l3.27">  *</span>
<a href="#l3.28"></a><span id="l3.28">  * @param bgColor   the background color as a &quot;#RRGGBB&quot; string</span>
<a href="#l3.29"></a><span id="l3.29">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/providers/storage/Makefile.in</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/providers/storage/Makefile.in</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,9 +1,8 @@</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineminus">-# </span>
<a href="#l4.5"></a><span id="l4.5"> # ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.6"></a><span id="l4.6"> # Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.7"></a><span id="l4.7"> #</span>
<a href="#l4.8"></a><span id="l4.8"> # The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.9"></a><span id="l4.9"> # 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.10"></a><span id="l4.10"> # the License. You may obtain a copy of the License at</span>
<a href="#l4.11"></a><span id="l4.11"> # http://www.mozilla.org/MPL/</span>
<a href="#l4.12"></a><span id="l4.12"> #</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineat">@@ -42,16 +41,20 @@ srcdir		= @srcdir@</span>
<a href="#l4.14"></a><span id="l4.14"> VPATH		= @srcdir@</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> MODULE = calStorageCalendar</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> EXTRA_COMPONENTS = calStorageCalendarModule.js</span>
<a href="#l4.21"></a><span id="l4.21"> EXTRA_SCRIPTS = calStorageCalendar.js</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+EXTRA_JS_MODULES = \</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+    calStorageHelpers.jsm \</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+    calStorageUpgrade.jsm \</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+    $(NULL)</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27"> libs:: $(EXTRA_SCRIPTS)</span>
<a href="#l4.28"></a><span id="l4.28"> 	if test ! -d $(FINAL_TARGET)/calendar-js; then $(NSINSTALL) -D $(FINAL_TARGET)/calendar-js; fi</span>
<a href="#l4.29"></a><span id="l4.29"> 	$(INSTALL) $^ $(FINAL_TARGET)/calendar-js</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31"> # The install target must use SYSINSTALL, which is NSINSTALL in copy mode.</span>
<a href="#l4.32"></a><span id="l4.32"> install:: $(EXTRA_SCRIPTS)</span>
<a href="#l4.33"></a><span id="l4.33"> 	$(SYSINSTALL) $(IFLAGS1) $^ $(DESTDIR)$(mozappdir)/calendar-js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -42,225 +42,26 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.5"></a><span id="l5.5">  *</span>
<a href="#l5.6"></a><span id="l5.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l5.11"></a><span id="l5.11"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-const kStorageServiceContractID = &quot;@mozilla.org/storage/service;1&quot;;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-const kStorageServiceIID = Components.interfaces.mozIStorageService;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-const kCalICalendar = Components.interfaces.calICalendar;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-const kCalAttendeeContractID = &quot;@mozilla.org/calendar/attendee;1&quot;;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-const kCalIAttendee = Components.interfaces.calIAttendee;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-var CalAttendee;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-const kCalRecurrenceInfoContractID = &quot;@mozilla.org/calendar/recurrence-info;1&quot;;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-const kCalIRecurrenceInfo = Components.interfaces.calIRecurrenceInfo;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-var CalRecurrenceInfo;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-const kCalRecurrenceRuleContractID = &quot;@mozilla.org/calendar/recurrence-rule;1&quot;;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-const kCalIRecurrenceRule = Components.interfaces.calIRecurrenceRule;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-var CalRecurrenceRule;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-const kCalRecurrenceDateSetContractID = &quot;@mozilla.org/calendar/recurrence-date-set;1&quot;;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-const kCalIRecurrenceDateSet = Components.interfaces.calIRecurrenceDateSet;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-var CalRecurrenceDateSet;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-const kCalRecurrenceDateContractID = &quot;@mozilla.org/calendar/recurrence-date;1&quot;;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-const kCalIRecurrenceDate = Components.interfaces.calIRecurrenceDate;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-var CalRecurrenceDate;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-const kMozStorageStatementWrapperContractID = &quot;@mozilla.org/storage/statement-wrapper;1&quot;;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-const kMozStorageStatementWrapperIID = Components.interfaces.mozIStorageStatementWrapper;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-var MozStorageStatementWrapper;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-if (!kMozStorageStatementWrapperIID) {</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-    dump(&quot;*** mozStorage not available, calendar/storage provider will not function\n&quot;);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-}</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-function initCalStorageCalendarComponent() {</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    CalAttendee = new Components.Constructor(kCalAttendeeContractID, kCalIAttendee);</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-    CalRecurrenceInfo = new Components.Constructor(kCalRecurrenceInfoContractID, kCalIRecurrenceInfo);</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-    CalRecurrenceRule = new Components.Constructor(kCalRecurrenceRuleContractID, kCalIRecurrenceRule);</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-    CalRecurrenceDateSet = new Components.Constructor(kCalRecurrenceDateSetContractID, kCalIRecurrenceDateSet);</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-    CalRecurrenceDate = new Components.Constructor(kCalRecurrenceDateContractID, kCalIRecurrenceDate);</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-    MozStorageStatementWrapper = new Components.Constructor(kMozStorageStatementWrapperContractID, kMozStorageStatementWrapperIID);</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-}</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-//</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-// calStorageCalendar.js</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-//</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-const CAL_ITEM_TYPE_EVENT = 0;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-const CAL_ITEM_TYPE_TODO = 1;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-// bitmasks</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-const CAL_ITEM_FLAG_PRIVATE = 1;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-const CAL_ITEM_FLAG_HAS_ATTENDEES = 2;</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-const CAL_ITEM_FLAG_HAS_PROPERTIES = 4;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-const CAL_ITEM_FLAG_EVENT_ALLDAY = 8;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-const CAL_ITEM_FLAG_HAS_RECURRENCE = 16;</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-const CAL_ITEM_FLAG_HAS_EXCEPTIONS = 32;</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-const CAL_ITEM_FLAG_HAS_ATTACHMENTS = 64;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-const CAL_ITEM_FLAG_HAS_RELATIONS = 128;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-const CAL_ITEM_FLAG_HAS_ALARMS = 256;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calStorageUpgrade.jsm&quot;);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calStorageHelpers.jsm&quot;);</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75"> const USECS_PER_SECOND = 1000000;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+const kCalICalendar = Components.interfaces.calICalendar;</span>
<a href="#l5.77"></a><span id="l5.77"> </span>
<a href="#l5.78"></a><span id="l5.78"> var gTransCount = {};</span>
<a href="#l5.79"></a><span id="l5.79"> var gTransErr = {};</span>
<a href="#l5.80"></a><span id="l5.80"> </span>
<a href="#l5.81"></a><span id="l5.81"> //</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-// Storage helpers</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-//</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-function createStatement (dbconn, sql) {</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-    try {</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-        var stmt = dbconn.createStatement(sql);</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-        var wrapper = MozStorageStatementWrapper();</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-        wrapper.initialize(stmt);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-        return wrapper;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-    } catch (e) {</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-        Components.utils.reportError(</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-            &quot;mozStorage exception: createStatement failed, statement: '&quot; + </span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-            sql + &quot;', error: '&quot; + dbconn.lastErrorString + &quot;' - &quot; + e);</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-    }</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-    return null;</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-}</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-function getInUtcOrKeepFloating(dt) {</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-    var tz = dt.timezone;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-    if (tz.isFloating || tz.isUTC) {</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-        return dt;</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-    } else {</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-        return dt.getInTimezone(UTC());</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-    }</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-}</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-function textToDate(d) {</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-    var dval;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-    var tz = &quot;UTC&quot;;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-    if (d[0] == 'Z') {</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-        var strs = d.substr(2).split(&quot;:&quot;);</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-        dval = parseInt(strs[0]);</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-        tz = strs[1].replace(/%:/g, &quot;:&quot;).replace(/%%/g, &quot;%&quot;);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-    } else {</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-        dval = parseInt(d.substr(2));</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-    }</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-    var date;</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-    if (d[0] == 'U' || d[0] == 'Z') {</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-        date = newDateTime(dval, tz);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-    } else if (d[0] == 'L') {</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-        // is local time</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-        date = newDateTime(dval, &quot;floating&quot;);</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-    }</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-    if (d[1] == 'D')</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-        date.isDate = true;</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-    return date;</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-}</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-function dateToText(d) {</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-    var datestr;</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-    var tz = null;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-    if (!d.timezone.isFloating) {</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-        if (d.timezone.isUTC) {</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-            datestr = &quot;U&quot;;</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-        } else {</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-            datestr = &quot;Z&quot;;</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-            tz = d.timezone.tzid;</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-        }</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-    } else {</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-        datestr = &quot;L&quot;;</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-    }</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-    if (d.isDate) {</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-        datestr += &quot;D&quot;;</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-    } else {</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-        datestr += &quot;T&quot;;</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-    }</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-    datestr += d.nativeTime;</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-    if (tz) {</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-        // replace '%' with '%%', then replace ':' with '%:'</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-        tz = tz.replace(/%/g, &quot;%%&quot;);</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-        tz = tz.replace(/:/g, &quot;%:&quot;);</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-        datestr += &quot;:&quot; + tz;</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-    }</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-    return datestr;</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-}</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-// </span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-// other helpers</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-//</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-function calStorageTimezone(comp) {</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-    this.wrappedJSObject = this;</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-    this.provider = null;</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-    this.icalComponent = comp;</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-    this.tzid = comp.getFirstProperty(&quot;TZID&quot;).value;</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-    this.displayName = null;</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-    this.isUTC = false;</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-    this.isFloating = false;</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-    this.latitude = null;</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-    this.longitude = null;</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-}</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-calStorageTimezone.prototype = {</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-    toString: function() {</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-        return this.icalComponent.toString();</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-    }</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-};</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-var gForeignTimezonesCache = {};</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-function getTimezone(aTimezone) {</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-    let tz = null;</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-    if (aTimezone.indexOf(&quot;BEGIN:VTIMEZONE&quot;) == 0) {</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-        tz = gForeignTimezonesCache[aTimezone]; // using full definition as key</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-        if (!tz) {</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-            try {</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-                // cannot cope without parent VCALENDAR:</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-                var comp = getIcsService().parseICS(&quot;BEGIN:VCALENDAR\n&quot; + aTimezone + &quot;\nEND:VCALENDAR&quot;, null);</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-                tz = new calStorageTimezone(comp.getFirstSubcomponent(&quot;VTIMEZONE&quot;));</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-                gForeignTimezonesCache[aTimezone] = tz;</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-            } catch (exc) {</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-                ASSERT(false, exc);</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineminus">-            }</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-        }</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-    } else {</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-        tz = cal.getTimezoneService().getTimezone(aTimezone);</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-    }</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-    return tz;</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-}</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-function newDateTime(aNativeTime, aTimezone) {</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-    var t = createDateTime();</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-    t.nativeTime = aNativeTime;</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-    if (aTimezone) {</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-        var tz = getTimezone(aTimezone);</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-        if (tz) {</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-            t = t.getInTimezone(tz);</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-        } else {</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-            ASSERT(false, &quot;timezone not available: &quot; + aTimezone);</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-        }</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineminus">-    } else {</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-        t.timezone = floating();</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-    }</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-    return t;</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-}</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-//</span>
<a href="#l5.224"></a><span id="l5.224"> // calStorageCalendar</span>
<a href="#l5.225"></a><span id="l5.225"> //</span>
<a href="#l5.226"></a><span id="l5.226"> </span>
<a href="#l5.227"></a><span id="l5.227"> function calStorageCalendar() {</span>
<a href="#l5.228"></a><span id="l5.228">     this.initProviderBase();</span>
<a href="#l5.229"></a><span id="l5.229">     this.mItemCache = {};</span>
<a href="#l5.230"></a><span id="l5.230">     this.mRecEventCache = {};</span>
<a href="#l5.231"></a><span id="l5.231">     this.mRecTodoCache = {};</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineat">@@ -300,22 +101,22 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.233"></a><span id="l5.233"> </span>
<a href="#l5.234"></a><span id="l5.234">     createCalendar: function cSC_createCalendar() {</span>
<a href="#l5.235"></a><span id="l5.235">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.236"></a><span id="l5.236">     },</span>
<a href="#l5.237"></a><span id="l5.237"> </span>
<a href="#l5.238"></a><span id="l5.238">     deleteCalendar: function cSC_deleteCalendar(cal, listener) {</span>
<a href="#l5.239"></a><span id="l5.239">         cal = cal.wrappedJSObject;</span>
<a href="#l5.240"></a><span id="l5.240"> </span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-        for (var i in this.mDeleteEventExtras) {</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+        for (let i in this.mDeleteEventExtras) {</span>
<a href="#l5.243"></a><span id="l5.243">             this.mDeleteEventExtras[i].execute();</span>
<a href="#l5.244"></a><span id="l5.244">             this.mDeleteEventExtras[i].reset();</span>
<a href="#l5.245"></a><span id="l5.245">         }</span>
<a href="#l5.246"></a><span id="l5.246"> </span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-        for (var i in this.mDeleteTodoExtras) {</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+        for (let i in this.mDeleteTodoExtras) {</span>
<a href="#l5.249"></a><span id="l5.249">             this.mDeleteTodoExtras[i].execute();</span>
<a href="#l5.250"></a><span id="l5.250">             this.mDeleteTodoExtras[i].reset();</span>
<a href="#l5.251"></a><span id="l5.251">         }</span>
<a href="#l5.252"></a><span id="l5.252"> </span>
<a href="#l5.253"></a><span id="l5.253">         this.mDeleteAllEvents.execute();</span>
<a href="#l5.254"></a><span id="l5.254">         this.mDeleteAllEvents.reset();</span>
<a href="#l5.255"></a><span id="l5.255"> </span>
<a href="#l5.256"></a><span id="l5.256">         this.mDeleteAllTodos.execute();</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineat">@@ -359,47 +160,47 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.258"></a><span id="l5.258">         return this.mUri;</span>
<a href="#l5.259"></a><span id="l5.259">     },</span>
<a href="#l5.260"></a><span id="l5.260">     set uri(aUri) {</span>
<a href="#l5.261"></a><span id="l5.261">         // we can only load once</span>
<a href="#l5.262"></a><span id="l5.262">         if (this.mUri) {</span>
<a href="#l5.263"></a><span id="l5.263">             throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l5.264"></a><span id="l5.264">         }</span>
<a href="#l5.265"></a><span id="l5.265"> </span>
<a href="#l5.266"></a><span id="l5.266" class="difflineminus">-        var id = 0;</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+        let id = 0;</span>
<a href="#l5.268"></a><span id="l5.268"> </span>
<a href="#l5.269"></a><span id="l5.269">         // check if there's a ?id=</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineminus">-        var path = aUri.path;</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-        var pos = path.indexOf(&quot;?id=&quot;);</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+        let path = aUri.path;</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+        let pos = path.indexOf(&quot;?id=&quot;);</span>
<a href="#l5.274"></a><span id="l5.274"> </span>
<a href="#l5.275"></a><span id="l5.275">         if (pos != -1) {</span>
<a href="#l5.276"></a><span id="l5.276">             id = parseInt(path.substr(pos+4));</span>
<a href="#l5.277"></a><span id="l5.277">             path = path.substr(0, pos);</span>
<a href="#l5.278"></a><span id="l5.278">         }</span>
<a href="#l5.279"></a><span id="l5.279"> </span>
<a href="#l5.280"></a><span id="l5.280">         this.mCalId = id;</span>
<a href="#l5.281"></a><span id="l5.281">         this.mUri = aUri;</span>
<a href="#l5.282"></a><span id="l5.282"> </span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-        var dbService;</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+        let dbService = Components.classes[&quot;@mozilla.org/storage/service;1&quot;]</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+                                  .getService(Components.interfaces.mozIStorageService);</span>
<a href="#l5.286"></a><span id="l5.286">         if (aUri.scheme == &quot;file&quot;) {</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-            var fileURL = aUri.QueryInterface(Components.interfaces.nsIFileURL);</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+            let fileURL = aUri.QueryInterface(Components.interfaces.nsIFileURL);</span>
<a href="#l5.289"></a><span id="l5.289">             if (!fileURL)</span>
<a href="#l5.290"></a><span id="l5.290">                 throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.291"></a><span id="l5.291"> </span>
<a href="#l5.292"></a><span id="l5.292">             // open the database</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineminus">-            dbService = Components.classes[kStorageServiceContractID].getService(kStorageServiceIID);</span>
<a href="#l5.294"></a><span id="l5.294">             this.mDB = dbService.openDatabase(fileURL.file);</span>
<a href="#l5.295"></a><span id="l5.295">         } else if (aUri.scheme == &quot;moz-profile-calendar&quot;) {</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-            dbService = Components.classes[kStorageServiceContractID].getService(kStorageServiceIID);</span>
<a href="#l5.297"></a><span id="l5.297">             let localDB = cal.getCalendarDirectory();</span>
<a href="#l5.298"></a><span id="l5.298">             localDB.append(&quot;local.sqlite&quot;);</span>
<a href="#l5.299"></a><span id="l5.299">             localDB = dbService.openDatabase(localDB);</span>
<a href="#l5.300"></a><span id="l5.300"> </span>
<a href="#l5.301"></a><span id="l5.301">             this.mDB = dbService.openSpecialDatabase(&quot;profile&quot;);</span>
<a href="#l5.302"></a><span id="l5.302">             if (this.mDB.tableExists(&quot;cal_events&quot;)) { // migrate data to local.sqlite:</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+                cal.LOG(&quot;Storage: Migrating storage.sdb -&gt; local.sqlite&quot;);</span>
<a href="#l5.304"></a><span id="l5.304">                 this.initDB(); // upgrade schema before migating data</span>
<a href="#l5.305"></a><span id="l5.305">                 let attachStatement = createStatement(this.mDB, &quot;ATTACH DATABASE :file_path AS local_sqlite&quot;);</span>
<a href="#l5.306"></a><span id="l5.306">                 try {</span>
<a href="#l5.307"></a><span id="l5.307">                     attachStatement.params.file_path = localDB.databaseFile.path;</span>
<a href="#l5.308"></a><span id="l5.308">                     attachStatement.execute();</span>
<a href="#l5.309"></a><span id="l5.309">                 } catch (exc) {</span>
<a href="#l5.310"></a><span id="l5.310">                     cal.ERROR(exc + &quot;, error: &quot; + this.mDB.lastErrorString);</span>
<a href="#l5.311"></a><span id="l5.311">                     throw exc;</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineat">@@ -407,17 +208,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.313"></a><span id="l5.313">                     attachStatement.reset();</span>
<a href="#l5.314"></a><span id="l5.314">                 }</span>
<a href="#l5.315"></a><span id="l5.315">                 try {</span>
<a href="#l5.316"></a><span id="l5.316">                     // hold lock on storage.sdb until we've migrated data from storage.sdb:</span>
<a href="#l5.317"></a><span id="l5.317">                     this.mDB.beginTransactionAs(Components.interfaces.mozIStorageConnection.TRANSACTION_EXCLUSIVE);</span>
<a href="#l5.318"></a><span id="l5.318">                     try {</span>
<a href="#l5.319"></a><span id="l5.319">                         if (this.mDB.tableExists(&quot;cal_events&quot;)) { // check again (with lock)</span>
<a href="#l5.320"></a><span id="l5.320">                             // take over data and drop from storage.sdb tables:</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineminus">-                            for (let table in sqlTables) {</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+                            for (let table in getSqlTable(DB_SCHEMA_VERSION)) {</span>
<a href="#l5.323"></a><span id="l5.323">                                 this.mDB.executeSimpleSQL(&quot;CREATE TABLE local_sqlite.&quot; +  table +</span>
<a href="#l5.324"></a><span id="l5.324">                                                           &quot; AS SELECT * FROM &quot; + table +</span>
<a href="#l5.325"></a><span id="l5.325">                                                           &quot;; DROP TABLE IF EXISTS &quot; +  table);</span>
<a href="#l5.326"></a><span id="l5.326">                             }</span>
<a href="#l5.327"></a><span id="l5.327">                             this.mDB.commitTransaction();</span>
<a href="#l5.328"></a><span id="l5.328">                         } else { // migration done in the meantime</span>
<a href="#l5.329"></a><span id="l5.329">                             this.mDB.rollbackTransaction();</span>
<a href="#l5.330"></a><span id="l5.330">                         }</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineat">@@ -438,17 +239,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.332"></a><span id="l5.332">     },</span>
<a href="#l5.333"></a><span id="l5.333"> </span>
<a href="#l5.334"></a><span id="l5.334">     refresh: function cSC_refresh() {</span>
<a href="#l5.335"></a><span id="l5.335">         // no-op</span>
<a href="#l5.336"></a><span id="l5.336">     },</span>
<a href="#l5.337"></a><span id="l5.337"> </span>
<a href="#l5.338"></a><span id="l5.338">     // void addItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l5.339"></a><span id="l5.339">     addItem: function cSC_addItem(aItem, aListener) {</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineminus">-        var newItem = aItem.clone();</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+        let newItem = aItem.clone();</span>
<a href="#l5.342"></a><span id="l5.342">         return this.adoptItem(newItem, aListener);</span>
<a href="#l5.343"></a><span id="l5.343">     },</span>
<a href="#l5.344"></a><span id="l5.344"> </span>
<a href="#l5.345"></a><span id="l5.345">     // void adoptItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l5.346"></a><span id="l5.346">     adoptItem: function cSC_adoptItem(aItem, aListener) {</span>
<a href="#l5.347"></a><span id="l5.347">         if (this.readOnly) {</span>
<a href="#l5.348"></a><span id="l5.348">             this.notifyOperationComplete(aListener,</span>
<a href="#l5.349"></a><span id="l5.349">                                          Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineat">@@ -897,634 +698,26 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.351"></a><span id="l5.351">                                      null,</span>
<a href="#l5.352"></a><span id="l5.352">                                      null);</span>
<a href="#l5.353"></a><span id="l5.353"> </span>
<a href="#l5.354"></a><span id="l5.354">         //var profEndTime = Date.now();</span>
<a href="#l5.355"></a><span id="l5.355">         //dump (&quot;++++ getItems took: &quot; + (profEndTime - profStartTime) + &quot; ms\n&quot;);</span>
<a href="#l5.356"></a><span id="l5.356">     },</span>
<a href="#l5.357"></a><span id="l5.357"> </span>
<a href="#l5.358"></a><span id="l5.358">     //</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineminus">-    // Helper functions</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineminus">-    //</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineminus">-</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineminus">-    //</span>
<a href="#l5.363"></a><span id="l5.363">     // database handling</span>
<a href="#l5.364"></a><span id="l5.364">     //</span>
<a href="#l5.365"></a><span id="l5.365"> </span>
<a href="#l5.366"></a><span id="l5.366" class="difflineminus">-    // initialize the database schema.</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineminus">-    // needs to do some version checking</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-    initDBSchema: function cSC_initDBSchema() {</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineminus">-        for (table in sqlTables) {</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineminus">-            try {</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;DROP TABLE &quot; + table);</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineminus">-            } catch (e) { }</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">-            this.mDB.createTable(table, sqlTables[table]);</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineminus">-        }</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineminus">-        // Add a version stamp to the schema</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineminus">-        this.mDB.executeSimpleSQL(&quot;INSERT INTO cal_calendar_schema_version VALUES(&quot; + this.DB_SCHEMA_VERSION + &quot;)&quot;);</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineminus">-    },</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineminus">-</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineminus">-    DB_SCHEMA_VERSION: 16,</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineminus">-</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineminus">-    /** </span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-     * @return      db schema version</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineminus">-     * @exception   various, depending on error</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineminus">-     */</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineminus">-    getVersion: function calStorageGetVersion() {</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineminus">-        var selectSchemaVersion;</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineminus">-        var version = null;</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-        try {</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-            selectSchemaVersion = createStatement(this.mDB, </span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-                                  &quot;SELECT version FROM &quot; +</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineminus">-                                  &quot;cal_calendar_schema_version LIMIT 1&quot;);</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineminus">-            if (selectSchemaVersion.step()) {</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineminus">-                version = selectSchemaVersion.row.version;</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineminus">-            }</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineminus">-</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineminus">-            if (version !== null) {</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineminus">-                // This is the only place to leave this function gracefully.</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineminus">-                return version;</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineminus">-            }</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineminus">-        } catch (e) {</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineminus">-            dump (&quot;++++++++++++ calStorageGetVersion() error: &quot; +</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-                  this.mDB.lastErrorString + &quot;\n&quot;);</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineminus">-            Components.utils.reportError(&quot;Error getting storage calendar &quot; +</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineminus">-                                         &quot;schema version! DB Error: &quot; + </span>
<a href="#l5.407"></a><span id="l5.407" class="difflineminus">-                                         this.mDB.lastErrorString);</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineminus">-            throw e;</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineminus">-        } finally {</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineminus">-            if (selectSchemaVersion) {</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineminus">-                selectSchemaVersion.reset();</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineminus">-            }</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineminus">-        }</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineminus">-</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineminus">-        throw &quot;cal_calendar_schema_version SELECT returned no results&quot;;</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineminus">-    },</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineminus">-</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineminus">-    upgradeDB: function cSC_upgradeDB(oldVersion) {</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineminus">-        // some common helpers</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineminus">-        function addColumn(db, tableName, colName, colType) {</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineminus">-            db.executeSimpleSQL(&quot;ALTER TABLE &quot; + tableName + &quot; ADD COLUMN &quot; + colName + &quot; &quot; + colType);</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineminus">-        }</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineminus">-</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineminus">-        if (oldVersion == 2) {</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineminus">-            dump (&quot;**** Upgrading schema from 2 -&gt; 3\n&quot;);</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineminus">-</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineminus">-            this.mDB.beginTransaction();</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineminus">-            try {</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineminus">-                // the change between 2 and 3 includes the splitting of cal_items into</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-                // cal_events and cal_todos, and the addition of columns for</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineminus">-                // event_start_tz, event_end_tz, todo_entry_tz, todo_due_tz.</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineminus">-                // These need to default to &quot;UTC&quot; if their corresponding time is</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineminus">-                // given, since that's what the default was for v2 calendars</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineminus">-</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineminus">-                // create the two new tables</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineminus">-                try { this.mDB.executeSimpleSQL(&quot;DROP TABLE cal_events; DROP TABLE cal_todos;&quot;); } catch (e) { }</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineminus">-                this.mDB.createTable(&quot;cal_events&quot;, sqlTables[&quot;cal_events&quot;]);</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineminus">-                this.mDB.createTable(&quot;cal_todos&quot;, sqlTables[&quot;cal_todos&quot;]);</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineminus">-</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineminus">-                // copy stuff over</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineminus">-                var eventCols = [&quot;cal_id&quot;, &quot;id&quot;, &quot;time_created&quot;, &quot;last_modified&quot;, &quot;title&quot;,</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineminus">-                                 &quot;priority&quot;, &quot;privacy&quot;, &quot;ical_status&quot;, &quot;flags&quot;,</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineminus">-                                 &quot;event_start&quot;, &quot;event_end&quot;, &quot;event_stamp&quot;];</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineminus">-                var todoCols = [&quot;cal_id&quot;, &quot;id&quot;, &quot;time_created&quot;, &quot;last_modified&quot;, &quot;title&quot;,</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineminus">-                                &quot;priority&quot;, &quot;privacy&quot;, &quot;ical_status&quot;, &quot;flags&quot;,</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineminus">-                                &quot;todo_entry&quot;, &quot;todo_due&quot;, &quot;todo_completed&quot;, &quot;todo_complete&quot;];</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineminus">-</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;INSERT INTO cal_events(&quot; + eventCols.join(&quot;,&quot;) + &quot;) &quot; +</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineminus">-                                          &quot;     SELECT &quot; + eventCols.join(&quot;,&quot;) +</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineminus">-                                          &quot;       FROM cal_items WHERE item_type = 0&quot;);</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;INSERT INTO cal_todos(&quot; + todoCols.join(&quot;,&quot;) + &quot;) &quot; +</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineminus">-                                          &quot;     SELECT &quot; + todoCols.join(&quot;,&quot;) +</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineminus">-                                          &quot;       FROM cal_items WHERE item_type = 1&quot;);</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineminus">-</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineminus">-                // now fix up the new _tz columns</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_events SET event_start_tz = 'UTC' WHERE event_start IS NOT NULL&quot;);</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_events SET event_end_tz = 'UTC' WHERE event_end IS NOT NULL&quot;);</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_todos SET todo_entry_tz = 'UTC' WHERE todo_entry IS NOT NULL&quot;);</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_todos SET todo_due_tz = 'UTC' WHERE todo_due IS NOT NULL&quot;);</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_todos SET todo_completed_tz = 'UTC' WHERE todo_completed IS NOT NULL&quot;);</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineminus">-</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineminus">-                // finally update the version</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;DELETE FROM cal_calendar_schema_version; INSERT INTO cal_calendar_schema_version VALUES (3);&quot;);</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineminus">-</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineminus">-                this.mDB.commitTransaction();</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineminus">-</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineminus">-                oldVersion = 3;</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineminus">-            } catch (e) {</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineminus">-                dump (&quot;+++++++++++++++++ DB Error: &quot; + this.mDB.lastErrorString + &quot;\n&quot;);</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineminus">-                Components.utils.reportError(&quot;Upgrade failed! DB Error: &quot; +</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineminus">-                                             this.mDB.lastErrorString);</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineminus">-                this.mDB.rollbackTransaction();</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineminus">-                throw e;</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineminus">-            }</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineminus">-        }</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineminus">-</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineminus">-        if (oldVersion == 3) {</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineminus">-            dump (&quot;**** Upgrading schema from 3 -&gt; 4\n&quot;);</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineminus">-</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineminus">-            this.mDB.beginTransaction();</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-            try {</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineminus">-                // the change between 3 and 4 is the addition of</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineminus">-                // recurrence_id and recurrence_id_tz columns to</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineminus">-                // cal_events, cal_todos, cal_attendees, and cal_properties</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineminus">-                addColumn(this.mDB, &quot;cal_events&quot;, &quot;recurrence_id&quot;, &quot;INTEGER&quot;);</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineminus">-                addColumn(this.mDB, &quot;cal_events&quot;, &quot;recurrence_id_tz&quot;, &quot;VARCHAR&quot;);</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineminus">-</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineminus">-                addColumn(this.mDB, &quot;cal_todos&quot;, &quot;recurrence_id&quot;, &quot;INTEGER&quot;);</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineminus">-                addColumn(this.mDB, &quot;cal_todos&quot;, &quot;recurrence_id_tz&quot;, &quot;VARCHAR&quot;);</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineminus">-</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineminus">-                addColumn(this.mDB, &quot;cal_attendees&quot;, &quot;recurrence_id&quot;, &quot;INTEGER&quot;);</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineminus">-                addColumn(this.mDB, &quot;cal_attendees&quot;, &quot;recurrence_id_tz&quot;, &quot;VARCHAR&quot;);</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineminus">-</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineminus">-                addColumn(this.mDB, &quot;cal_properties&quot;, &quot;recurrence_id&quot;, &quot;INTEGER&quot;);</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineminus">-                addColumn(this.mDB, &quot;cal_properties&quot;, &quot;recurrence_id_tz&quot;, &quot;VARCHAR&quot;);</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineminus">-</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;DELETE FROM cal_calendar_schema_version; INSERT INTO cal_calendar_schema_version VALUES (4);&quot;);</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineminus">-                this.mDB.commitTransaction();</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineminus">-</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineminus">-                oldVersion = 4;</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineminus">-            } catch (e) {</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineminus">-                dump (&quot;+++++++++++++++++ DB Error: &quot; + this.mDB.lastErrorString + &quot;\n&quot;);</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineminus">-                Components.utils.reportError(&quot;Upgrade failed! DB Error: &quot; +</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineminus">-                                             this.mDB.lastErrorString);</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineminus">-                this.mDB.rollbackTransaction();</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineminus">-                throw e;</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineminus">-            }</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineminus">-        }</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineminus">-</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineminus">-        if (oldVersion == 4) {</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineminus">-            dump (&quot;**** Upgrading schema from 4 -&gt; 5\n&quot;);</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineminus">-</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineminus">-            this.mDB.beginTransaction();</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-            try {</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineminus">-                // the change between 4 and 5 is the addition of alarm_offset</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineminus">-                // and alarm_last_ack columns.  The alarm_time column is not</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineminus">-                // used in this version, but will likely return in future versions</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineminus">-                // so it is not being removed</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineminus">-                addColumn(this.mDB, &quot;cal_events&quot;, &quot;alarm_offset&quot;, &quot;INTEGER&quot;);</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineminus">-                addColumn(this.mDB, &quot;cal_events&quot;, &quot;alarm_related&quot;, &quot;INTEGER&quot;);</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineminus">-                addColumn(this.mDB, &quot;cal_events&quot;, &quot;alarm_last_ack&quot;, &quot;INTEGER&quot;);</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineminus">-</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineminus">-                addColumn(this.mDB, &quot;cal_todos&quot;, &quot;alarm_offset&quot;, &quot;INTEGER&quot;);</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineminus">-                addColumn(this.mDB, &quot;cal_todos&quot;, &quot;alarm_related&quot;, &quot;INTEGER&quot;);</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineminus">-                addColumn(this.mDB, &quot;cal_todos&quot;, &quot;alarm_last_ack&quot;, &quot;INTEGER&quot;);</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineminus">-</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_calendar_schema_version SET version = 5;&quot;);</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineminus">-                this.mDB.commitTransaction();</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineminus">-                oldVersion = 5;</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineminus">-            } catch (e) {</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineminus">-                dump (&quot;+++++++++++++++++ DB Error: &quot; + this.mDB.lastErrorString + &quot;\n&quot;);</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineminus">-                Components.utils.reportError(&quot;Upgrade failed! DB Error: &quot; +</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineminus">-                                             this.mDB.lastErrorString);</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineminus">-                this.mDB.rollbackTransaction();</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineminus">-                throw e;</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-            }</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineminus">-        }</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineminus">-</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineminus">-        if (oldVersion == 5) {</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineminus">-            dump (&quot;**** Upgrading schema from 5 -&gt; 6\n&quot;);</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineminus">-</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineminus">-            this.mDB.beginTransaction();</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineminus">-            try {</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineminus">-                // Schema changes between v5 and v6:</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineminus">-                //</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineminus">-                // - Change all STRING columns to TEXT to avoid SQLite's</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineminus">-                //   &quot;feature&quot; where it will automatically convert strings to</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineminus">-                //   numbers (ex: 10e4 -&gt; 10000). See bug 333688.</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineminus">-</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineminus">-</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineminus">-                // Create the new tables.</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineminus">-                var tableNames = [&quot;cal_events&quot;, &quot;cal_todos&quot;, &quot;cal_attendees&quot;,</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineminus">-                                  &quot;cal_recurrence&quot;, &quot;cal_properties&quot;];</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineminus">-</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineminus">-                var query = &quot;&quot;;</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineminus">-                try { </span>
<a href="#l5.557"></a><span id="l5.557" class="difflineminus">-                    for (var i in tableNames) {</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineminus">-                        query += &quot;DROP TABLE &quot; + tableNames[i] + &quot;_v6;&quot;</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineminus">-                    }</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineminus">-                    this.mDB.executeSimpleSQL(query);</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineminus">-                } catch (e) {</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineminus">-                    // We should get exceptions for trying to drop tables</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineminus">-                    // that don't (shouldn't) exist.</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineminus">-                }</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineminus">-</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineminus">-                this.mDB.createTable(&quot;cal_events_v6&quot;, sqlTables[&quot;cal_events&quot;]);</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineminus">-                this.mDB.createTable(&quot;cal_todos_v6&quot;, sqlTables[&quot;cal_todos&quot;]);</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineminus">-                this.mDB.createTable(&quot;cal_attendees_v6&quot;, sqlTables[&quot;cal_attendees&quot;]);</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineminus">-                this.mDB.createTable(&quot;cal_recurrence_v6&quot;, sqlTables[&quot;cal_recurrence&quot;]);</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineminus">-                this.mDB.createTable(&quot;cal_properties_v6&quot;, sqlTables[&quot;cal_properties&quot;]);</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineminus">-</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineminus">-</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineminus">-                // Copy in the data.</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineminus">-                var cal_events_cols = [&quot;cal_id&quot;, &quot;id&quot;, &quot;time_created&quot;,</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineminus">-                                       &quot;last_modified&quot;, &quot;title&quot;, &quot;priority&quot;,</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineminus">-                                       &quot;privacy&quot;, &quot;ical_status&quot;,</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineminus">-                                       &quot;recurrence_id&quot;, &quot;recurrence_id_tz&quot;,</span>
<a href="#l5.578"></a><span id="l5.578" class="difflineminus">-                                       &quot;flags&quot;, &quot;event_start&quot;,</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineminus">-                                       &quot;event_start_tz&quot;, &quot;event_end&quot;,</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineminus">-                                       &quot;event_end_tz&quot;, &quot;event_stamp&quot;,</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineminus">-                                       &quot;alarm_time&quot;, &quot;alarm_time_tz&quot;,</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineminus">-                                       &quot;alarm_offset&quot;, &quot;alarm_related&quot;,</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineminus">-                                       &quot;alarm_last_ack&quot;];</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineminus">-</span>
<a href="#l5.585"></a><span id="l5.585" class="difflineminus">-                var cal_todos_cols = [&quot;cal_id&quot;, &quot;id&quot;, &quot;time_created&quot;,</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineminus">-                                      &quot;last_modified&quot;, &quot;title&quot;, &quot;priority&quot;,</span>
<a href="#l5.587"></a><span id="l5.587" class="difflineminus">-                                      &quot;privacy&quot;, &quot;ical_status&quot;,</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineminus">-                                      &quot;recurrence_id&quot;, &quot;recurrence_id_tz&quot;,</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineminus">-                                      &quot;flags&quot;, &quot;todo_entry&quot;, &quot;todo_entry_tz&quot;,</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineminus">-                                      &quot;todo_due&quot;, &quot;todo_due_tz&quot;,</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineminus">-                                      &quot;todo_completed&quot;, &quot;todo_completed_tz&quot;,</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineminus">-                                      &quot;todo_complete&quot;, &quot;alarm_time&quot;,</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineminus">-                                      &quot;alarm_time_tz&quot;, &quot;alarm_offset&quot;,</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineminus">-                                      &quot;alarm_related&quot;, &quot;alarm_last_ack&quot;];</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineminus">-</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineminus">-                var cal_attendees_cols = [&quot;item_id&quot;, &quot;recurrence_id&quot;,</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineminus">-                                          &quot;recurrence_id_tz&quot;, &quot;attendee_id&quot;,</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineminus">-                                          &quot;common_name&quot;, &quot;rsvp&quot;, &quot;role&quot;,</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineminus">-                                          &quot;status&quot;, &quot;type&quot;];</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineminus">-</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineminus">-                var cal_recurrence_cols = [&quot;item_id&quot;, &quot;recur_index&quot;,</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineminus">-                                           &quot;recur_type&quot;, &quot;is_negative&quot;,</span>
<a href="#l5.603"></a><span id="l5.603" class="difflineminus">-                                           &quot;dates&quot;, &quot;count&quot;, &quot;end_date&quot;,</span>
<a href="#l5.604"></a><span id="l5.604" class="difflineminus">-                                           &quot;interval&quot;, &quot;second&quot;, &quot;minute&quot;,</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineminus">-                                           &quot;hour&quot;, &quot;day&quot;, &quot;monthday&quot;,</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineminus">-                                           &quot;yearday&quot;, &quot;weekno&quot;, &quot;month&quot;,</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineminus">-                                           &quot;setpos&quot;];</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineminus">-</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineminus">-                var cal_properties_cols = [&quot;item_id&quot;, &quot;recurrence_id&quot;,</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineminus">-                                           &quot;recurrence_id_tz&quot;, &quot;key&quot;,</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineminus">-                                           &quot;value&quot;];</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineminus">-</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineminus">-                var theDB = this.mDB;</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineminus">-                function copyDataOver(aTableName, aColumnNames) {</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineminus">-                    theDB.executeSimpleSQL(&quot;INSERT INTO &quot; + aTableName + &quot;_v6(&quot; + aColumnNames.join(&quot;,&quot;) + &quot;) &quot; + </span>
<a href="#l5.616"></a><span id="l5.616" class="difflineminus">-                                           &quot;     SELECT &quot; + aColumnNames.join(&quot;,&quot;) + </span>
<a href="#l5.617"></a><span id="l5.617" class="difflineminus">-                                           &quot;       FROM &quot; + aTableName + &quot;;&quot;);</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineminus">-                }</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineminus">-</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineminus">-                copyDataOver(&quot;cal_events&quot;, cal_events_cols);</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineminus">-                copyDataOver(&quot;cal_todos&quot;, cal_todos_cols);</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineminus">-                copyDataOver(&quot;cal_attendees&quot;, cal_attendees_cols);</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineminus">-                copyDataOver(&quot;cal_recurrence&quot;, cal_recurrence_cols);</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineminus">-                copyDataOver(&quot;cal_properties&quot;, cal_properties_cols);</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineminus">-</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineminus">-</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineminus">-                // Delete each old table and rename the new ones to use the</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineminus">-                // old tables' names.</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineminus">-                for (var i in tableNames) {</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineminus">-                    this.mDB.executeSimpleSQL(&quot;DROP TABLE  &quot; + tableNames[i] + &quot;;&quot; +</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineminus">-                                              &quot;ALTER TABLE &quot; + tableNames[i] + &quot;_v6&quot; + </span>
<a href="#l5.632"></a><span id="l5.632" class="difflineminus">-                                              &quot;  RENAME TO &quot; + tableNames[i] + &quot;;&quot;);</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineminus">-                }</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineminus">-</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineminus">-</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineminus">-                // Update the version stamp, and commit.</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_calendar_schema_version SET version = 6;&quot;);</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineminus">-                this.mDB.commitTransaction();</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineminus">-                oldVersion = 6;</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineminus">-            } catch (e) {</span>
<a href="#l5.641"></a><span id="l5.641" class="difflineminus">-                dump (&quot;+++++++++++++++++ DB Error: &quot; + this.mDB.lastErrorString + &quot;\n&quot;);</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineminus">-                Components.utils.reportError(&quot;Upgrade failed! DB Error: &quot; +</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineminus">-                                             this.mDB.lastErrorString);</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineminus">-                this.mDB.rollbackTransaction();</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineminus">-                throw e;</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineminus">-            }</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineminus">-        }</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineminus">-</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineminus">-        // add cal_tz_version for all versions 6, 7, 8, 9:</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineminus">-        if (oldVersion &gt;= 6 &amp;&amp; oldVersion &lt;= 9) {</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineminus">-            dump (&quot;**** Upgrading schema from 6/7/8/9 -&gt; 10\n&quot;);</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineminus">-            this.mDB.beginTransaction();</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineminus">-            try {</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineminus">-                this.mDB.createTable(&quot;cal_tz_version&quot;, sqlTables.cal_tz_version);</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineminus">-                // Update the version stamp, and commit.</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_calendar_schema_version SET version = 10;&quot;);</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineminus">-                this.mDB.commitTransaction();</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineminus">-                oldVersion = 10;</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineminus">-            } catch (e) {</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineminus">-                dump (&quot;+++++++++++++++++ DB Error: &quot; + this.mDB.lastErrorString + &quot;\n&quot;);</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineminus">-                Components.utils.reportError(&quot;Upgrade failed! DB Error: &quot; +</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineminus">-                                             this.mDB.lastErrorString);</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineminus">-                this.mDB.rollbackTransaction();</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineminus">-                throw e;</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineminus">-            }</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineminus">-        }</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineminus">-</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineminus">-        if (oldVersion &lt; 11) {</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineminus">-            this.mDB.beginTransaction();</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineminus">-            try {</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineminus">-                this.mDB.createTable(&quot;cal_attachments&quot;, sqlTables.cal_attachments);</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineminus">-</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineminus">-                // update schema</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_calendar_schema_version SET version = 11;&quot;);</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineminus">-                this.mDB.commitTransaction();</span>
<a href="#l5.676"></a><span id="l5.676" class="difflineminus">-                oldVersion = 11;</span>
<a href="#l5.677"></a><span id="l5.677" class="difflineminus">-            } catch (e) {</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineminus">-                cal.ERROR(&quot;Upgrade failed! DB Error: &quot; + this.mDB.lastErrorString);</span>
<a href="#l5.679"></a><span id="l5.679" class="difflineminus">-                this.mDB.rollbackTransaction();</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineminus">-                throw e;</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineminus">-            }</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineminus">-        }</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineminus">-</span>
<a href="#l5.684"></a><span id="l5.684" class="difflineminus">-        if (oldVersion &lt; 12) {</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineminus">-            this.mDB.beginTransaction();</span>
<a href="#l5.686"></a><span id="l5.686" class="difflineminus">-            try {</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineminus">-                this.mDB.createTable(&quot;cal_metadata&quot;, sqlTables.cal_metadata);</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineminus">-                addColumn(this.mDB, &quot;cal_attendees&quot;, &quot;is_organizer&quot;, &quot;BOOLEAN&quot;);</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineminus">-                addColumn(this.mDB, &quot;cal_attendees&quot;, &quot;properties&quot;, &quot;BLOB&quot;);</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineminus">-</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineminus">-                // update schema</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_calendar_schema_version SET version = 12;&quot;);</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineminus">-                this.mDB.commitTransaction();</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineminus">-                oldVersion = 12;</span>
<a href="#l5.695"></a><span id="l5.695" class="difflineminus">-            } catch (e) {</span>
<a href="#l5.696"></a><span id="l5.696" class="difflineminus">-                cal.ERROR(&quot;Upgrade failed! DB Error: &quot; + this.mDB.lastErrorString);</span>
<a href="#l5.697"></a><span id="l5.697" class="difflineminus">-                this.mDB.rollbackTransaction();</span>
<a href="#l5.698"></a><span id="l5.698" class="difflineminus">-                throw e;</span>
<a href="#l5.699"></a><span id="l5.699" class="difflineminus">-            }</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineminus">-        }</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineminus">-</span>
<a href="#l5.702"></a><span id="l5.702" class="difflineminus">-        if (oldVersion &lt; 13) {</span>
<a href="#l5.703"></a><span id="l5.703" class="difflineminus">-            this.mDB.beginTransaction();</span>
<a href="#l5.704"></a><span id="l5.704" class="difflineminus">-            try {</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineminus">-                // reset cal_metadata's item_id to longer be UNIQUE:</span>
<a href="#l5.706"></a><span id="l5.706" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;DROP TABLE IF EXISTS old_cal_metadata&quot;);</span>
<a href="#l5.707"></a><span id="l5.707" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;ALTER TABLE cal_metadata RENAME TO old_cal_metadata&quot;);</span>
<a href="#l5.708"></a><span id="l5.708" class="difflineminus">-                this.mDB.createTable(&quot;cal_metadata&quot;, sqlTables[&quot;cal_metadata&quot;]);</span>
<a href="#l5.709"></a><span id="l5.709" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;INSERT INTO cal_metadata&quot;</span>
<a href="#l5.710"></a><span id="l5.710" class="difflineminus">-                                          + &quot; (cal_id, item_id, value) &quot;</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineminus">-                                          + &quot; SELECT cal_id, item_id, value&quot;</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineminus">-                                          + &quot; FROM old_cal_metadata&quot;);</span>
<a href="#l5.713"></a><span id="l5.713" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;DROP TABLE old_cal_metadata&quot;);</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineminus">-</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineminus">-                // match item ids to cal_id:</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineminus">-                var calIds = {};</span>
<a href="#l5.717"></a><span id="l5.717" class="difflineminus">-                for each (var itemTable in [&quot;events&quot;, &quot;todos&quot;]) {</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineminus">-                    var stmt = createStatement(this.mDB,</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineminus">-                                               &quot;SELECT id, cal_id FROM cal_&quot; + itemTable);</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineminus">-                    while (stmt.step()) {</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineminus">-                        calIds[stmt.row.id] = stmt.row.cal_id;</span>
<a href="#l5.722"></a><span id="l5.722" class="difflineminus">-                    }</span>
<a href="#l5.723"></a><span id="l5.723" class="difflineminus">-                    stmt.reset();</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineminus">-                }</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineminus">-</span>
<a href="#l5.726"></a><span id="l5.726" class="difflineminus">-                for each (var updTable in [&quot;cal_attendees&quot;, &quot;cal_recurrence&quot;,</span>
<a href="#l5.727"></a><span id="l5.727" class="difflineminus">-                                           &quot;cal_properties&quot;, &quot;cal_attachments&quot;]) {</span>
<a href="#l5.728"></a><span id="l5.728" class="difflineminus">-                    try { // some tables might have been created with the</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineminus">-                          // required columns already, see previous upgrade pathes</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineminus">-                        addColumn(this.mDB, updTable, &quot;cal_id&quot;, &quot;INTEGER&quot;);</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineminus">-                    } catch (ace) {}</span>
<a href="#l5.732"></a><span id="l5.732" class="difflineminus">-</span>
<a href="#l5.733"></a><span id="l5.733" class="difflineminus">-                    for (var itemId in calIds) {</span>
<a href="#l5.734"></a><span id="l5.734" class="difflineminus">-                        this.mDB.executeSimpleSQL(&quot;UPDATE &quot; + updTable +</span>
<a href="#l5.735"></a><span id="l5.735" class="difflineminus">-                                                  &quot; SET cal_id = &quot; + calIds[itemId] +</span>
<a href="#l5.736"></a><span id="l5.736" class="difflineminus">-                                                  &quot; WHERE item_id = '&quot; + itemId + &quot;'&quot;);</span>
<a href="#l5.737"></a><span id="l5.737" class="difflineminus">-                     }</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineminus">-                }</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineminus">-</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;DROP INDEX IF EXISTS&quot; +</span>
<a href="#l5.741"></a><span id="l5.741" class="difflineminus">-                                          &quot; idx_cal_properies_item_id&quot;);</span>
<a href="#l5.742"></a><span id="l5.742" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;CREATE INDEX IF NOT EXISTS&quot; + </span>
<a href="#l5.743"></a><span id="l5.743" class="difflineminus">-                                          &quot; idx_cal_properies_item_id&quot; +</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineminus">-                                          &quot; ON cal_properties(cal_id, item_id);&quot;);</span>
<a href="#l5.745"></a><span id="l5.745" class="difflineminus">-</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_calendar_schema_version SET version = 13;&quot;);</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineminus">-                this.mDB.commitTransaction();</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineminus">-                oldVersion = 13;</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineminus">-            } catch (e) {</span>
<a href="#l5.750"></a><span id="l5.750" class="difflineminus">-                cal.ERROR(&quot;Upgrade failed! DB Error: &quot; + this.mDB.lastErrorString);</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineminus">-                this.mDB.rollbackTransaction();</span>
<a href="#l5.752"></a><span id="l5.752" class="difflineminus">-                throw e;</span>
<a href="#l5.753"></a><span id="l5.753" class="difflineminus">-            }</span>
<a href="#l5.754"></a><span id="l5.754" class="difflineminus">-        }</span>
<a href="#l5.755"></a><span id="l5.755" class="difflineminus">-</span>
<a href="#l5.756"></a><span id="l5.756" class="difflineminus">-        if (oldVersion &lt; 14) {</span>
<a href="#l5.757"></a><span id="l5.757" class="difflineminus">-            this.mDB.beginTransaction();</span>
<a href="#l5.758"></a><span id="l5.758" class="difflineminus">-            try {</span>
<a href="#l5.759"></a><span id="l5.759" class="difflineminus">-                this.mDB.createTable(&quot;cal_relations&quot;, sqlTables.cal_relations);</span>
<a href="#l5.760"></a><span id="l5.760" class="difflineminus">-                // update schema</span>
<a href="#l5.761"></a><span id="l5.761" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_calendar_schema_version SET version = 14;&quot;);</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineminus">-                this.mDB.commitTransaction();</span>
<a href="#l5.763"></a><span id="l5.763" class="difflineminus">-                oldVersion = 14;</span>
<a href="#l5.764"></a><span id="l5.764" class="difflineminus">-            } catch (e) {</span>
<a href="#l5.765"></a><span id="l5.765" class="difflineminus">-                cal.ERROR(&quot;Upgrade failed! DB Error: &quot; + this.mDB.lastErrorString);</span>
<a href="#l5.766"></a><span id="l5.766" class="difflineminus">-                this.mDB.rollbackTransaction();</span>
<a href="#l5.767"></a><span id="l5.767" class="difflineminus">-                throw e;</span>
<a href="#l5.768"></a><span id="l5.768" class="difflineminus">-            }</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineminus">-        }</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineminus">-</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineminus">-        if (oldVersion &lt; 15) {</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineminus">-            this.mDB.beginTransaction();</span>
<a href="#l5.773"></a><span id="l5.773" class="difflineminus">-            try {</span>
<a href="#l5.774"></a><span id="l5.774" class="difflineminus">-                addColumn(this.mDB, &quot;cal_todos&quot;, &quot;todo_stamp&quot;, &quot;INTEGER&quot;);</span>
<a href="#l5.775"></a><span id="l5.775" class="difflineminus">-                // update schema</span>
<a href="#l5.776"></a><span id="l5.776" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_calendar_schema_version SET version = 15;&quot;);</span>
<a href="#l5.777"></a><span id="l5.777" class="difflineminus">-                this.mDB.commitTransaction();</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineminus">-                oldVersion = 15;</span>
<a href="#l5.779"></a><span id="l5.779" class="difflineminus">-            } catch (e) {</span>
<a href="#l5.780"></a><span id="l5.780" class="difflineminus">-                cal.ERROR(&quot;Upgrade failed! DB Error: &quot; + this.mDB.lastErrorString);</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineminus">-                this.mDB.rollbackTransaction();</span>
<a href="#l5.782"></a><span id="l5.782" class="difflineminus">-                throw e;</span>
<a href="#l5.783"></a><span id="l5.783" class="difflineminus">-            }</span>
<a href="#l5.784"></a><span id="l5.784" class="difflineminus">-        }</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineminus">-</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineminus">-        if (oldVersion &lt; 16) {</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineminus">-            this.mDB.beginTransaction();</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineminus">-            try {</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineminus">-                this.mDB.createFunction(&quot;translateAlarm&quot;, 4, {</span>
<a href="#l5.790"></a><span id="l5.790" class="difflineminus">-                    onFunctionCall: function translateAlarm(storArgs) {</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineminus">-                        let [aOffset, aRelated, aAlarmTime, aTzId] =</span>
<a href="#l5.792"></a><span id="l5.792" class="difflineminus">-                            [0,1,2,3].map(function(i) storArgs.getUTF8String(i));</span>
<a href="#l5.793"></a><span id="l5.793" class="difflineminus">-</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineminus">-                        let alarm = cal.createAlarm();</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineminus">-                        if (aOffset) {</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineminus">-                            alarm.related = parseInt(aRelated, 10) + 1;</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineminus">-                            alarm.offset = cal.createDuration();</span>
<a href="#l5.798"></a><span id="l5.798" class="difflineminus">-                            alarm.offset.inSeconds = aOffset;</span>
<a href="#l5.799"></a><span id="l5.799" class="difflineminus">-                        } else if (aAlarmTime) {</span>
<a href="#l5.800"></a><span id="l5.800" class="difflineminus">-                            alarm.related = alarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l5.801"></a><span id="l5.801" class="difflineminus">-                            let alarmDate = cal.createDateTime();</span>
<a href="#l5.802"></a><span id="l5.802" class="difflineminus">-                            alarmDate.nativeTime = aAlarmTime;</span>
<a href="#l5.803"></a><span id="l5.803" class="difflineminus">-                            alarmDate.timezone = getTimezoneService().getTimezone(aTzId);</span>
<a href="#l5.804"></a><span id="l5.804" class="difflineminus">-                            alarm.alarmDate = alarmDate;</span>
<a href="#l5.805"></a><span id="l5.805" class="difflineminus">-                        }</span>
<a href="#l5.806"></a><span id="l5.806" class="difflineminus">-                        return alarm.icalString;</span>
<a href="#l5.807"></a><span id="l5.807" class="difflineminus">-                    }</span>
<a href="#l5.808"></a><span id="l5.808" class="difflineminus">-                });</span>
<a href="#l5.809"></a><span id="l5.809" class="difflineminus">-</span>
<a href="#l5.810"></a><span id="l5.810" class="difflineminus">-                let copyDataOver = function copyDataOver(tbl, db) {</span>
<a href="#l5.811"></a><span id="l5.811" class="difflineminus">-                    const transAlarm =  &quot;translateAlarm(alarm_offset, alarm_related, alarm_time, alarm_time_tz)&quot;;</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineminus">-                    db.executeSimpleSQL(&quot;INSERT INTO cal_alarms&quot; +</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineminus">-                        &quot;(cal_id, item_id, icalString) SELECT &quot; +</span>
<a href="#l5.814"></a><span id="l5.814" class="difflineminus">-                        &quot;cal_id, id, &quot; + transAlarm + &quot; FROM &quot; + tbl +</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineminus">-                        &quot; WHERE alarm_offset IS NOT NULL OR alarm_time IS NOT NULL;&quot;);</span>
<a href="#l5.816"></a><span id="l5.816" class="difflineminus">-</span>
<a href="#l5.817"></a><span id="l5.817" class="difflineminus">-                };</span>
<a href="#l5.818"></a><span id="l5.818" class="difflineminus">-                this.mDB.createTable(&quot;cal_alarms&quot;, sqlTables.cal_alarms);</span>
<a href="#l5.819"></a><span id="l5.819" class="difflineminus">-                copyDataOver(&quot;cal_events&quot;, this.mDB);</span>
<a href="#l5.820"></a><span id="l5.820" class="difflineminus">-                copyDataOver(&quot;cal_todos&quot;, this.mDB);</span>
<a href="#l5.821"></a><span id="l5.821" class="difflineminus">-                this.mDB.removeFunction(&quot;translateAlarm&quot;);</span>
<a href="#l5.822"></a><span id="l5.822" class="difflineminus">-</span>
<a href="#l5.823"></a><span id="l5.823" class="difflineminus">-                // Make sure the alarm flag is set on the item</span>
<a href="#l5.824"></a><span id="l5.824" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_events SET flags = flags | 256 WHERE id IN&quot; +</span>
<a href="#l5.825"></a><span id="l5.825" class="difflineminus">-                                          &quot; (SELECT item_id FROM cal_alarms WHERE cal_alarms.cal_id=cal_events.cal_id)&quot;);</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_todos SET flags = flags | 256 WHERE id IN&quot; +</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineminus">-                                          &quot; (SELECT item_id FROM cal_alarms WHERE cal_alarms.cal_id=cal_todos.cal_id)&quot;);</span>
<a href="#l5.828"></a><span id="l5.828" class="difflineminus">-</span>
<a href="#l5.829"></a><span id="l5.829" class="difflineminus">-                // remove column. Not possible via ALTER TABLE.</span>
<a href="#l5.830"></a><span id="l5.830" class="difflineminus">-                this.mDB.createTable(&quot;cal_events_v16&quot;, sqlTables.cal_events);</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineminus">-                this.mDB.createTable(&quot;cal_todos_v16&quot;, sqlTables.cal_todos);</span>
<a href="#l5.832"></a><span id="l5.832" class="difflineminus">-</span>
<a href="#l5.833"></a><span id="l5.833" class="difflineminus">-                let cal_events_cols = [&quot;cal_id&quot;, &quot;id&quot;, &quot;time_created&quot;,</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineminus">-                                       &quot;last_modified&quot;, &quot;title&quot;, &quot;priority&quot;,</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineminus">-                                       &quot;privacy&quot;, &quot;ical_status&quot;,</span>
<a href="#l5.836"></a><span id="l5.836" class="difflineminus">-                                       &quot;recurrence_id&quot;, &quot;recurrence_id_tz&quot;,</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineminus">-                                       &quot;flags&quot;, &quot;event_start&quot;,</span>
<a href="#l5.838"></a><span id="l5.838" class="difflineminus">-                                       &quot;event_start_tz&quot;, &quot;event_end&quot;,</span>
<a href="#l5.839"></a><span id="l5.839" class="difflineminus">-                                       &quot;event_end_tz&quot;, &quot;event_stamp&quot;,</span>
<a href="#l5.840"></a><span id="l5.840" class="difflineminus">-                                       &quot;alarm_last_ack&quot;];</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineminus">-</span>
<a href="#l5.842"></a><span id="l5.842" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;INSERT INTO cal_events_v16 (&quot; +</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineminus">-                                          cal_events_cols.join(&quot;,&quot;) + &quot;) &quot; +</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineminus">-                                          &quot;SELECT &quot; + cal_events_cols.join(&quot;,&quot;) +</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineminus">-                                          &quot; FROM cal_events&quot;);</span>
<a href="#l5.846"></a><span id="l5.846" class="difflineminus">-</span>
<a href="#l5.847"></a><span id="l5.847" class="difflineminus">-                let cal_todos_cols = [&quot;cal_id&quot;, &quot;id&quot;, &quot;time_created&quot;,</span>
<a href="#l5.848"></a><span id="l5.848" class="difflineminus">-                                      &quot;last_modified&quot;, &quot;title&quot;, &quot;priority&quot;,</span>
<a href="#l5.849"></a><span id="l5.849" class="difflineminus">-                                      &quot;privacy&quot;, &quot;ical_status&quot;,</span>
<a href="#l5.850"></a><span id="l5.850" class="difflineminus">-                                      &quot;recurrence_id&quot;, &quot;recurrence_id_tz&quot;,</span>
<a href="#l5.851"></a><span id="l5.851" class="difflineminus">-                                      &quot;flags&quot;, &quot;todo_entry&quot;, &quot;todo_entry_tz&quot;,</span>
<a href="#l5.852"></a><span id="l5.852" class="difflineminus">-                                      &quot;todo_due&quot;, &quot;todo_due_tz&quot;, &quot;todo_stamp&quot;,</span>
<a href="#l5.853"></a><span id="l5.853" class="difflineminus">-                                      &quot;todo_completed&quot;, &quot;todo_completed_tz&quot;,</span>
<a href="#l5.854"></a><span id="l5.854" class="difflineminus">-                                      &quot;todo_complete&quot;, &quot;alarm_last_ack&quot;];</span>
<a href="#l5.855"></a><span id="l5.855" class="difflineminus">-</span>
<a href="#l5.856"></a><span id="l5.856" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;INSERT INTO cal_todos_v16 (&quot; +</span>
<a href="#l5.857"></a><span id="l5.857" class="difflineminus">-                                          cal_todos_cols.join(&quot;,&quot;) + &quot;) &quot; +</span>
<a href="#l5.858"></a><span id="l5.858" class="difflineminus">-                                          &quot;SELECT &quot; + cal_todos_cols.join(&quot;,&quot;) +</span>
<a href="#l5.859"></a><span id="l5.859" class="difflineminus">-                                          &quot; FROM cal_todos&quot;);</span>
<a href="#l5.860"></a><span id="l5.860" class="difflineminus">-</span>
<a href="#l5.861"></a><span id="l5.861" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;DROP TABLE cal_events;&quot; +</span>
<a href="#l5.862"></a><span id="l5.862" class="difflineminus">-                                          &quot;ALTER TABLE cal_events_v16 RENAME TO cal_events;&quot;);</span>
<a href="#l5.863"></a><span id="l5.863" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;DROP TABLE cal_todos;&quot; +</span>
<a href="#l5.864"></a><span id="l5.864" class="difflineminus">-                                          &quot;ALTER TABLE cal_todos_v16 RENAME TO cal_todos;&quot;);</span>
<a href="#l5.865"></a><span id="l5.865" class="difflineminus">-</span>
<a href="#l5.866"></a><span id="l5.866" class="difflineminus">-                // update schema</span>
<a href="#l5.867"></a><span id="l5.867" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;UPDATE cal_calendar_schema_version SET version = 16;&quot;);</span>
<a href="#l5.868"></a><span id="l5.868" class="difflineminus">-                this.mDB.commitTransaction();</span>
<a href="#l5.869"></a><span id="l5.869" class="difflineminus">-                oldVersion = 16;</span>
<a href="#l5.870"></a><span id="l5.870" class="difflineminus">-            } catch (e) {</span>
<a href="#l5.871"></a><span id="l5.871" class="difflineminus">-                cal.ERROR(&quot;Upgrade to v16 failed! DB Error: &quot; +</span>
<a href="#l5.872"></a><span id="l5.872" class="difflineminus">-                          this.mDB.lastErrorString + &quot; ex: &quot; + e);</span>
<a href="#l5.873"></a><span id="l5.873" class="difflineminus">-                this.mDB.rollbackTransaction();</span>
<a href="#l5.874"></a><span id="l5.874" class="difflineminus">-                throw e;</span>
<a href="#l5.875"></a><span id="l5.875" class="difflineminus">-            }</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineminus">-        }</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineminus">-</span>
<a href="#l5.878"></a><span id="l5.878" class="difflineminus">-        if (oldVersion != this.DB_SCHEMA_VERSION) {</span>
<a href="#l5.879"></a><span id="l5.879" class="difflineminus">-            dump (&quot;#######!!!!! calStorageCalendar Schema Update failed -- db version: &quot; + oldVersion + &quot; this version: &quot; + this.DB_SCHEMA_VERSION + &quot;\n&quot;);</span>
<a href="#l5.880"></a><span id="l5.880" class="difflineminus">-            throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l5.881"></a><span id="l5.881" class="difflineminus">-        }</span>
<a href="#l5.882"></a><span id="l5.882" class="difflineminus">-    },</span>
<a href="#l5.883"></a><span id="l5.883" class="difflineminus">-</span>
<a href="#l5.884"></a><span id="l5.884" class="difflineminus">-    ensureUpdatedTimezones: function cSC_ensureUpdatedTimezones() {</span>
<a href="#l5.885"></a><span id="l5.885" class="difflineminus">-        // check if timezone version has changed:</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineminus">-        var selectTzVersion = createStatement(this.mDB, &quot;SELECT version FROM cal_tz_version LIMIT 1&quot;);</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineminus">-        var version;</span>
<a href="#l5.888"></a><span id="l5.888" class="difflineminus">-        try {</span>
<a href="#l5.889"></a><span id="l5.889" class="difflineminus">-            version = (selectTzVersion.step() ? selectTzVersion.row.version : null);</span>
<a href="#l5.890"></a><span id="l5.890" class="difflineminus">-        } finally {</span>
<a href="#l5.891"></a><span id="l5.891" class="difflineminus">-            selectTzVersion.reset();</span>
<a href="#l5.892"></a><span id="l5.892" class="difflineminus">-        }</span>
<a href="#l5.893"></a><span id="l5.893" class="difflineminus">-</span>
<a href="#l5.894"></a><span id="l5.894" class="difflineminus">-        var versionComp = 1;</span>
<a href="#l5.895"></a><span id="l5.895" class="difflineminus">-        if (version) {</span>
<a href="#l5.896"></a><span id="l5.896" class="difflineminus">-            versionComp = Components.classes[&quot;@mozilla.org/xpcom/version-comparator;1&quot;]</span>
<a href="#l5.897"></a><span id="l5.897" class="difflineminus">-                                    .getService(Components.interfaces.nsIVersionComparator)</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineminus">-                                    .compare(cal.getTimezoneService().version, version);</span>
<a href="#l5.899"></a><span id="l5.899" class="difflineminus">-        }</span>
<a href="#l5.900"></a><span id="l5.900" class="difflineminus">-</span>
<a href="#l5.901"></a><span id="l5.901" class="difflineminus">-        if (versionComp &lt; 0) {</span>
<a href="#l5.902"></a><span id="l5.902" class="difflineminus">-            // A timezones downgrade has happened!</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineminus">-            throw Components.interfaces.calIErrors.STORAGE_UNKNOWN_TIMEZONES_ERROR;</span>
<a href="#l5.904"></a><span id="l5.904" class="difflineminus">-        } else if (versionComp &gt; 0) {</span>
<a href="#l5.905"></a><span id="l5.905" class="difflineminus">-            LOG(&quot;timezones have been updated, updating calendar data.&quot;);</span>
<a href="#l5.906"></a><span id="l5.906" class="difflineminus">-</span>
<a href="#l5.907"></a><span id="l5.907" class="difflineminus">-            var zonesToUpdate = [];</span>
<a href="#l5.908"></a><span id="l5.908" class="difflineminus">-            var getZones = createStatement(</span>
<a href="#l5.909"></a><span id="l5.909" class="difflineminus">-                this.mDB,</span>
<a href="#l5.910"></a><span id="l5.910" class="difflineminus">-                &quot;SELECT DISTINCT(zone) FROM (&quot;+</span>
<a href="#l5.911"></a><span id="l5.911" class="difflineminus">-                &quot;SELECT recurrence_id_tz AS zone FROM cal_attendees  WHERE recurrence_id_tz IS NOT NULL UNION &quot; +</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineminus">-                &quot;SELECT recurrence_id_tz AS zone FROM cal_events     WHERE recurrence_id_tz IS NOT NULL UNION &quot; +</span>
<a href="#l5.913"></a><span id="l5.913" class="difflineminus">-                &quot;SELECT event_start_tz   AS zone FROM cal_events     WHERE event_start_tz   IS NOT NULL UNION &quot; +</span>
<a href="#l5.914"></a><span id="l5.914" class="difflineminus">-                &quot;SELECT event_end_tz     AS zone FROM cal_events     WHERE event_end_tz     IS NOT NULL UNION &quot; +</span>
<a href="#l5.915"></a><span id="l5.915" class="difflineminus">-                &quot;SELECT recurrence_id_tz AS zone FROM cal_properties WHERE recurrence_id_tz IS NOT NULL UNION &quot; +</span>
<a href="#l5.916"></a><span id="l5.916" class="difflineminus">-                &quot;SELECT recurrence_id_tz AS zone FROM cal_todos      WHERE recurrence_id_tz IS NOT NULL UNION &quot; +</span>
<a href="#l5.917"></a><span id="l5.917" class="difflineminus">-                &quot;SELECT todo_entry_tz    AS zone FROM cal_todos      WHERE todo_entry_tz    IS NOT NULL UNION &quot; +</span>
<a href="#l5.918"></a><span id="l5.918" class="difflineminus">-                &quot;SELECT todo_due_tz      AS zone FROM cal_todos      WHERE todo_due_tz      IS NOT NULL&quot; +</span>
<a href="#l5.919"></a><span id="l5.919" class="difflineminus">-                &quot;);&quot;);</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineminus">-            try {</span>
<a href="#l5.921"></a><span id="l5.921" class="difflineminus">-                while (getZones.step()) {</span>
<a href="#l5.922"></a><span id="l5.922" class="difflineminus">-                    var zone = getZones.row.zone;</span>
<a href="#l5.923"></a><span id="l5.923" class="difflineminus">-                    // Send the timezones off to the timezone service to attempt conversion:</span>
<a href="#l5.924"></a><span id="l5.924" class="difflineminus">-                    var tz = getTimezone(zone);</span>
<a href="#l5.925"></a><span id="l5.925" class="difflineminus">-                    if (tz) {</span>
<a href="#l5.926"></a><span id="l5.926" class="difflineminus">-                        var refTz = cal.getTimezoneService().getTimezone(tz.tzid);</span>
<a href="#l5.927"></a><span id="l5.927" class="difflineminus">-                        if (refTz &amp;&amp; refTz.tzid != zone) {</span>
<a href="#l5.928"></a><span id="l5.928" class="difflineminus">-                            zonesToUpdate.push({ oldTzId: zone, newTzId: refTz.tzid });</span>
<a href="#l5.929"></a><span id="l5.929" class="difflineminus">-                        }</span>
<a href="#l5.930"></a><span id="l5.930" class="difflineminus">-                    }</span>
<a href="#l5.931"></a><span id="l5.931" class="difflineminus">-                }</span>
<a href="#l5.932"></a><span id="l5.932" class="difflineminus">-            } finally {</span>
<a href="#l5.933"></a><span id="l5.933" class="difflineminus">-                getZones.reset();</span>
<a href="#l5.934"></a><span id="l5.934" class="difflineminus">-            }</span>
<a href="#l5.935"></a><span id="l5.935" class="difflineminus">-</span>
<a href="#l5.936"></a><span id="l5.936" class="difflineminus">-            this.mDB.beginTransaction();</span>
<a href="#l5.937"></a><span id="l5.937" class="difflineminus">-            try {</span>
<a href="#l5.938"></a><span id="l5.938" class="difflineminus">-                for each (var update in zonesToUpdate) {</span>
<a href="#l5.939"></a><span id="l5.939" class="difflineminus">-                    this.mDB.executeSimpleSQL(</span>
<a href="#l5.940"></a><span id="l5.940" class="difflineminus">-                        &quot;UPDATE cal_attendees  SET recurrence_id_tz = '&quot; + update.newTzId + &quot;' WHERE recurrence_id_tz = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l5.941"></a><span id="l5.941" class="difflineminus">-                        &quot;UPDATE cal_events     SET recurrence_id_tz = '&quot; + update.newTzId + &quot;' WHERE recurrence_id_tz = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l5.942"></a><span id="l5.942" class="difflineminus">-                        &quot;UPDATE cal_events     SET event_start_tz   = '&quot; + update.newTzId + &quot;' WHERE event_start_tz   = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l5.943"></a><span id="l5.943" class="difflineminus">-                        &quot;UPDATE cal_events     SET event_end_tz     = '&quot; + update.newTzId + &quot;' WHERE event_end_tz     = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l5.944"></a><span id="l5.944" class="difflineminus">-                        &quot;UPDATE cal_properties SET recurrence_id_tz = '&quot; + update.newTzId + &quot;' WHERE recurrence_id_tz = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l5.945"></a><span id="l5.945" class="difflineminus">-                        &quot;UPDATE cal_todos      SET recurrence_id_tz = '&quot; + update.newTzId + &quot;' WHERE recurrence_id_tz = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l5.946"></a><span id="l5.946" class="difflineminus">-                        &quot;UPDATE cal_todos      SET todo_entry_tz    = '&quot; + update.newTzId + &quot;' WHERE todo_entry_tz    = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l5.947"></a><span id="l5.947" class="difflineminus">-                        &quot;UPDATE cal_todos      SET todo_due_tz      = '&quot; + update.newTzId + &quot;' WHERE todo_due_tz      = '&quot; + update.oldTzId + &quot;';&quot;);</span>
<a href="#l5.948"></a><span id="l5.948" class="difflineminus">-                }</span>
<a href="#l5.949"></a><span id="l5.949" class="difflineminus">-                this.mDB.executeSimpleSQL(&quot;DELETE FROM cal_tz_version; INSERT INTO cal_tz_version VALUES ('&quot; +</span>
<a href="#l5.950"></a><span id="l5.950" class="difflineminus">-                                          cal.getTimezoneService().version + &quot;');&quot;);</span>
<a href="#l5.951"></a><span id="l5.951" class="difflineminus">-                this.mDB.commitTransaction();</span>
<a href="#l5.952"></a><span id="l5.952" class="difflineminus">-            } catch (exc) {</span>
<a href="#l5.953"></a><span id="l5.953" class="difflineminus">-                ASSERT(false, &quot;Timezone update failed! DB Error: &quot; + this.mDB.lastErrorString);</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineminus">-                this.mDB.rollbackTransaction();</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineminus">-                throw exc;</span>
<a href="#l5.956"></a><span id="l5.956" class="difflineminus">-            }</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineminus">-        }</span>
<a href="#l5.958"></a><span id="l5.958" class="difflineminus">-    },</span>
<a href="#l5.959"></a><span id="l5.959" class="difflineminus">-</span>
<a href="#l5.960"></a><span id="l5.960">     // database initialization</span>
<a href="#l5.961"></a><span id="l5.961">     // assumes mDB is valid</span>
<a href="#l5.962"></a><span id="l5.962"> </span>
<a href="#l5.963"></a><span id="l5.963">     initDB: function cSC_initDB() {</span>
<a href="#l5.964"></a><span id="l5.964">         ASSERT(this.mDB, &quot;Database has not been opened!&quot;, true);</span>
<a href="#l5.965"></a><span id="l5.965" class="difflineminus">-        if (!this.mDB.tableExists(&quot;cal_calendar_schema_version&quot;)) {</span>
<a href="#l5.966"></a><span id="l5.966" class="difflineminus">-            this.initDBSchema();</span>
<a href="#l5.967"></a><span id="l5.967" class="difflineminus">-        } else {</span>
<a href="#l5.968"></a><span id="l5.968" class="difflineminus">-            var version = this.getVersion();</span>
<a href="#l5.969"></a><span id="l5.969" class="difflineminus">-            if (version &lt; this.DB_SCHEMA_VERSION) {</span>
<a href="#l5.970"></a><span id="l5.970" class="difflineminus">-                this.upgradeDB(version);</span>
<a href="#l5.971"></a><span id="l5.971" class="difflineminus">-            } else if (version &gt; this.DB_SCHEMA_VERSION) {</span>
<a href="#l5.972"></a><span id="l5.972" class="difflineminus">-                throw Components.interfaces.calIErrors.STORAGE_UNKNOWN_SCHEMA_ERROR;</span>
<a href="#l5.973"></a><span id="l5.973" class="difflineminus">-            }</span>
<a href="#l5.974"></a><span id="l5.974" class="difflineminus">-        }</span>
<a href="#l5.975"></a><span id="l5.975"> </span>
<a href="#l5.976"></a><span id="l5.976" class="difflineminus">-        this.ensureUpdatedTimezones();</span>
<a href="#l5.977"></a><span id="l5.977" class="difflineplus">+        upgradeDB(this.mDB);</span>
<a href="#l5.978"></a><span id="l5.978"> </span>
<a href="#l5.979"></a><span id="l5.979">         // (Conditionally) add index</span>
<a href="#l5.980"></a><span id="l5.980">         this.mDB.executeSimpleSQL(</span>
<a href="#l5.981"></a><span id="l5.981">             &quot;CREATE INDEX IF NOT EXISTS &quot; + </span>
<a href="#l5.982"></a><span id="l5.982">             &quot;idx_cal_properies_item_id ON cal_properties(cal_id, item_id);&quot;</span>
<a href="#l5.983"></a><span id="l5.983">             );</span>
<a href="#l5.984"></a><span id="l5.984"> </span>
<a href="#l5.985"></a><span id="l5.985">         this.mSelectEvent = createStatement (</span>
<a href="#l5.986"></a><span id="l5.986" class="difflineat">@@ -1886,17 +1079,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.987"></a><span id="l5.987"> </span>
<a href="#l5.988"></a><span id="l5.988">         if (row.alarm_last_ack) {</span>
<a href="#l5.989"></a><span id="l5.989">             // alarm acks are always in utc</span>
<a href="#l5.990"></a><span id="l5.990">             item.alarmLastAck = newDateTime(row.alarm_last_ack, &quot;UTC&quot;);</span>
<a href="#l5.991"></a><span id="l5.991">         }</span>
<a href="#l5.992"></a><span id="l5.992"> </span>
<a href="#l5.993"></a><span id="l5.993">         if (row.recurrence_id) {</span>
<a href="#l5.994"></a><span id="l5.994">             item.recurrenceId = newDateTime(row.recurrence_id, row.recurrence_id_tz);</span>
<a href="#l5.995"></a><span id="l5.995" class="difflineminus">-            if ((row.flags &amp; CAL_ITEM_FLAG_EVENT_ALLDAY) != 0) {</span>
<a href="#l5.996"></a><span id="l5.996" class="difflineplus">+            if ((row.flags &amp; CAL_ITEM_FLAG.EVENT_ALLDAY) != 0) {</span>
<a href="#l5.997"></a><span id="l5.997">                 item.recurrenceId.isDate = true;</span>
<a href="#l5.998"></a><span id="l5.998">             }</span>
<a href="#l5.999"></a><span id="l5.999">         }</span>
<a href="#l5.1000"></a><span id="l5.1000"> </span>
<a href="#l5.1001"></a><span id="l5.1001">         if (flags)</span>
<a href="#l5.1002"></a><span id="l5.1002">             flags.value = row.flags;</span>
<a href="#l5.1003"></a><span id="l5.1003"> </span>
<a href="#l5.1004"></a><span id="l5.1004">         if (row.time_created) {</span>
<a href="#l5.1005"></a><span id="l5.1005" class="difflineat">@@ -1972,17 +1165,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1006"></a><span id="l5.1006">         item = createEvent();</span>
<a href="#l5.1007"></a><span id="l5.1007"> </span>
<a href="#l5.1008"></a><span id="l5.1008">         if (row.event_start)</span>
<a href="#l5.1009"></a><span id="l5.1009">             item.startDate = newDateTime(row.event_start, row.event_start_tz);</span>
<a href="#l5.1010"></a><span id="l5.1010">         if (row.event_end)</span>
<a href="#l5.1011"></a><span id="l5.1011">             item.endDate = newDateTime(row.event_end, row.event_end_tz);</span>
<a href="#l5.1012"></a><span id="l5.1012">         if (row.event_stamp)</span>
<a href="#l5.1013"></a><span id="l5.1013">             item.setProperty(&quot;DTSTAMP&quot;, newDateTime(row.event_stamp, &quot;UTC&quot;));</span>
<a href="#l5.1014"></a><span id="l5.1014" class="difflineminus">-        if ((row.flags &amp; CAL_ITEM_FLAG_EVENT_ALLDAY) != 0) {</span>
<a href="#l5.1015"></a><span id="l5.1015" class="difflineplus">+        if ((row.flags &amp; CAL_ITEM_FLAG.EVENT_ALLDAY) != 0) {</span>
<a href="#l5.1016"></a><span id="l5.1016">             item.startDate.isDate = true;</span>
<a href="#l5.1017"></a><span id="l5.1017">             item.endDate.isDate = true;</span>
<a href="#l5.1018"></a><span id="l5.1018">         }</span>
<a href="#l5.1019"></a><span id="l5.1019"> </span>
<a href="#l5.1020"></a><span id="l5.1020">         // This must be done last to keep the modification time intact.</span>
<a href="#l5.1021"></a><span id="l5.1021">         this.getItemBaseFromRow (row, flags, item);</span>
<a href="#l5.1022"></a><span id="l5.1022">         this.getAdditionalDataForItem(item, flags.value);</span>
<a href="#l5.1023"></a><span id="l5.1023"> </span>
<a href="#l5.1024"></a><span id="l5.1024" class="difflineat">@@ -2031,17 +1224,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1025"></a><span id="l5.1025"> </span>
<a href="#l5.1026"></a><span id="l5.1026">     // We used to use mDBTwo for this, so this can be run while a</span>
<a href="#l5.1027"></a><span id="l5.1027">     // select is executing but this no longer seems to be required.</span>
<a href="#l5.1028"></a><span id="l5.1028">     </span>
<a href="#l5.1029"></a><span id="l5.1029">     getAdditionalDataForItem: function cSC_getAdditionalDataForItem(item, flags) {</span>
<a href="#l5.1030"></a><span id="l5.1030">         // This is needed to keep the modification time intact.</span>
<a href="#l5.1031"></a><span id="l5.1031">         var savedLastModifiedTime = item.lastModifiedTime;</span>
<a href="#l5.1032"></a><span id="l5.1032"> </span>
<a href="#l5.1033"></a><span id="l5.1033" class="difflineminus">-        if (flags &amp; CAL_ITEM_FLAG_HAS_ATTENDEES) {</span>
<a href="#l5.1034"></a><span id="l5.1034" class="difflineplus">+        if (flags &amp; CAL_ITEM_FLAG.HAS_ATTENDEES) {</span>
<a href="#l5.1035"></a><span id="l5.1035">             var selectItem = null;</span>
<a href="#l5.1036"></a><span id="l5.1036">             if (item.recurrenceId == null)</span>
<a href="#l5.1037"></a><span id="l5.1037">                 selectItem = this.mSelectAttendeesForItem;</span>
<a href="#l5.1038"></a><span id="l5.1038">             else {</span>
<a href="#l5.1039"></a><span id="l5.1039">                 selectItem = this.mSelectAttendeesForItemWithRecurrenceId;</span>
<a href="#l5.1040"></a><span id="l5.1040">                 this.setDateParamHelper(selectItem.params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l5.1041"></a><span id="l5.1041">             }</span>
<a href="#l5.1042"></a><span id="l5.1042"> </span>
<a href="#l5.1043"></a><span id="l5.1043" class="difflineat">@@ -2061,17 +1254,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1044"></a><span id="l5.1044">                           item.title + &quot;' (&quot; + item.id + &quot;)!\n&quot; + e +</span>
<a href="#l5.1045"></a><span id="l5.1045">                           &quot;\nDB Error: &quot; + this.mDB.lastErrorString);</span>
<a href="#l5.1046"></a><span id="l5.1046">             } finally {</span>
<a href="#l5.1047"></a><span id="l5.1047">                 selectItem.reset();</span>
<a href="#l5.1048"></a><span id="l5.1048">             }</span>
<a href="#l5.1049"></a><span id="l5.1049">         }</span>
<a href="#l5.1050"></a><span id="l5.1050"> </span>
<a href="#l5.1051"></a><span id="l5.1051">         var row;</span>
<a href="#l5.1052"></a><span id="l5.1052" class="difflineminus">-        if (flags &amp; CAL_ITEM_FLAG_HAS_PROPERTIES) {</span>
<a href="#l5.1053"></a><span id="l5.1053" class="difflineplus">+        if (flags &amp; CAL_ITEM_FLAG.HAS_PROPERTIES) {</span>
<a href="#l5.1054"></a><span id="l5.1054">             var selectItem = null;</span>
<a href="#l5.1055"></a><span id="l5.1055">             if (item.recurrenceId == null)</span>
<a href="#l5.1056"></a><span id="l5.1056">                 selectItem = this.mSelectPropertiesForItem;</span>
<a href="#l5.1057"></a><span id="l5.1057">             else {</span>
<a href="#l5.1058"></a><span id="l5.1058">                 selectItem = this.mSelectPropertiesForItemWithRecurrenceId;</span>
<a href="#l5.1059"></a><span id="l5.1059">                 this.setDateParamHelper(selectItem.params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l5.1060"></a><span id="l5.1060">             }</span>
<a href="#l5.1061"></a><span id="l5.1061">                 </span>
<a href="#l5.1062"></a><span id="l5.1062" class="difflineat">@@ -2100,45 +1293,47 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1063"></a><span id="l5.1063">                           item.title + &quot;' (&quot; + item.id + &quot;)!\n&quot; + e +</span>
<a href="#l5.1064"></a><span id="l5.1064">                           &quot;\nDB Error: &quot; + this.mDB.lastErrorString);</span>
<a href="#l5.1065"></a><span id="l5.1065">             } finally {</span>
<a href="#l5.1066"></a><span id="l5.1066">                 selectItem.reset();</span>
<a href="#l5.1067"></a><span id="l5.1067">             }</span>
<a href="#l5.1068"></a><span id="l5.1068">         }</span>
<a href="#l5.1069"></a><span id="l5.1069"> </span>
<a href="#l5.1070"></a><span id="l5.1070">         var i;</span>
<a href="#l5.1071"></a><span id="l5.1071" class="difflineminus">-        if (flags &amp; CAL_ITEM_FLAG_HAS_RECURRENCE) {</span>
<a href="#l5.1072"></a><span id="l5.1072" class="difflineplus">+        if (flags &amp; CAL_ITEM_FLAG.HAS_RECURRENCE) {</span>
<a href="#l5.1073"></a><span id="l5.1073">             if (item.recurrenceId)</span>
<a href="#l5.1074"></a><span id="l5.1074">                 throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l5.1075"></a><span id="l5.1075"> </span>
<a href="#l5.1076"></a><span id="l5.1076">             var rec = null;</span>
<a href="#l5.1077"></a><span id="l5.1077"> </span>
<a href="#l5.1078"></a><span id="l5.1078">             this.mSelectRecurrenceForItem.params.item_id = item.id;</span>
<a href="#l5.1079"></a><span id="l5.1079">             try {</span>
<a href="#l5.1080"></a><span id="l5.1080">                 while (this.mSelectRecurrenceForItem.step()) {</span>
<a href="#l5.1081"></a><span id="l5.1081">                     row = this.mSelectRecurrenceForItem.row;</span>
<a href="#l5.1082"></a><span id="l5.1082"> </span>
<a href="#l5.1083"></a><span id="l5.1083">                     var ritem = null;</span>
<a href="#l5.1084"></a><span id="l5.1084"> </span>
<a href="#l5.1085"></a><span id="l5.1085">                     if (row.recur_type == null ||</span>
<a href="#l5.1086"></a><span id="l5.1086">                         row.recur_type == &quot;x-dateset&quot;)</span>
<a href="#l5.1087"></a><span id="l5.1087">                     {</span>
<a href="#l5.1088"></a><span id="l5.1088" class="difflineminus">-                        ritem = new CalRecurrenceDateSet();</span>
<a href="#l5.1089"></a><span id="l5.1089" class="difflineplus">+                        ritem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date-set;1&quot;]</span>
<a href="#l5.1090"></a><span id="l5.1090" class="difflineplus">+                                          .createInstance(Components.interfaces.calIRecurrenceDateSet);</span>
<a href="#l5.1091"></a><span id="l5.1091"> </span>
<a href="#l5.1092"></a><span id="l5.1092">                         var dates = row.dates.split(&quot;,&quot;);</span>
<a href="#l5.1093"></a><span id="l5.1093">                         for (i = 0; i &lt; dates.length; i++) {</span>
<a href="#l5.1094"></a><span id="l5.1094">                             var date = textToDate(dates[i]);</span>
<a href="#l5.1095"></a><span id="l5.1095">                             ritem.addDate(date);</span>
<a href="#l5.1096"></a><span id="l5.1096">                         }</span>
<a href="#l5.1097"></a><span id="l5.1097">                     } else if (row.recur_type == &quot;x-date&quot;) {</span>
<a href="#l5.1098"></a><span id="l5.1098" class="difflineminus">-                        ritem = new CalRecurrenceDate();</span>
<a href="#l5.1099"></a><span id="l5.1099" class="difflineplus">+                        ritem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l5.1100"></a><span id="l5.1100" class="difflineplus">+                                          .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l5.1101"></a><span id="l5.1101">                         var d = row.dates;</span>
<a href="#l5.1102"></a><span id="l5.1102">                         ritem.date = textToDate(d);</span>
<a href="#l5.1103"></a><span id="l5.1103">                     } else {</span>
<a href="#l5.1104"></a><span id="l5.1104" class="difflineminus">-                        ritem = new CalRecurrenceRule();</span>
<a href="#l5.1105"></a><span id="l5.1105" class="difflineplus">+                        ritem = cal.createRecurrenceRule();</span>
<a href="#l5.1106"></a><span id="l5.1106"> </span>
<a href="#l5.1107"></a><span id="l5.1107">                         ritem.type = row.recur_type;</span>
<a href="#l5.1108"></a><span id="l5.1108">                         if (row.count) {</span>
<a href="#l5.1109"></a><span id="l5.1109">                             try {</span>
<a href="#l5.1110"></a><span id="l5.1110">                                 ritem.count = row.count;</span>
<a href="#l5.1111"></a><span id="l5.1111">                             } catch(exc) {</span>
<a href="#l5.1112"></a><span id="l5.1112">                             }</span>
<a href="#l5.1113"></a><span id="l5.1113">                         } else {</span>
<a href="#l5.1114"></a><span id="l5.1114" class="difflineat">@@ -2174,18 +1369,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1115"></a><span id="l5.1115">                                 ritem.setComponent (comp, rarray.length, rarray);</span>
<a href="#l5.1116"></a><span id="l5.1116">                             }</span>
<a href="#l5.1117"></a><span id="l5.1117">                         }</span>
<a href="#l5.1118"></a><span id="l5.1118">                     }</span>
<a href="#l5.1119"></a><span id="l5.1119"> </span>
<a href="#l5.1120"></a><span id="l5.1120">                     if (row.is_negative)</span>
<a href="#l5.1121"></a><span id="l5.1121">                         ritem.isNegative = true;</span>
<a href="#l5.1122"></a><span id="l5.1122">                     if (rec == null) {</span>
<a href="#l5.1123"></a><span id="l5.1123" class="difflineminus">-                        rec = new CalRecurrenceInfo();</span>
<a href="#l5.1124"></a><span id="l5.1124" class="difflineminus">-                        rec.item = item;</span>
<a href="#l5.1125"></a><span id="l5.1125" class="difflineplus">+                        rec = cal.createRecurrenceInfo(item);</span>
<a href="#l5.1126"></a><span id="l5.1126">                     }</span>
<a href="#l5.1127"></a><span id="l5.1127">                     rec.appendRecurrenceItem(ritem);</span>
<a href="#l5.1128"></a><span id="l5.1128">                 }</span>
<a href="#l5.1129"></a><span id="l5.1129">             } catch (e) {</span>
<a href="#l5.1130"></a><span id="l5.1130">                 cal.ERROR(&quot;Error getting recurrence for item '&quot; +</span>
<a href="#l5.1131"></a><span id="l5.1131">                           item.title + &quot;' (&quot; + item.id + &quot;)!\n&quot; + e +</span>
<a href="#l5.1132"></a><span id="l5.1132">                           &quot;\nDB Error: &quot; + this.mDB.lastErrorString);</span>
<a href="#l5.1133"></a><span id="l5.1133">             } finally {</span>
<a href="#l5.1134"></a><span id="l5.1134" class="difflineat">@@ -2194,20 +1388,20 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1135"></a><span id="l5.1135"> </span>
<a href="#l5.1136"></a><span id="l5.1136">             if (rec == null) {</span>
<a href="#l5.1137"></a><span id="l5.1137">                 dump (&quot;XXXX Expected to find recurrence, but got no items!\n&quot;);</span>
<a href="#l5.1138"></a><span id="l5.1138">             }</span>
<a href="#l5.1139"></a><span id="l5.1139">             item.recurrenceInfo = rec;</span>
<a href="#l5.1140"></a><span id="l5.1140"> </span>
<a href="#l5.1141"></a><span id="l5.1141">         }</span>
<a href="#l5.1142"></a><span id="l5.1142"> </span>
<a href="#l5.1143"></a><span id="l5.1143" class="difflineminus">-        if (flags &amp; CAL_ITEM_FLAG_HAS_EXCEPTIONS) {</span>
<a href="#l5.1144"></a><span id="l5.1144" class="difflineplus">+        if (flags &amp; CAL_ITEM_FLAG.HAS_EXCEPTIONS) {</span>
<a href="#l5.1145"></a><span id="l5.1145">             // it's safe that we don't run into this branch again for exceptions</span>
<a href="#l5.1146"></a><span id="l5.1146">             // (getAdditionalDataForItem-&gt;get[Event|Todo]FromRow-&gt;getAdditionalDataForItem):</span>
<a href="#l5.1147"></a><span id="l5.1147" class="difflineminus">-            // every excepton has a recurrenceId and isn't flagged as CAL_ITEM_FLAG_HAS_EXCEPTIONS</span>
<a href="#l5.1148"></a><span id="l5.1148" class="difflineplus">+            // every excepton has a recurrenceId and isn't flagged as CAL_ITEM_FLAG.HAS_EXCEPTIONS</span>
<a href="#l5.1149"></a><span id="l5.1149">             if (item.recurrenceId)</span>
<a href="#l5.1150"></a><span id="l5.1150">                 throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l5.1151"></a><span id="l5.1151"> </span>
<a href="#l5.1152"></a><span id="l5.1152">             var rec = item.recurrenceInfo;</span>
<a href="#l5.1153"></a><span id="l5.1153"> </span>
<a href="#l5.1154"></a><span id="l5.1154">             if (isEvent(item)) {</span>
<a href="#l5.1155"></a><span id="l5.1155">                 this.mSelectEventExceptions.params.id = item.id;</span>
<a href="#l5.1156"></a><span id="l5.1156">                 try {</span>
<a href="#l5.1157"></a><span id="l5.1157" class="difflineat">@@ -2238,17 +1432,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1158"></a><span id="l5.1158">                 } finally {</span>
<a href="#l5.1159"></a><span id="l5.1159">                     this.mSelectTodoExceptions.reset();</span>
<a href="#l5.1160"></a><span id="l5.1160">                 }</span>
<a href="#l5.1161"></a><span id="l5.1161">             } else {</span>
<a href="#l5.1162"></a><span id="l5.1162">                 throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l5.1163"></a><span id="l5.1163">             }</span>
<a href="#l5.1164"></a><span id="l5.1164">         }</span>
<a href="#l5.1165"></a><span id="l5.1165"> </span>
<a href="#l5.1166"></a><span id="l5.1166" class="difflineminus">-        if (flags &amp; CAL_ITEM_FLAG_HAS_ATTACHMENTS) {</span>
<a href="#l5.1167"></a><span id="l5.1167" class="difflineplus">+        if (flags &amp; CAL_ITEM_FLAG.HAS_ATTACHMENTS) {</span>
<a href="#l5.1168"></a><span id="l5.1168">             var selectAttachment = this.mSelectAttachmentsForItem;</span>
<a href="#l5.1169"></a><span id="l5.1169">             selectAttachment.params.item_id = item.id;</span>
<a href="#l5.1170"></a><span id="l5.1170"> </span>
<a href="#l5.1171"></a><span id="l5.1171">             try { </span>
<a href="#l5.1172"></a><span id="l5.1172">                 while (selectAttachment.step()) {</span>
<a href="#l5.1173"></a><span id="l5.1173">                     var row = selectAttachment.row;</span>
<a href="#l5.1174"></a><span id="l5.1174">                     var attachment = this.getAttachmentFromRow(row);</span>
<a href="#l5.1175"></a><span id="l5.1175">                     item.addAttachment(attachment);</span>
<a href="#l5.1176"></a><span id="l5.1176" class="difflineat">@@ -2257,17 +1451,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1177"></a><span id="l5.1177">                 cal.ERROR(&quot;Error getting attachments for item '&quot; +</span>
<a href="#l5.1178"></a><span id="l5.1178">                           item.title + &quot;' (&quot; + item.id + &quot;)!\n&quot; + e +</span>
<a href="#l5.1179"></a><span id="l5.1179">                           &quot;\nDB Error: &quot; + this.mDB.lastErrorString);</span>
<a href="#l5.1180"></a><span id="l5.1180">             } finally {</span>
<a href="#l5.1181"></a><span id="l5.1181">                 selectAttachment.reset();</span>
<a href="#l5.1182"></a><span id="l5.1182">             }</span>
<a href="#l5.1183"></a><span id="l5.1183">         }</span>
<a href="#l5.1184"></a><span id="l5.1184"> </span>
<a href="#l5.1185"></a><span id="l5.1185" class="difflineminus">-        if (flags &amp; CAL_ITEM_FLAG_HAS_RELATIONS) {</span>
<a href="#l5.1186"></a><span id="l5.1186" class="difflineplus">+        if (flags &amp; CAL_ITEM_FLAG.HAS_RELATIONS) {</span>
<a href="#l5.1187"></a><span id="l5.1187">             var selectRelation = this.mSelectRelationsForItem;</span>
<a href="#l5.1188"></a><span id="l5.1188">             selectRelation.params.item_id = item.id;</span>
<a href="#l5.1189"></a><span id="l5.1189">             try {</span>
<a href="#l5.1190"></a><span id="l5.1190">                 while (selectRelation.step()) {</span>
<a href="#l5.1191"></a><span id="l5.1191">                     var row = selectRelation.row;</span>
<a href="#l5.1192"></a><span id="l5.1192">                     var relation = this.getRelationFromRow(row);</span>
<a href="#l5.1193"></a><span id="l5.1193">                     item.addRelation(relation);</span>
<a href="#l5.1194"></a><span id="l5.1194">                 }</span>
<a href="#l5.1195"></a><span id="l5.1195" class="difflineat">@@ -2275,17 +1469,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1196"></a><span id="l5.1196">                 cal.ERROR(&quot;Error getting relations for item '&quot; +</span>
<a href="#l5.1197"></a><span id="l5.1197">                           item.title + &quot;' (&quot; + item.id + &quot;)!\n&quot; + e +</span>
<a href="#l5.1198"></a><span id="l5.1198">                           &quot;\nDB Error: &quot; + this.mDB.lastErrorString);</span>
<a href="#l5.1199"></a><span id="l5.1199">             } finally {</span>
<a href="#l5.1200"></a><span id="l5.1200">                 selectRelation.reset();</span>
<a href="#l5.1201"></a><span id="l5.1201">             }</span>
<a href="#l5.1202"></a><span id="l5.1202">         }</span>
<a href="#l5.1203"></a><span id="l5.1203"> </span>
<a href="#l5.1204"></a><span id="l5.1204" class="difflineminus">-        if (flags &amp; CAL_ITEM_FLAG_HAS_ALARMS) {</span>
<a href="#l5.1205"></a><span id="l5.1205" class="difflineplus">+        if (flags &amp; CAL_ITEM_FLAG.HAS_ALARMS) {</span>
<a href="#l5.1206"></a><span id="l5.1206">             let selectAlarm = this.mSelectAlarmsForItem;</span>
<a href="#l5.1207"></a><span id="l5.1207">             selectAlarm.params.item_id = item.id;</span>
<a href="#l5.1208"></a><span id="l5.1208"> </span>
<a href="#l5.1209"></a><span id="l5.1209">             try { </span>
<a href="#l5.1210"></a><span id="l5.1210">                 while (selectAlarm.step()) {</span>
<a href="#l5.1211"></a><span id="l5.1211">                     let row = selectAlarm.row;</span>
<a href="#l5.1212"></a><span id="l5.1212">                     let alarm = cal.createAlarm();</span>
<a href="#l5.1213"></a><span id="l5.1213">                     alarm.icalString = row.icalString;</span>
<a href="#l5.1214"></a><span id="l5.1214" class="difflineat">@@ -2300,57 +1494,57 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1215"></a><span id="l5.1215">             }</span>
<a href="#l5.1216"></a><span id="l5.1216">         }</span>
<a href="#l5.1217"></a><span id="l5.1217"> </span>
<a href="#l5.1218"></a><span id="l5.1218">         // Restore the saved modification time</span>
<a href="#l5.1219"></a><span id="l5.1219">         item.setProperty(&quot;LAST-MODIFIED&quot;, savedLastModifiedTime);</span>
<a href="#l5.1220"></a><span id="l5.1220">     },</span>
<a href="#l5.1221"></a><span id="l5.1221"> </span>
<a href="#l5.1222"></a><span id="l5.1222">     getAttendeeFromRow: function cSC_getAttendeeFromRow(row) {</span>
<a href="#l5.1223"></a><span id="l5.1223" class="difflineminus">-        var a = CalAttendee();</span>
<a href="#l5.1224"></a><span id="l5.1224" class="difflineplus">+        let a = cal.createAttendee();</span>
<a href="#l5.1225"></a><span id="l5.1225"> </span>
<a href="#l5.1226"></a><span id="l5.1226">         a.id = row.attendee_id;</span>
<a href="#l5.1227"></a><span id="l5.1227">         a.commonName = row.common_name;</span>
<a href="#l5.1228"></a><span id="l5.1228">         switch (row.rsvp) {</span>
<a href="#l5.1229"></a><span id="l5.1229">             case 0:</span>
<a href="#l5.1230"></a><span id="l5.1230">                 a.rsvp = &quot;FALSE&quot;;</span>
<a href="#l5.1231"></a><span id="l5.1231">                 break;</span>
<a href="#l5.1232"></a><span id="l5.1232">             case 1:</span>
<a href="#l5.1233"></a><span id="l5.1233">                 a.rsvp = &quot;TRUE&quot;;</span>
<a href="#l5.1234"></a><span id="l5.1234">                 break;</span>
<a href="#l5.1235"></a><span id="l5.1235">             // default: keep undefined</span>
<a href="#l5.1236"></a><span id="l5.1236">         }</span>
<a href="#l5.1237"></a><span id="l5.1237">         a.role = row.role;</span>
<a href="#l5.1238"></a><span id="l5.1238">         a.participationStatus = row.status;</span>
<a href="#l5.1239"></a><span id="l5.1239">         a.userType = row.type;</span>
<a href="#l5.1240"></a><span id="l5.1240">         a.isOrganizer = row.is_organizer;</span>
<a href="#l5.1241"></a><span id="l5.1241" class="difflineminus">-        var props = row.properties;</span>
<a href="#l5.1242"></a><span id="l5.1242" class="difflineplus">+        let props = row.properties;</span>
<a href="#l5.1243"></a><span id="l5.1243">         if (props) {</span>
<a href="#l5.1244"></a><span id="l5.1244" class="difflineminus">-            for each (var pair in props.split(&quot;,&quot;)) {</span>
<a href="#l5.1245"></a><span id="l5.1245" class="difflineplus">+            for each (let pair in props.split(&quot;,&quot;)) {</span>
<a href="#l5.1246"></a><span id="l5.1246">                 [key, value] = pair.split(&quot;:&quot;);</span>
<a href="#l5.1247"></a><span id="l5.1247">                 a.setProperty(decodeURIComponent(key), decodeURIComponent(value));</span>
<a href="#l5.1248"></a><span id="l5.1248">             }</span>
<a href="#l5.1249"></a><span id="l5.1249">         }</span>
<a href="#l5.1250"></a><span id="l5.1250"> </span>
<a href="#l5.1251"></a><span id="l5.1251">         return a;</span>
<a href="#l5.1252"></a><span id="l5.1252">     },</span>
<a href="#l5.1253"></a><span id="l5.1253"> </span>
<a href="#l5.1254"></a><span id="l5.1254">     getAttachmentFromRow: function cSC_getAttachmentFromRow(row) {</span>
<a href="#l5.1255"></a><span id="l5.1255" class="difflineminus">-        var a = createAttachment();</span>
<a href="#l5.1256"></a><span id="l5.1256" class="difflineplus">+        let a = cal.createAttachment();</span>
<a href="#l5.1257"></a><span id="l5.1257">        </span>
<a href="#l5.1258"></a><span id="l5.1258">         // TODO we don't support binary data here, libical doesn't either.</span>
<a href="#l5.1259"></a><span id="l5.1259">         a.uri = makeURL(row.data);</span>
<a href="#l5.1260"></a><span id="l5.1260">         a.formatType = row.format_type;</span>
<a href="#l5.1261"></a><span id="l5.1261">         a.encoding = row.encoding;</span>
<a href="#l5.1262"></a><span id="l5.1262">     </span>
<a href="#l5.1263"></a><span id="l5.1263">         return a;</span>
<a href="#l5.1264"></a><span id="l5.1264">     },</span>
<a href="#l5.1265"></a><span id="l5.1265"> </span>
<a href="#l5.1266"></a><span id="l5.1266">     getRelationFromRow: function cSC_getRelationFromRow(row) {</span>
<a href="#l5.1267"></a><span id="l5.1267" class="difflineminus">-        var r = createRelation();</span>
<a href="#l5.1268"></a><span id="l5.1268" class="difflineplus">+        let r = cal.createRelation();</span>
<a href="#l5.1269"></a><span id="l5.1269">         r.relType = row.rel_type;</span>
<a href="#l5.1270"></a><span id="l5.1270">         r.relId = row.rel_id;</span>
<a href="#l5.1271"></a><span id="l5.1271">         return r;</span>
<a href="#l5.1272"></a><span id="l5.1272">     },</span>
<a href="#l5.1273"></a><span id="l5.1273"> </span>
<a href="#l5.1274"></a><span id="l5.1274">     //</span>
<a href="#l5.1275"></a><span id="l5.1275">     // get item from db or from cache with given iid</span>
<a href="#l5.1276"></a><span id="l5.1276">     //</span>
<a href="#l5.1277"></a><span id="l5.1277" class="difflineat">@@ -2465,17 +1659,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1278"></a><span id="l5.1278">         this.setDateParamHelper(ip, &quot;event_start&quot;, item.startDate);</span>
<a href="#l5.1279"></a><span id="l5.1279">         this.setDateParamHelper(ip, &quot;event_end&quot;, item.endDate);</span>
<a href="#l5.1280"></a><span id="l5.1280">         let dtstamp = item.stampTime;</span>
<a href="#l5.1281"></a><span id="l5.1281">         if (dtstamp) {</span>
<a href="#l5.1282"></a><span id="l5.1282">             ip.event_stamp = dtstamp.nativeTime;</span>
<a href="#l5.1283"></a><span id="l5.1283">         }</span>
<a href="#l5.1284"></a><span id="l5.1284"> </span>
<a href="#l5.1285"></a><span id="l5.1285">         if (item.startDate.isDate)</span>
<a href="#l5.1286"></a><span id="l5.1286" class="difflineminus">-            flags |= CAL_ITEM_FLAG_EVENT_ALLDAY;</span>
<a href="#l5.1287"></a><span id="l5.1287" class="difflineplus">+            flags |= CAL_ITEM_FLAG.EVENT_ALLDAY;</span>
<a href="#l5.1288"></a><span id="l5.1288"> </span>
<a href="#l5.1289"></a><span id="l5.1289">         ip.flags = flags;</span>
<a href="#l5.1290"></a><span id="l5.1290"> </span>
<a href="#l5.1291"></a><span id="l5.1291">         this.mInsertEvent.execute();</span>
<a href="#l5.1292"></a><span id="l5.1292">         this.mInsertEvent.reset();</span>
<a href="#l5.1293"></a><span id="l5.1293">     },</span>
<a href="#l5.1294"></a><span id="l5.1294"> </span>
<a href="#l5.1295"></a><span id="l5.1295">     writeTodo: function cSC_writeTodo(item, olditem, flags) {</span>
<a href="#l5.1296"></a><span id="l5.1296" class="difflineat">@@ -2490,17 +1684,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1297"></a><span id="l5.1297">             ip.todo_stamp = dtstamp.nativeTime;</span>
<a href="#l5.1298"></a><span id="l5.1298">         }</span>
<a href="#l5.1299"></a><span id="l5.1299">         this.setDateParamHelper(ip, &quot;todo_completed&quot;, item.getProperty(&quot;COMPLETED&quot;));</span>
<a href="#l5.1300"></a><span id="l5.1300"> </span>
<a href="#l5.1301"></a><span id="l5.1301">         ip.todo_complete = item.getProperty(&quot;PERCENT-COMPLETED&quot;);</span>
<a href="#l5.1302"></a><span id="l5.1302"> </span>
<a href="#l5.1303"></a><span id="l5.1303">         let someDate = (item.entryDate || item.dueDate);</span>
<a href="#l5.1304"></a><span id="l5.1304">         if (someDate &amp;&amp; someDate.isDate) {</span>
<a href="#l5.1305"></a><span id="l5.1305" class="difflineminus">-            flags |= CAL_ITEM_FLAG_EVENT_ALLDAY;</span>
<a href="#l5.1306"></a><span id="l5.1306" class="difflineplus">+            flags |= CAL_ITEM_FLAG.EVENT_ALLDAY;</span>
<a href="#l5.1307"></a><span id="l5.1307">         }</span>
<a href="#l5.1308"></a><span id="l5.1308"> </span>
<a href="#l5.1309"></a><span id="l5.1309">         ip.flags = flags;</span>
<a href="#l5.1310"></a><span id="l5.1310"> </span>
<a href="#l5.1311"></a><span id="l5.1311">         this.mInsertTodo.execute();</span>
<a href="#l5.1312"></a><span id="l5.1312">         this.mInsertTodo.reset();</span>
<a href="#l5.1313"></a><span id="l5.1313">     },</span>
<a href="#l5.1314"></a><span id="l5.1314"> </span>
<a href="#l5.1315"></a><span id="l5.1315" class="difflineat">@@ -2570,17 +1764,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1316"></a><span id="l5.1316">                 if (props.length) {</span>
<a href="#l5.1317"></a><span id="l5.1317">                     ap.properties = props;</span>
<a href="#l5.1318"></a><span id="l5.1318">                 }</span>
<a href="#l5.1319"></a><span id="l5.1319"> </span>
<a href="#l5.1320"></a><span id="l5.1320">                 this.mInsertAttendee.execute();</span>
<a href="#l5.1321"></a><span id="l5.1321">                 this.mInsertAttendee.reset();</span>
<a href="#l5.1322"></a><span id="l5.1322">             }</span>
<a href="#l5.1323"></a><span id="l5.1323"> </span>
<a href="#l5.1324"></a><span id="l5.1324" class="difflineminus">-            return CAL_ITEM_FLAG_HAS_ATTENDEES;</span>
<a href="#l5.1325"></a><span id="l5.1325" class="difflineplus">+            return CAL_ITEM_FLAG.HAS_ATTENDEES;</span>
<a href="#l5.1326"></a><span id="l5.1326">         }</span>
<a href="#l5.1327"></a><span id="l5.1327"> </span>
<a href="#l5.1328"></a><span id="l5.1328">         return 0;</span>
<a href="#l5.1329"></a><span id="l5.1329">     },</span>
<a href="#l5.1330"></a><span id="l5.1330"> </span>
<a href="#l5.1331"></a><span id="l5.1331">     writeProperty: function cSC_writeProperty(item, propName, propValue) {</span>
<a href="#l5.1332"></a><span id="l5.1332">         var pp = this.mInsertProperty.params;</span>
<a href="#l5.1333"></a><span id="l5.1333">         pp.key = propName;</span>
<a href="#l5.1334"></a><span id="l5.1334" class="difflineat">@@ -2603,64 +1797,64 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1335"></a><span id="l5.1335">         this.mInsertProperty.execute();</span>
<a href="#l5.1336"></a><span id="l5.1336">         this.mInsertProperty.reset();</span>
<a href="#l5.1337"></a><span id="l5.1337">     },</span>
<a href="#l5.1338"></a><span id="l5.1338"> </span>
<a href="#l5.1339"></a><span id="l5.1339">     writeProperties: function cSC_writeProperties(item, olditem) {</span>
<a href="#l5.1340"></a><span id="l5.1340">         var ret = 0;</span>
<a href="#l5.1341"></a><span id="l5.1341">         var propEnumerator = item.propertyEnumerator;</span>
<a href="#l5.1342"></a><span id="l5.1342">         while (propEnumerator.hasMoreElements()) {</span>
<a href="#l5.1343"></a><span id="l5.1343" class="difflineminus">-            ret = CAL_ITEM_FLAG_HAS_PROPERTIES;</span>
<a href="#l5.1344"></a><span id="l5.1344" class="difflineplus">+            ret = CAL_ITEM_FLAG.HAS_PROPERTIES;</span>
<a href="#l5.1345"></a><span id="l5.1345">             var prop = propEnumerator.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l5.1346"></a><span id="l5.1346">             if (item.isPropertyPromoted(prop.name))</span>
<a href="#l5.1347"></a><span id="l5.1347">                 continue;</span>
<a href="#l5.1348"></a><span id="l5.1348">             this.writeProperty(item, prop.name, prop.value);</span>
<a href="#l5.1349"></a><span id="l5.1349">         }</span>
<a href="#l5.1350"></a><span id="l5.1350"> </span>
<a href="#l5.1351"></a><span id="l5.1351">         var cats = item.getCategories({});</span>
<a href="#l5.1352"></a><span id="l5.1352">         if (cats.length &gt; 0) {</span>
<a href="#l5.1353"></a><span id="l5.1353" class="difflineminus">-            ret = CAL_ITEM_FLAG_HAS_PROPERTIES;</span>
<a href="#l5.1354"></a><span id="l5.1354" class="difflineplus">+            ret = CAL_ITEM_FLAG.HAS_PROPERTIES;</span>
<a href="#l5.1355"></a><span id="l5.1355">             this.writeProperty(item, &quot;CATEGORIES&quot;, categoriesArrayToString(cats));</span>
<a href="#l5.1356"></a><span id="l5.1356">         }</span>
<a href="#l5.1357"></a><span id="l5.1357"> </span>
<a href="#l5.1358"></a><span id="l5.1358">         return ret;</span>
<a href="#l5.1359"></a><span id="l5.1359">     },</span>
<a href="#l5.1360"></a><span id="l5.1360"> </span>
<a href="#l5.1361"></a><span id="l5.1361">     writeRecurrence: function cSC_writeRecurrence(item, olditem) {</span>
<a href="#l5.1362"></a><span id="l5.1362">         var flags = 0;</span>
<a href="#l5.1363"></a><span id="l5.1363"> </span>
<a href="#l5.1364"></a><span id="l5.1364">         var rec = item.recurrenceInfo;</span>
<a href="#l5.1365"></a><span id="l5.1365">         if (rec) {</span>
<a href="#l5.1366"></a><span id="l5.1366" class="difflineminus">-            flags = CAL_ITEM_FLAG_HAS_RECURRENCE;</span>
<a href="#l5.1367"></a><span id="l5.1367" class="difflineplus">+            flags = CAL_ITEM_FLAG.HAS_RECURRENCE;</span>
<a href="#l5.1368"></a><span id="l5.1368">             var ritems = rec.getRecurrenceItems ({});</span>
<a href="#l5.1369"></a><span id="l5.1369">             for (i in ritems) {</span>
<a href="#l5.1370"></a><span id="l5.1370">                 var ritem = ritems[i];</span>
<a href="#l5.1371"></a><span id="l5.1371">                 ap = this.mInsertRecurrence.params;</span>
<a href="#l5.1372"></a><span id="l5.1372">                 ap.item_id = item.id;</span>
<a href="#l5.1373"></a><span id="l5.1373">                 ap.recur_index = i;</span>
<a href="#l5.1374"></a><span id="l5.1374">                 ap.is_negative = ritem.isNegative;</span>
<a href="#l5.1375"></a><span id="l5.1375" class="difflineminus">-                if (calInstanceOf(ritem, kCalIRecurrenceDate)) {</span>
<a href="#l5.1376"></a><span id="l5.1376" class="difflineplus">+                if (calInstanceOf(ritem, Components.interfaces.calIRecurrenceDate)) {</span>
<a href="#l5.1377"></a><span id="l5.1377">                     ap.recur_type = &quot;x-date&quot;;</span>
<a href="#l5.1378"></a><span id="l5.1378">                     ap.dates = dateToText(getInUtcOrKeepFloating(ritem.date));</span>
<a href="#l5.1379"></a><span id="l5.1379"> </span>
<a href="#l5.1380"></a><span id="l5.1380" class="difflineminus">-                } else if (calInstanceOf(ritem, kCalIRecurrenceDateSet)) {</span>
<a href="#l5.1381"></a><span id="l5.1381" class="difflineplus">+                } else if (calInstanceOf(ritem, Components.interfaces.calIRecurrenceDateSet)) {</span>
<a href="#l5.1382"></a><span id="l5.1382">                     ap.recur_type = &quot;x-dateset&quot;;</span>
<a href="#l5.1383"></a><span id="l5.1383"> </span>
<a href="#l5.1384"></a><span id="l5.1384">                     var rdates = ritem.getDates({});</span>
<a href="#l5.1385"></a><span id="l5.1385">                     var datestr = &quot;&quot;;</span>
<a href="#l5.1386"></a><span id="l5.1386">                     for (j in rdates) {</span>
<a href="#l5.1387"></a><span id="l5.1387">                         if (j != 0)</span>
<a href="#l5.1388"></a><span id="l5.1388">                             datestr += &quot;,&quot;;</span>
<a href="#l5.1389"></a><span id="l5.1389"> </span>
<a href="#l5.1390"></a><span id="l5.1390">                         datestr += dateToText(getInUtcOrKeepFloating(rdates[j]));</span>
<a href="#l5.1391"></a><span id="l5.1391">                     }</span>
<a href="#l5.1392"></a><span id="l5.1392"> </span>
<a href="#l5.1393"></a><span id="l5.1393">                     ap.dates = datestr;</span>
<a href="#l5.1394"></a><span id="l5.1394"> </span>
<a href="#l5.1395"></a><span id="l5.1395" class="difflineminus">-                } else if (calInstanceOf(ritem, kCalIRecurrenceRule)) {</span>
<a href="#l5.1396"></a><span id="l5.1396" class="difflineplus">+                } else if (calInstanceOf(ritem, Components.interfaces.calIRecurrenceRule)) {</span>
<a href="#l5.1397"></a><span id="l5.1397">                     ap.recur_type = ritem.type;</span>
<a href="#l5.1398"></a><span id="l5.1398"> </span>
<a href="#l5.1399"></a><span id="l5.1399">                     if (ritem.isByCount)</span>
<a href="#l5.1400"></a><span id="l5.1400">                         ap.count = ritem.count;</span>
<a href="#l5.1401"></a><span id="l5.1401">                     else</span>
<a href="#l5.1402"></a><span id="l5.1402">                         ap.end_date = ritem.untilDate ? ritem.untilDate.nativeTime : null;</span>
<a href="#l5.1403"></a><span id="l5.1403"> </span>
<a href="#l5.1404"></a><span id="l5.1404">                     ap.interval = ritem.interval;</span>
<a href="#l5.1405"></a><span id="l5.1405" class="difflineat">@@ -2687,17 +1881,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1406"></a><span id="l5.1406">                 }</span>
<a href="#l5.1407"></a><span id="l5.1407"> </span>
<a href="#l5.1408"></a><span id="l5.1408">                 this.mInsertRecurrence.execute();</span>
<a href="#l5.1409"></a><span id="l5.1409">                 this.mInsertRecurrence.reset();</span>
<a href="#l5.1410"></a><span id="l5.1410">             }</span>
<a href="#l5.1411"></a><span id="l5.1411"> </span>
<a href="#l5.1412"></a><span id="l5.1412">             var exceptions = rec.getExceptionIds ({});</span>
<a href="#l5.1413"></a><span id="l5.1413">             if (exceptions.length &gt; 0) {</span>
<a href="#l5.1414"></a><span id="l5.1414" class="difflineminus">-                flags |= CAL_ITEM_FLAG_HAS_EXCEPTIONS;</span>
<a href="#l5.1415"></a><span id="l5.1415" class="difflineplus">+                flags |= CAL_ITEM_FLAG.HAS_EXCEPTIONS;</span>
<a href="#l5.1416"></a><span id="l5.1416"> </span>
<a href="#l5.1417"></a><span id="l5.1417">                 // we need to serialize each exid as a separate</span>
<a href="#l5.1418"></a><span id="l5.1418">                 // event/todo; setupItemBase will handle</span>
<a href="#l5.1419"></a><span id="l5.1419">                 // writing the recurrenceId for us</span>
<a href="#l5.1420"></a><span id="l5.1420">                 for each (exid in exceptions) {</span>
<a href="#l5.1421"></a><span id="l5.1421">                     let ex = rec.getExceptionFor(exid);</span>
<a href="#l5.1422"></a><span id="l5.1422">                     if (!ex)</span>
<a href="#l5.1423"></a><span id="l5.1423">                         throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l5.1424"></a><span id="l5.1424" class="difflineat">@@ -2717,34 +1911,34 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1425"></a><span id="l5.1425">                 ap.item_id = item.id;</span>
<a href="#l5.1426"></a><span id="l5.1426">                 ap.data = (att.uri ? att.uri.spec : &quot;&quot;);</span>
<a href="#l5.1427"></a><span id="l5.1427">                 ap.format_type = att.formatType;</span>
<a href="#l5.1428"></a><span id="l5.1428">                 ap.encoding = att.encoding;</span>
<a href="#l5.1429"></a><span id="l5.1429"> </span>
<a href="#l5.1430"></a><span id="l5.1430">                 this.mInsertAttachment.execute();</span>
<a href="#l5.1431"></a><span id="l5.1431">                 this.mInsertAttachment.reset();</span>
<a href="#l5.1432"></a><span id="l5.1432">             }</span>
<a href="#l5.1433"></a><span id="l5.1433" class="difflineminus">-            return CAL_ITEM_FLAG_HAS_ATTACHMENTS;</span>
<a href="#l5.1434"></a><span id="l5.1434" class="difflineplus">+            return CAL_ITEM_FLAG.HAS_ATTACHMENTS;</span>
<a href="#l5.1435"></a><span id="l5.1435">         }</span>
<a href="#l5.1436"></a><span id="l5.1436">         return 0;</span>
<a href="#l5.1437"></a><span id="l5.1437">     },</span>
<a href="#l5.1438"></a><span id="l5.1438"> </span>
<a href="#l5.1439"></a><span id="l5.1439">     writeRelations: function cSC_writeRelations(item, olditem) {</span>
<a href="#l5.1440"></a><span id="l5.1440">         var relations = item.getRelations({});</span>
<a href="#l5.1441"></a><span id="l5.1441">         if (relations &amp;&amp; relations.length &gt; 0) {</span>
<a href="#l5.1442"></a><span id="l5.1442">             for each (var rel in relations) {</span>
<a href="#l5.1443"></a><span id="l5.1443">                 var rp = this.mInsertRelation.params;</span>
<a href="#l5.1444"></a><span id="l5.1444">                 rp.item_id = item.id;</span>
<a href="#l5.1445"></a><span id="l5.1445">                 rp.rel_type = rel.relType;</span>
<a href="#l5.1446"></a><span id="l5.1446">                 rp.rel_id = rel.relId;</span>
<a href="#l5.1447"></a><span id="l5.1447"> </span>
<a href="#l5.1448"></a><span id="l5.1448">                 this.mInsertRelation.execute();</span>
<a href="#l5.1449"></a><span id="l5.1449">                 this.mInsertRelation.reset();</span>
<a href="#l5.1450"></a><span id="l5.1450">             }</span>
<a href="#l5.1451"></a><span id="l5.1451" class="difflineminus">-            return CAL_ITEM_FLAG_HAS_RELATIONS;</span>
<a href="#l5.1452"></a><span id="l5.1452" class="difflineplus">+            return CAL_ITEM_FLAG.HAS_RELATIONS;</span>
<a href="#l5.1453"></a><span id="l5.1453">         }</span>
<a href="#l5.1454"></a><span id="l5.1454">         return 0;</span>
<a href="#l5.1455"></a><span id="l5.1455">     },          </span>
<a href="#l5.1456"></a><span id="l5.1456"> </span>
<a href="#l5.1457"></a><span id="l5.1457">     writeAlarms: function cSC_writeAlarms(item, olditem) {</span>
<a href="#l5.1458"></a><span id="l5.1458">         let alarms = item.getAlarms({});</span>
<a href="#l5.1459"></a><span id="l5.1459">         if (alarms.length &lt; 1) {</span>
<a href="#l5.1460"></a><span id="l5.1460">             return 0;</span>
<a href="#l5.1461"></a><span id="l5.1461" class="difflineat">@@ -2760,17 +1954,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1462"></a><span id="l5.1462">                 cal.ERROR(&quot;Error writing alarm for item &quot; + item.title + &quot; (&quot; + item.id + &quot;)&quot; +</span>
<a href="#l5.1463"></a><span id="l5.1463">                           &quot;\nDB Error: &quot; + this.mDB.lastErrorString +</span>
<a href="#l5.1464"></a><span id="l5.1464">                           &quot;\nException: &quot; + e);</span>
<a href="#l5.1465"></a><span id="l5.1465">             } finally {</span>
<a href="#l5.1466"></a><span id="l5.1466">                 this.mInsertAlarm.reset();</span>
<a href="#l5.1467"></a><span id="l5.1467">             }</span>
<a href="#l5.1468"></a><span id="l5.1468">         }</span>
<a href="#l5.1469"></a><span id="l5.1469"> </span>
<a href="#l5.1470"></a><span id="l5.1470" class="difflineminus">-        return CAL_ITEM_FLAG_HAS_ALARMS;</span>
<a href="#l5.1471"></a><span id="l5.1471" class="difflineplus">+        return CAL_ITEM_FLAG.HAS_ALARMS;</span>
<a href="#l5.1472"></a><span id="l5.1472">     },</span>
<a href="#l5.1473"></a><span id="l5.1473"> </span>
<a href="#l5.1474"></a><span id="l5.1474">     //</span>
<a href="#l5.1475"></a><span id="l5.1475">     // delete the item with the given uid</span>
<a href="#l5.1476"></a><span id="l5.1476">     //</span>
<a href="#l5.1477"></a><span id="l5.1477">     deleteItemById: function cSC_deleteItemById(aID) {</span>
<a href="#l5.1478"></a><span id="l5.1478">         this.acquireTransaction();</span>
<a href="#l5.1479"></a><span id="l5.1479">         try {</span>
<a href="#l5.1480"></a><span id="l5.1480" class="difflineat">@@ -2892,171 +2086,8 @@ calStorageCalendar.prototype = {</span>
<a href="#l5.1481"></a><span id="l5.1481">         } finally {</span>
<a href="#l5.1482"></a><span id="l5.1482">             query.reset();</span>
<a href="#l5.1483"></a><span id="l5.1483">         }</span>
<a href="#l5.1484"></a><span id="l5.1484">         out_count.value = ids.length;</span>
<a href="#l5.1485"></a><span id="l5.1485">         out_ids.value = ids;</span>
<a href="#l5.1486"></a><span id="l5.1486">         out_values.value = values;</span>
<a href="#l5.1487"></a><span id="l5.1487">     }</span>
<a href="#l5.1488"></a><span id="l5.1488"> };</span>
<a href="#l5.1489"></a><span id="l5.1489" class="difflineminus">-</span>
<a href="#l5.1490"></a><span id="l5.1490" class="difflineminus">-//</span>
<a href="#l5.1491"></a><span id="l5.1491" class="difflineminus">-// sqlTables generated from schema.sql via makejsschema.pl</span>
<a href="#l5.1492"></a><span id="l5.1492" class="difflineminus">-//</span>
<a href="#l5.1493"></a><span id="l5.1493" class="difflineminus">-</span>
<a href="#l5.1494"></a><span id="l5.1494" class="difflineminus">-var sqlTables = {</span>
<a href="#l5.1495"></a><span id="l5.1495" class="difflineminus">-  cal_calendar_schema_version:</span>
<a href="#l5.1496"></a><span id="l5.1496" class="difflineminus">-    &quot;   version INTEGER&quot; +</span>
<a href="#l5.1497"></a><span id="l5.1497" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l5.1498"></a><span id="l5.1498" class="difflineminus">-</span>
<a href="#l5.1499"></a><span id="l5.1499" class="difflineminus">-  cal_tz_version:</span>
<a href="#l5.1500"></a><span id="l5.1500" class="difflineminus">-    &quot;   version TEXT&quot; +</span>
<a href="#l5.1501"></a><span id="l5.1501" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l5.1502"></a><span id="l5.1502" class="difflineminus">-</span>
<a href="#l5.1503"></a><span id="l5.1503" class="difflineminus">-  cal_events:</span>
<a href="#l5.1504"></a><span id="l5.1504" class="difflineminus">-    /*  REFERENCES cal_calendars.id, */</span>
<a href="#l5.1505"></a><span id="l5.1505" class="difflineminus">-    &quot;   cal_id          INTEGER, &quot; +</span>
<a href="#l5.1506"></a><span id="l5.1506" class="difflineminus">-    /*  ItemBase bits */</span>
<a href="#l5.1507"></a><span id="l5.1507" class="difflineminus">-    &quot;   id              TEXT,&quot; +</span>
<a href="#l5.1508"></a><span id="l5.1508" class="difflineminus">-    &quot;   time_created    INTEGER,&quot; +</span>
<a href="#l5.1509"></a><span id="l5.1509" class="difflineminus">-    &quot;   last_modified   INTEGER,&quot; +</span>
<a href="#l5.1510"></a><span id="l5.1510" class="difflineminus">-    &quot;   title           TEXT,&quot; +</span>
<a href="#l5.1511"></a><span id="l5.1511" class="difflineminus">-    &quot;   priority        INTEGER,&quot; +</span>
<a href="#l5.1512"></a><span id="l5.1512" class="difflineminus">-    &quot;   privacy         TEXT,&quot; +</span>
<a href="#l5.1513"></a><span id="l5.1513" class="difflineminus">-    &quot;   ical_status     TEXT,&quot; +</span>
<a href="#l5.1514"></a><span id="l5.1514" class="difflineminus">-    &quot;   recurrence_id   INTEGER,&quot; +</span>
<a href="#l5.1515"></a><span id="l5.1515" class="difflineminus">-    &quot;   recurrence_id_tz TEXT,&quot; +</span>
<a href="#l5.1516"></a><span id="l5.1516" class="difflineminus">-    /*  CAL_ITEM_FLAG_PRIVATE = 1 */</span>
<a href="#l5.1517"></a><span id="l5.1517" class="difflineminus">-    /*  CAL_ITEM_FLAG_HAS_ATTENDEES = 2 */</span>
<a href="#l5.1518"></a><span id="l5.1518" class="difflineminus">-    /*  CAL_ITEM_FLAG_HAS_PROPERTIES = 4 */</span>
<a href="#l5.1519"></a><span id="l5.1519" class="difflineminus">-    /*  CAL_ITEM_FLAG_EVENT_ALLDAY = 8 */</span>
<a href="#l5.1520"></a><span id="l5.1520" class="difflineminus">-    /*  CAL_ITEM_FLAG_HAS_RECURRENCE = 16 */</span>
<a href="#l5.1521"></a><span id="l5.1521" class="difflineminus">-    /*  CAL_ITEM_FLAG_HAS_EXCEPTIONS = 32 */</span>
<a href="#l5.1522"></a><span id="l5.1522" class="difflineminus">-    /*  CAL_ITEM_FLAG_HAS_ATTACHMENTS = 64 */</span>
<a href="#l5.1523"></a><span id="l5.1523" class="difflineminus">-    /*  CAL_ITEM_FLAG_HAS_ALARMS = 256 */</span>
<a href="#l5.1524"></a><span id="l5.1524" class="difflineminus">-    &quot;   flags           INTEGER,&quot; +</span>
<a href="#l5.1525"></a><span id="l5.1525" class="difflineminus">-    /*  Event bits */</span>
<a href="#l5.1526"></a><span id="l5.1526" class="difflineminus">-    &quot;   event_start     INTEGER,&quot; +</span>
<a href="#l5.1527"></a><span id="l5.1527" class="difflineminus">-    &quot;   event_start_tz  TEXT,&quot; +</span>
<a href="#l5.1528"></a><span id="l5.1528" class="difflineminus">-    &quot;   event_end       INTEGER,&quot; +</span>
<a href="#l5.1529"></a><span id="l5.1529" class="difflineminus">-    &quot;   event_end_tz    TEXT,&quot; +</span>
<a href="#l5.1530"></a><span id="l5.1530" class="difflineminus">-    &quot;   event_stamp     INTEGER,&quot; +</span>
<a href="#l5.1531"></a><span id="l5.1531" class="difflineminus">-    &quot;   alarm_last_ack  INTEGER&quot; +</span>
<a href="#l5.1532"></a><span id="l5.1532" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l5.1533"></a><span id="l5.1533" class="difflineminus">-</span>
<a href="#l5.1534"></a><span id="l5.1534" class="difflineminus">-  cal_todos:</span>
<a href="#l5.1535"></a><span id="l5.1535" class="difflineminus">-    /*  REFERENCES cal_calendars.id, */</span>
<a href="#l5.1536"></a><span id="l5.1536" class="difflineminus">-    &quot;   cal_id          INTEGER, &quot; +</span>
<a href="#l5.1537"></a><span id="l5.1537" class="difflineminus">-    /*  ItemBase bits */</span>
<a href="#l5.1538"></a><span id="l5.1538" class="difflineminus">-    &quot;   id              TEXT,&quot; +</span>
<a href="#l5.1539"></a><span id="l5.1539" class="difflineminus">-    &quot;   time_created    INTEGER,&quot; +</span>
<a href="#l5.1540"></a><span id="l5.1540" class="difflineminus">-    &quot;   last_modified   INTEGER,&quot; +</span>
<a href="#l5.1541"></a><span id="l5.1541" class="difflineminus">-    &quot;   title           TEXT,&quot; +</span>
<a href="#l5.1542"></a><span id="l5.1542" class="difflineminus">-    &quot;   priority        INTEGER,&quot; +</span>
<a href="#l5.1543"></a><span id="l5.1543" class="difflineminus">-    &quot;   privacy         TEXT,&quot; +</span>
<a href="#l5.1544"></a><span id="l5.1544" class="difflineminus">-    &quot;   ical_status     TEXT,&quot; +</span>
<a href="#l5.1545"></a><span id="l5.1545" class="difflineminus">-    &quot;   recurrence_id   INTEGER,&quot; +</span>
<a href="#l5.1546"></a><span id="l5.1546" class="difflineminus">-    &quot;   recurrence_id_tz        TEXT,&quot; +</span>
<a href="#l5.1547"></a><span id="l5.1547" class="difflineminus">-    /*  CAL_ITEM_FLAG_PRIVATE = 1 */</span>
<a href="#l5.1548"></a><span id="l5.1548" class="difflineminus">-    /*  CAL_ITEM_FLAG_HAS_ATTENDEES = 2 */</span>
<a href="#l5.1549"></a><span id="l5.1549" class="difflineminus">-    /*  CAL_ITEM_FLAG_HAS_PROPERTIES = 4 */</span>
<a href="#l5.1550"></a><span id="l5.1550" class="difflineminus">-    /*  CAL_ITEM_FLAG_EVENT_ALLDAY = 8 */</span>
<a href="#l5.1551"></a><span id="l5.1551" class="difflineminus">-    /*  CAL_ITEM_FLAG_HAS_RECURRENCE = 16 */</span>
<a href="#l5.1552"></a><span id="l5.1552" class="difflineminus">-    /*  CAL_ITEM_FLAG_HAS_EXCEPTIONS = 32 */</span>
<a href="#l5.1553"></a><span id="l5.1553" class="difflineminus">-    /*  CAL_ITEM_FLAG_HAS_ALARMS = 256 */</span>
<a href="#l5.1554"></a><span id="l5.1554" class="difflineminus">-    &quot;   flags           INTEGER,&quot; +</span>
<a href="#l5.1555"></a><span id="l5.1555" class="difflineminus">-    /*  Todo bits */</span>
<a href="#l5.1556"></a><span id="l5.1556" class="difflineminus">-    /*  date the todo is to be displayed */</span>
<a href="#l5.1557"></a><span id="l5.1557" class="difflineminus">-    &quot;   todo_entry      INTEGER,&quot; +</span>
<a href="#l5.1558"></a><span id="l5.1558" class="difflineminus">-    &quot;   todo_entry_tz   TEXT,&quot; +</span>
<a href="#l5.1559"></a><span id="l5.1559" class="difflineminus">-    /*  date the todo is due */</span>
<a href="#l5.1560"></a><span id="l5.1560" class="difflineminus">-    &quot;   todo_due        INTEGER,&quot; +</span>
<a href="#l5.1561"></a><span id="l5.1561" class="difflineminus">-    &quot;   todo_due_tz     TEXT,&quot; +</span>
<a href="#l5.1562"></a><span id="l5.1562" class="difflineminus">-    &quot;   todo_stamp      INTEGER,&quot; +</span>
<a href="#l5.1563"></a><span id="l5.1563" class="difflineminus">-    /*  date the todo is completed */</span>
<a href="#l5.1564"></a><span id="l5.1564" class="difflineminus">-    &quot;   todo_completed  INTEGER,&quot; +</span>
<a href="#l5.1565"></a><span id="l5.1565" class="difflineminus">-    &quot;   todo_completed_tz TEXT,&quot; +</span>
<a href="#l5.1566"></a><span id="l5.1566" class="difflineminus">-    /*  percent the todo is complete (0-100) */</span>
<a href="#l5.1567"></a><span id="l5.1567" class="difflineminus">-    &quot;   todo_complete   INTEGER,&quot; +</span>
<a href="#l5.1568"></a><span id="l5.1568" class="difflineminus">-    &quot;   alarm_last_ack  INTEGER&quot; +</span>
<a href="#l5.1569"></a><span id="l5.1569" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l5.1570"></a><span id="l5.1570" class="difflineminus">-</span>
<a href="#l5.1571"></a><span id="l5.1571" class="difflineminus">-  cal_attendees:</span>
<a href="#l5.1572"></a><span id="l5.1572" class="difflineminus">-    &quot;   cal_id          INTEGER, &quot; +</span>
<a href="#l5.1573"></a><span id="l5.1573" class="difflineminus">-    &quot;   item_id         TEXT,&quot; +</span>
<a href="#l5.1574"></a><span id="l5.1574" class="difflineminus">-    &quot;   recurrence_id   INTEGER,&quot; +</span>
<a href="#l5.1575"></a><span id="l5.1575" class="difflineminus">-    &quot;   recurrence_id_tz        TEXT,&quot; +</span>
<a href="#l5.1576"></a><span id="l5.1576" class="difflineminus">-    &quot;   attendee_id     TEXT,&quot; +</span>
<a href="#l5.1577"></a><span id="l5.1577" class="difflineminus">-    &quot;   common_name     TEXT,&quot; +</span>
<a href="#l5.1578"></a><span id="l5.1578" class="difflineminus">-    &quot;   rsvp            INTEGER,&quot; +</span>
<a href="#l5.1579"></a><span id="l5.1579" class="difflineminus">-    &quot;   role            TEXT,&quot; +</span>
<a href="#l5.1580"></a><span id="l5.1580" class="difflineminus">-    &quot;   status          TEXT,&quot; +</span>
<a href="#l5.1581"></a><span id="l5.1581" class="difflineminus">-    &quot;   type            TEXT,&quot; +</span>
<a href="#l5.1582"></a><span id="l5.1582" class="difflineminus">-    &quot;   is_organizer    BOOLEAN,&quot; +</span>
<a href="#l5.1583"></a><span id="l5.1583" class="difflineminus">-    &quot;   properties      BLOB&quot; +</span>
<a href="#l5.1584"></a><span id="l5.1584" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l5.1585"></a><span id="l5.1585" class="difflineminus">-</span>
<a href="#l5.1586"></a><span id="l5.1586" class="difflineminus">-  cal_recurrence:</span>
<a href="#l5.1587"></a><span id="l5.1587" class="difflineminus">-    &quot;   cal_id          INTEGER, &quot; +</span>
<a href="#l5.1588"></a><span id="l5.1588" class="difflineminus">-    &quot;   item_id         TEXT,&quot; +</span>
<a href="#l5.1589"></a><span id="l5.1589" class="difflineminus">-    /*  the index in the recurrence array of this thing */</span>
<a href="#l5.1590"></a><span id="l5.1590" class="difflineminus">-    &quot;   recur_index     INTEGER, &quot; +</span>
<a href="#l5.1591"></a><span id="l5.1591" class="difflineminus">-    /*  values from calIRecurrenceInfo; if null, date-based. */</span>
<a href="#l5.1592"></a><span id="l5.1592" class="difflineminus">-    &quot;   recur_type      TEXT, &quot; +</span>
<a href="#l5.1593"></a><span id="l5.1593" class="difflineminus">-    &quot;   is_negative     BOOLEAN,&quot; +</span>
<a href="#l5.1594"></a><span id="l5.1594" class="difflineminus">-    /*  */</span>
<a href="#l5.1595"></a><span id="l5.1595" class="difflineminus">-    /*  these are for date-based recurrence */</span>
<a href="#l5.1596"></a><span id="l5.1596" class="difflineminus">-    /*  */</span>
<a href="#l5.1597"></a><span id="l5.1597" class="difflineminus">-    /*  comma-separated list of dates */</span>
<a href="#l5.1598"></a><span id="l5.1598" class="difflineminus">-    &quot;   dates           TEXT,&quot; +</span>
<a href="#l5.1599"></a><span id="l5.1599" class="difflineminus">-    /*  */</span>
<a href="#l5.1600"></a><span id="l5.1600" class="difflineminus">-    /*  these are for rule-based recurrence */</span>
<a href="#l5.1601"></a><span id="l5.1601" class="difflineminus">-    /*  */</span>
<a href="#l5.1602"></a><span id="l5.1602" class="difflineminus">-    &quot;   count           INTEGER,&quot; +</span>
<a href="#l5.1603"></a><span id="l5.1603" class="difflineminus">-    &quot;   end_date        INTEGER,&quot; +</span>
<a href="#l5.1604"></a><span id="l5.1604" class="difflineminus">-    &quot;   interval        INTEGER,&quot; +</span>
<a href="#l5.1605"></a><span id="l5.1605" class="difflineminus">-    /*  components, comma-separated list or null */</span>
<a href="#l5.1606"></a><span id="l5.1606" class="difflineminus">-    &quot;   second          TEXT,&quot; +</span>
<a href="#l5.1607"></a><span id="l5.1607" class="difflineminus">-    &quot;   minute          TEXT,&quot; +</span>
<a href="#l5.1608"></a><span id="l5.1608" class="difflineminus">-    &quot;   hour            TEXT,&quot; +</span>
<a href="#l5.1609"></a><span id="l5.1609" class="difflineminus">-    &quot;   day             TEXT,&quot; +</span>
<a href="#l5.1610"></a><span id="l5.1610" class="difflineminus">-    &quot;   monthday        TEXT,&quot; +</span>
<a href="#l5.1611"></a><span id="l5.1611" class="difflineminus">-    &quot;   yearday         TEXT,&quot; +</span>
<a href="#l5.1612"></a><span id="l5.1612" class="difflineminus">-    &quot;   weekno          TEXT,&quot; +</span>
<a href="#l5.1613"></a><span id="l5.1613" class="difflineminus">-    &quot;   month           TEXT,&quot; +</span>
<a href="#l5.1614"></a><span id="l5.1614" class="difflineminus">-    &quot;   setpos          TEXT&quot; +</span>
<a href="#l5.1615"></a><span id="l5.1615" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l5.1616"></a><span id="l5.1616" class="difflineminus">-</span>
<a href="#l5.1617"></a><span id="l5.1617" class="difflineminus">-  cal_properties:</span>
<a href="#l5.1618"></a><span id="l5.1618" class="difflineminus">-    &quot;   cal_id          INTEGER, &quot; +</span>
<a href="#l5.1619"></a><span id="l5.1619" class="difflineminus">-    &quot;   item_id         TEXT,&quot; +</span>
<a href="#l5.1620"></a><span id="l5.1620" class="difflineminus">-    &quot;   recurrence_id   INTEGER,&quot; +</span>
<a href="#l5.1621"></a><span id="l5.1621" class="difflineminus">-    &quot;   recurrence_id_tz TEXT,&quot; +</span>
<a href="#l5.1622"></a><span id="l5.1622" class="difflineminus">-    &quot;   key             TEXT,&quot; +</span>
<a href="#l5.1623"></a><span id="l5.1623" class="difflineminus">-    &quot;   value           BLOB&quot; +</span>
<a href="#l5.1624"></a><span id="l5.1624" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l5.1625"></a><span id="l5.1625" class="difflineminus">-</span>
<a href="#l5.1626"></a><span id="l5.1626" class="difflineminus">-  cal_attachments:</span>
<a href="#l5.1627"></a><span id="l5.1627" class="difflineminus">-    &quot;   cal_id          INTEGER, &quot; +</span>
<a href="#l5.1628"></a><span id="l5.1628" class="difflineminus">-    &quot;   item_id         TEXT,&quot; +</span>
<a href="#l5.1629"></a><span id="l5.1629" class="difflineminus">-    &quot;   data            BLOB,&quot; +</span>
<a href="#l5.1630"></a><span id="l5.1630" class="difflineminus">-    &quot;   format_type     TEXT,&quot; +</span>
<a href="#l5.1631"></a><span id="l5.1631" class="difflineminus">-    &quot;   encoding        TEXT&quot; +</span>
<a href="#l5.1632"></a><span id="l5.1632" class="difflineminus">-    &quot;&quot;,  </span>
<a href="#l5.1633"></a><span id="l5.1633" class="difflineminus">-  </span>
<a href="#l5.1634"></a><span id="l5.1634" class="difflineminus">-  cal_relations:</span>
<a href="#l5.1635"></a><span id="l5.1635" class="difflineminus">-    &quot;   cal_id          INTEGER,&quot; +</span>
<a href="#l5.1636"></a><span id="l5.1636" class="difflineminus">-    &quot;   item_id         TEXT,&quot; +</span>
<a href="#l5.1637"></a><span id="l5.1637" class="difflineminus">-    &quot;   rel_type        TEXT,&quot; +</span>
<a href="#l5.1638"></a><span id="l5.1638" class="difflineminus">-    &quot;   rel_id          TEXT&quot; +</span>
<a href="#l5.1639"></a><span id="l5.1639" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l5.1640"></a><span id="l5.1640" class="difflineminus">-</span>
<a href="#l5.1641"></a><span id="l5.1641" class="difflineminus">-  cal_metadata:</span>
<a href="#l5.1642"></a><span id="l5.1642" class="difflineminus">-    &quot;   cal_id          INTEGER, &quot; +</span>
<a href="#l5.1643"></a><span id="l5.1643" class="difflineminus">-    &quot;   item_id         TEXT,&quot; + </span>
<a href="#l5.1644"></a><span id="l5.1644" class="difflineminus">-    &quot;   value           BLOB&quot; + </span>
<a href="#l5.1645"></a><span id="l5.1645" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l5.1646"></a><span id="l5.1646" class="difflineminus">-</span>
<a href="#l5.1647"></a><span id="l5.1647" class="difflineminus">-  cal_alarms:</span>
<a href="#l5.1648"></a><span id="l5.1648" class="difflineminus">-    &quot;   cal_id          INTEGER, &quot; +</span>
<a href="#l5.1649"></a><span id="l5.1649" class="difflineminus">-    &quot;   item_id         TEXT,&quot; +</span>
<a href="#l5.1650"></a><span id="l5.1650" class="difflineminus">-    &quot;   icalString      TEXT&quot;</span>
<a href="#l5.1651"></a><span id="l5.1651" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendarModule.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendarModule.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -66,20 +66,20 @@ var calStorageCalendarModule = {</span>
<a href="#l6.4"></a><span id="l6.4">     mContractID: &quot;@mozilla.org/calendar/calendar;1?type=storage&quot;,</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6">     mUtilsLoaded: false,</span>
<a href="#l6.7"></a><span id="l6.7">     loadUtils: function storageLoadUtils() {</span>
<a href="#l6.8"></a><span id="l6.8">         if (this.mUtilsLoaded)</span>
<a href="#l6.9"></a><span id="l6.9">             return;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13">         cal.loadScripts([&quot;calUtils.js&quot;, &quot;calStorageCalendar.js&quot;],</span>
<a href="#l6.14"></a><span id="l6.14">                         this.__parent__);</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-        initCalStorageCalendarComponent();</span>
<a href="#l6.17"></a><span id="l6.17">         this.mUtilsLoaded = true;</span>
<a href="#l6.18"></a><span id="l6.18">     },</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">     registerSelf: function (compMgr, fileSpec, location, type) {</span>
<a href="#l6.21"></a><span id="l6.21">         compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l6.22"></a><span id="l6.22">         compMgr.registerFactoryLocation(this.mCID,</span>
<a href="#l6.23"></a><span id="l6.23">                                         &quot;Calendar mozStorage/SQL back-end&quot;,</span>
<a href="#l6.24"></a><span id="l6.24">                                         this.mContractID,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/calendar/providers/storage/calStorageHelpers.jsm</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,241 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2005, 2006</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ *   Joey Minta &lt;jminta@gmail.com&gt;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ *   Dan Mosedale &lt;dan.mosedale@oracle.com&gt;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ *   Thomas Benisch &lt;thomas.benisch@sun.com&gt;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ *   Matthew Willis &lt;lilmatt@mozilla.com&gt;</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ *   Sebastian Schwieger &lt;sebo.moz@googlemail.com&gt;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ *   Fred Jendrzejewski &lt;fred.jen@web.de&gt;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ *</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+ *</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+var EXPORTED_SYMBOLS = [</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+    &quot;CAL_ITEM_FLAG&quot;,</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    &quot;createStatement&quot;,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+    &quot;getInUtcOrKeepFloating&quot;,</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    &quot;dateToText&quot;,</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+    &quot;textToDate&quot;,</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+    &quot;calStorageTimezone&quot;,</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+    &quot;getTimezone&quot;,</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+    &quot;newDateTime&quot;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+];</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+// Storage flags. These are used in the Database |flags| column to give</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+// information about the item's features. For example, if the item has</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+// attachments, the HAS_ATTACHMENTS flag is added to the flags column.</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+var CAL_ITEM_FLAG = {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+    PRIVATE: 1,</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+    HAS_ATTENDEES: 2,</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+    HAS_PROPERTIES: 4,</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+    EVENT_ALLDAY: 8,</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+    HAS_RECURRENCE: 16,</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+    HAS_EXCEPTIONS: 32,</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+    HAS_ATTACHMENTS: 64,</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+    HAS_RELATIONS: 128,</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+    HAS_ALARMS: 256,</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+};</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+// The cache of foreign timezones</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+var gForeignTimezonesCache = {};</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+/**</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+ * Create a storage statement on the given database connection with the passed</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+ * sql statement string.</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+ *</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+ * @param aDb       The mozIStorageConnection to create the statement with.</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+ * @param aSql      A string with the SQL of the statement to create.</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+ */</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+function createStatement(aDb, aSql) {</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    try {</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+        // TODO We don't need the wrapper anymore if we get rid of calling</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+        // statements as functions, i.e mDeleteAttendees(aID);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+        let stmt = aDb.createStatement(aSql);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+        let wrapper = Components.classes[&quot;@mozilla.org/storage/statement-wrapper;1&quot;]</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+                                .createInstance(Components.interfaces.mozIStorageStatementWrapper);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+        wrapper.initialize(stmt);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+        return wrapper;</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+    } catch (e) {</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+        cal.ERROR(&quot;mozStorage exception: createStatement failed, statement: '&quot; +</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+                  aSql + &quot;', error: '&quot; + aDb.lastErrorString + &quot;' - &quot; + e);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+    }</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+    return null;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+}</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+/**</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+ * Returns the passed date in UTC, unless it is floating. In this case, it is</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+ * kept floating.</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+ *</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+ * @param dt        The calIDateTime to convert.</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+ * @return          The possibly converted calIDateTime.</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+ */</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+function getInUtcOrKeepFloating(dt) {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+    let tz = dt.timezone;</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+    if (tz.isFloating || tz.isUTC) {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+        return dt;</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+    } else {</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+        return dt.getInTimezone(cal.UTC());</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+    }</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+}</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+/**</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+ * Transforms a date object to a text which is suitable for the database</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+ *</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+ * @param d     The calIDateTime to transform.</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+ * @return      The string representation of the date object.</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+ */</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+function dateToText(d) {</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+    let datestr;</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+    let tz = null;</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+    datestr = (d.timezone.isFloating ? &quot;L&quot; :</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+                 (d.timezone.isUTC ? &quot;U&quot; : &quot;Z&quot;)) +</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+              (d.isDate ? &quot;D&quot; : &quot;T&quot;) + d.nativeTime;</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+    if (!d.timezone.isFloating &amp;&amp; ! d.timezone.isUTC) {</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+        datestr += &quot;:&quot; + d.timezone.tzid.replace(/%/g, &quot;%%&quot;).replace(/:/g, &quot;%:&quot;);</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+    }</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+    return datestr;</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+}</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+/**</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+ * Transforms the text representation of this date object to a calIDateTime</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+ * object.</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+ *</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+ * @param d     The text to transform.</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+ * @return      The resulting calIDateTime.</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+ */</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+function textToDate(d) {</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+    let dval;</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+    let tz = &quot;UTC&quot;;</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+    if (d[0] == 'Z') {</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+        let strs = d.substr(2).split(&quot;:&quot;);</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+        dval = parseInt(strs[0]);</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+        tz = strs[1].replace(/%:/g, &quot;:&quot;).replace(/%%/g, &quot;%&quot;);</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+    } else {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+        dval = parseInt(d.substr(2));</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+    }</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+    let date;</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+    if (d[0] == 'U' || d[0] == 'Z') {</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+        date = newDateTime(dval, tz);</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+    } else if (d[0] == 'L') {</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+        // is local time</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+        date = newDateTime(dval, &quot;floating&quot;);</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+    }</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+    if (d[1] == 'D')</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+        date.isDate = true;</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+    return date;</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+}</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+//</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+// other helpers</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+//</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+/**</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+ * Prototype definition for foreign timezone.</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+ */</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+function calStorageTimezone(comp) {</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+    this.wrappedJSObject = this;</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+    this.provider = null;</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+    this.icalComponent = comp;</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+    this.tzid = comp.getFirstProperty(&quot;TZID&quot;).value;</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+    this.displayName = null;</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+    this.isUTC = false;</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+    this.isFloating = false;</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+    this.latitude = null;</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+    this.longitude = null;</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+}</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+calStorageTimezone.prototype = {</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+    toString: function() {</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+        return this.icalComponent.toString();</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+    }</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+};</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+/**</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+ * Gets the timezone for the given definition or identifier</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+ *</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+ * @param aTimezone     The timezone data</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+ * @return              The calITimezone object</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+ */</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+function getTimezone(aTimezone) {</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+    let tz = null;</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+    if (aTimezone.indexOf(&quot;BEGIN:VTIMEZONE&quot;) == 0) {</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+        tz = gForeignTimezonesCache[aTimezone]; // using full definition as key</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+        if (!tz) {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+            try {</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+                // cannot cope without parent VCALENDAR:</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+                let comp = cal.getIcsService().parseICS(&quot;BEGIN:VCALENDAR\n&quot; + aTimezone + &quot;\nEND:VCALENDAR&quot;, null);</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+                tz = new calStorageTimezone(comp.getFirstSubcomponent(&quot;VTIMEZONE&quot;));</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+                gForeignTimezonesCache[aTimezone] = tz;</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+            } catch (e) {</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+                cal.ASSERT(false, e);</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+            }</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+        }</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+    } else {</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+        tz = cal.getTimezoneService().getTimezone(aTimezone);</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+    }</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+    return tz;</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+}</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+/**</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+ * Creates a new calIDateTime from the given native time and optionally</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+ * the passed timezone. The timezone can either be the TZID of the timezone (in</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+ * this case the timezone service will be asked for the definition), or a string</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+ * representation of the timezone component (i.e a VTIMEZONE component).</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+ *</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+ * @param aNativeTime       The native time, in microseconds</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+ * @param aTimezone         The timezone identifier or definition.</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+ */</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+function newDateTime(aNativeTime, aTimezone) {</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+    let t = cal.createDateTime();</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+    t.nativeTime = aNativeTime;</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+    if (aTimezone) {</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+        let tz = getTimezone(aTimezone);</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+        if (tz) {</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+            t = t.getInTimezone(tz);</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+        } else {</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+            cal.ASSERT(false, &quot;Timezone not available: &quot; + aTimezone);</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+        }</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+    } else {</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+        t.timezone = cal.floating();</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+    }</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+    return t;</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,1074 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ *</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ *</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ * License.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ *</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ * The Original Code is Mozilla Calendar code.</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ *</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ *</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ *</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ *</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+/**</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+ * Welcome to the storage database migration.</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+ *</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+ * If you would like to change anything in the database schema, you must follow</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+ * some steps to make sure that upgrading from old versions works fine.</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+ *</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+ * First of all you must increment the DB_SCHEMA_VERSION variable below. Then</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+ * you must write your upgrader. To do this, create a new function and add it to</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+ * the upgrade object, similar to the existing upgraders below. An example is</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+ * given below.</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+ *</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+ * An upgrader MUST update both the database (if it is passed) AND the table</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+ * data javascript object. An example for a such object is in the v1/v2</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+ * upgrader. The process of upgrading calls the latest upgrader with the</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+ * database object and the current database version. The whole chain of</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+ * upgraders is then called (down to v1). The first upgrader (v1/v2) provides</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+ * the basic table data object. Each further upgrader then updates this object</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+ * to correspond with the database tables and columns. No actual database calls</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+ * are made until the first upgrader with a higher version than the current</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+ * database version is called. When this version is arrived, both the table data</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+ * object and the database are updated. This process continues until the</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+ * database is at the latest version.</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+ *</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+ * Note that your upgrader is not neccessarily called with a database object,</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+ * for example if the user's database is already at a higher version. In this</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+ * case your upgrader is called to compile the table data object. To make</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+ * calling code easier, there are a bunch of helper functions below that can be</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+ * called with a null database object and only call the database object if it is</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+ * not null. If you need to call new functions on the database object, check out</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+ * the createDBDelegate function below.</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+ *</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+ * The basic structure for an upgrader is (NN is current version, XX = NN - 1)</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+ *</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+ * upgrader.vNN = function upgrade_vNN(db, version) {</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+ *     let tbl = upgrade.vXX(version &lt; XX &amp;&amp; db, version);</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+ *     LOGdb(db, &quot;Storage: Upgrading to vNN&quot;);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+ *</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+ *     beginTransaction(db);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+ *     try {</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+ *         // Do stuff here</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+ *         setDbVersionAndCommit(db, NN);</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+ *     } catch (e) {</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+ *         throw reportErrorAndRollback(db, e);</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+ *     }</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+ *     return tbl;</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+ * }</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+ *</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+ * Regardless of how your upgrader looks, make sure you:</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+ * - use an sql transaction, if you have a database</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+ * - If everything succeeds, call setDbVersionAndCommit to update the database</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+ *     version (setDbVersionAndCommit also commits the transaction)</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+ * - If something fails, throw reportErrorAndRollback(db, e) to report the</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+ *     failure and roll back the transaction.</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+ *</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+ * If this documentation isn't sufficient to make upgrading understandable,</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+ * please file a bug.</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+ */</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calStorageHelpers.jsm&quot;);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+// The current database version. Be sure to increment this when you create a new</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+// updater.</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+var DB_SCHEMA_VERSION = 16;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;DB_SCHEMA_VERSION&quot;, &quot;getSql&quot;, &quot;getAllSql&quot;, &quot;getSqlTable&quot;, &quot;upgradeDB&quot;];</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+/**</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+ * Gets the SQL for the given table data and table name</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+ *</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+ * @param tblName       The name of the table to retrieve sql for</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+ * @param tblData       The table data object, as returned from the upgrade_v*</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+ *                        functions. If null, then the latest table data is</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+ *                        retrieved.</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+ * @param alternateName (optional) The table name to be used in the resulting</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+ *                        CREATE TABLE statement. If not set, tblName will be</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+ *                        used.</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+ * @return              The SQL Statement for the given table and version as a</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+ *                        string.</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+ */</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+function getSql(tblName, tblData, alternateName) {</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+    tblData = tblData || getSqlTable();</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+    let sql = &quot;CREATE TABLE &quot; +  (alternateName || tblName) + &quot; (\n&quot;;</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+    for (let [key, type] in Iterator(tblData[tblName]))  {</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+        sql += &quot;    &quot; + key + &quot; &quot; + type + &quot;,\n&quot;;</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+    }</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+    return sql.replace(/,\s*$/, &quot;);&quot;);</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+}</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+/**</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+ * Gets all SQL for the given table data</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+ *</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+ * @param version       The database schema version to retrieve. If null, the</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+ *                        latest schema version will be used.</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+ * @return              The SQL Statement for the given version as a string.</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+ */</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+function getAllSql(version) {</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+    let tblData = getSqlTable(version);</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+    let sql = &quot;&quot;;</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+    for (let tblName in tblData) {</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+        sql += getSql(tblName, tblData) + &quot;\n\n&quot;;</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+    }</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+    cal.LOG(&quot;Storage: Full SQL statement is &quot; + sql);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+    return sql;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+}</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+/**</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+ * Get the JS object corresponding to the given schema version</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+ *</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+ * @param schemaVersion       The schema version to get. If null, the latest</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+ *                              schema version will be used.</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+ * @return                    The javascript object containing the table</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+ *                              definition.</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+ */</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+function getSqlTable(schemaVersion) {</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+    let version = &quot;v&quot; + (schemaVersion || DB_SCHEMA_VERSION);</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+    if (version in upgrade) {</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+        return upgrade[version]();</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+    } else {</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+        return {};</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+    }</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+}</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+/**</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+ * Gets the current version of the storage database</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+ */</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+function getVersion(db) {</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+    let selectSchemaVersion;</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+    let version = null;</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+    try {</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+        selectSchemaVersion = createStatement(db,</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+                              &quot;SELECT version FROM &quot; +</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+                              &quot;cal_calendar_schema_version LIMIT 1&quot;);</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+        if (selectSchemaVersion.step()) {</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+            version = selectSchemaVersion.row.version;</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+        }</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+        if (version !== null) {</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+            // This is the only place to leave this function gracefully.</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+            return version;</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+        }</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+    } finally {</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+        if (selectSchemaVersion) {</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+            selectSchemaVersion.reset();</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+        }</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+    }</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+    throw &quot;cal_calendar_schema_version SELECT returned no results&quot;;</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+}</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+/**</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+ * Upgrade the passed database.</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+ *</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+ * @param db        The database to bring up to date.</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+ */</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+function upgradeDB(db) {</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+    cal.ASSERT(db, &quot;Database has not been opened!&quot;, true);</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+    if (!db.tableExists(&quot;cal_calendar_schema_version&quot;)) {</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+        cal.LOG(&quot;Storage: Creating tables from scratch&quot;);</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+        beginTransaction(db);</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+        try {</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+            executeSimpleSQL(db, getAllSql());</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+            setDbVersionAndCommit(db, DB_SCHEMA_VERSION);</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+        } catch (e) {</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+            reportErrorAndRollback(db, e);</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+        }</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+    } else {</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+        let version = getVersion(db);</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+        if (version &lt; DB_SCHEMA_VERSION) {</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+            cal.LOG(&quot;Storage: Preparing to upgrade v&quot; + version +</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+                    &quot; to v&quot; + DB_SCHEMA_VERSION);</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+            upgrade[&quot;v&quot; + DB_SCHEMA_VERSION](db, version);</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+        } else if (version &gt; DB_SCHEMA_VERSION) {</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+            throw Components.interfaces.calIErrors.STORAGE_UNKNOWN_SCHEMA_ERROR;</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+        }</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+    }</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+    ensureUpdatedTimezones(db);</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+}</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+/**</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+ * Sets the db version and commits any open transaction.</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+ *</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+ * @param db        The mozIStorageConnection to commit on</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+ * @param version   The version to set</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+ */</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+function setDbVersionAndCommit(db, version) {</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+    executeSimpleSQL(db, &quot;DELETE FROM cal_calendar_schema_version;&quot; +</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+                         &quot;INSERT INTO cal_calendar_schema_version &quot; +</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+                         &quot;(version) VALUES (&quot; + version + &quot;)&quot;);</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+    if (db &amp;&amp; db.transactionInProgress) {</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+        commitTransaction(db);</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+    }</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+}</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+/**</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+ * Creates a function that calls the given function |funcName| on it's passed</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+ * database. In addition, if no database is passed, the call is ignored.</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+ *</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+ * @param funcName      The function name to delegate.</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+ * @return              The delegate function for the passed named function.</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+ */</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+function createDBDelegate(funcName) {</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+    let func = function(db /* , ... */) {</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+        if (db) {</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+            let args = Array.slice(arguments);</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+            args.shift();</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+            try {</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+                return db[funcName].apply(db, args);</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+            } catch (e) {</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+                cal.ERROR(&quot;Error calling '&quot; + funcName + &quot;' db error: '&quot; +</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+                          lastErrorString(db) + &quot;'.\nException: &quot; + e);</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+                cal.WARN(cal.STACK(10));</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+            }</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+        }</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+    };</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+    func.name = &quot;dbDelegate_&quot; + funcName;</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+    return func;</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+}</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+/**</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+ * Creates a delegate function for a database getter. Returns a function that</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+ * can be called to get the specified attribute, if a database is passed. If no</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+ * database is passed, no error is thrown but null is returned.</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+ *</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+ * @param getterAttr        The getter to delegate.</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+ * @return                  The function that delegates the getter.</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+ */</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+function createDBDelegateGetter(getterAttr) {</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+    let func = function(db) {</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+        return (db ? db[getterAttr] : null);</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+    }</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+    func.name = &quot;dbDelegate_get_&quot; + getterAttr;</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+    return func;</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+}</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+// These functions use the db delegate to allow easier calling of common</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+// database functions.</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+var beginTransaction = createDBDelegate(&quot;beginTransaction&quot;);</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+var commitTransaction = createDBDelegate(&quot;commitTransaction&quot;);</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+var rollbackTransaction = createDBDelegate(&quot;rollbackTransaction&quot;);</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+var createStatement = createDBDelegate(&quot;createStatement&quot;);</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+var executeSimpleSQL = createDBDelegate(&quot;executeSimpleSQL&quot;);</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+var removeFunction = createDBDelegate(&quot;removeFunction&quot;);</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+var createFunction = createDBDelegate(&quot;createFunction&quot;);</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+var lastErrorString = createDBDelegateGetter(&quot;lastErrorString&quot;);</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+/**</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+ * Often in an upgrader we want to log something only if there is a database. To</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+ * make code less cludgy, here a helper function.</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+ *</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+ * @param db        The database, or null if nothing should be logged.</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+ * @param msg       The message to log.</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+ */</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+function LOGdb(db, msg) {</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+    if (db) {</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+        cal.LOG(msg);</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+    }</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+}</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+/**</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+ * Report an error and roll back the last transaction.</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+ *</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+ * @param db        The database to roll back on.</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+ * @param e         The exception to report</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+ * @return          The passed exception, for chaining.</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+ */</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+function reportErrorAndRollback(db, e) {</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+    if (db &amp;&amp; db.transactionInProgress) {</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+        rollbackTransaction(db);</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+    }</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+    cal.ERROR(&quot;++++++ Storage error!&quot; +</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+              &quot;++++++ DB Error: &quot; + lastErrorString(db) + &quot;\n&quot; +</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+              &quot;++++++ Exception: &quot; + e);</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+    return e;</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+}</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+/**</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+ * Make sure the timezones of the events in the database are up to date.</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+ *</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineplus">+ * @param db        The database to bring up to date</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineplus">+ */</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineplus">+function ensureUpdatedTimezones(db) {</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineplus">+    // check if timezone version has changed:</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+    let selectTzVersion = createStatement(db, &quot;SELECT version FROM cal_tz_version LIMIT 1&quot;);</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+    let version;</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+    try {</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+        version = (selectTzVersion.step() ? selectTzVersion.row.version : null);</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+    } finally {</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+        selectTzVersion.reset();</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineplus">+    }</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineplus">+</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineplus">+    let versionComp = 1;</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineplus">+    if (version) {</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineplus">+        versionComp = Components.classes[&quot;@mozilla.org/xpcom/version-comparator;1&quot;]</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineplus">+                                .getService(Components.interfaces.nsIVersionComparator)</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+                                .compare(cal.getTimezoneService().version, version);</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+    }</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+    if (versionComp &lt; 0) {</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+        // A timezones downgrade has happened!</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+        throw Components.interfaces.calIErrors.STORAGE_UNKNOWN_TIMEZONES_ERROR;</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+    } else if (versionComp &gt; 0) {</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+        cal.LOG(&quot;Timezones have been updated, updating calendar data.&quot;);</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineplus">+</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+        let zonesToUpdate = [];</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+        let getZones = createStatement(db,</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+            &quot;SELECT DISTINCT(zone) FROM (&quot;+</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineplus">+            &quot;SELECT recurrence_id_tz AS zone FROM cal_attendees  WHERE recurrence_id_tz IS NOT NULL UNION &quot; +</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+            &quot;SELECT recurrence_id_tz AS zone FROM cal_events     WHERE recurrence_id_tz IS NOT NULL UNION &quot; +</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+            &quot;SELECT event_start_tz   AS zone FROM cal_events     WHERE event_start_tz   IS NOT NULL UNION &quot; +</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineplus">+            &quot;SELECT event_end_tz     AS zone FROM cal_events     WHERE event_end_tz     IS NOT NULL UNION &quot; +</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+            &quot;SELECT recurrence_id_tz AS zone FROM cal_properties WHERE recurrence_id_tz IS NOT NULL UNION &quot; +</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+            &quot;SELECT recurrence_id_tz AS zone FROM cal_todos      WHERE recurrence_id_tz IS NOT NULL UNION &quot; +</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineplus">+            &quot;SELECT todo_entry_tz    AS zone FROM cal_todos      WHERE todo_entry_tz    IS NOT NULL UNION &quot; +</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+            &quot;SELECT todo_due_tz      AS zone FROM cal_todos      WHERE todo_due_tz      IS NOT NULL&quot; +</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+            &quot;);&quot;);</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+        try {</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+            while (getZones.step()) {</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+                let zone = getZones.row.zone;</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+                // Send the timezones off to the timezone service to attempt conversion:</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+                let tz = getTimezone(zone);</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+                if (tz) {</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+                    let refTz = cal.getTimezoneService().getTimezone(tz.tzid);</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+                    if (refTz &amp;&amp; refTz.tzid != zone) {</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+                        zonesToUpdate.push({ oldTzId: zone, newTzId: refTz.tzid });</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+                    }</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+                }</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+            }</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineplus">+        } catch (e) {</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineplus">+            cal.ERROR(&quot;Error updating timezones: &quot; + e +</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+                      &quot;\nDB Error &quot; + lastErrorString(db));</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+        } finally {</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+            getZones.reset();</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+        }</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+        beginTransaction(db);</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+        try {</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+            for each (let update in zonesToUpdate) {</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineplus">+                executeSimpleSQL(db,</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+                    &quot;UPDATE cal_attendees  SET recurrence_id_tz = '&quot; + update.newTzId + &quot;' WHERE recurrence_id_tz = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+                    &quot;UPDATE cal_events     SET recurrence_id_tz = '&quot; + update.newTzId + &quot;' WHERE recurrence_id_tz = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+                    &quot;UPDATE cal_events     SET event_start_tz   = '&quot; + update.newTzId + &quot;' WHERE event_start_tz   = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+                    &quot;UPDATE cal_events     SET event_end_tz     = '&quot; + update.newTzId + &quot;' WHERE event_end_tz     = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+                    &quot;UPDATE cal_properties SET recurrence_id_tz = '&quot; + update.newTzId + &quot;' WHERE recurrence_id_tz = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+                    &quot;UPDATE cal_todos      SET recurrence_id_tz = '&quot; + update.newTzId + &quot;' WHERE recurrence_id_tz = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+                    &quot;UPDATE cal_todos      SET todo_entry_tz    = '&quot; + update.newTzId + &quot;' WHERE todo_entry_tz    = '&quot; + update.oldTzId + &quot;'; &quot; +</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+                    &quot;UPDATE cal_todos      SET todo_due_tz      = '&quot; + update.newTzId + &quot;' WHERE todo_due_tz      = '&quot; + update.oldTzId + &quot;';&quot;);</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+            }</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+            executeSimpleSQL(db, &quot;DELETE FROM cal_tz_version; &quot; +</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+                                 &quot;INSERT INTO cal_tz_version VALUES ('&quot; +</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+                                 cal.getTimezoneService().version + &quot;');&quot;);</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+            commitTransaction(db);</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+        } catch (e) {</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+            cal.ASSERT(false, &quot;Timezone update failed! DB Error: &quot; + lastErrorString(db));</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+            rollbackTransaction(db);</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+            throw e;</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+        }</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+    }</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+}</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+/**</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+ * Adds a column to the given table.</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+ *</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineplus">+ * @param tblData       The table data object to apply the operation on.</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+ * @param tblName       The table name to add on</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+ * @param colName       The column name to add</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+ * @param colType       The type of the column to add</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+ * @param db            (optional) The database to apply the operation on</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+ */</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+function addColumn(tblData, tblName, colName, colType, db) {</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+    tblData[tblName][colName] = colType;</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+    executeSimpleSQL(db, &quot;ALTER TABLE &quot; + tblName +</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineplus">+                         &quot;  ADD COLUMN &quot; + colName + &quot; &quot; + colType);</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineplus">+}</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineplus">+</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+/**</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+ * Deletes columns from the given table.</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+ *</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+ * @param tblData       The table data object to apply the operation on.</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+ * @param tblName       The table name to delete on</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineplus">+ * @param colNameArray  An array of colum names to delete</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineplus">+ * @param db            (optional) The database to apply the operation on</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+ */</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineplus">+function deleteColumns(tblData, tblName, colNameArray, db) {</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineplus">+    for each (let colName in colNameArray) {</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+        delete tblData[tblName][colName];</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+    }</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineplus">+</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineplus">+    let columns = [ k for (k in tblData[tblName]) ];</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineplus">+    executeSimpleSQL(db, getSql(tblName, tblData, tblName + &quot;_temp&quot;));</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineplus">+    executeSimpleSQL(db, &quot;INSERT INTO &quot; + tblName + &quot;_temp&quot; +</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineplus">+                         &quot;  (&quot; + columns.join(&quot;,&quot;) + &quot;) &quot; +</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineplus">+                         &quot;SELECT &quot; + columns.join(&quot;,&quot;) +</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+                         &quot;  FROM &quot; + tblName + &quot;;&quot;);</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineplus">+    executeSimpleSQL(db, &quot;DROP TABLE &quot; + tblName + &quot;; &quot; +</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineplus">+                         &quot;ALTER TABLE &quot; + tblName + &quot;_temp&quot; +</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineplus">+                         &quot;  RENAME TO &quot; + tblName + &quot;;&quot;);</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineplus">+}</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineplus">+</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineplus">+/**</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineplus">+ * Does a full copy of the given table</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineplus">+ *</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+ * @param tblData       The table data object to apply the operation on.</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+ * @param tblName       The table name to copy</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+ * @param newTblName    The target table name.</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+ * @param db            (optional) The database to apply the operation on</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+ * @param condition     (optional) The condition to respect when copying</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineplus">+ */</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+function copyTable(tblData, tblName, newTblName, db, condition) {</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineplus">+    function objcopy(obj) {</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineplus">+        return eval(obj.toSource());</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+    }</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineplus">+</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineplus">+    tblData[newTblName] = objcopy(tblData[tblName]);</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineplus">+</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineplus">+    let columns = [ k for (k in tblData[newTblName]) ];</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+    executeSimpleSQL(db, getSql(newTblName, tblData));</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+    executeSimpleSQL(db, &quot;INSERT INTO &quot; + newTblName +</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+                         &quot;  (&quot; + columns.join(&quot;,&quot;) + &quot;) &quot; +</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineplus">+                         &quot;SELECT &quot; + columns.join(&quot;,&quot;) +</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+                         &quot;  FROM &quot; + tblName + &quot; &quot; +</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineplus">+                              (condition ? condition : &quot;&quot;) +</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineplus">+                         &quot;;&quot;);</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+}</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineplus">+</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineplus">+/**</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineplus">+ * Alter the type of a certain column</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineplus">+ *</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineplus">+ * @param tblData       The table data object to apply the operation on.</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineplus">+ * @param tblName       The table name to alter</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineplus">+ * @param colNameArray  An array of colum names to delete</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineplus">+ * @param newType       The new type of the column</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineplus">+ * @param db            (optional) The database to apply the operation on</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineplus">+ */</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+function alterTypes(tblData, tblName, colNameArray, newType, db) {</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineplus">+    for each (let colName in colNameArray) {</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineplus">+        tblData[tblName][colName] = newType;</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineplus">+    }</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineplus">+</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+    let columns = [ k for (k in tblData[tblName]) ];</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineplus">+    executeSimpleSQL(db, getSql(tblName, tblData, tblName + &quot;_temp&quot;));</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineplus">+    executeSimpleSQL(db, &quot;INSERT INTO &quot; + tblName + &quot;_temp&quot; +</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineplus">+                         &quot;  (&quot; + columns.join(&quot;,&quot;) + &quot;) &quot; +</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineplus">+                         &quot;SELECT &quot; + columns.join(&quot;,&quot;) +</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineplus">+                         &quot;  FROM &quot; + tblName + &quot;;&quot;);</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineplus">+    executeSimpleSQL(db, &quot;DROP TABLE &quot; + tblName + &quot;; &quot; +</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineplus">+                         &quot;ALTER TABLE &quot; + tblName + &quot;_temp&quot; +</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineplus">+                         &quot;  RENAME TO &quot; + tblName + &quot;;&quot;);</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineplus">+}</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+/**</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineplus">+ * Drops the given table.</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+ *</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineplus">+ * @param tblData       The table data object to apply the operation on.</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineplus">+ * @param tblName       The table name to drop</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineplus">+ * @param db            (optional) The database to apply the operation on</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineplus">+ */</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineplus">+function dropTable(tblData, tblName, db) {</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineplus">+    delete tblData[tblName];</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineplus">+</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineplus">+    executeSimpleSQL(db, &quot;DROP TABLE IF EXISTS &quot; + tblName + &quot;;&quot;);</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineplus">+}</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineplus">+</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineplus">+/**</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineplus">+ * Creates the given table.</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineplus">+ *</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineplus">+ * @param tblData       The table data object to apply the operation on.</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineplus">+ * @param tblName       The table name to add</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+ * @param def           The table definition object</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineplus">+ * @param db            (optional) The database to apply the operation on</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineplus">+ */</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineplus">+function addTable(tblData, tblName, def, db) {</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineplus">+    tblData[tblName] = def;</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineplus">+</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineplus">+    executeSimpleSQL(db, getSql(tblName, tblData));</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineplus">+}</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineplus">+</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineplus">+/** Object holding upgraders */</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineplus">+var upgrade = {};</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineplus">+</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineplus">+/**</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineplus">+ * Returns the initial storage database schema. Note this is not the current</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineplus">+ * schema, it will be modified by the upgrade.vNN() functions. This function</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineplus">+ * returns the initial v1 with modifications from v2 applied.</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineplus">+ *</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineplus">+ * No bug - new recurrence system. exceptions supported now, along with</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+ * everything else ical can throw at us. I hope.</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineplus">+ * p=vlad</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineplus">+ */</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineplus">+upgrade.v2 = upgrade.v1 = function upgrade_v2(db, version) {</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v1/v2&quot;);</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineplus">+    let tblData = {</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineplus">+      cal_calendar_schema_version: {</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineplus">+        version: &quot;INTEGER&quot;</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineplus">+      },</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineplus">+</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineplus">+    /* While this table is in v1, actually keeping it in the sql object will</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineplus">+     * cause problems when migrating from storage.sdb to local.sqlite. There,</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineplus">+     * all tables from storage.sdb will be moved to local.sqlite and so starting</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineplus">+     * sunbird again afterwards causes a borked upgrade since its missing tables</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineplus">+     * it expects.</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineplus">+     *</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineplus">+     *  cal_calendars: {</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineplus">+     *   id:  &quot;INTEGER PRIMARY KEY&quot;,</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineplus">+     *   name: &quot;STRING&quot;</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+     * },</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineplus">+     */</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineplus">+</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineplus">+      cal_items: {</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineplus">+        cal_id: &quot;INTEGER&quot;,</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineplus">+        item_type: &quot;INTEGER&quot;,</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+        id: &quot;STRING&quot;,</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineplus">+        time_created: &quot;INTEGER&quot;,</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineplus">+        last_modified: &quot;INTEGER&quot;,</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineplus">+        title: &quot;STRING&quot;,</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineplus">+        priority: &quot;INTEGER&quot;,</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineplus">+        privacy: &quot;STRING&quot;,</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+        ical_status: &quot;STRING&quot;,</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+        flags: &quot;INTEGER&quot;,</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+        event_start: &quot;INTEGER&quot;,</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineplus">+        event_end: &quot;INTEGER&quot;,</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineplus">+        event_stamp: &quot;INTEGER&quot;,</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineplus">+        todo_entry: &quot;INTEGER&quot;,</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineplus">+        todo_due: &quot;INTEGER&quot;,</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineplus">+        todo_completed: &quot;INTEGER&quot;,</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineplus">+        todo_complete: &quot;INTEGER&quot;,</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineplus">+        alarm_id: &quot;INTEGER&quot;</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineplus">+      },</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineplus">+</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineplus">+      cal_attendees: {</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineplus">+        item_id: &quot;STRING&quot;,</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineplus">+        attendee_id: &quot;STRING&quot;,</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+        common_name: &quot;STRING&quot;,</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineplus">+        rsvp: &quot;INTEGER&quot;,</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineplus">+        role: &quot;STRING&quot;,</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineplus">+        status: &quot;STRING&quot;,</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineplus">+        type: &quot;STRING&quot;</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineplus">+      },</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineplus">+</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineplus">+      cal_alarms: {</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineplus">+        id: &quot;INTEGER PRIMARY KEY&quot;,</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineplus">+        alarm_data: &quot;BLOB&quot;</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineplus">+      },</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineplus">+</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+      cal_recurrence: {</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineplus">+        item_id: &quot;STRING&quot;,</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineplus">+        recur_type: &quot;INTEGER&quot;,</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineplus">+        recur_index: &quot;INTEGER&quot;,</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineplus">+        is_negative: &quot;BOOLEAN&quot;,</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineplus">+        dates: &quot;STRING&quot;,</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineplus">+        end_date: &quot;INTEGER&quot;,</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineplus">+        count: &quot;INTEGER&quot;,</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineplus">+        interval: &quot;INTEGER&quot;,</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineplus">+        second: &quot;STRING&quot;,</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineplus">+        minute: &quot;STRING&quot;,</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineplus">+        hour: &quot;STRING&quot;,</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineplus">+        day: &quot;STRING&quot;,</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineplus">+        monthday: &quot;STRING&quot;,</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineplus">+        yearday: &quot;STRING&quot;,</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineplus">+        weekno: &quot;STRING&quot;,</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineplus">+        month: &quot;STRING&quot;,</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineplus">+        setpos: &quot;STRING&quot;</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+      },</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineplus">+</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+      cal_properties: {</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineplus">+        item_id: &quot;STRING&quot;,</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineplus">+        key: &quot;STRING&quot;,</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineplus">+        value: &quot;BLOB&quot;</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineplus">+      }</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineplus">+    };</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineplus">+</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineplus">+    for (let tbl in tblData) {</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineplus">+        executeSimpleSQL(db, &quot;DROP TABLE IF EXISTS &quot; + tbl);</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineplus">+    }</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineplus">+    return tblData;</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineplus">+};</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineplus">+</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineplus">+/**</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineplus">+ * Upgrade to version 3.</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+ * Bug 293707, updates to storage provider; calendar manager database locked</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+ * fix, r=shaver, p=vlad</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+ * p=vlad</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+ */</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+upgrade.v3 = function upgrade_v3(db, version) {</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineplus">+    let tbl = upgrade.v2(version &lt; 2 &amp;&amp; db, version);</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v3&quot;);</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineplus">+</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineplus">+    try {</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineplus">+</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineplus">+        copyTable(tbl, &quot;cal_items&quot;, &quot;cal_events&quot;, db, &quot;item_type = 0&quot;);</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineplus">+        copyTable(tbl, &quot;cal_items&quot;, &quot;cal_todos&quot;, db, &quot;item_type = 1&quot;);</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineplus">+</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineplus">+        dropTable(tbl, &quot;cal_items&quot;, db);</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineplus">+</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineplus">+        let removeEventCols = [&quot;item_type&quot;,</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineplus">+                               &quot;item_type&quot;,</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineplus">+                               &quot;todo_entry&quot;,</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineplus">+                               &quot;todo_due&quot;,</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineplus">+                               &quot;todo_completed&quot;,</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineplus">+                               &quot;todo_complete&quot;,</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineplus">+                               &quot;alarm_id&quot;];</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineplus">+        deleteColumns(tbl, &quot;cal_events&quot;, removeEventCols, db);</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineplus">+</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineplus">+        addColumn(tbl, &quot;cal_events&quot;, &quot;event_start_tz&quot;, &quot;VARCHAR&quot;, db);</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineplus">+        addColumn(tbl, &quot;cal_events&quot;, &quot;event_end_tz&quot;, &quot;VARCHAR&quot;, db);</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineplus">+        addColumn(tbl, &quot;cal_events&quot;, &quot;alarm_time&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineplus">+        addColumn(tbl, &quot;cal_events&quot;, &quot;alarm_time_tz&quot;, &quot;VARCHAR&quot;, db);</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineplus">+</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineplus">+        let removeTodoCols = [&quot;item_type&quot;,</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineplus">+                              &quot;event_start&quot;,</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineplus">+                              &quot;event_end&quot;,</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineplus">+                              &quot;event_stamp&quot;,</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+                              &quot;alarm_id&quot;];</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+        deleteColumns(tbl, &quot;cal_todos&quot;, removeTodoCols, db);</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+        addColumn(tbl, &quot;cal_todos&quot;, &quot;todo_entry_tz&quot;, &quot;VARCHAR&quot;, db);</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+        addColumn(tbl, &quot;cal_todos&quot;, &quot;todo_due_tz&quot;, &quot;VARCHAR&quot;, db);</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineplus">+        addColumn(tbl, &quot;cal_todos&quot;, &quot;todo_completed_tz&quot;, &quot;VARCHAR&quot;, db);</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineplus">+        addColumn(tbl, &quot;cal_todos&quot;, &quot;alarm_time&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+        addColumn(tbl, &quot;cal_todos&quot;, &quot;alarm_time_tz&quot;, &quot;VARCHAR&quot;, db);</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineplus">+</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineplus">+        dropTable(tbl, &quot;cal_alarms&quot;, db);</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineplus">+</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+        // The change between 2 and 3 includes the splitting of cal_items into</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineplus">+        // cal_events and cal_todos, and the addition of columns for</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineplus">+        // event_start_tz, event_end_tz, todo_entry_tz, todo_due_tz.</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineplus">+        // These need to default to &quot;UTC&quot; if their corresponding time is</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineplus">+        // given, since that's what the default was for v2 calendars</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineplus">+</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineplus">+        // Fix up the new timezone columns</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineplus">+        function updateSql(tbl, field) {</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineplus">+            executeSimpleSQL(db, &quot;UPDATE &quot; + tbl + &quot; SET &quot; + field + &quot;_tz='UTC'&quot; +</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineplus">+                                 &quot; WHERE &quot; + field + &quot; IS NOT NULL&quot;);</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineplus">+        }</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineplus">+</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineplus">+        updateSql(&quot;cal_events&quot;, &quot;event_start&quot;);</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineplus">+        updateSql(&quot;cal_events&quot;, &quot;event_end&quot;);</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineplus">+        updateSql(&quot;cal_todos&quot;, &quot;todo_entry&quot;);</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineplus">+        updateSql(&quot;cal_todos&quot;, &quot;todo_due&quot;);</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineplus">+        updateSql(&quot;cal_todos&quot;, &quot;todo_completed&quot;);</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineplus">+</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineplus">+        setDbVersionAndCommit(db, 3);</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineplus">+    }</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+    return tbl;</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineplus">+};</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineplus">+</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineplus">+/**</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineplus">+ * Upgrade to version 4.</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineplus">+ * Bug 293183 - implement exception support for recurrence.</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineplus">+ * r=shaver,p=vlad</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineplus">+ */</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineplus">+upgrade.v4 = function upgrade_v4(db, version) {</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineplus">+    let tbl = upgrade.v3(version &lt; 3 &amp;&amp; db, version);</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v4&quot;);</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineplus">+</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineplus">+    try {</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineplus">+        for each (let tblid in [&quot;events&quot;, &quot;todos&quot;, &quot;attendees&quot;, &quot;properties&quot;]) {</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineplus">+            addColumn(tbl, &quot;cal_&quot; + tblid, &quot;recurrence_id&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineplus">+            addColumn(tbl, &quot;cal_&quot; + tblid, &quot;recurrence_id_tz&quot;, &quot;VARCHAR&quot;, db);</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineplus">+        }</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineplus">+        setDbVersionAndCommit(db, 4);</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineplus">+    }</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineplus">+</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineplus">+    return tbl;</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+};</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineplus">+</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+/**</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineplus">+ * Bug 315051 - Switch to storing alarms based on offsets from start/end time</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineplus">+ * rather than as absolute times. Ensure that missed alarms are fired.</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineplus">+ * r=dmose, p=jminta</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineplus">+ */</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineplus">+upgrade.v5 = function upgrade_v5(db, version) {</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineplus">+    let tbl = upgrade.v4(version &lt; 4 &amp;&amp; db, version);</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v5&quot;);</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineplus">+</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineplus">+    try {</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineplus">+        for each (let tblid in [&quot;events&quot;, &quot;todos&quot;]) {</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineplus">+            addColumn(tbl, &quot;cal_&quot; + tblid, &quot;alarm_offset&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineplus">+            addColumn(tbl, &quot;cal_&quot; + tblid, &quot;alarm_related&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineplus">+            addColumn(tbl, &quot;cal_&quot; + tblid, &quot;alarm_last_ack&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineplus">+        }</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineplus">+        setDbVersionAndCommit(db, 5);</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineplus">+    }</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineplus">+</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineplus">+    return tbl;</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineplus">+};</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineplus">+</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineplus">+/**</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineplus">+ * Bug 333688 - Converts STRING and VARCHAR columns to TEXT to avoid SQLite's</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineplus">+ * auto-conversion of strings to numbers (10e4 to 10000)</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineplus">+ * r=ctalbert,jminta p=lilmatt</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineplus">+ */</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineplus">+upgrade.v6 = function upgrade_v6(db, version) {</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineplus">+    let tbl = upgrade.v5(version &lt; 5 &amp;&amp; db, version);</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v6&quot;);</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineplus">+</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineplus">+    try {</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineplus">+        let eventCols = [&quot;id&quot;, &quot;title&quot;, &quot;privacy&quot;, &quot;ical_status&quot;,</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineplus">+                         &quot;recurrence_id_tz&quot;, &quot;event_start_tz&quot;,</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineplus">+                         &quot;event_end_tz&quot;, &quot;alarm_time_tz&quot;];</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineplus">+        alterTypes(tbl, &quot;cal_events&quot;, eventCols, &quot;TEXT&quot;, db);</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineplus">+</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineplus">+        let todoCols = [&quot;id&quot;, &quot;title&quot;, &quot;privacy&quot;, &quot;ical_status&quot;,</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineplus">+                         &quot;recurrence_id_tz&quot;, &quot;todo_entry_tz&quot;,</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineplus">+                         &quot;todo_due_tz&quot;, &quot;todo_completed_tz&quot;,</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineplus">+                         &quot;alarm_time_tz&quot;];</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineplus">+        alterTypes(tbl, &quot;cal_todos&quot;, todoCols, &quot;TEXT&quot;, db);</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineplus">+</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineplus">+        let attendeeCols = [&quot;item_id&quot;, &quot;recurrence_id_tz&quot;, &quot;attendee_id&quot;,</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineplus">+                            &quot;common_name&quot;, &quot;role&quot;, &quot;status&quot;, &quot;type&quot;];</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineplus">+        alterTypes(tbl, &quot;cal_attendees&quot;, attendeeCols, &quot;TEXT&quot;, db);</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineplus">+</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineplus">+        let recurrenceCols =  [&quot;item_id&quot;, &quot;recur_type&quot;, &quot;dates&quot;, &quot;second&quot;,</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineplus">+                               &quot;minute&quot;, &quot;hour&quot;, &quot;day&quot;, &quot;monthday&quot;, &quot;yearday&quot;,</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineplus">+                               &quot;weekno&quot;, &quot;month&quot;, &quot;setpos&quot;];</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineplus">+        alterTypes(tbl, &quot;cal_recurrence&quot;, recurrenceCols, &quot;TEXT&quot;, db);</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineplus">+</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineplus">+        let propertyCols = [&quot;item_id&quot;, &quot;recurrence_id_tz&quot;, &quot;key&quot;];</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineplus">+        alterTypes(tbl, &quot;cal_properties&quot;, propertyCols, &quot;TEXT&quot;, db);</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineplus">+        setDbVersionAndCommit(db, 6);</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineplus">+    }</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineplus">+</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineplus">+    return tbl;</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineplus">+};</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineplus">+</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineplus">+/**</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineplus">+ * Bug 369010: Migrate all old tzids in storage to new one.</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineplus">+ * r=ctalbert,dmose p=lilmatt</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineplus">+ */</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineplus">+upgrade.v7 = function upgrade_v7(db, version) {</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineplus">+    // No schema changes in v7</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineplus">+    let tbl = upgrade.v6(db, version);</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v7&quot;);</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineplus">+    return tbl;</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineplus">+};</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineplus">+</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineplus">+/**</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineplus">+ * Bug 410931 - Update internal timezone definitions</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineplus">+ * r=ctalbert, p=dbo,nth10sd,hb</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineplus">+ */</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineplus">+upgrade.v8 = function upgrade_v8(db, version) {</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineplus">+    // No schema changes in v8</span>
<a href="#l8.804"></a><span id="l8.804" class="difflineplus">+    let tbl = upgrade.v7(db, version);</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v8&quot;);</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineplus">+    return tbl;</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineplus">+};</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineplus">+</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineplus">+/**</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineplus">+ * Bug 363191 - Handle Timezones more efficiently (Timezone Database)</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineplus">+ * r=philipp,ctalbert, p=dbo</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineplus">+ */</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineplus">+upgrade.v9 = function upgrade_v9(db, version) {</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineplus">+    // No schema changes in v9</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineplus">+    let tbl = upgrade.v8(db, version);</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v9&quot;);</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineplus">+    return tbl;</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineplus">+};</span>
<a href="#l8.819"></a><span id="l8.819" class="difflineplus">+</span>
<a href="#l8.820"></a><span id="l8.820" class="difflineplus">+/**</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineplus">+ * Bug 413908 – Events using internal timezones are no longer updated to</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineplus">+ * recent timezone version;</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineplus">+ * r=philipp, p=dbo</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineplus">+ */</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineplus">+upgrade.v10 = function upgrade_v10(db, version) {</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineplus">+    let tbl = upgrade.v9(version &lt; 9 &amp;&amp; db, version);</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v10&quot;);</span>
<a href="#l8.828"></a><span id="l8.828" class="difflineplus">+</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineplus">+    try {</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineplus">+        addTable(tbl, &quot;cal_tz_version&quot;, { version: &quot;TEXT&quot; }, db);</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineplus">+        setDbVersionAndCommit(db, 10);</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineplus">+    }</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineplus">+    return tbl;</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineplus">+};</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineplus">+</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineplus">+/**</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineplus">+ * Fix bug 319909 - Failure to properly serialize/unserialize ics ATTACH</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineplus">+ * properties.</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineplus">+ * r=philipp,p=fred.jen@web.de</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineplus">+ */</span>
<a href="#l8.844"></a><span id="l8.844" class="difflineplus">+upgrade.v11 = function upgrade_v11(db, version) {</span>
<a href="#l8.845"></a><span id="l8.845" class="difflineplus">+    let tbl = upgrade.v10(version &lt; 10 &amp;&amp; db, version);</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v11&quot;);</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineplus">+</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineplus">+    try {</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineplus">+        addTable(tbl, &quot;cal_attachments&quot;, {</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineplus">+            item_id: &quot;TEXT&quot;,</span>
<a href="#l8.852"></a><span id="l8.852" class="difflineplus">+            data: &quot;BLOB&quot;,</span>
<a href="#l8.853"></a><span id="l8.853" class="difflineplus">+            format_type: &quot;TEXT&quot;,</span>
<a href="#l8.854"></a><span id="l8.854" class="difflineplus">+            encoding: &quot;TEXT&quot;</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineplus">+        }, db);</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineplus">+        setDbVersionAndCommit(db, 11);</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.858"></a><span id="l8.858" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l8.859"></a><span id="l8.859" class="difflineplus">+    }</span>
<a href="#l8.860"></a><span id="l8.860" class="difflineplus">+    return tbl;</span>
<a href="#l8.861"></a><span id="l8.861" class="difflineplus">+};</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineplus">+</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineplus">+/**</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineplus">+ * Bug 449031 - Add meta data API to memory/storage</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineplus">+ * r=philipp, p=dbo</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineplus">+ */</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineplus">+upgrade.v12 = function upgrade_v12(db, version) {</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineplus">+    let tbl = upgrade.v11(version &lt; 11 &amp;&amp; db, version);</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v12&quot;);</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineplus">+</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l8.872"></a><span id="l8.872" class="difflineplus">+    try {</span>
<a href="#l8.873"></a><span id="l8.873" class="difflineplus">+        addColumn(tbl, &quot;cal_attendees&quot;, &quot;is_organizer&quot;, &quot;BOOLEAN&quot;, db);</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineplus">+        addColumn(tbl, &quot;cal_attendees&quot;, &quot;properties&quot;, &quot;BLOB&quot;, db);</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineplus">+</span>
<a href="#l8.876"></a><span id="l8.876" class="difflineplus">+        addTable(tbl, &quot;cal_metadata&quot;, {</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineplus">+            cal_id: &quot;INTEGER&quot;,</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineplus">+            item_id: &quot;TEXT UNIQUE&quot;,</span>
<a href="#l8.879"></a><span id="l8.879" class="difflineplus">+            value: &quot;BLOB&quot;</span>
<a href="#l8.880"></a><span id="l8.880" class="difflineplus">+        }, db);</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineplus">+        setDbVersionAndCommit(db, 12);</span>
<a href="#l8.882"></a><span id="l8.882" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.883"></a><span id="l8.883" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineplus">+    }</span>
<a href="#l8.885"></a><span id="l8.885" class="difflineplus">+</span>
<a href="#l8.886"></a><span id="l8.886" class="difflineplus">+    return tbl;</span>
<a href="#l8.887"></a><span id="l8.887" class="difflineplus">+};</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineplus">+</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineplus">+/**</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineplus">+ * Bug 449401 - storage provider doesn't cleanly separate items of the same id</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineplus">+ * across different calendars</span>
<a href="#l8.892"></a><span id="l8.892" class="difflineplus">+ * r=dbo,philipp, p=wsourdeau@inverse.ca</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineplus">+ */</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineplus">+upgrade.v13 = function upgrade_v13(db, version) {</span>
<a href="#l8.895"></a><span id="l8.895" class="difflineplus">+    let tbl = upgrade.v12(version &lt; 12 &amp;&amp; db, version);</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v13&quot;);</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineplus">+</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineplus">+    try {</span>
<a href="#l8.900"></a><span id="l8.900" class="difflineplus">+        alterTypes(tbl, &quot;cal_metadata&quot;, [&quot;item_id&quot;], &quot;TEXT&quot;, db);</span>
<a href="#l8.901"></a><span id="l8.901" class="difflineplus">+</span>
<a href="#l8.902"></a><span id="l8.902" class="difflineplus">+        let calIds = {};</span>
<a href="#l8.903"></a><span id="l8.903" class="difflineplus">+        if (db) {</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineplus">+            for each (let itemTable in [&quot;events&quot;, &quot;todos&quot;]) {</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineplus">+                let stmt = createStatement(db,</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineplus">+                                           &quot;SELECT id, cal_id FROM cal_&quot; + itemTable);</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineplus">+                while (stmt.step()) {</span>
<a href="#l8.908"></a><span id="l8.908" class="difflineplus">+                    calIds[stmt.row.id] = stmt.row.cal_id;</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineplus">+                }</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineplus">+                stmt.reset();</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineplus">+            }</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineplus">+        }</span>
<a href="#l8.913"></a><span id="l8.913" class="difflineplus">+</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineplus">+        for each (let tblid in [&quot;attendees&quot;, &quot;recurrence&quot;, &quot;properties&quot;,</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineplus">+                                &quot;attachments&quot;]) {</span>
<a href="#l8.916"></a><span id="l8.916" class="difflineplus">+            addColumn(tbl, &quot;cal_&quot; + tblid, &quot;cal_id&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l8.917"></a><span id="l8.917" class="difflineplus">+</span>
<a href="#l8.918"></a><span id="l8.918" class="difflineplus">+            for (let itemId in calIds) {</span>
<a href="#l8.919"></a><span id="l8.919" class="difflineplus">+                executeSimpleSQL(db, &quot;UPDATE cal_&quot; + tblid +</span>
<a href="#l8.920"></a><span id="l8.920" class="difflineplus">+                                     &quot;   SET cal_id = &quot; + calIds[itemId] +</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineplus">+                                     &quot; WHERE item_id = '&quot; + itemId + &quot;'&quot;);</span>
<a href="#l8.922"></a><span id="l8.922" class="difflineplus">+            }</span>
<a href="#l8.923"></a><span id="l8.923" class="difflineplus">+        }</span>
<a href="#l8.924"></a><span id="l8.924" class="difflineplus">+</span>
<a href="#l8.925"></a><span id="l8.925" class="difflineplus">+        executeSimpleSQL(db, &quot;DROP INDEX IF EXISTS&quot; +</span>
<a href="#l8.926"></a><span id="l8.926" class="difflineplus">+                             &quot; idx_cal_properies_item_id&quot;);</span>
<a href="#l8.927"></a><span id="l8.927" class="difflineplus">+        executeSimpleSQL(db, &quot;CREATE INDEX IF NOT EXISTS&quot; +</span>
<a href="#l8.928"></a><span id="l8.928" class="difflineplus">+                             &quot; idx_cal_properies_item_id&quot; +</span>
<a href="#l8.929"></a><span id="l8.929" class="difflineplus">+                             &quot; ON cal_properties(cal_id, item_id);&quot;);</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineplus">+        setDbVersionAndCommit(db, 13);</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l8.933"></a><span id="l8.933" class="difflineplus">+    }</span>
<a href="#l8.934"></a><span id="l8.934" class="difflineplus">+    return tbl;</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineplus">+};</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineplus">+</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineplus">+/**</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineplus">+ * Bug 446303 - use the &quot;RELATED-TO&quot; property.</span>
<a href="#l8.939"></a><span id="l8.939" class="difflineplus">+ * r=philipp,dbo, p=fred.jen@web.de</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineplus">+ */</span>
<a href="#l8.941"></a><span id="l8.941" class="difflineplus">+upgrade.v14 = function upgrade_v14(db, version) {</span>
<a href="#l8.942"></a><span id="l8.942" class="difflineplus">+    let tbl = upgrade.v13(version &lt; 13 &amp;&amp; db, version);</span>
<a href="#l8.943"></a><span id="l8.943" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v14&quot;);</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineplus">+</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineplus">+    try {</span>
<a href="#l8.947"></a><span id="l8.947" class="difflineplus">+        addTable(tbl, &quot;cal_relations&quot;, {</span>
<a href="#l8.948"></a><span id="l8.948" class="difflineplus">+            cal_id: &quot;INTEGER&quot;,</span>
<a href="#l8.949"></a><span id="l8.949" class="difflineplus">+            item_id: &quot;TEXT&quot;,</span>
<a href="#l8.950"></a><span id="l8.950" class="difflineplus">+            rel_type: &quot;TEXT&quot;,</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineplus">+            rel_id: &quot;TEXT&quot;</span>
<a href="#l8.952"></a><span id="l8.952" class="difflineplus">+        }, db);</span>
<a href="#l8.953"></a><span id="l8.953" class="difflineplus">+        setDbVersionAndCommit(db, 14);</span>
<a href="#l8.954"></a><span id="l8.954" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.955"></a><span id="l8.955" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l8.956"></a><span id="l8.956" class="difflineplus">+    }</span>
<a href="#l8.957"></a><span id="l8.957" class="difflineplus">+    return tbl;</span>
<a href="#l8.958"></a><span id="l8.958" class="difflineplus">+};</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineplus">+</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineplus">+/**</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineplus">+ * Bug 463282 - Tasks cannot be created or imported (regression).</span>
<a href="#l8.962"></a><span id="l8.962" class="difflineplus">+ * r=philipp,berend, p=dbo</span>
<a href="#l8.963"></a><span id="l8.963" class="difflineplus">+ */</span>
<a href="#l8.964"></a><span id="l8.964" class="difflineplus">+upgrade.v15 = function upgrade_v15(db, version) {</span>
<a href="#l8.965"></a><span id="l8.965" class="difflineplus">+    let tbl = upgrade.v14(version &lt; 14 &amp;&amp; db, version);</span>
<a href="#l8.966"></a><span id="l8.966" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v15&quot;);</span>
<a href="#l8.967"></a><span id="l8.967" class="difflineplus">+</span>
<a href="#l8.968"></a><span id="l8.968" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l8.969"></a><span id="l8.969" class="difflineplus">+    try {</span>
<a href="#l8.970"></a><span id="l8.970" class="difflineplus">+        addColumn(tbl, &quot;cal_todos&quot;, &quot;todo_stamp&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineplus">+        setDbVersionAndCommit(db, 15);</span>
<a href="#l8.972"></a><span id="l8.972" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.973"></a><span id="l8.973" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l8.974"></a><span id="l8.974" class="difflineplus">+    }</span>
<a href="#l8.975"></a><span id="l8.975" class="difflineplus">+    return tbl;</span>
<a href="#l8.976"></a><span id="l8.976" class="difflineplus">+};</span>
<a href="#l8.977"></a><span id="l8.977" class="difflineplus">+</span>
<a href="#l8.978"></a><span id="l8.978" class="difflineplus">+/**</span>
<a href="#l8.979"></a><span id="l8.979" class="difflineplus">+ * Bug 353492 - support multiple alarms per events/task, support</span>
<a href="#l8.980"></a><span id="l8.980" class="difflineplus">+ * absolute alarms with fixed date/time - Storage Provider support for multiple</span>
<a href="#l8.981"></a><span id="l8.981" class="difflineplus">+ * alarms.</span>
<a href="#l8.982"></a><span id="l8.982" class="difflineplus">+ * r=dbo,ssitter, p=philipp</span>
<a href="#l8.983"></a><span id="l8.983" class="difflineplus">+ */</span>
<a href="#l8.984"></a><span id="l8.984" class="difflineplus">+upgrade.v16 = function upgrade_v16(db, version) {</span>
<a href="#l8.985"></a><span id="l8.985" class="difflineplus">+    let tbl = upgrade.v15(version &lt; 15 &amp;&amp; db, version);</span>
<a href="#l8.986"></a><span id="l8.986" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v16&quot;);</span>
<a href="#l8.987"></a><span id="l8.987" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l8.988"></a><span id="l8.988" class="difflineplus">+    try {</span>
<a href="#l8.989"></a><span id="l8.989" class="difflineplus">+        createFunction(db, &quot;translateAlarm&quot;, 4, {</span>
<a href="#l8.990"></a><span id="l8.990" class="difflineplus">+            onFunctionCall: function translateAlarm(storArgs) {</span>
<a href="#l8.991"></a><span id="l8.991" class="difflineplus">+                try {</span>
<a href="#l8.992"></a><span id="l8.992" class="difflineplus">+                    let [aOffset, aRelated, aAlarmTime, aTzId] =</span>
<a href="#l8.993"></a><span id="l8.993" class="difflineplus">+                        [0,1,2,3].map(function(i) storArgs.getUTF8String(i));</span>
<a href="#l8.994"></a><span id="l8.994" class="difflineplus">+</span>
<a href="#l8.995"></a><span id="l8.995" class="difflineplus">+                    let alarm = cal.createAlarm();</span>
<a href="#l8.996"></a><span id="l8.996" class="difflineplus">+                    if (aOffset) {</span>
<a href="#l8.997"></a><span id="l8.997" class="difflineplus">+                        alarm.related = parseInt(aRelated, 10) + 1;</span>
<a href="#l8.998"></a><span id="l8.998" class="difflineplus">+                        alarm.offset = cal.createDuration();</span>
<a href="#l8.999"></a><span id="l8.999" class="difflineplus">+                        alarm.offset.inSeconds = aOffset;</span>
<a href="#l8.1000"></a><span id="l8.1000" class="difflineplus">+                    } else if (aAlarmTime) {</span>
<a href="#l8.1001"></a><span id="l8.1001" class="difflineplus">+                        alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l8.1002"></a><span id="l8.1002" class="difflineplus">+                        let alarmDate = cal.createDateTime();</span>
<a href="#l8.1003"></a><span id="l8.1003" class="difflineplus">+                        alarmDate.nativeTime = aAlarmTime;</span>
<a href="#l8.1004"></a><span id="l8.1004" class="difflineplus">+                        if (aTzId == &quot;floating&quot;) {</span>
<a href="#l8.1005"></a><span id="l8.1005" class="difflineplus">+                            // The current calDateTime code assumes that if a</span>
<a href="#l8.1006"></a><span id="l8.1006" class="difflineplus">+                            // date is floating then we can just assign the new</span>
<a href="#l8.1007"></a><span id="l8.1007" class="difflineplus">+                            // timezone. I have the feeling this is wrong so I</span>
<a href="#l8.1008"></a><span id="l8.1008" class="difflineplus">+                            // filed bug 520463. Since we want to release 1.0b1</span>
<a href="#l8.1009"></a><span id="l8.1009" class="difflineplus">+                            // soon, I will just fix this on the &quot;client side&quot;</span>
<a href="#l8.1010"></a><span id="l8.1010" class="difflineplus">+                            // and do the conversion here.</span>
<a href="#l8.1011"></a><span id="l8.1011" class="difflineplus">+                            alarmDate.timezone = cal.getTimezoneService().defaultTimezone;</span>
<a href="#l8.1012"></a><span id="l8.1012" class="difflineplus">+                            alarmDate = alarmDate.getInTimezone(cal.UTC());</span>
<a href="#l8.1013"></a><span id="l8.1013" class="difflineplus">+                        } else {</span>
<a href="#l8.1014"></a><span id="l8.1014" class="difflineplus">+                            alarmDate.timezone = cal.getTimezoneService().getTimezone(aTzId);</span>
<a href="#l8.1015"></a><span id="l8.1015" class="difflineplus">+                        }</span>
<a href="#l8.1016"></a><span id="l8.1016" class="difflineplus">+                        alarm.alarmDate = alarmDate;</span>
<a href="#l8.1017"></a><span id="l8.1017" class="difflineplus">+                    }</span>
<a href="#l8.1018"></a><span id="l8.1018" class="difflineplus">+                    return alarm.icalString;</span>
<a href="#l8.1019"></a><span id="l8.1019" class="difflineplus">+                } catch (e) {</span>
<a href="#l8.1020"></a><span id="l8.1020" class="difflineplus">+                    // Errors in this function are not really logged. Do this</span>
<a href="#l8.1021"></a><span id="l8.1021" class="difflineplus">+                    // separately.</span>
<a href="#l8.1022"></a><span id="l8.1022" class="difflineplus">+                    cal.ERROR(&quot;Error converting alarms: &quot; + e);</span>
<a href="#l8.1023"></a><span id="l8.1023" class="difflineplus">+                    throw e;</span>
<a href="#l8.1024"></a><span id="l8.1024" class="difflineplus">+                }</span>
<a href="#l8.1025"></a><span id="l8.1025" class="difflineplus">+            }</span>
<a href="#l8.1026"></a><span id="l8.1026" class="difflineplus">+        });</span>
<a href="#l8.1027"></a><span id="l8.1027" class="difflineplus">+</span>
<a href="#l8.1028"></a><span id="l8.1028" class="difflineplus">+        addTable(tbl, &quot;cal_alarms&quot;, {</span>
<a href="#l8.1029"></a><span id="l8.1029" class="difflineplus">+            cal_id: &quot;INTEGER&quot;,</span>
<a href="#l8.1030"></a><span id="l8.1030" class="difflineplus">+            item_id: &quot;TEXT&quot;,</span>
<a href="#l8.1031"></a><span id="l8.1031" class="difflineplus">+            icalString: &quot;TEXT&quot;</span>
<a href="#l8.1032"></a><span id="l8.1032" class="difflineplus">+        }, db);</span>
<a href="#l8.1033"></a><span id="l8.1033" class="difflineplus">+</span>
<a href="#l8.1034"></a><span id="l8.1034" class="difflineplus">+        let copyDataOver = function copyDataOver(tbl) {</span>
<a href="#l8.1035"></a><span id="l8.1035" class="difflineplus">+            const transAlarm =  &quot;translateAlarm(alarm_offset, &quot; +</span>
<a href="#l8.1036"></a><span id="l8.1036" class="difflineplus">+                                               &quot;alarm_related, &quot; +</span>
<a href="#l8.1037"></a><span id="l8.1037" class="difflineplus">+                                               &quot;alarm_time, &quot; +</span>
<a href="#l8.1038"></a><span id="l8.1038" class="difflineplus">+                                               &quot;alarm_time_tz)&quot;;</span>
<a href="#l8.1039"></a><span id="l8.1039" class="difflineplus">+            executeSimpleSQL(db, &quot;INSERT INTO cal_alarms&quot; +</span>
<a href="#l8.1040"></a><span id="l8.1040" class="difflineplus">+                &quot;(cal_id, item_id, icalString) SELECT &quot; +</span>
<a href="#l8.1041"></a><span id="l8.1041" class="difflineplus">+                &quot;cal_id, id, &quot; + transAlarm + &quot; FROM &quot; + tbl +</span>
<a href="#l8.1042"></a><span id="l8.1042" class="difflineplus">+                &quot; WHERE alarm_offset IS NOT NULL OR alarm_time IS NOT NULL;&quot;);</span>
<a href="#l8.1043"></a><span id="l8.1043" class="difflineplus">+</span>
<a href="#l8.1044"></a><span id="l8.1044" class="difflineplus">+        };</span>
<a href="#l8.1045"></a><span id="l8.1045" class="difflineplus">+        copyDataOver(&quot;cal_events&quot;);</span>
<a href="#l8.1046"></a><span id="l8.1046" class="difflineplus">+        copyDataOver(&quot;cal_todos&quot;);</span>
<a href="#l8.1047"></a><span id="l8.1047" class="difflineplus">+        removeFunction(db, &quot;translateAlarm&quot;);</span>
<a href="#l8.1048"></a><span id="l8.1048" class="difflineplus">+</span>
<a href="#l8.1049"></a><span id="l8.1049" class="difflineplus">+        // Make sure the alarm flag is set on the item</span>
<a href="#l8.1050"></a><span id="l8.1050" class="difflineplus">+        executeSimpleSQL(db, &quot;UPDATE cal_events &quot; +</span>
<a href="#l8.1051"></a><span id="l8.1051" class="difflineplus">+                             &quot;   SET flags = flags | &quot; + CAL_ITEM_FLAG.HAS_ALARMS +</span>
<a href="#l8.1052"></a><span id="l8.1052" class="difflineplus">+                             &quot; WHERE id IN&quot; +</span>
<a href="#l8.1053"></a><span id="l8.1053" class="difflineplus">+                             &quot;  (SELECT item_id &quot; +</span>
<a href="#l8.1054"></a><span id="l8.1054" class="difflineplus">+                             &quot;     FROM cal_alarms &quot; +</span>
<a href="#l8.1055"></a><span id="l8.1055" class="difflineplus">+                             &quot;    WHERE cal_alarms.cal_id = cal_events.cal_id)&quot;);</span>
<a href="#l8.1056"></a><span id="l8.1056" class="difflineplus">+        executeSimpleSQL(db, &quot;UPDATE cal_todos &quot; +</span>
<a href="#l8.1057"></a><span id="l8.1057" class="difflineplus">+                             &quot;   SET flags = flags | &quot; + CAL_ITEM_FLAG.HAS_ALARMS +</span>
<a href="#l8.1058"></a><span id="l8.1058" class="difflineplus">+                             &quot; WHERE id IN&quot; +</span>
<a href="#l8.1059"></a><span id="l8.1059" class="difflineplus">+                             &quot;  (SELECT item_id &quot; +</span>
<a href="#l8.1060"></a><span id="l8.1060" class="difflineplus">+                             &quot;     FROM cal_alarms &quot; +</span>
<a href="#l8.1061"></a><span id="l8.1061" class="difflineplus">+                             &quot;     WHERE cal_alarms.cal_id = cal_todos.cal_id)&quot;);</span>
<a href="#l8.1062"></a><span id="l8.1062" class="difflineplus">+</span>
<a href="#l8.1063"></a><span id="l8.1063" class="difflineplus">+        // Remote obsolete columns</span>
<a href="#l8.1064"></a><span id="l8.1064" class="difflineplus">+        let cols = [&quot;alarm_time&quot;,</span>
<a href="#l8.1065"></a><span id="l8.1065" class="difflineplus">+                    &quot;alarm_time_tz&quot;,</span>
<a href="#l8.1066"></a><span id="l8.1066" class="difflineplus">+                    &quot;alarm_offset&quot;,</span>
<a href="#l8.1067"></a><span id="l8.1067" class="difflineplus">+                    &quot;alarm_related&quot;];</span>
<a href="#l8.1068"></a><span id="l8.1068" class="difflineplus">+        for each (let tblid in [&quot;events&quot;, &quot;todos&quot;]) {</span>
<a href="#l8.1069"></a><span id="l8.1069" class="difflineplus">+            deleteColumns(tbl, &quot;cal_&quot; + tblid, cols, db);</span>
<a href="#l8.1070"></a><span id="l8.1070" class="difflineplus">+        }</span>
<a href="#l8.1071"></a><span id="l8.1071" class="difflineplus">+</span>
<a href="#l8.1072"></a><span id="l8.1072" class="difflineplus">+        setDbVersionAndCommit(db, 16);</span>
<a href="#l8.1073"></a><span id="l8.1073" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.1074"></a><span id="l8.1074" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l8.1075"></a><span id="l8.1075" class="difflineplus">+    }</span>
<a href="#l8.1076"></a><span id="l8.1076" class="difflineplus">+</span>
<a href="#l8.1077"></a><span id="l8.1077" class="difflineplus">+    return tbl;</span>
<a href="#l8.1078"></a><span id="l8.1078" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/calendar/providers/storage/makejsschema.pl</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,27 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-#!/usr/bin/perl</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">-print &quot;var sqlTables = {\n&quot;;</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-$in_item = 0;</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-while (&lt;&gt;) {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  chop;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-  if (/--(.*)/) {</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-    print &quot;    /* $1 */\n&quot;;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-  }</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-  s/--.*$//;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-  if (/^\s*CREATE TABLE (\S+)/) {</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-    print &quot;  $1:\n&quot;;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-    $in_item = 1;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-  } elsif(/^\);/) {</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-    print &quot;    \&quot;\&quot;,\n\n&quot;;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-    $in_item = 0;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-  } else {</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-    if ($in_item) {</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-      next if /^\s*$/;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-      print &quot;    \&quot;$_\&quot; +\n&quot;;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-    }</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-  }</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-}</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-print &quot;};\n&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/calendar/providers/storage/schema-2.sql</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,97 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">-CREATE TABLE cal_calendar_schema_version (</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">-	version	INTEGER</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-);</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-CREATE TABLE cal_items (</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-	cal_id		INTEGER, --	REFERENCES cal_calendars.id,</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-	-- 0: event, 1: todo</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-	item_type	INTEGER,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-	-- ItemBase bits</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-	id		STRING,</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-	time_created	INTEGER,</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-	last_modified	INTEGER,</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-	title		STRING,</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-	priority	INTEGER,</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-	privacy		STRING,</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-	ical_status	STRING,</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-	-- CAL_ITEM_FLAG_PRIVATE = 1</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-	-- CAL_ITEM_FLAG_HAS_ATTENDEES = 2</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-	-- CAL_ITEM_FLAG_HAS_PROPERTIES = 4</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-	-- CAL_ITEM_FLAG_EVENT_ALLDAY = 8</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-	-- CAL_ITEM_FLAG_HAS_RECURRENCE = 16</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-	flags		INTEGER,</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-	-- Event bits</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-	event_start	INTEGER,</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-	event_end	INTEGER,</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-	event_stamp	INTEGER,</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-	-- Todo bits</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-	todo_entry	INTEGER,</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-	todo_due	INTEGER,</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-	todo_completed	INTEGER,</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-	todo_complete	INTEGER,</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-	-- internal bits</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-	alarm_id	INTEGER  -- REFERENCES cal_alarms.id ON DELETE CASCADE</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-);</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-CREATE TABLE cal_attendees (</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-	item_id         STRING,</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-	attendee_id	STRING,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-	common_name	STRING,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-	rsvp		INTEGER,</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-	role		STRING,</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-	status		STRING,</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-	type		STRING</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-);</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-CREATE TABLE cal_alarms (</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-	id		INTEGER PRIMARY KEY,</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-	alarm_data	BLOB</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-CREATE TABLE cal_recurrence (</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-	item_id		STRING,</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-	recur_index	INTEGER, -- the index in the recurrence array of this thing</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-	recur_type	STRING, -- values from calIRecurrenceInfo; if null, date-based.</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-	is_negative	BOOLEAN,</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-	--</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-	-- these are for date-based recurrence</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-	--</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-	-- comma-separated list of dates</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-	dates		STRING,</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-	--</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-	-- these are for rule-based recurrence</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-	--</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-	count		INTEGER,</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-	end_date	INTEGER,</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-	interval	INTEGER,</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-	-- components, comma-separated list or null</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-	second		STRING,</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-	minute		STRING,</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-	hour		STRING,</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-	day		STRING,</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-	monthday	STRING,</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-	yearday		STRING,</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-	weekno		STRING,</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-	month		STRING,</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-	setpos		STRING</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-);</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-CREATE TABLE cal_properties (</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-	item_id		STRING,</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-	</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-	key		STRING,</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-	value		BLOB</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/calendar/providers/storage/schema-3.sql</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,123 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-CREATE TABLE cal_calendar_schema_version (</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-	version	INTEGER</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">-);</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-CREATE TABLE cal_events (</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-	cal_id		INTEGER, --	REFERENCES cal_calendars.id,</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-	-- ItemBase bits</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-	id		STRING,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-	time_created	INTEGER,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-	last_modified	INTEGER,</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-	title		STRING,</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-	priority	INTEGER,</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-	privacy		STRING,</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-	ical_status	STRING,</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-	-- CAL_ITEM_FLAG_PRIVATE = 1</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-	-- CAL_ITEM_FLAG_HAS_ATTENDEES = 2</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-	-- CAL_ITEM_FLAG_HAS_PROPERTIES = 4</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-	-- CAL_ITEM_FLAG_EVENT_ALLDAY = 8</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-	-- CAL_ITEM_FLAG_HAS_RECURRENCE = 16</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-	flags		INTEGER,</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-	-- Event bits</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-	event_start	INTEGER,</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-	event_start_tz	VARCHAR,</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-	event_end	INTEGER,</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-	event_end_tz	VARCHAR,</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-	event_stamp	INTEGER,</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-	-- alarm time</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-	alarm_time	INTEGER,</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-	alarm_time_tz	VARCHAR</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-CREATE TABLE cal_todos (</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-	cal_id		INTEGER, --	REFERENCES cal_calendars.id,</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-	-- ItemBase bits</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-	id		STRING,</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-	time_created	INTEGER,</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-	last_modified	INTEGER,</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-	title		STRING,</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-	priority	INTEGER,</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-	privacy		STRING,</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-	ical_status	STRING,</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-	-- CAL_ITEM_FLAG_PRIVATE = 1</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-	-- CAL_ITEM_FLAG_HAS_ATTENDEES = 2</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-	-- CAL_ITEM_FLAG_HAS_PROPERTIES = 4</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-	-- CAL_ITEM_FLAG_EVENT_ALLDAY = 8</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-	-- CAL_ITEM_FLAG_HAS_RECURRENCE = 16</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-	flags		INTEGER,</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-	-- Todo bits</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-	-- date the todo is to be displayed</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-	todo_entry	INTEGER,</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-	todo_entry_tz	VARCHAR,</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-	-- date the todo is due</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-	todo_due	INTEGER,</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-	todo_due_tz	VARCHAR,</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-	-- date the todo is completed</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-	todo_completed	INTEGER,</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-	todo_completed_tz VARCHAR,</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-	-- percent the todo is complete (0-100)</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-	todo_complete	INTEGER,</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-	-- alarm time</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-	alarm_time	INTEGER,</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-	alarm_time_tz	VARCHAR</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-);</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-CREATE TABLE cal_attendees (</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-	item_id         STRING,</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-	attendee_id	STRING,</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-	common_name	STRING,</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-	rsvp		INTEGER,</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-	role		STRING,</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-	status		STRING,</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-	type		STRING</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-);</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-CREATE TABLE cal_recurrence (</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-	item_id		STRING,</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-	recur_index	INTEGER, -- the index in the recurrence array of this thing</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-	recur_type	STRING, -- values from calIRecurrenceInfo; if null, date-based.</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-	is_negative	BOOLEAN,</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-	--</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-	-- these are for date-based recurrence</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-	--</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-	-- comma-separated list of dates</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-	dates		STRING,</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-	--</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-	-- these are for rule-based recurrence</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-	--</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-	count		INTEGER,</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-	end_date	INTEGER,</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-	interval	INTEGER,</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-	-- components, comma-separated list or null</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-	second		STRING,</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-	minute		STRING,</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-	hour		STRING,</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-	day		STRING,</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-	monthday	STRING,</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-	yearday		STRING,</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-	weekno		STRING,</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-	month		STRING,</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-	setpos		STRING</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-);</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-CREATE TABLE cal_properties (</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-	item_id		STRING,</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-	</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-	key		STRING,</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-	value		BLOB</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100755</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/calendar/providers/storage/schema-4.sql</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,100 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-CREATE TABLE cal_calendar_schema_version (</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">-    version INTEGER</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">-);</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">-</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-CREATE TABLE cal_calendars (</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-    id INTEGER PRIMARY KEY,</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-    type STRING,</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    uri STRING</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-CREATE TABLE cal_calendars_prefs (</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-    id INTEGER PRIMARY KEY,</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-    calendar INTEGER,</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-    name STRING,</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-    value STRING</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-);</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-CREATE TABLE cal_events (</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-    cal_id INTEGER,</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-    id STRING,</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-    time_created INTEGER,</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-    last_modified INTEGER,</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-    title STRING,</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-    priority INTEGER,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-    privacy STRING,</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-    ical_status STRING,</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-    recurrence_id_tz VARCHAR,</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-    flags INTEGER,</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-    event_start INTEGER,</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-    event_start_tz VARCHAR,</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-    event_end INTEGER,</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-    event_end_tz VARCHAR,</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-    event_stamp INTEGER,</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-    alarm_time INTEGER,</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-    alarm_time_tz VARCHAR</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-);</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-CREATE TABLE cal_todos (</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-    cal_id INTEGER,</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-    id STRING,</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-    time_created INTEGER,</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-    last_modified INTEGER,</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-    title STRING,</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-    priority INTEGER,</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-    privacy STRING,</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-    ical_status STRING,</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-    recurrence_id_tz VARCHAR,</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-    flags INTEGER,</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-    todo_entry INTEGER,</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-    todo_entry_tz VARCHAR,</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-    todo_due INTEGER,</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-    todo_due_tz VARCHAR,</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-    todo_completed INTEGER,</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-    todo_completed_tz VARCHAR,</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-    todo_complete INTEGER,</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-    alarm_time INTEGER,</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-    alarm_time_tz VARCHAR</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-CREATE TABLE cal_attendees (</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-    item_id STRING,</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-    recurrence_id_tz VARCHAR,</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-    attendee_id STRING,</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-    common_name STRING,</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-    rsvp INTEGER,</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-    role STRING,</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-    status STRING,</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-    type STRING</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-);</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-CREATE TABLE cal_recurrence (</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-    item_id STRING,</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-    recur_index INTEGER,</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-    recur_type STRING,</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-    is_negative BOOLEAN,</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-    dates STRING,</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-    count INTEGER,</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-    end_date INTEGER,</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-    interval INTEGER,</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-    second STRING,</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-    minute STRING,</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-    hour STRING,</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-    day STRING,</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-    monthday STRING,</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-    yearday STRING,</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-    weekno STRING,</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-    month STRING,</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineminus">-    setpos STRING</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-);</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-CREATE TABLE cal_properties (</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-    item_id STRING,</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-    recurrence_id_tz VARCHAR,</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-    key STRING,</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-    value BLOB</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100755</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/calendar/providers/storage/schema-5.sql</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,106 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-CREATE TABLE cal_calendar_schema_version (</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">-    version INTEGER</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">-);</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-CREATE TABLE cal_calendars (</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-    id INTEGER PRIMARY KEY,</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-    type STRING,</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    uri STRING</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-CREATE TABLE cal_calendars_prefs (</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-    id INTEGER PRIMARY KEY,</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-    calendar INTEGER,</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-    name STRING,</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-    value STRING</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-);</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-CREATE TABLE cal_events (</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-    cal_id INTEGER,</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-    id STRING,</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-    time_created INTEGER,</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-    last_modified INTEGER,</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-    title STRING,</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-    priority INTEGER,</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-    privacy STRING,</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-    ical_status STRING,</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-    recurrence_id_tz VARCHAR,</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-    flags INTEGER,</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-    event_start INTEGER,</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-    event_start_tz VARCHAR,</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-    event_end INTEGER,</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-    event_end_tz VARCHAR,</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-    event_stamp INTEGER,</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-    alarm_time INTEGER,</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-    alarm_time_tz VARCHAR,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-    alarm_offset INTEGER,</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-    alarm_related INTEGER,</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-    alarm_last_ack INTEGER</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-CREATE TABLE cal_todos (</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-    cal_id INTEGER,</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-    id STRING,</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-    time_created INTEGER,</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-    last_modified INTEGER,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-    title STRING,</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-    priority INTEGER,</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-    privacy STRING,</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-    ical_status STRING,</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-    recurrence_id_tz VARCHAR,</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-    flags INTEGER,</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-    todo_entry INTEGER,</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-    todo_entry_tz VARCHAR,</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-    todo_due INTEGER,</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-    todo_due_tz VARCHAR,</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-    todo_completed INTEGER,</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-    todo_completed_tz VARCHAR,</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-    todo_complete INTEGER,</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-    alarm_time INTEGER,</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-    alarm_time_tz VARCHAR,</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-    alarm_offset INTEGER,</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-    alarm_related INTEGER,</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-    alarm_last_ack INTEGER</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-);</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-CREATE TABLE cal_attendees (</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-    item_id STRING,</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-    recurrence_id_tz VARCHAR,</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-    attendee_id STRING,</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-    common_name STRING,</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-    rsvp INTEGER,</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-    role STRING,</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-    status STRING,</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-    type STRING</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-);</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-CREATE TABLE cal_recurrence (</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-    item_id STRING,</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-    recur_index INTEGER,</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-    recur_type STRING,</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-    is_negative BOOLEAN,</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-    dates STRING,</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-    count INTEGER,</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-    end_date INTEGER,</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-    interval INTEGER,</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-    second STRING,</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-    minute STRING,</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineminus">-    hour STRING,</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-    day STRING,</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-    monthday STRING,</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-    yearday STRING,</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-    weekno STRING,</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-    month STRING,</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-    setpos STRING</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-);</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-CREATE TABLE cal_properties (</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-    item_id STRING,</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-    recurrence_id_tz VARCHAR,</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-    key STRING,</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineminus">-    value BLOB</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100755</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/calendar/providers/storage/schema-6.sql</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,106 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-CREATE TABLE cal_calendar_schema_version (</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">-    version INTEGER</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">-);</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">-</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-CREATE TABLE cal_calendars (</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-    id INTEGER PRIMARY KEY,</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-    type TEXT,</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    uri TEXT</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-CREATE TABLE cal_calendars_prefs (</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-    id INTEGER PRIMARY KEY,</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-    calendar INTEGER,</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-    name TEXT,</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-    value TEXT</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-);</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-CREATE TABLE cal_events (</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-    cal_id INTEGER,</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-    id TEXT,</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-    time_created INTEGER,</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-    last_modified INTEGER,</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-    title TEXT,</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-    priority INTEGER,</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-    privacy TEXT,</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-    ical_status TEXT,</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-    recurrence_id_tz TEXT,</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-    flags INTEGER,</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-    event_start INTEGER,</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-    event_start_tz TEXT,</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-    event_end INTEGER,</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-    event_end_tz TEXT,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-    event_stamp INTEGER,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-    alarm_time INTEGER,</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-    alarm_time_tz TEXT,</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-    alarm_offset INTEGER,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-    alarm_related INTEGER,</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-    alarm_last_ack INTEGER</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-CREATE TABLE cal_todos (</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-    cal_id INTEGER,</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-    id TEXT,</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-    time_created INTEGER,</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-    last_modified INTEGER,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-    title TEXT,</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-    priority INTEGER,</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-    privacy TEXT,</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-    ical_status TEXT,</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-    recurrence_id_tz TEXT,</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-    flags INTEGER,</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-    todo_entry INTEGER,</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-    todo_entry_tz TEXT,</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-    todo_due INTEGER,</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-    todo_due_tz TEXT,</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-    todo_completed INTEGER,</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-    todo_completed_tz TEXT,</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-    todo_complete INTEGER,</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-    alarm_time INTEGER,</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-    alarm_time_tz TEXT,</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-    alarm_offset INTEGER,</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-    alarm_related INTEGER,</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-    alarm_last_ack INTEGER</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-);</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-CREATE TABLE cal_attendees (</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-    item_id TEXT,</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-    recurrence_id_tz TEXT,</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-    attendee_id TEXT,</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-    common_name TEXT,</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-    rsvp INTEGER,</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-    role TEXT,</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-    status TEXT,</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-    type TEXT</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-);</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-CREATE TABLE cal_recurrence (</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineminus">-    item_id TEXT,</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-    recur_index INTEGER,</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-    recur_type TEXT,</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-    is_negative BOOLEAN,</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-    dates TEXT,</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-    count INTEGER,</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-    end_date INTEGER,</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-    interval INTEGER,</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-    second TEXT,</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-    minute TEXT,</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-    hour TEXT,</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-    day TEXT,</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-    monthday TEXT,</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-    yearday TEXT,</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-    weekno TEXT,</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-    month TEXT,</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-    setpos TEXT</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-CREATE TABLE cal_properties (</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-    item_id TEXT,</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineminus">-    recurrence_id_tz TEXT,</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-    key TEXT,</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-    value BLOB</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">deleted file mode 100755</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- a/calendar/providers/storage/schema-7.sql</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ /dev/null</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -1,166 +0,0 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineminus">-CREATE TABLE cal_calendar_schema_version (</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">-    version INTEGER</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">-);</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">-</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-CREATE TABLE cal_calendars (</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-    id INTEGER PRIMARY KEY,</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">-    type TEXT,</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    uri TEXT</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-CREATE TABLE cal_calendars_prefs (</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-    --</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-    -- defines arbitrary preferences for a calendar</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-    -- e.g. name, color, visibility status</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-    --</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-    id INTEGER PRIMARY KEY,</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-    calendar INTEGER, -- REFERENCES cal_calendars.id</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-    name TEXT,</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-    value TEXT</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-);</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-CREATE TABLE cal_events (</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-    --</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-    -- defines an Event calendar component</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-    --</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-    cal_id INTEGER, -- REFERENCES cal_calendars.id</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-    -- ItemBase bits</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-    id TEXT,</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-    time_created INTEGER,</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-    last_modified INTEGER,</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-    title TEXT,</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-    priority INTEGER,</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-    privacy TEXT,</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-    ical_status TEXT,</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-    recurrence_id_tz TEXT,</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-    -- CAL_ITEM_FLAG_PRIVATE = 1</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-    -- CAL_ITEM_FLAG_HAS_ATTENDEES = 2</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-    -- CAL_ITEM_FLAG_HAS_PROPERTIES = 4</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-    -- CAL_ITEM_FLAG_EVENT_ALLDAY = 8</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-    -- CAL_ITEM_FLAG_HAS_RECURRENCE = 16</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-    -- CAL_ITEM_FLAG_HAS_EXCEPTIONS = 32</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-    flags INTEGER,</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-    -- Event bits</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-    event_start INTEGER,</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-    event_start_tz TEXT,</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-    event_end INTEGER,</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-    event_end_tz TEXT,</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-    event_stamp INTEGER,</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-    -- Alarm bits</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-    alarm_time INTEGER,</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-    alarm_time_tz TEXT,</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-    alarm_offset INTEGER,</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-    alarm_related INTEGER,</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-    alarm_last_ack INTEGER</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-);</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-CREATE TABLE cal_todos (</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-    --</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-    -- defines a Todo/Task calendar component</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-    --</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-    cal_id INTEGER, -- REFERENCES cal_calendars.id</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-    -- ItemBase bits</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-    id TEXT,</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-    time_created INTEGER,</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-    last_modified INTEGER,</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-    title TEXT,</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-    priority INTEGER,</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-    privacy TEXT,</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-    ical_status TEXT,</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-    recurrence_id_tz TEXT,</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-    -- CAL_ITEM_FLAG_PRIVATE = 1</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-    -- CAL_ITEM_FLAG_HAS_ATTENDEES = 2</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-    -- CAL_ITEM_FLAG_HAS_PROPERTIES = 4</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-    -- CAL_ITEM_FLAG_EVENT_ALLDAY = 8</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-    -- CAL_ITEM_FLAG_HAS_RECURRENCE = 16</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-    -- CAL_ITEM_FLAG_HAS_EXCEPTIONS = 32</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-    flags INTEGER,</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-    -- Todo bits</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineminus">-    todo_entry INTEGER, -- date the todo is to be displayed</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-    todo_entry_tz TEXT,</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-    todo_due INTEGER, -- date the todo is due</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-    todo_due_tz TEXT,</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-    todo_completed INTEGER, -- date the todo is completed</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-    todo_completed_tz TEXT,</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-    todo_complete INTEGER, -- percent the todo is complete (0-100)</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-    -- Alarm bits</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-    alarm_time INTEGER,</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-    alarm_time_tz TEXT,</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-    alarm_offset INTEGER,</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-    alarm_related INTEGER,</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-    alarm_last_ack INTEGER</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-);</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-CREATE TABLE cal_attendees (</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-    --</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-    -- defines an &quot;Attendee&quot; within a calendar component</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-    --</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-    item_id TEXT, -- REFERENCES cal_events.id respectively cal_todos.id</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-    recurrence_id_tz TEXT,</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-    attendee_id TEXT, -- ID, e.g. &quot;mailto:jsmith@host.com&quot;</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-    common_name TEXT, -- CN, e.g. &quot;John Smith&quot; or &quot;jsmith@host.com&quot;</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-    rsvp INTEGER, -- RSVP expectation</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-    role TEXT, -- participation role, e.g. &quot;REQ-PARTICIPANT&quot;</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-    status TEXT, -- participation status</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-    type TEXT</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-);</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-CREATE TABLE cal_recurrence (</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-    --</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-    -- defines an &quot;Recurrence Rule&quot; within a calendar component</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-    --</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-    item_id TEXT, -- REFERENCES cal_events.id respectively cal_todos.id</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-    recur_index INTEGER, -- the index in the recurrence array of this thing</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-    recur_type TEXT, -- values from calIRecurrenceInfo; if null, date-based</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineminus">-</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-    is_negative BOOLEAN,</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-    --</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-    -- these are for date-based recurrence</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-    --</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-    dates TEXT, -- comma-separated list of dates</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-    --</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-    -- these are for rule-based recurrence</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-    --</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-    count INTEGER,</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-    end_date INTEGER,</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-    interval INTEGER,</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-    -- components, comma-separated list or null</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-    second TEXT,</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-    minute TEXT,</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-    hour TEXT,</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-    day TEXT,</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-    monthday TEXT,</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineminus">-    yearday TEXT,</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineminus">-    weekno TEXT,</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-    month TEXT,</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-    setpos TEXT</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-);</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineminus">-</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineminus">-CREATE TABLE cal_properties (</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineminus">-    --</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineminus">-    -- defines arbitrary property within a calendar component</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineminus">-    -- e.g. DESCRIPTION, LOCATION, URL,</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineminus">-    --</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-    item_id TEXT, -- REFERENCES cal_events.id respectively cal_todos.id</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-    recurrence_id INTEGER,</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-    recurrence_id_tz TEXT,</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineminus">-    key TEXT,</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-    value BLOB</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

