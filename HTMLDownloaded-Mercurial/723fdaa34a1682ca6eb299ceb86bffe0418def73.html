<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 16074:723fdaa34a1682ca6eb299ceb86bffe0418def73</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 723fdaa34a1682ca6eb299ceb86bffe0418def73" />
<meta property="og:url" content="/comm-central/rev/723fdaa34a1682ca6eb299ceb86bffe0418def73" />
<meta property="og:description" content="Bug 991220 - Remove Ubuntu One Support From Thunderbird. r=mkmelin,r=mconley,a=Standard8 CLOSED TREE" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 723fdaa34a1682ca6eb299ceb86bffe0418def73 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/723fdaa34a1682ca6eb299ceb86bffe0418def73">shortlog</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/723fdaa34a1682ca6eb299ceb86bffe0418def73">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/723fdaa34a1682ca6eb299ceb86bffe0418def73">files</a> |
changeset |
<a href="/comm-central/raw-rev/723fdaa34a1682ca6eb299ceb86bffe0418def73">raw</a>  | <a href="/comm-central/archive/723fdaa34a1682ca6eb299ceb86bffe0418def73.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=991220">Bug 991220</a> - Remove Ubuntu One Support From Thunderbird. r=mkmelin,r=mconley,a=Standard8 CLOSED TREE
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#117;&#121;&#97;&#115;&#104;&#32;&#65;&#103;&#97;&#114;&#119;&#97;&#108;&#32;&#60;&#115;&#121;&#115;&#104;&#97;&#103;&#97;&#114;&#119;&#97;&#108;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 24 Apr 2014 11:30:48 +0100</td></tr>

<tr>
 <td>changeset 16074</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/723fdaa34a1682ca6eb299ceb86bffe0418def73">723fdaa34a1682ca6eb299ceb86bffe0418def73</a></td>
</tr>



<tr>
<td>parent 16073</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fd35deed885de2a526ce4f4438f5a770f38b192a">fd35deed885de2a526ce4f4438f5a770f38b192a</a>
</td>
</tr>

<tr>
<td>child 16075</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ac5495ab2fdce046e539282ea3d8eebff801e986">ac5495ab2fdce046e539282ea3d8eebff801e986</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=723fdaa34a1682ca6eb299ceb86bffe0418def73">10062</a></td></tr>
<tr><td>push user</td><td>mbanner@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 24 Apr 2014 10:31:55 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@723fdaa34a16 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=723fdaa34a1682ca6eb299ceb86bffe0418def73">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=723fdaa34a1682ca6eb299ceb86bffe0418def73&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=723fdaa34a1682ca6eb299ceb86bffe0418def73&newProject=comm-central&newRevision=fd35deed885de2a526ce4f4438f5a770f38b192a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=723fdaa34a1682ca6eb299ceb86bffe0418def73&newProject=comm-central&newRevision=fd35deed885de2a526ce4f4438f5a770f38b192a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=723fdaa34a1682ca6eb299ceb86bffe0418def73&newProject=comm-central&newRevision=fd35deed885de2a526ce4f4438f5a770f38b192a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a>, <a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a>, <a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=991220">991220</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=991220">Bug 991220</a> - Remove Ubuntu One Support From Thunderbird. r=mkmelin,r=mconley,a=Standard8 CLOSED TREE</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/cloudFileComponents.manifest">mail/components/cloudfile/cloudFileComponents.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/cloudFileComponents.manifest">file</a> |
<a href="/comm-central/annotate/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/cloudFileComponents.manifest">annotate</a> |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/cloudFileComponents.manifest">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/cloudFileComponents.manifest">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/cloudFileComponents.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/management.js">mail/components/cloudfile/content/UbuntuOne/management.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/management.js">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/management.js">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/management.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/management.xhtml">mail/components/cloudfile/content/UbuntuOne/management.xhtml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/management.xhtml">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/management.xhtml">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/management.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/settings.js">mail/components/cloudfile/content/UbuntuOne/settings.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/settings.js">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/settings.js">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/settings.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/settings.xhtml">mail/components/cloudfile/content/UbuntuOne/settings.xhtml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/settings.xhtml">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/settings.xhtml">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/content/UbuntuOne/settings.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/jar.mn">mail/components/cloudfile/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/jar.mn">file</a> |
<a href="/comm-central/annotate/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/jar.mn">annotate</a> |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/jar.mn">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/jar.mn">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/moz.build">mail/components/cloudfile/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/moz.build">file</a> |
<a href="/comm-central/annotate/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/moz.build">annotate</a> |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/moz.build">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/moz.build">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/nsUbuntuOne.js">mail/components/cloudfile/nsUbuntuOne.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/nsUbuntuOne.js">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/nsUbuntuOne.js">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/components/cloudfile/nsUbuntuOne.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/installer/package-manifest.in">mail/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/installer/package-manifest.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd">mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd">mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/jar.mn">mail/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js">mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/linux/jar.mn">mail/themes/linux/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/linux/jar.mn">file</a> |
<a href="/comm-central/annotate/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/linux/jar.mn">annotate</a> |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/linux/jar.mn">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/linux/jar.mn">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/linux/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/linux/mail/icons/ubuntuone.png">mail/themes/linux/mail/icons/ubuntuone.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/linux/mail/icons/ubuntuone.png">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/linux/mail/icons/ubuntuone.png">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/linux/mail/icons/ubuntuone.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/osx/jar.mn">mail/themes/osx/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/osx/jar.mn">file</a> |
<a href="/comm-central/annotate/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/osx/jar.mn">annotate</a> |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/osx/jar.mn">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/osx/jar.mn">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/osx/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/osx/mail/icons/ubuntuone.png">mail/themes/osx/mail/icons/ubuntuone.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/osx/mail/icons/ubuntuone.png">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/osx/mail/icons/ubuntuone.png">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/osx/mail/icons/ubuntuone.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/windows/jar.mn">mail/themes/windows/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/windows/jar.mn">file</a> |
<a href="/comm-central/annotate/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/windows/jar.mn">annotate</a> |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/windows/jar.mn">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/windows/jar.mn">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/windows/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/windows/mail/icons/ubuntuone.png">mail/themes/windows/mail/icons/ubuntuone.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/windows/mail/icons/ubuntuone.png">diff</a> |
<a href="/comm-central/comparison/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/windows/mail/icons/ubuntuone.png">comparison</a> |
<a href="/comm-central/log/723fdaa34a1682ca6eb299ceb86bffe0418def73/mail/themes/windows/mail/icons/ubuntuone.png">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/cloudfile/cloudFileComponents.manifest</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/cloudfile/cloudFileComponents.manifest</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,12 +1,8 @@</span>
<a href="#l1.4"></a><span id="l1.4"> component {dd2bce44-ca71-42ce-b806-6fa4e073919c} nsHightail.js</span>
<a href="#l1.5"></a><span id="l1.5"> contract @mozilla.org/mail/hightail;1 {dd2bce44-ca71-42ce-b806-6fa4e073919c}</span>
<a href="#l1.6"></a><span id="l1.6"> # Hightail used to be named YouSendIt, which is the constant used in the prefs.</span>
<a href="#l1.7"></a><span id="l1.7"> category cloud-files YouSendIt @mozilla.org/mail/hightail;1</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9" class="difflineminus">-component {9a44742b-a7b1-4f44-919e-6f3b28902c1a} nsUbuntuOne.js</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineminus">-contract @mozilla.org/mail/ubuntuone;1 {9a44742b-a7b1-4f44-919e-6f3b28902c1a}</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-category cloud-files UbuntuOne @mozilla.org/mail/ubuntuone;1</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-</span>
<a href="#l1.13"></a><span id="l1.13"> component {c06a8707-7463-416c-8b39-e85044a4ff6e} nsBox.js</span>
<a href="#l1.14"></a><span id="l1.14"> contract @mozilla.org/mail/box;1 {c06a8707-7463-416c-8b39-e85044a4ff6e}</span>
<a href="#l1.15"></a><span id="l1.15"> category cloud-files Box @mozilla.org/mail/box;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">deleted file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- a/mail/components/cloudfile/content/UbuntuOne/management.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ /dev/null</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -1,44 +0,0 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineminus">-</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-function onLoadProvider(provider) {</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">-  let messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">-                            .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  let fileSpaceUsed = document.getElementById(&quot;file-space-used&quot;);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-  fileSpaceUsed.textContent = messenger.formatFileSize(provider.fileSpaceUsed);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-  let fileSpaceUsedSwatch = document.getElementById(&quot;file-space-used-swatch&quot;);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-  fileSpaceUsedSwatch.style.backgroundColor = pv.Colors.category20.values[0];</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-  let remainingFileSpace = document.getElementById(&quot;remaining-file-space&quot;);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-  remainingFileSpace.textContent = messenger.formatFileSize(</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-    provider.remainingFileSpace);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-  let remainingFileSpaceSwatch = document.getElementById(&quot;remaining-file-space-swatch&quot;);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-  remainingFileSpaceSwatch.style.backgroundColor = pv.Colors.category20.values[1];</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-  let totalSpace = provider.fileSpaceUsed + provider.remainingFileSpace;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-  let pieScale = 2 * Math.PI / totalSpace;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-  let spaceDiv = document.getElementById(&quot;provider-space-visuals&quot;);</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-  let vis = new pv.Panel().canvas(spaceDiv)</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-    .width(150)</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-    .height(150);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  vis.add(pv.Wedge)</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-    .data([provider.fileSpaceUsed, provider.remainingFileSpace])</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-    .left(75)</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-    .top(75)</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-    .innerRadius(30)</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-    .outerRadius(65)</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-    .angle(function(d) d * pieScale);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  vis.add(pv.Label)</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-    .left(75)</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-    .top(75)</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    .font(&quot;14px Sans-Serif&quot;)</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    .textAlign(&quot;center&quot;)</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    .textBaseline(&quot;middle&quot;)</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-    .text(messenger.formatFileSize(totalSpace));</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-  vis.render();</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/mail/components/cloudfile/content/UbuntuOne/management.xhtml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,51 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-&lt;!DOCTYPE html [</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-  &lt;!ENTITY % htmlDTD PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;DTD/xhtml1-strict.dtd&quot;&gt; %htmlDTD;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  &lt;!ENTITY % managementDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/management.dtd&quot;&gt; %managementDTD;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  &lt;!ENTITY % u1DTD SYSTEM &quot;chrome://messenger/locale/cloudfile/UbuntuOne/management.dtd&quot;&gt; %u1DTD;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-]&gt;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xml:lang=&quot;en&quot; lang=&quot;en&quot;&gt;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-  &lt;head&gt;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    &lt;script type=&quot;application/javascript;version=1.8&quot;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-            src=&quot;chrome://messenger/content/protovis-r2.6-modded.js&quot;/&gt;</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    &lt;script type=&quot;text/javascript;version=1.8&quot;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-            src=&quot;chrome://messenger/content/cloudfile/UbuntuOne/management.js&quot;/&gt;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-        type=&quot;text/css&quot;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-        href=&quot;chrome://messenger/skin/preferences/preferences.css&quot; /&gt;</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  &lt;/head&gt;</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-  &lt;body id=&quot;provider-management&quot;&gt;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-    &lt;div id=&quot;provider-header&quot;&gt;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-      &lt;div id=&quot;provider-terms&quot;&gt;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-      &lt;a href=&quot;https://one.ubuntu.com/referrals/referee/2149434/?next=/privacy/&quot;&gt;&amp;cloudfileMgmt.privacyPolicy;&lt;/a&gt;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-      &lt;a href=&quot;https://one.ubuntu.com/referrals/referee/2149434/?next=/terms/&quot;&gt;&amp;cloudfileMgmt.termsOfService;&lt;/a&gt;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-      &lt;div id=&quot;provider-name&quot;&gt;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-      &lt;h1&gt;Ubuntu One&lt;/h1&gt;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-    &lt;/div&gt;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-    &lt;div id=&quot;provider-spacebox&quot;&gt;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-      &lt;div id=&quot;provider-space-visuals&quot;&gt;&lt;/div&gt;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-      &lt;div id=&quot;provider-space&quot;&gt;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-        &lt;div&gt;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-          &lt;label&gt;&amp;cloudfileMgmt.usedSpace;&lt;/label&gt;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-          &lt;span id=&quot;file-space-used&quot;/&gt;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-          &lt;span id=&quot;file-space-used-swatch&quot; class=&quot;space-swatch&quot;/&gt;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-        &lt;/div&gt;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-        &lt;div&gt;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-          &lt;label&gt;&amp;cloudfileMgmt.unusedSpace;&lt;/label&gt;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-          &lt;span id=&quot;remaining-file-space&quot;/&gt;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-          &lt;span id=&quot;remaining-file-space-swatch&quot; class=&quot;space-swatch&quot;/&gt;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-        &lt;/div&gt;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-        &lt;div id=&quot;upgrade&quot;&gt;&lt;a href=&quot;https://one.ubuntu.com/referrals/referee/2149434/?next=/services/add-storage/&quot;&gt;&amp;cloudfileMgmt.upgradeOffer;&lt;/a&gt;&lt;/div&gt;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-    &lt;div id=&quot;provider-account-settings&quot;&gt;&lt;a href=&quot;https://one.ubuntu.com/referrals/referee/2149434/?next=/account/&quot;&gt;&amp;ubuntuOneMgmt.viewSettings;&lt;/a&gt;&lt;/div&gt;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-  &lt;/body&gt;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">deleted file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- a/mail/components/cloudfile/content/UbuntuOne/settings.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ /dev/null</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -1,10 +0,0 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-function extraArgs() {</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-  var emailaddressValue = document.getElementById(&quot;emailaddress&quot;).value;</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-  return {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    &quot;emailaddress&quot;: {type: &quot;char&quot;, value: emailaddressValue},</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  };</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/mail/components/cloudfile/content/UbuntuOne/settings.xhtml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,30 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-&lt;!DOCTYPE html [</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-  &lt;!ENTITY % htmlDTD PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;DTD/xhtml1-strict.dtd&quot;&gt; %htmlDTD;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  &lt;!ENTITY % u1DTD SYSTEM &quot;chrome://messenger/locale/cloudfile/UbuntuOne/settings.dtd&quot;&gt; %u1DTD;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-]&gt;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xml:lang=&quot;en&quot; lang=&quot;en&quot;&gt;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-  &lt;head&gt;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-    &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-            src=&quot;chrome://messenger/content/cloudfile/UbuntuOne/settings.js&quot;/&gt;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-    &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-        type=&quot;text/css&quot;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-        href=&quot;chrome://messenger/skin/cloudfile/addAccountDialog.css&quot; /&gt;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-  &lt;/head&gt;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-  &lt;body id=&quot;provider-settings&quot;&gt;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-    &lt;form id=&quot;provider-form&quot; onsubmit=&quot;return false;&quot;&gt;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-      &lt;label for=&quot;username&quot;&gt;&amp;UbuntuOneSettings.emailAddress;&lt;/label&gt;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-      &lt;input id=&quot;emailaddress&quot; type=&quot;text&quot; required=&quot;true&quot;/&gt;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-      &lt;div id=&quot;learn-more&quot; class=&quot;float-right&quot;&gt;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-        &lt;a href=&quot;https://one.ubuntu.com/referrals/referee/2149434/?next=/&quot;&gt;&amp;UbuntuOneSettings.learnMore;&lt;/a&gt;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-      &lt;div&gt;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-        &lt;a href=&quot;https://one.ubuntu.com/referrals/referee/2149434/?next=/services/&quot;&gt;&amp;UbuntuOneSettings.needAnAccount;&lt;/a&gt;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-    &lt;/form&gt;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-  &lt;/body&gt;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/cloudfile/jar.mn</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/cloudfile/jar.mn</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -7,20 +7,16 @@ messenger.jar:</span>
<a href="#l6.4"></a><span id="l6.4">     content/messenger/cloudfile/addAccountDialog.js  (content/addAccountDialog.js)</span>
<a href="#l6.5"></a><span id="l6.5">     content/messenger/cloudfile/attachment-24.png (content/attachment-24.png)</span>
<a href="#l6.6"></a><span id="l6.6">     content/messenger/cloudfile/emptySettings.xhtml (content/emptySettings.xhtml)</span>
<a href="#l6.7"></a><span id="l6.7">     content/messenger/cloudfile/Box/settings.xhtml (content/Box/settings.xhtml)</span>
<a href="#l6.8"></a><span id="l6.8">     content/messenger/cloudfile/Box/management.xhtml (content/Box/management.xhtml)</span>
<a href="#l6.9"></a><span id="l6.9">     content/messenger/cloudfile/Box/management.js (content/Box/management.js)</span>
<a href="#l6.10"></a><span id="l6.10">     content/messenger/cloudfile/Box/auth.xul (content/Box/auth.xul)</span>
<a href="#l6.11"></a><span id="l6.11">     content/messenger/cloudfile/Box/auth.js (content/Box/auth.js)</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    content/messenger/cloudfile/UbuntuOne/management.js (content/UbuntuOne/management.js)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-    content/messenger/cloudfile/UbuntuOne/management.xhtml (content/UbuntuOne/management.xhtml)</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-    content/messenger/cloudfile/UbuntuOne/settings.js (content/UbuntuOne/settings.js)</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-    content/messenger/cloudfile/UbuntuOne/settings.xhtml (content/UbuntuOne/settings.xhtml)</span>
<a href="#l6.16"></a><span id="l6.16">     content/messenger/cloudfile/Hightail/management.xhtml (content/Hightail/management.xhtml)</span>
<a href="#l6.17"></a><span id="l6.17">     content/messenger/cloudfile/Hightail/management.js (content/Hightail/management.js)</span>
<a href="#l6.18"></a><span id="l6.18">     content/messenger/cloudfile/Hightail/settings.js (content/Hightail/settings.js)</span>
<a href="#l6.19"></a><span id="l6.19">     content/messenger/cloudfile/Hightail/settings.xhtml (content/Hightail/settings.xhtml)</span>
<a href="#l6.20"></a><span id="l6.20">     content/messenger/cloudfile/Hightail/fileExceedsLimit.xul (content/Hightail/fileExceedsLimit.xul)</span>
<a href="#l6.21"></a><span id="l6.21">     content/messenger/cloudfile/Hightail/fileExceedsLimit.js (content/Hightail/fileExceedsLimit.js)</span>
<a href="#l6.22"></a><span id="l6.22">     content/messenger/cloudfile/Hightail/fileExceedsQuota.xul (content/Hightail/fileExceedsQuota.xul)</span>
<a href="#l6.23"></a><span id="l6.23">     content/messenger/cloudfile/Hightail/fileExceedsQuota.js (content/Hightail/fileExceedsQuota.js)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/cloudfile/moz.build</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/cloudfile/moz.build</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -8,16 +8,15 @@ XPIDL_SOURCES += [</span>
<a href="#l7.4"></a><span id="l7.4"> ]</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> XPIDL_MODULE = 'cloudfile'</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> EXTRA_COMPONENTS += [</span>
<a href="#l7.9"></a><span id="l7.9">     'cloudFileComponents.manifest',</span>
<a href="#l7.10"></a><span id="l7.10">     'nsBox.js',</span>
<a href="#l7.11"></a><span id="l7.11">     'nsHightail.js',</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    'nsUbuntuOne.js',</span>
<a href="#l7.13"></a><span id="l7.13"> ]</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> EXTRA_JS_MODULES += [</span>
<a href="#l7.16"></a><span id="l7.16">     'cloudFileAccounts.js',</span>
<a href="#l7.17"></a><span id="l7.17"> ]</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> JAR_MANIFESTS += ['jar.mn']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/mail/components/cloudfile/nsUbuntuOne.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,762 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-/* This file implements the nsIMsgCloudFileProvider interface.</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">- *</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">- * This component handles the UbuntuOne implementation of the</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">- * nsIMsgCloudFileProvider interface.</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">- */</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-const Cc = Components.classes;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-const Cu = Components.utils;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-const Cr = Components.results;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-Cu.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-Cu.import(&quot;resource:///modules/oauth.jsm&quot;);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-Cu.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-const kBadAccessToken = 401;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-const kAuthSecretRealm = &quot;Ubuntu One Auth Secret&quot;;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-const kConsumerKeyRealm = &quot;Ubuntu One Consumer Key&quot;;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-const kConsumerSecretRealm = &quot;Ubuntu One Consumer Secret&quot;;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-const kAttachmentsVolume = &quot;/~/Thunderbird Attachments&quot;;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-const kVolumesPath = &quot;/volumes&quot;;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-var gServerUrl = &quot;https://one.ubuntu.com/api/file_storage/v1&quot;;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-var gContentUrl = &quot;https://files.one.ubuntu.com/content&quot;;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-var gSsoUrl = &quot;https://login.ubuntu.com/api/1.0/authentications&quot;;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-var gSsoPingUrl = &quot;https://one.ubuntu.com/oauth/sso-finished-so-get-tokens/&quot;;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-function encodePathForURI(aStr) {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  return encodeURIComponent(aStr).replace(/%2F/g, '/');</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-}</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-function nsUbuntuOne() {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-  this.log = Log4Moz.getConfiguredLogger(&quot;UbuntuOne&quot;);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-}</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-nsUbuntuOne.prototype = {</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-  /* nsISupports */</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-  QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgCloudFileProvider]),</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-  classID: Components.ID(&quot;{9a44742b-a7b1-4f44-919e-6f3b28902c1a}&quot;),</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-  get type() &quot;UbuntuOne&quot;,</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-  get displayName() &quot;Ubuntu One&quot;,</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-  get serviceURL() &quot;https://one.ubuntu.com/referrals/referee/2149434/?next=/&quot;,</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-  get iconClass() &quot;chrome://messenger/skin/icons/ubuntuone.png&quot;,</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-  get accountKey() this._accountKey,</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-  get lastError() this._lastErrorText,</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-  get settingsURL() &quot;chrome://messenger/content/cloudfile/UbuntuOne/settings.xhtml&quot;,</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-  get managementURL() &quot;chrome://messenger/content/cloudfile/UbuntuOne/management.xhtml&quot;,</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-  _accountKey: false,</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-  _prefBranch: null,</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-  _emailAddress: &quot;&quot;,</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-  _loggedIn: false,</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-  _userInfo: null,</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-  _connection: null,</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-  _uploadingFile : null,</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-  _uploader : null,</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-  _availableStorage : -1,</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-  _fileSpaceUsed : -1,</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  _uploads: [],</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-  _urlsForFiles : {},</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-  _uploadInfo : {}, // upload info keyed on aFiles.</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-  /**</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-   * Initialize this instance of nsUbuntuOne, setting the accountKey.</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-   *</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-   * @param aAccountKey the account key to initialize this provider with</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-   */</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-  init: function nsUbuntuOne_init(aAccountKey) {</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-    this._accountKey = aAccountKey;</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-    this._prefBranch = Services.prefs.getBranch(&quot;mail.cloud_files.accounts.&quot; + </span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-                                                aAccountKey + &quot;.&quot;);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-    this._emailAddress = this._prefBranch.getCharPref(&quot;emailaddress&quot;)</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-  },</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-  /**</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-   * The callback passed to an nsUbuntuOneFileUploader, which is fired when</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-   * nsUbuntuOneFileUploader exits.</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-   *</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-   * @param aRequestObserver the request observer originally passed to</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-   *                         uploadFile for the file associated with the</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-   *                         nsUbuntuOneFileUploader</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-   * @param aStatus the result of the upload</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-   */</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-  _uploaderCallback : function nsUbuntuOne__uploaderCallback(aRequestObserver,</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-                                                             aStatus) {</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-    aRequestObserver.onStopRequest(null, null, aStatus);</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-    this._uploadingFile = null;</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-    this._uploads.shift();</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-    if (this._uploads.length &gt; 0) {</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-      let nextUpload = this._uploads[0];</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-      this.log.info(&quot;chaining upload, file = &quot; + nextUpload.file.leafName);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-      this._uploadingFile = nextUpload.file;</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-      this._uploader = nextUpload;</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-      try {</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-        this.uploadFile(nextUpload.file, nextUpload.callback);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-      }</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-      catch (ex) {</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-        // I'd like to pass ex.result, but that doesn't seem to be defined.</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-        nextUpload.callback(nextUpload.requestObserver, Cr.NS_ERROR_FAILURE);</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-      }</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-    }</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-    else</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-      this._uploader = null;</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-  },</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-  /** </span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-   * Attempts to upload a file to UbuntuOne.</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-   *</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-   * @param aFile the nsILocalFile to be uploaded</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-   * @param aCallback an nsIRequestObserver for listening for the starting</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-   *                  and ending states of the upload.</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-   */</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-  uploadFile: function nsUbuntuOne_uploadFile(aFile, aCallback) {</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-    this.log.info(&quot;uploading &quot; + aFile.leafName);</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-    // Some ugliness here - we stash requestObserver here, because we might</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-    // use it again in _getUserInfo.</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-    this.requestObserver = aCallback;</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-    // if we're uploading a file, queue this request.</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-    if (this._uploadingFile &amp;&amp; !this._uploadingFile.equals(aFile)) {</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-      let uploader = new nsUbuntuOneFileUploader(this, aFile,</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-                                                 this._uploaderCallback</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-                                                   .bind(this),</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-                                                 aCallback);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-      this._uploads.push(uploader);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-      return;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-    }</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-    this._uploadingFile = aFile;</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-    let successCallback = this._finishUpload.bind(this, aFile, aCallback);</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-    if (!this._loggedIn)</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-      return this._logonAndGetUserInfo(successCallback, null, true);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-    this.log.info(&quot;getting user info&quot;);</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-    if (!this._userInfo)</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-      return this._getUserInfo(successCallback);</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-    successCallback();</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-  },</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-  /**</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-   * A private function used to ensure that we can actually upload the file</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-   * (we haven't exceeded file size or quota limitations), and then attempts</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-   * to kick-off the upload.</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-   *</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-   * @param aFile the nsILocalFile to upload</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-   * @param aCallback an nsIRequestObserver for monitoring the starting and</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-   *                  ending states of the upload.</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-   */</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-  _finishUpload: function nsUbuntuOne__finishUpload(aFile, aCallback) {</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-    let exceedsFileLimit = Ci.nsIMsgCloudFileProvider.uploadExceedsFileLimit;</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-    let exceedsQuota = Ci.nsIMsgCloudFileProvider.uploadWouldExceedQuota;</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-    if (aFile.fileSize &gt; this._availableStorage)</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-      return aCallback.onStopRequest(null, null, exceedsQuota);</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-    delete this._userInfo; // force us to update userInfo on every upload.</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-    if (!this._uploader) {</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-      this._uploader = new nsUbuntuOneFileUploader(this, aFile,</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-                                                   this._uploaderCallback</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineminus">-                                                     .bind(this),</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-                                                   aCallback);</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-      this._uploads.unshift(this._uploader);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-    }</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-    this._uploadingFile = aFile;</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-    this._uploader.uploadFile();</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-  },</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-  /**</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-   * Attempts to cancel a file upload.</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-   *</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-   * @param aFile the nsILocalFile to cancel the upload for.</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-   */</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-  cancelFileUpload: function nsUbuntuOne_cancelFileUpload(aFile) {</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-    this.log.info(&quot;Cancelling upload of file &quot; + aFile.leafName);</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-    if (this._uploadingFile.equals(aFile)) {</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-      this._uploader.cancel();</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-    }</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-    else {</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-      for (let i = 0; i &lt; this._uploads.length; i++)</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-        if (this._uploads[i].file.equals(aFile)) {</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-          // We bypass the cancel() method here so that</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-          // _uploaderCallback doesn't get called and chain to the</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-          // next upload.</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-          this._uploads[i].requestObserver.onStopRequest(</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-            null, null, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-          this._uploads.splice(i, 1);</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-          return;</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-        }</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-    }</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineminus">-  },</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-  /**</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-   * A private function used to retrieve the profile information for the</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-   * user account associated with the accountKey.</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-   *</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-   * @param successCallback the function called if information retrieval</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-   *                        is successful</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-   * @param failureCallback the function called if information retrieval fails</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-   */</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-  _getUserInfo: function nsUbuntuOne__getUserInfo(successCallback,</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-                                                  failureCallback) {</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-    if (!successCallback)</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-      successCallback = function() {</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-        this.requestObserver</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-            .onStopRequest(null, null,</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-                           this._loggedIn ? Cr.NS_OK : Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-      }.bind(this);</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-    if (!failureCallback)</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-      failureCallback = function () {</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-        this.requestObserver</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-            .onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-      }.bind(this);</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-    let requestFailed = function(aException, aResponseText, aRequest) {</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-      // Treat bad token specially, and fallback to</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-      // going through the uploadFiles process</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-      // again, and getting new tokens.</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-      if (aRequest.status == kBadAccessToken) {</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-        this.log.info(&quot;got bad token&quot;);</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-        this._loggedIn = false;</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-        this._cachedAuthToken = &quot;&quot;;</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-        this._cachedAuthSecret = &quot;&quot;;</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-        successCallback();</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-        return;</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-      }</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineminus">-      this.log.error(&quot;user info failed, status = &quot; + aRequest.status);</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-      this.log.error(&quot;response text = &quot; + aResponseText);</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-      this.log.error(&quot;exception = &quot; + aException);</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-      failureCallback();</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-    }.bind(this)</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-    this.log.info(&quot;Getting user info&quot;)</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-    this._connection.signAndSend(</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-      gServerUrl, [], &quot;GET&quot;, &quot;&quot;,</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-      function(aResponseText, aRequest) {</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-        this.log.info(&quot;user info = &quot; + aResponseText);</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-        this._userInfo = JSON.parse(aResponseText);</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineminus">-        this._fileSpaceUsed = this._userInfo.used_bytes;</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineminus">-        this._availableStorage = this._userInfo.max_bytes - this._fileSpaceUsed;</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineminus">-        this.log.info(&quot;avail storage = &quot; + this._availableStorage);</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-        // Ensure that the volume where we will store attachments exists.</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-        if (this._userInfo.user_node_paths.indexOf(kAttachmentsVolume) &lt; 0) {</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineminus">-          this.log.info(&quot;Creating attachments volume&quot;);</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineminus">-          let volumeUrl = (gServerUrl + kVolumesPath +</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineminus">-                           encodePathForURI(kAttachmentsVolume));</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineminus">-          this._connection.signAndSend(</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-            volumeUrl, [], &quot;PUT&quot;, &quot;&quot;,</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-            function(aResponseText, aRequest) {</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineminus">-              this.log.info(&quot;Created new volume &quot; + kAttachmentsVolume);</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-              successCallback();</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-            }.bind(this),</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-            requestFailed, this);</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-        }</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-        else {</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineminus">-          successCallback();</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-        }</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-      }.bind(this),</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineminus">-      requestFailed, this);</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-  },</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineminus">-</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineminus">-  /**</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-   * A private function that first ensures that the user is logged in, and then</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-   * retrieves the user's profile information.</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-   *</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-   * @param aSuccessCallback the function called on successful information</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-   *                         retrieval</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-   * @param aFailureCallback the function called on failed information retrieval</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-   * @param aWithUI a boolean for whether or not we should display authorization</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineminus">-   *                UI if we don't have a valid token anymore, or just fail out.</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineminus">-   */</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineminus">-  _logonAndGetUserInfo: function nsUbuntuOne_logonAndGetUserInfo(aSuccessCallback,</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-                                                                 aFailureCallback,</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-                                                                 aWithUI) {</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineminus">-    if (!aFailureCallback)</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-      aFailureCallback = function () {</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineminus">-        this.requestObserver</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-            .onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-      }.bind(this);</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineminus">-</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineminus">-    return this.logon(function() {</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-      this._getUserInfo(aSuccessCallback, aFailureCallback);</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-    }.bind(this), aFailureCallback, aWithUI);</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineminus">-  },</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-  /**</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-   * For some nsILocalFile, return the associated sharing URL.</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-   *</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineminus">-   * @param aFile the nsILocalFile to retrieve the URL for</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineminus">-   */</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-  urlForFile: function nsUbuntuOne_urlForFile(aFile) {</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-    return this._urlsForFiles[aFile.path];</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineminus">-  },</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineminus">-  /**</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-   * Updates the profile information for the account associated with the</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-   * account key.</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineminus">-   *</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-   * @param aWithUI a boolean for whether or not we should display authorization</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineminus">-   *                UI if we don't have a valid token anymore, or just fail out.</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-   * @param aCallback an nsIRequestObserver for observing the starting and</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-   *                  ending states of the request.</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-   */</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-  refreshUserInfo: function nsUbuntuOne_refreshUserInfo(aWithUI, aCallback) {</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineminus">-    this.requestObserver = aCallback;</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-    aCallback.onStartRequest(null, null);</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineminus">-    if (!this._loggedIn)</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-      return this._logonAndGetUserInfo(null, null, aWithUI);</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-    if (!this._userInfo)</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-      return this._getUserInfo();</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-    return this._userInfo;</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-  },</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineminus">-  /**</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineminus">-   * Our UbuntuOne implementation does not implement the createNewAccount</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-   * function defined in nsIMsgCloudFileProvider.idl.</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-   */</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-  createNewAccount: function nsUbuntuOne_createNewAccount(aEmailAddress,</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-                                                          aPassword, aFirstName,</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-                                                          aLastName) {</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineminus">-    return Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-  },</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineminus">-</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineminus">-  /**</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineminus">-   * If the user already has an account, we can get the user to just login</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-   * to it via OAuth.</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-   *</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-   * This function does not appear to be called from the BigFiles UI, and</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-   * might be excisable.</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-   */</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-  createExistingAccount: function nsUbuntuOne_createExistingAccount(aRequestObserver) {</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">-     // XXX: replace this with a better function</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-    let successCb = function(aResponseText, aRequest) {</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineminus">-      aRequestObserver.onStopRequest(null, this, Cr.NS_OK);</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineminus">-    }.bind(this);</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineminus">-</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-    let failureCb = function(aResponseText, aRequest) {</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-      aRequestObserver.onStopRequest(null, this,</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-                                     Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-    }.bind(this);</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineminus">-    this.logon(successCb, failureCb, true);</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineminus">-  },</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineminus">-</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineminus">-  /**</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineminus">-   * If the provider doesn't have an API for creating an account, perhaps</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineminus">-   * there's a url we can load in a content tab that will allow the user</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineminus">-   * to create an account.</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-   */</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineminus">-  get createNewAccountUrl() &quot;&quot;,</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineminus">-</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineminus">-  /**</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineminus">-   * For a particular error, return a URL if UbuntuOne has a page for handling</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-   * that particular error.</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-   *</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineminus">-   * @param aError the error to get the URL for</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineminus">-   */</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineminus">-  providerUrlForError: function nsUbuntuOne_providerUrlForError(aError) {</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineminus">-    if (aError == Ci.nsIMsgCloudFileProvider.uploadWouldExceedQuota)</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineminus">-      return &quot;https://one.ubuntu.com/referrals/referee/2149434/?next=/services/add-storage/&quot;;</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineminus">-  },</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineminus">-</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineminus">-  /**</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineminus">-   * If we don't know the limit, this will return -1.</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineminus">-   */</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineminus">-  get fileUploadSizeLimit() -1,</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineminus">-  get remainingFileSpace() this._availableStorage,</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineminus">-  get fileSpaceUsed() this._fileSpaceUsed,</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineminus">-</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineminus">-  /**</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineminus">-   * Attempt to delete an upload file if we've uploaded it.</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineminus">-   *</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineminus">-   * @param aFile the file that was originall uploaded</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineminus">-   * @param aCallback an nsIRequestObserver for monitoring the starting and</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineminus">-   *                  ending states of the deletion request.</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineminus">-   */</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineminus">-  deleteFile: function nsUbuntuOne_deleteFile(aFile, aCallback) {</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineminus">-</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineminus">-    let uploadInfo = this._uploadInfo[aFile.path];</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineminus">-    if (!uploadInfo)</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineminus">-      throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineminus">-</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineminus">-    this.requestObserver = aCallback;</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineminus">-    let url = gServerUrl + encodePathForURI(uploadInfo.resource_path);</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineminus">-    this.log.info(&quot;Sending delete request to &quot; + url);</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineminus">-    this._connection.signAndSend(url, [], &quot;DELETE&quot;, null,</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineminus">-      function(aResponseText, aRequest) {</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineminus">-        this.log.info(&quot;success deleting file; response = &quot; + aResponseText);</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineminus">-        aCallback.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineminus">-      }.bind(this),</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineminus">-      function(aException, aResponseText, aRequest) {</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineminus">-        this.log.error(&quot;failed deleting file; response = &quot; + aResponseText);</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineminus">-        aCallback.onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineminus">-      }.bind(this), this);</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineminus">-  },</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineminus">-</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineminus">-  /**</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineminus">-   * This function is used by our testing framework to override the default</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineminus">-   * URL's that nsUbuntuOne connects to.</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineminus">-   */</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineminus">-  overrideUrls : function nsUbuntuOne_overrideUrls(aNumUrls, aUrls) {</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineminus">-    gServerUrl = aUrls[0];</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineminus">-    gContentUrl = aUrls[1];</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineminus">-    gSsoUrl = aUrls[2];</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-    gSsoPingUrl = aUrls[3];</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineminus">-  },</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineminus">-</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineminus">-  _getPassword: function nsUbuntuOne__getPassword(aEmailAddress) {</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">-    this.log.info(&quot;Getting password for user: &quot; + aEmailAddress);</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineminus">-</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineminus">-    // OK, let's prompt for it.</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineminus">-    let win = Services.wm.getMostRecentWindow(null);</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">-    let authPrompter = Services.ww.getNewAuthPrompter(win);</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-    var password = { value: &quot;&quot; };</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">-    let userPos = gSsoUrl.indexOf(&quot;//&quot;) + 2;</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineminus">-    let userNamePart = encodeURIComponent(this._emailAddress) + &quot;@&quot;;</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineminus">-    let ssoUrl = (gSsoUrl.substr(0, userPos) + userNamePart +</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineminus">-                  gSsoUrl.substring(userPos));</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineminus">-    let messengerBundle = Services.strings.createBundle(</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineminus">-      &quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-    let promptString = messengerBundle.formatStringFromName(&quot;passwordPrompt&quot;,</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-                                                            [this._emailAddress,</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-                                                             this.displayName],</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-                                                            2);</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-    if (authPrompter.promptPassword(this.displayName, promptString, ssoUrl,</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-                                    authPrompter.SAVE_PASSWORD_NEVER,</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineminus">-                                    password))</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineminus">-      return password.value;</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineminus">-</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineminus">-  },</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineminus">-</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineminus">-  _acquireToken: function nsUbuntuOne__acquireToken(successCallback,</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-                                                    failureCallback) {</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineminus">-    this.log.info(&quot;Acquiring a token&quot;);</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineminus">-    let password = this._getPassword(this._emailAddress);</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineminus">-</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineminus">-    if (!password) {</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">-      this.log.info(&quot;No password provided&quot;);</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineminus">-      failureCallback();</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineminus">-    }</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineminus">-</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-    let userPos = gSsoUrl.indexOf(&quot;//&quot;) + 2;</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineminus">-    let credentials = &quot;Basic &quot; + btoa(this._emailAddress + &quot;:&quot; + password);</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineminus">-    let dnsService = Cc[&quot;@mozilla.org/network/dns-service;1&quot;]</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineminus">-      .getService(Components.interfaces.nsIDNSService);</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineminus">-    let tokenName = &quot;Ubuntu One @ &quot; + dnsService.myHostName + &quot; [thunderbird]&quot;;</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineminus">-    let newTokenUrl = gSsoUrl + &quot;?ws.op=authenticate&amp;token_name=&quot; +</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineminus">-      encodeURIComponent(tokenName);</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineminus">-</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-    this.log.info(&quot;Requesting Authentication token&quot;);</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-    httpRequest(newTokenUrl, {</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineminus">-        headers: [[&quot;Authorization&quot;, credentials]],</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineminus">-        onLoad: function(aResponseText, aRequest) {</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineminus">-          this.log.info(&quot;Retrieved a new token from SSO&quot;);</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineminus">-          let tokenInfo = JSON.parse(aResponseText);</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineminus">-</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineminus">-          // We need to tell Ubuntu One to pull the token from the SSO</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineminus">-          // service now.</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineminus">-          this._connection = new OAuth(this.displayName, null, null,</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineminus">-                                       tokenInfo.token, tokenInfo.token_secret,</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-                                       tokenInfo.consumer_key,</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineminus">-                                       tokenInfo.consumer_secret,</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineminus">-                                       &quot;PLAINTEXT&quot;);</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineminus">-          this._connection.signAndSend(</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineminus">-            gSsoPingUrl, [], &quot;POST&quot;, &quot;&quot;,</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineminus">-            function(aResponseText, aRequest) {</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineminus">-              this.log.info(&quot;Token transferred to Ubuntu One: &quot; + aResponseText);</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineminus">-              // Now that the token has successfully been transferred,</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-              // save it locally.</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-              this._cachedAuthToken = tokenInfo.token;</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineminus">-              this._cachedAuthSecret = tokenInfo.token_secret;</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineminus">-              this._cachedConsumerKey = tokenInfo.consumer_key;</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineminus">-              this._cachedConsumerSecret = tokenInfo.consumer_secret;</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineminus">-              successCallback();</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineminus">-            }.bind(this),</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineminus">-            function(aException, aResponseText, aRequest) {</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineminus">-              this.log.info(&quot;Failed to transfer access token to Ubuntu One:&quot; +</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineminus">-                            aResponseText);</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineminus">-              failureCallback();</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-            }.bind(this), this);</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineminus">-        }.bind(this),</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineminus">-        onError: function(aException, aResponseText, aRequest) {</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineminus">-          this.log.info(&quot;Failed to acquire an access token:&quot; + aResponseText);</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineminus">-          failureCallback();</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineminus">-        }.bind(this),</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineminus">-        method: &quot;GET&quot;</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineminus">-      });</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineminus">-  },</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineminus">-</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineminus">-  /**</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineminus">-   * logon to the Ubuntu One account.</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineminus">-   *</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineminus">-   * @param successCallback - called if logon is successful</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineminus">-   * @param failureCallback - called back on error.</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineminus">-   * @param aWithUI if false, logon fails if it would have needed to put up UI.</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineminus">-   *                This is used for things like displaying account settings,</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineminus">-   *                where we don't want to pop up the oauth ui.</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineminus">-   */</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineminus">-  logon: function nsUbuntuOne_logon(successCallback, failureCallback, aWithUI) {</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-    let authToken = this._cachedAuthToken;</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineminus">-    let authSecret = this._cachedAuthSecret;</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineminus">-    let consumerKey = this._cachedConsumerKey;</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineminus">-    let consumerSecret = this._cachedConsumerSecret;</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineminus">-    if (!aWithUI &amp;&amp; (!authToken.length || !authSecret.length ||</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineminus">-                     !consumerKey.length || !consumerSecret.length)) {</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineminus">-      failureCallback();</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineminus">-      return;</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineminus">-    }</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineminus">-</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineminus">-    let haveTokenCb = function() {</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineminus">-      // Should probably perform a verification step to ensure that</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineminus">-      // the token is still valid.</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineminus">-      this._loggedIn = true;</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineminus">-      successCallback();</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineminus">-    }.bind(this);</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineminus">-</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineminus">-    if (authToken.length &amp;&amp; authSecret.length &amp;&amp;</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineminus">-        consumerKey.length &amp;&amp; consumerSecret.length) {</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineminus">-      this._connection = new OAuth(this.displayName, null, null,</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineminus">-                                   authToken, authSecret,</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineminus">-                                   consumerKey, consumerSecret,</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineminus">-                                   &quot;PLAINTEXT&quot;);</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineminus">-      haveTokenCb();</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineminus">-    }</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineminus">-    else {</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineminus">-      if (!aWithUI) {</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-        failureCallback();</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineminus">-        return;</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineminus">-      }</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineminus">-      this._acquireToken(haveTokenCb, failureCallback);</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineminus">-    }</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineminus">-  },</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineminus">-</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineminus">-  /**</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineminus">-   * Retrieves the cached auth token for this account.</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineminus">-   */</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineminus">-  get _cachedAuthToken() {</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineminus">-    let authToken = cloudFileAccounts.getSecretValue(this.accountKey,</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineminus">-                                                     cloudFileAccounts.kTokenRealm);</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineminus">-    if (!authToken)</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineminus">-</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineminus">-    return authToken;</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineminus">-  },</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineminus">-</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineminus">-  /**</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineminus">-   * Sets the cached auth token for this account.</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineminus">-   *</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineminus">-   * @param aAuthToken the auth token to cache.</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineminus">-   */</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineminus">-  set _cachedAuthToken(aAuthToken) {</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineminus">-    cloudFileAccounts.setSecretValue(this.accountKey,</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineminus">-                                     cloudFileAccounts.kTokenRealm,</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineminus">-                                     aAuthToken);</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineminus">-  },</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineminus">-</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineminus">-  /**</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineminus">-   * Retrieves the cached auth secret for this account.</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineminus">-   */</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineminus">-  get _cachedAuthSecret() {</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineminus">-    let authSecret = cloudFileAccounts.getSecretValue(this.accountKey,</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineminus">-                                                      kAuthSecretRealm);</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineminus">-</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineminus">-    if (!authSecret)</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineminus">-</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineminus">-    return authSecret;</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineminus">-  },</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineminus">-</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineminus">-  /**</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineminus">-   * Sets the cached auth secret for this account.</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineminus">-   *</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineminus">-   * @param aAuthSecret the auth secret to cache.</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineminus">-   */</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineminus">-  set _cachedAuthSecret(aAuthSecret) {</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineminus">-    cloudFileAccounts.setSecretValue(this.accountKey,</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineminus">-                                     kAuthSecretRealm,</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineminus">-                                     aAuthSecret);</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineminus">-  },</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineminus">-</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineminus">-  /**</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineminus">-   * Retrieves the cached consumer key for this account.</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineminus">-   */</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineminus">-  get _cachedConsumerKey() {</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineminus">-    let consumerKey = cloudFileAccounts.getSecretValue(this.accountKey,</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineminus">-                                                       kConsumerKeyRealm);</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineminus">-</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineminus">-    if (!consumerKey)</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineminus">-</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineminus">-    return consumerKey;</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineminus">-  },</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineminus">-</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineminus">-  /**</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineminus">-   * Sets the cached consumer key for this account.</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineminus">-   *</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineminus">-   * @param aConsumerKey the consumer key to cache.</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineminus">-   */</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineminus">-  set _cachedConsumerKey(aConsumerKey) {</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineminus">-    cloudFileAccounts.setSecretValue(this.accountKey,</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineminus">-                                     kConsumerKeyRealm,</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineminus">-                                     aConsumerKey);</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineminus">-  },</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineminus">-</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineminus">-  /**</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineminus">-   * Retrieves the cached consumer secret for this account.</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineminus">-   */</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineminus">-  get _cachedConsumerSecret() {</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineminus">-    let consumerSecret = cloudFileAccounts.getSecretValue(this.accountKey,</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineminus">-                                                          kConsumerSecretRealm);</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineminus">-</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineminus">-    if (!consumerSecret)</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineminus">-</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineminus">-    return consumerSecret;</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineminus">-  },</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineminus">-</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineminus">-  /**</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineminus">-   * Sets the cached consumer secret for this account.</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineminus">-   *</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineminus">-   * @param aConsumerSecret the auth secret to cache.</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineminus">-   */</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineminus">-  set _cachedConsumerSecret(aConsumerSecret) {</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineminus">-    cloudFileAccounts.setSecretValue(this.accountKey,</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineminus">-                                     kConsumerSecretRealm,</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineminus">-                                     aConsumerSecret);</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineminus">-  },</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineminus">-</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineminus">-};</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineminus">-</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineminus">-function nsUbuntuOneFileUploader(aUbuntuOne, aFile, aCallback,</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineminus">-                                 aRequestObserver) {</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineminus">-  this.ubuntuone = aUbuntuOne;</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineminus">-  this.log = this.ubuntuone.log;</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineminus">-  this.log.info(&quot;new nsUbuntuOneFileUploader file = &quot; + aFile.leafName);</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineminus">-  this.file = aFile;</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineminus">-  this.callback = aCallback;</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineminus">-  this.requestObserver = aRequestObserver;</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineminus">-}</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineminus">-</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineminus">-nsUbuntuOneFileUploader.prototype = {</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineminus">-  ubuntuone: null,</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineminus">-  file: null,</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineminus">-  callback: null,</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineminus">-  request: null,</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineminus">-</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineminus">-  /**</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineminus">-   * Kicks off the upload request for the file associated with this Uploader.</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineminus">-   */</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineminus">-  uploadFile: function nsU1FU_uploadFile() {</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineminus">-    this.requestObserver.onStartRequest(null, null);</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineminus">-    // XXX: should check to see if there is another file by this name</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineminus">-    // in the folder.  Perhaps put attachments in date oriented</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineminus">-    // directories?</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineminus">-    let path = kAttachmentsVolume + &quot;/&quot; + this.file.leafName;</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineminus">-    this.log.info(&quot;ready to upload file &quot; + path);</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineminus">-    let url = gContentUrl + encodePathForURI(path);</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineminus">-    let mimeService = Cc[&quot;@mozilla.org/mime;1&quot;].getService(Ci.nsIMIMEService);</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineminus">-    let contentType;</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineminus">-    try {</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineminus">-      contentType = mimeService.getTypeFromFile(this.file);</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineminus">-    }</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineminus">-    catch (ex) {</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineminus">-      contentType = &quot;application/octet-stream&quot;;</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineminus">-    }</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineminus">-    let headers = [[&quot;Content-Type&quot;, contentType]];</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineminus">-    let fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineminus">-                     .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineminus">-    fstream.init(this.file, -1, 0, 0);</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineminus">-    let bufStream = Cc[&quot;@mozilla.org/network/buffered-input-stream;1&quot;].</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineminus">-      createInstance(Ci.nsIBufferedInputStream);</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineminus">-    bufStream.init(fstream, 4096);</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineminus">-    bufStream = bufStream.QueryInterface(Ci.nsIInputStream);</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineminus">-    this.request = this.ubuntuone._connection.signAndSend(</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineminus">-      url, headers, &quot;PUT&quot;, bufStream,</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineminus">-      function(aResponseText, aRequest) {</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineminus">-        this.request = null;</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineminus">-        this.log.info(&quot;success putting file &quot; + aResponseText);</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineminus">-        let nodeInfo = JSON.parse(aResponseText);</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineminus">-        this._getShareUrl(nodeInfo);</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineminus">-      }.bind(this),</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineminus">-      function(aException, aResponseText, aRequest) {</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineminus">-        this.request = null;</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineminus">-        this.log.info(&quot;failed putting file response = &quot; + aException);</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-        if (this.callback)</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineminus">-          this.callback(this.requestObserver,</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineminus">-                        Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineminus">-      }.bind(this), this);</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineminus">-  },</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineminus">-</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineminus">-  /**</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineminus">-   * Cancels the upload request for the file associated with this Uploader.</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineminus">-   */</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineminus">-  cancel: function nsU1FU_cancel() {</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineminus">-    this.log.info(&quot;Cancelling upload of &quot; + this.file.leafName);</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineminus">-    this.callback(this.requestObserver, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineminus">-    this.callback = null;</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineminus">-    if (this.request) {</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineminus">-      let req = this.request;</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineminus">-      if (req.channel) {</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineminus">-        this.log.info(&quot;canceling channel upload&quot;);</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineminus">-        req.channel.cancel(Cr.NS_BINDING_ABORTED);</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineminus">-      }</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineminus">-      this.request = null;</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineminus">-    }</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineminus">-  },</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineminus">-</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineminus">-  /**</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineminus">-   * Private function that attempts to retrieve the sharing URL for the file</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineminus">-   * uploaded with this Uploader.</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineminus">-   *</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineminus">-   * @param aNodeInfo the node info for the file on the server.</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineminus">-   */</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineminus">-  _getShareUrl: function nsU1FU__getShareUrl(aNodeInfo) {</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineminus">-    this.log.info(&quot;Making file &quot; + aNodeInfo.resource_path + &quot; public&quot;);</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineminus">-    let url = gServerUrl + encodePathForURI(aNodeInfo.resource_path);</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineminus">-    let headers = [[&quot;Content-Type&quot;, &quot;application/json&quot;]];</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineminus">-    let body = JSON.stringify({is_public: true});</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineminus">-    this.request = this.ubuntuone._connection.signAndSend(</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineminus">-      url, headers, &quot;PUT&quot;, body,</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineminus">-      function(aResponseText, aRequest) {</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineminus">-        this.request = null;</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineminus">-        this.log.info(&quot;Successfully made node public with response text: &quot;</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineminus">-                      + aResponseText);</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineminus">-        let nodeInfo = JSON.parse(aResponseText);</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineminus">-        this.ubuntuone._uploadInfo[this.file.path] = nodeInfo;</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineminus">-        this.ubuntuone._urlsForFiles[this.file.path] = nodeInfo.public_url;</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineminus">-        this.callback(this.requestObserver, Cr.NS_OK);</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineminus">-      }.bind(this),</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineminus">-      function(aException, aResponseText, aRequest) {</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineminus">-        this.request = null;</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineminus">-        this.log.error(&quot;Getting share URL failed: &quot; + aException);</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineminus">-        if (this.callback)</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineminus">-          this.callback(this.requestObserver, Cr.NS_ERROR_FAILURE);</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineminus">-      }.bind(this), this);</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineminus">-  },</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineminus">-};</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineminus">-</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineminus">-const NSGetFactory = XPCOMUtils.generateNSGetFactory([nsUbuntuOne]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/installer/package-manifest.in</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/installer/package-manifest.in</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -204,17 +204,16 @@</span>
<a href="#l9.4"></a><span id="l9.4"> @BINPATH@/components/mailview.xpt</span>
<a href="#l9.5"></a><span id="l9.5"> @BINPATH@/components/mailprofilemigration.xpt</span>
<a href="#l9.6"></a><span id="l9.6"> @BINPATH@/components/messageWakeupService.js</span>
<a href="#l9.7"></a><span id="l9.7"> @BINPATH@/components/messageWakeupService.manifest</span>
<a href="#l9.8"></a><span id="l9.8"> @BINPATH@/components/nsActivity.js</span>
<a href="#l9.9"></a><span id="l9.9"> @BINPATH@/components/nsActivityManager.js</span>
<a href="#l9.10"></a><span id="l9.10"> @BINPATH@/components/nsActivityManagerUI.js</span>
<a href="#l9.11"></a><span id="l9.11"> @BINPATH@/components/nsHightail.js</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-@BINPATH@/components/nsUbuntuOne.js</span>
<a href="#l9.13"></a><span id="l9.13"> @BINPATH@/components/nsBox.js</span>
<a href="#l9.14"></a><span id="l9.14"> @BINPATH@/components/nsAddrbook.manifest</span>
<a href="#l9.15"></a><span id="l9.15"> @BINPATH@/components/nsMailNewsCommandLineHandler.js</span>
<a href="#l9.16"></a><span id="l9.16"> @BINPATH@/components/nsNewsAutoCompleteSearch.js</span>
<a href="#l9.17"></a><span id="l9.17"> @BINPATH@/components/nsNewsAutoCompleteSearch.manifest</span>
<a href="#l9.18"></a><span id="l9.18"> @BINPATH@/components/services-crypto-component.xpt</span>
<a href="#l9.19"></a><span id="l9.19"> @BINPATH@/components/shellservice.xpt</span>
<a href="#l9.20"></a><span id="l9.20"> @BINPATH@/components/xpcom_base.xpt</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,4 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-&lt;!ENTITY ubuntuOneMgmt.viewSettings &quot;View my account settings on one.ubuntu.com&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,6 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-&lt;!ENTITY UbuntuOneSettings.emailAddress &quot;Email Address:&quot;&gt;</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-&lt;!ENTITY UbuntuOneSettings.needAnAccount &quot;Need an account?&quot;&gt;</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-&lt;!ENTITY UbuntuOneSettings.learnMore &quot;Learn more…&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -125,18 +125,16 @@</span>
<a href="#l12.4"></a><span id="l12.4">   locale/@AB_CD@/messenger/addressbook/abMailListDialog.dtd             (%chrome/messenger/addressbook/abMailListDialog.dtd)</span>
<a href="#l12.5"></a><span id="l12.5">   locale/@AB_CD@/messenger/addressbook/addressBook.properties           (%chrome/messenger/addressbook/addressBook.properties)</span>
<a href="#l12.6"></a><span id="l12.6">   locale/@AB_CD@/messenger/addressbook/ldapAutoCompErrs.properties      (%chrome/messenger/addressbook/ldapAutoCompErrs.properties)</span>
<a href="#l12.7"></a><span id="l12.7">   locale/@AB_CD@/messenger/addressbook/pref-directory.dtd               (%chrome/messenger/addressbook/pref-directory.dtd)</span>
<a href="#l12.8"></a><span id="l12.8">   locale/@AB_CD@/messenger/addressbook/pref-directory-add.dtd           (%chrome/messenger/addressbook/pref-directory-add.dtd)</span>
<a href="#l12.9"></a><span id="l12.9">   locale/@AB_CD@/messenger/addressbook/replicationProgress.properties   (%chrome/messenger/addressbook/replicationProgress.properties)</span>
<a href="#l12.10"></a><span id="l12.10">   locale/@AB_CD@/messenger/cloudfile/addAccountDialog.dtd               (%chrome/messenger/cloudfile/addAccountDialog.dtd)</span>
<a href="#l12.11"></a><span id="l12.11">   locale/@AB_CD@/messenger/cloudfile/management.dtd                     (%chrome/messenger/cloudfile/management.dtd)</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/UbuntuOne/management.dtd           (%chrome/messenger/cloudfile/UbuntuOne/management.dtd)</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/UbuntuOne/settings.dtd             (%chrome/messenger/cloudfile/UbuntuOne/settings.dtd)</span>
<a href="#l12.14"></a><span id="l12.14">   locale/@AB_CD@/messenger/cloudfile/Hightail/management.dtd           (%chrome/messenger/cloudfile/Hightail/management.dtd)</span>
<a href="#l12.15"></a><span id="l12.15">   locale/@AB_CD@/messenger/cloudfile/Hightail/settings.dtd             (%chrome/messenger/cloudfile/Hightail/settings.dtd)</span>
<a href="#l12.16"></a><span id="l12.16">   locale/@AB_CD@/messenger/cloudfile/Hightail/fileExceedsLimit.dtd     (%chrome/messenger/cloudfile/Hightail/fileExceedsLimit.dtd)</span>
<a href="#l12.17"></a><span id="l12.17">   locale/@AB_CD@/messenger/cloudfile/Hightail/fileExceedsQuota.dtd     (%chrome/messenger/cloudfile/Hightail/fileExceedsQuota.dtd)</span>
<a href="#l12.18"></a><span id="l12.18">   locale/@AB_CD@/messenger/cloudfile/Hightail/fileExceeds2GB.dtd       (%chrome/messenger/cloudfile/Hightail/fileExceeds2GB.dtd)</span>
<a href="#l12.19"></a><span id="l12.19">   locale/@AB_CD@/messenger/cloudfile/Box/settings.dtd                   (%chrome/messenger/cloudfile/Box/settings.dtd)</span>
<a href="#l12.20"></a><span id="l12.20">   locale/@AB_CD@/messenger/cloudfile/Box/management.dtd                 (%chrome/messenger/cloudfile/Box/management.dtd)</span>
<a href="#l12.21"></a><span id="l12.21">   locale/@AB_CD@/messenger/cloudfile/Box/auth.dtd                       (%chrome/messenger/cloudfile/Box/auth.dtd)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,273 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">-  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-/**</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">- * Tests the Ubuntu One Bigfile backend.</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">- */</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-let Cu = Components.utils;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-let Cc = Components.classes;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-let Ci = Components.interfaces;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-const MODULE_NAME = 'test-cloudfile-backend-ubuntuone';</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-const MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-                         'compose-helpers',</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-                         'cloudfile-ubuntuone-helpers',</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-                         'observer-helpers',</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-                         'prompt-helpers',];</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-const kAttachmentsVolume = '/~/Thunderbird Attachments';</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-Cu.import('resource://gre/modules/Services.jsm');</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-Cu.import('resource:///modules/cloudFileAccounts.js');</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-var gServer, gObsManager;</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-function setupModule(module) {</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-  fdh.installInto(module);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-  let ch = collector.getModule('compose-helpers');</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-  ch.installInto(module);</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-  let cfh = collector.getModule('cloudfile-helpers');</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-  cfh.installInto(module);</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-  let cbh = collector.getModule('cloudfile-backend-helpers');</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-  cbh.installInto(module);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-  let cdh = collector.getModule('cloudfile-ubuntuone-helpers');</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-  cdh.installInto(module);</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-  let oh = collector.getModule('observer-helpers');</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-  oh.installInto(module);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-  let ph = collector.getModule('prompt-helpers');</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-  ph.installInto(module);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-  gObsManager = new cbh.SimpleRequestObserverManager();</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-  // Enable logging for this test.</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-  Services.prefs.setCharPref(&quot;UbuntuOne.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-  Services.prefs.setCharPref(&quot;TBOAuth.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-};</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-function teardownModule() {</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-  Services.prefs.QueryInterface(Ci.nsIPrefBranch)</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-          .deleteBranch(&quot;mail.cloud_files.accounts&quot;);</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-  Services.prefs.clearUserPref(&quot;UbuntuOne.logging.dump&quot;);</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-  Services.prefs.clearUserPref(&quot;TBOAuth.logging.dump&quot;);</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-}</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-function setupTest() {</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-  gServer = new MockUbuntuOneServer();</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-  gServer.init();</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-  gServer.start();</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-}</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-function teardownTest() {</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-  gObsManager.check();</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-  gObsManager.reset();</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-  gServer.stop(mc);</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-}</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-function test_simple_case() {</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-  const kExpectedUrl = &quot;http://www.example.com/expectedUrl&quot;;</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-  gServer.setupUser();</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-  gServer.planForCreateVolume(kAttachmentsVolume);</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-  gServer.planForUploadFile(kAttachmentsVolume + &quot;/testFile1&quot;);</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-  gServer.planForMetadataUpdate(kAttachmentsVolume + &quot;/testFile1&quot;,</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-                                kExpectedUrl);</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-  let obs = new ObservationRecorder();</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-    obs.planFor(topic);</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-    Services.obs.addObserver(obs, topic, false);</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineminus">-  }</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-  let requestObserver = gObsManager.create(&quot;test_simple_case - Upload 1&quot;);</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-  let file = getFile(&quot;./data/testFile1&quot;, __file__);</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-  provider.uploadFile(file, requestObserver);</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-  mc.waitFor(function () requestObserver.success);</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-  let urlForFile = provider.urlForFile(file);</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-  assert_equals(1, obs.numSightings(kUploadFile));</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-  assert_equals(1, obs.numSightings(kGetFileURL));</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineminus">-  gServer.planForUploadFile(kAttachmentsVolume + &quot;/testFile1&quot;);</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-  gServer.planForMetadataUpdate(kAttachmentsVolume + &quot;/testFile1&quot;,</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-                                kExpectedUrl);</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-  requestObserver = gObsManager.create(&quot;test_simple_case - Upload 2&quot;);</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-  provider.uploadFile(file, requestObserver);</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-  mc.waitFor(function () requestObserver.success);</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-  urlForFile = provider.urlForFile(file);</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-  assert_equals(2, obs.numSightings(kUploadFile));</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-  assert_equals(2, obs.numSightings(kGetFileURL));</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-    Services.obs.removeObserver(obs, topic);</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-  }</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-}</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-function test_chained_uploads() {</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-  const kExpectedUrlRoot = &quot;http://www.example.com/&quot;;</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-  const kFilenames = [&quot;testFile1&quot;, &quot;testFile2&quot;, &quot;testFile3&quot;];</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-  gServer.setupUser();</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-  gServer.planForCreateVolume(kAttachmentsVolume);</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-  for each (let [, filename] in Iterator(kFilenames)) {</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-    let path = kAttachmentsVolume + &quot;/&quot; + filename;</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-    let expectedUrl = kExpectedUrlRoot + filename;</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-    gServer.planForUploadFile(path);</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-    gServer.planForMetadataUpdate(path, expectedUrl);</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineminus">-  }</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-  let obs = new ObservationRecorder();</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-    obs.planFor(topic);</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-    Services.obs.addObserver(obs, topic, false);</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-  }</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-  let files = [];</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-  let observers = kFilenames.map(function(aFilename) {</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-    let requestObserver = gObsManager.create(&quot;test_chained_uploads for filename &quot; + aFilename);</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-    let file = getFile(&quot;./data/&quot; + aFilename, __file__);</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-    files.push(file);</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-    provider.uploadFile(file, requestObserver);</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineminus">-    return requestObserver;</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineminus">-  });</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineminus">-</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineminus">-  mc.waitFor(function() {</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineminus">-    return observers.every(function(aListener) aListener.success);</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineminus">-  }, &quot;Timed out waiting for chained uploads to complete.&quot;, 10000);</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-  assert_equals(kFilenames.length, obs.numSightings(kUploadFile));</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineminus">-</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineminus">-  for (let [index, filename] in Iterator(kFilenames)) {</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineminus">-    let path = kAttachmentsVolume + &quot;/&quot; + filename;</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineminus">-    assert_equals(obs.data[kUploadFile][index], path);</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineminus">-    let file = getFile(&quot;./data/&quot; + filename, __file__);</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineminus">-    let expectedUriForFile = kExpectedUrlRoot + filename;</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-    let uriForFile = provider.urlForFile(files[index]);</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-    assert_equals(expectedUriForFile, uriForFile);</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineminus">-  }</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineminus">-</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-  assert_equals(kFilenames.length, obs.numSightings(kGetFileURL));</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineminus">-  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineminus">-    Services.obs.removeObserver(obs, topic);</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-  }</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-}</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineminus">-</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-function test_deleting_uploads() {</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineminus">-  const kFilename = &quot;testFile1&quot;;</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineminus">-  let path = kAttachmentsVolume + &quot;/&quot; + kFilename;</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineminus">-  gServer.setupUser();</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-  // Upload a file</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineminus">-</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-  gServer.planForCreateVolume(kAttachmentsVolume);</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-  gServer.planForUploadFile(path);</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-  gServer.planForMetadataUpdate(path, &quot;http://www.example.com/someFile&quot;);</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineminus">-  let requestObserver = gObsManager.create(&quot;test_deleting_uploads - upload 1&quot;);</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineminus">-  let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineminus">-  provider.uploadFile(file, requestObserver);</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineminus">-  mc.waitFor(function() requestObserver.success);</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineminus">-</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-  // Try deleting a file</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-  let obs = new ObservationRecorder();</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineminus">-  obs.planFor(kDeleteFile);</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineminus">-  Services.obs.addObserver(obs, kDeleteFile, false);</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-  //gServer.planForDeleteFile(kFilename);</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-  let deleteObserver = gObsManager.create(&quot;test_deleting_uploads - delete 1&quot;);</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineminus">-  provider.deleteFile(file, deleteObserver);</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineminus">-  mc.waitFor(function() deleteObserver.success);</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineminus">-</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineminus">-  // Check to make sure the file was deleted on the server</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-  assert_equals(1, obs.numSightings(kDeleteFile));</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-  assert_equals(obs.data[kDeleteFile][0], path);</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineminus">-  Services.obs.removeObserver(obs, kDeleteFile);</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineminus">-}</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineminus">-</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineminus">-/**</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineminus">- * Test that when we call createExistingAccount, onStopRequest is successfully</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineminus">- * called, and we pass the correct parameters.</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">- */</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineminus">-function test_create_existing_account() {</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineminus">-  gMockAuthPromptReg.register();</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineminus">-  try {</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineminus">-    gMockAuthPrompt.password = &quot;account_password&quot;;</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineminus">-    let accountKey = &quot;someNewAccount&quot;;</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineminus">-    // Prepare the backend without preloading any token.</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineminus">-    let provider = gServer.getPreparedBackend(accountKey, true);</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">-    let done = false;</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineminus">-    let myObs = {</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineminus">-      onStartRequest: function(aRequest, aContext) {</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineminus">-      },</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineminus">-      onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineminus">-        assert_true(aContext instanceof Ci.nsIMsgCloudFileProvider);</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-        assert_equals(aStatusCode, Components.results.NS_OK);</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineminus">-        done = true;</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-      },</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineminus">-    }</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineminus">-</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineminus">-    provider.createExistingAccount(myObs);</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineminus">-    mc.waitFor(function() done);</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineminus">-    let newToken = cloudFileAccounts.getSecretValue(</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-      accountKey, cloudFileAccounts.kTokenRealm);</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineminus">-    assert_not_equals(newToken, &quot;&quot;);</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineminus">-  }</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineminus">-  finally {</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-    gMockAuthPromptReg.unregister();</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineminus">-  }</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineminus">-}</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineminus">-</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineminus">-/**</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineminus">- * Test that cancelling an upload causes onStopRequest to be</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">- * called with nsIMsgCloudFileProvider.uploadCanceled.</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineminus">- */</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineminus">-function test_can_cancel_upload() {</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineminus">-  const kFilename = &quot;testFile1&quot;;</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineminus">-  let path = kAttachmentsVolume + &quot;/&quot; + kFilename;</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-  gServer.setupUser();</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someNewAccount&quot;);</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineminus">-  let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineminus">-  gServer.planForCreateVolume(kAttachmentsVolume);</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-  gServer.planForUploadFile(path, 2000);</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineminus">-  assert_can_cancel_uploads(mc, provider, [file]);</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">-}</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineminus">-/**</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">- * Test that cancelling several uploads causes onStopRequest to be</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">- * called with nsIMsgCloudFileProvider.uploadCanceled.</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineminus">- */</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-function test_can_cancel_uploads() {</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-  const kFiles = [&quot;testFile1&quot;, &quot;testFile2&quot;, &quot;testFile3&quot;];</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineminus">-  gServer.setupUser();</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someNewAccount&quot;);</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineminus">-  let files = [];</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineminus">-  gServer.planForCreateVolume(kAttachmentsVolume);</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineminus">-  for each (let [, filename] in Iterator(kFiles)) {</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineminus">-    let path = kAttachmentsVolume + &quot;/&quot; + filename;</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineminus">-    gServer.planForUploadFile(path, 2000);</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineminus">-    files.push(getFile(&quot;./data/&quot; + filename, __file__));</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineminus">-  }</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineminus">-  assert_can_cancel_uploads(mc, provider, files);</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,342 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">-</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-const MODULE_NAME = &quot;cloudfile-ubuntuone-helpers&quot;;</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-Cu.import('resource://mozmill/stdlib/httpd.js');</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-Cu.import('resource://gre/modules/Services.jsm');</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-Cu.import('resource:///modules/cloudFileAccounts.js');</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-const kDefaultServerPort = 4444;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-const kServerRoot = &quot;http://localhost:&quot; + kDefaultServerPort;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-const kServerPath = &quot;/server&quot;;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-const kContentPath = &quot;/content&quot;;</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-const kSsoPath = &quot;/sso/authentications&quot;;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-const kSsoPingPath = &quot;/sso-ping/&quot;;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-const kServerURL = kServerRoot + kServerPath;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-const kContentURL = kServerRoot + kContentPath;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-const kSsoURL = kServerRoot + kSsoPath;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-const kSsoPingURL = kServerRoot + kSsoPingPath;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-const kVolumesPath = &quot;/volumes&quot;;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-const kDefaultConfig = {</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-  port: kDefaultServerPort</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-}</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-const kAuthToken = {</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-  token: &quot;oauth_token&quot;,</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-  token_secret: &quot;oauth_token_secret&quot;,</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-  consumer_key: &quot;oauth_consumer_key&quot;,</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-  consumer_secret: &quot;oauth_consumer_secret&quot;,</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-  description: &quot;Ubuntu One @ hostname [thunderbird]&quot;</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-};</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-const kDefaultUser = {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-  visible_name: &quot;Example User&quot;,</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-  user_id: 42,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-  root_node_path: &quot;/~/Ubuntu One&quot;,</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-  user_node_paths: [</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-    &quot;/~/.ubuntuone/Purchased from Ubuntu One&quot;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-  ],</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-  resource_path: &quot;&quot;,</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-  max_bytes: 91268055040,</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-  used_bytes: 134506915</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-};</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-const kDefaultVolume = {</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-  resource_path: &quot;/volumes/~/Thunderbird Attachments&quot;,</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-  type: &quot;udf&quot;,</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-  when_created: &quot;2012-04-09T05:32:57Z&quot;,</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-  generation: 14,</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-  path: &quot;~/Thunderbird Attachments&quot;,</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-  content_path: &quot;/content/~/Thunderbird Attachments&quot;,</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-  node_path: &quot;/~/Thunderbird Attachments&quot;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-};</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-const kDefaultFileInfo = {</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-  kind: &quot;file&quot;,</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-  resource_path: &quot;/~/Thunderbird Attachments/placeholder.txt&quot;,</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-  content_path: &quot;/content/~/Thunderbird Attachments/placeholder.txt&quot;,</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-  key: &quot;D0b30fjbSs-8oYWplbgi2A:jBK7FHshSCi8rpTRbUUkag&quot;,</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-  hash: &quot;sha1:39e9d7d7689f94b61237a0c5d642331bbec4268c&quot;,</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-  when_created: &quot;2012-04-09T10:51:30Z&quot;,</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-  when_changed: &quot;2012-04-09T10:51:31Z&quot;,</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-  size: 39452,</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-  volume_path: &quot;/volumes/~/Thunderbird Attachments&quot;,</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-  path: &quot;/placeholder.txt&quot;,</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-  parent_path: &quot;/~/Thunderbird Attachments&quot;,</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-  generation: 10,</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-  generation_created: 8,</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-  is_live: true,</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-  is_public: false,</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-};</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-const kDefaultReturnHeader = {</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-  statusCode: 200,</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-  statusString: &quot;OK&quot;,</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-  contentType: &quot;text/plain&quot;,</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-}</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineminus">-function installInto(module) {</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-  module.MockUbuntuOneServer = MockUbuntuOneServer;</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-}</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-function MockUbuntuOneServer() {}</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-MockUbuntuOneServer.prototype = {</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-  _server: null,</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-  _toDelete: [],</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-  _timers: [],</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-  getPreparedBackend: function MU1S_getPreparedBackend(aAccountKey, aDontAuth) {</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-    let emailaddress = &quot;somebody@example.org&quot;;</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-    Services.prefs.setCharPref(&quot;mail.cloud_files.accounts.&quot; + aAccountKey</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-                               + &quot;.emailaddress&quot;, emailaddress);</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-    if (!aDontAuth) {</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-      cloudFileAccounts.setSecretValue(aAccountKey, cloudFileAccounts.kTokenRealm,</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-                                       &quot;someAuthToken&quot;);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-      cloudFileAccounts.setSecretValue(aAccountKey, &quot;Ubuntu One Auth Secret&quot;,</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-                                       &quot;someAuthSecret&quot;);</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-      cloudFileAccounts.setSecretValue(aAccountKey, &quot;Ubuntu One Consumer Key&quot;,</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineminus">-                                       &quot;someConsumerKey&quot;);</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineminus">-      cloudFileAccounts.setSecretValue(aAccountKey, &quot;Ubuntu One Consumer Secret&quot;,</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-                                       &quot;someConsumerSecret&quot;);</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-    }</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineminus">-    let ubuntuone = Cc[&quot;@mozilla.org/mail/ubuntuone;1&quot;]</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-      .createInstance(Ci.nsIMsgCloudFileProvider);</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineminus">-</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineminus">-    let urls = [kServerURL, kContentURL, kSsoURL, kSsoPingURL];</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-    ubuntuone.overrideUrls(urls.length, urls);</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineminus">-    ubuntuone.init(aAccountKey);</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineminus">-    return ubuntuone;</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-  },</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-  init: function MU1S_init(aConfig) {</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineminus">-    this._config = this._overrideDefault(kDefaultConfig, aConfig);</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">-    this._server = new HttpServer();</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-    this._pathInfo = {}</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-    this._wireSso();</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-  },</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineminus">-  start: function MU1S_start() {</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineminus">-    this._server.start(this._config.port);</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-  },</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineminus">-  stop: function MU1S_stop(aController) {</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineminus">-    let allDone = false;</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-    this._server.stop(function() {</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-      allDone = true;</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineminus">-    });</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-    aController.waitFor(function () allDone,</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-                        &quot;Timed out waiting for UbuntuOne server to stop!&quot;,</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineminus">-                        10000);</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineminus">-  },</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineminus">-</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineminus">-  setupUser: function MU1S_wireUser(aData) {</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineminus">-    this._userInfo = this._overrideDefault(kDefaultUser, aData);</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-    this._server.registerPathHandler(kServerPath, this._getUserInfo.bind(this));</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineminus">-  },</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineminus">-  _getUserInfo: function MU1S__delete(aRequest, aResponse) {</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineminus">-    Services.obs.notifyObservers(null, &quot;cloudfile:user&quot;, &quot;&quot;);</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineminus">-    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineminus">-    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-    aResponse.write(JSON.stringify(this._userInfo));</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-  },</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-  planForCreateVolume: function MU1S_planForCreateVolume(aVolumeName) {</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineminus">-    let volume_info = this._overrideDefault(kDefaultVolume, {</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineminus">-      resource_path: kVolumesPath + aVolumeName,</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineminus">-      path: aVolumeName.substring(1),</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-      content_path: kContentPath + aVolumeName,</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineminus">-      node_path: aVolumeName</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineminus">-    });</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineminus">-    let putFileFunc = function(aRequest, aResponse) {</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-      if (aRequest.method != &quot;PUT&quot;) {</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-        returnError(aResponse, &quot;Volume should be created with a PUT request&quot;);</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineminus">-        return</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineminus">-      }</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineminus">-      Services.obs.notifyObservers(null, &quot;cloudfile:createvolume&quot;, aVolumeName);</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-      if (this._userInfo.user_node_paths.indexOf(aVolumeName) &lt; 0) {</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineminus">-        this._userInfo.user_node_paths.push(aVolumeName);</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">-      }</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineminus">-</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-      aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-      aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-      aResponse.write(JSON.stringify(volume_info));</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineminus">-    }.bind(this);</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineminus">-    this._server.registerPathHandler(</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineminus">-      kServerPath + kVolumesPath + encodePathForURI(aVolumeName),</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineminus">-      putFileFunc);</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineminus">-  },</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineminus">-</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineminus">-  /**</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineminus">-   * Plan to upload a file with a particular filename.</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineminus">-   *</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineminus">-   * @param aPath the path of the file that will be uploaded.</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineminus">-   * @param aMSeconds an optional argument, for how long the upload should</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineminus">-   *                  last in milliseconds.</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineminus">-   */</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineminus">-  planForUploadFile: function MU1S_planForUploadFile(aPath, aMSeconds) {</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineminus">-    let lastSlash = aPath.lastIndexOf('/');</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-    let parent = aPath.substring(0, lastSlash);</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineminus">-    let filename = aPath.substring(lastSlash);</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineminus">-    let info = this._overrideDefault(kDefaultFileInfo, {</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineminus">-      resource_path: aPath,</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineminus">-      content_path: kContentPath + aPath,</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineminus">-      volume_path: kVolumesPath + parent,</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineminus">-      path: filename,</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineminus">-      parent_path: parent,</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-    });</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-    this._pathInfo[aPath] = info;</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-    // Prepare the function that will receive the upload and respond</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-    // appropriately.</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineminus">-    let putFileFunc = function(aRequest, aResponse) {</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineminus">-      if (aRequest.method != &quot;PUT&quot;) {</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineminus">-        returnError(aResponse, &quot;Files should be created with a PUT request&quot;);</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineminus">-        return;</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineminus">-      }</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineminus">-      Services.obs.notifyObservers(null, &quot;cloudfile:uploadFile&quot;, aPath);</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineminus">-      info.size = aRequest.getHeader(&quot;Content-Length&quot;);</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineminus">-      info.is_live = true;</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineminus">-      aResponse.setStatusLine(null, 201, &quot;OK&quot;);</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-      aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineminus">-      aResponse.write(JSON.stringify(info));</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-    }.bind(this);</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineminus">-</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-    // Also prepare a function that will, if necessary, wait aMSeconds before</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-    // firing putFileFunc.</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-    let waitWrapperFunc = function(aRequest, aResponse) {</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-      Services.obs.notifyObservers(null, &quot;cloudfile:uploadStarted&quot;, aPath);</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineminus">-</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-      if (!aMSeconds) {</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-        putFileFunc(aRequest, aResponse);</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-        return;</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineminus">-      }</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineminus">-</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineminus">-      // Ok, we're waiting a bit.  Tell the HTTP server that we're going to</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineminus">-      // generate a response asynchronously, then set a timer to send the</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineminus">-      // response after aMSeconds milliseconds.</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineminus">-      aResponse.processAsync();</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineminus">-      let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-      let timerEvent = {</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-        notify: function(aTimer) {</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-          putFileFunc(aRequest, aResponse);</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-          aResponse.finish();</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineminus">-        },</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineminus">-      };</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineminus">-      timer.initWithCallback(timerEvent, aMSeconds,</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineminus">-                             Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-      // We can't let the timer get garbage collected, so we store it.</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-      this._timers.push(timer);</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineminus">-    }.bind(this);</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineminus">-    this._server.registerPathHandler(kContentPath + encodePathForURI(aPath),</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineminus">-                                     waitWrapperFunc);</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineminus">-  },</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineminus">-</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineminus">-  planForMetadataUpdate: function MU1S_planForMetadataUpdate(aPath,</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineminus">-                                                             aPublicURL) {</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineminus">-    let fileMetadataFunc = function(aRequest, aResponse) {</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-      let info = this._pathInfo[aPath];</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineminus">-      if (aRequest.method == &quot;GET&quot;) {</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineminus">-        Services.obs.notifyObservers(null, &quot;cloudfile:getMetadata&quot;, aPath);</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineminus">-      }</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineminus">-      else if (aRequest.method == &quot;PUT&quot;) {</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-        Services.obs.notifyObservers(null, &quot;cloudfile:getFileURL&quot;, aPath);</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineminus">-        let body = JSON.parse(readBody(aRequest));</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-        info.is_public = body.is_public;</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-        if (info.is_public) {</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineminus">-          info.public_url = aPublicURL;</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineminus">-        }</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-      }</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-      else if (aRequest.method == &quot;DELETE&quot;) {</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineminus">-        Services.obs.notifyObservers(null, &quot;cloudfile:deleteFile&quot;, aPath);</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-        info.is_live = false;</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineminus">-        info = &quot;&quot;;</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineminus">-      }</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineminus">-      aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineminus">-      aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineminus">-      aResponse.write(JSON.stringify(info));</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineminus">-    }.bind(this);</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineminus">-    this._server.registerPathHandler(kServerPath + encodePathForURI(aPath),</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineminus">-                                     fileMetadataFunc);</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-  },</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineminus">-</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineminus">-  _noteAndReturnString: function MU1S__noteAndReturnString(aKey, aValue,</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineminus">-                                                           aString,</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineminus">-                                                           aOptions) {</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineminus">-</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineminus">-    aOptions = this._overrideDefault(kDefaultReturnHeader, aOptions);</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineminus">-</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineminus">-    let subjectString = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineminus">-                          .createInstance(Ci.nsISupportsString);</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineminus">-    subjectString.data = aString;</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineminus">-</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineminus">-    let func = function(aMeta, aResponse) {</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineminus">-      try {</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineminus">-        aResponse.setStatusLine(null, aOptions.statusCode,</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineminus">-                                aOptions.statusString);</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineminus">-        aResponse.setHeader(&quot;Content-Type&quot;, aOptions.contentType);</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineminus">-        aResponse.write(aString);</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineminus">-        Services.obs.notifyObservers(subjectString, aKey, aValue);</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineminus">-      }</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineminus">-      catch(ex) {</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineminus">-        dump(&quot;Failed to generate server response: &quot; + ex);</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineminus">-      }</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineminus">-    }</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineminus">-    return func;</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineminus">-  },</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineminus">-</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineminus">-  _overrideDefault: function MU1S__overrideDefault(aDefault, aData) {</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineminus">-    let result = {}</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineminus">-</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineminus">-    if (aData === undefined)</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineminus">-      aData = {};</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineminus">-</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineminus">-    for (let param in aDefault) {</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineminus">-      if (param in aData)</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineminus">-        result[param] = aData[param];</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineminus">-      else</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineminus">-        result[param] = aDefault[param];</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineminus">-    }</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineminus">-    return result;</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineminus">-  },</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineminus">-</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineminus">-  _wireSso: function MU1S__wireSso() {</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineminus">-    let authFunc = this._noteAndReturnString(&quot;cloudfile:auth&quot;, &quot;&quot;,</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineminus">-                                             JSON.stringify(kAuthToken),</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineminus">-                                             {contentType: 'application/json'});</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineminus">-    this._server.registerPathHandler(kSsoPath, authFunc);</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineminus">-</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-    let pingFunc = this._noteAndReturnString(&quot;cloudfile:ping&quot;, &quot;&quot;,</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineminus">-                                             &quot;ok 1/1&quot;);</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineminus">-    this._server.registerPathHandler(kSsoPingPath, pingFunc)</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineminus">-  },</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineminus">-}</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineminus">-</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineminus">-function encodePathForURI(aStr) {</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineminus">-  return encodeURIComponent(aStr).replace(/%2F/g, '/');</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineminus">-}</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineminus">-</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineminus">-const ScriptableInputStream = Components.Constructor(</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineminus">-  &quot;@mozilla.org/scriptableinputstream;1&quot;,</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineminus">-  &quot;nsIScriptableInputStream&quot;,</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineminus">-  &quot;init&quot;);</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineminus">-</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineminus">-function readBody(aRequest) {</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineminus">-  //let body = Cc['@mozilla.org/scriptableinputstream;1']</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineminus">-  //  .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineminus">-  //body.setInputStream(aRequest.bodyInputStream);</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineminus">-  let body = new ScriptableInputStream(aRequest.bodyInputStream)</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineminus">-  return body.read(-1);</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineminus">-}</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineminus">-</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineminus">-function returnError(aResponse, aMessage) {</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineminus">-  aResponse.setStatusLine(null, 50, &quot;Server Error&quot;);</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineminus">-  aResponse.setHeader(&quot;Content-Type&quot;, &quot;text/plain&quot;);</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineminus">-  aResponse.write(aMessage);</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/themes/linux/jar.mn</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/themes/linux/jar.mn</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -261,17 +261,16 @@ classic.jar:</span>
<a href="#l15.4"></a><span id="l15.4">   skin/classic/messenger/newmailaccount/accountProvisioner.css (mail/newmailaccount/accountProvisioner.css)</span>
<a href="#l15.5"></a><span id="l15.5">   skin/classic/messenger/newmailaccount/search.gif            (mail/newmailaccount/search.gif)</span>
<a href="#l15.6"></a><span id="l15.6">   skin/classic/messenger/newmailaccount/spinner.gif           (mail/newmailaccount/spinner.gif)</span>
<a href="#l15.7"></a><span id="l15.7">   skin/classic/messenger/newmailaccount/success-addons.png    (mail/newmailaccount/success-addons.png)</span>
<a href="#l15.8"></a><span id="l15.8">   skin/classic/messenger/newmailaccount/success-border.png    (mail/newmailaccount/success-border.png)</span>
<a href="#l15.9"></a><span id="l15.9">   skin/classic/messenger/newmailaccount/success-compose.png   (mail/newmailaccount/success-compose.png)</span>
<a href="#l15.10"></a><span id="l15.10">   skin/classic/messenger/newmailaccount/success-signature.png (mail/newmailaccount/success-signature.png)</span>
<a href="#l15.11"></a><span id="l15.11">   skin/classic/messenger/newmailaccount/search.png            (mail/newmailaccount/search.png)</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  skin/classic/messenger/icons/ubuntuone.png                  (mail/icons/ubuntuone.png)</span>
<a href="#l15.13"></a><span id="l15.13">   skin/classic/messenger/icons/hightail.png                   (mail/icons/hightail.png)</span>
<a href="#l15.14"></a><span id="l15.14">   skin/classic/messenger/sanitizeDialog.css                   (mail/sanitizeDialog.css)</span>
<a href="#l15.15"></a><span id="l15.15">   skin/classic/messenger/icons/box-logo.png                   (mail/icons/box-logo.png)</span>
<a href="#l15.16"></a><span id="l15.16">   skin/classic/messenger/sharedPlatform.css                   (mail/linuxShared.css)</span>
<a href="#l15.17"></a><span id="l15.17">   skin/classic/messenger/shared/mailWindow1.css               (../shared/mail/mailWindow1.css)</span>
<a href="#l15.18"></a><span id="l15.18">   skin/classic/messenger/shared/messenger.css                 (../shared/mail/messenger.css)</span>
<a href="#l15.19"></a><span id="l15.19">   skin/classic/messenger/shared/messageHeader.css             (../shared/mail/messageHeader.css)</span>
<a href="#l15.20"></a><span id="l15.20">   skin/classic/messenger/shared/tabmail.css                   (../shared/mail/tabmail.css)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2">index bb61a6debea27e6d0f923a0ff8b34ca86e5a5421..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l16.3"></a><span id="l16.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/themes/osx/jar.mn</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/themes/osx/jar.mn</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -334,17 +334,16 @@ classic.jar:</span>
<a href="#l17.4"></a><span id="l17.4">   skin/classic/messenger/newmailaccount/accountProvisioner.css   (mail/newmailaccount/accountProvisioner.css)</span>
<a href="#l17.5"></a><span id="l17.5">   skin/classic/messenger/newmailaccount/search.gif               (mail/newmailaccount/search.gif)</span>
<a href="#l17.6"></a><span id="l17.6">   skin/classic/messenger/newmailaccount/spinner.gif              (mail/newmailaccount/spinner.gif)</span>
<a href="#l17.7"></a><span id="l17.7">   skin/classic/messenger/newmailaccount/success-addons.png       (mail/newmailaccount/success-addons.png)</span>
<a href="#l17.8"></a><span id="l17.8">   skin/classic/messenger/newmailaccount/success-border.png       (mail/newmailaccount/success-border.png)</span>
<a href="#l17.9"></a><span id="l17.9">   skin/classic/messenger/newmailaccount/success-compose.png      (mail/newmailaccount/success-compose.png)</span>
<a href="#l17.10"></a><span id="l17.10">   skin/classic/messenger/newmailaccount/success-signature.png    (mail/newmailaccount/success-signature.png)</span>
<a href="#l17.11"></a><span id="l17.11">   skin/classic/messenger/newmailaccount/search.png               (mail/newmailaccount/search.png)</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  skin/classic/messenger/icons/ubuntuone.png                     (mail/icons/ubuntuone.png)</span>
<a href="#l17.13"></a><span id="l17.13">   skin/classic/messenger/icons/hightail.png                      (mail/icons/hightail.png)</span>
<a href="#l17.14"></a><span id="l17.14">   skin/classic/messenger/icons/expander-closed.png               (mail/icons/expander-closed.png)</span>
<a href="#l17.15"></a><span id="l17.15">   skin/classic/messenger/icons/expander-closed-active.png        (mail/icons/expander-closed-active.png)</span>
<a href="#l17.16"></a><span id="l17.16">   skin/classic/messenger/icons/expander-open.png                 (mail/icons/expander-open.png)</span>
<a href="#l17.17"></a><span id="l17.17">   skin/classic/messenger/icons/expander-open-active.png          (mail/icons/expander-open-active.png)</span>
<a href="#l17.18"></a><span id="l17.18">   skin/classic/messenger/sanitizeDialog.css                      (mail/sanitizeDialog.css)</span>
<a href="#l17.19"></a><span id="l17.19">   skin/classic/messenger/icons/box-logo.png                      (mail/icons/box-logo.png)</span>
<a href="#l17.20"></a><span id="l17.20">   skin/classic/messenger/sharedPlatform.css                      (mail/osxShared.css)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">deleted file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2">index bb61a6debea27e6d0f923a0ff8b34ca86e5a5421..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l18.3"></a><span id="l18.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/themes/windows/jar.mn</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/themes/windows/jar.mn</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -279,17 +279,16 @@ classic.jar:</span>
<a href="#l19.4"></a><span id="l19.4">   skin/classic/messenger/newmailaccount/search.gif            (mail/newmailaccount/search.gif)</span>
<a href="#l19.5"></a><span id="l19.5">   skin/classic/messenger/newmailaccount/spinner.gif           (mail/newmailaccount/spinner.gif)</span>
<a href="#l19.6"></a><span id="l19.6">   skin/classic/messenger/newmailaccount/success-addons.png    (mail/newmailaccount/success-addons.png)</span>
<a href="#l19.7"></a><span id="l19.7">   skin/classic/messenger/newmailaccount/success-border.png    (mail/newmailaccount/success-border.png)</span>
<a href="#l19.8"></a><span id="l19.8">   skin/classic/messenger/newmailaccount/success-compose.png   (mail/newmailaccount/success-compose.png)</span>
<a href="#l19.9"></a><span id="l19.9">   skin/classic/messenger/newmailaccount/success-signature.png (mail/newmailaccount/success-signature.png)</span>
<a href="#l19.10"></a><span id="l19.10">   skin/classic/messenger/newmailaccount/search.png            (mail/newmailaccount/search.png)</span>
<a href="#l19.11"></a><span id="l19.11">   skin/classic/messenger/sanitizeDialog.css                   (mail/sanitizeDialog.css)</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  skin/classic/messenger/icons/ubuntuone.png                  (mail/icons/ubuntuone.png)</span>
<a href="#l19.13"></a><span id="l19.13">   skin/classic/messenger/icons/hightail.png                   (mail/icons/hightail.png)</span>
<a href="#l19.14"></a><span id="l19.14">   skin/classic/messenger/icons/box-logo.png                   (mail/icons/box-logo.png)</span>
<a href="#l19.15"></a><span id="l19.15">   skin/classic/messenger/sharedPlatform.css                   (mail/windowsShared.css)</span>
<a href="#l19.16"></a><span id="l19.16">   skin/classic/messenger/shared/mailWindow1.css               (../shared/mail/mailWindow1.css)</span>
<a href="#l19.17"></a><span id="l19.17">   skin/classic/messenger/shared/messenger.css                 (../shared/mail/messenger.css)</span>
<a href="#l19.18"></a><span id="l19.18">   skin/classic/messenger/shared/messageHeader.css             (../shared/mail/messageHeader.css)</span>
<a href="#l19.19"></a><span id="l19.19">   skin/classic/messenger/shared/tabmail.css                   (../shared/mail/tabmail.css)</span>
<a href="#l19.20"></a><span id="l19.20"> #ifdef XP_WIN</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineat">@@ -557,17 +556,16 @@ classic.jar:</span>
<a href="#l19.22"></a><span id="l19.22">   skin/classic/aero/messenger/newmailaccount/accountProvisioner.css (mail/newmailaccount/accountProvisioner-aero.css)</span>
<a href="#l19.23"></a><span id="l19.23">   skin/classic/aero/messenger/newmailaccount/search.gif            (mail/newmailaccount/search.gif)</span>
<a href="#l19.24"></a><span id="l19.24">   skin/classic/aero/messenger/newmailaccount/spinner.gif           (mail/newmailaccount/spinner.gif)</span>
<a href="#l19.25"></a><span id="l19.25">   skin/classic/aero/messenger/newmailaccount/success-addons.png    (mail/newmailaccount/success-addons.png)</span>
<a href="#l19.26"></a><span id="l19.26">   skin/classic/aero/messenger/newmailaccount/success-border.png    (mail/newmailaccount/success-border.png)</span>
<a href="#l19.27"></a><span id="l19.27">   skin/classic/aero/messenger/newmailaccount/success-compose.png   (mail/newmailaccount/success-compose.png)</span>
<a href="#l19.28"></a><span id="l19.28">   skin/classic/aero/messenger/newmailaccount/success-signature.png (mail/newmailaccount/success-signature.png)</span>
<a href="#l19.29"></a><span id="l19.29">   skin/classic/aero/messenger/newmailaccount/search.png            (mail/newmailaccount/search.png)</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-  skin/classic/aero/messenger/icons/ubuntuone.png                  (mail/icons/ubuntuone.png)</span>
<a href="#l19.31"></a><span id="l19.31">   skin/classic/aero/messenger/icons/hightail.png                   (mail/icons/hightail.png)</span>
<a href="#l19.32"></a><span id="l19.32">   skin/classic/aero/messenger/sanitizeDialog.css                   (mail/sanitizeDialog.css)</span>
<a href="#l19.33"></a><span id="l19.33">   skin/classic/aero/messenger/icons/box-logo.png                   (mail/icons/box-logo.png)</span>
<a href="#l19.34"></a><span id="l19.34">   skin/classic/aero/messenger/sharedPlatform.css                   (mail/windowsShared.css)</span>
<a href="#l19.35"></a><span id="l19.35">   skin/classic/aero/messenger/shared/mailWindow1.css               (../shared/mail/mailWindow1.css)</span>
<a href="#l19.36"></a><span id="l19.36">   skin/classic/aero/messenger/shared/messenger.css                 (../shared/mail/messenger.css)</span>
<a href="#l19.37"></a><span id="l19.37">   skin/classic/aero/messenger/shared/messageHeader.css             (../shared/mail/messageHeader.css)</span>
<a href="#l19.38"></a><span id="l19.38">   skin/classic/aero/messenger/shared/tabmail.css                   (../shared/mail/tabmail.css)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">deleted file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2">index bb61a6debea27e6d0f923a0ff8b34ca86e5a5421..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l20.3"></a><span id="l20.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

