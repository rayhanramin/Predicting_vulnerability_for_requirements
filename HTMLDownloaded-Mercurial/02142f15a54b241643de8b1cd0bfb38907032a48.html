<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25880:02142f15a54b241643de8b1cd0bfb38907032a48</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 02142f15a54b241643de8b1cd0bfb38907032a48" />
<meta property="og:url" content="/comm-central/rev/02142f15a54b241643de8b1cd0bfb38907032a48" />
<meta property="og:description" content="Bug 1518656 - Lint JSBridge extension; r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 02142f15a54b241643de8b1cd0bfb38907032a48 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/02142f15a54b241643de8b1cd0bfb38907032a48">shortlog</a> |
<a href="/comm-central/log/02142f15a54b241643de8b1cd0bfb38907032a48">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/02142f15a54b241643de8b1cd0bfb38907032a48">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/02142f15a54b241643de8b1cd0bfb38907032a48">files</a> |
changeset |
<a href="/comm-central/raw-rev/02142f15a54b241643de8b1cd0bfb38907032a48">raw</a>  | <a href="/comm-central/archive/02142f15a54b241643de8b1cd0bfb38907032a48.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518656">Bug 1518656</a> - Lint JSBridge extension; r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 18 Feb 2019 15:30:40 +1300</td></tr>

<tr>
 <td>changeset 25880</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/02142f15a54b241643de8b1cd0bfb38907032a48">02142f15a54b241643de8b1cd0bfb38907032a48</a></td>
</tr>



<tr>
<td>parent 25879</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2">e8578ad1d60bf7956d6623058e3a857cb7a8e6a2</a>
</td>
</tr>

<tr>
<td>child 25881</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8dbf6b5932f323d2262ece8b608bc3961ed9b264">8dbf6b5932f323d2262ece8b608bc3961ed9b264</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=02142f15a54b241643de8b1cd0bfb38907032a48">15523</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 18 Feb 2019 02:31:36 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8dbf6b5932f3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8dbf6b5932f323d2262ece8b608bc3961ed9b264">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8dbf6b5932f323d2262ece8b608bc3961ed9b264&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8dbf6b5932f323d2262ece8b608bc3961ed9b264&newProject=comm-central&newRevision=59888b1b19fbd67946637b9ef00baf750e2647fa&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8dbf6b5932f323d2262ece8b608bc3961ed9b264&newProject=comm-central&newRevision=59888b1b19fbd67946637b9ef00baf750e2647fa&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8dbf6b5932f323d2262ece8b608bc3961ed9b264&newProject=comm-central&newRevision=59888b1b19fbd67946637b9ef00baf750e2647fa&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518656">1518656</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518656">Bug 1518656</a> - Lint JSBridge extension; r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/bootstrap.js">mail/test/resources/jsbridge/jsbridge/extension/bootstrap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/bootstrap.js">file</a> |
<a href="/comm-central/annotate/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/bootstrap.js">annotate</a> |
<a href="/comm-central/diff/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/bootstrap.js">diff</a> |
<a href="/comm-central/comparison/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/bootstrap.js">comparison</a> |
<a href="/comm-central/log/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/bootstrap.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/events.js">mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/events.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/events.js">file</a> |
<a href="/comm-central/annotate/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/events.js">annotate</a> |
<a href="/comm-central/diff/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/events.js">diff</a> |
<a href="/comm-central/comparison/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/events.js">comparison</a> |
<a href="/comm-central/log/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/events.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/json2.js">mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/json2.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/json2.js">diff</a> |
<a href="/comm-central/comparison/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/json2.js">comparison</a> |
<a href="/comm-central/log/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/json2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/server.js">mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/server.js">file</a> |
<a href="/comm-central/annotate/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/server.js">annotate</a> |
<a href="/comm-central/diff/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/server.js">diff</a> |
<a href="/comm-central/comparison/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/server.js">comparison</a> |
<a href="/comm-central/log/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/server.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/overlay.js">mail/test/resources/jsbridge/jsbridge/extension/chrome/content/overlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/overlay.js">file</a> |
<a href="/comm-central/annotate/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/overlay.js">annotate</a> |
<a href="/comm-central/diff/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/overlay.js">diff</a> |
<a href="/comm-central/comparison/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/overlay.js">comparison</a> |
<a href="/comm-central/log/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/overlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/components/cmdarg.js">mail/test/resources/jsbridge/jsbridge/extension/components/cmdarg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/components/cmdarg.js">file</a> |
<a href="/comm-central/annotate/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/components/cmdarg.js">annotate</a> |
<a href="/comm-central/diff/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/components/cmdarg.js">diff</a> |
<a href="/comm-central/comparison/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/components/cmdarg.js">comparison</a> |
<a href="/comm-central/log/02142f15a54b241643de8b1cd0bfb38907032a48/mail/test/resources/jsbridge/jsbridge/extension/components/cmdarg.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/test/resources/jsbridge/jsbridge/extension/bootstrap.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/test/resources/jsbridge/jsbridge/extension/bootstrap.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -9,47 +9,40 @@ var {ExtensionSupport} = ChromeUtils.imp</span>
<a href="#l1.4"></a><span id="l1.4"> var addonID;</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> function install() {}</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> function uninstall() {}</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> function startup(data, reason) {</span>
<a href="#l1.11"></a><span id="l1.11">   addonID = data.id;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  ExtensionSupport.registerWindowListener(</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    addonID,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    {</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-      chromeURLs: [ &quot;chrome://messenger/content/messenger.xul&quot; ],</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-      onLoadWindow: setupServer</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-    });</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+  ExtensionSupport.registerWindowListener(addonID, {</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    chromeURLs: [&quot;chrome://messenger/content/messenger.xul&quot;],</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    onLoadWindow: setupServer,</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+  });</span>
<a href="#l1.22"></a><span id="l1.22"> }</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24"> function shutdown(data, reason) {</span>
<a href="#l1.25"></a><span id="l1.25">   // This should have already been unregistered in setupServer().</span>
<a href="#l1.26"></a><span id="l1.26">   // We do it again, just in case something went wrong.</span>
<a href="#l1.27"></a><span id="l1.27">   ExtensionSupport.unregisterWindowListener(data.id);</span>
<a href="#l1.28"></a><span id="l1.28"> }</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30"> function setupServer(domWindow) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  loadScript(&quot;chrome://jsbridge/content/overlay.js&quot;, domWindow);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  Services.scriptloader.loadSubScript(&quot;chrome://jsbridge/content/overlay.js&quot;, domWindow);</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34">   // The server used to be started via the command line (cmdarg.js) which</span>
<a href="#l1.35"></a><span id="l1.35">   // doesn't work for a bootstrapped add-on, so let's do it here.</span>
<a href="#l1.36"></a><span id="l1.36">   let server = {};</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  ChromeUtils.import('chrome://jsbridge/content/modules/server.js', server);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  ChromeUtils.import(&quot;chrome://jsbridge/content/modules/server.js&quot;, server);</span>
<a href="#l1.39"></a><span id="l1.39">   console.log(&quot;=== JS Bridge: Starting server&quot;);</span>
<a href="#l1.40"></a><span id="l1.40">   server.startServer(24242);</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">   // We only needed to start the server once, so unregister the listener.</span>
<a href="#l1.43"></a><span id="l1.43">   ExtensionSupport.unregisterWindowListener(addonID);</span>
<a href="#l1.44"></a><span id="l1.44"> }</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-function loadScript(url, targetWindow) {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-  let loader = Cc[&quot;@mozilla.org/moz/jssubscript-loader;1&quot;].getService(Ci.mozIJSSubScriptLoader);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-  loader.loadSubScript(url, targetWindow);</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-}</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-</span>
<a href="#l1.51"></a><span id="l1.51"> function logException(exc) {</span>
<a href="#l1.52"></a><span id="l1.52">   try {</span>
<a href="#l1.53"></a><span id="l1.53">     Services.console.logStringMessage(exc.toString() + &quot;\n&quot; + exc.stack);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+  } catch (x) {</span>
<a href="#l1.55"></a><span id="l1.55">   }</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-  catch (x) {}</span>
<a href="#l1.57"></a><span id="l1.57"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/events.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/events.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,13 +1,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> var EXPORTED_SYMBOLS = [&quot;backchannels&quot;, &quot;fireEvent&quot;, &quot;addBackChannel&quot;];</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> var backchannels = [];</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8" class="difflineminus">-var fireEvent = function (name, obj) {</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+function fireEvent(name, obj) {</span>
<a href="#l2.10"></a><span id="l2.10">   for (let backchannel of backchannels) {</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">-    backchannel.session.encodeOut({'eventType':name, 'result':obj});</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    backchannel.session.encodeOut({</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      eventType: name,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+      result: obj,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    });</span>
<a href="#l2.16"></a><span id="l2.16">   }</span>
<a href="#l2.17"></a><span id="l2.17"> }</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-var addBackChannel = function (backchannel) {</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-    backchannels.push(backchannel);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+function addBackChannel(backchannel) {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+  backchannels.push(backchannel);</span>
<a href="#l2.23"></a><span id="l2.23"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/json2.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,473 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-/*</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-    http://www.JSON.org/json2.js</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">-    2008-05-25</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-    Public Domain.</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-    NO WARRANTY EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    See http://www.JSON.org/js.html</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    This file creates a global JSON object containing two methods: stringify</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-    and parse.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-        JSON.stringify(value, replacer, space)</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-            value       any JavaScript value, usually an object or array.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-            replacer    an optional parameter that determines how object</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-                        values are stringified for objects without a toJSON</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-                        method. It can be a function or an array.</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-            space       an optional parameter that specifies the indentation</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-                        of nested structures. If it is omitted, the text will</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-                        be packed without extra whitespace. If it is a number,</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-                        it will specify the number of spaces to indent at each</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-                        level. If it is a string (such as '\t' or '&amp;nbsp;'),</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-                        it contains the characters used to indent at each level.</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-            This method produces a JSON text from a JavaScript value.</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-            When an object value is found, if the object contains a toJSON</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-            method, its toJSON method will be called and the result will be</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-            stringified. A toJSON method does not serialize: it returns the</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-            value represented by the name/value pair that should be serialized,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-            or undefined if nothing should be serialized. The toJSON method</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-            will be passed the key associated with the value, and this will be</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-            bound to the object holding the key.</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-            For example, this would serialize Dates as ISO strings.</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-                Date.prototype.toJSON = function (key) {</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-                    function f(n) {</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-                        // Format integers to have at least two digits.</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-                        return n &lt; 10 ? '0' + n : n;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-                    }</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-                    return this.getUTCFullYear()   + '-' +</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-                         f(this.getUTCMonth() + 1) + '-' +</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-                         f(this.getUTCDate())      + 'T' +</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-                         f(this.getUTCHours())     + ':' +</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-                         f(this.getUTCMinutes())   + ':' +</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-                         f(this.getUTCSeconds())   + 'Z';</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-                };</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-            You can provide an optional replacer method. It will be passed the</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-            key and value of each member, with this bound to the containing</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-            object. The value that is returned from your method will be</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-            serialized. If your method returns undefined, then the member will</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-            be excluded from the serialization.</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-            If the replacer parameter is an array, then it will be used to</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-            select the members to be serialized. It filters the results such</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-            that only members with keys listed in the replacer array are</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-            stringified.</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-            Values that do not have JSON representations, such as undefined or</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-            functions, will not be serialized. Such values in objects will be</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-            dropped; in arrays they will be replaced with null. You can use</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-            a replacer function to replace those with JSON values.</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-            JSON.stringify(undefined) returns undefined.</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-            The optional space parameter produces a stringification of the</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-            value that is filled with line breaks and indentation to make it</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-            easier to read.</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-            If the space parameter is a non-empty string, then that string will</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-            be used for indentation. If the space parameter is a number, then</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-            the indentation will be that many spaces.</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-            Example:</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-            text = JSON.stringify(['e', {pluribus: 'unum'}]);</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-            // text is '[&quot;e&quot;,{&quot;pluribus&quot;:&quot;unum&quot;}]'</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-            text = JSON.stringify(['e', {pluribus: 'unum'}], null, '\t');</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-            // text is '[\n\t&quot;e&quot;,\n\t{\n\t\t&quot;pluribus&quot;: &quot;unum&quot;\n\t}\n]'</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-            text = JSON.stringify([new Date()], function (key, value) {</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-                return this[key] instanceof Date ?</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-                    'Date(' + this[key] + ')' : value;</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-            });</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-            // text is '[&quot;Date(---current time---)&quot;]'</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-        JSON.parse(text, reviver)</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-            This method parses a JSON text to produce an object or array.</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-            It can throw a SyntaxError exception.</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-            The optional reviver parameter is a function that can filter and</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-            transform the results. It receives each of the keys and values,</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-            and its return value is used instead of the original value.</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-            If it returns what it received, then the structure is not modified.</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-            If it returns undefined then the member is deleted.</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-            Example:</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-            // Parse the text. Values that look like ISO date strings will</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-            // be converted to Date objects.</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-            myData = JSON.parse(text, function (key, value) {</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-                var a;</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-                if (typeof value === 'string') {</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-                    a =</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(value);</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-                    if (a) {</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-                        return new Date(Date.UTC(+a[1], +a[2] - 1, +a[3], +a[4],</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-                            +a[5], +a[6]));</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-                    }</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-                }</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-                return value;</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-            });</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-            myData = JSON.parse('[&quot;Date(09/09/2001)&quot;]', function (key, value) {</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-                var d;</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-                if (typeof value === 'string' &amp;&amp;</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-                        value.slice(0, 5) === 'Date(' &amp;&amp;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-                        value.slice(-1) === ')') {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-                    d = new Date(value.slice(5, -1));</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-                    if (d) {</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-                        return d;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-                    }</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-                }</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-                return value;</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-            });</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-    This is a reference implementation. You are free to copy, modify, or</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-    redistribute.</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-    This code should be minified before deployment.</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-    See http://javascript.crockford.com/jsmin.html</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-    USE YOUR OWN COPY. IT IS EXTREMELY UNWISE TO LOAD CODE FROM SERVERS YOU DO</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-    NOT CONTROL.</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-*/</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-/*jslint evil: true */</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-/*global JSON */</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-/*members &quot;&quot;, &quot;\b&quot;, &quot;\t&quot;, &quot;\n&quot;, &quot;\f&quot;, &quot;\r&quot;, &quot;\&quot;&quot;, JSON, &quot;\\&quot;, call,</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-    charCodeAt, getUTCDate, getUTCFullYear, getUTCHours, getUTCMinutes,</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-    getUTCMonth, getUTCSeconds, hasOwnProperty, join, lastIndex, length,</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-    parse, propertyIsEnumerable, prototype, push, replace, slice, stringify,</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-    test, toJSON, toString</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-*/</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;JSON&quot;];</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-var JSON = Cu.getGlobalForObject(this).JSON;</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-if (!JSON) {</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-  dump(&quot;jsbridge/extension/resource/modules/json2.js: creating JSON object\n&quot;);</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-// Create a JSON object only if one does not already exist. We create the</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-// object in a closure to avoid creating global variables.</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-    JSON = function () {</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-        function f(n) {</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-            // Format integers to have at least two digits.</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-            return n &lt; 10 ? '0' + n : n;</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-        }</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-        Date.prototype.toJSON = function (key) {</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-            return this.getUTCFullYear()   + '-' +</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-                 f(this.getUTCMonth() + 1) + '-' +</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-                 f(this.getUTCDate())      + 'T' +</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-                 f(this.getUTCHours())     + ':' +</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-                 f(this.getUTCMinutes())   + ':' +</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-                 f(this.getUTCSeconds())   + 'Z';</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-        };</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-        var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-            escapeable = /[\\\&quot;\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-            gap,</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-            indent,</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-            meta = {    // table of character substitutions</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-                '\b': '\\b',</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-                '\t': '\\t',</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-                '\n': '\\n',</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-                '\f': '\\f',</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-                '\r': '\\r',</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-                '&quot;' : '\\&quot;',</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-                '\\': '\\\\'</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-            },</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-            rep;</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-        function quote(string) {</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-// If the string contains no control characters, no quote characters, and no</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-// backslash characters, then we can safely slap some quotes around it.</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-// Otherwise we must also replace the offending characters with safe escape</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-// sequences.</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-            escapeable.lastIndex = 0;</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-            return escapeable.test(string) ?</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-                '&quot;' + string.replace(escapeable, function (a) {</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-                    var c = meta[a];</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-                    if (typeof c === 'string') {</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-                        return c;</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-                    }</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-                    return '\\u' + ('0000' +</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-                            (+(a.charCodeAt(0))).toString(16)).slice(-4);</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-                }) + '&quot;' :</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-                '&quot;' + string + '&quot;';</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-        }</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-        function str(key, holder) {</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-// Produce a string from holder[key].</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-            var i,          // The loop counter.</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-                k,          // The member key.</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-                v,          // The member value.</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-                length,</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-                mind = gap,</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-                partial,</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-                value = holder[key];</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-// If the value has a toJSON method, call it to obtain a replacement value.</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-            if (value &amp;&amp; typeof value === 'object' &amp;&amp;</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-                    typeof value.toJSON === 'function') {</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-                value = value.toJSON(key);</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-            }</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-// If we were called with a replacer function, then call the replacer to</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-// obtain a replacement value.</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-            if (typeof rep === 'function') {</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-                value = rep.call(holder, key, value);</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-            }</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-// What happens next depends on the value's type.</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-            switch (typeof value) {</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-            case 'string':</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-                return quote(value);</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-            case 'number':</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-// JSON numbers must be finite. Encode non-finite numbers as null.</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-                return isFinite(value) ? String(value) : 'null';</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-            case 'boolean':</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-            case 'null':</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-// If the value is a boolean or null, convert it to a string. Note:</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-// typeof null does not produce 'null'. The case is included here in</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-// the remote chance that this gets fixed someday.</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-                return String(value);</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-// If the type is 'object', we might be dealing with an object or an array or</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-// null.</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-            case 'object':</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-// Due to a specification blunder in ECMAScript, typeof null is 'object',</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-// so watch out for that case.</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-                if (!value) {</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-                    return 'null';</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-                }</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-// Make an array to hold the partial results of stringifying this object value.</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-                gap += indent;</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-                partial = [];</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-// If the object has a dontEnum length property, we'll treat it as an array.</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-                if (typeof value.length === 'number' &amp;&amp;</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-                        !(value.propertyIsEnumerable('length'))) {</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-// The object is an array. Stringify every element. Use null as a placeholder</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-// for non-JSON values.</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-                    length = value.length;</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-                    for (i = 0; i &lt; length; i += 1) {</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-                        partial[i] = str(i, value) || 'null';</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-                    }</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-// Join all of the elements together, separated with commas, and wrap them in</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-// brackets.</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-                    v = partial.length === 0 ? '[]' :</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-                        gap ? '[\n' + gap +</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-                                partial.join(',\n' + gap) + '\n' +</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-                                    mind + ']' :</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-                              '[' + partial.join(',') + ']';</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-                    gap = mind;</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-                    return v;</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-                }</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-// If the replacer is an array, use it to select the members to be stringified.</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-                if (rep &amp;&amp; typeof rep === 'object') {</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-                    length = rep.length;</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-                    for (i = 0; i &lt; length; i += 1) {</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-                        k = rep[i];</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-                        if (typeof k === 'string') {</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-                            v = str(k, value, rep);</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-                            if (v) {</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-                                partial.push(quote(k) + (gap ? ': ' : ':') + v);</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-                            }</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-                        }</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-                    }</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-                } else {</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-// Otherwise, iterate through all of the keys in the object.</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-                    for (k in value) {</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-                        if (Object.hasOwnProperty.call(value, k)) {</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-                            v = str(k, value, rep);</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-                            if (v) {</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-                                partial.push(quote(k) + (gap ? ': ' : ':') + v);</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-                            }</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-                        }</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-                    }</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineminus">-                }</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-// Join all of the member texts together, separated with commas,</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-// and wrap them in braces.</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-                v = partial.length === 0 ? '{}' :</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-                    gap ? '{\n' + gap + partial.join(',\n' + gap) + '\n' +</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-                            mind + '}' : '{' + partial.join(',') + '}';</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-                gap = mind;</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-                return v;</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-            }</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-        }</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-// Return the JSON object containing the stringify and parse methods.</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-        return {</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-            stringify: function (value, replacer, space) {</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-// The stringify method takes a value and an optional replacer, and an optional</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">-// space parameter, and returns a JSON text. The replacer can be a function</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-// that can replace values, or an array of strings that will select the keys.</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-// A default replacer method can be provided. Use of the space parameter can</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-// produce text that is more easily readable.</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-                var i;</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-                gap = '';</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-                indent = '';</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-// If the space parameter is a number, make an indent string containing that</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-// many spaces.</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-                if (typeof space === 'number') {</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineminus">-                    for (i = 0; i &lt; space; i += 1) {</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineminus">-                        indent += ' ';</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">-                    }</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineminus">-</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-// If the space parameter is a string, it will be used as the indent string.</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-                } else if (typeof space === 'string') {</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-                    indent = space;</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-                }</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-// If there is a replacer, it must be a function or an array.</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-// Otherwise, throw an error.</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-                rep = replacer;</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-                if (replacer &amp;&amp; typeof replacer !== 'function' &amp;&amp;</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-                        (typeof replacer !== 'object' ||</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-                         typeof replacer.length !== 'number')) {</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-                    throw new Error('JSON.stringify');</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-                }</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-// Make a fake root object containing our value under the key of ''.</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineminus">-// Return the result of stringifying the value.</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-                return str('', {'': value});</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-            },</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-            parse: function (text, reviver) {</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-// The parse method takes a text and an optional reviver function, and returns</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-// a JavaScript value if the text is a valid JSON text.</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-                var j;</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-                function walk(holder, key) {</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-// The walk method is used to recursively walk the resulting structure so</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-// that modifications can be made.</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-                    var k, v, value = holder[key];</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-                    if (value &amp;&amp; typeof value === 'object') {</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-                        for (k in value) {</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-                            if (Object.hasOwnProperty.call(value, k)) {</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-                                v = walk(value, k);</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-                                if (v !== undefined) {</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-                                    value[k] = v;</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-                                } else {</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-                                    delete value[k];</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-                                }</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-                            }</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-                        }</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-                    }</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-                    return reviver.call(holder, key, value);</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-                }</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-// Parsing happens in four stages. In the first stage, we replace certain</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-// Unicode characters with escape sequences. JavaScript handles many characters</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-// incorrectly, either silently deleting them, or treating them as line endings.</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineminus">-</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-                cx.lastIndex = 0;</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-                if (cx.test(text)) {</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-                    text = text.replace(cx, function (a) {</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-                        return '\\u' + ('0000' +</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-                                (+(a.charCodeAt(0))).toString(16)).slice(-4);</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-                    });</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-                }</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-// In the second stage, we run the text against regular expressions that look</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineminus">-// for non-JSON patterns. We are especially concerned with '()' and 'new'</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-// because they can cause invocation, and '=' because it can cause mutation.</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-// But just to be safe, we want to reject all unexpected forms.</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-// We split the second stage into 4 regexp operations in order to work around</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-// crippling inefficiencies in IE's and Safari's regexp engines. First we</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-// replace the JSON backslash pairs with '@' (a non-JSON character). Second, we</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-// replace all simple value tokens with ']' characters. Third, we delete all</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-// open brackets that follow a colon or comma or that begin the text. Finally,</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-// we look to see that the remaining characters are only whitespace or ']' or</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-// ',' or ':' or '{' or '}'. If that is so, then the text is safe for eval.</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-                if (/^[\],:{}\s]*$/.</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-test(text.replace(/\\(?:[&quot;\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@').</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-replace(/&quot;[^&quot;\\\n\r]*&quot;|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']').</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) {</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-// In the third stage we use the eval function to compile the text into a</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-// JavaScript structure. The '{' operator is subject to a syntactic ambiguity</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-// in JavaScript: it can begin a block or an object literal. We wrap the text</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-// in parens to eliminate the ambiguity.</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">-</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-                    j = eval('(' + text + ')');</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-// In the optional fourth stage, we recursively walk the new structure, passing</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-// each name/value pair to a reviver function for possible transformation.</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-                    return typeof reviver === 'function' ?</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-                        walk({'': j}, '') : j;</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-                }</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-// If the text is not JSON parseable, then a SyntaxError is thrown.</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-                throw new SyntaxError('JSON.parse');</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-            }</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-        };</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-    }();</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/server.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/modules/server.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -33,45 +33,37 @@</span>
<a href="#l4.4"></a><span id="l4.4"> // and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.5"></a><span id="l4.5"> // the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.6"></a><span id="l4.6"> // the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.7"></a><span id="l4.7"> //</span>
<a href="#l4.8"></a><span id="l4.8"> // ***** END LICENSE BLOCK *****</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> var EXPORTED_SYMBOLS = [&quot;Server&quot;, &quot;server&quot;, &quot;AsyncRead&quot;, &quot;Session&quot;, &quot;sessions&quot;, &quot;globalRegistry&quot;, &quot;startServer&quot;];</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14"> var events = ChromeUtils.import(&quot;chrome://jsbridge/content/modules/events.js&quot;);</span>
<a href="#l4.15"></a><span id="l4.15"> var DEBUG_ON = false;</span>
<a href="#l4.16"></a><span id="l4.16"> var BUFFER_SIZE = 1024;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-var loader = Cc['@mozilla.org/moz/jssubscript-loader;1']</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-    .getService(Ci.mozIJSSubScriptLoader);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-var hwindow = Cc[&quot;@mozilla.org/appshell/appShellService;1&quot;]</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-    .getService(Ci.nsIAppShellService)</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-    .hiddenDOMWindow;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+var hwindow = Services.appShell.hiddenDOMWindow;</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-var json2 = ChromeUtils.import(&quot;chrome://jsbridge/content/modules/json2.js&quot;);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-var jsonEncode = json2.JSON.stringify;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+var uuidgen = Cc[&quot;@mozilla.org/uuid-generator;1&quot;].getService(Ci.nsIUUIDGenerator);</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-var uuidgen = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-                .getService(Ci.nsIUUIDGenerator);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-function AsyncRead (session) {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+function AsyncRead(session) {</span>
<a href="#l4.35"></a><span id="l4.35">   this.session = session;</span>
<a href="#l4.36"></a><span id="l4.36"> }</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-AsyncRead.prototype.onStartRequest = function (request, context) {};</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-AsyncRead.prototype.onStopRequest = function (request, context, status) {</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+AsyncRead.prototype.onStartRequest = function(request, context) {};</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+AsyncRead.prototype.onStopRequest = function(request, context, status) {</span>
<a href="#l4.42"></a><span id="l4.42">   log(&quot;async onstoprequest: onstoprequest&quot;);</span>
<a href="#l4.43"></a><span id="l4.43">   this.session.onQuit();</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-}</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-AsyncRead.prototype.onDataAvailable = function (request, context, inputStream, offset, count) {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+};</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+AsyncRead.prototype.onDataAvailable = function(request, context, inputStream, offset, count) {</span>
<a href="#l4.48"></a><span id="l4.48">   var str = {};</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-  str.value = '';</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  str.value = &quot;&quot;;</span>
<a href="#l4.51"></a><span id="l4.51"> </span>
<a href="#l4.52"></a><span id="l4.52">   var bytesAvail = 0;</span>
<a href="#l4.53"></a><span id="l4.53">   do {</span>
<a href="#l4.54"></a><span id="l4.54">     var parts = {};</span>
<a href="#l4.55"></a><span id="l4.55">     if (count &gt; BUFFER_SIZE) {</span>
<a href="#l4.56"></a><span id="l4.56">       bytesAvail = BUFFER_SIZE;</span>
<a href="#l4.57"></a><span id="l4.57">     } else {</span>
<a href="#l4.58"></a><span id="l4.58">       bytesAvail = count;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineat">@@ -80,167 +72,203 @@ AsyncRead.prototype.onDataAvailable = fu</span>
<a href="#l4.60"></a><span id="l4.60">     log(&quot;jsbridge: onDataAvailable, reading bytesAvail = &quot; + bytesAvail + &quot;\n&quot;);</span>
<a href="#l4.61"></a><span id="l4.61">     var bytesRead = this.session.instream.readString(bytesAvail, parts);</span>
<a href="#l4.62"></a><span id="l4.62">     count = count - bytesRead;</span>
<a href="#l4.63"></a><span id="l4.63">     log(&quot;jsbridge: onDataAvailable, read bytes: &quot; + bytesRead + &quot; count is now: &quot; + count + &quot;\n&quot;);</span>
<a href="#l4.64"></a><span id="l4.64">     str.value += parts.value;</span>
<a href="#l4.65"></a><span id="l4.65">   } while (count &gt; 0);</span>
<a href="#l4.66"></a><span id="l4.66">   log(&quot;jsbridge: onDataAvailable, going into receive with: \n\n&quot; + str.value + &quot;\n\n&quot;);</span>
<a href="#l4.67"></a><span id="l4.67">   this.session.receive(str.value);</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-}</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+};</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71"> var globalRegistry = {};</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-function Bridge (session) {</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+function Bridge(session) {</span>
<a href="#l4.75"></a><span id="l4.75">   this.session = session;</span>
<a href="#l4.76"></a><span id="l4.76">   this.registry = globalRegistry;</span>
<a href="#l4.77"></a><span id="l4.77"> }</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-Bridge.prototype._register = function (_type) {</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+Bridge.prototype._register = function(_type) {</span>
<a href="#l4.80"></a><span id="l4.80">   this.bridgeType = _type;</span>
<a href="#l4.81"></a><span id="l4.81">   if (_type == &quot;backchannel&quot;) {</span>
<a href="#l4.82"></a><span id="l4.82">     events.addBackChannel(this);</span>
<a href="#l4.83"></a><span id="l4.83">   }</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-}</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-Bridge.prototype.register = function (uuid, _type) {</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+};</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+Bridge.prototype.register = function(uuid, _type) {</span>
<a href="#l4.88"></a><span id="l4.88">   try {</span>
<a href="#l4.89"></a><span id="l4.89">     this._register(_type);</span>
<a href="#l4.90"></a><span id="l4.90">     var passed = true;</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-  } catch(e) {</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+  } catch (e) {</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+    var exception;</span>
<a href="#l4.94"></a><span id="l4.94">     if (typeof(e) == &quot;string&quot;) {</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-      var exception = e;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+      exception = e;</span>
<a href="#l4.97"></a><span id="l4.97">     } else {</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-      var exception = {'name':e.name, 'message':e.message};</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+      exception = {</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+        name: e.name,</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+        message: e.message,</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+      };</span>
<a href="#l4.103"></a><span id="l4.103">     }</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-    this.session.encodeOut({'result':false, 'exception':exception, 'uuid':uuid});</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+    this.session.encodeOut({</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+      result: false,</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+      exception,</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+      uuid,</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+    });</span>
<a href="#l4.110"></a><span id="l4.110">   }</span>
<a href="#l4.111"></a><span id="l4.111">   if (passed != undefined) {</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-    this.session.encodeOut({&quot;result&quot;:true, 'eventType':'register', 'uuid':uuid});</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+    this.session.encodeOut({</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+      result: true,</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+      eventType: &quot;register&quot;,</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+      uuid,</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+    });</span>
<a href="#l4.118"></a><span id="l4.118">   }</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-}</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-Bridge.prototype._describe = function (obj) {</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+};</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+Bridge.prototype._describe = function(obj) {</span>
<a href="#l4.124"></a><span id="l4.124">   var response = {};</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-  if (obj == null) {</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-    var type = &quot;null&quot;;</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+  var type;</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+  if (obj === null) {</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+    type = &quot;null&quot;;</span>
<a href="#l4.130"></a><span id="l4.130">   } else {</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-    var type = typeof(obj);</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+    type = typeof(obj);</span>
<a href="#l4.133"></a><span id="l4.133">   }</span>
<a href="#l4.134"></a><span id="l4.134">   if (type == &quot;object&quot;) {</span>
<a href="#l4.135"></a><span id="l4.135">     if (obj.length != undefined) {</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-      var type = &quot;array&quot;;</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+      type = &quot;array&quot;;</span>
<a href="#l4.138"></a><span id="l4.138">     }</span>
<a href="#l4.139"></a><span id="l4.139">     response.attributes = [];</span>
<a href="#l4.140"></a><span id="l4.140">     for (var i in obj) {</span>
<a href="#l4.141"></a><span id="l4.141">       response.attributes = response.attributes.concat(i);</span>
<a href="#l4.142"></a><span id="l4.142">     }</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-  }</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-  else if (type != &quot;function&quot;){</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  } else if (type != &quot;function&quot;) {</span>
<a href="#l4.146"></a><span id="l4.146">     response.data = obj;</span>
<a href="#l4.147"></a><span id="l4.147">   }</span>
<a href="#l4.148"></a><span id="l4.148">   response.type = type;</span>
<a href="#l4.149"></a><span id="l4.149">   return response;</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-}</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-Bridge.prototype.describe = function (uuid, obj) {</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+};</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+Bridge.prototype.describe = function(uuid, obj) {</span>
<a href="#l4.154"></a><span id="l4.154">   var response = this._describe(obj);</span>
<a href="#l4.155"></a><span id="l4.155">   response.uuid = uuid;</span>
<a href="#l4.156"></a><span id="l4.156">   response.result = true;</span>
<a href="#l4.157"></a><span id="l4.157">   this.session.encodeOut(response);</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-}</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-Bridge.prototype._set = function (obj) {</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+};</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+Bridge.prototype._set = function(obj) {</span>
<a href="#l4.162"></a><span id="l4.162">   var uuid = uuidgen.generateUUID().toString();</span>
<a href="#l4.163"></a><span id="l4.163">   this.registry[uuid] = obj;</span>
<a href="#l4.164"></a><span id="l4.164">   return uuid;</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-}</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-Bridge.prototype.set = function (uuid, obj) {</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+};</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+Bridge.prototype.set = function(uuid, obj) {</span>
<a href="#l4.169"></a><span id="l4.169">   var ruuid = this._set(obj);</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-  this.session.encodeOut({'result':true, 'data':'bridge.registry[&quot;'+ruuid+'&quot;]', 'uuid':uuid});</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-}</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-Bridge.prototype._setAttribute = function (obj, name, value) {</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+  this.session.encodeOut({</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+    result: true,</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+    data: `bridge.registry[&quot;${ruuid}&quot;]`,</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+    uuid,</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+  });</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+};</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+Bridge.prototype._setAttribute = function(obj, name, value) {</span>
<a href="#l4.180"></a><span id="l4.180">   obj[name] = value;</span>
<a href="#l4.181"></a><span id="l4.181">   return value;</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-}</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-Bridge.prototype.setAttribute = function (uuid, obj, name, value) {</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+};</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+Bridge.prototype.setAttribute = function(uuid, obj, name, value) {</span>
<a href="#l4.186"></a><span id="l4.186">   try {</span>
<a href="#l4.187"></a><span id="l4.187">     var result = this._setAttribute(obj, name, value);</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-  } catch(e) {</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+  } catch (e) {</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+    var exception;</span>
<a href="#l4.191"></a><span id="l4.191">     if (typeof(e) == &quot;string&quot;) {</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-      var exception = e;</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+      exception = e;</span>
<a href="#l4.194"></a><span id="l4.194">     } else {</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-      var exception = {'name':e.name, 'message':e.message};</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+      exception = {</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+        name: e.name,</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+        message: e.message,</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+      };</span>
<a href="#l4.200"></a><span id="l4.200">     }</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-    this.session.encodeOut({'result':false, 'exception':exception, 'uuid':uuid});</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+    this.session.encodeOut({</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+      result: false,</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+      exception,</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+      uuid,</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+    });</span>
<a href="#l4.207"></a><span id="l4.207">   }</span>
<a href="#l4.208"></a><span id="l4.208">   if (result != undefined) {</span>
<a href="#l4.209"></a><span id="l4.209">     this.set(uuid, obj[name]);</span>
<a href="#l4.210"></a><span id="l4.210">   }</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-}</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-Bridge.prototype._execFunction = function (func, args) {</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+};</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+Bridge.prototype._execFunction = function(func, args) {</span>
<a href="#l4.215"></a><span id="l4.215">   return func.apply(this.session.sandbox, args);</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-}</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-Bridge.prototype.execFunction = function (uuid, func, args) {</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+};</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+Bridge.prototype.execFunction = function(uuid, func, args) {</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+  var result;</span>
<a href="#l4.221"></a><span id="l4.221">   try {</span>
<a href="#l4.222"></a><span id="l4.222">     var data = this._execFunction(func, args);</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-    var result = true;</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-  } catch(e) {</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+    result = true;</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+  } catch (e) {</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+    var exception;</span>
<a href="#l4.228"></a><span id="l4.228">     if (typeof(e) == &quot;string&quot;) {</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-      var exception = e;</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+      exception = e;</span>
<a href="#l4.231"></a><span id="l4.231">     } else {</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-      var exception = {'name':e.name, 'message':e.message};</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+      exception = {</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+        name: e.name,</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+        message: e.message,</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+      };</span>
<a href="#l4.237"></a><span id="l4.237">     }</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-    this.session.encodeOut({'result':false, 'exception':exception, 'uuid':uuid});</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-    var result = true;</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+    this.session.encodeOut({</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+      result: false,</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+      exception,</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+      uuid,</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+    });</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+    result = true;</span>
<a href="#l4.246"></a><span id="l4.246">   }</span>
<a href="#l4.247"></a><span id="l4.247">   if (data != undefined) {</span>
<a href="#l4.248"></a><span id="l4.248">     this.set(uuid, data);</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-  } else if ( result == true) {</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-    this.session.encodeOut({'result':true, 'data':null, 'uuid':uuid});</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+  } else if (result) {</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+    this.session.encodeOut({</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+      result: true,</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+      data: null,</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+      uuid,</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+    });</span>
<a href="#l4.257"></a><span id="l4.257">   } else {</span>
<a href="#l4.258"></a><span id="l4.258">     log(&quot;jsbridge threw unknown data in execFunc&quot;);</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-    throw 'JSBridge unknown data in execFunc';</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+    throw &quot;JSBridge unknown data in execFunc&quot;;</span>
<a href="#l4.261"></a><span id="l4.261">   }</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineminus">-}</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+};</span>
<a href="#l4.264"></a><span id="l4.264"> </span>
<a href="#l4.265"></a><span id="l4.265"> var backstage = this;</span>
<a href="#l4.266"></a><span id="l4.266"> </span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-function Session (transport) {</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+function Session(transport) {</span>
<a href="#l4.269"></a><span id="l4.269">   this.transpart = transport;  // XXX Unused, needed to hold reference? Note the typo.</span>
<a href="#l4.270"></a><span id="l4.270">   let systemPrincipal = Cc[&quot;@mozilla.org/systemprincipal;1&quot;]</span>
<a href="#l4.271"></a><span id="l4.271">                           .createInstance(Ci.nsIPrincipal);</span>
<a href="#l4.272"></a><span id="l4.272">   this.sandbox = Cu.Sandbox(systemPrincipal, { wantGlobalProperties: [&quot;ChromeUtils&quot;] });</span>
<a href="#l4.273"></a><span id="l4.273">   this.sandbox.bridge = new Bridge(this);</span>
<a href="#l4.274"></a><span id="l4.274">   this.sandbox.openPreferences = hwindow.openPreferences;</span>
<a href="#l4.275"></a><span id="l4.275">   try {</span>
<a href="#l4.276"></a><span id="l4.276">       this.outputstream = transport.openOutputStream(Ci.nsITransport.OPEN_BLOCKING, 0, 0);</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-      this.outstream = Cc['@mozilla.org/intl/converter-output-stream;1']</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-                    .createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-      this.outstream.init(this.outputstream, 'UTF-8');</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+      this.outstream = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+                         .createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+      this.outstream.init(this.outputstream, &quot;UTF-8&quot;);</span>
<a href="#l4.283"></a><span id="l4.283">       this.stream = transport.openInputStream(0, 0, 0);</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-      this.instream = Cc['@mozilla.org/intl/converter-input-stream;1']</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+      this.instream = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l4.286"></a><span id="l4.286">                         .createInstance(Ci.nsIConverterInputStream);</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-      this.instream.init(this.stream, 'UTF-8', BUFFER_SIZE,</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+      this.instream.init(this.stream, &quot;UTF-8&quot;, BUFFER_SIZE,</span>
<a href="#l4.289"></a><span id="l4.289">                          Ci.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER);</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-  } catch(e) {</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-      log('jsbridge: Error: ' + e);</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+  } catch (e) {</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+      log(&quot;jsbridge: Error: &quot; + e);</span>
<a href="#l4.294"></a><span id="l4.294">   }</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-  log('jsbridge: Accepted connection.');</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+  log(&quot;jsbridge: Accepted connection.&quot;);</span>
<a href="#l4.297"></a><span id="l4.297"> </span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-  this.pump = Cc['@mozilla.org/network/input-stream-pump;1']</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-      .createInstance(Ci.nsIInputStreamPump);</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+  this.pump = Cc[&quot;@mozilla.org/network/input-stream-pump;1&quot;]</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+                .createInstance(Ci.nsIInputStreamPump);</span>
<a href="#l4.302"></a><span id="l4.302">   this.pump.init(this.stream, 0, 0, false);</span>
<a href="#l4.303"></a><span id="l4.303">   this.pump.asyncRead(new AsyncRead(this), null);</span>
<a href="#l4.304"></a><span id="l4.304"> }</span>
<a href="#l4.305"></a><span id="l4.305"> Session.prototype.onOutput = function(string) {</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-  log('jsbridge: write: '+string)</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+  log(&quot;jsbridge: write: &quot; + string);</span>
<a href="#l4.308"></a><span id="l4.308">   if (typeof(string) != &quot;string&quot;) {</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-    throw &quot;This is not a string&quot;</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+    throw new Error(&quot;This is not a string&quot;);</span>
<a href="#l4.311"></a><span id="l4.311">   }</span>
<a href="#l4.312"></a><span id="l4.312">   try {</span>
<a href="#l4.313"></a><span id="l4.313">     var stroffset = 0;</span>
<a href="#l4.314"></a><span id="l4.314">     do {</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-      var parts = '';</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+      var parts = &quot;&quot;;</span>
<a href="#l4.317"></a><span id="l4.317">       // Handle the case where we are writing something larger than our buffer</span>
<a href="#l4.318"></a><span id="l4.318">       if (string.length &gt; BUFFER_SIZE) {</span>
<a href="#l4.319"></a><span id="l4.319">         log(&quot;jsbridge: onOutput: writing data stroffset is: &quot; + stroffset + &quot; string.length is: &quot; + string.length);</span>
<a href="#l4.320"></a><span id="l4.320">         parts = string.slice(stroffset, stroffset + BUFFER_SIZE);</span>
<a href="#l4.321"></a><span id="l4.321">         log(&quot;jsbridge: onOutput: here is our part: \n&quot; + parts + &quot;\n&quot;);</span>
<a href="#l4.322"></a><span id="l4.322">       } else {</span>
<a href="#l4.323"></a><span id="l4.323">         parts = string;</span>
<a href="#l4.324"></a><span id="l4.324">       }</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineat">@@ -251,91 +279,97 @@ Session.prototype.onOutput = function(st</span>
<a href="#l4.326"></a><span id="l4.326">       // write it</span>
<a href="#l4.327"></a><span id="l4.327">       this.outstream.writeString(parts);</span>
<a href="#l4.328"></a><span id="l4.328">     } while (stroffset &lt; string.length);</span>
<a href="#l4.329"></a><span id="l4.329"> </span>
<a href="#l4.330"></a><span id="l4.330">     // Ensure the entire stream is flushed</span>
<a href="#l4.331"></a><span id="l4.331">     this.outstream.flush();</span>
<a href="#l4.332"></a><span id="l4.332">   } catch (e) {</span>
<a href="#l4.333"></a><span id="l4.333">     log(&quot;jsbridge: threw on writing string: &quot; + string + &quot;   exception: &quot; + e);</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-    throw &quot;JSBridge cannot write: &quot;+string</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+    throw new Error(&quot;JSBridge cannot write: &quot; + string);</span>
<a href="#l4.336"></a><span id="l4.336">   }</span>
<a href="#l4.337"></a><span id="l4.337"> };</span>
<a href="#l4.338"></a><span id="l4.338"> Session.prototype.onQuit = function() {</span>
<a href="#l4.339"></a><span id="l4.339">   this.instream.close();</span>
<a href="#l4.340"></a><span id="l4.340">   this.outstream.close();</span>
<a href="#l4.341"></a><span id="l4.341">   sessions.remove(this);</span>
<a href="#l4.342"></a><span id="l4.342"> };</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-Session.prototype.encodeOut = function (obj) {</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+Session.prototype.encodeOut = function(obj) {</span>
<a href="#l4.345"></a><span id="l4.345">   try {</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineminus">-    this.onOutput(jsonEncode(obj));</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-  } catch(e) {</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+    this.onOutput(JSON.stringify(obj));</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+  } catch (e) {</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+    var exception;</span>
<a href="#l4.351"></a><span id="l4.351">     if (typeof(e) == &quot;string&quot;) {</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineminus">-      var exception = e;</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+      exception = e;</span>
<a href="#l4.354"></a><span id="l4.354">     } else {</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-      var exception = {'name':e.name, 'message':e.message};</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+      exception = {</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+        name: e.name,</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+        message: e.message,</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+      };</span>
<a href="#l4.360"></a><span id="l4.360">     }</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineminus">-    this.onOutput(jsonEncode({'result':false, 'exception':exception}));</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+    this.onOutput(JSON.stringify({</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+      result: false,</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+      exception,</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+    }));</span>
<a href="#l4.366"></a><span id="l4.366">   }</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-}</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+};</span>
<a href="#l4.370"></a><span id="l4.370"> Session.prototype.receive = function(data) {</span>
<a href="#l4.371"></a><span id="l4.371">   Cu.evalInSandbox(data, this.sandbox);</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-}</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineplus">+};</span>
<a href="#l4.374"></a><span id="l4.374"> </span>
<a href="#l4.375"></a><span id="l4.375"> var sessions = {</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-    _list: [],</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-    add: function(session) {</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-        this._list.push(session);</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-    },</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-    remove: function(session) {</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-        var index = this._list.indexOf(session);</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineminus">-        if(index != -1)</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineminus">-            this._list.splice(index, 1);</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-    },</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-    get: function(index) {</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-        return this._list[index];</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineminus">-    },</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-    quit: function() {</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineminus">-        this._list.forEach(function(session) { session.onQuit(); });</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineminus">-        this._list.splice(0, this._list.length);</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-    }</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+  _list: [],</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+  add(session) {</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+    this._list.push(session);</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+  },</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+  remove(session) {</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+    var index = this._list.indexOf(session);</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+    if (index != -1)</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+      this._list.splice(index, 1);</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+  },</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+  get(index) {</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+    return this._list[index];</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+  },</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+  quit() {</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+    this._list.forEach(function(session) { session.onQuit(); });</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+    this._list.splice(0, this._list.length);</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+  },</span>
<a href="#l4.408"></a><span id="l4.408"> };</span>
<a href="#l4.409"></a><span id="l4.409"> </span>
<a href="#l4.410"></a><span id="l4.410" class="difflineminus">-function Server (port) {</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineplus">+function Server(port) {</span>
<a href="#l4.412"></a><span id="l4.412">   this.port = port;</span>
<a href="#l4.413"></a><span id="l4.413"> }</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineminus">-Server.prototype.start = function () {</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+Server.prototype.start = function() {</span>
<a href="#l4.416"></a><span id="l4.416">   try {</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineminus">-    this.serv = Cc['@mozilla.org/network/server-socket;1']</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineminus">-        .createInstance(Ci.nsIServerSocket);</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+    this.serv = Cc[&quot;@mozilla.org/network/server-socket;1&quot;]</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+                  .createInstance(Ci.nsIServerSocket);</span>
<a href="#l4.421"></a><span id="l4.421">     this.serv.init(this.port, true, -1);</span>
<a href="#l4.422"></a><span id="l4.422">     this.serv.asyncListen(this);</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineminus">-  } catch(e) {</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineminus">-    log('jsbridge: Exception: ' + e);</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+  } catch (e) {</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+    log(&quot;jsbridge: Exception: &quot; + e);</span>
<a href="#l4.427"></a><span id="l4.427">   }</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineminus">-}</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineminus">-Server.prototype.stop = function () {</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineminus">-    log('jsbridge: Closing...');</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineminus">-    this.serv.close();</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineminus">-    this.sessions.quit();</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineminus">-    this.serv = undefined;</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineminus">-}</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineminus">-Server.prototype.onStopListening = function (serv, status) {</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+};</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+Server.prototype.stop = function() {</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+  log(&quot;jsbridge: Closing...&quot;);</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+  this.serv.close();</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+  this.sessions.quit();</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+  this.serv = undefined;</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+};</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+Server.prototype.onStopListening = function(serv, status) {</span>
<a href="#l4.444"></a><span id="l4.444"> // Stub function</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineminus">-}</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineminus">-Server.prototype.onSocketAccepted = function (serv, transport) {</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+};</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+Server.prototype.onSocketAccepted = function(serv, transport) {</span>
<a href="#l4.449"></a><span id="l4.449">   let session = new Session(transport);</span>
<a href="#l4.450"></a><span id="l4.450">   sessions.add(session);</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineminus">-}</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineplus">+};</span>
<a href="#l4.453"></a><span id="l4.453"> </span>
<a href="#l4.454"></a><span id="l4.454"> function log(msg) {</span>
<a href="#l4.455"></a><span id="l4.455">   if (DEBUG_ON) {</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineminus">-    dump(msg + '\n');</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+    dump(msg + &quot;\n&quot;);</span>
<a href="#l4.458"></a><span id="l4.458">   }</span>
<a href="#l4.459"></a><span id="l4.459"> }</span>
<a href="#l4.460"></a><span id="l4.460"> </span>
<a href="#l4.461"></a><span id="l4.461"> function startServer(port) {</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineminus">-  var server = new Server(port)</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineminus">-  server.start()</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+  var server = new Server(port);</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+  server.start();</span>
<a href="#l4.466"></a><span id="l4.466"> }</span>
<a href="#l4.467"></a><span id="l4.467"> </span>
<a href="#l4.468"></a><span id="l4.468"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/overlay.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/resources/jsbridge/jsbridge/extension/chrome/content/overlay.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -31,10 +31,8 @@</span>
<a href="#l5.4"></a><span id="l5.4"> // decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.5"></a><span id="l5.5"> // and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.6"></a><span id="l5.6"> // the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.7"></a><span id="l5.7"> // the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.8"></a><span id="l5.8"> //</span>
<a href="#l5.9"></a><span id="l5.9"> // ***** END LICENSE BLOCK *****</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> var jsbridgeInit = ChromeUtils.import(&quot;chrome://jsbridge/content/modules/init.js&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/resources/jsbridge/jsbridge/extension/components/cmdarg.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/resources/jsbridge/jsbridge/extension/components/cmdarg.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,53 +1,38 @@</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineplus">+var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.5"></a><span id="l6.5"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">-var nsIAppShellService    = Ci.nsIAppShellService;</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-var nsISupports           = Ci.nsISupports;</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-var nsICategoryManager    = Ci.nsICategoryManager;</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-var nsIComponentRegistrar = Ci.nsIComponentRegistrar;</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-var nsICommandLine        = Ci.nsICommandLine;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-var nsICommandLineHandler = Ci.nsICommandLineHandler;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-var nsIFactory            = Ci.nsIFactory;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-var nsIModule             = Ci.nsIModule;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-var nsIWindowWatcher      = Ci.nsIWindowWatcher;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-</span>
<a href="#l6.17"></a><span id="l6.17"> // CHANGEME: to the chrome URI of your extension or application</span>
<a href="#l6.18"></a><span id="l6.18"> var CHROME_URI = &quot;chrome://jsbridge/content/&quot;;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> // CHANGEME: change the contract id, CID, and category to be unique</span>
<a href="#l6.21"></a><span id="l6.21"> // to your application.</span>
<a href="#l6.22"></a><span id="l6.22"> var clh_contractID = &quot;@mozilla.org/commandlinehandler/general-startup;1?type=jsbridge&quot;;</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24"> // use uuidgen to generate a unique ID</span>
<a href="#l6.25"></a><span id="l6.25"> var clh_CID = Components.ID(&quot;{2872d428-14f6-11de-ac86-001f5bd9235c}&quot;);</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> // category names are sorted alphabetically. Typical command-line handlers use a</span>
<a href="#l6.28"></a><span id="l6.28"> // category that begins with the letter &quot;m&quot;.</span>
<a href="#l6.29"></a><span id="l6.29"> var clh_category = &quot;jsbridge&quot;;</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-var aConsoleService = Cc[&quot;@mozilla.org/consoleservice;1&quot;].</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-     getService(Ci.nsIConsoleService);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-</span>
<a href="#l6.34"></a><span id="l6.34"> /**</span>
<a href="#l6.35"></a><span id="l6.35">  * Utility functions</span>
<a href="#l6.36"></a><span id="l6.36">  */</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38"> /**</span>
<a href="#l6.39"></a><span id="l6.39">  * Opens a chrome window.</span>
<a href="#l6.40"></a><span id="l6.40">  * @param aChromeURISpec a string specifying the URI of the window to open.</span>
<a href="#l6.41"></a><span id="l6.41">  * @param aArgument an argument to pass to the window (may be null)</span>
<a href="#l6.42"></a><span id="l6.42">  */</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-function openWindow(aChromeURISpec, aArgument)</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-{</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-  var ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-    getService(Ci.nsIWindowWatcher);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-  ww.openWindow(null, aChromeURISpec, &quot;_blank&quot;,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-                &quot;chrome,menubar,toolbar,status,resizable,dialog=no&quot;,</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-                aArgument);</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+function openWindow(aChromeURISpec, aArgument) {</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  Services.ww.openWindow(null, aChromeURISpec, &quot;_blank&quot;,</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+                         &quot;chrome,menubar,toolbar,status,resizable,dialog=no&quot;,</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+                         aArgument);</span>
<a href="#l6.54"></a><span id="l6.54"> }</span>
<a href="#l6.55"></a><span id="l6.55"> </span>
<a href="#l6.56"></a><span id="l6.56"> /**</span>
<a href="#l6.57"></a><span id="l6.57">  * The XPCOM component that implements nsICommandLineHandler.</span>
<a href="#l6.58"></a><span id="l6.58">  * It also implements nsIFactory to serve as its own singleton factory.</span>
<a href="#l6.59"></a><span id="l6.59">  */</span>
<a href="#l6.60"></a><span id="l6.60"> function jsbridgeHandler() {</span>
<a href="#l6.61"></a><span id="l6.61"> }</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineat">@@ -58,60 +43,45 @@ jsbridgeHandler.prototype = {</span>
<a href="#l6.63"></a><span id="l6.63">   _xpcom_categories: [{category: &quot;command-line-handler&quot;, entry: clh_category}],</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65">   /* nsISupports */</span>
<a href="#l6.66"></a><span id="l6.66">   QueryInterface: ChromeUtils.generateQI([&quot;nsICommandLineHandler&quot;,</span>
<a href="#l6.67"></a><span id="l6.67">                                           &quot;nsIFactory&quot;]),</span>
<a href="#l6.68"></a><span id="l6.68"> </span>
<a href="#l6.69"></a><span id="l6.69">   /* nsICommandLineHandler */</span>
<a href="#l6.70"></a><span id="l6.70"> </span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-  handle : function clh_handle(cmdLine)</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-  {</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  handle(cmdLine) {</span>
<a href="#l6.74"></a><span id="l6.74">     try {</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+      var server = ChromeUtils.import(&quot;chrome://jsbridge/content/modules/server.js&quot;);</span>
<a href="#l6.76"></a><span id="l6.76">       var port = cmdLine.handleFlagWithParam(&quot;jsbridge&quot;, false);</span>
<a href="#l6.77"></a><span id="l6.77">       if (port) {</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-        var server =</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-          ChromeUtils.import(&quot;chrome://jsbridge/content/modules/server.js&quot;);</span>
<a href="#l6.80"></a><span id="l6.80">         server.startServer(parseInt(port));</span>
<a href="#l6.81"></a><span id="l6.81">       } else {</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-        var server =</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-          ChromeUtils.import(&quot;chrome://jsbridge/content/modules/server.js&quot;);</span>
<a href="#l6.84"></a><span id="l6.84">         server.startServer(24242);</span>
<a href="#l6.85"></a><span id="l6.85">       }</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-    }</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-    catch (e) {</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+    } catch (e) {</span>
<a href="#l6.89"></a><span id="l6.89">       Cu.reportError(&quot;incorrect parameter passed to -jsbridge on the command line.&quot;);</span>
<a href="#l6.90"></a><span id="l6.90">     }</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-</span>
<a href="#l6.92"></a><span id="l6.92">   },</span>
<a href="#l6.93"></a><span id="l6.93"> </span>
<a href="#l6.94"></a><span id="l6.94">   // CHANGEME: change the help info as appropriate, but</span>
<a href="#l6.95"></a><span id="l6.95">   // follow the guidelines in nsICommandLineHandler.idl</span>
<a href="#l6.96"></a><span id="l6.96">   // specifically, flag descriptions should start at</span>
<a href="#l6.97"></a><span id="l6.97">   // character 24, and lines should be wrapped at</span>
<a href="#l6.98"></a><span id="l6.98">   // 72 characters with embedded newlines,</span>
<a href="#l6.99"></a><span id="l6.99">   // and finally, the string should end with a newline</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-  helpInfo : &quot;  -jsbridge            Port to run jsbridge on.\n&quot;,</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+  helpInfo: &quot;  -jsbridge            Port to run jsbridge on.\n&quot;,</span>
<a href="#l6.102"></a><span id="l6.102"> </span>
<a href="#l6.103"></a><span id="l6.103">   /* nsIFactory */</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-  createInstance : function clh_CI(outer, iid)</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-  {</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  createInstance(outer, iid) {</span>
<a href="#l6.108"></a><span id="l6.108">     if (outer != null)</span>
<a href="#l6.109"></a><span id="l6.109">       throw Cr.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l6.110"></a><span id="l6.110"> </span>
<a href="#l6.111"></a><span id="l6.111">     return this.QueryInterface(iid);</span>
<a href="#l6.112"></a><span id="l6.112">   },</span>
<a href="#l6.113"></a><span id="l6.113"> </span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-  lockFactory : function clh_lock(lock)</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-  {</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+  lockFactory(lock) {</span>
<a href="#l6.117"></a><span id="l6.117">     /* no-op */</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-  }</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+  },</span>
<a href="#l6.120"></a><span id="l6.120"> };</span>
<a href="#l6.121"></a><span id="l6.121"> </span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-/**</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">- * XPCOMUtils.generateNSGetFactory was introduced in Mozilla 2 (Firefox 4).</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">- * XPCOMUtils.generateNSGetModule is for Mozilla 1.9.1 (Firefox 3.5).</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">- */</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory ? XPCOMUtils.generateNSGetFactory([jsbridgeHandler])</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-                                                     : undefined;</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-var NSGetModule = !XPCOMUtils.generateNSGetFactory ? XPCOMUtils.generateNSGetModule([jsbridgeHandler])</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-                                                     : undefined;</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([jsbridgeHandler]);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

