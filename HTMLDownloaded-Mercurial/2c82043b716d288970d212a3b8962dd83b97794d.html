<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27383:2c82043b716d288970d212a3b8962dd83b97794d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2c82043b716d288970d212a3b8962dd83b97794d" />
<meta property="og:url" content="/comm-central/rev/2c82043b716d288970d212a3b8962dd83b97794d" />
<meta property="og:description" content="Bug 1463266 - Fix some ugly comments in nsMsgAttachment*.cpp. rs=comment-only" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2c82043b716d288970d212a3b8962dd83b97794d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2c82043b716d288970d212a3b8962dd83b97794d">shortlog</a> |
<a href="/comm-central/log/2c82043b716d288970d212a3b8962dd83b97794d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2c82043b716d288970d212a3b8962dd83b97794d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2c82043b716d288970d212a3b8962dd83b97794d">files</a> |
changeset |
<a href="/comm-central/raw-rev/2c82043b716d288970d212a3b8962dd83b97794d">raw</a>  | <a href="/comm-central/archive/2c82043b716d288970d212a3b8962dd83b97794d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">Bug 1463266</a> - Fix some ugly comments in nsMsgAttachment*.cpp. rs=comment-only
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 22 Aug 2019 23:44:14 +0200</td></tr>

<tr>
 <td>changeset 27383</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2c82043b716d288970d212a3b8962dd83b97794d">2c82043b716d288970d212a3b8962dd83b97794d</a></td>
</tr>



<tr>
<td>parent 27382</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1a402de7a24866f5b1d77a2f4cccef23c61abefb">1a402de7a24866f5b1d77a2f4cccef23c61abefb</a>
</td>
</tr>

<tr>
<td>child 27384</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/29e0bcd5298ec1ab3cb8ab0f92d9c2345ce838b5">29e0bcd5298ec1ab3cb8ab0f92d9c2345ce838b5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2c82043b716d288970d212a3b8962dd83b97794d">16314</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 22 Aug 2019 22:02:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2c82043b716d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2c82043b716d288970d212a3b8962dd83b97794d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2c82043b716d288970d212a3b8962dd83b97794d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2c82043b716d288970d212a3b8962dd83b97794d&newProject=comm-central&newRevision=2c82043b716d288970d212a3b8962dd83b97794d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2c82043b716d288970d212a3b8962dd83b97794d&newProject=comm-central&newRevision=2c82043b716d288970d212a3b8962dd83b97794d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2c82043b716d288970d212a3b8962dd83b97794d&newProject=comm-central&newRevision=2c82043b716d288970d212a3b8962dd83b97794d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28comment-only%29&revcount=50">comment-only</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">1463266</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">Bug 1463266</a> - Fix some ugly comments in nsMsgAttachment*.cpp. rs=comment-only</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c82043b716d288970d212a3b8962dd83b97794d/mailnews/compose/src/nsMsgAttachment.cpp">mailnews/compose/src/nsMsgAttachment.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c82043b716d288970d212a3b8962dd83b97794d/mailnews/compose/src/nsMsgAttachment.cpp">file</a> |
<a href="/comm-central/annotate/2c82043b716d288970d212a3b8962dd83b97794d/mailnews/compose/src/nsMsgAttachment.cpp">annotate</a> |
<a href="/comm-central/diff/2c82043b716d288970d212a3b8962dd83b97794d/mailnews/compose/src/nsMsgAttachment.cpp">diff</a> |
<a href="/comm-central/comparison/2c82043b716d288970d212a3b8962dd83b97794d/mailnews/compose/src/nsMsgAttachment.cpp">comparison</a> |
<a href="/comm-central/log/2c82043b716d288970d212a3b8962dd83b97794d/mailnews/compose/src/nsMsgAttachment.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c82043b716d288970d212a3b8962dd83b97794d/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c82043b716d288970d212a3b8962dd83b97794d/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/2c82043b716d288970d212a3b8962dd83b97794d/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/2c82043b716d288970d212a3b8962dd83b97794d/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/2c82043b716d288970d212a3b8962dd83b97794d/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/2c82043b716d288970d212a3b8962dd83b97794d/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachment.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachment.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -113,19 +113,18 @@ NS_IMETHODIMP nsMsgAttachment::GetConten</span>
<a href="#l1.4"></a><span id="l1.4">   NS_ENSURE_ARG_POINTER(aContentType);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">   *aContentType = ToNewCString(mContentType);</span>
<a href="#l1.7"></a><span id="l1.7">   return (*aContentType ? NS_OK : NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l1.8"></a><span id="l1.8"> }</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> NS_IMETHODIMP nsMsgAttachment::SetContentType(const char *aContentType) {</span>
<a href="#l1.11"></a><span id="l1.11">   mContentType = aContentType;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  /* a full content type could also contains parameters but we need to</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-     keep only the content type alone. Therefore we need to cleanup it.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-  */</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  // a full content type could also contains parameters but we need to</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+  // keep only the content type alone. Therefore we need to cleanup it.</span>
<a href="#l1.17"></a><span id="l1.17">   int32_t offset = mContentType.FindChar(';');</span>
<a href="#l1.18"></a><span id="l1.18">   if (offset &gt;= 0) mContentType.SetLength(offset);</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">   return NS_OK;</span>
<a href="#l1.21"></a><span id="l1.21"> }</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> NS_IMETHODIMP nsMsgAttachment::GetContentTypeParam(char **aContentTypeParam) {</span>
<a href="#l1.24"></a><span id="l1.24">   NS_ENSURE_ARG_POINTER(aContentTypeParam);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -291,20 +291,18 @@ void nsMsgAttachmentHandler::AnalyzeSnar</span>
<a href="#l2.4"></a><span id="l2.4">       if (m_prev_char_was_cr) m_have_cr = 1;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">       inputFile-&gt;Close();</span>
<a href="#l2.7"></a><span id="l2.7">       m_file_analyzed = true;</span>
<a href="#l2.8"></a><span id="l2.8">     }</span>
<a href="#l2.9"></a><span id="l2.9">   }</span>
<a href="#l2.10"></a><span id="l2.10"> }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-//</span>
<a href="#l2.13"></a><span id="l2.13"> // Given a content-type and some info about the contents of the document,</span>
<a href="#l2.14"></a><span id="l2.14"> // decide what encoding it should have.</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-//</span>
<a href="#l2.16"></a><span id="l2.16"> nsresult nsMsgAttachmentHandler::PickEncoding(const char *charset,</span>
<a href="#l2.17"></a><span id="l2.17">                                               nsIMsgSend *mime_delivery_state) {</span>
<a href="#l2.18"></a><span id="l2.18">   nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   bool needsB64 = false;</span>
<a href="#l2.21"></a><span id="l2.21">   bool forceB64 = false;</span>
<a href="#l2.22"></a><span id="l2.22">   bool isUsingQP = false;</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24" class="difflineat">@@ -420,37 +418,35 @@ nsresult nsMsgAttachmentHandler::PickEnc</span>
<a href="#l2.25"></a><span id="l2.25">                                               mime_delivery_state);</span>
<a href="#l2.26"></a><span id="l2.26">   } else if (m_encoding.LowerCaseEqualsLiteral(ENCODING_QUOTED_PRINTABLE)) {</span>
<a href="#l2.27"></a><span id="l2.27">     m_encoder =</span>
<a href="#l2.28"></a><span id="l2.28">         MimeEncoder::GetQPEncoder(mime_encoder_output_fn, mime_delivery_state);</span>
<a href="#l2.29"></a><span id="l2.29">   } else {</span>
<a href="#l2.30"></a><span id="l2.30">     m_encoder = nullptr;</span>
<a href="#l2.31"></a><span id="l2.31">   }</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  /*</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-    Do some cleanup for documents with unknown content type.</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-    There are two issues: how they look to MIME users, and how they look to</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-    non-MIME users.</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  // Do some cleanup for documents with unknown content type.</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  // There are two issues: how they look to MIME users, and how they look to</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  // non-MIME users.</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-    If the user attaches a &quot;README&quot; file, which has unknown type because it</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    has no extension, we still need to send it with no encoding, so that it</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    is readable to non-MIME users.</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+  // If the user attaches a &quot;README&quot; file, which has unknown type because it</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  // has no extension, we still need to send it with no encoding, so that it</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  // is readable to non-MIME users.</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    But if the user attaches some random binary file, then base64 encoding</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-    will have been chosen for it (above), and in this case, it won't be</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-    immediately readable by non-MIME users.  However, if we type it as</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-    text/plain instead of application/octet-stream, it will show up inline</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-    in a MIME viewer, which will probably be ugly, and may possibly have</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-    bad charset things happen as well.</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  // But if the user attaches some random binary file, then base64 encoding</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  // will have been chosen for it (above), and in this case, it won't be</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  // immediately readable by non-MIME users.  However, if we type it as</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  // text/plain instead of application/octet-stream, it will show up inline</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  // in a MIME viewer, which will probably be ugly, and may possibly have</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  // bad charset things happen as well.</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-    So, the heuristic we use is, if the type is unknown, then the type is</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-    set to application/octet-stream for data which needs base64 (binary data)</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-    and is set to text/plain for data which didn't need base64 (unencoded or</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-    lightly encoded data.)</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  */</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  // So, the heuristic we use is, if the type is unknown, then the type is</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  // set to application/octet-stream for data which needs base64 (binary data)</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  // and is set to text/plain for data which didn't need base64 (unencoded or</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  // lightly encoded data.)</span>
<a href="#l2.70"></a><span id="l2.70"> DONE:</span>
<a href="#l2.71"></a><span id="l2.71">   if (m_type.IsEmpty() || m_type.LowerCaseEqualsLiteral(UNKNOWN_CONTENT_TYPE)) {</span>
<a href="#l2.72"></a><span id="l2.72">     if (m_already_encoded_p)</span>
<a href="#l2.73"></a><span id="l2.73">       m_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l2.74"></a><span id="l2.74">     else if (m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64) ||</span>
<a href="#l2.75"></a><span id="l2.75">              m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE))</span>
<a href="#l2.76"></a><span id="l2.76">       m_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l2.77"></a><span id="l2.77">     else</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineat">@@ -677,22 +673,20 @@ nsresult nsMsgAttachmentHandler::SnarfAt</span>
<a href="#l2.79"></a><span id="l2.79">       rv = ConvertToZipFile(macFile);</span>
<a href="#l2.80"></a><span id="l2.80">     else</span>
<a href="#l2.81"></a><span id="l2.81">       rv = ConvertToAppleEncoding(sourceURISpec, unescapedFilePath, macFile);</span>
<a href="#l2.82"></a><span id="l2.82"> </span>
<a href="#l2.83"></a><span id="l2.83">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.84"></a><span id="l2.84">   }</span>
<a href="#l2.85"></a><span id="l2.85"> #endif /* XP_MACOSX */</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-  //</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-  // Ok, here we are, we need to fire the URL off and get the data</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-  // in the temp file</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-  //</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  // OK, here we are, we need to fire the URL off and get the data</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+  // in the temp file.</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+</span>
<a href="#l2.94"></a><span id="l2.94">   // Create a fetcher for the URL attachment...</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-</span>
<a href="#l2.96"></a><span id="l2.96">   nsCOMPtr&lt;nsIURLFetcher&gt; fetcher =</span>
<a href="#l2.97"></a><span id="l2.97">       do_CreateInstance(NS_URLFETCHER_CONTRACTID, &amp;rv);</span>
<a href="#l2.98"></a><span id="l2.98">   if (NS_FAILED(rv) || !fetcher) {</span>
<a href="#l2.99"></a><span id="l2.99">     if (NS_SUCCEEDED(rv))</span>
<a href="#l2.100"></a><span id="l2.100">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.101"></a><span id="l2.101">     else</span>
<a href="#l2.102"></a><span id="l2.102">       return rv;</span>
<a href="#l2.103"></a><span id="l2.103">   }</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineat">@@ -791,23 +785,21 @@ nsresult nsMsgAttachmentHandler::Convert</span>
<a href="#l2.105"></a><span id="l2.105">     nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l2.106"></a><span id="l2.106">     nsresult rv = nsMsgCreateTempFile(&quot;appledouble&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l2.107"></a><span id="l2.107">     if (NS_SUCCEEDED(rv)) mEncodedWorkingFile = tmpFile;</span>
<a href="#l2.108"></a><span id="l2.108">     if (!mEncodedWorkingFile) {</span>
<a href="#l2.109"></a><span id="l2.109">       PR_FREEIF(separator);</span>
<a href="#l2.110"></a><span id="l2.110">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.111"></a><span id="l2.111">     }</span>
<a href="#l2.112"></a><span id="l2.112"> </span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-    //</span>
<a href="#l2.114"></a><span id="l2.114">     // RICHIE_MAC - ok, here's the deal, we have a file that we need</span>
<a href="#l2.115"></a><span id="l2.115">     // to encode in appledouble encoding for the resource fork and put that</span>
<a href="#l2.116"></a><span id="l2.116">     // into the mEncodedWorkingFile location. Then, we need to patch the new</span>
<a href="#l2.117"></a><span id="l2.117">     // file spec into the array and send this as part of the 2 part</span>
<a href="#l2.118"></a><span id="l2.118">     // appledouble/mime encoded mime part.</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-    //</span>
<a href="#l2.120"></a><span id="l2.120">     AppleDoubleEncodeObject *obj = new (AppleDoubleEncodeObject);</span>
<a href="#l2.121"></a><span id="l2.121">     if (obj == NULL) {</span>
<a href="#l2.122"></a><span id="l2.122">       mEncodedWorkingFile = nullptr;</span>
<a href="#l2.123"></a><span id="l2.123">       PR_FREEIF(separator);</span>
<a href="#l2.124"></a><span id="l2.124">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.125"></a><span id="l2.125">     }</span>
<a href="#l2.126"></a><span id="l2.126"> </span>
<a href="#l2.127"></a><span id="l2.127">     rv = MsgGetFileStream(mEncodedWorkingFile, getter_AddRefs(obj-&gt;fileStream));</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineat">@@ -822,44 +814,40 @@ nsresult nsMsgAttachmentHandler::Convert</span>
<a href="#l2.129"></a><span id="l2.129">       PR_FREEIF(separator);</span>
<a href="#l2.130"></a><span id="l2.130">       delete obj;</span>
<a href="#l2.131"></a><span id="l2.131">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.132"></a><span id="l2.132">     }</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134">     obj-&gt;buff = working_buff;</span>
<a href="#l2.135"></a><span id="l2.135">     obj-&gt;s_buff = AD_WORKING_BUFF_SIZE;</span>
<a href="#l2.136"></a><span id="l2.136"> </span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-    //</span>
<a href="#l2.138"></a><span id="l2.138">     //  Setup all the need information on the apple double encoder.</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-    //</span>
<a href="#l2.140"></a><span id="l2.140">     ap_encode_init(&amp;(obj-&gt;ap_encode_obj), aFilePath.get(), separator);</span>
<a href="#l2.141"></a><span id="l2.141"> </span>
<a href="#l2.142"></a><span id="l2.142">     int32_t count;</span>
<a href="#l2.143"></a><span id="l2.143"> </span>
<a href="#l2.144"></a><span id="l2.144">     OSErr status = noErr;</span>
<a href="#l2.145"></a><span id="l2.145">     m_size = 0;</span>
<a href="#l2.146"></a><span id="l2.146">     while (status == noErr) {</span>
<a href="#l2.147"></a><span id="l2.147">       status =</span>
<a href="#l2.148"></a><span id="l2.148">           ap_encode_next(&amp;(obj-&gt;ap_encode_obj), obj-&gt;buff, obj-&gt;s_buff, &amp;count);</span>
<a href="#l2.149"></a><span id="l2.149">       if (status == noErr || status == errDone) {</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-        //</span>
<a href="#l2.151"></a><span id="l2.151">         // we got the encode data, so call the next stream to write it to the</span>
<a href="#l2.152"></a><span id="l2.152">         // disk.</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-        //</span>
<a href="#l2.154"></a><span id="l2.154">         uint32_t bytesWritten;</span>
<a href="#l2.155"></a><span id="l2.155">         obj-&gt;fileStream-&gt;Write(obj-&gt;buff, count, &amp;bytesWritten);</span>
<a href="#l2.156"></a><span id="l2.156">         if (bytesWritten != (uint32_t)count) status = errFileWrite;</span>
<a href="#l2.157"></a><span id="l2.157">       }</span>
<a href="#l2.158"></a><span id="l2.158">     }</span>
<a href="#l2.159"></a><span id="l2.159"> </span>
<a href="#l2.160"></a><span id="l2.160">     ap_encode_end(&amp;(obj-&gt;ap_encode_obj),</span>
<a href="#l2.161"></a><span id="l2.161">                   (status &gt;= 0));  // if this is true, ok, false abort</span>
<a href="#l2.162"></a><span id="l2.162">     if (obj-&gt;fileStream) obj-&gt;fileStream-&gt;Close();</span>
<a href="#l2.163"></a><span id="l2.163"> </span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-    PR_FREEIF(obj-&gt;buff); /* free the working buff.   */</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+    PR_FREEIF(obj-&gt;buff);  // free the working buff.</span>
<a href="#l2.166"></a><span id="l2.166">     PR_FREEIF(obj);</span>
<a href="#l2.167"></a><span id="l2.167"> </span>
<a href="#l2.168"></a><span id="l2.168">     nsCOMPtr&lt;nsIURI&gt; fileURI;</span>
<a href="#l2.169"></a><span id="l2.169">     NS_NewFileURI(getter_AddRefs(fileURI), mEncodedWorkingFile);</span>
<a href="#l2.170"></a><span id="l2.170"> </span>
<a href="#l2.171"></a><span id="l2.171">     nsCString newURLSpec;</span>
<a href="#l2.172"></a><span id="l2.172">     rv = fileURI-&gt;GetSpec(newURLSpec);</span>
<a href="#l2.173"></a><span id="l2.173">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineat">@@ -977,34 +965,32 @@ nsresult nsMsgAttachmentHandler::UrlExit</span>
<a href="#l2.175"></a><span id="l2.175">   }</span>
<a href="#l2.176"></a><span id="l2.176">   mRequest = nullptr;</span>
<a href="#l2.177"></a><span id="l2.177"> </span>
<a href="#l2.178"></a><span id="l2.178">   // First things first, we are now going to see if this is an HTML</span>
<a href="#l2.179"></a><span id="l2.179">   // Doc and if it is, we need to see if we can determine the charset</span>
<a href="#l2.180"></a><span id="l2.180">   // for this part by sniffing the HTML file.</span>
<a href="#l2.181"></a><span id="l2.181">   // This is needed only when the charset is not set already.</span>
<a href="#l2.182"></a><span id="l2.182">   // (e.g. a charset may be specified in HTTP header)</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-  //</span>
<a href="#l2.184"></a><span id="l2.184">   if (!m_type.IsEmpty() &amp;&amp; m_charset.IsEmpty() &amp;&amp;</span>
<a href="#l2.185"></a><span id="l2.185">       m_type.LowerCaseEqualsLiteral(TEXT_HTML))</span>
<a href="#l2.186"></a><span id="l2.186">     m_charset = nsMsgI18NParseMetaCharset(mTmpFile);</span>
<a href="#l2.187"></a><span id="l2.187"> </span>
<a href="#l2.188"></a><span id="l2.188">   nsresult mimeDeliveryStatus;</span>
<a href="#l2.189"></a><span id="l2.189">   m_mime_delivery_state-&gt;GetStatus(&amp;mimeDeliveryStatus);</span>
<a href="#l2.190"></a><span id="l2.190"> </span>
<a href="#l2.191"></a><span id="l2.191">   if (mimeDeliveryStatus == NS_ERROR_ABORT) status = NS_ERROR_ABORT;</span>
<a href="#l2.192"></a><span id="l2.192"> </span>
<a href="#l2.193"></a><span id="l2.193">   // If the attachment is empty, let's call that a failure.</span>
<a href="#l2.194"></a><span id="l2.194">   if (!m_size) status = NS_ERROR_FAILURE;</span>
<a href="#l2.195"></a><span id="l2.195"> </span>
<a href="#l2.196"></a><span id="l2.196">   if (NS_FAILED(status) &amp;&amp; status != NS_ERROR_ABORT &amp;&amp;</span>
<a href="#l2.197"></a><span id="l2.197">       NS_SUCCEEDED(mimeDeliveryStatus)) {</span>
<a href="#l2.198"></a><span id="l2.198">     // At this point, we should probably ask a question to the user</span>
<a href="#l2.199"></a><span id="l2.199">     // if we should continue without this attachment.</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-    //</span>
<a href="#l2.201"></a><span id="l2.201">     bool keepOnGoing = true;</span>
<a href="#l2.202"></a><span id="l2.202">     nsCString turl;</span>
<a href="#l2.203"></a><span id="l2.203">     nsString msg;</span>
<a href="#l2.204"></a><span id="l2.204">     nsresult rv;</span>
<a href="#l2.205"></a><span id="l2.205">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l2.206"></a><span id="l2.206">         mozilla::services::GetStringBundleService();</span>
<a href="#l2.207"></a><span id="l2.207">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l2.208"></a><span id="l2.208">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineat">@@ -1055,28 +1041,24 @@ nsresult nsMsgAttachmentHandler::UrlExit</span>
<a href="#l2.210"></a><span id="l2.210">                                                          nullptr);</span>
<a href="#l2.211"></a><span id="l2.211">       SetMimeDeliveryState(nullptr);</span>
<a href="#l2.212"></a><span id="l2.212">       return status;</span>
<a href="#l2.213"></a><span id="l2.213">     }</span>
<a href="#l2.214"></a><span id="l2.214">   }</span>
<a href="#l2.215"></a><span id="l2.215"> </span>
<a href="#l2.216"></a><span id="l2.216">   m_done = true;</span>
<a href="#l2.217"></a><span id="l2.217"> </span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-  //</span>
<a href="#l2.219"></a><span id="l2.219">   // Ok, now that we have the file here on disk, we need to see if there was</span>
<a href="#l2.220"></a><span id="l2.220">   // a need to do conversion to plain text...if so, the magic happens here,</span>
<a href="#l2.221"></a><span id="l2.221">   // otherwise, just move on to other attachments...</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-  //</span>
<a href="#l2.223"></a><span id="l2.223">   if (NS_SUCCEEDED(status) &amp;&amp; !m_type.LowerCaseEqualsLiteral(TEXT_PLAIN) &amp;&amp;</span>
<a href="#l2.224"></a><span id="l2.224">       m_desiredType.LowerCaseEqualsLiteral(TEXT_PLAIN)) {</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-    //</span>
<a href="#l2.226"></a><span id="l2.226">     // Conversion to plain text desired.</span>
<a href="#l2.227"></a><span id="l2.227">     // Now use the converter service here to do the right</span>
<a href="#l2.228"></a><span id="l2.228">     // thing and convert this data to plain text for us!</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-    //</span>
<a href="#l2.230"></a><span id="l2.230">     nsAutoString conData;</span>
<a href="#l2.231"></a><span id="l2.231"> </span>
<a href="#l2.232"></a><span id="l2.232">     if (NS_SUCCEEDED(LoadDataFromFile(mTmpFile, conData, true))) {</span>
<a href="#l2.233"></a><span id="l2.233">       bool flowed, delsp, formatted, disallowBreaks;</span>
<a href="#l2.234"></a><span id="l2.234">       GetSerialiserFlags(m_charset.get(), &amp;flowed, &amp;delsp, &amp;formatted,</span>
<a href="#l2.235"></a><span id="l2.235">                          &amp;disallowBreaks);</span>
<a href="#l2.236"></a><span id="l2.236"> </span>
<a href="#l2.237"></a><span id="l2.237">       if (NS_SUCCEEDED(ConvertBufToPlainText(conData, flowed, delsp, formatted,</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineat">@@ -1120,34 +1102,31 @@ nsresult nsMsgAttachmentHandler::UrlExit</span>
<a href="#l2.239"></a><span id="l2.239">   NS_ASSERTION(pendingAttachmentCount &gt; 0, &quot;no more pending attachment&quot;);</span>
<a href="#l2.240"></a><span id="l2.240"> </span>
<a href="#l2.241"></a><span id="l2.241">   m_mime_delivery_state-&gt;SetPendingAttachmentCount(pendingAttachmentCount - 1);</span>
<a href="#l2.242"></a><span id="l2.242"> </span>
<a href="#l2.243"></a><span id="l2.243">   bool processAttachmentsSynchronously = false;</span>
<a href="#l2.244"></a><span id="l2.244">   m_mime_delivery_state-&gt;GetProcessAttachmentsSynchronously(</span>
<a href="#l2.245"></a><span id="l2.245">       &amp;processAttachmentsSynchronously);</span>
<a href="#l2.246"></a><span id="l2.246">   if (NS_SUCCEEDED(status) &amp;&amp; processAttachmentsSynchronously) {</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-    /* Find the next attachment which has not yet been loaded,</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-     if any, and start it going.</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-     */</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+    // Find the next attachment which has not yet been loaded,</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+    // if any, and start it going.</span>
<a href="#l2.252"></a><span id="l2.252">     uint32_t i;</span>
<a href="#l2.253"></a><span id="l2.253">     nsMsgAttachmentHandler *next = 0;</span>
<a href="#l2.254"></a><span id="l2.254">     nsTArray&lt;RefPtr&lt;nsMsgAttachmentHandler&gt;&gt; *attachments;</span>
<a href="#l2.255"></a><span id="l2.255"> </span>
<a href="#l2.256"></a><span id="l2.256">     m_mime_delivery_state-&gt;GetAttachmentHandlers(&amp;attachments);</span>
<a href="#l2.257"></a><span id="l2.257"> </span>
<a href="#l2.258"></a><span id="l2.258">     for (i = 0; i &lt; attachments-&gt;Length(); i++) {</span>
<a href="#l2.259"></a><span id="l2.259">       if (!(*attachments)[i]-&gt;m_done) {</span>
<a href="#l2.260"></a><span id="l2.260">         next = (*attachments)[i];</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-        //</span>
<a href="#l2.262"></a><span id="l2.262">         // rhp: We need to get a little more understanding to failed URL</span>
<a href="#l2.263"></a><span id="l2.263">         // requests. So, at this point if most of next is NULL, then we</span>
<a href="#l2.264"></a><span id="l2.264">         // should just mark it fetched and move on! We probably ignored</span>
<a href="#l2.265"></a><span id="l2.265">         // this earlier on in the send process.</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-        //</span>
<a href="#l2.267"></a><span id="l2.267">         if ((!next-&gt;mURL) &amp;&amp; (next-&gt;m_uri.IsEmpty())) {</span>
<a href="#l2.268"></a><span id="l2.268">           (*attachments)[i]-&gt;m_done = true;</span>
<a href="#l2.269"></a><span id="l2.269">           (*attachments)[i]-&gt;SetMimeDeliveryState(nullptr);</span>
<a href="#l2.270"></a><span id="l2.270">           m_mime_delivery_state-&gt;GetPendingAttachmentCount(</span>
<a href="#l2.271"></a><span id="l2.271">               &amp;pendingAttachmentCount);</span>
<a href="#l2.272"></a><span id="l2.272">           m_mime_delivery_state-&gt;SetPendingAttachmentCount(</span>
<a href="#l2.273"></a><span id="l2.273">               pendingAttachmentCount - 1);</span>
<a href="#l2.274"></a><span id="l2.274">           next-&gt;mPartUserOmissionOverride = true;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

