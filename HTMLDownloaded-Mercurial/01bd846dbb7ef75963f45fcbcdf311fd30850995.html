<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2958:01bd846dbb7ef75963f45fcbcdf311fd30850995</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 01bd846dbb7ef75963f45fcbcdf311fd30850995" />
<meta property="og:url" content="/comm-central/rev/01bd846dbb7ef75963f45fcbcdf311fd30850995" />
<meta property="og:description" content="Bug 467768 -- &quot;No way to make mail open in tabs by default&quot;. r=asuth for folder display parts and tests, bienvenu for desktop search integration and mailnews/, Mnyromyr for mailnews/ and suite/; sr=bienvenu; ui-r=clarkbw." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 01bd846dbb7ef75963f45fcbcdf311fd30850995 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/01bd846dbb7ef75963f45fcbcdf311fd30850995">shortlog</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/01bd846dbb7ef75963f45fcbcdf311fd30850995">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995">files</a> |
changeset |
<a href="/comm-central/raw-rev/01bd846dbb7ef75963f45fcbcdf311fd30850995">raw</a>  | <a href="/comm-central/archive/01bd846dbb7ef75963f45fcbcdf311fd30850995.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=467768">Bug 467768</a> -- &quot;No way to make mail open in tabs by default&quot;. r=asuth for folder display parts and tests, bienvenu for desktop search integration and mailnews/, Mnyromyr for mailnews/ and suite/; sr=bienvenu; ui-r=clarkbw.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#105;&#100;&#100;&#104;&#97;&#114;&#116;&#104;&#32;&#65;&#103;&#97;&#114;&#119;&#97;&#108;&#32;&#60;&#115;&#105;&#100;&#46;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 29 Jun 2009 01:55:15 +0530</td></tr>

<tr>
 <td>changeset 2958</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/01bd846dbb7ef75963f45fcbcdf311fd30850995">01bd846dbb7ef75963f45fcbcdf311fd30850995</a></td>
</tr>



<tr>
<td>parent 2957</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/235b52d1d6654db0124a23f2973573dec4254add">235b52d1d6654db0124a23f2973573dec4254add</a>
</td>
</tr>

<tr>
<td>child 2959</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ff9b5051d01df904cf3c67a2945ff854527a871f">ff9b5051d01df904cf3c67a2945ff854527a871f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=01bd846dbb7ef75963f45fcbcdf311fd30850995">2399</a></td></tr>
<tr><td>push user</td><td>sid.bugzilla@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 28 Jun 2009 20:26:23 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@ff9b5051d01d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ff9b5051d01df904cf3c67a2945ff854527a871f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ff9b5051d01df904cf3c67a2945ff854527a871f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ff9b5051d01df904cf3c67a2945ff854527a871f&newProject=comm-central&newRevision=01bd846dbb7ef75963f45fcbcdf311fd30850995&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ff9b5051d01df904cf3c67a2945ff854527a871f&newProject=comm-central&newRevision=01bd846dbb7ef75963f45fcbcdf311fd30850995&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ff9b5051d01df904cf3c67a2945ff854527a871f&newProject=comm-central&newRevision=01bd846dbb7ef75963f45fcbcdf311fd30850995&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28asuth%29&revcount=50">asuth</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a>, <a href="/comm-central/log?rev=reviewer%28clarkbw%29&revcount=50">clarkbw</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=467768">467768</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=467768">Bug 467768</a> -- &quot;No way to make mail open in tabs by default&quot;. r=asuth for folder display parts and tests, bienvenu for desktop search integration and mailnews/, Mnyromyr for mailnews/ and suite/; sr=bienvenu; ui-r=clarkbw.

Add support for opening mail in tabs, and for opening tabs in the background.
Fix most code that opens mail to obey the preference.
Fix several cases of multiple message loads at once with tabs (including with message tab restore at startup) and the standalone message window.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/app/profile/all-thunderbird.js">mail/app/profile/all-thunderbird.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/app/profile/all-thunderbird.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/app/profile/all-thunderbird.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/app/profile/all-thunderbird.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/app/profile/all-thunderbird.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/app/profile/all-thunderbird.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/Makefile.in">mail/base/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/Makefile.in">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/Makefile.in">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/Makefile.in">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/Makefile.in">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/mailWindowOverlay.xul">mail/base/content/mailWindowOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/mailWindowOverlay.xul">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/mailWindowOverlay.xul">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/mailWindowOverlay.xul">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/mailWindowOverlay.xul">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/mailWindowOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/messageDisplay.js">mail/base/content/messageDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/messageDisplay.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/messageDisplay.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/messageDisplay.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/messageDisplay.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/messageDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/messageWindow.js">mail/base/content/messageWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/messageWindow.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/messageWindow.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/messageWindow.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/messageWindow.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/messageWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/search.xml">mail/base/content/search.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/search.xml">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/search.xml">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/search.xml">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/search.xml">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/search.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/specialTabs.js">mail/base/content/specialTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/specialTabs.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/specialTabs.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/specialTabs.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/specialTabs.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/specialTabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/tabmail.xml">mail/base/content/tabmail.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/tabmail.xml">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/tabmail.xml">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/tabmail.xml">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/tabmail.xml">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/tabmail.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/widgetglue.js">mail/base/content/widgetglue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/widgetglue.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/widgetglue.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/widgetglue.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/widgetglue.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/content/widgetglue.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/MailConsts.js">mail/base/modules/MailConsts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/MailConsts.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/MailConsts.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/MailConsts.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/MailConsts.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/MailConsts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/MailUtils.js">mail/base/modules/MailUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/MailUtils.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/MailUtils.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/MailUtils.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/MailUtils.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/MailUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/Makefile.in">mail/base/modules/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/Makefile.in">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/Makefile.in">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/Makefile.in">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/Makefile.in">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/base/modules/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/nsMailDefaultHandler.js">mail/components/nsMailDefaultHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/nsMailDefaultHandler.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/nsMailDefaultHandler.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/nsMailDefaultHandler.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/nsMailDefaultHandler.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/nsMailDefaultHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/preferences/advanced.xul">mail/components/preferences/advanced.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/preferences/advanced.xul">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/preferences/advanced.xul">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/preferences/advanced.xul">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/preferences/advanced.xul">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/preferences/advanced.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/SpotlightIntegration.js">mail/components/search/SpotlightIntegration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/SpotlightIntegration.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/SpotlightIntegration.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/SpotlightIntegration.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/SpotlightIntegration.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/SpotlightIntegration.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/WinSearchIntegration.js">mail/components/search/WinSearchIntegration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/WinSearchIntegration.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/WinSearchIntegration.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/WinSearchIntegration.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/WinSearchIntegration.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/WinSearchIntegration.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/content/searchCommon.js">mail/components/search/content/searchCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/content/searchCommon.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/content/searchCommon.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/content/searchCommon.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/content/searchCommon.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/components/search/content/searchCommon.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/installer/windows/packages-static">mail/installer/windows/packages-static</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/installer/windows/packages-static">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/installer/windows/packages-static">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/installer/windows/packages-static">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/installer/windows/packages-static">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/installer/windows/packages-static">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/locales/en-US/chrome/messenger/messenger.properties">mail/locales/en-US/chrome/messenger/messenger.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/locales/en-US/chrome/messenger/messenger.properties">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/locales/en-US/chrome/messenger/messenger.properties">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/locales/en-US/chrome/messenger/messenger.properties">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/locales/en-US/chrome/messenger/messenger.properties">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/locales/en-US/chrome/messenger/messenger.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/locales/en-US/chrome/messenger/preferences/advanced.dtd">mail/locales/en-US/chrome/messenger/preferences/advanced.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/locales/en-US/chrome/messenger/preferences/advanced.dtd">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/locales/en-US/chrome/messenger/preferences/advanced.dtd">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/locales/en-US/chrome/messenger/preferences/advanced.dtd">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/locales/en-US/chrome/messenger/preferences/advanced.dtd">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/locales/en-US/chrome/messenger/preferences/advanced.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-message-window.js">mail/test/mozmill/folder-display/test-message-window.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-message-window.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-message-window.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-message-window.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-message-window.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-message-window.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-opening-messages.js">mail/test/mozmill/folder-display/test-opening-messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-opening-messages.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-opening-messages.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-opening-messages.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-opening-messages.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-opening-messages.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-right-click-middle-click.js">mail/test/mozmill/folder-display/test-right-click-middle-click.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-right-click-middle-click.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-right-click-middle-click.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-right-click-middle-click.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-right-click-middle-click.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/folder-display/test-right-click-middle-click.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/shared-modules/test-window-helpers.js">mail/test/mozmill/shared-modules/test-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/shared-modules/test-window-helpers.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/shared-modules/test-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/shared-modules/test-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/shared-modules/test-window-helpers.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mail/test/mozmill/shared-modules/test-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/build/nsMsgFactory.cpp">mailnews/base/build/nsMsgFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/build/nsMsgFactory.cpp">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/build/nsMsgFactory.cpp">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/build/nsMsgFactory.cpp">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/build/nsMsgFactory.cpp">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/build/nsMsgFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/Makefile.in">mailnews/base/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/dbViewWrapper.js">mailnews/base/src/dbViewWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/dbViewWrapper.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/dbViewWrapper.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/dbViewWrapper.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/dbViewWrapper.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/dbViewWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMailNewsCommandLineHandler.js">mailnews/base/src/nsMailNewsCommandLineHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMailNewsCommandLineHandler.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMailNewsCommandLineHandler.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMailNewsCommandLineHandler.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMailNewsCommandLineHandler.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMailNewsCommandLineHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMessengerBootstrap.cpp">mailnews/base/src/nsMessengerBootstrap.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMessengerBootstrap.cpp">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMessengerBootstrap.cpp">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMessengerBootstrap.cpp">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMessengerBootstrap.cpp">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMessengerBootstrap.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMessengerBootstrap.h">mailnews/base/src/nsMessengerBootstrap.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMessengerBootstrap.h">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMessengerBootstrap.h">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMessengerBootstrap.h">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMessengerBootstrap.h">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/src/nsMessengerBootstrap.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/test/unit/test_jsTreeSelection.js">mailnews/base/test/unit/test_jsTreeSelection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/test/unit/test_jsTreeSelection.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/test/unit/test_jsTreeSelection.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/test/unit/test_jsTreeSelection.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/test/unit/test_jsTreeSelection.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/test/unit/test_jsTreeSelection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/util/jsTreeSelection.js">mailnews/base/util/jsTreeSelection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/util/jsTreeSelection.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/util/jsTreeSelection.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/util/jsTreeSelection.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/util/jsTreeSelection.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/base/util/jsTreeSelection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/mailnews/mailnews.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/installer/unix/packages">suite/installer/unix/packages</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/installer/unix/packages">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/installer/unix/packages">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/installer/unix/packages">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/installer/unix/packages">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/installer/unix/packages">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/installer/windows/packages">suite/installer/windows/packages</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/installer/windows/packages">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/installer/windows/packages">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/installer/windows/packages">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/installer/windows/packages">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/installer/windows/packages">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/Makefile.in">suite/mailnews/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/Makefile.in">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/Makefile.in">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/Makefile.in">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/Makefile.in">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/modules/MailUtils.js">suite/mailnews/modules/MailUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/modules/MailUtils.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/modules/MailUtils.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/modules/MailUtils.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/modules/MailUtils.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/modules/MailUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/modules/Makefile.in">suite/mailnews/modules/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/modules/Makefile.in">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/modules/Makefile.in">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/modules/Makefile.in">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/modules/Makefile.in">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/modules/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/widgetglue.js">suite/mailnews/widgetglue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/widgetglue.js">file</a> |
<a href="/comm-central/annotate/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/widgetglue.js">annotate</a> |
<a href="/comm-central/diff/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/widgetglue.js">diff</a> |
<a href="/comm-central/comparison/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/widgetglue.js">comparison</a> |
<a href="/comm-central/log/01bd846dbb7ef75963f45fcbcdf311fd30850995/suite/mailnews/widgetglue.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -390,16 +390,26 @@ pref(&quot;browser.safebrowsing.warning.infoU</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> // prevent status-bar spoofing even if people are foolish enough to turn on JS</span>
<a href="#l1.6"></a><span id="l1.6"> pref(&quot;dom.disable_window_status_change&quot;,          true);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> // For the Empty Junk/Trash confirmation dialogs.</span>
<a href="#l1.9"></a><span id="l1.9"> pref(&quot;mail.emptyJunk.dontAskAgain&quot;, false);</span>
<a href="#l1.10"></a><span id="l1.10"> pref(&quot;mail.emptyTrash.dontAskAgain&quot;, false);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+// If a message is opened using Enter or a double click, what should we do?</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+// 0 - open it in a new window</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+// 1 - open it in an existing window</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+// 2 - open it in a new tab</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+pref(&quot;mail.openMessageBehavior&quot;, 2);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+pref(&quot;mail.openMessageBehavior.version&quot;, 0);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+// If messages or folders are opened using the context menu or a middle click,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+// should we open them in the foreground or in the background?</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+pref(&quot;mail.contextMenuBackgroundTabs&quot;, true);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+</span>
<a href="#l1.22"></a><span id="l1.22"> // Tabs</span>
<a href="#l1.23"></a><span id="l1.23"> pref(&quot;mail.tabs.tabMinWidth&quot;, 100);</span>
<a href="#l1.24"></a><span id="l1.24"> pref(&quot;mail.tabs.tabMaxWidth&quot;, 250);</span>
<a href="#l1.25"></a><span id="l1.25"> pref(&quot;mail.tabs.tabClipWidth&quot;, 140);</span>
<a href="#l1.26"></a><span id="l1.26"> pref(&quot;mail.tabs.autoHide&quot;, false);</span>
<a href="#l1.27"></a><span id="l1.27"> pref(&quot;mail.tabs.closeWindowWithLastTab&quot;, true);</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> // Where to show tab close buttons:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/Makefile.in</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/Makefile.in</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -37,16 +37,18 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> DEPTH		= ../..</span>
<a href="#l2.6"></a><span id="l2.6"> topsrcdir	= @top_srcdir@</span>
<a href="#l2.7"></a><span id="l2.7"> srcdir		= @srcdir@</span>
<a href="#l2.8"></a><span id="l2.8"> VPATH		= @srcdir@</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+DIRS = modules</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14"> DEFINES += -DMOZ_APP_VERSION=$(MOZ_APP_VERSION)</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> ifneq (,$(BUILD_OFFICIAL)$(MOZILLA_OFFICIAL))</span>
<a href="#l2.17"></a><span id="l2.17"> DEFINES += -DOFFICIAL_BUILD=1</span>
<a href="#l2.18"></a><span id="l2.18"> endif</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> ifneq (,$(filter windows gtk2 mac cocoa, $(MOZ_WIDGET_TOOLKIT)))</span>
<a href="#l2.21"></a><span id="l2.21"> DEFINES += -DHAVE_SHELL_SERVICE=1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -33,16 +33,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.5"></a><span id="l3.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.6"></a><span id="l3.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.7"></a><span id="l3.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.8"></a><span id="l3.8">  *</span>
<a href="#l3.9"></a><span id="l3.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> Components.utils.import(&quot;resource://app/modules/dbViewWrapper.js&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/jsTreeSelection.js&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> var gFolderDisplay = null;</span>
<a href="#l3.15"></a><span id="l3.15"> var gMessageDisplay = null;</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> var nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> /**</span>
<a href="#l3.20"></a><span id="l3.20">  * Abstraction for a widget that (roughly speaking) displays the contents of</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -137,33 +138,45 @@ function FolderDisplayWidget(aTabInfo, a</span>
<a href="#l3.22"></a><span id="l3.22">   /**</span>
<a href="#l3.23"></a><span id="l3.23">    * Create a fake tree box object for if/when this folder is in the background.</span>
<a href="#l3.24"></a><span id="l3.24">    * We need to give it a bogus DOM object to send events to, so we choose the</span>
<a href="#l3.25"></a><span id="l3.25">    *  mail-toolbox, who is hopefully unlikely to take offense.</span>
<a href="#l3.26"></a><span id="l3.26">    */</span>
<a href="#l3.27"></a><span id="l3.27">   this._fakeTreeBox = dummyDOMNode ?</span>
<a href="#l3.28"></a><span id="l3.28">                         new FakeTreeBoxObject(dummyDOMNode.boxObject) : null;</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  /**</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+   * Create a fake tree selection for cases where we have opened a background</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+   * tab. We'll get rid of this as soon as we've switched to the tab for the</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+   * first time, and have a real tree selection.</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+   */</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  this._fakeTreeSelection = new JSTreeSelection(this._fakeTreeBox);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+</span>
<a href="#l3.37"></a><span id="l3.37">   this._mostRecentSelectionCounts = [];</span>
<a href="#l3.38"></a><span id="l3.38">   this._mostRecentCurrentIndices = [];</span>
<a href="#l3.39"></a><span id="l3.39"> }</span>
<a href="#l3.40"></a><span id="l3.40"> FolderDisplayWidget.prototype = {</span>
<a href="#l3.41"></a><span id="l3.41">   /**</span>
<a href="#l3.42"></a><span id="l3.42">    * @return the currently displayed folder.  This is just proxied from the</span>
<a href="#l3.43"></a><span id="l3.43">    *     view wrapper.</span>
<a href="#l3.44"></a><span id="l3.44">    */</span>
<a href="#l3.45"></a><span id="l3.45">   get displayedFolder() {</span>
<a href="#l3.46"></a><span id="l3.46">     return this._nonViewFolder || this.view.displayedFolder;</span>
<a href="#l3.47"></a><span id="l3.47">   },</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49">   /**</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-   * @return the nsITreeSelection object for our tree view if there is one,</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-   *     null otherwise.</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+   * @return the nsITreeSelection object for our tree view.  This exists for</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+   *     the benefit of message tabs that haven't been switched to yet.</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+   *     We provide a fake tree selection in those cases.</span>
<a href="#l3.55"></a><span id="l3.55">    */</span>
<a href="#l3.56"></a><span id="l3.56">   get treeSelection() {</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+    // If we haven't switched to this tab yet, dbView will exist but</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+    // dbView.selection won't, so use the fake tree selection instead.</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+    if (this._fakeTreeSelection)</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+      return this._fakeTreeSelection;</span>
<a href="#l3.61"></a><span id="l3.61">     if (this.view.dbView)</span>
<a href="#l3.62"></a><span id="l3.62">       return this.view.dbView.selection;</span>
<a href="#l3.63"></a><span id="l3.63">     else</span>
<a href="#l3.64"></a><span id="l3.64">       return null;</span>
<a href="#l3.65"></a><span id="l3.65">   },</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67">   /**</span>
<a href="#l3.68"></a><span id="l3.68">    * Number of headers to tell the message database to cache when we enter a</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineat">@@ -542,16 +555,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l3.70"></a><span id="l3.70">     //  down to the message display and we don't want it doing anything it</span>
<a href="#l3.71"></a><span id="l3.71">     //  doesn't have to do.</span>
<a href="#l3.72"></a><span id="l3.72">     this.messageDisplay._close();</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74">     this.view.close();</span>
<a href="#l3.75"></a><span id="l3.75">     this.messenger.setWindow(null, null);</span>
<a href="#l3.76"></a><span id="l3.76">     this.messenger = null;</span>
<a href="#l3.77"></a><span id="l3.77">     this._fakeTreeBox = null;</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+    this._fakeTreeSelection = null;</span>
<a href="#l3.79"></a><span id="l3.79">   },</span>
<a href="#l3.80"></a><span id="l3.80"> </span>
<a href="#l3.81"></a><span id="l3.81">   /*   ===============================   */</span>
<a href="#l3.82"></a><span id="l3.82">   /* ===== IDBViewWrapper Listener ===== */</span>
<a href="#l3.83"></a><span id="l3.83">   /*   ===============================   */</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85">   /**</span>
<a href="#l3.86"></a><span id="l3.86">    * @return true if the mail view picker is visible.  This affects whether the</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineat">@@ -765,39 +779,16 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l3.88"></a><span id="l3.88">     }</span>
<a href="#l3.89"></a><span id="l3.89"> </span>
<a href="#l3.90"></a><span id="l3.90">     // - new messages</span>
<a href="#l3.91"></a><span id="l3.91">     // if configured to scroll to new messages, try that</span>
<a href="#l3.92"></a><span id="l3.92">     if (gPrefBranch.getBoolPref(&quot;mailnews.scroll_to_new_message&quot;) &amp;&amp;</span>
<a href="#l3.93"></a><span id="l3.93">         this.navigate(nsMsgNavigationType.firstNew, /* select */ false))</span>
<a href="#l3.94"></a><span id="l3.94">       return;</span>
<a href="#l3.95"></a><span id="l3.95"> </span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-    // - last selected message</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-    // if configured to load the last selected message (this is currently more</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-    //  persistent than our saveSelection/restoreSelection stuff), and the view</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-    //  is backed by a single underlying folder (the only way having just a</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-    //  message key works out), try that</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-    if (gPrefBranch.getBoolPref(&quot;mailnews.remember_selected_message&quot;) &amp;&amp;</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-        this.view.isSingleFolder) {</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-      // use the displayed folder; nsMsgDBView goes to the effort to save the</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-      //  state to the viewFolder, so this is the correct course of action.</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-      let lastLoadedMessageKey = this.view.displayedFolder.lastMessageLoaded;</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-      if (lastLoadedMessageKey != nsMsgKey_None) {</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-        this.view.dbView.selectMsgByKey(lastLoadedMessageKey);</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-        // The message key may not be present in the view for a variety of</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-        //  reasons.  Beyond message deletion, it simply may not match the</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-        //  active mail view or quick search, for example.</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-        if (this.view.dbView.numSelected) {</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-          this.ensureRowIsVisible(</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-            this.view.dbView.viewIndexForFirstSelectedMsg);</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-          return;</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-        }</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-      }</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-    }</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-</span>
<a href="#l3.119"></a><span id="l3.119">     // - towards the newest messages, but don't select</span>
<a href="#l3.120"></a><span id="l3.120">     if (this.view.isSortedAscending &amp;&amp; this.view.sortImpliesTemporalOrdering &amp;&amp;</span>
<a href="#l3.121"></a><span id="l3.121">       this.navigate(nsMsgNavigationType.lastMessage, /* select */ false))</span>
<a href="#l3.122"></a><span id="l3.122">       return;</span>
<a href="#l3.123"></a><span id="l3.123"> </span>
<a href="#l3.124"></a><span id="l3.124">     // - to the top, the coliseum</span>
<a href="#l3.125"></a><span id="l3.125">     this.ensureRowIsVisible(0);</span>
<a href="#l3.126"></a><span id="l3.126">   },</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineat">@@ -1197,37 +1188,65 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l3.128"></a><span id="l3.128">     messenger = this.messenger;</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130">     // update singleton globals' state</span>
<a href="#l3.131"></a><span id="l3.131">     msgWindow.openFolder = this.view.displayedFolder;</span>
<a href="#l3.132"></a><span id="l3.132"> </span>
<a href="#l3.133"></a><span id="l3.133">     this._active = true;</span>
<a href="#l3.134"></a><span id="l3.134">     this._runNotificationsPendingActivation();</span>
<a href="#l3.135"></a><span id="l3.135"> </span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+    // Make sure we get rid of this._fakeTreeSelection, whether we use it below</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+    // or not.</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+    let fakeTreeSelection = this._fakeTreeSelection;</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+    this._fakeTreeSelection = null;</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+</span>
<a href="#l3.141"></a><span id="l3.141">     // -- UI</span>
<a href="#l3.142"></a><span id="l3.142"> </span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+    // We're going to set this to true if we've already caused a</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    // selectionChanged event, so that the message display doesn't cause</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+    // another.</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+    let dontReloadMessage = false;</span>
<a href="#l3.147"></a><span id="l3.147">     // thread pane if we have a db view</span>
<a href="#l3.148"></a><span id="l3.148">     if (this.view.dbView) {</span>
<a href="#l3.149"></a><span id="l3.149">       // Make sure said thread pane is visible.  If we do this after we re-root</span>
<a href="#l3.150"></a><span id="l3.150">       //  the tree, the thread pane may not actually replace the account central</span>
<a href="#l3.151"></a><span id="l3.151">       //  pane.  Concerning...</span>
<a href="#l3.152"></a><span id="l3.152">       this._showThreadPane();</span>
<a href="#l3.153"></a><span id="l3.153"> </span>
<a href="#l3.154"></a><span id="l3.154">       // some things only need to happen if we are transitioning from inactive</span>
<a href="#l3.155"></a><span id="l3.155">       //  to active</span>
<a href="#l3.156"></a><span id="l3.156">       if (wasInactive) {</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-        // Setting the 'view' attribute on treeBox results in the following</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-        //  effective calls, noting that in makeInactive we made sure to null</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-        //  out its view so that it won't try and clean up any views or their</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-        //  selections.  (The actual actions happen in nsTreeBodyFrame::SetView)</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-        // - this.view.dbView.selection.tree = this.treeBox</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-        // - this.view.dbView.setTree(this.treeBox)</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-        // - this.treeBox.view = this.view.dbView (in nsTreeBodyObject::SetView)</span>
<a href="#l3.164"></a><span id="l3.164">         if (this.treeBox) {</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+          // We might have assigned our JS tree selection to</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+          //  this.view.dbView.selection back in _hookUpFakeTreeBox. If we've</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+          //  done so, null the selection out so that the line after this</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+          //  causes a real selection to be created.</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+          // If we haven't done so, we're fine as selection would be null here</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+          //  anyway. (The fake tree selection should persist only till the</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+          //  first time the tab is switched to.)</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+          if (fakeTreeSelection)</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+            this.view.dbView.selection = null;</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+          // Setting the 'view' attribute on treeBox results in the following</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+          //  effective calls, noting that in makeInactive we made sure to null</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+          //  out its view so that it won't try and clean up any views or their</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+          //  selections.  (The actual actions happen in</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+          //  nsTreeBodyFrame::SetView)</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+          // - this.view.dbView.selection.tree = this.treeBox</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+          // - this.view.dbView.setTree(this.treeBox)</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+          // - this.treeBox.view = this.view.dbView (in</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+          //   nsTreeBodyObject::SetView)</span>
<a href="#l3.184"></a><span id="l3.184">           this.treeBox.view = this.view.dbView;</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+          if (fakeTreeSelection) {</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+            fakeTreeSelection.duplicateSelection(this.view.dbView.selection);</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+            // Since duplicateSelection will fire a selectionChanged event,</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+            // which will try to reload the message, we shouldn't do the same.</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+            dontReloadMessage = true;</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+          }</span>
<a href="#l3.192"></a><span id="l3.192">           if (this._savedFirstVisibleRow != null)</span>
<a href="#l3.193"></a><span id="l3.193">             this.treeBox.scrollToRow(this._savedFirstVisibleRow);</span>
<a href="#l3.194"></a><span id="l3.194"> </span>
<a href="#l3.195"></a><span id="l3.195">           this.restoreColumnStates();</span>
<a href="#l3.196"></a><span id="l3.196">         }</span>
<a href="#l3.197"></a><span id="l3.197"> </span>
<a href="#l3.198"></a><span id="l3.198">         // restore the quick search widget</span>
<a href="#l3.199"></a><span id="l3.199">         let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineat">@@ -1249,17 +1268,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l3.201"></a><span id="l3.201">       if (this._tabInfo)</span>
<a href="#l3.202"></a><span id="l3.202">         mailTabType._setPaneStates(this._tabInfo.mode.legalPanes,</span>
<a href="#l3.203"></a><span id="l3.203">           {folder: !this._tabInfo.folderPaneCollapsed,</span>
<a href="#l3.204"></a><span id="l3.204">            message: this.messageDisplay.visible});</span>
<a href="#l3.205"></a><span id="l3.205"> </span>
<a href="#l3.206"></a><span id="l3.206">       // update the columns and such that live inside the thread pane</span>
<a href="#l3.207"></a><span id="l3.207">       this._updateThreadDisplay();</span>
<a href="#l3.208"></a><span id="l3.208"> </span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-      this.messageDisplay.makeActive();</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+      this.messageDisplay.makeActive(dontReloadMessage);</span>
<a href="#l3.211"></a><span id="l3.211">     }</span>
<a href="#l3.212"></a><span id="l3.212">     // account central stuff when we don't have a dbview</span>
<a href="#l3.213"></a><span id="l3.213">     else {</span>
<a href="#l3.214"></a><span id="l3.214">       this._showAccountCentral();</span>
<a href="#l3.215"></a><span id="l3.215">       if (this._tabInfo)</span>
<a href="#l3.216"></a><span id="l3.216">         mailTabType._setPaneStates(this._tabInfo.mode.accountCentralLegalPanes,</span>
<a href="#l3.217"></a><span id="l3.217">           {folder: !this._tabInfo.folderPaneCollapsed});</span>
<a href="#l3.218"></a><span id="l3.218">     }</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineat">@@ -1314,38 +1333,54 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l3.220"></a><span id="l3.220">       let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l3.221"></a><span id="l3.221">       if (searchInput) {</span>
<a href="#l3.222"></a><span id="l3.222">         this._savedQuickSearch = {</span>
<a href="#l3.223"></a><span id="l3.223">           text: searchInput.showingSearchCriteria ? null : searchInput.value,</span>
<a href="#l3.224"></a><span id="l3.224">           searchMode: searchInput.searchMode</span>
<a href="#l3.225"></a><span id="l3.225">         };</span>
<a href="#l3.226"></a><span id="l3.226">       }</span>
<a href="#l3.227"></a><span id="l3.227"> </span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-      // save off the tree selection object.  the nsTreeBodyFrame will make the</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-      //  view forget about it when our view is removed, so it's up to us to</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-      //  save it.</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-      let treeViewSelection = this.view.dbView.selection;</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-      // make the tree forget about the view right now so we can tell the db</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-      //  view about its selection object so it can try and keep it up-to-date</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-      //  even while hidden in the background</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-      if (this.treeBox)</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-        this.treeBox.view = null;</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-      // (and tell the db view about its selection again...)</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-      this.view.dbView.selection = treeViewSelection;</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-      // hook the dbview up to the fake tree box</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-      this._fakeTreeBox.view = this.view.dbView;</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-      this.view.dbView.setTree(this._fakeTreeBox);</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-      treeViewSelection.tree = this._fakeTreeBox;</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+      this.hookUpFakeTreeBox(true);</span>
<a href="#l3.245"></a><span id="l3.245">     }</span>
<a href="#l3.246"></a><span id="l3.246"> </span>
<a href="#l3.247"></a><span id="l3.247">     this.messageDisplay.makeInactive();</span>
<a href="#l3.248"></a><span id="l3.248">   },</span>
<a href="#l3.249"></a><span id="l3.249"> </span>
<a href="#l3.250"></a><span id="l3.250">   /**</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+   * Called when we want to &quot;disable&quot; the real treeBox for a while and hook up</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+   * the fake tree box to the db view. This also takes care of our</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+   * treeSelection object.</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+   *</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+   * @param aNullRealTreeBoxView true if we want to null out the real tree box.</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+   *          We don't want to null out the view if we're opening a background</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+   *          tab, for example.</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+   */</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+  hookUpFakeTreeBox: function FolderDisplayWidget_hookUpFakeTreeBox(</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+                         aNullRealTreeBoxView) {</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+    // save off the tree selection object.  the nsTreeBodyFrame will make the</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+    //  view forget about it when our view is removed, so it's up to us to</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+    //  save it.</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+    // We use this.treeSelection instead of this.view.dbView.selection here,</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+    //  so that we get the fake tree selection if we have it.</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+    let treeSelection = this.treeSelection;</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+    // if we want to, make the tree forget about the view right now so we can</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+    //  tell the db view about its selection object so it can try and keep it</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+    //  up-to-date even while hidden in the background</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+    if (aNullRealTreeBoxView &amp;&amp; this.treeBox)</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+      this.treeBox.view = null;</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+    // (and tell the db view about its selection again...)</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+    this.view.dbView.selection = treeSelection;</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+    // hook the dbview up to the fake tree box</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+    this._fakeTreeBox.view = this.view.dbView;</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+    this.view.dbView.setTree(this._fakeTreeBox);</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+    treeSelection.tree = this._fakeTreeBox;</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+  },</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+  /**</span>
<a href="#l3.282"></a><span id="l3.282">    * @return true if there is a db view and the command is enabled on the view.</span>
<a href="#l3.283"></a><span id="l3.283">    *  This function hides some of the XPCOM-odditities of the getCommandStatus</span>
<a href="#l3.284"></a><span id="l3.284">    *  call.</span>
<a href="#l3.285"></a><span id="l3.285">    */</span>
<a href="#l3.286"></a><span id="l3.286">   getCommandStatus: function FolderDisplayWidget_getCommandStatus(</span>
<a href="#l3.287"></a><span id="l3.287">       aCommandType, aEnabledObj, aCheckStatusObj) {</span>
<a href="#l3.288"></a><span id="l3.288">     // no view means not enabled</span>
<a href="#l3.289"></a><span id="l3.289">     if (!this.view.dbView)</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineat">@@ -1626,59 +1661,57 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l3.291"></a><span id="l3.291">     if (!treeSelection)</span>
<a href="#l3.292"></a><span id="l3.292">       return;</span>
<a href="#l3.293"></a><span id="l3.293">     treeSelection.clearSelection();</span>
<a href="#l3.294"></a><span id="l3.294">     this.messageDisplay.clearDisplay();</span>
<a href="#l3.295"></a><span id="l3.295">     this._updateContextDisplay();</span>
<a href="#l3.296"></a><span id="l3.296">   },</span>
<a href="#l3.297"></a><span id="l3.297"> </span>
<a href="#l3.298"></a><span id="l3.298">   /**</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-   * Select a message for display by header.  If the view is active, attempt</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-   *  to select the message right now.  If the view is not active or we were</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-   *  unable to find it, update our saved selection to want to display the</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-   *  message.  Threads are expanded to find the header.</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+   * Select a message for display by header.  Attempt to select the message</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+   *  right now.  If we were unable to find it, update our saved selection</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+   *  to want to display the message.  Threads are expanded to find the header.</span>
<a href="#l3.306"></a><span id="l3.306">    *</span>
<a href="#l3.307"></a><span id="l3.307">    * @param aMsgHdr The message header to select for display.</span>
<a href="#l3.308"></a><span id="l3.308">    */</span>
<a href="#l3.309"></a><span id="l3.309">   selectMessage: function FolderDisplayWidget_selectMessage(aMsgHdr,</span>
<a href="#l3.310"></a><span id="l3.310">       aForceNotification) {</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-    if (this.active) {</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-      let viewIndex = this.view.dbView.findIndexOfMsgHdr(aMsgHdr, true);</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-      if (viewIndex != nsMsgViewIndex_None) {</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-        this.selectViewIndex(viewIndex);</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-        return;</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-      }</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+    let viewIndex = this.view.dbView.findIndexOfMsgHdr(aMsgHdr, true);</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+    if (viewIndex != nsMsgViewIndex_None) {</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+      this.selectViewIndex(viewIndex);</span>
<a href="#l3.320"></a><span id="l3.320">     }</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-    this._savedSelection = [{messageId: aMsgHdr.messageId}];</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-    // queue the selection to be restored once we become active if we are not</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-    //  active.</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-    if (!this.active)</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-      this._notifyWhenActive(this._restoreSelection);</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+    else {</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+      this._savedSelection = [{messageId: aMsgHdr.messageId}];</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+      // queue the selection to be restored once we become active if we are not</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+      //  active.</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+      if (!this.active)</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+        this._notifyWhenActive(this._restoreSelection);</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+    }</span>
<a href="#l3.333"></a><span id="l3.333">   },</span>
<a href="#l3.334"></a><span id="l3.334"> </span>
<a href="#l3.335"></a><span id="l3.335">   /**</span>
<a href="#l3.336"></a><span id="l3.336">    * Select all of the provided nsIMsgDBHdrs in the aMessages array, expanding</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-   *  threads as required.  If the view is not active, or we were not able to</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-   *  find all of the messages, update our saved selection to want to display</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineminus">-   *  the messages.  The messages will then be selected when we are made active</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-   *  or all messages in the folder complete loading.  This is to accomodate the</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-   *  use-case where we are backed by an in-progress search and no</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+   *  threads as required.  If we were not able to find all of the messages,</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+   *  update our saved selection to want to display the messages.  The messages</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+   *  will then be selected when we are made active or all messages in the</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+   *  folder complete loading.  This is to accomodate the use-case where we</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+   *  are backed by an in-progress search and no</span>
<a href="#l3.347"></a><span id="l3.347">    *</span>
<a href="#l3.348"></a><span id="l3.348">    * @param aMessages An array of nsIMsgDBHdr instances.</span>
<a href="#l3.349"></a><span id="l3.349">    * @param aDoNotNeedToFindAll If true (can be omitted and left undefined), we</span>
<a href="#l3.350"></a><span id="l3.350">    *     do not attempt to save the selection for future use.  This is intended</span>
<a href="#l3.351"></a><span id="l3.351">    *     for use by the _restoreSelection call which is the end-of-the-line for</span>
<a href="#l3.352"></a><span id="l3.352">    *     restoring the selection.  (Once it gets called all of our messages</span>
<a href="#l3.353"></a><span id="l3.353">    *     should have already been loaded.)</span>
<a href="#l3.354"></a><span id="l3.354">    */</span>
<a href="#l3.355"></a><span id="l3.355">   selectMessages: function FolderDisplayWidget_selectMessages(</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-    aMessages, aDoNotNeedToFindAll) {</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-    if (this.active &amp;&amp; this.treeSelection) {</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+      aMessages, aDoNotNeedToFindAll) {</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+    let treeSelection = this.treeSelection; // potentially magic getter</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+    if (treeSelection) {</span>
<a href="#l3.361"></a><span id="l3.361">       let foundAll = true;</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-      let treeSelection = this.treeSelection;</span>
<a href="#l3.363"></a><span id="l3.363">       let dbView = this.view.dbView;</span>
<a href="#l3.364"></a><span id="l3.364">       let minRow = null, maxRow = null;</span>
<a href="#l3.365"></a><span id="l3.365"> </span>
<a href="#l3.366"></a><span id="l3.366">       treeSelection.selectEventsSuppressed = true;</span>
<a href="#l3.367"></a><span id="l3.367">       treeSelection.clearSelection();</span>
<a href="#l3.368"></a><span id="l3.368"> </span>
<a href="#l3.369"></a><span id="l3.369">       for each (let [, msgHdr] in Iterator(aMessages)) {</span>
<a href="#l3.370"></a><span id="l3.370">         let viewIndex = dbView.findIndexOfMsgHdr(msgHdr, true);</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineat">@@ -1968,16 +2001,19 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l3.372"></a><span id="l3.372">  */</span>
<a href="#l3.373"></a><span id="l3.373"> function FakeTreeBoxObject(aDummyBoxObject) {</span>
<a href="#l3.374"></a><span id="l3.374">   this.dummyBoxObject = aDummyBoxObject.QueryInterface(</span>
<a href="#l3.375"></a><span id="l3.375">                           Components.interfaces.nsIBoxObject);</span>
<a href="#l3.376"></a><span id="l3.376">   this.view = null;</span>
<a href="#l3.377"></a><span id="l3.377"> }</span>
<a href="#l3.378"></a><span id="l3.378"> FakeTreeBoxObject.prototype = {</span>
<a href="#l3.379"></a><span id="l3.379">   view: null,</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+  ensureRowIsVisible: function FakeTreeBoxObject_ensureRowIsVisible() {</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+    // NOP</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+  },</span>
<a href="#l3.383"></a><span id="l3.383">   /**</span>
<a href="#l3.384"></a><span id="l3.384">    * No need to actually invalidate, as when we re-root the view this will</span>
<a href="#l3.385"></a><span id="l3.385">    *  happen.</span>
<a href="#l3.386"></a><span id="l3.386">    */</span>
<a href="#l3.387"></a><span id="l3.387">   invalidate: function FakeTreeBoxObject_invalidate() {</span>
<a href="#l3.388"></a><span id="l3.388">     // NOP</span>
<a href="#l3.389"></a><span id="l3.389">   },</span>
<a href="#l3.390"></a><span id="l3.390">   invalidateRange: function FakeTreeBoxObject_invalidateRange() {</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineat">@@ -2055,26 +2091,24 @@ FTBO_stubOutAttributes(FakeTreeBoxObject</span>
<a href="#l3.392"></a><span id="l3.392">   &quot;rowWidth&quot;,</span>
<a href="#l3.393"></a><span id="l3.393">   &quot;horizontalPosition&quot;,</span>
<a href="#l3.394"></a><span id="l3.394">   &quot;selectionRegion&quot;,</span>
<a href="#l3.395"></a><span id="l3.395">   ]);</span>
<a href="#l3.396"></a><span id="l3.396"> FTBO_stubOutMethods(FakeTreeBoxObject.prototype, [</span>
<a href="#l3.397"></a><span id="l3.397">   &quot;getFirstVisibleRow&quot;,</span>
<a href="#l3.398"></a><span id="l3.398">   &quot;getLastVisibleRow&quot;,</span>
<a href="#l3.399"></a><span id="l3.399">   &quot;getPageLength&quot;,</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-  &quot;ensureRowIsVisible&quot;,</span>
<a href="#l3.401"></a><span id="l3.401">   &quot;ensureCellIsVisible&quot;,</span>
<a href="#l3.402"></a><span id="l3.402">   &quot;scrollToRow&quot;,</span>
<a href="#l3.403"></a><span id="l3.403">   &quot;scrollByLines&quot;,</span>
<a href="#l3.404"></a><span id="l3.404">   &quot;scrollByPages&quot;,</span>
<a href="#l3.405"></a><span id="l3.405">   &quot;scrollToCell&quot;,</span>
<a href="#l3.406"></a><span id="l3.406">   &quot;scrollToColumn&quot;,</span>
<a href="#l3.407"></a><span id="l3.407">   &quot;scrollToHorizontalPosition&quot;,</span>
<a href="#l3.408"></a><span id="l3.408">   &quot;invalidateColumn&quot;,</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-  &quot;invalidateRow&quot;,</span>
<a href="#l3.410"></a><span id="l3.410">   &quot;invalidateCell&quot;,</span>
<a href="#l3.411"></a><span id="l3.411">   &quot;invalidateColumnRange&quot;,</span>
<a href="#l3.412"></a><span id="l3.412">   &quot;getRowAt&quot;,</span>
<a href="#l3.413"></a><span id="l3.413">   &quot;getCellAt&quot;,</span>
<a href="#l3.414"></a><span id="l3.414">   &quot;getCoordsForCellItem&quot;,</span>
<a href="#l3.415"></a><span id="l3.415">   &quot;isCellCropped&quot;,</span>
<a href="#l3.416"></a><span id="l3.416">   &quot;clearStyleAndImageCaches&quot;,</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-  ]);</span>
<a href="#l3.418"></a><span id="l3.418">\ No newline at end of file</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+  ]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -61,16 +61,19 @@ const kVerticalMailLayout = 2;</span>
<a href="#l4.4"></a><span id="l4.4"> const kNoRemoteContentPolicy = 0;</span>
<a href="#l4.5"></a><span id="l4.5"> const kBlockRemoteContent = 1;</span>
<a href="#l4.6"></a><span id="l4.6"> const kAllowRemoteContent = 2;</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> const kMsgNotificationPhishingBar = 1;</span>
<a href="#l4.9"></a><span id="l4.9"> const kMsgNotificationJunkBar = 2;</span>
<a href="#l4.10"></a><span id="l4.10"> const kMsgNotificationRemoteImages = 3;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/MailUtils.js&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/MailConsts.js&quot;);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+</span>
<a href="#l4.15"></a><span id="l4.15"> var gMessengerBundle;</span>
<a href="#l4.16"></a><span id="l4.16"> var gPrefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l4.17"></a><span id="l4.17">                             .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l4.18"></a><span id="l4.18">                             .getBranch(null);</span>
<a href="#l4.19"></a><span id="l4.19"> var gCopyService = Components.classes[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l4.20"></a><span id="l4.20">                      .getService(Components.interfaces.nsIMsgCopyService);</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> // Timer to mark read, if the user has configured the app to mark a message as</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineat">@@ -1694,62 +1697,68 @@ let mailTabType = {</span>
<a href="#l4.24"></a><span id="l4.24">         // persistence and restoreTab wants to know if we are the magic first tab</span>
<a href="#l4.25"></a><span id="l4.25">         aTab.firstTab = true;</span>
<a href="#l4.26"></a><span id="l4.26">         aTab.folderDisplay.makeActive();</span>
<a href="#l4.27"></a><span id="l4.27">       },</span>
<a href="#l4.28"></a><span id="l4.28">       /**</span>
<a href="#l4.29"></a><span id="l4.29">        * @param aFolder The nsIMsgFolder to display.</span>
<a href="#l4.30"></a><span id="l4.30">        * @param aMsgHdr Optional message header to display.</span>
<a href="#l4.31"></a><span id="l4.31">        */</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-      openTab: function(aTab, aFolder, aMsgHdr, aOptions) {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-        if (aOptions === undefined)</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-          aOptions = {};</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+      openTab: function(aTab, aArgs) {</span>
<a href="#l4.37"></a><span id="l4.37">         // persistence and restoreTab wants to know if we are the magic first tab</span>
<a href="#l4.38"></a><span id="l4.38">         aTab.firstTab = false;</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40">         // Get a tab that we can initialize our user preferences from.</span>
<a href="#l4.41"></a><span id="l4.41">         // (We don't want to assume that our immediate predecessor was a</span>
<a href="#l4.42"></a><span id="l4.42">         //  &quot;folder&quot; tab.)</span>
<a href="#l4.43"></a><span id="l4.43">         let modelTab = document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l4.44"></a><span id="l4.44">                          .getTabInfoForCurrentOrFirstModeInstance(aTab.mode);</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46">         if (modelTab)</span>
<a href="#l4.47"></a><span id="l4.47">           aTab.folderPaneCollapsed = modelTab.folderPaneCollapsed;</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49">         // - figure out whether to show the message pane</span>
<a href="#l4.50"></a><span id="l4.50">         let messagePaneShouldBeVisible;</span>
<a href="#l4.51"></a><span id="l4.51">         // explicitly told to us?</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-        if (&quot;messagePaneVisible&quot; in aOptions)</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-          messagePaneShouldBeVisible = aOptions.messagePaneVisible;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+        if (&quot;messagePaneVisible&quot; in aArgs)</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+          messagePaneShouldBeVisible = aArgs.messagePaneVisible;</span>
<a href="#l4.56"></a><span id="l4.56">         // inherit from the previous tab (if we've got one)</span>
<a href="#l4.57"></a><span id="l4.57">         else if (modelTab)</span>
<a href="#l4.58"></a><span id="l4.58">           messagePaneShouldBeVisible = modelTab.messageDisplay.visible;</span>
<a href="#l4.59"></a><span id="l4.59">         // who does't love a message pane?</span>
<a href="#l4.60"></a><span id="l4.60">         else</span>
<a href="#l4.61"></a><span id="l4.61">           messagePaneShouldBeVisible = true;</span>
<a href="#l4.62"></a><span id="l4.62"> </span>
<a href="#l4.63"></a><span id="l4.63">         this.openTab(aTab, false,</span>
<a href="#l4.64"></a><span id="l4.64">                      new MessagePaneDisplayWidget(messagePaneShouldBeVisible));</span>
<a href="#l4.65"></a><span id="l4.65"> </span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-        // Clear selection, because context clicking on a folder and opening in a</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-        // new tab needs to have SelectFolder think the selection has changed.</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-        // We also need to clear these globals to subvert the code that prevents</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-        // folder loads when things haven't changed.</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-        var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-        folderTree.view.selection.clearSelection();</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-        folderTree.view.selection.currentIndex = -1;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-        aTab.folderDisplay.makeActive();</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-        // selecting the folder effectively calls</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-        //  aTab.folderDisplay.show(aFolder)</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-        gFolderTreeView.selectFolder(aFolder);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-        if(aMsgHdr)</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-          aTab.folderDisplay.selectMessage(aMsgHdr);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+        let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+        let msgHdr = (&quot;msgHdr&quot; in aArgs) &amp;&amp; aArgs.msgHdr;</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+        if (!background) {</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+          // Clear selection, because context clicking on a folder and opening in a</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+          // new tab needs to have SelectFolder think the selection has changed.</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+          // We also need to clear these globals to subvert the code that prevents</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+          // folder loads when things haven't changed.</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+          let folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+          folderTree.view.selection.clearSelection();</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+          folderTree.view.selection.currentIndex = -1;</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+          aTab.folderDisplay.makeActive();</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+          // This will call aTab.folderDisplay.show(aArgs.folder), which takes</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+          // care of the tab title and other stuff</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+          gFolderTreeView.selectFolder(aArgs.folder);</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+          if (msgHdr)</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+            aTab.folderDisplay.selectMessage(msgHdr);</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+        }</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+        else {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+          // Since we can't call gFolderTreeView.selectFolder, we need to make the folder</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+          // display believe it's showing this folder</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+          aTab.folderDisplay.show(aArgs.folder);</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+        }</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106">         aTab.mode.onTitleChanged.call(this, aTab, aTab.tabNode);</span>
<a href="#l4.107"></a><span id="l4.107">       },</span>
<a href="#l4.108"></a><span id="l4.108">       persistTab: function(aTab) {</span>
<a href="#l4.109"></a><span id="l4.109">         if (!aTab.folderDisplay.displayedFolder)</span>
<a href="#l4.110"></a><span id="l4.110">           return null;</span>
<a href="#l4.111"></a><span id="l4.111">         return {</span>
<a href="#l4.112"></a><span id="l4.112">           folderURI: aTab.folderDisplay.displayedFolder.URI,</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineat">@@ -1776,17 +1785,19 @@ let mailTabType = {</span>
<a href="#l4.114"></a><span id="l4.114">               //  need to explicitly set the _visible value because otherwise it</span>
<a href="#l4.115"></a><span id="l4.115">               //  misses out on the toggle event.</span>
<a href="#l4.116"></a><span id="l4.116">               if (!gMessageDisplay._active)</span>
<a href="#l4.117"></a><span id="l4.117">                 gMessageDisplay._visible = aPersistedState.messagePaneVisible;</span>
<a href="#l4.118"></a><span id="l4.118">             }</span>
<a href="#l4.119"></a><span id="l4.119">             gFolderTreeView.selectFolder(folder);</span>
<a href="#l4.120"></a><span id="l4.120">           }</span>
<a href="#l4.121"></a><span id="l4.121">           else {</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-            aTabmail.openTab(&quot;folder&quot;, folder, null, aPersistedState);</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+            aTabmail.openTab(&quot;folder&quot;, {folder: folder,</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+                messagePaneVisible: aPersistedState.messagePaneVisible,</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+                background: true});</span>
<a href="#l4.126"></a><span id="l4.126">           }</span>
<a href="#l4.127"></a><span id="l4.127">         }</span>
<a href="#l4.128"></a><span id="l4.128">       },</span>
<a href="#l4.129"></a><span id="l4.129">       onTitleChanged: function(aTab, aTabNode) {</span>
<a href="#l4.130"></a><span id="l4.130">         if (!aTab.folderDisplay || !aTab.folderDisplay.displayedFolder) {</span>
<a href="#l4.131"></a><span id="l4.131">           // Don't show &quot;undefined&quot; as title when there is no account.</span>
<a href="#l4.132"></a><span id="l4.132">           aTab.title = &quot; &quot;;</span>
<a href="#l4.133"></a><span id="l4.133">           return;</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineat">@@ -1814,43 +1825,55 @@ let mailTabType = {</span>
<a href="#l4.135"></a><span id="l4.135">     message: {</span>
<a href="#l4.136"></a><span id="l4.136">       type: &quot;message&quot;,</span>
<a href="#l4.137"></a><span id="l4.137">       /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l4.138"></a><span id="l4.138">       legalPanes: {</span>
<a href="#l4.139"></a><span id="l4.139">         folder: false,</span>
<a href="#l4.140"></a><span id="l4.140">         thread: false,</span>
<a href="#l4.141"></a><span id="l4.141">         message: true</span>
<a href="#l4.142"></a><span id="l4.142">       },</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-      openTab: function(aTab, aMsgHdr, aViewWrapperToClone) {</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-        aTab.mode.onTitleChanged.call(this, aTab, null, aMsgHdr);</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+      openTab: function(aTab, aArgs) {</span>
<a href="#l4.147"></a><span id="l4.147">         this.openTab(aTab, false, new MessageTabDisplayWidget());</span>
<a href="#l4.148"></a><span id="l4.148"> </span>
<a href="#l4.149"></a><span id="l4.149" class="difflineminus">-        if (aViewWrapperToClone)</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-          aTab.folderDisplay.cloneView(aViewWrapperToClone);</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+        let viewWrapperToClone = (&quot;viewWrapperToClone&quot; in aArgs) &amp;&amp;</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+                                 aArgs.viewWrapperToClone;</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+        let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+        if (viewWrapperToClone)</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+          aTab.folderDisplay.cloneView(viewWrapperToClone);</span>
<a href="#l4.157"></a><span id="l4.157">         else</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-          aTab.folderDisplay.show(aMsgHdr.folder);</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-        aTab.folderDisplay.selectMessage(aMsgHdr);</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+          aTab.folderDisplay.show(aArgs.msgHdr.folder);</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+        // folderDisplay.show is going to try to set the title itself, but we</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+        // wouldn't have selected a message at that point, so set the title</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+        // here</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+        aTab.mode.onTitleChanged.call(this, aTab, null, aArgs.msgHdr);</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+        aTab.folderDisplay.selectMessage(aArgs.msgHdr);</span>
<a href="#l4.169"></a><span id="l4.169"> </span>
<a href="#l4.170"></a><span id="l4.170">         // we only want to make it active after setting up the view and the message</span>
<a href="#l4.171"></a><span id="l4.171">         //  to avoid generating bogus summarization events.</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-        aTab.folderDisplay.makeActive();</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+        if (!background)</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+          aTab.folderDisplay.makeActive();</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+        else</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+          // We don't want to null out the real tree box view, as that</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+          // corresponds to the _current_ tab, not the new one</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+          aTab.folderDisplay.hookUpFakeTreeBox(false);</span>
<a href="#l4.179"></a><span id="l4.179">       },</span>
<a href="#l4.180"></a><span id="l4.180">       persistTab: function(aTab) {</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-        let msgHdr = aTab.messageDisplay.displayedMessage;</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+        let msgHdr = aTab.folderDisplay.selectedMessage;</span>
<a href="#l4.183"></a><span id="l4.183">         return {</span>
<a href="#l4.184"></a><span id="l4.184">           messageURI: msgHdr.folder.getUriForMsg(msgHdr)</span>
<a href="#l4.185"></a><span id="l4.185">         };</span>
<a href="#l4.186"></a><span id="l4.186">       },</span>
<a href="#l4.187"></a><span id="l4.187">       restoreTab: function(aTabmail, aPersistedState) {</span>
<a href="#l4.188"></a><span id="l4.188">         let msgHdr = messenger.msgHdrFromURI(aPersistedState.messageURI);</span>
<a href="#l4.189"></a><span id="l4.189">         // if the message no longer exists, we can't restore the tab</span>
<a href="#l4.190"></a><span id="l4.190">         if (msgHdr)</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-          aTabmail.openTab(&quot;message&quot;, msgHdr);</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+          aTabmail.openTab(&quot;message&quot;, {msgHdr: msgHdr, background: true});</span>
<a href="#l4.193"></a><span id="l4.193">       },</span>
<a href="#l4.194"></a><span id="l4.194">       onTitleChanged: function(aTab, aTabNode, aMsgHdr) {</span>
<a href="#l4.195"></a><span id="l4.195">         // Try and figure out the selected message if one was not provided.</span>
<a href="#l4.196"></a><span id="l4.196">         // It is possible that the folder has yet to load, so it may still be</span>
<a href="#l4.197"></a><span id="l4.197">         //  null.</span>
<a href="#l4.198"></a><span id="l4.198">         if (aMsgHdr == null)</span>
<a href="#l4.199"></a><span id="l4.199">           aMsgHdr = aTab.folderDisplay.selectedMessage;</span>
<a href="#l4.200"></a><span id="l4.200">         aTab.title = &quot;&quot;;</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineat">@@ -1893,29 +1916,31 @@ let mailTabType = {</span>
<a href="#l4.202"></a><span id="l4.202">        * @param facetString</span>
<a href="#l4.203"></a><span id="l4.203">        *     - everything:</span>
<a href="#l4.204"></a><span id="l4.204">        *     - subject:</span>
<a href="#l4.205"></a><span id="l4.205">        *     - involves:</span>
<a href="#l4.206"></a><span id="l4.206">        *     - to:</span>
<a href="#l4.207"></a><span id="l4.207">        *     - from:</span>
<a href="#l4.208"></a><span id="l4.208">        *     - body:</span>
<a href="#l4.209"></a><span id="l4.209">        * @param location Either a GlodaFolder or the string &quot;everywhere&quot;.</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+       * </span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+       * XXX This needs to handle opening in the background</span>
<a href="#l4.212"></a><span id="l4.212">        */</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-      openTab: function(aTab, searchString, facetString, location) {</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+      openTab: function(aTab, aArgs) {</span>
<a href="#l4.215"></a><span id="l4.215">         // make sure the search string bundle is loaded</span>
<a href="#l4.216"></a><span id="l4.216">         getDocumentElements();</span>
<a href="#l4.217"></a><span id="l4.217">         aTab.title = gSearchBundle.getFormattedString(&quot;glodaSearchTabTitle&quot;,</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-                                                      [searchString]);</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-        aTab.glodaSearchInputValue = searchString;</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-        aTab.searchString = searchString;</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-        aTab.facetString = facetString;</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-        aTab.glodaSynView = new GlodaSyntheticSearchView(searchString,</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-                                                         facetString,</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-                                                         location);</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+                                                      [aArgs.searchString]);</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+        aTab.glodaSearchInputValue = aArgs.searchString;</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+        aTab.searchString = aArgs.searchString;</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+        aTab.facetString = aArgs.facetString;</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+        aTab.glodaSynView = new GlodaSyntheticSearchView(aArgs.searchString,</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+                                                         aArgs.facetString,</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+                                                         aArgs.location);</span>
<a href="#l4.234"></a><span id="l4.234"> </span>
<a href="#l4.235"></a><span id="l4.235">         this.openTab(aTab, false, new MessagePaneDisplayWidget());</span>
<a href="#l4.236"></a><span id="l4.236">         aTab.folderDisplay.show(aTab.glodaSynView);</span>
<a href="#l4.237"></a><span id="l4.237">         aTab.folderDisplay.setVisibleColumns(aTab.mode.desiredColumns);</span>
<a href="#l4.238"></a><span id="l4.238">         aTab.folderDisplay.makeActive();</span>
<a href="#l4.239"></a><span id="l4.239">       },</span>
<a href="#l4.240"></a><span id="l4.240">     },</span>
<a href="#l4.241"></a><span id="l4.241">   },</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineat">@@ -1944,20 +1969,22 @@ let mailTabType = {</span>
<a href="#l4.243"></a><span id="l4.243">                                    Components.interfaces.nsITreeBoxObject);</span>
<a href="#l4.244"></a><span id="l4.244"> </span>
<a href="#l4.245"></a><span id="l4.245">     if (aIsFirstTab) {</span>
<a href="#l4.246"></a><span id="l4.246">       aTab.folderDisplay.messenger = messenger;</span>
<a href="#l4.247"></a><span id="l4.247">     }</span>
<a href="#l4.248"></a><span id="l4.248">     else {</span>
<a href="#l4.249"></a><span id="l4.249">       // Each tab gets its own messenger instance; this provides each tab with</span>
<a href="#l4.250"></a><span id="l4.250">       // its own undo/redo stack and back/forward navigation history.</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-      messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-                            .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-      messenger.setWindow(window, msgWindow);</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-      aTab.folderDisplay.messenger = messenger;</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+      // If this is a foreground tab, folderDisplay.makeActive() is going to</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+      // set it as the global messenger, so there's no need to do it here</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+      let tabMessenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+                                   .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+      tabMessenger.setWindow(window, msgWindow);</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+      aTab.folderDisplay.messenger = tabMessenger;</span>
<a href="#l4.261"></a><span id="l4.261">     }</span>
<a href="#l4.262"></a><span id="l4.262">   },</span>
<a href="#l4.263"></a><span id="l4.263"> </span>
<a href="#l4.264"></a><span id="l4.264">   closeTab: function(aTab) {</span>
<a href="#l4.265"></a><span id="l4.265">     aTab.folderDisplay.close();</span>
<a href="#l4.266"></a><span id="l4.266">   },</span>
<a href="#l4.267"></a><span id="l4.267"> </span>
<a href="#l4.268"></a><span id="l4.268">   saveTabState: function(aTab) {</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineat">@@ -2185,63 +2212,58 @@ function MsgOpenNewWindowForFolder(folde</span>
<a href="#l4.270"></a><span id="l4.270">     window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l4.271"></a><span id="l4.271">                       &quot;chrome,all,dialog=no&quot;,</span>
<a href="#l4.272"></a><span id="l4.272">                       selectedFolders[i].URI, msgKeyToSelect);</span>
<a href="#l4.273"></a><span id="l4.273">   }</span>
<a href="#l4.274"></a><span id="l4.274"> }</span>
<a href="#l4.275"></a><span id="l4.275"> </span>
<a href="#l4.276"></a><span id="l4.276"> /**</span>
<a href="#l4.277"></a><span id="l4.277">  * UI-triggered command to open the currently selected folder(s) in new tabs.</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+ * @param aBackground [optional] if true, then the folder tab is opened in the</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+ *                    background. If false or not given, then the folder tab is</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+ *                    opened in the foreground.</span>
<a href="#l4.281"></a><span id="l4.281">  */</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineminus">-function MsgOpenNewTabForFolder()</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+function MsgOpenNewTabForFolder(aBackground)</span>
<a href="#l4.284"></a><span id="l4.284"> {</span>
<a href="#l4.285"></a><span id="l4.285">   // If there is a right-click happening, gFolderTreeView.getSelectedFolders()</span>
<a href="#l4.286"></a><span id="l4.286">   // will tell us about it (while the selection's currentIndex would reflect</span>
<a href="#l4.287"></a><span id="l4.287">   // the node that was selected/displayed before the right-click.)</span>
<a href="#l4.288"></a><span id="l4.288">   let selectedFolders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l4.289"></a><span id="l4.289">   for (let i = 0; i &lt; selectedFolders.length; i++) {</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-    document.getElementById(&quot;tabmail&quot;).openTab(&quot;folder&quot;, selectedFolders[i]);</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+    document.getElementById(&quot;tabmail&quot;).openTab(&quot;folder&quot;,</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+      {folder: selectedFolders[i], background: aBackground});</span>
<a href="#l4.293"></a><span id="l4.293">   }</span>
<a href="#l4.294"></a><span id="l4.294"> }</span>
<a href="#l4.295"></a><span id="l4.295"> </span>
<a href="#l4.296"></a><span id="l4.296" class="difflineminus">-/**</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">- * UI-triggered command to open the currently selected message in a new tab.</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">- */</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-function MsgOpenNewTabForMessage()</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-{</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-  if (!gFolderDisplay.selectedMessage)</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-    return;</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-  document.getElementById('tabmail').openTab(&quot;message&quot;,</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-                                             gFolderDisplay.selectedMessage,</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineminus">-                                             gFolderDisplay.view);</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-}</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-</span>
<a href="#l4.308"></a><span id="l4.308"> function MsgOpenSelectedMessages()</span>
<a href="#l4.309"></a><span id="l4.309"> {</span>
<a href="#l4.310"></a><span id="l4.310">   // Toggle message body (rss summary) and content-base url in message</span>
<a href="#l4.311"></a><span id="l4.311">   // pane per pref, otherwise open summary or web page in new window.</span>
<a href="#l4.312"></a><span id="l4.312">   if (gFolderDisplay.selectedMessageIsFeed &amp;&amp; GetFeedOpenHandler() == 2) {</span>
<a href="#l4.313"></a><span id="l4.313">     FeedSetContentViewToggle();</span>
<a href="#l4.314"></a><span id="l4.314">     return;</span>
<a href="#l4.315"></a><span id="l4.315">   }</span>
<a href="#l4.316"></a><span id="l4.316"> </span>
<a href="#l4.317"></a><span id="l4.317">   let selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-  var numMessages = selectedMessages.length;</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineminus">-  var windowReuse = gPrefBranch.getBoolPref(&quot;mailnews.reuse_message_window&quot;);</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineminus">-  // This is a radio type button pref, currently with only 2 buttons.</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-  // We need to keep the pref type as 'bool' for backwards compatibility</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-  // with 4.x migrated prefs.  For future radio button(s), please use another</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-  // pref (either 'bool' or 'int' type) to describe it.</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineminus">-  //</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-  // windowReuse values: false, true</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-  //    false: open new standalone message window for each message</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-  //    true : reuse existing standalone message window for each message</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-  if (windowReuse &amp;&amp; numMessages == 1 &amp;&amp;</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-      MsgOpenSelectedMessageInExistingWindow())</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+  let numMessages = selectedMessages.length;</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+  let openMessageBehavior = gPrefBranch.getIntPref(&quot;mail.openMessageBehavior&quot;);</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+  if (openMessageBehavior == MailConsts.OpenMessageBehavior.NEW_TAB) {</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+    // Open all the tabs in the background, except for the last one</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+    let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+    for (let i = 0; i &lt; numMessages; i++)</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+      tabmail.openTab(&quot;message&quot;, {msgHdr: selectedMessages[i],</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+          viewWrapperToClone: gFolderDisplay.view,</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+          background: (i &lt; (numMessages - 1))});</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+    return;</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+  }</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+  if (openMessageBehavior == MailConsts.OpenMessageBehavior.EXISTING_WINDOW &amp;&amp;</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+      numMessages == 1 &amp;&amp; MailUtils.openMessageInExistingWindow(</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+          gFolderDisplay.selectedMessage, gFolderDisplay.view))</span>
<a href="#l4.347"></a><span id="l4.347">     return;</span>
<a href="#l4.348"></a><span id="l4.348"> </span>
<a href="#l4.349"></a><span id="l4.349">   var openWindowWarning = gPrefBranch.getIntPref(&quot;mailnews.open_window_warning&quot;);</span>
<a href="#l4.350"></a><span id="l4.350">   if ((openWindowWarning &gt; 1) &amp;&amp; (numMessages &gt;= openWindowWarning)) {</span>
<a href="#l4.351"></a><span id="l4.351">     if (!gMessengerBundle)</span>
<a href="#l4.352"></a><span id="l4.352">         gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l4.353"></a><span id="l4.353">     var title = gMessengerBundle.getString(&quot;openWindowWarningTitle&quot;);</span>
<a href="#l4.354"></a><span id="l4.354">     var text = gMessengerBundle.getFormattedString(&quot;openWindowWarningText&quot;, [numMessages]);</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineat">@@ -2251,35 +2273,16 @@ function MsgOpenSelectedMessages()</span>
<a href="#l4.356"></a><span id="l4.356">       return;</span>
<a href="#l4.357"></a><span id="l4.357">   }</span>
<a href="#l4.358"></a><span id="l4.358"> </span>
<a href="#l4.359"></a><span id="l4.359">   for (var i = 0; i &lt; numMessages; i++) {</span>
<a href="#l4.360"></a><span id="l4.360">     MsgOpenNewWindowForMessage(selectedMessages[i]);</span>
<a href="#l4.361"></a><span id="l4.361">   }</span>
<a href="#l4.362"></a><span id="l4.362"> }</span>
<a href="#l4.363"></a><span id="l4.363"> </span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-function MsgOpenSelectedMessageInExistingWindow()</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-{</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-  var windowID = GetWindowByWindowType(&quot;mail:messageWindow&quot;);</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-  if (!windowID)</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-    return false;</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-  // (future work: perhaps make the window have a method we can call to do this)</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-  // make the window's folder clone our view</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-  windowID.gFolderDisplay.cloneView(gFolderDisplay.view);</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-  // boss the window into showing our message</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-  windowID.gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-  // bring existing window to front</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-  windowID.focus();</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-  return true;</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-}</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineminus">-</span>
<a href="#l4.383"></a><span id="l4.383"> function MsgOpenFromFile()</span>
<a href="#l4.384"></a><span id="l4.384"> {</span>
<a href="#l4.385"></a><span id="l4.385">   const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l4.386"></a><span id="l4.386">   var fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l4.387"></a><span id="l4.387">                      .createInstance(nsIFilePicker);</span>
<a href="#l4.388"></a><span id="l4.388"> </span>
<a href="#l4.389"></a><span id="l4.389">   var strBundleService = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;].getService();</span>
<a href="#l4.390"></a><span id="l4.390">   strBundleService = strBundleService.QueryInterface(Components.interfaces.nsIStringBundleService);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -529,17 +529,17 @@</span>
<a href="#l5.4"></a><span id="l5.4">     &lt;menuseparator id=&quot;mailContext-sep-open&quot;/&gt;</span>
<a href="#l5.5"></a><span id="l5.5">     &lt;menuitem id=&quot;mailContext-openNewWindow&quot;</span>
<a href="#l5.6"></a><span id="l5.6">               label=&quot;&amp;contextOpenNewWindow.label;&quot;</span>
<a href="#l5.7"></a><span id="l5.7">               accesskey=&quot;&amp;contextOpenNewWindow.accesskey;&quot;</span>
<a href="#l5.8"></a><span id="l5.8">               oncommand=&quot;MsgOpenNewWindowForMessage();&quot;/&gt;</span>
<a href="#l5.9"></a><span id="l5.9">     &lt;menuitem id=&quot;threadPaneContext-openNewTab&quot;</span>
<a href="#l5.10"></a><span id="l5.10">               label=&quot;&amp;contextOpenNewTab.label;&quot;</span>
<a href="#l5.11"></a><span id="l5.11">               accesskey=&quot;&amp;contextOpenNewTab.accesskey;&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-              oncommand=&quot;MsgOpenNewTabForMessage();&quot;/&gt;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+              oncommand=&quot;ThreadTreeContextMenuNewTab();&quot;/&gt;</span>
<a href="#l5.14"></a><span id="l5.14">     &lt;menuseparator id=&quot;mailContext-sep-open2&quot;/&gt;</span>
<a href="#l5.15"></a><span id="l5.15">     &lt;menuitem id=&quot;mailContext-replySender&quot;</span>
<a href="#l5.16"></a><span id="l5.16">               label=&quot;&amp;contextReplySender.label;&quot;</span>
<a href="#l5.17"></a><span id="l5.17">               accesskey=&quot;&amp;contextReplySender.accesskey;&quot;</span>
<a href="#l5.18"></a><span id="l5.18">               oncommand=&quot;MsgReplySender(event);&quot;/&gt;</span>
<a href="#l5.19"></a><span id="l5.19">     &lt;menuitem id=&quot;mailContext-replyNewsgroup&quot;</span>
<a href="#l5.20"></a><span id="l5.20">               label=&quot;&amp;contextReplyNewsgroup.label;&quot;</span>
<a href="#l5.21"></a><span id="l5.21">               accesskey=&quot;&amp;contextReplyNewsgroup.accesskey;&quot;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -724,17 +724,17 @@</span>
<a href="#l5.23"></a><span id="l5.23">               oncommand=&quot;MsgGetMessage();&quot;/&gt;</span>
<a href="#l5.24"></a><span id="l5.24">     &lt;menuitem id=&quot;folderPaneContext-openNewWindow&quot;</span>
<a href="#l5.25"></a><span id="l5.25">               label=&quot;&amp;folderContextOpenNewWindow.label;&quot;</span>
<a href="#l5.26"></a><span id="l5.26">               accesskey=&quot;&amp;folderContextOpenNewWindow.accesskey;&quot;</span>
<a href="#l5.27"></a><span id="l5.27">               oncommand=&quot;MsgOpenNewWindowForFolder(null,-1);&quot;/&gt;</span>
<a href="#l5.28"></a><span id="l5.28">     &lt;menuitem id=&quot;folderPaneContext-openNewTab&quot;</span>
<a href="#l5.29"></a><span id="l5.29">               label=&quot;&amp;folderContextOpenNewTab.label;&quot;</span>
<a href="#l5.30"></a><span id="l5.30">               accesskey=&quot;&amp;folderContextOpenNewTab.accesskey;&quot;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-              oncommand=&quot;MsgOpenNewTabForFolder();&quot;/&gt;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+              oncommand=&quot;FolderPaneContextMenuNewTab();&quot;/&gt;</span>
<a href="#l5.33"></a><span id="l5.33">     &lt;menuitem id=&quot;folderPaneContext-searchMessages&quot;</span>
<a href="#l5.34"></a><span id="l5.34">               label=&quot;&amp;folderContextSearchMessages.label;&quot;</span>
<a href="#l5.35"></a><span id="l5.35">               accesskey=&quot;&amp;folderContextSearchMessages.accesskey;&quot;</span>
<a href="#l5.36"></a><span id="l5.36">               command=&quot;cmd_search&quot;/&gt;</span>
<a href="#l5.37"></a><span id="l5.37">     &lt;menuitem id=&quot;folderPaneContext-subscribe&quot;</span>
<a href="#l5.38"></a><span id="l5.38">               label=&quot;&amp;folderContextSubscribe.label;&quot;</span>
<a href="#l5.39"></a><span id="l5.39">               accesskey=&quot;&amp;folderContextSubscribe.accesskey;&quot;</span>
<a href="#l5.40"></a><span id="l5.40">               oncommand=&quot;MsgSubscribe();&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/messageDisplay.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/messageDisplay.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -319,18 +319,24 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l6.4"></a><span id="l6.4">   _clearSummaryTimer: function MessageDisplayWidget__clearSummaryTimer(aThis) {</span>
<a href="#l6.5"></a><span id="l6.5">     aThis._summaryStabilityTimeout = null;</span>
<a href="#l6.6"></a><span id="l6.6">   },</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">   /**</span>
<a href="#l6.9"></a><span id="l6.9">    * Called by the FolderDisplayWidget when it is being made active again and</span>
<a href="#l6.10"></a><span id="l6.10">    *  it's time for us to step up and re-display or clear the message as</span>
<a href="#l6.11"></a><span id="l6.11">    *  demanded by our multiplexed tab implementation.</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+   *  </span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+   *  @param aDontReloadMessage [optional] true if you don't want to make us</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+   *                            call reloadMessage even if the conditions are</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+   *                            right for doing so. Use only when you're sure</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+   *                            that you've already triggered a message load,</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+   *                            and that a message reload would be harmful.</span>
<a href="#l6.18"></a><span id="l6.18">    */</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-  makeActive: function MessageDisplayWidget_makeActive() {</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+  makeActive: function MessageDisplayWidget_makeActive(aDontReloadMessage) {</span>
<a href="#l6.21"></a><span id="l6.21">     let wasInactive = !this._active;</span>
<a href="#l6.22"></a><span id="l6.22">     this._active = true;</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">     if (wasInactive) {</span>
<a href="#l6.25"></a><span id="l6.25">       // (see our usage below)</span>
<a href="#l6.26"></a><span id="l6.26">       let preDisplayedMessage = this.displayedMessage;</span>
<a href="#l6.27"></a><span id="l6.27">       // Force a synthetic selection changed event.  This will propagate through</span>
<a href="#l6.28"></a><span id="l6.28">       //  to a call to onSelectedMessagesChanged who will handle making sure the</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineat">@@ -338,18 +344,19 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l6.30"></a><span id="l6.30">       this.folderDisplay.view.dbView.selectionChanged();</span>
<a href="#l6.31"></a><span id="l6.31">       // The one potential problem is that the message view only triggers message</span>
<a href="#l6.32"></a><span id="l6.32">       //  streaming if it doesn't think the message is already displayed.  In that</span>
<a href="#l6.33"></a><span id="l6.33">       //  case we need to force a re-display by calling reloadMessage.  We can</span>
<a href="#l6.34"></a><span id="l6.34">       //  detect that case by seeing if our displayedMessage value changes its</span>
<a href="#l6.35"></a><span id="l6.35">       //  value during this call (because we will receive a onDisplayingMessage</span>
<a href="#l6.36"></a><span id="l6.36">       //  notification).  If we should be displaying a single message but the</span>
<a href="#l6.37"></a><span id="l6.37">       //  value does not change, we need to force a re-display.</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-      if (this.singleMessageDisplay &amp;&amp; this.displayedMessage &amp;&amp;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-          (this.displayedMessage == preDisplayedMessage))</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+      if (!aDontReloadMessage &amp;&amp; this.singleMessageDisplay &amp;&amp;</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+          this.displayedMessage &amp;&amp; (this.displayedMessage ==</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+                                    preDisplayedMessage))</span>
<a href="#l6.43"></a><span id="l6.43">         this.folderDisplay.view.dbView.reloadMessage();</span>
<a href="#l6.44"></a><span id="l6.44">     }</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46">     this._updateActiveMessagePane();</span>
<a href="#l6.47"></a><span id="l6.47">   },</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49">   /**</span>
<a href="#l6.50"></a><span id="l6.50">    * Called by the FolderDisplayWidget when it is being made inactive or no</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineat">@@ -460,9 +467,9 @@ NeverVisisbleMessageDisplayWidget.protot</span>
<a href="#l6.52"></a><span id="l6.52">   get visible() {</span>
<a href="#l6.53"></a><span id="l6.53">     return false;</span>
<a href="#l6.54"></a><span id="l6.54">   },</span>
<a href="#l6.55"></a><span id="l6.55">   onSelectedMessagesChanged: function() {</span>
<a href="#l6.56"></a><span id="l6.56">     return false;</span>
<a href="#l6.57"></a><span id="l6.57">   },</span>
<a href="#l6.58"></a><span id="l6.58">   _updateActiveMessagePane: function() {</span>
<a href="#l6.59"></a><span id="l6.59">   },</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-};</span>
<a href="#l6.61"></a><span id="l6.61">\ No newline at end of file</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/messageWindow.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/messageWindow.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -59,17 +59,19 @@ var gMessageDisplay;</span>
<a href="#l7.4"></a><span id="l7.4">  * - To intercept queries about the selected message so that we can do the</span>
<a href="#l7.5"></a><span id="l7.5">  *    .eml file thing.  We were originally trying to avoid involving the</span>
<a href="#l7.6"></a><span id="l7.6">  *    nsMsgDBView, but that might not be important anymore. (future work)</span>
<a href="#l7.7"></a><span id="l7.7">  */</span>
<a href="#l7.8"></a><span id="l7.8"> function StandaloneFolderDisplayWidget(aMessageDisplayWidget) {</span>
<a href="#l7.9"></a><span id="l7.9">   FolderDisplayWidget.call(this, null, aMessageDisplayWidget);</span>
<a href="#l7.10"></a><span id="l7.10">   // do not set the actual treeBox variable or our superclass might try and do</span>
<a href="#l7.11"></a><span id="l7.11">   //  weird rooting things we don't want to have to think about right now.</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  this._magicTreeSelection = new JSTreeSelection(this.treeBox);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  //  Oh, and since we don't have a real tree selection, the fake tree</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  //  selection is going to be our real one. :)</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  this._magicTreeSelection = this._fakeTreeSelection;</span>
<a href="#l7.16"></a><span id="l7.16"> }</span>
<a href="#l7.17"></a><span id="l7.17"> StandaloneFolderDisplayWidget.prototype = {</span>
<a href="#l7.18"></a><span id="l7.18">   __proto__: FolderDisplayWidget.prototype,</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20">   /**</span>
<a href="#l7.21"></a><span id="l7.21">    * If we have a displayed message, then we've got 1 message, otherwise 0.</span>
<a href="#l7.22"></a><span id="l7.22">    */</span>
<a href="#l7.23"></a><span id="l7.23">   get selectedCount() {</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineat">@@ -111,16 +113,34 @@ StandaloneFolderDisplayWidget.prototype </span>
<a href="#l7.25"></a><span id="l7.25">     //  having the selection object properly associated with the tree.</span>
<a href="#l7.26"></a><span id="l7.26">     if (!this.messageDisplay.isDummy) {</span>
<a href="#l7.27"></a><span id="l7.27">       this.view.dbView.setTree(this._fakeTreeBox);</span>
<a href="#l7.28"></a><span id="l7.28">       this.view.dbView.selection = this._magicTreeSelection;</span>
<a href="#l7.29"></a><span id="l7.29">     }</span>
<a href="#l7.30"></a><span id="l7.30">     this.__proto__.__proto__.onCreatedView.call(this);</span>
<a href="#l7.31"></a><span id="l7.31">   },</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  /**</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+   * Override this to make sure that we don't try to do stuff with</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+   * quick-search.</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+   *</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+   * XXX This should ideally be the default behavior, with a 3pane subclass</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+   * implementing the quick-search stuff.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+   */</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  onDisplayingFolder:</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+      function StandaloneFolderDisplayWidget_onDisplayingFolder() {</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+    let msgDatabase = this.view.displayedFolder.msgDatabase;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+    if (msgDatabase) {</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+      msgDatabase.resetHdrCacheSize(this.PERF_HEADER_CACHE_SIZE);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+    }</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+    if (this.active)</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+      this.makeActive();</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+  },</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+</span>
<a href="#l7.51"></a><span id="l7.51">   _superSelectedMessageUrisGetter:</span>
<a href="#l7.52"></a><span id="l7.52">     FolderDisplayWidget.prototype.__lookupGetter__('selectedMessageUris'),</span>
<a href="#l7.53"></a><span id="l7.53">   /**</span>
<a href="#l7.54"></a><span id="l7.54">    * Check with the message display widget to see if it has a dummy; if so, just</span>
<a href="#l7.55"></a><span id="l7.55">    *  return the dummy's URI, as the nsMsgDBView logic that our superclass uses</span>
<a href="#l7.56"></a><span id="l7.56">    *  falls down in that case.</span>
<a href="#l7.57"></a><span id="l7.57">    */</span>
<a href="#l7.58"></a><span id="l7.58">   get selectedMessageUris() {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineat">@@ -156,28 +176,50 @@ function StandaloneMessageDisplayWidget(</span>
<a href="#l7.60"></a><span id="l7.60">    *  attachment on some mail message.</span>
<a href="#l7.61"></a><span id="l7.61">    */</span>
<a href="#l7.62"></a><span id="l7.62">   this.isDummy = false;</span>
<a href="#l7.63"></a><span id="l7.63">   /**</span>
<a href="#l7.64"></a><span id="l7.64">    * When displaying a dummy message, this is the URI of the message that we are</span>
<a href="#l7.65"></a><span id="l7.65">    *  displaying.  If we are not displaying a dummy message, this is null.</span>
<a href="#l7.66"></a><span id="l7.66">    */</span>
<a href="#l7.67"></a><span id="l7.67">   this.displayedUri = null;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  /**</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+   * This is supposed to be true when we know we're going to load another message</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+   * shortly, so clearDisplay et al shouldn't close the window. It is the</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+   * responsibility of calling code to set this to true when needed. This is</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+   * automatically set to false once a message has been loaded.</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+   *</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+   * This is true initially, because we know we're going to load another message</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+   * shortly.</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+   */</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  this.aboutToLoadMessage = true;</span>
<a href="#l7.78"></a><span id="l7.78"> }</span>
<a href="#l7.79"></a><span id="l7.79"> StandaloneMessageDisplayWidget.prototype = {</span>
<a href="#l7.80"></a><span id="l7.80">   __proto__: MessageDisplayWidget.prototype,</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">   /**</span>
<a href="#l7.83"></a><span id="l7.83">    * The message pane is a standalone display widget is always visible.</span>
<a href="#l7.84"></a><span id="l7.84">    */</span>
<a href="#l7.85"></a><span id="l7.85">   get visible() {</span>
<a href="#l7.86"></a><span id="l7.86">     return true;</span>
<a href="#l7.87"></a><span id="l7.87">   },</span>
<a href="#l7.88"></a><span id="l7.88">   set visible(aIgnored) {</span>
<a href="#l7.89"></a><span id="l7.89">   },</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+  /// We're always active</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+  _active: true,</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  active: true,</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+  /**</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+   * Since we're always active, there's no reason for us to do anything with</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+   * makeActive or makeInactive.</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+   */</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  makeActive: function StandaloneMessageDisplayWidget_makeActive() {</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+  },</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+  makeInactive: function StandaloneMessageDisplayWidget_makeInactive() {</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+  },</span>
<a href="#l7.102"></a><span id="l7.102"> </span>
<a href="#l7.103"></a><span id="l7.103">   /**</span>
<a href="#l7.104"></a><span id="l7.104">    * Display the external message (from disk or attachment) named by the URI.</span>
<a href="#l7.105"></a><span id="l7.105">    */</span>
<a href="#l7.106"></a><span id="l7.106">   displayExternalMessage:</span>
<a href="#l7.107"></a><span id="l7.107">       function StandaloneMessageDisplayWidget_displayExternalMessage(aUri) {</span>
<a href="#l7.108"></a><span id="l7.108">     this.isDummy = true;</span>
<a href="#l7.109"></a><span id="l7.109">     this.displayedUri = aUri;</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineat">@@ -186,17 +228,20 @@ StandaloneMessageDisplayWidget.prototype</span>
<a href="#l7.111"></a><span id="l7.111">     // null out the selection on the view so it operates in stand alone mode</span>
<a href="#l7.112"></a><span id="l7.112">     this.folderDisplay.view.dbView.selection = null;</span>
<a href="#l7.113"></a><span id="l7.113">     this.folderDisplay.view.dbView.loadMessageByUrl(aUri);</span>
<a href="#l7.114"></a><span id="l7.114">   },</span>
<a href="#l7.115"></a><span id="l7.115"> </span>
<a href="#l7.116"></a><span id="l7.116">   clearDisplay: function () {</span>
<a href="#l7.117"></a><span id="l7.117">     this.messageLoading = false;</span>
<a href="#l7.118"></a><span id="l7.118">     this.messageLoaded = false;</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-    window.close();</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+    // XXX we should figure out why we're calling window.close() both from here</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+    // and from onSelectedMessagesChanged.</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+    if (!this.aboutToLoadMessage)</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+      window.close();</span>
<a href="#l7.124"></a><span id="l7.124">   },</span>
<a href="#l7.125"></a><span id="l7.125">   _updateActiveMessagePane: function() {</span>
<a href="#l7.126"></a><span id="l7.126">     // no-op.  the message pane is always visible.</span>
<a href="#l7.127"></a><span id="l7.127">   },</span>
<a href="#l7.128"></a><span id="l7.128"> </span>
<a href="#l7.129"></a><span id="l7.129">   onDisplayingMessage:</span>
<a href="#l7.130"></a><span id="l7.130">       function StandaloneMessageDisplayWidget_onDisplayingMessage(aMsgHdr) {</span>
<a href="#l7.131"></a><span id="l7.131">     this.__proto__.__proto__.onDisplayingMessage.call(this, aMsgHdr);</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineat">@@ -205,20 +250,25 @@ StandaloneMessageDisplayWidget.prototype</span>
<a href="#l7.133"></a><span id="l7.133">     let title = aMsgHdr.mime2DecodedSubject;</span>
<a href="#l7.134"></a><span id="l7.134">     if (!gPlatformOSX)</span>
<a href="#l7.135"></a><span id="l7.135">       title += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l7.136"></a><span id="l7.136">     document.title = title;</span>
<a href="#l7.137"></a><span id="l7.137"> </span>
<a href="#l7.138"></a><span id="l7.138">     this.isDummy = aMsgHdr.folder == null;</span>
<a href="#l7.139"></a><span id="l7.139">     if (!this.isDummy)</span>
<a href="#l7.140"></a><span id="l7.140">       this.displayedUri = null;</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+    // We've loaded a message, so this should be set to false</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+    this.aboutToLoadMessage = false;</span>
<a href="#l7.144"></a><span id="l7.144">   },</span>
<a href="#l7.145"></a><span id="l7.145"> </span>
<a href="#l7.146"></a><span id="l7.146">   onSelectedMessagesChanged: function () {</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-    if (this.folderDisplay.treeSelection.count == 0) {</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+    // XXX we should figure out why we're calling window.close() both from here</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+    // and from clearDisplay.</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+    if (!this.aboutToLoadMessage &amp;&amp; this.folderDisplay.treeSelection.count == 0) {</span>
<a href="#l7.151"></a><span id="l7.151">       window.close();</span>
<a href="#l7.152"></a><span id="l7.152">       return true;</span>
<a href="#l7.153"></a><span id="l7.153">     }</span>
<a href="#l7.154"></a><span id="l7.154">     return false;</span>
<a href="#l7.155"></a><span id="l7.155">   },</span>
<a href="#l7.156"></a><span id="l7.156"> };</span>
<a href="#l7.157"></a><span id="l7.157"> </span>
<a href="#l7.158"></a><span id="l7.158"> var messagepaneObserver = {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineat">@@ -390,16 +440,43 @@ function actuallyLoadMessage() {</span>
<a href="#l7.160"></a><span id="l7.160">   }</span>
<a href="#l7.161"></a><span id="l7.161"> </span>
<a href="#l7.162"></a><span id="l7.162">   gFolderDisplay.makeActive();</span>
<a href="#l7.163"></a><span id="l7.163"> </span>
<a href="#l7.164"></a><span id="l7.164">   // set focus to the message pane</span>
<a href="#l7.165"></a><span id="l7.165">   window.content.focus();</span>
<a href="#l7.166"></a><span id="l7.166"> }</span>
<a href="#l7.167"></a><span id="l7.167"> </span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+/**</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+ * Load the given message into this window, and bring it to the front. This is</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+ * supposed to be called whenever a message is supposed to be displayed in this</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+ * window.</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+ *</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+ * @param aMsgHdr the message to display</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+ * @param aViewWrapperToClone [optional] a DB view wrapper to clone for the</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+ *                            message window</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+ */</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+function displayMessage(aMsgHdr, aViewWrapperToClone)</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+{</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+  // We're about to load another message, so make sure we don't close this</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+  // window</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+  gMessageDisplay.aboutToLoadMessage = true;</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+  if (aViewWrapperToClone)</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+    gFolderDisplay.cloneView(aViewWrapperToClone);</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+  else</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+    gFolderDisplay.show(aMsgHdr.folder);</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  // show the message</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+  gFolderDisplay.selectMessage(aMsgHdr);</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+  // bring this window to the front</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+  window.focus();</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+}</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+</span>
<a href="#l7.195"></a><span id="l7.195"> function ShowMenus()</span>
<a href="#l7.196"></a><span id="l7.196"> {</span>
<a href="#l7.197"></a><span id="l7.197">   var openMail3Pane_menuitem = document.getElementById('tasksMenuMail');</span>
<a href="#l7.198"></a><span id="l7.198">   if (openMail3Pane_menuitem)</span>
<a href="#l7.199"></a><span id="l7.199">     openMail3Pane_menuitem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l7.200"></a><span id="l7.200"> }</span>
<a href="#l7.201"></a><span id="l7.201"> </span>
<a href="#l7.202"></a><span id="l7.202"> function HideMenus()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -40,16 +40,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.5"></a><span id="l8.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.6"></a><span id="l8.6">  *</span>
<a href="#l8.7"></a><span id="l8.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> Components.utils.import(&quot;resource://gre/modules/folderUtils.jsm&quot;);</span>
<a href="#l8.10"></a><span id="l8.10"> Components.utils.import(&quot;resource://app/modules/activity/activityModules.js&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> Components.utils.import(&quot;resource://app/modules/jsTreeSelection.js&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/MailConsts.js&quot;);</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> /* This is where functions related to the 3 pane window are kept */</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> // from MailNewsTypes.h</span>
<a href="#l8.17"></a><span id="l8.17"> const nsMsgKey_None = 0xFFFFFFFF;</span>
<a href="#l8.18"></a><span id="l8.18"> const nsMsgViewIndex_None = 0xFFFFFFFF;</span>
<a href="#l8.19"></a><span id="l8.19"> const kMailCheckOncePrefName = &quot;mail.startup.enabledMailCheckOnce&quot;;</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -309,16 +310,17 @@ function LoadPostAccountWizard()</span>
<a href="#l8.22"></a><span id="l8.22"> {</span>
<a href="#l8.23"></a><span id="l8.23">   InitMsgWindow();</span>
<a href="#l8.24"></a><span id="l8.24">   messenger.setWindow(window, msgWindow);</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">   InitPanes();</span>
<a href="#l8.27"></a><span id="l8.27">   MigrateAttachmentDownloadStore();</span>
<a href="#l8.28"></a><span id="l8.28">   MigrateJunkMailSettings();</span>
<a href="#l8.29"></a><span id="l8.29">   MigrateFolderViews();</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  MigrateOpenMessageBehavior();</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32">   accountManager.setSpecialFolders();</span>
<a href="#l8.33"></a><span id="l8.33">   accountManager.loadVirtualFolders();</span>
<a href="#l8.34"></a><span id="l8.34">   accountManager.addIncomingServerListener(gThreePaneIncomingServerListener);</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">   gPhishingDetector.init();</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">   AddToSession();</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineat">@@ -927,24 +929,29 @@ function TreeOnMouseDown(event)</span>
<a href="#l8.40"></a><span id="l8.40">     if (event.button == 2 || event.button == 1)</span>
<a href="#l8.41"></a><span id="l8.41">     {</span>
<a href="#l8.42"></a><span id="l8.42">       // We want a single selection if this is a middle-click (button 1)</span>
<a href="#l8.43"></a><span id="l8.43">       ChangeSelectionWithoutContentLoad(event, event.target.parentNode,</span>
<a href="#l8.44"></a><span id="l8.44">                                         event.button == 1);</span>
<a href="#l8.45"></a><span id="l8.45">     }</span>
<a href="#l8.46"></a><span id="l8.46"> }</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+function FolderPaneContextMenuNewTab()</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+{</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  MsgOpenNewTabForFolder(gPrefBranch.getBoolPref(&quot;mail.contextMenuBackgroundTabs&quot;));</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+}</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+</span>
<a href="#l8.53"></a><span id="l8.53"> function FolderPaneOnClick(event)</span>
<a href="#l8.54"></a><span id="l8.54"> {</span>
<a href="#l8.55"></a><span id="l8.55">   var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">   // Middle click on a folder opens the folder in a tab</span>
<a href="#l8.58"></a><span id="l8.58">   if (event.button == 1)</span>
<a href="#l8.59"></a><span id="l8.59">   {</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-    MsgOpenNewTabForFolder();</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    FolderPaneContextMenuNewTab();</span>
<a href="#l8.62"></a><span id="l8.62">     RestoreSelectionWithoutContentLoad(folderTree);</span>
<a href="#l8.63"></a><span id="l8.63">   }</span>
<a href="#l8.64"></a><span id="l8.64">   else if (event.button == 0)</span>
<a href="#l8.65"></a><span id="l8.65">   {</span>
<a href="#l8.66"></a><span id="l8.66">     var row = {};</span>
<a href="#l8.67"></a><span id="l8.67">     var col = {};</span>
<a href="#l8.68"></a><span id="l8.68">     var elt = {};</span>
<a href="#l8.69"></a><span id="l8.69">     folderTree.treeBoxObject.getCellAt(event.clientX, event.clientY, row, col, elt);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineat">@@ -957,24 +964,32 @@ function FolderPaneOnClick(event)</span>
<a href="#l8.71"></a><span id="l8.71">     }</span>
<a href="#l8.72"></a><span id="l8.72">     else if ((event.originalTarget.localName == &quot;slider&quot;) ||</span>
<a href="#l8.73"></a><span id="l8.73">              (event.originalTarget.localName == &quot;scrollbarbutton&quot;)) {</span>
<a href="#l8.74"></a><span id="l8.74">       event.stopPropagation();</span>
<a href="#l8.75"></a><span id="l8.75">     }</span>
<a href="#l8.76"></a><span id="l8.76">   }</span>
<a href="#l8.77"></a><span id="l8.77"> }</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+function ThreadTreeContextMenuNewTab()</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+{</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+  document.getElementById('tabmail').openTab(&quot;message&quot;,</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+      {msgHdr: gFolderDisplay.selectedMessage,</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+       viewWrapperToClone: gFolderDisplay.view,</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+       background: gPrefBranch.getBoolPref(&quot;mail.contextMenuBackgroundTabs&quot;)});</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+}</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+</span>
<a href="#l8.87"></a><span id="l8.87"> function ThreadTreeOnClick(event)</span>
<a href="#l8.88"></a><span id="l8.88"> {</span>
<a href="#l8.89"></a><span id="l8.89">   var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l8.90"></a><span id="l8.90"> </span>
<a href="#l8.91"></a><span id="l8.91">   // Middle click on a message opens the message in a tab</span>
<a href="#l8.92"></a><span id="l8.92">   if (event.button == 1)</span>
<a href="#l8.93"></a><span id="l8.93">   {</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-    MsgOpenNewTabForMessage();</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+    ThreadTreeContextMenuNewTab();</span>
<a href="#l8.96"></a><span id="l8.96">     RestoreSelectionWithoutContentLoad(threadTree);</span>
<a href="#l8.97"></a><span id="l8.97">   }</span>
<a href="#l8.98"></a><span id="l8.98"> }</span>
<a href="#l8.99"></a><span id="l8.99"> </span>
<a href="#l8.100"></a><span id="l8.100"> function GetSelectedMsgFolders()</span>
<a href="#l8.101"></a><span id="l8.101"> {</span>
<a href="#l8.102"></a><span id="l8.102">   return gFolderTreeView.getSelectedFolders();</span>
<a href="#l8.103"></a><span id="l8.103"> }</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineat">@@ -1065,16 +1080,44 @@ function MigrateAttachmentDownloadStore(</span>
<a href="#l8.105"></a><span id="l8.105">     if (downloadsFile &amp;&amp; downloadsFile.exists())</span>
<a href="#l8.106"></a><span id="l8.106">       downloadsFile.remove(false);</span>
<a href="#l8.107"></a><span id="l8.107"> </span>
<a href="#l8.108"></a><span id="l8.108">     // bump the version so we don't bother doing this again.</span>
<a href="#l8.109"></a><span id="l8.109">     gPrefBranch.setIntPref(&quot;mail.attachment.store.version&quot;, 1);</span>
<a href="#l8.110"></a><span id="l8.110">   }</span>
<a href="#l8.111"></a><span id="l8.111"> }</span>
<a href="#l8.112"></a><span id="l8.112"> </span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+// Do a one-time migration of the old mailnews.reuse_message_window pref to the</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+// newer mail.openMessageBehavior. This does the migration only if the old pref</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+// is defined.</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+function MigrateOpenMessageBehavior()</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+{</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+  let openMessageBehaviorVersion = gPrefBranch.getIntPref(</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+                                     &quot;mail.openMessageBehavior.version&quot;);</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+  if (!openMessageBehaviorVersion)</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+  {</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+    let reuseMessageWindow;</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+    try {</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+      reuseMessageWindow = gPrefBranch.getBoolPref(</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+                             &quot;mailnews.reuse_message_window&quot;);</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+    }</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+    catch (e) {}</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+    // Don't touch this if it isn't defined</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+    if (reuseMessageWindow === true)</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+      gPrefBranch.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+          MailConsts.OpenMessageBehavior.EXISTING_WINDOW);</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+    else if (reuseMessageWindow === false)</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+      gPrefBranch.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+          MailConsts.OpenMessageBehavior.NEW_TAB);</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+    gPrefBranch.setIntPref(&quot;mail.openMessageBehavior.version&quot;, 1);</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+  }</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+}</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+</span>
<a href="#l8.141"></a><span id="l8.141"> function threadPaneOnDragStart(aEvent) {</span>
<a href="#l8.142"></a><span id="l8.142">   if (aEvent.originalTarget.localName != &quot;treechildren&quot;)</span>
<a href="#l8.143"></a><span id="l8.143">     return;</span>
<a href="#l8.144"></a><span id="l8.144"> </span>
<a href="#l8.145"></a><span id="l8.145">   var messages = gFolderDisplay.selectedMessageUris;</span>
<a href="#l8.146"></a><span id="l8.146">   if (!messages)</span>
<a href="#l8.147"></a><span id="l8.147">     return;</span>
<a href="#l8.148"></a><span id="l8.148"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/content/search.xml</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/content/search.xml</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -73,17 +73,18 @@</span>
<a href="#l9.4"></a><span id="l9.4">           //  to the initial search value.  Otherwise, clear it.  This</span>
<a href="#l9.5"></a><span id="l9.5">           //  is the value that is going to be saved with the current</span>
<a href="#l9.6"></a><span id="l9.6">           //  tab when we switch back to it next.</span>
<a href="#l9.7"></a><span id="l9.7">           if (tabmail.currentTabInfo.mode.name == &quot;glodaSearch&quot;)</span>
<a href="#l9.8"></a><span id="l9.8">             this.value = tabmail.currentTabInfo.searchString;</span>
<a href="#l9.9"></a><span id="l9.9">           else</span>
<a href="#l9.10"></a><span id="l9.10">             this.value = &quot;&quot;;</span>
<a href="#l9.11"></a><span id="l9.11">           // open a new tab with our dude</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-          tabmail.openTab(&quot;glodaSearch&quot;, searchString, &quot;everything&quot;, &quot;everywhere&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+          tabmail.openTab(&quot;glodaSearch&quot;, {searchString: searchString,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+              facetString: &quot;everything&quot;, locationString: &quot;everywhere&quot;});</span>
<a href="#l9.15"></a><span id="l9.15">         }</span>
<a href="#l9.16"></a><span id="l9.16">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l9.17"></a><span id="l9.17">     &lt;/handlers&gt;</span>
<a href="#l9.18"></a><span id="l9.18">     </span>
<a href="#l9.19"></a><span id="l9.19">   &lt;/binding&gt;</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">   &lt;!--</span>
<a href="#l9.22"></a><span id="l9.22">     - The glodaFacets binding is used to display additional search constraints</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/content/specialTabs.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/content/specialTabs.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -71,17 +71,17 @@ var specialTabs = {</span>
<a href="#l10.4"></a><span id="l10.4">     },</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6">     modes: {</span>
<a href="#l10.7"></a><span id="l10.7">       contentTab: {</span>
<a href="#l10.8"></a><span id="l10.8">         type: &quot;contentTab&quot;,</span>
<a href="#l10.9"></a><span id="l10.9">         maxTabs: 10</span>
<a href="#l10.10"></a><span id="l10.10">       }</span>
<a href="#l10.11"></a><span id="l10.11">     },</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    shouldSwitchTo: function onSwitchTo(aContentPage, aTitle) {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    shouldSwitchTo: function onSwitchTo({contentPage: aContentPage}) {</span>
<a href="#l10.14"></a><span id="l10.14">       let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l10.15"></a><span id="l10.15">       let tabInfo = tabmail.tabInfo;</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17">       // Remove any anchors - especially for the about: pages, we just want</span>
<a href="#l10.18"></a><span id="l10.18">       // to re-use the same tab.</span>
<a href="#l10.19"></a><span id="l10.19">       let regEx = new RegExp(&quot;#.*&quot;);</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21">       let contentUrl = aContentPage.replace(regEx, &quot;&quot;);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -95,17 +95,17 @@ var specialTabs = {</span>
<a href="#l10.23"></a><span id="l10.23">           // Ensure we go to the correct location on the page.</span>
<a href="#l10.24"></a><span id="l10.24">           tabInfo[selectedIndex].panel.firstChild</span>
<a href="#l10.25"></a><span id="l10.25">                                 .setAttribute(&quot;src&quot;, aContentPage);</span>
<a href="#l10.26"></a><span id="l10.26">           return selectedIndex;</span>
<a href="#l10.27"></a><span id="l10.27">         }</span>
<a href="#l10.28"></a><span id="l10.28">       }</span>
<a href="#l10.29"></a><span id="l10.29">       return -1;</span>
<a href="#l10.30"></a><span id="l10.30">     },</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-    openTab: function onTabOpened(aTab, aContentPage) {</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+    openTab: function onTabOpened(aTab, {contentPage: aContentPage}) {</span>
<a href="#l10.33"></a><span id="l10.33">       // You can't dynamically change an iframe from a non-content to a content</span>
<a href="#l10.34"></a><span id="l10.34">       // type, therefore we dynamically create the element instead.</span>
<a href="#l10.35"></a><span id="l10.35">       let iframe = document.createElement(&quot;browser&quot;);</span>
<a href="#l10.36"></a><span id="l10.36">       iframe.setAttribute(&quot;type&quot;, &quot;content-primary&quot;);</span>
<a href="#l10.37"></a><span id="l10.37">       iframe.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l10.38"></a><span id="l10.38">       iframe.setAttribute(&quot;autocompleteenabled&quot;, false);</span>
<a href="#l10.39"></a><span id="l10.39">       iframe.setAttribute(&quot;disablehistory&quot;, true);</span>
<a href="#l10.40"></a><span id="l10.40">       iframe.setAttribute(&quot;id&quot;, &quot;contentTabType&quot; + this.lastBrowserId);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -68,19 +68,22 @@</span>
<a href="#l11.4"></a><span id="l11.4">     -</span>
<a href="#l11.5"></a><span id="l11.5">     - From a javascript perspective, there are three types of code that we</span>
<a href="#l11.6"></a><span id="l11.6">     -  expect to interact with:</span>
<a href="#l11.7"></a><span id="l11.7">     - 1) Code that wants to open new tabs.</span>
<a href="#l11.8"></a><span id="l11.8">     - 2) Code that wants to contribute one or more varieties of tabs.</span>
<a href="#l11.9"></a><span id="l11.9">     - 3) Code that wants to monitor to know when the active tab changes.</span>
<a href="#l11.10"></a><span id="l11.10">     -</span>
<a href="#l11.11"></a><span id="l11.11">     - Consumer code should use the following methods:</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    - * openTab(aTabModeName, arguments...): Open a tab of the given &quot;mode&quot;,</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    -   passing the provided arguments.  The tab type author should tell you</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-    -   the modes they implement and the required/optional arguments.</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+    - * openTab(aTabModeName, aArgs): Open a tab of the given &quot;mode&quot;,</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+    -   passing the provided arguments as an object.  The tab type author</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+    -   should tell you the modes they implement and the required/optional</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+    -   arguments.</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+    -   One of the arguments you can pass is &quot;background&quot;: if this is true,</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+    -   the tab will be loaded in the background.</span>
<a href="#l11.21"></a><span id="l11.21">     - * closeTab(aOptionalTabIndexInfoOrTabNode): If no argument is provided,</span>
<a href="#l11.22"></a><span id="l11.22">     -   the current tab is closed.  If an argument is provided, it can be</span>
<a href="#l11.23"></a><span id="l11.23">     -   a tab index, a tab info object, or the tabmail-tab bound element</span>
<a href="#l11.24"></a><span id="l11.24">     -   that _is_ the tab.  Some tabs cannot be closed, in which case this</span>
<a href="#l11.25"></a><span id="l11.25">     -   will do nothing.</span>
<a href="#l11.26"></a><span id="l11.26">     - * switchToTab(aTabIndexInfoOrTabNode): Switch to the tab by providing</span>
<a href="#l11.27"></a><span id="l11.27">     -   a tab index, tab info object, or tab node (tabmail-tab bound</span>
<a href="#l11.28"></a><span id="l11.28">     -   element.)  You can also just poke at tabmail.tabContainer and its</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineat">@@ -148,32 +151,33 @@</span>
<a href="#l11.30"></a><span id="l11.30">     -     Generally, this would be the same as the mode name, but you can do as</span>
<a href="#l11.31"></a><span id="l11.31">     -     you please.</span>
<a href="#l11.32"></a><span id="l11.32">     - * isDefault: This should only be present and should be true for the tab</span>
<a href="#l11.33"></a><span id="l11.33">     -     mode that is the tab displayed automatically on startup.</span>
<a href="#l11.34"></a><span id="l11.34">     - * maxTabs: The maximum number of this mode that can be opened at a time.</span>
<a href="#l11.35"></a><span id="l11.35">     -     If this limit is reached, any additional calls to openTab for this</span>
<a href="#l11.36"></a><span id="l11.36">     -     mode will simply result in the first existing tab of this mode being</span>
<a href="#l11.37"></a><span id="l11.37">     -     displayed.</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-    - * shouldSwitchTo(arguments...): Optional function. Called when</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-    -     openTab is called on the top-level tabmail binding. It is used to</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-    -     decide if the openTab function should switch to an existing tab or</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-    -     actually open a new tab.</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+    - * shouldSwitchTo(aArgs): Optional function. Called when openTab is called</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+    -     on the top-level tabmail binding. It is used to decide if the openTab</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+    -     function should switch to an existing tab or actually open a new tab.</span>
<a href="#l11.45"></a><span id="l11.45">     -     If the openTab function should switch to an existing tab, return the</span>
<a href="#l11.46"></a><span id="l11.46">     -     index of that tab; otherwise return -1.</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-    - * openTab(aTab, arguments...): Called when a tab of the given mode is</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-    -     in the process of being opened.  aTab will have its &quot;mode&quot; attribute</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+    -     aArgs is a set of named parameters (the ones that are later passed to</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+    -     openTab).</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+    - * openTab(aTab, aArgs): Called when a tab of the given mode is in the</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+    -     process of being opened.  aTab will have its &quot;mode&quot; attribute</span>
<a href="#l11.53"></a><span id="l11.53">     -     set to the mode definition of the tab mode being opened.  You should</span>
<a href="#l11.54"></a><span id="l11.54">     -     set the &quot;title&quot; attribute on it, and may set any other attributes</span>
<a href="#l11.55"></a><span id="l11.55">     -     you wish for your own use in subsequent functions.  Note that 'this'</span>
<a href="#l11.56"></a><span id="l11.56">     -     points to the tab type definition, not the mode definition as you</span>
<a href="#l11.57"></a><span id="l11.57">     -     might expect.  This allows you to place common logic code on the</span>
<a href="#l11.58"></a><span id="l11.58">     -     tab type for use by multiple modes and to defer to it.  Any arguments</span>
<a href="#l11.59"></a><span id="l11.59">     -     provided to the caller of tabmail.openTab will be passed to your</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-    -     function as well.</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+    -     function as well, including background.</span>
<a href="#l11.62"></a><span id="l11.62">     - * closeTab(aTab): Called when aTab is being closed.  The tab need not be</span>
<a href="#l11.63"></a><span id="l11.63">     -     currently displayed.  You are responsible for properly cleaning up</span>
<a href="#l11.64"></a><span id="l11.64">     -     any state you preserved in aTab.</span>
<a href="#l11.65"></a><span id="l11.65">     - * saveTabState(aTab): Called when aTab is being switched away from so that</span>
<a href="#l11.66"></a><span id="l11.66">     -     you can preserve its state on aTab.  This is primarily for single</span>
<a href="#l11.67"></a><span id="l11.67">     -     tab panel implementations; you may not have much state to save if your</span>
<a href="#l11.68"></a><span id="l11.68">     -     tab has its own tab panel.</span>
<a href="#l11.69"></a><span id="l11.69">     - * showTab(aTab): Called when aTab is being displayed and you should</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineat">@@ -404,42 +408,48 @@</span>
<a href="#l11.71"></a><span id="l11.71">               for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l11.72"></a><span id="l11.72">                 tabMonitor.onTabSwitched(firstTab, null);</span>
<a href="#l11.73"></a><span id="l11.73">             }</span>
<a href="#l11.74"></a><span id="l11.74">           }</span>
<a href="#l11.75"></a><span id="l11.75">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.76"></a><span id="l11.76">       &lt;/method&gt;</span>
<a href="#l11.77"></a><span id="l11.77">       &lt;method name=&quot;openTab&quot;&gt;</span>
<a href="#l11.78"></a><span id="l11.78">         &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+        &lt;parameter name=&quot;aArgs&quot;/&gt;</span>
<a href="#l11.80"></a><span id="l11.80">         &lt;body&gt;</span>
<a href="#l11.81"></a><span id="l11.81">             &lt;![CDATA[</span>
<a href="#l11.82"></a><span id="l11.82">           let tabMode = this.tabModes[aTabModeName];</span>
<a href="#l11.83"></a><span id="l11.83">           // if we are already at our limit for this mode, show an existing one</span>
<a href="#l11.84"></a><span id="l11.84">           if (tabMode.tabs.length == tabMode.maxTabs) {</span>
<a href="#l11.85"></a><span id="l11.85">             let desiredTab = tabMode.tabs[0];</span>
<a href="#l11.86"></a><span id="l11.86">             this.tabContainer.selectedIndex = this.tabInfo.indexOf(desiredTab);</span>
<a href="#l11.87"></a><span id="l11.87">             return;</span>
<a href="#l11.88"></a><span id="l11.88">           }</span>
<a href="#l11.89"></a><span id="l11.89"> </span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+          // Do this so that we don't generate strict warnings</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+          let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+</span>
<a href="#l11.93"></a><span id="l11.93">           // If the mode wants us to, we should switch to an existing tab</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-          // rather than open a new one.</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+          // rather than open a new one. We shouldn't switch to the tab if</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+          // we're opening it in the background, though.</span>
<a href="#l11.97"></a><span id="l11.97">           let shouldSwitchToFunc = tabMode.shouldSwitchTo ||</span>
<a href="#l11.98"></a><span id="l11.98">                                    tabMode.tabType.shouldSwitchTo;</span>
<a href="#l11.99"></a><span id="l11.99"> </span>
<a href="#l11.100"></a><span id="l11.100">           if (shouldSwitchToFunc) {</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-            let args = Array.prototype.slice.call(arguments, 1);</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-            let tabIndex = shouldSwitchToFunc.apply(tabMode.tabType, args);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+            let tabIndex = shouldSwitchToFunc.apply(tabMode.tabType, [aArgs]);</span>
<a href="#l11.104"></a><span id="l11.104">             if (tabIndex &gt;= 0) {</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-              this.selectTabByIndex(null, tabIndex);</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+              if (!background)</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+                this.selectTabByIndex(null, tabIndex);</span>
<a href="#l11.108"></a><span id="l11.108">               return;</span>
<a href="#l11.109"></a><span id="l11.109">             }</span>
<a href="#l11.110"></a><span id="l11.110">           }</span>
<a href="#l11.111"></a><span id="l11.111"> </span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-          // we need to save the state before it gets corrupted</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-          this.saveCurrentTabState();</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+          if (!background)</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+            // we need to save the state before it gets corrupted</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+            this.saveCurrentTabState();</span>
<a href="#l11.117"></a><span id="l11.117"> </span>
<a href="#l11.118"></a><span id="l11.118">           let tab = {mode: tabMode, busy: false, canClose: true};</span>
<a href="#l11.119"></a><span id="l11.119">           tabMode.tabs.push(tab);</span>
<a href="#l11.120"></a><span id="l11.120"> </span>
<a href="#l11.121"></a><span id="l11.121">           var t = document.createElementNS(</span>
<a href="#l11.122"></a><span id="l11.122">             &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l11.123"></a><span id="l11.123">             &quot;tab&quot;);</span>
<a href="#l11.124"></a><span id="l11.124">           tab.tabNode = t;</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineat">@@ -454,60 +464,64 @@</span>
<a href="#l11.126"></a><span id="l11.126">           if (this.tabContainer.collapsed) {</span>
<a href="#l11.127"></a><span id="l11.127">             this.tabContainer.collapsed = false;</span>
<a href="#l11.128"></a><span id="l11.128">             this.tabContainer.adjustTabstrip();</span>
<a href="#l11.129"></a><span id="l11.129">           }</span>
<a href="#l11.130"></a><span id="l11.130"> </span>
<a href="#l11.131"></a><span id="l11.131">           let oldTab = this._mostRecentTabInfo = this.currentTabInfo;</span>
<a href="#l11.132"></a><span id="l11.132"> </span>
<a href="#l11.133"></a><span id="l11.133">           // the order of the following statements is important</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-          this.currentTabInfo = tab;</span>
<a href="#l11.135"></a><span id="l11.135">           this.tabInfo[this.tabContainer.childNodes.length - 1] = tab;</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-          // this has a side effect of calling updateCurrentTab, but our</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-          //  setting currentTabInfo above will cause it to take no action.</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-          this.tabContainer.selectedIndex =</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-            this.tabContainer.childNodes.length - 1;</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+          if (!background) {</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+            this.currentTabInfo = tab;</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+            // this has a side effect of calling updateCurrentTab, but our</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+            //  setting currentTabInfo above will cause it to take no action.</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+            this.tabContainer.selectedIndex =</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+              this.tabContainer.childNodes.length - 1;</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+          }</span>
<a href="#l11.147"></a><span id="l11.147"> </span>
<a href="#l11.148"></a><span id="l11.148">           // make sure we are on the right panel</span>
<a href="#l11.149"></a><span id="l11.149">           if (tab.mode.tabType.perTabPanel) {</span>
<a href="#l11.150"></a><span id="l11.150">             // should we create the element for them, or will they do it?</span>
<a href="#l11.151"></a><span id="l11.151">             if (typeof(tab.mode.tabType.perTabPanel) == &quot;string&quot;) {</span>
<a href="#l11.152"></a><span id="l11.152">               tab.panel = document.createElementNS(</span>
<a href="#l11.153"></a><span id="l11.153">                 &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l11.154"></a><span id="l11.154">                 tab.mode.tabType.perTabPanel);</span>
<a href="#l11.155"></a><span id="l11.155">             }</span>
<a href="#l11.156"></a><span id="l11.156">             else {</span>
<a href="#l11.157"></a><span id="l11.157">               tab.panel = tab.mode.tabType.perTabPanel(tab);</span>
<a href="#l11.158"></a><span id="l11.158">             }</span>
<a href="#l11.159"></a><span id="l11.159">             this.panelContainer.appendChild(tab.panel);</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-            this.panelContainer.selectedPanel = tab.panel;</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+            if (!background)</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+              this.panelContainer.selectedPanel = tab.panel;</span>
<a href="#l11.163"></a><span id="l11.163">           }</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-          else</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+          else if (!background)</span>
<a href="#l11.166"></a><span id="l11.166">             this.panelContainer.selectedPanel = tab.mode.tabType.panel;</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-            </span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+</span>
<a href="#l11.169"></a><span id="l11.169">           let tabOpenFunc = tab.mode.openTab || tab.mode.tabType.openTab;</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-          let args = [tab].concat(Array.prototype.slice.call(arguments, 1));</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-          tabOpenFunc.apply(tab.mode.tabType, args);</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineminus">-          </span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-          if (this.tabMonitors.length) {</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+          tabOpenFunc.apply(tab.mode.tabType, [tab, aArgs]);</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+          if (!background &amp;&amp; this.tabMonitors.length) {</span>
<a href="#l11.177"></a><span id="l11.177">             for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l11.178"></a><span id="l11.178">               tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l11.179"></a><span id="l11.179">           }</span>
<a href="#l11.180"></a><span id="l11.180">           </span>
<a href="#l11.181"></a><span id="l11.181">           // clear _mostRecentTabInfo; we only needed it during the call to</span>
<a href="#l11.182"></a><span id="l11.182">           //  openTab.</span>
<a href="#l11.183"></a><span id="l11.183">           this._mostRecentTabInfo = null;</span>
<a href="#l11.184"></a><span id="l11.184">           </span>
<a href="#l11.185"></a><span id="l11.185">           t.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-          </span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">-          let docTitle = tab.title;</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-          if (!gPlatformOSX)</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-            docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-          document.title = docTitle;</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-          </span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+          if (!background) {</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+            let docTitle = tab.title;</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+            if (!gPlatformOSX)</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+              docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+            document.title = docTitle;</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+          }</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+</span>
<a href="#l11.200"></a><span id="l11.200">           // for styling purposes, apply the type to the tab...</span>
<a href="#l11.201"></a><span id="l11.201">           t.setAttribute('type', tab.mode.type);</span>
<a href="#l11.202"></a><span id="l11.202"> </span>
<a href="#l11.203"></a><span id="l11.203">           // Update the toolbar status - we don't need to do menus as they</span>
<a href="#l11.204"></a><span id="l11.204">           // do themselves when we open them.</span>
<a href="#l11.205"></a><span id="l11.205">           UpdateMailToolbar(&quot;tabmail&quot;);</span>
<a href="#l11.206"></a><span id="l11.206"> </span>
<a href="#l11.207"></a><span id="l11.207">           return tab;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/content/widgetglue.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/content/widgetglue.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -39,16 +39,18 @@</span>
<a href="#l12.4"></a><span id="l12.4">  *  ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> /*</span>
<a href="#l12.7"></a><span id="l12.7">  * widget-specific wrapper glue. There should be one function for every</span>
<a href="#l12.8"></a><span id="l12.8">  * widget/menu item, which gets some context (like the current selection)</span>
<a href="#l12.9"></a><span id="l12.9">  * and then calls a function/command in commandglue</span>
<a href="#l12.10"></a><span id="l12.10">  */</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/MailUtils.js&quot;);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+</span>
<a href="#l12.14"></a><span id="l12.14"> //The eventual goal is for this file to go away and its contents to be brought into</span>
<a href="#l12.15"></a><span id="l12.15"> //mailWindowOverlay.js.  This is currently being done.</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> function MsgToggleMessagePane()</span>
<a href="#l12.18"></a><span id="l12.18"> {</span>
<a href="#l12.19"></a><span id="l12.19">   // Bail without doing anything if we are not a folder tab.</span>
<a href="#l12.20"></a><span id="l12.20">   let currentTabInfo = document.getElementById(&quot;tabmail&quot;).currentTabInfo;</span>
<a href="#l12.21"></a><span id="l12.21">   if (currentTabInfo.mode.name != &quot;folder&quot;)</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -66,26 +68,18 @@ function MsgToggleMessagePane()</span>
<a href="#l12.23"></a><span id="l12.23"> // Given a URI we would like to return corresponding message folder here.</span>
<a href="#l12.24"></a><span id="l12.24"> // An additonal input param which specifies whether or not to check folder</span>
<a href="#l12.25"></a><span id="l12.25"> // attributes (like if there exists a parent or is it a server) is also passed</span>
<a href="#l12.26"></a><span id="l12.26"> // to this routine. Qualifying against those checks would return an existing</span>
<a href="#l12.27"></a><span id="l12.27"> // folder. Callers who don't want to check those attributes will specify the</span>
<a href="#l12.28"></a><span id="l12.28"> // same and then this routine will simply return a msgfolder. This scenario</span>
<a href="#l12.29"></a><span id="l12.29"> // applies to a new imap account creation where special folders are created</span>
<a href="#l12.30"></a><span id="l12.30"> // on demand and hence needs to prior check of existence.</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+/**</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+ * Gets the message folder for this URI.</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+ *</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+ * @deprecated Use |MailUtils.getFolderForURI| instead.</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ */</span>
<a href="#l12.37"></a><span id="l12.37"> function GetMsgFolderFromUri(uri, checkFolderAttributes)</span>
<a href="#l12.38"></a><span id="l12.38"> {</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-    var msgfolder = null;</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-    try {</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-        var rdfService = Components.classes['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-                                   .getService(Components.interfaces.nsIRDFService);</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-        var resource = rdfService.GetResource(uri);</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-        msgfolder = resource.QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-        if (checkFolderAttributes) {</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-            if (!(msgfolder &amp;&amp; (msgfolder.parent || msgfolder.isServer))) {</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-                msgfolder = null;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-            }</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-        }</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-    }</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-    catch (ex) {</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-    }</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-    return msgfolder;</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+  return MailUtils.getFolderForURI(uri, checkFolderAttributes);</span>
<a href="#l12.55"></a><span id="l12.55"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mail/base/modules/MailConsts.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,73 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ *</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+ *</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ * License.</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+ *</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+ *</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+ *</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+ *</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+ *</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+/**</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+ * This is a place to store constants and enumerations that are needed only by</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+ * JavaScript code, especially component/module code.</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+ */</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;MailConsts&quot;];</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+var MailConsts =</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+{</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+  /**</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+   * Determine how to open a message when it is double-clicked or selected and</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+   * Enter pressed. The preference to set this is mail.openMessageBehavior.</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+   */</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+  OpenMessageBehavior: {</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+    /**</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+     * Open the message in a new window. If multiple messages are selected, all</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+     * of them are opened in separate windows.</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+     */</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+    NEW_WINDOW: 0,</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+    /**</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+     * Open the message in an existing window. If multiple messages are</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+     * selected, the fallback is to &quot;new window&quot; behavior. If no standalone</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+     * windows are open, the message is opened in a new standalone window.</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+     */</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+    EXISTING_WINDOW: 1,</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+    /**</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+     * Open the message in a new tab. If multiple messages are selected, all of</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+     * them are opened as tabs, with the last tab in the foreground and all the</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+     * rest in the background. If no 3-pane window is open, the message is</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+     * opened in a new standalone window.</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+     */</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    NEW_TAB: 2</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+  }</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/mail/base/modules/MailUtils.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,206 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ *</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+ *</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+ * License.</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+ *</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+ *</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+ *</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+ *</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+ *</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;MailUtils&quot;];</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/MailConsts.js&quot;);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+const MC = MailConsts;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+/**</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+ * This module has several utility functions for use by both core and</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+ * third-party code. Some functions are aimed at code that doesn't have a</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+ * window context, while others can be used anywhere.</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+ */</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+var MailUtils =</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+{</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+  /**</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+   * A reference to the root pref branch</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+   */</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+  get _prefBranch MailUtils_get_prefBranch() {</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+    delete this._prefBranch;</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+    return this._prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+                                .getService(Ci.nsIPrefService)</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+                                .getBranch(null);</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+  },</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+  /**</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+   * Discover all folders. This is useful during startup, when you have code</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+   * that deals with folders and that executes before the main 3pane window is</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+   * open (the folder tree wouldn't have been initialized yet).</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+   */</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+  discoverFolders: function MailUtils_discoverFolders() {</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+    let accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+                           .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+    let servers = accountManager.allServers;</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+    for each (let server in fixIterator(servers, Ci.nsIMsgIncomingServer))</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+      server.rootFolder.subFolders;</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+  },</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  /**</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+   * Get the nsIMsgFolder corresponding to this file. This just looks at all</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+   * folders and does a direct match.</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+   *</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+   * One of the places this is used is desktop search integration -- to open</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+   * the search result corresponding to a mozeml/wdseml file, we need to figure</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+   * out the folder using the file's path.</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+   *</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+   * @param aFile the nsILocalFile to convert to a folder</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+   * @returns the nsIMsgFolder corresponding to aFile, or null if the folder</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+   *          isn't found</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+   */</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+  getFolderForFileInProfile:</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+      function MailUtils_getFolderForFileInProfile(aFile) {</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+    let accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+                           .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+    let folders = accountManager.allFolders;</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+    for each (let folder in fixIterator(folders.enumerate(), Ci.nsIMsgFolder)) {</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+      if (folder.filePath.equals(aFile))</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+        return folder;</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+    }</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+    return null;</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+  },</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+  /**</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+   * Get the nsIMsgFolder corresponding to this URI. This uses the RDF service</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+   * to do the work.</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+   *</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+   * @param aFolderURI the URI to convert into a folder</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+   * @param aCheckFolderAttributes whether to check that the folder either has</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+   *                              a parent or isn't a server</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+   * @returns the nsIMsgFolder corresponding to this URI, or null if</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+   *          aCheckFolderAttributes is true and the folder doesn't have a</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+   *          parent or is a server</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+   */</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+  getFolderForURI: function MailUtils_getFolderForURI(aFolderURI,</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+                       aCheckFolderAttributes) {</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+    let folder = null;</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+    let rdfService = Cc['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+                       .getService(Ci.nsIRDFService);</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+    folder = rdfService.GetResource(aFolderURI);</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+    // This is going to QI the folder to an nsIMsgFolder as well</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+    if (folder &amp;&amp; folder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+      if (aCheckFolderAttributes &amp;&amp; !(folder.parent || folder.isServer))</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+        return null;</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+    }</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+    else {</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+      return null;</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+    }</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+    return folder;</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+  },</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+  /**</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+   * Displays this message header in a new tab, a new window or an existing</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+   * window, depending on the preference and whether a 3pane or standalone</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+   * window is already open. This function should be called when you'd like to</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+   * display a message to the user according to the pref set.</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+   *</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+   * @param aMsgHdr the message header to display</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+   */</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+  displayMessage: function MailUtils_displayMessage(aMsgHdr) {</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+    let openMessageBehavior = this._prefBranch.getIntPref(</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+                                  &quot;mail.openMessageBehavior&quot;);</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+    if (openMessageBehavior == MC.OpenMessageBehavior.NEW_WINDOW) {</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+      this.openMessageInNewWindow(aMsgHdr);</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+    }</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+    else if (openMessageBehavior == MC.OpenMessageBehavior.EXISTING_WINDOW) {</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+      // Try reusing an existing window. If we can't, fall back to opening a</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+      // new window</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+      if (!this.openMessageInExistingWindow(aMsgHdr))</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+        this.openMessageInNewWindow(aMsgHdr);</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+    }</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+    else if (openMessageBehavior == MC.OpenMessageBehavior.NEW_TAB) {</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+      // Try opening a new tab in a 3pane window. If we can't, fall back to</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+      // opening a new window</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+      let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+                             .getService(Ci.nsIWindowMediator);</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+      let mail3PaneWindow = windowMediator.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+      // Do this directly instead of calling MsgOpenNewTabForMessage, because</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+      // that passes in gFolderDisplay.view to be cloned, and we don't want</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+      // that</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+      if (mail3PaneWindow) {</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+        mail3PaneWindow.document.getElementById(&quot;tabmail&quot;).openTab(&quot;message&quot;,</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+            {msgHdr: aMsgHdr, background: false});</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+        mail3PaneWindow.focus();</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+      }</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+      else {</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+        this.openMessageInNewWindow(aMsgHdr);</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+      }</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+    }</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+  },</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+  /**</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+   * Show this message in an existing window.</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+   *</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+   * @param aMsgHdr the message header to display</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+   * @param aViewWrapperToClone [optional] a DB view wrapper to clone for the</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+   *                            message window</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+   * @returns true if an existing window was found and the message header was</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+   *          displayed, false otherwise</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+   */</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+  openMessageInExistingWindow:</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+      function MailUtils_openMessageInExistingWindow(aMsgHdr,</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+                                                     aViewWrapperToClone) {</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+    let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+                           .getService(Ci.nsIWindowMediator);</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+    let messageWindow = windowMediator.getMostRecentWindow(&quot;mail:messageWindow&quot;);</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+    if (messageWindow) {</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+      messageWindow.displayMessage(aMsgHdr, aViewWrapperToClone);</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+      return true;</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+    }</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+    return false;</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+  },</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+  /**</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+   * Open a new standalone message window with this header.</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+   *</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+   * @param aMsgHdr the message header to display</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+   */</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+  openMessageInNewWindow: function MailUtils_openMessageInNewWindow(aMsgHdr) {</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+    let windowWatcher = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+                          .getService(Ci.nsIWindowWatcher);</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+    windowWatcher.openWindow(null,</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+        &quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+        &quot;all,chrome,dialog=no,status,toolbar&quot;, aMsgHdr);</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+  }</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/mail/base/modules/Makefile.in</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,51 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+#</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+#</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+#</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+# License.</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+#</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+# The Original Code is mozilla.org code.</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+#</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+# Mozilla Messaging, Inc.</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+#</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+# Contributor(s):</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+#   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+#</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+#</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+DEPTH   = ../../..</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+topsrcdir = @top_srcdir@</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+srcdir    = @srcdir@</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+VPATH   = @srcdir@</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+EXTRA_JS_MODULES = \</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+  MailConsts.js \</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+  MailUtils.js \</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+  $(NULL)</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/components/nsMailDefaultHandler.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/components/nsMailDefaultHandler.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -16,16 +16,17 @@</span>
<a href="#l16.4"></a><span id="l16.4">  *</span>
<a href="#l16.5"></a><span id="l16.5">  * The Initial Developer of the Original Code is</span>
<a href="#l16.6"></a><span id="l16.6">  * Benjamin Smedberg &lt;benjamin@smedbergs.us&gt;</span>
<a href="#l16.7"></a><span id="l16.7">  *</span>
<a href="#l16.8"></a><span id="l16.8">  * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l16.9"></a><span id="l16.9">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l16.10"></a><span id="l16.10">  *</span>
<a href="#l16.11"></a><span id="l16.11">  * Contributor(s):</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l16.13"></a><span id="l16.13">  *</span>
<a href="#l16.14"></a><span id="l16.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l16.15"></a><span id="l16.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l16.16"></a><span id="l16.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l16.17"></a><span id="l16.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l16.18"></a><span id="l16.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l16.19"></a><span id="l16.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l16.20"></a><span id="l16.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -84,16 +85,34 @@ function resolveURIInternal(aCmdLine, aA</span>
<a href="#l16.22"></a><span id="l16.22">   }</span>
<a href="#l16.23"></a><span id="l16.23">   catch (e) {</span>
<a href="#l16.24"></a><span id="l16.24">     Components.utils.reportError(e);</span>
<a href="#l16.25"></a><span id="l16.25">   }</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27">   return uri;</span>
<a href="#l16.28"></a><span id="l16.28"> }</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+function handleIndexerResult(aFile) {</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+  // Do this here because xpcshell isn't too happy with this at startup</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+  Components.utils.import(&quot;resource://app/modules/MailUtils.js&quot;);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+  // Make sure the folder tree is initialized</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+  MailUtils.discoverFolders();</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+  // Use the search integration module to convert the indexer result into a</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+  // message header</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+  Components.utils.import(&quot;resource://app/modules/SearchIntegration.js&quot;);</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+  let msgHdr = SearchIntegration.handleResult(aFile);</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+  // If we found a message header, open it, otherwise throw an exception</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+  if (msgHdr)</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+    MailUtils.displayMessage(msgHdr);</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+  else</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+    throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+}</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+</span>
<a href="#l16.48"></a><span id="l16.48"> function mayOpenURI(uri)</span>
<a href="#l16.49"></a><span id="l16.49"> {</span>
<a href="#l16.50"></a><span id="l16.50">   var ext = Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l16.51"></a><span id="l16.51">     .getService(Components.interfaces.nsIExternalProtocolService);</span>
<a href="#l16.52"></a><span id="l16.52"> </span>
<a href="#l16.53"></a><span id="l16.53">   return ext.isExposedProtocol(uri.scheme);</span>
<a href="#l16.54"></a><span id="l16.54"> }</span>
<a href="#l16.55"></a><span id="l16.55"> </span>
<a href="#l16.56"></a><span id="l16.56" class="difflineat">@@ -264,16 +283,28 @@ var nsMailDefaultHandler = {</span>
<a href="#l16.57"></a><span id="l16.57">         dump(e);</span>
<a href="#l16.58"></a><span id="l16.58">       }</span>
<a href="#l16.59"></a><span id="l16.59">     }</span>
<a href="#l16.60"></a><span id="l16.60"> </span>
<a href="#l16.61"></a><span id="l16.61">     if (cmdLine.handleFlag(&quot;silent&quot;, false)) {</span>
<a href="#l16.62"></a><span id="l16.62">       cmdLine.preventDefault = true;</span>
<a href="#l16.63"></a><span id="l16.63">     }</span>
<a href="#l16.64"></a><span id="l16.64"> </span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+    if (cmdLine.handleFlag(&quot;options&quot;, false)) {</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+      // Open the options window</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+      var wwatch = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+                             .getService(nsIWindowWatcher);</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+      wwatch.openWindow(null,</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+          &quot;chrome://messenger/content/preferences/preferences.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+          &quot;chrome,dialog=no,all&quot;, null);</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+    }</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+    // The URI might be passed as the argument to the file parameter</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+    uri = cmdLine.handleFlagWithParam(&quot;file&quot;, false);</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+</span>
<a href="#l16.77"></a><span id="l16.77">     var count = cmdLine.length;</span>
<a href="#l16.78"></a><span id="l16.78">     if (count) {</span>
<a href="#l16.79"></a><span id="l16.79">       var i = 0;</span>
<a href="#l16.80"></a><span id="l16.80">       while (i &lt; count) {</span>
<a href="#l16.81"></a><span id="l16.81">         var curarg = cmdLine.getArgument(i);</span>
<a href="#l16.82"></a><span id="l16.82">         if (!curarg.match(/^-/))</span>
<a href="#l16.83"></a><span id="l16.83">           break;</span>
<a href="#l16.84"></a><span id="l16.84"> </span>
<a href="#l16.85"></a><span id="l16.85" class="difflineat">@@ -326,17 +357,62 @@ var nsMailDefaultHandler = {</span>
<a href="#l16.86"></a><span id="l16.86">         try {</span>
<a href="#l16.87"></a><span id="l16.87">           Components.classes[&quot;@mozilla.org/newsblog-feed-downloader;1&quot;]</span>
<a href="#l16.88"></a><span id="l16.88">                     .getService(Components.interfaces.nsINewsBlogFeedDownloader)</span>
<a href="#l16.89"></a><span id="l16.89">                     .subscribeToFeed(uri, null, null);</span>
<a href="#l16.90"></a><span id="l16.90">         }</span>
<a href="#l16.91"></a><span id="l16.91">         catch (e) {</span>
<a href="#l16.92"></a><span id="l16.92">           // If feed handling is not installed, do nothing</span>
<a href="#l16.93"></a><span id="l16.93">         }</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-      } else {</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+      }</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+      else if (/\.mozeml$/i.test(uri) || /\.wdseml$/i.test(uri)) {</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+        handleIndexerResult(cmdLine.resolveFile(uri));</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+        cmdLine.preventDefault = true;</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+      }</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+      else if (/\.eml$/i.test(uri)) {</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+        // Open this eml in a new message window</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+        let file = cmdLine.resolveFile(uri);</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+        // No point in trying to open a file if it doesn't exist or is empty</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+        if (file.exists() &amp;&amp; file.fileSize &gt; 0) {</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+          // Get the URL for this file</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+          let ios = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+                              .getService(Components.interfaces.nsIIOService);</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+          let fileURL = ios.newFileURI(file)</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+                           .QueryInterface(Components.interfaces.nsIFileURL);</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+          fileURL.query = &quot;?type=application/x-message-display&quot;;</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+          let wwatch = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+                                 .getService(nsIWindowWatcher);</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+          wwatch.openWindow(null,</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+                            &quot;chrome://messenger/content/messageWindow.xul&quot;,</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+                            &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+                            fileURL);</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+          cmdLine.preventDefault = true;</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+        }</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+        else {</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+          let bundle = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+                                 .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+                                 .createBundle(&quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+          let title, message;</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+          if (!file.exists()) {</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+            title = bundle.GetStringFromName(&quot;fileNotFoundTitle&quot;);</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+            message = bundle.formatStringFromName(&quot;fileNotFoundMsg&quot;, [file.path], 1);</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+          }</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+          else {</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+            // The file is empty</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+            title = bundle.GetStringFromName(&quot;fileEmptyTitle&quot;);</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+            message = bundle.formatStringFromName(&quot;fileEmptyMsg&quot;, [file.path], 1);</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+          }</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+          let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+                                        .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+          promptService.alert(null, title, message);</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+        }</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+      }</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+      else {</span>
<a href="#l16.141"></a><span id="l16.141">         openURI(cmdLine.resolveURI(uri));</span>
<a href="#l16.142"></a><span id="l16.142">         // XXX: add error-handling here! (error dialog, if nothing else)</span>
<a href="#l16.143"></a><span id="l16.143">       }</span>
<a href="#l16.144"></a><span id="l16.144">     } else {</span>
<a href="#l16.145"></a><span id="l16.145">       var wwatch = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l16.146"></a><span id="l16.146">                              .getService(nsIWindowWatcher);</span>
<a href="#l16.147"></a><span id="l16.147"> </span>
<a href="#l16.148"></a><span id="l16.148">       var argstring = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineat">@@ -371,17 +447,18 @@ var nsMailDefaultHandler = {</span>
<a href="#l16.150"></a><span id="l16.150">       var param = cmdLine.getArgument(actionFlagIdx + 1);</span>
<a href="#l16.151"></a><span id="l16.151">       if (cmdLine.length != actionFlagIdx + 2 ||</span>
<a href="#l16.152"></a><span id="l16.152">           /thunderbird.url.(mailto|news):/.test(param))</span>
<a href="#l16.153"></a><span id="l16.153">         throw NS_ERROR_ABORT;</span>
<a href="#l16.154"></a><span id="l16.154">       cmdLine.handleFlag(&quot;osint&quot;, false)</span>
<a href="#l16.155"></a><span id="l16.155">     }</span>
<a href="#l16.156"></a><span id="l16.156">   },</span>
<a href="#l16.157"></a><span id="l16.157"> </span>
<a href="#l16.158"></a><span id="l16.158" class="difflineminus">-  helpInfo : &quot;&quot;,</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+  helpInfo : &quot;  -options             Open the options dialog.\n&quot; +</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+             &quot;  -file                Open the specified email file.\n&quot;,</span>
<a href="#l16.161"></a><span id="l16.161"> </span>
<a href="#l16.162"></a><span id="l16.162">   /* nsIFactory */</span>
<a href="#l16.163"></a><span id="l16.163"> </span>
<a href="#l16.164"></a><span id="l16.164">   createInstance : function mdh_CI(outer, iid) {</span>
<a href="#l16.165"></a><span id="l16.165">     if (outer != null)</span>
<a href="#l16.166"></a><span id="l16.166">       throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l16.167"></a><span id="l16.167"> </span>
<a href="#l16.168"></a><span id="l16.168">     return this.QueryInterface(iid);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/components/preferences/advanced.xul</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/components/preferences/advanced.xul</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -94,17 +94,17 @@</span>
<a href="#l17.4"></a><span id="l17.4">       &lt;preference id=&quot;mail.showCondensedAddresses&quot; name=&quot;mail.showCondensedAddresses&quot; type=&quot;bool&quot;/&gt;</span>
<a href="#l17.5"></a><span id="l17.5">       &lt;preference id=&quot;mailnews.mark_message_read.auto&quot;</span>
<a href="#l17.6"></a><span id="l17.6">                   name=&quot;mailnews.mark_message_read.auto&quot; type=&quot;bool&quot;/&gt;</span>
<a href="#l17.7"></a><span id="l17.7">       &lt;preference id=&quot;mailnews.mark_message_read.delay&quot;</span>
<a href="#l17.8"></a><span id="l17.8">                   name=&quot;mailnews.mark_message_read.delay&quot; type=&quot;bool&quot;</span>
<a href="#l17.9"></a><span id="l17.9">                   onchange=&quot;gAdvancedPane.updateMarkAsReadTextbox(this.value);&quot;/&gt;</span>
<a href="#l17.10"></a><span id="l17.10">       &lt;preference id=&quot;mailnews.mark_message_read.delay.interval&quot;</span>
<a href="#l17.11"></a><span id="l17.11">                   name=&quot;mailnews.mark_message_read.delay.interval&quot; type=&quot;int&quot;/&gt;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-      &lt;preference id=&quot;mailnews.reuse_message_window&quot; name=&quot;mailnews.reuse_message_window&quot; type=&quot;bool&quot;/&gt;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+      &lt;preference id=&quot;mail.openMessageBehavior&quot; name=&quot;mail.openMessageBehavior&quot; type=&quot;int&quot;/&gt;</span>
<a href="#l17.14"></a><span id="l17.14">       &lt;preference id=&quot;mail.close_message_window.on_delete&quot; </span>
<a href="#l17.15"></a><span id="l17.15">                   name=&quot;mail.close_message_window.on_delete&quot; type=&quot;bool&quot;/&gt;</span>
<a href="#l17.16"></a><span id="l17.16">       &lt;!-- Network tab --&gt;</span>
<a href="#l17.17"></a><span id="l17.17">       &lt;preference id=&quot;mail.prompt_purge_threshhold&quot;          name=&quot;mail.prompt_purge_threshhold&quot;    type=&quot;bool&quot;/&gt;</span>
<a href="#l17.18"></a><span id="l17.18">       &lt;preference id=&quot;mail.purge_threshhold&quot;                 name=&quot;mail.purge_threshhold&quot;    type=&quot;int&quot;/&gt;</span>
<a href="#l17.19"></a><span id="l17.19">       &lt;preference id=&quot;browser.cache.disk.capacity&quot;</span>
<a href="#l17.20"></a><span id="l17.20">                   name=&quot;browser.cache.disk.capacity&quot; type=&quot;int&quot;/&gt;</span>
<a href="#l17.21"></a><span id="l17.21">       &lt;!-- Update tab --&gt;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -231,26 +231,28 @@</span>
<a href="#l17.23"></a><span id="l17.23">                   &lt;label id=&quot;secondsLabel&quot; value=&quot;&amp;secondsLabel.label;&quot;/&gt;</span>
<a href="#l17.24"></a><span id="l17.24">                 &lt;/hbox&gt;</span>
<a href="#l17.25"></a><span id="l17.25">               &lt;/radiogroup&gt;</span>
<a href="#l17.26"></a><span id="l17.26">             &lt;/vbox&gt;</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28">             &lt;vbox&gt;</span>
<a href="#l17.29"></a><span id="l17.29">               &lt;hbox&gt;</span>
<a href="#l17.30"></a><span id="l17.30">                 &lt;label value=&quot;&amp;openMsgIn.label;&quot;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-                       control=&quot;mailnewsDoubleClick2NewWindow&quot;/&gt;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+                       control=&quot;mailOpenMessageBehavior&quot;/&gt;</span>
<a href="#l17.33"></a><span id="l17.33">               &lt;/hbox&gt;</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35">               &lt;hbox&gt;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-                &lt;radiogroup id=&quot;mailnewsDoubleClick2NewWindow&quot; class=&quot;indent&quot;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-                            preference=&quot;mailnews.reuse_message_window&quot;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+                &lt;radiogroup id=&quot;mailOpenMessageBehavior&quot; class=&quot;indent&quot;</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+                            preference=&quot;mail.openMessageBehavior&quot;</span>
<a href="#l17.40"></a><span id="l17.40">                             orient=&quot;horizontal&quot;&gt;</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-                  &lt;radio id=&quot;new&quot; value=&quot;false&quot; label=&quot;&amp;reuseExpRadio0.label;&quot;</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+                  &lt;radio id=&quot;newTab&quot; value=&quot;2&quot; label=&quot;&amp;openMsgInNewTab.label;&quot;</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+                         accesskey=&quot;&amp;openMsgInNewTab.accesskey;&quot;/&gt;</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+                  &lt;radio id=&quot;newWindow&quot; value=&quot;0&quot; label=&quot;&amp;reuseExpRadio0.label;&quot;</span>
<a href="#l17.45"></a><span id="l17.45">                          accesskey=&quot;&amp;reuseExpRadio0.accesskey;&quot;/&gt;</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-                  &lt;radio id=&quot;existing&quot; value=&quot;true&quot;</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+                  &lt;radio id=&quot;existingWindow&quot; value=&quot;1&quot;</span>
<a href="#l17.48"></a><span id="l17.48">                          label=&quot;&amp;reuseExpRadio1.label;&quot;</span>
<a href="#l17.49"></a><span id="l17.49">                          accesskey=&quot;&amp;reuseExpRadio1.accesskey;&quot;/&gt;</span>
<a href="#l17.50"></a><span id="l17.50">                 &lt;/radiogroup&gt;</span>
<a href="#l17.51"></a><span id="l17.51">               &lt;/hbox&gt;</span>
<a href="#l17.52"></a><span id="l17.52">               &lt;hbox&gt;</span>
<a href="#l17.53"></a><span id="l17.53">                 &lt;checkbox id=&quot;closeMsgWindowOnDelete&quot;</span>
<a href="#l17.54"></a><span id="l17.54">                           label=&quot;&amp;closeMsgWindowOnDelete.label;&quot;</span>
<a href="#l17.55"></a><span id="l17.55">                           accesskey=&quot;&amp;closeMsgWindowOnDelete.accesskey;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/components/search/SpotlightIntegration.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/components/search/SpotlightIntegration.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -61,29 +61,53 @@ let SearchIntegration =</span>
<a href="#l18.4"></a><span id="l18.4">   get _profileDir()</span>
<a href="#l18.5"></a><span id="l18.5">   {</span>
<a href="#l18.6"></a><span id="l18.6">     delete this._profileDir;</span>
<a href="#l18.7"></a><span id="l18.7">     return this._profileDir = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l18.8"></a><span id="l18.8">                                 .getService(Ci.nsIProperties)</span>
<a href="#l18.9"></a><span id="l18.9">                                 .get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l18.10"></a><span id="l18.10">   },</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+  get _metadataDir()</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  {</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+    delete this._metadataDir;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+    let metadataDir = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+                        .getService(Ci.nsIProperties)</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+                        .get(&quot;Home&quot;, Ci.nsIFile);</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+    metadataDir.append(&quot;Library&quot;);</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+    metadataDir.append(&quot;Caches&quot;);</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+    metadataDir.append(&quot;Metadata&quot;);</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+    metadataDir.append(&quot;Thunderbird&quot;);</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+    return this._metadataDir = metadataDir;</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+  },</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+</span>
<a href="#l18.25"></a><span id="l18.25">   /// Spotlight won't index files in the profile dir, but will use ~/Library/Caches/Metadata</span>
<a href="#l18.26"></a><span id="l18.26">   _getSearchPathForFolder: function spotlight_get_search_path(aFolder)</span>
<a href="#l18.27"></a><span id="l18.27">   {</span>
<a href="#l18.28"></a><span id="l18.28">     // Swap the metadata dir for the profile dir prefix in the folder's path</span>
<a href="#l18.29"></a><span id="l18.29">     let folderPath = aFolder.filePath.path;</span>
<a href="#l18.30"></a><span id="l18.30">     let fixedPath = folderPath.replace(this._profileDir.path,</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-                                       &quot;~/Library/Caches/Metadata/Thunderbird&quot;);</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+                                       this._metadataDir.path);</span>
<a href="#l18.33"></a><span id="l18.33">     let searchPath = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l18.34"></a><span id="l18.34">                        .createInstance(Ci.nsILocalFile);</span>
<a href="#l18.35"></a><span id="l18.35">     searchPath.initWithPath(fixedPath);</span>
<a href="#l18.36"></a><span id="l18.36">     return searchPath;</span>
<a href="#l18.37"></a><span id="l18.37">   },</span>
<a href="#l18.38"></a><span id="l18.38"> </span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+  /// Replace ~/Library/Caches/Metadata with the profile directory, then convert</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+  _getFolderForSearchPath: function spotlight_get_folder_for_search_path(aPath)</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+  {</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+    let folderPath = aPath.path.replace(this._metadataDir.path,</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+                                        this._profileDir.path);</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+    let folderFile = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+                      .createInstance(Ci.nsILocalFile);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+    folderFile.initWithPath(folderPath);</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+    return MailUtils.getFolderForFileInProfile(folderFile);</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+  },</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+</span>
<a href="#l18.50"></a><span id="l18.50">   /**</span>
<a href="#l18.51"></a><span id="l18.51">    * These two functions won't do anything, as Spotlight integration is handled</span>
<a href="#l18.52"></a><span id="l18.52">    * using Info.plist files</span>
<a href="#l18.53"></a><span id="l18.53">    */</span>
<a href="#l18.54"></a><span id="l18.54">   register: function spotlight_register()</span>
<a href="#l18.55"></a><span id="l18.55">   {</span>
<a href="#l18.56"></a><span id="l18.56">     return true;</span>
<a href="#l18.57"></a><span id="l18.57">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/components/search/WinSearchIntegration.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/components/search/WinSearchIntegration.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -155,16 +155,22 @@ let SearchIntegration =</span>
<a href="#l19.4"></a><span id="l19.4">   },</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6">   /// Use the folder's path (i.e., in profile dir) as is</span>
<a href="#l19.7"></a><span id="l19.7">   _getSearchPathForFolder: function winsearch_get_search_path(aFolder)</span>
<a href="#l19.8"></a><span id="l19.8">   {</span>
<a href="#l19.9"></a><span id="l19.9">     return aFolder.filePath;</span>
<a href="#l19.10"></a><span id="l19.10">   },</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+  /// Use the search path as is</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  _getFolderForSearchPath: function winsearch_get_folder_for_search_path(aDir)</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+  {</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+    return MailUtils.getFolderForFileInProfile(aDir);</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+  },</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+</span>
<a href="#l19.18"></a><span id="l19.18">   _init: function winsearch_init()</span>
<a href="#l19.19"></a><span id="l19.19">   {</span>
<a href="#l19.20"></a><span id="l19.20">     this._initLogging();</span>
<a href="#l19.21"></a><span id="l19.21">     // We're currently only enabled on Vista and above</span>
<a href="#l19.22"></a><span id="l19.22">     let sysInfo = Cc[&quot;@mozilla.org/system-info;1&quot;]</span>
<a href="#l19.23"></a><span id="l19.23">                     .getService(Ci.nsIPropertyBag2);</span>
<a href="#l19.24"></a><span id="l19.24">     let windowsVersion = sysInfo.getProperty(&quot;version&quot;);</span>
<a href="#l19.25"></a><span id="l19.25">     if (parseFloat(windowsVersion) &lt; 6)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/components/search/content/searchCommon.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/components/search/content/searchCommon.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -50,16 +50,17 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #endif</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6"> const Cc = Components.classes;</span>
<a href="#l20.7"></a><span id="l20.7"> const Ci = Components.interfaces;</span>
<a href="#l20.8"></a><span id="l20.8"> const Cu = Components.utils;</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10"> Cu.import(&quot;resource://gre/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l20.11"></a><span id="l20.11"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+Cu.import(&quot;resource://app/modules/MailUtils.js&quot;);</span>
<a href="#l20.13"></a><span id="l20.13"> </span>
<a href="#l20.14"></a><span id="l20.14"> let SearchSupport =</span>
<a href="#l20.15"></a><span id="l20.15"> {</span>
<a href="#l20.16"></a><span id="l20.16">   /**</span>
<a href="#l20.17"></a><span id="l20.17">    * URI of last folder indexed. Kept in sync with the pref</span>
<a href="#l20.18"></a><span id="l20.18">    */</span>
<a href="#l20.19"></a><span id="l20.19">   __lastFolderIndexedUri: null,</span>
<a href="#l20.20"></a><span id="l20.20">   set _lastFolderIndexedUri(uri)</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineat">@@ -729,16 +730,40 @@ let SearchSupport =</span>
<a href="#l20.22"></a><span id="l20.22">       this._log.info(&quot;generating support file for id = &quot; + msgHdr.messageId);</span>
<a href="#l20.23"></a><span id="l20.23">       this._streamListener.startStreaming(msgHdr, reindexTime);</span>
<a href="#l20.24"></a><span id="l20.24">     }</span>
<a href="#l20.25"></a><span id="l20.25">     else</span>
<a href="#l20.26"></a><span id="l20.26">       this._log.info(&quot;queueing support file generation for id = &quot; +</span>
<a href="#l20.27"></a><span id="l20.27">                      msgHdr.messageId);</span>
<a href="#l20.28"></a><span id="l20.28">   },</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+  /**</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+   * Handle results from the command line. This method is the inverse of the</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+   * _getSupportFile method below.</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+   *</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+   * @param aFile the file passed in by the command line</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+   * @return the nsIMsgDBHdr corresponding to the file passed in</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+   */</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+  handleResult: function search_handle_result(aFile)</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+  {</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+    // The file path has two components -- the search path, which needs to be</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+    // converted into a folder, and the message ID.</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+    let searchPath = aFile.parent;</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+    // Strip off &quot;.mozmsgs&quot; from the end (8 characters)</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+    searchPath.leafName = searchPath.leafName.slice(0, -8);</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+    let folder = this._getFolderForSearchPath(searchPath);</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+    // Get rid of the file extension at the end (7 characters), and unescape</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+    let messageID = decodeURIComponent(aFile.leafName.slice(0, -7));</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+    // Look for the message ID in the folder</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+    return folder.msgDatabase.getMsgHdrForMessageID(messageID);</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+  },</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+</span>
<a href="#l20.54"></a><span id="l20.54">   _getSupportFile: function search_get_support_file(msgHdr)</span>
<a href="#l20.55"></a><span id="l20.55">   {</span>
<a href="#l20.56"></a><span id="l20.56">     let folder = msgHdr.folder;</span>
<a href="#l20.57"></a><span id="l20.57">     if (folder)</span>
<a href="#l20.58"></a><span id="l20.58">     {</span>
<a href="#l20.59"></a><span id="l20.59">       let messageId = encodeURIComponent(msgHdr.messageId);</span>
<a href="#l20.60"></a><span id="l20.60">       this._log.debug(&quot;encoded message id = &quot; + messageId);</span>
<a href="#l20.61"></a><span id="l20.61">       let file = this._getSearchPathForFolder(folder);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/installer/windows/packages-static</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/installer/windows/packages-static</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -78,16 +78,17 @@ bin\components\msgnews.xpt</span>
<a href="#l21.4"></a><span id="l21.4"> bin\components\msgsearch.xpt</span>
<a href="#l21.5"></a><span id="l21.5"> bin\components\import.xpt</span>
<a href="#l21.6"></a><span id="l21.6"> bin\components\impComm4xMail.xpt</span>
<a href="#l21.7"></a><span id="l21.7"> bin\components\mailview.xpt</span>
<a href="#l21.8"></a><span id="l21.8"> bin\components\mailprofilemigration.xpt</span>
<a href="#l21.9"></a><span id="l21.9"> bin\components\nsActivity.js</span>
<a href="#l21.10"></a><span id="l21.10"> bin\components\nsActivityManager.js</span>
<a href="#l21.11"></a><span id="l21.11"> bin\components\nsActivityManagerUI.js</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+bin\components\nsMailNewsCommandLineHandler.js</span>
<a href="#l21.13"></a><span id="l21.13"> bin\components\shellservice.xpt</span>
<a href="#l21.14"></a><span id="l21.14"> bin\components\xpcom_base.xpt</span>
<a href="#l21.15"></a><span id="l21.15"> bin\components\xpcom_system.xpt</span>
<a href="#l21.16"></a><span id="l21.16"> bin\components\xpcom_components.xpt</span>
<a href="#l21.17"></a><span id="l21.17"> bin\components\xpcom_ds.xpt</span>
<a href="#l21.18"></a><span id="l21.18"> bin\components\xpcom_io.xpt</span>
<a href="#l21.19"></a><span id="l21.19"> bin\components\xpcom_thread.xpt</span>
<a href="#l21.20"></a><span id="l21.20"> bin\components\xpcom_xpti.xpt</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -477,16 +477,20 @@ emptyTrashDontAsk=Don't ask me again.</span>
<a href="#l22.4"></a><span id="l22.4"> junkAnalysisPercentComplete=Junk analysis %S complete</span>
<a href="#l22.5"></a><span id="l22.5"> processingJunkMessages=Processing Junk Messages</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7"> # Messenger bootstrapping messages</span>
<a href="#l22.8"></a><span id="l22.8"> fileNotFoundTitle = File Not Found</span>
<a href="#l22.9"></a><span id="l22.9"> #LOCALIZATION NOTE(fileNotFoundMsg): %S is the filename</span>
<a href="#l22.10"></a><span id="l22.10"> fileNotFoundMsg = The file %S does not exist.</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+fileEmptyTitle = File Empty</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+#LOCALIZATION NOTE(fileEmptyMsg): %S is the filename</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+fileEmptyMsg = The file %S is empty.</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+</span>
<a href="#l22.16"></a><span id="l22.16"> # second person direct object pronoun; used in the collapsed header view if</span>
<a href="#l22.17"></a><span id="l22.17"> # the user is in the To or Cc field of a message</span>
<a href="#l22.18"></a><span id="l22.18"> headerFieldYou=You</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20"> # Shown when content tabs are being loaded.</span>
<a href="#l22.21"></a><span id="l22.21"> loadingTab=Loading…</span>
<a href="#l22.22"></a><span id="l22.22"> </span>
<a href="#l22.23"></a><span id="l22.23"> applyToCollapsedMsgsTitle=Confirm Delete of Messages in Collapsed Thread(s)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/preferences/advanced.dtd</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/preferences/advanced.dtd</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -34,16 +34,18 @@</span>
<a href="#l23.4"></a><span id="l23.4"> &lt;!ENTITY markAsReadNoDelay.accesskey   &quot;o&quot;&gt;</span>
<a href="#l23.5"></a><span id="l23.5"> &lt;!-- LOCALIZATION NOTE (markAsReadDelay.label): This will concatenate to</span>
<a href="#l23.6"></a><span id="l23.6">      &quot;After displaying for [___] seconds&quot;,</span>
<a href="#l23.7"></a><span id="l23.7">      using (markAsReadDelay.label) and a number (secondsLabel.label). --&gt;</span>
<a href="#l23.8"></a><span id="l23.8"> &lt;!ENTITY markAsReadDelay.label         &quot;After displaying for&quot;&gt;</span>
<a href="#l23.9"></a><span id="l23.9"> &lt;!ENTITY markAsReadDelay.accesskey     &quot;d&quot;&gt;</span>
<a href="#l23.10"></a><span id="l23.10"> &lt;!ENTITY secondsLabel.label            &quot;seconds&quot;&gt;</span>
<a href="#l23.11"></a><span id="l23.11"> &lt;!ENTITY openMsgIn.label               &quot;Open messages in:&quot;&gt;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+&lt;!ENTITY openMsgInNewTab.label         &quot;A new tab&quot;&gt;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+&lt;!ENTITY openMsgInNewTab.accesskey     &quot;t&quot;&gt;</span>
<a href="#l23.14"></a><span id="l23.14"> &lt;!ENTITY reuseExpRadio0.label          &quot;A new message window&quot;&gt;</span>
<a href="#l23.15"></a><span id="l23.15"> &lt;!ENTITY reuseExpRadio0.accesskey      &quot;n&quot;&gt;</span>
<a href="#l23.16"></a><span id="l23.16"> &lt;!ENTITY reuseExpRadio1.label          &quot;An existing message window&quot;&gt;</span>
<a href="#l23.17"></a><span id="l23.17"> &lt;!ENTITY reuseExpRadio1.accesskey      &quot;e&quot;&gt;</span>
<a href="#l23.18"></a><span id="l23.18"> &lt;!ENTITY closeMsgWindowOnDelete.label  &quot;Close message window on delete&quot;&gt;</span>
<a href="#l23.19"></a><span id="l23.19"> &lt;!ENTITY closeMsgWindowOnDelete.accesskey &quot;C&quot;&gt;</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21"> &lt;!-- Update --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -33,17 +33,19 @@</span>
<a href="#l24.4"></a><span id="l24.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l24.5"></a><span id="l24.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l24.6"></a><span id="l24.6">  *</span>
<a href="#l24.7"></a><span id="l24.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> /*</span>
<a href="#l24.10"></a><span id="l24.10">  * Test that deleting a message in a given tab or window properly updates both</span>
<a href="#l24.11"></a><span id="l24.11">  *  that tab/window as well as all other tabs/windows.  We also test that the</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">- *  message tab title updates appropriately through all of this.</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+ *  message tab title updates appropriately through all of this. We do all of</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+ *  this both for tabs that have ever been opened in the foreground, and tabs</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+ *  that haven't (and thus might have fake selections).</span>
<a href="#l24.16"></a><span id="l24.16">  */</span>
<a href="#l24.17"></a><span id="l24.17"> var MODULE_NAME = 'test-deletion-with-multiple-displays';</span>
<a href="#l24.18"></a><span id="l24.18"> </span>
<a href="#l24.19"></a><span id="l24.19"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l24.20"></a><span id="l24.20"> var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22"> var folder;</span>
<a href="#l24.23"></a><span id="l24.23"> </span>
<a href="#l24.24"></a><span id="l24.24" class="difflineat">@@ -56,17 +58,17 @@ function setupModule(module) {</span>
<a href="#l24.25"></a><span id="l24.25">   folder = create_folder(&quot;DeletionA&quot;);</span>
<a href="#l24.26"></a><span id="l24.26">   // we want exactly as many messages as we plan to delete, so that we can test</span>
<a href="#l24.27"></a><span id="l24.27">   //  that the message window and tabs close when they run out of things to</span>
<a href="#l24.28"></a><span id="l24.28">   //  to display.</span>
<a href="#l24.29"></a><span id="l24.29">   make_new_sets_in_folder(folder, [{count: 4}]);</span>
<a href="#l24.30"></a><span id="l24.30"> }</span>
<a href="#l24.31"></a><span id="l24.31"> </span>
<a href="#l24.32"></a><span id="l24.32"> </span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-var tabFolder, tabMessage, curMessage, nextMessage;</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+var tabFolder, tabMessage, tabMessageBackground, curMessage, nextMessage;</span>
<a href="#l24.35"></a><span id="l24.35"> </span>
<a href="#l24.36"></a><span id="l24.36"> /**</span>
<a href="#l24.37"></a><span id="l24.37">  * The message window controller.  Short names because controllers get used a</span>
<a href="#l24.38"></a><span id="l24.38">  *  lot.</span>
<a href="#l24.39"></a><span id="l24.39">  */</span>
<a href="#l24.40"></a><span id="l24.40"> var msgc;</span>
<a href="#l24.41"></a><span id="l24.41"> </span>
<a href="#l24.42"></a><span id="l24.42"> /**</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineat">@@ -81,16 +83,23 @@ function test_open_message_in_all_three_</span>
<a href="#l24.44"></a><span id="l24.44">   curMessage = select_click_row(0);</span>
<a href="#l24.45"></a><span id="l24.45">   assert_selected_and_displayed(curMessage);</span>
<a href="#l24.46"></a><span id="l24.46"> </span>
<a href="#l24.47"></a><span id="l24.47">   // - Open the tab with the message</span>
<a href="#l24.48"></a><span id="l24.48">   tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l24.49"></a><span id="l24.49">   assert_selected_and_displayed(curMessage);</span>
<a href="#l24.50"></a><span id="l24.50">   assert_tab_titled_from(tabMessage, curMessage);</span>
<a href="#l24.51"></a><span id="l24.51"> </span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+  // go back to the folder tab</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+  switch_tab(tabFolder);</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+  // - Open another tab with the message, this time in the background</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+  tabMessageBackground = open_selected_message_in_new_tab(true);</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+  assert_tab_titled_from(tabMessageBackground, curMessage);</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+</span>
<a href="#l24.59"></a><span id="l24.59">   // - Open the window with the message</span>
<a href="#l24.60"></a><span id="l24.60">   // need to go back to the folder tab.  (well, should.)</span>
<a href="#l24.61"></a><span id="l24.61">   switch_tab(tabFolder);</span>
<a href="#l24.62"></a><span id="l24.62">   msgc = open_selected_message_in_new_window();</span>
<a href="#l24.63"></a><span id="l24.63">   assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l24.64"></a><span id="l24.64"> }</span>
<a href="#l24.65"></a><span id="l24.65"> </span>
<a href="#l24.66"></a><span id="l24.66"> /**</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineat">@@ -110,32 +119,38 @@ function test_delete_in_folder_tab() {</span>
<a href="#l24.68"></a><span id="l24.68"> </span>
<a href="#l24.69"></a><span id="l24.69">   // - make sure the message tab updated its title even without us switching</span>
<a href="#l24.70"></a><span id="l24.70">   assert_tab_titled_from(tabMessage, curMessage);</span>
<a href="#l24.71"></a><span id="l24.71"> </span>
<a href="#l24.72"></a><span id="l24.72">   // - switch to the message tab, make sure he is now on the right guy</span>
<a href="#l24.73"></a><span id="l24.73">   switch_tab(tabMessage);</span>
<a href="#l24.74"></a><span id="l24.74">   assert_selected_and_displayed(curMessage);</span>
<a href="#l24.75"></a><span id="l24.75"> </span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+  // - make sure the background message tab updated its title</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+  assert_tab_titled_from(tabMessageBackground, curMessage);</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+</span>
<a href="#l24.79"></a><span id="l24.79">   // - check the window</span>
<a href="#l24.80"></a><span id="l24.80">   assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l24.81"></a><span id="l24.81"> }</span>
<a href="#l24.82"></a><span id="l24.82"> </span>
<a href="#l24.83"></a><span id="l24.83"> /**</span>
<a href="#l24.84"></a><span id="l24.84">  * Perform a deletion from the message tab, verify the others update correctly</span>
<a href="#l24.85"></a><span id="l24.85">  *  (advancing to the next message).</span>
<a href="#l24.86"></a><span id="l24.86">  */</span>
<a href="#l24.87"></a><span id="l24.87"> function test_delete_in_message_tab() {</span>
<a href="#l24.88"></a><span id="l24.88">   // (we're still on the message tab, and nextMessage is the guy we want to see</span>
<a href="#l24.89"></a><span id="l24.89">   //  once the delete completes.)</span>
<a href="#l24.90"></a><span id="l24.90">   press_delete();</span>
<a href="#l24.91"></a><span id="l24.91">   curMessage = nextMessage;</span>
<a href="#l24.92"></a><span id="l24.92">   assert_selected_and_displayed(curMessage);</span>
<a href="#l24.93"></a><span id="l24.93">   assert_tab_titled_from(tabMessage, curMessage);</span>
<a href="#l24.94"></a><span id="l24.94"> </span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+  // - check the background message tab</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+  assert_tab_titled_from(tabMessageBackground, curMessage);</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+</span>
<a href="#l24.98"></a><span id="l24.98">   // - switch to the folder tab and make sure he is on the right guy and at 0</span>
<a href="#l24.99"></a><span id="l24.99">   switch_tab(tabFolder);</span>
<a href="#l24.100"></a><span id="l24.100">   assert_selected_and_displayed(curMessage);</span>
<a href="#l24.101"></a><span id="l24.101">   assert_selected_and_displayed(0);</span>
<a href="#l24.102"></a><span id="l24.102">   // figure out the next guy...</span>
<a href="#l24.103"></a><span id="l24.103">   nextMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l24.104"></a><span id="l24.104">   if (!nextMessage)</span>
<a href="#l24.105"></a><span id="l24.105">     throw new Error(&quot;We ran out of messages early?&quot;);</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineat">@@ -157,28 +172,28 @@ function test_delete_in_message_window()</span>
<a href="#l24.107"></a><span id="l24.107">   // - verify in the folder tab (we're still on this tab)</span>
<a href="#l24.108"></a><span id="l24.108">   assert_selected_and_displayed(curMessage);</span>
<a href="#l24.109"></a><span id="l24.109">   assert_selected_and_displayed(0);</span>
<a href="#l24.110"></a><span id="l24.110"> </span>
<a href="#l24.111"></a><span id="l24.111">   // - verify in the message tab</span>
<a href="#l24.112"></a><span id="l24.112">   switch_tab(tabMessage);</span>
<a href="#l24.113"></a><span id="l24.113">   assert_selected_and_displayed(curMessage);</span>
<a href="#l24.114"></a><span id="l24.114">   assert_tab_titled_from(tabMessage, curMessage);</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+  // - verify in the background message tab</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineplus">+  assert_tab_titled_from(tabMessageBackground, curMessage);</span>
<a href="#l24.118"></a><span id="l24.118"> }</span>
<a href="#l24.119"></a><span id="l24.119"> </span>
<a href="#l24.120"></a><span id="l24.120"> /**</span>
<a href="#l24.121"></a><span id="l24.121">  * Delete the last message in that folder, which should close all message</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineminus">- *  displays.  For comprehensiveness, first open an additional message tab</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineminus">- *  of the message so that we can test foreground and background closing at the</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineminus">- *  same time.</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineplus">+ *  displays.</span>
<a href="#l24.126"></a><span id="l24.126">  */</span>
<a href="#l24.127"></a><span id="l24.127"> function test_delete_last_message_closes_message_displays() {</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineminus">-  // - open the additional message tab</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineminus">-  switch_tab(tabFolder);</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineminus">-  let tabMessage2 = open_selected_message_in_new_tab();</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineplus">+  // - since we have both foreground and background message tabs, we don't need</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineplus">+  // to open yet another tab to test</span>
<a href="#l24.133"></a><span id="l24.133"> </span>
<a href="#l24.134"></a><span id="l24.134">   // - prep for the message window disappearing</span>
<a href="#l24.135"></a><span id="l24.135">   plan_for_window_close(msgc);</span>
<a href="#l24.136"></a><span id="l24.136"> </span>
<a href="#l24.137"></a><span id="l24.137">   // - let's arbitrarily perform the deletion on this message tab</span>
<a href="#l24.138"></a><span id="l24.138">   press_delete();</span>
<a href="#l24.139"></a><span id="l24.139"> </span>
<a href="#l24.140"></a><span id="l24.140">   // - the message window should have gone away...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-window.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-window.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -84,9 +84,9 @@ function test_navigate_to_next_message()</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5"> /**</span>
<a href="#l25.6"></a><span id="l25.6">  * Close the window by hitting escape.</span>
<a href="#l25.7"></a><span id="l25.7">  */</span>
<a href="#l25.8"></a><span id="l25.8"> function test_close_message_window() {</span>
<a href="#l25.9"></a><span id="l25.9">   plan_for_window_close(msgc);</span>
<a href="#l25.10"></a><span id="l25.10">   msgc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l25.11"></a><span id="l25.11">   wait_for_window_close(msgc);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-}</span>
<a href="#l25.13"></a><span id="l25.13">\ No newline at end of file</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-opening-messages.js</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,181 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+ *</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+ *</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+ * License.</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+ *</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+ *</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineplus">+ *</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+ *</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+ *</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineplus">+</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineplus">+/*</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineplus">+ * Test that we open single and multiple messages from the thread pane</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+ * according to the mail.openMessageBehavior preference, and that we have the</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineplus">+ * correct message headers displayed in whatever we open.</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineplus">+ *</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineplus">+ * Currently tested:</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+ * - opening single and multiple messages in tabs</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+ * - opening a single message in a window. (Multiple messages require a fair</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineplus">+ *   amount of additional work and are hard to test. We're also assuming here</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineplus">+ *   that multiple messages opened in windows are just the same function called</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+ *   repeatedly.)</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineplus">+ * - reusing an existing window to show another message</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+ */</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineplus">+var MODULE_NAME = 'test-opening-messages';</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineplus">+</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineplus">+// One folder's enough</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+var folder = null;</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineplus">+</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineplus">+// Number of messages to open for multi-message tests</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+const NUM_MESSAGES_TO_OPEN = 5;</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineplus">+</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+var setupModule = function (module) {</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineplus">+</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+  folder = create_folder(&quot;OpeningMessagesA&quot;);</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: 10}]);</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+};</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineplus">+/**</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineplus">+ * Test opening a single message in a new tab.</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineplus">+ */</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineplus">+function test_open_single_message_in_tab() {</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineplus">+  set_open_message_behavior(&quot;NEW_TAB&quot;);</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineplus">+  let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineplus">+  let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineplus">+  // Select one message</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineplus">+  let msgHdr = select_click_row(1);</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineplus">+  // Open it</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+  open_selected_message();</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineplus">+  // Check that the tab count has increased by 1</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineplus">+  assert_number_of_tabs_open(preCount + 1);</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineplus">+  // Check that the currently displayed tab is a message tab (i.e. our newly</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineplus">+  // opened tab is in the foreground)</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineplus">+  assert_tab_mode_name(null, &quot;message&quot;);</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineplus">+  // Check that the message header displayed is the right one</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineplus">+  assert_selected_and_displayed(msgHdr);</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineplus">+  // Clean up, close the tab</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineplus">+  close_tab(mc.tabmail.currentTabInfo);</span>
<a href="#l26.97"></a><span id="l26.97" class="difflineplus">+  switch_tab(folderTab);</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineplus">+  reset_open_message_behavior();</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineplus">+}</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineplus">+</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineplus">+/**</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineplus">+ * Test opening multiple messages in new tabs.</span>
<a href="#l26.103"></a><span id="l26.103" class="difflineplus">+ */</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineplus">+function test_open_multiple_messages_in_tabs() {</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineplus">+  set_open_message_behavior(&quot;NEW_TAB&quot;);</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineplus">+  let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineplus">+  let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineplus">+</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineplus">+  // Select a bunch of messages</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineplus">+  select_click_row(1);</span>
<a href="#l26.112"></a><span id="l26.112" class="difflineplus">+  let selectedMessages = select_shift_click_row(NUM_MESSAGES_TO_OPEN);</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineplus">+  // Open them</span>
<a href="#l26.114"></a><span id="l26.114" class="difflineplus">+  open_selected_messages();</span>
<a href="#l26.115"></a><span id="l26.115" class="difflineplus">+  // Check that the tab count has increased by the correct number</span>
<a href="#l26.116"></a><span id="l26.116" class="difflineplus">+  assert_number_of_tabs_open(preCount + NUM_MESSAGES_TO_OPEN);</span>
<a href="#l26.117"></a><span id="l26.117" class="difflineplus">+  // Check that the currently displayed tab is a message tab (i.e. one of our</span>
<a href="#l26.118"></a><span id="l26.118" class="difflineplus">+  // newly opened tabs is in the foreground)</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineplus">+  assert_tab_mode_name(null, &quot;message&quot;);</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineplus">+</span>
<a href="#l26.121"></a><span id="l26.121" class="difflineplus">+  // Now check whether each of the NUM_MESSAGES_TO_OPEN tabs has the correct</span>
<a href="#l26.122"></a><span id="l26.122" class="difflineplus">+  // title</span>
<a href="#l26.123"></a><span id="l26.123" class="difflineplus">+  for (let i = 0; i &lt; NUM_MESSAGES_TO_OPEN; i++)</span>
<a href="#l26.124"></a><span id="l26.124" class="difflineplus">+    assert_tab_titled_from(mc.tabmail.tabInfo[preCount + i],</span>
<a href="#l26.125"></a><span id="l26.125" class="difflineplus">+                           selectedMessages[i]);</span>
<a href="#l26.126"></a><span id="l26.126" class="difflineplus">+</span>
<a href="#l26.127"></a><span id="l26.127" class="difflineplus">+  // Check whether each tab has the correct message, then close it to load the</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineplus">+  // previous tab.</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineplus">+  for (let i = 0; i &lt; NUM_MESSAGES_TO_OPEN; i++) {</span>
<a href="#l26.130"></a><span id="l26.130" class="difflineplus">+    assert_selected_and_displayed(selectedMessages.pop());</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineplus">+    close_tab(mc.tabmail.currentTabInfo);</span>
<a href="#l26.132"></a><span id="l26.132" class="difflineplus">+  }</span>
<a href="#l26.133"></a><span id="l26.133" class="difflineplus">+  switch_tab(folderTab);</span>
<a href="#l26.134"></a><span id="l26.134" class="difflineplus">+  reset_open_message_behavior();</span>
<a href="#l26.135"></a><span id="l26.135" class="difflineplus">+}</span>
<a href="#l26.136"></a><span id="l26.136" class="difflineplus">+</span>
<a href="#l26.137"></a><span id="l26.137" class="difflineplus">+/**</span>
<a href="#l26.138"></a><span id="l26.138" class="difflineplus">+ * Test opening a message in a new window.</span>
<a href="#l26.139"></a><span id="l26.139" class="difflineplus">+ */</span>
<a href="#l26.140"></a><span id="l26.140" class="difflineplus">+function test_open_message_in_new_window() {</span>
<a href="#l26.141"></a><span id="l26.141" class="difflineplus">+  set_open_message_behavior(&quot;NEW_WINDOW&quot;);</span>
<a href="#l26.142"></a><span id="l26.142" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l26.143"></a><span id="l26.143" class="difflineplus">+</span>
<a href="#l26.144"></a><span id="l26.144" class="difflineplus">+  // Select a message</span>
<a href="#l26.145"></a><span id="l26.145" class="difflineplus">+  let msgHdr = select_click_row(1);</span>
<a href="#l26.146"></a><span id="l26.146" class="difflineplus">+  </span>
<a href="#l26.147"></a><span id="l26.147" class="difflineplus">+  plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l26.148"></a><span id="l26.148" class="difflineplus">+  // Open it</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineplus">+  open_selected_message();</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineplus">+  let msgc = wait_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l26.151"></a><span id="l26.151" class="difflineplus">+  wait_for_message_display_completion(msgc, true);</span>
<a href="#l26.152"></a><span id="l26.152" class="difflineplus">+</span>
<a href="#l26.153"></a><span id="l26.153" class="difflineplus">+  assert_selected_and_displayed(msgc, msgHdr);</span>
<a href="#l26.154"></a><span id="l26.154" class="difflineplus">+  // Clean up, close the window</span>
<a href="#l26.155"></a><span id="l26.155" class="difflineplus">+  close_message_window(msgc);</span>
<a href="#l26.156"></a><span id="l26.156" class="difflineplus">+  reset_open_message_behavior();</span>
<a href="#l26.157"></a><span id="l26.157" class="difflineplus">+}</span>
<a href="#l26.158"></a><span id="l26.158" class="difflineplus">+</span>
<a href="#l26.159"></a><span id="l26.159" class="difflineplus">+/**</span>
<a href="#l26.160"></a><span id="l26.160" class="difflineplus">+ * Test reusing an existing window to open a new message.</span>
<a href="#l26.161"></a><span id="l26.161" class="difflineplus">+ */</span>
<a href="#l26.162"></a><span id="l26.162" class="difflineplus">+function test_open_message_in_existing_window() {</span>
<a href="#l26.163"></a><span id="l26.163" class="difflineplus">+  set_open_message_behavior(&quot;EXISTING_WINDOW&quot;);</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineplus">+</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineplus">+  // Open up a window</span>
<a href="#l26.167"></a><span id="l26.167" class="difflineplus">+  select_click_row(1);</span>
<a href="#l26.168"></a><span id="l26.168" class="difflineplus">+  plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l26.169"></a><span id="l26.169" class="difflineplus">+  open_selected_message();</span>
<a href="#l26.170"></a><span id="l26.170" class="difflineplus">+  let msgc = wait_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l26.171"></a><span id="l26.171" class="difflineplus">+  wait_for_message_display_completion(msgc, true);</span>
<a href="#l26.172"></a><span id="l26.172" class="difflineplus">+</span>
<a href="#l26.173"></a><span id="l26.173" class="difflineplus">+  // Select another message and open it</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineplus">+  let msgHdr = select_click_row(2);</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineplus">+  open_selected_message();</span>
<a href="#l26.176"></a><span id="l26.176" class="difflineplus">+  // We don't need to pass true here, as open_selected_message should have</span>
<a href="#l26.177"></a><span id="l26.177" class="difflineplus">+  // started off the load before returning.</span>
<a href="#l26.178"></a><span id="l26.178" class="difflineplus">+  wait_for_message_display_completion(msgc);</span>
<a href="#l26.179"></a><span id="l26.179" class="difflineplus">+</span>
<a href="#l26.180"></a><span id="l26.180" class="difflineplus">+  // Check if our old window displays the message</span>
<a href="#l26.181"></a><span id="l26.181" class="difflineplus">+  assert_selected_and_displayed(msgc, msgHdr);</span>
<a href="#l26.182"></a><span id="l26.182" class="difflineplus">+  // Clean up, close the window</span>
<a href="#l26.183"></a><span id="l26.183" class="difflineplus">+  close_message_window(msgc);</span>
<a href="#l26.184"></a><span id="l26.184" class="difflineplus">+  reset_open_message_behavior();</span>
<a href="#l26.185"></a><span id="l26.185" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-right-click-middle-click.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-right-click-middle-click.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -144,104 +144,161 @@ function test_right_click_on_existing_mu</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5">   close_popup();</span>
<a href="#l27.6"></a><span id="l27.6">   assert_selected_and_displayed([3, 6]);</span>
<a href="#l27.7"></a><span id="l27.7"> }</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9"> /**</span>
<a href="#l27.10"></a><span id="l27.10">  * Middle clicking should open a message in a tab, but not affect our selection.</span>
<a href="#l27.11"></a><span id="l27.11">  */</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-function test_middle_click_with_nothing_selected() {</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+function _middle_click_with_nothing_selected_helper(aBackground) {</span>
<a href="#l27.14"></a><span id="l27.14">   be_in_folder(folder);</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16">   select_none();</span>
<a href="#l27.17"></a><span id="l27.17">   assert_nothing_selected();</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+  let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l27.20"></a><span id="l27.20">   let [tabMessage, curMessage] = middle_click_on_row(1);</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-  // as of immediately right now, the tab opens in the foreground, but soon</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-  //  it will open in the background, so prepare the test for that...</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-  switch_tab(tabMessage);</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+  if (aBackground) {</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+    // Make sure we haven't switched to the new tab.</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+    assert_selected_tab(folderTab);</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+    // Now switch to the new tab and check</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+    switch_tab(tabMessage);</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+  }</span>
<a href="#l27.30"></a><span id="l27.30">   assert_selected_and_displayed(curMessage);</span>
<a href="#l27.31"></a><span id="l27.31">   close_tab(tabMessage);</span>
<a href="#l27.32"></a><span id="l27.32"> </span>
<a href="#l27.33"></a><span id="l27.33">   assert_nothing_selected();</span>
<a href="#l27.34"></a><span id="l27.34"> }</span>
<a href="#l27.35"></a><span id="l27.35"> </span>
<a href="#l27.36"></a><span id="l27.36"> /**</span>
<a href="#l27.37"></a><span id="l27.37">  * One-thing selected, middle-click on something else.</span>
<a href="#l27.38"></a><span id="l27.38">  */</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineminus">-function test_middle_click_with_one_thing_selected() {</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+function _middle_click_with_one_thing_selected_helper(aBackground) {</span>
<a href="#l27.41"></a><span id="l27.41">   be_in_folder(folder);</span>
<a href="#l27.42"></a><span id="l27.42"> </span>
<a href="#l27.43"></a><span id="l27.43">   select_click_row(0);</span>
<a href="#l27.44"></a><span id="l27.44">   assert_selected_and_displayed(0);</span>
<a href="#l27.45"></a><span id="l27.45"> </span>
<a href="#l27.46"></a><span id="l27.46" class="difflineplus">+  let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l27.47"></a><span id="l27.47">   let [tabMessage, curMessage] = middle_click_on_row(1);</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-  switch_tab(tabMessage);</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineplus">+  if (aBackground) {</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+    // Make sure we haven't switched to the new tab.</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+    assert_selected_tab(folderTab);</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+    // Now switch to the new tab and check</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+    switch_tab(tabMessage);</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+  }</span>
<a href="#l27.55"></a><span id="l27.55">   assert_selected_and_displayed(curMessage);</span>
<a href="#l27.56"></a><span id="l27.56">   close_tab(tabMessage);</span>
<a href="#l27.57"></a><span id="l27.57"> </span>
<a href="#l27.58"></a><span id="l27.58">   assert_selected_and_displayed(0);</span>
<a href="#l27.59"></a><span id="l27.59"> }</span>
<a href="#l27.60"></a><span id="l27.60"> </span>
<a href="#l27.61"></a><span id="l27.61"> /**</span>
<a href="#l27.62"></a><span id="l27.62">  * Many things selected, middle-click on something that is not in that</span>
<a href="#l27.63"></a><span id="l27.63">  *  selection.</span>
<a href="#l27.64"></a><span id="l27.64">  */</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineminus">-function test_middle_click_with_many_things_selected() {</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+function _middle_click_with_many_things_selected_helper(aBackground) {</span>
<a href="#l27.67"></a><span id="l27.67">   be_in_folder(folder);</span>
<a href="#l27.68"></a><span id="l27.68"> </span>
<a href="#l27.69"></a><span id="l27.69">   select_click_row(0);</span>
<a href="#l27.70"></a><span id="l27.70">   select_shift_click_row(5);</span>
<a href="#l27.71"></a><span id="l27.71">   assert_selected_and_displayed([0, 5]);</span>
<a href="#l27.72"></a><span id="l27.72"> </span>
<a href="#l27.73"></a><span id="l27.73" class="difflineplus">+  let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l27.74"></a><span id="l27.74">   let [tabMessage, curMessage] = middle_click_on_row(1);</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineminus">-  switch_tab(tabMessage);</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineplus">+  if (aBackground) {</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineplus">+    // Make sure we haven't switched to the new tab.</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineplus">+    assert_selected_tab(folderTab);</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineplus">+    // Now switch to the new tab and check</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineplus">+    switch_tab(tabMessage);</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineplus">+  }</span>
<a href="#l27.82"></a><span id="l27.82">   assert_selected_and_displayed(curMessage);</span>
<a href="#l27.83"></a><span id="l27.83">   close_tab(tabMessage);</span>
<a href="#l27.84"></a><span id="l27.84"> </span>
<a href="#l27.85"></a><span id="l27.85">   assert_selected_and_displayed([0, 5]);</span>
<a href="#l27.86"></a><span id="l27.86"> }</span>
<a href="#l27.87"></a><span id="l27.87"> </span>
<a href="#l27.88"></a><span id="l27.88"> /**</span>
<a href="#l27.89"></a><span id="l27.89">  * One thing selected, middle-click on that.</span>
<a href="#l27.90"></a><span id="l27.90">  */</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineminus">-function test_middle_click_on_existing_single_selection() {</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineplus">+function _middle_click_on_existing_single_selection_helper(aBackground) {</span>
<a href="#l27.93"></a><span id="l27.93">   be_in_folder(folder);</span>
<a href="#l27.94"></a><span id="l27.94"> </span>
<a href="#l27.95"></a><span id="l27.95">   select_click_row(3);</span>
<a href="#l27.96"></a><span id="l27.96">   assert_selected_and_displayed(3);</span>
<a href="#l27.97"></a><span id="l27.97"> </span>
<a href="#l27.98"></a><span id="l27.98" class="difflineplus">+  let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l27.99"></a><span id="l27.99">   let [tabMessage, curMessage] = middle_click_on_row(3);</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-  switch_tab(tabMessage);</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineplus">+  if (aBackground) {</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineplus">+    // Make sure we haven't switched to the new tab.</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineplus">+    assert_selected_tab(folderTab);</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineplus">+    // Now switch to the new tab and check</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineplus">+    switch_tab(tabMessage);</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineplus">+  }</span>
<a href="#l27.107"></a><span id="l27.107">   assert_selected_and_displayed(curMessage);</span>
<a href="#l27.108"></a><span id="l27.108">   close_tab(tabMessage);</span>
<a href="#l27.109"></a><span id="l27.109"> </span>
<a href="#l27.110"></a><span id="l27.110">   assert_selected_and_displayed(3);</span>
<a href="#l27.111"></a><span id="l27.111"> }</span>
<a href="#l27.112"></a><span id="l27.112"> </span>
<a href="#l27.113"></a><span id="l27.113"> /**</span>
<a href="#l27.114"></a><span id="l27.114">  * Many things selected, right-click somewhere in the selection.</span>
<a href="#l27.115"></a><span id="l27.115">  */</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineminus">-function test_middle_click_on_existing_multi_selection() {</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineplus">+function _middle_click_on_existing_multi_selection_helper(aBackground) {</span>
<a href="#l27.118"></a><span id="l27.118">   be_in_folder(folder);</span>
<a href="#l27.119"></a><span id="l27.119"> </span>
<a href="#l27.120"></a><span id="l27.120">   select_click_row(3);</span>
<a href="#l27.121"></a><span id="l27.121">   select_shift_click_row(6);</span>
<a href="#l27.122"></a><span id="l27.122">   assert_selected_and_displayed([3, 6]);</span>
<a href="#l27.123"></a><span id="l27.123"> </span>
<a href="#l27.124"></a><span id="l27.124" class="difflineplus">+  let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l27.125"></a><span id="l27.125">   let [tabMessage, curMessage] = middle_click_on_row(5);</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineminus">-  switch_tab(tabMessage);</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineplus">+  if (aBackground) {</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineplus">+    // Make sure we haven't switched to the new tab.</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineplus">+    assert_selected_tab(folderTab);</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineplus">+    // Now switch to the new tab and check</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineplus">+    switch_tab(tabMessage);</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineplus">+  }</span>
<a href="#l27.133"></a><span id="l27.133">   assert_selected_and_displayed(curMessage);</span>
<a href="#l27.134"></a><span id="l27.134">   close_tab(tabMessage);</span>
<a href="#l27.135"></a><span id="l27.135"> </span>
<a href="#l27.136"></a><span id="l27.136">   assert_selected_and_displayed([3, 6]);</span>
<a href="#l27.137"></a><span id="l27.137"> }</span>
<a href="#l27.138"></a><span id="l27.138"> </span>
<a href="#l27.139"></a><span id="l27.139"> /**</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineplus">+ * Generate background and foreground tests for each middle click test.</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineplus">+ *</span>
<a href="#l27.142"></a><span id="l27.142" class="difflineplus">+ * @param aTests an array of test names</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineplus">+ */</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineplus">+function _generate_background_foreground_tests(aTests) {</span>
<a href="#l27.145"></a><span id="l27.145" class="difflineplus">+  let self = this;</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineplus">+  for each (let [, test] in Iterator(aTests)) {</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineplus">+    let helperFunc = this[&quot;_&quot; + test + &quot;_helper&quot;];</span>
<a href="#l27.148"></a><span id="l27.148" class="difflineplus">+    this[&quot;test_&quot; + test + &quot;_background&quot;] = function() {</span>
<a href="#l27.149"></a><span id="l27.149" class="difflineplus">+      set_context_menu_background_tabs(true);</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineplus">+      helperFunc.apply(self, [true]);</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineplus">+      reset_context_menu_background_tabs();</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineplus">+    };</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineplus">+    this[&quot;test_&quot; + test + &quot;_foreground&quot;] = function() {</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineplus">+      set_context_menu_background_tabs(false);</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineplus">+      helperFunc.apply(self, [false]);</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineplus">+      reset_context_menu_background_tabs();</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineplus">+    };</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineplus">+  }</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineplus">+}</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineplus">+</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineplus">+_generate_background_foreground_tests([</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineplus">+  &quot;middle_click_with_nothing_selected&quot;,</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineplus">+  &quot;middle_click_with_one_thing_selected&quot;,</span>
<a href="#l27.164"></a><span id="l27.164" class="difflineplus">+  &quot;middle_click_with_many_things_selected&quot;,</span>
<a href="#l27.165"></a><span id="l27.165" class="difflineplus">+  &quot;middle_click_on_existing_single_selection&quot;,</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineplus">+  &quot;middle_click_on_existing_multi_selection&quot;</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineplus">+]);</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineplus">+</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineplus">+/**</span>
<a href="#l27.170"></a><span id="l27.170">  * Right-click on something and delete it, having no selection previously.</span>
<a href="#l27.171"></a><span id="l27.171">  */</span>
<a href="#l27.172"></a><span id="l27.172"> function test_right_click_deletion_nothing_selected() {</span>
<a href="#l27.173"></a><span id="l27.173">   be_in_folder(folder);</span>
<a href="#l27.174"></a><span id="l27.174"> </span>
<a href="#l27.175"></a><span id="l27.175">   select_none();</span>
<a href="#l27.176"></a><span id="l27.176">   assert_selected_and_displayed();</span>
<a href="#l27.177"></a><span id="l27.177"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -54,27 +54,27 @@ Cu.import('resource://mozmill/stdlib/os.</span>
<a href="#l28.4"></a><span id="l28.4"> </span>
<a href="#l28.5"></a><span id="l28.5"> const MODULE_NAME = 'folder-display-helpers';</span>
<a href="#l28.6"></a><span id="l28.6"> </span>
<a href="#l28.7"></a><span id="l28.7"> const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l28.8"></a><span id="l28.8"> // we need window-helpers for augment_controller</span>
<a href="#l28.9"></a><span id="l28.9"> const MODULES_REQUIRES = ['window-helpers'];</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11"> const nsMsgViewIndex_None = 0xffffffff;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+Cu.import('resource://app/modules/MailConsts.js');</span>
<a href="#l28.14"></a><span id="l28.14"> </span>
<a href="#l28.15"></a><span id="l28.15"> const DO_NOT_EXPORT = {</span>
<a href="#l28.16"></a><span id="l28.16">   // magic globals</span>
<a href="#l28.17"></a><span id="l28.17">   MODULE_NAME: true, DO_NOT_EXPORT: true,</span>
<a href="#l28.18"></a><span id="l28.18">   // imported modules</span>
<a href="#l28.19"></a><span id="l28.19">   elib: true, mozmill: true, controller: true, frame: true, os: true,</span>
<a href="#l28.20"></a><span id="l28.20">   // convenience constants</span>
<a href="#l28.21"></a><span id="l28.21">   Ci: true, Cc: true, Cu: true, Cr: true,</span>
<a href="#l28.22"></a><span id="l28.22">   // useful constants</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-  nsMsgViewIndex_None: true,</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+  nsMsgViewIndex_None: true, MailConsts: true,</span>
<a href="#l28.25"></a><span id="l28.25">   // internal setup functions</span>
<a href="#l28.26"></a><span id="l28.26">   setupModule: true, setupAccountStuff: true,</span>
<a href="#l28.27"></a><span id="l28.27">   // internal setup flags</span>
<a href="#l28.28"></a><span id="l28.28">   initialized: false,</span>
<a href="#l28.29"></a><span id="l28.29">   // other libraries we use</span>
<a href="#l28.30"></a><span id="l28.30">   windowHelper: true</span>
<a href="#l28.31"></a><span id="l28.31"> };</span>
<a href="#l28.32"></a><span id="l28.32"> </span>
<a href="#l28.33"></a><span id="l28.33" class="difflineat">@@ -237,43 +237,64 @@ function be_in_folder(aFolder) {</span>
<a href="#l28.34"></a><span id="l28.34">  * Create a new tab displaying a folder, making that tab the current tab.</span>
<a href="#l28.35"></a><span id="l28.35">  *</span>
<a href="#l28.36"></a><span id="l28.36">  * @return The tab info of the current tab (a more persistent identifier for</span>
<a href="#l28.37"></a><span id="l28.37">  *     tabs than the index, which will change as tabs open/close).</span>
<a href="#l28.38"></a><span id="l28.38">  */</span>
<a href="#l28.39"></a><span id="l28.39"> function open_folder_in_new_tab(aFolder) {</span>
<a href="#l28.40"></a><span id="l28.40">   // save the current tab as the 'other' tab</span>
<a href="#l28.41"></a><span id="l28.41">   otherTab = mc.tabmail.currentTabInfo;</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-  mc.tabmail.openTab(&quot;folder&quot;, aFolder);</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+  mc.tabmail.openTab(&quot;folder&quot;, {folder: aFolder});</span>
<a href="#l28.44"></a><span id="l28.44">   wait_for_all_messages_to_load();</span>
<a href="#l28.45"></a><span id="l28.45">   return mc.tabmail.currentTabInfo;</span>
<a href="#l28.46"></a><span id="l28.46"> }</span>
<a href="#l28.47"></a><span id="l28.47"> </span>
<a href="#l28.48"></a><span id="l28.48"> /**</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+ * Open the selected message(s) by pressing Enter. The mail.openMessageBehavior</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+ * pref is supposed to determine how the messages are opened.</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+ */</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+function open_selected_messages() {</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+  // Focus the thread tree</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+  mc.threadTree.focus();</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+  // Open whatever's selected</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+  press_enter();</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+}</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+var open_selected_message = open_selected_messages;</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+/**</span>
<a href="#l28.62"></a><span id="l28.62">  * Create a new tab displaying the currently selected message, making that tab</span>
<a href="#l28.63"></a><span id="l28.63">  *  the current tab.  We block until the message finishes loading.</span>
<a href="#l28.64"></a><span id="l28.64">  *</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">- * @return The tab info of the current tab (a more persistent identifier for</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">- *     tabs than the index, which will change as tabs open/close).</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+ * @param aBackground [optional] If true, then the tab is opened in the</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineplus">+ *                    background. If false or not given, then the tab is opened</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineplus">+ *                    in the foreground.</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+ *</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineplus">+ * @return The tab info of the new tab (a more persistent identifier for tabs</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+ *     than the index, which will change as tabs open/close).</span>
<a href="#l28.73"></a><span id="l28.73">  */</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineminus">-function open_selected_message_in_new_tab() {</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineplus">+function open_selected_message_in_new_tab(aBackground) {</span>
<a href="#l28.76"></a><span id="l28.76">   // get the current tab count so we can make sure the tab actually opened.</span>
<a href="#l28.77"></a><span id="l28.77">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l28.78"></a><span id="l28.78"> </span>
<a href="#l28.79"></a><span id="l28.79">   // save the current tab as the 'other' tab</span>
<a href="#l28.80"></a><span id="l28.80">   otherTab = mc.tabmail.currentTabInfo;</span>
<a href="#l28.81"></a><span id="l28.81"> </span>
<a href="#l28.82"></a><span id="l28.82" class="difflineminus">-  mc.window.MsgOpenNewTabForMessage();</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineminus">-  wait_for_message_display_completion(mc, true);</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineplus">+  mc.tabmail.openTab(&quot;message&quot;, {msgHdr: mc.folderDisplay.selectedMessage,</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineplus">+      viewWrapperToClone: mc.folderDisplay.view,</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineplus">+      background: aBackground});</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineplus">+  // We won't trigger a new message load if we're in the background</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineplus">+  wait_for_message_display_completion(mc, !aBackground);</span>
<a href="#l28.89"></a><span id="l28.89"> </span>
<a href="#l28.90"></a><span id="l28.90">   // check that the tab count increased</span>
<a href="#l28.91"></a><span id="l28.91">   if (mc.tabmail.tabContainer.childNodes.length != preCount + 1)</span>
<a href="#l28.92"></a><span id="l28.92">     throw new Error(&quot;The tab never actually got opened!&quot;);</span>
<a href="#l28.93"></a><span id="l28.93"> </span>
<a href="#l28.94"></a><span id="l28.94" class="difflineminus">-  return mc.tabmail.currentTabInfo;</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+  // We append new tabs at the end, so return the last tab</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineplus">+  return mc.tabmail.tabInfo[mc.tabmail.tabContainer.childNodes.length - 1];</span>
<a href="#l28.97"></a><span id="l28.97"> }</span>
<a href="#l28.98"></a><span id="l28.98"> </span>
<a href="#l28.99"></a><span id="l28.99"> /**</span>
<a href="#l28.100"></a><span id="l28.100">  * Create a new window displaying the currently selected message.  We do not</span>
<a href="#l28.101"></a><span id="l28.101">  *  return until the message has finished loading.</span>
<a href="#l28.102"></a><span id="l28.102">  *</span>
<a href="#l28.103"></a><span id="l28.103">  * @return The MozmillController-wrapped new window.</span>
<a href="#l28.104"></a><span id="l28.104">  */</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineat">@@ -296,16 +317,56 @@ function switch_tab(aNewTab) {</span>
<a href="#l28.106"></a><span id="l28.106">   let targetTab = (aNewTab != null) ? aNewTab : otherTab;</span>
<a href="#l28.107"></a><span id="l28.107">   // now the current tab will be the 'other' tab after we switch</span>
<a href="#l28.108"></a><span id="l28.108">   otherTab = mc.tabmail.currentTabInfo;</span>
<a href="#l28.109"></a><span id="l28.109">   mc.tabmail.switchToTab(targetTab);</span>
<a href="#l28.110"></a><span id="l28.110">   wait_for_message_display_completion();</span>
<a href="#l28.111"></a><span id="l28.111"> }</span>
<a href="#l28.112"></a><span id="l28.112"> </span>
<a href="#l28.113"></a><span id="l28.113"> /**</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineplus">+ * Assert that the currently selected tab is the given one.</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineplus">+ *</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineplus">+ * @param aTab The tab that should currently be selected.</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineplus">+ */</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineplus">+function assert_selected_tab(aTab) {</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineplus">+  if (mc.tabmail.currentTabInfo != aTab)</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineplus">+    throw new Error(&quot;The currently selected tab should be at index &quot; +</span>
<a href="#l28.121"></a><span id="l28.121" class="difflineplus">+        mc.tabmail.tabInfo.indexOf(aTab) + &quot;, but is actually at index &quot; +</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineplus">+        mc.tabmail.tabInfo.indexOf(mc.tabmail.currentTabInfo));</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineplus">+}</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineplus">+</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineplus">+/**</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineplus">+ * Assert that the given tab has the given mode name. Valid mode names include</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineplus">+ * &quot;message&quot; and &quot;folder&quot;.</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineplus">+ *</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineplus">+ * @param aTab A Tab. The currently selected tab if null.</span>
<a href="#l28.130"></a><span id="l28.130" class="difflineplus">+ * @param aModeName A string that should match the mode name of the tab.</span>
<a href="#l28.131"></a><span id="l28.131" class="difflineplus">+ */</span>
<a href="#l28.132"></a><span id="l28.132" class="difflineplus">+function assert_tab_mode_name(aTab, aModeName) {</span>
<a href="#l28.133"></a><span id="l28.133" class="difflineplus">+  if (!aTab)</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineplus">+    aTab = mc.tabmail.currentTabInfo;</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineplus">+</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+  if (aTab.mode.type != aModeName)</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineplus">+    throw new Error(&quot;Tab should be of type &quot; + aModeName +</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineplus">+                    &quot;, but is actually of type &quot; + aTab.mode.type + &quot;.&quot;);</span>
<a href="#l28.139"></a><span id="l28.139" class="difflineplus">+}</span>
<a href="#l28.140"></a><span id="l28.140" class="difflineplus">+</span>
<a href="#l28.141"></a><span id="l28.141" class="difflineplus">+/**</span>
<a href="#l28.142"></a><span id="l28.142" class="difflineplus">+ * Assert that the number of tabs open matches the value given.</span>
<a href="#l28.143"></a><span id="l28.143" class="difflineplus">+ *</span>
<a href="#l28.144"></a><span id="l28.144" class="difflineplus">+ * @param aNumber The number of tabs that should be open.</span>
<a href="#l28.145"></a><span id="l28.145" class="difflineplus">+ */</span>
<a href="#l28.146"></a><span id="l28.146" class="difflineplus">+function assert_number_of_tabs_open(aNumber) {</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineplus">+  let actualNumber = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l28.148"></a><span id="l28.148" class="difflineplus">+  if (actualNumber != aNumber)</span>
<a href="#l28.149"></a><span id="l28.149" class="difflineplus">+    throw new Error(&quot;There should be &quot; + aNumber + &quot; tabs open, but there &quot; +</span>
<a href="#l28.150"></a><span id="l28.150" class="difflineplus">+                    &quot;are actually &quot; + actualNumber + &quot; tabs open.&quot;);</span>
<a href="#l28.151"></a><span id="l28.151" class="difflineplus">+}</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineplus">+</span>
<a href="#l28.153"></a><span id="l28.153" class="difflineplus">+/**</span>
<a href="#l28.154"></a><span id="l28.154">  * Assert that the given tab's title is based on the provided folder or</span>
<a href="#l28.155"></a><span id="l28.155">  *  message.</span>
<a href="#l28.156"></a><span id="l28.156">  *</span>
<a href="#l28.157"></a><span id="l28.157">  * @param aTab A Tab.</span>
<a href="#l28.158"></a><span id="l28.158">  * @param aWhat Either an nsIMsgFolder or an nsIMsgDBHdr</span>
<a href="#l28.159"></a><span id="l28.159">  */</span>
<a href="#l28.160"></a><span id="l28.160"> function assert_tab_titled_from(aTab, aWhat) {</span>
<a href="#l28.161"></a><span id="l28.161">   let text;</span>
<a href="#l28.162"></a><span id="l28.162" class="difflineat">@@ -331,16 +392,27 @@ function close_tab(aTabToClose) {</span>
<a href="#l28.163"></a><span id="l28.163">   wait_for_message_display_completion();</span>
<a href="#l28.164"></a><span id="l28.164"> </span>
<a href="#l28.165"></a><span id="l28.165">   // check that the tab count decreased</span>
<a href="#l28.166"></a><span id="l28.166">   if (mc.tabmail.tabContainer.childNodes.length != preCount - 1)</span>
<a href="#l28.167"></a><span id="l28.167">     throw new Error(&quot;The tab never actually got closed!&quot;);</span>
<a href="#l28.168"></a><span id="l28.168"> }</span>
<a href="#l28.169"></a><span id="l28.169"> </span>
<a href="#l28.170"></a><span id="l28.170"> /**</span>
<a href="#l28.171"></a><span id="l28.171" class="difflineplus">+ * Close a standalone message window.</span>
<a href="#l28.172"></a><span id="l28.172" class="difflineplus">+ *</span>
<a href="#l28.173"></a><span id="l28.173" class="difflineplus">+ * @param aController The message window controller</span>
<a href="#l28.174"></a><span id="l28.174" class="difflineplus">+ */</span>
<a href="#l28.175"></a><span id="l28.175" class="difflineplus">+function close_message_window(aController) {</span>
<a href="#l28.176"></a><span id="l28.176" class="difflineplus">+  windowHelper.plan_for_window_close(aController);</span>
<a href="#l28.177"></a><span id="l28.177" class="difflineplus">+  aController.window.close();</span>
<a href="#l28.178"></a><span id="l28.178" class="difflineplus">+  windowHelper.wait_for_window_close(aController);</span>
<a href="#l28.179"></a><span id="l28.179" class="difflineplus">+}</span>
<a href="#l28.180"></a><span id="l28.180" class="difflineplus">+</span>
<a href="#l28.181"></a><span id="l28.181" class="difflineplus">+/**</span>
<a href="#l28.182"></a><span id="l28.182">  * Clear the selection.  I'm not sure how we're pretending we did that.</span>
<a href="#l28.183"></a><span id="l28.183">  */</span>
<a href="#l28.184"></a><span id="l28.184"> function select_none() {</span>
<a href="#l28.185"></a><span id="l28.185">   wait_for_message_display_completion();</span>
<a href="#l28.186"></a><span id="l28.186">   mc.dbView.selection.clearSelection();</span>
<a href="#l28.187"></a><span id="l28.187">   // give the event queue a chance to drain...</span>
<a href="#l28.188"></a><span id="l28.188">   controller.sleep(0);</span>
<a href="#l28.189"></a><span id="l28.189"> }</span>
<a href="#l28.190"></a><span id="l28.190" class="difflineat">@@ -483,17 +555,19 @@ function right_click_on_row(aViewIndex) </span>
<a href="#l28.191"></a><span id="l28.191">  * Middle-click on the tree-view in question, presumably opening a new message</span>
<a href="#l28.192"></a><span id="l28.192">  *  tab.</span>
<a href="#l28.193"></a><span id="l28.193">  *</span>
<a href="#l28.194"></a><span id="l28.194">  * @return [The new tab, the message that you clicked on.]</span>
<a href="#l28.195"></a><span id="l28.195">  */</span>
<a href="#l28.196"></a><span id="l28.196"> function middle_click_on_row(aViewIndex) {</span>
<a href="#l28.197"></a><span id="l28.197">   let msgHdr = mc.dbView.getMsgHdrAt(aViewIndex);</span>
<a href="#l28.198"></a><span id="l28.198">   _row_click_helper(aViewIndex, 1);</span>
<a href="#l28.199"></a><span id="l28.199" class="difflineminus">-  return [mc.tabmail.currentTabInfo, msgHdr];</span>
<a href="#l28.200"></a><span id="l28.200" class="difflineplus">+  // We append new tabs at the end, so return the last tab</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineplus">+  return [mc.tabmail.tabInfo[mc.tabmail.tabContainer.childNodes.length - 1],</span>
<a href="#l28.202"></a><span id="l28.202" class="difflineplus">+          msgHdr];</span>
<a href="#l28.203"></a><span id="l28.203"> }</span>
<a href="#l28.204"></a><span id="l28.204"> </span>
<a href="#l28.205"></a><span id="l28.205"> /**</span>
<a href="#l28.206"></a><span id="l28.206">  * Assuming the context popup is popped-up (via right_click_on_row), select</span>
<a href="#l28.207"></a><span id="l28.207">  *  the deletion option.  If the popup is not popped up, you are out of luck.</span>
<a href="#l28.208"></a><span id="l28.208">  */</span>
<a href="#l28.209"></a><span id="l28.209"> function delete_via_popup() {</span>
<a href="#l28.210"></a><span id="l28.210">   plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;,</span>
<a href="#l28.211"></a><span id="l28.211" class="difflineat">@@ -530,16 +604,33 @@ function press_delete(aController) {</span>
<a href="#l28.212"></a><span id="l28.212">   plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;,</span>
<a href="#l28.213"></a><span id="l28.213">                                  &quot;DeleteOrMoveMsgFailed&quot;);</span>
<a href="#l28.214"></a><span id="l28.214">   aController.keypress(aController == mc ? mc.eThreadTree : null,</span>
<a href="#l28.215"></a><span id="l28.215">                        &quot;VK_DELETE&quot;, {});</span>
<a href="#l28.216"></a><span id="l28.216">   wait_for_folder_events();</span>
<a href="#l28.217"></a><span id="l28.217"> }</span>
<a href="#l28.218"></a><span id="l28.218"> </span>
<a href="#l28.219"></a><span id="l28.219"> /**</span>
<a href="#l28.220"></a><span id="l28.220" class="difflineplus">+ * Pretend we are pressing the Enter key, triggering opening selected messages.</span>
<a href="#l28.221"></a><span id="l28.221" class="difflineplus">+ *</span>
<a href="#l28.222"></a><span id="l28.222" class="difflineplus">+ * @param aController The controller in whose context to do this, defaults to</span>
<a href="#l28.223"></a><span id="l28.223" class="difflineplus">+ *     |mc| if omitted.</span>
<a href="#l28.224"></a><span id="l28.224" class="difflineplus">+ */</span>
<a href="#l28.225"></a><span id="l28.225" class="difflineplus">+function press_enter(aController) {</span>
<a href="#l28.226"></a><span id="l28.226" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l28.227"></a><span id="l28.227" class="difflineplus">+    aController = mc;</span>
<a href="#l28.228"></a><span id="l28.228" class="difflineplus">+  // if something is loading, make sure it finishes loading...</span>
<a href="#l28.229"></a><span id="l28.229" class="difflineplus">+  wait_for_message_display_completion(aController);</span>
<a href="#l28.230"></a><span id="l28.230" class="difflineplus">+  aController.keypress(aController == mc ? mc.eThreadTree : null,</span>
<a href="#l28.231"></a><span id="l28.231" class="difflineplus">+                       &quot;VK_RETURN&quot;, {});</span>
<a href="#l28.232"></a><span id="l28.232" class="difflineplus">+  // this is always going to cause a message load, so wait for that</span>
<a href="#l28.233"></a><span id="l28.233" class="difflineplus">+  wait_for_message_display_completion(aController);</span>
<a href="#l28.234"></a><span id="l28.234" class="difflineplus">+}</span>
<a href="#l28.235"></a><span id="l28.235" class="difflineplus">+</span>
<a href="#l28.236"></a><span id="l28.236" class="difflineplus">+/**</span>
<a href="#l28.237"></a><span id="l28.237">  * Wait for the |folderDisplay| on aController (defaults to mc if omitted) to</span>
<a href="#l28.238"></a><span id="l28.238">  *  finish loading.  This generally only matters for folders that have an active</span>
<a href="#l28.239"></a><span id="l28.239">  *  search.</span>
<a href="#l28.240"></a><span id="l28.240">  * This method is generally called automatically most of the time, and you</span>
<a href="#l28.241"></a><span id="l28.241">  *  should not need to call it yourself unless you are operating outside the</span>
<a href="#l28.242"></a><span id="l28.242">  *  helper methods in this file.</span>
<a href="#l28.243"></a><span id="l28.243">  */</span>
<a href="#l28.244"></a><span id="l28.244"> function wait_for_all_messages_to_load(aController) {</span>
<a href="#l28.245"></a><span id="l28.245" class="difflineat">@@ -1029,16 +1120,59 @@ function make_display_threaded() {</span>
<a href="#l28.246"></a><span id="l28.246"> function make_display_grouped() {</span>
<a href="#l28.247"></a><span id="l28.247">   wait_for_message_display_completion();</span>
<a href="#l28.248"></a><span id="l28.248">   mc.folderDisplay.view.showGroupedBySort = true;</span>
<a href="#l28.249"></a><span id="l28.249">   // drain event queue</span>
<a href="#l28.250"></a><span id="l28.250">   mc.sleep(0);</span>
<a href="#l28.251"></a><span id="l28.251"> }</span>
<a href="#l28.252"></a><span id="l28.252"> </span>
<a href="#l28.253"></a><span id="l28.253"> /**</span>
<a href="#l28.254"></a><span id="l28.254" class="difflineplus">+ * Set the mail.openMessageBehavior pref.</span>
<a href="#l28.255"></a><span id="l28.255" class="difflineplus">+ *</span>
<a href="#l28.256"></a><span id="l28.256" class="difflineplus">+ * @param aPref One of &quot;NEW_WINDOW&quot;, &quot;EXISTING_WINDOW&quot; or &quot;NEW_TAB&quot;</span>
<a href="#l28.257"></a><span id="l28.257" class="difflineplus">+ */</span>
<a href="#l28.258"></a><span id="l28.258" class="difflineplus">+function set_open_message_behavior(aPref) {</span>
<a href="#l28.259"></a><span id="l28.259" class="difflineplus">+  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l28.260"></a><span id="l28.260" class="difflineplus">+                     .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l28.261"></a><span id="l28.261" class="difflineplus">+  prefBranch.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l28.262"></a><span id="l28.262" class="difflineplus">+                        MailConsts.OpenMessageBehavior[aPref]);</span>
<a href="#l28.263"></a><span id="l28.263" class="difflineplus">+}</span>
<a href="#l28.264"></a><span id="l28.264" class="difflineplus">+</span>
<a href="#l28.265"></a><span id="l28.265" class="difflineplus">+/**</span>
<a href="#l28.266"></a><span id="l28.266" class="difflineplus">+ * Reset the mail.openMessageBehavior pref.</span>
<a href="#l28.267"></a><span id="l28.267" class="difflineplus">+ */</span>
<a href="#l28.268"></a><span id="l28.268" class="difflineplus">+function reset_open_message_behavior() {</span>
<a href="#l28.269"></a><span id="l28.269" class="difflineplus">+  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l28.270"></a><span id="l28.270" class="difflineplus">+                     .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l28.271"></a><span id="l28.271" class="difflineplus">+  if (prefBranch.prefHasUserValue(&quot;mail.openMessageBehavior&quot;))</span>
<a href="#l28.272"></a><span id="l28.272" class="difflineplus">+    prefBranch.clearUserPref(&quot;mail.openMessageBehavior&quot;);</span>
<a href="#l28.273"></a><span id="l28.273" class="difflineplus">+}</span>
<a href="#l28.274"></a><span id="l28.274" class="difflineplus">+</span>
<a href="#l28.275"></a><span id="l28.275" class="difflineplus">+/**</span>
<a href="#l28.276"></a><span id="l28.276" class="difflineplus">+ * Set the mail.contextMenuBackgroundTabs pref.</span>
<a href="#l28.277"></a><span id="l28.277" class="difflineplus">+ *</span>
<a href="#l28.278"></a><span id="l28.278" class="difflineplus">+ * @param aPref true/false.</span>
<a href="#l28.279"></a><span id="l28.279" class="difflineplus">+ */</span>
<a href="#l28.280"></a><span id="l28.280" class="difflineplus">+function set_context_menu_background_tabs(aPref) {</span>
<a href="#l28.281"></a><span id="l28.281" class="difflineplus">+  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l28.282"></a><span id="l28.282" class="difflineplus">+                     .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l28.283"></a><span id="l28.283" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.contextMenuBackgroundTabs&quot;, aPref);</span>
<a href="#l28.284"></a><span id="l28.284" class="difflineplus">+}</span>
<a href="#l28.285"></a><span id="l28.285" class="difflineplus">+</span>
<a href="#l28.286"></a><span id="l28.286" class="difflineplus">+/**</span>
<a href="#l28.287"></a><span id="l28.287" class="difflineplus">+ * Reset the mail.contextMenuBackgroundTabs pref.</span>
<a href="#l28.288"></a><span id="l28.288" class="difflineplus">+ */</span>
<a href="#l28.289"></a><span id="l28.289" class="difflineplus">+function reset_context_menu_background_tabs() {</span>
<a href="#l28.290"></a><span id="l28.290" class="difflineplus">+  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l28.291"></a><span id="l28.291" class="difflineplus">+                     .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l28.292"></a><span id="l28.292" class="difflineplus">+  if (prefBranch.prefHasUserValue(&quot;mail.contextMenuBackgroundTabs&quot;))</span>
<a href="#l28.293"></a><span id="l28.293" class="difflineplus">+    prefBranch.clearUserPref(&quot;mail.contextMenuBackgroundTabs&quot;);</span>
<a href="#l28.294"></a><span id="l28.294" class="difflineplus">+}</span>
<a href="#l28.295"></a><span id="l28.295" class="difflineplus">+</span>
<a href="#l28.296"></a><span id="l28.296" class="difflineplus">+/**</span>
<a href="#l28.297"></a><span id="l28.297">  * assert that the multimessage/thread summary view contains</span>
<a href="#l28.298"></a><span id="l28.298">  * the specified number of elements of the specified class.</span>
<a href="#l28.299"></a><span id="l28.299">  *</span>
<a href="#l28.300"></a><span id="l28.300">  * @param aClassName: the class to use to select</span>
<a href="#l28.301"></a><span id="l28.301">  * @param aNumElts: the number of expected elements that have that class</span>
<a href="#l28.302"></a><span id="l28.302">  */</span>
<a href="#l28.303"></a><span id="l28.303"> </span>
<a href="#l28.304"></a><span id="l28.304"> function assert_summary_contains_N_divs(aClassName, aNumElts) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -774,9 +774,9 @@ function augment_controller(aController,</span>
<a href="#l29.4"></a><span id="l29.4">   if (aWindowType === undefined)</span>
<a href="#l29.5"></a><span id="l29.5">     aWindowType =</span>
<a href="#l29.6"></a><span id="l29.6">       aController.window.document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8">   _augment_helper(aController, AugmentEverybodyWith);</span>
<a href="#l29.9"></a><span id="l29.9">   if (PerWindowTypeAugmentations[aWindowType])</span>
<a href="#l29.10"></a><span id="l29.10">     _augment_helper(aController, PerWindowTypeAugmentations[aWindowType]);</span>
<a href="#l29.11"></a><span id="l29.11">   return aController;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-}</span>
<a href="#l29.13"></a><span id="l29.13">\ No newline at end of file</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/build/nsMsgFactory.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/build/nsMsgFactory.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -238,43 +238,16 @@ UnregisterMailnewsContentPolicy(nsICompo</span>
<a href="#l30.4"></a><span id="l30.4">       do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l30.5"></a><span id="l30.5">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.6"></a><span id="l30.6"> </span>
<a href="#l30.7"></a><span id="l30.7">   return catman-&gt;DeleteCategoryEntry(&quot;content-policy&quot;,</span>
<a href="#l30.8"></a><span id="l30.8">                                      NS_MSGCONTENTPOLICY_CONTRACTID,</span>
<a href="#l30.9"></a><span id="l30.9">                                      PR_TRUE);</span>
<a href="#l30.10"></a><span id="l30.10"> }</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-static NS_METHOD</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-RegisterCommandLineHandler(nsIComponentManager* compMgr, nsIFile* path,</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-                           const char *location, const char *type,</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-                           const nsModuleComponentInfo *info)</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-{</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-  nsCOMPtr&lt;nsICategoryManager&gt; catMan (do_GetService(NS_CATEGORYMANAGER_CONTRACTID));</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-  NS_ENSURE_TRUE(catMan, NS_ERROR_FAILURE);</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">-  return catMan-&gt;AddCategoryEntry(&quot;command-line-handler&quot;, &quot;m-mail&quot;,</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">-                                  NS_MAILSTARTUPHANDLER_CONTRACTID,</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-                                  PR_TRUE, PR_TRUE, nsnull);</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-}</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-static NS_METHOD</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-UnregisterCommandLineHandler(nsIComponentManager* compMgr, nsIFile* path,</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-                             const char *location,</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-                             const nsModuleComponentInfo *info)</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-{</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-  nsCOMPtr&lt;nsICategoryManager&gt; catMan (do_GetService(NS_CATEGORYMANAGER_CONTRACTID));</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-  NS_ENSURE_TRUE(catMan, NS_ERROR_FAILURE);</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-  catMan-&gt;DeleteCategoryEntry(&quot;command-line-handler&quot;, &quot;m-mail&quot;,</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-                              PR_TRUE);</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-  return NS_OK;</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-}</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-</span>
<a href="#l30.39"></a><span id="l30.39"> #ifdef XP_MACOSX</span>
<a href="#l30.40"></a><span id="l30.40"> static NS_METHOD RegisterOSXIntegration(nsIComponentManager *aCompMgr,</span>
<a href="#l30.41"></a><span id="l30.41">                                         nsIFile *aPath,</span>
<a href="#l30.42"></a><span id="l30.42">                                         const char *registryLocation,</span>
<a href="#l30.43"></a><span id="l30.43">                                         const char *componentType,</span>
<a href="#l30.44"></a><span id="l30.44">                                         const nsModuleComponentInfo *info)</span>
<a href="#l30.45"></a><span id="l30.45"> {</span>
<a href="#l30.46"></a><span id="l30.46">   nsresult rv;</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineat">@@ -313,18 +286,16 @@ static const nsModuleComponentInfo gComp</span>
<a href="#l30.48"></a><span id="l30.48">     },</span>
<a href="#l30.49"></a><span id="l30.49">     { &quot;Netscape Messenger Window Service&quot;, NS_MESSENGERWINDOWSERVICE_CID,</span>
<a href="#l30.50"></a><span id="l30.50">       NS_MESSENGERWINDOWSERVICE_CONTRACTID,</span>
<a href="#l30.51"></a><span id="l30.51">       nsMessengerBootstrapConstructor,</span>
<a href="#l30.52"></a><span id="l30.52">     },</span>
<a href="#l30.53"></a><span id="l30.53">     { &quot;Mail Startup Handler&quot;, NS_MESSENGERBOOTSTRAP_CID,</span>
<a href="#l30.54"></a><span id="l30.54">       NS_MAILSTARTUPHANDLER_CONTRACTID,</span>
<a href="#l30.55"></a><span id="l30.55">       nsMessengerBootstrapConstructor,</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineminus">-      RegisterCommandLineHandler,</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineminus">-      UnregisterCommandLineHandler,</span>
<a href="#l30.58"></a><span id="l30.58">     },</span>
<a href="#l30.59"></a><span id="l30.59">     { &quot;Mail Session&quot;, NS_MSGMAILSESSION_CID,</span>
<a href="#l30.60"></a><span id="l30.60">       NS_MSGMAILSESSION_CONTRACTID,</span>
<a href="#l30.61"></a><span id="l30.61">       nsMsgMailSessionConstructor,</span>
<a href="#l30.62"></a><span id="l30.62">     },</span>
<a href="#l30.63"></a><span id="l30.63">     { &quot;Messenger DOM interaction object&quot;, NS_MESSENGER_CID,</span>
<a href="#l30.64"></a><span id="l30.64">       NS_MESSENGER_CONTRACTID,</span>
<a href="#l30.65"></a><span id="l30.65">       nsMessengerConstructor,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/base/src/Makefile.in</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/base/src/Makefile.in</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -170,16 +170,20 @@ DEFINES         += -DMOZ_LDAP_XPCOM</span>
<a href="#l31.4"></a><span id="l31.4"> endif</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6"> EXPORTS = \</span>
<a href="#l31.7"></a><span id="l31.7"> 		nsMsgRDFDataSource.h \</span>
<a href="#l31.8"></a><span id="l31.8"> 		nsMsgRDFUtils.h \</span>
<a href="#l31.9"></a><span id="l31.9"> 		nsMailDirServiceDefs.h \</span>
<a href="#l31.10"></a><span id="l31.10"> 		$(NULL)</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+EXTRA_COMPONENTS = \</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+		nsMailNewsCommandLineHandler.js \</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+		$(NULL)</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+</span>
<a href="#l31.16"></a><span id="l31.16"> EXTRA_JS_MODULES = \</span>
<a href="#l31.17"></a><span id="l31.17"> 		dbViewWrapper.js \</span>
<a href="#l31.18"></a><span id="l31.18"> 		mailViewManager.js \</span>
<a href="#l31.19"></a><span id="l31.19"> 		quickSearchManager.js \</span>
<a href="#l31.20"></a><span id="l31.20"> 		searchSpec.js \</span>
<a href="#l31.21"></a><span id="l31.21"> 		virtualFolderWrapper.js \</span>
<a href="#l31.22"></a><span id="l31.22"> 		$(NULL)</span>
<a href="#l31.23"></a><span id="l31.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1879,9 +1879,9 @@ DBViewWrapper.prototype = {</span>
<a href="#l32.4"></a><span id="l32.4">       return null;</span>
<a href="#l32.5"></a><span id="l32.5">     for (let [, folder] in Iterator(this._underlyingFolders)) {</span>
<a href="#l32.6"></a><span id="l32.6">       let msgHdr = folder.msgDatabase.getMsgHdrForMessageID(aMessageId);</span>
<a href="#l32.7"></a><span id="l32.7">       if (msgHdr)</span>
<a href="#l32.8"></a><span id="l32.8">         return msgHdr;</span>
<a href="#l32.9"></a><span id="l32.9">     }</span>
<a href="#l32.10"></a><span id="l32.10">     return null;</span>
<a href="#l32.11"></a><span id="l32.11">   },</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-};</span>
<a href="#l32.13"></a><span id="l32.13">\ No newline at end of file</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">new file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- /dev/null</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ b/mailnews/base/src/nsMailNewsCommandLineHandler.js</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -0,0 +1,198 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineplus">+ *</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+ *</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+ * License.</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+ *</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+ *</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+ *</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+ *</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+ *</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+const MAPI_STARTUP_ARG = &quot;MapiStartup&quot;;</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+const MESSAGE_ID_PARAM = &quot;?messageid=&quot;;</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+var nsMailNewsCommandLineHandler =</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+{</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+  get _messenger nsMailNewsCommandLineHandler_getMessenger() {</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineplus">+    delete this._messenger;</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+    return this._messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+                               .createInstance(Ci.nsIMessenger);</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+  },</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+  /* nsICommandLineHandler */</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+  /**</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+   * Handles the following command line arguments:</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+   * - -mail: opens the mail folder view</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+   * - -MapiStartup: indicates that this startup is due to MAPI.</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+   *   Don't do anything for now.</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+   */</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineplus">+  handle: function nsMailNewsCommandLineHandler_handle(aCommandLine) {</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+    // Do this here because xpcshell isn't too happy with this at startup</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+    Components.utils.import(&quot;resource://app/modules/MailUtils.js&quot;);</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+    // -mail &lt;URL&gt;</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+    let mailURL = null;</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+    try {</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+      mailURL = aCommandLine.handleFlagWithParam(&quot;mail&quot;, false);</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+    }</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+    catch (e) {</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+      // We're going to cover -mail without a parameter later</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+    }</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+    if (mailURL &amp;&amp; mailURL.length &gt; 0) {</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+      let msgHdr = null;</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+      if (/^(mailbox|imap|news)-message:\/\//.test(mailURL)) {</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+        // This might be a standard message URI, or one with a messageID</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+        // parameter. Handle both cases.</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+        let messageIDIndex = mailURL.toLowerCase().indexOf(MESSAGE_ID_PARAM);</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+        if (messageIDIndex != -1) {</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+          // messageID parameter</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+          // Convert the message URI into a folder URI</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+          let folderURI = mailURL.slice(0, messageIDIndex)</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+                                 .replace(&quot;-message&quot;, &quot;&quot;);</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+          // Get the message ID</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+          let messageID = mailURL.slice(messageIDIndex + MESSAGE_ID_PARAM.length);</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineplus">+          // Make sure the folder tree is initialized</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineplus">+          MailUtils.discoverFolders();</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineplus">+          let folder = MailUtils.getFolderForURI(folderURI, true);</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineplus">+          // The folder might not exist, so guard against that</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+          if (folder &amp;&amp; messageID.length &gt; 0)</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+            msgHdr = folder.msgDatabase.getMsgHdrForMessageID(messageID);</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+        }</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+        else {</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+          // message URI</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+          msgHdr = this._messenger.msgHdrFromURI(mailURL);</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+        }</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineplus">+      }</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineplus">+      else {</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineplus">+        // Necko URL, so convert it into a message header</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+        let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineplus">+                          .getService(Ci.nsIIOService);</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineplus">+        let neckoURL = null;</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineplus">+        try {</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineplus">+          neckoURL = ioService.newURI(mailURL, null, null);</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineplus">+        }</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineplus">+        catch (e) {</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineplus">+          // We failed to convert the URI. Oh well.</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineplus">+        }</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineplus">+</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineplus">+        if (neckoURL instanceof Ci.nsIMsgMessageUrl)</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineplus">+          msgHdr = neckoURL.messageHeader;</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineplus">+      }</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineplus">+</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineplus">+      if (msgHdr) {</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineplus">+        aCommandLine.preventDefault = true;</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineplus">+        MailUtils.displayMessage(msgHdr);</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineplus">+      }</span>
<a href="#l33.125"></a><span id="l33.125" class="difflineplus">+      else {</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineplus">+        dump(&quot;Unrecognized URL: &quot; + mailURL + &quot;\n&quot;);</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineplus">+      }</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineplus">+    }</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineplus">+</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineplus">+    // -mail (no parameter)</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineplus">+    let mailFlag = aCommandLine.handleFlag(&quot;mail&quot;, false);</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineplus">+    if (mailFlag) {</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineplus">+      // Focus the 3pane window if one is present, else open one</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineplus">+      let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineplus">+                             .getService(Ci.nsIWindowMediator);</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineplus">+      let mail3PaneWindow = windowMediator.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineplus">+      if (mail3PaneWindow) {</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineplus">+        mail3PaneWindow.focus();</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineplus">+      }</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineplus">+      else {</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineplus">+        let windowWatcher = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineplus">+                              .getService(Ci.nsIWindowWatcher);</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineplus">+        windowWatcher.openWindow(null, &quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineplus">+            &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar,dialog=no&quot;,</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineplus">+            null);</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineplus">+      }</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineplus">+      aCommandLine.preventDefault = true;</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineplus">+    }</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineplus">+</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineplus">+    // -MapiStartup</span>
<a href="#l33.151"></a><span id="l33.151" class="difflineplus">+    aCommandLine.handleFlag(MAPI_STARTUP_ARG, false);</span>
<a href="#l33.152"></a><span id="l33.152" class="difflineplus">+  },</span>
<a href="#l33.153"></a><span id="l33.153" class="difflineplus">+</span>
<a href="#l33.154"></a><span id="l33.154" class="difflineplus">+  helpInfo: &quot;  -mail                Open the mail folder view.\n&quot; +</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineplus">+            &quot;  -mail &lt;URL&gt;          Open the message specified by this URL.\n&quot;,</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineplus">+</span>
<a href="#l33.157"></a><span id="l33.157" class="difflineplus">+  /* nsIClassInfo */</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineplus">+  flags: Ci.nsIClassInfo.SINGLETON,</span>
<a href="#l33.159"></a><span id="l33.159" class="difflineplus">+  implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineplus">+  getHelperForLanguage: function(language) null,</span>
<a href="#l33.161"></a><span id="l33.161" class="difflineplus">+  getInterfaces: function(count) {</span>
<a href="#l33.162"></a><span id="l33.162" class="difflineplus">+    let interfaces = [Ci.nsICommandLineHandler];</span>
<a href="#l33.163"></a><span id="l33.163" class="difflineplus">+    count.value = interfaces.length;</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineplus">+    return interfaces;</span>
<a href="#l33.165"></a><span id="l33.165" class="difflineplus">+  },</span>
<a href="#l33.166"></a><span id="l33.166" class="difflineplus">+</span>
<a href="#l33.167"></a><span id="l33.167" class="difflineplus">+  /* nsIFactory */</span>
<a href="#l33.168"></a><span id="l33.168" class="difflineplus">+  createInstance: function(outer, iid) {</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineplus">+    if (outer != null)</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineplus">+      throw Cr.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineplus">+</span>
<a href="#l33.172"></a><span id="l33.172" class="difflineplus">+    return this.QueryInterface(iid);</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineplus">+  },</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineplus">+</span>
<a href="#l33.175"></a><span id="l33.175" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsICommandLineHandler,</span>
<a href="#l33.176"></a><span id="l33.176" class="difflineplus">+                                         Ci.nsIClassInfo,</span>
<a href="#l33.177"></a><span id="l33.177" class="difflineplus">+                                         Ci.nsIFactory])</span>
<a href="#l33.178"></a><span id="l33.178" class="difflineplus">+};</span>
<a href="#l33.179"></a><span id="l33.179" class="difflineplus">+</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineplus">+function mailNewsCommandLineHandlerModule() {}</span>
<a href="#l33.181"></a><span id="l33.181" class="difflineplus">+mailNewsCommandLineHandlerModule.prototype =</span>
<a href="#l33.182"></a><span id="l33.182" class="difflineplus">+{</span>
<a href="#l33.183"></a><span id="l33.183" class="difflineplus">+  // XPCOM registration</span>
<a href="#l33.184"></a><span id="l33.184" class="difflineplus">+  classDescription: &quot;MailNews Commandline Handler&quot;,</span>
<a href="#l33.185"></a><span id="l33.185" class="difflineplus">+  classID: Components.ID(&quot;{2f86d554-f9d9-4e76-8eb7-243f047333ee}&quot;),</span>
<a href="#l33.186"></a><span id="l33.186" class="difflineplus">+  contractID: &quot;@mozilla.org/messenger/clh;1&quot;,</span>
<a href="#l33.187"></a><span id="l33.187" class="difflineplus">+</span>
<a href="#l33.188"></a><span id="l33.188" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIModule]),</span>
<a href="#l33.189"></a><span id="l33.189" class="difflineplus">+  </span>
<a href="#l33.190"></a><span id="l33.190" class="difflineplus">+  _xpcom_categories: [{</span>
<a href="#l33.191"></a><span id="l33.191" class="difflineplus">+    category: &quot;command-line-handler&quot;,</span>
<a href="#l33.192"></a><span id="l33.192" class="difflineplus">+    entry: &quot;m-mail&quot;</span>
<a href="#l33.193"></a><span id="l33.193" class="difflineplus">+  }],</span>
<a href="#l33.194"></a><span id="l33.194" class="difflineplus">+</span>
<a href="#l33.195"></a><span id="l33.195" class="difflineplus">+  _xpcom_factory: nsMailNewsCommandLineHandler</span>
<a href="#l33.196"></a><span id="l33.196" class="difflineplus">+};</span>
<a href="#l33.197"></a><span id="l33.197" class="difflineplus">+</span>
<a href="#l33.198"></a><span id="l33.198" class="difflineplus">+// NSGetModule: Return the nsIModule object.</span>
<a href="#l33.199"></a><span id="l33.199" class="difflineplus">+function NSGetModule(compMgr, fileSpec)</span>
<a href="#l33.200"></a><span id="l33.200" class="difflineplus">+{</span>
<a href="#l33.201"></a><span id="l33.201" class="difflineplus">+  return XPCOMUtils.generateModule([mailNewsCommandLineHandlerModule]);</span>
<a href="#l33.202"></a><span id="l33.202" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerBootstrap.cpp</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerBootstrap.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -40,329 +40,36 @@</span>
<a href="#l34.4"></a><span id="l34.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l34.5"></a><span id="l34.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l34.6"></a><span id="l34.6">  *</span>
<a href="#l34.7"></a><span id="l34.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9"> #include &quot;nsMessengerBootstrap.h&quot;</span>
<a href="#l34.10"></a><span id="l34.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-#include &quot;nsDOMCID.h&quot;</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+#include &quot;nsISupportsArray.h&quot;</span>
<a href="#l34.15"></a><span id="l34.15"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineminus">-#include &quot;nsIMsgFolderCache.h&quot;</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineminus">-#include &quot;nsIPrefService.h&quot;</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineminus">-#include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineminus">-#include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineminus">-#include &quot;nsXPCOM.h&quot;</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineminus">-#include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l34.22"></a><span id="l34.22"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-#include &quot;nsIPromptService.h&quot;</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineminus">-#include &quot;nsIURI.h&quot;</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineminus">-#include &quot;nsIDialogParamBlock.h&quot;</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineminus">-#include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-#include &quot;nsICommandLine.h&quot;</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-#include &quot;nsILocalFile.h&quot;</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">-#include &quot;nsIFileURL.h&quot;</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-#include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineminus">-#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l34.38"></a><span id="l34.38"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineminus">-#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineminus">-</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineminus">-#include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineminus">-#endif</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineminus">-</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineminus">-#define MAPI_STARTUP_ARG &quot;MapiStartup&quot;</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+#include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+#include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l34.49"></a><span id="l34.49"> </span>
<a href="#l34.50"></a><span id="l34.50"> NS_IMPL_THREADSAFE_ADDREF(nsMessengerBootstrap)</span>
<a href="#l34.51"></a><span id="l34.51"> NS_IMPL_THREADSAFE_RELEASE(nsMessengerBootstrap)</span>
<a href="#l34.52"></a><span id="l34.52"> </span>
<a href="#l34.53"></a><span id="l34.53" class="difflineminus">-NS_IMPL_QUERY_INTERFACE2(nsMessengerBootstrap,</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineminus">-                         nsICommandLineHandler,</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineminus">-                         nsIMessengerWindowService)</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+NS_IMPL_QUERY_INTERFACE1(nsMessengerBootstrap, nsIMessengerWindowService)</span>
<a href="#l34.57"></a><span id="l34.57"> </span>
<a href="#l34.58"></a><span id="l34.58"> nsMessengerBootstrap::nsMessengerBootstrap()</span>
<a href="#l34.59"></a><span id="l34.59"> {</span>
<a href="#l34.60"></a><span id="l34.60"> }</span>
<a href="#l34.61"></a><span id="l34.61"> </span>
<a href="#l34.62"></a><span id="l34.62"> nsMessengerBootstrap::~nsMessengerBootstrap()</span>
<a href="#l34.63"></a><span id="l34.63"> {</span>
<a href="#l34.64"></a><span id="l34.64"> }</span>
<a href="#l34.65"></a><span id="l34.65"> </span>
<a href="#l34.66"></a><span id="l34.66" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineminus">-nsMessengerBootstrap::Handle(nsICommandLine* aCmdLine)</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-{</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aCmdLine);</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineminus">-  nsresult rv;</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineminus">-</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-  nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch (do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineminus">-  NS_ENSURE_TRUE(wwatch, NS_ERROR_FAILURE);</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineminus">-</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineminus">-  nsCOMPtr&lt;nsIDOMWindow&gt; opened;</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineminus">-</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineminus">-#ifndef MOZ_SUITE</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineminus">-  PRBool found;</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineminus">-  rv = aCmdLine-&gt;HandleFlag(NS_LITERAL_STRING(&quot;options&quot;), PR_FALSE, &amp;found);</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; found) {</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineminus">-    wwatch-&gt;OpenWindow(nsnull, &quot;chrome://messenger/content/preferences/preferences.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineminus">-                      &quot;chrome,dialog=no,all&quot;, nsnull, getter_AddRefs(opened));</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineminus">-    aCmdLine-&gt;SetPreventDefault(PR_TRUE);</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineminus">-  }</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineminus">-#endif</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineminus">-</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineminus">-  nsAutoString mailUrl; // -mail or -mail &lt;some url&gt; </span>
<a href="#l34.88"></a><span id="l34.88" class="difflineminus">-  PRBool flag = PR_FALSE;</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineminus">-  rv = aCmdLine-&gt;HandleFlagWithParam(NS_LITERAL_STRING(&quot;mail&quot;), PR_FALSE, mailUrl);</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineminus">-    flag = !mailUrl.IsVoid();</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineminus">-  else </span>
<a href="#l34.93"></a><span id="l34.93" class="difflineminus">-    aCmdLine-&gt;HandleFlag(NS_LITERAL_STRING(&quot;mail&quot;), PR_FALSE, &amp;flag);</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineminus">-  if (flag)</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineminus">-  {</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineminus">-    nsCOMPtr&lt;nsISupportsArray&gt; argsArray = do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineminus">-</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineminus">-    // create scriptable versions of our strings that we can store in our nsISupportsArray....</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineminus">-    if (!mailUrl.IsEmpty())</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineminus">-    {</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineminus">-      nsCOMPtr&lt;nsISupportsString&gt; scriptableURL (do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID));</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineminus">-      NS_ENSURE_TRUE(scriptableURL, NS_ERROR_FAILURE);</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineminus">-      if (StringBeginsWith(mailUrl, NS_LITERAL_STRING(&quot;mailbox-message://&quot;)) ||</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineminus">-          StringBeginsWith(mailUrl, NS_LITERAL_STRING(&quot;imap-message://&quot;)) ||</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineminus">-          StringBeginsWith(mailUrl, NS_LITERAL_STRING(&quot;news-message://&quot;)))</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineminus">-      {</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineminus">-        nsCAutoString nativeArg;</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineminus">-        NS_CopyUnicodeToNative(mailUrl, nativeArg);</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineminus">-        PRInt32 queryIndex = nativeArg.Find(&quot;?messageId=&quot;, PR_TRUE);</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineminus">-        if (queryIndex &gt; 0)</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineminus">-        {</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineminus">-          nsCString messageId, folderUri;</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineminus">-          nativeArg.Right(messageId, nativeArg.Length() - queryIndex - 11);</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineminus">-          nativeArg.Left(folderUri, queryIndex);</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineminus">-          folderUri.Cut(folderUri.Find(&quot;-message&quot;), 8);</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineminus">-          return OpenMessengerWindowForMessageId(folderUri, messageId);</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineminus">-        }</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineminus">-        else</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineminus">-          GetMsgDBHdrFromURI(nativeArg.get(), getter_AddRefs(msgHdr));</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineminus">-</span>
<a href="#l34.123"></a><span id="l34.123" class="difflineminus">-        if (msgHdr)</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineminus">-        {</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineminus">-          nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l34.126"></a><span id="l34.126" class="difflineminus">-          nsCString folderUri;</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineminus">-          nsMsgKey msgKey;</span>
<a href="#l34.128"></a><span id="l34.128" class="difflineminus">-          msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l34.129"></a><span id="l34.129" class="difflineminus">-          msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l34.130"></a><span id="l34.130" class="difflineminus">-          if (folder)</span>
<a href="#l34.131"></a><span id="l34.131" class="difflineminus">-          {</span>
<a href="#l34.132"></a><span id="l34.132" class="difflineminus">-            folder-&gt;GetURI(folderUri);</span>
<a href="#l34.133"></a><span id="l34.133" class="difflineminus">-            rv = DiscoverFoldersIfNeeded(folder);</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.135"></a><span id="l34.135" class="difflineminus">-            return OpenMessengerWindowWithUri(&quot;mail:messageWindow&quot;, folderUri.get(), msgKey);  </span>
<a href="#l34.136"></a><span id="l34.136" class="difflineminus">-          }</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineminus">-        }</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineminus">-      }</span>
<a href="#l34.139"></a><span id="l34.139" class="difflineminus">-      // check if it's a mail message url, and if so, convert it?</span>
<a href="#l34.140"></a><span id="l34.140" class="difflineminus">-      scriptableURL-&gt;SetData((mailUrl));</span>
<a href="#l34.141"></a><span id="l34.141" class="difflineminus">-      argsArray-&gt;AppendElement(scriptableURL);</span>
<a href="#l34.142"></a><span id="l34.142" class="difflineminus">-    }</span>
<a href="#l34.143"></a><span id="l34.143" class="difflineminus">-    wwatch-&gt;OpenWindow(nsnull, &quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineminus">-                       &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar,dialog=no&quot;, argsArray, getter_AddRefs(opened));</span>
<a href="#l34.145"></a><span id="l34.145" class="difflineminus">-    aCmdLine-&gt;SetPreventDefault(PR_TRUE);</span>
<a href="#l34.146"></a><span id="l34.146" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.147"></a><span id="l34.147" class="difflineminus">-  }</span>
<a href="#l34.148"></a><span id="l34.148" class="difflineminus">-</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l34.150"></a><span id="l34.150" class="difflineminus">-  // Handle MAPI startup -- do nothing</span>
<a href="#l34.151"></a><span id="l34.151" class="difflineminus">-  PRBool isMapiStartup = PR_FALSE;</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineminus">-  aCmdLine-&gt;HandleFlag(NS_LITERAL_STRING(MAPI_STARTUP_ARG), PR_FALSE, &amp;isMapiStartup);</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineminus">-#endif</span>
<a href="#l34.154"></a><span id="l34.154" class="difflineminus">-</span>
<a href="#l34.155"></a><span id="l34.155" class="difflineminus">-#ifndef MOZ_SUITE</span>
<a href="#l34.156"></a><span id="l34.156" class="difflineminus">-  PRInt32 numArgs;</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineminus">-  aCmdLine-&gt;GetLength(&amp;numArgs);</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineminus">-  if (numArgs &gt; 0)</span>
<a href="#l34.159"></a><span id="l34.159" class="difflineminus">-  {</span>
<a href="#l34.160"></a><span id="l34.160" class="difflineminus">-    nsAutoString mailPath;</span>
<a href="#l34.161"></a><span id="l34.161" class="difflineminus">-</span>
<a href="#l34.162"></a><span id="l34.162" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l34.163"></a><span id="l34.163" class="difflineminus">-    // Mac will get -file /path/to/file</span>
<a href="#l34.164"></a><span id="l34.164" class="difflineminus">-    rv = aCmdLine-&gt;HandleFlagWithParam(NS_LITERAL_STRING(&quot;file&quot;), PR_FALSE, mailPath);</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.166"></a><span id="l34.166" class="difflineminus">-</span>
<a href="#l34.167"></a><span id="l34.167" class="difflineminus">-    if (StringEndsWith(mailPath, NS_LITERAL_STRING(&quot;.mozeml&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l34.168"></a><span id="l34.168" class="difflineminus">-    {</span>
<a href="#l34.169"></a><span id="l34.169" class="difflineminus">-      rv = HandleIndexerResult(mailPath);</span>
<a href="#l34.170"></a><span id="l34.170" class="difflineminus">-      // If we've found a search result, don't pop up a 3pane window</span>
<a href="#l34.171"></a><span id="l34.171" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l34.172"></a><span id="l34.172" class="difflineminus">-        aCmdLine-&gt;SetPreventDefault(PR_TRUE);</span>
<a href="#l34.173"></a><span id="l34.173" class="difflineminus">-    }</span>
<a href="#l34.174"></a><span id="l34.174" class="difflineminus">-#else</span>
<a href="#l34.175"></a><span id="l34.175" class="difflineminus">-    // All other OSes just get a straight path (i.e., no -file)</span>
<a href="#l34.176"></a><span id="l34.176" class="difflineminus">-    nsAutoString arg;</span>
<a href="#l34.177"></a><span id="l34.177" class="difflineminus">-    aCmdLine-&gt;GetArgument(0, arg);</span>
<a href="#l34.178"></a><span id="l34.178" class="difflineminus">-</span>
<a href="#l34.179"></a><span id="l34.179" class="difflineminus">-    mailPath = arg;</span>
<a href="#l34.180"></a><span id="l34.180" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l34.181"></a><span id="l34.181" class="difflineminus">-    if (StringEndsWith(mailPath, NS_LITERAL_STRING(&quot;.wdseml&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l34.182"></a><span id="l34.182" class="difflineminus">-    {</span>
<a href="#l34.183"></a><span id="l34.183" class="difflineminus">-      rv = aCmdLine-&gt;RemoveArguments(0, 0);</span>
<a href="#l34.184"></a><span id="l34.184" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.185"></a><span id="l34.185" class="difflineminus">-</span>
<a href="#l34.186"></a><span id="l34.186" class="difflineminus">-      rv = HandleIndexerResult(mailPath);</span>
<a href="#l34.187"></a><span id="l34.187" class="difflineminus">-      // If we've found a search result, don't pop up a 3pane window</span>
<a href="#l34.188"></a><span id="l34.188" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l34.189"></a><span id="l34.189" class="difflineminus">-        aCmdLine-&gt;SetPreventDefault(PR_TRUE);</span>
<a href="#l34.190"></a><span id="l34.190" class="difflineminus">-    }</span>
<a href="#l34.191"></a><span id="l34.191" class="difflineminus">-#endif</span>
<a href="#l34.192"></a><span id="l34.192" class="difflineminus">-#endif</span>
<a href="#l34.193"></a><span id="l34.193" class="difflineminus">-</span>
<a href="#l34.194"></a><span id="l34.194" class="difflineminus">-    if (StringEndsWith(mailPath, NS_LITERAL_STRING(&quot;.eml&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l34.195"></a><span id="l34.195" class="difflineminus">-    {</span>
<a href="#l34.196"></a><span id="l34.196" class="difflineminus">-      rv = aCmdLine-&gt;RemoveArguments(0, 0);</span>
<a href="#l34.197"></a><span id="l34.197" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.198"></a><span id="l34.198" class="difflineminus">-</span>
<a href="#l34.199"></a><span id="l34.199" class="difflineminus">-      nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineminus">-      if (StringBeginsWith(mailPath, NS_LITERAL_STRING(&quot;file://&quot;),</span>
<a href="#l34.201"></a><span id="l34.201" class="difflineminus">-                           nsCaseInsensitiveStringComparator()))</span>
<a href="#l34.202"></a><span id="l34.202" class="difflineminus">-      {</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineminus">-        // Get the file from the file:// URL.</span>
<a href="#l34.204"></a><span id="l34.204" class="difflineminus">-        rv = NS_GetFileFromURLSpec(NS_ConvertUTF16toUTF8(mailPath),</span>
<a href="#l34.205"></a><span id="l34.205" class="difflineminus">-                                   getter_AddRefs(file));</span>
<a href="#l34.206"></a><span id="l34.206" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.207"></a><span id="l34.207" class="difflineminus">-      }</span>
<a href="#l34.208"></a><span id="l34.208" class="difflineminus">-      else</span>
<a href="#l34.209"></a><span id="l34.209" class="difflineminus">-      {</span>
<a href="#l34.210"></a><span id="l34.210" class="difflineminus">-        // Resolve the file from the relative or absolute path.</span>
<a href="#l34.211"></a><span id="l34.211" class="difflineminus">-        aCmdLine-&gt;ResolveFile(mailPath, getter_AddRefs(file));</span>
<a href="#l34.212"></a><span id="l34.212" class="difflineminus">-      }</span>
<a href="#l34.213"></a><span id="l34.213" class="difflineminus">-</span>
<a href="#l34.214"></a><span id="l34.214" class="difflineminus">-      PRBool fileExists = PR_FALSE;</span>
<a href="#l34.215"></a><span id="l34.215" class="difflineminus">-      if (file) // Absolute paths always resolve a file, check if it exists too.</span>
<a href="#l34.216"></a><span id="l34.216" class="difflineminus">-        file-&gt;Exists(&amp;fileExists);</span>
<a href="#l34.217"></a><span id="l34.217" class="difflineminus">-</span>
<a href="#l34.218"></a><span id="l34.218" class="difflineminus">-      // If the file does not exist - shown an alert.</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineminus">-      if (!fileExists)</span>
<a href="#l34.220"></a><span id="l34.220" class="difflineminus">-      {</span>
<a href="#l34.221"></a><span id="l34.221" class="difflineminus">-        nsCOMPtr&lt;nsIStringBundleService&gt; bs = do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l34.222"></a><span id="l34.222" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.223"></a><span id="l34.223" class="difflineminus">-        nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l34.224"></a><span id="l34.224" class="difflineminus">-        rv = bs-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l34.225"></a><span id="l34.225" class="difflineminus">-                              getter_AddRefs(bundle));</span>
<a href="#l34.226"></a><span id="l34.226" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.227"></a><span id="l34.227" class="difflineminus">-</span>
<a href="#l34.228"></a><span id="l34.228" class="difflineminus">-        nsAutoString title;</span>
<a href="#l34.229"></a><span id="l34.229" class="difflineminus">-        rv = bundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;fileNotFoundTitle&quot;).get(),</span>
<a href="#l34.230"></a><span id="l34.230" class="difflineminus">-                                       getter_Copies(title));</span>
<a href="#l34.231"></a><span id="l34.231" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.232"></a><span id="l34.232" class="difflineminus">-</span>
<a href="#l34.233"></a><span id="l34.233" class="difflineminus">-        nsAutoString msg;</span>
<a href="#l34.234"></a><span id="l34.234" class="difflineminus">-        const PRUnichar *formatStrings[1] = { mailPath.get() };</span>
<a href="#l34.235"></a><span id="l34.235" class="difflineminus">-        rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;fileNotFoundMsg&quot;).get(),</span>
<a href="#l34.236"></a><span id="l34.236" class="difflineminus">-                                          formatStrings, 1, getter_Copies(msg));</span>
<a href="#l34.237"></a><span id="l34.237" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.238"></a><span id="l34.238" class="difflineminus">-</span>
<a href="#l34.239"></a><span id="l34.239" class="difflineminus">-        nsCOMPtr&lt;nsIPromptService&gt; promptService(do_GetService(&quot;@mozilla.org/embedcomp/prompt-service;1&quot;, &amp;rv));</span>
<a href="#l34.240"></a><span id="l34.240" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.241"></a><span id="l34.241" class="difflineminus">-</span>
<a href="#l34.242"></a><span id="l34.242" class="difflineminus">-        promptService-&gt;Alert(nsnull, title.get(), msg.get());</span>
<a href="#l34.243"></a><span id="l34.243" class="difflineminus">-        return NS_OK;</span>
<a href="#l34.244"></a><span id="l34.244" class="difflineminus">-      }</span>
<a href="#l34.245"></a><span id="l34.245" class="difflineminus">-</span>
<a href="#l34.246"></a><span id="l34.246" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l34.247"></a><span id="l34.247" class="difflineminus">-      NS_NewFileURI(getter_AddRefs(uri), file);</span>
<a href="#l34.248"></a><span id="l34.248" class="difflineminus">-      nsCOMPtr&lt;nsIFileURL&gt; fileURL(do_QueryInterface(uri));</span>
<a href="#l34.249"></a><span id="l34.249" class="difflineminus">-      NS_ENSURE_TRUE(fileURL, NS_ERROR_FAILURE);</span>
<a href="#l34.250"></a><span id="l34.250" class="difflineminus">-</span>
<a href="#l34.251"></a><span id="l34.251" class="difflineminus">-      // create scriptable versions of our strings that we can store in our nsISupportsArray....</span>
<a href="#l34.252"></a><span id="l34.252" class="difflineminus">-      nsCOMPtr&lt;nsISupportsString&gt; scriptableURL (do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID));</span>
<a href="#l34.253"></a><span id="l34.253" class="difflineminus">-      NS_ENSURE_TRUE(scriptableURL, NS_ERROR_FAILURE);</span>
<a href="#l34.254"></a><span id="l34.254" class="difflineminus">-</span>
<a href="#l34.255"></a><span id="l34.255" class="difflineminus">-      fileURL-&gt;SetQuery(NS_LITERAL_CSTRING(&quot;?type=application/x-message-display&quot;));</span>
<a href="#l34.256"></a><span id="l34.256" class="difflineminus">-</span>
<a href="#l34.257"></a><span id="l34.257" class="difflineminus">-      wwatch-&gt;OpenWindow(nsnull, &quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l34.258"></a><span id="l34.258" class="difflineminus">-                         &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar,dialog=no&quot;, fileURL, getter_AddRefs(opened));</span>
<a href="#l34.259"></a><span id="l34.259" class="difflineminus">-      aCmdLine-&gt;SetPreventDefault(PR_TRUE);</span>
<a href="#l34.260"></a><span id="l34.260" class="difflineminus">-    }</span>
<a href="#l34.261"></a><span id="l34.261" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.262"></a><span id="l34.262" class="difflineminus">-  }</span>
<a href="#l34.263"></a><span id="l34.263" class="difflineminus">-#endif</span>
<a href="#l34.264"></a><span id="l34.264" class="difflineminus">-  return NS_OK;</span>
<a href="#l34.265"></a><span id="l34.265" class="difflineminus">-}</span>
<a href="#l34.266"></a><span id="l34.266" class="difflineminus">-</span>
<a href="#l34.267"></a><span id="l34.267" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l34.268"></a><span id="l34.268" class="difflineminus">-nsMessengerBootstrap::GetHelpInfo(nsACString&amp; aResult)</span>
<a href="#l34.269"></a><span id="l34.269" class="difflineminus">-{</span>
<a href="#l34.270"></a><span id="l34.270" class="difflineminus">-  aResult.Assign(</span>
<a href="#l34.271"></a><span id="l34.271" class="difflineminus">-    &quot;  -mail                Open the mail folder view.\n&quot;</span>
<a href="#l34.272"></a><span id="l34.272" class="difflineminus">-#ifndef MOZ_SUITE</span>
<a href="#l34.273"></a><span id="l34.273" class="difflineminus">-    &quot;  -options             Open the options dialog.\n&quot;</span>
<a href="#l34.274"></a><span id="l34.274" class="difflineminus">-#endif</span>
<a href="#l34.275"></a><span id="l34.275" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l34.276"></a><span id="l34.276" class="difflineminus">-    &quot;  -file                Open the specified email file.\n&quot;</span>
<a href="#l34.277"></a><span id="l34.277" class="difflineminus">-#endif</span>
<a href="#l34.278"></a><span id="l34.278" class="difflineminus">-  );</span>
<a href="#l34.279"></a><span id="l34.279" class="difflineminus">-</span>
<a href="#l34.280"></a><span id="l34.280" class="difflineminus">-  return NS_OK;</span>
<a href="#l34.281"></a><span id="l34.281" class="difflineminus">-}</span>
<a href="#l34.282"></a><span id="l34.282" class="difflineminus">-nsresult nsMessengerBootstrap::DiscoverFoldersIfNeeded(nsIMsgFolder *folder)</span>
<a href="#l34.283"></a><span id="l34.283" class="difflineminus">-{</span>
<a href="#l34.284"></a><span id="l34.284" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l34.285"></a><span id="l34.285" class="difflineminus">-  folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l34.286"></a><span id="l34.286" class="difflineminus">-  // check if we've done folder discovery. If not,</span>
<a href="#l34.287"></a><span id="l34.287" class="difflineminus">-  // do it so we'll have a real folder.</span>
<a href="#l34.288"></a><span id="l34.288" class="difflineminus">-  if (!parent)</span>
<a href="#l34.289"></a><span id="l34.289" class="difflineminus">-  {</span>
<a href="#l34.290"></a><span id="l34.290" class="difflineminus">-    nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l34.291"></a><span id="l34.291" class="difflineminus">-    folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l34.292"></a><span id="l34.292" class="difflineminus">-    nsresult rv = server-&gt;GetRootFolder(getter_AddRefs(parent));</span>
<a href="#l34.293"></a><span id="l34.293" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.294"></a><span id="l34.294" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l34.295"></a><span id="l34.295" class="difflineminus">-    parent-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l34.296"></a><span id="l34.296" class="difflineminus">-  }</span>
<a href="#l34.297"></a><span id="l34.297" class="difflineminus">-  return NS_OK;</span>
<a href="#l34.298"></a><span id="l34.298" class="difflineminus">-}</span>
<a href="#l34.299"></a><span id="l34.299" class="difflineminus">-</span>
<a href="#l34.300"></a><span id="l34.300" class="difflineminus">-nsresult nsMessengerBootstrap::OpenMessengerWindowForMessageId(nsCString &amp;folderUri, nsCString &amp;messageId)</span>
<a href="#l34.301"></a><span id="l34.301" class="difflineminus">-{</span>
<a href="#l34.302"></a><span id="l34.302" class="difflineminus">-  nsresult rv;</span>
<a href="#l34.303"></a><span id="l34.303" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l34.304"></a><span id="l34.304" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.305"></a><span id="l34.305" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l34.306"></a><span id="l34.306" class="difflineminus">-  rv = rdf-&gt;GetResource(folderUri, getter_AddRefs(res));</span>
<a href="#l34.307"></a><span id="l34.307" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.308"></a><span id="l34.308" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; containingFolder;</span>
<a href="#l34.309"></a><span id="l34.309" class="difflineminus">-  containingFolder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l34.310"></a><span id="l34.310" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.311"></a><span id="l34.311" class="difflineminus">-  rv = DiscoverFoldersIfNeeded(containingFolder);</span>
<a href="#l34.312"></a><span id="l34.312" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.313"></a><span id="l34.313" class="difflineminus">-  // once we have the folder uri, open the db and search for the message id.</span>
<a href="#l34.314"></a><span id="l34.314" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l34.315"></a><span id="l34.315" class="difflineminus">-  containingFolder-&gt;GetMsgDatabase(getter_AddRefs(msgDB));</span>
<a href="#l34.316"></a><span id="l34.316" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l34.317"></a><span id="l34.317" class="difflineminus">-  if (msgDB)</span>
<a href="#l34.318"></a><span id="l34.318" class="difflineminus">-    msgDB-&gt;GetMsgHdrForMessageID(messageId.get(), getter_AddRefs(msgHdr));</span>
<a href="#l34.319"></a><span id="l34.319" class="difflineminus">-  if (msgHdr)</span>
<a href="#l34.320"></a><span id="l34.320" class="difflineminus">-  {</span>
<a href="#l34.321"></a><span id="l34.321" class="difflineminus">-    nsMsgKey msgKey;</span>
<a href="#l34.322"></a><span id="l34.322" class="difflineminus">-    msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l34.323"></a><span id="l34.323" class="difflineminus">-    rv = OpenMessengerWindowWithUri(&quot;mail:messageWindow&quot;, folderUri.get(), msgKey);  </span>
<a href="#l34.324"></a><span id="l34.324" class="difflineminus">-    return rv;</span>
<a href="#l34.325"></a><span id="l34.325" class="difflineminus">-  }</span>
<a href="#l34.326"></a><span id="l34.326" class="difflineminus">-  return NS_ERROR_FAILURE;</span>
<a href="#l34.327"></a><span id="l34.327" class="difflineminus">-}</span>
<a href="#l34.328"></a><span id="l34.328" class="difflineminus">-</span>
<a href="#l34.329"></a><span id="l34.329"> NS_IMETHODIMP nsMessengerBootstrap::OpenMessengerWindowWithUri(const char *windowType, const char * aFolderURI, nsMsgKey aMessageKey)</span>
<a href="#l34.330"></a><span id="l34.330"> {</span>
<a href="#l34.331"></a><span id="l34.331">   PRBool standAloneMsgWindow = PR_FALSE;</span>
<a href="#l34.332"></a><span id="l34.332">   nsCAutoString chromeUrl(&quot;chrome://messenger/content/&quot;);</span>
<a href="#l34.333"></a><span id="l34.333">   if (windowType &amp;&amp; !strcmp(windowType, &quot;mail:messageWindow&quot;))</span>
<a href="#l34.334"></a><span id="l34.334">   {</span>
<a href="#l34.335"></a><span id="l34.335">     chromeUrl.Append(&quot;messageWindow.xul&quot;);</span>
<a href="#l34.336"></a><span id="l34.336">     standAloneMsgWindow = PR_TRUE;</span>
<a href="#l34.337"></a><span id="l34.337" class="difflineat">@@ -410,76 +117,8 @@ NS_IMETHODIMP nsMessengerBootstrap::Open</span>
<a href="#l34.338"></a><span id="l34.338"> </span>
<a href="#l34.339"></a><span id="l34.339">   // we need to use the &quot;mailnews.reuse_thread_window2&quot; pref</span>
<a href="#l34.340"></a><span id="l34.340">   // to determine if we should open a new window, or use an existing one.</span>
<a href="#l34.341"></a><span id="l34.341">   nsCOMPtr&lt;nsIDOMWindow&gt; newWindow;</span>
<a href="#l34.342"></a><span id="l34.342">   return wwatch-&gt;OpenWindow(0, chromeUrl.get(), &quot;_blank&quot;,</span>
<a href="#l34.343"></a><span id="l34.343">                             &quot;chrome,all,dialog=no&quot;, argsArray,</span>
<a href="#l34.344"></a><span id="l34.344">                              getter_AddRefs(newWindow));</span>
<a href="#l34.345"></a><span id="l34.345"> }</span>
<a href="#l34.346"></a><span id="l34.346" class="difflineminus">-</span>
<a href="#l34.347"></a><span id="l34.347" class="difflineminus">-nsresult</span>
<a href="#l34.348"></a><span id="l34.348" class="difflineminus">-nsMessengerBootstrap::HandleIndexerResult(const nsString &amp;aPath)</span>
<a href="#l34.349"></a><span id="l34.349" class="difflineminus">-{</span>
<a href="#l34.350"></a><span id="l34.350" class="difflineminus">-  nsresult rv;</span>
<a href="#l34.351"></a><span id="l34.351" class="difflineminus">-  // parse file name - get path to containing folder, and message-id of message we're looking for</span>
<a href="#l34.352"></a><span id="l34.352" class="difflineminus">-  // Then, open that message (in a 3-pane window?)</span>
<a href="#l34.353"></a><span id="l34.353" class="difflineminus">-  PRInt32 mozmsgsIndex = aPath.Find(NS_LITERAL_STRING(&quot;.mozmsgs&quot;));</span>
<a href="#l34.354"></a><span id="l34.354" class="difflineminus">-  nsString folderPathStr;</span>
<a href="#l34.355"></a><span id="l34.355" class="difflineminus">-  aPath.Left(folderPathStr, mozmsgsIndex);</span>
<a href="#l34.356"></a><span id="l34.356" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; folderPath;</span>
<a href="#l34.357"></a><span id="l34.357" class="difflineminus">-</span>
<a href="#l34.358"></a><span id="l34.358" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l34.359"></a><span id="l34.359" class="difflineminus">-  // On Mac, the .mozeml files are stored outside the profile in</span>
<a href="#l34.360"></a><span id="l34.360" class="difflineminus">-  // ~/Library/Caches/Metadata.  We have to replace this root with</span>
<a href="#l34.361"></a><span id="l34.361" class="difflineminus">-  // the profile dir, so we can find the actual mail there.  NOTE:</span>
<a href="#l34.362"></a><span id="l34.362" class="difflineminus">-  // this works for profiles not in ~/Library/Thunderbird/Profiles.</span>
<a href="#l34.363"></a><span id="l34.363" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; homeDir;</span>
<a href="#l34.364"></a><span id="l34.364" class="difflineminus">-  rv = NS_GetSpecialDirectory(NS_OS_HOME_DIR, getter_AddRefs(homeDir));</span>
<a href="#l34.365"></a><span id="l34.365" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.366"></a><span id="l34.366" class="difflineminus">-  // TB Spotlight data goes in ~/Library/Caches/Metadata/Thunderbird</span>
<a href="#l34.367"></a><span id="l34.367" class="difflineminus">-  homeDir-&gt;Append(NS_LITERAL_STRING(&quot;Library&quot;));</span>
<a href="#l34.368"></a><span id="l34.368" class="difflineminus">-  homeDir-&gt;Append(NS_LITERAL_STRING(&quot;Caches&quot;));</span>
<a href="#l34.369"></a><span id="l34.369" class="difflineminus">-  homeDir-&gt;Append(NS_LITERAL_STRING(&quot;Metadata&quot;));</span>
<a href="#l34.370"></a><span id="l34.370" class="difflineminus">-  homeDir-&gt;Append(NS_LITERAL_STRING(&quot;Thunderbird&quot;));</span>
<a href="#l34.371"></a><span id="l34.371" class="difflineminus">-  nsAutoString metadataDirStr;</span>
<a href="#l34.372"></a><span id="l34.372" class="difflineminus">-  rv = homeDir-&gt;GetPath(metadataDirStr);</span>
<a href="#l34.373"></a><span id="l34.373" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.374"></a><span id="l34.374" class="difflineminus">-</span>
<a href="#l34.375"></a><span id="l34.375" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; profileDir;</span>
<a href="#l34.376"></a><span id="l34.376" class="difflineminus">-  rv = NS_GetSpecialDirectory(&quot;ProfD&quot;, getter_AddRefs(profileDir));</span>
<a href="#l34.377"></a><span id="l34.377" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.378"></a><span id="l34.378" class="difflineminus">-  nsAutoString profileDirStr;</span>
<a href="#l34.379"></a><span id="l34.379" class="difflineminus">-  rv = profileDir-&gt;GetPath(profileDirStr);</span>
<a href="#l34.380"></a><span id="l34.380" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.381"></a><span id="l34.381" class="difflineminus">-</span>
<a href="#l34.382"></a><span id="l34.382" class="difflineminus">-  // Swap the Spotlight metadata root and the profile dir root</span>
<a href="#l34.383"></a><span id="l34.383" class="difflineminus">-  folderPathStr.Replace(0, metadataDirStr.Length(), profileDirStr); </span>
<a href="#l34.384"></a><span id="l34.384" class="difflineminus">-</span>
<a href="#l34.385"></a><span id="l34.385" class="difflineminus">-  folderPath = do_CreateInstance(&quot;@mozilla.org/file/local;1&quot;, &amp;rv);</span>
<a href="#l34.386"></a><span id="l34.386" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.387"></a><span id="l34.387" class="difflineminus">-  rv = folderPath-&gt;InitWithPath(folderPathStr);</span>
<a href="#l34.388"></a><span id="l34.388" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.389"></a><span id="l34.389" class="difflineminus">-#endif</span>
<a href="#l34.390"></a><span id="l34.390" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l34.391"></a><span id="l34.391" class="difflineminus">-  // Get the nsILocalFile for this path</span>
<a href="#l34.392"></a><span id="l34.392" class="difflineminus">-  folderPath = do_CreateInstance(&quot;@mozilla.org/file/local;1&quot;, &amp;rv);</span>
<a href="#l34.393"></a><span id="l34.393" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.394"></a><span id="l34.394" class="difflineminus">-  rv = folderPath-&gt;InitWithPath(folderPathStr);</span>
<a href="#l34.395"></a><span id="l34.395" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.396"></a><span id="l34.396" class="difflineminus">-#endif</span>
<a href="#l34.397"></a><span id="l34.397" class="difflineminus">-</span>
<a href="#l34.398"></a><span id="l34.398" class="difflineminus">-  nsCString folderUri;</span>
<a href="#l34.399"></a><span id="l34.399" class="difflineminus">-  rv = FolderUriFromDirInProfile(folderPath, folderUri);</span>
<a href="#l34.400"></a><span id="l34.400" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.401"></a><span id="l34.401" class="difflineminus">-</span>
<a href="#l34.402"></a><span id="l34.402" class="difflineminus">-  nsAutoString unicodeMessageId;</span>
<a href="#l34.403"></a><span id="l34.403" class="difflineminus">-  // strip off .mozeml/.wdseml at the end as well</span>
<a href="#l34.404"></a><span id="l34.404" class="difflineminus">-  aPath.Mid(unicodeMessageId, mozmsgsIndex + 9, aPath.Length() - (mozmsgsIndex + 9 + 7));</span>
<a href="#l34.405"></a><span id="l34.405" class="difflineminus">-  nsCAutoString escapedMessageId;</span>
<a href="#l34.406"></a><span id="l34.406" class="difflineminus">-  NS_CopyUnicodeToNative(unicodeMessageId, escapedMessageId);</span>
<a href="#l34.407"></a><span id="l34.407" class="difflineminus">-</span>
<a href="#l34.408"></a><span id="l34.408" class="difflineminus">-  // unescape messageId</span>
<a href="#l34.409"></a><span id="l34.409" class="difflineminus">-  nsCAutoString messageId;</span>
<a href="#l34.410"></a><span id="l34.410" class="difflineminus">-  messageId = NS_UnescapeURL(escapedMessageId, esc_Minimal, messageId);</span>
<a href="#l34.411"></a><span id="l34.411" class="difflineminus">-</span>
<a href="#l34.412"></a><span id="l34.412" class="difflineminus">-  return OpenMessengerWindowForMessageId(folderUri, messageId);</span>
<a href="#l34.413"></a><span id="l34.413" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerBootstrap.h</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerBootstrap.h</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -35,38 +35,27 @@</span>
<a href="#l35.4"></a><span id="l35.4">  *</span>
<a href="#l35.5"></a><span id="l35.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l35.6"></a><span id="l35.6"> </span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8"> #ifndef __nsMessenger_h</span>
<a href="#l35.9"></a><span id="l35.9"> #define __nsMessenger_h</span>
<a href="#l35.10"></a><span id="l35.10"> </span>
<a href="#l35.11"></a><span id="l35.11"> #include &quot;nscore.h&quot;</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l35.13"></a><span id="l35.13"> #include &quot;nsIMessengerWindowService.h&quot;</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-#include &quot;nsICommandLineHandler.h&quot;</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineminus">-</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineminus">-class nsIMsgFolder;</span>
<a href="#l35.18"></a><span id="l35.18"> </span>
<a href="#l35.19"></a><span id="l35.19"> #define NS_MESSENGERBOOTSTRAP_CID                 \</span>
<a href="#l35.20"></a><span id="l35.20"> { /* 4a85a5d0-cddd-11d2-b7f6-00805f05ffa5 */      \</span>
<a href="#l35.21"></a><span id="l35.21">   0x4a85a5d0, 0xcddd, 0x11d2,                     \</span>
<a href="#l35.22"></a><span id="l35.22">   {0xb7, 0xf6, 0x00, 0x80, 0x5f, 0x05, 0xff, 0xa5}}</span>
<a href="#l35.23"></a><span id="l35.23"> </span>
<a href="#l35.24"></a><span id="l35.24"> class nsMessengerBootstrap :</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineminus">-    public nsICommandLineHandler,</span>
<a href="#l35.26"></a><span id="l35.26">     public nsIMessengerWindowService</span>
<a href="#l35.27"></a><span id="l35.27"> {</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineminus">-  </span>
<a href="#l35.29"></a><span id="l35.29"> public:</span>
<a href="#l35.30"></a><span id="l35.30">   nsMessengerBootstrap();</span>
<a href="#l35.31"></a><span id="l35.31">   virtual ~nsMessengerBootstrap();</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-  nsresult DiscoverFoldersIfNeeded(nsIMsgFolder *folder);</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-  nsresult OpenMessengerWindowForMessageId(nsCString &amp;folderUri, nsCString &amp;messageId);</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">-  nsresult HandleIndexerResult(const nsString &amp;aPath);</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineminus">-  </span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+</span>
<a href="#l35.37"></a><span id="l35.37">   NS_DECL_ISUPPORTS  </span>
<a href="#l35.38"></a><span id="l35.38">   NS_DECL_NSIMESSENGERWINDOWSERVICE</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineminus">-  NS_DECL_NSICOMMANDLINEHANDLER</span>
<a href="#l35.40"></a><span id="l35.40"> };</span>
<a href="#l35.41"></a><span id="l35.41"> </span>
<a href="#l35.42"></a><span id="l35.42"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/base/test/unit/test_jsTreeSelection.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_jsTreeSelection.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -136,16 +136,22 @@ function run_test() {</span>
<a href="#l36.4"></a><span id="l36.4">   aci(2);</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6">   // -- clearSelection</span>
<a href="#l36.7"></a><span id="l36.7">   sel.clearSelection();</span>
<a href="#l36.8"></a><span id="l36.8">   asr();</span>
<a href="#l36.9"></a><span id="l36.9">   aci(2); // should still be the same...</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11">   // -- toggleSelect</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+  // start from nothing</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+  sel.clearSelection();</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+  sel.toggleSelect(1);</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+  asr([1, 1]);</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+  aci(1);</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+</span>
<a href="#l36.18"></a><span id="l36.18">   // lower fusion</span>
<a href="#l36.19"></a><span id="l36.19">   sel.select(2);</span>
<a href="#l36.20"></a><span id="l36.20">   sel.toggleSelect(1);</span>
<a href="#l36.21"></a><span id="l36.21">   asr([1, 2]);</span>
<a href="#l36.22"></a><span id="l36.22">   aci(1);</span>
<a href="#l36.23"></a><span id="l36.23"> </span>
<a href="#l36.24"></a><span id="l36.24">   // upper fusion</span>
<a href="#l36.25"></a><span id="l36.25">   sel.toggleSelect(3);</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineat">@@ -436,9 +442,38 @@ function run_test() {</span>
<a href="#l36.27"></a><span id="l36.27">   aci(-1);</span>
<a href="#l36.28"></a><span id="l36.28"> </span>
<a href="#l36.29"></a><span id="l36.29">   // broad nuke due to removal</span>
<a href="#l36.30"></a><span id="l36.30">   sel.rangedSelect(5, 10, false);</span>
<a href="#l36.31"></a><span id="l36.31">   sel.adjustSelection(0, -20);</span>
<a href="#l36.32"></a><span id="l36.32">   asr();</span>
<a href="#l36.33"></a><span id="l36.33">   asp(-1);</span>
<a href="#l36.34"></a><span id="l36.34">   aci(-1);</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineminus">-}</span>
<a href="#l36.36"></a><span id="l36.36">\ No newline at end of file</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineplus">+</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineplus">+  // duplicateSelection (please keep this right at the end, as this modifies</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineplus">+  // sel)</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineplus">+  // no guarantees for the shift pivot yet, so don't test that</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineplus">+  let oldSel = sel;</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+  let newSel = new JSTreeSelection(fakeBox);</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+  // multiple selections</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+  oldSel.rangedSelect(1, 3, false);</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+  oldSel.rangedSelect(5, 5, true);</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+  oldSel.rangedSelect(10, 10, true);</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineplus">+  oldSel.rangedSelect(6, 7, true);</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineplus">+</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+  oldSel.duplicateSelection(newSel);</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineplus">+  // from now on we're only going to be checking newSel</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+  sel = newSel;</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+  asr([1, 3], [5, 7], [10, 10]);</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+  aci(7);</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+  // single selection</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+  oldSel.select(4);</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineplus">+  oldSel.duplicateSelection(newSel);</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+  asr([4, 4]);</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+  aci(4);</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+  // nothing selected</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+  oldSel.clearSelection();</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineplus">+  oldSel.duplicateSelection(newSel);</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+  asr();</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+  aci(4);</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/base/util/jsTreeSelection.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/base/util/jsTreeSelection.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -183,17 +183,22 @@ JSTreeSelection.prototype = {</span>
<a href="#l37.4"></a><span id="l37.4">   },</span>
<a href="#l37.5"></a><span id="l37.5"> </span>
<a href="#l37.6"></a><span id="l37.6">   timedSelect: function JSTreeSelection_timedSelect(aIndex, aDelay) {</span>
<a href="#l37.7"></a><span id="l37.7">     throw new Error(&quot;We do not implement timed selection.&quot;);</span>
<a href="#l37.8"></a><span id="l37.8">   },</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10">   toggleSelect: function JSTreeSelection_toggleSelect(aIndex) {</span>
<a href="#l37.11"></a><span id="l37.11">     this.currentIndex = aIndex;</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-    for each (let [iTupe, [low, high]] in Iterator(this._ranges)) {</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+    // If nothing's selected, select aIndex</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+    if (this._count == 0) {</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+      this._count = 1;</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+      this._ranges = [[aIndex, aIndex]];</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+    }</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+    else for each (let [iTupe, [low, high]] in Iterator(this._ranges)) {</span>
<a href="#l37.19"></a><span id="l37.19">       // below the range? add it to the existing range or create a new one</span>
<a href="#l37.20"></a><span id="l37.20">       if (aIndex &lt; low) {</span>
<a href="#l37.21"></a><span id="l37.21">         this._count++;</span>
<a href="#l37.22"></a><span id="l37.22">         // is it just below an existing range? (range fusion only happens in the</span>
<a href="#l37.23"></a><span id="l37.23">         //  high case, not here.)</span>
<a href="#l37.24"></a><span id="l37.24">         if (aIndex == low - 1) {</span>
<a href="#l37.25"></a><span id="l37.25">           this._ranges[iTupe][0] = aIndex;</span>
<a href="#l37.26"></a><span id="l37.26">           break;</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineat">@@ -612,21 +617,24 @@ JSTreeSelection.prototype = {</span>
<a href="#l37.28"></a><span id="l37.28">    */</span>
<a href="#l37.29"></a><span id="l37.29">   _fireSelectionChanged: function JSTreeSelection__fireSelectionChanged() {</span>
<a href="#l37.30"></a><span id="l37.30">     // don't fire if we are suppressed; we will fire when un-suppressed</span>
<a href="#l37.31"></a><span id="l37.31">     if (this.selectEventsSuppressed)</span>
<a href="#l37.32"></a><span id="l37.32">       return;</span>
<a href="#l37.33"></a><span id="l37.33">     let view;</span>
<a href="#l37.34"></a><span id="l37.34">     if (this._treeBoxObject &amp;&amp; this._treeBoxObject.view)</span>
<a href="#l37.35"></a><span id="l37.35">       view = this._treeBoxObject.view;</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineminus">-    else </span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+    else</span>
<a href="#l37.38"></a><span id="l37.38">       view = this._view;</span>
<a href="#l37.39"></a><span id="l37.39"> </span>
<a href="#l37.40"></a><span id="l37.40" class="difflineminus">-    view = view.QueryInterface(Ci.nsITreeView);</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineminus">-    view.selectionChanged();</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+    // We might not have a view if we're in the middle of setting up things</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineplus">+    if (view) {</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+      view = view.QueryInterface(Ci.nsITreeView);</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineplus">+      view.selectionChanged();</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineplus">+    }</span>
<a href="#l37.47"></a><span id="l37.47">   },</span>
<a href="#l37.48"></a><span id="l37.48"> </span>
<a href="#l37.49"></a><span id="l37.49">   get currentIndex JSTreeSelection_get_currentIndex() {</span>
<a href="#l37.50"></a><span id="l37.50">     if (this._currentIndex == null)</span>
<a href="#l37.51"></a><span id="l37.51">       return -1;</span>
<a href="#l37.52"></a><span id="l37.52">     return this._currentIndex;</span>
<a href="#l37.53"></a><span id="l37.53">   },</span>
<a href="#l37.54"></a><span id="l37.54">   /**</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineat">@@ -646,9 +654,34 @@ JSTreeSelection.prototype = {</span>
<a href="#l37.56"></a><span id="l37.56">   currentColumn: null,</span>
<a href="#l37.57"></a><span id="l37.57"> </span>
<a href="#l37.58"></a><span id="l37.58">   get shiftSelectPivot JSTreeSelection_get_shiftSelectPivot() {</span>
<a href="#l37.59"></a><span id="l37.59">     return this._shiftSelectPivot != null ? this._shiftSelectPivot : -1;</span>
<a href="#l37.60"></a><span id="l37.60">   },</span>
<a href="#l37.61"></a><span id="l37.61"> </span>
<a href="#l37.62"></a><span id="l37.62">   QueryInterface: XPCOMUtils.generateQI(</span>
<a href="#l37.63"></a><span id="l37.63">     [Ci.nsITreeSelection]),</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineplus">+</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineplus">+  /*</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineplus">+   * Functions after this aren't part of the nsITreeSelection interface.</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineplus">+   */</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineplus">+</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineplus">+  /**</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineplus">+   * Duplicate this selection on another nsITreeSelection. This is useful</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineplus">+   * when you would like to discard this selection for a real tree selection.</span>
<a href="#l37.72"></a><span id="l37.72" class="difflineplus">+   * We assume that both selections are for the same tree.</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineplus">+   *</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineplus">+   * @note We don't transfer the correct shiftSelectPivot over.</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineplus">+   * @note This will fire a selectionChanged event on the tree view.</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineplus">+   *</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineplus">+   * @param aSelection an nsITreeSelection to duplicate this selection onto</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineplus">+   */</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineplus">+  duplicateSelection: function JSTreeSelection_duplicateSelection(aSelection) {</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineplus">+    aSelection.selectEventsSuppressed = true;</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineplus">+    aSelection.clearSelection();</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineplus">+    for each (let [iTupe, [low, high]] in Iterator(this._ranges))</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineplus">+      aSelection.rangedSelect(low, high, iTupe &gt; 0);</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineplus">+</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineplus">+    aSelection.currentIndex = this.currentIndex;</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineplus">+    // This will fire a selectionChanged event</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineplus">+    aSelection.selectEventsSuppressed = false;</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineplus">+  },</span>
<a href="#l37.89"></a><span id="l37.89"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -622,19 +622,16 @@ static NS_METHOD</span>
<a href="#l38.4"></a><span id="l38.4"> RegisterCommandLineHandlers(nsIComponentManager* compMgr, nsIFile* path,</span>
<a href="#l38.5"></a><span id="l38.5">                             const char *location, const char *type,</span>
<a href="#l38.6"></a><span id="l38.6">                             const nsModuleComponentInfo *info)</span>
<a href="#l38.7"></a><span id="l38.7"> {</span>
<a href="#l38.8"></a><span id="l38.8">   nsresult rv;</span>
<a href="#l38.9"></a><span id="l38.9">   nsCOMPtr&lt;nsICategoryManager&gt; catMan (do_GetService(NS_CATEGORYMANAGER_CONTRACTID));</span>
<a href="#l38.10"></a><span id="l38.10">   NS_ENSURE_TRUE(catMan, NS_ERROR_FAILURE);</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-  rv  = catMan-&gt;AddCategoryEntry(&quot;command-line-handler&quot;, &quot;m-mail&quot;,</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-                                 NS_MESSENGERBOOTSTRAP_CONTRACTID,</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-                                 PR_TRUE, PR_TRUE, nsnull);</span>
<a href="#l38.15"></a><span id="l38.15">   rv |= catMan-&gt;AddCategoryEntry(&quot;command-line-handler&quot;, &quot;m-addressbook&quot;,</span>
<a href="#l38.16"></a><span id="l38.16">                                  NS_ABMANAGER_CONTRACTID,</span>
<a href="#l38.17"></a><span id="l38.17">                                  PR_TRUE, PR_TRUE, nsnull);</span>
<a href="#l38.18"></a><span id="l38.18">   rv |= catMan-&gt;AddCategoryEntry(&quot;command-line-handler&quot;, &quot;m-compose&quot;,</span>
<a href="#l38.19"></a><span id="l38.19">                                  NS_MSGCOMPOSESERVICE_CONTRACTID,</span>
<a href="#l38.20"></a><span id="l38.20">                                  PR_TRUE, PR_TRUE, nsnull);</span>
<a href="#l38.21"></a><span id="l38.21">   rv |= catMan-&gt;AddCategoryEntry(&quot;command-line-handler&quot;, &quot;m-news&quot;,</span>
<a href="#l38.22"></a><span id="l38.22">                                  NS_NNTPSERVICE_CONTRACTID,</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineat">@@ -648,18 +645,16 @@ RegisterCommandLineHandlers(nsIComponent</span>
<a href="#l38.24"></a><span id="l38.24"> static NS_METHOD</span>
<a href="#l38.25"></a><span id="l38.25"> UnregisterCommandLineHandlers(nsIComponentManager* compMgr, nsIFile* path,</span>
<a href="#l38.26"></a><span id="l38.26">                               const char *location,</span>
<a href="#l38.27"></a><span id="l38.27">                               const nsModuleComponentInfo *info)</span>
<a href="#l38.28"></a><span id="l38.28"> {</span>
<a href="#l38.29"></a><span id="l38.29">   nsCOMPtr&lt;nsICategoryManager&gt; catMan (do_GetService(NS_CATEGORYMANAGER_CONTRACTID));</span>
<a href="#l38.30"></a><span id="l38.30">   NS_ENSURE_TRUE(catMan, NS_ERROR_FAILURE);</span>
<a href="#l38.31"></a><span id="l38.31"> </span>
<a href="#l38.32"></a><span id="l38.32" class="difflineminus">-  catMan-&gt;DeleteCategoryEntry(&quot;command-line-handler&quot;, &quot;m-mail&quot;,</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-                              PR_TRUE);</span>
<a href="#l38.34"></a><span id="l38.34">   catMan-&gt;DeleteCategoryEntry(&quot;command-line-handler&quot;, &quot;m-addressbook&quot;,</span>
<a href="#l38.35"></a><span id="l38.35">                               PR_TRUE);</span>
<a href="#l38.36"></a><span id="l38.36">   catMan-&gt;DeleteCategoryEntry(&quot;command-line-handler&quot;, &quot;m-compose&quot;,</span>
<a href="#l38.37"></a><span id="l38.37">                               PR_TRUE);</span>
<a href="#l38.38"></a><span id="l38.38">   catMan-&gt;DeleteCategoryEntry(&quot;command-line-handler&quot;, &quot;m-news&quot;,</span>
<a href="#l38.39"></a><span id="l38.39">                               PR_TRUE);</span>
<a href="#l38.40"></a><span id="l38.40"> </span>
<a href="#l38.41"></a><span id="l38.41">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -387,17 +387,20 @@ pref(&quot;ldap_2.version&quot;, 3); /* Update kCu</span>
<a href="#l39.4"></a><span id="l39.4"> pref(&quot;mailnews.confirm.moveFoldersToTrash&quot;, true);</span>
<a href="#l39.5"></a><span id="l39.5"> </span>
<a href="#l39.6"></a><span id="l39.6"> // space-delimited list of extra headers to add to .msf file</span>
<a href="#l39.7"></a><span id="l39.7"> pref(&quot;mailnews.customDBHeaders&quot;, &quot;&quot;);</span>
<a href="#l39.8"></a><span id="l39.8"> </span>
<a href="#l39.9"></a><span id="l39.9"> // close standalone message window when deleting the displayed message</span>
<a href="#l39.10"></a><span id="l39.10"> pref(&quot;mail.close_message_window.on_delete&quot;, false);</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+#ifdef MOZ_SUITE</span>
<a href="#l39.13"></a><span id="l39.13"> pref(&quot;mailnews.reuse_message_window&quot;, true);</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+#endif</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+</span>
<a href="#l39.16"></a><span id="l39.16"> pref(&quot;mailnews.reuse_thread_window2&quot;, false);</span>
<a href="#l39.17"></a><span id="l39.17"> pref(&quot;mailnews.open_window_warning&quot;, 10); // warn user if they attempt to open more than this many messages at once</span>
<a href="#l39.18"></a><span id="l39.18"> </span>
<a href="#l39.19"></a><span id="l39.19"> pref(&quot;mailnews.start_page.enabled&quot;, true);</span>
<a href="#l39.20"></a><span id="l39.20"> </span>
<a href="#l39.21"></a><span id="l39.21"> pref(&quot;mailnews.remember_selected_message&quot;, true);</span>
<a href="#l39.22"></a><span id="l39.22"> pref(&quot;mailnews.scroll_to_new_message&quot;, true);</span>
<a href="#l39.23"></a><span id="l39.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/suite/installer/unix/packages</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/suite/installer/unix/packages</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -490,16 +490,17 @@ bin/components/msgnews.xpt</span>
<a href="#l40.4"></a><span id="l40.4"> bin/components/msgsearch.xpt</span>
<a href="#l40.5"></a><span id="l40.5"> bin/components/msgsmime.xpt</span>
<a href="#l40.6"></a><span id="l40.6"> ; JS components</span>
<a href="#l40.7"></a><span id="l40.7"> bin/components/mdn-service.js</span>
<a href="#l40.8"></a><span id="l40.8"> bin/components/newsblog.js</span>
<a href="#l40.9"></a><span id="l40.9"> bin/components/nsAbAutoCompleteMyDomain.js</span>
<a href="#l40.10"></a><span id="l40.10"> bin/components/nsAbAutoCompleteSearch.js</span>
<a href="#l40.11"></a><span id="l40.11"> bin/components/nsAbLDAPAttributeMap.js</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+bin/components/nsMailNewsCommandLineHandler.js</span>
<a href="#l40.13"></a><span id="l40.13"> bin/components/nsMsgTraitService.js</span>
<a href="#l40.14"></a><span id="l40.14"> bin/components/nsSMTPProtocolHandler.js</span>
<a href="#l40.15"></a><span id="l40.15"> bin/components/offlineStartup.js</span>
<a href="#l40.16"></a><span id="l40.16"> bin/components/smime-service.js</span>
<a href="#l40.17"></a><span id="l40.17"> </span>
<a href="#l40.18"></a><span id="l40.18"> bin/chrome/messenger.jar</span>
<a href="#l40.19"></a><span id="l40.19"> bin/chrome/messenger.manifest</span>
<a href="#l40.20"></a><span id="l40.20"> bin/chrome/newsblog.jar</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/suite/installer/windows/packages</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/suite/installer/windows/packages</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -468,16 +468,17 @@ bin\components\msgnews.xpt</span>
<a href="#l41.4"></a><span id="l41.4"> bin\components\msgsearch.xpt</span>
<a href="#l41.5"></a><span id="l41.5"> bin\components\msgsmime.xpt</span>
<a href="#l41.6"></a><span id="l41.6"> ; JS components</span>
<a href="#l41.7"></a><span id="l41.7"> bin\components\mdn-service.js</span>
<a href="#l41.8"></a><span id="l41.8"> bin\components\newsblog.js</span>
<a href="#l41.9"></a><span id="l41.9"> bin\components\nsAbAutoCompleteMyDomain.js</span>
<a href="#l41.10"></a><span id="l41.10"> bin\components\nsAbAutoCompleteSearch.js</span>
<a href="#l41.11"></a><span id="l41.11"> bin\components\nsAbLDAPAttributeMap.js</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+bin\components\nsMailNewsCommandLineHandler.js</span>
<a href="#l41.13"></a><span id="l41.13"> bin\components\nsMsgTraitService.js</span>
<a href="#l41.14"></a><span id="l41.14"> bin\components\nsSMTPProtocolHandler.js</span>
<a href="#l41.15"></a><span id="l41.15"> bin\components\offlineStartup.js</span>
<a href="#l41.16"></a><span id="l41.16"> bin\components\smime-service.js</span>
<a href="#l41.17"></a><span id="l41.17"> </span>
<a href="#l41.18"></a><span id="l41.18"> ; chrome</span>
<a href="#l41.19"></a><span id="l41.19"> bin\chrome\messenger.jar</span>
<a href="#l41.20"></a><span id="l41.20"> bin\chrome\messenger.manifest</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/suite/mailnews/Makefile.in</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/suite/mailnews/Makefile.in</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -36,9 +36,13 @@</span>
<a href="#l42.4"></a><span id="l42.4"> #</span>
<a href="#l42.5"></a><span id="l42.5"> # ***** END LICENSE BLOCK *****</span>
<a href="#l42.6"></a><span id="l42.6"> </span>
<a href="#l42.7"></a><span id="l42.7"> DEPTH=../..</span>
<a href="#l42.8"></a><span id="l42.8"> topsrcdir=@top_srcdir@</span>
<a href="#l42.9"></a><span id="l42.9"> srcdir=@srcdir@</span>
<a href="#l42.10"></a><span id="l42.10"> VPATH=@srcdir@</span>
<a href="#l42.11"></a><span id="l42.11"> </span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+DIRS = modules</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+</span>
<a href="#l42.16"></a><span id="l42.16"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">new file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineminus">--- /dev/null</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineplus">+++ b/suite/mailnews/modules/MailUtils.js</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineat">@@ -0,0 +1,126 @@</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l43.6"></a><span id="l43.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l43.7"></a><span id="l43.7" class="difflineplus">+ *</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l43.10"></a><span id="l43.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l43.11"></a><span id="l43.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+ *</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+ * License.</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+ *</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+ *</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineplus">+ *</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineplus">+ *</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l43.39"></a><span id="l43.39" class="difflineplus">+ *</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineplus">+</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;MailUtils&quot;];</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineplus">+</span>
<a href="#l43.44"></a><span id="l43.44" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l43.46"></a><span id="l43.46" class="difflineplus">+</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l43.48"></a><span id="l43.48" class="difflineplus">+</span>
<a href="#l43.49"></a><span id="l43.49" class="difflineplus">+/**</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineplus">+ * This module has several utility functions for use by both core and</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineplus">+ * third-party code. Some functions are aimed at code that doesn't have a</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineplus">+ * window context, while others can be used anywhere.</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineplus">+ */</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineplus">+var MailUtils =</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineplus">+{</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineplus">+  /**</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineplus">+   * Discover all folders. This is useful during startup, when you have code</span>
<a href="#l43.58"></a><span id="l43.58" class="difflineplus">+   * that deals with folders and that executes before the main 3pane window is</span>
<a href="#l43.59"></a><span id="l43.59" class="difflineplus">+   * open (the folder tree wouldn't have been initialized yet).</span>
<a href="#l43.60"></a><span id="l43.60" class="difflineplus">+   */</span>
<a href="#l43.61"></a><span id="l43.61" class="difflineplus">+  discoverFolders: function MailUtils_discoverFolders()</span>
<a href="#l43.62"></a><span id="l43.62" class="difflineplus">+  {</span>
<a href="#l43.63"></a><span id="l43.63" class="difflineplus">+    let accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l43.64"></a><span id="l43.64" class="difflineplus">+                           .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l43.65"></a><span id="l43.65" class="difflineplus">+    let servers = accountManager.allServers;</span>
<a href="#l43.66"></a><span id="l43.66" class="difflineplus">+    for each (let server in fixIterator(servers, Ci.nsIMsgIncomingServer))</span>
<a href="#l43.67"></a><span id="l43.67" class="difflineplus">+      server.rootFolder.subFolders;</span>
<a href="#l43.68"></a><span id="l43.68" class="difflineplus">+  },</span>
<a href="#l43.69"></a><span id="l43.69" class="difflineplus">+</span>
<a href="#l43.70"></a><span id="l43.70" class="difflineplus">+  /**</span>
<a href="#l43.71"></a><span id="l43.71" class="difflineplus">+   * Get the nsIMsgFolder corresponding to this URI. This uses the RDF service</span>
<a href="#l43.72"></a><span id="l43.72" class="difflineplus">+   * to do the work.</span>
<a href="#l43.73"></a><span id="l43.73" class="difflineplus">+   *</span>
<a href="#l43.74"></a><span id="l43.74" class="difflineplus">+   * @param aFolderURI the URI to convert into a folder</span>
<a href="#l43.75"></a><span id="l43.75" class="difflineplus">+   * @param aCheckFolderAttributes whether to check that the folder either has</span>
<a href="#l43.76"></a><span id="l43.76" class="difflineplus">+   *                              a parent or isn't a server</span>
<a href="#l43.77"></a><span id="l43.77" class="difflineplus">+   * @returns the nsIMsgFolder corresponding to this URI, or null if</span>
<a href="#l43.78"></a><span id="l43.78" class="difflineplus">+   *          aCheckFolderAttributes is true and the folder doesn't have a</span>
<a href="#l43.79"></a><span id="l43.79" class="difflineplus">+   *          parent or is a server</span>
<a href="#l43.80"></a><span id="l43.80" class="difflineplus">+   */</span>
<a href="#l43.81"></a><span id="l43.81" class="difflineplus">+  getFolderForURI: function MailUtils_getFolderForURI(aFolderURI,</span>
<a href="#l43.82"></a><span id="l43.82" class="difflineplus">+                       aCheckFolderAttributes)</span>
<a href="#l43.83"></a><span id="l43.83" class="difflineplus">+  {</span>
<a href="#l43.84"></a><span id="l43.84" class="difflineplus">+    let folder = null;</span>
<a href="#l43.85"></a><span id="l43.85" class="difflineplus">+    let rdfService = Cc['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l43.86"></a><span id="l43.86" class="difflineplus">+                       .getService(Ci.nsIRDFService);</span>
<a href="#l43.87"></a><span id="l43.87" class="difflineplus">+    folder = rdfService.GetResource(aFolderURI);</span>
<a href="#l43.88"></a><span id="l43.88" class="difflineplus">+    // This is going to QI the folder to an nsIMsgFolder as well</span>
<a href="#l43.89"></a><span id="l43.89" class="difflineplus">+    if (folder &amp;&amp; folder instanceof Ci.nsIMsgFolder)</span>
<a href="#l43.90"></a><span id="l43.90" class="difflineplus">+    {</span>
<a href="#l43.91"></a><span id="l43.91" class="difflineplus">+      if (aCheckFolderAttributes &amp;&amp; !(folder.parent || folder.isServer))</span>
<a href="#l43.92"></a><span id="l43.92" class="difflineplus">+        return null;</span>
<a href="#l43.93"></a><span id="l43.93" class="difflineplus">+    }</span>
<a href="#l43.94"></a><span id="l43.94" class="difflineplus">+    else</span>
<a href="#l43.95"></a><span id="l43.95" class="difflineplus">+    {</span>
<a href="#l43.96"></a><span id="l43.96" class="difflineplus">+      return null;</span>
<a href="#l43.97"></a><span id="l43.97" class="difflineplus">+    }</span>
<a href="#l43.98"></a><span id="l43.98" class="difflineplus">+</span>
<a href="#l43.99"></a><span id="l43.99" class="difflineplus">+    return folder;</span>
<a href="#l43.100"></a><span id="l43.100" class="difflineplus">+  },</span>
<a href="#l43.101"></a><span id="l43.101" class="difflineplus">+</span>
<a href="#l43.102"></a><span id="l43.102" class="difflineplus">+  /**</span>
<a href="#l43.103"></a><span id="l43.103" class="difflineplus">+   * Displays this message in a new window.</span>
<a href="#l43.104"></a><span id="l43.104" class="difflineplus">+   *</span>
<a href="#l43.105"></a><span id="l43.105" class="difflineplus">+   * @param aMsgHdr the message header to display</span>
<a href="#l43.106"></a><span id="l43.106" class="difflineplus">+   */</span>
<a href="#l43.107"></a><span id="l43.107" class="difflineplus">+  displayMessage: function MailUtils_displayMessage(aMsgHdr)</span>
<a href="#l43.108"></a><span id="l43.108" class="difflineplus">+  {</span>
<a href="#l43.109"></a><span id="l43.109" class="difflineplus">+    this.openMessageInNewWindow(aMsgHdr);</span>
<a href="#l43.110"></a><span id="l43.110" class="difflineplus">+  },</span>
<a href="#l43.111"></a><span id="l43.111" class="difflineplus">+</span>
<a href="#l43.112"></a><span id="l43.112" class="difflineplus">+  /**</span>
<a href="#l43.113"></a><span id="l43.113" class="difflineplus">+   * Open a new standalone message window with this header.</span>
<a href="#l43.114"></a><span id="l43.114" class="difflineplus">+   *</span>
<a href="#l43.115"></a><span id="l43.115" class="difflineplus">+   * @param aMsgHdr the message header to display</span>
<a href="#l43.116"></a><span id="l43.116" class="difflineplus">+   */</span>
<a href="#l43.117"></a><span id="l43.117" class="difflineplus">+  openMessageInNewWindow: function MailUtils_openMessageInNewWindow(aMsgHdr)</span>
<a href="#l43.118"></a><span id="l43.118" class="difflineplus">+  {</span>
<a href="#l43.119"></a><span id="l43.119" class="difflineplus">+    // Pass in the message URI as messageWindow.js doesn't handle message headers</span>
<a href="#l43.120"></a><span id="l43.120" class="difflineplus">+    let messageURI = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l43.121"></a><span id="l43.121" class="difflineplus">+                       .createInstance(Ci.nsISupportsString);</span>
<a href="#l43.122"></a><span id="l43.122" class="difflineplus">+    messageURI.data = aMsgHdr.folder.getUriForMsg(aMsgHdr);</span>
<a href="#l43.123"></a><span id="l43.123" class="difflineplus">+</span>
<a href="#l43.124"></a><span id="l43.124" class="difflineplus">+    let windowWatcher = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l43.125"></a><span id="l43.125" class="difflineplus">+                          .getService(Ci.nsIWindowWatcher);</span>
<a href="#l43.126"></a><span id="l43.126" class="difflineplus">+    windowWatcher.openWindow(null,</span>
<a href="#l43.127"></a><span id="l43.127" class="difflineplus">+        &quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l43.128"></a><span id="l43.128" class="difflineplus">+        &quot;all,chrome,dialog=no,status,toolbar&quot;, messageURI);</span>
<a href="#l43.129"></a><span id="l43.129" class="difflineplus">+  }</span>
<a href="#l43.130"></a><span id="l43.130" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1">new file mode 100644</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineminus">--- /dev/null</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineplus">+++ b/suite/mailnews/modules/Makefile.in</span>
<a href="#l44.4"></a><span id="l44.4" class="difflineat">@@ -0,0 +1,49 @@</span>
<a href="#l44.5"></a><span id="l44.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l44.6"></a><span id="l44.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l44.7"></a><span id="l44.7" class="difflineplus">+#</span>
<a href="#l44.8"></a><span id="l44.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l44.9"></a><span id="l44.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+#</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+# License.</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+#</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+# The Original Code is mozilla.org code.</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+#</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+# Mozilla Messaging, Inc.</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineplus">+#</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineplus">+#   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineplus">+#</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineplus">+# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineplus">+# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineplus">+#</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineplus">+</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineplus">+DEPTH     = ../../..</span>
<a href="#l44.43"></a><span id="l44.43" class="difflineplus">+VPATH     = @srcdir@</span>
<a href="#l44.44"></a><span id="l44.44" class="difflineplus">+topsrcdir = @top_srcdir@</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineplus">+srcdir    = @srcdir@</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineplus">+</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineplus">+</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineplus">+EXTRA_JS_MODULES = \</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineplus">+  MailUtils.js \</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineplus">+  $(NULL)</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineplus">+</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/suite/mailnews/widgetglue.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/suite/mailnews/widgetglue.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -42,16 +42,18 @@</span>
<a href="#l45.4"></a><span id="l45.4">  * widget-specific wrapper glue. There should be one function for every</span>
<a href="#l45.5"></a><span id="l45.5">  * widget/menu item, which gets some context (like the current selection)</span>
<a href="#l45.6"></a><span id="l45.6">  * and then calls a function/command in commandglue</span>
<a href="#l45.7"></a><span id="l45.7">  */</span>
<a href="#l45.8"></a><span id="l45.8">  </span>
<a href="#l45.9"></a><span id="l45.9"> //The eventual goal is for this file to go away and its contents to be brought into</span>
<a href="#l45.10"></a><span id="l45.10"> //mailWindowOverlay.js.  This is currently being done.</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/MailUtils.js&quot;);</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+</span>
<a href="#l45.14"></a><span id="l45.14"> //NOTE: gMessengerBundle must be defined and set or this Overlay won't work</span>
<a href="#l45.15"></a><span id="l45.15"> </span>
<a href="#l45.16"></a><span id="l45.16"> function ConvertDOMListToResourceArray(nodeList)</span>
<a href="#l45.17"></a><span id="l45.17"> {</span>
<a href="#l45.18"></a><span id="l45.18">     var result = Components.classes[&quot;@mozilla.org/supports-array;1&quot;].createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l45.19"></a><span id="l45.19"> </span>
<a href="#l45.20"></a><span id="l45.20">     for (var i=0; i&lt;nodeList.length; i++) {</span>
<a href="#l45.21"></a><span id="l45.21">         result.AppendElement(nodeList[i].resource);</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineat">@@ -316,34 +318,19 @@ function MsgSetFolderCharset()</span>
<a href="#l45.23"></a><span id="l45.23"> // attributes (like if there exists a parent or is it a server) is also passed</span>
<a href="#l45.24"></a><span id="l45.24"> // to this routine. Qualifying against those checks would return an existing </span>
<a href="#l45.25"></a><span id="l45.25"> // folder. Callers who don't want to check those attributes will specify the</span>
<a href="#l45.26"></a><span id="l45.26"> // same and then this routine will simply return a msgfolder. This scenario</span>
<a href="#l45.27"></a><span id="l45.27"> // applies to a new imap account creation where special folders are created</span>
<a href="#l45.28"></a><span id="l45.28"> // on demand and hence needs to prior check of existence.</span>
<a href="#l45.29"></a><span id="l45.29"> function GetMsgFolderFromUri(uri, checkFolderAttributes)</span>
<a href="#l45.30"></a><span id="l45.30"> {</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineminus">-    //dump(&quot;GetMsgFolderFromUri of &quot; + uri + &quot;\n&quot;);</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineminus">-    var msgfolder = null;</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineminus">-    try {</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineminus">-        var resource = GetResourceFromUri(uri);</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineminus">-        msgfolder = resource.QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineminus">-        if (checkFolderAttributes) {</span>
<a href="#l45.37"></a><span id="l45.37" class="difflineminus">-            if (!(msgfolder &amp;&amp; (msgfolder.parent || msgfolder.isServer))) {</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineminus">-                msgfolder = null;</span>
<a href="#l45.39"></a><span id="l45.39" class="difflineminus">-            }</span>
<a href="#l45.40"></a><span id="l45.40" class="difflineminus">-        }</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineminus">-    }</span>
<a href="#l45.42"></a><span id="l45.42" class="difflineminus">-    catch (ex) {</span>
<a href="#l45.43"></a><span id="l45.43" class="difflineminus">-        //dump(&quot;failed to get the folder resource\n&quot;);</span>
<a href="#l45.44"></a><span id="l45.44" class="difflineminus">-    }</span>
<a href="#l45.45"></a><span id="l45.45" class="difflineminus">-    return msgfolder;</span>
<a href="#l45.46"></a><span id="l45.46" class="difflineplus">+  return MailUtils.getFolderForURI(uri, checkFolderAttributes);</span>
<a href="#l45.47"></a><span id="l45.47"> }</span>
<a href="#l45.48"></a><span id="l45.48"> </span>
<a href="#l45.49"></a><span id="l45.49"> function GetResourceFromUri(uri)</span>
<a href="#l45.50"></a><span id="l45.50"> {</span>
<a href="#l45.51"></a><span id="l45.51">     var RDF = Components.classes['@mozilla.org/rdf/rdf-service;1'].getService();</span>
<a href="#l45.52"></a><span id="l45.52">     RDF = RDF.QueryInterface(Components.interfaces.nsIRDFService);</span>
<a href="#l45.53"></a><span id="l45.53">     var resource = RDF.GetResource(uri);</span>
<a href="#l45.54"></a><span id="l45.54"> </span>
<a href="#l45.55"></a><span id="l45.55">     return resource;</span>
<a href="#l45.56"></a><span id="l45.56"> }  </span>
<a href="#l45.57"></a><span id="l45.57" class="difflineminus">-</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

