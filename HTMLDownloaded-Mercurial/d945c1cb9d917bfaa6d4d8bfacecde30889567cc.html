<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24854:d945c1cb9d917bfaa6d4d8bfacecde30889567cc</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ d945c1cb9d917bfaa6d4d8bfacecde30889567cc" />
<meta property="og:url" content="/comm-central/rev/d945c1cb9d917bfaa6d4d8bfacecde30889567cc" />
<meta property="og:description" content="Bug 1495101 - remove interface nsISubscribeDataSource and related RDF code. r=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / d945c1cb9d917bfaa6d4d8bfacecde30889567cc 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/d945c1cb9d917bfaa6d4d8bfacecde30889567cc">shortlog</a> |
<a href="/comm-central/log/d945c1cb9d917bfaa6d4d8bfacecde30889567cc">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/d945c1cb9d917bfaa6d4d8bfacecde30889567cc">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/d945c1cb9d917bfaa6d4d8bfacecde30889567cc">files</a> |
changeset |
<a href="/comm-central/raw-rev/d945c1cb9d917bfaa6d4d8bfacecde30889567cc">raw</a>  | <a href="/comm-central/archive/d945c1cb9d917bfaa6d4d8bfacecde30889567cc.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1495101">Bug 1495101</a> - remove interface nsISubscribeDataSource and related RDF code. r=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 28 Sep 2018 17:22:00 +0200</td></tr>

<tr>
 <td>changeset 24854</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/d945c1cb9d917bfaa6d4d8bfacecde30889567cc">d945c1cb9d917bfaa6d4d8bfacecde30889567cc</a></td>
</tr>



<tr>
<td>parent 24853</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2131ecd0173c88f2a080af5c8ce46ecbb36dd272">2131ecd0173c88f2a080af5c8ce46ecbb36dd272</a>
</td>
</tr>

<tr>
<td>child 24855</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/17f0a541d7acf332ba8c503025277932d3b9936b">17f0a541d7acf332ba8c503025277932d3b9936b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=d945c1cb9d917bfaa6d4d8bfacecde30889567cc">14948</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 29 Sep 2018 07:55:42 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@d945c1cb9d91 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d945c1cb9d917bfaa6d4d8bfacecde30889567cc">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d945c1cb9d917bfaa6d4d8bfacecde30889567cc&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d945c1cb9d917bfaa6d4d8bfacecde30889567cc&newProject=comm-central&newRevision=d945c1cb9d917bfaa6d4d8bfacecde30889567cc&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d945c1cb9d917bfaa6d4d8bfacecde30889567cc&newProject=comm-central&newRevision=d945c1cb9d917bfaa6d4d8bfacecde30889567cc&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d945c1cb9d917bfaa6d4d8bfacecde30889567cc&newProject=comm-central&newRevision=d945c1cb9d917bfaa6d4d8bfacecde30889567cc&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1495101">1495101</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1495101">Bug 1495101</a> - remove interface nsISubscribeDataSource and related RDF code. r=jorgk</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/public/nsISubscribableServer.idl">mailnews/base/public/nsISubscribableServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/public/nsISubscribableServer.idl">file</a> |
<a href="/comm-central/annotate/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/public/nsISubscribableServer.idl">annotate</a> |
<a href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/public/nsISubscribableServer.idl">diff</a> |
<a href="/comm-central/comparison/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/public/nsISubscribableServer.idl">comparison</a> |
<a href="/comm-central/log/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/public/nsISubscribableServer.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/public/nsMsgBaseCID.h">mailnews/base/public/nsMsgBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/public/nsMsgBaseCID.h">file</a> |
<a href="/comm-central/annotate/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/public/nsMsgBaseCID.h">annotate</a> |
<a href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/public/nsMsgBaseCID.h">diff</a> |
<a href="/comm-central/comparison/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/public/nsMsgBaseCID.h">comparison</a> |
<a href="/comm-central/log/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/public/nsMsgBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/moz.build">mailnews/base/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/moz.build">file</a> |
<a href="/comm-central/annotate/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/moz.build">annotate</a> |
<a href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/moz.build">diff</a> |
<a href="/comm-central/comparison/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/moz.build">comparison</a> |
<a href="/comm-central/log/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribableServer.cpp">mailnews/base/src/nsSubscribableServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribableServer.cpp">file</a> |
<a href="/comm-central/annotate/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribableServer.cpp">annotate</a> |
<a href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribableServer.cpp">diff</a> |
<a href="/comm-central/comparison/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribableServer.cpp">comparison</a> |
<a href="/comm-central/log/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribableServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribableServer.h">mailnews/base/src/nsSubscribableServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribableServer.h">file</a> |
<a href="/comm-central/annotate/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribableServer.h">annotate</a> |
<a href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribableServer.h">diff</a> |
<a href="/comm-central/comparison/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribableServer.h">comparison</a> |
<a href="/comm-central/log/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribableServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribeDataSource.cpp">mailnews/base/src/nsSubscribeDataSource.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribeDataSource.cpp">diff</a> |
<a href="/comm-central/comparison/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribeDataSource.cpp">comparison</a> |
<a href="/comm-central/log/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribeDataSource.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribeDataSource.h">mailnews/base/src/nsSubscribeDataSource.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribeDataSource.h">diff</a> |
<a href="/comm-central/comparison/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribeDataSource.h">comparison</a> |
<a href="/comm-central/log/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/base/src/nsSubscribeDataSource.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/news/src/nsNntpIncomingServer.cpp">mailnews/news/src/nsNntpIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/news/src/nsNntpIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/news/src/nsNntpIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/news/src/nsNntpIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/news/src/nsNntpIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/news/src/nsNntpIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/news/test/unit/test_internalUris.js">mailnews/news/test/unit/test_internalUris.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/news/test/unit/test_internalUris.js">file</a> |
<a href="/comm-central/annotate/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/news/test/unit/test_internalUris.js">annotate</a> |
<a href="/comm-central/diff/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/news/test/unit/test_internalUris.js">diff</a> |
<a href="/comm-central/comparison/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/news/test/unit/test_internalUris.js">comparison</a> |
<a href="/comm-central/log/d945c1cb9d917bfaa6d4d8bfacecde30889567cc/mailnews/news/test/unit/test_internalUris.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsISubscribableServer.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsISubscribableServer.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -2,26 +2,18 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> interface nsIMsgWindow;</span>
<a href="#l1.11"></a><span id="l1.11"> interface nsIMsgIncomingServer;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-interface nsIRDFResource;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-interface nsIRDFNode;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-interface nsISimpleEnumerator;</span>
<a href="#l1.15"></a><span id="l1.15"> interface nsITreeView;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-[scriptable, uuid(61a08c3a-1dd2-11b2-b64f-c4b2de1cf129)]</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-interface nsISubscribeDataSource : nsISupports {</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-    readonly attribute boolean hasObservers;</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-    void NotifyObservers(in nsIRDFResource subject, in nsIRDFResource property, in nsIRDFNode object, in boolean isAssert, in boolean isChange);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-};</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+interface nsIUTF8StringEnumerator;</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24"> /**</span>
<a href="#l1.25"></a><span id="l1.25">  * A listener to receive notification of the subscribable folders of a server.</span>
<a href="#l1.26"></a><span id="l1.26">  */</span>
<a href="#l1.27"></a><span id="l1.27"> [scriptable, uuid(f337b84a-1dd1-11b2-97c7-fb8b2e3f2280)]</span>
<a href="#l1.28"></a><span id="l1.28"> interface nsISubscribeListener : nsISupports {</span>
<a href="#l1.29"></a><span id="l1.29">   /**</span>
<a href="#l1.30"></a><span id="l1.30">    * The server has finished finding all folders to subscribe to.</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineat">@@ -61,23 +53,22 @@ interface nsISubscribableServer : nsISup</span>
<a href="#l1.32"></a><span id="l1.32">   // if path is null, use the root</span>
<a href="#l1.33"></a><span id="l1.33">   boolean isSubscribed(in AUTF8String path);</span>
<a href="#l1.34"></a><span id="l1.34">   // if path is null, use the root</span>
<a href="#l1.35"></a><span id="l1.35">   boolean isSubscribable(in AUTF8String path);</span>
<a href="#l1.36"></a><span id="l1.36">   // if path is null, use the root</span>
<a href="#l1.37"></a><span id="l1.37">   AString getLeafName(in AUTF8String path);</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39">   /**</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-   * Returns the children underneath the specified uri (path).</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+   * Returns the children uris underneath the specified uri (path).</span>
<a href="#l1.42"></a><span id="l1.42">    *</span>
<a href="#l1.43"></a><span id="l1.43">    * @param  aPath  The server's uri; If this is null or empty, then the</span>
<a href="#l1.44"></a><span id="l1.44">    *                root server uri will be used.</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-   * @return        Enumerator containing the children.</span>
<a href="#l1.46"></a><span id="l1.46">    */</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-  nsISimpleEnumerator getChildren(in AUTF8String aPath);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  nsIUTF8StringEnumerator getChildURIs(in AUTF8String aPath);</span>
<a href="#l1.49"></a><span id="l1.49">   // if path is null, use the root</span>
<a href="#l1.50"></a><span id="l1.50">   AUTF8String getFirstChildURI(in AUTF8String path);</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52">   // for searching</span>
<a href="#l1.53"></a><span id="l1.53">   void setSearchValue(in AString searchValue);</span>
<a href="#l1.54"></a><span id="l1.54">   readonly attribute boolean supportsSubscribeSearch;</span>
<a href="#l1.55"></a><span id="l1.55">   readonly attribute nsITreeView folderView;</span>
<a href="#l1.56"></a><span id="l1.56"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsMsgBaseCID.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsMsgBaseCID.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -241,26 +241,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> //</span>
<a href="#l2.5"></a><span id="l2.5"> #define NS_SUBSCRIBABLESERVER_CONTRACTID \</span>
<a href="#l2.6"></a><span id="l2.6">  &quot;@mozilla.org/messenger/subscribableserver;1&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> #define NS_SUBSCRIBABLESERVER_CID \</span>
<a href="#l2.9"></a><span id="l2.9"> { 0x8510876a, 0x1dd2, 0x11b2,     \</span>
<a href="#l2.10"></a><span id="l2.10"> { 0x82, 0x53, 0x91, 0xf7, 0x1b, 0x34, 0x8a, 0x25 }}</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-//</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-// nsSubscribeDataSource</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-//</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-#define NS_SUBSCRIBEDATASOURCE_CONTRACTID \</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-  NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;subscribe&quot;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-#define NS_SUBSCRIBEDATASOURCE_CID \</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-{ 0x00e89c82, 0x1dd2, 0x11b2,      \</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-{ 0x9a, 0x1c, 0xe7, 0x59, 0x95, 0xd7, 0xd5, 0x95 }}</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-</span>
<a href="#l2.22"></a><span id="l2.22"> #define NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID \</span>
<a href="#l2.23"></a><span id="l2.23">   &quot;@mozilla.org/messenger/localfoldercompactor;1&quot;</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25"> #define NS_MSGLOCALFOLDERCOMPACTOR_CID \</span>
<a href="#l2.26"></a><span id="l2.26"> { 0x7d1d315c, 0xe5c6, 0x11d4,          \</span>
<a href="#l2.27"></a><span id="l2.27"> { 0xa5, 0xb7, 0x00,0x60, 0xb0, 0xfc, 0x04, 0xb7 }}</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29"> #define NS_MSGOFFLINESTORECOMPACTOR_CONTRACTID \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/moz.build</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/moz.build</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -43,18 +43,17 @@ SOURCES += [</span>
<a href="#l3.4"></a><span id="l3.4">     'nsMsgStatusFeedback.cpp',</span>
<a href="#l3.5"></a><span id="l3.5">     'nsMsgTagService.cpp',</span>
<a href="#l3.6"></a><span id="l3.6">     'nsMsgThreadedDBView.cpp',</span>
<a href="#l3.7"></a><span id="l3.7">     'nsMsgWindow.cpp',</span>
<a href="#l3.8"></a><span id="l3.8">     'nsMsgXFViewThread.cpp',</span>
<a href="#l3.9"></a><span id="l3.9">     'nsMsgXFVirtualFolderDBView.cpp',</span>
<a href="#l3.10"></a><span id="l3.10">     'nsSpamSettings.cpp',</span>
<a href="#l3.11"></a><span id="l3.11">     'nsStatusBarBiffManager.cpp',</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    'nsSubscribableServer.cpp',</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    'nsSubscribeDataSource.cpp',</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    'nsSubscribableServer.cpp'</span>
<a href="#l3.15"></a><span id="l3.15"> ]</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> if CONFIG['NS_PRINTING']:</span>
<a href="#l3.18"></a><span id="l3.18">     SOURCES += ['nsMsgPrintEngine.cpp']</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> if CONFIG['OS_ARCH'] == 'WINNT':</span>
<a href="#l3.21"></a><span id="l3.21">     SOURCES += ['nsMessengerWinIntegration.cpp']</span>
<a href="#l3.22"></a><span id="l3.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribableServer.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribableServer.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,59 +1,39 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l4.5"></a><span id="l4.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsSubscribableServer.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;prmem.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+#include &quot;nsStringEnumerator.h&quot;</span>
<a href="#l4.20"></a><span id="l4.20"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l4.21"></a><span id="l4.21"> #include &quot;nsTreeColumns.h&quot;</span>
<a href="#l4.22"></a><span id="l4.22"> #include &quot;mozilla/dom/DataTransfer.h&quot;</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26"> nsSubscribableServer::nsSubscribableServer(void)</span>
<a href="#l4.27"></a><span id="l4.27"> {</span>
<a href="#l4.28"></a><span id="l4.28">     mDelimiter = '.';</span>
<a href="#l4.29"></a><span id="l4.29">     mShowFullName = true;</span>
<a href="#l4.30"></a><span id="l4.30">     mTreeRoot = nullptr;</span>
<a href="#l4.31"></a><span id="l4.31">     mStopped = false;</span>
<a href="#l4.32"></a><span id="l4.32"> }</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34"> nsresult</span>
<a href="#l4.35"></a><span id="l4.35"> nsSubscribableServer::Init()</span>
<a href="#l4.36"></a><span id="l4.36"> {</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-    rv = EnsureRDFService();</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-    rv = mRDFService-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;child&quot;),</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-                                  getter_AddRefs(kNC_Child));</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-    rv = mRDFService-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;Subscribed&quot;),</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-                                  getter_AddRefs(kNC_Subscribed));</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-    rv = mRDFService-&gt;GetLiteral(u&quot;true&quot;, getter_AddRefs(kTrueLiteral));</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-    rv = mRDFService-&gt;GetLiteral(u&quot;false&quot;, getter_AddRefs(kFalseLiteral));</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.57"></a><span id="l4.57"> }</span>
<a href="#l4.58"></a><span id="l4.58"> </span>
<a href="#l4.59"></a><span id="l4.59"> nsSubscribableServer::~nsSubscribableServer(void)</span>
<a href="#l4.60"></a><span id="l4.60"> {</span>
<a href="#l4.61"></a><span id="l4.61">   mozilla::DebugOnly&lt;nsresult&gt; rv = FreeRows();</span>
<a href="#l4.62"></a><span id="l4.62">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to free tree rows&quot;);</span>
<a href="#l4.63"></a><span id="l4.63">   rv = FreeSubtree(mTreeRoot);</span>
<a href="#l4.64"></a><span id="l4.64">   NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to free tree&quot;);</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineat">@@ -103,19 +83,16 @@ nsSubscribableServer::SetAsSubscribed(co</span>
<a href="#l4.66"></a><span id="l4.66">     rv = FindAndCreateNode(path, &amp;node);</span>
<a href="#l4.67"></a><span id="l4.67">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.68"></a><span id="l4.68"> </span>
<a href="#l4.69"></a><span id="l4.69">     NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l4.70"></a><span id="l4.70">     if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l4.71"></a><span id="l4.71">     node-&gt;isSubscribable = true;</span>
<a href="#l4.72"></a><span id="l4.72">     node-&gt;isSubscribed = true;</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-    rv = NotifyChange(node, kNC_Subscribed, node-&gt;isSubscribed);</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-</span>
<a href="#l4.77"></a><span id="l4.77">     return rv;</span>
<a href="#l4.78"></a><span id="l4.78"> }</span>
<a href="#l4.79"></a><span id="l4.79"> </span>
<a href="#l4.80"></a><span id="l4.80"> NS_IMETHODIMP</span>
<a href="#l4.81"></a><span id="l4.81"> nsSubscribableServer::AddTo(const nsACString&amp; aName, bool aAddAsSubscribed,</span>
<a href="#l4.82"></a><span id="l4.82">                             bool aSubscribable, bool aChangeIfExists)</span>
<a href="#l4.83"></a><span id="l4.83"> {</span>
<a href="#l4.84"></a><span id="l4.84">     nsresult rv = NS_OK;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineat">@@ -130,18 +107,16 @@ nsSubscribableServer::AddTo(const nsACSt</span>
<a href="#l4.86"></a><span id="l4.86">     // default value if we create it?</span>
<a href="#l4.87"></a><span id="l4.87">     rv = FindAndCreateNode(aName, &amp;node);</span>
<a href="#l4.88"></a><span id="l4.88">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.89"></a><span id="l4.89">     NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l4.90"></a><span id="l4.90">     if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92">     if (aChangeIfExists) {</span>
<a href="#l4.93"></a><span id="l4.93">         node-&gt;isSubscribed = aAddAsSubscribed;</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-        rv = NotifyChange(node, kNC_Subscribed, node-&gt;isSubscribed);</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.96"></a><span id="l4.96">     }</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98">     node-&gt;isSubscribable = aSubscribable;</span>
<a href="#l4.99"></a><span id="l4.99"> </span>
<a href="#l4.100"></a><span id="l4.100">     return NS_OK;</span>
<a href="#l4.101"></a><span id="l4.101"> }</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103"> NS_IMETHODIMP</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineat">@@ -169,171 +144,28 @@ nsSubscribableServer::SetState(const nsA</span>
<a href="#l4.105"></a><span id="l4.105">     }</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107">     if (node-&gt;isSubscribed == aState) {</span>
<a href="#l4.108"></a><span id="l4.108">         return NS_OK;</span>
<a href="#l4.109"></a><span id="l4.109">     }</span>
<a href="#l4.110"></a><span id="l4.110">     else {</span>
<a href="#l4.111"></a><span id="l4.111">         node-&gt;isSubscribed = aState;</span>
<a href="#l4.112"></a><span id="l4.112">         *aStateChanged = true;</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-        rv = NotifyChange(node, kNC_Subscribed, node-&gt;isSubscribed);</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.115"></a><span id="l4.115"> </span>
<a href="#l4.116"></a><span id="l4.116">         // Repaint the tree row to show/clear the check mark.</span>
<a href="#l4.117"></a><span id="l4.117">         if (mTree) {</span>
<a href="#l4.118"></a><span id="l4.118">           bool dummy;</span>
<a href="#l4.119"></a><span id="l4.119">           int32_t index = GetRow(node, &amp;dummy);</span>
<a href="#l4.120"></a><span id="l4.120">           if (index &gt;= 0)</span>
<a href="#l4.121"></a><span id="l4.121">             mTree-&gt;InvalidateRow(index);</span>
<a href="#l4.122"></a><span id="l4.122">         }</span>
<a href="#l4.123"></a><span id="l4.123">     }</span>
<a href="#l4.124"></a><span id="l4.124">     return NS_OK;</span>
<a href="#l4.125"></a><span id="l4.125"> }</span>
<a href="#l4.126"></a><span id="l4.126"> </span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-void</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-nsSubscribableServer::BuildURIFromNode(SubscribeTreeNode *node, nsACString &amp;uri)</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-{</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-    if (node-&gt;parent) {</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-        BuildURIFromNode(node-&gt;parent, uri);</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-        if (node-&gt;parent == mTreeRoot) {</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-            uri += &quot;/&quot;;</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-        }</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-        else {</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-            uri += mDelimiter;</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-        }</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-    }</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineminus">-</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-    uri += node-&gt;name;</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-    return;</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-}</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-nsresult</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-nsSubscribableServer::NotifyAssert(SubscribeTreeNode *subjectNode, nsIRDFResource *property, SubscribeTreeNode *objectNode)</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-{</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineminus">-</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineminus">-    bool hasObservers = true;</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-    rv = EnsureSubscribeDS();</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-    rv = mSubscribeDS-&gt;GetHasObservers(&amp;hasObservers);</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-    // no need to do all this work, there are no observers</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-    if (!hasObservers) {</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-        return NS_OK;</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-    }</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-    nsAutoCString subjectUri;</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-    BuildURIFromNode(subjectNode, subjectUri);</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-    // we could optimize this, since we know that objectUri == subjectUri + mDelimiter + object-&gt;name</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-    // is it worth it?</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-    nsAutoCString objectUri;</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-    BuildURIFromNode(objectNode, objectUri);</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-    nsCOMPtr &lt;nsIRDFResource&gt; subject;</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-    nsCOMPtr &lt;nsIRDFResource&gt; object;</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-    rv = EnsureRDFService();</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-    rv = mRDFService-&gt;GetResource(subjectUri, getter_AddRefs(subject));</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-    rv = mRDFService-&gt;GetResource(objectUri, getter_AddRefs(object));</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-    rv = Notify(subject, property, object, true, false);</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-}</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-nsresult</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-nsSubscribableServer::EnsureRDFService()</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-{</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-    if (!mRDFService) {</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-        mRDFService = do_GetService(kRDFServiceCID, &amp;rv);</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; mRDFService, &quot;failed to get rdf service&quot;);</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-        if (!mRDFService) return NS_ERROR_FAILURE;</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-    }</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-}</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-nsresult</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-nsSubscribableServer::NotifyChange(SubscribeTreeNode *subjectNode, nsIRDFResource *property, bool value)</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-{</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-    nsCOMPtr &lt;nsIRDFResource&gt; subject;</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-    bool hasObservers = true;</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-    rv = EnsureSubscribeDS();</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-    rv = mSubscribeDS-&gt;GetHasObservers(&amp;hasObservers);</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-    // no need to do all this work, there are no observers</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-    if (!hasObservers) {</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-        return NS_OK;</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-    }</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-    nsAutoCString subjectUri;</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-    BuildURIFromNode(subjectNode, subjectUri);</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-    rv = EnsureRDFService();</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-    rv = mRDFService-&gt;GetResource(subjectUri, getter_AddRefs(subject));</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-    if (value) {</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-        rv = Notify(subject,property,kTrueLiteral,false,true);</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-    }</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-    else {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-        rv = Notify(subject,property,kFalseLiteral,false,true);</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-    }</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-}</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-nsresult</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-nsSubscribableServer::EnsureSubscribeDS()</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineminus">-{</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-    if (!mSubscribeDS) {</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-        nsCOMPtr&lt;nsIRDFDataSource&gt; ds;</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-        rv = EnsureRDFService();</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-        rv = mRDFService-&gt;GetDataSource(&quot;rdf:subscribe&quot;, getter_AddRefs(ds));</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-        if (!ds) return NS_ERROR_FAILURE;</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-        mSubscribeDS = do_QueryInterface(ds, &amp;rv);</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-        if (!mSubscribeDS) return NS_ERROR_FAILURE;</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-    }</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-}</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-nsresult</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-nsSubscribableServer::Notify(nsIRDFResource *subject, nsIRDFResource *property, nsIRDFNode *object, bool isAssert, bool isChange)</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-{</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-    rv = EnsureSubscribeDS();</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineminus">-</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineminus">-    rv = mSubscribeDS-&gt;NotifyObservers(subject, property, object, isAssert, isChange);</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-    return rv;</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineminus">-}</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-</span>
<a href="#l4.268"></a><span id="l4.268"> NS_IMETHODIMP</span>
<a href="#l4.269"></a><span id="l4.269"> nsSubscribableServer::SetSubscribeListener(nsISubscribeListener *aListener)</span>
<a href="#l4.270"></a><span id="l4.270"> {</span>
<a href="#l4.271"></a><span id="l4.271">   mSubscribeListener = aListener;</span>
<a href="#l4.272"></a><span id="l4.272">   return NS_OK;</span>
<a href="#l4.273"></a><span id="l4.273"> }</span>
<a href="#l4.274"></a><span id="l4.274"> </span>
<a href="#l4.275"></a><span id="l4.275"> NS_IMETHODIMP</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineat">@@ -538,19 +370,16 @@ nsSubscribableServer::AddChildNode(Subsc</span>
<a href="#l4.277"></a><span id="l4.277">     if (!parent-&gt;firstChild) {</span>
<a href="#l4.278"></a><span id="l4.278">         // CreateNode will set the parent-&gt;cachedChild</span>
<a href="#l4.279"></a><span id="l4.279">         rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l4.280"></a><span id="l4.280">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.281"></a><span id="l4.281"> </span>
<a href="#l4.282"></a><span id="l4.282">         parent-&gt;firstChild = *child;</span>
<a href="#l4.283"></a><span id="l4.283">         parent-&gt;lastChild = *child;</span>
<a href="#l4.284"></a><span id="l4.284"> </span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-        rv = NotifyAssert(parent, kNC_Child, *child);</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-</span>
<a href="#l4.288"></a><span id="l4.288">         return NS_OK;</span>
<a href="#l4.289"></a><span id="l4.289">     }</span>
<a href="#l4.290"></a><span id="l4.290"> </span>
<a href="#l4.291"></a><span id="l4.291">     if (parent-&gt;cachedChild) {</span>
<a href="#l4.292"></a><span id="l4.292">         if (strcmp(parent-&gt;cachedChild-&gt;name,name) == 0) {</span>
<a href="#l4.293"></a><span id="l4.293">             *child = parent-&gt;cachedChild;</span>
<a href="#l4.294"></a><span id="l4.294">             return NS_OK;</span>
<a href="#l4.295"></a><span id="l4.295">         }</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineat">@@ -584,18 +413,16 @@ nsSubscribableServer::AddChildNode(Subsc</span>
<a href="#l4.297"></a><span id="l4.297">             current-&gt;prevSibling = (*child);</span>
<a href="#l4.298"></a><span id="l4.298">             if (!(*child)-&gt;prevSibling) {</span>
<a href="#l4.299"></a><span id="l4.299">                 parent-&gt;firstChild = (*child);</span>
<a href="#l4.300"></a><span id="l4.300">             }</span>
<a href="#l4.301"></a><span id="l4.301">             else {</span>
<a href="#l4.302"></a><span id="l4.302">                 (*child)-&gt;prevSibling-&gt;nextSibling = (*child);</span>
<a href="#l4.303"></a><span id="l4.303">             }</span>
<a href="#l4.304"></a><span id="l4.304"> </span>
<a href="#l4.305"></a><span id="l4.305" class="difflineminus">-            rv = NotifyAssert(parent, kNC_Child, *child);</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-            NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.307"></a><span id="l4.307">             return NS_OK;</span>
<a href="#l4.308"></a><span id="l4.308">         }</span>
<a href="#l4.309"></a><span id="l4.309">         current = current-&gt;nextSibling;</span>
<a href="#l4.310"></a><span id="l4.310">         if (current) {</span>
<a href="#l4.311"></a><span id="l4.311">             NS_ASSERTION(current-&gt;name, &quot;no name!&quot;);</span>
<a href="#l4.312"></a><span id="l4.312">             compare = strcmp(current-&gt;name,name);</span>
<a href="#l4.313"></a><span id="l4.313">         }</span>
<a href="#l4.314"></a><span id="l4.314">         else {</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineat">@@ -616,18 +443,16 @@ nsSubscribableServer::AddChildNode(Subsc</span>
<a href="#l4.316"></a><span id="l4.316">     rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l4.317"></a><span id="l4.317">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.318"></a><span id="l4.318"> </span>
<a href="#l4.319"></a><span id="l4.319">     (*child)-&gt;prevSibling = parent-&gt;lastChild;</span>
<a href="#l4.320"></a><span id="l4.320">     (*child)-&gt;nextSibling = nullptr;</span>
<a href="#l4.321"></a><span id="l4.321">     parent-&gt;lastChild-&gt;nextSibling = *child;</span>
<a href="#l4.322"></a><span id="l4.322">     parent-&gt;lastChild = *child;</span>
<a href="#l4.323"></a><span id="l4.323"> </span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-    rv = NotifyAssert(parent, kNC_Child, *child);</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.326"></a><span id="l4.326">     return NS_OK;</span>
<a href="#l4.327"></a><span id="l4.327"> }</span>
<a href="#l4.328"></a><span id="l4.328"> </span>
<a href="#l4.329"></a><span id="l4.329"> nsresult</span>
<a href="#l4.330"></a><span id="l4.330"> nsSubscribableServer::FindAndCreateNode(const nsACString &amp;aPath,</span>
<a href="#l4.331"></a><span id="l4.331">                                         SubscribeTreeNode **aResult)</span>
<a href="#l4.332"></a><span id="l4.332"> {</span>
<a href="#l4.333"></a><span id="l4.333">   nsresult rv = NS_OK;</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineat">@@ -766,76 +591,62 @@ nsSubscribableServer::GetFirstChildURI(c</span>
<a href="#l4.335"></a><span id="l4.335">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.336"></a><span id="l4.336"> </span>
<a href="#l4.337"></a><span id="l4.337">     NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l4.338"></a><span id="l4.338">     if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l4.339"></a><span id="l4.339"> </span>
<a href="#l4.340"></a><span id="l4.340">     // no children</span>
<a href="#l4.341"></a><span id="l4.341">     if (!node-&gt;firstChild) return NS_ERROR_FAILURE;</span>
<a href="#l4.342"></a><span id="l4.342"> </span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-    BuildURIFromNode(node-&gt;firstChild, aResult);</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+    aResult.Assign(node-&gt;firstChild-&gt;path);</span>
<a href="#l4.345"></a><span id="l4.345"> </span>
<a href="#l4.346"></a><span id="l4.346">     return NS_OK;</span>
<a href="#l4.347"></a><span id="l4.347"> }</span>
<a href="#l4.348"></a><span id="l4.348"> </span>
<a href="#l4.349"></a><span id="l4.349"> NS_IMETHODIMP</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-nsSubscribableServer::GetChildren(const nsACString &amp;aPath,</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineminus">-                                  nsISimpleEnumerator **aResult)</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+nsSubscribableServer::GetChildURIs(const nsACString &amp;aPath,</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+                                   nsIUTF8StringEnumerator **aResult)</span>
<a href="#l4.354"></a><span id="l4.354"> {</span>
<a href="#l4.355"></a><span id="l4.355">     SubscribeTreeNode *node = nullptr;</span>
<a href="#l4.356"></a><span id="l4.356">     nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l4.357"></a><span id="l4.357">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.358"></a><span id="l4.358"> </span>
<a href="#l4.359"></a><span id="l4.359">     NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l4.360"></a><span id="l4.360">     if (!node)</span>
<a href="#l4.361"></a><span id="l4.361">       return NS_ERROR_FAILURE;</span>
<a href="#l4.362"></a><span id="l4.362"> </span>
<a href="#l4.363"></a><span id="l4.363" class="difflineminus">-    nsAutoCString uriPrefix;</span>
<a href="#l4.364"></a><span id="l4.364">     NS_ASSERTION(mTreeRoot, &quot;no tree root!&quot;);</span>
<a href="#l4.365"></a><span id="l4.365">     if (!mTreeRoot)</span>
<a href="#l4.366"></a><span id="l4.366">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l4.367"></a><span id="l4.367"> </span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-    uriPrefix = mTreeRoot-&gt;name; // the root's name is the server uri</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-    uriPrefix += &quot;/&quot;;</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-    if (!aPath.IsEmpty()) {</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-        uriPrefix += aPath;</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-        uriPrefix += mDelimiter;</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-    }</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-    // we inserted them in reverse alphabetical order.</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-    // so pull them out in reverse to get the right order</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-    // in the subscribe dialog</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+    // We inserted them in reverse alphabetical order.</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+    // So pull them out in reverse to get the right order</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineplus">+    // in the subscribe dialog.</span>
<a href="#l4.381"></a><span id="l4.381">     SubscribeTreeNode *current = node-&gt;lastChild;</span>
<a href="#l4.382"></a><span id="l4.382">     // return failure if there are no children.</span>
<a href="#l4.383"></a><span id="l4.383">     if (!current)</span>
<a href="#l4.384"></a><span id="l4.384">       return NS_ERROR_FAILURE;</span>
<a href="#l4.385"></a><span id="l4.385"> </span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-    nsCOMArray&lt;nsIRDFResource&gt; result;</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+    nsTArray&lt;nsCString&gt; *result = new nsTArray&lt;nsCString&gt;;</span>
<a href="#l4.388"></a><span id="l4.388"> </span>
<a href="#l4.389"></a><span id="l4.389">     while (current) {</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineminus">-        nsAutoCString uri;</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-        uri = uriPrefix;</span>
<a href="#l4.392"></a><span id="l4.392">         NS_ASSERTION(current-&gt;name, &quot;no name&quot;);</span>
<a href="#l4.393"></a><span id="l4.393">         if (!current-&gt;name)</span>
<a href="#l4.394"></a><span id="l4.394">           return NS_ERROR_FAILURE;</span>
<a href="#l4.395"></a><span id="l4.395"> </span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-        uri += current-&gt;name;</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-        nsCOMPtr &lt;nsIRDFResource&gt; res;</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineminus">-        rv = EnsureRDFService();</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineminus">-</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineminus">-        // todo, is this creating nsMsgFolders?</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineminus">-        mRDFService-&gt;GetResource(uri, getter_AddRefs(res));</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineminus">-        result.AppendObject(res);</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+        result-&gt;AppendElement(current-&gt;path);</span>
<a href="#l4.406"></a><span id="l4.406"> </span>
<a href="#l4.407"></a><span id="l4.407">         current = current-&gt;prevSibling;</span>
<a href="#l4.408"></a><span id="l4.408">     }</span>
<a href="#l4.409"></a><span id="l4.409"> </span>
<a href="#l4.410"></a><span id="l4.410" class="difflineminus">-    return NS_NewArrayEnumerator(aResult, result, NS_GET_IID(nsIRDFResource));</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineplus">+    rv = NS_NewAdoptingUTF8StringEnumerator(aResult, result);</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+      delete result;</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+    return rv;</span>
<a href="#l4.416"></a><span id="l4.416"> }</span>
<a href="#l4.417"></a><span id="l4.417"> </span>
<a href="#l4.418"></a><span id="l4.418"> NS_IMETHODIMP</span>
<a href="#l4.419"></a><span id="l4.419"> nsSubscribableServer::CommitSubscribeChanges()</span>
<a href="#l4.420"></a><span id="l4.420"> {</span>
<a href="#l4.421"></a><span id="l4.421">     NS_ASSERTION(false,&quot;override this.&quot;);</span>
<a href="#l4.422"></a><span id="l4.422">     return NS_ERROR_FAILURE;</span>
<a href="#l4.423"></a><span id="l4.423"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribableServer.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribableServer.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -8,19 +8,16 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsString.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsITreeBoxObject.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsITreeSelection.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsITreeView.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsISubscribableServer.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-#include &quot;nsSubscribeDataSource.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #include &quot;nsTArray.h&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> /**</span>
<a href="#l5.18"></a><span id="l5.18">  * The basic structure for the tree of the implementation.</span>
<a href="#l5.19"></a><span id="l5.19">  *</span>
<a href="#l5.20"></a><span id="l5.20">  * These elements are stored in reverse alphabetical order.</span>
<a href="#l5.21"></a><span id="l5.21">  */</span>
<a href="#l5.22"></a><span id="l5.22"> typedef struct _subscribeTreeNode {</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -57,42 +54,28 @@ public:</span>
<a href="#l5.24"></a><span id="l5.24">   NS_DECL_NSITREEVIEW</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26"> private:</span>
<a href="#l5.27"></a><span id="l5.27">   virtual ~nsSubscribableServer();</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29">   nsresult ConvertNameToUnichar(const char *inStr, char16_t **outStr);</span>
<a href="#l5.30"></a><span id="l5.30">   nsCOMPtr &lt;nsISubscribeListener&gt; mSubscribeListener;</span>
<a href="#l5.31"></a><span id="l5.31">   nsCString mIncomingServerUri;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-  nsCOMPtr &lt;nsISubscribeDataSource&gt; mSubscribeDS;</span>
<a href="#l5.33"></a><span id="l5.33">   char mDelimiter;</span>
<a href="#l5.34"></a><span id="l5.34">   bool mShowFullName;</span>
<a href="#l5.35"></a><span id="l5.35">   bool mStopped;</span>
<a href="#l5.36"></a><span id="l5.36">   nsCString mServerType;</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Child;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Subscribed;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-  nsCOMPtr &lt;nsIRDFLiteral&gt;       kTrueLiteral;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-  nsCOMPtr &lt;nsIRDFLiteral&gt;       kFalseLiteral;</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-  nsCOMPtr &lt;nsIRDFService&gt;       mRDFService;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-</span>
<a href="#l5.45"></a><span id="l5.45">   SubscribeTreeNode *mTreeRoot;          // root of the folder tree while items are discovered on the server</span>
<a href="#l5.46"></a><span id="l5.46">   nsTArray&lt;SubscribeTreeNode*&gt; mRowMap;  // array of nodes representing the rows for the tree element</span>
<a href="#l5.47"></a><span id="l5.47">   nsCOMPtr&lt;nsITreeSelection&gt; mSelection;</span>
<a href="#l5.48"></a><span id="l5.48">   nsCOMPtr&lt;nsITreeBoxObject&gt; mTree;</span>
<a href="#l5.49"></a><span id="l5.49">   nsresult FreeSubtree(SubscribeTreeNode *node);</span>
<a href="#l5.50"></a><span id="l5.50">   nsresult FreeRows();</span>
<a href="#l5.51"></a><span id="l5.51">   nsresult CreateNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **result);</span>
<a href="#l5.52"></a><span id="l5.52">   nsresult AddChildNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **child);</span>
<a href="#l5.53"></a><span id="l5.53">   nsresult FindAndCreateNode(const nsACString &amp;aPath, SubscribeTreeNode **aResult);</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-  nsresult NotifyAssert(SubscribeTreeNode *subjectNode, nsIRDFResource *property, SubscribeTreeNode *objectNode);</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-  nsresult NotifyChange(SubscribeTreeNode *subjectNode, nsIRDFResource *property, bool value);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-  nsresult Notify(nsIRDFResource *subject, nsIRDFResource *property, nsIRDFNode *object, bool isAssert, bool isChange);</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-  void BuildURIFromNode(SubscribeTreeNode *node, nsACString &amp;uri);</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-  nsresult EnsureSubscribeDS();</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-  nsresult EnsureRDFService();</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61">   int32_t GetRow(SubscribeTreeNode *node, bool *open);</span>
<a href="#l5.62"></a><span id="l5.62">   int32_t AddSubtree(SubscribeTreeNode *node, int32_t index);</span>
<a href="#l5.63"></a><span id="l5.63"> };</span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65"> #endif // nsSubscribableServer_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/mailnews/base/src/nsSubscribeDataSource.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,671 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-#include &quot;nsSubscribeDataSource.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-#include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-#include &quot;nsCOMArray.h&quot;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-#include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-nsSubscribeDataSource::nsSubscribeDataSource()</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-{</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-}</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-nsSubscribeDataSource::~nsSubscribeDataSource()</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-{</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-}</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-NS_IMPL_ISUPPORTS(nsSubscribeDataSource, nsIRDFDataSource, nsISubscribeDataSource)</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-nsresult</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-nsSubscribeDataSource::Init()</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-{</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-    nsresult rv;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-    mRDFService = do_GetService(kRDFServiceCID, &amp;rv);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; mRDFService, &quot;failed to get rdf service&quot;);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-    if (!mRDFService) return NS_ERROR_FAILURE;</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-    rv = mRDFService-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;child&quot;),</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-                                  getter_AddRefs(kNC_Child));</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-    rv = mRDFService-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;Name&quot;),</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-                                  getter_AddRefs(kNC_Name));</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-    rv = mRDFService-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;LeafName&quot;),</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-                                  getter_AddRefs(kNC_LeafName));</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-    rv = mRDFService-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;Subscribed&quot;),</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-                                  getter_AddRefs(kNC_Subscribed));</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    rv = mRDFService-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;Subscribable&quot;),</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-                                  getter_AddRefs(kNC_Subscribable));</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-    rv = mRDFService-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;ServerType&quot;),</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-                                  getter_AddRefs(kNC_ServerType));</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-    rv = mRDFService-&gt;GetLiteral(u&quot;true&quot;, getter_AddRefs(kTrueLiteral));</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-    rv = mRDFService-&gt;GetLiteral(u&quot;false&quot;, getter_AddRefs(kFalseLiteral));</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-}</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-nsSubscribeDataSource::GetURI(nsACString&amp; aURI)</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-{</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-  aURI.AssignLiteral(&quot;rdf:subscribe&quot;);</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-}</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-nsSubscribeDataSource::GetSource(nsIRDFResource *property, nsIRDFNode *target, bool tv, nsIRDFResource **source)</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-{</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-    NS_ASSERTION(property != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-    if (! property)</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-    NS_ASSERTION(target != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-    if (! target)</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-    NS_ASSERTION(source != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-    if (! source)</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-    *source = nullptr;</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-}</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-nsSubscribeDataSource::GetTarget(nsIRDFResource *source,</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-                                nsIRDFResource *property,</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-                                bool tv,</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-                                nsIRDFNode **target /* out */)</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-{</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-  nsresult rv = NS_RDF_NO_VALUE;</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-  NS_ASSERTION(source != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-  if (! source)</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-  NS_ASSERTION(property != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-  if (! property)</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-  NS_ASSERTION(target != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-  if (! target)</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-  *target = nullptr;</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-  // we only have positive assertions in the subscribe data source.</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-  if (! tv) return NS_RDF_NO_VALUE;</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-    nsCOMPtr&lt;nsISubscribableServer&gt; server;</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-    nsCString relativePath;</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-    rv = GetServerAndRelativePathFromResource(source, getter_AddRefs(server), getter_Copies(relativePath));</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-    if (NS_FAILED(rv) || !server)</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-        return NS_RDF_NO_VALUE;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-    if (property == kNC_Name.get()) {</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; name;</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-        rv = mRDFService-&gt;GetLiteral(NS_ConvertUTF8toUTF16(relativePath).get(),</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-                                     getter_AddRefs(name));</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-        if (!name) rv = NS_RDF_NO_VALUE;</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-        if (rv == NS_RDF_NO_VALUE) return(rv);</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-        return name-&gt;QueryInterface(NS_GET_IID(nsIRDFNode), (void**) target);</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-    }</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-    else if (property == kNC_Child.get()) {</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-        nsCString childUri;</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-        rv = server-&gt;GetFirstChildURI(relativePath, childUri);</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-        if (NS_FAILED(rv)) return NS_RDF_NO_VALUE;</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-        if (childUri.IsEmpty()) return NS_RDF_NO_VALUE;</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-        nsCOMPtr &lt;nsIRDFResource&gt; childResource;</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-        rv = mRDFService-&gt;GetResource(childUri, getter_AddRefs(childResource));</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-        return childResource-&gt;QueryInterface(NS_GET_IID(nsIRDFNode), (void**) target);</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-    }</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-    else if (property == kNC_Subscribed.get()) {</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-        bool isSubscribed;</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-        rv = server-&gt;IsSubscribed(relativePath, &amp;isSubscribed);</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-        NS_IF_ADDREF(*target = isSubscribed ? kTrueLiteral : kFalseLiteral);</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-        return NS_OK;</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-    }</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-    else if (property == kNC_Subscribable.get()) {</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-        bool isSubscribable;</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-        rv = server-&gt;IsSubscribable(relativePath, &amp;isSubscribable);</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-        NS_IF_ADDREF(*target = isSubscribable ? kTrueLiteral : kFalseLiteral);</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-        return NS_OK;</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-    }</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-    else if (property == kNC_ServerType.get()) {</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-        nsCString serverTypeStr;</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-        rv = GetServerType(server, serverTypeStr);</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; serverType;</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-        rv = mRDFService-&gt;GetLiteral(NS_ConvertASCIItoUTF16(serverTypeStr).get(),</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-                                     getter_AddRefs(serverType));</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-        if (!serverType)</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-          rv = NS_RDF_NO_VALUE;</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-        if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-          return rv;</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-        return serverType-&gt;QueryInterface(NS_GET_IID(nsIRDFNode), (void**) target);</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-    }</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-    else if (property == kNC_LeafName.get()) {</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-        nsString leafNameStr;</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-        rv = server-&gt;GetLeafName(relativePath, leafNameStr);</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; leafName;</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-        rv = mRDFService-&gt;GetLiteral(leafNameStr.get(), getter_AddRefs(leafName));</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-        if (!leafName)</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-          rv = NS_RDF_NO_VALUE;</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-        if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-          return rv;</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-        return leafName-&gt;QueryInterface(NS_GET_IID(nsIRDFNode), (void**) target);</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-    }</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-    else {</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-        // do nothing</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-    }</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-  return(NS_RDF_NO_VALUE);</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-}</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-nsSubscribeDataSource::GetTargets(nsIRDFResource *source,</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-        nsIRDFResource *property,</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-        bool tv,</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-        nsISimpleEnumerator **targets /* out */)</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-{</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-  NS_ASSERTION(source != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-  if (! source)</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-  NS_ASSERTION(property != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-  if (! property)</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-  NS_ASSERTION(targets != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-  if (! targets)</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-  *targets = nullptr;</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-  // we only have positive assertions in the subscribe data source.</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-  if (!tv) return NS_RDF_NO_VALUE;</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-    nsCOMPtr&lt;nsISubscribableServer&gt; server;</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-    nsCString relativePath;  // UTF-8</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-    rv = GetServerAndRelativePathFromResource(source, getter_AddRefs(server), getter_Copies(relativePath));</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-    if (NS_FAILED(rv) || !server) {</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-      return NS_NewEmptyEnumerator(targets);</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-    }</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-    if (property == kNC_Child.get()) {</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-        rv = server-&gt;GetChildren(relativePath, targets);</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-        if (NS_FAILED(rv)) {</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-            return NS_NewEmptyEnumerator(targets);</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-        }</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-        return rv;</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-    }</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-    else if (property == kNC_LeafName.get()) {</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-        nsString leafNameStr;</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-        rv = server-&gt;GetLeafName(relativePath, leafNameStr);</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; leafName;</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-        rv = mRDFService-&gt;GetLiteral(leafNameStr.get(), getter_AddRefs(leafName));</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-        return NS_NewSingletonEnumerator(targets, leafName);</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-    }</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-    else if (property == kNC_Subscribed.get()) {</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-        bool isSubscribed;</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-        rv = server-&gt;IsSubscribed(relativePath, &amp;isSubscribed);</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-        return NS_NewSingletonEnumerator(targets,</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-                 isSubscribed ? kTrueLiteral : kFalseLiteral);</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-    }</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-    else if (property == kNC_Subscribable.get()) {</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-        bool isSubscribable;</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-        rv = server-&gt;IsSubscribable(relativePath, &amp;isSubscribable);</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-        return NS_NewSingletonEnumerator(targets,</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-                 isSubscribable ? kTrueLiteral : kFalseLiteral);</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-    }</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-    else if (property == kNC_Name.get()) {</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; name;</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-        rv = mRDFService-&gt;GetLiteral(NS_ConvertUTF8toUTF16(relativePath).get(),</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-                                     getter_AddRefs(name));</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-        return NS_NewSingletonEnumerator(targets, name);</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-    }</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-    else if (property == kNC_ServerType.get()) {</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-        nsCString serverTypeStr;</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-        rv = GetServerType(server, serverTypeStr);</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; serverType;</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-        rv = mRDFService-&gt;GetLiteral(NS_ConvertASCIItoUTF16(serverTypeStr).get(),</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-                                     getter_AddRefs(serverType));</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-        return NS_NewSingletonEnumerator(targets, serverType);</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-    }</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-    else {</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-        // do nothing</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-    }</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-  return NS_NewEmptyEnumerator(targets);</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-}</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-nsSubscribeDataSource::Assert(nsIRDFResource *source,</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-                       nsIRDFResource *property,</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-                       nsIRDFNode *target,</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-                       bool tv)</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-{</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-  return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-}</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-nsSubscribeDataSource::Unassert(nsIRDFResource *source,</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-                         nsIRDFResource *property,</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-                         nsIRDFNode *target)</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-{</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-  return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-}</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-nsSubscribeDataSource::Change(nsIRDFResource* aSource,</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-                              nsIRDFResource* aProperty,</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-                              nsIRDFNode* aOldTarget,</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-                              nsIRDFNode* aNewTarget)</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-{</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-  return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-}</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-nsSubscribeDataSource::Move(nsIRDFResource* aOldSource,</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-                            nsIRDFResource* aNewSource,</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-                            nsIRDFResource* aProperty,</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-                            nsIRDFNode* aTarget)</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-{</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-  return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-}</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-nsresult</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-nsSubscribeDataSource::GetServerType(nsISubscribableServer *server, nsACString&amp; serverType)</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-{</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-  NS_ENSURE_ARG_POINTER(server);</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer(do_QueryInterface(server, &amp;rv));</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-  return incomingServer-&gt;GetType(serverType);</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-}</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">-nsresult</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-nsSubscribeDataSource::GetServerAndRelativePathFromResource(nsIRDFResource *source, nsISubscribableServer **server, char **relativePath)</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-{</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-    const char *sourceURI = nullptr;</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-    rv = source-&gt;GetValueConst(&amp;sourceURI);</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(source, &amp;rv));</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-    // we expect this to fail sometimes, so don't assert</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineminus">-      return rv;</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-    rv = folder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineminus">-    rv = incomingServer-&gt;QueryInterface(NS_GET_IID(nsISubscribableServer), (void**)server);</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineminus">-</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-    nsCString serverURI;</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineminus">-    rv = incomingServer-&gt;GetServerURI(serverURI);</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineminus">-</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineminus">-    uint32_t serverURILen = serverURI.Length();</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-    if (serverURILen == strlen(sourceURI))</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineminus">-      *relativePath = nullptr;</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineminus">-    else {</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-      // XXX : perhaps, have to unescape before returning</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-      *relativePath = strdup(sourceURI + serverURILen + 1);</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-      if (!*relativePath)</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-    }</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-}</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineminus">-</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-nsSubscribeDataSource::HasAssertion(nsIRDFResource *source,</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-                             nsIRDFResource *property,</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-                             nsIRDFNode *target,</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineminus">-                             bool tv,</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineminus">-                             bool *hasAssertion /* out */)</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineminus">-{</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineminus">-</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineminus">-  NS_ASSERTION(source != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineminus">-  if (! source)</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-  NS_ASSERTION(property != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineminus">-  if (! property)</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineminus">-</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineminus">-  NS_ASSERTION(target != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineminus">-  if (! target)</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineminus">-</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-  NS_ASSERTION(hasAssertion != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineminus">-  if (! hasAssertion)</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">-</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineminus">-  *hasAssertion = false;</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineminus">-</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineminus">-  // we only have positive assertions in the subscribe data source.</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineminus">-  if (!tv) return NS_OK;</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineminus">-</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineminus">-  if (property == kNC_Child.get()) {</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineminus">-    nsCOMPtr&lt;nsISubscribableServer&gt; server;</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineminus">-    nsCString relativePath;</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineminus">-</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-    rv = GetServerAndRelativePathFromResource(source, getter_AddRefs(server), getter_Copies(relativePath));</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineminus">-    if (NS_FAILED(rv) || !server) {</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineminus">-        *hasAssertion = false;</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineminus">-        return NS_OK;</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineminus">-    }</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineminus">-</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineminus">-        // not everything has children</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineminus">-        rv = server-&gt;HasChildren(relativePath, hasAssertion);</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineminus">-    }</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineminus">-    else if (property == kNC_Name.get()) {</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineminus">-        // everything has a name</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineminus">-        *hasAssertion = true;</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineminus">-    }</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineminus">-    else if (property == kNC_LeafName.get()) {</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineminus">-        // everything has a leaf name</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineminus">-        *hasAssertion = true;</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineminus">-    }</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineminus">-    else if (property == kNC_Subscribed.get()) {</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineminus">-        // everything is subscribed or not</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineminus">-        *hasAssertion = true;</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineminus">-    }</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineminus">-    else if (property == kNC_Subscribable.get()) {</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineminus">-        // everything is subscribable or not</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineminus">-        *hasAssertion = true;</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineminus">-    }</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineminus">-    else if (property == kNC_ServerType.get()) {</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineminus">-        // everything has a server type</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineminus">-        *hasAssertion = true;</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineminus">-    }</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineminus">-    else {</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineminus">-        // do nothing</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineminus">-    }</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineminus">-</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineminus">-}</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineminus">-</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineminus">-</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineminus">-nsSubscribeDataSource::HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, bool *result)</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineminus">-{</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineminus">-}</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineminus">-</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineminus">-nsSubscribeDataSource::HasArcOut(nsIRDFResource *source, nsIRDFResource *aArc, bool *result)</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineminus">-{</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineminus">-</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineminus">-    nsCOMPtr&lt;nsISubscribableServer&gt; server;</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineminus">-    nsCString relativePath;</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineminus">-</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineminus">-    if (aArc == kNC_Child.get()) {</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineminus">-    rv = GetServerAndRelativePathFromResource(source, getter_AddRefs(server), getter_Copies(relativePath));</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineminus">-        if (NS_FAILED(rv) || !server) {</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineminus">-          *result = false;</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineminus">-            return NS_OK;</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineminus">-        }</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineminus">-</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineminus">-        bool hasChildren = false;</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineminus">-        rv = server-&gt;HasChildren(relativePath, &amp;hasChildren);</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineminus">-        *result = hasChildren;</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineminus">-        return NS_OK;</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineminus">-    }</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineminus">-    else if ((aArc == kNC_Subscribed.get()) ||</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineminus">-             (aArc == kNC_Subscribable.get()) ||</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineminus">-             (aArc == kNC_LeafName.get()) ||</span>
<a href="#l6.500"></a><span id="l6.500" class="difflineminus">-             (aArc == kNC_ServerType.get()) ||</span>
<a href="#l6.501"></a><span id="l6.501" class="difflineminus">-             (aArc == kNC_Name.get())) {</span>
<a href="#l6.502"></a><span id="l6.502" class="difflineminus">-        *result = true;</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineminus">-        return NS_OK;</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineminus">-    }</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineminus">-</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineminus">-    *result = false;</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineminus">-}</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineminus">-</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineminus">-</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineminus">-nsSubscribeDataSource::ArcLabelsIn(nsIRDFNode *node,</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineminus">-                            nsISimpleEnumerator ** labels /* out */)</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineminus">-{</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineminus">-}</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineminus">-</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineminus">-</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineminus">-</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineminus">-nsSubscribeDataSource::ArcLabelsOut(nsIRDFResource *source,</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineminus">-           nsISimpleEnumerator **labels /* out */)</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineminus">-{</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineminus">-</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineminus">-    NS_ASSERTION(source != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineminus">-    if (! source)</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineminus">-</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineminus">-    NS_ASSERTION(labels != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineminus">-    if (! labels)</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineminus">-</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineminus">-    nsCOMPtr&lt;nsISubscribableServer&gt; server;</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineminus">-    nsCString relativePath;</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineminus">-</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineminus">-    rv = GetServerAndRelativePathFromResource(source, getter_AddRefs(server), getter_Copies(relativePath));</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineminus">-    if (NS_FAILED(rv) || !server) {</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineminus">-        return NS_NewEmptyEnumerator(labels);</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineminus">-    }</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineminus">-</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineminus">-    bool hasChildren = false;</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineminus">-    rv = server-&gt;HasChildren(relativePath, &amp;hasChildren);</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineminus">-</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineminus">-    // Initialise with the number of items below, to save reallocating on each</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineminus">-    // addition.</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineminus">-    nsCOMArray&lt;nsIRDFResource&gt; array(hasChildren ? 6 : 5);</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineminus">-</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineminus">-    array.AppendObject(kNC_Subscribed);</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineminus">-    array.AppendObject(kNC_Subscribable);</span>
<a href="#l6.552"></a><span id="l6.552" class="difflineminus">-    array.AppendObject(kNC_Name);</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineminus">-    array.AppendObject(kNC_ServerType);</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineminus">-    array.AppendObject(kNC_LeafName);</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineminus">-</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineminus">-    if (hasChildren) {</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineminus">-        array.AppendObject(kNC_Child);</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineminus">-    }</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineminus">-</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineminus">-    return NS_NewArrayEnumerator(labels, array, NS_GET_IID(nsIRDFResource));</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineminus">-}</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineminus">-</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineminus">-nsSubscribeDataSource::GetAllResources(nsISimpleEnumerator** aCursor)</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineminus">-{</span>
<a href="#l6.566"></a><span id="l6.566" class="difflineminus">-  MOZ_ASSERT_UNREACHABLE(&quot;sorry!&quot;);</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineminus">-}</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineminus">-</span>
<a href="#l6.570"></a><span id="l6.570" class="difflineminus">-</span>
<a href="#l6.571"></a><span id="l6.571" class="difflineminus">-</span>
<a href="#l6.572"></a><span id="l6.572" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineminus">-nsSubscribeDataSource::AddObserver(nsIRDFObserver *n)</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineminus">-{</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineminus">-  NS_ENSURE_ARG_POINTER(n);</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineminus">-  mObservers.AppendElement(n);</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineminus">-}</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineminus">-</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineminus">-</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.582"></a><span id="l6.582" class="difflineminus">-nsSubscribeDataSource::RemoveObserver(nsIRDFObserver *n)</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineminus">-{</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineminus">-  NS_ENSURE_ARG_POINTER(n);</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineminus">-  mObservers.RemoveElement(n);</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineminus">-}</span>
<a href="#l6.588"></a><span id="l6.588" class="difflineminus">-</span>
<a href="#l6.589"></a><span id="l6.589" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.590"></a><span id="l6.590" class="difflineminus">-nsSubscribeDataSource::GetHasObservers(bool *hasObservers)</span>
<a href="#l6.591"></a><span id="l6.591" class="difflineminus">-{</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-  NS_ENSURE_ARG_POINTER(hasObservers);</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineminus">-  *hasObservers = !mObservers.IsEmpty();</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineminus">-}</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineminus">-</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineminus">-nsSubscribeDataSource::GetAllCmds(nsIRDFResource* source,</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineminus">-                                     nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** commands)</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineminus">-{</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineminus">-  return(NS_NewEmptyEnumerator(commands));</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineminus">-}</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineminus">-</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineminus">-nsSubscribeDataSource::IsCommandEnabled(nsISupports/*nsISupportsArray&lt;nsIRDFResource&gt;*/* aSources,</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineminus">-                                        nsIRDFResource*   aCommand,</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineminus">-                                        nsISupports/*nsISupportsArray&lt;nsIRDFResource&gt;*/* aArguments,</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineminus">-                                        bool* aResult)</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineminus">-{</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineminus">-  return(NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineminus">-}</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineminus">-</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineminus">-</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineminus">-</span>
<a href="#l6.615"></a><span id="l6.615" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineminus">-nsSubscribeDataSource::DoCommand(nsISupports/*nsISupportsArray&lt;nsIRDFResource&gt;*/* aSources,</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineminus">-                                 nsIRDFResource*   aCommand,</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineminus">-                                 nsISupports/*nsISupportsArray&lt;nsIRDFResource&gt;*/* aArguments)</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineminus">-{</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineminus">-  return(NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineminus">-}</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineminus">-</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineminus">-</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineminus">-</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineminus">-nsSubscribeDataSource::BeginUpdateBatch()</span>
<a href="#l6.627"></a><span id="l6.627" class="difflineminus">-{</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineminus">-        return NS_OK;</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineminus">-}</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineminus">-</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineminus">-</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineminus">-</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineminus">-nsSubscribeDataSource::EndUpdateBatch()</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineminus">-{</span>
<a href="#l6.636"></a><span id="l6.636" class="difflineminus">-        return NS_OK;</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineminus">-}</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineminus">-</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineminus">-</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineminus">-</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineminus">-nsSubscribeDataSource::GetSources(nsIRDFResource *aProperty, nsIRDFNode *aTarget, bool aTruthValue, nsISimpleEnumerator **_retval)</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineminus">-{</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineminus">-  NS_ASSERTION(false, &quot;Not implemented&quot;);</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineminus">-}</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineminus">-</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineminus">-#define NOTIFY_SUBSCRIBE_LISTENERS(propertyfunc_, params_) \</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineminus">-  PR_BEGIN_MACRO \</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineminus">-  { \</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineminus">-    nsTObserverArray&lt;nsCOMPtr&lt;nsIRDFObserver&gt; &gt;::ForwardIterator iter(mObservers); \</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineminus">-    while (iter.HasMore()) \</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineminus">-    { \</span>
<a href="#l6.654"></a><span id="l6.654" class="difflineminus">-      iter.GetNext()-&gt;propertyfunc_ params_; \</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineminus">-    } \</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineminus">-  } \</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineminus">-  PR_END_MACRO</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineminus">-</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineminus">-nsSubscribeDataSource::NotifyObservers(nsIRDFResource *subject,</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineminus">-                                                nsIRDFResource *property,</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineminus">-                                                nsIRDFNode *object,</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineminus">-                                                bool assert, bool change)</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineminus">-{</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineminus">-  NS_ASSERTION(!(change &amp;&amp; assert),</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineminus">-               &quot;Can't change and assert at the same time!\n&quot;);</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineminus">-</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineminus">-  if (change)</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineminus">-    NOTIFY_SUBSCRIBE_LISTENERS(OnChange, (this, subject, property, nullptr, object));</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineminus">-  else if (assert)</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineminus">-    NOTIFY_SUBSCRIBE_LISTENERS(OnAssert, (this, subject, property, object));</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineminus">-  else</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineminus">-    NOTIFY_SUBSCRIBE_LISTENERS(OnUnassert, (this, subject, property, object));</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/mailnews/base/src/nsSubscribeDataSource.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,50 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-#ifndef nsSubscribeDataSource_h__</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-#define nsSubscribeDataSource_h__</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-#include &quot;nsIRDFLiteral.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-#include &quot;nsISubscribableServer.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-#include &quot;nsTObserverArray.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-/**</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">- * The subscribe data source.</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">- */</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-class nsSubscribeDataSource : public nsIRDFDataSource, public nsISubscribeDataSource</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-{</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-public:</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  nsSubscribeDataSource();</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-  nsresult Init();</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  NS_DECL_NSIRDFDATASOURCE</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  NS_DECL_NSISUBSCRIBEDATASOURCE</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-private:</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-  virtual ~nsSubscribeDataSource();</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Child;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Name;</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt;      kNC_LeafName;</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Subscribed;</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Subscribable;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt;      kNC_ServerType;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  nsCOMPtr &lt;nsIRDFLiteral&gt;       kTrueLiteral;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-  nsCOMPtr &lt;nsIRDFLiteral&gt;       kFalseLiteral;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-  nsCOMPtr &lt;nsIRDFService&gt;       mRDFService;</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIRDFObserver&gt; &gt;  mObservers;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-  nsresult GetServerAndRelativePathFromResource(nsIRDFResource *source, nsISubscribableServer **server, char **relativePath);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  nsresult GetServerType(nsISubscribableServer *server, nsACString&amp; serverType);</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-};</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-#endif /* nsSubscribedDataSource_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -65,17 +65,16 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsMsgKeyArray.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsCopyMessageStreamListener.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsMsgCopyService.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsMsgFolderCache.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsMsgStatusFeedback.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsMsgFilterService.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsMsgWindow.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsMsgServiceProvider.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;nsSubscribeDataSource.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> #include &quot;nsSubscribableServer.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> #ifdef NS_PRINTING</span>
<a href="#l8.15"></a><span id="l8.15"> #include &quot;nsMsgPrintEngine.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> #endif</span>
<a href="#l8.17"></a><span id="l8.17"> #include &quot;nsMsgSearchSession.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18"> #include &quot;nsMsgSearchTerm.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19"> #include &quot;nsMsgSearchAdapter.h&quot;</span>
<a href="#l8.20"></a><span id="l8.20"> #include &quot;nsMsgFolderCompactor.h&quot;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -336,17 +335,16 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgPurg</span>
<a href="#l8.22"></a><span id="l8.22"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsStatusBarBiffManager, Init)</span>
<a href="#l8.23"></a><span id="l8.23"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsCopyMessageStreamListener)</span>
<a href="#l8.24"></a><span id="l8.24"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgCopyService)</span>
<a href="#l8.25"></a><span id="l8.25"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgFolderCache)</span>
<a href="#l8.26"></a><span id="l8.26"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgStatusFeedback)</span>
<a href="#l8.27"></a><span id="l8.27"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgKeyArray)</span>
<a href="#l8.28"></a><span id="l8.28"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsMsgWindow,Init)</span>
<a href="#l8.29"></a><span id="l8.29"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsMsgServiceProviderService, Init)</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsSubscribeDataSource, Init)</span>
<a href="#l8.31"></a><span id="l8.31"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsSubscribableServer, Init)</span>
<a href="#l8.32"></a><span id="l8.32"> #ifdef NS_PRINTING</span>
<a href="#l8.33"></a><span id="l8.33"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgPrintEngine)</span>
<a href="#l8.34"></a><span id="l8.34"> #endif</span>
<a href="#l8.35"></a><span id="l8.35"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsFolderCompactState)</span>
<a href="#l8.36"></a><span id="l8.36"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsOfflineStoreCompactState)</span>
<a href="#l8.37"></a><span id="l8.37"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgThreadedDBView)</span>
<a href="#l8.38"></a><span id="l8.38"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgThreadsWithUnreadDBView)</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineat">@@ -396,17 +394,16 @@ NS_DEFINE_NAMED_CID(NS_MSGCOPYSERVICE_CI</span>
<a href="#l8.40"></a><span id="l8.40"> NS_DEFINE_NAMED_CID(NS_MSGFOLDERCACHE_CID);</span>
<a href="#l8.41"></a><span id="l8.41"> NS_DEFINE_NAMED_CID(NS_MSGSTATUSFEEDBACK_CID);</span>
<a href="#l8.42"></a><span id="l8.42"> NS_DEFINE_NAMED_CID(NS_MSGWINDOW_CID);</span>
<a href="#l8.43"></a><span id="l8.43"> NS_DEFINE_NAMED_CID(NS_MSGKEYARRAY_CID);</span>
<a href="#l8.44"></a><span id="l8.44"> #ifdef NS_PRINTING</span>
<a href="#l8.45"></a><span id="l8.45"> NS_DEFINE_NAMED_CID(NS_MSG_PRINTENGINE_CID);</span>
<a href="#l8.46"></a><span id="l8.46"> #endif</span>
<a href="#l8.47"></a><span id="l8.47"> NS_DEFINE_NAMED_CID(NS_MSGSERVICEPROVIDERSERVICE_CID);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_SUBSCRIBEDATASOURCE_CID);</span>
<a href="#l8.49"></a><span id="l8.49"> NS_DEFINE_NAMED_CID(NS_SUBSCRIBABLESERVER_CID);</span>
<a href="#l8.50"></a><span id="l8.50"> NS_DEFINE_NAMED_CID(NS_MSGLOCALFOLDERCOMPACTOR_CID);</span>
<a href="#l8.51"></a><span id="l8.51"> NS_DEFINE_NAMED_CID(NS_MSG_OFFLINESTORECOMPACTOR_CID);</span>
<a href="#l8.52"></a><span id="l8.52"> NS_DEFINE_NAMED_CID(NS_MSGTHREADEDDBVIEW_CID);</span>
<a href="#l8.53"></a><span id="l8.53"> NS_DEFINE_NAMED_CID(NS_MSGTHREADSWITHUNREADDBVIEW_CID);</span>
<a href="#l8.54"></a><span id="l8.54"> NS_DEFINE_NAMED_CID(NS_MSGWATCHEDTHREADSWITHUNREADDBVIEW_CID);</span>
<a href="#l8.55"></a><span id="l8.55"> NS_DEFINE_NAMED_CID(NS_MSGSEARCHDBVIEW_CID);</span>
<a href="#l8.56"></a><span id="l8.56"> NS_DEFINE_NAMED_CID(NS_MSGQUICKSEARCHDBVIEW_CID);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineat">@@ -860,17 +857,16 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l8.58"></a><span id="l8.58">   { &amp;kNS_MSGFOLDERCACHE_CID, false, NULL, nsMsgFolderCacheConstructor},</span>
<a href="#l8.59"></a><span id="l8.59">   { &amp;kNS_MSGSTATUSFEEDBACK_CID, false, NULL, nsMsgStatusFeedbackConstructor},</span>
<a href="#l8.60"></a><span id="l8.60">   { &amp;kNS_MSGKEYARRAY_CID, false, NULL, nsMsgKeyArrayConstructor},</span>
<a href="#l8.61"></a><span id="l8.61">   { &amp;kNS_MSGWINDOW_CID, false, NULL, nsMsgWindowConstructor},</span>
<a href="#l8.62"></a><span id="l8.62"> #ifdef NS_PRINTING</span>
<a href="#l8.63"></a><span id="l8.63">   { &amp;kNS_MSG_PRINTENGINE_CID, false, NULL, nsMsgPrintEngineConstructor},</span>
<a href="#l8.64"></a><span id="l8.64"> #endif</span>
<a href="#l8.65"></a><span id="l8.65">   { &amp;kNS_MSGSERVICEPROVIDERSERVICE_CID, false, NULL, nsMsgServiceProviderServiceConstructor},</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-  { &amp;kNS_SUBSCRIBEDATASOURCE_CID, false, NULL, nsSubscribeDataSourceConstructor},</span>
<a href="#l8.67"></a><span id="l8.67">   { &amp;kNS_SUBSCRIBABLESERVER_CID, false, NULL, nsSubscribableServerConstructor},</span>
<a href="#l8.68"></a><span id="l8.68">   { &amp;kNS_MSGLOCALFOLDERCOMPACTOR_CID, false, NULL, nsFolderCompactStateConstructor},</span>
<a href="#l8.69"></a><span id="l8.69">   { &amp;kNS_MSG_OFFLINESTORECOMPACTOR_CID, false, NULL, nsOfflineStoreCompactStateConstructor},</span>
<a href="#l8.70"></a><span id="l8.70">   { &amp;kNS_MSGTHREADEDDBVIEW_CID, false, NULL, nsMsgThreadedDBViewConstructor},</span>
<a href="#l8.71"></a><span id="l8.71">   { &amp;kNS_MSGTHREADSWITHUNREADDBVIEW_CID, false, NULL, nsMsgThreadsWithUnreadDBViewConstructor},</span>
<a href="#l8.72"></a><span id="l8.72">   { &amp;kNS_MSGWATCHEDTHREADSWITHUNREADDBVIEW_CID, false, NULL, nsMsgWatchedThreadsWithUnreadDBViewConstructor</span>
<a href="#l8.73"></a><span id="l8.73"> },</span>
<a href="#l8.74"></a><span id="l8.74">   { &amp;kNS_MSGSEARCHDBVIEW_CID, false, NULL, nsMsgSearchDBViewConstructor},</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineat">@@ -1069,17 +1065,16 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l8.76"></a><span id="l8.76">   { NS_MSGFOLDERCACHE_CONTRACTID, &amp;kNS_MSGFOLDERCACHE_CID },</span>
<a href="#l8.77"></a><span id="l8.77">   { NS_MSGSTATUSFEEDBACK_CONTRACTID, &amp;kNS_MSGSTATUSFEEDBACK_CID },</span>
<a href="#l8.78"></a><span id="l8.78">   { NS_MSGKEYARRAY_CONTRACTID, &amp;kNS_MSGKEYARRAY_CID },</span>
<a href="#l8.79"></a><span id="l8.79">   { NS_MSGWINDOW_CONTRACTID, &amp;kNS_MSGWINDOW_CID },</span>
<a href="#l8.80"></a><span id="l8.80"> #ifdef NS_PRINTING</span>
<a href="#l8.81"></a><span id="l8.81">   { NS_MSGPRINTENGINE_CONTRACTID, &amp;kNS_MSG_PRINTENGINE_CID },</span>
<a href="#l8.82"></a><span id="l8.82"> #endif</span>
<a href="#l8.83"></a><span id="l8.83">   { NS_MSGSERVICEPROVIDERSERVICE_CONTRACTID, &amp;kNS_MSGSERVICEPROVIDERSERVICE_CID },</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-  { NS_SUBSCRIBEDATASOURCE_CONTRACTID, &amp;kNS_SUBSCRIBEDATASOURCE_CID },</span>
<a href="#l8.85"></a><span id="l8.85">   { NS_SUBSCRIBABLESERVER_CONTRACTID, &amp;kNS_SUBSCRIBABLESERVER_CID },</span>
<a href="#l8.86"></a><span id="l8.86">   { NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;kNS_MSGLOCALFOLDERCOMPACTOR_CID },</span>
<a href="#l8.87"></a><span id="l8.87">   { NS_MSGOFFLINESTORECOMPACTOR_CONTRACTID, &amp;kNS_MSG_OFFLINESTORECOMPACTOR_CID },</span>
<a href="#l8.88"></a><span id="l8.88">   { NS_MSGTHREADEDDBVIEW_CONTRACTID, &amp;kNS_MSGTHREADEDDBVIEW_CID },</span>
<a href="#l8.89"></a><span id="l8.89">   { NS_MSGTHREADSWITHUNREADDBVIEW_CONTRACTID, &amp;kNS_MSGTHREADSWITHUNREADDBVIEW_CID },</span>
<a href="#l8.90"></a><span id="l8.90">   { NS_MSGWATCHEDTHREADSWITHUNREADDBVIEW_CONTRACTID, &amp;kNS_MSGWATCHEDTHREADSWITHUNREADDBVIEW_CID },</span>
<a href="#l8.91"></a><span id="l8.91">   { NS_MSGSEARCHDBVIEW_CONTRACTID, &amp;kNS_MSGSEARCHDBVIEW_CID },</span>
<a href="#l8.92"></a><span id="l8.92">   { NS_MSGQUICKSEARCHDBVIEW_CONTRACTID, &amp;kNS_MSGQUICKSEARCHDBVIEW_CID },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -2644,22 +2644,22 @@ nsImapIncomingServer::GetFirstChildURI(c</span>
<a href="#l9.4"></a><span id="l9.4"> {</span>
<a href="#l9.5"></a><span id="l9.5">   nsresult rv = EnsureInner();</span>
<a href="#l9.6"></a><span id="l9.6">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.7"></a><span id="l9.7">   return mInner-&gt;GetFirstChildURI(path, aResult);</span>
<a href="#l9.8"></a><span id="l9.8"> }</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> NS_IMETHODIMP</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-nsImapIncomingServer::GetChildren(const nsACString &amp;aPath,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-                                  nsISimpleEnumerator **aResult)</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+nsImapIncomingServer::GetChildURIs(const nsACString &amp;aPath,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+                                   nsIUTF8StringEnumerator **aResult)</span>
<a href="#l9.16"></a><span id="l9.16"> {</span>
<a href="#l9.17"></a><span id="l9.17">   nsresult rv = EnsureInner();</span>
<a href="#l9.18"></a><span id="l9.18">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-  return mInner-&gt;GetChildren(aPath, aResult);</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  return mInner-&gt;GetChildURIs(aPath, aResult);</span>
<a href="#l9.21"></a><span id="l9.21"> }</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23"> nsresult</span>
<a href="#l9.24"></a><span id="l9.24"> nsImapIncomingServer::EnsureInner()</span>
<a href="#l9.25"></a><span id="l9.25"> {</span>
<a href="#l9.26"></a><span id="l9.26">   nsresult rv = NS_OK;</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28">   if (mInner)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1325,22 +1325,22 @@ NS_IMETHODIMP</span>
<a href="#l10.4"></a><span id="l10.4"> nsNntpIncomingServer::GetFirstChildURI(const nsACString &amp;path, nsACString &amp;aResult)</span>
<a href="#l10.5"></a><span id="l10.5"> {</span>
<a href="#l10.6"></a><span id="l10.6">   nsresult rv = EnsureInner();</span>
<a href="#l10.7"></a><span id="l10.7">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.8"></a><span id="l10.8">   return mInner-&gt;GetFirstChildURI(path, aResult);</span>
<a href="#l10.9"></a><span id="l10.9"> }</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> NS_IMETHODIMP</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-nsNntpIncomingServer::GetChildren(const nsACString &amp;aPath,</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-                                  nsISimpleEnumerator **aResult)</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+nsNntpIncomingServer::GetChildURIs(const nsACString &amp;aPath,</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+                                   nsIUTF8StringEnumerator **aResult)</span>
<a href="#l10.16"></a><span id="l10.16"> {</span>
<a href="#l10.17"></a><span id="l10.17">   nsresult rv = EnsureInner();</span>
<a href="#l10.18"></a><span id="l10.18">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-  return mInner-&gt;GetChildren(aPath, aResult);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  return mInner-&gt;GetChildURIs(aPath, aResult);</span>
<a href="#l10.21"></a><span id="l10.21"> }</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23"> NS_IMETHODIMP</span>
<a href="#l10.24"></a><span id="l10.24"> nsNntpIncomingServer::CommitSubscribeChanges()</span>
<a href="#l10.25"></a><span id="l10.25"> {</span>
<a href="#l10.26"></a><span id="l10.26">   // we force the newrc to be dirty, so it will get written out when</span>
<a href="#l10.27"></a><span id="l10.27">   // we call WriteNewsrcFile()</span>
<a href="#l10.28"></a><span id="l10.28">   nsresult rv = SetNewsrcHasChanged(true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/news/test/unit/test_internalUris.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_internalUris.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -149,36 +149,39 @@ function* test_grouplist() {</span>
<a href="#l11.4"></a><span id="l11.4">   // This tests nsNntpService::GetListOfGroupsOnServer</span>
<a href="#l11.5"></a><span id="l11.5">   let subserver = localserver.QueryInterface(Ci.nsISubscribableServer);</span>
<a href="#l11.6"></a><span id="l11.6">   let subscribeListener = {</span>
<a href="#l11.7"></a><span id="l11.7">     OnDonePopulating: function () { async_driver(); }</span>
<a href="#l11.8"></a><span id="l11.8">   };</span>
<a href="#l11.9"></a><span id="l11.9">   subserver.subscribeListener = subscribeListener;</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11">   function enumGroups(rootUri) {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    let hierarchy = subserver.getChildren(rootUri);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    let hierarchy = subserver.getChildURIs(rootUri);</span>
<a href="#l11.14"></a><span id="l11.14">     let groups = [];</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-    while (hierarchy.hasMoreElements()) {</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-      let element = hierarchy.getNext().QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-      let name = element.ValueUTF8;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-      name = name.slice(name.lastIndexOf(&quot;/&quot;) + 1);</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+    for (let name of hierarchy) {</span>
<a href="#l11.20"></a><span id="l11.20">       if (subserver.isSubscribable(name))</span>
<a href="#l11.21"></a><span id="l11.21">         groups.push(name);</span>
<a href="#l11.22"></a><span id="l11.22">       if (subserver.hasChildren(name))</span>
<a href="#l11.23"></a><span id="l11.23">         groups = groups.concat(enumGroups(name));</span>
<a href="#l11.24"></a><span id="l11.24">     }</span>
<a href="#l11.25"></a><span id="l11.25">     return groups;</span>
<a href="#l11.26"></a><span id="l11.26">   }</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">   MailServices.nntp.getListOfGroupsOnServer(localserver, null, false);</span>
<a href="#l11.29"></a><span id="l11.29">   yield false;</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31">   let groups = enumGroups(&quot;&quot;);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-  for (let group in daemon._groups)</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-    Assert.ok(groups.indexOf(group) &gt;= 0);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+  Assert.equal(groups.length, Object.keys(daemon._groups).length);</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  for (let group in daemon._groups) {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+    Assert.ok(groups.includes(group));</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+  }</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+  // First node in the group list, even though it is not subscribable,</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+  // parent of &quot;test.empty&quot; group.</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+  Assert.equal(subserver.getFirstChildURI(&quot;&quot;), &quot;test&quot;);</span>
<a href="#l11.42"></a><span id="l11.42"> </span>
<a href="#l11.43"></a><span id="l11.43">   // Release reference, somehow impedes GC of 'subserver'.</span>
<a href="#l11.44"></a><span id="l11.44">   subserver.subscribeListener = null;</span>
<a href="#l11.45"></a><span id="l11.45">   yield true;</span>
<a href="#l11.46"></a><span id="l11.46"> }</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48"> function* test_postMessage() {</span>
<a href="#l11.49"></a><span id="l11.49">   // This tests nsNntpService::SetUpNntpUrlForPosting via PostMessage</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

