<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6102:b9e980d6f85d8be090681db70a0be5a06d5b216d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b9e980d6f85d8be090681db70a0be5a06d5b216d" />
<meta property="og:url" content="/comm-central/rev/b9e980d6f85d8be090681db70a0be5a06d5b216d" />
<meta property="og:description" content="bug 557496 - Port Firefox bookmarks tests to SeaMonkey, r=Callek" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b9e980d6f85d8be090681db70a0be5a06d5b216d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b9e980d6f85d8be090681db70a0be5a06d5b216d">shortlog</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b9e980d6f85d8be090681db70a0be5a06d5b216d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d">files</a> |
changeset |
<a href="/comm-central/raw-rev/b9e980d6f85d8be090681db70a0be5a06d5b216d">raw</a>  | <a href="/comm-central/archive/b9e980d6f85d8be090681db70a0be5a06d5b216d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=557496">bug 557496</a> - Port Firefox bookmarks tests to SeaMonkey, r=Callek
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#111;&#98;&#101;&#114;&#116;&#32;&#75;&#97;&#105;&#115;&#101;&#114;&#32;&#60;&#107;&#97;&#105;&#114;&#111;&#64;&#107;&#97;&#105;&#114;&#111;&#46;&#97;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 08 Aug 2010 22:06:47 +0200</td></tr>

<tr>
 <td>changeset 6102</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b9e980d6f85d8be090681db70a0be5a06d5b216d">b9e980d6f85d8be090681db70a0be5a06d5b216d</a></td>
</tr>



<tr>
<td>parent 6101</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b7d14a8dd2d0b25bf30b7bbf09319d796376f147">b7d14a8dd2d0b25bf30b7bbf09319d796376f147</a>
</td>
</tr>

<tr>
<td>child 6103</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3af9425f87527b77561d64ecc539696fe1ce2a87">3af9425f87527b77561d64ecc539696fe1ce2a87</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b9e980d6f85d8be090681db70a0be5a06d5b216d">4716</a></td></tr>
<tr><td>push user</td><td>kairo@kairo.at</td></tr>
<tr><td>push date</td><td class="date age">Sun, 08 Aug 2010 20:07:31 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b9e980d6f85d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b9e980d6f85d8be090681db70a0be5a06d5b216d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b9e980d6f85d8be090681db70a0be5a06d5b216d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9e980d6f85d8be090681db70a0be5a06d5b216d&newProject=comm-central&newRevision=6e9656086f3397ba950d84983e1878cb757598d0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9e980d6f85d8be090681db70a0be5a06d5b216d&newProject=comm-central&newRevision=6e9656086f3397ba950d84983e1878cb757598d0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9e980d6f85d8be090681db70a0be5a06d5b216d&newProject=comm-central&newRevision=6e9656086f3397ba950d84983e1878cb757598d0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Callek%29&revcount=50">Callek</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=557496">557496</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=557496">bug 557496</a> - Port Firefox bookmarks tests to SeaMonkey, r=Callek</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/Makefile.in">suite/common/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/Makefile.in">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/Makefile.in">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/Makefile.in">suite/common/places/tests/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/Makefile.in">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/Makefile.in">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_0_library_left_pane_migration.js">suite/common/places/tests/browser/browser_0_library_left_pane_migration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_0_library_left_pane_migration.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_0_library_left_pane_migration.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_0_library_left_pane_migration.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_0_library_left_pane_migration.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_0_library_left_pane_migration.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_423515.js">suite/common/places/tests/browser/browser_423515.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_423515.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_423515.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_423515.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_423515.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_423515.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_425884.js">suite/common/places/tests/browser/browser_425884.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_425884.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_425884.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_425884.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_425884.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_425884.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_457473_no_copy_guid.js">suite/common/places/tests/browser/browser_457473_no_copy_guid.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_457473_no_copy_guid.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_457473_no_copy_guid.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_457473_no_copy_guid.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_457473_no_copy_guid.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_457473_no_copy_guid.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_drag_bookmarks_on_toolbar.js">suite/common/places/tests/browser/browser_drag_bookmarks_on_toolbar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_drag_bookmarks_on_toolbar.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_drag_bookmarks_on_toolbar.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_drag_bookmarks_on_toolbar.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_drag_bookmarks_on_toolbar.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_drag_bookmarks_on_toolbar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_infoBox.js">suite/common/places/tests/browser/browser_library_infoBox.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_infoBox.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_infoBox.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_infoBox.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_infoBox.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_infoBox.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_left_pane_commands.js">suite/common/places/tests/browser/browser_library_left_pane_commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_left_pane_commands.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_left_pane_commands.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_left_pane_commands.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_left_pane_commands.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_left_pane_commands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_left_pane_fixnames.js">suite/common/places/tests/browser/browser_library_left_pane_fixnames.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_left_pane_fixnames.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_left_pane_fixnames.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_left_pane_fixnames.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_left_pane_fixnames.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_left_pane_fixnames.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_open_leak.js">suite/common/places/tests/browser/browser_library_open_leak.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_open_leak.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_open_leak.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_open_leak.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_open_leak.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_open_leak.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_views_liveupdate.js">suite/common/places/tests/browser/browser_library_views_liveupdate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_views_liveupdate.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_views_liveupdate.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_views_liveupdate.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_views_liveupdate.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_library_views_liveupdate.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_sort_in_library.js">suite/common/places/tests/browser/browser_sort_in_library.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_sort_in_library.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_sort_in_library.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_sort_in_library.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_sort_in_library.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_sort_in_library.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_ui_000_data.js">suite/common/places/tests/browser/browser_ui_000_data.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_ui_000_data.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_ui_000_data.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_ui_000_data.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_ui_000_data.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_ui_000_data.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_ui_history_menu.js">suite/common/places/tests/browser/browser_ui_history_menu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_ui_history_menu.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_ui_history_menu.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_ui_history_menu.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_ui_history_menu.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/browser_ui_history_menu.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/head.js">suite/common/places/tests/browser/head.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/head.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/head.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/head.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/head.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/browser/head.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/perf_large_delete.xul">suite/common/places/tests/chrome/perf_large_delete.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/perf_large_delete.xul">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/perf_large_delete.xul">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/perf_large_delete.xul">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/perf_large_delete.xul">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/perf_large_delete.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_0_bug510634.xul">suite/common/places/tests/chrome/test_0_bug510634.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_0_bug510634.xul">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_0_bug510634.xul">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_0_bug510634.xul">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_0_bug510634.xul">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_0_bug510634.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_0_multiple_left_pane.xul">suite/common/places/tests/chrome/test_0_multiple_left_pane.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_0_multiple_left_pane.xul">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_0_multiple_left_pane.xul">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_0_multiple_left_pane.xul">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_0_multiple_left_pane.xul">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_0_multiple_left_pane.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug427633_no_newfolder_if_noip.xul">suite/common/places/tests/chrome/test_bug427633_no_newfolder_if_noip.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug427633_no_newfolder_if_noip.xul">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug427633_no_newfolder_if_noip.xul">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug427633_no_newfolder_if_noip.xul">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug427633_no_newfolder_if_noip.xul">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug427633_no_newfolder_if_noip.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug485100-change-case-loses-tag.xul">suite/common/places/tests/chrome/test_bug485100-change-case-loses-tag.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug485100-change-case-loses-tag.xul">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug485100-change-case-loses-tag.xul">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug485100-change-case-loses-tag.xul">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug485100-change-case-loses-tag.xul">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug485100-change-case-loses-tag.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug549192.xul">suite/common/places/tests/chrome/test_bug549192.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug549192.xul">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug549192.xul">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug549192.xul">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug549192.xul">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug549192.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug549491.xul">suite/common/places/tests/chrome/test_bug549491.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug549491.xul">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug549491.xul">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug549491.xul">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug549491.xul">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_bug549491.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_treeview_date.xul">suite/common/places/tests/chrome/test_treeview_date.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_treeview_date.xul">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_treeview_date.xul">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_treeview_date.xul">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_treeview_date.xul">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/chrome/test_treeview_date.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.corrupt.html">suite/common/places/tests/unit/bookmarks.corrupt.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.corrupt.html">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.corrupt.html">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.corrupt.html">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.corrupt.html">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.corrupt.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.glue.html">suite/common/places/tests/unit/bookmarks.glue.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.glue.html">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.glue.html">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.glue.html">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.glue.html">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.glue.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.glue.json">suite/common/places/tests/unit/bookmarks.glue.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.glue.json">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.glue.json">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.glue.json">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.glue.json">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.glue.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.preplaces.html">suite/common/places/tests/unit/bookmarks.preplaces.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.preplaces.html">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.preplaces.html">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.preplaces.html">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.preplaces.html">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/bookmarks.preplaces.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/corruptDB.sqlite">suite/common/places/tests/unit/corruptDB.sqlite</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/corruptDB.sqlite">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/corruptDB.sqlite">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/corruptDB.sqlite">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/corruptDB.sqlite">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/corruptDB.sqlite">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/distribution.ini">suite/common/places/tests/unit/distribution.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/distribution.ini">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/distribution.ini">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/distribution.ini">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/distribution.ini">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/distribution.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/head_bookmarks.js">suite/common/places/tests/unit/head_bookmarks.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/head_bookmarks.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/head_bookmarks.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/head_bookmarks.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/head_bookmarks.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/head_bookmarks.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_384370.js">suite/common/places/tests/unit/test_384370.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_384370.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_384370.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_384370.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_384370.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_384370.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_398914.js">suite/common/places/tests/unit/test_398914.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_398914.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_398914.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_398914.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_398914.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_398914.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_421483.js">suite/common/places/tests/unit/test_421483.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_421483.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_421483.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_421483.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_421483.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_421483.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js">suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js">suite/common/places/tests/unit/test_bookmarksRestoreNotification.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_bookmarks_html.js">suite/common/places/tests/unit/test_bookmarks_html.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_bookmarks_html.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_bookmarks_html.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_bookmarks_html.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_bookmarks_html.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_bookmarks_html.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt.js">suite/common/places/tests/unit/test_browserGlue_corrupt.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup.js">suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup_default.js">suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup_default.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup_default.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup_default.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup_default.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup_default.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup_default.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_distribution.js">suite/common/places/tests/unit/test_browserGlue_distribution.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_distribution.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_distribution.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_distribution.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_distribution.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_distribution.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_migrate.js">suite/common/places/tests/unit/test_browserGlue_migrate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_migrate.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_migrate.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_migrate.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_migrate.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_migrate.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_prefs.js">suite/common/places/tests/unit/test_browserGlue_prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_prefs.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_prefs.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_prefs.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_prefs.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_prefs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_restore.js">suite/common/places/tests/unit/test_browserGlue_restore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_restore.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_restore.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_restore.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_restore.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_restore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_shutdown.js">suite/common/places/tests/unit/test_browserGlue_shutdown.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_shutdown.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_shutdown.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_shutdown.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_shutdown.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_shutdown.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js">suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_clearHistory_shutdown.js">suite/common/places/tests/unit/test_clearHistory_shutdown.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_clearHistory_shutdown.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_clearHistory_shutdown.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_clearHistory_shutdown.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_clearHistory_shutdown.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_clearHistory_shutdown.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_leftpane_corruption_handling.js">suite/common/places/tests/unit/test_leftpane_corruption_handling.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_leftpane_corruption_handling.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_leftpane_corruption_handling.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_leftpane_corruption_handling.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_leftpane_corruption_handling.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_leftpane_corruption_handling.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_placesTxn.js">suite/common/places/tests/unit/test_placesTxn.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_placesTxn.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_placesTxn.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_placesTxn.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_placesTxn.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_placesTxn.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_txnGUIDs.js">suite/common/places/tests/unit/test_txnGUIDs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_txnGUIDs.js">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_txnGUIDs.js">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_txnGUIDs.js">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_txnGUIDs.js">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tests/unit/test_txnGUIDs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tree.xml">suite/common/places/tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tree.xml">file</a> |
<a href="/comm-central/annotate/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tree.xml">annotate</a> |
<a href="/comm-central/diff/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tree.xml">diff</a> |
<a href="/comm-central/comparison/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tree.xml">comparison</a> |
<a href="/comm-central/log/b9e980d6f85d8be090681db70a0be5a06d5b216d/suite/common/places/tree.xml">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/common/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/common/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -40,17 +40,17 @@ topsrcdir	= @top_srcdir@</span>
<a href="#l1.4"></a><span id="l1.4"> srcdir		= @srcdir@</span>
<a href="#l1.5"></a><span id="l1.5"> VPATH		= @srcdir@</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> PARALLEL_DIRS = public src</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> ifdef ENABLE_TESTS</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-PARALLEL_DIRS += tests downloads/tests</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+PARALLEL_DIRS += tests downloads/tests places/tests</span>
<a href="#l1.14"></a><span id="l1.14"> endif</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> abs_srcdir = $(call core_abspath,$(srcdir))</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> CHROME_DEPS += $(abs_srcdir)/app-license.html</span>
<a href="#l1.21"></a><span id="l1.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/suite/common/places/tests/Makefile.in</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,85 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+#</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+#</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+# License.</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+#</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+# The Original Code is mozilla.org code.</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+#</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+# Mozilla.org.</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+#</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+# Contributor(s):</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+#     Boris Zbarsky &lt;bzbarsky@mit.edu&gt;  (Original author)</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+#     Karsten Dsterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+#</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+#</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+DEPTH		= ../../../..</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+topsrcdir	= @top_srcdir@</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+srcdir		= @srcdir@</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+VPATH		= @srcdir@</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+relativesrcdir = suite/common/places/tests</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+MODULE = test_suite_places</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+XPCSHELL_TESTS = unit</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+_CHROME_FILES = \</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+    test_treeview_date.xul \</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+    test_bug485100-change-case-loses-tag.xul \</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    test_bug427633_no_newfolder_if_noip.xul \</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+    test_0_multiple_left_pane.xul \</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+    test_0_bug510634.xul \</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+    test_bug549192.xul \</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+    test_bug549491.xul \</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    perf_large_delete.xul \</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    $(NULL)</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+_BROWSER_FILES = \</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    head.js \</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    browser_0_library_left_pane_migration.js \</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    browser_library_left_pane_fixnames.js \</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+    browser_425884.js \</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    browser_423515.js \</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+    browser_457473_no_copy_guid.js \</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    browser_sort_in_library.js \</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+    browser_library_open_leak.js \</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+    browser_library_left_pane_commands.js \</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+    browser_drag_bookmarks_on_toolbar.js \</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+    browser_library_views_liveupdate.js \</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+    browser_library_infoBox.js \</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+    browser_ui_000_data.js \</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+    browser_ui_history_menu.js \</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+    $(NULL)</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+libs:: $(addprefix chrome/, $(_CHROME_FILES))</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+	$(INSTALL) $(foreach f,$^,&quot;$f&quot;) $(MOZDEPTH)/_tests/testing/mochitest/chrome/$(relativesrcdir)</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+libs:: $(addprefix browser/, $(_BROWSER_FILES))</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+	$(INSTALL) $(foreach f,$^,&quot;$f&quot;) $(MOZDEPTH)/_tests/testing/mochitest/browser/$(relativesrcdir)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_0_library_left_pane_migration.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,142 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ *</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ *</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+ * License.</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+ *</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ * The Original Code is Places test code.</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ *</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+ *</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt; (Original Author)</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+ *</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+ * decision by devaring the provisions above and replace them with the notice</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not devare</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+ *</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+/**</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+ *  Test we correctly migrate Library left pane to the latest version.</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+ *  Note: this test MUST be the first between browser chrome tests, or results</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+ *        of next tests could be unexpected due to PlacesUIUtils getters.</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+ */</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+const TEST_URI = &quot;http://www.mozilla.org/&quot;;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+var ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+         getService(Ci.nsIWindowWatcher);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+function windowObserver(aSubject, aTopic, aData) {</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  if (aTopic != &quot;domwindowopened&quot;)</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    return;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+  ww.unregisterNotification(windowObserver);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+  var organizer = aSubject.QueryInterface(Ci.nsIDOMWindow);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  organizer.addEventListener(&quot;load&quot;, function onLoad(event) {</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    organizer.removeEventListener(&quot;load&quot;, onLoad, false);</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+    executeSoon(function () {</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+      // Check left pane.</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+      ok(PlacesUIUtils.leftPaneFolderId &gt; 0,</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+         &quot;Left pane folder correctly created&quot;);</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+      var leftPaneItems =</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+        PlacesUtils.annotations</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+                   .getItemsWithAnnotation(PlacesUIUtils.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+      is(leftPaneItems.length, 1,</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+         &quot;We correctly have only 1 left pane folder&quot;);</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+      var leftPaneRoot = leftPaneItems[0];</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+      is(leftPaneRoot, PlacesUIUtils.leftPaneFolderId,</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+         &quot;leftPaneFolderId getter has correct value&quot;);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+      // Check version has been upgraded.</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+      var version =</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+        PlacesUtils.annotations.getItemAnnotation(leftPaneRoot,</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+                                                  PlacesUIUtils.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+      is(version, PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION,</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+         &quot;Left pane version has been correctly upgraded&quot;);</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+      // Check left pane is populated.</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+      organizer.PlacesOrganizer.selectLeftPaneQuery('AllBookmarks');</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+      is(organizer.PlacesOrganizer._places.selectedNode.itemId,</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+         PlacesUIUtils.leftPaneQueries[&quot;AllBookmarks&quot;],</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+         &quot;Library left pane is populated and working&quot;);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+      // Close Library window.</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+      organizer.close();</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+      // No need to cleanup anything, we have a correct left pane now.</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+      finish();</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+    });</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+  }, false);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+}</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+function test() {</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+  waitForExplicitFinish();</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+  // Sanity checks.</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+  ok(PlacesUtils, &quot;PlacesUtils is running in chrome context&quot;);</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+  ok(PlacesUIUtils, &quot;PlacesUIUtils is running in chrome context&quot;);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+  ok(PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION &gt; 0,</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+     &quot;Left pane version in chrome context, current version is: &quot; + PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION );</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  // Check if we have any left pane folder already set, remove it eventually.</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+  var leftPaneItems = PlacesUtils.annotations</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+                                 .getItemsWithAnnotation(PlacesUIUtils.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+  if (leftPaneItems.length &gt; 0) {</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+    // The left pane has already been created, touching it now would cause</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+    // next tests to rely on wrong values (and possibly crash)</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+    is(leftPaneItems.length, 1, &quot;We correctly have only 1 left pane folder&quot;);</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+    // Check version.</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+    var version = PlacesUtils.annotations.getItemAnnotation(leftPaneItems[0],</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+                                                            PlacesUIUtils.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+    is(version, PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION, &quot;Left pane version is actual&quot;);</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+    ok(true, &quot;left pane has already been created, skipping test&quot;);</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+    finish();</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+    return;</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+  }</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+  // Create a fake left pane folder with an old version (current version - 1).</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+  var fakeLeftPaneRoot =</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+    PlacesUtils.bookmarks.createFolder(PlacesUtils.placesRootId, &quot;&quot;,</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+                                       PlacesUtils.bookmarks.DEFAULT_INDEX);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+  PlacesUtils.annotations.setItemAnnotation(fakeLeftPaneRoot,</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+                                            PlacesUIUtils.ORGANIZER_FOLDER_ANNO,</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+                                            PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION - 1,</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+                                            0,</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+                                            PlacesUtils.annotations.EXPIRE_NEVER);</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+  // Check fake left pane root has been correctly created.</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+  var leftPaneItems =</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+    PlacesUtils.annotations.getItemsWithAnnotation(PlacesUIUtils.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+  is(leftPaneItems.length, 1, &quot;We correctly have only 1 left pane folder&quot;);</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+  is(leftPaneItems[0], fakeLeftPaneRoot, &quot;left pane root itemId is correct&quot;);</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+  // Check version.</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+  var version = PlacesUtils.annotations.getItemAnnotation(fakeLeftPaneRoot,</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+                                                          PlacesUIUtils.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+  is(version, PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION - 1, &quot;Left pane version correctly set&quot;);</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+  // Open Library, this will upgrade our left pane version.</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+  ww.registerNotification(windowObserver);</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+  ww.openWindow(null,</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+                &quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;,</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+                &quot;&quot;,</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+                &quot;chrome,toolbar=yes,dialog=no,resizable&quot;,</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+                null);</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_423515.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,250 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ *</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ *</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ * License.</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ *</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ * The Original Code is Places test code.</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ *</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+ *</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+ *  Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ *</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ *</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+function test() {</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  // sanity check</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  ok(PlacesUtils, &quot;checking PlacesUtils, running in chrome context?&quot;);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  ok(PlacesUIUtils, &quot;checking PlacesUIUtils, running in chrome context?&quot;);</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  ok(PlacesControllerDragHelper, &quot;checking PlacesControllerDragHelper, running in chrome context?&quot;);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  const IDX = PlacesUtils.bookmarks.DEFAULT_INDEX;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  // setup</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  var rootId = PlacesUtils.bookmarks.createFolder(PlacesUtils.toolbarFolderId, &quot;&quot;, IDX);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+  var rootNode = PlacesUtils.getFolderContents(rootId, false, true).root;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  is(rootNode.childCount, 0, &quot;confirm test root is empty&quot;);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  var tests = [];</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  // add a regular folder, should be moveable</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  tests.push({</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    populate: function() {</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      this.id =</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+        PlacesUtils.bookmarks.createFolder(rootId, &quot;&quot;, IDX);</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+    },</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+    validate: function() {</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+      is(rootNode.childCount, 1,</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+        &quot;populate added data to the test root&quot;);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+      is(PlacesControllerDragHelper.canMoveContainer(this.id),</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+         true, &quot;can move regular folder id&quot;);</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+      is(PlacesControllerDragHelper.canMoveNode(rootNode.getChild(0)),</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+         true, &quot;can move regular folder node&quot;);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    }</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  });</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  // add a regular folder shortcut, should be moveable</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+  tests.push({</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+    populate: function() {</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+      this.folderId =</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+        PlacesUtils.bookmarks.createFolder(rootId, &quot;foo&quot;, IDX);</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+      this.shortcutId =</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+        PlacesUtils.bookmarks.insertBookmark(rootId, makeURI(&quot;place:folder=&quot;+this.folderId), IDX, &quot;bar&quot;);</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+    },</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+    validate: function() {</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+      is(rootNode.childCount, 2,</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+        &quot;populated data to the test root&quot;);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+      var folderNode = rootNode.getChild(0);</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+      is(folderNode.type, 6, &quot;node is folder&quot;);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+      is(this.folderId, folderNode.itemId, &quot;folder id and folder node item id match&quot;);</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+      var shortcutNode = rootNode.getChild(1);</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+      is(shortcutNode.type, 9, &quot;node is folder shortcut&quot;);</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+      is(this.shortcutId, shortcutNode.itemId, &quot;shortcut id and shortcut node item id match&quot;);</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+      var concreteId = PlacesUtils.getConcreteItemId(shortcutNode);</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+      is(concreteId, folderNode.itemId, &quot;shortcut node id and concrete id match&quot;);</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+      is(PlacesControllerDragHelper.canMoveContainer(this.shortcutId),</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+         true, &quot;can move folder shortcut id&quot;);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+      is(PlacesControllerDragHelper.canMoveNode(shortcutNode),</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+         true, &quot;can move folder shortcut node&quot;);</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+    }</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+  });</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+  // add a regular query, should be moveable</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  tests.push({</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+    populate: function() {</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+      this.bookmarkId =</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+        PlacesUtils.bookmarks.insertBookmark(rootId, makeURI(&quot;http://foo.com&quot;), IDX, &quot;foo&quot;);</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+      this.queryId =</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+        PlacesUtils.bookmarks.insertBookmark(rootId, makeURI(&quot;place:terms=foo&quot;), IDX, &quot;bar&quot;);</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+    },</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+    validate: function() {</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+      is(rootNode.childCount, 2,</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+        &quot;populated data to the test root&quot;);</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+      var bmNode = rootNode.getChild(0);</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+      is(bmNode.itemId, this.bookmarkId, &quot;bookmark id and bookmark node item id match&quot;);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+      var queryNode = rootNode.getChild(1);</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+      is(queryNode.itemId, this.queryId, &quot;query id and query node item id match&quot;);</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+      is(PlacesControllerDragHelper.canMoveContainer(this.queryId),</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+         true, &quot;can move query id&quot;);</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+      is(PlacesControllerDragHelper.canMoveNode(queryNode),</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+         true, &quot;can move query node&quot;);</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+    }</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+  });</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+  // test that special folders cannot be moved</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+  // test that special folders shortcuts can be moved</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+  tests.push({</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+    folders: [PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+              PlacesUtils.tagsFolderId, PlacesUtils.unfiledBookmarksFolderId,</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+              PlacesUtils.toolbarFolderId],</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+    shortcuts: {},</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+    populate: function() {</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+      for (var i = 0; i &lt; this.folders.length; i++) {</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+        var id = this.folders[i];</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+        this.shortcuts[id] =</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+          PlacesUtils.bookmarks.insertBookmark(rootId, makeURI(&quot;place:folder=&quot; + id), IDX, &quot;&quot;);</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+      }</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+    },</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+    validate: function() {</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+      // test toolbar shortcut node</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+      is(rootNode.childCount, this.folders.length,</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+        &quot;populated data to the test root&quot;);</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+      function getRootChildNode(aId) {</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+        var node = PlacesUtils.getFolderContents(PlacesUtils.placesRootId, false, true).root;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+        for (var i = 0; i &lt; node.childCount; i++) {</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+          var child = node.getChild(i);</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+          if (child.itemId == aId) {</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+            node.containerOpen = false;</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+            return child;</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+          }</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+        }</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+        node.containerOpen = false;</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+        ok(false, &quot;Unable to find child node&quot;);</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+        return null;</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+      }</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+      for (var i = 0; i &lt; this.folders.length; i++) {</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+        var id = this.folders[i];</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+        is(PlacesControllerDragHelper.canMoveContainer(id),</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+           false, &quot;shouldn't be able to move special folder id&quot;);</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+        var node = getRootChildNode(id);</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+        isnot(node, null, &quot;Node found&quot;);</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+        is(PlacesControllerDragHelper.canMoveNode(node),</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+           false, &quot;shouldn't be able to move special folder node&quot;);</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+        var shortcutId = this.shortcuts[id];</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+        var shortcutNode = rootNode.getChild(i);</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+        is(shortcutNode.itemId, shortcutId, &quot;shortcut id and shortcut node item id match&quot;);</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+        dump(&quot;can move shortcut id?\n&quot;);</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+        is(PlacesControllerDragHelper.canMoveContainer(shortcutId),</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+           true, &quot;should be able to move special folder shortcut id&quot;);</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+        dump(&quot;can move shortcut node?\n&quot;);</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+        is(PlacesControllerDragHelper.canMoveNode(shortcutNode),</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+           true, &quot;should be able to move special folder shortcut node&quot;);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+      }</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+    }</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+  });</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+  // test that a tag container cannot be moved</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+  tests.push({</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+    populate: function() {</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+      // tag a uri</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+      this.uri = makeURI(&quot;http://foo.com&quot;);</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+      PlacesUtils.tagging.tagURI(this.uri, [&quot;bar&quot;]);</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+    },</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+    validate: function() {</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+      // get tag root</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+      var query = PlacesUtils.history.getNewQuery();</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+      var options = PlacesUtils.history.getNewQueryOptions();</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+      options.resultType = Ci.nsINavHistoryQueryOptions.RESULTS_AS_TAG_QUERY;</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+      var tagsNode = PlacesUtils.history.executeQuery(query, options).root;</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+      tagsNode.containerOpen = true;</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+      is(tagsNode.childCount, 1, &quot;has new tag&quot;);</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+      var tagNode = tagsNode.getChild(0);</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+      is(PlacesControllerDragHelper.canMoveNode(tagNode),</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+         false, &quot;should not be able to move tag container node&quot;);</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+      tagsNode.containerOpen = false;</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+    }</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+  });</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+  // test that any child of a read-only node cannot be moved</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+  tests.push({</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+    populate: function() {</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+      this.id =</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+        PlacesUtils.bookmarks.createFolder(rootId, &quot;foo&quot;, IDX);</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+      PlacesUtils.bookmarks.createFolder(this.id, &quot;bar&quot;, IDX);</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+      PlacesUtils.bookmarks.setFolderReadonly(this.id, true);</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+    },</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+    validate: function() {</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+      is(rootNode.childCount, 1,</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+        &quot;populate added data to the test root&quot;);</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+      var readOnlyFolder = rootNode.getChild(0);</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+      // test that we can move the read-only folder</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+      is(PlacesControllerDragHelper.canMoveContainer(this.id),</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+         true, &quot;can move read-only folder id&quot;);</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+      is(PlacesControllerDragHelper.canMoveNode(readOnlyFolder),</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+         true, &quot;can move read-only folder node&quot;);</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+      // test that we cannot move the child of a read-only folder</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+      readOnlyFolder.QueryInterface(Ci.nsINavHistoryContainerResultNode);</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+      readOnlyFolder.containerOpen = true;</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+      var childFolder = readOnlyFolder.getChild(0);</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+      is(PlacesControllerDragHelper.canMoveContainer(childFolder.itemId),</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+         false, &quot;cannot move a child of a read-only folder&quot;);</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+      is(PlacesControllerDragHelper.canMoveNode(childFolder),</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+         false, &quot;cannot move a child node of a read-only folder node&quot;);</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+    }</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+  });</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+  tests.forEach(function(aTest) {</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+    PlacesUtils.bookmarks.removeFolderChildren(rootId);</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+    aTest.populate();</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+    aTest.validate();</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+  });</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+  PlacesUtils.bookmarks.removeItem(rootId);</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_425884.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,133 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+ *</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+ *</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+ * License.</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+ *</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+ * The Original Code is Places test code.</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+ *</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+ *</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+ *  Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+ *</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+ *</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+function test() {</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+  // sanity check</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  ok(PlacesUtils, &quot;checking PlacesUtils, running in chrome context?&quot;);</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  ok(PlacesUIUtils, &quot;checking PlacesUIUtils, running in chrome context?&quot;);</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  /*</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+   Deep copy of bookmark data, using the front-end codepath:</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+   - create test folder A</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+   - add a subfolder to folder A, and add items to it</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+   - validate folder A (sanity check)</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+   - copy folder A, creating new folder B, using the front-end path</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+   - validate folder B</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+   - undo copy transaction</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+   - validate folder B (empty)</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+   - redo copy transaction</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+   - validate folder B's contents</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+  */</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+  var toolbarId = PlacesUtils.toolbarFolderId;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+  var toolbarNode = PlacesUtils.getFolderContents(toolbarId).root;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+  var oldCount = toolbarNode.childCount;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+  var testRootId = PlacesUtils.bookmarks.createFolder(toolbarId, &quot;test root&quot;, -1);</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+  is(toolbarNode.childCount, oldCount+1, &quot;confirm test root node is a container, and is empty&quot;);</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+  var testRootNode = toolbarNode.getChild(toolbarNode.childCount-1);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  testRootNode.QueryInterface(Ci.nsINavHistoryContainerResultNode);</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  testRootNode.containerOpen = true;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+  is(testRootNode.childCount, 0, &quot;confirm test root node is a container, and is empty&quot;);</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+  // create folder A, fill it, validate its contents</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  var folderAId = PlacesUtils.bookmarks.createFolder(testRootId, &quot;A&quot;, -1);</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+  populate(folderAId);</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  var folderANode = PlacesUtils.getFolderContents(folderAId).root;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+  validate(folderANode);</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+  is(testRootNode.childCount, 1, &quot;create test folder&quot;);</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+  // copy it, using the front-end helper functions</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+  var serializedNode = PlacesUtils.wrapNode(folderANode, PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER);</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+  var rawNode = PlacesUtils.unwrapNodes(serializedNode, PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER).shift();</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+  // confirm serialization</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+  ok(rawNode.type, &quot;confirm json node&quot;);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+  var transaction = PlacesUIUtils.makeTransaction(rawNode,</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+                                                  PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER,</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+                                                  testRootId,</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+                                                  -1,</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+                                                  true);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+  ok(transaction, &quot;create transaction&quot;);</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+  PlacesUIUtils.ptm.doTransaction(transaction);</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+  // confirm copy</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+  is(testRootNode.childCount, 2, &quot;create test folder via copy&quot;);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+  // validate the copy</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+  var folderBNode = testRootNode.getChild(1);</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+  validate(folderBNode);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+  // undo the transaction, confirm the removal</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  PlacesUIUtils.ptm.undoTransaction();</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+  is(testRootNode.childCount, 1, &quot;confirm undo removed the copied folder&quot;);</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  // redo the transaction</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+  PlacesUIUtils.ptm.redoTransaction();</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+  is(testRootNode.childCount, 2, &quot;confirm redo re-copied the folder&quot;);</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+  folderBNode = testRootNode.getChild(1);</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+  validate(folderBNode);</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+  // Close containers, cleaning up their observers.</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+  testRootNode.containerOpen = false;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+  toolbarNode.containerOpen = false;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+  // clean up</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+  PlacesUIUtils.ptm.undoTransaction();</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+  PlacesUtils.bookmarks.removeItem(folderAId);</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+}</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+function populate(aFolderId) {</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+  var folderId = PlacesUtils.bookmarks.createFolder(aFolderId, &quot;test folder&quot;, -1);</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+  PlacesUtils.bookmarks.insertBookmark(folderId, PlacesUtils._uri(&quot;http://foo&quot;), -1, &quot;test bookmark&quot;);</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+  PlacesUtils.bookmarks.insertSeparator(folderId, -1);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+}</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+function validate(aNode) {</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+  PlacesUtils.asContainer(aNode);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+  aNode.containerOpen = true;</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+  is(aNode.childCount, 1, &quot;confirm child count match&quot;);</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+  var folderNode = aNode.getChild(0);</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+  is(folderNode.title, &quot;test folder&quot;, &quot;confirm folder title&quot;);</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+  PlacesUtils.asContainer(folderNode);</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+  folderNode.containerOpen = true;</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+  is(folderNode.childCount, 2, &quot;confirm child count match&quot;);</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+  var bookmarkNode = folderNode.getChild(0);</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+  var separatorNode = folderNode.getChild(1);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+  folderNode.containerOpen = false;</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+  aNode.containerOpen = false;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_457473_no_copy_guid.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,152 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ *</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ *</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ * License.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ *</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ * The Original Code is Places test code.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ *</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ *</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+ *  Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ *</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+ *</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+function test() {</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+  // sanity check</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  ok(PlacesUtils, &quot;checking PlacesUtils, running in chrome context?&quot;);</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  ok(PlacesUIUtils, &quot;checking PlacesUIUtils, running in chrome context?&quot;);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+  /*</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+  - create, a test folder, add bookmark, separator, livemark to it</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  - fetch guids for all</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  - copy the folder</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  - test that guids are all different</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+  - undo copy</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+  - redo copy</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  - test that guids for the copy stay the same</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+  */</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+  var toolbarId = PlacesUtils.toolbarFolderId;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  var toolbarNode = PlacesUtils.getFolderContents(toolbarId).root;</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  var oldCount = toolbarNode.childCount;</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+  var testRootId = PlacesUtils.bookmarks.createFolder(toolbarId, &quot;test root&quot;, -1);</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  is(toolbarNode.childCount, oldCount+1, &quot;confirm test root node is a container, and is empty&quot;);</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  var testRootNode = toolbarNode.getChild(toolbarNode.childCount-1);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  PlacesUtils.asContainer(testRootNode);</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+  testRootNode.containerOpen = true;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  is(testRootNode.childCount, 0, &quot;confirm test root node is a container, and is empty&quot;);</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  // create folder A, fill it w/ each item type</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+  var folderAId = PlacesUtils.bookmarks.createFolder(testRootId, &quot;A&quot;, -1);</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  PlacesUtils.bookmarks.insertBookmark(folderAId, PlacesUtils._uri(&quot;http://foo&quot;),</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+                                       -1, &quot;test bookmark&quot;);</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  PlacesUtils.bookmarks.insertSeparator(folderAId, -1);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  PlacesUtils.livemarks.createLivemarkFolderOnly(folderAId, &quot;test livemark&quot;,</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+                                                 PlacesUtils._uri(&quot;http://test&quot;),</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+                                                 PlacesUtils._uri(&quot;http://test&quot;), -1);</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  var folderANode = testRootNode.getChild(0);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+  var folderAGUIDs = getGUIDs(folderANode);</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+  // test the test function</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+  ok(checkGUIDs(folderANode, folderAGUIDs, true), &quot;confirm guid test works&quot;);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+  // serialize the folder</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  var serializedNode = PlacesUtils.wrapNode(folderANode, PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER);</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  var rawNode = PlacesUtils.unwrapNodes(serializedNode, PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER).shift();</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  ok(rawNode.type, &quot;confirm json node was made&quot;);</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+  // Create a copy transaction from the serialization.</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+  // this exercises the guid-filtering</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+  var transaction = PlacesUIUtils.makeTransaction(rawNode,</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+                                                  PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER,</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+                                                  testRootId, -1, true);</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+  ok(transaction, &quot;create transaction&quot;);</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+  // execute it, copying to the test root folder</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  PlacesUIUtils.ptm.doTransaction(transaction);</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  is(testRootNode.childCount, 2, &quot;create test folder via copy&quot;);</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  // check GUIDs are different</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+  var folderBNode = testRootNode.getChild(1);</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+  ok(checkGUIDs(folderBNode, folderAGUIDs, false), &quot;confirm folder A GUIDs don't match folder B GUIDs&quot;);</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  var folderBGUIDs = getGUIDs(folderBNode);</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+  ok(checkGUIDs(folderBNode, folderBGUIDs, true), &quot;confirm test of new GUIDs&quot;);</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+  // undo the transaction, confirm the removal</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  PlacesUIUtils.ptm.undoTransaction();</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  is(testRootNode.childCount, 1, &quot;confirm undo removed the copied folder&quot;);</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+  // redo the transaction</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+  // confirming GUIDs persist through undo/redo</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+  PlacesUIUtils.ptm.redoTransaction();</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  is(testRootNode.childCount, 2, &quot;confirm redo re-copied the folder&quot;);</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  folderBNode = testRootNode.getChild(1);</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+  ok(checkGUIDs(folderBNode, folderAGUIDs, false), &quot;folder B GUIDs after undo/redo don't match folder A GUIDs&quot;); // sanity check</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+  ok(checkGUIDs(folderBNode, folderBGUIDs, true), &quot;folder B GUIDs after under/redo should match pre-undo/redo folder B GUIDs&quot;);</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+  // Close containers, cleaning up their observers.</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+  testRootNode.containerOpen = false;</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+  toolbarNode.containerOpen = false;</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+  // clean up</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+  PlacesUIUtils.ptm.undoTransaction();</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+  PlacesUtils.bookmarks.removeItem(testRootId);</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+}</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+function getGUIDs(aNode) {</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+  PlacesUtils.asContainer(aNode);</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+  aNode.containerOpen = true;</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+  var GUIDs = {</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+    folder: PlacesUtils.bookmarks.getItemGUID(aNode.itemId),</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+    bookmark: PlacesUtils.bookmarks.getItemGUID(aNode.getChild(0).itemId),</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+    separator: PlacesUtils.bookmarks.getItemGUID(aNode.getChild(1).itemId),</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+    livemark: PlacesUtils.bookmarks.getItemGUID(aNode.getChild(2).itemId)</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+  };</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+  aNode.containerOpen = false;</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+  return GUIDs;</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+}</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+function checkGUIDs(aFolderNode, aGUIDs, aShouldMatch) {</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+  function check(aNode, aGUID, aEquals) {</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+    var nodeGUID = PlacesUtils.bookmarks.getItemGUID(aNode.itemId);</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+    return aEquals ? (nodeGUID == aGUID) : (nodeGUID != aGUID);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+  }</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+  PlacesUtils.asContainer(aFolderNode);</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+  aFolderNode.containerOpen = true;</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+  var allMatch = check(aFolderNode, aGUIDs.folder, aShouldMatch) &amp;&amp;</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+                 check(aFolderNode.getChild(0), aGUIDs.bookmark, aShouldMatch) &amp;&amp;</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+                 check(aFolderNode.getChild(1), aGUIDs.separator, aShouldMatch) &amp;&amp;</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+                 check(aFolderNode.getChild(2), aGUIDs.livemark, aShouldMatch);</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+  aFolderNode.containerOpen = false;</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+  return allMatch;</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_drag_bookmarks_on_toolbar.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,266 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * The Original Code is Places test.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * Mozilla Corporation</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ *   Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ *</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ *</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+const TEST_URL = &quot;http://www.mozilla.org&quot;;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+const TEST_TITLE = &quot;example_title&quot;;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+var gBookmarksToolbar = window.document.getElementById(&quot;PlacesToolbar&quot;);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+var dragDirections = { LEFT: 0, UP: 1, RIGHT: 2, DOWN: 3 };</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+/**</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+ * Tests dragging on toolbar.</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+ *</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+ * We must test these 2 cases:</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+ *   - Dragging toward left, top, right should start a drag.</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+ *   - Dragging toward down should should open the container if the item is a</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+ *     container, drag the item otherwise.</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+ *</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+ * @param aElement</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+ *        DOM node element we will drag</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+ * @param aExpectedDragData</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+ *        Array of flavors and values in the form:</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+ *        [ [&quot;text/plain: sometext&quot;, &quot;text/html: &lt;b&gt;sometext&lt;/b&gt;&quot;], [...] ]</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+ *        Pass an empty array to check that drag even has been canceled.</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+ * @param aDirection</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+ *        Direction for the dragging gesture, see dragDirections helper object.</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+ */</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+function synthesizeDragWithDirection(aElement, aExpectedDragData, aDirection) {</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  var trapped = false;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  // Dragstart listener function.</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  var trapDrag = function(event) {</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+    trapped = true;</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+    var dataTransfer = event.dataTransfer;</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+    is(dataTransfer.mozItemCount, aExpectedDragData.length,</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+       &quot;Number of dragged items should be the same.&quot;);</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+    for (var t = 0; t &lt; dataTransfer.mozItemCount; t++) {</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+      var types = dataTransfer.mozTypesAt(t);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+      var expecteditem = aExpectedDragData[t];</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+      is(types.length, expecteditem.length,</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+        &quot;Number of flavors for item &quot; + t + &quot; should be the same.&quot;);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+      for (var f = 0; f &lt; types.length; f++) {</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+        is(types[f], expecteditem[f].substring(0, types[f].length),</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+           &quot;Flavor &quot; + types[f] + &quot; for item &quot; + t + &quot; should be the same.&quot;);</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+        is(dataTransfer.mozGetDataAt(types[f], t),</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+           expecteditem[f].substring(types[f].length + 2),</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+           &quot;Contents for item &quot; + t + &quot; with flavor &quot; + types[f] + &quot; should be the same.&quot;);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+      }</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+    }</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+    if (!aExpectedDragData.length)</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+      ok(event.getPreventDefault(), &quot;Drag has been canceled.&quot;);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+    event.preventDefault();</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+    event.stopPropagation();</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+  }</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  var prevent = function(aEvent) {aEvent.preventDefault();}</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+  var xIncrement = 0;</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+  var yIncrement = 0;</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+  switch (aDirection) {</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+    case dragDirections.LEFT:</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+      xIncrement = -1;</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+      break;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+    case dragDirections.RIGHT:</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+      xIncrement = +1;</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+      break;</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+    case dragDirections.UP:</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+      yIncrement = -1;</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+      break;</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+    case dragDirections.DOWN:</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+      yIncrement = +1;</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+      break;</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  }</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+  var rect = aElement.getBoundingClientRect();</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  var startingPoint = { x: (rect.right - rect.left)/2,</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+                        y: (rect.bottom - rect.top)/2 };</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+  EventUtils.synthesizeMouse(aElement,</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+                             startingPoint.x,</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+                             startingPoint.y,</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+                             { type: &quot;mousedown&quot; });</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+  EventUtils.synthesizeMouse(aElement,</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+                             startingPoint.x + xIncrement * 1,</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+                             startingPoint.y + yIncrement * 1,</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+                             { type: &quot;mousemove&quot; });</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  gBookmarksToolbar.addEventListener(&quot;dragstart&quot;, trapDrag, false);</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+  EventUtils.synthesizeMouse(aElement,</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+                             startingPoint.x + xIncrement * 9,</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+                             startingPoint.y + yIncrement * 9,</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+                             { type: &quot;mousemove&quot; });</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+  ok(trapped, &quot;A dragstart event has been trapped.&quot;);</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  gBookmarksToolbar.removeEventListener(&quot;dragstart&quot;, trapDrag, false);</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+  // This is likely to cause a click event, and, in case we are dragging a</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+  // bookmark, an unwanted page visit.  Prevent the click event.</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+  aElement.addEventListener(&quot;click&quot;, prevent, false);</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+  EventUtils.synthesizeMouse(aElement,</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+                             startingPoint.x + xIncrement * 9,</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+                             startingPoint.y + yIncrement * 9,</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+                             { type: &quot;mouseup&quot; });</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  aElement.removeEventListener(&quot;click&quot;, prevent, false);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+  // Cleanup eventually opened menus.</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  if (aElement.localName == &quot;menu&quot; &amp;&amp; aElement.open)</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+    aElement.open = false;</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+}</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+function getToolbarNodeForItemId(aItemId) {</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+  var children = document.getElementById(&quot;PlacesToolbarItems&quot;).childNodes;</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  var node = null;</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+  for (var i = 0; i &lt; children.length; i++) {</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+    if (aItemId == children[i]._placesNode.itemId) {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+      node = children[i];</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+      break;</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+    }</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+  }</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+  return node;</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+}</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+function getExpectedDataForPlacesNode(aNode) {</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+  var wrappedNode = [];</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+  var flavors = [&quot;text/x-moz-place&quot;,</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+                 &quot;text/x-moz-url&quot;,</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+                 &quot;text/plain&quot;,</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+                 &quot;text/html&quot;];</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+  flavors.forEach(function(aFlavor) {</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+    var wrappedFlavor = aFlavor + &quot;: &quot; +</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+                        PlacesUtils.wrapNode(aNode, aFlavor);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+    wrappedNode.push(wrappedFlavor);</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+  });</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+  return [wrappedNode];</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+}</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+var gTests = [</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+  {</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+    desc: &quot;Drag a folder on toolbar&quot;,</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+    run: function() {</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+      // Create a test folder to be dragged.</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+      var folderId = PlacesUtils.bookmarks</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+                                .createFolder(PlacesUtils.toolbarFolderId,</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+                                              TEST_TITLE,</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+                                              PlacesUtils.bookmarks.DEFAULT_INDEX);</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+      var element = getToolbarNodeForItemId(folderId);</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+      isnot(element, null, &quot;Found node on toolbar&quot;);</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+      isnot(element._placesNode, null, &quot;Toolbar node has an associated Places node.&quot;);</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+      var expectedData = getExpectedDataForPlacesNode(element._placesNode);</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+      ok(true, &quot;Dragging left&quot;);</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+      synthesizeDragWithDirection(element, expectedData, dragDirections.LEFT);</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+      ok(true, &quot;Dragging right&quot;);</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+      synthesizeDragWithDirection(element, expectedData, dragDirections.RIGHT);</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+      ok(true, &quot;Dragging up&quot;);</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+      synthesizeDragWithDirection(element, expectedData, dragDirections.UP);</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+      ok(true, &quot;Dragging down&quot;);</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+      synthesizeDragWithDirection(element, new Array(), dragDirections.DOWN);</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+      // Cleanup.</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+      PlacesUtils.bookmarks.removeItem(folderId);</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+    }</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+  },</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+  {</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+    desc: &quot;Drag a bookmark on toolbar&quot;,</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+    run: function() {</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+      // Create a test bookmark to be dragged.</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+      var itemId = PlacesUtils.bookmarks</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+                              .insertBookmark(PlacesUtils.toolbarFolderId,</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+                                              PlacesUtils._uri(TEST_URL),</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+                                              PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+                                              TEST_TITLE);</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+      var element = getToolbarNodeForItemId(itemId);</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+      isnot(element, null, &quot;Found node on toolbar&quot;);</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+      isnot(element._placesNode, null, &quot;Toolbar node has an associated Places node.&quot;);</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+      var expectedData = getExpectedDataForPlacesNode(element._placesNode);</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+      ok(true, &quot;Dragging left&quot;);</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+      synthesizeDragWithDirection(element, expectedData, dragDirections.LEFT);</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+      ok(true, &quot;Dragging right&quot;);</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+      synthesizeDragWithDirection(element, expectedData, dragDirections.RIGHT);</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+      ok(true, &quot;Dragging up&quot;);</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+      synthesizeDragWithDirection(element, expectedData, dragDirections.UP);</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+      ok(true, &quot;Dragging down&quot;);</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+      synthesizeDragWithDirection(element, expectedData, dragDirections.DOWN);</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+      // Cleanup.</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+      PlacesUtils.bookmarks.removeItem(itemId);</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+    }</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+  },</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+];</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+function nextTest() {</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+  if (gTests.length) {</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+    var test = gTests.shift();</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+    info(&quot;Start of test: &quot; + test.desc);</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+    test.run();</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+    setTimeout(nextTest, 0);</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+  }</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+  else {</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+    // Collapse the personal toolbar if needed.</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+    if (wasCollapsed)</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+      toolbar.collapsed = true;</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+    finish();</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+  }</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+}</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+let toolbar = document.getElementById(&quot;PersonalToolbar&quot;);</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+let wasCollapsed = toolbar.collapsed;</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+function test() {</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+  // Uncollapse the personal toolbar if needed.</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+  if (wasCollapsed)</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+    toolbar.collapsed = false;</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+  waitForExplicitFinish();</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+  nextTest();</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+}</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_library_infoBox.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,219 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ *</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ *</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ * License.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ *</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ * The Original Code is Places test code.</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ *</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+ *</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ *  Margaret Leibovic &lt;mleibovic@mozilla.com&gt; (Original Author)</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ *</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * decision by devaring the provisions above and replace them with the notice</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not devare</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ *</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+/**</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+ *  Test appropriate visibility of infoBoxExpanderWrapper and</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+ *  additionalInfoFields in infoBox section of library</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+ */</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+const TEST_URI = &quot;http://www.mozilla.org/&quot;;</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+var gTests = [];</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+var gLibrary;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+gTests.push({</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  desc: &quot;Bug 430148 - Remove or hide the more/less button in details pane...&quot;,</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  run: function() {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    var PO = gLibrary.PlacesOrganizer;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+    var infoBoxExpanderWrapper = getAndCheckElmtById(&quot;infoBoxExpanderWrapper&quot;);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+    // add a visit to browser history</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+    var bhist = PlacesUtils.history.QueryInterface(Ci.nsIBrowserHistory);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    PlacesUtils.history.addVisit(PlacesUtils._uri(TEST_URI), Date.now() * 1000,</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+                                 null, PlacesUtils.history.TRANSITION_TYPED,</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+                                 false, 0);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+    ok(bhist.isVisited(PlacesUtils._uri(TEST_URI)), &quot;Visit has been added.&quot;);</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+    // open all bookmarks node</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+    PO.selectLeftPaneQuery(&quot;AllBookmarks&quot;);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+    isnot(PO._places.selectedNode, null,</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+          &quot;Correctly selected all bookmarks node.&quot;);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+    checkInfoBoxSelected(PO);</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+    ok(infoBoxExpanderWrapper.hidden,</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+       &quot;Expander button is hidden for all bookmarks node.&quot;);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    checkAddInfoFieldsCollapsed(PO);</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+    // open bookmarks menu node</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+    PO.selectLeftPaneQuery(&quot;BookmarksMenu&quot;);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+    isnot(PO._places.selectedNode, null,</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+          &quot;Correctly selected bookmarks menu node.&quot;);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+    checkInfoBoxSelected(PO);</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+    ok(infoBoxExpanderWrapper.hidden,</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+       &quot;Expander button is hidden for bookmarks menu node.&quot;);</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+    checkAddInfoFieldsCollapsed(PO);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+    // open recently bookmarked node</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+    var menuNode = PO._places.selectedNode.</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+                   QueryInterface(Ci.nsINavHistoryContainerResultNode);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+    menuNode.containerOpen = true;</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+    childNode = menuNode.getChild(0);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+    isnot(childNode, null, &quot;Bookmarks menu child node exists.&quot;);</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+    var recentlyBookmarkedTitle = PlacesUIUtils.</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+                                  getString(&quot;recentlyBookmarkedTitle&quot;);</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+    isnot(recentlyBookmarkedTitle, null,</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+          &quot;Correctly got the recently bookmarked title locale string.&quot;);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+    is(childNode.title, recentlyBookmarkedTitle,</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+       &quot;Correctly selected recently bookmarked node.&quot;);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+    PO._places.selectNode(childNode);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+    checkInfoBoxSelected(PO);</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+    ok(!infoBoxExpanderWrapper.hidden,</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+       &quot;Expander button is not hidden for recently bookmarked node.&quot;);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+    checkAddInfoFieldsNotCollapsed(PO);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+    // open first bookmark</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+    var view = PO._content.treeBoxObject.view;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+    ok(view.rowCount &gt; 0, &quot;Bookmark item exists.&quot;);</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+    view.selection.select(0);</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+    checkInfoBoxSelected(PO);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+    ok(!infoBoxExpanderWrapper.hidden,</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+       &quot;Expander button is not hidden for bookmark item.&quot;);</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+    checkAddInfoFieldsNotCollapsed(PO);</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+    checkAddInfoFields(PO, &quot;bookmark item&quot;);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+    // make sure additional fields are still hidden in second bookmark item</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+    ok(view.rowCount &gt; 1, &quot;Second bookmark item exists.&quot;);</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+    view.selection.select(1);</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+    checkInfoBoxSelected(PO);</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+    ok(!infoBoxExpanderWrapper.hidden,</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+       &quot;Expander button is not hidden for second bookmark item.&quot;);</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+    checkAddInfoFieldsNotCollapsed(PO);</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+    checkAddInfoFields(PO, &quot;second bookmark item&quot;);</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+    menuNode.containerOpen = false;</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+    bhist.removeAllPages();</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+    nextTest();</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+  }</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+});</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+function checkInfoBoxSelected(PO) {</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+  is(getAndCheckElmtById(&quot;detailsDeck&quot;).selectedIndex, 1,</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+     &quot;Selected element in detailsDeck is infoBox.&quot;);</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+}</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+function checkAddInfoFieldsCollapsed(PO) {</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+  PO._additionalInfoFields.forEach(function (id) {</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+    ok(getAndCheckElmtById(id).collapsed,</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+       &quot;Additional info field correctly collapsed: #&quot; + id);</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+  });</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+}</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+function checkAddInfoFieldsNotCollapsed(PO) {</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+  ok(PO._additionalInfoFields.some(function (id) {</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+      return !getAndCheckElmtById(id).collapsed;</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+     }), &quot;Some additional info field correctly not collapsed&quot;);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+}</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+function checkAddInfoFields(PO, nodeName) {</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+  ok(true, &quot;Checking additional info fields visibiity for node: &quot; + nodeName);</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  var expanderButton = getAndCheckElmtById(&quot;infoBoxExpander&quot;);</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+  // make sure additional fields are hidden by default</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+  PO._additionalInfoFields.forEach(function (id) {</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+    ok(getAndCheckElmtById(id).hidden,</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+       &quot;Additional info field correctly hidden by default: #&quot; + id);</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+  });</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+  // toggle fields and make sure they are hidden/unhidden as expected</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+  expanderButton.click();</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+  PO._additionalInfoFields.forEach(function (id) {</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+    ok(!getAndCheckElmtById(id).hidden,</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+       &quot;Additional info field correctly unhidden after toggle: #&quot; + id);</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+  });</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+  expanderButton.click();</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+  PO._additionalInfoFields.forEach(function (id) {</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+    ok(getAndCheckElmtById(id).hidden,</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+       &quot;Additional info field correctly hidden after toggle: #&quot; + id);</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+  });</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+}</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+function getAndCheckElmtById(id) {</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+  var elmt = gLibrary.document.getElementById(id);</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+  isnot(elmt, null, &quot;Correctly got element: #&quot; + id);</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  return elmt;</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+}</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+function nextTest() {</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+  if (gTests.length) {</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+    var test = gTests.shift();</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+    ok(true, &quot;TEST: &quot; + test.desc);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+    dump(&quot;TEST: &quot; + test.desc + &quot;\n&quot;);</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+    test.run();</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+  }</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+  else {</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+    // Close Library window.</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+    gLibrary.close();</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+    // No need to cleanup anything, we have a correct left pane now.</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+    finish();</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+  }</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+}</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+var ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+         getService(Ci.nsIWindowWatcher);</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+function windowObserver(aSubject, aTopic, aData) {</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+  if (aTopic != &quot;domwindowopened&quot;)</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+    return;</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+  ww.unregisterNotification(windowObserver);</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+  gLibrary = aSubject.QueryInterface(Ci.nsIDOMWindow);</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+  gLibrary.addEventListener(&quot;load&quot;, function onLoad(event) {</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+    gLibrary.removeEventListener(&quot;load&quot;, onLoad, false);</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+    executeSoon(function() {</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+      gLibrary.PlacesOrganizer._places.focus();</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+      waitForFocus(nextTest, gLibrary);</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+    });</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+  }, false);</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+}</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+function test() {</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+  dump(&quot;Starting test browser_library_infoBox.js\n&quot;);</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+  waitForExplicitFinish();</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+  // Sanity checks.</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+  ok(PlacesUtils, &quot;PlacesUtils is running in chrome context&quot;);</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+  ok(PlacesUIUtils, &quot;PlacesUIUtils is running in chrome context&quot;);</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+  // Open Library.</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+  ww.registerNotification(windowObserver);</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+  ww.openWindow(null,</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+                &quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;,</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+                &quot;&quot;,</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+                &quot;chrome,toolbar=yes,dialog=no,resizable&quot;,</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+                null);</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_library_left_pane_commands.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,148 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+ *</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+ *</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+ * License.</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+ *</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+ * The Original Code is Places test code.</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+ *</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+ *</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt; (Original Author)</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+ *</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+ * decision by devaring the provisions above and replace them with the notice</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not devare</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+ *</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+/**</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+ *  Test enabled commands in the left pane folder of the Library.</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+ */</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+const TEST_URI = &quot;http://www.mozilla.org/&quot;;</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+var gTests = [];</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+var gLibrary;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+gTests.push({</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+  desc: &quot;Bug 490156 - Can't delete smart bookmark containers&quot;,</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+  run: function() {</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+    // Select and open the left pane &quot;Bookmarks Toolbar&quot; folder.</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+    var PO = gLibrary.PlacesOrganizer;</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+    PO.selectLeftPaneQuery('BookmarksToolbar');</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+    isnot(PO._places.selectedNode, null, &quot;We have a valid selection&quot;);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    is(PlacesUtils.getConcreteItemId(PO._places.selectedNode),</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+       PlacesUtils.toolbarFolderId,</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+       &quot;We have correctly selected bookmarks toolbar node.&quot;);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+    // Check that both cut and delete commands are disabled.</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+    ok(!PO._places.controller.isCommandEnabled(&quot;cmd_cut&quot;),</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+       &quot;Cut command is disabled&quot;);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+    ok(!PO._places.controller.isCommandEnabled(&quot;cmd_delete&quot;),</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+       &quot;Delete command is disabled&quot;);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+    var toolbarNode = PO._places.selectedNode</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+                        .QueryInterface(Ci.nsINavHistoryContainerResultNode);</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+    toolbarNode.containerOpen = true;</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+    // Add an History query to the toolbar.</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+    PlacesUtils.bookmarks.insertBookmark(PlacesUtils.toolbarFolderId,</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+                                         PlacesUtils._uri(&quot;place:sort=4&quot;),</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+                                         0, // Insert at start.</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+                                         &quot;special_query&quot;);</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+    // Get first child and check it is the &quot;Most Visited&quot; smart bookmark.</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+    ok(toolbarNode.childCount &gt; 0, &quot;Toolbar node has children&quot;);</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+    var queryNode = toolbarNode.getChild(0);</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+    is(queryNode.title, &quot;special_query&quot;, &quot;Query node is correctly selected&quot;);</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+    // Select query node.</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+    PO._places.selectNode(queryNode);</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+    is(PO._places.selectedNode, queryNode, &quot;We correctly selected query node&quot;);</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+    // Check that both cut and delete commands are enabled.</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+    ok(PO._places.controller.isCommandEnabled(&quot;cmd_cut&quot;),</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+       &quot;Cut command is enabled&quot;);</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+    ok(PO._places.controller.isCommandEnabled(&quot;cmd_delete&quot;),</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+       &quot;Delete command is enabled&quot;);</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+    // Execute the delete command and check bookmark has been removed.</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+    PO._places.controller.doCommand(&quot;cmd_delete&quot;);</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+    try {</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+      PlacesUtils.bookmarks.getFolderIdForItem(queryNode.itemId);  </span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+      ok(false, &quot;Unable to remove query node bookmark&quot;);</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+    } catch(ex) {</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+      ok(true, &quot;Query node bookmark has been correctly removed&quot;);</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+    }</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+    toolbarNode.containerOpen = false;</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+    nextTest();</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+  }</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+});</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+function nextTest() {</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+  if (gTests.length) {</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+    var test = gTests.shift();</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+    info(&quot;Start of test: &quot; + test.desc);</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+    test.run();</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+  }</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+  else {</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+    // Close Library window.</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+    gLibrary.close();</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+    // No need to cleanup anything, we have a correct left pane now.</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+    finish();</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+  }</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+}</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+var ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+         getService(Ci.nsIWindowWatcher);</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+function windowObserver(aSubject, aTopic, aData) {</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+  if (aTopic != &quot;domwindowopened&quot;)</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+    return;</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+  ww.unregisterNotification(windowObserver);</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+  gLibrary = aSubject.QueryInterface(Ci.nsIDOMWindow);</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+  gLibrary.addEventListener(&quot;load&quot;, function onLoad(event) {</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+    gLibrary.removeEventListener(&quot;load&quot;, onLoad, false);</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+    executeSoon(nextTest);</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+  }, false);</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+}</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+function test() {</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+  waitForExplicitFinish();</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+  // Sanity checks.</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+  ok(PlacesUtils, &quot;PlacesUtils is running in chrome context&quot;);</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+  ok(PlacesUIUtils, &quot;PlacesUIUtils is running in chrome context&quot;);</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+  // Open Library.</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+  ww.registerNotification(windowObserver);</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+  ww.openWindow(null,</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+                &quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;,</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+                &quot;&quot;,</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+                &quot;chrome,toolbar=yes,dialog=no,resizable&quot;,</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+                null);</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_library_left_pane_fixnames.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,143 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+ *</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ *</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+ * License.</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+ *</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+ * The Original Code is Places test code.</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+ *</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+ *</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt; (Original Author)</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+ *</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+ * decision by devaring the provisions above and replace them with the notice</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not devare</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+ *</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+/**</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+ *  Test we correctly fix broken Library left pane queries names.</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+ */</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+var ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+         getService(Ci.nsIWindowWatcher);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+// Array of left pane queries objects, each one has the following properties:</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+// name: query's identifier got from annotations,</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+// itemId: query's itemId,</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+// correctTitle: original and correct query's title.</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+var leftPaneQueries = [];</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+function windowObserver(aSubject, aTopic, aData) {</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  if (aTopic != &quot;domwindowopened&quot;)</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+    return;</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  ww.unregisterNotification(windowObserver);</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+  var organizer = aSubject.QueryInterface(Ci.nsIDOMWindow);</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  organizer.addEventListener(&quot;load&quot;, function onLoad(event) {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+    organizer.removeEventListener(&quot;load&quot;, onLoad, false);</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+    executeSoon(function () {</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+      // Check titles have been fixed.</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+      for (var i = 0; i &lt; leftPaneQueries.length; i++) {</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+        var query = leftPaneQueries[i];</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+        is(PlacesUtils.bookmarks.getItemTitle(query.itemId),</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+           query.correctTitle, &quot;Title is correct for query &quot; + query.name);</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+        if (&quot;concreteId&quot; in query) {</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+          is(PlacesUtils.bookmarks.getItemTitle(query.concreteId),</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+           query.concreteTitle, &quot;Concrete title is correct for query &quot; + query.name);</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+        }</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+      }</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+      // Close Library window.</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+      organizer.close();</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+      // No need to cleanup anything, we have a correct left pane now.</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+      finish();</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+    });</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+  }, false);</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+}</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+function test() {</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+  waitForExplicitFinish();</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+  // Sanity checks.</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+  ok(PlacesUtils, &quot;PlacesUtils is running in chrome context&quot;);</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+  ok(PlacesUIUtils, &quot;PlacesUIUtils is running in chrome context&quot;);</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+  ok(PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION &gt; 0,</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+     &quot;Left pane version in chrome context, current version is: &quot; + PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION );</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+  // Ensure left pane is initialized.</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+  ok(PlacesUIUtils.leftPaneFolderId &gt; 0, &quot;left pane folder is initialized&quot;);</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+  // Get the left pane folder.</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+  var leftPaneItems = PlacesUtils.annotations</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+                                 .getItemsWithAnnotation(PlacesUIUtils.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+  is(leftPaneItems.length, 1, &quot;We correctly have only 1 left pane folder&quot;);</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+  // Check version.</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+  var version = PlacesUtils.annotations</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+                           .getItemAnnotation(leftPaneItems[0],</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+                                              PlacesUIUtils.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+  is(version, PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION, &quot;Left pane version is actual&quot;);</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+  // Get all left pane queries.</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+  var items = PlacesUtils.annotations</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+                         .getItemsWithAnnotation(PlacesUIUtils.ORGANIZER_QUERY_ANNO);</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+  // Get current queries names.</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+  for (var i = 0; i &lt; items.length; i++) {</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+    var itemId = items[i];</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+    var queryName = PlacesUtils.annotations</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+                               .getItemAnnotation(items[i],</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+                                                  PlacesUIUtils.ORGANIZER_QUERY_ANNO);</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+    var query = { name: queryName,</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+                  itemId: itemId,</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+                  correctTitle: PlacesUtils.bookmarks.getItemTitle(itemId) }</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+    switch (queryName) {</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+      case &quot;BookmarksToolbar&quot;:</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+        query.concreteId = PlacesUtils.toolbarFolderId;</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+        query.concreteTitle = PlacesUtils.bookmarks.getItemTitle(query.concreteId);</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+        break;</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+      case &quot;BookmarksMenu&quot;:</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+        query.concreteId = PlacesUtils.bookmarksMenuFolderId;</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+        query.concreteTitle = PlacesUtils.bookmarks.getItemTitle(query.concreteId);</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+        break;</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+      case &quot;UnfiledBookmarks&quot;:</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+        query.concreteId = PlacesUtils.unfiledBookmarksFolderId;</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+        query.concreteTitle = PlacesUtils.bookmarks.getItemTitle(query.concreteId);</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+        break;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+    }</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+    leftPaneQueries.push(query);</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+    // Rename to a bad title.</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+    PlacesUtils.bookmarks.setItemTitle(query.itemId, &quot;badName&quot;);</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+    if (&quot;concreteId&quot; in query)</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+      PlacesUtils.bookmarks.setItemTitle(query.concreteId, &quot;badName&quot;);</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+  }</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+  PlacesUIUtils.__defineGetter__(&quot;leftPaneFolderId&quot;, cachedLeftPaneFolderIdGetter);</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+  // Open Library, this will kick-off left pane code.</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+  ww.registerNotification(windowObserver);</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+  ww.openWindow(null,</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+                &quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;,</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+                &quot;&quot;,</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+                &quot;chrome,toolbar=yes,dialog=no,resizable&quot;,</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+                null);</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_library_open_leak.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,74 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+ *</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+ *</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+ * License.</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+ *</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+ * The Original Code is Places test code.</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+ *</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+ *</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+ *  Drew Willcoxon &lt;adw@mozilla.com&gt; (Original Author)</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+ *</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+ *</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+/**</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+ * Bug 474831</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+ * https://bugzilla.mozilla.org/show_bug.cgi?id=474831</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+ *</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+ * Tests for leaks caused by simply opening and closing the Places Library</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+ * window.  Opens the Places Library window, waits for it to load, closes it,</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+ * and finishes.</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+ */</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+let ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+         getService(Ci.nsIWindowWatcher);</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+function windowObserver(aSubject, aTopic, aData) {</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+  if (aTopic != &quot;domwindowopened&quot;)</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+    return;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+  ww.unregisterNotification(windowObserver);</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+  let win = aSubject.QueryInterface(Ci.nsIDOMWindow);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+  win.addEventListener(&quot;load&quot;, function onLoad(event) {</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+    win.removeEventListener(&quot;load&quot;, onLoad, false);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+    executeSoon(function () {</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+      ok(true, &quot;Library has been correctly opened&quot;);</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+      win.close();</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+      finish();</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+    });</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+  }, false);</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+}</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+function test() {</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+  waitForExplicitFinish();</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+  ww.registerNotification(windowObserver);</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  ww.openWindow(null,</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+                &quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;,</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+                &quot;&quot;,</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+                &quot;chrome,toolbar=yes,dialog=no,resizable&quot;,</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+                null);</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_library_views_liveupdate.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,347 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ *</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+ *</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ * License.</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+ *</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+ *</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+ *</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+ *   Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+ *</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+ *</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+/**</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+ * Tests Library Left pane view for liveupdate.</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+ */</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+var gLibrary = null;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+function test() {</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+  waitForExplicitFinish();</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+  // This test takes quite some time, and timeouts frequently, so we require</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+  // more time to run.</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+  // See Bug 525610.</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+  requestLongerTimeout(2);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+  // Sanity checks.</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+  ok(PlacesUtils, &quot;PlacesUtils in context&quot;);</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+  ok(PlacesUIUtils, &quot;PlacesUIUtils in context&quot;);</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+  // Open Library, we will check the left pane.</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+  var ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+           getService(Ci.nsIWindowWatcher);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+  function windowObserver(aSubject, aTopic, aData) {</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+    if (aTopic != &quot;domwindowopened&quot;)</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+      return;</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+    ww.unregisterNotification(windowObserver);</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+    gLibrary = aSubject.QueryInterface(Ci.nsIDOMWindow);</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+    gLibrary.addEventListener(&quot;load&quot;, function onLoad(event) {</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+      gLibrary.removeEventListener(&quot;load&quot;, onLoad, false);</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+      executeSoon(startTest);</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+    }, false);</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+  }</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+  ww.registerNotification(windowObserver);</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+  ww.openWindow(null,</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+                &quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;,</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+                &quot;&quot;,</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+                &quot;chrome,toolbar=yes,dialog=no,resizable&quot;,</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+                null);</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+}</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+/**</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+ * Adds bookmarks observer, and executes a bunch of bookmarks operations.</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+ */</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+function startTest() {</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+  var bs = PlacesUtils.bookmarks;</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+  // Add bookmarks observer.</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+  bs.addObserver(bookmarksObserver, false);</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+  var addedBookmarks = [];</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+  // MENU</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+  ok(true, &quot;*** Acting on menu bookmarks&quot;);</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+  var id = bs.insertBookmark(bs.bookmarksMenuFolder,</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+                             PlacesUtils._uri(&quot;http://bm1.mozilla.org/&quot;),</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+                             bs.DEFAULT_INDEX,</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+                             &quot;bm1&quot;);</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+  id = bs.insertBookmark(bs.bookmarksMenuFolder,</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+                         PlacesUtils._uri(&quot;place:&quot;),</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+                         bs.DEFAULT_INDEX,</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+                         &quot;bm2&quot;);</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+  bs.setItemTitle(id, &quot;bm2_edited&quot;);</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+  id = bs.insertSeparator(bs.bookmarksMenuFolder, bs.DEFAULT_INDEX);</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  id = bs.createFolder(bs.bookmarksMenuFolder,</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+                       &quot;bmf&quot;,</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+                       bs.DEFAULT_INDEX);</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+  bs.setItemTitle(id, &quot;bmf_edited&quot;);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+  id = bs.insertBookmark(id,</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+                         PlacesUtils._uri(&quot;http://bmf1.mozilla.org/&quot;),</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+                         bs.DEFAULT_INDEX,</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+                         &quot;bmf1&quot;);</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+  bs.moveItem(id, bs.bookmarksMenuFolder, 0);</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+  // TOOLBAR</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+  ok(true, &quot;*** Acting on toolbar bookmarks&quot;);</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  bs.insertBookmark(bs.toolbarFolder,</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+                    PlacesUtils._uri(&quot;http://tb1.mozilla.org/&quot;),</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+                    bs.DEFAULT_INDEX,</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+                    &quot;tb1&quot;);</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+  bs.setItemTitle(id, &quot;tb1_edited&quot;);</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+  id = bs.insertBookmark(bs.toolbarFolder,</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+                         PlacesUtils._uri(&quot;place:&quot;),</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+                         bs.DEFAULT_INDEX,</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+                         &quot;tb2&quot;);</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+  bs.setItemTitle(id, &quot;tb2_edited&quot;);</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+  id = bs.insertSeparator(bs.toolbarFolder, bs.DEFAULT_INDEX);</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+  id = bs.createFolder(bs.toolbarFolder,</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+                       &quot;tbf&quot;,</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+                       bs.DEFAULT_INDEX);</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+  bs.setItemTitle(id, &quot;tbf_edited&quot;);</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+  id = bs.insertBookmark(id,</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+                         PlacesUtils._uri(&quot;http://tbf1.mozilla.org/&quot;),</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+                         bs.DEFAULT_INDEX,</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+                         &quot;bmf1&quot;);</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+  bs.moveItem(id, bs.toolbarFolder, 0);</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+  // UNSORTED</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+  ok(true, &quot;*** Acting on unsorted bookmarks&quot;);</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+  id = bs.insertBookmark(bs.unfiledBookmarksFolder,</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+                         PlacesUtils._uri(&quot;http://ub1.mozilla.org/&quot;),</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+                         bs.DEFAULT_INDEX,</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+                         &quot;ub1&quot;);</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+  bs.setItemTitle(id, &quot;ub1_edited&quot;);</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+  id = bs.insertBookmark(bs.unfiledBookmarksFolder,</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+                         PlacesUtils._uri(&quot;place:&quot;),</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+                         bs.DEFAULT_INDEX,</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+                         &quot;ub2&quot;);</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+  bs.setItemTitle(id, &quot;ub2_edited&quot;);</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+  id = bs.insertSeparator(bs.unfiledBookmarksFolder, bs.DEFAULT_INDEX);</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+  id = bs.createFolder(bs.unfiledBookmarksFolder,</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+                       &quot;ubf&quot;,</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+                       bs.DEFAULT_INDEX);</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+  bs.setItemTitle(id, &quot;ubf_edited&quot;);</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+  id = bs.insertBookmark(id,</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+                         PlacesUtils._uri(&quot;http://ubf1.mozilla.org/&quot;),</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+                         bs.DEFAULT_INDEX,</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+                         &quot;ubf1&quot;);</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+  addedBookmarks.push(id);</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+  bs.moveItem(id, bs.unfiledBookmarksFolder, 0);</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+  // Remove all added bookmarks.</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+  addedBookmarks.forEach(function (aItem) {</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+    // If we remove an item after its containing folder has been removed,</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+    // this will throw, but we can ignore that.</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+    try {</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+      bs.removeItem(aItem);</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+  });</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+  // Remove bookmarks observer.</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+  bs.removeObserver(bookmarksObserver);</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+  finishTest();</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+}</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+/**</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+ * Restores browser state and calls finish.</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+ */</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+function finishTest() {</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+  // Close Library window.</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+  gLibrary.close();</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+  finish();</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+}</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+/**</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+ * The observer is where magic happens, for every change we do it will look for</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+ * nodes positions in the affected views.</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+ */</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+var bookmarksObserver = {</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+  QueryInterface: function PSB_QueryInterface(aIID) {</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+    if (aIID.equals(Ci.nsINavBookmarkObserver) ||</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+        aIID.equals(Ci.nsISupports))</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+      return this;</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+    throw Cr.NS_NOINTERFACE;</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+  },</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+  // nsINavBookmarkObserver</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+  onItemAdded: function PSB_onItemAdded(aItemId, aFolderId, aIndex) {</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+    var node = null;</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+    var index = null;</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+    [node, index] = getNodeForTreeItem(aItemId, gLibrary.PlacesOrganizer._places);</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+    // Left pane should not be updated for normal bookmarks or separators.</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+    var type = PlacesUtils.bookmarks.getItemType(aItemId);</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+    switch (type) {</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+      case PlacesUtils.bookmarks.TYPE_BOOKMARK:</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+        var uriString = PlacesUtils.bookmarks.getBookmarkURI(aItemId).spec;</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+        var isQuery = uriString.substr(0, 6) == &quot;place:&quot;;</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+        if (isQuery) {</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+          isnot(node, null, &quot;Found new Places node in left pane&quot;);</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+          ok(index &gt;= 0, &quot;Node is at index &quot; + index);</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+          break;</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+        }</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+        // Fallback to separator case if this is not a query.</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+      case PlacesUtils.bookmarks.TYPE_SEPARATOR:</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+        is(node, null, &quot;New Places node not added in left pane&quot;);</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+        break;</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+      default:</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+        isnot(node, null, &quot;Found new Places node in left pane&quot;);</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+        ok(index &gt;= 0, &quot;Node is at index &quot; + index);</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+    }</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+  },</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+  onItemRemoved: function PSB_onItemRemoved(aItemId, aFolder, aIndex) {</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+    var node = null;</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+    var index = null;</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+    [node, index] = getNodeForTreeItem(aItemId, gLibrary.PlacesOrganizer._places);</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+    is(node, null, &quot;Places node not found in left pane&quot;);</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+  },</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+  onItemMoved: function(aItemId,</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+                        aOldFolderId, aOldIndex,</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+                        aNewFolderId, aNewIndex) {</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+    var node = null;</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+    var index = null;</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+    [node, index] = getNodeForTreeItem(aItemId, gLibrary.PlacesOrganizer._places);</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+    // Left pane should not be updated for normal bookmarks or separators.</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+    var type = PlacesUtils.bookmarks.getItemType(aItemId);</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+    switch (type) {</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+      case PlacesUtils.bookmarks.TYPE_BOOKMARK:</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+        var uriString = PlacesUtils.bookmarks.getBookmarkURI(aItemId).spec;</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+        var isQuery = uriString.substr(0, 6) == &quot;place:&quot;;</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+        if (isQuery) {</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+          isnot(node, null, &quot;Found new Places node in left pane&quot;);</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+          ok(index &gt;= 0, &quot;Node is at index &quot; + index);</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+          break;</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+        }</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+        // Fallback to separator case if this is not a query.</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+      case type == PlacesUtils.bookmarks.TYPE_SEPARATOR:</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+        is(node, null, &quot;New Places node not added in left pane&quot;);</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+        break;</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+      default:</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+        isnot(node, null, &quot;Found new Places node in left pane&quot;);</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+        ok(index &gt;= 0, &quot;Node is at index &quot; + index);</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+    }</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+  },</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineplus">+  onBeginUpdateBatch: function PSB_onBeginUpdateBatch() {},</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineplus">+  onEndUpdateBatch: function PSB_onEndUpdateBatch() {},</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+  onBeforeItemRemoved: function PSB_onBeforeItemRemoved(aItemId) {},</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+  onItemVisited: function() {},</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+  onItemChanged: function PSB_onItemChanged(aItemId, aProperty,</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+                                            aIsAnnotationProperty, aNewValue) {</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+    if (aProperty == &quot;title&quot;) {</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+      let validator = function(aTreeRowIndex) {</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+        let tree = gLibrary.PlacesOrganizer._places;</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+        let cellText = tree.view.getCellText(aTreeRowIndex,</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineplus">+                                             tree.columns.getColumnAt(0));</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+        return cellText == aNewValue;</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineplus">+      }</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineplus">+      let [node, index, valid] = getNodeForTreeItem(aItemId, gLibrary.PlacesOrganizer._places, validator);</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineplus">+      if (node) // Only visible nodes.</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineplus">+        ok(valid, &quot;Title cell value has been correctly updated&quot;);</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineplus">+    }</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineplus">+  }</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineplus">+};</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineplus">+</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineplus">+/**</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineplus">+ * Get places node and index for an itemId in a tree view.</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+ *</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+ * @param aItemId</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineplus">+ *        item id of the item to search.</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineplus">+ * @param aTree</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+ *        Tree to search in.</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+ * @param aValidator [optional]</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineplus">+ *        function to check row validity if found.  Defaults to {return true;}.</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+ * @returns [node, index, valid] or [null, null, false] if not found.</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+ */</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineplus">+function getNodeForTreeItem(aItemId, aTree, aValidator) {</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineplus">+</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+  function findNode(aContainerIndex) {</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+    if (aTree.view.isContainerEmpty(aContainerIndex))</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+      return [null, null, false];</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineplus">+</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+    // The rowCount limit is just for sanity, but we will end looping when</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+    // we have checked the last child of this container or we have found node.</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineplus">+    for (var i = aContainerIndex + 1; i &lt; aTree.view.rowCount; i++) {</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineplus">+      var node = aTree.view.nodeForTreeIndex(i);</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineplus">+</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineplus">+      if (node.itemId == aItemId) {</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineplus">+        // Minus one because we want relative index inside the container.</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+        let valid = aValidator ? aValidator(i) : true;</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+        return [node, i - aTree.view.getParentIndex(i) - 1, valid];</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+      }</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+      if (PlacesUtils.nodeIsFolder(node)) {</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineplus">+        // Open container.</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+        aTree.view.toggleOpenState(i);</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineplus">+        // Search inside it.</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineplus">+        var foundNode = findNode(i);</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineplus">+        // Close container.</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineplus">+        aTree.view.toggleOpenState(i);</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineplus">+        // Return node if found.</span>
<a href="#l12.327"></a><span id="l12.327" class="difflineplus">+        if (foundNode[0] != null)</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineplus">+          return foundNode;</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineplus">+      }</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineplus">+</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineplus">+      // We have finished walking this container.</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineplus">+      if (!aTree.view.hasNextSibling(aContainerIndex + 1, i))</span>
<a href="#l12.333"></a><span id="l12.333" class="difflineplus">+        break;</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineplus">+    }</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineplus">+    return [null, null, false]</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineplus">+  }</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+  // Root node is hidden, so we need to manually walk the first level.</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineplus">+  for (var i = 0; i &lt; aTree.view.rowCount; i++) {</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineplus">+    // Open container.</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineplus">+    aTree.view.toggleOpenState(i);</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineplus">+    // Search inside it.</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineplus">+    var foundNode = findNode(i);</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineplus">+    // Close container.</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineplus">+    aTree.view.toggleOpenState(i);</span>
<a href="#l12.346"></a><span id="l12.346" class="difflineplus">+    // Return node if found.</span>
<a href="#l12.347"></a><span id="l12.347" class="difflineplus">+    if (foundNode[0] != null)</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineplus">+      return foundNode;</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineplus">+  }</span>
<a href="#l12.350"></a><span id="l12.350" class="difflineplus">+  return [null, null, false];</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_sort_in_library.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,305 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+ *</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+ *</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+ * License.</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+ *</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+ * The Original Code is Places test code.</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+ *</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+ *</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+ *  Drew Willcoxon &lt;adw@mozilla.com&gt; (Original Author)</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+ *</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+ *</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+/**</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+ * Tests the following bugs:</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+ *</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+ * Bug 443745 - View&gt;Sort&gt;of &quot;alpha&quot; sort items is default to Z&gt;A instead of A&gt;Z</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+ * https://bugzilla.mozilla.org/show_bug.cgi?id=443745</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+ *</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+ * Bug 444179 - Library&gt;Views&gt;Sort&gt;Sort by Tags does nothing</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+ * https://bugzilla.mozilla.org/show_bug.cgi?id=444179</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+ *</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+ * Basically, fully tests sorting the placeContent tree in the Places Library</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+ * window.  Sorting is verified by comparing the nsINavHistoryResult returned by</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+ * placeContent.result to the expected sort values.</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+ */</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+// Two properties of nsINavHistoryResult control the sort of the tree:</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+// sortingMode and sortingAnnotation.  sortingMode's value is one of the</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+// nsINavHistoryQueryOptions.SORT_BY_* constants.  sortingAnnotation is the</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+// annotation used to sort for SORT_BY_ANNOTATION_* mode.</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+//</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+// This lookup table maps the possible values of anonid's of the treecols to</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+// objects that represent the treecols' correct state after the user sorts the</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+// previously unsorted tree by selecting a column from the Views &gt; Sort menu.</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+// sortingMode is constructed from the key and dir properties (i.e.,</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+// SORT_BY_&lt;key&gt;_&lt;dir&gt;) and sortingAnnotation is checked against anno.  anno</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+// may be undefined if key is not &quot;ANNOTATION&quot;.</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+const SORT_LOOKUP_TABLE = {</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+  title:        { key: &quot;TITLE&quot;,        dir: &quot;ASCENDING&quot;  },</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+  tags:         { key: &quot;TAGS&quot;,         dir: &quot;ASCENDING&quot;  },</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+  url:          { key: &quot;URI&quot;,          dir: &quot;ASCENDING&quot;  },</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+  date:         { key: &quot;DATE&quot;,         dir: &quot;DESCENDING&quot; },</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+  visitCount:   { key: &quot;VISITCOUNT&quot;,   dir: &quot;DESCENDING&quot; },</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+  keyword:      { key: &quot;KEYWORD&quot;,      dir: &quot;ASCENDING&quot;  },</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+  dateAdded:    { key: &quot;DATEADDED&quot;,    dir: &quot;DESCENDING&quot; },</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+  lastModified: { key: &quot;LASTMODIFIED&quot;, dir: &quot;DESCENDING&quot; },</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+  description:  { key:  &quot;ANNOTATION&quot;,</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+                  dir:  &quot;ASCENDING&quot;,</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+                  anno: &quot;bookmarkProperties/description&quot; }</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+};</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+// This is the column that's sorted if one is not specified and the tree is</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+// currently unsorted.  Set it to a key substring in the name of one of the</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+// nsINavHistoryQueryOptions.SORT_BY_* constants, e.g., &quot;TITLE&quot;, &quot;URI&quot;.</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+// Method ViewMenu.setSortColumn in browser/components/places/content/places.js</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+// determines this value.</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+const DEFAULT_SORT_KEY = &quot;TITLE&quot;;</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+// Part of the test is checking that sorts stick, so each time we sort we need</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+// to remember it.</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+let prevSortDir = null;</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+let prevSortKey = null;</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+/**</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+ * Ensures that the sort of aTree is aSortingMode and aSortingAnno.</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+ *</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+ * @param aTree</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+ *        the tree to check</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+ * @param aSortingMode</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+ *        one of the Ci.nsINavHistoryQueryOptions.SORT_BY_* constants</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+ * @param aSortingAnno</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+ *        checked only if sorting mode is one of the</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+ *        Ci.nsINavHistoryQueryOptions.SORT_BY_ANNOTATION_* constants</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+ */</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+function checkSort(aTree, aSortingMode, aSortingAnno) {</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+  // The placeContent tree's sort is determined by the nsINavHistoryResult it</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+  // stores.  Get it and check that the sort is what the caller expects.</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+  let res = aTree.result;</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+  isnot(res, null,</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+        &quot;sanity check: placeContent.result should not return null&quot;);</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+  // Check sortingMode.</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+  is(res.sortingMode, aSortingMode,</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+     &quot;column should now have sortingMode &quot; + aSortingMode);</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+  // Check sortingAnnotation, but only if sortingMode is ANNOTATION.</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+  if ([Ci.nsINavHistoryQueryOptions.SORT_BY_ANNOTATION_ASCENDING,</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+       Ci.nsINavHistoryQueryOptions.SORT_BY_ANNOTATION_DESCENDING].</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+      indexOf(aSortingMode) &gt;= 0) {</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+    is(res.sortingAnnotation, aSortingAnno,</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+       &quot;column should now have sorting annotation &quot; + aSortingAnno);</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+  }</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+}</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+/**</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+ * Sets the sort of aTree.</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+ *</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+ * @param aOrganizerWin</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+ *        the Places window</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+ * @param aTree</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+ *        the tree to sort</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+ * @param aUnsortFirst</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+ *        true if the sort should be set to SORT_BY_NONE before sorting by aCol</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+ *        and aDir</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+ * @param aShouldFail</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+ *        true if setSortColumn should fail on aCol or aDir</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+ * @param aCol</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+ *        the column of aTree by which to sort</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+ * @param aDir</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+ *        either &quot;ascending&quot; or &quot;descending&quot;</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+ */</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+function setSort(aOrganizerWin, aTree, aUnsortFirst, aShouldFail, aCol, aDir) {</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+  if (aUnsortFirst) {</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+    aOrganizerWin.ViewMenu.setSortColumn();</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+    checkSort(aTree, Ci.nsINavHistoryQueryOptions.SORT_BY_NONE, &quot;&quot;);</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+    // Remember the sort key and direction.</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+    prevSortKey = null;</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+    prevSortDir = null;</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+  }</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+  let failed = false;</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+  try {</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+    aOrganizerWin.ViewMenu.setSortColumn(aCol, aDir);</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+    // Remember the sort key and direction.</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+    if (!aCol &amp;&amp; !aDir) {</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+      prevSortKey = null;</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+      prevSortDir = null;</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+    }</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+    else {</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+      if (aCol)</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+        prevSortKey = SORT_LOOKUP_TABLE[aCol.getAttribute(&quot;anonid&quot;)].key;</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+      else if (prevSortKey === null)</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+        prevSortKey = DEFAULT_SORT_KEY;</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+      if (aDir)</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+        prevSortDir = aDir.toUpperCase();</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+      else if (prevSortDir === null)</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+        prevSortDir = SORT_LOOKUP_TABLE[aCol.getAttribute(&quot;anonid&quot;)].dir;</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+    }</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+  } catch (exc) {</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+    failed = true;</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+  }</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+  is(failed, !!aShouldFail,</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+     &quot;setSortColumn on column &quot; +</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+     (aCol ? aCol.getAttribute(&quot;anonid&quot;) : &quot;(no column)&quot;) +</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+     &quot; with direction &quot; + (aDir || &quot;(no direction)&quot;) +</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+     &quot; and table previously &quot; + (aUnsortFirst ? &quot;unsorted&quot; : &quot;sorted&quot;) +</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+     &quot; should &quot; + (aShouldFail ? &quot;&quot; : &quot;not &quot;) + &quot;fail&quot;);</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+}</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+/**</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+ * Tries sorting by an invalid column and sort direction.</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+ *</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+ * @param aOrganizerWin</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+ *        the Places window</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+ * @param aPlaceContentTree</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+ *        the placeContent tree in aOrganizerWin</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+ */</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+function testInvalid(aOrganizerWin, aPlaceContentTree) {</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+  // Invalid column should fail by throwing an exception.</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+  let bogusCol = document.createElement(&quot;treecol&quot;);</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+  bogusCol.setAttribute(&quot;anonid&quot;, &quot;bogusColumn&quot;);</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+  setSort(aOrganizerWin, aPlaceContentTree, true, true, bogusCol, &quot;ascending&quot;);</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+  // Invalid direction reverts to SORT_BY_NONE.</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+  setSort(aOrganizerWin, aPlaceContentTree, false, false, null, &quot;bogus dir&quot;);</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+  checkSort(aPlaceContentTree, Ci.nsINavHistoryQueryOptions.SORT_BY_NONE, &quot;&quot;);</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+}</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+/**</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+ * Tests sorting aPlaceContentTree by column only and then by both column</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+ * and direction.</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+ *</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+ * @param aOrganizerWin</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+ *        the Places window</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+ * @param aPlaceContentTree</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+ *        the placeContent tree in aOrganizerWin</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+ * @param aUnsortFirst</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+ *        true if, before each sort we try, we should sort to SORT_BY_NONE</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+ */</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+function testSortByColAndDir(aOrganizerWin, aPlaceContentTree, aUnsortFirst) {</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+  let cols = aPlaceContentTree.getElementsByTagName(&quot;treecol&quot;);</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+  ok(cols.length &gt; 0, &quot;sanity check: placeContent should contain columns&quot;);</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+  for (let i = 0; i &lt; cols.length; i++) {</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+    let col = cols.item(i);</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+    ok(col.hasAttribute(&quot;anonid&quot;),</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+       &quot;sanity check: column &quot; + col.id + &quot; should have anonid&quot;);</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+    let colId = col.getAttribute(&quot;anonid&quot;);</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+    ok(colId in SORT_LOOKUP_TABLE,</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+       &quot;sanity check: unexpected placeContent column anonid&quot;);</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+    let sortConst =</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+      &quot;SORT_BY_&quot; + SORT_LOOKUP_TABLE[colId].key + &quot;_&quot; +</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+      (aUnsortFirst ? SORT_LOOKUP_TABLE[colId].dir : prevSortDir);</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+    let expectedSortMode = Ci.nsINavHistoryQueryOptions[sortConst];</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+    let expectedAnno = SORT_LOOKUP_TABLE[colId].anno || &quot;&quot;;</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+    // Test sorting by only a column.</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+    setSort(aOrganizerWin, aPlaceContentTree, aUnsortFirst, false, col);</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+    checkSort(aPlaceContentTree, expectedSortMode, expectedAnno);</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+    // Test sorting by both a column and a direction.</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+    [&quot;ascending&quot;, &quot;descending&quot;].forEach(function (dir) {</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+      let sortConst =</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+        &quot;SORT_BY_&quot; + SORT_LOOKUP_TABLE[colId].key + &quot;_&quot; + dir.toUpperCase();</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+      let expectedSortMode = Ci.nsINavHistoryQueryOptions[sortConst];</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+      setSort(aOrganizerWin, aPlaceContentTree, aUnsortFirst, false, col, dir);</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+      checkSort(aPlaceContentTree, expectedSortMode, expectedAnno);</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+    });</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+  }</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+}</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+/**</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+ * Tests sorting aPlaceContentTree by direction only.</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+ *</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+ * @param aOrganizerWin</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+ *        the Places window</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+ * @param aPlaceContentTree</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+ *        the placeContent tree in aOrganizerWin</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+ * @param aUnsortFirst</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+ *        true if, before each sort we try, we should sort to SORT_BY_NONE</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+ */</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+function testSortByDir(aOrganizerWin, aPlaceContentTree, aUnsortFirst) {</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+  [&quot;ascending&quot;, &quot;descending&quot;].forEach(function (dir) {</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+    let key = (aUnsortFirst ? DEFAULT_SORT_KEY : prevSortKey);</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineplus">+    let sortConst = &quot;SORT_BY_&quot; + key + &quot;_&quot; + dir.toUpperCase();</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineplus">+    let expectedSortMode = Ci.nsINavHistoryQueryOptions[sortConst];</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+    setSort(aOrganizerWin, aPlaceContentTree, aUnsortFirst, false, null, dir);</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+    checkSort(aPlaceContentTree, expectedSortMode, &quot;&quot;);</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+  });</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+}</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+function test() {</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+  waitForExplicitFinish();</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+  let ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+           getService(Ci.nsIWindowWatcher);</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+  function windowObserver(aSubject, aTopic, aData) {</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineplus">+    if (aTopic != &quot;domwindowopened&quot;)</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+      return;</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+    ww.unregisterNotification(windowObserver);</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineplus">+    let win = aSubject.QueryInterface(Ci.nsIDOMWindow);</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineplus">+    win.addEventListener(&quot;load&quot;, function onLoad(event) {</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+      win.removeEventListener(&quot;load&quot;, onLoad, false);</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+      executeSoon(function () {</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+        let tree = win.document.getElementById(&quot;placeContent&quot;);</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+        isnot(tree, null, &quot;sanity check: placeContent tree should exist&quot;);</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineplus">+        // Run the tests.</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineplus">+        testSortByColAndDir(win, tree, true);</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineplus">+        testSortByColAndDir(win, tree, false);</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineplus">+        testSortByDir(win, tree, true);</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineplus">+        testSortByDir(win, tree, false);</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineplus">+        testInvalid(win, tree);</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineplus">+        // Reset the sort to SORT_BY_NONE.</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineplus">+        setSort(win, tree, false, false);</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineplus">+        // Close the window and finish.</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineplus">+        win.close();</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineplus">+        finish();</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineplus">+      });</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineplus">+    }, false);</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+  }</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineplus">+  ww.registerNotification(windowObserver);</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineplus">+  ww.openWindow(null,</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineplus">+                &quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;,</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineplus">+                &quot;&quot;,</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+                &quot;chrome,toolbar=yes,dialog=no,resizable&quot;,</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineplus">+                null);</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_ui_000_data.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,163 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ *</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+ *</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+ * License.</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+ *</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+ *</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+ *</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+ *   Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+ *</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+ *</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+/*</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+Sets up the database for subsequent performance</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+tests, and test the speed of adding to history</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+and bookmarks.</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+- add XXX visits distributed over XXX days</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+- add XXX bookmarks distributed over XXX days</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+*/</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+/*********************** begin header **********************/</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+waitForExplicitFinish();</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+const TEST_IDENTIFIER = &quot;ui-perf-test&quot;;</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+const TEST_SUITE = &quot;places&quot;;</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+var wm = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;].</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+         getService(Ci.nsIWindowMediator);</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+var win = wm.getMostRecentWindow(&quot;navigator:browser&quot;);</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+var ios = Cc[&quot;@mozilla.org/network/io-service;1&quot;].</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+          getService(Ci.nsIIOService);</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+var hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+         getService(Ci.nsINavHistoryService);</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+var bs = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+         getService(Ci.nsINavBookmarksService);</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+function add_visit(aURI, aDate) {</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+  var placeID = hs.addVisit(aURI,</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+                            aDate,</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+                            null, // no referrer</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+                            hs.TRANSITION_TYPED, // user typed in URL bar</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+                            false, // not redirect</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+                            0);</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  return placeID;</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+}</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+function add_bookmark(aURI) {</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+  var bId = bs.insertBookmark(bs.unfiledBookmarksFolder, aURI,</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+                              bs.DEFAULT_INDEX, &quot;bookmark/&quot; + aURI.spec);</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+  return bId;</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+}</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+function make_test_report(testName, result, units) {</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+  return [TEST_IDENTIFIER, TEST_SUITE, testName, result, units||&quot;ms&quot;].join(&quot;:&quot;);</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+}</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+// Each test is an obj w/ a name property and run method</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+var ptests = [];</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+/*********************** end header **********************/</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+// add visits and bookmarks</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+ptests.push({</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+  run: function() {</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+    bs.runInBatchMode({</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+      runBatched: function(aUserData) {</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+        // timespan - same as default history pref for now</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+        var days = 90;</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+        // add visits, distributed across the timespan</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+        var total_visits = 300;</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+        var visits_per_day = total_visits/days;</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+        var visit_date_microsec = Date.now() * 1000;</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+        var day_counter = 0;</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+        </span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+        var start = Date.now();</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+        for (var i = 0; i &lt; days; i++) {</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+          visit_date_microsec -= 86400 * 1000 * 1000; // remove a day</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+          var spec = &quot;http://example.com/&quot; + visit_date_microsec;</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+          for (var j = 0; j &lt; visits_per_day; j++) {</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+            var uri = ios.newURI(spec + j, null, null);</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+            add_visit(uri, visit_date_microsec);</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+          }</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+        }</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+        var duration = Date.now() - start;</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+        var report = make_test_report(&quot;add_visits&quot;, duration);</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+        ok(true, report);</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+        // add bookmarks</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+        var bookmarks_total = total_visits/10; // bookmark a tenth of the URLs in history</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+        var bookmarks_per_day = bookmarks_total/days;</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+        // reset visit date counter</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+        visit_date_microsec = Date.now() * 1000;</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+        var bookmark_counter = 0;</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+        start = Date.now();</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+        for (var i = 0; i &lt; days; i++) {</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+          visit_date_microsec -= 86400 * 1000 * 1000; // remove a day</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+          var spec = &quot;http://example.com/&quot; + visit_date_microsec;</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+          for (var j = 0; j &lt; visits_per_day; j++) {</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+            var uri = ios.newURI(spec + j, null, null);</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+            if (bookmark_counter &lt; bookmarks_per_day) {</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+              add_bookmark(uri);</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+              bookmark_counter++;</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+            }</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+            else</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+              bookmark_counter = 0;</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+          }</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+        }</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+        duration = Date.now() - start;</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+        report = make_test_report(&quot;add_bookmarks&quot;, duration);</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+        ok(true, report);</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+        runNextTest();</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+      }</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+    }, null);</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+  }</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+});</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+function test() {</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+  // kick off tests</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+  runNextTest();</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+}</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+function runNextTest() {</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+  if (ptests.length &gt; 0)</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+    ptests.shift().run();</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+  else</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+    finish();</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/suite/common/places/tests/browser/browser_ui_history_menu.js</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,147 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+ *</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+ *</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+ * License.</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+ *</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+ *</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+ *</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+ *   Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+ *   Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+ *</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+ *</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+/*</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+Tests the performance of opening the history menu.</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+*/</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+/*********************** begin header **********************/</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+const TEST_IDENTIFIER = &quot;ui-perf-test&quot;;</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+const TEST_SUITE = &quot;places&quot;;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+var wm = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;].</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+         getService(Ci.nsIWindowMediator);</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+var win = wm.getMostRecentWindow(&quot;navigator:browser&quot;);</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+var ios = Cc[&quot;@mozilla.org/network/io-service;1&quot;].</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+          getService(Ci.nsIIOService);</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+var hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+         getService(Ci.nsINavHistoryService);</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+var bs = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+         getService(Ci.nsINavBookmarksService);</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+var historyMenu = document.getElementById(&quot;history-menu&quot;);</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+var historyPopup = document.getElementById(&quot;goPopup&quot;);</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+function add_visit(aURI, aDate) {</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+  var visitId = hs.addVisit(aURI,</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+                            aDate,</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+                            null, // no referrer</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+                            hs.TRANSITION_TYPED, // user typed in URL bar</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+                            false, // not redirect</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+                            0);</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+  return visitId;</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+}</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+function add_bookmark(aURI) {</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+  var bId = bs.insertBookmark(bs.unfiledBookmarksFolder, aURI,</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+                              bs.DEFAULT_INDEX, &quot;bookmark/&quot; + aURI.spec);</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+  return bId;</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+}</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+function make_test_report(testName, result, units) {</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+  return [TEST_IDENTIFIER, TEST_SUITE, testName, result, units||&quot;ms&quot;].join(&quot;:&quot;);</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+}</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+// Each test is an obj w/ a name property and run method</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+var ptests = [];</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+/*********************** end header **********************/</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+const TEST_REPEAT_COUNT = 6;</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+// test duration of history menu opening</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+ptests.push({</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+  name: &quot;open_history_menu&quot;,</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+  times: [],</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+  run: function() {</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+    var self = this;</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+    var start = Date.now();</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+    historyPopup.addEventListener(&quot;popupshown&quot;, function() {</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+      historyPopup.removeEventListener(&quot;popupshown&quot;, arguments.callee, true);</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+      executeSoon(function() {</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+        var duration = Date.now() - start;</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+        historyPopup.hidePopup();</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+        historyMenu.open = false;</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+        self.times.push(duration);</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+        if (self.times.length == TEST_REPEAT_COUNT)</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+          self.finish();</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+        else</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+          self.run();</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+      });</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+    }, true);</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+    historyMenu.open = true;</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+    historyPopup.openPopup();</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+  },</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+  finish: function() {</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+    processTestResult(this);</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+    setTimeout(runNextTest, 0);</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+  }</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+});</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+function processTestResult(aTest) {</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+  aTest.times.sort();  // sort the scores</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+  aTest.times.pop();   // remove worst</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+  aTest.times.shift(); // remove best</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+  var totalDuration = aTest.times.reduce(function(time, total){ return time + total; });</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+  var avgDuration = totalDuration/aTest.times.length;</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+  var report = make_test_report(aTest.name, avgDuration);</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+  ok(true, report);</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+}</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineplus">+</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+function test() {</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+  // Skip test on Mac due to native menus.</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+  if (navigator.platform.toLowerCase().indexOf(&quot;mac&quot;) != -1)</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+    return;</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+  waitForExplicitFinish();</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+  // kick off tests</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+  setTimeout(runNextTest, 0);</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineplus">+}</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineplus">+</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+function runNextTest() {</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+  if (ptests.length &gt; 0)</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+    ptests.shift().run();</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+  else</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+    finish();</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/suite/common/places/tests/browser/head.js</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+// We need to cache this before test runs...</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+let cachedLeftPaneFolderIdGetter;</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+let (getter = PlacesUIUtils.__lookupGetter__(&quot;leftPaneFolderId&quot;)) {</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+  if (!cachedLeftPaneFolderIdGetter &amp;&amp; typeof(getter) == &quot;function&quot;)</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+    cachedLeftPaneFolderIdGetter = getter;</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+}</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+// ...And restore it when test ends.</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+registerCleanupFunction(function(){</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+  let (getter = PlacesUIUtils.__lookupGetter__(&quot;leftPaneFolderId&quot;)) {</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+    if (cachedLeftPaneFolderIdGetter &amp;&amp; typeof(getter) != &quot;function&quot;)</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+      PlacesUIUtils.__defineGetter__(&quot;leftPaneFolderId&quot;,</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+                                     cachedLeftPaneFolderIdGetter);</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+  }</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/suite/common/places/tests/chrome/perf_large_delete.xul</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,169 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+&lt;!--</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+ *</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+ *</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+ * License.</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+ *</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+ *</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+ *</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+ *</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+ *</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+/**</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+ * This tests that the performance of deleting a large number of bookmarks.  See</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+ * bug 432706 for more details.</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+ *</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+ * To run this test, run it like you would a standard chrome test, with the test</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+ * path being:</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+ * ../chrome/browser/components/places/tests/perf/perf_large_delete.xul</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+ */</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+--&gt;</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+&lt;window title=&quot;Places Library Performance Test&quot;</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+        onload=&quot;test();&quot;&gt;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+          src=&quot;chrome://mochikit/content/MochiKit/packed.js&quot;/&gt;</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+          src=&quot;chrome://mochikit/content/tests/SimpleTest/SimpleTest.js&quot;/&gt;</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+          src=&quot;chrome://mochikit/content/tests/SimpleTest/EventUtils.js&quot;/&gt;</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+  &lt;![CDATA[</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+function test()</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+{</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+  let ios = Cc[&quot;@mozilla.org/network/io-service;1&quot;].</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+            getService(Ci.nsIIOService);</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+  // First, add 250 bookmarks</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+  let bs = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+           getService(Ci.nsINavBookmarksService);</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+  bs.runInBatchMode({</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+    runBatched: function(aUserData)</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+    {</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+      for (let i = 0; i &lt; 250; i++) {</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+        let uri = ios.newURI(&quot;http://example.com/&quot; + i, null, null);</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+        bs.insertBookmark(bs.unfiledBookmarksFolder, uri, bs.DEFAULT_INDEX,</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+                          &quot;bookmark &quot; + i);</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+      }</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+    }</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+  }, null);</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+  // Close the window if it's already open</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+  let wm = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;].</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+           getService(Ci.nsIWindowMediator);</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+  let win = wm.getMostRecentWindow(&quot;Places:Organizer&quot;);</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+  if (win)</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+    win.close();</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+  let ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+           getService(Ci.nsIWindowWatcher);</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+  ww.registerNotification({</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+    observe: function(aSubject, aTopic, aData)</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+    {</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+      if (aTopic != &quot;domwindowopened&quot;)</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+        return;</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+      let win = aSubject.QueryInterface(Ci.nsIDOMEventTarget);</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+      // We need to run after the window is loaded, and has run its startup code</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+      win.addEventListener(&quot;DOMContentLoaded&quot;, function() {</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+        let tm = Cc[&quot;@mozilla.org/thread-manager;1&quot;].</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+                 getService(Ci.nsIThreadManager);</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+        tm.mainThread.dispatch({</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+          run: function() doTest(win.QueryInterface(Ci.nsIDOMWindow))</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+        }, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+      }, false);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+      // and now to unregister ourself as a listener</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+      ww.unregisterNotification(this);</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+    }</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+  });</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+  function doTest(aWin)</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+  {</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+    // Select all the bookmarks</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+    synthesizeKey(&quot;a&quot;, {accelKey:true}, aWin);</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+    // If we can, start shark</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineplus">+    try {</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineplus">+      connectShark();</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+      startShark();</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+    }</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+    catch (e) { }</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+    // Delete the bookmarks</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+    let start = Date.now();</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+    synthesizeKey(&quot;VK_BACK_SPACE&quot;, {}, aWin);</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+    let end = Date.now();</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+    // Stop shark, if we can</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+    try {</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+      stopShark();</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+      disconnectionShark();</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+    }</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+    catch (e) { }</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+    // Close the window, and write the results out</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+    aWin.close();</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+    document.getElementById(&quot;test-result&quot;).value =</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+      &quot;Duration was &quot; + String(end - start) + &quot;ms&quot;;</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineplus">+    SimpleTest.finish();</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+  }</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineplus">+</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+  // And open the window</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+  wm.getMostRecentWindow(&quot;navigator:browser&quot;)</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+    .openDialog(&quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;,</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+                &quot;&quot;, &quot;chrome,toolbar=yes,dialog=no,resizable&quot;,</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+                &quot;UnfiledBookmarks&quot;);</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+  SimpleTest.waitForExplicitFinish();</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+}</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+  ]]&gt;</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineplus">+  &lt;/script&gt;</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineplus">+  &lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineplus">+    &lt;p id=&quot;display&quot;&gt;&lt;/p&gt;</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+    &lt;div id=&quot;content&quot; style=&quot;display:none;&quot;&gt;&lt;/div&gt;</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineplus">+    &lt;pre id=&quot;test&quot;&gt;&lt;/pre&gt;</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineplus">+  &lt;label id=&quot;test-result&quot;/&gt;</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineplus">+&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/suite/common/places/tests/chrome/test_0_bug510634.xul</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,138 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+   - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+   -</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+   - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+   - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+   - the License. You may obtain a copy of the License at</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+   - http://www.mozilla.org/MPL/</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+   -</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+   - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+   - for the specific language governing rights and limitations under the</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+   - License.</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+   -</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+   - The Original Code is the Places test code.</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+   -</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+   - The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+   - Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+   - the Initial Developer. All Rights Reserved.</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+   -</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+   - Contributor(s):</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+   -   Asaf Romano (Original Author)</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+   -</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+   - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+   - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+   - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+   - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+   - the provisions above, a recipient may use your version of this file under</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+   - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+   -</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+   - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://mochikit/content/tests/SimpleTest/test.css&quot;</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+                 type=&quot;text/css&quot;?&gt;</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/places.css&quot;?&gt;</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/places.css&quot;?&gt;</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/placesOverlay.xul&quot;?&gt;</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+&lt;window xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+        title=&quot;510634: Wrong icons on bookmarks sidebar&quot;</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+        onload=&quot;runTest();&quot;&gt;</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+          src=&quot;chrome://mochikit/content/MochiKit/packed.js&quot; /&gt;</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+          src=&quot;chrome://mochikit/content/tests/SimpleTest/SimpleTest.js&quot; /&gt;</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+  &lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot; /&gt;</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+  &lt;tree id=&quot;tree&quot;</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+        type=&quot;places&quot;</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+        flex=&quot;1&quot;&gt;</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+    &lt;treecols&gt;</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+      &lt;treecol label=&quot;Title&quot; id=&quot;title&quot; anonid=&quot;title&quot; primary=&quot;true&quot; ordinal=&quot;1&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+    &lt;/treecols&gt;</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+    &lt;treechildren flex=&quot;1&quot;/&gt;</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+  &lt;/tree&gt;</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+  &lt;![CDATA[</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+    /**</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+     * Bug 510634 -  Wrong icons on bookmarks sidebar</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+     * https://bugzilla.mozilla.org/show_bug.cgi?id=510634</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+     *</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+     * Ensures that properties for special queries are set on their tree nodes,</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+     * even if PlacesUIUtils.leftPaneFolderId was not initialized.</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+     */</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+    SimpleTest.waitForExplicitFinish();</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+    function createSupportsArray() {</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+      return Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+                       .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+    }</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+    // converts nsISupportsArray of atoms to a simple JS-strings array</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+    function convertPropertiesToJSArray(aSupportsArray) {</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+      var results = [];</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+      var count = aSupportsArray.Count();</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+      for (var i = 0; i &lt; count; i++)</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+        results.push(aSupportsArray.QueryElementAt(i, Components.interfaces.nsIAtom).toString());</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+      return results;</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+    }</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+    function runTest() {</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+      // We need to cache and restore this getter in order to simulate</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+      // Bug 510634</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+      let cachedLeftPaneFolderIdGetter =</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+        PlacesUIUtils.__lookupGetter__(&quot;leftPaneFolderId&quot;);</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+      let leftPaneFolderId = PlacesUIUtils.leftPaneFolderId;</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+      // restore the getter</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+      PlacesUIUtils.__defineGetter__(&quot;leftPaneFolderId&quot;, cachedLeftPaneFolderIdGetter);</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+      // Setup the places tree contents.</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+      let tree = document.getElementById(&quot;tree&quot;);</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+      tree.place = &quot;place:queryType=1&amp;folder=&quot; + leftPaneFolderId;</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+      // Open All Bookmarks</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+      PlacesUtils.asContainer(tree.view.nodeForTreeIndex(1)).containerOpen = true;</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+      // The query-property is set on the title column for each row.</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+      let titleColumn = tree.treeBoxObject.columns.getColumnAt(0);</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+      [&quot;Tags&quot;, &quot;AllBookmarks&quot;, &quot;BookmarksToolbar&quot;,</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+       &quot;BookmarksMenu&quot;, &quot;UnfiledBookmarks&quot;].forEach(</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+         function(aQueryName, aRow) {</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+           let rowProperties = createSupportsArray();</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineplus">+           tree.view.getCellProperties(aRow, titleColumn, rowProperties);</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+           rowProperties = convertPropertiesToJSArray(rowProperties);</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+           ok(rowProperties.indexOf(&quot;OrganizerQuery_&quot; + aQueryName) != -1,</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+             &quot;OrganizerQuery_&quot; + aQueryName + &quot; is set&quot;);</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+         }</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+       );</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+      // Close the root node</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+      tree.result.root.containerOpen = false;</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+      // Restore the getter for the next test.</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+      PlacesUIUtils.__defineGetter__(&quot;leftPaneFolderId&quot;, cachedLeftPaneFolderIdGetter);</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+      SimpleTest.finish();</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+    }</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+  ]]&gt;</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+  &lt;/script&gt;</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/suite/common/places/tests/chrome/test_0_multiple_left_pane.xul</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,116 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+   - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+   -</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+   - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+   - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+   - the License. You may obtain a copy of the License at</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+   - http://www.mozilla.org/MPL/</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+   -</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+   - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+   - for the specific language governing rights and limitations under the</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+   - License.</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+   -</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+   - The Original Code is the Places test code.</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+   -</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+   - The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+   - Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+   - the Initial Developer. All Rights Reserved.</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+   -</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+   - Contributor(s):</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+   -   Marco Bonardo &lt;mak77@bonardo.net&gt; (Original Author)</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+   -</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+   - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+   - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+   - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+   - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+   - the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+   - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+   -</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+   - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+&lt;!-- Bug 466422:</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+   - Check that we replace the left pane with a correct one if it gets corrupted</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+   - and we end up having more than one. --&gt;</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://mochikit/content/tests/SimpleTest/test.css&quot;</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+                 type=&quot;text/css&quot;?&gt;</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/places.css&quot;?&gt;</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/places.css&quot;?&gt;</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/placesOverlay.xul&quot;?&gt;</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+&lt;window xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+        title=&quot;Test handling of multiple left pane folders&quot;</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+        onload=&quot;runTest();&quot;&gt;</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+          src=&quot;chrome://mochikit/content/MochiKit/packed.js&quot; /&gt;</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+          src=&quot;chrome://mochikit/content/tests/SimpleTest/SimpleTest.js&quot; /&gt;</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+  &lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+    &lt;p id=&quot;display&quot;&gt;&lt;/p&gt;</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+    &lt;div id=&quot;content&quot; style=&quot;display: none&quot;&gt;&lt;/div&gt;</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+    &lt;pre id=&quot;test&quot;&gt;&lt;/pre&gt;</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+  &lt;![CDATA[</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+    function runTest() {</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+      // Sanity checks.</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+      ok(PlacesUtils, &quot;PlacesUtils is running in chrome context&quot;);</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+      ok(PlacesUIUtils, &quot;PlacesUIUtils is running in chrome context&quot;);</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+      ok(PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION &gt; 0,</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+         &quot;Left pane version in chrome context, &quot; +</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+           &quot;current version is: &quot; + PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION );</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+      var fakeLeftPanes = [];</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+      var as = PlacesUtils.annotations;</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+      var bs = PlacesUtils.bookmarks;</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+      // We need 2 left pane folders to simulate a corrupt profile.</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+      do {</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+        let leftPaneItems = as.getItemsWithAnnotation(PlacesUIUtils.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+        // Create a fake left pane folder.</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+        let fakeLeftPaneRoot = bs.createFolder(PlacesUtils.placesRootId, &quot;&quot;,</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+                                               bs.DEFAULT_INDEX);</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+        as.setItemAnnotation(fakeLeftPaneRoot, PlacesUIUtils.ORGANIZER_FOLDER_ANNO,</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+                             PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION, 0,</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+                             as.EXPIRE_NEVER);</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+        fakeLeftPanes.push(fakeLeftPaneRoot);</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+      } while (fakeLeftPanes.length &lt; 2);</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+      // Initialize the left pane queries.</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+      PlacesUIUtils.leftPaneFolderId;</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+      // Check left pane.</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+      ok(PlacesUIUtils.leftPaneFolderId &gt; 0,</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+         &quot;Left pane folder correctly created&quot;);</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+      var leftPaneItems = as.getItemsWithAnnotation(PlacesUIUtils.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+      is(leftPaneItems.length, 1,</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+         &quot;We correctly have only 1 left pane folder&quot;);</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+      // Check that all old left pane items have been removed.</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+      fakeLeftPanes.forEach(function(aItemId) {</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+        try {</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+          bs.getItemTitle(aItemId);</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+          throw(&quot;This folder should have been removed&quot;);</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+        } catch (ex) {}</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+      });</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+    }</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+  ]]&gt;</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+  &lt;/script&gt;</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/suite/common/places/tests/chrome/test_bug427633_no_newfolder_if_noip.xul</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,123 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+   - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+   -</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+   - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+   - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+   - the License. You may obtain a copy of the License at</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+   - http://www.mozilla.org/MPL/</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+   -</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+   - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+   - for the specific language governing rights and limitations under the</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+   - License.</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+   -</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+   - The Original Code is the Places test code.</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+   -</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+   - The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+   - Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+   - the Initial Developer. All Rights Reserved.</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+   -</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+   - Contributor(s):</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+   -   Marco Bonardo &lt;mak77@bonardo.net&gt; (Original Author)</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+   -</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+   - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+   - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+   - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+   - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+   - the provisions above, a recipient may use your version of this file under</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+   - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+   -</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+   - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://mochikit/content/tests/SimpleTest/test.css&quot;</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+                 type=&quot;text/css&quot;?&gt;</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/bookmarks/editBookmarkOverlay.css&quot;?&gt;</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/places.css&quot;?&gt;</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/places.css&quot;?&gt;</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/placesOverlay.xul&quot;?&gt;</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/editBookmarkOverlay.xul&quot;?&gt;</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+&lt;!DOCTYPE window [</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+  &lt;!ENTITY % editBookmarkOverlayDTD SYSTEM &quot;chrome://communicator/locale/bookmarks/editBookmarkOverlay.dtd&quot;&gt;</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+  %editBookmarkOverlayDTD;</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+]&gt;</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+&lt;window xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+        title=&quot;Bug 427633 - Disable creating a New Folder in the bookmarks dialogs if insertionPoint is invalid&quot;</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+        onload=&quot;runTest();&quot;&gt;</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+          src=&quot;chrome://mochikit/content/MochiKit/packed.js&quot; /&gt;</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+          src=&quot;chrome://mochikit/content/tests/SimpleTest/SimpleTest.js&quot; /&gt;</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+          src=&quot;chrome://communicator/content/bookmarks/editBookmarkOverlay.js&quot;/&gt;</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+  &lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot; /&gt;</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+  &lt;vbox id=&quot;editBookmarkPanelContent&quot;/&gt;</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+  &lt;![CDATA[</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+     /**</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+      * Bug 427633 - Disable creating a New Folder in the bookmarks dialogs if</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+      * insertionPoint is invalid.</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+      */</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+    function runTest() {</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+      const Cc = Components.classes;</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+      const Ci = Components.interfaces;</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+      var bs = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+               getService(Ci.nsINavBookmarksService);</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+      var ios = Cc[&quot;@mozilla.org/network/io-service;1&quot;].</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+                getService(Ci.nsIIOService);</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+      function uri(spec) {</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+        return ios.newURI(spec, null, null);</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+      }</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+      // Add a bookmark.</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+      var itemId = bs.insertBookmark(bs.toolbarFolder,</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+                                     uri(&quot;http://www.mozilla.org/&quot;),</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+                                     bs.DEFAULT_INDEX,</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+                                     &quot;mozilla&quot;);</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+      // Init panel.</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+      ok(gEditItemOverlay, &quot;gEditItemOverlay is in context&quot;);</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+      gEditItemOverlay.initPanel(itemId);</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+      ok(gEditItemOverlay._initialized, &quot;gEditItemOverlay is initialized&quot;);</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+      // We must be sure tree is initialized, so we wait for place to be set.</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+      SimpleTest.waitForExplicitFinish();</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+      var tree = gEditItemOverlay._element(&quot;folderTree&quot;);</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+      tree.addEventListener(&quot;DOMAttrModified&quot;, function(event) {</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+          if (event.attrName != &quot;place&quot;)</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+            return;</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+          tree.removeEventListener(&quot;DOMAttrModified&quot;, arguments.callee, false);</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+          SimpleTest.executeSoon(function() {</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+            tree.view.selection.clearSelection();</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+            ok(document.getElementById(&quot;editBMPanel_newFolderButton&quot;).disabled,</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+               &quot;New folder button is disabled if there's no selection&quot;);</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+            // Cleanup.</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+            bs.removeItem(itemId);</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+            SimpleTest.finish();</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+            });</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+        }, false);</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+      // Open the folder tree.</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+      document.getElementById(&quot;editBMPanel_foldersExpander&quot;).doCommand();</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+    }</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+  ]]&gt;</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+  &lt;/script&gt;</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">new file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- /dev/null</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ b/suite/common/places/tests/chrome/test_bug485100-change-case-loses-tag.xul</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -0,0 +1,123 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineplus">+</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineplus">+   - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+   -</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+   - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+   - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+   - the License. You may obtain a copy of the License at</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+   - http://www.mozilla.org/MPL/</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+   -</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+   - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+   - for the specific language governing rights and limitations under the</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+   - License.</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+   -</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+   - The Original Code is the Places test code.</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+   -</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+   - The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+   - Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+   - the Initial Developer. All Rights Reserved.</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+   -</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+   - Contributor(s):</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+   -   Marco Bonardo &lt;mak77@bonardo.net&gt; (Original Author)</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+   -   Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+   -</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+   - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+   - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+   - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+   - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+   - the provisions above, a recipient may use your version of this file under</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+   - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+   -</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+   - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://mochikit/content/tests/SimpleTest/test.css&quot;</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+                 type=&quot;text/css&quot;?&gt;</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/bookmarks/editBookmarkOverlay.css&quot;?&gt;</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/places.css&quot;?&gt;</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/places.css&quot;?&gt;</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/placesOverlay.xul&quot;?&gt;</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/editBookmarkOverlay.xul&quot;?&gt;</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+&lt;!DOCTYPE window [</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+  &lt;!ENTITY % editBookmarkOverlayDTD SYSTEM &quot;chrome://browser/locale/bookmarks/editBookmarkOverlay.dtd&quot;&gt;</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+  %editBookmarkOverlayDTD;</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+]&gt;</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+&lt;window xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+        title=&quot;485100: Exchanging a letter of a tag name with its big/small equivalent removes tag from bookmark&quot;</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+        onload=&quot;runTest();&quot;&gt;</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+          src=&quot;chrome://mochikit/content/MochiKit/packed.js&quot; /&gt;</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+          src=&quot;chrome://mochikit/content/tests/SimpleTest/SimpleTest.js&quot; /&gt;</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+          src=&quot;chrome://communicator/content/bookmarks/editBookmarkOverlay.js&quot;/&gt;</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+  &lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot; /&gt;</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+  &lt;vbox id=&quot;editBookmarkPanelContent&quot;/&gt;</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+  &lt;![CDATA[</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+    function runTest() {</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+      const Cc = Components.classes;</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+      const Ci = Components.interfaces;</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+      var bs = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+               getService(Ci.nsINavBookmarksService);</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+      var ts = Cc[&quot;@mozilla.org/browser/tagging-service;1&quot;].</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+               getService(Ci.nsITaggingService);</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+      var ios = Cc[&quot;@mozilla.org/network/io-service;1&quot;].</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+                getService(Ci.nsIIOService);</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+      function uri(spec) {</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+        return ios.newURI(spec, null, null);</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+      }</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+      var testURI = uri(&quot;http://www.mozilla.org/&quot;);</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+      var testTag = &quot;foo&quot;;</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+      var testTagUpper = &quot;Foo&quot;;</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+      // Add a bookmark</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+      var itemId = bs.insertBookmark(bs.toolbarFolder,</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+                                     testURI,</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+                                     bs.DEFAULT_INDEX,</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+                                     &quot;mozilla&quot;);</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineplus">+</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineplus">+      // Init panel</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+      ok(gEditItemOverlay, &quot;gEditItemOverlay is in context&quot;);</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+      gEditItemOverlay.initPanel(itemId);</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+      // add a tag</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+      document.getElementById(&quot;editBMPanel_tagsField&quot;).value = testTag;</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+      gEditItemOverlay.onTagsFieldBlur();</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineplus">+</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineplus">+      // test that the tag has been added in the backend</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineplus">+      is(ts.getTagsForURI(testURI)[0], testTag, &quot;tags match&quot;);</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineplus">+      // change the tag</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineplus">+      document.getElementById(&quot;editBMPanel_tagsField&quot;).value = testTagUpper;</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineplus">+      gEditItemOverlay.onTagsFieldBlur();</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineplus">+</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineplus">+      // test that the tag has been added in the backend</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+      is(ts.getTagsForURI(testURI)[0], testTagUpper, &quot;tags match&quot;);</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineplus">+</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+      // Cleanup.</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+      ts.untagURI(testURI, [testTag]);</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+      bs.removeItem(itemId);</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+    }</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineplus">+  ]]&gt;</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineplus">+  &lt;/script&gt;</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineplus">+</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineplus">+&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">new file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- /dev/null</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ b/suite/common/places/tests/chrome/test_bug549192.xul</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -0,0 +1,120 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineplus">+</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineplus">+&lt;!--</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineplus">+    Any copyright is dedicated to the Public Domain.</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineplus">+    http://creativecommons.org/licenses/publicdomain/</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+   --&gt;</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineplus">+</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://mochikit/content/tests/SimpleTest/test.css&quot;</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+                 type=&quot;text/css&quot;?&gt;</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/places.css&quot;?&gt;</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/places.css&quot;?&gt;</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/placesOverlay.xul&quot;?&gt;</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+&lt;window xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+        title=&quot;549192:  History view not updated after deleting entry&quot;</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+        onload=&quot;runTest();&quot;&gt;</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+          src=&quot;chrome://mochikit/content/MochiKit/packed.js&quot; /&gt;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+          src=&quot;chrome://mochikit/content/tests/SimpleTest/SimpleTest.js&quot; /&gt;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+  &lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot; /&gt;</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+  &lt;tree id=&quot;tree&quot;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+        type=&quot;places&quot;</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+        flatList=&quot;true&quot;</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+        flex=&quot;1&quot;&gt;</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+    &lt;treecols&gt;</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+      &lt;treecol label=&quot;Title&quot; id=&quot;title&quot; anonid=&quot;title&quot; primary=&quot;true&quot; ordinal=&quot;1&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+    &lt;/treecols&gt;</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+    &lt;treechildren flex=&quot;1&quot;/&gt;</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+  &lt;/tree&gt;</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;&gt;&lt;![CDATA[</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+    /**</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+     * Bug 549192</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+     * https://bugzilla.mozilla.org/show_bug.cgi?id=549192</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+     *</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+     * Ensures that history views are updated after deleting entries.</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+     */</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+      Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+      const Cc = Components.classes;</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+      const Ci = Components.interfaces;</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+    SimpleTest.waitForExplicitFinish();</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+    function runTest() {</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+      // The mochitest page is added to history.</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineplus">+      waitForClearHistory(continue_test);</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+    }</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+    function continue_test() {</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineplus">+</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+      // Add some visits.</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+      let vtime = Date.now() * 1000;</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+      const ttype = PlacesUtils.history.TRANSITION_TYPED;</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+      PlacesUtils.history</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+                 .addVisit(Services.io.newURI(&quot;http://example.tld/&quot;, null, null),</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+                           vtime, null, ttype, false, 0);</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+      PlacesUtils.history</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+                 .addVisit(Services.io.newURI(&quot;http://example2.tld/&quot;, null, null),</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+                           vtime++, null, ttype, false, 0);</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+      PlacesUtils.history</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+                 .addVisit(Services.io.newURI(&quot;http://exmample3.tld/&quot;, null, null),</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineplus">+                           vtime++, null, ttype, false, 0);</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineplus">+      // Make a history query.</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+      let query = PlacesUtils.history.getNewQuery();</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+      let opts = PlacesUtils.history.getNewQueryOptions();</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+      let queryURI = PlacesUtils.history.queriesToQueryString([query], 1, opts);</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineplus">+      // Setup the places tree contents.</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineplus">+      var tree = document.getElementById(&quot;tree&quot;);</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineplus">+      tree.place = queryURI;</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineplus">+</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineplus">+      // loop through the rows and check formatting</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineplus">+      let treeView = tree.view;</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineplus">+      for (let i = 0; i &lt; rc; i++) {</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineplus">+        selection.select(rc);</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineplus">+        let node = tree.selectedNode;</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineplus">+        ok(true, &quot;found &quot; + node.title);</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineplus">+      }</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineplus">+      let rc = treeView.rowCount;</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineplus">+      is(rc, 3, &quot;Rows found.&quot;);</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineplus">+      let selection = treeView.selection;</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineplus">+      for (let i = 0; i &lt; rc; i++) {</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+        selection.select(0);</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineplus">+        let node = tree.selectedNode;</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineplus">+        tree.controller.remove(&quot;Removing page&quot;);</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineplus">+        ok(treeView.treeIndexForNode(node) == Ci.nsINavHistoryResultTreeViewer.INDEX_INVISIBLE,</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineplus">+           node.uri + &quot; removed.&quot;);</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineplus">+        ok(treeView.rowCount == rc - i - 1, &quot;Rows count decreased&quot;);</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineplus">+      }</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineplus">+</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineplus">+      // Cleanup.</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+      waitForClearHistory(SimpleTest.finish);</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineplus">+    }</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineplus">+</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+    /**</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineplus">+     * Clears history invoking callback when done.</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineplus">+     */</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineplus">+    function waitForClearHistory(aCallback) {</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineplus">+      const TOPIC_EXPIRATION_FINISHED = &quot;places-expiration-finished&quot;;</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineplus">+      let observer = {</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineplus">+        observe: function(aSubject, aTopic, aData) {</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineplus">+          Services.obs.removeObserver(this, TOPIC_EXPIRATION_FINISHED);</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineplus">+          aCallback();</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineplus">+        }</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineplus">+      };</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineplus">+      Services.obs.addObserver(observer, TOPIC_EXPIRATION_FINISHED, false);</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+      let hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+               getService(Ci.nsINavHistoryService);</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineplus">+      hs.QueryInterface(Ci.nsIBrowserHistory).removeAllPages();</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineplus">+   }</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineplus">+</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineplus">+  ]]&gt;&lt;/script&gt;</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineplus">+&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">new file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- /dev/null</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ b/suite/common/places/tests/chrome/test_bug549491.xul</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -0,0 +1,100 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineplus">+</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineplus">+&lt;!--</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineplus">+    Any copyright is dedicated to the Public Domain.</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineplus">+    http://creativecommons.org/licenses/publicdomain/</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineplus">+   --&gt;</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineplus">+</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://mochikit/content/tests/SimpleTest/test.css&quot;</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+                 type=&quot;text/css&quot;?&gt;</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/places.css&quot;?&gt;</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/places.css&quot;?&gt;</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/placesOverlay.xul&quot;?&gt;</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+&lt;window xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineplus">+        title=&quot;549491: 'The root node is never visible' exception when details of the root node are modified &quot;</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+        onload=&quot;runTest();&quot;&gt;</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineplus">+          src=&quot;chrome://mochikit/content/MochiKit/packed.js&quot; /&gt;</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+          src=&quot;chrome://mochikit/content/tests/SimpleTest/SimpleTest.js&quot; /&gt;</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineplus">+</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+  &lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot; /&gt;</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+  &lt;tree id=&quot;tree&quot;</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+        type=&quot;places&quot;</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+        flatList=&quot;true&quot;</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+        flex=&quot;1&quot;&gt;</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+    &lt;treecols&gt;</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+      &lt;treecol label=&quot;Title&quot; id=&quot;title&quot; anonid=&quot;title&quot; primary=&quot;true&quot; ordinal=&quot;1&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+      &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+      &lt;treecol label=&quot;Date&quot; anonid=&quot;date&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+    &lt;/treecols&gt;</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+    &lt;treechildren flex=&quot;1&quot;/&gt;</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+  &lt;/tree&gt;</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;&gt;&lt;![CDATA[</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+    /**</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+     * Bug 549491</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+     * https://bugzilla.mozilla.org/show_bug.cgi?id=549491</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+     *</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+     * Ensures that changing the details of places tree's root-node doesn't</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+     * throw.</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+     */</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+      Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+      const Cc = Components.classes;</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+      const Ci = Components.interfaces;</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+    SimpleTest.waitForExplicitFinish();</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineplus">+    function runTest() {</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+      // The mochitest page is added to history.</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+      waitForClearHistory(continue_test);</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+    }</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+    function continue_test() {</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineplus">+      PlacesUtils.history</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+                 .addVisit(Services.io.newURI(&quot;http://example.tld/&quot;, null, null),</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineplus">+                           Date.now() * 1000, null, PlacesUtils.history.TRANSITION_TYPED, false, 0);</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineplus">+</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+      // Make a history query.</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineplus">+      let query = PlacesUtils.history.getNewQuery();</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+      let opts = PlacesUtils.history.getNewQueryOptions();</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+      let queryURI = PlacesUtils.history.queriesToQueryString([query], 1, opts);</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+      // Setup the places tree contents.</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineplus">+      let tree = document.getElementById(&quot;tree&quot;);</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+      tree.place = queryURI;</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineplus">+</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+      let rootNode = tree.result.root;</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineplus">+      let obs = tree.view.QueryInterface(Ci.nsINavHistoryResultObserver);</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+      obs.nodeHistoryDetailsChanged(rootNode, rootNode.time, rootNode.accessCount);</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+      obs.nodeTitleChanged(rootNode, rootNode.title);</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+      ok(true, &quot;No exceptions thrown&quot;);</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineplus">+      // Cleanup.</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+      waitForClearHistory(SimpleTest.finish);</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineplus">+    }</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineplus">+</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+    /**</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineplus">+     * Clears history invoking callback when done.</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineplus">+     */</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineplus">+    function waitForClearHistory(aCallback) {</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineplus">+      const TOPIC_EXPIRATION_FINISHED = &quot;places-expiration-finished&quot;;</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineplus">+      let observer = {</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineplus">+        observe: function(aSubject, aTopic, aData) {</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+          Services.obs.removeObserver(this, TOPIC_EXPIRATION_FINISHED);</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+          aCallback();</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+        }</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+      };</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+      Services.obs.addObserver(observer, TOPIC_EXPIRATION_FINISHED, false);</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+      let hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+               getService(Ci.nsINavHistoryService);</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineplus">+      hs.QueryInterface(Ci.nsIBrowserHistory).removeAllPages();</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineplus">+   }</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineplus">+  ]]&gt;&lt;/script&gt;</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineplus">+&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">new file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- /dev/null</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ b/suite/common/places/tests/chrome/test_treeview_date.xul</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -0,0 +1,224 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineplus">+</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+   - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+   -</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+   - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineplus">+   - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+   - the License. You may obtain a copy of the License at</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+   - http://www.mozilla.org/MPL/</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+   -</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+   - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+   - for the specific language governing rights and limitations under the</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+   - License.</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+   -</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+   - The Original Code is the Places test code.</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineplus">+   -</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+   - The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+   - Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+   - the Initial Developer. All Rights Reserved.</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+   -</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+   - Contributor(s):</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+   -   Marco Bonardo &lt;mak77@bonardo.net&gt; (Original Author)</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+   -</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+   - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+   - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+   - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+   - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+   - the provisions above, a recipient may use your version of this file under</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+   - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+   -</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+   - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://mochikit/content/tests/SimpleTest/test.css&quot;</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+                 type=&quot;text/css&quot;?&gt;</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/places.css&quot;?&gt;</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/places.css&quot;?&gt;</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/placesOverlay.xul&quot;?&gt;</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+&lt;window xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+        title=&quot;435322: Places tree view's formatting&quot;</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+        onload=&quot;runTest();&quot;&gt;</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+          src=&quot;chrome://mochikit/content/MochiKit/packed.js&quot; /&gt;</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+          src=&quot;chrome://mochikit/content/tests/SimpleTest/SimpleTest.js&quot; /&gt;</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+  &lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot; /&gt;</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineplus">+</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+  &lt;tree id=&quot;tree&quot;</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+        type=&quot;places&quot;</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+        flatList=&quot;true&quot;</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineplus">+        flex=&quot;1&quot;&gt;</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+    &lt;treecols&gt;</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+      &lt;treecol label=&quot;Title&quot; id=&quot;title&quot; anonid=&quot;title&quot; primary=&quot;true&quot; ordinal=&quot;1&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+      &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+      &lt;treecol label=&quot;Tags&quot; id=&quot;tags&quot; anonid=&quot;tags&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+      &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+      &lt;treecol label=&quot;Url&quot; id=&quot;url&quot; anonid=&quot;url&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+      &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+      &lt;treecol label=&quot;Visit Date&quot; id=&quot;date&quot; anonid=&quot;date&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+      &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+      &lt;treecol label=&quot;Visit Count&quot; id=&quot;visitCount&quot; anonid=&quot;visitCount&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+    &lt;/treecols&gt;</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+    &lt;treechildren flex=&quot;1&quot;/&gt;</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+  &lt;/tree&gt;</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+  &lt;![CDATA[</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+    /**</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+     * Bug 435322</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+     * https://bugzilla.mozilla.org/show_bug.cgi?id=435322</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+     *</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+     * Ensures that date in places treeviews is correctly formatted.</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+     */</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+      Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+      const Cc = Components.classes;</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+      const Ci = Components.interfaces;</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+    SimpleTest.waitForExplicitFinish();</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+    function runTest() {</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+      // The mochitest page is added to history.</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+      waitForClearHistory(continue_test);</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+    }</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+    function continue_test() {</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+      var hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+               getService(Ci.nsINavHistoryService);</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+      var bh = hs.QueryInterface(Ci.nsIBrowserHistory);</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+      var bs = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+               getService(Ci.nsINavBookmarksService);</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+      var ds = Cc[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;].</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineplus">+               getService(Ci.nsIScriptableDateFormat);</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+      var iosvc = Cc[&quot;@mozilla.org/network/io-service;1&quot;].</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+                  getService(Ci.nsIIOService);</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+      function uri(spec) {</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+        return iosvc.newURI(spec, null, null);</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineplus">+      }</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+      var midnight = new Date();</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineplus">+      midnight.setHours(0);</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineplus">+      midnight.setMinutes(0);</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineplus">+      midnight.setSeconds(0);</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineplus">+      midnight.setMilliseconds(0);</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineplus">+</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+      // Add a visit 1ms before midnight.</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineplus">+      hs.addVisit(uri(&quot;http://before.midnight.com/&quot;),</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineplus">+                  (midnight.getTime() - 1) * 1000,</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineplus">+                  null, hs.TRANSITION_TYPED, false, 0);</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+      // Add a visit at midnight.</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+      hs.addVisit(uri(&quot;http://at.midnight.com/&quot;),</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineplus">+                  (midnight.getTime()) * 1000,</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineplus">+                  null, hs.TRANSITION_TYPED, false, 0);</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineplus">+</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineplus">+      // Add a visit 1ms after midnight.</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineplus">+      hs.addVisit(uri(&quot;http://after.midnight.com/&quot;),</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineplus">+                  (midnight.getTime() + 1) * 1000,</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineplus">+                  null, hs.TRANSITION_TYPED, false, 0);</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineplus">+</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineplus">+      // add a bookmark to the midnight visit</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineplus">+      var itemId = bs.insertBookmark(bs.toolbarFolder,</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineplus">+                                     uri(&quot;http://at.midnight.com/&quot;),</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineplus">+                                     bs.DEFAULT_INDEX,</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineplus">+                                     &quot;A bookmark at midnight&quot;);</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineplus">+</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineplus">+      // Make a history query.</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineplus">+      var query = hs.getNewQuery();</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineplus">+      var opts = hs.getNewQueryOptions();</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineplus">+      var queryURI = hs.queriesToQueryString([query], 1, opts);</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineplus">+</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineplus">+      // Setup the places tree contents.</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineplus">+      var tree = document.getElementById(&quot;tree&quot;);</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineplus">+      tree.place = queryURI;</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineplus">+</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineplus">+      // loop through the rows and check formatting</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineplus">+      var treeView = tree.view;</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineplus">+      var rc = treeView.rowCount;</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineplus">+      ok(rc &gt;= 3, &quot;Rows found&quot;);</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineplus">+      var columns = tree.columns;</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineplus">+      ok(columns.count &gt; 0, &quot;Columns found&quot;);</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineplus">+      for (var r = 0; r &lt; rc; r++) {</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineplus">+        var node = treeView.nodeForTreeIndex(r);</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineplus">+        ok(node, &quot;Places node found&quot;);</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineplus">+        for (var ci = 0; ci &lt; columns.count; ci++) {</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineplus">+          var c = columns.getColumnAt(ci);</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineplus">+          var text = treeView.getCellText(r, c);</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineplus">+          switch (c.element.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineplus">+            case &quot;title&quot;:</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineplus">+              // The title can differ, we did not set any title so we would</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineplus">+              // expect null, but in such a case the view will generate a title</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineplus">+              // through PlacesUIUtils.getBestTitle.</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineplus">+              if (node.title)</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineplus">+                is(text, node.title, &quot;Title is correct&quot;);</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineplus">+              break;</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineplus">+            case &quot;url&quot;:</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineplus">+              is(text, node.uri, &quot;Uri is correct&quot;);</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineplus">+              break;</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineplus">+            case &quot;date&quot;:</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineplus">+              var timeObj = new Date(node.time / 1000);</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineplus">+              // Default is short date format.</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineplus">+              var dateFormat = Ci.nsIScriptableDateFormat.dateFormatShort;</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineplus">+              // For today's visits we don't show date portion.</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineplus">+              if (node.uri == &quot;http://at.midnight.com/&quot; ||</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineplus">+                  node.uri == &quot;http://after.midnight.com/&quot;)</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineplus">+                dateFormat = Ci.nsIScriptableDateFormat.dateFormatNone;</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineplus">+              else if (node.uri == &quot;http://before.midnight.com/&quot;)</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineplus">+                dateFormat = Ci.nsIScriptableDateFormat.dateFormatShort;</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineplus">+              else {</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineplus">+                // Avoid to test spurious uris, due to how the test works</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineplus">+                // a redirecting uri could be put in the tree while we test.</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineplus">+                break;</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineplus">+              }</span>
<a href="#l24.190"></a><span id="l24.190" class="difflineplus">+              var timeStr = ds.FormatDateTime(&quot;&quot;, dateFormat,</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineplus">+                    Ci.nsIScriptableDateFormat.timeFormatNoSeconds,</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineplus">+                    timeObj.getFullYear(), timeObj.getMonth() + 1,</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineplus">+                    timeObj.getDate(), timeObj.getHours(),</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineplus">+                    timeObj.getMinutes(), timeObj.getSeconds())</span>
<a href="#l24.195"></a><span id="l24.195" class="difflineplus">+</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineplus">+              is(text, timeStr, &quot;Date format is correct&quot;);</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineplus">+              break;</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineplus">+            case &quot;visitCount&quot;:</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineplus">+              is(text, 1, &quot;Visit count is correct&quot;);</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineplus">+              break;</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineplus">+          }</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineplus">+        }</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineplus">+      }</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineplus">+      // Cleanup.</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineplus">+      bs.removeItem(itemId);</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineplus">+      waitForClearHistory(SimpleTest.finish);</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineplus">+    }</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineplus">+</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineplus">+    /**</span>
<a href="#l24.210"></a><span id="l24.210" class="difflineplus">+     * Clears history invoking callback when done.</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineplus">+     */</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineplus">+    function waitForClearHistory(aCallback) {</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineplus">+      const TOPIC_EXPIRATION_FINISHED = &quot;places-expiration-finished&quot;;</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineplus">+      let observer = {</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineplus">+        observe: function(aSubject, aTopic, aData) {</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineplus">+          Services.obs.removeObserver(this, TOPIC_EXPIRATION_FINISHED);</span>
<a href="#l24.217"></a><span id="l24.217" class="difflineplus">+          aCallback();</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineplus">+        }</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineplus">+      };</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineplus">+      Services.obs.addObserver(observer, TOPIC_EXPIRATION_FINISHED, false);</span>
<a href="#l24.221"></a><span id="l24.221" class="difflineplus">+      let hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineplus">+               getService(Ci.nsINavHistoryService);</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineplus">+      hs.QueryInterface(Ci.nsIBrowserHistory).removeAllPages();</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineplus">+   }</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineplus">+</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineplus">+  ]]&gt;</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineplus">+  &lt;/script&gt;</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineplus">+&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">new file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- /dev/null</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ b/suite/common/places/tests/unit/bookmarks.corrupt.html</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -0,0 +1,63 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineplus">+&lt;!DOCTYPE NETSCAPE-Bookmark-file-1&gt;</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineplus">+&lt;!-- This is an automatically generated file.</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineplus">+     It will be read and overwritten.</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineplus">+     DO NOT EDIT! --&gt;</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineplus">+&lt;META HTTP-EQUIV=&quot;Content-Type&quot; CONTENT=&quot;text/html; charset=UTF-8&quot;&gt;</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+&lt;TITLE&gt;Bookmarks&lt;/TITLE&gt;</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+&lt;H1 LAST_MODIFIED=&quot;1177541029&quot;&gt;Bookmarks&lt;/H1&gt;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+&lt;DL&gt;&lt;p&gt;</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+    &lt;DT&gt;&lt;H3 UNFILED_BOOKMARKS_FOLDER=&quot;true&quot;&gt;Unsorted Bookmarks&lt;/H3&gt;</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+    &lt;DL&gt;&lt;p&gt;</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://example.tld&quot;&gt;Example.tld&lt;/A&gt;</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+    &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+    &lt;DT&gt;&lt;H3 LAST_MODIFIED=&quot;1177541040&quot; PERSONAL_TOOLBAR_FOLDER=&quot;true&quot; ID=&quot;NC:PersonalToolbarFolder&quot;&gt;Bookmarks Toolbar Folder&lt;/H3&gt;</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+&lt;DD&gt;Add bookmarks to this folder to see them displayed on the Bookmarks Toolbar</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+    &lt;DL&gt;&lt;p&gt;</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://www.seamonkey-project.org/&quot; LAST_VISIT=&quot;1274050000&quot; LAST_CHARSET=&quot;UTF-8&quot; ICON=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH1QwCEiUG/+wAegAAAu5JREFUOMtlk01oXFUUx3/3vfte3kydmeeQJgUTMsEaKX40tREbDHYE6UIXnZVUujCIiu3GKl0EXRh3ol1EF8WutItuuum4sRTRRXFRFGUyRPxIyVe1mK+ZZD46d968e6+LSduoFw7/c+D+Dv8D5wj+984NDQ4mz6TT/iiAMWCMRanO1urqnaJSZy/u/i12F2H46Qe5XGo6DAOMscSxQWuL1t08imI2NlRpba05CVOz/2qQSJx7+/DhfTPAPUhrQxwbJl54mHemJnCkg20pxh67sFStqlGY2pZd/OOjIyPZmTi+D91t0N+/h/enn2NuFW78aXm6dRvfd3NBIItK8bwEGB5Oz3iei1IxWpt7lrW2vPjKKKoDv65bMr5m4kiOvr4kjUaUh0+OO/DRwSBwR5WKabc1Smnu5zGFwgjfLsIv69CKDL+vG44dGyaKNK5rJ+XAQCqfTifY3Gzumrurp04dom0dlrag3gZtBc2OIZPpIZVK0tubycuxsSfD44VnsQaMBbsTxsDBIx3O/2hRsSAbWFwBf21b8vmn6N83zvz8SijL5YhGo47rguOC0YZsVjI+nuAP7RNpCANLpREzkBYMZly+vhxRLivq9Ri5vLxdqlQaaA1as2MfTp7u4fqGS0dbDvVp6hlBJrD0bFkuXarheaBUpSS1Xii1WvsxJovWXfufnX+QK5uSB3xN0tGkfIdHeyFahddfqxIEAs+DZvPv0s4iXf1CiCcmoQvf2Bvw8oEYAazUBM/sFfz8XZsLnzdRyiKlwJg15uau5XYWafYMpAvvvvd4OD+U4PRDMeYO3F7QbP7W4c1ii1YLPA+CQCBExK1b5Wk4uywArLVDxZ+aX6qeZD5ZiXjrRAXP69qUsqueJ5ASoqjC4uIP07Xaqx8CONbaK9+v2KUDuT3sV2uFky99U3TdJkEgCAJBItFVKSNqtYWlmzevT96FAYS19iiwJYSY3X3S2ewjBd8PQinBcaBaXSnV62989d/j/wcgGYelT45hgQAAAABJRU5ErkJggg==&quot; ID=&quot;rdf:#$q2rCs3&quot;&gt;SeaMonkey&lt;/A&gt;</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://www.mozilla.org/&quot; LAST_VISIT=&quot;1274050586&quot; LAST_CHARSET=&quot;UTF-8&quot; ID=&quot;rdf:#$r2rCs3&quot;&gt;mozilla.org&lt;/A&gt;</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://www.mozillazine.org/&quot; ID=&quot;rdf:#$s2rCs3&quot;&gt;mozillaZine&lt;/A&gt;</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://en-US.fxfeeds.mozilla.com/en-US/firefox/livebookmarks/&quot; LAST_MODIFIED=&quot;1177541035&quot; FEEDURL=&quot;http://en-US.fxfeeds.mozilla.com/en-US/firefox/headlines.xml&quot; ID=&quot;rdf:#$HvPhC3&quot;&gt;Latest Headlines&lt;/A&gt;</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://bogus-icon.mozilla.com/&quot; ICON=&quot;b0rked&quot; ID=&quot;rdf:#$GvPhC3&quot;&gt;Getting Started&lt;/A&gt;</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+&lt;DD&gt;Livemark test comment</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+    &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+    &lt;DT&gt;&lt;H3 ID=&quot;rdf:#$u2rCs3&quot;&gt;SeaMonkey and Mozilla&lt;/H3&gt;</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+    &lt;DL&gt;&lt;p&gt;</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://www.seamonkey-project.org/&quot; LAST_VISIT=&quot;1274050000&quot; LAST_CHARSET=&quot;UTF-8&quot; ID=&quot;rdf:#$v2rCs3&quot;&gt;The SeaMonkey Project&lt;/A&gt;</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+        &lt;DT&gt;&lt;H3 ID=&quot;rdf:#$w2rCs3&quot;&gt;mozilla.org&lt;/H3&gt;</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+        &lt;DL&gt;&lt;p&gt;</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.mozilla.org/&quot; LAST_VISIT=&quot;1274050586&quot; LAST_CHARSET=&quot;UTF-8&quot; ID=&quot;rdf:#$x2rCs3&quot;&gt;The Mozilla Organization&lt;/A&gt;</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.mozilla.org/projects/&quot; ID=&quot;rdf:#$y2rCs3&quot;&gt;Mozilla Projects&lt;/A&gt;</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.mozilla.org/about/&quot; ID=&quot;rdf:#$z2rCs3&quot;&gt;About Mozilla&lt;/A&gt;</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+        &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+        &lt;DT&gt;&lt;H3 ID=&quot;rdf:#$A2rCs3&quot;&gt;Extending SeaMonkey&lt;/H3&gt;</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+        &lt;DL&gt;&lt;p&gt;</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;https://addons.mozilla.org/en-US/seamonkey/&quot; ID=&quot;rdf:#$B2rCs3&quot;&gt;SeaMonkey Add-ons&lt;/A&gt;</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;https://addons.mozilla.org/en-US/seamonkey/themes&quot; ID=&quot;rdf:#$C2rCs3&quot;&gt;SeaMonkey Themes&lt;/A&gt;</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;https://addons.mozilla.org/en-US/seamonkey/dictionaries&quot; ID=&quot;rdf:#$D2rCs3&quot;&gt;Spell Checking Dictionaries&lt;/A&gt;</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;https://addons.mozilla.org/en-US/seamonkey/plugins&quot; ID=&quot;rdf:#$E2rCs3&quot;&gt;Plugins for SeaMonkey&lt;/A&gt;</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.mozdev.org/&quot; ID=&quot;rdf:#$F2rCs3&quot;&gt;mozdev.org&lt;/A&gt;</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.mozdev.org/projects/applications/SeaMonkey.html&quot; ID=&quot;rdf:#$G2rCs3&quot;&gt;SeaMonkey Extensions from mozdev.org&lt;/A&gt;</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+        &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+        &lt;DT&gt;&lt;H3 ID=&quot;rdf:#$H2rCs3&quot;&gt;Community &amp;amp; Support&lt;/H3&gt;</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineplus">+        &lt;DL&gt;&lt;p&gt;</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.seamonkey-project.org/community&quot; ID=&quot;rdf:#$I2rCs3&quot;&gt;SeaMonkey Community&lt;/A&gt;</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.mozillazine.org/&quot; ID=&quot;rdf:#$J2rCs3&quot;&gt;mozillaZine&lt;/A&gt;</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://forums.mozillazine.org/viewforum.php?f=40&quot; ID=&quot;rdf:#$K2rCs3&quot;&gt;SeaMonkey Support Forum (mozillaZine)&lt;/A&gt;</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+        &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;b0rked&quot; ICON=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAHWSURBVHjaYvz//z8DJQAggJiQOe/fv2fv7Oz8rays/N+VkfG/iYnJfyD/1+rVq7ffu3dPFpsBAAHEAHIBCJ85c8bN2Nj4vwsDw/8zQLwKiO8CcRoQu0DxqlWrdsHUwzBAAIGJmTNnPgYa9j8UqhFElwPxf2MIDeIrKSn9FwSJoRkAEEAM0DD4DzMAyPi/G+QKY4hh5WAXGf8PDQ0FGwJ22d27CjADAAIIrLmjo+MXA9R2kAHvGBA2wwx6B8W7od6CeQcggKCmCEL8bgwxYCbUIGTDVkHDBia+CuotgACCueD3TDQN75D4xmAvCoK9ARMHBzAw0AECiBHkAlC0Mdy7x9ABNA3obAZXIAa6iKEcGlMVQHwWyjYuL2d4v2cPg8vZswx7gHyAAAK7AOif7SAbOqCmn4Ha3AHFsIDtgPq/vLz8P4MSkJ2W9h8ggBjevXvHDo4FQUQg/kdypqCg4H8lUIACnQ/SOBMYI8bAsAJFPcj1AAEEjwVQqLpAbXmH5BJjqI0gi9DTAAgDBBCcAVLkgmQ7yKCZxpCQxqUZhAECCJ4XgMl493ug21ZD+aDAXH0WLM4A9MZPXJkJIIAwTAR5pQMalaCABQUULttBGCCAGCnNzgABBgAMJ5THwGvJLAAAAABJRU5ErkJggg==&quot; ID=&quot;rdf:#$52iCK1&quot;&gt;About Us&lt;/A&gt;</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+    &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+    &lt;DT&gt;&lt;H3 ID=&quot;rdf:#$L2rCs3&quot;&gt;Search the Web&lt;/H3&gt;</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+    &lt;DL&gt;&lt;p&gt;</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://www.google.com/&quot; ID=&quot;rdf:#$M2rCs3&quot;&gt;Google&lt;/A&gt;</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://groups.google.com/&quot; ID=&quot;rdf:#$N2rCs3&quot;&gt;Google Groups&lt;/A&gt;</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://news.google.com/&quot; ID=&quot;rdf:#$O2rCs3&quot;&gt;Google News&lt;/A&gt;</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+    &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+    &lt;HR&gt;</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+    &lt;DT&gt;&lt;H3 ADD_DATE=&quot;1177541020&quot; LAST_MODIFIED=&quot;1177541050&quot; ID=&quot;rdf:#$74Gpx2&quot;&gt;test&lt;/H3&gt;</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+&lt;DD&gt;folder test comment</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+    &lt;DL&gt;&lt;p&gt;</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://test/post&quot; ADD_DATE=&quot;1177375336&quot; LAST_MODIFIED=&quot;1177375423&quot; SHORTCUTURL=&quot;test&quot; WEB_PANEL=&quot;true&quot; POST_DATA=&quot;hidden1%3Dbar&amp;amp;text1%3D%25s&quot; LAST_CHARSET=&quot;ISO-8859-1&quot; ID=&quot;rdf:#$pYFe7&quot;&gt;test post keyword&lt;/A&gt;</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineplus">+&lt;DD&gt;item description</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineplus">+    &lt;/DL&gt;</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineplus">+&lt;/DL&gt;&lt;p&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/suite/common/places/tests/unit/bookmarks.glue.html</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+&lt;!DOCTYPE NETSCAPE-Bookmark-file-1&gt;</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+&lt;!-- This is an automatically generated file.</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+     It will be read and overwritten.</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+     DO NOT EDIT! --&gt;</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+&lt;META HTTP-EQUIV=&quot;Content-Type&quot; CONTENT=&quot;text/html; charset=UTF-8&quot;&gt;</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+&lt;TITLE&gt;Bookmarks&lt;/TITLE&gt;</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+&lt;H1&gt;Bookmarks Menu&lt;/H1&gt;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+&lt;DL&gt;&lt;p&gt;</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+    &lt;DT&gt;&lt;A HREF=&quot;http://example.com/&quot; ADD_DATE=&quot;1233157972&quot; LAST_MODIFIED=&quot;1233157984&quot;&gt;example&lt;/A&gt;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+    &lt;DT&gt;&lt;H3 ADD_DATE=&quot;1233157910&quot; LAST_MODIFIED=&quot;1233157972&quot; PERSONAL_TOOLBAR_FOLDER=&quot;true&quot;&gt;Bookmarks Toolbar&lt;/H3&gt;</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+&lt;DD&gt;Add bookmarks to this folder to see them displayed on the Bookmarks Toolbar</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+    &lt;DL&gt;&lt;p&gt;</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://example.com/&quot; ADD_DATE=&quot;1233157972&quot; LAST_MODIFIED=&quot;1233157984&quot;&gt;example&lt;/A&gt;</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+    &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+&lt;/DL&gt;&lt;p&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">new file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- /dev/null</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ b/suite/common/places/tests/unit/bookmarks.glue.json</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineplus">+{&quot;title&quot;:&quot;&quot;,&quot;id&quot;:1,&quot;dateAdded&quot;:1233157910552624,&quot;lastModified&quot;:1233157955206833,&quot;type&quot;:&quot;text/x-moz-place-container&quot;,&quot;root&quot;:&quot;placesRoot&quot;,&quot;children&quot;:[{&quot;title&quot;:&quot;Bookmarks Menu&quot;,&quot;id&quot;:2,&quot;parent&quot;:1,&quot;dateAdded&quot;:1233157910552624,&quot;lastModified&quot;:1233157993171424,&quot;type&quot;:&quot;text/x-moz-place-container&quot;,&quot;root&quot;:&quot;bookmarksMenuFolder&quot;,&quot;children&quot;:[{&quot;title&quot;:&quot;examplejson&quot;,&quot;id&quot;:27,&quot;parent&quot;:2,&quot;dateAdded&quot;:1233157972101126,&quot;lastModified&quot;:1233157984999673,&quot;type&quot;:&quot;text/x-moz-place&quot;,&quot;uri&quot;:&quot;http://example.com/&quot;}]},{&quot;index&quot;:1,&quot;title&quot;:&quot;Bookmarks Toolbar&quot;,&quot;id&quot;:3,&quot;parent&quot;:1,&quot;dateAdded&quot;:1233157910552624,&quot;lastModified&quot;:1233157972101126,&quot;annos&quot;:[{&quot;name&quot;:&quot;bookmarkProperties/description&quot;,&quot;flags&quot;:0,&quot;expires&quot;:4,&quot;mimeType&quot;:null,&quot;type&quot;:3,&quot;value&quot;:&quot;Add bookmarks to this folder to see them displayed on the Bookmarks Toolbar&quot;}],&quot;type&quot;:&quot;text/x-moz-place-container&quot;,&quot;root&quot;:&quot;toolbarFolder&quot;,&quot;children&quot;:[{&quot;title&quot;:&quot;examplejson&quot;,&quot;id&quot;:26,&quot;parent&quot;:3,&quot;dateAdded&quot;:1233157972101126,&quot;lastModified&quot;:1233157984999673,&quot;type&quot;:&quot;text/x-moz-place&quot;,&quot;uri&quot;:&quot;http://example.com/&quot;}]},{&quot;index&quot;:2,&quot;title&quot;:&quot;Tags&quot;,&quot;id&quot;:4,&quot;parent&quot;:1,&quot;dateAdded&quot;:1233157910552624,&quot;lastModified&quot;:1233157910582667,&quot;type&quot;:&quot;text/x-moz-place-container&quot;,&quot;root&quot;:&quot;tagsFolder&quot;,&quot;children&quot;:[]},{&quot;index&quot;:3,&quot;title&quot;:&quot;Unsorted Bookmarks&quot;,&quot;id&quot;:5,&quot;parent&quot;:1,&quot;dateAdded&quot;:1233157910552624,&quot;lastModified&quot;:1233157911033315,&quot;type&quot;:&quot;text/x-moz-place-container&quot;,&quot;root&quot;:&quot;unfiledBookmarksFolder&quot;,&quot;children&quot;:[]}]}</span>
<a href="#l27.6"></a><span id="l27.6">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">new file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- /dev/null</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ b/suite/common/places/tests/unit/bookmarks.preplaces.html</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -0,0 +1,65 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineplus">+&lt;!DOCTYPE NETSCAPE-Bookmark-file-1&gt;</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineplus">+&lt;!-- This is an automatically generated file.</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineplus">+     It will be read and overwritten.</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineplus">+     DO NOT EDIT! --&gt;</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineplus">+&lt;META HTTP-EQUIV=&quot;Content-Type&quot; CONTENT=&quot;text/html; charset=UTF-8&quot;&gt;</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+&lt;TITLE&gt;Bookmarks&lt;/TITLE&gt;</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+&lt;H1 LAST_MODIFIED=&quot;1177541029&quot;&gt;Bookmarks&lt;/H1&gt;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+&lt;DL&gt;&lt;p&gt;</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+    &lt;DT&gt;&lt;H3 UNFILED_BOOKMARKS_FOLDER=&quot;true&quot;&gt;Unsorted Bookmarks&lt;/H3&gt;</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+    &lt;DL&gt;&lt;p&gt;</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://example.tld&quot;&gt;Example.tld&lt;/A&gt;</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+    &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+    &lt;DT&gt;&lt;H3 LAST_MODIFIED=&quot;1177541040&quot; PERSONAL_TOOLBAR_FOLDER=&quot;true&quot; ID=&quot;NC:PersonalToolbarFolder&quot;&gt;Bookmarks Toolbar Folder&lt;/H3&gt;</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+&lt;DD&gt;Add bookmarks to this folder to see them displayed on the Bookmarks Toolbar</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+    &lt;DL&gt;&lt;p&gt;</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://www.seamonkey-project.org/&quot; LAST_VISIT=&quot;1274050000&quot; LAST_CHARSET=&quot;UTF-8&quot; ICON=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH1QwCEiUG/+wAegAAAu5JREFUOMtlk01oXFUUx3/3vfte3kydmeeQJgUTMsEaKX40tREbDHYE6UIXnZVUujCIiu3GKl0EXRh3ol1EF8WutItuuum4sRTRRXFRFGUyRPxIyVe1mK+ZZD46d968e6+LSduoFw7/c+D+Dv8D5wj+984NDQ4mz6TT/iiAMWCMRanO1urqnaJSZy/u/i12F2H46Qe5XGo6DAOMscSxQWuL1t08imI2NlRpba05CVOz/2qQSJx7+/DhfTPAPUhrQxwbJl54mHemJnCkg20pxh67sFStqlGY2pZd/OOjIyPZmTi+D91t0N+/h/enn2NuFW78aXm6dRvfd3NBIItK8bwEGB5Oz3iei1IxWpt7lrW2vPjKKKoDv65bMr5m4kiOvr4kjUaUh0+OO/DRwSBwR5WKabc1Smnu5zGFwgjfLsIv69CKDL+vG44dGyaKNK5rJ+XAQCqfTifY3Gzumrurp04dom0dlrag3gZtBc2OIZPpIZVK0tubycuxsSfD44VnsQaMBbsTxsDBIx3O/2hRsSAbWFwBf21b8vmn6N83zvz8SijL5YhGo47rguOC0YZsVjI+nuAP7RNpCANLpREzkBYMZly+vhxRLivq9Ri5vLxdqlQaaA1as2MfTp7u4fqGS0dbDvVp6hlBJrD0bFkuXarheaBUpSS1Xii1WvsxJovWXfufnX+QK5uSB3xN0tGkfIdHeyFahddfqxIEAs+DZvPv0s4iXf1CiCcmoQvf2Bvw8oEYAazUBM/sFfz8XZsLnzdRyiKlwJg15uau5XYWafYMpAvvvvd4OD+U4PRDMeYO3F7QbP7W4c1ii1YLPA+CQCBExK1b5Wk4uywArLVDxZ+aX6qeZD5ZiXjrRAXP69qUsqueJ5ASoqjC4uIP07Xaqx8CONbaK9+v2KUDuT3sV2uFky99U3TdJkEgCAJBItFVKSNqtYWlmzevT96FAYS19iiwJYSY3X3S2ewjBd8PQinBcaBaXSnV62989d/j/wcgGYelT45hgQAAAABJRU5ErkJggg==&quot; ID=&quot;rdf:#$q2rCs3&quot;&gt;SeaMonkey&lt;/A&gt;</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://www.mozilla.org/&quot; LAST_VISIT=&quot;1274050586&quot; LAST_CHARSET=&quot;UTF-8&quot; ID=&quot;rdf:#$r2rCs3&quot;&gt;mozilla.org&lt;/A&gt;</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://www.mozillazine.org/&quot; ID=&quot;rdf:#$s2rCs3&quot;&gt;mozillaZine&lt;/A&gt;</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://en-US.fxfeeds.mozilla.com/en-US/firefox/livebookmarks/&quot; LAST_MODIFIED=&quot;1177541035&quot; FEEDURL=&quot;http://en-US.fxfeeds.mozilla.com/en-US/firefox/headlines.xml&quot; ID=&quot;rdf:#$HvPhC3&quot;&gt;Latest Headlines&lt;/A&gt;</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+&lt;DD&gt;Livemark test comment</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+    &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+    &lt;DT&gt;&lt;H3 ID=&quot;rdf:#$u2rCs3&quot;&gt;SeaMonkey and Mozilla&lt;/H3&gt;</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+    &lt;DL&gt;&lt;p&gt;</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://www.seamonkey-project.org/&quot; LAST_VISIT=&quot;1274050000&quot; LAST_CHARSET=&quot;UTF-8&quot; ID=&quot;rdf:#$v2rCs3&quot;&gt;The SeaMonkey Project&lt;/A&gt;</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+        &lt;DT&gt;&lt;H3 ID=&quot;rdf:#$w2rCs3&quot;&gt;mozilla.org&lt;/H3&gt;</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+        &lt;DL&gt;&lt;p&gt;</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.mozilla.org/&quot; LAST_VISIT=&quot;1274050586&quot; LAST_CHARSET=&quot;UTF-8&quot; ID=&quot;rdf:#$x2rCs3&quot;&gt;The Mozilla Organization&lt;/A&gt;</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.mozilla.org/projects/&quot; ID=&quot;rdf:#$y2rCs3&quot;&gt;Mozilla Projects&lt;/A&gt;</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.mozilla.org/about/&quot; ID=&quot;rdf:#$z2rCs3&quot;&gt;About Mozilla&lt;/A&gt;</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+        &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+        &lt;DT&gt;&lt;H3 ID=&quot;rdf:#$A2rCs3&quot;&gt;Extending SeaMonkey&lt;/H3&gt;</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+        &lt;DL&gt;&lt;p&gt;</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;https://addons.mozilla.org/en-US/seamonkey/&quot; ID=&quot;rdf:#$B2rCs3&quot;&gt;SeaMonkey Add-ons&lt;/A&gt;</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;https://addons.mozilla.org/en-US/seamonkey/themes&quot; ID=&quot;rdf:#$C2rCs3&quot;&gt;SeaMonkey Themes&lt;/A&gt;</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;https://addons.mozilla.org/en-US/seamonkey/dictionaries&quot; ID=&quot;rdf:#$D2rCs3&quot;&gt;Spell Checking Dictionaries&lt;/A&gt;</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;https://addons.mozilla.org/en-US/seamonkey/plugins&quot; ID=&quot;rdf:#$E2rCs3&quot;&gt;Plugins for SeaMonkey&lt;/A&gt;</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.mozdev.org/&quot; ID=&quot;rdf:#$F2rCs3&quot;&gt;mozdev.org&lt;/A&gt;</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.mozdev.org/projects/applications/SeaMonkey.html&quot; ID=&quot;rdf:#$G2rCs3&quot;&gt;SeaMonkey Extensions from mozdev.org&lt;/A&gt;</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+        &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+        &lt;DT&gt;&lt;H3 ID=&quot;rdf:#$H2rCs3&quot;&gt;Community &amp;amp; Support&lt;/H3&gt;</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+        &lt;DL&gt;&lt;p&gt;</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.seamonkey-project.org/community&quot; ID=&quot;rdf:#$I2rCs3&quot;&gt;SeaMonkey Community&lt;/A&gt;</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://www.mozillazine.org/&quot; ID=&quot;rdf:#$J2rCs3&quot;&gt;mozillaZine&lt;/A&gt;</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+            &lt;DT&gt;&lt;A HREF=&quot;http://forums.mozillazine.org/viewforum.php?f=40&quot; ID=&quot;rdf:#$K2rCs3&quot;&gt;SeaMonkey Support Forum (mozillaZine)&lt;/A&gt;</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+        &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+    &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+    &lt;DT&gt;&lt;H3 ID=&quot;rdf:#$L2rCs3&quot;&gt;Search the Web&lt;/H3&gt;</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+    &lt;DL&gt;&lt;p&gt;</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://www.google.com/&quot; ID=&quot;rdf:#$M2rCs3&quot;&gt;Google&lt;/A&gt;</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://groups.google.com/&quot; ID=&quot;rdf:#$N2rCs3&quot;&gt;Google Groups&lt;/A&gt;</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://news.google.com/&quot; ID=&quot;rdf:#$O2rCs3&quot;&gt;Google News&lt;/A&gt;</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+    &lt;/DL&gt;&lt;p&gt;</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+    &lt;HR&gt;</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+    &lt;DT&gt;&lt;H3 ADD_DATE=&quot;1177541020&quot; LAST_MODIFIED=&quot;1177541050&quot; ID=&quot;rdf:#$74Gpx2&quot;&gt;test&lt;/H3&gt;</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+&lt;DD&gt;folder test comment</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+    &lt;DL&gt;&lt;p&gt;</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://test/post&quot; ADD_DATE=&quot;1177375336&quot; LAST_MODIFIED=&quot;1177375423&quot; SHORTCUTURL=&quot;test&quot; WEB_PANEL=&quot;true&quot; POST_DATA=&quot;hidden1%3Dbar&amp;amp;text1%3D%25s&quot; LAST_CHARSET=&quot;ISO-8859-1&quot; ID=&quot;rdf:#$pYFe7&quot;&gt;test post keyword&lt;/A&gt;</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineplus">+&lt;DD&gt;item description</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineplus">+&lt;!-- XXX Bug 380468</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineplus">+        &lt;DT&gt;&lt;A HREF=&quot;http://test/micsum&quot; ADD_DATE=&quot;1177375377&quot; LAST_MODIFIED=&quot;1177541023&quot; LAST_CHARSET=&quot;ISO-8859-1&quot; MICSUM_GEN_URI=&quot;urn:source:http://dietrich.ganx4.com/mozilla/test-microsummary.xml&quot; MICSUM_EXPIRATION=&quot;1177542823620&quot; GENERATED_TITLE=&quot;id:462fd9a2e5b66&quot; ID=&quot;rdf:#$qYFe7&quot;&gt;test microsummary&lt;/A&gt;</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineplus">+&lt;DD&gt;test microsummary</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+--&gt;</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineplus">+    &lt;/DL&gt;</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineplus">+&lt;/DL&gt;&lt;p&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">new file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..b234246cac90b17d43d3955156d94276b7e3b503</span>
<a href="#l29.3"></a><span id="l29.3">GIT binary patch
literal 32772
zc%1Fm+i%)d90zdYq?C4JZF&lt;Y@J1&lt;k0312Y85TvRl#fh?#EMtz=R*|X``v8_Ow(Nr-
z+g_qc`$x97N&amp;92^x~D!(+CQ+@{RlX1wkfTmX;Q22NBKg|g&gt;x}F2EP8P9Z12tQ4(^=
zDx7m=QOV_$dyFXxvy_=d$|scK{QpdjQczw&amp;aXyN=_bR&gt;N4Uqd~`S$JHk5?o=7&gt;F?X
z_K6&gt;jhl7aw&gt;8XNxzvDDrhq=x5w!=;}vCjgZZSA&lt;urqf}&amp;ovrO==Mj70JSwpv4+V3b
zhi-|b(J1k&lt;g5*h0$gG7*(haERe2fwkL;rLI^^q?W6VVk(B9i$CVkiT7xYf!=7h$~1
zWq)4uMoF@MC`Ed*#+@%+wzJo6vzD{b+-tkcEU}PJUeZY`Q!iSTdl+Z?i02FOn{hk{
zJT8N1_&gt;U&amp;&lt;xc02M`A9|`k&amp;d44_+PrMOwXp8`(9C3=mE~*k8{8B==1!Nvf|y%=P#wj
zqN)~)g#w*{U@+iX+1BG&gt;uP&lt;esHVorn)H|-$=goSQ^o-M8yTL$EPh+F;w+3bL-qY`X
zd;0kJ`PmXXbIi0Kjh|49?)8GZfq$oJ+SRqH+EQCTxEF3HTSsA&lt;&amp;*zSokBZ*H!kz6x
z;hSJcM&gt;c)9t36m&gt;vrN0bs!i&amp;)=Ire0Vj`w&lt;(Nx)?*2BO{qBQDC-HXDLYQr`v1~+W_
z0IJn}Pb+unp~^)?&lt;NkrInO3d4+U@#fuWT7-&amp;zD^Ur(v|R8_7#vLYIaA^k@0^&gt;GRK&lt;
zSAV@YU-Ni8)~72S^F+j4di~=ir-BYX-4={VJf01!jp9_qrmba7dS8ZvPc5rftyF5f
z&gt;iO2%s%MuQb+b~VYNK2+t$Nio-2SM&lt;EQ@_H8Zyf?ZD!URW~E`)+2*$EH1&lt;z6uz&amp;Uj
zu0N~OAAf$YFd|P1siiUzJiOo7-%X-k!b7$}7bo4{p1s&gt;tqI*d+`40~Q0KA?)rhG)X
zLb*&lt;PoAQn_`|5s;@)qSX&lt;pSjr&lt;*G9K?thVTgL0E{i?U34m+~IveaZ)v4=GC&amp;rp$gv
zOy|l|7AWffur~kz00000000000000000000000000000000000000000000000000
W000000000000000004k&lt;yZje$IAS{h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">new file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- /dev/null</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ b/suite/common/places/tests/unit/distribution.ini</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -0,0 +1,21 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineplus">+# Distribution Configuration File</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineplus">+# Bug 516444 demo</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineplus">+</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineplus">+[Global]</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineplus">+id=516444</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineplus">+version=1.0</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineplus">+about=Test distribution file</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+[BookmarksToolbar]</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+item.1.title=Toolbar Link Before</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+item.1.link=http://mozilla.com/</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+item.2.type=default</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+item.3.title=Toolbar Link After</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+item.3.link=http://mozilla.com/</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+[BookmarksMenu]</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+item.1.title=Menu Link Before</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+item.1.link=http://mozilla.com/</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+item.2.type=default</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+item.3.title=Menu Link After</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+item.3.link=http://mozilla.com/</span>
<a href="#l30.26"></a><span id="l30.26">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">new file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineminus">--- /dev/null</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineplus">+++ b/suite/common/places/tests/unit/head_bookmarks.js</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineat">@@ -0,0 +1,111 @@</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l31.7"></a><span id="l31.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l31.8"></a><span id="l31.8" class="difflineplus">+ *</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+ *</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+ * License.</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineplus">+ *</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+ * The Original Code is Places.</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+ *</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+ * Google Inc.</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+ *</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+ *  Brian Ryner &lt;bryner@brianryner.com&gt;</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+ *  Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+ *</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineplus">+ *</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineplus">+</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+// Import common head.</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+let (commonFile = do_get_file(&quot;../../test_places/head_common.js&quot;, false)) {</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+  let uri = Services.io.newFileURI(commonFile);</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineplus">+  Services.scriptloader.loadSubScript(uri.spec, this);</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineplus">+}</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineplus">+</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineplus">+// Put any other stuff relative to this test folder below.</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineplus">+</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineplus">+</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;PlacesUIUtils&quot;, function() {</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineplus">+  Cu.import(&quot;resource:///modules/PlacesUIUtils.jsm&quot;);</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineplus">+  return PlacesUIUtils;</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineplus">+});</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineplus">+</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineplus">+const ORGANIZER_FOLDER_ANNO = &quot;PlacesOrganizer/OrganizerFolder&quot;;</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineplus">+const ORGANIZER_QUERY_ANNO = &quot;PlacesOrganizer/OrganizerQuery&quot;;</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineplus">+</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+// Needed by some test that relies on having an app  registered.</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineplus">+let (XULAppInfo = {</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+  vendor: &quot;Mozilla&quot;,</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineplus">+  name: &quot;PlacesTest&quot;,</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+  ID: &quot;{230de50e-4cd1-11dc-8314-0800200c9a66}&quot;,</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineplus">+  version: &quot;1&quot;,</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+  appBuildID: &quot;2007010101&quot;,</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineplus">+  platformVersion: &quot;&quot;,</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineplus">+  platformBuildID: &quot;2007010101&quot;,</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineplus">+  inSafeMode: false,</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineplus">+  logConsoleErrors: true,</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineplus">+  OS: &quot;XPCShell&quot;,</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineplus">+  XPCOMABI: &quot;noarch-spidermonkey&quot;,</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineplus">+</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineplus">+    Ci.nsIXULAppInfo,</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineplus">+    Ci.nsIXULRuntime,</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineplus">+  ])</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineplus">+}) {</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+  let XULAppInfoFactory = {</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineplus">+    createInstance: function (outer, iid) {</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineplus">+      if (outer != null)</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineplus">+        throw Cr.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineplus">+      return XULAppInfo.QueryInterface(iid);</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineplus">+    }</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineplus">+  };</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineplus">+  let registrar = Components.manager.QueryInterface(Ci.nsIComponentRegistrar);</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineplus">+  registrar.registerFactory(Components.ID(&quot;{fbfae60b-64a4-44ef-a911-08ceb70b9f31}&quot;),</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineplus">+                            &quot;XULAppInfo&quot;, &quot;@mozilla.org/xre/app-info;1&quot;,</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineplus">+                            XULAppInfoFactory);</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineplus">+}</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineplus">+</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineplus">+</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineplus">+const FILENAME_BOOKMARKS_HTML = &quot;bookmarks.html&quot;;</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineplus">+let (backup_date = new Date().toLocaleFormat(&quot;%Y-%m-%d&quot;)) {</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineplus">+  const FILENAME_BOOKMARKS_JSON = &quot;bookmarks-&quot; + backup_date + &quot;.json&quot;;</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineplus">+}</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineplus">+</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineplus">+// Smart bookmarks constants.</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineplus">+const SMART_BOOKMARKS_VERSION = 2;</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineplus">+const SMART_BOOKMARKS_ON_TOOLBAR = 1;</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineplus">+const SMART_BOOKMARKS_ON_MENU = 3; // Takes in count the additional separator.</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineplus">+</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineplus">+// Default bookmarks constants.</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineplus">+const DEFAULT_BOOKMARKS_ON_TOOLBAR = 4;</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineplus">+const DEFAULT_BOOKMARKS_ON_MENU = 3; // Takes in count the additional separator.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">new file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- /dev/null</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_384370.js</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -0,0 +1,317 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineplus">+ *</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+ *</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+ * License.</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+ *</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+ * The Original Code is Bug 384370 code.</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+ *</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+ *</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+ *  Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+ *</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineplus">+ *</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineplus">+</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineplus">+// The following components need to be initialized to perform tests without</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+// asserting in debug builds (Bug 448804).</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineplus">+Cc[&quot;@mozilla.org/browser/livemark-service;2&quot;].getService(Ci.nsILivemarkService);</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+Cc[&quot;@mozilla.org/feed-processor;1&quot;].createInstance(Ci.nsIFeedProcessor);</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+const LOAD_IN_SIDEBAR_ANNO = &quot;bookmarkProperties/loadInSidebar&quot;;</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+const DESCRIPTION_ANNO = &quot;bookmarkProperties/description&quot;;</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+const POST_DATA_ANNO = &quot;bookmarkProperties/POSTData&quot;;</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+do_check_eq(typeof PlacesUtils, &quot;object&quot;);</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+// main</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+function run_test() {</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineplus">+  /*</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineplus">+    HTML+FEATURES SUMMARY:</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+    - import legacy bookmarks</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+    - export as json, import, test (tests integrity of html &gt; json)</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+    - export as html, import, test (tests integrity of json &gt; html)</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineplus">+</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineplus">+    BACKUP/RESTORE SUMMARY:</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineplus">+    - create a bookmark in each root</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineplus">+    - tag multiple URIs with multiple tags</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+    - export as json, import, test</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineplus">+  */</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineplus">+</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+  // get places import/export service</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+  var importer = Cc[&quot;@mozilla.org/browser/places/import-export-service;1&quot;].getService(Ci.nsIPlacesImportExportService);</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineplus">+</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+  // avoid creating the places smart folder during tests</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+  Cc[&quot;@mozilla.org/preferences-service;1&quot;].getService(Ci.nsIPrefBranch).</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+  setIntPref(&quot;browser.places.smartBookmarksVersion&quot;, -1);</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+  // file pointer to legacy bookmarks file</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+  //var bookmarksFileOld = do_get_file(&quot;bookmarks.large.html&quot;);</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+  var bookmarksFileOld = do_get_file(&quot;bookmarks.preplaces.html&quot;);</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+  // file pointer to a new places-exported json file</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+  var jsonFile = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsILocalFile);</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineplus">+  jsonFile.append(&quot;bookmarks.exported.json&quot;);</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineplus">+</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineplus">+  // create bookmarks.exported.json</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineplus">+  if (jsonFile.exists())</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineplus">+    jsonFile.remove(false);</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineplus">+  jsonFile.create(Ci.nsILocalFile.NORMAL_FILE_TYPE, 0600);</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineplus">+  if (!jsonFile.exists())</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineplus">+    do_throw(&quot;couldn't create file: bookmarks.exported.json&quot;);</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineplus">+</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineplus">+  // Test importing a pre-Places canonical bookmarks file.</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineplus">+  // 1. import bookmarks.preplaces.html</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineplus">+  // 2. run the test-suite</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineplus">+  // Note: we do not empty the db before this import to catch bugs like 380999</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineplus">+  try {</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineplus">+    importer.importHTMLFromFile(bookmarksFileOld, true);</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import legacy bookmarks file: &quot; + ex); }</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineplus">+  populate();</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineplus">+  validate();</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineplus">+</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineplus">+  // Test exporting a Places canonical json file.</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineplus">+  // 1. export to bookmarks.exported.json</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineplus">+  // 2. empty bookmarks db</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineplus">+  // 3. import bookmarks.exported.json</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineplus">+  // 4. run the test-suite</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineplus">+  try {</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineplus">+    PlacesUtils.backups.saveBookmarksToJSONFile(jsonFile);</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineplus">+  LOG(&quot;exported json&quot;); </span>
<a href="#l32.108"></a><span id="l32.108" class="difflineplus">+  try {</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineplus">+    PlacesUtils.restoreBookmarksFromJSONFile(jsonFile);</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineplus">+  LOG(&quot;imported json&quot;); </span>
<a href="#l32.112"></a><span id="l32.112" class="difflineplus">+  validate();</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineplus">+  LOG(&quot;validated import&quot;); </span>
<a href="#l32.114"></a><span id="l32.114" class="difflineplus">+}</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineplus">+</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineplus">+var tagData = [</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineplus">+  { uri: uri(&quot;http://slint.us&quot;), tags: [&quot;indie&quot;, &quot;kentucky&quot;, &quot;music&quot;] },</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineplus">+  { uri: uri(&quot;http://en.wikipedia.org/wiki/Diplodocus&quot;), tags: [&quot;dinosaur&quot;, &quot;dj&quot;, &quot;rad word&quot;] }</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineplus">+];</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineplus">+</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineplus">+var bookmarkData = [</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineplus">+  { uri: uri(&quot;http://slint.us&quot;), title: &quot;indie, kentucky, music&quot; },</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineplus">+  { uri: uri(&quot;http://en.wikipedia.org/wiki/Diplodocus&quot;), title: &quot;dinosaur, dj, rad word&quot; }</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineplus">+];</span>
<a href="#l32.125"></a><span id="l32.125" class="difflineplus">+</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineplus">+/*</span>
<a href="#l32.127"></a><span id="l32.127" class="difflineplus">+populate data in each folder</span>
<a href="#l32.128"></a><span id="l32.128" class="difflineplus">+(menu is populated via the html import)</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineplus">+*/</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineplus">+function populate() {</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineplus">+  // add tags</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineplus">+  for each(let {uri: u, tags: t} in tagData)</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineplus">+    PlacesUtils.tagging.tagURI(u, t);</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineplus">+  </span>
<a href="#l32.135"></a><span id="l32.135" class="difflineplus">+  // add unfiled bookmarks</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineplus">+  for each(let {uri: u, title: t} in bookmarkData) {</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineplus">+    PlacesUtils.bookmarks.insertBookmark(PlacesUtils.bookmarks.unfiledBookmarksFolder,</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineplus">+                                         u, PlacesUtils.bookmarks.DEFAULT_INDEX, t);</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineplus">+  }</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineplus">+</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineplus">+  // add to the toolbar</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineplus">+  for each(let {uri: u, title: t} in bookmarkData) {</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineplus">+    PlacesUtils.bookmarks.insertBookmark(PlacesUtils.bookmarks.toolbarFolder,</span>
<a href="#l32.144"></a><span id="l32.144" class="difflineplus">+                                         u, PlacesUtils.bookmarks.DEFAULT_INDEX, t);</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineplus">+  }</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineplus">+}</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineplus">+</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineplus">+function validate() {</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineplus">+  testCanonicalBookmarks(PlacesUtils.bookmarks.bookmarksMenuFolder);</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+  testToolbarFolder();</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineplus">+  testUnfiledBookmarks();</span>
<a href="#l32.152"></a><span id="l32.152" class="difflineplus">+  testTags();</span>
<a href="#l32.153"></a><span id="l32.153" class="difflineplus">+}</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineplus">+</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineplus">+// Tests a bookmarks datastore that has a set of bookmarks, etc</span>
<a href="#l32.156"></a><span id="l32.156" class="difflineplus">+// that flex each supported field and feature.</span>
<a href="#l32.157"></a><span id="l32.157" class="difflineplus">+function testCanonicalBookmarks() {</span>
<a href="#l32.158"></a><span id="l32.158" class="difflineplus">+  // query to see if the deleted folder and items have been imported</span>
<a href="#l32.159"></a><span id="l32.159" class="difflineplus">+  var query = PlacesUtils.history.getNewQuery();</span>
<a href="#l32.160"></a><span id="l32.160" class="difflineplus">+  query.setFolders([PlacesUtils.bookmarks.bookmarksMenuFolder], 1);</span>
<a href="#l32.161"></a><span id="l32.161" class="difflineplus">+  var result = PlacesUtils.history.executeQuery(query, PlacesUtils.history.getNewQueryOptions());</span>
<a href="#l32.162"></a><span id="l32.162" class="difflineplus">+  var rootNode = result.root;</span>
<a href="#l32.163"></a><span id="l32.163" class="difflineplus">+  rootNode.containerOpen = true;</span>
<a href="#l32.164"></a><span id="l32.164" class="difflineplus">+</span>
<a href="#l32.165"></a><span id="l32.165" class="difflineplus">+  // 6-2: the toolbar contents are imported to the places-toolbar folder,</span>
<a href="#l32.166"></a><span id="l32.166" class="difflineplus">+  // the separator above it is removed.</span>
<a href="#l32.167"></a><span id="l32.167" class="difflineplus">+  do_check_eq(rootNode.childCount, DEFAULT_BOOKMARKS_ON_MENU + 1);</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineplus">+</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineplus">+  // get test folder</span>
<a href="#l32.170"></a><span id="l32.170" class="difflineplus">+  var testFolder = rootNode.getChild(DEFAULT_BOOKMARKS_ON_MENU);</span>
<a href="#l32.171"></a><span id="l32.171" class="difflineplus">+  do_check_eq(testFolder.type, testFolder.RESULT_TYPE_FOLDER);</span>
<a href="#l32.172"></a><span id="l32.172" class="difflineplus">+  do_check_eq(testFolder.title, &quot;test&quot;);</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineplus">+</span>
<a href="#l32.174"></a><span id="l32.174" class="difflineplus">+  /*</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineplus">+  // add date </span>
<a href="#l32.176"></a><span id="l32.176" class="difflineplus">+  do_check_eq(PlacesUtils.bookmarks.getItemDateAdded(testFolder.itemId)/1000000, 1177541020);</span>
<a href="#l32.177"></a><span id="l32.177" class="difflineplus">+  // last modified</span>
<a href="#l32.178"></a><span id="l32.178" class="difflineplus">+  do_check_eq(PlacesUtils.bookmarks.getItemLastModified(testFolder.itemId)/1000000, 1177541050);</span>
<a href="#l32.179"></a><span id="l32.179" class="difflineplus">+  */</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineplus">+</span>
<a href="#l32.181"></a><span id="l32.181" class="difflineplus">+  testFolder = testFolder.QueryInterface(Ci.nsINavHistoryQueryResultNode);</span>
<a href="#l32.182"></a><span id="l32.182" class="difflineplus">+  do_check_eq(testFolder.hasChildren, true);</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineplus">+  // folder description</span>
<a href="#l32.184"></a><span id="l32.184" class="difflineplus">+  do_check_true(PlacesUtils.annotations.itemHasAnnotation(testFolder.itemId,</span>
<a href="#l32.185"></a><span id="l32.185" class="difflineplus">+                                                          DESCRIPTION_ANNO));</span>
<a href="#l32.186"></a><span id="l32.186" class="difflineplus">+  do_check_eq(&quot;folder test comment&quot;,</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineplus">+              PlacesUtils.annotations.getItemAnnotation(testFolder.itemId, DESCRIPTION_ANNO));</span>
<a href="#l32.188"></a><span id="l32.188" class="difflineplus">+  // open test folder, and test the children</span>
<a href="#l32.189"></a><span id="l32.189" class="difflineplus">+  testFolder.containerOpen = true;</span>
<a href="#l32.190"></a><span id="l32.190" class="difflineplus">+  var cc = testFolder.childCount;</span>
<a href="#l32.191"></a><span id="l32.191" class="difflineplus">+  // XXX Bug 380468</span>
<a href="#l32.192"></a><span id="l32.192" class="difflineplus">+  // do_check_eq(cc, 2);</span>
<a href="#l32.193"></a><span id="l32.193" class="difflineplus">+  do_check_eq(cc, 1);</span>
<a href="#l32.194"></a><span id="l32.194" class="difflineplus">+</span>
<a href="#l32.195"></a><span id="l32.195" class="difflineplus">+  // test bookmark 1</span>
<a href="#l32.196"></a><span id="l32.196" class="difflineplus">+  var testBookmark1 = testFolder.getChild(0);</span>
<a href="#l32.197"></a><span id="l32.197" class="difflineplus">+  // url</span>
<a href="#l32.198"></a><span id="l32.198" class="difflineplus">+  do_check_eq(&quot;http://test/post&quot;, testBookmark1.uri);</span>
<a href="#l32.199"></a><span id="l32.199" class="difflineplus">+  // title</span>
<a href="#l32.200"></a><span id="l32.200" class="difflineplus">+  do_check_eq(&quot;test post keyword&quot;, testBookmark1.title);</span>
<a href="#l32.201"></a><span id="l32.201" class="difflineplus">+  // keyword</span>
<a href="#l32.202"></a><span id="l32.202" class="difflineplus">+  do_check_eq(&quot;test&quot;, PlacesUtils.bookmarks.getKeywordForBookmark(testBookmark1.itemId));</span>
<a href="#l32.203"></a><span id="l32.203" class="difflineplus">+  // sidebar</span>
<a href="#l32.204"></a><span id="l32.204" class="difflineplus">+  do_check_true(PlacesUtils.annotations.itemHasAnnotation(testBookmark1.itemId,</span>
<a href="#l32.205"></a><span id="l32.205" class="difflineplus">+                                                          LOAD_IN_SIDEBAR_ANNO));</span>
<a href="#l32.206"></a><span id="l32.206" class="difflineplus">+  /*</span>
<a href="#l32.207"></a><span id="l32.207" class="difflineplus">+  // add date </span>
<a href="#l32.208"></a><span id="l32.208" class="difflineplus">+  do_check_eq(testBookmark1.dateAdded/1000000, 1177375336);</span>
<a href="#l32.209"></a><span id="l32.209" class="difflineplus">+</span>
<a href="#l32.210"></a><span id="l32.210" class="difflineplus">+  // last modified</span>
<a href="#l32.211"></a><span id="l32.211" class="difflineplus">+  do_check_eq(testBookmark1.lastModified/1000000, 1177375423);</span>
<a href="#l32.212"></a><span id="l32.212" class="difflineplus">+  */</span>
<a href="#l32.213"></a><span id="l32.213" class="difflineplus">+</span>
<a href="#l32.214"></a><span id="l32.214" class="difflineplus">+  // post data</span>
<a href="#l32.215"></a><span id="l32.215" class="difflineplus">+  do_check_true(PlacesUtils.annotations.itemHasAnnotation(testBookmark1.itemId, POST_DATA_ANNO));</span>
<a href="#l32.216"></a><span id="l32.216" class="difflineplus">+  do_check_eq(&quot;hidden1%3Dbar&amp;text1%3D%25s&quot;,</span>
<a href="#l32.217"></a><span id="l32.217" class="difflineplus">+              PlacesUtils.annotations.getItemAnnotation(testBookmark1.itemId, POST_DATA_ANNO));</span>
<a href="#l32.218"></a><span id="l32.218" class="difflineplus">+</span>
<a href="#l32.219"></a><span id="l32.219" class="difflineplus">+  // last charset</span>
<a href="#l32.220"></a><span id="l32.220" class="difflineplus">+  var testURI = PlacesUtils._uri(testBookmark1.uri);</span>
<a href="#l32.221"></a><span id="l32.221" class="difflineplus">+  do_check_eq(&quot;ISO-8859-1&quot;, PlacesUtils.history.getCharsetForURI(testURI));</span>
<a href="#l32.222"></a><span id="l32.222" class="difflineplus">+</span>
<a href="#l32.223"></a><span id="l32.223" class="difflineplus">+  // description </span>
<a href="#l32.224"></a><span id="l32.224" class="difflineplus">+  do_check_true(PlacesUtils.annotations.itemHasAnnotation(testBookmark1.itemId,</span>
<a href="#l32.225"></a><span id="l32.225" class="difflineplus">+                                                          DESCRIPTION_ANNO));</span>
<a href="#l32.226"></a><span id="l32.226" class="difflineplus">+  do_check_eq(&quot;item description&quot;,</span>
<a href="#l32.227"></a><span id="l32.227" class="difflineplus">+              PlacesUtils.annotations.getItemAnnotation(testBookmark1.itemId,</span>
<a href="#l32.228"></a><span id="l32.228" class="difflineplus">+                                                        DESCRIPTION_ANNO));</span>
<a href="#l32.229"></a><span id="l32.229" class="difflineplus">+</span>
<a href="#l32.230"></a><span id="l32.230" class="difflineplus">+  /*</span>
<a href="#l32.231"></a><span id="l32.231" class="difflineplus">+  // XXX Bug 380468</span>
<a href="#l32.232"></a><span id="l32.232" class="difflineplus">+  // test bookmark 2</span>
<a href="#l32.233"></a><span id="l32.233" class="difflineplus">+  var testBookmark2 = testFolder.getChild(1);</span>
<a href="#l32.234"></a><span id="l32.234" class="difflineplus">+  // url</span>
<a href="#l32.235"></a><span id="l32.235" class="difflineplus">+  do_check_eq(&quot;http://test/micsum&quot;, testBookmark2.uri);</span>
<a href="#l32.236"></a><span id="l32.236" class="difflineplus">+  // title</span>
<a href="#l32.237"></a><span id="l32.237" class="difflineplus">+  do_check_eq(&quot;test microsummary&quot;, testBookmark2.title);</span>
<a href="#l32.238"></a><span id="l32.238" class="difflineplus">+  // check that it's a microsummary</span>
<a href="#l32.239"></a><span id="l32.239" class="difflineplus">+  var micsum = mssvc.getMicrosummary(testBookmark2.itemId);</span>
<a href="#l32.240"></a><span id="l32.240" class="difflineplus">+  if (!micsum)</span>
<a href="#l32.241"></a><span id="l32.241" class="difflineplus">+    do_throw(&quot;Could not import microsummary&quot;);</span>
<a href="#l32.242"></a><span id="l32.242" class="difflineplus">+  // check generator uri</span>
<a href="#l32.243"></a><span id="l32.243" class="difflineplus">+  var generator = micsum.generator;</span>
<a href="#l32.244"></a><span id="l32.244" class="difflineplus">+  do_check_eq(&quot;urn:source:http://dietrich.ganx4.com/mozilla/test-microsummary.xml&quot;, generator.uri.spec);</span>
<a href="#l32.245"></a><span id="l32.245" class="difflineplus">+  // expiration and generated title can change, so don't test them</span>
<a href="#l32.246"></a><span id="l32.246" class="difflineplus">+  */</span>
<a href="#l32.247"></a><span id="l32.247" class="difflineplus">+</span>
<a href="#l32.248"></a><span id="l32.248" class="difflineplus">+  // clean up</span>
<a href="#l32.249"></a><span id="l32.249" class="difflineplus">+  testFolder.containerOpen = false;</span>
<a href="#l32.250"></a><span id="l32.250" class="difflineplus">+  rootNode.containerOpen = false;</span>
<a href="#l32.251"></a><span id="l32.251" class="difflineplus">+}</span>
<a href="#l32.252"></a><span id="l32.252" class="difflineplus">+</span>
<a href="#l32.253"></a><span id="l32.253" class="difflineplus">+function testToolbarFolder() {</span>
<a href="#l32.254"></a><span id="l32.254" class="difflineplus">+  var query = PlacesUtils.history.getNewQuery();</span>
<a href="#l32.255"></a><span id="l32.255" class="difflineplus">+  query.setFolders([PlacesUtils.bookmarks.toolbarFolder], 1);</span>
<a href="#l32.256"></a><span id="l32.256" class="difflineplus">+  var result = PlacesUtils.history.executeQuery(query, PlacesUtils.history.getNewQueryOptions());</span>
<a href="#l32.257"></a><span id="l32.257" class="difflineplus">+</span>
<a href="#l32.258"></a><span id="l32.258" class="difflineplus">+  var toolbar = result.root;</span>
<a href="#l32.259"></a><span id="l32.259" class="difflineplus">+  toolbar.containerOpen = true;</span>
<a href="#l32.260"></a><span id="l32.260" class="difflineplus">+</span>
<a href="#l32.261"></a><span id="l32.261" class="difflineplus">+  // child count (adding pre-existing items)</span>
<a href="#l32.262"></a><span id="l32.262" class="difflineplus">+  do_check_eq(toolbar.childCount, bookmarkData.length + DEFAULT_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l32.263"></a><span id="l32.263" class="difflineplus">+</span>
<a href="#l32.264"></a><span id="l32.264" class="difflineplus">+  // livemark</span>
<a href="#l32.265"></a><span id="l32.265" class="difflineplus">+  var livemark = toolbar.getChild(DEFAULT_BOOKMARKS_ON_TOOLBAR - 1);</span>
<a href="#l32.266"></a><span id="l32.266" class="difflineplus">+  // title</span>
<a href="#l32.267"></a><span id="l32.267" class="difflineplus">+  do_check_eq(&quot;Latest Headlines&quot;, livemark.title);</span>
<a href="#l32.268"></a><span id="l32.268" class="difflineplus">+  // livemark check</span>
<a href="#l32.269"></a><span id="l32.269" class="difflineplus">+  do_check_true(PlacesUtils.livemarks.isLivemark(livemark.itemId));</span>
<a href="#l32.270"></a><span id="l32.270" class="difflineplus">+  // site url</span>
<a href="#l32.271"></a><span id="l32.271" class="difflineplus">+  do_check_eq(&quot;http://en-us.fxfeeds.mozilla.com/en-US/firefox/livebookmarks/&quot;,</span>
<a href="#l32.272"></a><span id="l32.272" class="difflineplus">+              PlacesUtils.livemarks.getSiteURI(livemark.itemId).spec);</span>
<a href="#l32.273"></a><span id="l32.273" class="difflineplus">+  // feed url</span>
<a href="#l32.274"></a><span id="l32.274" class="difflineplus">+  do_check_eq(&quot;http://en-us.fxfeeds.mozilla.com/en-US/firefox/headlines.xml&quot;,</span>
<a href="#l32.275"></a><span id="l32.275" class="difflineplus">+              PlacesUtils.livemarks.getFeedURI(livemark.itemId).spec);</span>
<a href="#l32.276"></a><span id="l32.276" class="difflineplus">+</span>
<a href="#l32.277"></a><span id="l32.277" class="difflineplus">+  // test added bookmark data</span>
<a href="#l32.278"></a><span id="l32.278" class="difflineplus">+  var child = toolbar.getChild(DEFAULT_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l32.279"></a><span id="l32.279" class="difflineplus">+  do_check_eq(child.uri, bookmarkData[0].uri.spec);</span>
<a href="#l32.280"></a><span id="l32.280" class="difflineplus">+  do_check_eq(child.title, bookmarkData[0].title);</span>
<a href="#l32.281"></a><span id="l32.281" class="difflineplus">+  child = toolbar.getChild(DEFAULT_BOOKMARKS_ON_TOOLBAR + 1);</span>
<a href="#l32.282"></a><span id="l32.282" class="difflineplus">+  do_check_eq(child.uri, bookmarkData[1].uri.spec);</span>
<a href="#l32.283"></a><span id="l32.283" class="difflineplus">+  do_check_eq(child.title, bookmarkData[1].title);</span>
<a href="#l32.284"></a><span id="l32.284" class="difflineplus">+</span>
<a href="#l32.285"></a><span id="l32.285" class="difflineplus">+  toolbar.containerOpen = false;</span>
<a href="#l32.286"></a><span id="l32.286" class="difflineplus">+}</span>
<a href="#l32.287"></a><span id="l32.287" class="difflineplus">+</span>
<a href="#l32.288"></a><span id="l32.288" class="difflineplus">+function testUnfiledBookmarks() {</span>
<a href="#l32.289"></a><span id="l32.289" class="difflineplus">+  var query = PlacesUtils.history.getNewQuery();</span>
<a href="#l32.290"></a><span id="l32.290" class="difflineplus">+  query.setFolders([PlacesUtils.bookmarks.unfiledBookmarksFolder], 1);</span>
<a href="#l32.291"></a><span id="l32.291" class="difflineplus">+  var result = PlacesUtils.history.executeQuery(query, PlacesUtils.history.getNewQueryOptions());</span>
<a href="#l32.292"></a><span id="l32.292" class="difflineplus">+  var rootNode = result.root;</span>
<a href="#l32.293"></a><span id="l32.293" class="difflineplus">+  rootNode.containerOpen = true;</span>
<a href="#l32.294"></a><span id="l32.294" class="difflineplus">+  // child count (add 1 for pre-existing item)</span>
<a href="#l32.295"></a><span id="l32.295" class="difflineplus">+  do_check_eq(rootNode.childCount, bookmarkData.length + 1);</span>
<a href="#l32.296"></a><span id="l32.296" class="difflineplus">+  for (var i = 1; i &lt; rootNode.childCount; i++) {</span>
<a href="#l32.297"></a><span id="l32.297" class="difflineplus">+    var child = rootNode.getChild(i);</span>
<a href="#l32.298"></a><span id="l32.298" class="difflineplus">+    dump(bookmarkData[i - 1].uri.spec + &quot; == &quot; + child.uri + &quot;?\n&quot;);</span>
<a href="#l32.299"></a><span id="l32.299" class="difflineplus">+    do_check_true(bookmarkData[i - 1].uri.equals(uri(child.uri)));</span>
<a href="#l32.300"></a><span id="l32.300" class="difflineplus">+    do_check_eq(child.title, bookmarkData[i - 1].title);</span>
<a href="#l32.301"></a><span id="l32.301" class="difflineplus">+    /* WTF</span>
<a href="#l32.302"></a><span id="l32.302" class="difflineplus">+    if (child.tags)</span>
<a href="#l32.303"></a><span id="l32.303" class="difflineplus">+      do_check_eq(child.tags, bookmarkData[i].title);</span>
<a href="#l32.304"></a><span id="l32.304" class="difflineplus">+    */</span>
<a href="#l32.305"></a><span id="l32.305" class="difflineplus">+  }</span>
<a href="#l32.306"></a><span id="l32.306" class="difflineplus">+  rootNode.containerOpen = false;</span>
<a href="#l32.307"></a><span id="l32.307" class="difflineplus">+}</span>
<a href="#l32.308"></a><span id="l32.308" class="difflineplus">+</span>
<a href="#l32.309"></a><span id="l32.309" class="difflineplus">+function testTags() {</span>
<a href="#l32.310"></a><span id="l32.310" class="difflineplus">+  for each(let {uri: u, tags: t} in tagData) {</span>
<a href="#l32.311"></a><span id="l32.311" class="difflineplus">+    var i = 0;</span>
<a href="#l32.312"></a><span id="l32.312" class="difflineplus">+    dump(&quot;test tags for &quot; + u.spec + &quot;: &quot; + t + &quot;\n&quot;);</span>
<a href="#l32.313"></a><span id="l32.313" class="difflineplus">+    var tt = PlacesUtils.tagging.getTagsForURI(u);</span>
<a href="#l32.314"></a><span id="l32.314" class="difflineplus">+    dump(&quot;true tags for &quot; + u.spec + &quot;: &quot; + tt + &quot;\n&quot;);</span>
<a href="#l32.315"></a><span id="l32.315" class="difflineplus">+    do_check_true(t.every(function(el) {</span>
<a href="#l32.316"></a><span id="l32.316" class="difflineplus">+      i++;</span>
<a href="#l32.317"></a><span id="l32.317" class="difflineplus">+      return tt.indexOf(el) &gt; -1;</span>
<a href="#l32.318"></a><span id="l32.318" class="difflineplus">+    }));</span>
<a href="#l32.319"></a><span id="l32.319" class="difflineplus">+    do_check_eq(i, t.length);</span>
<a href="#l32.320"></a><span id="l32.320" class="difflineplus">+  }</span>
<a href="#l32.321"></a><span id="l32.321" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">new file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- /dev/null</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_398914.js</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -0,0 +1,182 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineplus">+ *</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+ *</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+ * License.</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+ *</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+ * The Original Code is mozilla.com code.</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+ *</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+ *</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+ *  Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+ *</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+ *</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+const bmsvc = PlacesUtils.bookmarks;</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+const testFolderId = PlacesUtils.bookmarksMenuFolderId;</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+// main</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+function run_test() {</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+  var testURI = uri(&quot;http://foo.com&quot;);</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+  /*</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+  1. Create a bookmark for a URI, with a keyword and post data.</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+  2. Create a bookmark for the same URI, with a different keyword and different post data.</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+  3. Confirm that our method for getting a URI+postdata retains bookmark affinity.</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineplus">+  */</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+  var bm1 = bmsvc.insertBookmark(testFolderId, testURI, -1, &quot;blah&quot;);</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+  bmsvc.setKeywordForBookmark(bm1, &quot;foo&quot;);</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+  PlacesUtils.setPostDataForBookmark(bm1, &quot;pdata1&quot;);</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+  var bm2 = bmsvc.insertBookmark(testFolderId, testURI, -1, &quot;blah&quot;);</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+  bmsvc.setKeywordForBookmark(bm2, &quot;bar&quot;);</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+  PlacesUtils.setPostDataForBookmark(bm2, &quot;pdata2&quot;);</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+  // check kw, pd for bookmark 1</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+  var url, postdata;</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+  [url, postdata] = PlacesUtils.getURLAndPostDataForKeyword(&quot;foo&quot;);</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+  do_check_eq(testURI.spec, url);</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+  do_check_eq(postdata, &quot;pdata1&quot;);</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineplus">+</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+  // check kw, pd for bookmark 2</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+  [url, postdata] = PlacesUtils.getURLAndPostDataForKeyword(&quot;bar&quot;);</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+  do_check_eq(testURI.spec, url);</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+  do_check_eq(postdata, &quot;pdata2&quot;);</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+  // cleanup</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+  bmsvc.removeItem(bm1);</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+  bmsvc.removeItem(bm2);</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+  /*</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+  1. Create two bookmarks with the same URI and keyword.</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+  2. Confirm that the most recently created one is returned for that keyword.</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+  */</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+  var bm1 = bmsvc.insertBookmark(testFolderId, testURI, -1, &quot;blah&quot;);</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+  bmsvc.setKeywordForBookmark(bm1, &quot;foo&quot;);</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+  PlacesUtils.setPostDataForBookmark(bm1, &quot;pdata1&quot;);</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+  var bm2 = bmsvc.insertBookmark(testFolderId, testURI, -1, &quot;blah&quot;);</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+  bmsvc.setKeywordForBookmark(bm2, &quot;foo&quot;);</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+  PlacesUtils.setPostDataForBookmark(bm2, &quot;pdata2&quot;);</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+  var bm1da = bmsvc.getItemDateAdded(bm1);</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+  var bm1lm = bmsvc.getItemLastModified(bm1);</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+  LOG(&quot;bm1 dateAdded: &quot; + bm1da + &quot;, lastModified: &quot; + bm1lm);</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+  var bm2da = bmsvc.getItemDateAdded(bm2);</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineplus">+  var bm2lm = bmsvc.getItemLastModified(bm2);</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineplus">+  LOG(&quot;bm2 dateAdded: &quot; + bm2da + &quot;, lastModified: &quot; + bm2lm);</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+  do_check_true(bm1da &lt;= bm2da);</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineplus">+  do_check_true(bm1lm &lt;= bm2lm);</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineplus">+</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+  [url, postdata] = PlacesUtils.getURLAndPostDataForKeyword(&quot;foo&quot;);</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+  do_check_eq(testURI.spec, url);</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+  do_check_eq(postdata, &quot;pdata2&quot;);</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+  // cleanup</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+  bmsvc.removeItem(bm1);</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+  bmsvc.removeItem(bm2);</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineplus">+</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineplus">+  /*</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineplus">+  1. Create two bookmarks with the same URI and keyword.</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+  2. Modify the first-created bookmark.</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineplus">+  3. Confirm that the most recently modified one is returned for that keyword.</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineplus">+  */</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineplus">+  var bm1 = bmsvc.insertBookmark(testFolderId, testURI, -1, &quot;blah&quot;);</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineplus">+  bmsvc.setKeywordForBookmark(bm1, &quot;foo&quot;);</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineplus">+  PlacesUtils.setPostDataForBookmark(bm1, &quot;pdata1&quot;);</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineplus">+  var bm2 = bmsvc.insertBookmark(testFolderId, testURI, -1, &quot;blah&quot;);</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineplus">+  bmsvc.setKeywordForBookmark(bm2, &quot;foo&quot;);</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineplus">+  PlacesUtils.setPostDataForBookmark(bm2, &quot;pdata2&quot;);</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineplus">+</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineplus">+  // modify the older bookmark</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineplus">+  bmsvc.setItemTitle(bm1, &quot;change&quot;);</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineplus">+</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineplus">+  var bm1da = bmsvc.getItemDateAdded(bm1);</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineplus">+  var bm1lm = bmsvc.getItemLastModified(bm1);</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineplus">+  LOG(&quot;bm1 dateAdded: &quot; + bm1da + &quot;, lastModified: &quot; + bm1lm);</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineplus">+  var bm2da = bmsvc.getItemDateAdded(bm2);</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineplus">+  var bm2lm = bmsvc.getItemLastModified(bm2);</span>
<a href="#l33.125"></a><span id="l33.125" class="difflineplus">+  LOG(&quot;bm2 dateAdded: &quot; + bm2da + &quot;, lastModified: &quot; + bm2lm);</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineplus">+  do_check_true(bm1da &lt;= bm2da);</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineplus">+  // the last modified for bm1 should be at least as big as bm2</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineplus">+  // but could be equal if the test runs faster than our PRNow()</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineplus">+  // granularity</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineplus">+  do_check_true(bm1lm &gt;= bm2lm);</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineplus">+</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineplus">+  // we need to ensure that bm1 last modified date is greater</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineplus">+  // that the modified date of bm2, otherwise in case of a &quot;tie&quot;</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineplus">+  // bm2 will win, as it has a bigger item id</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineplus">+  if (bm1lm == bm2lm) </span>
<a href="#l33.136"></a><span id="l33.136" class="difflineplus">+    bmsvc.setItemLastModified(bm1, bm2lm + 1);</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineplus">+</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineplus">+  [url, postdata] = PlacesUtils.getURLAndPostDataForKeyword(&quot;foo&quot;);</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineplus">+  do_check_eq(testURI.spec, url);</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineplus">+  do_check_eq(postdata, &quot;pdata1&quot;);</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineplus">+</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineplus">+  // cleanup</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineplus">+  bmsvc.removeItem(bm1);</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineplus">+  bmsvc.removeItem(bm2);</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineplus">+</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineplus">+  /*</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineplus">+  Test that id breaks ties:</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineplus">+  1. Create two bookmarks with the same URI and keyword, dateAdded and lastModified.</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineplus">+  2. Confirm that the most recently created one is returned for that keyword.</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineplus">+  */</span>
<a href="#l33.151"></a><span id="l33.151" class="difflineplus">+  var testDate = Date.now() * 1000;</span>
<a href="#l33.152"></a><span id="l33.152" class="difflineplus">+  var bm1 = bmsvc.insertBookmark(testFolderId, testURI, -1, &quot;blah&quot;);</span>
<a href="#l33.153"></a><span id="l33.153" class="difflineplus">+  bmsvc.setKeywordForBookmark(bm1, &quot;foo&quot;);</span>
<a href="#l33.154"></a><span id="l33.154" class="difflineplus">+  PlacesUtils.setPostDataForBookmark(bm1, &quot;pdata1&quot;);</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineplus">+  bmsvc.setItemDateAdded(bm1, testDate);</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineplus">+  bmsvc.setItemLastModified(bm1, testDate);</span>
<a href="#l33.157"></a><span id="l33.157" class="difflineplus">+</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineplus">+  var bm2 = bmsvc.insertBookmark(testFolderId, testURI, -1, &quot;blah&quot;);</span>
<a href="#l33.159"></a><span id="l33.159" class="difflineplus">+  bmsvc.setKeywordForBookmark(bm2, &quot;foo&quot;);</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineplus">+  PlacesUtils.setPostDataForBookmark(bm2, &quot;pdata2&quot;);</span>
<a href="#l33.161"></a><span id="l33.161" class="difflineplus">+  bmsvc.setItemDateAdded(bm2, testDate);</span>
<a href="#l33.162"></a><span id="l33.162" class="difflineplus">+  bmsvc.setItemLastModified(bm2, testDate);</span>
<a href="#l33.163"></a><span id="l33.163" class="difflineplus">+</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineplus">+  var bm1da = bmsvc.getItemDateAdded(bm1, testDate);</span>
<a href="#l33.165"></a><span id="l33.165" class="difflineplus">+  var bm1lm = bmsvc.getItemLastModified(bm1);</span>
<a href="#l33.166"></a><span id="l33.166" class="difflineplus">+  LOG(&quot;bm1 dateAdded: &quot; + bm1da + &quot;, lastModified: &quot; + bm1lm);</span>
<a href="#l33.167"></a><span id="l33.167" class="difflineplus">+  var bm2da = bmsvc.getItemDateAdded(bm2);</span>
<a href="#l33.168"></a><span id="l33.168" class="difflineplus">+  var bm2lm = bmsvc.getItemLastModified(bm2);</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineplus">+  LOG(&quot;bm2 dateAdded: &quot; + bm2da + &quot;, lastModified: &quot; + bm2lm);</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineplus">+</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineplus">+  do_check_eq(bm1da, bm2da);</span>
<a href="#l33.172"></a><span id="l33.172" class="difflineplus">+  do_check_eq(bm1lm, bm2lm);</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineplus">+</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineplus">+</span>
<a href="#l33.175"></a><span id="l33.175" class="difflineplus">+  var ids = bmsvc.getBookmarkIdsForURI(testURI);</span>
<a href="#l33.176"></a><span id="l33.176" class="difflineplus">+  do_check_eq(ids[0], bm2);</span>
<a href="#l33.177"></a><span id="l33.177" class="difflineplus">+  do_check_eq(ids[1], bm1);</span>
<a href="#l33.178"></a><span id="l33.178" class="difflineplus">+</span>
<a href="#l33.179"></a><span id="l33.179" class="difflineplus">+  [url, postdata] = PlacesUtils.getURLAndPostDataForKeyword(&quot;foo&quot;);</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineplus">+  do_check_eq(testURI.spec, url);</span>
<a href="#l33.181"></a><span id="l33.181" class="difflineplus">+  do_check_eq(postdata, &quot;pdata2&quot;);</span>
<a href="#l33.182"></a><span id="l33.182" class="difflineplus">+</span>
<a href="#l33.183"></a><span id="l33.183" class="difflineplus">+  // cleanup</span>
<a href="#l33.184"></a><span id="l33.184" class="difflineplus">+  bmsvc.removeItem(bm1);</span>
<a href="#l33.185"></a><span id="l33.185" class="difflineplus">+  bmsvc.removeItem(bm2);</span>
<a href="#l33.186"></a><span id="l33.186" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">new file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- /dev/null</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_421483.js</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -0,0 +1,122 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+ *</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+ *</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+ * License.</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+ *</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+ * The Original Code is Places Unit Test code.</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+ *</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+ *</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@supereva.it&gt;</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineplus">+ *</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+ *</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+// Get bookmarks service</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+try {</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+  var bmsvc = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+              getService(Ci.nsINavBookmarksService);</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+} catch(ex) {</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+  do_throw(&quot;Could not get Bookmarks service\n&quot;);</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+}</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+// Get annotation service</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineplus">+try {</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+  var annosvc = Cc[&quot;@mozilla.org/browser/annotation-service;1&quot;].</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+                getService(Ci.nsIAnnotationService);</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+} catch(ex) {</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+  do_throw(&quot;Could not get Annotation service\n&quot;);</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+}</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineplus">+</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineplus">+// Get browser glue</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+try {</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+  var gluesvc = Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+                getService(Ci.nsISuiteGlue);</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+} catch(ex) {</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineplus">+  do_throw(&quot;Could not get SuiteGlue service\n&quot;);</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+}</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineplus">+// Get pref service</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineplus">+try {</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+  var pref =  Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+              getService(Ci.nsIPrefBranch);</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineplus">+} catch(ex) {</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineplus">+  do_throw(&quot;Could not get Preferences service\n&quot;);</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineplus">+}</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineplus">+</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+const SMART_BOOKMARKS_ANNO = &quot;Places/SmartBookmark&quot;;</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineplus">+const SMART_BOOKMARKS_PREF = &quot;browser.places.smartBookmarksVersion&quot;;</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineplus">+</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+// main</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineplus">+function run_test() {</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineplus">+  // TEST 1: smart bookmarks disabled</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineplus">+  pref.setIntPref(&quot;browser.places.smartBookmarksVersion&quot;, -1);</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineplus">+  gluesvc.ensurePlacesDefaultQueriesInitialized();</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineplus">+  var smartBookmarkItemIds = annosvc.getItemsWithAnnotation(SMART_BOOKMARKS_ANNO);</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineplus">+  do_check_eq(smartBookmarkItemIds.length, 0);</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineplus">+  // check that pref has not been bumped up</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineplus">+  do_check_eq(pref.getIntPref(&quot;browser.places.smartBookmarksVersion&quot;), -1);</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineplus">+</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineplus">+  // TEST 2: create smart bookmarks</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineplus">+  pref.setIntPref(&quot;browser.places.smartBookmarksVersion&quot;, 0);</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineplus">+  gluesvc.ensurePlacesDefaultQueriesInitialized();</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineplus">+  smartBookmarkItemIds = annosvc.getItemsWithAnnotation(SMART_BOOKMARKS_ANNO);</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineplus">+  do_check_neq(smartBookmarkItemIds.length, 0);</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineplus">+  // check that pref has been bumped up</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineplus">+  do_check_true(pref.getIntPref(&quot;browser.places.smartBookmarksVersion&quot;) &gt; 0);</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineplus">+</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineplus">+  var smartBookmarksCount = smartBookmarkItemIds.length;</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineplus">+</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineplus">+  // TEST 3: smart bookmarks restore</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineplus">+  // remove one smart bookmark and restore</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineplus">+  bmsvc.removeItem(smartBookmarkItemIds[0]);</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineplus">+  pref.setIntPref(&quot;browser.places.smartBookmarksVersion&quot;, 0);</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineplus">+  gluesvc.ensurePlacesDefaultQueriesInitialized();</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineplus">+  smartBookmarkItemIds = annosvc.getItemsWithAnnotation(SMART_BOOKMARKS_ANNO);</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineplus">+  do_check_eq(smartBookmarkItemIds.length, smartBookmarksCount);</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineplus">+  // check that pref has been bumped up</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineplus">+  do_check_true(pref.getIntPref(&quot;browser.places.smartBookmarksVersion&quot;) &gt; 0);</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineplus">+</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineplus">+  // TEST 4: move a smart bookmark, change its title, then restore</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineplus">+  // smart bookmark should be restored in place</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineplus">+  var parent = bmsvc.getFolderIdForItem(smartBookmarkItemIds[0]);</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineplus">+  var oldTitle = bmsvc.getItemTitle(smartBookmarkItemIds[0]);</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineplus">+  // create a subfolder and move inside it</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineplus">+  var newParent = bmsvc.createFolder(parent, &quot;test&quot;, bmsvc.DEFAULT_INDEX);</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineplus">+  bmsvc.moveItem(smartBookmarkItemIds[0], newParent, bmsvc.DEFAULT_INDEX);</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineplus">+  // change title</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineplus">+  bmsvc.setItemTitle(smartBookmarkItemIds[0], &quot;new title&quot;);</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineplus">+  // restore</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineplus">+  pref.setIntPref(&quot;browser.places.smartBookmarksVersion&quot;, 0);</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineplus">+  gluesvc.ensurePlacesDefaultQueriesInitialized();</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineplus">+  smartBookmarkItemIds = annosvc.getItemsWithAnnotation(SMART_BOOKMARKS_ANNO);</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineplus">+  do_check_eq(smartBookmarkItemIds.length, smartBookmarksCount);</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineplus">+  do_check_eq(bmsvc.getFolderIdForItem(smartBookmarkItemIds[0]), newParent);</span>
<a href="#l34.123"></a><span id="l34.123" class="difflineplus">+  do_check_eq(bmsvc.getItemTitle(smartBookmarkItemIds[0]), oldTitle);</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineplus">+  // check that pref has been bumped up</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineplus">+  do_check_true(pref.getIntPref(&quot;browser.places.smartBookmarksVersion&quot;) &gt; 0);</span>
<a href="#l34.126"></a><span id="l34.126" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">new file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- /dev/null</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -0,0 +1,219 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+ *</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+ *</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+ * License.</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+ *</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+ * The Original Code is Bug 457441 code.</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+ *</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+ *</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt; (Original Author)</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+ *</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+ *</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+/*</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineplus">+ * This test ensures that importing/exporting to HTML does not stop</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineplus">+ * if a malformed uri is found.</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineplus">+ */</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineplus">+</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineplus">+// Get Services</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineplus">+var hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+         getService(Ci.nsINavHistoryService);</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+var dbConn = hs.QueryInterface(Ci.nsPIPlacesDatabase).DBConnection;</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+var bs = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+         getService(Ci.nsINavBookmarksService);</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+var as = Cc[&quot;@mozilla.org/browser/annotation-service;1&quot;].</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineplus">+         getService(Ci.nsIAnnotationService);</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+var lms = Cc[&quot;@mozilla.org/browser/livemark-service;2&quot;].</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineplus">+          getService(Ci.nsILivemarkService);</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+var icos = Cc[&quot;@mozilla.org/browser/favicon-service;1&quot;].</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineplus">+           getService(Ci.nsIFaviconService);</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineplus">+var ps = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+         getService(Ci.nsIPrefBranch);</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineplus">+var ies = Cc[&quot;@mozilla.org/browser/places/import-export-service;1&quot;].</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineplus">+          getService(Ci.nsIPlacesImportExportService);</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineplus">+const DESCRIPTION_ANNO = &quot;bookmarkProperties/description&quot;;</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineplus">+const LOAD_IN_SIDEBAR_ANNO = &quot;bookmarkProperties/loadInSidebar&quot;;</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+const POST_DATA_ANNO = &quot;bookmarkProperties/POSTData&quot;;</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+const TEST_FAVICON_PAGE_URL = &quot;http://www.seamonkey-project.org/&quot;;</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+const TEST_FAVICON_DATA_URL = &quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH1QwCEiUG/+wAegAAAu5JREFUOMtlk01oXFUUx3/3vfte3kydmeeQJgUTMsEaKX40tREbDHYE6UIXnZVUujCIiu3GKl0EXRh3ol1EF8WutItuuum4sRTRRXFRFGUyRPxIyVe1mK+ZZD46d968e6+LSduoFw7/c+D+Dv8D5wj+984NDQ4mz6TT/iiAMWCMRanO1urqnaJSZy/u/i12F2H46Qe5XGo6DAOMscSxQWuL1t08imI2NlRpba05CVOz/2qQSJx7+/DhfTPAPUhrQxwbJl54mHemJnCkg20pxh67sFStqlGY2pZd/OOjIyPZmTi+D91t0N+/h/enn2NuFW78aXm6dRvfd3NBIItK8bwEGB5Oz3iei1IxWpt7lrW2vPjKKKoDv65bMr5m4kiOvr4kjUaUh0+OO/DRwSBwR5WKabc1Smnu5zGFwgjfLsIv69CKDL+vG44dGyaKNK5rJ+XAQCqfTifY3Gzumrurp04dom0dlrag3gZtBc2OIZPpIZVK0tubycuxsSfD44VnsQaMBbsTxsDBIx3O/2hRsSAbWFwBf21b8vmn6N83zvz8SijL5YhGo47rguOC0YZsVjI+nuAP7RNpCANLpREzkBYMZly+vhxRLivq9Ri5vLxdqlQaaA1as2MfTp7u4fqGS0dbDvVp6hlBJrD0bFkuXarheaBUpSS1Xii1WvsxJovWXfufnX+QK5uSB3xN0tGkfIdHeyFahddfqxIEAs+DZvPv0s4iXf1CiCcmoQvf2Bvw8oEYAazUBM/sFfz8XZsLnzdRyiKlwJg15uau5XYWafYMpAvvvvd4OD+U4PRDMeYO3F7QbP7W4c1ii1YLPA+CQCBExK1b5Wk4uywArLVDxZ+aX6qeZD5ZiXjrRAXP69qUsqueJ5ASoqjC4uIP07Xaqx8CONbaK9+v2KUDuT3sV2uFky99U3TdJkEgCAJBItFVKSNqtYWlmzevT96FAYS19iiwJYSY3X3S2ewjBd8PQinBcaBaXSnV62989d/j/wcgGYelT45hgQAAAABJRU5ErkJggg==&quot;;</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+// main</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineplus">+function run_test() {</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineplus">+  // avoid creating the places smart folder during tests</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+  ps.setIntPref(&quot;browser.places.smartBookmarksVersion&quot;, -1);</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineplus">+  // import bookmarks from corrupt file</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+  var corruptBookmarksFile = do_get_file(&quot;bookmarks.corrupt.html&quot;);</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+  try {</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+    ies.importHTMLFromFile(corruptBookmarksFile, true);</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import corrupt bookmarks file: &quot; + ex); }</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+  // Check that every bookmark is correct</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+  // Corrupt bookmarks should not have been imported</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineplus">+  database_check();</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineplus">+</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineplus">+  // Create corruption in database</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineplus">+  var corruptItemId = bs.insertBookmark(bs.toolbarFolder,</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineplus">+                                        uri(&quot;http://test.mozilla.org&quot;),</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineplus">+                                        bs.DEFAULT_INDEX, &quot;We love belugas&quot;);</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+  var stmt = dbConn.createStatement(&quot;UPDATE moz_bookmarks SET fk = NULL WHERE id = :itemId&quot;);</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+  stmt.params.itemId = corruptItemId;</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineplus">+  stmt.execute();</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineplus">+  stmt.finalize();</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineplus">+</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineplus">+  // Export bookmarks</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineplus">+  var bookmarksFile = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsILocalFile);</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineplus">+  bookmarksFile.append(&quot;bookmarks.exported.html&quot;);</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineplus">+  if (bookmarksFile.exists())</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineplus">+    bookmarksFile.remove(false);</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineplus">+  bookmarksFile.create(Ci.nsILocalFile.NORMAL_FILE_TYPE, 0600);</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineplus">+  if (!bookmarksFile.exists())</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+    do_throw(&quot;couldn't create file: bookmarks.exported.html&quot;);</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineplus">+  try {</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+    ies.exportHTMLToFile(bookmarksFile);</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't export to bookmarks.exported.html: &quot; + ex); }</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+  // Clear all bookmarks</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+  remove_all_bookmarks();</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineplus">+  // Import bookmarks</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+  try {</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+    ies.importHTMLFromFile(bookmarksFile, true);</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineplus">+  // Check that every bookmark is correct</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+  database_check();</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+}</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineplus">+/*</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineplus">+ * Check for imported bookmarks correctness</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineplus">+ */</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineplus">+function database_check() {</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineplus">+  // BOOKMARKS MENU</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+  var query = hs.getNewQuery();</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+  query.setFolders([bs.bookmarksMenuFolder], 1);</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineplus">+  var options = hs.getNewQueryOptions();</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+  options.queryType = Ci.nsINavHistoryQueryOptions.QUERY_TYPE_BOOKMARKS;</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+  var result = hs.executeQuery(query, options);</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineplus">+  var rootNode = result.root;</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineplus">+  rootNode.containerOpen = true;</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineplus">+  do_check_eq(rootNode.childCount, DEFAULT_BOOKMARKS_ON_MENU + 1);</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineplus">+</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineplus">+  // get test folder</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineplus">+  var testFolder = rootNode.getChild(DEFAULT_BOOKMARKS_ON_MENU);</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineplus">+  do_check_eq(testFolder.type, testFolder.RESULT_TYPE_FOLDER);</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+  do_check_eq(testFolder.title, &quot;test&quot;);</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+  // add date</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+  do_check_eq(bs.getItemDateAdded(testFolder.itemId)/1000000, 1177541020);</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+  // last modified</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineplus">+  do_check_eq(bs.getItemLastModified(testFolder.itemId)/1000000, 1177541050);</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineplus">+  testFolder = testFolder.QueryInterface(Ci.nsINavHistoryQueryResultNode);</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineplus">+  do_check_eq(testFolder.hasChildren, true);</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineplus">+  // folder description</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+  do_check_true(as.itemHasAnnotation(testFolder.itemId,</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineplus">+                                          DESCRIPTION_ANNO));</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineplus">+  do_check_eq(&quot;folder test comment&quot;,</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineplus">+              as.getItemAnnotation(testFolder.itemId, DESCRIPTION_ANNO));</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineplus">+  // open test folder, and test the children</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineplus">+  testFolder.containerOpen = true;</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineplus">+  var cc = testFolder.childCount;</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineplus">+  do_check_eq(cc, 1);</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineplus">+</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+  // test bookmark 1</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+  var testBookmark1 = testFolder.getChild(0);</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+  // url</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+  do_check_eq(&quot;http://test/post&quot;, testBookmark1.uri);</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+  // title</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+  do_check_eq(&quot;test post keyword&quot;, testBookmark1.title);</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+  // keyword</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+  do_check_eq(&quot;test&quot;, bs.getKeywordForBookmark(testBookmark1.itemId));</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+  // sidebar</span>
<a href="#l35.163"></a><span id="l35.163" class="difflineplus">+  do_check_true(as.itemHasAnnotation(testBookmark1.itemId,</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineplus">+                                          LOAD_IN_SIDEBAR_ANNO));</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineplus">+  // add date</span>
<a href="#l35.166"></a><span id="l35.166" class="difflineplus">+  do_check_eq(testBookmark1.dateAdded/1000000, 1177375336);</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineplus">+  // last modified</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineplus">+  do_check_eq(testBookmark1.lastModified/1000000, 1177375423);</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineplus">+  // post data</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineplus">+  do_check_true(as.itemHasAnnotation(testBookmark1.itemId,</span>
<a href="#l35.171"></a><span id="l35.171" class="difflineplus">+                                          POST_DATA_ANNO));</span>
<a href="#l35.172"></a><span id="l35.172" class="difflineplus">+  do_check_eq(&quot;hidden1%3Dbar&amp;text1%3D%25s&quot;,</span>
<a href="#l35.173"></a><span id="l35.173" class="difflineplus">+              as.getItemAnnotation(testBookmark1.itemId, POST_DATA_ANNO));</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineplus">+  // last charset</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+  var testURI = uri(testBookmark1.uri);</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineplus">+  do_check_eq(&quot;ISO-8859-1&quot;, hs.getCharsetForURI(testURI));</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineplus">+  // description</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineplus">+  do_check_true(as.itemHasAnnotation(testBookmark1.itemId,</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineplus">+                                          DESCRIPTION_ANNO));</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineplus">+  do_check_eq(&quot;item description&quot;,</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineplus">+              as.getItemAnnotation(testBookmark1.itemId,</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineplus">+                                        DESCRIPTION_ANNO));</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineplus">+</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+  // clean up</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineplus">+  testFolder.containerOpen = false;</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineplus">+  rootNode.containerOpen = false;</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineplus">+</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineplus">+  // BOOKMARKS TOOLBAR</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineplus">+  query.setFolders([bs.toolbarFolder], 1);</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineplus">+  result = hs.executeQuery(query, hs.getNewQueryOptions());</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineplus">+  var toolbar = result.root;</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineplus">+  toolbar.containerOpen = true;</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineplus">+  do_check_eq(toolbar.childCount, DEFAULT_BOOKMARKS_ON_TOOLBAR + 1);</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineplus">+</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineplus">+  // livemark</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineplus">+  var livemark = toolbar.getChild(DEFAULT_BOOKMARKS_ON_TOOLBAR - 1);</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineplus">+  // title</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineplus">+  do_check_eq(&quot;Latest Headlines&quot;, livemark.title);</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineplus">+  // livemark check</span>
<a href="#l35.200"></a><span id="l35.200" class="difflineplus">+  do_check_true(lms.isLivemark(livemark.itemId));</span>
<a href="#l35.201"></a><span id="l35.201" class="difflineplus">+  // site url</span>
<a href="#l35.202"></a><span id="l35.202" class="difflineplus">+  do_check_eq(&quot;http://en-us.fxfeeds.mozilla.com/en-US/firefox/livebookmarks/&quot;,</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineplus">+              lms.getSiteURI(livemark.itemId).spec);</span>
<a href="#l35.204"></a><span id="l35.204" class="difflineplus">+  // feed url</span>
<a href="#l35.205"></a><span id="l35.205" class="difflineplus">+  do_check_eq(&quot;http://en-us.fxfeeds.mozilla.com/en-US/firefox/headlines.xml&quot;,</span>
<a href="#l35.206"></a><span id="l35.206" class="difflineplus">+              lms.getFeedURI(livemark.itemId).spec);</span>
<a href="#l35.207"></a><span id="l35.207" class="difflineplus">+</span>
<a href="#l35.208"></a><span id="l35.208" class="difflineplus">+  // cleanup</span>
<a href="#l35.209"></a><span id="l35.209" class="difflineplus">+  toolbar.containerOpen = false;</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineplus">+</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineplus">+  // UNFILED BOOKMARKS</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineplus">+  query.setFolders([bs.unfiledBookmarksFolder], 1);</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineplus">+  result = hs.executeQuery(query, hs.getNewQueryOptions());</span>
<a href="#l35.214"></a><span id="l35.214" class="difflineplus">+  var unfiledBookmarks = result.root;</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineplus">+  unfiledBookmarks.containerOpen = true;</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineplus">+  do_check_eq(unfiledBookmarks.childCount, 1);</span>
<a href="#l35.217"></a><span id="l35.217" class="difflineplus">+  unfiledBookmarks.containerOpen = false;</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineplus">+</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineplus">+  // favicons</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineplus">+  var faviconURI = icos.getFaviconForPage(uri(TEST_FAVICON_PAGE_URL));</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineplus">+  var dataURL = icos.getFaviconDataAsDataURL(faviconURI);</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineplus">+  do_check_eq(TEST_FAVICON_DATA_URL, dataURL);</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">new file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- /dev/null</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -0,0 +1,443 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineplus">+ *</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+ *</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineplus">+ * License.</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineplus">+ *</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineplus">+ * The Original Code is Places test code.</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+ *</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineplus">+ *</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+ *   Drew Willcoxon &lt;adw@mozilla.com&gt; (Original Author)</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineplus">+ *</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineplus">+ *</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+/**</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+ * Tests the bookmarks-restore-* nsIObserver notifications after restoring</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+ * bookmarks from JSON and HTML.  See bug 470314.</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+ */</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineplus">+</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineplus">+// The topics and data passed to nsIObserver.observe() on bookmarks restore</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+const NSIOBSERVER_TOPIC_BEGIN    = &quot;bookmarks-restore-begin&quot;;</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineplus">+const NSIOBSERVER_TOPIC_SUCCESS  = &quot;bookmarks-restore-success&quot;;</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+const NSIOBSERVER_TOPIC_FAILED   = &quot;bookmarks-restore-failed&quot;;</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+const NSIOBSERVER_DATA_JSON      = &quot;json&quot;;</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+const NSIOBSERVER_DATA_HTML      = &quot;html&quot;;</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+const NSIOBSERVER_DATA_HTML_INIT = &quot;html-initial&quot;;</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+// Bookmarks are added for these URIs</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineplus">+var uris = [</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+  &quot;http://example.com/1&quot;,</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+  &quot;http://example.com/2&quot;,</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+  &quot;http://example.com/3&quot;,</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+  &quot;http://example.com/4&quot;,</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+  &quot;http://example.com/5&quot;,</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineplus">+];</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+// Add tests here.  Each is an object with these properties:</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+//   desc:       description printed before test is run</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineplus">+//   currTopic:  the next expected topic that should be observed for the test;</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineplus">+//               set to NSIOBSERVER_TOPIC_BEGIN to begin</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineplus">+//   finalTopic: the last expected topic that should be observed for the test,</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineplus">+//               which then causes the next test to be run</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineplus">+//   data:       the data passed to nsIObserver.observe() corresponding to the</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineplus">+//               test</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineplus">+//   file:       the nsILocalFile that the test creates</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineplus">+//   folderId:   for HTML restore into a folder, the folder ID to restore into;</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineplus">+//               otherwise, set it to null</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineplus">+//   run:        a method that actually runs the test</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineplus">+var tests = [</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineplus">+  {</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineplus">+    desc:       &quot;JSON restore: normal restore should succeed&quot;,</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+    currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineplus">+    finalTopic: NSIOBSERVER_TOPIC_SUCCESS,</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+    data:       NSIOBSERVER_DATA_JSON,</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineplus">+    folderId:   null,</span>
<a href="#l36.84"></a><span id="l36.84" class="difflineplus">+    run:        function () {</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineplus">+      this.file = createFile(&quot;bookmarks-test_restoreNotification.json&quot;);</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineplus">+      addBookmarks();</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineplus">+      PlacesUtils.backups.saveBookmarksToJSONFile(this.file);</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineplus">+      remove_all_bookmarks();</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+      try {</span>
<a href="#l36.90"></a><span id="l36.90" class="difflineplus">+        PlacesUtils.restoreBookmarksFromJSONFile(this.file);</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineplus">+      }</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineplus">+      catch (e) {</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineplus">+        do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineplus">+      }</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineplus">+    }</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineplus">+  },</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineplus">+</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineplus">+  {</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineplus">+    desc:       &quot;JSON restore: empty file should succeed&quot;,</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineplus">+    currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineplus">+    finalTopic: NSIOBSERVER_TOPIC_SUCCESS,</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineplus">+    data:       NSIOBSERVER_DATA_JSON,</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineplus">+    folderId:   null,</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineplus">+    run:        function () {</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineplus">+      this.file = createFile(&quot;bookmarks-test_restoreNotification.json&quot;);</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineplus">+      try {</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineplus">+        PlacesUtils.restoreBookmarksFromJSONFile(this.file);</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+      }</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineplus">+      catch (e) {</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineplus">+        do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineplus">+      }</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineplus">+    }</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineplus">+  },</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineplus">+</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineplus">+  {</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineplus">+    desc:       &quot;JSON restore: nonexistent file should fail&quot;,</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineplus">+    currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineplus">+    finalTopic: NSIOBSERVER_TOPIC_FAILED,</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineplus">+    data:       NSIOBSERVER_DATA_JSON,</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineplus">+    folderId:   null,</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineplus">+    run:        function () {</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineplus">+      this.file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsILocalFile);</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+      this.file.append(&quot;this file doesn't exist because nobody created it&quot;);</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineplus">+      try {</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineplus">+        PlacesUtils.restoreBookmarksFromJSONFile(this.file);</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineplus">+        do_throw(&quot;  Restore should have failed&quot;);</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineplus">+      }</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+      catch (e) {}</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineplus">+    }</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineplus">+  },</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineplus">+</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineplus">+  {</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineplus">+    desc:       &quot;HTML restore: normal restore should succeed&quot;,</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineplus">+    currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineplus">+    finalTopic: NSIOBSERVER_TOPIC_SUCCESS,</span>
<a href="#l36.136"></a><span id="l36.136" class="difflineplus">+    data:       NSIOBSERVER_DATA_HTML,</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineplus">+    folderId:   null,</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineplus">+    run:        function () {</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineplus">+      this.file = createFile(&quot;bookmarks-test_restoreNotification.html&quot;);</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineplus">+      addBookmarks();</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineplus">+      importer.exportHTMLToFile(this.file);</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineplus">+      remove_all_bookmarks();</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineplus">+      try {</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineplus">+        importer.importHTMLFromFile(this.file, false);</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineplus">+      }</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+      catch (e) {</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+        do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineplus">+      }</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineplus">+    }</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineplus">+  },</span>
<a href="#l36.151"></a><span id="l36.151" class="difflineplus">+</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineplus">+  {</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineplus">+    desc:       &quot;HTML restore: empty file should succeed&quot;,</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineplus">+    currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineplus">+    finalTopic: NSIOBSERVER_TOPIC_SUCCESS,</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineplus">+    data:       NSIOBSERVER_DATA_HTML,</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineplus">+    folderId:   null,</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineplus">+    run:        function () {</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineplus">+      this.file = createFile(&quot;bookmarks-test_restoreNotification.init.html&quot;);</span>
<a href="#l36.160"></a><span id="l36.160" class="difflineplus">+      try {</span>
<a href="#l36.161"></a><span id="l36.161" class="difflineplus">+        importer.importHTMLFromFile(this.file, false);</span>
<a href="#l36.162"></a><span id="l36.162" class="difflineplus">+      }</span>
<a href="#l36.163"></a><span id="l36.163" class="difflineplus">+      catch (e) {</span>
<a href="#l36.164"></a><span id="l36.164" class="difflineplus">+        do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineplus">+      }</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineplus">+    }</span>
<a href="#l36.167"></a><span id="l36.167" class="difflineplus">+  },</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineplus">+</span>
<a href="#l36.169"></a><span id="l36.169" class="difflineplus">+  {</span>
<a href="#l36.170"></a><span id="l36.170" class="difflineplus">+    desc:       &quot;HTML restore: nonexistent file should fail&quot;,</span>
<a href="#l36.171"></a><span id="l36.171" class="difflineplus">+    currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l36.172"></a><span id="l36.172" class="difflineplus">+    finalTopic: NSIOBSERVER_TOPIC_FAILED,</span>
<a href="#l36.173"></a><span id="l36.173" class="difflineplus">+    data:       NSIOBSERVER_DATA_HTML,</span>
<a href="#l36.174"></a><span id="l36.174" class="difflineplus">+    folderId:   null,</span>
<a href="#l36.175"></a><span id="l36.175" class="difflineplus">+    run:        function () {</span>
<a href="#l36.176"></a><span id="l36.176" class="difflineplus">+      this.file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsILocalFile);</span>
<a href="#l36.177"></a><span id="l36.177" class="difflineplus">+      this.file.append(&quot;this file doesn't exist because nobody created it&quot;);</span>
<a href="#l36.178"></a><span id="l36.178" class="difflineplus">+      try {</span>
<a href="#l36.179"></a><span id="l36.179" class="difflineplus">+        importer.importHTMLFromFile(this.file, false);</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineplus">+        do_throw(&quot;  Restore should have failed&quot;);</span>
<a href="#l36.181"></a><span id="l36.181" class="difflineplus">+      }</span>
<a href="#l36.182"></a><span id="l36.182" class="difflineplus">+      catch (e) {}</span>
<a href="#l36.183"></a><span id="l36.183" class="difflineplus">+    }</span>
<a href="#l36.184"></a><span id="l36.184" class="difflineplus">+  },</span>
<a href="#l36.185"></a><span id="l36.185" class="difflineplus">+</span>
<a href="#l36.186"></a><span id="l36.186" class="difflineplus">+  {</span>
<a href="#l36.187"></a><span id="l36.187" class="difflineplus">+    desc:       &quot;HTML initial restore: normal restore should succeed&quot;,</span>
<a href="#l36.188"></a><span id="l36.188" class="difflineplus">+    currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l36.189"></a><span id="l36.189" class="difflineplus">+    finalTopic: NSIOBSERVER_TOPIC_SUCCESS,</span>
<a href="#l36.190"></a><span id="l36.190" class="difflineplus">+    data:       NSIOBSERVER_DATA_HTML_INIT,</span>
<a href="#l36.191"></a><span id="l36.191" class="difflineplus">+    folderId:   null,</span>
<a href="#l36.192"></a><span id="l36.192" class="difflineplus">+    run:        function () {</span>
<a href="#l36.193"></a><span id="l36.193" class="difflineplus">+      this.file = createFile(&quot;bookmarks-test_restoreNotification.init.html&quot;);</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineplus">+      addBookmarks();</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineplus">+      importer.exportHTMLToFile(this.file);</span>
<a href="#l36.196"></a><span id="l36.196" class="difflineplus">+      remove_all_bookmarks();</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineplus">+      try {</span>
<a href="#l36.198"></a><span id="l36.198" class="difflineplus">+        importer.importHTMLFromFile(this.file, true);</span>
<a href="#l36.199"></a><span id="l36.199" class="difflineplus">+      }</span>
<a href="#l36.200"></a><span id="l36.200" class="difflineplus">+      catch (e) {</span>
<a href="#l36.201"></a><span id="l36.201" class="difflineplus">+        do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l36.202"></a><span id="l36.202" class="difflineplus">+      }</span>
<a href="#l36.203"></a><span id="l36.203" class="difflineplus">+    }</span>
<a href="#l36.204"></a><span id="l36.204" class="difflineplus">+  },</span>
<a href="#l36.205"></a><span id="l36.205" class="difflineplus">+</span>
<a href="#l36.206"></a><span id="l36.206" class="difflineplus">+  {</span>
<a href="#l36.207"></a><span id="l36.207" class="difflineplus">+    desc:       &quot;HTML initial restore: empty file should succeed&quot;,</span>
<a href="#l36.208"></a><span id="l36.208" class="difflineplus">+    currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l36.209"></a><span id="l36.209" class="difflineplus">+    finalTopic: NSIOBSERVER_TOPIC_SUCCESS,</span>
<a href="#l36.210"></a><span id="l36.210" class="difflineplus">+    data:       NSIOBSERVER_DATA_HTML_INIT,</span>
<a href="#l36.211"></a><span id="l36.211" class="difflineplus">+    folderId:   null,</span>
<a href="#l36.212"></a><span id="l36.212" class="difflineplus">+    run:        function () {</span>
<a href="#l36.213"></a><span id="l36.213" class="difflineplus">+      this.file = createFile(&quot;bookmarks-test_restoreNotification.init.html&quot;);</span>
<a href="#l36.214"></a><span id="l36.214" class="difflineplus">+      try {</span>
<a href="#l36.215"></a><span id="l36.215" class="difflineplus">+        importer.importHTMLFromFile(this.file, true);</span>
<a href="#l36.216"></a><span id="l36.216" class="difflineplus">+      }</span>
<a href="#l36.217"></a><span id="l36.217" class="difflineplus">+      catch (e) {</span>
<a href="#l36.218"></a><span id="l36.218" class="difflineplus">+        do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l36.219"></a><span id="l36.219" class="difflineplus">+      }</span>
<a href="#l36.220"></a><span id="l36.220" class="difflineplus">+    }</span>
<a href="#l36.221"></a><span id="l36.221" class="difflineplus">+  },</span>
<a href="#l36.222"></a><span id="l36.222" class="difflineplus">+</span>
<a href="#l36.223"></a><span id="l36.223" class="difflineplus">+  {</span>
<a href="#l36.224"></a><span id="l36.224" class="difflineplus">+    desc:       &quot;HTML initial restore: nonexistent file should fail&quot;,</span>
<a href="#l36.225"></a><span id="l36.225" class="difflineplus">+    currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l36.226"></a><span id="l36.226" class="difflineplus">+    finalTopic: NSIOBSERVER_TOPIC_FAILED,</span>
<a href="#l36.227"></a><span id="l36.227" class="difflineplus">+    data:       NSIOBSERVER_DATA_HTML_INIT,</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineplus">+    folderId:   null,</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineplus">+    run:        function () {</span>
<a href="#l36.230"></a><span id="l36.230" class="difflineplus">+      this.file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsILocalFile);</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineplus">+      this.file.append(&quot;this file doesn't exist because nobody created it&quot;);</span>
<a href="#l36.232"></a><span id="l36.232" class="difflineplus">+      try {</span>
<a href="#l36.233"></a><span id="l36.233" class="difflineplus">+        importer.importHTMLFromFile(this.file, true);</span>
<a href="#l36.234"></a><span id="l36.234" class="difflineplus">+        do_throw(&quot;  Restore should have failed&quot;);</span>
<a href="#l36.235"></a><span id="l36.235" class="difflineplus">+      }</span>
<a href="#l36.236"></a><span id="l36.236" class="difflineplus">+      catch (e) {}</span>
<a href="#l36.237"></a><span id="l36.237" class="difflineplus">+    }</span>
<a href="#l36.238"></a><span id="l36.238" class="difflineplus">+  },</span>
<a href="#l36.239"></a><span id="l36.239" class="difflineplus">+</span>
<a href="#l36.240"></a><span id="l36.240" class="difflineplus">+  {</span>
<a href="#l36.241"></a><span id="l36.241" class="difflineplus">+    desc:       &quot;HTML restore into folder: normal restore should succeed&quot;,</span>
<a href="#l36.242"></a><span id="l36.242" class="difflineplus">+    currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l36.243"></a><span id="l36.243" class="difflineplus">+    finalTopic: NSIOBSERVER_TOPIC_SUCCESS,</span>
<a href="#l36.244"></a><span id="l36.244" class="difflineplus">+    data:       NSIOBSERVER_DATA_HTML,</span>
<a href="#l36.245"></a><span id="l36.245" class="difflineplus">+    run:        function () {</span>
<a href="#l36.246"></a><span id="l36.246" class="difflineplus">+      this.file = createFile(&quot;bookmarks-test_restoreNotification.html&quot;);</span>
<a href="#l36.247"></a><span id="l36.247" class="difflineplus">+      addBookmarks();</span>
<a href="#l36.248"></a><span id="l36.248" class="difflineplus">+      importer.exportHTMLToFile(this.file);</span>
<a href="#l36.249"></a><span id="l36.249" class="difflineplus">+      remove_all_bookmarks();</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineplus">+      this.folderId = bmsvc.createFolder(bmsvc.unfiledBookmarksFolder,</span>
<a href="#l36.251"></a><span id="l36.251" class="difflineplus">+                                         &quot;test folder&quot;,</span>
<a href="#l36.252"></a><span id="l36.252" class="difflineplus">+                                         bmsvc.DEFAULT_INDEX);</span>
<a href="#l36.253"></a><span id="l36.253" class="difflineplus">+      print(&quot;  Sanity check: createFolder() should have succeeded&quot;);</span>
<a href="#l36.254"></a><span id="l36.254" class="difflineplus">+      do_check_true(this.folderId &gt; 0);</span>
<a href="#l36.255"></a><span id="l36.255" class="difflineplus">+      try {</span>
<a href="#l36.256"></a><span id="l36.256" class="difflineplus">+        importer.importHTMLFromFileToFolder(this.file, this.folderId, false);</span>
<a href="#l36.257"></a><span id="l36.257" class="difflineplus">+      }</span>
<a href="#l36.258"></a><span id="l36.258" class="difflineplus">+      catch (e) {</span>
<a href="#l36.259"></a><span id="l36.259" class="difflineplus">+        do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l36.260"></a><span id="l36.260" class="difflineplus">+      }</span>
<a href="#l36.261"></a><span id="l36.261" class="difflineplus">+    }</span>
<a href="#l36.262"></a><span id="l36.262" class="difflineplus">+  },</span>
<a href="#l36.263"></a><span id="l36.263" class="difflineplus">+</span>
<a href="#l36.264"></a><span id="l36.264" class="difflineplus">+  {</span>
<a href="#l36.265"></a><span id="l36.265" class="difflineplus">+    desc:       &quot;HTML restore into folder: empty file should succeed&quot;,</span>
<a href="#l36.266"></a><span id="l36.266" class="difflineplus">+    currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l36.267"></a><span id="l36.267" class="difflineplus">+    finalTopic: NSIOBSERVER_TOPIC_SUCCESS,</span>
<a href="#l36.268"></a><span id="l36.268" class="difflineplus">+    data:       NSIOBSERVER_DATA_HTML,</span>
<a href="#l36.269"></a><span id="l36.269" class="difflineplus">+    run:        function () {</span>
<a href="#l36.270"></a><span id="l36.270" class="difflineplus">+      this.file = createFile(&quot;bookmarks-test_restoreNotification.init.html&quot;);</span>
<a href="#l36.271"></a><span id="l36.271" class="difflineplus">+      this.folderId = bmsvc.createFolder(bmsvc.unfiledBookmarksFolder,</span>
<a href="#l36.272"></a><span id="l36.272" class="difflineplus">+                                         &quot;test folder&quot;,</span>
<a href="#l36.273"></a><span id="l36.273" class="difflineplus">+                                         bmsvc.DEFAULT_INDEX);</span>
<a href="#l36.274"></a><span id="l36.274" class="difflineplus">+      print(&quot;  Sanity check: createFolder() should have succeeded&quot;);</span>
<a href="#l36.275"></a><span id="l36.275" class="difflineplus">+      do_check_true(this.folderId &gt; 0);</span>
<a href="#l36.276"></a><span id="l36.276" class="difflineplus">+      try {</span>
<a href="#l36.277"></a><span id="l36.277" class="difflineplus">+        importer.importHTMLFromFileToFolder(this.file, this.folderId, false);</span>
<a href="#l36.278"></a><span id="l36.278" class="difflineplus">+      }</span>
<a href="#l36.279"></a><span id="l36.279" class="difflineplus">+      catch (e) {</span>
<a href="#l36.280"></a><span id="l36.280" class="difflineplus">+        do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l36.281"></a><span id="l36.281" class="difflineplus">+      }</span>
<a href="#l36.282"></a><span id="l36.282" class="difflineplus">+    }</span>
<a href="#l36.283"></a><span id="l36.283" class="difflineplus">+  },</span>
<a href="#l36.284"></a><span id="l36.284" class="difflineplus">+</span>
<a href="#l36.285"></a><span id="l36.285" class="difflineplus">+  {</span>
<a href="#l36.286"></a><span id="l36.286" class="difflineplus">+    desc:       &quot;HTML restore into folder: nonexistent file should fail&quot;,</span>
<a href="#l36.287"></a><span id="l36.287" class="difflineplus">+    currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l36.288"></a><span id="l36.288" class="difflineplus">+    finalTopic: NSIOBSERVER_TOPIC_FAILED,</span>
<a href="#l36.289"></a><span id="l36.289" class="difflineplus">+    data:       NSIOBSERVER_DATA_HTML,</span>
<a href="#l36.290"></a><span id="l36.290" class="difflineplus">+    run:        function () {</span>
<a href="#l36.291"></a><span id="l36.291" class="difflineplus">+      this.file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsILocalFile);</span>
<a href="#l36.292"></a><span id="l36.292" class="difflineplus">+      this.file.append(&quot;this file doesn't exist because nobody created it&quot;);</span>
<a href="#l36.293"></a><span id="l36.293" class="difflineplus">+      this.folderId = bmsvc.createFolder(bmsvc.unfiledBookmarksFolder,</span>
<a href="#l36.294"></a><span id="l36.294" class="difflineplus">+                                         &quot;test folder&quot;,</span>
<a href="#l36.295"></a><span id="l36.295" class="difflineplus">+                                         bmsvc.DEFAULT_INDEX);</span>
<a href="#l36.296"></a><span id="l36.296" class="difflineplus">+      print(&quot;  Sanity check: createFolder() should have succeeded&quot;);</span>
<a href="#l36.297"></a><span id="l36.297" class="difflineplus">+      do_check_true(this.folderId &gt; 0);</span>
<a href="#l36.298"></a><span id="l36.298" class="difflineplus">+      try {</span>
<a href="#l36.299"></a><span id="l36.299" class="difflineplus">+        importer.importHTMLFromFileToFolder(this.file, this.folderId, false);</span>
<a href="#l36.300"></a><span id="l36.300" class="difflineplus">+        do_throw(&quot;  Restore should have failed&quot;);</span>
<a href="#l36.301"></a><span id="l36.301" class="difflineplus">+      }</span>
<a href="#l36.302"></a><span id="l36.302" class="difflineplus">+      catch (e) {}</span>
<a href="#l36.303"></a><span id="l36.303" class="difflineplus">+    }</span>
<a href="#l36.304"></a><span id="l36.304" class="difflineplus">+  }</span>
<a href="#l36.305"></a><span id="l36.305" class="difflineplus">+];</span>
<a href="#l36.306"></a><span id="l36.306" class="difflineplus">+</span>
<a href="#l36.307"></a><span id="l36.307" class="difflineplus">+// nsIObserver that observes bookmarks-restore-begin.</span>
<a href="#l36.308"></a><span id="l36.308" class="difflineplus">+var beginObserver = {</span>
<a href="#l36.309"></a><span id="l36.309" class="difflineplus">+  observe: function _beginObserver(aSubject, aTopic, aData) {</span>
<a href="#l36.310"></a><span id="l36.310" class="difflineplus">+    var test = tests[currTestIndex];</span>
<a href="#l36.311"></a><span id="l36.311" class="difflineplus">+</span>
<a href="#l36.312"></a><span id="l36.312" class="difflineplus">+    print(&quot;  Observed &quot; + aTopic);</span>
<a href="#l36.313"></a><span id="l36.313" class="difflineplus">+    print(&quot;  Topic for current test should be what is expected&quot;);</span>
<a href="#l36.314"></a><span id="l36.314" class="difflineplus">+    do_check_eq(aTopic, test.currTopic);</span>
<a href="#l36.315"></a><span id="l36.315" class="difflineplus">+</span>
<a href="#l36.316"></a><span id="l36.316" class="difflineplus">+    print(&quot;  Data for current test should be what is expected&quot;);</span>
<a href="#l36.317"></a><span id="l36.317" class="difflineplus">+    do_check_eq(aData, test.data);</span>
<a href="#l36.318"></a><span id="l36.318" class="difflineplus">+</span>
<a href="#l36.319"></a><span id="l36.319" class="difflineplus">+    // Update current expected topic to the next expected one.</span>
<a href="#l36.320"></a><span id="l36.320" class="difflineplus">+    test.currTopic = test.finalTopic;</span>
<a href="#l36.321"></a><span id="l36.321" class="difflineplus">+  }</span>
<a href="#l36.322"></a><span id="l36.322" class="difflineplus">+};</span>
<a href="#l36.323"></a><span id="l36.323" class="difflineplus">+</span>
<a href="#l36.324"></a><span id="l36.324" class="difflineplus">+// nsIObserver that observes bookmarks-restore-success/failed.  This starts</span>
<a href="#l36.325"></a><span id="l36.325" class="difflineplus">+// the next test.</span>
<a href="#l36.326"></a><span id="l36.326" class="difflineplus">+var successAndFailedObserver = {</span>
<a href="#l36.327"></a><span id="l36.327" class="difflineplus">+  observe: function _successAndFailedObserver(aSubject, aTopic, aData) {</span>
<a href="#l36.328"></a><span id="l36.328" class="difflineplus">+    var test = tests[currTestIndex];</span>
<a href="#l36.329"></a><span id="l36.329" class="difflineplus">+</span>
<a href="#l36.330"></a><span id="l36.330" class="difflineplus">+    print(&quot;  Observed &quot; + aTopic);</span>
<a href="#l36.331"></a><span id="l36.331" class="difflineplus">+    print(&quot;  Topic for current test should be what is expected&quot;);</span>
<a href="#l36.332"></a><span id="l36.332" class="difflineplus">+    do_check_eq(aTopic, test.currTopic);</span>
<a href="#l36.333"></a><span id="l36.333" class="difflineplus">+</span>
<a href="#l36.334"></a><span id="l36.334" class="difflineplus">+    print(&quot;  Data for current test should be what is expected&quot;);</span>
<a href="#l36.335"></a><span id="l36.335" class="difflineplus">+    do_check_eq(aData, test.data);</span>
<a href="#l36.336"></a><span id="l36.336" class="difflineplus">+</span>
<a href="#l36.337"></a><span id="l36.337" class="difflineplus">+    // On restore failed, file may not exist, so wrap in try-catch.</span>
<a href="#l36.338"></a><span id="l36.338" class="difflineplus">+    try {</span>
<a href="#l36.339"></a><span id="l36.339" class="difflineplus">+      test.file.remove(false);</span>
<a href="#l36.340"></a><span id="l36.340" class="difflineplus">+    }</span>
<a href="#l36.341"></a><span id="l36.341" class="difflineplus">+    catch (exc) {}</span>
<a href="#l36.342"></a><span id="l36.342" class="difflineplus">+</span>
<a href="#l36.343"></a><span id="l36.343" class="difflineplus">+    // Make sure folder ID is what is expected.  For importing HTML into a</span>
<a href="#l36.344"></a><span id="l36.344" class="difflineplus">+    // folder, this will be an integer, otherwise null.</span>
<a href="#l36.345"></a><span id="l36.345" class="difflineplus">+    if (aSubject) {</span>
<a href="#l36.346"></a><span id="l36.346" class="difflineplus">+      do_check_eq(aSubject.QueryInterface(Ci.nsISupportsPRInt64).data,</span>
<a href="#l36.347"></a><span id="l36.347" class="difflineplus">+                  test.folderId);</span>
<a href="#l36.348"></a><span id="l36.348" class="difflineplus">+    }</span>
<a href="#l36.349"></a><span id="l36.349" class="difflineplus">+    else</span>
<a href="#l36.350"></a><span id="l36.350" class="difflineplus">+      do_check_eq(test.folderId, null);</span>
<a href="#l36.351"></a><span id="l36.351" class="difflineplus">+</span>
<a href="#l36.352"></a><span id="l36.352" class="difflineplus">+    remove_all_bookmarks();</span>
<a href="#l36.353"></a><span id="l36.353" class="difflineplus">+    doNextTest();</span>
<a href="#l36.354"></a><span id="l36.354" class="difflineplus">+  }</span>
<a href="#l36.355"></a><span id="l36.355" class="difflineplus">+};</span>
<a href="#l36.356"></a><span id="l36.356" class="difflineplus">+</span>
<a href="#l36.357"></a><span id="l36.357" class="difflineplus">+// Index of the currently running test.  See doNextTest().</span>
<a href="#l36.358"></a><span id="l36.358" class="difflineplus">+var currTestIndex = -1;</span>
<a href="#l36.359"></a><span id="l36.359" class="difflineplus">+</span>
<a href="#l36.360"></a><span id="l36.360" class="difflineplus">+var bmsvc = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l36.361"></a><span id="l36.361" class="difflineplus">+            getService(Ci.nsINavBookmarksService);</span>
<a href="#l36.362"></a><span id="l36.362" class="difflineplus">+</span>
<a href="#l36.363"></a><span id="l36.363" class="difflineplus">+var obssvc = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l36.364"></a><span id="l36.364" class="difflineplus">+             getService(Ci.nsIObserverService);</span>
<a href="#l36.365"></a><span id="l36.365" class="difflineplus">+</span>
<a href="#l36.366"></a><span id="l36.366" class="difflineplus">+var importer = Cc[&quot;@mozilla.org/browser/places/import-export-service;1&quot;].</span>
<a href="#l36.367"></a><span id="l36.367" class="difflineplus">+               getService(Ci.nsIPlacesImportExportService);</span>
<a href="#l36.368"></a><span id="l36.368" class="difflineplus">+</span>
<a href="#l36.369"></a><span id="l36.369" class="difflineplus">+///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.370"></a><span id="l36.370" class="difflineplus">+</span>
<a href="#l36.371"></a><span id="l36.371" class="difflineplus">+/**</span>
<a href="#l36.372"></a><span id="l36.372" class="difflineplus">+ * Adds some bookmarks for the URIs in |uris|.</span>
<a href="#l36.373"></a><span id="l36.373" class="difflineplus">+ */</span>
<a href="#l36.374"></a><span id="l36.374" class="difflineplus">+function addBookmarks() {</span>
<a href="#l36.375"></a><span id="l36.375" class="difflineplus">+  uris.forEach(function (u) bmsvc.insertBookmark(bmsvc.bookmarksMenuFolder,</span>
<a href="#l36.376"></a><span id="l36.376" class="difflineplus">+                                                 uri(u),</span>
<a href="#l36.377"></a><span id="l36.377" class="difflineplus">+                                                 bmsvc.DEFAULT_INDEX,</span>
<a href="#l36.378"></a><span id="l36.378" class="difflineplus">+                                                 u));</span>
<a href="#l36.379"></a><span id="l36.379" class="difflineplus">+  checkBookmarksExist();</span>
<a href="#l36.380"></a><span id="l36.380" class="difflineplus">+}</span>
<a href="#l36.381"></a><span id="l36.381" class="difflineplus">+</span>
<a href="#l36.382"></a><span id="l36.382" class="difflineplus">+/**</span>
<a href="#l36.383"></a><span id="l36.383" class="difflineplus">+ * Checks that all of the bookmarks created for |uris| exist.  It works by</span>
<a href="#l36.384"></a><span id="l36.384" class="difflineplus">+ * creating one query per URI and then ORing all the queries.  The number of</span>
<a href="#l36.385"></a><span id="l36.385" class="difflineplus">+ * results returned should be uris.length.</span>
<a href="#l36.386"></a><span id="l36.386" class="difflineplus">+ */</span>
<a href="#l36.387"></a><span id="l36.387" class="difflineplus">+function checkBookmarksExist() {</span>
<a href="#l36.388"></a><span id="l36.388" class="difflineplus">+  var hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l36.389"></a><span id="l36.389" class="difflineplus">+           getService(Ci.nsINavHistoryService);</span>
<a href="#l36.390"></a><span id="l36.390" class="difflineplus">+  var queries = uris.map(function (u) {</span>
<a href="#l36.391"></a><span id="l36.391" class="difflineplus">+    var q = hs.getNewQuery();</span>
<a href="#l36.392"></a><span id="l36.392" class="difflineplus">+    q.uri = uri(u);</span>
<a href="#l36.393"></a><span id="l36.393" class="difflineplus">+    return q;</span>
<a href="#l36.394"></a><span id="l36.394" class="difflineplus">+  });</span>
<a href="#l36.395"></a><span id="l36.395" class="difflineplus">+  var options = hs.getNewQueryOptions();</span>
<a href="#l36.396"></a><span id="l36.396" class="difflineplus">+  options.queryType = options.QUERY_TYPE_BOOKMARKS;</span>
<a href="#l36.397"></a><span id="l36.397" class="difflineplus">+  var root = hs.executeQueries(queries, uris.length, options).root;</span>
<a href="#l36.398"></a><span id="l36.398" class="difflineplus">+  root.containerOpen = true;</span>
<a href="#l36.399"></a><span id="l36.399" class="difflineplus">+  do_check_eq(root.childCount, uris.length);</span>
<a href="#l36.400"></a><span id="l36.400" class="difflineplus">+  root.containerOpen = false;</span>
<a href="#l36.401"></a><span id="l36.401" class="difflineplus">+}</span>
<a href="#l36.402"></a><span id="l36.402" class="difflineplus">+</span>
<a href="#l36.403"></a><span id="l36.403" class="difflineplus">+/**</span>
<a href="#l36.404"></a><span id="l36.404" class="difflineplus">+ * Creates an nsILocalFile in the profile directory.</span>
<a href="#l36.405"></a><span id="l36.405" class="difflineplus">+ *</span>
<a href="#l36.406"></a><span id="l36.406" class="difflineplus">+ * @param  aBasename</span>
<a href="#l36.407"></a><span id="l36.407" class="difflineplus">+ *         e.g., &quot;foo.txt&quot; in the path /some/long/path/foo.txt</span>
<a href="#l36.408"></a><span id="l36.408" class="difflineplus">+ * @return The nsILocalFile</span>
<a href="#l36.409"></a><span id="l36.409" class="difflineplus">+ */</span>
<a href="#l36.410"></a><span id="l36.410" class="difflineplus">+function createFile(aBasename) {</span>
<a href="#l36.411"></a><span id="l36.411" class="difflineplus">+  var file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsILocalFile);</span>
<a href="#l36.412"></a><span id="l36.412" class="difflineplus">+  file.append(aBasename);</span>
<a href="#l36.413"></a><span id="l36.413" class="difflineplus">+  if (file.exists())</span>
<a href="#l36.414"></a><span id="l36.414" class="difflineplus">+    file.remove(false);</span>
<a href="#l36.415"></a><span id="l36.415" class="difflineplus">+  file.create(file.NORMAL_FILE_TYPE, 0666);</span>
<a href="#l36.416"></a><span id="l36.416" class="difflineplus">+  if (!file.exists())</span>
<a href="#l36.417"></a><span id="l36.417" class="difflineplus">+    do_throw(&quot;Couldn't create file: &quot; + aBasename);</span>
<a href="#l36.418"></a><span id="l36.418" class="difflineplus">+  return file;</span>
<a href="#l36.419"></a><span id="l36.419" class="difflineplus">+}</span>
<a href="#l36.420"></a><span id="l36.420" class="difflineplus">+</span>
<a href="#l36.421"></a><span id="l36.421" class="difflineplus">+/**</span>
<a href="#l36.422"></a><span id="l36.422" class="difflineplus">+ * Runs the next test or if all tests have been run, finishes.</span>
<a href="#l36.423"></a><span id="l36.423" class="difflineplus">+ */</span>
<a href="#l36.424"></a><span id="l36.424" class="difflineplus">+function doNextTest() {</span>
<a href="#l36.425"></a><span id="l36.425" class="difflineplus">+  currTestIndex++;</span>
<a href="#l36.426"></a><span id="l36.426" class="difflineplus">+  if (currTestIndex &gt;= tests.length) {</span>
<a href="#l36.427"></a><span id="l36.427" class="difflineplus">+    obssvc.removeObserver(beginObserver, NSIOBSERVER_TOPIC_BEGIN);</span>
<a href="#l36.428"></a><span id="l36.428" class="difflineplus">+    obssvc.removeObserver(successAndFailedObserver, NSIOBSERVER_TOPIC_SUCCESS);</span>
<a href="#l36.429"></a><span id="l36.429" class="difflineplus">+    obssvc.removeObserver(successAndFailedObserver, NSIOBSERVER_TOPIC_FAILED);</span>
<a href="#l36.430"></a><span id="l36.430" class="difflineplus">+    do_test_finished();</span>
<a href="#l36.431"></a><span id="l36.431" class="difflineplus">+  }</span>
<a href="#l36.432"></a><span id="l36.432" class="difflineplus">+  else {</span>
<a href="#l36.433"></a><span id="l36.433" class="difflineplus">+    var test = tests[currTestIndex];</span>
<a href="#l36.434"></a><span id="l36.434" class="difflineplus">+    print(&quot;Running test: &quot; + test.desc);</span>
<a href="#l36.435"></a><span id="l36.435" class="difflineplus">+    test.run();</span>
<a href="#l36.436"></a><span id="l36.436" class="difflineplus">+  }</span>
<a href="#l36.437"></a><span id="l36.437" class="difflineplus">+}</span>
<a href="#l36.438"></a><span id="l36.438" class="difflineplus">+</span>
<a href="#l36.439"></a><span id="l36.439" class="difflineplus">+///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.440"></a><span id="l36.440" class="difflineplus">+</span>
<a href="#l36.441"></a><span id="l36.441" class="difflineplus">+function run_test() {</span>
<a href="#l36.442"></a><span id="l36.442" class="difflineplus">+  do_test_pending();</span>
<a href="#l36.443"></a><span id="l36.443" class="difflineplus">+  obssvc.addObserver(beginObserver, NSIOBSERVER_TOPIC_BEGIN, false);</span>
<a href="#l36.444"></a><span id="l36.444" class="difflineplus">+  obssvc.addObserver(successAndFailedObserver, NSIOBSERVER_TOPIC_SUCCESS, false);</span>
<a href="#l36.445"></a><span id="l36.445" class="difflineplus">+  obssvc.addObserver(successAndFailedObserver, NSIOBSERVER_TOPIC_FAILED, false);</span>
<a href="#l36.446"></a><span id="l36.446" class="difflineplus">+  doNextTest();</span>
<a href="#l36.447"></a><span id="l36.447" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">new file mode 100644</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineminus">--- /dev/null</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_bookmarks_html.js</span>
<a href="#l37.4"></a><span id="l37.4" class="difflineat">@@ -0,0 +1,324 @@</span>
<a href="#l37.5"></a><span id="l37.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l37.6"></a><span id="l37.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l37.7"></a><span id="l37.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l37.8"></a><span id="l37.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l37.9"></a><span id="l37.9" class="difflineplus">+ *</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+ *</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+ * License.</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineplus">+ *</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineplus">+ * The Original Code is mozilla.com code.</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineplus">+ *</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+ *</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+ *  Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineplus">+ *</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineplus">+ *</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineplus">+// get history service</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+try {</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineplus">+  var histsvc = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].getService(Ci.nsINavHistoryService);</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineplus">+} catch(ex) {</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineplus">+  do_throw(&quot;Could not get nav-history-service\n&quot;);</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+}</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineplus">+// Get bookmark service</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+try {</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+  var bmsvc = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].getService(Ci.nsINavBookmarksService);</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineplus">+} catch(ex) {</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineplus">+  do_throw(&quot;Could not get nav-bookmarks-service\n&quot;);</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+}</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineplus">+</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineplus">+// Get annotation service</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineplus">+try {</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineplus">+  var annosvc = Cc[&quot;@mozilla.org/browser/annotation-service;1&quot;].getService(Ci.nsIAnnotationService);</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineplus">+} catch(ex) {</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineplus">+  do_throw(&quot;Could not get annotation service\n&quot;);</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineplus">+} </span>
<a href="#l37.63"></a><span id="l37.63" class="difflineplus">+</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineplus">+// Get livemark service</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineplus">+try {</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineplus">+  var livemarksvc = Cc[&quot;@mozilla.org/browser/livemark-service;2&quot;].getService(Ci.nsILivemarkService);</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineplus">+} catch(ex) {</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineplus">+  do_throw(&quot;Could not get livemark service\n&quot;);</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineplus">+} </span>
<a href="#l37.70"></a><span id="l37.70" class="difflineplus">+</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineplus">+// Get favicon service</span>
<a href="#l37.72"></a><span id="l37.72" class="difflineplus">+try {</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineplus">+  var iconsvc = Cc[&quot;@mozilla.org/browser/favicon-service;1&quot;].getService(Ci.nsIFaviconService);</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineplus">+} catch(ex) {</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineplus">+  do_throw(&quot;Could not get favicon service\n&quot;);</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineplus">+} </span>
<a href="#l37.77"></a><span id="l37.77" class="difflineplus">+</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineplus">+// Get microsummary service</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineplus">+try {</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineplus">+  var mssvc = Cc[&quot;@mozilla.org/microsummary/service;1&quot;].getService(Ci.nsIMicrosummaryService);</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineplus">+} catch(ex) {</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineplus">+  do_throw(&quot;Could not get microsummary service\n&quot;);</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineplus">+}</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineplus">+</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineplus">+// Get io service</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineplus">+try {</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineplus">+  var iosvc = Cc[&quot;@mozilla.org/network/io-service;1&quot;].getService(Ci.nsIIOService);</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineplus">+} catch (ex) {</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineplus">+  do_throw(&quot;Could not get io service\n&quot;);</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineplus">+}</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineplus">+</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineplus">+const DESCRIPTION_ANNO = &quot;bookmarkProperties/description&quot;;</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineplus">+const LOAD_IN_SIDEBAR_ANNO = &quot;bookmarkProperties/loadInSidebar&quot;;</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineplus">+const POST_DATA_ANNO = &quot;bookmarkProperties/POSTData&quot;;</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineplus">+</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineplus">+const TEST_FAVICON_PAGE_URL = &quot;http://www.seamonkey-project.org/&quot;;</span>
<a href="#l37.97"></a><span id="l37.97" class="difflineplus">+const TEST_FAVICON_DATA_URL = &quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH1QwCEiUG/+wAegAAAu5JREFUOMtlk01oXFUUx3/3vfte3kydmeeQJgUTMsEaKX40tREbDHYE6UIXnZVUujCIiu3GKl0EXRh3ol1EF8WutItuuum4sRTRRXFRFGUyRPxIyVe1mK+ZZD46d968e6+LSduoFw7/c+D+Dv8D5wj+984NDQ4mz6TT/iiAMWCMRanO1urqnaJSZy/u/i12F2H46Qe5XGo6DAOMscSxQWuL1t08imI2NlRpba05CVOz/2qQSJx7+/DhfTPAPUhrQxwbJl54mHemJnCkg20pxh67sFStqlGY2pZd/OOjIyPZmTi+D91t0N+/h/enn2NuFW78aXm6dRvfd3NBIItK8bwEGB5Oz3iei1IxWpt7lrW2vPjKKKoDv65bMr5m4kiOvr4kjUaUh0+OO/DRwSBwR5WKabc1Smnu5zGFwgjfLsIv69CKDL+vG44dGyaKNK5rJ+XAQCqfTifY3Gzumrurp04dom0dlrag3gZtBc2OIZPpIZVK0tubycuxsSfD44VnsQaMBbsTxsDBIx3O/2hRsSAbWFwBf21b8vmn6N83zvz8SijL5YhGo47rguOC0YZsVjI+nuAP7RNpCANLpREzkBYMZly+vhxRLivq9Ri5vLxdqlQaaA1as2MfTp7u4fqGS0dbDvVp6hlBJrD0bFkuXarheaBUpSS1Xii1WvsxJovWXfufnX+QK5uSB3xN0tGkfIdHeyFahddfqxIEAs+DZvPv0s4iXf1CiCcmoQvf2Bvw8oEYAazUBM/sFfz8XZsLnzdRyiKlwJg15uau5XYWafYMpAvvvvd4OD+U4PRDMeYO3F7QbP7W4c1ii1YLPA+CQCBExK1b5Wk4uywArLVDxZ+aX6qeZD5ZiXjrRAXP69qUsqueJ5ASoqjC4uIP07Xaqx8CONbaK9+v2KUDuT3sV2uFky99U3TdJkEgCAJBItFVKSNqtYWlmzevT96FAYS19iiwJYSY3X3S2ewjBd8PQinBcaBaXSnV62989d/j/wcgGYelT45hgQAAAABJRU5ErkJggg==&quot;;</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineplus">+</span>
<a href="#l37.99"></a><span id="l37.99" class="difflineplus">+// main</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineplus">+function run_test() {</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineplus">+  // get places import/export service</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineplus">+  var importer = Cc[&quot;@mozilla.org/browser/places/import-export-service;1&quot;].getService(Ci.nsIPlacesImportExportService);</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineplus">+</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineplus">+  // avoid creating the places smart folder during tests</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineplus">+  Cc[&quot;@mozilla.org/preferences-service;1&quot;].getService(Ci.nsIPrefBranch).</span>
<a href="#l37.106"></a><span id="l37.106" class="difflineplus">+  setIntPref(&quot;browser.places.smartBookmarksVersion&quot;, -1);</span>
<a href="#l37.107"></a><span id="l37.107" class="difflineplus">+</span>
<a href="#l37.108"></a><span id="l37.108" class="difflineplus">+  // file pointer to legacy bookmarks file</span>
<a href="#l37.109"></a><span id="l37.109" class="difflineplus">+  var bookmarksFileOld = do_get_file(&quot;bookmarks.preplaces.html&quot;);</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineplus">+  // file pointer to a new places-exported bookmarks file</span>
<a href="#l37.111"></a><span id="l37.111" class="difflineplus">+  var bookmarksFileNew = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsILocalFile);</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineplus">+  bookmarksFileNew.append(&quot;bookmarks.exported.html&quot;);</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineplus">+</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineplus">+  // create bookmarks.exported.html</span>
<a href="#l37.115"></a><span id="l37.115" class="difflineplus">+  if (bookmarksFileNew.exists())</span>
<a href="#l37.116"></a><span id="l37.116" class="difflineplus">+    bookmarksFileNew.remove(false);</span>
<a href="#l37.117"></a><span id="l37.117" class="difflineplus">+  bookmarksFileNew.create(Ci.nsILocalFile.NORMAL_FILE_TYPE, 0600);</span>
<a href="#l37.118"></a><span id="l37.118" class="difflineplus">+  if (!bookmarksFileNew.exists())</span>
<a href="#l37.119"></a><span id="l37.119" class="difflineplus">+    do_throw(&quot;couldn't create file: bookmarks.exported.html&quot;);</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineplus">+</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineplus">+  // Test importing a pre-Places canonical bookmarks file.</span>
<a href="#l37.122"></a><span id="l37.122" class="difflineplus">+  // 1. import bookmarks.preplaces.html</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineplus">+  // 2. run the test-suite</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineplus">+  // Note: we do not empty the db before this import to catch bugs like 380999</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineplus">+  try {</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineplus">+    importer.importHTMLFromFile(bookmarksFileOld, true);</span>
<a href="#l37.127"></a><span id="l37.127" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import legacy bookmarks file: &quot; + ex); }</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineplus">+  testCanonicalBookmarks(bmsvc.bookmarksMenuFolder);</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineplus">+</span>
<a href="#l37.130"></a><span id="l37.130" class="difflineplus">+  // Test exporting a Places canonical bookmarks file.</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineplus">+  // 1. export to bookmarks.exported.html</span>
<a href="#l37.132"></a><span id="l37.132" class="difflineplus">+  // 2. empty bookmarks db</span>
<a href="#l37.133"></a><span id="l37.133" class="difflineplus">+  // 3. import bookmarks.exported.html</span>
<a href="#l37.134"></a><span id="l37.134" class="difflineplus">+  // 4. run the test-suite</span>
<a href="#l37.135"></a><span id="l37.135" class="difflineplus">+  try {</span>
<a href="#l37.136"></a><span id="l37.136" class="difflineplus">+    importer.exportHTMLToFile(bookmarksFileNew);</span>
<a href="#l37.137"></a><span id="l37.137" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l37.138"></a><span id="l37.138" class="difflineplus">+  bmsvc.removeFolderChildren(bmsvc.bookmarksMenuFolder);</span>
<a href="#l37.139"></a><span id="l37.139" class="difflineplus">+  bmsvc.removeFolderChildren(bmsvc.toolbarFolder);</span>
<a href="#l37.140"></a><span id="l37.140" class="difflineplus">+  try {</span>
<a href="#l37.141"></a><span id="l37.141" class="difflineplus">+    importer.importHTMLFromFile(bookmarksFileNew, true);</span>
<a href="#l37.142"></a><span id="l37.142" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l37.143"></a><span id="l37.143" class="difflineplus">+  testCanonicalBookmarks(bmsvc.bookmarksMenuFolder);</span>
<a href="#l37.144"></a><span id="l37.144" class="difflineplus">+</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineplus">+  /*</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineplus">+  // XXX import-to-folder tests disabled due to bug 363634</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineplus">+  // Test importing a pre-Places canonical bookmarks file to a specific folder.</span>
<a href="#l37.148"></a><span id="l37.148" class="difflineplus">+  // 1. create a new folder</span>
<a href="#l37.149"></a><span id="l37.149" class="difflineplus">+  // 2. import bookmarks.preplaces.html to that folder</span>
<a href="#l37.150"></a><span id="l37.150" class="difflineplus">+  // 3. run the test-suite</span>
<a href="#l37.151"></a><span id="l37.151" class="difflineplus">+  var testFolder = bmsvc.createFolder(bmsvc.bookmarksMenuFolder, &quot;test-import&quot;, bmsvc.DEFAULT_INDEX);</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineplus">+  try {</span>
<a href="#l37.153"></a><span id="l37.153" class="difflineplus">+    importer.importHTMLFromFileToFolder(bookmarksFileOld, testFolder, false);</span>
<a href="#l37.154"></a><span id="l37.154" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import the exported file to folder: &quot; + ex); }</span>
<a href="#l37.155"></a><span id="l37.155" class="difflineplus">+  testCanonicalBookmarks(testFolder);</span>
<a href="#l37.156"></a><span id="l37.156" class="difflineplus">+  bmsvc.removeFolder(testFolder);</span>
<a href="#l37.157"></a><span id="l37.157" class="difflineplus">+</span>
<a href="#l37.158"></a><span id="l37.158" class="difflineplus">+  // Test importing a Places canonical bookmarks file to a specific folder.</span>
<a href="#l37.159"></a><span id="l37.159" class="difflineplus">+  // 1. create a new folder</span>
<a href="#l37.160"></a><span id="l37.160" class="difflineplus">+  // 2. import bookmarks.exported.html to that folder</span>
<a href="#l37.161"></a><span id="l37.161" class="difflineplus">+  // 3. run the test-suite</span>
<a href="#l37.162"></a><span id="l37.162" class="difflineplus">+  var testFolder = bmsvc.createFolder(bmsvc.bookmarksMenuFolder, &quot;test-import&quot;, bmsvc.DEFAULT_INDEX);</span>
<a href="#l37.163"></a><span id="l37.163" class="difflineplus">+  try {</span>
<a href="#l37.164"></a><span id="l37.164" class="difflineplus">+    importer.importHTMLFromFileToFolder(bookmarksFileNew, testFolder, false);</span>
<a href="#l37.165"></a><span id="l37.165" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import the exported file to folder: &quot; + ex); }</span>
<a href="#l37.166"></a><span id="l37.166" class="difflineplus">+  testCanonicalBookmarks(testFolder); </span>
<a href="#l37.167"></a><span id="l37.167" class="difflineplus">+  bmsvc.removeFolder(testFolder);</span>
<a href="#l37.168"></a><span id="l37.168" class="difflineplus">+</span>
<a href="#l37.169"></a><span id="l37.169" class="difflineplus">+  // XXX Disabled due to bug 381129 - separators will be duplicated on re-import</span>
<a href="#l37.170"></a><span id="l37.170" class="difflineplus">+  // Test importing the exported bookmarks.html file *on top of* the existing</span>
<a href="#l37.171"></a><span id="l37.171" class="difflineplus">+  // bookmarks. This tests import of IDs. If we support IDs correctly, there</span>
<a href="#l37.172"></a><span id="l37.172" class="difflineplus">+  // should be no difference after the import.</span>
<a href="#l37.173"></a><span id="l37.173" class="difflineplus">+  // 1. empty bookmarks db</span>
<a href="#l37.174"></a><span id="l37.174" class="difflineplus">+  // 2. import the exported bookmarks file</span>
<a href="#l37.175"></a><span id="l37.175" class="difflineplus">+  // 3. export to file</span>
<a href="#l37.176"></a><span id="l37.176" class="difflineplus">+  // 3. import the exported bookmarks file</span>
<a href="#l37.177"></a><span id="l37.177" class="difflineplus">+  // 4. run the test-suite</span>
<a href="#l37.178"></a><span id="l37.178" class="difflineplus">+  bmsvc.removeFolderChildren(bmsvc.bookmarksMenuFolder);</span>
<a href="#l37.179"></a><span id="l37.179" class="difflineplus">+  try {</span>
<a href="#l37.180"></a><span id="l37.180" class="difflineplus">+    importer.importHTMLFromFile(bookmarksFileNew, true);</span>
<a href="#l37.181"></a><span id="l37.181" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l37.182"></a><span id="l37.182" class="difflineplus">+  try {</span>
<a href="#l37.183"></a><span id="l37.183" class="difflineplus">+    importer.exportHTMLToFile(bookmarksFileNew);</span>
<a href="#l37.184"></a><span id="l37.184" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l37.185"></a><span id="l37.185" class="difflineplus">+  try {</span>
<a href="#l37.186"></a><span id="l37.186" class="difflineplus">+    importer.importHTMLFromFile(bookmarksFileNew, true);</span>
<a href="#l37.187"></a><span id="l37.187" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l37.188"></a><span id="l37.188" class="difflineplus">+  testCanonicalBookmarks(bmsvc.bookmarksMenuFolder);</span>
<a href="#l37.189"></a><span id="l37.189" class="difflineplus">+  */</span>
<a href="#l37.190"></a><span id="l37.190" class="difflineplus">+  /*</span>
<a href="#l37.191"></a><span id="l37.191" class="difflineplus">+  XXX if there are new fields we add to the bookmarks HTML format</span>
<a href="#l37.192"></a><span id="l37.192" class="difflineplus">+  then test them here</span>
<a href="#l37.193"></a><span id="l37.193" class="difflineplus">+  Test importing a Places canonical bookmarks file</span>
<a href="#l37.194"></a><span id="l37.194" class="difflineplus">+  1. empty the bookmarks datastore</span>
<a href="#l37.195"></a><span id="l37.195" class="difflineplus">+  2. import bookmarks.places.html</span>
<a href="#l37.196"></a><span id="l37.196" class="difflineplus">+  3. run the test-suite</span>
<a href="#l37.197"></a><span id="l37.197" class="difflineplus">+  4. run the additional-test-suite</span>
<a href="#l37.198"></a><span id="l37.198" class="difflineplus">+  */</span>
<a href="#l37.199"></a><span id="l37.199" class="difflineplus">+}</span>
<a href="#l37.200"></a><span id="l37.200" class="difflineplus">+</span>
<a href="#l37.201"></a><span id="l37.201" class="difflineplus">+// Tests a bookmarks datastore that has a set of bookmarks, etc</span>
<a href="#l37.202"></a><span id="l37.202" class="difflineplus">+// that flex each supported field and feature.</span>
<a href="#l37.203"></a><span id="l37.203" class="difflineplus">+function testCanonicalBookmarks(aFolder) {</span>
<a href="#l37.204"></a><span id="l37.204" class="difflineplus">+  // query to see if the deleted folder and items have been imported</span>
<a href="#l37.205"></a><span id="l37.205" class="difflineplus">+  var query = histsvc.getNewQuery();</span>
<a href="#l37.206"></a><span id="l37.206" class="difflineplus">+  query.setFolders([aFolder], 1);</span>
<a href="#l37.207"></a><span id="l37.207" class="difflineplus">+  var result = histsvc.executeQuery(query, histsvc.getNewQueryOptions());</span>
<a href="#l37.208"></a><span id="l37.208" class="difflineplus">+  var rootNode = result.root;</span>
<a href="#l37.209"></a><span id="l37.209" class="difflineplus">+  rootNode.containerOpen = true;</span>
<a href="#l37.210"></a><span id="l37.210" class="difflineplus">+</span>
<a href="#l37.211"></a><span id="l37.211" class="difflineplus">+  // 6-2: the toolbar folder and unfiled bookmarks folder imported to the</span>
<a href="#l37.212"></a><span id="l37.212" class="difflineplus">+  // corresponding places folders</span>
<a href="#l37.213"></a><span id="l37.213" class="difflineplus">+  do_check_eq(rootNode.childCount, DEFAULT_BOOKMARKS_ON_MENU + 1);</span>
<a href="#l37.214"></a><span id="l37.214" class="difflineplus">+</span>
<a href="#l37.215"></a><span id="l37.215" class="difflineplus">+  // get test folder</span>
<a href="#l37.216"></a><span id="l37.216" class="difflineplus">+  var testFolder = rootNode.getChild(DEFAULT_BOOKMARKS_ON_MENU);</span>
<a href="#l37.217"></a><span id="l37.217" class="difflineplus">+  do_check_eq(testFolder.type, testFolder.RESULT_TYPE_FOLDER);</span>
<a href="#l37.218"></a><span id="l37.218" class="difflineplus">+  do_check_eq(testFolder.title, &quot;test&quot;);</span>
<a href="#l37.219"></a><span id="l37.219" class="difflineplus">+</span>
<a href="#l37.220"></a><span id="l37.220" class="difflineplus">+  // add date </span>
<a href="#l37.221"></a><span id="l37.221" class="difflineplus">+  do_check_eq(bmsvc.getItemDateAdded(testFolder.itemId)/1000000, 1177541020);</span>
<a href="#l37.222"></a><span id="l37.222" class="difflineplus">+  // last modified</span>
<a href="#l37.223"></a><span id="l37.223" class="difflineplus">+  do_check_eq(bmsvc.getItemLastModified(testFolder.itemId)/1000000, 1177541050);</span>
<a href="#l37.224"></a><span id="l37.224" class="difflineplus">+</span>
<a href="#l37.225"></a><span id="l37.225" class="difflineplus">+  testFolder = testFolder.QueryInterface(Ci.nsINavHistoryQueryResultNode);</span>
<a href="#l37.226"></a><span id="l37.226" class="difflineplus">+  do_check_eq(testFolder.hasChildren, true);</span>
<a href="#l37.227"></a><span id="l37.227" class="difflineplus">+  // folder description</span>
<a href="#l37.228"></a><span id="l37.228" class="difflineplus">+  do_check_true(annosvc.itemHasAnnotation(testFolder.itemId,</span>
<a href="#l37.229"></a><span id="l37.229" class="difflineplus">+                                          DESCRIPTION_ANNO));</span>
<a href="#l37.230"></a><span id="l37.230" class="difflineplus">+  do_check_eq(&quot;folder test comment&quot;,</span>
<a href="#l37.231"></a><span id="l37.231" class="difflineplus">+              annosvc.getItemAnnotation(testFolder.itemId, DESCRIPTION_ANNO));</span>
<a href="#l37.232"></a><span id="l37.232" class="difflineplus">+  // open test folder, and test the children</span>
<a href="#l37.233"></a><span id="l37.233" class="difflineplus">+  testFolder.containerOpen = true;</span>
<a href="#l37.234"></a><span id="l37.234" class="difflineplus">+  var cc = testFolder.childCount;</span>
<a href="#l37.235"></a><span id="l37.235" class="difflineplus">+  // XXX Bug 380468</span>
<a href="#l37.236"></a><span id="l37.236" class="difflineplus">+  // do_check_eq(cc, 2);</span>
<a href="#l37.237"></a><span id="l37.237" class="difflineplus">+  do_check_eq(cc, 1);</span>
<a href="#l37.238"></a><span id="l37.238" class="difflineplus">+</span>
<a href="#l37.239"></a><span id="l37.239" class="difflineplus">+  // test bookmark 1</span>
<a href="#l37.240"></a><span id="l37.240" class="difflineplus">+  var testBookmark1 = testFolder.getChild(0);</span>
<a href="#l37.241"></a><span id="l37.241" class="difflineplus">+  // url</span>
<a href="#l37.242"></a><span id="l37.242" class="difflineplus">+  do_check_eq(&quot;http://test/post&quot;, testBookmark1.uri);</span>
<a href="#l37.243"></a><span id="l37.243" class="difflineplus">+  // title</span>
<a href="#l37.244"></a><span id="l37.244" class="difflineplus">+  do_check_eq(&quot;test post keyword&quot;, testBookmark1.title);</span>
<a href="#l37.245"></a><span id="l37.245" class="difflineplus">+  // keyword</span>
<a href="#l37.246"></a><span id="l37.246" class="difflineplus">+  do_check_eq(&quot;test&quot;, bmsvc.getKeywordForBookmark(testBookmark1.itemId));</span>
<a href="#l37.247"></a><span id="l37.247" class="difflineplus">+  // sidebar</span>
<a href="#l37.248"></a><span id="l37.248" class="difflineplus">+  do_check_true(annosvc.itemHasAnnotation(testBookmark1.itemId,</span>
<a href="#l37.249"></a><span id="l37.249" class="difflineplus">+                                          LOAD_IN_SIDEBAR_ANNO));</span>
<a href="#l37.250"></a><span id="l37.250" class="difflineplus">+  // add date </span>
<a href="#l37.251"></a><span id="l37.251" class="difflineplus">+  do_check_eq(testBookmark1.dateAdded/1000000, 1177375336);</span>
<a href="#l37.252"></a><span id="l37.252" class="difflineplus">+</span>
<a href="#l37.253"></a><span id="l37.253" class="difflineplus">+  // last modified</span>
<a href="#l37.254"></a><span id="l37.254" class="difflineplus">+  do_check_eq(testBookmark1.lastModified/1000000, 1177375423);</span>
<a href="#l37.255"></a><span id="l37.255" class="difflineplus">+</span>
<a href="#l37.256"></a><span id="l37.256" class="difflineplus">+  // post data</span>
<a href="#l37.257"></a><span id="l37.257" class="difflineplus">+  do_check_true(annosvc.itemHasAnnotation(testBookmark1.itemId,</span>
<a href="#l37.258"></a><span id="l37.258" class="difflineplus">+                                          POST_DATA_ANNO));</span>
<a href="#l37.259"></a><span id="l37.259" class="difflineplus">+  do_check_eq(&quot;hidden1%3Dbar&amp;text1%3D%25s&quot;,</span>
<a href="#l37.260"></a><span id="l37.260" class="difflineplus">+              annosvc.getItemAnnotation(testBookmark1.itemId, POST_DATA_ANNO));</span>
<a href="#l37.261"></a><span id="l37.261" class="difflineplus">+</span>
<a href="#l37.262"></a><span id="l37.262" class="difflineplus">+  // last charset</span>
<a href="#l37.263"></a><span id="l37.263" class="difflineplus">+  var testURI = uri(testBookmark1.uri);</span>
<a href="#l37.264"></a><span id="l37.264" class="difflineplus">+  do_check_eq(&quot;ISO-8859-1&quot;, histsvc.getCharsetForURI(testURI));</span>
<a href="#l37.265"></a><span id="l37.265" class="difflineplus">+</span>
<a href="#l37.266"></a><span id="l37.266" class="difflineplus">+  // description</span>
<a href="#l37.267"></a><span id="l37.267" class="difflineplus">+  do_check_true(annosvc.itemHasAnnotation(testBookmark1.itemId,</span>
<a href="#l37.268"></a><span id="l37.268" class="difflineplus">+                                          DESCRIPTION_ANNO));</span>
<a href="#l37.269"></a><span id="l37.269" class="difflineplus">+  do_check_eq(&quot;item description&quot;,</span>
<a href="#l37.270"></a><span id="l37.270" class="difflineplus">+              annosvc.getItemAnnotation(testBookmark1.itemId,</span>
<a href="#l37.271"></a><span id="l37.271" class="difflineplus">+                                        DESCRIPTION_ANNO));</span>
<a href="#l37.272"></a><span id="l37.272" class="difflineplus">+</span>
<a href="#l37.273"></a><span id="l37.273" class="difflineplus">+  /*</span>
<a href="#l37.274"></a><span id="l37.274" class="difflineplus">+  // XXX Bug 380468</span>
<a href="#l37.275"></a><span id="l37.275" class="difflineplus">+  // test bookmark 2</span>
<a href="#l37.276"></a><span id="l37.276" class="difflineplus">+  var testBookmark2 = testFolder.getChild(1);</span>
<a href="#l37.277"></a><span id="l37.277" class="difflineplus">+  // url</span>
<a href="#l37.278"></a><span id="l37.278" class="difflineplus">+  do_check_eq(&quot;http://test/micsum&quot;, testBookmark2.uri);</span>
<a href="#l37.279"></a><span id="l37.279" class="difflineplus">+  // title</span>
<a href="#l37.280"></a><span id="l37.280" class="difflineplus">+  do_check_eq(&quot;test microsummary&quot;, testBookmark2.title);</span>
<a href="#l37.281"></a><span id="l37.281" class="difflineplus">+  // check that it's a microsummary</span>
<a href="#l37.282"></a><span id="l37.282" class="difflineplus">+  var micsum = mssvc.getMicrosummary(testBookmark2.itemId);</span>
<a href="#l37.283"></a><span id="l37.283" class="difflineplus">+  if (!micsum)</span>
<a href="#l37.284"></a><span id="l37.284" class="difflineplus">+    do_throw(&quot;Could not import microsummary&quot;);</span>
<a href="#l37.285"></a><span id="l37.285" class="difflineplus">+  // check generator uri</span>
<a href="#l37.286"></a><span id="l37.286" class="difflineplus">+  var generator = micsum.generator;</span>
<a href="#l37.287"></a><span id="l37.287" class="difflineplus">+  do_check_eq(&quot;urn:source:http://dietrich.ganx4.com/mozilla/test-microsummary.xml&quot;, generator.uri.spec);</span>
<a href="#l37.288"></a><span id="l37.288" class="difflineplus">+  // expiration and generated title can change, so don't test them</span>
<a href="#l37.289"></a><span id="l37.289" class="difflineplus">+  */</span>
<a href="#l37.290"></a><span id="l37.290" class="difflineplus">+  // clean up</span>
<a href="#l37.291"></a><span id="l37.291" class="difflineplus">+  testFolder.containerOpen = false;</span>
<a href="#l37.292"></a><span id="l37.292" class="difflineplus">+  rootNode.containerOpen = false;</span>
<a href="#l37.293"></a><span id="l37.293" class="difflineplus">+</span>
<a href="#l37.294"></a><span id="l37.294" class="difflineplus">+  query.setFolders([bmsvc.toolbarFolder], 1);</span>
<a href="#l37.295"></a><span id="l37.295" class="difflineplus">+  result = histsvc.executeQuery(query, histsvc.getNewQueryOptions());</span>
<a href="#l37.296"></a><span id="l37.296" class="difflineplus">+  // bookmarks toolbar</span>
<a href="#l37.297"></a><span id="l37.297" class="difflineplus">+  var toolbar = result.root;</span>
<a href="#l37.298"></a><span id="l37.298" class="difflineplus">+  toolbar.containerOpen = true;</span>
<a href="#l37.299"></a><span id="l37.299" class="difflineplus">+  do_check_eq(toolbar.childCount, DEFAULT_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l37.300"></a><span id="l37.300" class="difflineplus">+  </span>
<a href="#l37.301"></a><span id="l37.301" class="difflineplus">+  // livemark</span>
<a href="#l37.302"></a><span id="l37.302" class="difflineplus">+  var livemark = toolbar.getChild(DEFAULT_BOOKMARKS_ON_TOOLBAR - 1);</span>
<a href="#l37.303"></a><span id="l37.303" class="difflineplus">+  // title</span>
<a href="#l37.304"></a><span id="l37.304" class="difflineplus">+  do_check_eq(&quot;Latest Headlines&quot;, livemark.title);</span>
<a href="#l37.305"></a><span id="l37.305" class="difflineplus">+  // livemark check</span>
<a href="#l37.306"></a><span id="l37.306" class="difflineplus">+  do_check_true(livemarksvc.isLivemark(livemark.itemId));</span>
<a href="#l37.307"></a><span id="l37.307" class="difflineplus">+  // site url</span>
<a href="#l37.308"></a><span id="l37.308" class="difflineplus">+  do_check_eq(&quot;http://en-us.fxfeeds.mozilla.com/en-US/firefox/livebookmarks/&quot;,</span>
<a href="#l37.309"></a><span id="l37.309" class="difflineplus">+              livemarksvc.getSiteURI(livemark.itemId).spec);</span>
<a href="#l37.310"></a><span id="l37.310" class="difflineplus">+  // feed url</span>
<a href="#l37.311"></a><span id="l37.311" class="difflineplus">+  do_check_eq(&quot;http://en-us.fxfeeds.mozilla.com/en-US/firefox/headlines.xml&quot;,</span>
<a href="#l37.312"></a><span id="l37.312" class="difflineplus">+              livemarksvc.getFeedURI(livemark.itemId).spec);</span>
<a href="#l37.313"></a><span id="l37.313" class="difflineplus">+</span>
<a href="#l37.314"></a><span id="l37.314" class="difflineplus">+  toolbar.containerOpen = false;</span>
<a href="#l37.315"></a><span id="l37.315" class="difflineplus">+  </span>
<a href="#l37.316"></a><span id="l37.316" class="difflineplus">+  // unfiled bookmarks</span>
<a href="#l37.317"></a><span id="l37.317" class="difflineplus">+  query.setFolders([bmsvc.unfiledBookmarksFolder], 1);</span>
<a href="#l37.318"></a><span id="l37.318" class="difflineplus">+  result = histsvc.executeQuery(query, histsvc.getNewQueryOptions());</span>
<a href="#l37.319"></a><span id="l37.319" class="difflineplus">+  var unfiledBookmarks = result.root;</span>
<a href="#l37.320"></a><span id="l37.320" class="difflineplus">+  unfiledBookmarks.containerOpen = true;</span>
<a href="#l37.321"></a><span id="l37.321" class="difflineplus">+  do_check_eq(unfiledBookmarks.childCount, 1);</span>
<a href="#l37.322"></a><span id="l37.322" class="difflineplus">+  unfiledBookmarks.containerOpen = false;</span>
<a href="#l37.323"></a><span id="l37.323" class="difflineplus">+</span>
<a href="#l37.324"></a><span id="l37.324" class="difflineplus">+  // favicons</span>
<a href="#l37.325"></a><span id="l37.325" class="difflineplus">+  var faviconURI = iconsvc.getFaviconForPage(uri(TEST_FAVICON_PAGE_URL));</span>
<a href="#l37.326"></a><span id="l37.326" class="difflineplus">+  var dataURL = iconsvc.getFaviconDataAsDataURL(faviconURI);</span>
<a href="#l37.327"></a><span id="l37.327" class="difflineplus">+  do_check_eq(TEST_FAVICON_DATA_URL, dataURL);</span>
<a href="#l37.328"></a><span id="l37.328" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">new file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- /dev/null</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_browserGlue_corrupt.js</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -0,0 +1,118 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineplus">+ *</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+ *</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+ * License.</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+ *</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+ * The Original Code is Places Unit Test code.</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+ *</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineplus">+ *</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+ *</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineplus">+ *</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+/**</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+ * Tests that nsSuiteGlue correctly restores bookmarks from a JSON backup if</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+ * database is corrupt and one backup is available.</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineplus">+ */</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineplus">+</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;bs&quot;,</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+                                   &quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;,</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+                                   &quot;nsINavBookmarksService&quot;);</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;anno&quot;,</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+                                   &quot;@mozilla.org/browser/annotation-service;1&quot;,</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+                                   &quot;nsIAnnotationService&quot;);</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+let bookmarksObserver = {</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+  onBeginUpdateBatch: function() {},</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineplus">+  onEndUpdateBatch: function() {</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineplus">+    let itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineplus">+    do_check_neq(itemId, -1);</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineplus">+    if (anno.itemHasAnnotation(itemId, &quot;Places/SmartBookmark&quot;))</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineplus">+      continue_test();</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineplus">+  },</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineplus">+  onItemAdded: function() {},</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineplus">+  onBeforeItemRemoved: function(id) {},</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineplus">+  onItemRemoved: function(id, folder, index, itemType) {},</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineplus">+  onItemChanged: function() {},</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineplus">+  onItemVisited: function(id, visitID, time) {},</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineplus">+  onItemMoved: function() {},</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsINavBookmarkObserver])</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineplus">+};</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineplus">+function run_test() {</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+  do_test_pending();</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineplus">+</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+  // Create our bookmarks.html copying bookmarks.glue.html to the profile</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineplus">+  // folder.  It should be ignored.</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+  create_bookmarks_html(&quot;bookmarks.glue.html&quot;);</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineplus">+</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+  // Create our JSON backup copying bookmarks.glue.json to the profile folder.</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+  create_JSON_backup(&quot;bookmarks.glue.json&quot;);</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineplus">+</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineplus">+  // Remove current database file.</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineplus">+  let db = gProfD.clone();</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineplus">+  db.append(&quot;places.sqlite&quot;);</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineplus">+  if (db.exists()) {</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineplus">+    db.remove(false);</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineplus">+    do_check_false(db.exists());</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineplus">+  }</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineplus">+  // Create a corrupt database.</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineplus">+  let corruptDB = gTestDir.clone();</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineplus">+  corruptDB.append(&quot;corruptDB.sqlite&quot;);</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineplus">+  corruptDB.copyTo(gProfD, &quot;places.sqlite&quot;);</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineplus">+  do_check_true(db.exists());</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineplus">+</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineplus">+  // Initialize nsSuiteGlue before Places.</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineplus">+  Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].getService(Ci.nsISuiteGlue);</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineplus">+</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineplus">+  // Initialize Places through the History Service.</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineplus">+  let hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+           getService(Ci.nsINavHistoryService);</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineplus">+  // Check the database was corrupt.</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+  // nsSuiteGlue uses databaseStatus to manage initialization.</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+  do_check_eq(hs.databaseStatus, hs.DATABASE_STATUS_CORRUPT);</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineplus">+</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+  // The test will continue once restore has finished and smart bookmarks</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+  // have been created.</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineplus">+  bs.addObserver(bookmarksObserver, false);</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineplus">+}</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineplus">+</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineplus">+function continue_test() {</span>
<a href="#l38.113"></a><span id="l38.113" class="difflineplus">+  // Check that JSON backup has been restored.</span>
<a href="#l38.114"></a><span id="l38.114" class="difflineplus">+  // Notice restore from JSON notification is fired before smart bookmarks creation.</span>
<a href="#l38.115"></a><span id="l38.115" class="difflineplus">+  let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l38.116"></a><span id="l38.116" class="difflineplus">+  do_check_eq(bs.getItemTitle(itemId), &quot;examplejson&quot;);</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineplus">+</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineplus">+  remove_bookmarks_html();</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineplus">+  remove_all_JSON_backups();</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineplus">+</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineplus">+  do_test_finished();</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">new file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineminus">--- /dev/null</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup.js</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineat">@@ -0,0 +1,114 @@</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineplus">+ *</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+ *</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+ * License.</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineplus">+ *</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineplus">+ * The Original Code is Places Unit Test code.</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineplus">+ *</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineplus">+ *</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+ *</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineplus">+ *</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineplus">+</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineplus">+/**</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineplus">+ * Tests that nsSuiteGlue correctly imports from bookmarks.html if database</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineplus">+ * is corrupt but a JSON backup is not available.</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineplus">+ */</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineplus">+</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineplus">+</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;bs&quot;,</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineplus">+                                   &quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;,</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineplus">+                                   &quot;nsINavBookmarksService&quot;);</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;anno&quot;,</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineplus">+                                   &quot;@mozilla.org/browser/annotation-service;1&quot;,</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineplus">+                                   &quot;nsIAnnotationService&quot;);</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineplus">+</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineplus">+let bookmarksObserver = {</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineplus">+  onBeginUpdateBatch: function() {},</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineplus">+  onEndUpdateBatch: function() {</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineplus">+    let itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineplus">+    do_check_neq(itemId, -1);</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineplus">+    if (anno.itemHasAnnotation(itemId, &quot;Places/SmartBookmark&quot;))</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+      continue_test();</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+  },</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+  onItemAdded: function() {},</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineplus">+  onBeforeItemRemoved: function(id) {},</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineplus">+  onItemRemoved: function(id, folder, index, itemType) {},</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineplus">+  onItemChanged: function() {},</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineplus">+  onItemVisited: function(id, visitID, time) {},</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineplus">+  onItemMoved: function() {},</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsINavBookmarkObserver])</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineplus">+};</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineplus">+</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineplus">+function run_test() {</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineplus">+  do_test_pending();</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineplus">+</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineplus">+  // Create bookmarks.html in the profile.</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineplus">+  create_bookmarks_html(&quot;bookmarks.glue.html&quot;);</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineplus">+  // Remove JSON backup from profile.</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineplus">+  remove_all_JSON_backups();</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineplus">+</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineplus">+  // Remove current database file.</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineplus">+  let db = gProfD.clone();</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineplus">+  db.append(&quot;places.sqlite&quot;);</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineplus">+  if (db.exists()) {</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineplus">+    db.remove(false);</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineplus">+    do_check_false(db.exists());</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineplus">+  }</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineplus">+  // Create a corrupt database.</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineplus">+  let corruptDB = gTestDir.clone();</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineplus">+  corruptDB.append(&quot;corruptDB.sqlite&quot;);</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineplus">+  corruptDB.copyTo(gProfD, &quot;places.sqlite&quot;);</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineplus">+  do_check_true(db.exists());</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineplus">+</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineplus">+  // Initialize nsSuiteGlue before Places.</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineplus">+  Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].getService(Ci.nsISuiteGlue);</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineplus">+</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineplus">+  // Initialize Places through the History Service.</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineplus">+  let hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineplus">+           getService(Ci.nsINavHistoryService);</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineplus">+  // Check the database was corrupt.</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineplus">+  // nsSuiteGlue uses databaseStatus to manage initialization.</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineplus">+  do_check_eq(hs.databaseStatus, hs.DATABASE_STATUS_CORRUPT);</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineplus">+</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineplus">+  // The test will continue once import has finished and smart bookmarks</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineplus">+  // have been created.</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineplus">+  bs.addObserver(bookmarksObserver, false);</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineplus">+}</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineplus">+</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineplus">+function continue_test() {</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineplus">+  // Check that bookmarks html has been restored.</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineplus">+  let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineplus">+  do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineplus">+</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineplus">+  remove_bookmarks_html();</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineplus">+</span>
<a href="#l39.117"></a><span id="l39.117" class="difflineplus">+  do_test_finished();</span>
<a href="#l39.118"></a><span id="l39.118" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">new file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineminus">--- /dev/null</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_browserGlue_corrupt_nobackup_default.js</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineat">@@ -0,0 +1,113 @@</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l40.6"></a><span id="l40.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l40.8"></a><span id="l40.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineplus">+ *</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+ *</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineplus">+ * License.</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineplus">+ *</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineplus">+ * The Original Code is Places Unit Test code.</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineplus">+ *</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineplus">+ *</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineplus">+ *</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l40.39"></a><span id="l40.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l40.40"></a><span id="l40.40" class="difflineplus">+ *</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineplus">+</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineplus">+/**</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineplus">+ * Tests that nsSuiteGlue correctly restores default bookmarks if database is</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineplus">+ * corrupt, nor a JSON backup nor bookmarks.html are available.</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineplus">+ */</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineplus">+</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineplus">+</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;bs&quot;,</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineplus">+                                   &quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;,</span>
<a href="#l40.52"></a><span id="l40.52" class="difflineplus">+                                   &quot;nsINavBookmarksService&quot;);</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;anno&quot;,</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineplus">+                                   &quot;@mozilla.org/browser/annotation-service;1&quot;,</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineplus">+                                   &quot;nsIAnnotationService&quot;);</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineplus">+</span>
<a href="#l40.57"></a><span id="l40.57" class="difflineplus">+let bookmarksObserver = {</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineplus">+  onBeginUpdateBatch: function() {},</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineplus">+  onEndUpdateBatch: function() {</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineplus">+    let itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineplus">+    do_check_neq(itemId, -1);</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineplus">+    if (anno.itemHasAnnotation(itemId, &quot;Places/SmartBookmark&quot;))</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineplus">+      continue_test();</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineplus">+  },</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineplus">+  onItemAdded: function() {},</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineplus">+  onBeforeItemRemoved: function(id) {},</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineplus">+  onItemRemoved: function(id, folder, index, itemType) {},</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineplus">+  onItemChanged: function() {},</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineplus">+  onItemVisited: function(id, visitID, time) {},</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineplus">+  onItemMoved: function() {},</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsINavBookmarkObserver])</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineplus">+};</span>
<a href="#l40.73"></a><span id="l40.73" class="difflineplus">+</span>
<a href="#l40.74"></a><span id="l40.74" class="difflineplus">+function run_test() {</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineplus">+  do_test_pending();</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineplus">+</span>
<a href="#l40.77"></a><span id="l40.77" class="difflineplus">+  // Remove bookmarks.html from profile.</span>
<a href="#l40.78"></a><span id="l40.78" class="difflineplus">+  remove_bookmarks_html();</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineplus">+  // Remove JSON backup from profile.</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineplus">+  remove_all_JSON_backups();</span>
<a href="#l40.81"></a><span id="l40.81" class="difflineplus">+</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineplus">+  // Remove current database file.</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineplus">+  let db = gProfD.clone();</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineplus">+  db.append(&quot;places.sqlite&quot;);</span>
<a href="#l40.85"></a><span id="l40.85" class="difflineplus">+  if (db.exists()) {</span>
<a href="#l40.86"></a><span id="l40.86" class="difflineplus">+    db.remove(false);</span>
<a href="#l40.87"></a><span id="l40.87" class="difflineplus">+    do_check_false(db.exists());</span>
<a href="#l40.88"></a><span id="l40.88" class="difflineplus">+  }</span>
<a href="#l40.89"></a><span id="l40.89" class="difflineplus">+  // Create a corrupt database.</span>
<a href="#l40.90"></a><span id="l40.90" class="difflineplus">+  let corruptDB = gTestDir.clone();</span>
<a href="#l40.91"></a><span id="l40.91" class="difflineplus">+  corruptDB.append(&quot;corruptDB.sqlite&quot;);</span>
<a href="#l40.92"></a><span id="l40.92" class="difflineplus">+  corruptDB.copyTo(gProfD, &quot;places.sqlite&quot;);</span>
<a href="#l40.93"></a><span id="l40.93" class="difflineplus">+  do_check_true(db.exists());</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineplus">+</span>
<a href="#l40.95"></a><span id="l40.95" class="difflineplus">+  // Initialize nsSuiteGlue before Places.</span>
<a href="#l40.96"></a><span id="l40.96" class="difflineplus">+  Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].getService(Ci.nsISuiteGlue);</span>
<a href="#l40.97"></a><span id="l40.97" class="difflineplus">+</span>
<a href="#l40.98"></a><span id="l40.98" class="difflineplus">+  // Initialize Places through the History Service.</span>
<a href="#l40.99"></a><span id="l40.99" class="difflineplus">+  let hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l40.100"></a><span id="l40.100" class="difflineplus">+           getService(Ci.nsINavHistoryService);</span>
<a href="#l40.101"></a><span id="l40.101" class="difflineplus">+  // Check the database was corrupt.</span>
<a href="#l40.102"></a><span id="l40.102" class="difflineplus">+  // nsSuiteGlue uses databaseStatus to manage initialization.</span>
<a href="#l40.103"></a><span id="l40.103" class="difflineplus">+  do_check_eq(hs.databaseStatus, hs.DATABASE_STATUS_CORRUPT);</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineplus">+</span>
<a href="#l40.105"></a><span id="l40.105" class="difflineplus">+  // The test will continue once import has finished and smart bookmarks</span>
<a href="#l40.106"></a><span id="l40.106" class="difflineplus">+  // have been created.</span>
<a href="#l40.107"></a><span id="l40.107" class="difflineplus">+  bs.addObserver(bookmarksObserver, false);</span>
<a href="#l40.108"></a><span id="l40.108" class="difflineplus">+}</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineplus">+</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineplus">+function continue_test() {</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineplus">+  // Check that default bookmarks have been restored.</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineplus">+  let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineplus">+  do_check_true(itemId &gt; 0);</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineplus">+  do_check_eq(bs.getItemTitle(itemId), &quot;SeaMonkey&quot;);</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineplus">+</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineplus">+  do_test_finished();</span>
<a href="#l40.117"></a><span id="l40.117" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">new file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineminus">--- /dev/null</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_browserGlue_distribution.js</span>
<a href="#l41.4"></a><span id="l41.4" class="difflineat">@@ -0,0 +1,160 @@</span>
<a href="#l41.5"></a><span id="l41.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l41.6"></a><span id="l41.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineplus">+ *</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+ *</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineplus">+ * License.</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineplus">+ *</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineplus">+ * The Original Code is Places Unit Test code.</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineplus">+ *</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineplus">+ *</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineplus">+ *</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineplus">+ *</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineplus">+</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineplus">+/**</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineplus">+ * Tests that nsSuiteGlue does not overwrite bookmarks imported from the</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineplus">+ * migrators.  They usually run before nsSuiteGlue, so if we find any</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineplus">+ * bookmark on init, we should not try to import.</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineplus">+ */</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineplus">+</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineplus">+const PREF_SMART_BOOKMARKS_VERSION = &quot;browser.places.smartBookmarksVersion&quot;;</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineplus">+const PREF_BMPROCESSED = &quot;distribution.516444.bookmarksProcessed&quot;;</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineplus">+const PREF_DISTRIBUTION_ID = &quot;distribution.id&quot;;</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineplus">+</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineplus">+const TOPIC_FINAL_UI_STARTUP = &quot;final-ui-startup&quot;;</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineplus">+const TOPIC_CUSTOMIZATION_COMPLETE = &quot;distribution-customization-complete&quot;;</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineplus">+</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineplus">+function run_test() {</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineplus">+  // This is needed but we still have to investigate the reason, could just be</span>
<a href="#l41.58"></a><span id="l41.58" class="difflineplus">+  // we try to act too late in the game, moving our shutdown earlier will help.</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineplus">+  let hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineplus">+         getService(Ci.nsINavHistoryService);</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineplus">+  // TODO: re-enable when bug 523936 is fixed.</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineplus">+  return;</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineplus">+</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineplus">+  do_test_pending();</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineplus">+</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineplus">+  // Copy distribution.ini file to our app dir.</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineplus">+  let distroDir = Services.dirsvc.get(&quot;XCurProcD&quot;, Ci.nsIFile);</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineplus">+  distroDir.append(&quot;distribution&quot;);</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineplus">+  let iniFile = distroDir.clone();</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineplus">+  iniFile.append(&quot;distribution.ini&quot;);</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineplus">+  if (iniFile.exists()) {</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineplus">+    iniFile.remove(false);</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineplus">+    print(&quot;distribution.ini already exists, did some test forget to cleanup?&quot;);</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineplus">+  }</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineplus">+</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineplus">+  let testDistributionFile = gTestDir.clone();</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineplus">+  testDistributionFile.append(&quot;distribution.ini&quot;);</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineplus">+  testDistributionFile.copyTo(distroDir, &quot;distribution.ini&quot;);</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineplus">+  do_check_true(testDistributionFile.exists());</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineplus">+</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineplus">+  // Disable Smart Bookmarks creation.</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineplus">+  let ps = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineplus">+           getService(Ci.nsIPrefBranch);</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineplus">+  ps.setIntPref(PREF_SMART_BOOKMARKS_VERSION, -1);</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineplus">+  // Avoid migrateUI, we are just simulating a partial startup.</span>
<a href="#l41.86"></a><span id="l41.86" class="difflineplus">+  ps.setIntPref(&quot;browser.migration.version&quot;, 1);</span>
<a href="#l41.87"></a><span id="l41.87" class="difflineplus">+</span>
<a href="#l41.88"></a><span id="l41.88" class="difflineplus">+  // Initialize Places through the History Service.</span>
<a href="#l41.89"></a><span id="l41.89" class="difflineplus">+  let hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineplus">+           getService(Ci.nsINavHistoryService);</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineplus">+  // Check a new database has been created.</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineplus">+  // nsSuiteGlue will use databaseStatus to manage initialization.</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineplus">+  do_check_eq(hs.databaseStatus, hs.DATABASE_STATUS_CREATE);</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineplus">+</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineplus">+  // Initialize nsSuiteGlue.</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineplus">+  let bg = Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].</span>
<a href="#l41.97"></a><span id="l41.97" class="difflineplus">+           getService(Ci.nsISuiteGlue);</span>
<a href="#l41.98"></a><span id="l41.98" class="difflineplus">+</span>
<a href="#l41.99"></a><span id="l41.99" class="difflineplus">+  let os = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l41.100"></a><span id="l41.100" class="difflineplus">+           getService(Ci.nsIObserverService);</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineplus">+  let observer = {</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineplus">+    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineplus">+      os.removeObserver(this, PlacesUtils.TOPIC_INIT_COMPLETE);</span>
<a href="#l41.104"></a><span id="l41.104" class="difflineplus">+</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineplus">+      // Simulate browser startup.</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineplus">+      bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineplus">+                                                TOPIC_FINAL_UI_STARTUP,</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineplus">+                                                null);</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineplus">+      // Test will continue on customization complete notification.</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineplus">+      let cObserver = {</span>
<a href="#l41.111"></a><span id="l41.111" class="difflineplus">+        observe: function(aSubject, aTopic, aData) {</span>
<a href="#l41.112"></a><span id="l41.112" class="difflineplus">+          os.removeObserver(this, TOPIC_CUSTOMIZATION_COMPLETE);</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineplus">+          do_execute_soon(continue_test);</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineplus">+        }</span>
<a href="#l41.115"></a><span id="l41.115" class="difflineplus">+      }</span>
<a href="#l41.116"></a><span id="l41.116" class="difflineplus">+      os.addObserver(cObserver, TOPIC_CUSTOMIZATION_COMPLETE, false);</span>
<a href="#l41.117"></a><span id="l41.117" class="difflineplus">+    }</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineplus">+  }</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineplus">+  os.addObserver(observer, PlacesUtils.TOPIC_INIT_COMPLETE, false);</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineplus">+}</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineplus">+</span>
<a href="#l41.122"></a><span id="l41.122" class="difflineplus">+function continue_test() {</span>
<a href="#l41.123"></a><span id="l41.123" class="difflineplus">+  let bs = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l41.124"></a><span id="l41.124" class="difflineplus">+           getService(Ci.nsINavBookmarksService);</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineplus">+</span>
<a href="#l41.126"></a><span id="l41.126" class="difflineplus">+  dump_table(&quot;moz_bookmarks&quot;);</span>
<a href="#l41.127"></a><span id="l41.127" class="difflineplus">+</span>
<a href="#l41.128"></a><span id="l41.128" class="difflineplus">+  // Check the custom bookmarks exist on menu.</span>
<a href="#l41.129"></a><span id="l41.129" class="difflineplus">+  let menuItemId = bs.getIdForItemAt(bs.bookmarksMenuFolder, 0);</span>
<a href="#l41.130"></a><span id="l41.130" class="difflineplus">+  do_check_neq(menuItemId, -1);</span>
<a href="#l41.131"></a><span id="l41.131" class="difflineplus">+  do_check_eq(bs.getItemTitle(menuItemId), &quot;Menu Link Before&quot;);</span>
<a href="#l41.132"></a><span id="l41.132" class="difflineplus">+  menuItemId = bs.getIdForItemAt(bs.bookmarksMenuFolder, 1 + DEFAULT_BOOKMARKS_ON_MENU);</span>
<a href="#l41.133"></a><span id="l41.133" class="difflineplus">+  do_check_neq(menuItemId, -1);</span>
<a href="#l41.134"></a><span id="l41.134" class="difflineplus">+  do_check_eq(bs.getItemTitle(menuItemId), &quot;Menu Link After&quot;);</span>
<a href="#l41.135"></a><span id="l41.135" class="difflineplus">+</span>
<a href="#l41.136"></a><span id="l41.136" class="difflineplus">+  // Check the custom bookmarks exist on toolbar.</span>
<a href="#l41.137"></a><span id="l41.137" class="difflineplus">+  let toolbarItemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l41.138"></a><span id="l41.138" class="difflineplus">+  do_check_neq(toolbarItemId, -1);</span>
<a href="#l41.139"></a><span id="l41.139" class="difflineplus">+  do_check_eq(bs.getItemTitle(toolbarItemId), &quot;Toolbar Link Before&quot;);</span>
<a href="#l41.140"></a><span id="l41.140" class="difflineplus">+  toolbarItemId = bs.getIdForItemAt(bs.toolbarFolder, 1 + DEFAULT_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l41.141"></a><span id="l41.141" class="difflineplus">+  do_check_neq(toolbarItemId, -1);</span>
<a href="#l41.142"></a><span id="l41.142" class="difflineplus">+  do_check_eq(bs.getItemTitle(toolbarItemId), &quot;Toolbar Link After&quot;);</span>
<a href="#l41.143"></a><span id="l41.143" class="difflineplus">+</span>
<a href="#l41.144"></a><span id="l41.144" class="difflineplus">+  // Check the bmprocessed pref has been created.</span>
<a href="#l41.145"></a><span id="l41.145" class="difflineplus">+  let ps = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l41.146"></a><span id="l41.146" class="difflineplus">+           getService(Ci.nsIPrefBranch);</span>
<a href="#l41.147"></a><span id="l41.147" class="difflineplus">+  do_check_true(ps.getBoolPref(PREF_BMPROCESSED));</span>
<a href="#l41.148"></a><span id="l41.148" class="difflineplus">+</span>
<a href="#l41.149"></a><span id="l41.149" class="difflineplus">+  // Check distribution prefs have been created.</span>
<a href="#l41.150"></a><span id="l41.150" class="difflineplus">+  do_check_eq(ps.getCharPref(PREF_DISTRIBUTION_ID), &quot;516444&quot;);</span>
<a href="#l41.151"></a><span id="l41.151" class="difflineplus">+</span>
<a href="#l41.152"></a><span id="l41.152" class="difflineplus">+  do_test_finished();</span>
<a href="#l41.153"></a><span id="l41.153" class="difflineplus">+}</span>
<a href="#l41.154"></a><span id="l41.154" class="difflineplus">+</span>
<a href="#l41.155"></a><span id="l41.155" class="difflineplus">+do_register_cleanup(function() {</span>
<a href="#l41.156"></a><span id="l41.156" class="difflineplus">+  // Remove the distribution file, even if the test failed, otherwise all</span>
<a href="#l41.157"></a><span id="l41.157" class="difflineplus">+  // next tests will import it.</span>
<a href="#l41.158"></a><span id="l41.158" class="difflineplus">+  let iniFile = Services.dirsvc.get(&quot;XCurProcD&quot;, Ci.nsIFile);</span>
<a href="#l41.159"></a><span id="l41.159" class="difflineplus">+  iniFile.append(&quot;distribution&quot;);</span>
<a href="#l41.160"></a><span id="l41.160" class="difflineplus">+  iniFile.append(&quot;distribution.ini&quot;);</span>
<a href="#l41.161"></a><span id="l41.161" class="difflineplus">+  if (iniFile.exists())</span>
<a href="#l41.162"></a><span id="l41.162" class="difflineplus">+    iniFile.remove(false);</span>
<a href="#l41.163"></a><span id="l41.163" class="difflineplus">+  do_check_false(iniFile.exists());</span>
<a href="#l41.164"></a><span id="l41.164" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">new file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- /dev/null</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_browserGlue_migrate.js</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -0,0 +1,121 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineplus">+ *</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+ *</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+ * License.</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineplus">+ *</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineplus">+ * The Original Code is Places Unit Test code.</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineplus">+ *</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineplus">+ *</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineplus">+ *</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineplus">+ *</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineplus">+</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+/**</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+ * Tests that nsSuiteGlue does not overwrite bookmarks imported from the</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineplus">+ * migrators.  They usually run before nsSuiteGlue, so if we find any</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineplus">+ * bookmark on init, we should not try to import.</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineplus">+ */</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineplus">+</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineplus">+</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;bs&quot;,</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineplus">+                                   &quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;,</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineplus">+                                   &quot;nsINavBookmarksService&quot;);</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;anno&quot;,</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+                                   &quot;@mozilla.org/browser/annotation-service;1&quot;,</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineplus">+                                   &quot;nsIAnnotationService&quot;);</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineplus">+</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineplus">+let bookmarksObserver = {</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineplus">+  onBeginUpdateBatch: function() {},</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineplus">+  onEndUpdateBatch: function() {</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineplus">+    let itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineplus">+    do_check_neq(itemId, -1);</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineplus">+    if (anno.itemHasAnnotation(itemId, &quot;Places/SmartBookmark&quot;))</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineplus">+      continue_test();</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineplus">+  },</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineplus">+  onItemAdded: function() {},</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineplus">+  onBeforeItemRemoved: function(id) {},</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineplus">+  onItemRemoved: function(id, folder, index, itemType) {},</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineplus">+  onItemChanged: function() {},</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineplus">+  onItemVisited: function(id, visitID, time) {},</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineplus">+  onItemMoved: function() {},</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsINavBookmarkObserver])</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineplus">+};</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineplus">+</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineplus">+const PREF_SMART_BOOKMARKS_VERSION = &quot;browser.places.smartBookmarksVersion&quot;;</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineplus">+</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineplus">+function run_test() {</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineplus">+  do_test_pending();</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineplus">+</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineplus">+  // Create our bookmarks.html copying bookmarks.glue.html to the profile</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineplus">+  // folder.  It will be ignored.</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineplus">+  create_bookmarks_html(&quot;bookmarks.glue.html&quot;);</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineplus">+</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineplus">+  // Remove current database file.</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineplus">+  let db = gProfD.clone();</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineplus">+  db.append(&quot;places.sqlite&quot;);</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineplus">+  if (db.exists()) {</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineplus">+    db.remove(false);</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineplus">+    do_check_false(db.exists());</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineplus">+  }</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineplus">+</span>
<a href="#l42.92"></a><span id="l42.92" class="difflineplus">+  // Initialize Places through the History Service.</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineplus">+  let hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineplus">+           getService(Ci.nsINavHistoryService);</span>
<a href="#l42.95"></a><span id="l42.95" class="difflineplus">+  // Check a new database has been created.</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineplus">+  // nsSuiteGlue uses databaseStatus to manage initialization.</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineplus">+  do_check_eq(hs.databaseStatus, hs.DATABASE_STATUS_CREATE);</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineplus">+</span>
<a href="#l42.99"></a><span id="l42.99" class="difflineplus">+  // A migrator would run before nsSuiteGlue, so we mimic that behavior</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineplus">+  // adding a bookmark.</span>
<a href="#l42.101"></a><span id="l42.101" class="difflineplus">+  bs.insertBookmark(bs.bookmarksMenuFolder, uri(&quot;http://mozilla.org/&quot;),</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineplus">+                    bs.DEFAULT_INDEX, &quot;migrated&quot;);</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineplus">+</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineplus">+  // Initialize nsSuiteGlue.</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineplus">+  let bg = Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineplus">+           getService(Ci.nsISuiteGlue);</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineplus">+</span>
<a href="#l42.108"></a><span id="l42.108" class="difflineplus">+  // The test will continue once import has finished and smart bookmarks</span>
<a href="#l42.109"></a><span id="l42.109" class="difflineplus">+  // have been created.</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineplus">+  bs.addObserver(bookmarksObserver, false);</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineplus">+}</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineplus">+</span>
<a href="#l42.113"></a><span id="l42.113" class="difflineplus">+function continue_test() {</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineplus">+  // Check the created bookmarks still exist.</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineplus">+  let itemId = bs.getIdForItemAt(bs.bookmarksMenuFolder, SMART_BOOKMARKS_ON_MENU);</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineplus">+  do_check_eq(bs.getItemTitle(itemId), &quot;migrated&quot;);</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineplus">+</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineplus">+  // Check that we have not imported any new bookmark.</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineplus">+  do_check_eq(bs.getIdForItemAt(bs.bookmarksMenuFolder, SMART_BOOKMARKS_ON_MENU + 1), -1);</span>
<a href="#l42.120"></a><span id="l42.120" class="difflineplus">+  do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_MENU), -1);</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineplus">+</span>
<a href="#l42.122"></a><span id="l42.122" class="difflineplus">+  remove_bookmarks_html();</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineplus">+</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineplus">+  do_test_finished();</span>
<a href="#l42.125"></a><span id="l42.125" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">new file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineminus">--- /dev/null</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_browserGlue_prefs.js</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineat">@@ -0,0 +1,287 @@</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l43.6"></a><span id="l43.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l43.7"></a><span id="l43.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineplus">+ *</span>
<a href="#l43.10"></a><span id="l43.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l43.11"></a><span id="l43.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+ *</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+ * License.</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+ *</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+ * The Original Code is Places Unit Test code.</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+ *</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineplus">+ *</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineplus">+ *</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l43.39"></a><span id="l43.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineplus">+ *</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineplus">+</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineplus">+/**</span>
<a href="#l43.44"></a><span id="l43.44" class="difflineplus">+ * Tests that nsSuiteGlue is correctly interpreting the preferences settable</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineplus">+ * by the user or by other components.</span>
<a href="#l43.46"></a><span id="l43.46" class="difflineplus">+ */</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineplus">+</span>
<a href="#l43.48"></a><span id="l43.48" class="difflineplus">+/** Bug 539067</span>
<a href="#l43.49"></a><span id="l43.49" class="difflineplus">+ * Test is disabled due to random failures and timeouts, see run_test.</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineplus">+ * This is commented out to avoid leaks.</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineplus">+// Initialize SuiteGlue.</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineplus">+let bg = Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineplus">+         getService(Ci.nsISuiteGlue);</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineplus">+*/</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineplus">+</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineplus">+// Initialize Places through Bookmarks Service.</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineplus">+let bs = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l43.58"></a><span id="l43.58" class="difflineplus">+         getService(Ci.nsINavBookmarksService);</span>
<a href="#l43.59"></a><span id="l43.59" class="difflineplus">+</span>
<a href="#l43.60"></a><span id="l43.60" class="difflineplus">+// Get other services.</span>
<a href="#l43.61"></a><span id="l43.61" class="difflineplus">+let ps = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l43.62"></a><span id="l43.62" class="difflineplus">+         getService(Ci.nsIPrefBranch);</span>
<a href="#l43.63"></a><span id="l43.63" class="difflineplus">+let os = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l43.64"></a><span id="l43.64" class="difflineplus">+         getService(Ci.nsIObserverService);</span>
<a href="#l43.65"></a><span id="l43.65" class="difflineplus">+</span>
<a href="#l43.66"></a><span id="l43.66" class="difflineplus">+const PREF_IMPORT_BOOKMARKS_HTML = &quot;browser.places.importBookmarksHTML&quot;;</span>
<a href="#l43.67"></a><span id="l43.67" class="difflineplus">+const PREF_RESTORE_DEFAULT_BOOKMARKS = &quot;browser.bookmarks.restore_default_bookmarks&quot;;</span>
<a href="#l43.68"></a><span id="l43.68" class="difflineplus">+const PREF_SMART_BOOKMARKS_VERSION = &quot;browser.places.smartBookmarksVersion&quot;;</span>
<a href="#l43.69"></a><span id="l43.69" class="difflineplus">+const PREF_AUTO_EXPORT_HTML = &quot;browser.bookmarks.autoExportHTML&quot;;</span>
<a href="#l43.70"></a><span id="l43.70" class="difflineplus">+</span>
<a href="#l43.71"></a><span id="l43.71" class="difflineplus">+let tests = [];</span>
<a href="#l43.72"></a><span id="l43.72" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l43.73"></a><span id="l43.73" class="difflineplus">+</span>
<a href="#l43.74"></a><span id="l43.74" class="difflineplus">+tests.push({</span>
<a href="#l43.75"></a><span id="l43.75" class="difflineplus">+  description: &quot;Import from bookmarks.html if importBookmarksHTML is true.&quot;,</span>
<a href="#l43.76"></a><span id="l43.76" class="difflineplus">+  exec: function() {</span>
<a href="#l43.77"></a><span id="l43.77" class="difflineplus">+    // Sanity check: we should not have any bookmark on the toolbar.</span>
<a href="#l43.78"></a><span id="l43.78" class="difflineplus">+    do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l43.79"></a><span id="l43.79" class="difflineplus">+</span>
<a href="#l43.80"></a><span id="l43.80" class="difflineplus">+    // Set preferences.</span>
<a href="#l43.81"></a><span id="l43.81" class="difflineplus">+    ps.setBoolPref(PREF_IMPORT_BOOKMARKS_HTML, true);</span>
<a href="#l43.82"></a><span id="l43.82" class="difflineplus">+</span>
<a href="#l43.83"></a><span id="l43.83" class="difflineplus">+    // Force nsSuiteGlue::_initPlaces().</span>
<a href="#l43.84"></a><span id="l43.84" class="difflineplus">+    print(&quot;Simulate Places init&quot;);</span>
<a href="#l43.85"></a><span id="l43.85" class="difflineplus">+    bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l43.86"></a><span id="l43.86" class="difflineplus">+                                              PlacesUtils.TOPIC_INIT_COMPLETE,</span>
<a href="#l43.87"></a><span id="l43.87" class="difflineplus">+                                              null);</span>
<a href="#l43.88"></a><span id="l43.88" class="difflineplus">+    // Check bookmarks.html has been imported, and a smart bookmark has been</span>
<a href="#l43.89"></a><span id="l43.89" class="difflineplus">+    // created.</span>
<a href="#l43.90"></a><span id="l43.90" class="difflineplus">+    let itemId = bs.getIdForItemAt(bs.toolbarFolder,</span>
<a href="#l43.91"></a><span id="l43.91" class="difflineplus">+                                   SMART_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l43.92"></a><span id="l43.92" class="difflineplus">+    do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l43.93"></a><span id="l43.93" class="difflineplus">+    // Check preferences have been reverted.</span>
<a href="#l43.94"></a><span id="l43.94" class="difflineplus">+    do_check_false(ps.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l43.95"></a><span id="l43.95" class="difflineplus">+</span>
<a href="#l43.96"></a><span id="l43.96" class="difflineplus">+    next_test();</span>
<a href="#l43.97"></a><span id="l43.97" class="difflineplus">+  }</span>
<a href="#l43.98"></a><span id="l43.98" class="difflineplus">+});</span>
<a href="#l43.99"></a><span id="l43.99" class="difflineplus">+</span>
<a href="#l43.100"></a><span id="l43.100" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l43.101"></a><span id="l43.101" class="difflineplus">+</span>
<a href="#l43.102"></a><span id="l43.102" class="difflineplus">+tests.push({</span>
<a href="#l43.103"></a><span id="l43.103" class="difflineplus">+  description: &quot;import from bookmarks.html, but don't create smart bookmarks if they are disabled&quot;,</span>
<a href="#l43.104"></a><span id="l43.104" class="difflineplus">+  exec: function() {</span>
<a href="#l43.105"></a><span id="l43.105" class="difflineplus">+    // Sanity check: we should not have any bookmark on the toolbar.</span>
<a href="#l43.106"></a><span id="l43.106" class="difflineplus">+    do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l43.107"></a><span id="l43.107" class="difflineplus">+</span>
<a href="#l43.108"></a><span id="l43.108" class="difflineplus">+    // Set preferences.</span>
<a href="#l43.109"></a><span id="l43.109" class="difflineplus">+    ps.setIntPref(PREF_SMART_BOOKMARKS_VERSION, -1);</span>
<a href="#l43.110"></a><span id="l43.110" class="difflineplus">+    ps.setBoolPref(PREF_IMPORT_BOOKMARKS_HTML, true);</span>
<a href="#l43.111"></a><span id="l43.111" class="difflineplus">+</span>
<a href="#l43.112"></a><span id="l43.112" class="difflineplus">+    // Force nsSuiteGlue::_initPlaces().</span>
<a href="#l43.113"></a><span id="l43.113" class="difflineplus">+    print(&quot;Simulate Places init&quot;);</span>
<a href="#l43.114"></a><span id="l43.114" class="difflineplus">+    bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l43.115"></a><span id="l43.115" class="difflineplus">+                                              PlacesUtils.TOPIC_INIT_COMPLETE,</span>
<a href="#l43.116"></a><span id="l43.116" class="difflineplus">+                                              null);</span>
<a href="#l43.117"></a><span id="l43.117" class="difflineplus">+    // Check bookmarks.html has been imported, but smart bookmarks have not</span>
<a href="#l43.118"></a><span id="l43.118" class="difflineplus">+    // been created.</span>
<a href="#l43.119"></a><span id="l43.119" class="difflineplus">+    let itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l43.120"></a><span id="l43.120" class="difflineplus">+    do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l43.121"></a><span id="l43.121" class="difflineplus">+    // Check preferences have been reverted.</span>
<a href="#l43.122"></a><span id="l43.122" class="difflineplus">+    do_check_false(ps.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l43.123"></a><span id="l43.123" class="difflineplus">+</span>
<a href="#l43.124"></a><span id="l43.124" class="difflineplus">+    next_test();</span>
<a href="#l43.125"></a><span id="l43.125" class="difflineplus">+  }</span>
<a href="#l43.126"></a><span id="l43.126" class="difflineplus">+});</span>
<a href="#l43.127"></a><span id="l43.127" class="difflineplus">+</span>
<a href="#l43.128"></a><span id="l43.128" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l43.129"></a><span id="l43.129" class="difflineplus">+</span>
<a href="#l43.130"></a><span id="l43.130" class="difflineplus">+tests.push({</span>
<a href="#l43.131"></a><span id="l43.131" class="difflineplus">+  description: &quot;Import from bookmarks.html, but don't create smart bookmarks if autoExportHTML is true and they are at latest version&quot;,</span>
<a href="#l43.132"></a><span id="l43.132" class="difflineplus">+  exec: function() {</span>
<a href="#l43.133"></a><span id="l43.133" class="difflineplus">+    // Sanity check: we should not have any bookmark on the toolbar.</span>
<a href="#l43.134"></a><span id="l43.134" class="difflineplus">+    do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l43.135"></a><span id="l43.135" class="difflineplus">+    // Set preferences.</span>
<a href="#l43.136"></a><span id="l43.136" class="difflineplus">+    ps.setIntPref(PREF_SMART_BOOKMARKS_VERSION, 999);</span>
<a href="#l43.137"></a><span id="l43.137" class="difflineplus">+    ps.setBoolPref(PREF_AUTO_EXPORT_HTML, true);</span>
<a href="#l43.138"></a><span id="l43.138" class="difflineplus">+    ps.setBoolPref(PREF_IMPORT_BOOKMARKS_HTML, true);</span>
<a href="#l43.139"></a><span id="l43.139" class="difflineplus">+</span>
<a href="#l43.140"></a><span id="l43.140" class="difflineplus">+    // Force nsSuiteGlue::_initPlaces()</span>
<a href="#l43.141"></a><span id="l43.141" class="difflineplus">+    print(&quot;Simulate Places init&quot;);</span>
<a href="#l43.142"></a><span id="l43.142" class="difflineplus">+    bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l43.143"></a><span id="l43.143" class="difflineplus">+                                              PlacesUtils.TOPIC_INIT_COMPLETE,</span>
<a href="#l43.144"></a><span id="l43.144" class="difflineplus">+                                              null);</span>
<a href="#l43.145"></a><span id="l43.145" class="difflineplus">+    // Check bookmarks.html has been imported, but smart bookmarks have not</span>
<a href="#l43.146"></a><span id="l43.146" class="difflineplus">+    // been created.</span>
<a href="#l43.147"></a><span id="l43.147" class="difflineplus">+    let itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l43.148"></a><span id="l43.148" class="difflineplus">+    do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l43.149"></a><span id="l43.149" class="difflineplus">+    do_check_false(ps.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l43.150"></a><span id="l43.150" class="difflineplus">+    // Check preferences have been reverted.</span>
<a href="#l43.151"></a><span id="l43.151" class="difflineplus">+    ps.setBoolPref(PREF_AUTO_EXPORT_HTML, false);</span>
<a href="#l43.152"></a><span id="l43.152" class="difflineplus">+</span>
<a href="#l43.153"></a><span id="l43.153" class="difflineplus">+    next_test();</span>
<a href="#l43.154"></a><span id="l43.154" class="difflineplus">+  }</span>
<a href="#l43.155"></a><span id="l43.155" class="difflineplus">+});</span>
<a href="#l43.156"></a><span id="l43.156" class="difflineplus">+</span>
<a href="#l43.157"></a><span id="l43.157" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l43.158"></a><span id="l43.158" class="difflineplus">+</span>
<a href="#l43.159"></a><span id="l43.159" class="difflineplus">+tests.push({</span>
<a href="#l43.160"></a><span id="l43.160" class="difflineplus">+  description: &quot;Import from bookmarks.html, and create smart bookmarks if autoExportHTML is true and they are not at latest version.&quot;,</span>
<a href="#l43.161"></a><span id="l43.161" class="difflineplus">+  exec: function() {</span>
<a href="#l43.162"></a><span id="l43.162" class="difflineplus">+    // Sanity check: we should not have any bookmark on the toolbar.</span>
<a href="#l43.163"></a><span id="l43.163" class="difflineplus">+    do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l43.164"></a><span id="l43.164" class="difflineplus">+    // Set preferences.</span>
<a href="#l43.165"></a><span id="l43.165" class="difflineplus">+    ps.setIntPref(PREF_SMART_BOOKMARKS_VERSION, 0);</span>
<a href="#l43.166"></a><span id="l43.166" class="difflineplus">+    ps.setBoolPref(PREF_AUTO_EXPORT_HTML, true);</span>
<a href="#l43.167"></a><span id="l43.167" class="difflineplus">+    ps.setBoolPref(PREF_IMPORT_BOOKMARKS_HTML, true);</span>
<a href="#l43.168"></a><span id="l43.168" class="difflineplus">+</span>
<a href="#l43.169"></a><span id="l43.169" class="difflineplus">+    // Force nsSuiteGlue::_initPlaces()</span>
<a href="#l43.170"></a><span id="l43.170" class="difflineplus">+    print(&quot;Simulate Places init&quot;);</span>
<a href="#l43.171"></a><span id="l43.171" class="difflineplus">+    bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l43.172"></a><span id="l43.172" class="difflineplus">+                                              PlacesUtils.TOPIC_INIT_COMPLETE,</span>
<a href="#l43.173"></a><span id="l43.173" class="difflineplus">+                                              null);</span>
<a href="#l43.174"></a><span id="l43.174" class="difflineplus">+    // Check bookmarks.html has been imported, but smart bookmarks have not</span>
<a href="#l43.175"></a><span id="l43.175" class="difflineplus">+    // been created.</span>
<a href="#l43.176"></a><span id="l43.176" class="difflineplus">+    let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l43.177"></a><span id="l43.177" class="difflineplus">+    do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l43.178"></a><span id="l43.178" class="difflineplus">+    do_check_false(ps.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l43.179"></a><span id="l43.179" class="difflineplus">+    // Check preferences have been reverted.</span>
<a href="#l43.180"></a><span id="l43.180" class="difflineplus">+    ps.setBoolPref(PREF_AUTO_EXPORT_HTML, false);</span>
<a href="#l43.181"></a><span id="l43.181" class="difflineplus">+</span>
<a href="#l43.182"></a><span id="l43.182" class="difflineplus">+    next_test();</span>
<a href="#l43.183"></a><span id="l43.183" class="difflineplus">+  }</span>
<a href="#l43.184"></a><span id="l43.184" class="difflineplus">+});</span>
<a href="#l43.185"></a><span id="l43.185" class="difflineplus">+</span>
<a href="#l43.186"></a><span id="l43.186" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l43.187"></a><span id="l43.187" class="difflineplus">+tests.push({</span>
<a href="#l43.188"></a><span id="l43.188" class="difflineplus">+  description: &quot;restore from default bookmarks.html if restore_default_bookmarks is true.&quot;,</span>
<a href="#l43.189"></a><span id="l43.189" class="difflineplus">+  exec: function() {</span>
<a href="#l43.190"></a><span id="l43.190" class="difflineplus">+    // Sanity check: we should not have any bookmark on the toolbar.</span>
<a href="#l43.191"></a><span id="l43.191" class="difflineplus">+    do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l43.192"></a><span id="l43.192" class="difflineplus">+    // Set preferences.</span>
<a href="#l43.193"></a><span id="l43.193" class="difflineplus">+    ps.setBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS, true);</span>
<a href="#l43.194"></a><span id="l43.194" class="difflineplus">+</span>
<a href="#l43.195"></a><span id="l43.195" class="difflineplus">+    // Force nsSuiteGlue::_initPlaces()</span>
<a href="#l43.196"></a><span id="l43.196" class="difflineplus">+    print(&quot;Simulate Places init&quot;);</span>
<a href="#l43.197"></a><span id="l43.197" class="difflineplus">+    bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l43.198"></a><span id="l43.198" class="difflineplus">+                                              PlacesUtils.TOPIC_INIT_COMPLETE,</span>
<a href="#l43.199"></a><span id="l43.199" class="difflineplus">+                                              null);</span>
<a href="#l43.200"></a><span id="l43.200" class="difflineplus">+    // Check bookmarks.html has been restored.</span>
<a href="#l43.201"></a><span id="l43.201" class="difflineplus">+    let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR + 1);</span>
<a href="#l43.202"></a><span id="l43.202" class="difflineplus">+    do_check_true(itemId &gt; 0);</span>
<a href="#l43.203"></a><span id="l43.203" class="difflineplus">+    // Check preferences have been reverted.</span>
<a href="#l43.204"></a><span id="l43.204" class="difflineplus">+    do_check_false(ps.getBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS));</span>
<a href="#l43.205"></a><span id="l43.205" class="difflineplus">+</span>
<a href="#l43.206"></a><span id="l43.206" class="difflineplus">+    next_test();</span>
<a href="#l43.207"></a><span id="l43.207" class="difflineplus">+  }</span>
<a href="#l43.208"></a><span id="l43.208" class="difflineplus">+});</span>
<a href="#l43.209"></a><span id="l43.209" class="difflineplus">+</span>
<a href="#l43.210"></a><span id="l43.210" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l43.211"></a><span id="l43.211" class="difflineplus">+</span>
<a href="#l43.212"></a><span id="l43.212" class="difflineplus">+tests.push({</span>
<a href="#l43.213"></a><span id="l43.213" class="difflineplus">+  description: &quot;setting both importBookmarksHTML and restore_default_bookmarks should restore defaults.&quot;,</span>
<a href="#l43.214"></a><span id="l43.214" class="difflineplus">+  exec: function() {</span>
<a href="#l43.215"></a><span id="l43.215" class="difflineplus">+    // Sanity check: we should not have any bookmark on the toolbar.</span>
<a href="#l43.216"></a><span id="l43.216" class="difflineplus">+    do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l43.217"></a><span id="l43.217" class="difflineplus">+    // Set preferences.</span>
<a href="#l43.218"></a><span id="l43.218" class="difflineplus">+    ps.setBoolPref(PREF_IMPORT_BOOKMARKS_HTML, true);</span>
<a href="#l43.219"></a><span id="l43.219" class="difflineplus">+    ps.setBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS, true);</span>
<a href="#l43.220"></a><span id="l43.220" class="difflineplus">+</span>
<a href="#l43.221"></a><span id="l43.221" class="difflineplus">+    // Force nsSuiteGlue::_initPlaces()</span>
<a href="#l43.222"></a><span id="l43.222" class="difflineplus">+    print(&quot;Simulate Places init&quot;);</span>
<a href="#l43.223"></a><span id="l43.223" class="difflineplus">+    bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l43.224"></a><span id="l43.224" class="difflineplus">+                                              PlacesUtils.TOPIC_INIT_COMPLETE,</span>
<a href="#l43.225"></a><span id="l43.225" class="difflineplus">+                                              null);</span>
<a href="#l43.226"></a><span id="l43.226" class="difflineplus">+    // Check bookmarks.html has been restored.</span>
<a href="#l43.227"></a><span id="l43.227" class="difflineplus">+    let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR + 1);</span>
<a href="#l43.228"></a><span id="l43.228" class="difflineplus">+    do_check_true(itemId &gt; 0);</span>
<a href="#l43.229"></a><span id="l43.229" class="difflineplus">+    // Check preferences have been reverted.</span>
<a href="#l43.230"></a><span id="l43.230" class="difflineplus">+    do_check_false(ps.getBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS));</span>
<a href="#l43.231"></a><span id="l43.231" class="difflineplus">+    do_check_false(ps.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l43.232"></a><span id="l43.232" class="difflineplus">+</span>
<a href="#l43.233"></a><span id="l43.233" class="difflineplus">+    do_test_finished();</span>
<a href="#l43.234"></a><span id="l43.234" class="difflineplus">+  }</span>
<a href="#l43.235"></a><span id="l43.235" class="difflineplus">+});</span>
<a href="#l43.236"></a><span id="l43.236" class="difflineplus">+</span>
<a href="#l43.237"></a><span id="l43.237" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l43.238"></a><span id="l43.238" class="difflineplus">+</span>
<a href="#l43.239"></a><span id="l43.239" class="difflineplus">+function finish_test() {</span>
<a href="#l43.240"></a><span id="l43.240" class="difflineplus">+  // Clean up database from all bookmarks.</span>
<a href="#l43.241"></a><span id="l43.241" class="difflineplus">+  remove_all_bookmarks();</span>
<a href="#l43.242"></a><span id="l43.242" class="difflineplus">+  remove_bookmarks_html();</span>
<a href="#l43.243"></a><span id="l43.243" class="difflineplus">+  remove_all_JSON_backups();</span>
<a href="#l43.244"></a><span id="l43.244" class="difflineplus">+</span>
<a href="#l43.245"></a><span id="l43.245" class="difflineplus">+  do_test_finished();</span>
<a href="#l43.246"></a><span id="l43.246" class="difflineplus">+}</span>
<a href="#l43.247"></a><span id="l43.247" class="difflineplus">+var testIndex = 0;</span>
<a href="#l43.248"></a><span id="l43.248" class="difflineplus">+function next_test() {</span>
<a href="#l43.249"></a><span id="l43.249" class="difflineplus">+  // Clean up database from all bookmarks.</span>
<a href="#l43.250"></a><span id="l43.250" class="difflineplus">+  remove_all_bookmarks();</span>
<a href="#l43.251"></a><span id="l43.251" class="difflineplus">+  // nsSuiteGlue stops observing topics after first notification,</span>
<a href="#l43.252"></a><span id="l43.252" class="difflineplus">+  // so we add back the observer to test additional runs.</span>
<a href="#l43.253"></a><span id="l43.253" class="difflineplus">+  os.addObserver(bg.QueryInterface(Ci.nsIObserver),</span>
<a href="#l43.254"></a><span id="l43.254" class="difflineplus">+                 PlacesUtils.TOPIC_INIT_COMPLETE, false);</span>
<a href="#l43.255"></a><span id="l43.255" class="difflineplus">+  os.addObserver(bg.QueryInterface(Ci.nsIObserver),</span>
<a href="#l43.256"></a><span id="l43.256" class="difflineplus">+                 PlacesUtils.TOPIC_DATABASE_LOCKED, false);</span>
<a href="#l43.257"></a><span id="l43.257" class="difflineplus">+  // Execute next test.</span>
<a href="#l43.258"></a><span id="l43.258" class="difflineplus">+  let test = tests.shift();</span>
<a href="#l43.259"></a><span id="l43.259" class="difflineplus">+  print(&quot;\nTEST &quot; + (++testIndex) + &quot;: &quot; + test.description);</span>
<a href="#l43.260"></a><span id="l43.260" class="difflineplus">+  test.exec();</span>
<a href="#l43.261"></a><span id="l43.261" class="difflineplus">+}</span>
<a href="#l43.262"></a><span id="l43.262" class="difflineplus">+function run_test() {</span>
<a href="#l43.263"></a><span id="l43.263" class="difflineplus">+  // Bug 539067: disabled due to random failures and timeouts.</span>
<a href="#l43.264"></a><span id="l43.264" class="difflineplus">+  return;</span>
<a href="#l43.265"></a><span id="l43.265" class="difflineplus">+</span>
<a href="#l43.266"></a><span id="l43.266" class="difflineplus">+  do_test_pending();</span>
<a href="#l43.267"></a><span id="l43.267" class="difflineplus">+  // Enqueue test, so it will consume the default places-init-complete</span>
<a href="#l43.268"></a><span id="l43.268" class="difflineplus">+  // notification created at Places init.</span>
<a href="#l43.269"></a><span id="l43.269" class="difflineplus">+  do_timeout(0, start_tests);</span>
<a href="#l43.270"></a><span id="l43.270" class="difflineplus">+}</span>
<a href="#l43.271"></a><span id="l43.271" class="difflineplus">+</span>
<a href="#l43.272"></a><span id="l43.272" class="difflineplus">+function start_tests() {</span>
<a href="#l43.273"></a><span id="l43.273" class="difflineplus">+  // Clean up database from all bookmarks.</span>
<a href="#l43.274"></a><span id="l43.274" class="difflineplus">+  remove_all_bookmarks();</span>
<a href="#l43.275"></a><span id="l43.275" class="difflineplus">+</span>
<a href="#l43.276"></a><span id="l43.276" class="difflineplus">+  // Ensure preferences status.</span>
<a href="#l43.277"></a><span id="l43.277" class="difflineplus">+  do_check_false(ps.getBoolPref(PREF_AUTO_EXPORT_HTML));</span>
<a href="#l43.278"></a><span id="l43.278" class="difflineplus">+  try {</span>
<a href="#l43.279"></a><span id="l43.279" class="difflineplus">+    do_check_false(ps.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l43.280"></a><span id="l43.280" class="difflineplus">+    do_throw(&quot;importBookmarksHTML pref should not exist&quot;);</span>
<a href="#l43.281"></a><span id="l43.281" class="difflineplus">+  }</span>
<a href="#l43.282"></a><span id="l43.282" class="difflineplus">+  catch(ex) {}</span>
<a href="#l43.283"></a><span id="l43.283" class="difflineplus">+  do_check_false(ps.getBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS));</span>
<a href="#l43.284"></a><span id="l43.284" class="difflineplus">+</span>
<a href="#l43.285"></a><span id="l43.285" class="difflineplus">+  // Create our bookmarks.html from bookmarks.glue.html.</span>
<a href="#l43.286"></a><span id="l43.286" class="difflineplus">+  create_bookmarks_html(&quot;bookmarks.glue.html&quot;);</span>
<a href="#l43.287"></a><span id="l43.287" class="difflineplus">+  // Create our JSON backup from bookmarks.glue.json.</span>
<a href="#l43.288"></a><span id="l43.288" class="difflineplus">+  create_JSON_backup(&quot;bookmarks.glue.json&quot;);</span>
<a href="#l43.289"></a><span id="l43.289" class="difflineplus">+  // Kick-off tests.</span>
<a href="#l43.290"></a><span id="l43.290" class="difflineplus">+  next_test();</span>
<a href="#l43.291"></a><span id="l43.291" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1">new file mode 100644</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineminus">--- /dev/null</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_browserGlue_restore.js</span>
<a href="#l44.4"></a><span id="l44.4" class="difflineat">@@ -0,0 +1,114 @@</span>
<a href="#l44.5"></a><span id="l44.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l44.6"></a><span id="l44.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l44.7"></a><span id="l44.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l44.8"></a><span id="l44.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l44.9"></a><span id="l44.9" class="difflineplus">+ *</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+ *</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+ * License.</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+ *</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+ * The Original Code is Places Unit Test code.</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+ *</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+ *</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineplus">+ *</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineplus">+ *</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineplus">+</span>
<a href="#l44.43"></a><span id="l44.43" class="difflineplus">+/**</span>
<a href="#l44.44"></a><span id="l44.44" class="difflineplus">+ * Tests that nsSuiteGlue correctly restores bookmarks from a JSON backup if</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineplus">+ * database has been created and one backup is available.</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineplus">+ */</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineplus">+</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineplus">+</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;bs&quot;,</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineplus">+                                   &quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;,</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineplus">+                                   &quot;nsINavBookmarksService&quot;);</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;anno&quot;,</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineplus">+                                   &quot;@mozilla.org/browser/annotation-service;1&quot;,</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineplus">+                                   &quot;nsIAnnotationService&quot;);</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineplus">+</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineplus">+let bookmarksObserver = {</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineplus">+  onBeginUpdateBatch: function() {},</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+  onEndUpdateBatch: function() {</span>
<a href="#l44.60"></a><span id="l44.60" class="difflineplus">+    let itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l44.61"></a><span id="l44.61" class="difflineplus">+    do_check_neq(itemId, -1);</span>
<a href="#l44.62"></a><span id="l44.62" class="difflineplus">+    if (anno.itemHasAnnotation(itemId, &quot;Places/SmartBookmark&quot;))</span>
<a href="#l44.63"></a><span id="l44.63" class="difflineplus">+      continue_test();</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineplus">+  },</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineplus">+  onItemAdded: function() {},</span>
<a href="#l44.66"></a><span id="l44.66" class="difflineplus">+  onBeforeItemRemoved: function(id) {},</span>
<a href="#l44.67"></a><span id="l44.67" class="difflineplus">+  onItemRemoved: function(id, folder, index, itemType) {},</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineplus">+  onItemChanged: function() {},</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineplus">+  onItemVisited: function(id, visitID, time) {},</span>
<a href="#l44.70"></a><span id="l44.70" class="difflineplus">+  onItemMoved: function() {},</span>
<a href="#l44.71"></a><span id="l44.71" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsINavBookmarkObserver])</span>
<a href="#l44.72"></a><span id="l44.72" class="difflineplus">+};</span>
<a href="#l44.73"></a><span id="l44.73" class="difflineplus">+</span>
<a href="#l44.74"></a><span id="l44.74" class="difflineplus">+function run_test() {</span>
<a href="#l44.75"></a><span id="l44.75" class="difflineplus">+  do_test_pending();</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineplus">+</span>
<a href="#l44.77"></a><span id="l44.77" class="difflineplus">+  // Create our bookmarks.html copying bookmarks.glue.html to the profile</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineplus">+  // folder.  It will be ignored.</span>
<a href="#l44.79"></a><span id="l44.79" class="difflineplus">+  create_bookmarks_html(&quot;bookmarks.glue.html&quot;);</span>
<a href="#l44.80"></a><span id="l44.80" class="difflineplus">+</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineplus">+  // Create our JSON backup copying bookmarks.glue.json to the profile</span>
<a href="#l44.82"></a><span id="l44.82" class="difflineplus">+  // folder.  It will be ignored.</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineplus">+  create_JSON_backup(&quot;bookmarks.glue.json&quot;);</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineplus">+</span>
<a href="#l44.85"></a><span id="l44.85" class="difflineplus">+  // Remove current database file.</span>
<a href="#l44.86"></a><span id="l44.86" class="difflineplus">+  let db = gProfD.clone();</span>
<a href="#l44.87"></a><span id="l44.87" class="difflineplus">+  db.append(&quot;places.sqlite&quot;);</span>
<a href="#l44.88"></a><span id="l44.88" class="difflineplus">+  if (db.exists()) {</span>
<a href="#l44.89"></a><span id="l44.89" class="difflineplus">+    db.remove(false);</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineplus">+    do_check_false(db.exists());</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineplus">+  }</span>
<a href="#l44.92"></a><span id="l44.92" class="difflineplus">+</span>
<a href="#l44.93"></a><span id="l44.93" class="difflineplus">+  // Initialize nsSuiteGlue before Places.</span>
<a href="#l44.94"></a><span id="l44.94" class="difflineplus">+  Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].getService(Ci.nsISuiteGlue);</span>
<a href="#l44.95"></a><span id="l44.95" class="difflineplus">+</span>
<a href="#l44.96"></a><span id="l44.96" class="difflineplus">+  // Initialize Places through the History Service.</span>
<a href="#l44.97"></a><span id="l44.97" class="difflineplus">+  let hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineplus">+           getService(Ci.nsINavHistoryService);</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineplus">+  // Check a new database has been created.</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineplus">+  // nsSuiteGlue uses databaseStatus to manage initialization.</span>
<a href="#l44.101"></a><span id="l44.101" class="difflineplus">+  do_check_eq(hs.databaseStatus, hs.DATABASE_STATUS_CREATE);</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineplus">+</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineplus">+  // The test will continue once restore has finished and smart bookmarks</span>
<a href="#l44.104"></a><span id="l44.104" class="difflineplus">+  // have been created.</span>
<a href="#l44.105"></a><span id="l44.105" class="difflineplus">+  bs.addObserver(bookmarksObserver, false);</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineplus">+}</span>
<a href="#l44.107"></a><span id="l44.107" class="difflineplus">+</span>
<a href="#l44.108"></a><span id="l44.108" class="difflineplus">+function continue_test() {</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineplus">+  // Check that JSON backup has been restored.</span>
<a href="#l44.110"></a><span id="l44.110" class="difflineplus">+  // Notice restore from JSON notification is fired before smart bookmarks creation.</span>
<a href="#l44.111"></a><span id="l44.111" class="difflineplus">+  let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineplus">+  do_check_eq(bs.getItemTitle(itemId), &quot;examplejson&quot;);</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineplus">+</span>
<a href="#l44.114"></a><span id="l44.114" class="difflineplus">+  remove_bookmarks_html();</span>
<a href="#l44.115"></a><span id="l44.115" class="difflineplus">+  remove_all_JSON_backups();</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineplus">+</span>
<a href="#l44.117"></a><span id="l44.117" class="difflineplus">+  do_test_finished();</span>
<a href="#l44.118"></a><span id="l44.118" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1">new file mode 100644</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineminus">--- /dev/null</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_browserGlue_shutdown.js</span>
<a href="#l45.4"></a><span id="l45.4" class="difflineat">@@ -0,0 +1,187 @@</span>
<a href="#l45.5"></a><span id="l45.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l45.6"></a><span id="l45.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l45.7"></a><span id="l45.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l45.8"></a><span id="l45.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l45.9"></a><span id="l45.9" class="difflineplus">+ *</span>
<a href="#l45.10"></a><span id="l45.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l45.11"></a><span id="l45.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+ *</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l45.18"></a><span id="l45.18" class="difflineplus">+ * License.</span>
<a href="#l45.19"></a><span id="l45.19" class="difflineplus">+ *</span>
<a href="#l45.20"></a><span id="l45.20" class="difflineplus">+ * The Original Code is Places Unit Test code.</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineplus">+ *</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l45.23"></a><span id="l45.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l45.24"></a><span id="l45.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l45.25"></a><span id="l45.25" class="difflineplus">+ *</span>
<a href="#l45.26"></a><span id="l45.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l45.27"></a><span id="l45.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l45.28"></a><span id="l45.28" class="difflineplus">+ *</span>
<a href="#l45.29"></a><span id="l45.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l45.30"></a><span id="l45.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l45.37"></a><span id="l45.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l45.39"></a><span id="l45.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l45.40"></a><span id="l45.40" class="difflineplus">+ *</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l45.42"></a><span id="l45.42" class="difflineplus">+</span>
<a href="#l45.43"></a><span id="l45.43" class="difflineplus">+/**</span>
<a href="#l45.44"></a><span id="l45.44" class="difflineplus">+ * Tests that nsSuiteGlue is correctly exporting based on preferences values,</span>
<a href="#l45.45"></a><span id="l45.45" class="difflineplus">+ * and creating bookmarks backup if one does not exist for today.</span>
<a href="#l45.46"></a><span id="l45.46" class="difflineplus">+ */</span>
<a href="#l45.47"></a><span id="l45.47" class="difflineplus">+</span>
<a href="#l45.48"></a><span id="l45.48" class="difflineplus">+// Initialize nsSuiteGlue after Places.</span>
<a href="#l45.49"></a><span id="l45.49" class="difflineplus">+let bg = Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].</span>
<a href="#l45.50"></a><span id="l45.50" class="difflineplus">+         getService(Ci.nsISuiteGlue);</span>
<a href="#l45.51"></a><span id="l45.51" class="difflineplus">+</span>
<a href="#l45.52"></a><span id="l45.52" class="difflineplus">+// Initialize Places through Bookmarks Service.</span>
<a href="#l45.53"></a><span id="l45.53" class="difflineplus">+let bs = PlacesUtils.bookmarks;</span>
<a href="#l45.54"></a><span id="l45.54" class="difflineplus">+</span>
<a href="#l45.55"></a><span id="l45.55" class="difflineplus">+// Get other services.</span>
<a href="#l45.56"></a><span id="l45.56" class="difflineplus">+let ps = Services.prefs;</span>
<a href="#l45.57"></a><span id="l45.57" class="difflineplus">+let os = Services.obs;</span>
<a href="#l45.58"></a><span id="l45.58" class="difflineplus">+</span>
<a href="#l45.59"></a><span id="l45.59" class="difflineplus">+const PREF_AUTO_EXPORT_HTML = &quot;browser.bookmarks.autoExportHTML&quot;;</span>
<a href="#l45.60"></a><span id="l45.60" class="difflineplus">+</span>
<a href="#l45.61"></a><span id="l45.61" class="difflineplus">+let tests = [];</span>
<a href="#l45.62"></a><span id="l45.62" class="difflineplus">+</span>
<a href="#l45.63"></a><span id="l45.63" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l45.64"></a><span id="l45.64" class="difflineplus">+</span>
<a href="#l45.65"></a><span id="l45.65" class="difflineplus">+tests.push({</span>
<a href="#l45.66"></a><span id="l45.66" class="difflineplus">+  description: &quot;Export to bookmarks.html if autoExportHTML is true.&quot;,</span>
<a href="#l45.67"></a><span id="l45.67" class="difflineplus">+  exec: function() {</span>
<a href="#l45.68"></a><span id="l45.68" class="difflineplus">+    // Sanity check: we should have bookmarks on the toolbar.</span>
<a href="#l45.69"></a><span id="l45.69" class="difflineplus">+    do_check_true(bs.getIdForItemAt(bs.toolbarFolder, 0) &gt; 0);</span>
<a href="#l45.70"></a><span id="l45.70" class="difflineplus">+</span>
<a href="#l45.71"></a><span id="l45.71" class="difflineplus">+    // Set preferences.</span>
<a href="#l45.72"></a><span id="l45.72" class="difflineplus">+    ps.setBoolPref(PREF_AUTO_EXPORT_HTML, true);</span>
<a href="#l45.73"></a><span id="l45.73" class="difflineplus">+</span>
<a href="#l45.74"></a><span id="l45.74" class="difflineplus">+    // Force nsSuiteGlue::_shutdownPlaces().</span>
<a href="#l45.75"></a><span id="l45.75" class="difflineplus">+    bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l45.76"></a><span id="l45.76" class="difflineplus">+                                              PlacesUtils.TOPIC_SHUTDOWN,</span>
<a href="#l45.77"></a><span id="l45.77" class="difflineplus">+                                              null);</span>
<a href="#l45.78"></a><span id="l45.78" class="difflineplus">+</span>
<a href="#l45.79"></a><span id="l45.79" class="difflineplus">+    // Check bookmarks.html has been created.</span>
<a href="#l45.80"></a><span id="l45.80" class="difflineplus">+    check_bookmarks_html();</span>
<a href="#l45.81"></a><span id="l45.81" class="difflineplus">+    // Check JSON backup has been created.</span>
<a href="#l45.82"></a><span id="l45.82" class="difflineplus">+    check_JSON_backup();</span>
<a href="#l45.83"></a><span id="l45.83" class="difflineplus">+</span>
<a href="#l45.84"></a><span id="l45.84" class="difflineplus">+    // Check preferences have not been reverted.</span>
<a href="#l45.85"></a><span id="l45.85" class="difflineplus">+    do_check_true(ps.getBoolPref(PREF_AUTO_EXPORT_HTML));</span>
<a href="#l45.86"></a><span id="l45.86" class="difflineplus">+    // Reset preferences.</span>
<a href="#l45.87"></a><span id="l45.87" class="difflineplus">+    ps.setBoolPref(PREF_AUTO_EXPORT_HTML, false);</span>
<a href="#l45.88"></a><span id="l45.88" class="difflineplus">+</span>
<a href="#l45.89"></a><span id="l45.89" class="difflineplus">+    next_test();</span>
<a href="#l45.90"></a><span id="l45.90" class="difflineplus">+  }</span>
<a href="#l45.91"></a><span id="l45.91" class="difflineplus">+});</span>
<a href="#l45.92"></a><span id="l45.92" class="difflineplus">+</span>
<a href="#l45.93"></a><span id="l45.93" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l45.94"></a><span id="l45.94" class="difflineplus">+</span>
<a href="#l45.95"></a><span id="l45.95" class="difflineplus">+tests.push({</span>
<a href="#l45.96"></a><span id="l45.96" class="difflineplus">+  description: &quot;Export to bookmarks.html if autoExportHTML is true and a bookmarks.html exists.&quot;,</span>
<a href="#l45.97"></a><span id="l45.97" class="difflineplus">+  exec: function() {</span>
<a href="#l45.98"></a><span id="l45.98" class="difflineplus">+    // Sanity check: we should have bookmarks on the toolbar.</span>
<a href="#l45.99"></a><span id="l45.99" class="difflineplus">+    do_check_true(bs.getIdForItemAt(bs.toolbarFolder, 0) &gt; 0);</span>
<a href="#l45.100"></a><span id="l45.100" class="difflineplus">+</span>
<a href="#l45.101"></a><span id="l45.101" class="difflineplus">+    // Set preferences.</span>
<a href="#l45.102"></a><span id="l45.102" class="difflineplus">+    ps.setBoolPref(PREF_AUTO_EXPORT_HTML, true);</span>
<a href="#l45.103"></a><span id="l45.103" class="difflineplus">+</span>
<a href="#l45.104"></a><span id="l45.104" class="difflineplus">+    // Create a bookmarks.html in the profile.</span>
<a href="#l45.105"></a><span id="l45.105" class="difflineplus">+    let profileBookmarksHTMLFile = create_bookmarks_html(&quot;bookmarks.glue.html&quot;);</span>
<a href="#l45.106"></a><span id="l45.106" class="difflineplus">+    // Get file lastModified and size.</span>
<a href="#l45.107"></a><span id="l45.107" class="difflineplus">+    let lastMod = profileBookmarksHTMLFile.lastModifiedTime;</span>
<a href="#l45.108"></a><span id="l45.108" class="difflineplus">+    let fileSize = profileBookmarksHTMLFile.fileSize;</span>
<a href="#l45.109"></a><span id="l45.109" class="difflineplus">+</span>
<a href="#l45.110"></a><span id="l45.110" class="difflineplus">+    // Force nsSuiteGlue::_shutdownPlaces().</span>
<a href="#l45.111"></a><span id="l45.111" class="difflineplus">+    bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l45.112"></a><span id="l45.112" class="difflineplus">+                                              PlacesUtils.TOPIC_SHUTDOWN,</span>
<a href="#l45.113"></a><span id="l45.113" class="difflineplus">+                                              null);</span>
<a href="#l45.114"></a><span id="l45.114" class="difflineplus">+</span>
<a href="#l45.115"></a><span id="l45.115" class="difflineplus">+    // Check a new bookmarks.html has been created.</span>
<a href="#l45.116"></a><span id="l45.116" class="difflineplus">+    let profileBookmarksHTMLFile = check_bookmarks_html();</span>
<a href="#l45.117"></a><span id="l45.117" class="difflineplus">+    //XXX not working on Linux unit boxes. Could be filestats caching issue.</span>
<a href="#l45.118"></a><span id="l45.118" class="difflineplus">+    //do_check_true(profileBookmarksHTMLFile.lastModifiedTime &gt; lastMod);</span>
<a href="#l45.119"></a><span id="l45.119" class="difflineplus">+    do_check_neq(profileBookmarksHTMLFile.fileSize, fileSize);</span>
<a href="#l45.120"></a><span id="l45.120" class="difflineplus">+</span>
<a href="#l45.121"></a><span id="l45.121" class="difflineplus">+    // Check preferences have not been reverted.</span>
<a href="#l45.122"></a><span id="l45.122" class="difflineplus">+    do_check_true(ps.getBoolPref(PREF_AUTO_EXPORT_HTML));</span>
<a href="#l45.123"></a><span id="l45.123" class="difflineplus">+    // Reset preferences.</span>
<a href="#l45.124"></a><span id="l45.124" class="difflineplus">+    ps.setBoolPref(PREF_AUTO_EXPORT_HTML, false);</span>
<a href="#l45.125"></a><span id="l45.125" class="difflineplus">+</span>
<a href="#l45.126"></a><span id="l45.126" class="difflineplus">+    next_test();</span>
<a href="#l45.127"></a><span id="l45.127" class="difflineplus">+  }</span>
<a href="#l45.128"></a><span id="l45.128" class="difflineplus">+});</span>
<a href="#l45.129"></a><span id="l45.129" class="difflineplus">+</span>
<a href="#l45.130"></a><span id="l45.130" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l45.131"></a><span id="l45.131" class="difflineplus">+</span>
<a href="#l45.132"></a><span id="l45.132" class="difflineplus">+tests.push({</span>
<a href="#l45.133"></a><span id="l45.133" class="difflineplus">+  description: &quot;Backup to JSON should be a no-op if a backup for today already exists.&quot;,</span>
<a href="#l45.134"></a><span id="l45.134" class="difflineplus">+  exec: function() {</span>
<a href="#l45.135"></a><span id="l45.135" class="difflineplus">+    // Sanity check: we should have bookmarks on the toolbar.</span>
<a href="#l45.136"></a><span id="l45.136" class="difflineplus">+    do_check_true(bs.getIdForItemAt(bs.toolbarFolder, 0) &gt; 0);</span>
<a href="#l45.137"></a><span id="l45.137" class="difflineplus">+</span>
<a href="#l45.138"></a><span id="l45.138" class="difflineplus">+    // Create a JSON backup in the profile.</span>
<a href="#l45.139"></a><span id="l45.139" class="difflineplus">+    let profileBookmarksJSONFile = create_JSON_backup(&quot;bookmarks.glue.json&quot;);</span>
<a href="#l45.140"></a><span id="l45.140" class="difflineplus">+    // Get file lastModified and size.</span>
<a href="#l45.141"></a><span id="l45.141" class="difflineplus">+    let lastMod = profileBookmarksJSONFile.lastModifiedTime;</span>
<a href="#l45.142"></a><span id="l45.142" class="difflineplus">+    let fileSize = profileBookmarksJSONFile.fileSize;</span>
<a href="#l45.143"></a><span id="l45.143" class="difflineplus">+</span>
<a href="#l45.144"></a><span id="l45.144" class="difflineplus">+    // Force nsSuiteGlue::_shutdownPlaces().</span>
<a href="#l45.145"></a><span id="l45.145" class="difflineplus">+    bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l45.146"></a><span id="l45.146" class="difflineplus">+                                              PlacesUtils.TOPIC_SHUTDOWN,</span>
<a href="#l45.147"></a><span id="l45.147" class="difflineplus">+                                              null);</span>
<a href="#l45.148"></a><span id="l45.148" class="difflineplus">+</span>
<a href="#l45.149"></a><span id="l45.149" class="difflineplus">+    // Check a new JSON backup has not been created.</span>
<a href="#l45.150"></a><span id="l45.150" class="difflineplus">+    do_check_true(profileBookmarksJSONFile.exists());</span>
<a href="#l45.151"></a><span id="l45.151" class="difflineplus">+    do_check_eq(profileBookmarksJSONFile.lastModifiedTime, lastMod);</span>
<a href="#l45.152"></a><span id="l45.152" class="difflineplus">+    do_check_eq(profileBookmarksJSONFile.fileSize, fileSize);</span>
<a href="#l45.153"></a><span id="l45.153" class="difflineplus">+</span>
<a href="#l45.154"></a><span id="l45.154" class="difflineplus">+    do_test_finished();</span>
<a href="#l45.155"></a><span id="l45.155" class="difflineplus">+  }</span>
<a href="#l45.156"></a><span id="l45.156" class="difflineplus">+});</span>
<a href="#l45.157"></a><span id="l45.157" class="difflineplus">+</span>
<a href="#l45.158"></a><span id="l45.158" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l45.159"></a><span id="l45.159" class="difflineplus">+</span>
<a href="#l45.160"></a><span id="l45.160" class="difflineplus">+function finish_test() {</span>
<a href="#l45.161"></a><span id="l45.161" class="difflineplus">+  do_test_finished();</span>
<a href="#l45.162"></a><span id="l45.162" class="difflineplus">+}</span>
<a href="#l45.163"></a><span id="l45.163" class="difflineplus">+</span>
<a href="#l45.164"></a><span id="l45.164" class="difflineplus">+var testIndex = 0;</span>
<a href="#l45.165"></a><span id="l45.165" class="difflineplus">+function next_test() {</span>
<a href="#l45.166"></a><span id="l45.166" class="difflineplus">+  // Remove bookmarks.html from profile.</span>
<a href="#l45.167"></a><span id="l45.167" class="difflineplus">+  remove_bookmarks_html();</span>
<a href="#l45.168"></a><span id="l45.168" class="difflineplus">+  // Remove JSON backups from profile.</span>
<a href="#l45.169"></a><span id="l45.169" class="difflineplus">+  remove_all_JSON_backups();</span>
<a href="#l45.170"></a><span id="l45.170" class="difflineplus">+</span>
<a href="#l45.171"></a><span id="l45.171" class="difflineplus">+  // Execute next test.</span>
<a href="#l45.172"></a><span id="l45.172" class="difflineplus">+  let test = tests.shift();</span>
<a href="#l45.173"></a><span id="l45.173" class="difflineplus">+  dump(&quot;\nTEST &quot; + (++testIndex) + &quot;: &quot; + test.description);</span>
<a href="#l45.174"></a><span id="l45.174" class="difflineplus">+  test.exec();</span>
<a href="#l45.175"></a><span id="l45.175" class="difflineplus">+}</span>
<a href="#l45.176"></a><span id="l45.176" class="difflineplus">+</span>
<a href="#l45.177"></a><span id="l45.177" class="difflineplus">+function run_test() {</span>
<a href="#l45.178"></a><span id="l45.178" class="difflineplus">+  do_test_pending();</span>
<a href="#l45.179"></a><span id="l45.179" class="difflineplus">+</span>
<a href="#l45.180"></a><span id="l45.180" class="difflineplus">+  // Clean up bookmarks.</span>
<a href="#l45.181"></a><span id="l45.181" class="difflineplus">+  remove_all_bookmarks();</span>
<a href="#l45.182"></a><span id="l45.182" class="difflineplus">+</span>
<a href="#l45.183"></a><span id="l45.183" class="difflineplus">+  // Create some bookmarks.</span>
<a href="#l45.184"></a><span id="l45.184" class="difflineplus">+  bs.insertBookmark(bs.bookmarksMenuFolder, uri(&quot;http://mozilla.org/&quot;),</span>
<a href="#l45.185"></a><span id="l45.185" class="difflineplus">+                    bs.DEFAULT_INDEX, &quot;bookmark-on-menu&quot;);</span>
<a href="#l45.186"></a><span id="l45.186" class="difflineplus">+  bs.insertBookmark(bs.toolbarFolder, uri(&quot;http://mozilla.org/&quot;),</span>
<a href="#l45.187"></a><span id="l45.187" class="difflineplus">+                    bs.DEFAULT_INDEX, &quot;bookmark-on-toolbar&quot;);</span>
<a href="#l45.188"></a><span id="l45.188" class="difflineplus">+</span>
<a href="#l45.189"></a><span id="l45.189" class="difflineplus">+  // Kick-off tests.</span>
<a href="#l45.190"></a><span id="l45.190" class="difflineplus">+  next_test();</span>
<a href="#l45.191"></a><span id="l45.191" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1">new file mode 100644</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineminus">--- /dev/null</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js</span>
<a href="#l46.4"></a><span id="l46.4" class="difflineat">@@ -0,0 +1,293 @@</span>
<a href="#l46.5"></a><span id="l46.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l46.6"></a><span id="l46.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l46.7"></a><span id="l46.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l46.8"></a><span id="l46.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l46.9"></a><span id="l46.9" class="difflineplus">+ *</span>
<a href="#l46.10"></a><span id="l46.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l46.11"></a><span id="l46.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineplus">+ *</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineplus">+ * License.</span>
<a href="#l46.19"></a><span id="l46.19" class="difflineplus">+ *</span>
<a href="#l46.20"></a><span id="l46.20" class="difflineplus">+ * The Original Code is Places Unit Test code.</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineplus">+ *</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l46.23"></a><span id="l46.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l46.24"></a><span id="l46.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l46.25"></a><span id="l46.25" class="difflineplus">+ *</span>
<a href="#l46.26"></a><span id="l46.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l46.27"></a><span id="l46.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l46.28"></a><span id="l46.28" class="difflineplus">+ *</span>
<a href="#l46.29"></a><span id="l46.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l46.35"></a><span id="l46.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l46.36"></a><span id="l46.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineplus">+ *</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineplus">+</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineplus">+/**</span>
<a href="#l46.44"></a><span id="l46.44" class="difflineplus">+ * Tests that nsSuiteGlue is correctly interpreting the preferences settable</span>
<a href="#l46.45"></a><span id="l46.45" class="difflineplus">+ * by the user or by other components.</span>
<a href="#l46.46"></a><span id="l46.46" class="difflineplus">+ */</span>
<a href="#l46.47"></a><span id="l46.47" class="difflineplus">+</span>
<a href="#l46.48"></a><span id="l46.48" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l46.49"></a><span id="l46.49" class="difflineplus">+</span>
<a href="#l46.50"></a><span id="l46.50" class="difflineplus">+// Initialize Places.</span>
<a href="#l46.51"></a><span id="l46.51" class="difflineplus">+var hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l46.52"></a><span id="l46.52" class="difflineplus">+         getService(Ci.nsINavHistoryService);</span>
<a href="#l46.53"></a><span id="l46.53" class="difflineplus">+var bs = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l46.54"></a><span id="l46.54" class="difflineplus">+         getService(Ci.nsINavBookmarksService);</span>
<a href="#l46.55"></a><span id="l46.55" class="difflineplus">+// Get other services.</span>
<a href="#l46.56"></a><span id="l46.56" class="difflineplus">+var ps = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l46.57"></a><span id="l46.57" class="difflineplus">+         getService(Ci.nsIPrefBranch);</span>
<a href="#l46.58"></a><span id="l46.58" class="difflineplus">+var os = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l46.59"></a><span id="l46.59" class="difflineplus">+         getService(Ci.nsIObserverService);</span>
<a href="#l46.60"></a><span id="l46.60" class="difflineplus">+var as = Cc[&quot;@mozilla.org/browser/annotation-service;1&quot;].</span>
<a href="#l46.61"></a><span id="l46.61" class="difflineplus">+         getService(Ci.nsIAnnotationService);</span>
<a href="#l46.62"></a><span id="l46.62" class="difflineplus">+</span>
<a href="#l46.63"></a><span id="l46.63" class="difflineplus">+const PREF_SMART_BOOKMARKS_VERSION = &quot;browser.places.smartBookmarksVersion&quot;;</span>
<a href="#l46.64"></a><span id="l46.64" class="difflineplus">+const PREF_AUTO_EXPORT_HTML = &quot;browser.bookmarks.autoExportHTML&quot;;</span>
<a href="#l46.65"></a><span id="l46.65" class="difflineplus">+const PREF_IMPORT_BOOKMARKS_HTML = &quot;browser.places.importBookmarksHTML&quot;;</span>
<a href="#l46.66"></a><span id="l46.66" class="difflineplus">+const PREF_RESTORE_DEFAULT_BOOKMARKS = &quot;browser.bookmarks.restore_default_bookmarks&quot;;</span>
<a href="#l46.67"></a><span id="l46.67" class="difflineplus">+</span>
<a href="#l46.68"></a><span id="l46.68" class="difflineplus">+const SMART_BOOKMARKS_ANNO = &quot;Places/SmartBookmark&quot;;</span>
<a href="#l46.69"></a><span id="l46.69" class="difflineplus">+</span>
<a href="#l46.70"></a><span id="l46.70" class="difflineplus">+/**</span>
<a href="#l46.71"></a><span id="l46.71" class="difflineplus">+ * Rebuilds smart bookmarks listening to console output to report any message or</span>
<a href="#l46.72"></a><span id="l46.72" class="difflineplus">+ * exception generated when calling ensurePlacesDefaultQueriesInitialized().</span>
<a href="#l46.73"></a><span id="l46.73" class="difflineplus">+ */</span>
<a href="#l46.74"></a><span id="l46.74" class="difflineplus">+function rebuildSmartBookmarks() {</span>
<a href="#l46.75"></a><span id="l46.75" class="difflineplus">+  var consoleListener = {</span>
<a href="#l46.76"></a><span id="l46.76" class="difflineplus">+    observe: function(aMsg) {</span>
<a href="#l46.77"></a><span id="l46.77" class="difflineplus">+      print(&quot;Got console message: &quot; + aMsg.message);</span>
<a href="#l46.78"></a><span id="l46.78" class="difflineplus">+    },</span>
<a href="#l46.79"></a><span id="l46.79" class="difflineplus">+</span>
<a href="#l46.80"></a><span id="l46.80" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l46.81"></a><span id="l46.81" class="difflineplus">+      Ci.nsIConsoleListener</span>
<a href="#l46.82"></a><span id="l46.82" class="difflineplus">+    ]),</span>
<a href="#l46.83"></a><span id="l46.83" class="difflineplus">+  };</span>
<a href="#l46.84"></a><span id="l46.84" class="difflineplus">+  var console = Cc[&quot;@mozilla.org/consoleservice;1&quot;].</span>
<a href="#l46.85"></a><span id="l46.85" class="difflineplus">+                getService(Ci.nsIConsoleService);</span>
<a href="#l46.86"></a><span id="l46.86" class="difflineplus">+  console.reset();</span>
<a href="#l46.87"></a><span id="l46.87" class="difflineplus">+  console.registerListener(consoleListener);</span>
<a href="#l46.88"></a><span id="l46.88" class="difflineplus">+  var bg = Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].</span>
<a href="#l46.89"></a><span id="l46.89" class="difflineplus">+           getService(Ci.nsISuiteGlue);</span>
<a href="#l46.90"></a><span id="l46.90" class="difflineplus">+  bg.ensurePlacesDefaultQueriesInitialized();</span>
<a href="#l46.91"></a><span id="l46.91" class="difflineplus">+  console.unregisterListener(consoleListener);</span>
<a href="#l46.92"></a><span id="l46.92" class="difflineplus">+}</span>
<a href="#l46.93"></a><span id="l46.93" class="difflineplus">+</span>
<a href="#l46.94"></a><span id="l46.94" class="difflineplus">+</span>
<a href="#l46.95"></a><span id="l46.95" class="difflineplus">+var tests = [];</span>
<a href="#l46.96"></a><span id="l46.96" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l46.97"></a><span id="l46.97" class="difflineplus">+</span>
<a href="#l46.98"></a><span id="l46.98" class="difflineplus">+tests.push({</span>
<a href="#l46.99"></a><span id="l46.99" class="difflineplus">+  description: &quot;All smart bookmarks are created if smart bookmarks version is 0.&quot;,</span>
<a href="#l46.100"></a><span id="l46.100" class="difflineplus">+  exec: function() {</span>
<a href="#l46.101"></a><span id="l46.101" class="difflineplus">+    // Sanity check: we should have default bookmark.</span>
<a href="#l46.102"></a><span id="l46.102" class="difflineplus">+    do_check_neq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l46.103"></a><span id="l46.103" class="difflineplus">+    do_check_neq(bs.getIdForItemAt(bs.bookmarksMenuFolder, 0), -1);</span>
<a href="#l46.104"></a><span id="l46.104" class="difflineplus">+</span>
<a href="#l46.105"></a><span id="l46.105" class="difflineplus">+    // Set preferences.</span>
<a href="#l46.106"></a><span id="l46.106" class="difflineplus">+    ps.setIntPref(PREF_SMART_BOOKMARKS_VERSION, 0);</span>
<a href="#l46.107"></a><span id="l46.107" class="difflineplus">+</span>
<a href="#l46.108"></a><span id="l46.108" class="difflineplus">+    rebuildSmartBookmarks();</span>
<a href="#l46.109"></a><span id="l46.109" class="difflineplus">+</span>
<a href="#l46.110"></a><span id="l46.110" class="difflineplus">+    // Count items.</span>
<a href="#l46.111"></a><span id="l46.111" class="difflineplus">+    do_check_eq(countFolderChildren(bs.toolbarFolder),</span>
<a href="#l46.112"></a><span id="l46.112" class="difflineplus">+                SMART_BOOKMARKS_ON_TOOLBAR + DEFAULT_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l46.113"></a><span id="l46.113" class="difflineplus">+    do_check_eq(countFolderChildren(bs.bookmarksMenuFolder),</span>
<a href="#l46.114"></a><span id="l46.114" class="difflineplus">+                SMART_BOOKMARKS_ON_MENU + DEFAULT_BOOKMARKS_ON_MENU);</span>
<a href="#l46.115"></a><span id="l46.115" class="difflineplus">+</span>
<a href="#l46.116"></a><span id="l46.116" class="difflineplus">+    // Check version has been updated.</span>
<a href="#l46.117"></a><span id="l46.117" class="difflineplus">+    do_check_eq(ps.getIntPref(PREF_SMART_BOOKMARKS_VERSION),</span>
<a href="#l46.118"></a><span id="l46.118" class="difflineplus">+                SMART_BOOKMARKS_VERSION);</span>
<a href="#l46.119"></a><span id="l46.119" class="difflineplus">+</span>
<a href="#l46.120"></a><span id="l46.120" class="difflineplus">+    next_test();</span>
<a href="#l46.121"></a><span id="l46.121" class="difflineplus">+  }</span>
<a href="#l46.122"></a><span id="l46.122" class="difflineplus">+});</span>
<a href="#l46.123"></a><span id="l46.123" class="difflineplus">+</span>
<a href="#l46.124"></a><span id="l46.124" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l46.125"></a><span id="l46.125" class="difflineplus">+</span>
<a href="#l46.126"></a><span id="l46.126" class="difflineplus">+tests.push({</span>
<a href="#l46.127"></a><span id="l46.127" class="difflineplus">+  description: &quot;An existing smart bookmark is replaced when version changes.&quot;,</span>
<a href="#l46.128"></a><span id="l46.128" class="difflineplus">+  exec: function() {</span>
<a href="#l46.129"></a><span id="l46.129" class="difflineplus">+    // Sanity check: we have a smart bookmark on the toolbar.</span>
<a href="#l46.130"></a><span id="l46.130" class="difflineplus">+    var itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l46.131"></a><span id="l46.131" class="difflineplus">+    do_check_neq(itemId, -1);</span>
<a href="#l46.132"></a><span id="l46.132" class="difflineplus">+    do_check_true(as.itemHasAnnotation(itemId, SMART_BOOKMARKS_ANNO));</span>
<a href="#l46.133"></a><span id="l46.133" class="difflineplus">+    // Change its title.</span>
<a href="#l46.134"></a><span id="l46.134" class="difflineplus">+    bs.setItemTitle(itemId, &quot;new title&quot;);</span>
<a href="#l46.135"></a><span id="l46.135" class="difflineplus">+    do_check_eq(bs.getItemTitle(itemId), &quot;new title&quot;);</span>
<a href="#l46.136"></a><span id="l46.136" class="difflineplus">+</span>
<a href="#l46.137"></a><span id="l46.137" class="difflineplus">+    // Sanity check items.</span>
<a href="#l46.138"></a><span id="l46.138" class="difflineplus">+    do_check_eq(countFolderChildren(bs.toolbarFolder),</span>
<a href="#l46.139"></a><span id="l46.139" class="difflineplus">+                SMART_BOOKMARKS_ON_TOOLBAR + DEFAULT_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l46.140"></a><span id="l46.140" class="difflineplus">+    do_check_eq(countFolderChildren(bs.bookmarksMenuFolder),</span>
<a href="#l46.141"></a><span id="l46.141" class="difflineplus">+                SMART_BOOKMARKS_ON_MENU + DEFAULT_BOOKMARKS_ON_MENU);</span>
<a href="#l46.142"></a><span id="l46.142" class="difflineplus">+</span>
<a href="#l46.143"></a><span id="l46.143" class="difflineplus">+    // Set preferences.</span>
<a href="#l46.144"></a><span id="l46.144" class="difflineplus">+    ps.setIntPref(PREF_SMART_BOOKMARKS_VERSION, 1);</span>
<a href="#l46.145"></a><span id="l46.145" class="difflineplus">+</span>
<a href="#l46.146"></a><span id="l46.146" class="difflineplus">+    rebuildSmartBookmarks();</span>
<a href="#l46.147"></a><span id="l46.147" class="difflineplus">+</span>
<a href="#l46.148"></a><span id="l46.148" class="difflineplus">+    // Count items.</span>
<a href="#l46.149"></a><span id="l46.149" class="difflineplus">+    do_check_eq(countFolderChildren(bs.toolbarFolder),</span>
<a href="#l46.150"></a><span id="l46.150" class="difflineplus">+                SMART_BOOKMARKS_ON_TOOLBAR + DEFAULT_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l46.151"></a><span id="l46.151" class="difflineplus">+    do_check_eq(countFolderChildren(bs.bookmarksMenuFolder),</span>
<a href="#l46.152"></a><span id="l46.152" class="difflineplus">+                SMART_BOOKMARKS_ON_MENU + DEFAULT_BOOKMARKS_ON_MENU);</span>
<a href="#l46.153"></a><span id="l46.153" class="difflineplus">+</span>
<a href="#l46.154"></a><span id="l46.154" class="difflineplus">+    // Check smart bookmark has been replaced, itemId has changed.</span>
<a href="#l46.155"></a><span id="l46.155" class="difflineplus">+    itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l46.156"></a><span id="l46.156" class="difflineplus">+    do_check_neq(itemId, -1);</span>
<a href="#l46.157"></a><span id="l46.157" class="difflineplus">+    do_check_neq(bs.getItemTitle(itemId), &quot;new title&quot;);</span>
<a href="#l46.158"></a><span id="l46.158" class="difflineplus">+    do_check_true(as.itemHasAnnotation(itemId, SMART_BOOKMARKS_ANNO));</span>
<a href="#l46.159"></a><span id="l46.159" class="difflineplus">+</span>
<a href="#l46.160"></a><span id="l46.160" class="difflineplus">+    // Check version has been updated.</span>
<a href="#l46.161"></a><span id="l46.161" class="difflineplus">+    do_check_eq(ps.getIntPref(PREF_SMART_BOOKMARKS_VERSION),</span>
<a href="#l46.162"></a><span id="l46.162" class="difflineplus">+                SMART_BOOKMARKS_VERSION);</span>
<a href="#l46.163"></a><span id="l46.163" class="difflineplus">+</span>
<a href="#l46.164"></a><span id="l46.164" class="difflineplus">+    next_test();</span>
<a href="#l46.165"></a><span id="l46.165" class="difflineplus">+  }</span>
<a href="#l46.166"></a><span id="l46.166" class="difflineplus">+});</span>
<a href="#l46.167"></a><span id="l46.167" class="difflineplus">+</span>
<a href="#l46.168"></a><span id="l46.168" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l46.169"></a><span id="l46.169" class="difflineplus">+</span>
<a href="#l46.170"></a><span id="l46.170" class="difflineplus">+tests.push({</span>
<a href="#l46.171"></a><span id="l46.171" class="difflineplus">+  description: &quot;An explicitly removed smart bookmark should not be recreated.&quot;,</span>
<a href="#l46.172"></a><span id="l46.172" class="difflineplus">+  exec: function() {   </span>
<a href="#l46.173"></a><span id="l46.173" class="difflineplus">+    // Remove toolbar's smart bookmarks</span>
<a href="#l46.174"></a><span id="l46.174" class="difflineplus">+    bs.removeItem(bs.getIdForItemAt(bs.toolbarFolder, 0));</span>
<a href="#l46.175"></a><span id="l46.175" class="difflineplus">+</span>
<a href="#l46.176"></a><span id="l46.176" class="difflineplus">+    // Sanity check items.</span>
<a href="#l46.177"></a><span id="l46.177" class="difflineplus">+    do_check_eq(countFolderChildren(bs.toolbarFolder),</span>
<a href="#l46.178"></a><span id="l46.178" class="difflineplus">+                DEFAULT_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l46.179"></a><span id="l46.179" class="difflineplus">+    do_check_eq(countFolderChildren(bs.bookmarksMenuFolder),</span>
<a href="#l46.180"></a><span id="l46.180" class="difflineplus">+                SMART_BOOKMARKS_ON_MENU + DEFAULT_BOOKMARKS_ON_MENU);</span>
<a href="#l46.181"></a><span id="l46.181" class="difflineplus">+</span>
<a href="#l46.182"></a><span id="l46.182" class="difflineplus">+    // Set preferences.</span>
<a href="#l46.183"></a><span id="l46.183" class="difflineplus">+    ps.setIntPref(PREF_SMART_BOOKMARKS_VERSION, 1);</span>
<a href="#l46.184"></a><span id="l46.184" class="difflineplus">+</span>
<a href="#l46.185"></a><span id="l46.185" class="difflineplus">+    rebuildSmartBookmarks();</span>
<a href="#l46.186"></a><span id="l46.186" class="difflineplus">+</span>
<a href="#l46.187"></a><span id="l46.187" class="difflineplus">+    // Count items.</span>
<a href="#l46.188"></a><span id="l46.188" class="difflineplus">+    // We should not have recreated the smart bookmark on toolbar.</span>
<a href="#l46.189"></a><span id="l46.189" class="difflineplus">+    do_check_eq(countFolderChildren(bs.toolbarFolder),</span>
<a href="#l46.190"></a><span id="l46.190" class="difflineplus">+                DEFAULT_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l46.191"></a><span id="l46.191" class="difflineplus">+    do_check_eq(countFolderChildren(bs.bookmarksMenuFolder),</span>
<a href="#l46.192"></a><span id="l46.192" class="difflineplus">+                SMART_BOOKMARKS_ON_MENU + DEFAULT_BOOKMARKS_ON_MENU);</span>
<a href="#l46.193"></a><span id="l46.193" class="difflineplus">+</span>
<a href="#l46.194"></a><span id="l46.194" class="difflineplus">+    // Check version has been updated.</span>
<a href="#l46.195"></a><span id="l46.195" class="difflineplus">+    do_check_eq(ps.getIntPref(PREF_SMART_BOOKMARKS_VERSION),</span>
<a href="#l46.196"></a><span id="l46.196" class="difflineplus">+                SMART_BOOKMARKS_VERSION);</span>
<a href="#l46.197"></a><span id="l46.197" class="difflineplus">+</span>
<a href="#l46.198"></a><span id="l46.198" class="difflineplus">+    next_test();</span>
<a href="#l46.199"></a><span id="l46.199" class="difflineplus">+  }</span>
<a href="#l46.200"></a><span id="l46.200" class="difflineplus">+});</span>
<a href="#l46.201"></a><span id="l46.201" class="difflineplus">+</span>
<a href="#l46.202"></a><span id="l46.202" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l46.203"></a><span id="l46.203" class="difflineplus">+</span>
<a href="#l46.204"></a><span id="l46.204" class="difflineplus">+tests.push({</span>
<a href="#l46.205"></a><span id="l46.205" class="difflineplus">+  description: &quot;Even if a smart bookmark has been removed recreate it if version is 0.&quot;,</span>
<a href="#l46.206"></a><span id="l46.206" class="difflineplus">+  exec: function() {</span>
<a href="#l46.207"></a><span id="l46.207" class="difflineplus">+    // Sanity check items.</span>
<a href="#l46.208"></a><span id="l46.208" class="difflineplus">+    do_check_eq(countFolderChildren(bs.toolbarFolder),</span>
<a href="#l46.209"></a><span id="l46.209" class="difflineplus">+                DEFAULT_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l46.210"></a><span id="l46.210" class="difflineplus">+    do_check_eq(countFolderChildren(bs.bookmarksMenuFolder),</span>
<a href="#l46.211"></a><span id="l46.211" class="difflineplus">+                SMART_BOOKMARKS_ON_MENU + DEFAULT_BOOKMARKS_ON_MENU);</span>
<a href="#l46.212"></a><span id="l46.212" class="difflineplus">+</span>
<a href="#l46.213"></a><span id="l46.213" class="difflineplus">+    // Set preferences.</span>
<a href="#l46.214"></a><span id="l46.214" class="difflineplus">+    ps.setIntPref(PREF_SMART_BOOKMARKS_VERSION, 0);</span>
<a href="#l46.215"></a><span id="l46.215" class="difflineplus">+</span>
<a href="#l46.216"></a><span id="l46.216" class="difflineplus">+    rebuildSmartBookmarks();</span>
<a href="#l46.217"></a><span id="l46.217" class="difflineplus">+</span>
<a href="#l46.218"></a><span id="l46.218" class="difflineplus">+    // Count items.</span>
<a href="#l46.219"></a><span id="l46.219" class="difflineplus">+    // We should not have recreated the smart bookmark on toolbar.</span>
<a href="#l46.220"></a><span id="l46.220" class="difflineplus">+    do_check_eq(countFolderChildren(bs.toolbarFolder),</span>
<a href="#l46.221"></a><span id="l46.221" class="difflineplus">+                SMART_BOOKMARKS_ON_TOOLBAR + DEFAULT_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l46.222"></a><span id="l46.222" class="difflineplus">+    do_check_eq(countFolderChildren(bs.bookmarksMenuFolder),</span>
<a href="#l46.223"></a><span id="l46.223" class="difflineplus">+                SMART_BOOKMARKS_ON_MENU + DEFAULT_BOOKMARKS_ON_MENU);</span>
<a href="#l46.224"></a><span id="l46.224" class="difflineplus">+</span>
<a href="#l46.225"></a><span id="l46.225" class="difflineplus">+    // Check version has been updated.</span>
<a href="#l46.226"></a><span id="l46.226" class="difflineplus">+    do_check_eq(ps.getIntPref(PREF_SMART_BOOKMARKS_VERSION),</span>
<a href="#l46.227"></a><span id="l46.227" class="difflineplus">+                SMART_BOOKMARKS_VERSION);</span>
<a href="#l46.228"></a><span id="l46.228" class="difflineplus">+</span>
<a href="#l46.229"></a><span id="l46.229" class="difflineplus">+    next_test();</span>
<a href="#l46.230"></a><span id="l46.230" class="difflineplus">+  }</span>
<a href="#l46.231"></a><span id="l46.231" class="difflineplus">+});</span>
<a href="#l46.232"></a><span id="l46.232" class="difflineplus">+//------------------------------------------------------------------------------</span>
<a href="#l46.233"></a><span id="l46.233" class="difflineplus">+</span>
<a href="#l46.234"></a><span id="l46.234" class="difflineplus">+function countFolderChildren(aFolderItemId) {</span>
<a href="#l46.235"></a><span id="l46.235" class="difflineplus">+  var query = hs.getNewQuery();</span>
<a href="#l46.236"></a><span id="l46.236" class="difflineplus">+  query.setFolders([aFolderItemId], 1);</span>
<a href="#l46.237"></a><span id="l46.237" class="difflineplus">+  var options = hs.getNewQueryOptions();</span>
<a href="#l46.238"></a><span id="l46.238" class="difflineplus">+  var rootNode = hs.executeQuery(query, options).root;</span>
<a href="#l46.239"></a><span id="l46.239" class="difflineplus">+  rootNode.containerOpen = true;</span>
<a href="#l46.240"></a><span id="l46.240" class="difflineplus">+  var cc = rootNode.childCount;</span>
<a href="#l46.241"></a><span id="l46.241" class="difflineplus">+  // Dump contents.</span>
<a href="#l46.242"></a><span id="l46.242" class="difflineplus">+  for (var i = 0; i &lt; cc ; i++) {</span>
<a href="#l46.243"></a><span id="l46.243" class="difflineplus">+    var node = rootNode.getChild(i);</span>
<a href="#l46.244"></a><span id="l46.244" class="difflineplus">+    print(&quot;Found child at &quot; + i + &quot;: &quot; + node.title);</span>
<a href="#l46.245"></a><span id="l46.245" class="difflineplus">+  }</span>
<a href="#l46.246"></a><span id="l46.246" class="difflineplus">+  rootNode.containerOpen = false;</span>
<a href="#l46.247"></a><span id="l46.247" class="difflineplus">+  return cc;</span>
<a href="#l46.248"></a><span id="l46.248" class="difflineplus">+}</span>
<a href="#l46.249"></a><span id="l46.249" class="difflineplus">+</span>
<a href="#l46.250"></a><span id="l46.250" class="difflineplus">+var testIndex = 0;</span>
<a href="#l46.251"></a><span id="l46.251" class="difflineplus">+function next_test() {</span>
<a href="#l46.252"></a><span id="l46.252" class="difflineplus">+  if (tests.length) {</span>
<a href="#l46.253"></a><span id="l46.253" class="difflineplus">+    // Execute next test.</span>
<a href="#l46.254"></a><span id="l46.254" class="difflineplus">+    let test = tests.shift();</span>
<a href="#l46.255"></a><span id="l46.255" class="difflineplus">+    print(&quot;\nTEST &quot; + (++testIndex) + &quot;: &quot; + test.description);</span>
<a href="#l46.256"></a><span id="l46.256" class="difflineplus">+    test.exec();</span>
<a href="#l46.257"></a><span id="l46.257" class="difflineplus">+  }</span>
<a href="#l46.258"></a><span id="l46.258" class="difflineplus">+  else {</span>
<a href="#l46.259"></a><span id="l46.259" class="difflineplus">+    // Clean up database from all bookmarks.</span>
<a href="#l46.260"></a><span id="l46.260" class="difflineplus">+    remove_all_bookmarks();</span>
<a href="#l46.261"></a><span id="l46.261" class="difflineplus">+    do_test_finished();</span>
<a href="#l46.262"></a><span id="l46.262" class="difflineplus">+  }</span>
<a href="#l46.263"></a><span id="l46.263" class="difflineplus">+}</span>
<a href="#l46.264"></a><span id="l46.264" class="difflineplus">+</span>
<a href="#l46.265"></a><span id="l46.265" class="difflineplus">+function run_test() {</span>
<a href="#l46.266"></a><span id="l46.266" class="difflineplus">+  // Bug 510219.</span>
<a href="#l46.267"></a><span id="l46.267" class="difflineplus">+  // Disabled on Windows due to almost permanent failure.</span>
<a href="#l46.268"></a><span id="l46.268" class="difflineplus">+  if (&quot;@mozilla.org/windows-registry-key;1&quot; in Components.classes)</span>
<a href="#l46.269"></a><span id="l46.269" class="difflineplus">+    return;</span>
<a href="#l46.270"></a><span id="l46.270" class="difflineplus">+</span>
<a href="#l46.271"></a><span id="l46.271" class="difflineplus">+  do_test_pending();</span>
<a href="#l46.272"></a><span id="l46.272" class="difflineplus">+</span>
<a href="#l46.273"></a><span id="l46.273" class="difflineplus">+  remove_bookmarks_html();</span>
<a href="#l46.274"></a><span id="l46.274" class="difflineplus">+  remove_all_JSON_backups();</span>
<a href="#l46.275"></a><span id="l46.275" class="difflineplus">+</span>
<a href="#l46.276"></a><span id="l46.276" class="difflineplus">+  // Initialize SuiteGlue.</span>
<a href="#l46.277"></a><span id="l46.277" class="difflineplus">+  var bg = Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].</span>
<a href="#l46.278"></a><span id="l46.278" class="difflineplus">+           getService(Ci.nsISuiteGlue);</span>
<a href="#l46.279"></a><span id="l46.279" class="difflineplus">+  bg.QueryInterface(Ci.nsIObserver).observe(null, &quot;places-init-complete&quot;, null);</span>
<a href="#l46.280"></a><span id="l46.280" class="difflineplus">+</span>
<a href="#l46.281"></a><span id="l46.281" class="difflineplus">+  // Ensure preferences status.</span>
<a href="#l46.282"></a><span id="l46.282" class="difflineplus">+  do_check_false(ps.getBoolPref(PREF_AUTO_EXPORT_HTML));</span>
<a href="#l46.283"></a><span id="l46.283" class="difflineplus">+  // XXXkairo: might get set due to the different logic of SeaMonkey imports</span>
<a href="#l46.284"></a><span id="l46.284" class="difflineplus">+  //           but there could be some real bug so import is set and restore not</span>
<a href="#l46.285"></a><span id="l46.285" class="difflineplus">+  try {</span>
<a href="#l46.286"></a><span id="l46.286" class="difflineplus">+    do_check_false(ps.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l46.287"></a><span id="l46.287" class="difflineplus">+    // do_throw(&quot;importBookmarksHTML pref should not exist&quot;);</span>
<a href="#l46.288"></a><span id="l46.288" class="difflineplus">+  }</span>
<a href="#l46.289"></a><span id="l46.289" class="difflineplus">+  catch(ex) {}</span>
<a href="#l46.290"></a><span id="l46.290" class="difflineplus">+  try {</span>
<a href="#l46.291"></a><span id="l46.291" class="difflineplus">+    do_check_false(ps.getBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS));</span>
<a href="#l46.292"></a><span id="l46.292" class="difflineplus">+  }</span>
<a href="#l46.293"></a><span id="l46.293" class="difflineplus">+  catch(ex) {}</span>
<a href="#l46.294"></a><span id="l46.294" class="difflineplus">+</span>
<a href="#l46.295"></a><span id="l46.295" class="difflineplus">+  // Kick-off tests.</span>
<a href="#l46.296"></a><span id="l46.296" class="difflineplus">+  next_test();</span>
<a href="#l46.297"></a><span id="l46.297" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1">new file mode 100644</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineminus">--- /dev/null</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_clearHistory_shutdown.js</span>
<a href="#l47.4"></a><span id="l47.4" class="difflineat">@@ -0,0 +1,114 @@</span>
<a href="#l47.5"></a><span id="l47.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l47.6"></a><span id="l47.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l47.7"></a><span id="l47.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l47.8"></a><span id="l47.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l47.9"></a><span id="l47.9" class="difflineplus">+ *</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineplus">+ *</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineplus">+ * License.</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineplus">+ *</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineplus">+ * The Original Code is Places Unit Test code.</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineplus">+ *</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l47.23"></a><span id="l47.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l47.25"></a><span id="l47.25" class="difflineplus">+ *</span>
<a href="#l47.26"></a><span id="l47.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l47.27"></a><span id="l47.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l47.28"></a><span id="l47.28" class="difflineplus">+ *</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l47.30"></a><span id="l47.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l47.31"></a><span id="l47.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l47.34"></a><span id="l47.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l47.35"></a><span id="l47.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l47.36"></a><span id="l47.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l47.37"></a><span id="l47.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l47.38"></a><span id="l47.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l47.39"></a><span id="l47.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l47.40"></a><span id="l47.40" class="difflineplus">+ *</span>
<a href="#l47.41"></a><span id="l47.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l47.42"></a><span id="l47.42" class="difflineplus">+</span>
<a href="#l47.43"></a><span id="l47.43" class="difflineplus">+/**</span>
<a href="#l47.44"></a><span id="l47.44" class="difflineplus">+ * Tests that requesting clear history at shutdown will really clear history.</span>
<a href="#l47.45"></a><span id="l47.45" class="difflineplus">+ */</span>
<a href="#l47.46"></a><span id="l47.46" class="difflineplus">+</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineplus">+const URIS = [</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineplus">+  &quot;http://a.example1.com/&quot;</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineplus">+, &quot;http://b.example1.com/&quot;</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineplus">+, &quot;http://b.example2.com/&quot;</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineplus">+, &quot;http://c.example3.com/&quot;</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineplus">+];</span>
<a href="#l47.53"></a><span id="l47.53" class="difflineplus">+</span>
<a href="#l47.54"></a><span id="l47.54" class="difflineplus">+let expirationObserver = {</span>
<a href="#l47.55"></a><span id="l47.55" class="difflineplus">+  observe: function observe(aSubject, aTopic, aData) {</span>
<a href="#l47.56"></a><span id="l47.56" class="difflineplus">+    print(&quot;Finished expiration.&quot;);</span>
<a href="#l47.57"></a><span id="l47.57" class="difflineplus">+    Services.obs.removeObserver(expirationObserver,</span>
<a href="#l47.58"></a><span id="l47.58" class="difflineplus">+                                PlacesUtils.TOPIC_EXPIRATION_FINISHED);</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineplus">+</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineplus">+    let db = PlacesUtils.history</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineplus">+                        .QueryInterface(Ci.nsPIPlacesDatabase)</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineplus">+                        .DBConnection;</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineplus">+</span>
<a href="#l47.64"></a><span id="l47.64" class="difflineplus">+    let stmt = db.createStatement(</span>
<a href="#l47.65"></a><span id="l47.65" class="difflineplus">+      &quot;SELECT id FROM moz_places_temp WHERE url = :page_url &quot;</span>
<a href="#l47.66"></a><span id="l47.66" class="difflineplus">+    + &quot;UNION ALL &quot;</span>
<a href="#l47.67"></a><span id="l47.67" class="difflineplus">+    + &quot;SELECT id FROM moz_places WHERE url = :page_url &quot;</span>
<a href="#l47.68"></a><span id="l47.68" class="difflineplus">+    );</span>
<a href="#l47.69"></a><span id="l47.69" class="difflineplus">+</span>
<a href="#l47.70"></a><span id="l47.70" class="difflineplus">+    try {</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineplus">+      URIS.forEach(function(aUrl) {</span>
<a href="#l47.72"></a><span id="l47.72" class="difflineplus">+        stmt.params.page_url = aUrl;</span>
<a href="#l47.73"></a><span id="l47.73" class="difflineplus">+        do_check_false(stmt.executeStep());</span>
<a href="#l47.74"></a><span id="l47.74" class="difflineplus">+        stmt.reset();</span>
<a href="#l47.75"></a><span id="l47.75" class="difflineplus">+      });</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineplus">+    } finally {</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineplus">+      stmt.finalize();</span>
<a href="#l47.78"></a><span id="l47.78" class="difflineplus">+    }</span>
<a href="#l47.79"></a><span id="l47.79" class="difflineplus">+</span>
<a href="#l47.80"></a><span id="l47.80" class="difflineplus">+    do_test_finished();</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineplus">+  }</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineplus">+}</span>
<a href="#l47.83"></a><span id="l47.83" class="difflineplus">+</span>
<a href="#l47.84"></a><span id="l47.84" class="difflineplus">+let timeInMicroseconds = Date.now() * 1000;</span>
<a href="#l47.85"></a><span id="l47.85" class="difflineplus">+</span>
<a href="#l47.86"></a><span id="l47.86" class="difflineplus">+function run_test() {</span>
<a href="#l47.87"></a><span id="l47.87" class="difflineplus">+  do_test_pending();</span>
<a href="#l47.88"></a><span id="l47.88" class="difflineplus">+</span>
<a href="#l47.89"></a><span id="l47.89" class="difflineplus">+  print(&quot;Initialize suiteglue before Places&quot;);</span>
<a href="#l47.90"></a><span id="l47.90" class="difflineplus">+  Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].getService(Ci.nsISuiteGlue);</span>
<a href="#l47.91"></a><span id="l47.91" class="difflineplus">+</span>
<a href="#l47.92"></a><span id="l47.92" class="difflineplus">+  Services.prefs.setBoolPref(&quot;privacy.item.history&quot;, true);</span>
<a href="#l47.93"></a><span id="l47.93" class="difflineplus">+  Services.prefs.setBoolPref(&quot;privacy.item.urlbar&quot;, true);</span>
<a href="#l47.94"></a><span id="l47.94" class="difflineplus">+  Services.prefs.setBoolPref(&quot;privacy.item.formdata&quot;, true);</span>
<a href="#l47.95"></a><span id="l47.95" class="difflineplus">+  Services.prefs.setBoolPref(&quot;privacy.item.passwords&quot;, true);</span>
<a href="#l47.96"></a><span id="l47.96" class="difflineplus">+  Services.prefs.setBoolPref(&quot;privacy.item.downloads&quot;, true);</span>
<a href="#l47.97"></a><span id="l47.97" class="difflineplus">+  Services.prefs.setBoolPref(&quot;privacy.item.cookies&quot;, true);</span>
<a href="#l47.98"></a><span id="l47.98" class="difflineplus">+  Services.prefs.setBoolPref(&quot;privacy.item.cache&quot;, true);</span>
<a href="#l47.99"></a><span id="l47.99" class="difflineplus">+  Services.prefs.setBoolPref(&quot;privacy.item.sessions&quot;, true);</span>
<a href="#l47.100"></a><span id="l47.100" class="difflineplus">+  Services.prefs.setBoolPref(&quot;privacy.item.offlineApps&quot;, true);</span>
<a href="#l47.101"></a><span id="l47.101" class="difflineplus">+</span>
<a href="#l47.102"></a><span id="l47.102" class="difflineplus">+  Services.prefs.setBoolPref(&quot;privacy.sanitize.sanitizeOnShutdown&quot;, true);</span>
<a href="#l47.103"></a><span id="l47.103" class="difflineplus">+  Services.prefs.setBoolPref(&quot;privacy.sanitize.promptOnSanitize&quot;, false);</span>
<a href="#l47.104"></a><span id="l47.104" class="difflineplus">+</span>
<a href="#l47.105"></a><span id="l47.105" class="difflineplus">+  print(&quot;Add visits.&quot;);</span>
<a href="#l47.106"></a><span id="l47.106" class="difflineplus">+  URIS.forEach(function(aUrl) {</span>
<a href="#l47.107"></a><span id="l47.107" class="difflineplus">+    PlacesUtils.history.addVisit(uri(aUrl), timeInMicroseconds++, null,</span>
<a href="#l47.108"></a><span id="l47.108" class="difflineplus">+                                 PlacesUtils.history.TRANSITION_TYPED,</span>
<a href="#l47.109"></a><span id="l47.109" class="difflineplus">+                                 false, 0);</span>
<a href="#l47.110"></a><span id="l47.110" class="difflineplus">+  });</span>
<a href="#l47.111"></a><span id="l47.111" class="difflineplus">+</span>
<a href="#l47.112"></a><span id="l47.112" class="difflineplus">+  print(&quot;Wait expiration.&quot;);</span>
<a href="#l47.113"></a><span id="l47.113" class="difflineplus">+  Services.obs.addObserver(expirationObserver,</span>
<a href="#l47.114"></a><span id="l47.114" class="difflineplus">+                           PlacesUtils.TOPIC_EXPIRATION_FINISHED, false);</span>
<a href="#l47.115"></a><span id="l47.115" class="difflineplus">+  print(&quot;Simulate shutdown.&quot;);</span>
<a href="#l47.116"></a><span id="l47.116" class="difflineplus">+  PlacesUtils.history.QueryInterface(Ci.nsIObserver)</span>
<a href="#l47.117"></a><span id="l47.117" class="difflineplus">+                     .observe(null, TOPIC_GLOBAL_SHUTDOWN, null);</span>
<a href="#l47.118"></a><span id="l47.118" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1">new file mode 100644</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineminus">--- /dev/null</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_leftpane_corruption_handling.js</span>
<a href="#l48.4"></a><span id="l48.4" class="difflineat">@@ -0,0 +1,222 @@</span>
<a href="#l48.5"></a><span id="l48.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l48.6"></a><span id="l48.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l48.7"></a><span id="l48.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l48.8"></a><span id="l48.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l48.9"></a><span id="l48.9" class="difflineplus">+ *</span>
<a href="#l48.10"></a><span id="l48.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l48.11"></a><span id="l48.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+ *</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineplus">+ * License.</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineplus">+ *</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineplus">+ * The Original Code is Places Unit Test code.</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineplus">+ *</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l48.25"></a><span id="l48.25" class="difflineplus">+ *</span>
<a href="#l48.26"></a><span id="l48.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l48.27"></a><span id="l48.27" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l48.28"></a><span id="l48.28" class="difflineplus">+ *</span>
<a href="#l48.29"></a><span id="l48.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l48.35"></a><span id="l48.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l48.36"></a><span id="l48.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l48.37"></a><span id="l48.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l48.40"></a><span id="l48.40" class="difflineplus">+ *</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineplus">+</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineplus">+/**</span>
<a href="#l48.44"></a><span id="l48.44" class="difflineplus">+ * Tests that we build a working leftpane in various corruption situations.</span>
<a href="#l48.45"></a><span id="l48.45" class="difflineplus">+ */</span>
<a href="#l48.46"></a><span id="l48.46" class="difflineplus">+</span>
<a href="#l48.47"></a><span id="l48.47" class="difflineplus">+// Used to store the original leftPaneFolderId getter.</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineplus">+let gLeftPaneFolderIdGetter;</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineplus">+let gAllBookmarksFolderIdGetter;</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineplus">+// Used to store the original left Pane status as a JSON string.</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineplus">+let gReferenceJSON;</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineplus">+let gLeftPaneFolderId;</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineplus">+// Third party annotated folder.</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineplus">+let gFolderId;</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineplus">+</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineplus">+// Corruption cases.</span>
<a href="#l48.57"></a><span id="l48.57" class="difflineplus">+let gTests = [</span>
<a href="#l48.58"></a><span id="l48.58" class="difflineplus">+</span>
<a href="#l48.59"></a><span id="l48.59" class="difflineplus">+  function test1() {</span>
<a href="#l48.60"></a><span id="l48.60" class="difflineplus">+    print(&quot;1. Do nothing, checks test calibration.&quot;);</span>
<a href="#l48.61"></a><span id="l48.61" class="difflineplus">+  },</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineplus">+</span>
<a href="#l48.63"></a><span id="l48.63" class="difflineplus">+  function test2() {</span>
<a href="#l48.64"></a><span id="l48.64" class="difflineplus">+    print(&quot;2. Delete the left pane folder.&quot;);</span>
<a href="#l48.65"></a><span id="l48.65" class="difflineplus">+    PlacesUtils.bookmarks.removeItem(gLeftPaneFolderId);</span>
<a href="#l48.66"></a><span id="l48.66" class="difflineplus">+  },</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineplus">+</span>
<a href="#l48.68"></a><span id="l48.68" class="difflineplus">+  function test3() {</span>
<a href="#l48.69"></a><span id="l48.69" class="difflineplus">+    print(&quot;3. Delete a child of the left pane folder.&quot;);</span>
<a href="#l48.70"></a><span id="l48.70" class="difflineplus">+    let id = PlacesUtils.bookmarks.getIdForItemAt(gLeftPaneFolderId, 0);</span>
<a href="#l48.71"></a><span id="l48.71" class="difflineplus">+    PlacesUtils.bookmarks.removeItem(id);</span>
<a href="#l48.72"></a><span id="l48.72" class="difflineplus">+  },</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineplus">+</span>
<a href="#l48.74"></a><span id="l48.74" class="difflineplus">+  function test4() {</span>
<a href="#l48.75"></a><span id="l48.75" class="difflineplus">+    print(&quot;4. Delete AllBookmarks.&quot;);</span>
<a href="#l48.76"></a><span id="l48.76" class="difflineplus">+    PlacesUtils.bookmarks.removeItem(PlacesUIUtils.allBookmarksFolderId);</span>
<a href="#l48.77"></a><span id="l48.77" class="difflineplus">+  },</span>
<a href="#l48.78"></a><span id="l48.78" class="difflineplus">+</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineplus">+  function test5() {</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineplus">+    print(&quot;5. Create a duplicated left pane folder.&quot;);</span>
<a href="#l48.81"></a><span id="l48.81" class="difflineplus">+    let id = PlacesUtils.bookmarks.createFolder(PlacesUtils.unfiledBookmarksFolderId,</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineplus">+                                                &quot;PlacesRoot&quot;,</span>
<a href="#l48.83"></a><span id="l48.83" class="difflineplus">+                                                PlacesUtils.bookmarks.DEFAULT_INDEX);</span>
<a href="#l48.84"></a><span id="l48.84" class="difflineplus">+    PlacesUtils.annotations.setItemAnnotation(id, ORGANIZER_FOLDER_ANNO,</span>
<a href="#l48.85"></a><span id="l48.85" class="difflineplus">+                                              &quot;PlacesRoot&quot;, 0,</span>
<a href="#l48.86"></a><span id="l48.86" class="difflineplus">+                                              PlacesUtils.annotations.EXPIRE_NEVER);</span>
<a href="#l48.87"></a><span id="l48.87" class="difflineplus">+  },</span>
<a href="#l48.88"></a><span id="l48.88" class="difflineplus">+</span>
<a href="#l48.89"></a><span id="l48.89" class="difflineplus">+  function test6() {</span>
<a href="#l48.90"></a><span id="l48.90" class="difflineplus">+    print(&quot;6. Create a duplicated left pane query.&quot;);</span>
<a href="#l48.91"></a><span id="l48.91" class="difflineplus">+    let id = PlacesUtils.bookmarks.createFolder(PlacesUtils.unfiledBookmarksFolderId,</span>
<a href="#l48.92"></a><span id="l48.92" class="difflineplus">+                                                &quot;AllBookmarks&quot;,</span>
<a href="#l48.93"></a><span id="l48.93" class="difflineplus">+                                                PlacesUtils.bookmarks.DEFAULT_INDEX);</span>
<a href="#l48.94"></a><span id="l48.94" class="difflineplus">+    PlacesUtils.annotations.setItemAnnotation(id, ORGANIZER_QUERY_ANNO,</span>
<a href="#l48.95"></a><span id="l48.95" class="difflineplus">+                                              &quot;AllBookmarks&quot;, 0,</span>
<a href="#l48.96"></a><span id="l48.96" class="difflineplus">+                                              PlacesUtils.annotations.EXPIRE_NEVER);</span>
<a href="#l48.97"></a><span id="l48.97" class="difflineplus">+  },</span>
<a href="#l48.98"></a><span id="l48.98" class="difflineplus">+</span>
<a href="#l48.99"></a><span id="l48.99" class="difflineplus">+  function test7() {</span>
<a href="#l48.100"></a><span id="l48.100" class="difflineplus">+    print(&quot;7. Remove the left pane folder annotation.&quot;);</span>
<a href="#l48.101"></a><span id="l48.101" class="difflineplus">+    PlacesUtils.annotations.removeItemAnnotation(gLeftPaneFolderId,</span>
<a href="#l48.102"></a><span id="l48.102" class="difflineplus">+                                                 ORGANIZER_FOLDER_ANNO);</span>
<a href="#l48.103"></a><span id="l48.103" class="difflineplus">+  },</span>
<a href="#l48.104"></a><span id="l48.104" class="difflineplus">+</span>
<a href="#l48.105"></a><span id="l48.105" class="difflineplus">+  function test8() {</span>
<a href="#l48.106"></a><span id="l48.106" class="difflineplus">+    print(&quot;8. Remove a left pane query annotation.&quot;);</span>
<a href="#l48.107"></a><span id="l48.107" class="difflineplus">+    PlacesUtils.annotations.removeItemAnnotation(PlacesUIUtils.allBookmarksFolderId,</span>
<a href="#l48.108"></a><span id="l48.108" class="difflineplus">+                                                 ORGANIZER_QUERY_ANNO);</span>
<a href="#l48.109"></a><span id="l48.109" class="difflineplus">+  },</span>
<a href="#l48.110"></a><span id="l48.110" class="difflineplus">+</span>
<a href="#l48.111"></a><span id="l48.111" class="difflineplus">+  function test9() {</span>
<a href="#l48.112"></a><span id="l48.112" class="difflineplus">+    print(&quot;9. Remove a child of AllBookmarks.&quot;);</span>
<a href="#l48.113"></a><span id="l48.113" class="difflineplus">+    let id = PlacesUtils.bookmarks.getIdForItemAt(PlacesUIUtils.allBookmarksFolderId, 0);</span>
<a href="#l48.114"></a><span id="l48.114" class="difflineplus">+    PlacesUtils.bookmarks.removeItem(id);</span>
<a href="#l48.115"></a><span id="l48.115" class="difflineplus">+  },</span>
<a href="#l48.116"></a><span id="l48.116" class="difflineplus">+</span>
<a href="#l48.117"></a><span id="l48.117" class="difflineplus">+];</span>
<a href="#l48.118"></a><span id="l48.118" class="difflineplus">+</span>
<a href="#l48.119"></a><span id="l48.119" class="difflineplus">+function run_test() {</span>
<a href="#l48.120"></a><span id="l48.120" class="difflineplus">+  // We want empty roots.</span>
<a href="#l48.121"></a><span id="l48.121" class="difflineplus">+  remove_all_bookmarks();</span>
<a href="#l48.122"></a><span id="l48.122" class="difflineplus">+</span>
<a href="#l48.123"></a><span id="l48.123" class="difflineplus">+  // Sanity check.</span>
<a href="#l48.124"></a><span id="l48.124" class="difflineplus">+  do_check_true(!!PlacesUIUtils);</span>
<a href="#l48.125"></a><span id="l48.125" class="difflineplus">+</span>
<a href="#l48.126"></a><span id="l48.126" class="difflineplus">+  // Check getters.</span>
<a href="#l48.127"></a><span id="l48.127" class="difflineplus">+  gLeftPaneFolderIdGetter = PlacesUIUtils.__lookupGetter__(&quot;leftPaneFolderId&quot;);</span>
<a href="#l48.128"></a><span id="l48.128" class="difflineplus">+  do_check_eq(typeof(gLeftPaneFolderIdGetter), &quot;function&quot;);</span>
<a href="#l48.129"></a><span id="l48.129" class="difflineplus">+  gAllBookmarksFolderIdGetter = PlacesUIUtils.__lookupGetter__(&quot;allBookmarksFolderId&quot;);</span>
<a href="#l48.130"></a><span id="l48.130" class="difflineplus">+  do_check_eq(typeof(gAllBookmarksFolderIdGetter), &quot;function&quot;);</span>
<a href="#l48.131"></a><span id="l48.131" class="difflineplus">+</span>
<a href="#l48.132"></a><span id="l48.132" class="difflineplus">+  // Add a third party bogus annotated item.  Should not be removed.</span>
<a href="#l48.133"></a><span id="l48.133" class="difflineplus">+  gFolderId = PlacesUtils.bookmarks.createFolder(PlacesUtils.unfiledBookmarksFolderId,</span>
<a href="#l48.134"></a><span id="l48.134" class="difflineplus">+                                                 &quot;test&quot;,</span>
<a href="#l48.135"></a><span id="l48.135" class="difflineplus">+                                                 PlacesUtils.bookmarks.DEFAULT_INDEX);</span>
<a href="#l48.136"></a><span id="l48.136" class="difflineplus">+  PlacesUtils.annotations.setItemAnnotation(gFolderId, ORGANIZER_QUERY_ANNO,</span>
<a href="#l48.137"></a><span id="l48.137" class="difflineplus">+                                            &quot;test&quot;, 0,</span>
<a href="#l48.138"></a><span id="l48.138" class="difflineplus">+                                            PlacesUtils.annotations.EXPIRE_NEVER);</span>
<a href="#l48.139"></a><span id="l48.139" class="difflineplus">+</span>
<a href="#l48.140"></a><span id="l48.140" class="difflineplus">+  // Create the left pane, and store its current status, it will be used</span>
<a href="#l48.141"></a><span id="l48.141" class="difflineplus">+  // as reference value.</span>
<a href="#l48.142"></a><span id="l48.142" class="difflineplus">+  gLeftPaneFolderId = PlacesUIUtils.leftPaneFolderId;</span>
<a href="#l48.143"></a><span id="l48.143" class="difflineplus">+  gReferenceJSON = folderToJSON(gLeftPaneFolderId);</span>
<a href="#l48.144"></a><span id="l48.144" class="difflineplus">+</span>
<a href="#l48.145"></a><span id="l48.145" class="difflineplus">+  // Kick-off tests.</span>
<a href="#l48.146"></a><span id="l48.146" class="difflineplus">+  do_test_pending();</span>
<a href="#l48.147"></a><span id="l48.147" class="difflineplus">+  do_timeout(0, run_next_test);</span>
<a href="#l48.148"></a><span id="l48.148" class="difflineplus">+}</span>
<a href="#l48.149"></a><span id="l48.149" class="difflineplus">+</span>
<a href="#l48.150"></a><span id="l48.150" class="difflineplus">+function run_next_test() {</span>
<a href="#l48.151"></a><span id="l48.151" class="difflineplus">+  if (gTests.length) {</span>
<a href="#l48.152"></a><span id="l48.152" class="difflineplus">+    // Create corruption.</span>
<a href="#l48.153"></a><span id="l48.153" class="difflineplus">+    let test = gTests.shift();</span>
<a href="#l48.154"></a><span id="l48.154" class="difflineplus">+    test();</span>
<a href="#l48.155"></a><span id="l48.155" class="difflineplus">+    // Regenerate getters.</span>
<a href="#l48.156"></a><span id="l48.156" class="difflineplus">+    PlacesUIUtils.__defineGetter__(&quot;leftPaneFolderId&quot;, gLeftPaneFolderIdGetter);</span>
<a href="#l48.157"></a><span id="l48.157" class="difflineplus">+    gLeftPaneFolderId = PlacesUIUtils.leftPaneFolderId;</span>
<a href="#l48.158"></a><span id="l48.158" class="difflineplus">+    PlacesUIUtils.__defineGetter__(&quot;allBookmarksFolderId&quot;, gAllBookmarksFolderIdGetter);</span>
<a href="#l48.159"></a><span id="l48.159" class="difflineplus">+    // Check the new left pane folder.</span>
<a href="#l48.160"></a><span id="l48.160" class="difflineplus">+    let leftPaneJSON = folderToJSON(gLeftPaneFolderId);</span>
<a href="#l48.161"></a><span id="l48.161" class="difflineplus">+    do_check_true(compareJSON(gReferenceJSON, leftPaneJSON));</span>
<a href="#l48.162"></a><span id="l48.162" class="difflineplus">+    do_check_eq(PlacesUtils.bookmarks.getItemTitle(gFolderId), &quot;test&quot;);</span>
<a href="#l48.163"></a><span id="l48.163" class="difflineplus">+    // Go to next test.</span>
<a href="#l48.164"></a><span id="l48.164" class="difflineplus">+    do_timeout(0, run_next_test);</span>
<a href="#l48.165"></a><span id="l48.165" class="difflineplus">+  }</span>
<a href="#l48.166"></a><span id="l48.166" class="difflineplus">+  else {</span>
<a href="#l48.167"></a><span id="l48.167" class="difflineplus">+    // All tests finished.</span>
<a href="#l48.168"></a><span id="l48.168" class="difflineplus">+    remove_all_bookmarks();</span>
<a href="#l48.169"></a><span id="l48.169" class="difflineplus">+    do_test_finished();</span>
<a href="#l48.170"></a><span id="l48.170" class="difflineplus">+  }</span>
<a href="#l48.171"></a><span id="l48.171" class="difflineplus">+}</span>
<a href="#l48.172"></a><span id="l48.172" class="difflineplus">+</span>
<a href="#l48.173"></a><span id="l48.173" class="difflineplus">+/**</span>
<a href="#l48.174"></a><span id="l48.174" class="difflineplus">+ * Convert a folder item id to a JSON representation of it and its contents.</span>
<a href="#l48.175"></a><span id="l48.175" class="difflineplus">+ */</span>
<a href="#l48.176"></a><span id="l48.176" class="difflineplus">+function folderToJSON(aItemId) {</span>
<a href="#l48.177"></a><span id="l48.177" class="difflineplus">+  let query = PlacesUtils.history.getNewQuery();</span>
<a href="#l48.178"></a><span id="l48.178" class="difflineplus">+  query.setFolders([aItemId], 1);</span>
<a href="#l48.179"></a><span id="l48.179" class="difflineplus">+  let options = PlacesUtils.history.getNewQueryOptions();</span>
<a href="#l48.180"></a><span id="l48.180" class="difflineplus">+  options.queryType = Ci.nsINavHistoryQueryOptions.QUERY_TYPE_BOOKMARKS;</span>
<a href="#l48.181"></a><span id="l48.181" class="difflineplus">+  let root = PlacesUtils.history.executeQuery(query, options).root;</span>
<a href="#l48.182"></a><span id="l48.182" class="difflineplus">+  let writer = {</span>
<a href="#l48.183"></a><span id="l48.183" class="difflineplus">+    value: &quot;&quot;,</span>
<a href="#l48.184"></a><span id="l48.184" class="difflineplus">+    write: function PU_wrapNode__write(aStr, aLen) {</span>
<a href="#l48.185"></a><span id="l48.185" class="difflineplus">+      this.value += aStr;</span>
<a href="#l48.186"></a><span id="l48.186" class="difflineplus">+    }</span>
<a href="#l48.187"></a><span id="l48.187" class="difflineplus">+  };</span>
<a href="#l48.188"></a><span id="l48.188" class="difflineplus">+  PlacesUtils.serializeNodeAsJSONToOutputStream(root, writer, false, false);</span>
<a href="#l48.189"></a><span id="l48.189" class="difflineplus">+  do_check_true(writer.value.length &gt; 0);</span>
<a href="#l48.190"></a><span id="l48.190" class="difflineplus">+  return writer.value;</span>
<a href="#l48.191"></a><span id="l48.191" class="difflineplus">+}</span>
<a href="#l48.192"></a><span id="l48.192" class="difflineplus">+</span>
<a href="#l48.193"></a><span id="l48.193" class="difflineplus">+/**</span>
<a href="#l48.194"></a><span id="l48.194" class="difflineplus">+ * Compare the JSON representation of 2 nodes, skipping everchanging properties</span>
<a href="#l48.195"></a><span id="l48.195" class="difflineplus">+ * like dates.</span>
<a href="#l48.196"></a><span id="l48.196" class="difflineplus">+ */</span>
<a href="#l48.197"></a><span id="l48.197" class="difflineplus">+function compareJSON(aNodeJSON_1, aNodeJSON_2) {</span>
<a href="#l48.198"></a><span id="l48.198" class="difflineplus">+  let JSON = Cc[&quot;@mozilla.org/dom/json;1&quot;].createInstance(Ci.nsIJSON);</span>
<a href="#l48.199"></a><span id="l48.199" class="difflineplus">+  node1 = JSON.decode(aNodeJSON_1);</span>
<a href="#l48.200"></a><span id="l48.200" class="difflineplus">+  node2 = JSON.decode(aNodeJSON_2);</span>
<a href="#l48.201"></a><span id="l48.201" class="difflineplus">+</span>
<a href="#l48.202"></a><span id="l48.202" class="difflineplus">+  // List of properties we should not compare (expected to be different).</span>
<a href="#l48.203"></a><span id="l48.203" class="difflineplus">+  const SKIP_PROPS = [&quot;dateAdded&quot;, &quot;lastModified&quot;, &quot;id&quot;];</span>
<a href="#l48.204"></a><span id="l48.204" class="difflineplus">+</span>
<a href="#l48.205"></a><span id="l48.205" class="difflineplus">+  function compareObjects(obj1, obj2) {</span>
<a href="#l48.206"></a><span id="l48.206" class="difflineplus">+    function count(o) { var n = 0; for (let p in o) n++; return n; }</span>
<a href="#l48.207"></a><span id="l48.207" class="difflineplus">+    do_check_eq(count(obj1), count(obj2));</span>
<a href="#l48.208"></a><span id="l48.208" class="difflineplus">+    for (let prop in obj1) {</span>
<a href="#l48.209"></a><span id="l48.209" class="difflineplus">+      // Skip everchanging values.</span>
<a href="#l48.210"></a><span id="l48.210" class="difflineplus">+      if (SKIP_PROPS.indexOf(prop) != -1)</span>
<a href="#l48.211"></a><span id="l48.211" class="difflineplus">+        continue;</span>
<a href="#l48.212"></a><span id="l48.212" class="difflineplus">+      // Skip undefined objects, otherwise we hang on them.</span>
<a href="#l48.213"></a><span id="l48.213" class="difflineplus">+      if (!obj1[prop])</span>
<a href="#l48.214"></a><span id="l48.214" class="difflineplus">+        continue;</span>
<a href="#l48.215"></a><span id="l48.215" class="difflineplus">+      if (typeof(obj1[prop]) == &quot;object&quot;)</span>
<a href="#l48.216"></a><span id="l48.216" class="difflineplus">+        return compareObjects(obj1[prop], obj2[prop]);</span>
<a href="#l48.217"></a><span id="l48.217" class="difflineplus">+      if (obj1[prop] !== obj2[prop]) {</span>
<a href="#l48.218"></a><span id="l48.218" class="difflineplus">+        print(prop + &quot;: &quot; + obj1[prop] + &quot;!=&quot; + obj2[prop]);</span>
<a href="#l48.219"></a><span id="l48.219" class="difflineplus">+        return false;</span>
<a href="#l48.220"></a><span id="l48.220" class="difflineplus">+      }</span>
<a href="#l48.221"></a><span id="l48.221" class="difflineplus">+    }</span>
<a href="#l48.222"></a><span id="l48.222" class="difflineplus">+    return true;</span>
<a href="#l48.223"></a><span id="l48.223" class="difflineplus">+  }</span>
<a href="#l48.224"></a><span id="l48.224" class="difflineplus">+</span>
<a href="#l48.225"></a><span id="l48.225" class="difflineplus">+  return compareObjects(node1, node2);</span>
<a href="#l48.226"></a><span id="l48.226" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1">new file mode 100644</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineminus">--- /dev/null</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_placesTxn.js</span>
<a href="#l49.4"></a><span id="l49.4" class="difflineat">@@ -0,0 +1,767 @@</span>
<a href="#l49.5"></a><span id="l49.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l49.6"></a><span id="l49.6" class="difflineplus">+/* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l49.7"></a><span id="l49.7" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l49.8"></a><span id="l49.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l49.9"></a><span id="l49.9" class="difflineplus">+ *</span>
<a href="#l49.10"></a><span id="l49.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l49.11"></a><span id="l49.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineplus">+ *</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineplus">+ * License.</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineplus">+ *</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineplus">+ *</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l49.23"></a><span id="l49.23" class="difflineplus">+ * Mozilla Foundation.</span>
<a href="#l49.24"></a><span id="l49.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l49.25"></a><span id="l49.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineplus">+ *</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineplus">+ *  Sungjoon Steve Won &lt;stevewon@gmail.com&gt; (Original Author)</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineplus">+ *  Asaf Romano &lt;mano@mozilla.com&gt;</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineplus">+ *</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l49.35"></a><span id="l49.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l49.36"></a><span id="l49.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l49.37"></a><span id="l49.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l49.38"></a><span id="l49.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l49.40"></a><span id="l49.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l49.41"></a><span id="l49.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l49.42"></a><span id="l49.42" class="difflineplus">+ *</span>
<a href="#l49.43"></a><span id="l49.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l49.44"></a><span id="l49.44" class="difflineplus">+</span>
<a href="#l49.45"></a><span id="l49.45" class="difflineplus">+var bmsvc = PlacesUtils.bookmarks;</span>
<a href="#l49.46"></a><span id="l49.46" class="difflineplus">+var lmsvc = PlacesUtils.livemarks;</span>
<a href="#l49.47"></a><span id="l49.47" class="difflineplus">+var mss = PlacesUtils.microsummaries;</span>
<a href="#l49.48"></a><span id="l49.48" class="difflineplus">+var ptSvc = PlacesUIUtils.ptm;</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineplus">+var tagssvc = PlacesUtils.tagging;</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineplus">+var annosvc = PlacesUtils.annotations;</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineplus">+</span>
<a href="#l49.52"></a><span id="l49.52" class="difflineplus">+// create and add bookmarks observer</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineplus">+var observer = {</span>
<a href="#l49.54"></a><span id="l49.54" class="difflineplus">+  onBeginUpdateBatch: function() {</span>
<a href="#l49.55"></a><span id="l49.55" class="difflineplus">+    this._beginUpdateBatch = true;</span>
<a href="#l49.56"></a><span id="l49.56" class="difflineplus">+  },</span>
<a href="#l49.57"></a><span id="l49.57" class="difflineplus">+  onEndUpdateBatch: function() {</span>
<a href="#l49.58"></a><span id="l49.58" class="difflineplus">+    this._endUpdateBatch = true;</span>
<a href="#l49.59"></a><span id="l49.59" class="difflineplus">+  },</span>
<a href="#l49.60"></a><span id="l49.60" class="difflineplus">+  onItemAdded: function(id, folder, index, itemType) {</span>
<a href="#l49.61"></a><span id="l49.61" class="difflineplus">+    this._itemAddedId = id;</span>
<a href="#l49.62"></a><span id="l49.62" class="difflineplus">+    this._itemAddedParent = folder;</span>
<a href="#l49.63"></a><span id="l49.63" class="difflineplus">+    this._itemAddedIndex = index;</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineplus">+    this._itemAddedType = itemType;</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineplus">+  },</span>
<a href="#l49.66"></a><span id="l49.66" class="difflineplus">+  onBeforeItemRemoved: function(id) {</span>
<a href="#l49.67"></a><span id="l49.67" class="difflineplus">+  },</span>
<a href="#l49.68"></a><span id="l49.68" class="difflineplus">+  onItemRemoved: function(id, folder, index, itemType) {</span>
<a href="#l49.69"></a><span id="l49.69" class="difflineplus">+    this._itemRemovedId = id;</span>
<a href="#l49.70"></a><span id="l49.70" class="difflineplus">+    this._itemRemovedFolder = folder;</span>
<a href="#l49.71"></a><span id="l49.71" class="difflineplus">+    this._itemRemovedIndex = index;</span>
<a href="#l49.72"></a><span id="l49.72" class="difflineplus">+  },</span>
<a href="#l49.73"></a><span id="l49.73" class="difflineplus">+  onItemChanged: function(id, property, isAnnotationProperty, newValue,</span>
<a href="#l49.74"></a><span id="l49.74" class="difflineplus">+                          lastModified, itemType) {</span>
<a href="#l49.75"></a><span id="l49.75" class="difflineplus">+    this._itemChangedId = id;</span>
<a href="#l49.76"></a><span id="l49.76" class="difflineplus">+    this._itemChangedProperty = property;</span>
<a href="#l49.77"></a><span id="l49.77" class="difflineplus">+    this._itemChanged_isAnnotationProperty = isAnnotationProperty;</span>
<a href="#l49.78"></a><span id="l49.78" class="difflineplus">+    this._itemChangedValue = newValue;</span>
<a href="#l49.79"></a><span id="l49.79" class="difflineplus">+  },</span>
<a href="#l49.80"></a><span id="l49.80" class="difflineplus">+  onItemVisited: function(id, visitID, time) {</span>
<a href="#l49.81"></a><span id="l49.81" class="difflineplus">+    this._itemVisitedId = id;</span>
<a href="#l49.82"></a><span id="l49.82" class="difflineplus">+    this._itemVisitedVistId = visitID;</span>
<a href="#l49.83"></a><span id="l49.83" class="difflineplus">+    this._itemVisitedTime = time;</span>
<a href="#l49.84"></a><span id="l49.84" class="difflineplus">+  },</span>
<a href="#l49.85"></a><span id="l49.85" class="difflineplus">+  onItemMoved: function(id, oldParent, oldIndex, newParent, newIndex,</span>
<a href="#l49.86"></a><span id="l49.86" class="difflineplus">+                        itemType) {</span>
<a href="#l49.87"></a><span id="l49.87" class="difflineplus">+    this._itemMovedId = id</span>
<a href="#l49.88"></a><span id="l49.88" class="difflineplus">+    this._itemMovedOldParent = oldParent;</span>
<a href="#l49.89"></a><span id="l49.89" class="difflineplus">+    this._itemMovedOldIndex = oldIndex;</span>
<a href="#l49.90"></a><span id="l49.90" class="difflineplus">+    this._itemMovedNewParent = newParent;</span>
<a href="#l49.91"></a><span id="l49.91" class="difflineplus">+    this._itemMovedNewIndex = newIndex;</span>
<a href="#l49.92"></a><span id="l49.92" class="difflineplus">+  },</span>
<a href="#l49.93"></a><span id="l49.93" class="difflineplus">+  QueryInterface: function(iid) {</span>
<a href="#l49.94"></a><span id="l49.94" class="difflineplus">+    if (iid.equals(Ci.nsINavBookmarkObserver) ||</span>
<a href="#l49.95"></a><span id="l49.95" class="difflineplus">+        iid.equals(Ci.nsISupports)) {</span>
<a href="#l49.96"></a><span id="l49.96" class="difflineplus">+      return this;</span>
<a href="#l49.97"></a><span id="l49.97" class="difflineplus">+    }</span>
<a href="#l49.98"></a><span id="l49.98" class="difflineplus">+    throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l49.99"></a><span id="l49.99" class="difflineplus">+  }</span>
<a href="#l49.100"></a><span id="l49.100" class="difflineplus">+};</span>
<a href="#l49.101"></a><span id="l49.101" class="difflineplus">+bmsvc.addObserver(observer, false);</span>
<a href="#l49.102"></a><span id="l49.102" class="difflineplus">+</span>
<a href="#l49.103"></a><span id="l49.103" class="difflineplus">+// index at which items should begin</span>
<a href="#l49.104"></a><span id="l49.104" class="difflineplus">+var bmStartIndex = 0;</span>
<a href="#l49.105"></a><span id="l49.105" class="difflineplus">+</span>
<a href="#l49.106"></a><span id="l49.106" class="difflineplus">+// main</span>
<a href="#l49.107"></a><span id="l49.107" class="difflineplus">+function run_test() {</span>
<a href="#l49.108"></a><span id="l49.108" class="difflineplus">+  // get bookmarks root index</span>
<a href="#l49.109"></a><span id="l49.109" class="difflineplus">+  var root = bmsvc.bookmarksMenuFolder;</span>
<a href="#l49.110"></a><span id="l49.110" class="difflineplus">+</span>
<a href="#l49.111"></a><span id="l49.111" class="difflineplus">+  //Test creating a folder with a description</span>
<a href="#l49.112"></a><span id="l49.112" class="difflineplus">+  const TEST_DESCRIPTION = &quot;this is my test description&quot;;</span>
<a href="#l49.113"></a><span id="l49.113" class="difflineplus">+  var annos = [{ name: PlacesUIUtils.DESCRIPTION_ANNO,</span>
<a href="#l49.114"></a><span id="l49.114" class="difflineplus">+                 type: annosvc.TYPE_STRING,</span>
<a href="#l49.115"></a><span id="l49.115" class="difflineplus">+                flags: 0,</span>
<a href="#l49.116"></a><span id="l49.116" class="difflineplus">+                value: TEST_DESCRIPTION,</span>
<a href="#l49.117"></a><span id="l49.117" class="difflineplus">+              expires: annosvc.EXPIRE_NEVER }];</span>
<a href="#l49.118"></a><span id="l49.118" class="difflineplus">+  var txn1 = ptSvc.createFolder(&quot;Testing folder&quot;, root, bmStartIndex, annos);</span>
<a href="#l49.119"></a><span id="l49.119" class="difflineplus">+  ptSvc.doTransaction(txn1);</span>
<a href="#l49.120"></a><span id="l49.120" class="difflineplus">+</span>
<a href="#l49.121"></a><span id="l49.121" class="difflineplus">+  // This checks that calling undoTransaction on an &quot;empty batch&quot; doesn't</span>
<a href="#l49.122"></a><span id="l49.122" class="difflineplus">+  // undo the previous transaction (getItemTitle will fail)</span>
<a href="#l49.123"></a><span id="l49.123" class="difflineplus">+  ptSvc.beginBatch();</span>
<a href="#l49.124"></a><span id="l49.124" class="difflineplus">+  ptSvc.endBatch();</span>
<a href="#l49.125"></a><span id="l49.125" class="difflineplus">+  ptSvc.undoTransaction();</span>
<a href="#l49.126"></a><span id="l49.126" class="difflineplus">+</span>
<a href="#l49.127"></a><span id="l49.127" class="difflineplus">+  var folderId = observer._itemAddedId;</span>
<a href="#l49.128"></a><span id="l49.128" class="difflineplus">+  do_check_eq(bmsvc.getItemTitle(folderId), &quot;Testing folder&quot;);</span>
<a href="#l49.129"></a><span id="l49.129" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, bmStartIndex);</span>
<a href="#l49.130"></a><span id="l49.130" class="difflineplus">+  do_check_eq(observer._itemAddedParent, root);</span>
<a href="#l49.131"></a><span id="l49.131" class="difflineplus">+  do_check_eq(observer._itemAddedId, folderId);</span>
<a href="#l49.132"></a><span id="l49.132" class="difflineplus">+  do_check_eq(TEST_DESCRIPTION, </span>
<a href="#l49.133"></a><span id="l49.133" class="difflineplus">+              annosvc.getItemAnnotation(folderId, PlacesUIUtils.DESCRIPTION_ANNO));</span>
<a href="#l49.134"></a><span id="l49.134" class="difflineplus">+</span>
<a href="#l49.135"></a><span id="l49.135" class="difflineplus">+  txn1.undoTransaction();</span>
<a href="#l49.136"></a><span id="l49.136" class="difflineplus">+  do_check_eq(observer._itemRemovedId, folderId);</span>
<a href="#l49.137"></a><span id="l49.137" class="difflineplus">+  do_check_eq(observer._itemRemovedFolder, root);</span>
<a href="#l49.138"></a><span id="l49.138" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, bmStartIndex);</span>
<a href="#l49.139"></a><span id="l49.139" class="difflineplus">+  txn1.redoTransaction();</span>
<a href="#l49.140"></a><span id="l49.140" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, bmStartIndex);</span>
<a href="#l49.141"></a><span id="l49.141" class="difflineplus">+  do_check_eq(observer._itemAddedParent, root);</span>
<a href="#l49.142"></a><span id="l49.142" class="difflineplus">+  do_check_eq(observer._itemAddedId, folderId);</span>
<a href="#l49.143"></a><span id="l49.143" class="difflineplus">+  txn1.undoTransaction();</span>
<a href="#l49.144"></a><span id="l49.144" class="difflineplus">+  do_check_eq(observer._itemRemovedId, folderId);</span>
<a href="#l49.145"></a><span id="l49.145" class="difflineplus">+  do_check_eq(observer._itemRemovedFolder, root);</span>
<a href="#l49.146"></a><span id="l49.146" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, bmStartIndex);</span>
<a href="#l49.147"></a><span id="l49.147" class="difflineplus">+</span>
<a href="#l49.148"></a><span id="l49.148" class="difflineplus">+  // Test creating an item</span>
<a href="#l49.149"></a><span id="l49.149" class="difflineplus">+  // Create to Root</span>
<a href="#l49.150"></a><span id="l49.150" class="difflineplus">+  var txn2 = ptSvc.createItem(uri(&quot;http://www.example.com&quot;), root, bmStartIndex, &quot;Testing1&quot;);</span>
<a href="#l49.151"></a><span id="l49.151" class="difflineplus">+  ptSvc.doTransaction(txn2); // Also testing doTransaction</span>
<a href="#l49.152"></a><span id="l49.152" class="difflineplus">+  var b = (bmsvc.getBookmarkIdsForURI(uri(&quot;http://www.example.com&quot;)))[0];</span>
<a href="#l49.153"></a><span id="l49.153" class="difflineplus">+  do_check_eq(observer._itemAddedId, b);</span>
<a href="#l49.154"></a><span id="l49.154" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, bmStartIndex);</span>
<a href="#l49.155"></a><span id="l49.155" class="difflineplus">+  do_check_true(bmsvc.isBookmarked(uri(&quot;http://www.example.com&quot;)));</span>
<a href="#l49.156"></a><span id="l49.156" class="difflineplus">+  txn2.undoTransaction();</span>
<a href="#l49.157"></a><span id="l49.157" class="difflineplus">+  do_check_eq(observer._itemRemovedId, b);</span>
<a href="#l49.158"></a><span id="l49.158" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, bmStartIndex);</span>
<a href="#l49.159"></a><span id="l49.159" class="difflineplus">+  do_check_false(bmsvc.isBookmarked(uri(&quot;http://www.example.com&quot;)));</span>
<a href="#l49.160"></a><span id="l49.160" class="difflineplus">+  txn2.redoTransaction();</span>
<a href="#l49.161"></a><span id="l49.161" class="difflineplus">+  do_check_true(bmsvc.isBookmarked(uri(&quot;http://www.example.com&quot;)));</span>
<a href="#l49.162"></a><span id="l49.162" class="difflineplus">+  var newId = (bmsvc.getBookmarkIdsForURI(uri(&quot;http://www.example.com&quot;)))[0];</span>
<a href="#l49.163"></a><span id="l49.163" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, bmStartIndex);</span>
<a href="#l49.164"></a><span id="l49.164" class="difflineplus">+  do_check_eq(observer._itemAddedParent, root);</span>
<a href="#l49.165"></a><span id="l49.165" class="difflineplus">+  do_check_eq(observer._itemAddedId, newId);</span>
<a href="#l49.166"></a><span id="l49.166" class="difflineplus">+  txn2.undoTransaction();</span>
<a href="#l49.167"></a><span id="l49.167" class="difflineplus">+  do_check_eq(observer._itemRemovedId, newId);</span>
<a href="#l49.168"></a><span id="l49.168" class="difflineplus">+  do_check_eq(observer._itemRemovedFolder, root);</span>
<a href="#l49.169"></a><span id="l49.169" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, bmStartIndex);</span>
<a href="#l49.170"></a><span id="l49.170" class="difflineplus">+</span>
<a href="#l49.171"></a><span id="l49.171" class="difflineplus">+  // Create item to a folder</span>
<a href="#l49.172"></a><span id="l49.172" class="difflineplus">+  var txn2a = ptSvc.createFolder(&quot;Folder&quot;, root, bmStartIndex);</span>
<a href="#l49.173"></a><span id="l49.173" class="difflineplus">+  ptSvc.doTransaction(txn2a);</span>
<a href="#l49.174"></a><span id="l49.174" class="difflineplus">+  var fldrId = observer._itemAddedId;</span>
<a href="#l49.175"></a><span id="l49.175" class="difflineplus">+  do_check_eq(bmsvc.getItemTitle(fldrId), &quot;Folder&quot;);</span>
<a href="#l49.176"></a><span id="l49.176" class="difflineplus">+</span>
<a href="#l49.177"></a><span id="l49.177" class="difflineplus">+  var txn2b = ptSvc.createItem(uri(&quot;http://www.example2.com&quot;), fldrId, bmStartIndex, &quot;Testing1b&quot;);</span>
<a href="#l49.178"></a><span id="l49.178" class="difflineplus">+  ptSvc.doTransaction(txn2b);</span>
<a href="#l49.179"></a><span id="l49.179" class="difflineplus">+  var b2 = (bmsvc.getBookmarkIdsForURI(uri(&quot;http://www.example2.com&quot;)))[0];</span>
<a href="#l49.180"></a><span id="l49.180" class="difflineplus">+  do_check_eq(observer._itemAddedId, b2);</span>
<a href="#l49.181"></a><span id="l49.181" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, bmStartIndex);</span>
<a href="#l49.182"></a><span id="l49.182" class="difflineplus">+  do_check_true(bmsvc.isBookmarked(uri(&quot;http://www.example2.com&quot;)));</span>
<a href="#l49.183"></a><span id="l49.183" class="difflineplus">+  txn2b.undoTransaction();</span>
<a href="#l49.184"></a><span id="l49.184" class="difflineplus">+  do_check_eq(observer._itemRemovedId, b2);</span>
<a href="#l49.185"></a><span id="l49.185" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, bmStartIndex);</span>
<a href="#l49.186"></a><span id="l49.186" class="difflineplus">+  txn2b.redoTransaction();</span>
<a href="#l49.187"></a><span id="l49.187" class="difflineplus">+  newId = (bmsvc.getBookmarkIdsForURI(uri(&quot;http://www.example2.com&quot;)))[0];</span>
<a href="#l49.188"></a><span id="l49.188" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, bmStartIndex);</span>
<a href="#l49.189"></a><span id="l49.189" class="difflineplus">+  do_check_eq(observer._itemAddedParent, fldrId);</span>
<a href="#l49.190"></a><span id="l49.190" class="difflineplus">+  do_check_eq(observer._itemAddedId, newId);</span>
<a href="#l49.191"></a><span id="l49.191" class="difflineplus">+  txn2b.undoTransaction();</span>
<a href="#l49.192"></a><span id="l49.192" class="difflineplus">+  do_check_eq(observer._itemRemovedId, newId);</span>
<a href="#l49.193"></a><span id="l49.193" class="difflineplus">+  do_check_eq(observer._itemRemovedFolder, fldrId);</span>
<a href="#l49.194"></a><span id="l49.194" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, bmStartIndex);</span>
<a href="#l49.195"></a><span id="l49.195" class="difflineplus">+</span>
<a href="#l49.196"></a><span id="l49.196" class="difflineplus">+  // Testing moving an item</span>
<a href="#l49.197"></a><span id="l49.197" class="difflineplus">+  ptSvc.doTransaction(ptSvc.createItem(uri(&quot;http://www.example3.com&quot;), root, -1, &quot;Testing2&quot;));</span>
<a href="#l49.198"></a><span id="l49.198" class="difflineplus">+  ptSvc.doTransaction(ptSvc.createItem(uri(&quot;http://www.example3.com&quot;), root, -1, &quot;Testing3&quot;));</span>
<a href="#l49.199"></a><span id="l49.199" class="difflineplus">+  ptSvc.doTransaction(ptSvc.createItem(uri(&quot;http://www.example3.com&quot;), fldrId, -1, &quot;Testing4&quot;));</span>
<a href="#l49.200"></a><span id="l49.200" class="difflineplus">+  var bkmkIds = bmsvc.getBookmarkIdsForURI(uri(&quot;http://www.example3.com&quot;));</span>
<a href="#l49.201"></a><span id="l49.201" class="difflineplus">+  bkmkIds.sort();</span>
<a href="#l49.202"></a><span id="l49.202" class="difflineplus">+  var bkmk1Id = bkmkIds[0];</span>
<a href="#l49.203"></a><span id="l49.203" class="difflineplus">+  var bkmk2Id = bkmkIds[1];</span>
<a href="#l49.204"></a><span id="l49.204" class="difflineplus">+  var bkmk3Id = bkmkIds[2];</span>
<a href="#l49.205"></a><span id="l49.205" class="difflineplus">+</span>
<a href="#l49.206"></a><span id="l49.206" class="difflineplus">+  // Moving items between the same folder</span>
<a href="#l49.207"></a><span id="l49.207" class="difflineplus">+  var txn3 = ptSvc.moveItem(bkmk1Id, root, -1);</span>
<a href="#l49.208"></a><span id="l49.208" class="difflineplus">+  txn3.doTransaction();</span>
<a href="#l49.209"></a><span id="l49.209" class="difflineplus">+  do_check_eq(observer._itemMovedId, bkmk1Id);</span>
<a href="#l49.210"></a><span id="l49.210" class="difflineplus">+  do_check_eq(observer._itemMovedOldParent, root);</span>
<a href="#l49.211"></a><span id="l49.211" class="difflineplus">+  do_check_eq(observer._itemMovedOldIndex, 1);</span>
<a href="#l49.212"></a><span id="l49.212" class="difflineplus">+  do_check_eq(observer._itemMovedNewParent, root);</span>
<a href="#l49.213"></a><span id="l49.213" class="difflineplus">+  do_check_eq(observer._itemMovedNewIndex, 2);</span>
<a href="#l49.214"></a><span id="l49.214" class="difflineplus">+  txn3.undoTransaction();</span>
<a href="#l49.215"></a><span id="l49.215" class="difflineplus">+  do_check_eq(observer._itemMovedId, bkmk1Id);</span>
<a href="#l49.216"></a><span id="l49.216" class="difflineplus">+  do_check_eq(observer._itemMovedOldParent, root);</span>
<a href="#l49.217"></a><span id="l49.217" class="difflineplus">+  do_check_eq(observer._itemMovedOldIndex, 2);</span>
<a href="#l49.218"></a><span id="l49.218" class="difflineplus">+  do_check_eq(observer._itemMovedNewParent, root);</span>
<a href="#l49.219"></a><span id="l49.219" class="difflineplus">+  do_check_eq(observer._itemMovedNewIndex, 1);</span>
<a href="#l49.220"></a><span id="l49.220" class="difflineplus">+  txn3.redoTransaction();</span>
<a href="#l49.221"></a><span id="l49.221" class="difflineplus">+  do_check_eq(observer._itemMovedId, bkmk1Id);</span>
<a href="#l49.222"></a><span id="l49.222" class="difflineplus">+  do_check_eq(observer._itemMovedOldParent, root);</span>
<a href="#l49.223"></a><span id="l49.223" class="difflineplus">+  do_check_eq(observer._itemMovedOldIndex, 1);</span>
<a href="#l49.224"></a><span id="l49.224" class="difflineplus">+  do_check_eq(observer._itemMovedNewParent, root);</span>
<a href="#l49.225"></a><span id="l49.225" class="difflineplus">+  do_check_eq(observer._itemMovedNewIndex, 2);</span>
<a href="#l49.226"></a><span id="l49.226" class="difflineplus">+  txn3.undoTransaction();</span>
<a href="#l49.227"></a><span id="l49.227" class="difflineplus">+  do_check_eq(observer._itemMovedId, bkmk1Id);</span>
<a href="#l49.228"></a><span id="l49.228" class="difflineplus">+  do_check_eq(observer._itemMovedOldParent, root);</span>
<a href="#l49.229"></a><span id="l49.229" class="difflineplus">+  do_check_eq(observer._itemMovedOldIndex, 2);</span>
<a href="#l49.230"></a><span id="l49.230" class="difflineplus">+  do_check_eq(observer._itemMovedNewParent, root);</span>
<a href="#l49.231"></a><span id="l49.231" class="difflineplus">+  do_check_eq(observer._itemMovedNewIndex, 1);</span>
<a href="#l49.232"></a><span id="l49.232" class="difflineplus">+</span>
<a href="#l49.233"></a><span id="l49.233" class="difflineplus">+  // Moving items between different folders</span>
<a href="#l49.234"></a><span id="l49.234" class="difflineplus">+  var txn3b = ptSvc.moveItem(bkmk1Id, fldrId, -1);</span>
<a href="#l49.235"></a><span id="l49.235" class="difflineplus">+  txn3b.doTransaction();</span>
<a href="#l49.236"></a><span id="l49.236" class="difflineplus">+  do_check_eq(observer._itemMovedId, bkmk1Id);</span>
<a href="#l49.237"></a><span id="l49.237" class="difflineplus">+  do_check_eq(observer._itemMovedOldParent, root);</span>
<a href="#l49.238"></a><span id="l49.238" class="difflineplus">+  do_check_eq(observer._itemMovedOldIndex, 1);</span>
<a href="#l49.239"></a><span id="l49.239" class="difflineplus">+  do_check_eq(observer._itemMovedNewParent, fldrId);</span>
<a href="#l49.240"></a><span id="l49.240" class="difflineplus">+  do_check_eq(observer._itemMovedNewIndex, 1);</span>
<a href="#l49.241"></a><span id="l49.241" class="difflineplus">+  txn3.undoTransaction();</span>
<a href="#l49.242"></a><span id="l49.242" class="difflineplus">+  do_check_eq(observer._itemMovedId, bkmk1Id);</span>
<a href="#l49.243"></a><span id="l49.243" class="difflineplus">+  do_check_eq(observer._itemMovedOldParent, fldrId);</span>
<a href="#l49.244"></a><span id="l49.244" class="difflineplus">+  do_check_eq(observer._itemMovedOldIndex, 1);</span>
<a href="#l49.245"></a><span id="l49.245" class="difflineplus">+  do_check_eq(observer._itemMovedNewParent, root);</span>
<a href="#l49.246"></a><span id="l49.246" class="difflineplus">+  do_check_eq(observer._itemMovedNewIndex, 1);</span>
<a href="#l49.247"></a><span id="l49.247" class="difflineplus">+  txn3b.redoTransaction();</span>
<a href="#l49.248"></a><span id="l49.248" class="difflineplus">+  do_check_eq(observer._itemMovedId, bkmk1Id);</span>
<a href="#l49.249"></a><span id="l49.249" class="difflineplus">+  do_check_eq(observer._itemMovedOldParent, root);</span>
<a href="#l49.250"></a><span id="l49.250" class="difflineplus">+  do_check_eq(observer._itemMovedOldIndex, 1);</span>
<a href="#l49.251"></a><span id="l49.251" class="difflineplus">+  do_check_eq(observer._itemMovedNewParent, fldrId);</span>
<a href="#l49.252"></a><span id="l49.252" class="difflineplus">+  do_check_eq(observer._itemMovedNewIndex, 1);</span>
<a href="#l49.253"></a><span id="l49.253" class="difflineplus">+  txn3.undoTransaction();</span>
<a href="#l49.254"></a><span id="l49.254" class="difflineplus">+  do_check_eq(observer._itemMovedId, bkmk1Id);</span>
<a href="#l49.255"></a><span id="l49.255" class="difflineplus">+  do_check_eq(observer._itemMovedOldParent, fldrId);</span>
<a href="#l49.256"></a><span id="l49.256" class="difflineplus">+  do_check_eq(observer._itemMovedOldIndex, 1);</span>
<a href="#l49.257"></a><span id="l49.257" class="difflineplus">+  do_check_eq(observer._itemMovedNewParent, root);</span>
<a href="#l49.258"></a><span id="l49.258" class="difflineplus">+  do_check_eq(observer._itemMovedNewIndex, 1);</span>
<a href="#l49.259"></a><span id="l49.259" class="difflineplus">+</span>
<a href="#l49.260"></a><span id="l49.260" class="difflineplus">+  // Test Removing a Folder</span>
<a href="#l49.261"></a><span id="l49.261" class="difflineplus">+  ptSvc.doTransaction(ptSvc.createFolder(&quot;Folder2&quot;, root, -1));</span>
<a href="#l49.262"></a><span id="l49.262" class="difflineplus">+  var fldrId2 = observer._itemAddedId;</span>
<a href="#l49.263"></a><span id="l49.263" class="difflineplus">+  do_check_eq(bmsvc.getItemTitle(fldrId2), &quot;Folder2&quot;);</span>
<a href="#l49.264"></a><span id="l49.264" class="difflineplus">+</span>
<a href="#l49.265"></a><span id="l49.265" class="difflineplus">+  var txn4 = ptSvc.removeItem(fldrId2);</span>
<a href="#l49.266"></a><span id="l49.266" class="difflineplus">+  txn4.doTransaction();</span>
<a href="#l49.267"></a><span id="l49.267" class="difflineplus">+  do_check_eq(observer._itemRemovedId, fldrId2);</span>
<a href="#l49.268"></a><span id="l49.268" class="difflineplus">+  do_check_eq(observer._itemRemovedFolder, root);</span>
<a href="#l49.269"></a><span id="l49.269" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, 3);</span>
<a href="#l49.270"></a><span id="l49.270" class="difflineplus">+  txn4.undoTransaction();</span>
<a href="#l49.271"></a><span id="l49.271" class="difflineplus">+  do_check_eq(observer._itemAddedId, fldrId2);</span>
<a href="#l49.272"></a><span id="l49.272" class="difflineplus">+  do_check_eq(observer._itemAddedParent, root);</span>
<a href="#l49.273"></a><span id="l49.273" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, 3);</span>
<a href="#l49.274"></a><span id="l49.274" class="difflineplus">+  txn4.redoTransaction();</span>
<a href="#l49.275"></a><span id="l49.275" class="difflineplus">+  do_check_eq(observer._itemRemovedId, fldrId2);</span>
<a href="#l49.276"></a><span id="l49.276" class="difflineplus">+  do_check_eq(observer._itemRemovedFolder, root);</span>
<a href="#l49.277"></a><span id="l49.277" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, 3);</span>
<a href="#l49.278"></a><span id="l49.278" class="difflineplus">+  txn4.undoTransaction();</span>
<a href="#l49.279"></a><span id="l49.279" class="difflineplus">+  do_check_eq(observer._itemAddedId, fldrId2);</span>
<a href="#l49.280"></a><span id="l49.280" class="difflineplus">+  do_check_eq(observer._itemAddedParent, root);</span>
<a href="#l49.281"></a><span id="l49.281" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, 3);</span>
<a href="#l49.282"></a><span id="l49.282" class="difflineplus">+</span>
<a href="#l49.283"></a><span id="l49.283" class="difflineplus">+  // Test removing an item with a keyword</span>
<a href="#l49.284"></a><span id="l49.284" class="difflineplus">+  bmsvc.setKeywordForBookmark(bkmk2Id, &quot;test_keyword&quot;);</span>
<a href="#l49.285"></a><span id="l49.285" class="difflineplus">+  var txn5 = ptSvc.removeItem(bkmk2Id);</span>
<a href="#l49.286"></a><span id="l49.286" class="difflineplus">+  txn5.doTransaction();</span>
<a href="#l49.287"></a><span id="l49.287" class="difflineplus">+  do_check_eq(observer._itemRemovedId, bkmk2Id);</span>
<a href="#l49.288"></a><span id="l49.288" class="difflineplus">+  do_check_eq(observer._itemRemovedFolder, root);</span>
<a href="#l49.289"></a><span id="l49.289" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, 2);</span>
<a href="#l49.290"></a><span id="l49.290" class="difflineplus">+  do_check_eq(bmsvc.getKeywordForBookmark(bkmk2Id), null);</span>
<a href="#l49.291"></a><span id="l49.291" class="difflineplus">+  txn5.undoTransaction();</span>
<a href="#l49.292"></a><span id="l49.292" class="difflineplus">+  var newbkmk2Id = observer._itemAddedId;</span>
<a href="#l49.293"></a><span id="l49.293" class="difflineplus">+  do_check_eq(observer._itemAddedParent, root);</span>
<a href="#l49.294"></a><span id="l49.294" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, 2);</span>
<a href="#l49.295"></a><span id="l49.295" class="difflineplus">+  do_check_eq(bmsvc.getKeywordForBookmark(newbkmk2Id), &quot;test_keyword&quot;);</span>
<a href="#l49.296"></a><span id="l49.296" class="difflineplus">+  txn5.redoTransaction();</span>
<a href="#l49.297"></a><span id="l49.297" class="difflineplus">+  do_check_eq(observer._itemRemovedId, newbkmk2Id);</span>
<a href="#l49.298"></a><span id="l49.298" class="difflineplus">+  do_check_eq(observer._itemRemovedFolder, root);</span>
<a href="#l49.299"></a><span id="l49.299" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, 2);</span>
<a href="#l49.300"></a><span id="l49.300" class="difflineplus">+  do_check_eq(bmsvc.getKeywordForBookmark(newbkmk2Id), null);</span>
<a href="#l49.301"></a><span id="l49.301" class="difflineplus">+  txn5.undoTransaction();</span>
<a href="#l49.302"></a><span id="l49.302" class="difflineplus">+  do_check_eq(observer._itemAddedParent, root);</span>
<a href="#l49.303"></a><span id="l49.303" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, 2);</span>
<a href="#l49.304"></a><span id="l49.304" class="difflineplus">+</span>
<a href="#l49.305"></a><span id="l49.305" class="difflineplus">+  // Test creating a separator</span>
<a href="#l49.306"></a><span id="l49.306" class="difflineplus">+  var txn6 = ptSvc.createSeparator(root, 1);</span>
<a href="#l49.307"></a><span id="l49.307" class="difflineplus">+  txn6.doTransaction();</span>
<a href="#l49.308"></a><span id="l49.308" class="difflineplus">+  var sepId = observer._itemAddedId;</span>
<a href="#l49.309"></a><span id="l49.309" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, 1);</span>
<a href="#l49.310"></a><span id="l49.310" class="difflineplus">+  do_check_eq(observer._itemAddedParent, root);</span>
<a href="#l49.311"></a><span id="l49.311" class="difflineplus">+  txn6.undoTransaction();</span>
<a href="#l49.312"></a><span id="l49.312" class="difflineplus">+  do_check_eq(observer._itemRemovedId, sepId);</span>
<a href="#l49.313"></a><span id="l49.313" class="difflineplus">+  do_check_eq(observer._itemRemovedFolder, root);</span>
<a href="#l49.314"></a><span id="l49.314" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, 1);</span>
<a href="#l49.315"></a><span id="l49.315" class="difflineplus">+  txn6.redoTransaction();</span>
<a href="#l49.316"></a><span id="l49.316" class="difflineplus">+  var newSepId = observer._itemAddedId;</span>
<a href="#l49.317"></a><span id="l49.317" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, 1);</span>
<a href="#l49.318"></a><span id="l49.318" class="difflineplus">+  do_check_eq(observer._itemAddedParent, root);</span>
<a href="#l49.319"></a><span id="l49.319" class="difflineplus">+  txn6.undoTransaction();</span>
<a href="#l49.320"></a><span id="l49.320" class="difflineplus">+  do_check_eq(observer._itemRemovedId, newSepId);</span>
<a href="#l49.321"></a><span id="l49.321" class="difflineplus">+  do_check_eq(observer._itemRemovedFolder, root);</span>
<a href="#l49.322"></a><span id="l49.322" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, 1);</span>
<a href="#l49.323"></a><span id="l49.323" class="difflineplus">+</span>
<a href="#l49.324"></a><span id="l49.324" class="difflineplus">+  // Test removing a separator</span>
<a href="#l49.325"></a><span id="l49.325" class="difflineplus">+  ptSvc.doTransaction(ptSvc.createSeparator(root, 1));</span>
<a href="#l49.326"></a><span id="l49.326" class="difflineplus">+  var sepId2 = observer._itemAddedId;</span>
<a href="#l49.327"></a><span id="l49.327" class="difflineplus">+  var txn7 = ptSvc.removeItem(sepId2);</span>
<a href="#l49.328"></a><span id="l49.328" class="difflineplus">+  txn7.doTransaction();</span>
<a href="#l49.329"></a><span id="l49.329" class="difflineplus">+  do_check_eq(observer._itemRemovedId, sepId2);</span>
<a href="#l49.330"></a><span id="l49.330" class="difflineplus">+  do_check_eq(observer._itemRemovedFolder, root);</span>
<a href="#l49.331"></a><span id="l49.331" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, 1);</span>
<a href="#l49.332"></a><span id="l49.332" class="difflineplus">+  txn7.undoTransaction();</span>
<a href="#l49.333"></a><span id="l49.333" class="difflineplus">+  do_check_eq(observer._itemAddedId, sepId2); //New separator created</span>
<a href="#l49.334"></a><span id="l49.334" class="difflineplus">+  do_check_eq(observer._itemAddedParent, root);</span>
<a href="#l49.335"></a><span id="l49.335" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, 1);</span>
<a href="#l49.336"></a><span id="l49.336" class="difflineplus">+  txn7.redoTransaction();</span>
<a href="#l49.337"></a><span id="l49.337" class="difflineplus">+  do_check_eq(observer._itemRemovedId, sepId2);</span>
<a href="#l49.338"></a><span id="l49.338" class="difflineplus">+  do_check_eq(observer._itemRemovedFolder, root);</span>
<a href="#l49.339"></a><span id="l49.339" class="difflineplus">+  do_check_eq(observer._itemRemovedIndex, 1);</span>
<a href="#l49.340"></a><span id="l49.340" class="difflineplus">+  txn7.undoTransaction();</span>
<a href="#l49.341"></a><span id="l49.341" class="difflineplus">+  do_check_eq(observer._itemAddedId, sepId2); //New separator created</span>
<a href="#l49.342"></a><span id="l49.342" class="difflineplus">+  do_check_eq(observer._itemAddedParent, root);</span>
<a href="#l49.343"></a><span id="l49.343" class="difflineplus">+  do_check_eq(observer._itemAddedIndex, 1);</span>
<a href="#l49.344"></a><span id="l49.344" class="difflineplus">+</span>
<a href="#l49.345"></a><span id="l49.345" class="difflineplus">+  // Test editing item title</span>
<a href="#l49.346"></a><span id="l49.346" class="difflineplus">+  var txn8 = ptSvc.editItemTitle(bkmk1Id, &quot;Testing2_mod&quot;);</span>
<a href="#l49.347"></a><span id="l49.347" class="difflineplus">+  txn8.doTransaction();</span>
<a href="#l49.348"></a><span id="l49.348" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id); </span>
<a href="#l49.349"></a><span id="l49.349" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;title&quot;);</span>
<a href="#l49.350"></a><span id="l49.350" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;Testing2_mod&quot;);</span>
<a href="#l49.351"></a><span id="l49.351" class="difflineplus">+  txn8.undoTransaction();</span>
<a href="#l49.352"></a><span id="l49.352" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id); </span>
<a href="#l49.353"></a><span id="l49.353" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;title&quot;);</span>
<a href="#l49.354"></a><span id="l49.354" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;Testing2&quot;);</span>
<a href="#l49.355"></a><span id="l49.355" class="difflineplus">+  txn8.redoTransaction();</span>
<a href="#l49.356"></a><span id="l49.356" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id); </span>
<a href="#l49.357"></a><span id="l49.357" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;title&quot;);</span>
<a href="#l49.358"></a><span id="l49.358" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;Testing2_mod&quot;);</span>
<a href="#l49.359"></a><span id="l49.359" class="difflineplus">+  txn8.undoTransaction();</span>
<a href="#l49.360"></a><span id="l49.360" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id); </span>
<a href="#l49.361"></a><span id="l49.361" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;title&quot;);</span>
<a href="#l49.362"></a><span id="l49.362" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;Testing2&quot;);</span>
<a href="#l49.363"></a><span id="l49.363" class="difflineplus">+</span>
<a href="#l49.364"></a><span id="l49.364" class="difflineplus">+  // Test editing item uri</span>
<a href="#l49.365"></a><span id="l49.365" class="difflineplus">+  var txn9 = ptSvc.editBookmarkURI(bkmk1Id, uri(&quot;http://newuri.com&quot;));</span>
<a href="#l49.366"></a><span id="l49.366" class="difflineplus">+  txn9.doTransaction();</span>
<a href="#l49.367"></a><span id="l49.367" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id);</span>
<a href="#l49.368"></a><span id="l49.368" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;uri&quot;);</span>
<a href="#l49.369"></a><span id="l49.369" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;http://newuri.com/&quot;);</span>
<a href="#l49.370"></a><span id="l49.370" class="difflineplus">+  txn9.undoTransaction();</span>
<a href="#l49.371"></a><span id="l49.371" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id);</span>
<a href="#l49.372"></a><span id="l49.372" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;uri&quot;);</span>
<a href="#l49.373"></a><span id="l49.373" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;http://www.example3.com/&quot;);</span>
<a href="#l49.374"></a><span id="l49.374" class="difflineplus">+  txn9.redoTransaction();</span>
<a href="#l49.375"></a><span id="l49.375" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id);</span>
<a href="#l49.376"></a><span id="l49.376" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;uri&quot;);</span>
<a href="#l49.377"></a><span id="l49.377" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;http://newuri.com/&quot;);</span>
<a href="#l49.378"></a><span id="l49.378" class="difflineplus">+  txn9.undoTransaction();</span>
<a href="#l49.379"></a><span id="l49.379" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id);</span>
<a href="#l49.380"></a><span id="l49.380" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;uri&quot;);</span>
<a href="#l49.381"></a><span id="l49.381" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;http://www.example3.com/&quot;);</span>
<a href="#l49.382"></a><span id="l49.382" class="difflineplus">+  </span>
<a href="#l49.383"></a><span id="l49.383" class="difflineplus">+  // Test edit description transaction.</span>
<a href="#l49.384"></a><span id="l49.384" class="difflineplus">+  var txn10 = ptSvc.editItemDescription(bkmk1Id, &quot;Description1&quot;);</span>
<a href="#l49.385"></a><span id="l49.385" class="difflineplus">+  txn10.doTransaction();</span>
<a href="#l49.386"></a><span id="l49.386" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id);</span>
<a href="#l49.387"></a><span id="l49.387" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, PlacesUIUtils.DESCRIPTION_ANNO);</span>
<a href="#l49.388"></a><span id="l49.388" class="difflineplus">+</span>
<a href="#l49.389"></a><span id="l49.389" class="difflineplus">+  // Testing edit keyword</span>
<a href="#l49.390"></a><span id="l49.390" class="difflineplus">+  var txn11 = ptSvc.editBookmarkKeyword(bkmk1Id, &quot;kw1&quot;);</span>
<a href="#l49.391"></a><span id="l49.391" class="difflineplus">+  txn11.doTransaction();</span>
<a href="#l49.392"></a><span id="l49.392" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id);</span>
<a href="#l49.393"></a><span id="l49.393" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;keyword&quot;);</span>
<a href="#l49.394"></a><span id="l49.394" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;kw1&quot;); </span>
<a href="#l49.395"></a><span id="l49.395" class="difflineplus">+  txn11.undoTransaction();</span>
<a href="#l49.396"></a><span id="l49.396" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id);</span>
<a href="#l49.397"></a><span id="l49.397" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;keyword&quot;);</span>
<a href="#l49.398"></a><span id="l49.398" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;&quot;); </span>
<a href="#l49.399"></a><span id="l49.399" class="difflineplus">+</span>
<a href="#l49.400"></a><span id="l49.400" class="difflineplus">+  // Testing create livemark</span>
<a href="#l49.401"></a><span id="l49.401" class="difflineplus">+  var txn12 = ptSvc.createLivemark(uri(&quot;http://feeduri.com&quot;),</span>
<a href="#l49.402"></a><span id="l49.402" class="difflineplus">+                                   uri(&quot;http://siteuri.com&quot;),</span>
<a href="#l49.403"></a><span id="l49.403" class="difflineplus">+                                   &quot;Livemark1&quot;, root);</span>
<a href="#l49.404"></a><span id="l49.404" class="difflineplus">+  txn12.doTransaction();</span>
<a href="#l49.405"></a><span id="l49.405" class="difflineplus">+  var lvmkId = observer._itemAddedId;</span>
<a href="#l49.406"></a><span id="l49.406" class="difflineplus">+  do_check_true(lmsvc.isLivemark(lvmkId));</span>
<a href="#l49.407"></a><span id="l49.407" class="difflineplus">+  do_check_eq(lmsvc.getSiteURI(lvmkId).spec, &quot;http://siteuri.com/&quot;);</span>
<a href="#l49.408"></a><span id="l49.408" class="difflineplus">+  do_check_eq(lmsvc.getFeedURI(lvmkId).spec, &quot;http://feeduri.com/&quot;);</span>
<a href="#l49.409"></a><span id="l49.409" class="difflineplus">+  txn12.undoTransaction();</span>
<a href="#l49.410"></a><span id="l49.410" class="difflineplus">+  do_check_false(lmsvc.isLivemark(lvmkId));</span>
<a href="#l49.411"></a><span id="l49.411" class="difflineplus">+  txn12.redoTransaction();</span>
<a href="#l49.412"></a><span id="l49.412" class="difflineplus">+  lvmkId = observer._itemAddedId;</span>
<a href="#l49.413"></a><span id="l49.413" class="difflineplus">+  do_check_true(lmsvc.isLivemark(lvmkId));</span>
<a href="#l49.414"></a><span id="l49.414" class="difflineplus">+  do_check_eq(lmsvc.getSiteURI(lvmkId).spec, &quot;http://siteuri.com/&quot;);</span>
<a href="#l49.415"></a><span id="l49.415" class="difflineplus">+  do_check_eq(lmsvc.getFeedURI(lvmkId).spec, &quot;http://feeduri.com/&quot;);</span>
<a href="#l49.416"></a><span id="l49.416" class="difflineplus">+</span>
<a href="#l49.417"></a><span id="l49.417" class="difflineplus">+  // editLivemarkSiteURI</span>
<a href="#l49.418"></a><span id="l49.418" class="difflineplus">+  var txn13 = ptSvc.editLivemarkSiteURI(lvmkId, uri(&quot;http://new-siteuri.com/&quot;));</span>
<a href="#l49.419"></a><span id="l49.419" class="difflineplus">+  txn13.doTransaction();</span>
<a href="#l49.420"></a><span id="l49.420" class="difflineplus">+  do_check_eq(observer._itemChangedId, lvmkId);</span>
<a href="#l49.421"></a><span id="l49.421" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;livemark/siteURI&quot;);</span>
<a href="#l49.422"></a><span id="l49.422" class="difflineplus">+  do_check_eq(lmsvc.getSiteURI(lvmkId).spec, &quot;http://new-siteuri.com/&quot;);</span>
<a href="#l49.423"></a><span id="l49.423" class="difflineplus">+  txn13.undoTransaction();</span>
<a href="#l49.424"></a><span id="l49.424" class="difflineplus">+  do_check_eq(observer._itemChangedId, lvmkId);</span>
<a href="#l49.425"></a><span id="l49.425" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;livemark/siteURI&quot;);</span>
<a href="#l49.426"></a><span id="l49.426" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;&quot;);</span>
<a href="#l49.427"></a><span id="l49.427" class="difflineplus">+  do_check_eq(lmsvc.getSiteURI(lvmkId).spec, &quot;http://siteuri.com/&quot;);</span>
<a href="#l49.428"></a><span id="l49.428" class="difflineplus">+  txn13.redoTransaction();</span>
<a href="#l49.429"></a><span id="l49.429" class="difflineplus">+  do_check_eq(observer._itemChangedId, lvmkId);</span>
<a href="#l49.430"></a><span id="l49.430" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;livemark/siteURI&quot;);</span>
<a href="#l49.431"></a><span id="l49.431" class="difflineplus">+  do_check_eq(lmsvc.getSiteURI(lvmkId).spec, &quot;http://new-siteuri.com/&quot;);</span>
<a href="#l49.432"></a><span id="l49.432" class="difflineplus">+  txn13.undoTransaction();</span>
<a href="#l49.433"></a><span id="l49.433" class="difflineplus">+  do_check_eq(observer._itemChangedId, lvmkId);</span>
<a href="#l49.434"></a><span id="l49.434" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;livemark/siteURI&quot;);</span>
<a href="#l49.435"></a><span id="l49.435" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;&quot;);</span>
<a href="#l49.436"></a><span id="l49.436" class="difflineplus">+  do_check_eq(lmsvc.getSiteURI(lvmkId).spec, &quot;http://siteuri.com/&quot;);</span>
<a href="#l49.437"></a><span id="l49.437" class="difflineplus">+</span>
<a href="#l49.438"></a><span id="l49.438" class="difflineplus">+  // editLivemarkFeedURI</span>
<a href="#l49.439"></a><span id="l49.439" class="difflineplus">+  var txn14 = ptSvc.editLivemarkFeedURI(lvmkId, uri(&quot;http://new-feeduri.com/&quot;));</span>
<a href="#l49.440"></a><span id="l49.440" class="difflineplus">+  txn14.doTransaction();</span>
<a href="#l49.441"></a><span id="l49.441" class="difflineplus">+  do_check_eq(observer._itemChangedId, lvmkId);</span>
<a href="#l49.442"></a><span id="l49.442" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;livemark/feedURI&quot;);</span>
<a href="#l49.443"></a><span id="l49.443" class="difflineplus">+  do_check_eq(lmsvc.getFeedURI(lvmkId).spec, &quot;http://new-feeduri.com/&quot;);</span>
<a href="#l49.444"></a><span id="l49.444" class="difflineplus">+  txn14.undoTransaction();</span>
<a href="#l49.445"></a><span id="l49.445" class="difflineplus">+  do_check_eq(observer._itemChangedId, lvmkId);</span>
<a href="#l49.446"></a><span id="l49.446" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;livemark/feedURI&quot;);</span>
<a href="#l49.447"></a><span id="l49.447" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;&quot;);</span>
<a href="#l49.448"></a><span id="l49.448" class="difflineplus">+  do_check_eq(lmsvc.getFeedURI(lvmkId).spec, &quot;http://feeduri.com/&quot;);</span>
<a href="#l49.449"></a><span id="l49.449" class="difflineplus">+  txn14.redoTransaction();</span>
<a href="#l49.450"></a><span id="l49.450" class="difflineplus">+  do_check_eq(observer._itemChangedId, lvmkId);</span>
<a href="#l49.451"></a><span id="l49.451" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;livemark/feedURI&quot;);</span>
<a href="#l49.452"></a><span id="l49.452" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;&quot;);</span>
<a href="#l49.453"></a><span id="l49.453" class="difflineplus">+  do_check_eq(lmsvc.getFeedURI(lvmkId).spec, &quot;http://new-feeduri.com/&quot;);</span>
<a href="#l49.454"></a><span id="l49.454" class="difflineplus">+  txn14.undoTransaction();</span>
<a href="#l49.455"></a><span id="l49.455" class="difflineplus">+  do_check_eq(observer._itemChangedId, lvmkId);</span>
<a href="#l49.456"></a><span id="l49.456" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;livemark/feedURI&quot;);</span>
<a href="#l49.457"></a><span id="l49.457" class="difflineplus">+  do_check_eq(observer._itemChangedValue, &quot;&quot;);</span>
<a href="#l49.458"></a><span id="l49.458" class="difflineplus">+  do_check_eq(lmsvc.getFeedURI(lvmkId).spec, &quot;http://feeduri.com/&quot;);</span>
<a href="#l49.459"></a><span id="l49.459" class="difflineplus">+</span>
<a href="#l49.460"></a><span id="l49.460" class="difflineplus">+  // Testing remove livemark</span>
<a href="#l49.461"></a><span id="l49.461" class="difflineplus">+  // Set an annotation and check that we don't lose it on undo</span>
<a href="#l49.462"></a><span id="l49.462" class="difflineplus">+  annosvc.setItemAnnotation(lvmkId, &quot;livemark/testAnno&quot;, &quot;testAnno&quot;,</span>
<a href="#l49.463"></a><span id="l49.463" class="difflineplus">+                            0, annosvc.EXPIRE_NEVER);</span>
<a href="#l49.464"></a><span id="l49.464" class="difflineplus">+  var txn15 = ptSvc.removeItem(lvmkId);</span>
<a href="#l49.465"></a><span id="l49.465" class="difflineplus">+  txn15.doTransaction();</span>
<a href="#l49.466"></a><span id="l49.466" class="difflineplus">+  do_check_false(lmsvc.isLivemark(lvmkId));</span>
<a href="#l49.467"></a><span id="l49.467" class="difflineplus">+  do_check_eq(observer._itemRemovedId, lvmkId);</span>
<a href="#l49.468"></a><span id="l49.468" class="difflineplus">+  txn15.undoTransaction();</span>
<a href="#l49.469"></a><span id="l49.469" class="difflineplus">+  lvmkId = observer._itemAddedId;</span>
<a href="#l49.470"></a><span id="l49.470" class="difflineplus">+  do_check_true(lmsvc.isLivemark(lvmkId));</span>
<a href="#l49.471"></a><span id="l49.471" class="difflineplus">+  do_check_eq(lmsvc.getSiteURI(lvmkId).spec, &quot;http://siteuri.com/&quot;);</span>
<a href="#l49.472"></a><span id="l49.472" class="difflineplus">+  do_check_eq(lmsvc.getFeedURI(lvmkId).spec, &quot;http://feeduri.com/&quot;);</span>
<a href="#l49.473"></a><span id="l49.473" class="difflineplus">+  do_check_eq(annosvc.getItemAnnotation(lvmkId, &quot;livemark/testAnno&quot;), &quot;testAnno&quot;);</span>
<a href="#l49.474"></a><span id="l49.474" class="difflineplus">+  txn15.redoTransaction();</span>
<a href="#l49.475"></a><span id="l49.475" class="difflineplus">+  do_check_false(lmsvc.isLivemark(lvmkId));</span>
<a href="#l49.476"></a><span id="l49.476" class="difflineplus">+  do_check_eq(observer._itemRemovedId, lvmkId);</span>
<a href="#l49.477"></a><span id="l49.477" class="difflineplus">+</span>
<a href="#l49.478"></a><span id="l49.478" class="difflineplus">+  // Test LoadInSidebar transaction.</span>
<a href="#l49.479"></a><span id="l49.479" class="difflineplus">+  var txn16 = ptSvc.setLoadInSidebar(bkmk1Id, true);</span>
<a href="#l49.480"></a><span id="l49.480" class="difflineplus">+  txn16.doTransaction();</span>
<a href="#l49.481"></a><span id="l49.481" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id);</span>
<a href="#l49.482"></a><span id="l49.482" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, PlacesUIUtils.LOAD_IN_SIDEBAR_ANNO);</span>
<a href="#l49.483"></a><span id="l49.483" class="difflineplus">+  do_check_eq(observer._itemChanged_isAnnotationProperty, true);</span>
<a href="#l49.484"></a><span id="l49.484" class="difflineplus">+  txn16.undoTransaction();</span>
<a href="#l49.485"></a><span id="l49.485" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id);</span>
<a href="#l49.486"></a><span id="l49.486" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, PlacesUIUtils.LOAD_IN_SIDEBAR_ANNO);</span>
<a href="#l49.487"></a><span id="l49.487" class="difflineplus">+  do_check_eq(observer._itemChanged_isAnnotationProperty, true);</span>
<a href="#l49.488"></a><span id="l49.488" class="difflineplus">+</span>
<a href="#l49.489"></a><span id="l49.489" class="difflineplus">+  // Test generic item annotation</span>
<a href="#l49.490"></a><span id="l49.490" class="difflineplus">+  var itemAnnoObj = { name: &quot;testAnno/testInt&quot;,</span>
<a href="#l49.491"></a><span id="l49.491" class="difflineplus">+                      type: Ci.nsIAnnotationService.TYPE_INT32,</span>
<a href="#l49.492"></a><span id="l49.492" class="difflineplus">+                      flags: 0,</span>
<a href="#l49.493"></a><span id="l49.493" class="difflineplus">+                      value: 123,</span>
<a href="#l49.494"></a><span id="l49.494" class="difflineplus">+                      expires: Ci.nsIAnnotationService.EXPIRE_NEVER };</span>
<a href="#l49.495"></a><span id="l49.495" class="difflineplus">+  var genItemAnnoTxn = ptSvc.setItemAnnotation(bkmk1Id, itemAnnoObj);</span>
<a href="#l49.496"></a><span id="l49.496" class="difflineplus">+  genItemAnnoTxn.doTransaction();</span>
<a href="#l49.497"></a><span id="l49.497" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id);</span>
<a href="#l49.498"></a><span id="l49.498" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;testAnno/testInt&quot;);</span>
<a href="#l49.499"></a><span id="l49.499" class="difflineplus">+  do_check_eq(observer._itemChanged_isAnnotationProperty, true);</span>
<a href="#l49.500"></a><span id="l49.500" class="difflineplus">+  genItemAnnoTxn.undoTransaction();</span>
<a href="#l49.501"></a><span id="l49.501" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id);</span>
<a href="#l49.502"></a><span id="l49.502" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;testAnno/testInt&quot;);</span>
<a href="#l49.503"></a><span id="l49.503" class="difflineplus">+  do_check_eq(observer._itemChanged_isAnnotationProperty, true);</span>
<a href="#l49.504"></a><span id="l49.504" class="difflineplus">+  genItemAnnoTxn.redoTransaction();</span>
<a href="#l49.505"></a><span id="l49.505" class="difflineplus">+  do_check_eq(observer._itemChangedId, bkmk1Id);</span>
<a href="#l49.506"></a><span id="l49.506" class="difflineplus">+  do_check_eq(observer._itemChangedProperty, &quot;testAnno/testInt&quot;);</span>
<a href="#l49.507"></a><span id="l49.507" class="difflineplus">+  do_check_eq(observer._itemChanged_isAnnotationProperty, true);</span>
<a href="#l49.508"></a><span id="l49.508" class="difflineplus">+</span>
<a href="#l49.509"></a><span id="l49.509" class="difflineplus">+  // Test generic page annotation</span>
<a href="#l49.510"></a><span id="l49.510" class="difflineplus">+  var pageAnnoObj = { name: &quot;testAnno/testInt&quot;,</span>
<a href="#l49.511"></a><span id="l49.511" class="difflineplus">+                      type: Ci.nsIAnnotationService.TYPE_INT32,</span>
<a href="#l49.512"></a><span id="l49.512" class="difflineplus">+                      flags: 0,</span>
<a href="#l49.513"></a><span id="l49.513" class="difflineplus">+                      value: 123,</span>
<a href="#l49.514"></a><span id="l49.514" class="difflineplus">+                      expires: Ci.nsIAnnotationService.EXPIRE_NEVER };</span>
<a href="#l49.515"></a><span id="l49.515" class="difflineplus">+  var hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l49.516"></a><span id="l49.516" class="difflineplus">+           getService(Ci.nsINavHistoryService);</span>
<a href="#l49.517"></a><span id="l49.517" class="difflineplus">+  hs.addVisit(uri(&quot;http://www.mozilla.org/&quot;), Date.now() * 1000, null,</span>
<a href="#l49.518"></a><span id="l49.518" class="difflineplus">+              hs.TRANSITION_TYPED, false, 0);</span>
<a href="#l49.519"></a><span id="l49.519" class="difflineplus">+  var genPageAnnoTxn = ptSvc.setPageAnnotation(uri(&quot;http://www.mozilla.org/&quot;), pageAnnoObj);</span>
<a href="#l49.520"></a><span id="l49.520" class="difflineplus">+  genPageAnnoTxn.doTransaction();</span>
<a href="#l49.521"></a><span id="l49.521" class="difflineplus">+  do_check_true(annosvc.pageHasAnnotation(uri(&quot;http://www.mozilla.org/&quot;), &quot;testAnno/testInt&quot;));</span>
<a href="#l49.522"></a><span id="l49.522" class="difflineplus">+  genPageAnnoTxn.undoTransaction();</span>
<a href="#l49.523"></a><span id="l49.523" class="difflineplus">+  do_check_false(annosvc.pageHasAnnotation(uri(&quot;http://www.mozilla.org/&quot;), &quot;testAnno/testInt&quot;));</span>
<a href="#l49.524"></a><span id="l49.524" class="difflineplus">+  genPageAnnoTxn.redoTransaction();</span>
<a href="#l49.525"></a><span id="l49.525" class="difflineplus">+  do_check_true(annosvc.pageHasAnnotation(uri(&quot;http://www.mozilla.org/&quot;), &quot;testAnno/testInt&quot;));</span>
<a href="#l49.526"></a><span id="l49.526" class="difflineplus">+</span>
<a href="#l49.527"></a><span id="l49.527" class="difflineplus">+  // sortFolderByName</span>
<a href="#l49.528"></a><span id="l49.528" class="difflineplus">+  ptSvc.doTransaction(ptSvc.createFolder(&quot;Sorting folder&quot;, root, bmStartIndex, [], null));</span>
<a href="#l49.529"></a><span id="l49.529" class="difflineplus">+  var srtFldId = observer._itemAddedId;</span>
<a href="#l49.530"></a><span id="l49.530" class="difflineplus">+  do_check_eq(bmsvc.getItemTitle(srtFldId), &quot;Sorting folder&quot;);</span>
<a href="#l49.531"></a><span id="l49.531" class="difflineplus">+  ptSvc.doTransaction(ptSvc.createItem(uri(&quot;http://www.sortingtest.com&quot;), srtFldId, -1, &quot;c&quot;));</span>
<a href="#l49.532"></a><span id="l49.532" class="difflineplus">+  ptSvc.doTransaction(ptSvc.createItem(uri(&quot;http://www.sortingtest.com&quot;), srtFldId, -1, &quot;b&quot;));   </span>
<a href="#l49.533"></a><span id="l49.533" class="difflineplus">+  ptSvc.doTransaction(ptSvc.createItem(uri(&quot;http://www.sortingtest.com&quot;), srtFldId, -1, &quot;a&quot;));</span>
<a href="#l49.534"></a><span id="l49.534" class="difflineplus">+  var b = bmsvc.getBookmarkIdsForURI(uri(&quot;http://www.sortingtest.com&quot;));</span>
<a href="#l49.535"></a><span id="l49.535" class="difflineplus">+  b.sort();</span>
<a href="#l49.536"></a><span id="l49.536" class="difflineplus">+  var b1 = b[0];</span>
<a href="#l49.537"></a><span id="l49.537" class="difflineplus">+  var b2 = b[1];</span>
<a href="#l49.538"></a><span id="l49.538" class="difflineplus">+  var b3 = b[2];</span>
<a href="#l49.539"></a><span id="l49.539" class="difflineplus">+  do_check_eq(0, bmsvc.getItemIndex(b1));</span>
<a href="#l49.540"></a><span id="l49.540" class="difflineplus">+  do_check_eq(1, bmsvc.getItemIndex(b2));</span>
<a href="#l49.541"></a><span id="l49.541" class="difflineplus">+  do_check_eq(2, bmsvc.getItemIndex(b3));</span>
<a href="#l49.542"></a><span id="l49.542" class="difflineplus">+  var txn17 = ptSvc.sortFolderByName(srtFldId);</span>
<a href="#l49.543"></a><span id="l49.543" class="difflineplus">+  txn17.doTransaction();</span>
<a href="#l49.544"></a><span id="l49.544" class="difflineplus">+  do_check_eq(2, bmsvc.getItemIndex(b1));</span>
<a href="#l49.545"></a><span id="l49.545" class="difflineplus">+  do_check_eq(1, bmsvc.getItemIndex(b2));</span>
<a href="#l49.546"></a><span id="l49.546" class="difflineplus">+  do_check_eq(0, bmsvc.getItemIndex(b3));</span>
<a href="#l49.547"></a><span id="l49.547" class="difflineplus">+  txn17.undoTransaction();</span>
<a href="#l49.548"></a><span id="l49.548" class="difflineplus">+  do_check_eq(0, bmsvc.getItemIndex(b1));</span>
<a href="#l49.549"></a><span id="l49.549" class="difflineplus">+  do_check_eq(1, bmsvc.getItemIndex(b2));</span>
<a href="#l49.550"></a><span id="l49.550" class="difflineplus">+  do_check_eq(2, bmsvc.getItemIndex(b3));</span>
<a href="#l49.551"></a><span id="l49.551" class="difflineplus">+  txn17.redoTransaction();</span>
<a href="#l49.552"></a><span id="l49.552" class="difflineplus">+  do_check_eq(2, bmsvc.getItemIndex(b1));</span>
<a href="#l49.553"></a><span id="l49.553" class="difflineplus">+  do_check_eq(1, bmsvc.getItemIndex(b2));</span>
<a href="#l49.554"></a><span id="l49.554" class="difflineplus">+  do_check_eq(0, bmsvc.getItemIndex(b3));</span>
<a href="#l49.555"></a><span id="l49.555" class="difflineplus">+  txn17.undoTransaction();</span>
<a href="#l49.556"></a><span id="l49.556" class="difflineplus">+  do_check_eq(0, bmsvc.getItemIndex(b1));</span>
<a href="#l49.557"></a><span id="l49.557" class="difflineplus">+  do_check_eq(1, bmsvc.getItemIndex(b2));</span>
<a href="#l49.558"></a><span id="l49.558" class="difflineplus">+  do_check_eq(2, bmsvc.getItemIndex(b3));</span>
<a href="#l49.559"></a><span id="l49.559" class="difflineplus">+</span>
<a href="#l49.560"></a><span id="l49.560" class="difflineplus">+  // editBookmarkMicrosummary</span>
<a href="#l49.561"></a><span id="l49.561" class="difflineplus">+  var tmpMs = mss.createMicrosummary(uri(&quot;http://testmicro.com&quot;), </span>
<a href="#l49.562"></a><span id="l49.562" class="difflineplus">+                                     uri(&quot;http://dietrich.ganx4.com/mozilla/test-microsummary.xml&quot;));</span>
<a href="#l49.563"></a><span id="l49.563" class="difflineplus">+  ptSvc.doTransaction(</span>
<a href="#l49.564"></a><span id="l49.564" class="difflineplus">+  ptSvc.createItem(uri(&quot;http://dietrich.ganx4.com/mozilla/test-microsummary-content.php&quot;),</span>
<a href="#l49.565"></a><span id="l49.565" class="difflineplus">+                   root, -1, &quot;micro test&quot;, null, null, null));</span>
<a href="#l49.566"></a><span id="l49.566" class="difflineplus">+  var bId = (bmsvc.getBookmarkIdsForURI(uri(&quot;http://dietrich.ganx4.com/mozilla/test-microsummary-content.php&quot;)))[0];</span>
<a href="#l49.567"></a><span id="l49.567" class="difflineplus">+  do_check_true(!mss.hasMicrosummary(bId));</span>
<a href="#l49.568"></a><span id="l49.568" class="difflineplus">+  var txn18 = ptSvc.editBookmarkMicrosummary(bId, tmpMs);</span>
<a href="#l49.569"></a><span id="l49.569" class="difflineplus">+  txn18.doTransaction();</span>
<a href="#l49.570"></a><span id="l49.570" class="difflineplus">+  do_check_eq(observer._itemChangedId, bId);</span>
<a href="#l49.571"></a><span id="l49.571" class="difflineplus">+  do_check_true(mss.hasMicrosummary(bId));</span>
<a href="#l49.572"></a><span id="l49.572" class="difflineplus">+  txn18.undoTransaction();</span>
<a href="#l49.573"></a><span id="l49.573" class="difflineplus">+  do_check_eq(observer._itemChangedId, bId);</span>
<a href="#l49.574"></a><span id="l49.574" class="difflineplus">+  do_check_true(!mss.hasMicrosummary(bId));</span>
<a href="#l49.575"></a><span id="l49.575" class="difflineplus">+</span>
<a href="#l49.576"></a><span id="l49.576" class="difflineplus">+  // Testing edit Post Data</span>
<a href="#l49.577"></a><span id="l49.577" class="difflineplus">+  const POST_DATA_ANNO = &quot;bookmarkProperties/POSTData&quot;;</span>
<a href="#l49.578"></a><span id="l49.578" class="difflineplus">+  var postData = &quot;foo&quot;;</span>
<a href="#l49.579"></a><span id="l49.579" class="difflineplus">+  var postDataURI = uri(&quot;http://foo.com&quot;);</span>
<a href="#l49.580"></a><span id="l49.580" class="difflineplus">+  ptSvc.doTransaction(</span>
<a href="#l49.581"></a><span id="l49.581" class="difflineplus">+    ptSvc.createItem(postDataURI, root, -1, &quot;postdata test&quot;, null, null, null));</span>
<a href="#l49.582"></a><span id="l49.582" class="difflineplus">+  var postDataId = (bmsvc.getBookmarkIdsForURI(postDataURI))[0];</span>
<a href="#l49.583"></a><span id="l49.583" class="difflineplus">+  var postDataTxn = ptSvc.editBookmarkPostData(postDataId, postData);</span>
<a href="#l49.584"></a><span id="l49.584" class="difflineplus">+  postDataTxn.doTransaction();</span>
<a href="#l49.585"></a><span id="l49.585" class="difflineplus">+  do_check_true(annosvc.itemHasAnnotation(postDataId, POST_DATA_ANNO))</span>
<a href="#l49.586"></a><span id="l49.586" class="difflineplus">+  do_check_eq(annosvc.getItemAnnotation(postDataId, POST_DATA_ANNO), postData);</span>
<a href="#l49.587"></a><span id="l49.587" class="difflineplus">+  postDataTxn.undoTransaction();</span>
<a href="#l49.588"></a><span id="l49.588" class="difflineplus">+  do_check_false(annosvc.itemHasAnnotation(postDataId, POST_DATA_ANNO))</span>
<a href="#l49.589"></a><span id="l49.589" class="difflineplus">+</span>
<a href="#l49.590"></a><span id="l49.590" class="difflineplus">+  // Test editing item date added</span>
<a href="#l49.591"></a><span id="l49.591" class="difflineplus">+  var oldAdded = bmsvc.getItemDateAdded(bkmk1Id);</span>
<a href="#l49.592"></a><span id="l49.592" class="difflineplus">+  var newAdded = Date.now();</span>
<a href="#l49.593"></a><span id="l49.593" class="difflineplus">+  var eidaTxn = ptSvc.editItemDateAdded(bkmk1Id, newAdded);</span>
<a href="#l49.594"></a><span id="l49.594" class="difflineplus">+  eidaTxn.doTransaction();</span>
<a href="#l49.595"></a><span id="l49.595" class="difflineplus">+  do_check_eq(newAdded, bmsvc.getItemDateAdded(bkmk1Id));</span>
<a href="#l49.596"></a><span id="l49.596" class="difflineplus">+  eidaTxn.undoTransaction();</span>
<a href="#l49.597"></a><span id="l49.597" class="difflineplus">+  do_check_eq(oldAdded, bmsvc.getItemDateAdded(bkmk1Id));</span>
<a href="#l49.598"></a><span id="l49.598" class="difflineplus">+</span>
<a href="#l49.599"></a><span id="l49.599" class="difflineplus">+  // Test editing item last modified </span>
<a href="#l49.600"></a><span id="l49.600" class="difflineplus">+  var oldModified = bmsvc.getItemLastModified(bkmk1Id);</span>
<a href="#l49.601"></a><span id="l49.601" class="difflineplus">+  var newModified = Date.now();</span>
<a href="#l49.602"></a><span id="l49.602" class="difflineplus">+  var eilmTxn = ptSvc.editItemLastModified(bkmk1Id, newModified);</span>
<a href="#l49.603"></a><span id="l49.603" class="difflineplus">+  eilmTxn.doTransaction();</span>
<a href="#l49.604"></a><span id="l49.604" class="difflineplus">+  do_check_eq(newModified, bmsvc.getItemLastModified(bkmk1Id));</span>
<a href="#l49.605"></a><span id="l49.605" class="difflineplus">+  eilmTxn.undoTransaction();</span>
<a href="#l49.606"></a><span id="l49.606" class="difflineplus">+  do_check_eq(oldModified, bmsvc.getItemLastModified(bkmk1Id));</span>
<a href="#l49.607"></a><span id="l49.607" class="difflineplus">+</span>
<a href="#l49.608"></a><span id="l49.608" class="difflineplus">+  // Test tagURI/untagURI</span>
<a href="#l49.609"></a><span id="l49.609" class="difflineplus">+  var tagURI = uri(&quot;http://foo.tld&quot;);</span>
<a href="#l49.610"></a><span id="l49.610" class="difflineplus">+  var tagTxn = ptSvc.tagURI(tagURI, [&quot;foo&quot;, &quot;bar&quot;]);</span>
<a href="#l49.611"></a><span id="l49.611" class="difflineplus">+  tagTxn.doTransaction();</span>
<a href="#l49.612"></a><span id="l49.612" class="difflineplus">+  do_check_eq(uneval(tagssvc.getTagsForURI(tagURI)), uneval([&quot;bar&quot;,&quot;foo&quot;]));</span>
<a href="#l49.613"></a><span id="l49.613" class="difflineplus">+  tagTxn.undoTransaction();</span>
<a href="#l49.614"></a><span id="l49.614" class="difflineplus">+  do_check_eq(tagssvc.getTagsForURI(tagURI).length, 0);</span>
<a href="#l49.615"></a><span id="l49.615" class="difflineplus">+  tagTxn.redoTransaction();</span>
<a href="#l49.616"></a><span id="l49.616" class="difflineplus">+  do_check_eq(uneval(tagssvc.getTagsForURI(tagURI)), uneval([&quot;bar&quot;,&quot;foo&quot;]));</span>
<a href="#l49.617"></a><span id="l49.617" class="difflineplus">+  var untagTxn = ptSvc.untagURI(tagURI, [&quot;bar&quot;]);</span>
<a href="#l49.618"></a><span id="l49.618" class="difflineplus">+  untagTxn.doTransaction();</span>
<a href="#l49.619"></a><span id="l49.619" class="difflineplus">+  do_check_eq(uneval(tagssvc.getTagsForURI(tagURI)), uneval([&quot;foo&quot;]));</span>
<a href="#l49.620"></a><span id="l49.620" class="difflineplus">+  untagTxn.undoTransaction();</span>
<a href="#l49.621"></a><span id="l49.621" class="difflineplus">+  do_check_eq(uneval(tagssvc.getTagsForURI(tagURI)), uneval([&quot;bar&quot;,&quot;foo&quot;]));</span>
<a href="#l49.622"></a><span id="l49.622" class="difflineplus">+  untagTxn.redoTransaction();</span>
<a href="#l49.623"></a><span id="l49.623" class="difflineplus">+  do_check_eq(uneval(tagssvc.getTagsForURI(tagURI)), uneval([&quot;foo&quot;]));</span>
<a href="#l49.624"></a><span id="l49.624" class="difflineplus">+</span>
<a href="#l49.625"></a><span id="l49.625" class="difflineplus">+  // Test aggregate removeItem transaction</span>
<a href="#l49.626"></a><span id="l49.626" class="difflineplus">+  var bkmk1Id = bmsvc.insertBookmark(root, uri(&quot;http://www.mozilla.org/&quot;), 0, &quot;Mozilla&quot;);</span>
<a href="#l49.627"></a><span id="l49.627" class="difflineplus">+  var bkmk2Id = bmsvc.insertSeparator(root, 1);</span>
<a href="#l49.628"></a><span id="l49.628" class="difflineplus">+  var bkmk3Id = bmsvc.createFolder(root, &quot;folder&quot;, 2);</span>
<a href="#l49.629"></a><span id="l49.629" class="difflineplus">+  var bkmk3_1Id = bmsvc.insertBookmark(bkmk3Id, uri(&quot;http://www.mozilla.org/&quot;), 0, &quot;Mozilla&quot;);</span>
<a href="#l49.630"></a><span id="l49.630" class="difflineplus">+  var bkmk3_2Id = bmsvc.insertSeparator(bkmk3Id, 1);</span>
<a href="#l49.631"></a><span id="l49.631" class="difflineplus">+  var bkmk3_3Id = bmsvc.createFolder(bkmk3Id, &quot;folder&quot;, 2);</span>
<a href="#l49.632"></a><span id="l49.632" class="difflineplus">+</span>
<a href="#l49.633"></a><span id="l49.633" class="difflineplus">+  var transactions = [];</span>
<a href="#l49.634"></a><span id="l49.634" class="difflineplus">+  transactions.push(ptSvc.removeItem(bkmk1Id));</span>
<a href="#l49.635"></a><span id="l49.635" class="difflineplus">+  transactions.push(ptSvc.removeItem(bkmk2Id));</span>
<a href="#l49.636"></a><span id="l49.636" class="difflineplus">+  transactions.push(ptSvc.removeItem(bkmk3Id));</span>
<a href="#l49.637"></a><span id="l49.637" class="difflineplus">+  var txn = ptSvc.aggregateTransactions(&quot;RemoveItems&quot;, transactions);</span>
<a href="#l49.638"></a><span id="l49.638" class="difflineplus">+</span>
<a href="#l49.639"></a><span id="l49.639" class="difflineplus">+  txn.doTransaction();</span>
<a href="#l49.640"></a><span id="l49.640" class="difflineplus">+  do_check_eq(bmsvc.getItemIndex(bkmk1Id), -1);</span>
<a href="#l49.641"></a><span id="l49.641" class="difflineplus">+  do_check_eq(bmsvc.getItemIndex(bkmk2Id), -1);</span>
<a href="#l49.642"></a><span id="l49.642" class="difflineplus">+  do_check_eq(bmsvc.getItemIndex(bkmk3Id), -1);</span>
<a href="#l49.643"></a><span id="l49.643" class="difflineplus">+  do_check_eq(bmsvc.getItemIndex(bkmk3_1Id), -1);</span>
<a href="#l49.644"></a><span id="l49.644" class="difflineplus">+  do_check_eq(bmsvc.getItemIndex(bkmk3_2Id), -1);</span>
<a href="#l49.645"></a><span id="l49.645" class="difflineplus">+  do_check_eq(bmsvc.getItemIndex(bkmk3_3Id), -1);</span>
<a href="#l49.646"></a><span id="l49.646" class="difflineplus">+  // Check last removed item id.</span>
<a href="#l49.647"></a><span id="l49.647" class="difflineplus">+  do_check_eq(observer._itemRemovedId, bkmk3Id);</span>
<a href="#l49.648"></a><span id="l49.648" class="difflineplus">+</span>
<a href="#l49.649"></a><span id="l49.649" class="difflineplus">+  txn.undoTransaction();</span>
<a href="#l49.650"></a><span id="l49.650" class="difflineplus">+  var newBkmk1Id = bmsvc.getIdForItemAt(root, 0);</span>
<a href="#l49.651"></a><span id="l49.651" class="difflineplus">+  var newBkmk2Id = bmsvc.getIdForItemAt(root, 1);</span>
<a href="#l49.652"></a><span id="l49.652" class="difflineplus">+  var newBkmk3Id = bmsvc.getIdForItemAt(root, 2);</span>
<a href="#l49.653"></a><span id="l49.653" class="difflineplus">+  var newBkmk3_1Id = bmsvc.getIdForItemAt(newBkmk3Id, 0);</span>
<a href="#l49.654"></a><span id="l49.654" class="difflineplus">+  var newBkmk3_2Id = bmsvc.getIdForItemAt(newBkmk3Id, 1);</span>
<a href="#l49.655"></a><span id="l49.655" class="difflineplus">+  var newBkmk3_3Id = bmsvc.getIdForItemAt(newBkmk3Id, 2);</span>
<a href="#l49.656"></a><span id="l49.656" class="difflineplus">+  do_check_eq(bmsvc.getItemType(newBkmk1Id), bmsvc.TYPE_BOOKMARK);</span>
<a href="#l49.657"></a><span id="l49.657" class="difflineplus">+  do_check_eq(bmsvc.getBookmarkURI(newBkmk1Id).spec, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l49.658"></a><span id="l49.658" class="difflineplus">+  do_check_eq(bmsvc.getItemType(newBkmk2Id), bmsvc.TYPE_SEPARATOR);</span>
<a href="#l49.659"></a><span id="l49.659" class="difflineplus">+  do_check_eq(bmsvc.getItemType(newBkmk3Id), bmsvc.TYPE_FOLDER);</span>
<a href="#l49.660"></a><span id="l49.660" class="difflineplus">+  do_check_eq(bmsvc.getItemTitle(newBkmk3Id), &quot;folder&quot;);</span>
<a href="#l49.661"></a><span id="l49.661" class="difflineplus">+  do_check_eq(bmsvc.getFolderIdForItem(newBkmk3_1Id), newBkmk3Id);</span>
<a href="#l49.662"></a><span id="l49.662" class="difflineplus">+  do_check_eq(bmsvc.getItemType(newBkmk3_1Id), bmsvc.TYPE_BOOKMARK);</span>
<a href="#l49.663"></a><span id="l49.663" class="difflineplus">+  do_check_eq(bmsvc.getBookmarkURI(newBkmk3_1Id).spec, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l49.664"></a><span id="l49.664" class="difflineplus">+  do_check_eq(bmsvc.getFolderIdForItem(newBkmk3_2Id), newBkmk3Id);</span>
<a href="#l49.665"></a><span id="l49.665" class="difflineplus">+  do_check_eq(bmsvc.getItemType(newBkmk3_2Id), bmsvc.TYPE_SEPARATOR);</span>
<a href="#l49.666"></a><span id="l49.666" class="difflineplus">+  do_check_eq(bmsvc.getFolderIdForItem(newBkmk3_3Id), newBkmk3Id);</span>
<a href="#l49.667"></a><span id="l49.667" class="difflineplus">+  do_check_eq(bmsvc.getItemType(newBkmk3_3Id), bmsvc.TYPE_FOLDER);</span>
<a href="#l49.668"></a><span id="l49.668" class="difflineplus">+  do_check_eq(bmsvc.getItemTitle(newBkmk3_3Id), &quot;folder&quot;);</span>
<a href="#l49.669"></a><span id="l49.669" class="difflineplus">+  // Check last added back item id.</span>
<a href="#l49.670"></a><span id="l49.670" class="difflineplus">+  // Notice items are restored in reverse order.</span>
<a href="#l49.671"></a><span id="l49.671" class="difflineplus">+  do_check_eq(observer._itemAddedId, newBkmk1Id);</span>
<a href="#l49.672"></a><span id="l49.672" class="difflineplus">+</span>
<a href="#l49.673"></a><span id="l49.673" class="difflineplus">+  txn.redoTransaction();</span>
<a href="#l49.674"></a><span id="l49.674" class="difflineplus">+  do_check_eq(bmsvc.getItemIndex(newBkmk1Id), -1);</span>
<a href="#l49.675"></a><span id="l49.675" class="difflineplus">+  do_check_eq(bmsvc.getItemIndex(newBkmk2Id), -1);</span>
<a href="#l49.676"></a><span id="l49.676" class="difflineplus">+  do_check_eq(bmsvc.getItemIndex(newBkmk3Id), -1);</span>
<a href="#l49.677"></a><span id="l49.677" class="difflineplus">+  do_check_eq(bmsvc.getItemIndex(newBkmk3_1Id), -1);</span>
<a href="#l49.678"></a><span id="l49.678" class="difflineplus">+  do_check_eq(bmsvc.getItemIndex(newBkmk3_2Id), -1);</span>
<a href="#l49.679"></a><span id="l49.679" class="difflineplus">+  do_check_eq(bmsvc.getItemIndex(newBkmk3_3Id), -1);</span>
<a href="#l49.680"></a><span id="l49.680" class="difflineplus">+  // Check last removed item id.</span>
<a href="#l49.681"></a><span id="l49.681" class="difflineplus">+  do_check_eq(observer._itemRemovedId, newBkmk3Id);</span>
<a href="#l49.682"></a><span id="l49.682" class="difflineplus">+</span>
<a href="#l49.683"></a><span id="l49.683" class="difflineplus">+  txn.undoTransaction();</span>
<a href="#l49.684"></a><span id="l49.684" class="difflineplus">+  newBkmk1Id = bmsvc.getIdForItemAt(root, 0);</span>
<a href="#l49.685"></a><span id="l49.685" class="difflineplus">+  newBkmk2Id = bmsvc.getIdForItemAt(root, 1);</span>
<a href="#l49.686"></a><span id="l49.686" class="difflineplus">+  newBkmk3Id = bmsvc.getIdForItemAt(root, 2);</span>
<a href="#l49.687"></a><span id="l49.687" class="difflineplus">+  newBkmk3_1Id = bmsvc.getIdForItemAt(newBkmk3Id, 0);</span>
<a href="#l49.688"></a><span id="l49.688" class="difflineplus">+  newBkmk3_2Id = bmsvc.getIdForItemAt(newBkmk3Id, 1);</span>
<a href="#l49.689"></a><span id="l49.689" class="difflineplus">+  newBkmk3_3Id = bmsvc.getIdForItemAt(newBkmk3Id, 2);</span>
<a href="#l49.690"></a><span id="l49.690" class="difflineplus">+  do_check_eq(bmsvc.getItemType(newBkmk1Id), bmsvc.TYPE_BOOKMARK);</span>
<a href="#l49.691"></a><span id="l49.691" class="difflineplus">+  do_check_eq(bmsvc.getBookmarkURI(newBkmk1Id).spec, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l49.692"></a><span id="l49.692" class="difflineplus">+  do_check_eq(bmsvc.getItemType(newBkmk2Id), bmsvc.TYPE_SEPARATOR);</span>
<a href="#l49.693"></a><span id="l49.693" class="difflineplus">+  do_check_eq(bmsvc.getItemType(newBkmk3Id), bmsvc.TYPE_FOLDER);</span>
<a href="#l49.694"></a><span id="l49.694" class="difflineplus">+  do_check_eq(bmsvc.getItemTitle(newBkmk3Id), &quot;folder&quot;);</span>
<a href="#l49.695"></a><span id="l49.695" class="difflineplus">+  do_check_eq(bmsvc.getFolderIdForItem(newBkmk3_1Id), newBkmk3Id);</span>
<a href="#l49.696"></a><span id="l49.696" class="difflineplus">+  do_check_eq(bmsvc.getItemType(newBkmk3_1Id), bmsvc.TYPE_BOOKMARK);</span>
<a href="#l49.697"></a><span id="l49.697" class="difflineplus">+  do_check_eq(bmsvc.getBookmarkURI(newBkmk3_1Id).spec, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l49.698"></a><span id="l49.698" class="difflineplus">+  do_check_eq(bmsvc.getFolderIdForItem(newBkmk3_2Id), newBkmk3Id);</span>
<a href="#l49.699"></a><span id="l49.699" class="difflineplus">+  do_check_eq(bmsvc.getItemType(newBkmk3_2Id), bmsvc.TYPE_SEPARATOR);</span>
<a href="#l49.700"></a><span id="l49.700" class="difflineplus">+  do_check_eq(bmsvc.getFolderIdForItem(newBkmk3_3Id), newBkmk3Id);</span>
<a href="#l49.701"></a><span id="l49.701" class="difflineplus">+  do_check_eq(bmsvc.getItemType(newBkmk3_3Id), bmsvc.TYPE_FOLDER);</span>
<a href="#l49.702"></a><span id="l49.702" class="difflineplus">+  do_check_eq(bmsvc.getItemTitle(newBkmk3_3Id), &quot;folder&quot;);</span>
<a href="#l49.703"></a><span id="l49.703" class="difflineplus">+  // Check last added back item id.</span>
<a href="#l49.704"></a><span id="l49.704" class="difflineplus">+  // Notice items are restored in reverse order.</span>
<a href="#l49.705"></a><span id="l49.705" class="difflineplus">+  do_check_eq(observer._itemAddedId, newBkmk1Id);</span>
<a href="#l49.706"></a><span id="l49.706" class="difflineplus">+</span>
<a href="#l49.707"></a><span id="l49.707" class="difflineplus">+  // Test creating an item with child transactions.</span>
<a href="#l49.708"></a><span id="l49.708" class="difflineplus">+  var childTxns = [];</span>
<a href="#l49.709"></a><span id="l49.709" class="difflineplus">+  var newDateAdded = Date.now() - 20000;</span>
<a href="#l49.710"></a><span id="l49.710" class="difflineplus">+  childTxns.push(ptSvc.editItemDateAdded(null, newDateAdded));</span>
<a href="#l49.711"></a><span id="l49.711" class="difflineplus">+  var itemChildAnnoObj = { name: &quot;testAnno/testInt&quot;,</span>
<a href="#l49.712"></a><span id="l49.712" class="difflineplus">+                           type: Ci.nsIAnnotationService.TYPE_INT32,</span>
<a href="#l49.713"></a><span id="l49.713" class="difflineplus">+                           flags: 0,</span>
<a href="#l49.714"></a><span id="l49.714" class="difflineplus">+                           value: 123,</span>
<a href="#l49.715"></a><span id="l49.715" class="difflineplus">+                           expires: Ci.nsIAnnotationService.EXPIRE_NEVER };</span>
<a href="#l49.716"></a><span id="l49.716" class="difflineplus">+  childTxns.push(ptSvc.setItemAnnotation(null, itemChildAnnoObj));</span>
<a href="#l49.717"></a><span id="l49.717" class="difflineplus">+  var itemWChildTxn = ptSvc.createItem(uri(&quot;http://www.example.com&quot;), root,</span>
<a href="#l49.718"></a><span id="l49.718" class="difflineplus">+                                       bmStartIndex, &quot;Testing1&quot;, null, null,</span>
<a href="#l49.719"></a><span id="l49.719" class="difflineplus">+                                       childTxns);</span>
<a href="#l49.720"></a><span id="l49.720" class="difflineplus">+  try {</span>
<a href="#l49.721"></a><span id="l49.721" class="difflineplus">+    ptSvc.doTransaction(itemWChildTxn); // Also testing doTransaction</span>
<a href="#l49.722"></a><span id="l49.722" class="difflineplus">+    var itemId = (bmsvc.getBookmarkIdsForURI(uri(&quot;http://www.example.com&quot;)))[0];</span>
<a href="#l49.723"></a><span id="l49.723" class="difflineplus">+    do_check_eq(observer._itemAddedId, itemId);</span>
<a href="#l49.724"></a><span id="l49.724" class="difflineplus">+    do_check_eq(newDateAdded, bmsvc.getItemDateAdded(itemId));</span>
<a href="#l49.725"></a><span id="l49.725" class="difflineplus">+    do_check_eq(observer._itemChangedProperty, &quot;testAnno/testInt&quot;);</span>
<a href="#l49.726"></a><span id="l49.726" class="difflineplus">+    do_check_eq(observer._itemChanged_isAnnotationProperty, true);</span>
<a href="#l49.727"></a><span id="l49.727" class="difflineplus">+    do_check_true(annosvc.itemHasAnnotation(itemId, itemChildAnnoObj.name))</span>
<a href="#l49.728"></a><span id="l49.728" class="difflineplus">+    do_check_eq(annosvc.getItemAnnotation(itemId, itemChildAnnoObj.name),</span>
<a href="#l49.729"></a><span id="l49.729" class="difflineplus">+                itemChildAnnoObj.value);</span>
<a href="#l49.730"></a><span id="l49.730" class="difflineplus">+    itemWChildTxn.undoTransaction();</span>
<a href="#l49.731"></a><span id="l49.731" class="difflineplus">+    do_check_eq(observer._itemRemovedId, itemId);</span>
<a href="#l49.732"></a><span id="l49.732" class="difflineplus">+    itemWChildTxn.redoTransaction();</span>
<a href="#l49.733"></a><span id="l49.733" class="difflineplus">+    do_check_true(bmsvc.isBookmarked(uri(&quot;http://www.example.com&quot;)));</span>
<a href="#l49.734"></a><span id="l49.734" class="difflineplus">+    var newId = (bmsvc.getBookmarkIdsForURI(uri(&quot;http://www.example.com&quot;)))[0];</span>
<a href="#l49.735"></a><span id="l49.735" class="difflineplus">+    do_check_eq(newDateAdded, bmsvc.getItemDateAdded(newId));</span>
<a href="#l49.736"></a><span id="l49.736" class="difflineplus">+    do_check_eq(observer._itemAddedId, newId);</span>
<a href="#l49.737"></a><span id="l49.737" class="difflineplus">+    do_check_eq(observer._itemChangedProperty, &quot;testAnno/testInt&quot;);</span>
<a href="#l49.738"></a><span id="l49.738" class="difflineplus">+    do_check_eq(observer._itemChanged_isAnnotationProperty, true);</span>
<a href="#l49.739"></a><span id="l49.739" class="difflineplus">+    do_check_true(annosvc.itemHasAnnotation(newId, itemChildAnnoObj.name))</span>
<a href="#l49.740"></a><span id="l49.740" class="difflineplus">+    do_check_eq(annosvc.getItemAnnotation(newId, itemChildAnnoObj.name),</span>
<a href="#l49.741"></a><span id="l49.741" class="difflineplus">+                itemChildAnnoObj.value);</span>
<a href="#l49.742"></a><span id="l49.742" class="difflineplus">+    itemWChildTxn.undoTransaction();</span>
<a href="#l49.743"></a><span id="l49.743" class="difflineplus">+    do_check_eq(observer._itemRemovedId, newId);</span>
<a href="#l49.744"></a><span id="l49.744" class="difflineplus">+  } catch (ex) {</span>
<a href="#l49.745"></a><span id="l49.745" class="difflineplus">+    do_throw(&quot;Setting a child transaction in a createItem transaction did throw: &quot; + ex);</span>
<a href="#l49.746"></a><span id="l49.746" class="difflineplus">+  }</span>
<a href="#l49.747"></a><span id="l49.747" class="difflineplus">+</span>
<a href="#l49.748"></a><span id="l49.748" class="difflineplus">+  // Create a folder with child item transactions.</span>
<a href="#l49.749"></a><span id="l49.749" class="difflineplus">+  var childItemTxn = ptSvc.createItem(uri(&quot;http://www.childItem.com&quot;), root, bmStartIndex, &quot;childItem&quot;);</span>
<a href="#l49.750"></a><span id="l49.750" class="difflineplus">+  var folderWChildItemTxn = ptSvc.createFolder(&quot;Folder&quot;, root, bmStartIndex, null, [childItemTxn]);</span>
<a href="#l49.751"></a><span id="l49.751" class="difflineplus">+  try {</span>
<a href="#l49.752"></a><span id="l49.752" class="difflineplus">+    ptSvc.doTransaction(folderWChildItemTxn);</span>
<a href="#l49.753"></a><span id="l49.753" class="difflineplus">+    var childItemId = (bmsvc.getBookmarkIdsForURI(uri(&quot;http://www.childItem.com&quot;)))[0];</span>
<a href="#l49.754"></a><span id="l49.754" class="difflineplus">+    do_check_eq(observer._itemAddedId, childItemId);</span>
<a href="#l49.755"></a><span id="l49.755" class="difflineplus">+    do_check_eq(observer._itemAddedIndex, 0);</span>
<a href="#l49.756"></a><span id="l49.756" class="difflineplus">+    do_check_true(bmsvc.isBookmarked(uri(&quot;http://www.childItem.com&quot;)));</span>
<a href="#l49.757"></a><span id="l49.757" class="difflineplus">+    folderWChildItemTxn.undoTransaction();</span>
<a href="#l49.758"></a><span id="l49.758" class="difflineplus">+    do_check_false(bmsvc.isBookmarked(uri(&quot;http://www.childItem.com&quot;)));</span>
<a href="#l49.759"></a><span id="l49.759" class="difflineplus">+    folderWChildItemTxn.redoTransaction();</span>
<a href="#l49.760"></a><span id="l49.760" class="difflineplus">+    var newchildItemId = (bmsvc.getBookmarkIdsForURI(uri(&quot;http://www.childItem.com&quot;)))[0];</span>
<a href="#l49.761"></a><span id="l49.761" class="difflineplus">+    do_check_eq(observer._itemAddedIndex, 0);</span>
<a href="#l49.762"></a><span id="l49.762" class="difflineplus">+    do_check_eq(observer._itemAddedId, newchildItemId);</span>
<a href="#l49.763"></a><span id="l49.763" class="difflineplus">+    do_check_true(bmsvc.isBookmarked(uri(&quot;http://www.childItem.com&quot;)));</span>
<a href="#l49.764"></a><span id="l49.764" class="difflineplus">+    folderWChildItemTxn.undoTransaction();</span>
<a href="#l49.765"></a><span id="l49.765" class="difflineplus">+    do_check_false(bmsvc.isBookmarked(uri(&quot;http://www.childItem.com&quot;)));</span>
<a href="#l49.766"></a><span id="l49.766" class="difflineplus">+  } catch (ex) {</span>
<a href="#l49.767"></a><span id="l49.767" class="difflineplus">+    do_throw(&quot;Setting a child item transaction in a createFolder transaction did throw: &quot; + ex);</span>
<a href="#l49.768"></a><span id="l49.768" class="difflineplus">+  }</span>
<a href="#l49.769"></a><span id="l49.769" class="difflineplus">+</span>
<a href="#l49.770"></a><span id="l49.770" class="difflineplus">+  bmsvc.removeObserver(observer, false);</span>
<a href="#l49.771"></a><span id="l49.771" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1">new file mode 100644</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineminus">--- /dev/null</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineplus">+++ b/suite/common/places/tests/unit/test_txnGUIDs.js</span>
<a href="#l50.4"></a><span id="l50.4" class="difflineat">@@ -0,0 +1,87 @@</span>
<a href="#l50.5"></a><span id="l50.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l50.6"></a><span id="l50.6" class="difflineplus">+ *  vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l50.7"></a><span id="l50.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l50.8"></a><span id="l50.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l50.9"></a><span id="l50.9" class="difflineplus">+ *</span>
<a href="#l50.10"></a><span id="l50.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l50.11"></a><span id="l50.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineplus">+ *</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineplus">+ * License.</span>
<a href="#l50.19"></a><span id="l50.19" class="difflineplus">+ *</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineplus">+ *</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l50.23"></a><span id="l50.23" class="difflineplus">+ * Mozilla Foundation.</span>
<a href="#l50.24"></a><span id="l50.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l50.26"></a><span id="l50.26" class="difflineplus">+ *</span>
<a href="#l50.27"></a><span id="l50.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l50.28"></a><span id="l50.28" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l50.29"></a><span id="l50.29" class="difflineplus">+ *</span>
<a href="#l50.30"></a><span id="l50.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l50.36"></a><span id="l50.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l50.37"></a><span id="l50.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l50.38"></a><span id="l50.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l50.39"></a><span id="l50.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l50.40"></a><span id="l50.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l50.41"></a><span id="l50.41" class="difflineplus">+ *</span>
<a href="#l50.42"></a><span id="l50.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l50.43"></a><span id="l50.43" class="difflineplus">+</span>
<a href="#l50.44"></a><span id="l50.44" class="difflineplus">+/**</span>
<a href="#l50.45"></a><span id="l50.45" class="difflineplus">+ * This test will ensure any transactions service that is going to create</span>
<a href="#l50.46"></a><span id="l50.46" class="difflineplus">+ * a new item, won't replace the GUID when undoing and redoing the action.</span>
<a href="#l50.47"></a><span id="l50.47" class="difflineplus">+ */</span>
<a href="#l50.48"></a><span id="l50.48" class="difflineplus">+var bmsvc = PlacesUtils.bookmarks;</span>
<a href="#l50.49"></a><span id="l50.49" class="difflineplus">+var txnsvc = PlacesUIUtils.ptm;</span>
<a href="#l50.50"></a><span id="l50.50" class="difflineplus">+</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineplus">+function test_GUID_persistance(aTxn) {</span>
<a href="#l50.52"></a><span id="l50.52" class="difflineplus">+  aTxn.doTransaction();</span>
<a href="#l50.53"></a><span id="l50.53" class="difflineplus">+  var itemId = bmsvc.getIdForItemAt(bmsvc.unfiledBookmarksFolder, 0);</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineplus">+  var GUID = bmsvc.getItemGUID(itemId);</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineplus">+  aTxn.undoTransaction();</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineplus">+  aTxn.redoTransaction();</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineplus">+  do_check_eq(GUID, bmsvc.getItemGUID(itemId));</span>
<a href="#l50.58"></a><span id="l50.58" class="difflineplus">+  aTxn.undoTransaction();</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineplus">+}</span>
<a href="#l50.60"></a><span id="l50.60" class="difflineplus">+</span>
<a href="#l50.61"></a><span id="l50.61" class="difflineplus">+function run_test() {</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineplus">+  // Create folder.</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineplus">+  var createFolderTxn = txnsvc.createFolder(&quot;Test folder&quot;,</span>
<a href="#l50.64"></a><span id="l50.64" class="difflineplus">+                                            bmsvc.unfiledBookmarksFolder,</span>
<a href="#l50.65"></a><span id="l50.65" class="difflineplus">+                                            bmsvc.DEFAULT_INDEX);</span>
<a href="#l50.66"></a><span id="l50.66" class="difflineplus">+  test_GUID_persistance(createFolderTxn);</span>
<a href="#l50.67"></a><span id="l50.67" class="difflineplus">+</span>
<a href="#l50.68"></a><span id="l50.68" class="difflineplus">+  // Create bookmark.</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineplus">+  var createBookmarkTxn = txnsvc.createItem(uri(&quot;http://www.example.com&quot;),</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineplus">+                                            bmsvc.unfiledBookmarksFolder,</span>
<a href="#l50.71"></a><span id="l50.71" class="difflineplus">+                                            bmsvc.DEFAULT_INDEX,</span>
<a href="#l50.72"></a><span id="l50.72" class="difflineplus">+                                            &quot;Test bookmark&quot;);</span>
<a href="#l50.73"></a><span id="l50.73" class="difflineplus">+  test_GUID_persistance(createBookmarkTxn);</span>
<a href="#l50.74"></a><span id="l50.74" class="difflineplus">+</span>
<a href="#l50.75"></a><span id="l50.75" class="difflineplus">+  // Create separator.</span>
<a href="#l50.76"></a><span id="l50.76" class="difflineplus">+  var createSeparatorTxn = txnsvc.createSeparator(bmsvc.unfiledBookmarksFolder,</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineplus">+                                                  bmsvc.DEFAULT_INDEX);</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineplus">+  test_GUID_persistance(createFolderTxn);</span>
<a href="#l50.79"></a><span id="l50.79" class="difflineplus">+</span>
<a href="#l50.80"></a><span id="l50.80" class="difflineplus">+  // Create livemark.</span>
<a href="#l50.81"></a><span id="l50.81" class="difflineplus">+  var createLivemarkTxn = txnsvc.createLivemark(uri(&quot;http://feeduri.com&quot;),</span>
<a href="#l50.82"></a><span id="l50.82" class="difflineplus">+                                               uri(&quot;http://siteuri.com&quot;),</span>
<a href="#l50.83"></a><span id="l50.83" class="difflineplus">+                                               &quot;Test livemark&quot;,</span>
<a href="#l50.84"></a><span id="l50.84" class="difflineplus">+                                               bmsvc.unfiledBookmarksFolder,</span>
<a href="#l50.85"></a><span id="l50.85" class="difflineplus">+                                               bmsvc.DEFAULT_INDEX);</span>
<a href="#l50.86"></a><span id="l50.86" class="difflineplus">+  test_GUID_persistance(createLivemarkTxn);</span>
<a href="#l50.87"></a><span id="l50.87" class="difflineplus">+</span>
<a href="#l50.88"></a><span id="l50.88" class="difflineplus">+  // Tag URI.</span>
<a href="#l50.89"></a><span id="l50.89" class="difflineplus">+  var tagURITxn = txnsvc.tagURI(uri(&quot;http://www.example.com&quot;), [&quot;foo&quot;]);</span>
<a href="#l50.90"></a><span id="l50.90" class="difflineplus">+  test_GUID_persistance(tagURITxn);</span>
<a href="#l50.91"></a><span id="l50.91" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/suite/common/places/tree.xml</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/suite/common/places/tree.xml</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -321,18 +321,19 @@</span>
<a href="#l51.4"></a><span id="l51.4"> </span>
<a href="#l51.5"></a><span id="l51.5">           let selection = this.view.selection;</span>
<a href="#l51.6"></a><span id="l51.6">           let rc = selection.getRangeCount();</span>
<a href="#l51.7"></a><span id="l51.7">           let resultview = this.view;</span>
<a href="#l51.8"></a><span id="l51.8">           for (let i = 0; i &lt; rc; ++i) {</span>
<a href="#l51.9"></a><span id="l51.9">             let min = { }, max = { };</span>
<a href="#l51.10"></a><span id="l51.10">             selection.getRangeAt(i, min, max);</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-            for (let j = min.value; j &lt;= max.value; ++j)</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineminus">-              nodes.push(resultview.nodeForTreeIndex(j));</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineplus">+            if (max.value &gt; -1)</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineplus">+              for (let j = min.value; j &lt;= max.value; ++j)</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+                nodes.push(resultview.nodeForTreeIndex(j));</span>
<a href="#l51.17"></a><span id="l51.17">           }</span>
<a href="#l51.18"></a><span id="l51.18">           return nodes;</span>
<a href="#l51.19"></a><span id="l51.19">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l51.20"></a><span id="l51.20">       &lt;/property&gt;</span>
<a href="#l51.21"></a><span id="l51.21"> </span>
<a href="#l51.22"></a><span id="l51.22">       &lt;!-- nsIPlacesView --&gt;</span>
<a href="#l51.23"></a><span id="l51.23">       &lt;property name=&quot;removableSelectionRanges&quot;&gt;</span>
<a href="#l51.24"></a><span id="l51.24">         &lt;getter&gt;&lt;![CDATA[</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

