<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3728:0e087e0955852702b10e9b437833c2cd61996c7e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 0e087e0955852702b10e9b437833c2cd61996c7e" />
<meta property="og:url" content="/comm-central/rev/0e087e0955852702b10e9b437833c2cd61996c7e" />
<meta property="og:description" content="Bug 474711, Bug 494962.  Land add-protovis, add-jquery, and gloda-facet branches by merge. a=blocking-thunderbird3." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 0e087e0955852702b10e9b437833c2cd61996c7e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/0e087e0955852702b10e9b437833c2cd61996c7e">shortlog</a> |
<a href="/comm-central/log/0e087e0955852702b10e9b437833c2cd61996c7e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/0e087e0955852702b10e9b437833c2cd61996c7e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/0e087e0955852702b10e9b437833c2cd61996c7e">files</a> |
changeset |
<a href="/comm-central/raw-rev/0e087e0955852702b10e9b437833c2cd61996c7e">raw</a>  | <a href="/comm-central/archive/0e087e0955852702b10e9b437833c2cd61996c7e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=474711">Bug 474711</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=494962">Bug 494962</a>.  Land add-protovis, add-jquery, and gloda-facet branches by merge. a=blocking-thunderbird3.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 09 Sep 2009 18:12:00 -0700</td></tr>

<tr>
 <td>changeset 3728</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/0e087e0955852702b10e9b437833c2cd61996c7e">0e087e0955852702b10e9b437833c2cd61996c7e</a></td>
</tr>



<tr>
<td>parent 3613</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8931dc00216426154eaac28708ab54752175a85c">8931dc00216426154eaac28708ab54752175a85c</a> (current diff)
</td>
</tr>
<tr>
<td>parent 3727</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/442b5ddeb70a1bc9eaad5dee83f3ed0d1296a5cd">442b5ddeb70a1bc9eaad5dee83f3ed0d1296a5cd</a> (<a href="/comm-central/rev/442b5ddeb70a1bc9eaad5dee83f3ed0d1296a5cd:0e087e095585">diff</a>)
</td>
</tr>

<tr>
<td>child 3732</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0b161ed73eb66538ade852cb5a4b9b1b2c319a33">0b161ed73eb66538ade852cb5a4b9b1b2c319a33</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=0e087e0955852702b10e9b437833c2cd61996c7e">2927</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Thu, 10 Sep 2009 01:15:56 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0b161ed73eb6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28blocking-thunderbird3%29&revcount=50">blocking-thunderbird3</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=474711">474711</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=494962">494962</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=474711">Bug 474711</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=494962">Bug 494962</a>.  Land add-protovis, add-jquery, and gloda-facet branches by merge. a=blocking-thunderbird3.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0e087e0955852702b10e9b437833c2cd61996c7e/.hgpatchinfo/add-jquery.dep">.hgpatchinfo/add-jquery.dep</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/0e087e0955852702b10e9b437833c2cd61996c7e/.hgpatchinfo/add-jquery.dep">diff</a> |
<a href="/comm-central/comparison/0e087e0955852702b10e9b437833c2cd61996c7e/.hgpatchinfo/add-jquery.dep">comparison</a> |
<a href="/comm-central/log/0e087e0955852702b10e9b437833c2cd61996c7e/.hgpatchinfo/add-jquery.dep">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0e087e0955852702b10e9b437833c2cd61996c7e/.hgpatchinfo/add-protovis.dep">.hgpatchinfo/add-protovis.dep</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/0e087e0955852702b10e9b437833c2cd61996c7e/.hgpatchinfo/add-protovis.dep">diff</a> |
<a href="/comm-central/comparison/0e087e0955852702b10e9b437833c2cd61996c7e/.hgpatchinfo/add-protovis.dep">comparison</a> |
<a href="/comm-central/log/0e087e0955852702b10e9b437833c2cd61996c7e/.hgpatchinfo/add-protovis.dep">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0e087e0955852702b10e9b437833c2cd61996c7e/.hgpatchinfo/gloda-facet.dep">.hgpatchinfo/gloda-facet.dep</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/0e087e0955852702b10e9b437833c2cd61996c7e/.hgpatchinfo/gloda-facet.dep">diff</a> |
<a href="/comm-central/comparison/0e087e0955852702b10e9b437833c2cd61996c7e/.hgpatchinfo/gloda-facet.dep">comparison</a> |
<a href="/comm-central/log/0e087e0955852702b10e9b437833c2cd61996c7e/.hgpatchinfo/gloda-facet.dep">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -38,17 +38,17 @@</span>
<a href="#l1.4"></a><span id="l1.4"> DEPTH		= ..</span>
<a href="#l1.5"></a><span id="l1.5"> topsrcdir	= @top_srcdir@</span>
<a href="#l1.6"></a><span id="l1.6"> srcdir		= @srcdir@</span>
<a href="#l1.7"></a><span id="l1.7"> VPATH		= @srcdir@</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> include $(topsrcdir)/config/config.mk</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> # app is always last as it packages up the built files on mac</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-DIRS		= base locales components extensions steel themes app</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+DIRS		= base locales components extensions steel themes jquery app</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> ifeq ($(OS_ARCH),WINNT)</span>
<a href="#l1.16"></a><span id="l1.16"> ifdef MOZ_INSTALLER</span>
<a href="#l1.17"></a><span id="l1.17"> # though some lasts are more last than others</span>
<a href="#l1.18"></a><span id="l1.18"> DIRS += installer/windows</span>
<a href="#l1.19"></a><span id="l1.19"> endif</span>
<a href="#l1.20"></a><span id="l1.20"> endif</span>
<a href="#l1.21"></a><span id="l1.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/extraCustomizeItems.xul</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/extraCustomizeItems.xul</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -47,98 +47,40 @@</span>
<a href="#l2.4"></a><span id="l2.4">   &lt;!ENTITY % msgViewPickerDTD SYSTEM &quot;chrome://messenger/locale/msgViewPickerOverlay.dtd&quot; &gt;</span>
<a href="#l2.5"></a><span id="l2.5">   %msgViewPickerDTD;</span>
<a href="#l2.6"></a><span id="l2.6">   &lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot;&gt;</span>
<a href="#l2.7"></a><span id="l2.7">   %brandDTD;</span>
<a href="#l2.8"></a><span id="l2.8"> ]&gt;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> &lt;overlay xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  &lt;popupset&gt;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    &lt;panel type=&quot;glodacomplete-richlistbox&quot; chromedir=&quot;ltr&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+           id=&quot;PopupGlodaAutocomplete&quot; noautofocus=&quot;true&quot; /&gt;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  &lt;/popupset&gt;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+</span>
<a href="#l2.17"></a><span id="l2.17">   &lt;toolbarpalette id=&quot;MailToolbarPalette&quot;&gt;</span>
<a href="#l2.18"></a><span id="l2.18">     &lt;!-- gloda search widget; provides global (message) searching.  --&gt;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-    &lt;toolbaritem id=&quot;gloda-search&quot; insertafter=&quot;search-container&quot;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    &lt;toolbaritem id=&quot;gloda-search&quot; insertafter=&quot;button-stop&quot;</span>
<a href="#l2.21"></a><span id="l2.21">                  title=&quot;&amp;glodaSearch.title;&quot;</span>
<a href="#l2.22"></a><span id="l2.22">                  align=&quot;center&quot;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+                 flex=&quot;1&quot;</span>
<a href="#l2.24"></a><span id="l2.24">                  class=&quot;chromeclass-toolbar-additional&quot;&gt;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-      &lt;textbox id=&quot;glodaSearchInput&quot; flex=&quot;1&quot; type=&quot;search&quot;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-               searchbutton=&quot;true&quot;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-               emptytext=&quot;&amp;glodaSearchBar.emptyText;&quot;/&gt;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+        &lt;textbox id=&quot;searchInput&quot; </span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+                 chromedir=&quot;ltr&quot;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+                 flex=&quot;1&quot;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+                 searchCriteria=&quot;true&quot;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+                 type=&quot;glodacomplete&quot;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+                 searchbutton=&quot;true&quot;</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+                 autocompletesearch=&quot;gloda&quot;</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+                 autocompletepopup=&quot;PopupGlodaAutocomplete&quot;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+                 &gt;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+        &lt;/textbox&gt;</span>
<a href="#l2.38"></a><span id="l2.38">     &lt;/toolbaritem&gt;</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-    &lt;toolbaritem id=&quot;search-container&quot; insertafter=&quot;button-stop&quot;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-                 title=&quot;&amp;searchItem.title;&quot;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-                 align=&quot;center&quot;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-                 class=&quot;chromeclass-toolbar-additional&quot;&gt;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-      &lt;textbox id=&quot;searchInput&quot; timeout=&quot;800&quot; flex=&quot;1&quot;</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-               onfocus=&quot;onSearchInputFocus(event);&quot;</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-               onclick=&quot;onSearchInputClick(event);&quot;</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-               onmousedown=&quot;onSearchInputMousedown(event);&quot;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-               onblur=&quot;onSearchInputBlur(event);&quot;</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-               oncommand=&quot;onEnterInSearchBar();&quot;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-               onkeypress=&quot;onSearchKeyPress();&quot;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-               chromedir=&quot;&amp;locale.dir;&quot;&gt;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-        &lt;button id=&quot;quick-search-button&quot; type=&quot;menu&quot; chromedir=&quot;&amp;locale.dir;&quot;&gt;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-          &lt;menupopup id=&quot;quick-search-menupopup&quot;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-                     value=&quot;2&quot;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-                     persist=&quot;value&quot;</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-                     onpopupshowing=&quot;InitQuickSearchPopup();&quot;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-                     popupalign=&quot;topleft&quot;</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-                     popupanchor=&quot;bottomleft&quot;&gt;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-            &lt;!-- The sequence of menu items must have a contiguous strictly</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-                 increasing sequence of ordinals starting at 0 (see the</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-                 VK_UP/VK_DOWN key handlers in search.xml) --&gt;</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-            &lt;menuitem id=&quot;searchSubjectMenu&quot;</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-                      value=&quot;0&quot;</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-                      ordinal=&quot;0&quot;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-                      label=&quot;&amp;searchSubjectMenu.label;&quot;</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-                      type=&quot;radio&quot;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-                      oncommand=&quot;changeQuickSearchMode(this)&quot;/&gt;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-            &lt;menuitem id=&quot;searchFromMenu&quot;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-                      value=&quot;1&quot;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-                      ordinal=&quot;1&quot;</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-                      label=&quot;&amp;searchFromMenu.label;&quot;</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-                      type=&quot;radio&quot;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-                      oncommand=&quot;changeQuickSearchMode(this)&quot; /&gt;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-            &lt;menuitem id=&quot;searchSubjectOrFromMenu&quot;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-                      value=&quot;2&quot;</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-                      ordinal=&quot;2&quot;</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-                      label=&quot;&amp;searchSubjectOrFromMenu.label;&quot;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-                      type=&quot;radio&quot;</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-                      oncommand=&quot;changeQuickSearchMode(this)&quot;/&gt;</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-            &lt;menuitem id=&quot;searchRecipient&quot;</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-                      value=&quot;5&quot;</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-                      ordinal=&quot;3&quot;</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-                      label=&quot;&amp;searchRecipient.label;&quot;</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-                      type=&quot;radio&quot;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-                      oncommand=&quot;changeQuickSearchMode(this)&quot;/&gt;</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-            &lt;menuitem id=&quot;searchSubjectOrRecipient&quot;</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-                      value=&quot;6&quot;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-                      ordinal=&quot;4&quot;</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-                      label=&quot;&amp;searchSubjectOrRecipientMenu.label;&quot;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-                      type=&quot;radio&quot;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-                      oncommand=&quot;changeQuickSearchMode(this)&quot;/&gt;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-            &lt;menuitem id=&quot;searchMessageBody&quot;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-                      value=&quot;3&quot;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-                      ordinal=&quot;5&quot;</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-                      label=&quot;&amp;searchMessageBody.label;&quot;</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-                      type=&quot;radio&quot;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-                      oncommand=&quot;changeQuickSearchMode(this)&quot;/&gt;</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-            &lt;!-- The ordinal of that separator must be the biggest ordinal of a</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-                 valid quicksearch option, plus one (see the VK_UP / VK_DOWN key</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-                 handlers in search.xml). --&gt;</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-            &lt;menuseparator id=&quot;quickSearchAfterLastOptionSeparator&quot;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-                           ordinal=&quot;6&quot;/&gt;</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-            &lt;menuitem id=&quot;quickSearchSaveAsVirtualFolder&quot;</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-                      ordinal=&quot;99&quot;</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-                      label=&quot;&amp;saveAsVirtualFolderMenu.label;&quot;</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-                      oncommand=&quot;saveViewAsVirtualFolder()&quot;/&gt;</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-          &lt;/menupopup&gt;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-        &lt;/button&gt;</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-      &lt;/textbox&gt;</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-    &lt;/toolbaritem&gt;</span>
<a href="#l2.111"></a><span id="l2.111">     &lt;toolbarbutton id=&quot;button-compact&quot; class=&quot;toolbarbutton-1&quot;</span>
<a href="#l2.112"></a><span id="l2.112">                    insertafter=&quot;button-mark&quot;</span>
<a href="#l2.113"></a><span id="l2.113">                    label=&quot;&amp;compactButton.label;&quot;</span>
<a href="#l2.114"></a><span id="l2.114">                    tooltiptext=&quot;&amp;compactButton.tooltip;&quot;</span>
<a href="#l2.115"></a><span id="l2.115">                    oncommand=&quot;goDoCommand('button_compact');&quot;</span>
<a href="#l2.116"></a><span id="l2.116">                    observes=&quot;button_compact&quot;/&gt;</span>
<a href="#l2.117"></a><span id="l2.117">     &lt;toolbaritem id=&quot;folder-location-container&quot; insert-after=&quot;button-stop&quot;</span>
<a href="#l2.118"></a><span id="l2.118">                  title=&quot;&amp;folderLocationToolbarItem.title;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -778,22 +778,22 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">   /**</span>
<a href="#l3.5"></a><span id="l3.5">    * The view wrapper tells us when a search is active, and we mark the tab as</span>
<a href="#l3.6"></a><span id="l3.6">    *  thinking so the user knows something is happening.  'Searching' in this</span>
<a href="#l3.7"></a><span id="l3.7">    *  case is more than just a user-initiated search.  Virtual folders / saved</span>
<a href="#l3.8"></a><span id="l3.8">    *  searches, mail views, plus the more obvious quick search are all based off</span>
<a href="#l3.9"></a><span id="l3.9">    *  of searches and we will receive a notification for them.</span>
<a href="#l3.10"></a><span id="l3.10">    */</span>
<a href="#l3.11"></a><span id="l3.11">   onSearching: function(aIsSearching) {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    // getDocumentElements() sets gSearchBundle</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    getDocumentElements();</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    if (this._tabInfo)</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    if (this._tabInfo) {</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+      let searchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l3.17"></a><span id="l3.17">       document.getElementById(&quot;tabmail&quot;).setTabThinking(</span>
<a href="#l3.18"></a><span id="l3.18">         this._tabInfo,</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-        aIsSearching &amp;&amp; gSearchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+        aIsSearching &amp;&amp; searchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    }</span>
<a href="#l3.22"></a><span id="l3.22">   },</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">   /**</span>
<a href="#l3.25"></a><span id="l3.25">    * Things we do on creating a view:</span>
<a href="#l3.26"></a><span id="l3.26">    * - notify the observer service so that custom column handler providers can</span>
<a href="#l3.27"></a><span id="l3.27">    *   add their custom columns to our view.</span>
<a href="#l3.28"></a><span id="l3.28">    */</span>
<a href="#l3.29"></a><span id="l3.29">   onCreatedView: function FolderDisplayWidget_onCreatedView() {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineat">@@ -887,20 +887,20 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l3.31"></a><span id="l3.31">     // makeActive will restore the folder state</span>
<a href="#l3.32"></a><span id="l3.32">     if (!this._savedColumnStates) {</span>
<a href="#l3.33"></a><span id="l3.33">       // get the default for this folder</span>
<a href="#l3.34"></a><span id="l3.34">       this._savedColumnStates = this._getDefaultColumnsForCurrentFolder();</span>
<a href="#l3.35"></a><span id="l3.35">       // and save it so it doesn't wiggle if the inbox/prototype changes</span>
<a href="#l3.36"></a><span id="l3.36">       this._persistColumnStates(this._savedColumnStates);</span>
<a href="#l3.37"></a><span id="l3.37">     }</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-    // the quick-search gets nuked when we show a new folder</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-    ClearQSIfNecessary();</span>
<a href="#l3.41"></a><span id="l3.41">     // update the quick-search relative to whether it's incoming/outgoing</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-    onSearchFolderTypeChanged(this.view.isOutgoingFolder);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+    let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+    if (searchInput)</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+      searchInput.folderChanged(this.view.isOutgoingFolder)</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">     if (this.active)</span>
<a href="#l3.48"></a><span id="l3.48">       this.makeActive();</span>
<a href="#l3.49"></a><span id="l3.49">   },</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51">   /**</span>
<a href="#l3.52"></a><span id="l3.52">    * Notification from DBViewWrapper that it is closing the folder.  This can</span>
<a href="#l3.53"></a><span id="l3.53">    *  happen for reasons other than our own 'close' method closing the view.</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineat">@@ -1446,30 +1446,16 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l3.55"></a><span id="l3.55">             fakeTreeSelection.duplicateSelection(this.view.dbView.selection);</span>
<a href="#l3.56"></a><span id="l3.56">             // Since duplicateSelection will fire a selectionChanged event,</span>
<a href="#l3.57"></a><span id="l3.57">             // which will try to reload the message, we shouldn't do the same.</span>
<a href="#l3.58"></a><span id="l3.58">             dontReloadMessage = true;</span>
<a href="#l3.59"></a><span id="l3.59">           }</span>
<a href="#l3.60"></a><span id="l3.60">           if (this._savedFirstVisibleRow != null)</span>
<a href="#l3.61"></a><span id="l3.61">             this.treeBox.scrollToRow(this._savedFirstVisibleRow);</span>
<a href="#l3.62"></a><span id="l3.62">         }</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-        // restore the quick search widget</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-        let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-        if (searchInput &amp;&amp; this._savedQuickSearch) {</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-          searchInput.searchMode = this._savedQuickSearch.searchMode;</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-          if (this._savedQuickSearch.text) {</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-            searchInput.value = this._savedQuickSearch.text;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-            searchInput.showingSearchCriteria = false;</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-            searchInput.clearButtonHidden = false;</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-          }</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-          else {</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-            searchInput.setSearchCriteriaText();</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-          }</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-        }</span>
<a href="#l3.77"></a><span id="l3.77">       }</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79">       // Always restore the column state if we have persisted state.  We restore</span>
<a href="#l3.80"></a><span id="l3.80">       //  state on folder entry, in which case we were probably not inactive.</span>
<a href="#l3.81"></a><span id="l3.81">       this._restoreColumnStates();</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83">       // the tab mode knows whether we are folder or message display, which</span>
<a href="#l3.84"></a><span id="l3.84">       //  impacts the legal modes</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineat">@@ -1539,25 +1525,16 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l3.86"></a><span id="l3.86">     if (this.view.dbView) {</span>
<a href="#l3.87"></a><span id="l3.87">       if (this.treeBox)</span>
<a href="#l3.88"></a><span id="l3.88">         this._savedFirstVisibleRow = this.treeBox.getFirstVisibleRow();</span>
<a href="#l3.89"></a><span id="l3.89"> </span>
<a href="#l3.90"></a><span id="l3.90">       // save the message pane's state only when it is potentially visible</span>
<a href="#l3.91"></a><span id="l3.91">       this.messagePaneCollapsed =</span>
<a href="#l3.92"></a><span id="l3.92">         document.getElementById(&quot;messagepanebox&quot;).collapsed;</span>
<a href="#l3.93"></a><span id="l3.93"> </span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-      // save the actual quick-search query text</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-      let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-      if (searchInput) {</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-        this._savedQuickSearch = {</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-          text: searchInput.showingSearchCriteria ? null : searchInput.value,</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-          searchMode: searchInput.searchMode</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-        };</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-      }</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-</span>
<a href="#l3.103"></a><span id="l3.103">       this.hookUpFakeTreeBox(true);</span>
<a href="#l3.104"></a><span id="l3.104">     }</span>
<a href="#l3.105"></a><span id="l3.105"> </span>
<a href="#l3.106"></a><span id="l3.106">     this.messageDisplay.makeInactive();</span>
<a href="#l3.107"></a><span id="l3.107">   },</span>
<a href="#l3.108"></a><span id="l3.108">   //@}</span>
<a href="#l3.109"></a><span id="l3.109"> </span>
<a href="#l3.110"></a><span id="l3.110">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/base/content/glodaFacetBindings.css</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,31 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+#query-explanation {</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#query-explanation');</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+}</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+.facets {</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#facets');</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+}</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+.facetious[type=&quot;discrete&quot;] {</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#facet-discrete');</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+}</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+.facetious[type=&quot;boolean&quot;] {</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#facet-boolean');</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+}</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+.facetious[type=&quot;boolean-filtered&quot;] {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#facet-boolean-filtered');</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+}</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+.facetious[type=&quot;date&quot;] {</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#facet-date');</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+}</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+.results[type=&quot;message&quot;] {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#results-message');</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+}</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+.message {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#result-message');</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mail/base/content/glodaFacetBindings.xml</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,1357 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+  - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+  -</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+  - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+  - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  - the License. You may obtain a copy of the License at</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  - http://www.mozilla.org/MPL/</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  -</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+  - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  - for the specific language governing rights and limitations under the</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+  - License.</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  -</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  - The Original Code is Thunderbird Global Database.</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  -</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+  - The Initial Developer of the Original Code is</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+  - Mozilla Messaging, Inc.</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+  - Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  - the Initial Developer. All Rights Reserved.</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+  -</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  - Contributor(s):</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+  -   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  -   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+  -   Bryan Clark &lt;clarkbw@gnome.org&gt;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  -</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  - either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  - or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  - the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+  - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+  - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+&lt;bindings id=&quot;glodaFacetBindings&quot;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+          xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+          xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+          xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+          xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+          xmlns:svg=&quot;http://www.w3.org/2000/svg&quot;&gt;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+&lt;!-- ===== Constraints ===== --&gt;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+&lt;binding id=&quot;query-explanation&quot;&gt;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+    &lt;!-- Indicate that we are based on a fulltext search--&gt;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+    &lt;method name=&quot;setFulltext&quot;&gt;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+      &lt;parameter name=&quot;aMsgSearcher&quot; /&gt;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+        while (this.lastChild)</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+          this.removeChild(this.lastChild);</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+        let dis = this;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+        function spanify(aText, aClass) {</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+          let span = document.createElement(&quot;span&quot;);</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+          span.setAttribute(&quot;class&quot;, aClass);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+          span.textContent = aText;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+          dis.appendChild(span);</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+          return span;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+        }</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+        let labelFormat = glodaFacetStrings.get(</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+          &quot;glodaFacetView.constraints.query.fulltext.label&quot;);</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+        let [labelPre, labelPost] = labelFormat.split(&quot;#1&quot;);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+        // trim both; we rely on CSS to handle the spacing</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+        labelPre = labelPre.trim();</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+        labelPost = labelPost.trim();</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+        if (labelPre)</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+          spanify(labelPre, &quot;explanation-fulltext-label&quot;);</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+        let criteriaText = glodaFacetStrings.get(</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+          &quot;glodaFacetView.constraints.query.fulltext.&quot; +</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+          (aMsgSearcher.andTerms ? &quot;and&quot; : &quot;or&quot;) + &quot;JoinWord&quot;);</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+        for each (let [iTerm, term] in Iterator(aMsgSearcher.fulltextTerms)) {</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+          if (iTerm)</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+            spanify(criteriaText, &quot;explanation-fulltext-criteria&quot;);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+          spanify(term, &quot;explanation-fulltext-term&quot;);</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+        }</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+        if (labelPost)</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+          spanify(labelPost, &quot;explanation-fulltext-label&quot;);</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+        if (aMsgSearcher.fulltextTerms.length &gt; 1) {</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+          spanify(</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+            glodaFacetStrings.get(&quot;glodaFacetView.constraints.query.fulltext.&quot; +</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+              (aMsgSearcher.andTerms ? &quot;changeToOrLabel&quot; : &quot;changeToAndLabel&quot;)),</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+            &quot;explanation-change-label&quot;)</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+          .onclick = function() {</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+            FacetContext.toggleFulltextCriteria();</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+          };</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+        }</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+    &lt;method name=&quot;setQuery&quot;&gt;</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+      &lt;parameter name=&quot;aMsgQuery&quot; /&gt;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+      try {</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+        while (this.lastChild)</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+          this.removeChild(this.lastChild);</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+        let dis = this;</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+        function spanify(aText, aClass) {</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+          let span = document.createElement(&quot;span&quot;);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+          span.setAttribute(&quot;class&quot;, aClass);</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+          span.textContent = aText;</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+          dis.appendChild(span);</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+          return span;</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+        }</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+        let label = glodaFacetStrings.get(</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+          &quot;glodaFacetView.constraints.query.initial&quot;);</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+        spanify(label, &quot;explanation-query-label&quot;);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+        let constraintStrings = [];</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+        for each (let constraint in aMsgQuery._constraints) {</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+          if (constraint[0] != 1) return; // no idea what this is about</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+          if (constraint[1].attributeName == 'involves') {</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+            let involvesLabel = glodaFacetStrings.get(</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+              &quot;glodaFacetView.constraints.query.involves.label&quot;);</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+            involvesLabel = involvesLabel.replace(&quot;#1&quot;, constraint[2].value)</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+            spanify(involvesLabel, &quot;explanation-query-involves&quot;);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+          } else if (constraint[1].attributeName == 'tag') {</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+            let tagLabel = glodaFacetStrings.get(</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+              &quot;glodaFacetView.constraints.query.tagged.label&quot;);</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+            let tag = constraint[2];</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+            let _msgTagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;].</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+                                      getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+            let tagNode = document.createElement(&quot;span&quot;);</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+            let colorClass = &quot;blc-&quot; + _msgTagService.getColorForKey(tag.key).substr(1);</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+            tagNode.setAttribute(&quot;class&quot;, &quot;message-tag tag &quot; + colorClass);</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+            tagNode.textContent = tag.tag;</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+            spanify(tagLabel, &quot;explanation-query-tagged&quot;);</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+            this.appendChild(tagNode);</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+          }</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+        }</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+        label = label + constraintStrings.join(', '); // XXX l10n?</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+      } catch (e) {</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+        logException(e);</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+      }</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+&lt;!-- ===== Facets ===== --&gt;</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+&lt;binding id=&quot;facets&quot;&gt;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+    &lt;method name=&quot;clearFacets&quot;&gt;</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+        while (this.lastChild != null)</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+          this.removeChild(this.lastChild);</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+    &lt;method name=&quot;addFacet&quot;&gt;</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+      &lt;parameter name=&quot;aType&quot; /&gt;</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+      &lt;parameter name=&quot;aAttrDef&quot; /&gt;</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+      &lt;parameter name=&quot;aArgs&quot; /&gt;</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+        let facets = this;</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+        let facet = document.createElement(&quot;div&quot;);</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+        facet.attrDef = aAttrDef;</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+        facet.nounDef = aAttrDef.objectNounDef;</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+        for each (let [key, value] in Iterator(aArgs)) {</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+          facet[key] = value;</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+        }</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+        facet.setAttribute(&quot;class&quot;, &quot;facetious&quot;);</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+        facet.setAttribute(&quot;type&quot;, aType);</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+        facet.setAttribute(&quot;name&quot;, aAttrDef.attributeName);</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+        facets.appendChild(facet);</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+        return facet;</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+&lt;binding id=&quot;facet-base&quot;&gt;</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+    &lt;method name=&quot;brushItems&quot;&gt;</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+    &lt;method name=&quot;clearBrushedItems&quot;&gt;</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+&lt;!--</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+  - A boolean facet; we presume orderedGroups contains at most two entries, and</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+  -  that their group values consist of true or false.</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+  -</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+  - The implication of this UI is that you only want to filter to true values</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+  -  and would never want to filter out the false values.  Consistent with this</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+  -  assumption we disable the UI if there are no true values.</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+  -</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+  - This depressingly</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+  --&gt;</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+&lt;binding id=&quot;facet-boolean&quot;</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+         extends=&quot;chrome://messenger/content/glodaFacetBindings.xml#facet-base&quot;&gt;</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+    &lt;html:span anonid=&quot;bubble&quot; class=&quot;facet-checkbox-bubble&quot;&gt;</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+      &lt;html:input anonid=&quot;checkbox&quot; type=&quot;checkbox&quot; /&gt;</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+      &lt;html:span anonid=&quot;label&quot; class=&quot;facet-checkbox-label&quot; /&gt;</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+      &lt;html:span anonid=&quot;count&quot; class=&quot;facet-checkbox-count&quot; /&gt;</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+    &lt;/html:span&gt;</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+    &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+      this.bubble = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+                                                            &quot;bubble&quot;);</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+      this.checkbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+                                                              &quot;checkbox&quot;);</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+      this.labelNode = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+                                                               &quot;label&quot;);</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+      this.countNode = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+                                                               &quot;count&quot;);</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+      let dis = this;</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+      this.bubble.addEventListener(&quot;click&quot;, function (event) {</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+        return dis.bubbleClicked(event);</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+      }, true);</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+      this.extraSetup();</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+      if (&quot;faceter&quot; in this)</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+        this.build(true);</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+    ]]&gt;&lt;/constructor&gt;</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+    &lt;field name=&quot;canUpdate&quot; readonly=&quot;true&quot;&gt;true&lt;/field&gt;</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+    &lt;property name=&quot;disabled&quot;&gt;</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+      &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+        return this.getAttribute(&quot;disabled&quot;) == &quot;true&quot;;</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+      ]]&gt;&lt;/getter&gt;</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+      &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+        if (val) {</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+          this.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+          this.checkbox.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+        }</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+        else {</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+          this.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+          this.checkbox.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+        }</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+      ]]&gt;&lt;/setter&gt;</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+    &lt;/property&gt;</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+    &lt;property name=&quot;checked&quot;&gt;</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+      &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+        return this.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+      ]]&gt;&lt;/getter&gt;</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+      &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+        if (this.checked == val)</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+          return;</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+        this.checkbox.checked = val;</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+        if (val) {</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+          // the XBL inherits magic appears to fail if we explicitly check the</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+          //  box itself rather than via our click handler, presumably because</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+          //  we unshadow something.  So manually apply changes ourselves.</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+          this.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+          this.checkbox.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+          if (!this.disabled)</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+            FacetContext.addFacetConstraint(this.faceter, true,</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+                                            this.trueGroups);</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+        }</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+        else {</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+          this.removeAttribute(&quot;checked&quot;);</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+          this.checkbox.removeAttribute(&quot;checked&quot;);</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+          if (!this.disabled)</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+            FacetContext.removeFacetConstraint(this.faceter, true,</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+                                               this.trueGroups);</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+        }</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+        this.checkStateChanged();</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+      ]]&gt;&lt;/setter&gt;</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+    &lt;/property&gt;</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+    &lt;method name=&quot;extraSetup&quot;&gt;</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+    &lt;method name=&quot;checkStateChanged&quot;&gt;</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+    &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+      &lt;parameter name=&quot;aFirstTime&quot; /&gt;</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+        if (aFirstTime) {</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+          this.labelNode.textContent = this.attrDef.strings.facetLabel;</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+          this.checkbox.setAttribute(&quot;aria-label&quot;,</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+                                     this.attrDef.strings.facetLabel);</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+        }</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+        // If we do not currently have a constraint applied and there is only</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+        //  one (or no) group, then: disable us, but reflect the underlying</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+        //  state of the data (checked or non-checked)</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+        if (!this.faceter.constraint &amp;&amp; (this.orderedGroups.length &lt;= 1)){</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+          this.disabled = true;</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+          let count = 0;</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+          if (this.orderedGroups.length) {</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+            // true case?</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+            if (this.orderedGroups[0][0]) {</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+              count = this.orderedGroups[0][1].length;</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+              this.checked = true;</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+            }</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+            else {</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+              this.checked = false;</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+            }</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+          }</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+          this.countNode.textContent = count.toLocaleString();</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+          return;</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+        }</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+        // if we were disabled checked before, clear ourselves out</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+        if (this.disabled &amp;&amp; this.checked)</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+          this.checked = false;</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+        this.disabled = false;</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+        // if we are here, we have our 2 groups, find true...</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+        // (note: it is possible to get jerked around by null values</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+        //  currently, so leave a reasonable failure case)</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+        this.trueValues = [];</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+        this.trueGroups = [true];</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+        for each (let [, groupPair] in Iterator(this.orderedGroups)) {</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+          if (groupPair[0] == true)</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+            this.trueValues = groupPair[1];</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+        }</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+        this.countNode.textContent = this.trueValues.length.toLocaleString();</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+    &lt;method name=&quot;bubbleClicked&quot;&gt;</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+      &lt;parameter name=&quot;event&quot; /&gt;</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+      if (!this.disabled)</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+        this.checked = !this.checked;</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+      event.stopPropagation();</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+  &lt;handlers&gt;</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+    &lt;handler event=&quot;mouseover&quot;&gt;&lt;![CDATA[</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+      FacetContext.hoverFacet(this.faceter, this.faceter.attrDef,</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+                              true, this.trueValues);</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+    ]]&gt;&lt;/handler&gt;</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+    &lt;handler event=&quot;mouseout&quot;&gt;&lt;![CDATA[</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+      FacetContext.unhoverFacet(this.faceter, this.faceter.attrDef,</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+                                true, this.trueValues);</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+    ]]&gt;&lt;/handler&gt;</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+  &lt;/handlers&gt;</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+&lt;!--</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+  - A check-box with filter-box front-end to a standard discrete faceter.  If</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+  -  there are no non-null values, we disable the UI.  If there are non-null</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+  -  values the checkbox is enabled and the filter is hidden.  Once you check</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+  -  the box we apply the facet and show the filtering mechanism.</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+  --&gt;</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+&lt;binding id=&quot;facet-boolean-filtered&quot;</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+         extends=&quot;chrome://messenger/content/glodaFacetBindings.xml#facet-boolean&quot;&gt;</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+    &lt;html:span anonid=&quot;bubble&quot; class=&quot;facet-checkbox-bubble&quot;&gt;</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+      &lt;html:input anonid=&quot;checkbox&quot; type=&quot;checkbox&quot;</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+                  xbl:inherits=&quot;checked,disabled&quot;/&gt;</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+      &lt;html:span anonid=&quot;label&quot; class=&quot;facet-checkbox-label&quot; /&gt;</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+      &lt;html:span anonid=&quot;count&quot; class=&quot;facet-checkbox-count&quot; /&gt;</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+    &lt;/html:span&gt;</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+    &lt;html:select anonid=&quot;filter&quot; class=&quot;facet-filter-list&quot; /&gt;</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+    &lt;method name=&quot;extraSetup&quot;&gt;</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+        this.filterNode = document.getAnonymousElementByAttribute(</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+                            this, &quot;anonid&quot;, &quot;filter&quot;);</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+        this.groupDisplayProperty = this.getAttribute(&quot;groupDisplayProperty&quot;);</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+        let dis = this;</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+        this.filterNode.addEventListener(&quot;change&quot;, function(event) {</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+          return dis.filterChanged(event);</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+        }, false);</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+        this.selectedValue = &quot;all&quot;;</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+    &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+      &lt;parameter name=&quot;aFirstTime&quot; /&gt;</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+        if (aFirstTime) {</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineplus">+          this.labelNode.textContent = this.attrDef.strings.facetLabel;</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineplus">+          this.checkbox.setAttribute(&quot;aria-label&quot;,</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+                                     this.attrDef.strings.facetLabel);</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+        }</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+        // Only update count if anything other than &quot;all&quot; is selected.</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+        //  Otherwise we lose the set of attachment types in our select box,</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+        //  and that makes us sad.  We do want to update on &quot;all&quot; though</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+        //  because other facets may further reduce the number of attachments</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+        //  we see.  (Or if this is not just being used for attachments, it</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+        //  still holds.)</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+        if (this.selectedValue != &quot;all&quot;) {</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+          let count = 0;</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+          for each (let [, groupPair] in Iterator(this.orderedGroups)) {</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+            if (groupPair[0] != null)</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+              count += groupPair[1].length;</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+          }</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineplus">+          this.countNode.textContent = count.toLocaleString();</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineplus">+          return;</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+        }</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineplus">+</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineplus">+        while (this.filterNode.lastChild)</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineplus">+          this.filterNode.removeChild(this.filterNode.lastChild);</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+        let allNode = document.createElement(&quot;option&quot;);</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineplus">+        allNode.textContent =</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineplus">+          glodaFacetStrings.get(&quot;glodaFacetView.facets.filter.&quot; +</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+                                this.attrDef.attributeName + &quot;.allLabel&quot;);</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineplus">+        allNode.setAttribute(&quot;value&quot;, &quot;all&quot;);</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+        if (this.selectedValue == &quot;all&quot;)</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineplus">+          allNode.setAttribute(&quot;selected&quot;, &quot;selected&quot;);</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+        this.filterNode.appendChild(allNode);</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineplus">+        // if we are here, we have our 2 groups, find true...</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineplus">+        // (note: it is possible to get jerked around by null values</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+        //  currently, so leave a reasonable failure case)</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+        // empty true groups is for the checkbox</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+        this.trueGroups = [];</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineplus">+        // the real true groups is the actual true values for our explicit</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineplus">+        //  filtering</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineplus">+        this.realTrueGroups = [];</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineplus">+        this.trueValues = [];</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+        this.falseValues = [];</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineplus">+        let selectNodes = [];</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineplus">+        for each (let [, groupPair] in Iterator(this.orderedGroups)) {</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+          if (groupPair[0] == null)</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineplus">+            this.falseValues.push.apply(this.falseValues, groupPair[1]);</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+          else {</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineplus">+            this.trueValues.push.apply(this.trueValues, groupPair[1]);</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineplus">+</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineplus">+            let groupValue = groupPair[0];</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineplus">+            let selNode = document.createElement(&quot;option&quot;);</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+            selNode.textContent = groupValue[this.groupDisplayProperty];</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+            selNode.setAttribute(&quot;value&quot;, this.realTrueGroups.length);</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+            if (this.selectedValue == groupValue.category)</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineplus">+              selNode.setAttribute(&quot;selected&quot;, &quot;selected&quot;);</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineplus">+            selectNodes.push(selNode);</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineplus">+</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineplus">+            this.realTrueGroups.push(groupValue);</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+          }</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineplus">+        }</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineplus">+        selectNodes.sort(function(a, b) {</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineplus">+          return a.textContent.localeCompare(b.textContent);</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineplus">+        })</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineplus">+        for each (let [, selNode] in Iterator(selectNodes)) {</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineplus">+          this.filterNode.appendChild(selNode);</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineplus">+        }</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineplus">+</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+        this.disabled = !this.trueValues.length;</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+        this.countNode.textContent = this.trueValues.length.toLocaleString();</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineplus">+    &lt;method name=&quot;checkStateChanged&quot;&gt;</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineplus">+        // if they un-check us, revert our value to all.</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineplus">+        if (!this.checked)</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineplus">+          this.selectedValue = &quot;all&quot;;</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+    &lt;method name=&quot;filterChanged&quot;&gt;</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+      &lt;parameter name=&quot;event&quot; /&gt;</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineplus">+        if (!this.checked)</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineplus">+          return;</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineplus">+        if (this.filterNode.value == &quot;all&quot;) {</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineplus">+          this.selectedValue = &quot;all&quot;;</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineplus">+          FacetContext.addFacetConstraint(this.faceter, true,</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineplus">+                                          this.trueGroups, false, true);</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+        }</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineplus">+        else {</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineplus">+          let groupValue = this.realTrueGroups[parseInt(this.filterNode.value)];</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+          this.selectedValue = groupValue.category;</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+          FacetContext.addFacetConstraint(this.faceter, true,</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+                                          [groupValue], false, true);</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineplus">+        }</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineplus">+</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineplus">+&lt;binding id=&quot;facet-discrete&quot;&gt;</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineplus">+  &lt;!-- without this explicit div here, the sibling selectors used to span</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineplus">+       included-label/included and excluded-label/excluded fail to apply.</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineplus">+       so. magic! (this is why our binding node's class is facetious. --&gt;</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineplus">+  &lt;html:div class=&quot;facet&quot;&gt;</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+    &lt;html:h2 anonid=&quot;name&quot;&gt;&lt;/html:h2&gt;</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+    &lt;html:div anonid=&quot;content-box&quot; class=&quot;facet-content&quot;&gt;</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+      &lt;html:h3 anonid=&quot;included-label&quot; class=&quot;facet-included-header&quot;&gt;&lt;/html:h3&gt;</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineplus">+      &lt;html:ul anonid=&quot;included&quot; class=&quot;facet-included barry&quot;&gt;&lt;/html:ul&gt;</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+      &lt;html:h3 anonid=&quot;excluded-label&quot; class=&quot;facet-excluded-header&quot;&gt;&lt;/html:h3&gt;</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+      &lt;html:ul anonid=&quot;excluded&quot; class=&quot;facet-excluded barry&quot;&gt;&lt;/html:ul&gt;</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+      &lt;html:h3 anonid=&quot;remainder-label&quot; class=&quot;facet-remaindered-header&quot;&gt;&lt;/html:h3&gt;</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+      &lt;html:ul anonid=&quot;remainder&quot; class=&quot;facet-remaindered barry&quot;&gt;&lt;/html:ul&gt;</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+      &lt;html:div anonid=&quot;more&quot; class=&quot;facet-more&quot; needed=&quot;false&quot; /&gt;</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+    &lt;/html:div&gt;</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+  &lt;/html:div&gt;</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineplus">+    &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineplus">+      if (&quot;faceter&quot; in this)</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineplus">+        this.build(true);</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+    ]]&gt;&lt;/constructor&gt;</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineplus">+    &lt;field name=&quot;canUpdate&quot; readonly=&quot;true&quot;&gt;false&lt;/field&gt;</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineplus">+    &lt;method name=&quot;lockSize&quot;&gt;</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineplus">+        return;</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineplus">+        if (this.style.paddingBottom != &quot;0px&quot;) {</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineplus">+          let $this = $(this);</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineplus">+          let height = ($this.height() + 60) + &quot;px&quot;;</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineplus">+          let width = $this.width() + &quot;px&quot;;</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineplus">+          this.style.minWidth = width;</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+          this.style.minHeight = height;</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineplus">+          this.style.maxWidth = width;</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+          this.style.maxHeight = height;</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineplus">+          this.style.paddingBottom = &quot;0px&quot;;</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineplus">+        }</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineplus">+    &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+      &lt;parameter name=&quot;aFirstTime&quot; /&gt;</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+        // -- Header Building</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+        let nameNode = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+                                                               &quot;name&quot;);</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+        nameNode.textContent = this.attrDef.strings.facetLabel;</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineplus">+        // - include</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+        // setup the include label</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+        this.includeLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+                           this, &quot;anonid&quot;, &quot;included-label&quot;);</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineplus">+        if (&quot;includeLabel&quot; in this.attrDef.strings)</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineplus">+          this.includeLabel.textContent = this.attrDef.strings.includeLabel;</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+        else</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+          this.includeLabel.textContent =</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineplus">+            glodaFacetStrings.get(</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineplus">+              &quot;glodaFacetView.facets.included.fallbackLabel&quot;);</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineplus">+        this.includeLabel.setAttribute(&quot;state&quot;, &quot;empty&quot;);</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineplus">+</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineplus">+        // include list ref</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineplus">+        this.includeList = document.getAnonymousElementByAttribute(</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineplus">+                                      this, &quot;anonid&quot;, &quot;included&quot;);</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+        // - exclude</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineplus">+        // setup the exclude label</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+        this.excludeLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+                                       this, &quot;anonid&quot;, &quot;excluded-label&quot;);</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineplus">+        if (&quot;excludeLabel&quot; in this.attrDef.strings)</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineplus">+          this.excludeLabel.textContent = this.attrDef.strings.excludeLabel;</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineplus">+        else</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineplus">+          this.excludeLabel.textContent =</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineplus">+            glodaFacetStrings.get(</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineplus">+              &quot;glodaFacetView.facets.excluded.fallbackLabel&quot;);</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineplus">+        this.excludeLabel.setAttribute(&quot;state&quot;, &quot;empty&quot;);</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineplus">+</span>
<a href="#l5.578"></a><span id="l5.578" class="difflineplus">+        // exclude list ref</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineplus">+        this.excludeList = document.getAnonymousElementByAttribute(</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineplus">+                                      this, &quot;anonid&quot;, &quot;excluded&quot;);</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineplus">+</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineplus">+        // - remainder</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineplus">+        // setup the remainder label</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineplus">+        this.remainderLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l5.585"></a><span id="l5.585" class="difflineplus">+                                this, &quot;anonid&quot;, &quot;remainder-label&quot;);</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineplus">+        if (&quot;remainderLabel&quot; in this.attrDef.strings)</span>
<a href="#l5.587"></a><span id="l5.587" class="difflineplus">+          this.remainderLabel.textContent = this.attrDef.strings.remainderLabel;</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineplus">+        else</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineplus">+          this.remainderLabel.textContent =</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineplus">+            glodaFacetStrings.get(</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineplus">+              &quot;glodaFacetView.facets.remainder.fallbackLabel&quot;);</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineplus">+        // remainder list ref</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineplus">+        this.remainderList = document.getAnonymousElementByAttribute(</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineplus">+                                        this, &quot;anonid&quot;, &quot;remainder&quot;);</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineplus">+</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineplus">+        // - more button</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineplus">+        this.moreButton = document.getAnonymousElementByAttribute(</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineplus">+                            this, &quot;anonid&quot;, &quot;more&quot;);</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineplus">+</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineplus">+        // we need to know who the content box is for flying fun</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineplus">+        this.contentBox = document.getAnonymousElementByAttribute(</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineplus">+                            this, &quot;anonid&quot;, &quot;content-box&quot;);</span>
<a href="#l5.603"></a><span id="l5.603" class="difflineplus">+</span>
<a href="#l5.604"></a><span id="l5.604" class="difflineplus">+</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineplus">+        // -- House-cleaning</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineplus">+        // -- All/Top mode decision</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineplus">+        this.modes = [&quot;all&quot;];</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineplus">+        if (this.maxDisplayRows &gt;= this.orderedGroups.length) {</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineplus">+          this.mode = &quot;all&quot;;</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineplus">+        }</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineplus">+        else {</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineplus">+          // top mode must be used</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineplus">+          this.modes.push(&quot;top&quot;);</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineplus">+          this.mode = &quot;top&quot;;</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineplus">+          this.topGroups = FacetUtils.makeTopGroups(this.attrDef,</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineplus">+                                                    this.orderedGroups,</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineplus">+                                                    this.maxDisplayRows);</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineplus">+          // setup the more button string</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineplus">+          this.moreButton.textContent =</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineplus">+            glodaFacetStrings.get(</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineplus">+                &quot;glodaFacetView.facets.mode.top.moreLabel&quot;)</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineplus">+              .replace(&quot;#1&quot;, this.orderedGroups.length.toLocaleString());</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineplus">+        }</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineplus">+</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineplus">+        // -- Row Building</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineplus">+        this.buildRows();</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineplus">+</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineplus">+    &lt;method name=&quot;changeMode&quot;&gt;</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineplus">+      &lt;parameter name=&quot;aNewMode&quot; /&gt;</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineplus">+        this.mode = aNewMode;</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineplus">+        this.setAttribute(&quot;mode&quot;, aNewMode);</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineplus">+        this.buildRows();</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineplus">+    &lt;method name=&quot;buildRows&quot;&gt;</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineplus">+        let nounDef = this.nounDef;</span>
<a href="#l5.641"></a><span id="l5.641" class="difflineplus">+        let useGroups = (this.mode == &quot;all&quot;) ? this.orderedGroups</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineplus">+                                             : this.topGroups;</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineplus">+</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineplus">+        // should we just rely on automatic string coercion?</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineplus">+        this.moreButton.setAttribute(&quot;needed&quot;,</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineplus">+                                     (this.mode == &quot;top&quot;) ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineplus">+</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineplus">+        let constraint = this.faceter.constraint;</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineplus">+</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineplus">+        // -- empty all of our display buckets...</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineplus">+        let remainderList = this.remainderList;</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineplus">+        while (remainderList.lastChild)</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineplus">+          remainderList.removeChild(remainderList.lastChild);</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineplus">+        let includeList = this.includeList, excludeList = this.excludeList;</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineplus">+        while (includeList.lastChild)</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineplus">+          includeList.removeChild(includeList.lastChild);</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineplus">+        while (excludeList.lastChild)</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineplus">+          excludeList.removeChild(excludeList.lastChild);</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineplus">+</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineplus">+        // -- first pass, check for ambiguous labels</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineplus">+        // It's possible that multiple groups are identified by the same short</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineplus">+        //  string, in which case we want to use the longer string to</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineplus">+        //  disambiguate.  For example, un-merged contacts can result in</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineplus">+        //  multiple identities having contacts with the same name.  In that</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineplus">+        //  case we want to display both the contact name and the identity</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineplus">+        //  name.</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineplus">+        // This is generically addressed by using the userVisibleString function</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineplus">+        //  defined on the noun type if it is defined.  It takes an argument</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+        //  indicating whether it should be a short string or a long string.</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineplus">+        // Our algorithm is somewhat dumb.  We get the short strings, put them</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineplus">+        //  in a dictionary that maps to whether they are ambiguous or not.  We</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineplus">+        //  do not attempt to map based on their id, so then when it comes time</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineplus">+        //  to actually build the labels, we must build the short string and</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineplus">+        //  then re-call for the long name.  We could be smarter by building</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineplus">+        //  a list of the input values that resulted in the output string and</span>
<a href="#l5.676"></a><span id="l5.676" class="difflineplus">+        //  then using that to back-update the id map, but it's more compelx and</span>
<a href="#l5.677"></a><span id="l5.677" class="difflineplus">+        //  the performance difference is unlikely to be meaningful.</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineplus">+        let ambiguousKeyValues;</span>
<a href="#l5.679"></a><span id="l5.679" class="difflineplus">+        if (&quot;userVisibleString&quot; in nounDef) {</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineplus">+          ambiguousKeyValues = {};</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineplus">+          for each (let [, groupPair] in Iterator(useGroups)) {</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineplus">+            let [groupValue, groupItems] = groupPair;</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineplus">+</span>
<a href="#l5.684"></a><span id="l5.684" class="difflineplus">+            // skip null values, they are handled by the none special-case</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineplus">+            if (groupValue == null)</span>
<a href="#l5.686"></a><span id="l5.686" class="difflineplus">+              continue;</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineplus">+</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineplus">+            let groupStr = nounDef.userVisibleString(groupValue, false);</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+            if (groupStr in ambiguousKeyValues)</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineplus">+              ambiguousKeyValues[groupStr] = true;</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineplus">+            else</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineplus">+              ambiguousKeyValues[groupStr] = false;</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineplus">+          }</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineplus">+        }</span>
<a href="#l5.695"></a><span id="l5.695" class="difflineplus">+</span>
<a href="#l5.696"></a><span id="l5.696" class="difflineplus">+        // -- create the items, assigning them to the right list based on</span>
<a href="#l5.697"></a><span id="l5.697" class="difflineplus">+        //  existing constraint values</span>
<a href="#l5.698"></a><span id="l5.698" class="difflineplus">+        for each (let [, groupPair] in Iterator(useGroups)) {</span>
<a href="#l5.699"></a><span id="l5.699" class="difflineplus">+          let [groupValue, groupItems] = groupPair;</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineplus">+          let li = document.createElement(&quot;li&quot;);</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineplus">+          li.setAttribute(&quot;class&quot;, &quot;bar&quot;);</span>
<a href="#l5.702"></a><span id="l5.702" class="difflineplus">+          li.groupValue = groupValue;</span>
<a href="#l5.703"></a><span id="l5.703" class="difflineplus">+          li.groupItems = groupItems;</span>
<a href="#l5.704"></a><span id="l5.704" class="difflineplus">+</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineplus">+          let countSpan = document.createElement(&quot;span&quot;);</span>
<a href="#l5.706"></a><span id="l5.706" class="difflineplus">+          countSpan.setAttribute(&quot;class&quot;, &quot;bar-count&quot;);</span>
<a href="#l5.707"></a><span id="l5.707" class="difflineplus">+          countSpan.textContent = groupItems.length.toLocaleString();</span>
<a href="#l5.708"></a><span id="l5.708" class="difflineplus">+          li.appendChild(countSpan);</span>
<a href="#l5.709"></a><span id="l5.709" class="difflineplus">+</span>
<a href="#l5.710"></a><span id="l5.710" class="difflineplus">+          let label = document.createElement(&quot;a&quot;);</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineplus">+          label.setAttribute(&quot;class&quot;, &quot;bar-link&quot;);</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineplus">+          // The null value is a special indicator for 'none'</span>
<a href="#l5.713"></a><span id="l5.713" class="difflineplus">+          if (groupValue == null) {</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineplus">+            label.textContent =</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineplus">+              glodaFacetStrings.get(&quot;glodaFacetView.facets.noneLabel&quot;);</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineplus">+          }</span>
<a href="#l5.717"></a><span id="l5.717" class="difflineplus">+          // Otherwise stringify the group object</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineplus">+          else {</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineplus">+            // XXX do a better job of truncation</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineplus">+            let labelStr;</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineplus">+            if (ambiguousKeyValues) {</span>
<a href="#l5.722"></a><span id="l5.722" class="difflineplus">+              labelStr = nounDef.userVisibleString(groupValue, false);</span>
<a href="#l5.723"></a><span id="l5.723" class="difflineplus">+              if (ambiguousKeyValues[labelStr])</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineplus">+                labelStr = nounDef.userVisibleString(groupValue, true);</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineplus">+            }</span>
<a href="#l5.726"></a><span id="l5.726" class="difflineplus">+            else {</span>
<a href="#l5.727"></a><span id="l5.727" class="difflineplus">+              labelStr = groupValue.toLocaleString().substring(0, 80);</span>
<a href="#l5.728"></a><span id="l5.728" class="difflineplus">+            }</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineplus">+            label.textContent = labelStr;</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineplus">+          }</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineplus">+</span>
<a href="#l5.732"></a><span id="l5.732" class="difflineplus">+          li.appendChild(label);</span>
<a href="#l5.733"></a><span id="l5.733" class="difflineplus">+</span>
<a href="#l5.734"></a><span id="l5.734" class="difflineplus">+          let excludeSpan = document.createElement(&quot;span&quot;);</span>
<a href="#l5.735"></a><span id="l5.735" class="difflineplus">+          excludeSpan.setAttribute(&quot;class&quot;, &quot;bar-exclude&quot;);</span>
<a href="#l5.736"></a><span id="l5.736" class="difflineplus">+          li.appendChild(excludeSpan);</span>
<a href="#l5.737"></a><span id="l5.737" class="difflineplus">+</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineplus">+          // root it under the appropriate list</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineplus">+          if (constraint) {</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineplus">+            if (constraint.isIncludedGroup(groupValue)) {</span>
<a href="#l5.741"></a><span id="l5.741" class="difflineplus">+              li.setAttribute(&quot;variety&quot;, &quot;include&quot;);</span>
<a href="#l5.742"></a><span id="l5.742" class="difflineplus">+              includeList.appendChild(li);</span>
<a href="#l5.743"></a><span id="l5.743" class="difflineplus">+            }</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineplus">+            else if (constraint.isExcludedGroup(groupValue)) {</span>
<a href="#l5.745"></a><span id="l5.745" class="difflineplus">+              li.setAttribute(&quot;variety&quot;, &quot;exclude&quot;);</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineplus">+              excludeList.appendChild(li);</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineplus">+            }</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineplus">+            else {</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineplus">+              li.setAttribute(&quot;variety&quot;, &quot;remainder&quot;);</span>
<a href="#l5.750"></a><span id="l5.750" class="difflineplus">+              remainderList.appendChild(li);</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineplus">+            }</span>
<a href="#l5.752"></a><span id="l5.752" class="difflineplus">+          }</span>
<a href="#l5.753"></a><span id="l5.753" class="difflineplus">+          else {</span>
<a href="#l5.754"></a><span id="l5.754" class="difflineplus">+            li.setAttribute(&quot;variety&quot;, &quot;remainder&quot;);</span>
<a href="#l5.755"></a><span id="l5.755" class="difflineplus">+            remainderList.appendChild(li);</span>
<a href="#l5.756"></a><span id="l5.756" class="difflineplus">+          }</span>
<a href="#l5.757"></a><span id="l5.757" class="difflineplus">+        }</span>
<a href="#l5.758"></a><span id="l5.758" class="difflineplus">+</span>
<a href="#l5.759"></a><span id="l5.759" class="difflineplus">+        this.updateHeaderStates();</span>
<a href="#l5.760"></a><span id="l5.760" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.761"></a><span id="l5.761" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineplus">+    &lt;!--</span>
<a href="#l5.763"></a><span id="l5.763" class="difflineplus">+      - Mark the include/exclude headers as &quot;some&quot; if there is anything in their</span>
<a href="#l5.764"></a><span id="l5.764" class="difflineplus">+      -  lists, mark the remainder header as &quot;needed&quot; if either of include /</span>
<a href="#l5.765"></a><span id="l5.765" class="difflineplus">+      -  exclude exist so we need that label.</span>
<a href="#l5.766"></a><span id="l5.766" class="difflineplus">+      --&gt;</span>
<a href="#l5.767"></a><span id="l5.767" class="difflineplus">+    &lt;method name=&quot;updateHeaderStates&quot;&gt;</span>
<a href="#l5.768"></a><span id="l5.768" class="difflineplus">+      &lt;parameter name=&quot;aItems&quot; /&gt;</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineplus">+        this.includeLabel.setAttribute(&quot;state&quot;,</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineplus">+          this.includeList.childElementCount ? &quot;some&quot; : &quot;empty&quot;);</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineplus">+        this.excludeLabel.setAttribute(&quot;state&quot;,</span>
<a href="#l5.773"></a><span id="l5.773" class="difflineplus">+          this.excludeList.childElementCount ? &quot;some&quot; : &quot;empty&quot;);</span>
<a href="#l5.774"></a><span id="l5.774" class="difflineplus">+        this.remainderLabel.setAttribute(&quot;needed&quot;,</span>
<a href="#l5.775"></a><span id="l5.775" class="difflineplus">+          ((this.includeList.childElementCount ||</span>
<a href="#l5.776"></a><span id="l5.776" class="difflineplus">+            this.excludeList.childElementCount) &amp;&amp;</span>
<a href="#l5.777"></a><span id="l5.777" class="difflineplus">+           this.remainderList.childElementCount) ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineplus">+</span>
<a href="#l5.779"></a><span id="l5.779" class="difflineplus">+        // nuke the style attributes to lose the artifacts of the jquery</span>
<a href="#l5.780"></a><span id="l5.780" class="difflineplus">+        //  animation.</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineplus">+        this.includeLabel.removeAttribute(&quot;style&quot;);</span>
<a href="#l5.782"></a><span id="l5.782" class="difflineplus">+        this.excludeLabel.removeAttribute(&quot;style&quot;);</span>
<a href="#l5.783"></a><span id="l5.783" class="difflineplus">+        this.remainderLabel.removeAttribute(&quot;style&quot;);</span>
<a href="#l5.784"></a><span id="l5.784" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineplus">+    &lt;method name=&quot;brushItems&quot;&gt;</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineplus">+      &lt;parameter name=&quot;aItems&quot; /&gt;</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.790"></a><span id="l5.790" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineplus">+    &lt;method name=&quot;clearBrushedItems&quot;&gt;</span>
<a href="#l5.792"></a><span id="l5.792" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.793"></a><span id="l5.793" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineplus">+    &lt;method name=&quot;afterListVisible&quot;&gt;</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineplus">+      &lt;parameter name=&quot;aVariety&quot; /&gt;</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineplus">+      &lt;parameter name=&quot;aCallback&quot; /&gt;</span>
<a href="#l5.798"></a><span id="l5.798" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.799"></a><span id="l5.799" class="difflineplus">+        let labelNode = this[aVariety + &quot;Label&quot;];</span>
<a href="#l5.800"></a><span id="l5.800" class="difflineplus">+        let listNode = this[aVariety + &quot;List&quot;];</span>
<a href="#l5.801"></a><span id="l5.801" class="difflineplus">+</span>
<a href="#l5.802"></a><span id="l5.802" class="difflineplus">+        // if there are already things displayed, no need</span>
<a href="#l5.803"></a><span id="l5.803" class="difflineplus">+        if (listNode.childElementCount) {</span>
<a href="#l5.804"></a><span id="l5.804" class="difflineplus">+          aCallback();</span>
<a href="#l5.805"></a><span id="l5.805" class="difflineplus">+          return;</span>
<a href="#l5.806"></a><span id="l5.806" class="difflineplus">+        }</span>
<a href="#l5.807"></a><span id="l5.807" class="difflineplus">+</span>
<a href="#l5.808"></a><span id="l5.808" class="difflineplus">+        let remListVisible =</span>
<a href="#l5.809"></a><span id="l5.809" class="difflineplus">+          this.remainderLabel.getAttribute(&quot;needed&quot;) == &quot;true&quot;;</span>
<a href="#l5.810"></a><span id="l5.810" class="difflineplus">+        let remListShouldBeVisible =</span>
<a href="#l5.811"></a><span id="l5.811" class="difflineplus">+          this.remainderList.childElementCount &gt; 1;</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineplus">+</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineplus">+        labelNode.setAttribute(&quot;state&quot;, &quot;some&quot;);</span>
<a href="#l5.814"></a><span id="l5.814" class="difflineplus">+        if (remListVisible != remListShouldBeVisible)</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineplus">+          showNodes = $([labelNode, this.remainderLabel]);</span>
<a href="#l5.816"></a><span id="l5.816" class="difflineplus">+        else</span>
<a href="#l5.817"></a><span id="l5.817" class="difflineplus">+          showNodes = $(labelNode);</span>
<a href="#l5.818"></a><span id="l5.818" class="difflineplus">+        showNodes</span>
<a href="#l5.819"></a><span id="l5.819" class="difflineplus">+          .hide()</span>
<a href="#l5.820"></a><span id="l5.820" class="difflineplus">+          .slideDown(&quot;fast&quot;, aCallback);</span>
<a href="#l5.821"></a><span id="l5.821" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.822"></a><span id="l5.822" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.823"></a><span id="l5.823" class="difflineplus">+    &lt;method name=&quot;_flyBarAway&quot;&gt;</span>
<a href="#l5.824"></a><span id="l5.824" class="difflineplus">+      &lt;parameter name=&quot;aBarNode&quot; /&gt;</span>
<a href="#l5.825"></a><span id="l5.825" class="difflineplus">+      &lt;parameter name=&quot;aVariety&quot; /&gt;</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineplus">+      &lt;parameter name=&quot;aCallback&quot; /&gt;</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.828"></a><span id="l5.828" class="difflineplus">+        // figure out our origin location prior to adding the target or it</span>
<a href="#l5.829"></a><span id="l5.829" class="difflineplus">+        //  will shift us down.</span>
<a href="#l5.830"></a><span id="l5.830" class="difflineplus">+        let $barNode = $(aBarNode);</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineplus">+        let origin = $barNode.offset();</span>
<a href="#l5.832"></a><span id="l5.832" class="difflineplus">+</span>
<a href="#l5.833"></a><span id="l5.833" class="difflineplus">+        // clone the node into its target location</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineplus">+        let targetNode = aBarNode.cloneNode(true);</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineplus">+        targetNode.groupValue = aBarNode.groupValue;</span>
<a href="#l5.836"></a><span id="l5.836" class="difflineplus">+        targetNode.groupItems = aBarNode.groupItems;</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineplus">+        targetNode.setAttribute(&quot;variety&quot;, aVariety);</span>
<a href="#l5.838"></a><span id="l5.838" class="difflineplus">+</span>
<a href="#l5.839"></a><span id="l5.839" class="difflineplus">+        let targetParent = this[aVariety + &quot;List&quot;];</span>
<a href="#l5.840"></a><span id="l5.840" class="difflineplus">+        targetParent.appendChild(targetNode);</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineplus">+</span>
<a href="#l5.842"></a><span id="l5.842" class="difflineplus">+        // create a flying clone</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineplus">+        let flyingNode = aBarNode.cloneNode(true);</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineplus">+</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineplus">+        // animate the flying clone... flying!</span>
<a href="#l5.846"></a><span id="l5.846" class="difflineplus">+        let $targetNode = $(targetNode);</span>
<a href="#l5.847"></a><span id="l5.847" class="difflineplus">+        let dest = $targetNode.offset();</span>
<a href="#l5.848"></a><span id="l5.848" class="difflineplus">+</span>
<a href="#l5.849"></a><span id="l5.849" class="difflineplus">+        // if the flying box wants to go higher than the content box goes, just</span>
<a href="#l5.850"></a><span id="l5.850" class="difflineplus">+        //  send it to the top of the content box instead.</span>
<a href="#l5.851"></a><span id="l5.851" class="difflineplus">+        let $contentBox = $(this.contentBox);</span>
<a href="#l5.852"></a><span id="l5.852" class="difflineplus">+        let contentOffset = $contentBox.offset();</span>
<a href="#l5.853"></a><span id="l5.853" class="difflineplus">+        if (dest.top &lt; contentOffset.top)</span>
<a href="#l5.854"></a><span id="l5.854" class="difflineplus">+          dest.top = contentOffset.top;</span>
<a href="#l5.855"></a><span id="l5.855" class="difflineplus">+        // likewise if it wants to go further south than the content box, stop</span>
<a href="#l5.856"></a><span id="l5.856" class="difflineplus">+        //  that</span>
<a href="#l5.857"></a><span id="l5.857" class="difflineplus">+        if (dest.top &gt; (contentOffset.top + $contentBox.height()))</span>
<a href="#l5.858"></a><span id="l5.858" class="difflineplus">+          dest.top = contentOffset.top + $contentBox.height() -</span>
<a href="#l5.859"></a><span id="l5.859" class="difflineplus">+                       $targetNode.height();</span>
<a href="#l5.860"></a><span id="l5.860" class="difflineplus">+</span>
<a href="#l5.861"></a><span id="l5.861" class="difflineplus">+        let $flyingNode = $(flyingNode)</span>
<a href="#l5.862"></a><span id="l5.862" class="difflineplus">+          .appendTo(&quot;body&quot;)</span>
<a href="#l5.863"></a><span id="l5.863" class="difflineplus">+          .css(&quot;position&quot;, &quot;absolute&quot;)</span>
<a href="#l5.864"></a><span id="l5.864" class="difflineplus">+          .css(&quot;width&quot;, $barNode.width())</span>
<a href="#l5.865"></a><span id="l5.865" class="difflineplus">+          .css(&quot;height&quot;, $barNode.height())</span>
<a href="#l5.866"></a><span id="l5.866" class="difflineplus">+          .css(&quot;top&quot;, origin.top)</span>
<a href="#l5.867"></a><span id="l5.867" class="difflineplus">+          .css(&quot;left&quot;, origin.left)</span>
<a href="#l5.868"></a><span id="l5.868" class="difflineplus">+          .css(&quot;zIndex&quot;, 1000)</span>
<a href="#l5.869"></a><span id="l5.869" class="difflineplus">+          .animate({</span>
<a href="#l5.870"></a><span id="l5.870" class="difflineplus">+              top: dest.top,</span>
<a href="#l5.871"></a><span id="l5.871" class="difflineplus">+              left: dest.left</span>
<a href="#l5.872"></a><span id="l5.872" class="difflineplus">+            },</span>
<a href="#l5.873"></a><span id="l5.873" class="difflineplus">+            // have a velocity of 1 pixel every 4ms</span>
<a href="#l5.874"></a><span id="l5.874" class="difflineplus">+            Math.abs(dest.top - origin.top) * 2, function() {</span>
<a href="#l5.875"></a><span id="l5.875" class="difflineplus">+              $barNode.remove();</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineplus">+              $targetNode.show();</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineplus">+              $flyingNode.remove();</span>
<a href="#l5.878"></a><span id="l5.878" class="difflineplus">+</span>
<a href="#l5.879"></a><span id="l5.879" class="difflineplus">+              if (aCallback)</span>
<a href="#l5.880"></a><span id="l5.880" class="difflineplus">+                setTimeout(aCallback, 50);</span>
<a href="#l5.881"></a><span id="l5.881" class="difflineplus">+            });</span>
<a href="#l5.882"></a><span id="l5.882" class="difflineplus">+</span>
<a href="#l5.883"></a><span id="l5.883" class="difflineplus">+        // hide the target (cloned) node</span>
<a href="#l5.884"></a><span id="l5.884" class="difflineplus">+        $(targetNode).hide();</span>
<a href="#l5.885"></a><span id="l5.885" class="difflineplus">+</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineplus">+        // hide the original node and remove its JS properties</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineplus">+        $(aBarNode).css(&quot;visibility&quot;, &quot;hidden&quot;);</span>
<a href="#l5.888"></a><span id="l5.888" class="difflineplus">+        delete aBarNode.groupValue;</span>
<a href="#l5.889"></a><span id="l5.889" class="difflineplus">+        delete aBarNode.groupItems;</span>
<a href="#l5.890"></a><span id="l5.890" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.891"></a><span id="l5.891" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.892"></a><span id="l5.892" class="difflineplus">+    &lt;method name=&quot;barClicked&quot;&gt;</span>
<a href="#l5.893"></a><span id="l5.893" class="difflineplus">+      &lt;parameter name=&quot;aBarNode&quot; /&gt;</span>
<a href="#l5.894"></a><span id="l5.894" class="difflineplus">+      &lt;parameter name=&quot;aVariety&quot; /&gt;</span>
<a href="#l5.895"></a><span id="l5.895" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.896"></a><span id="l5.896" class="difflineplus">+        let groupValue = aBarNode.groupValue;</span>
<a href="#l5.897"></a><span id="l5.897" class="difflineplus">+        let groupItems = aBarNode.groupItems;</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineplus">+</span>
<a href="#l5.899"></a><span id="l5.899" class="difflineplus">+        let dis = this;</span>
<a href="#l5.900"></a><span id="l5.900" class="difflineplus">+        // These determine what goAnimate actually does.</span>
<a href="#l5.901"></a><span id="l5.901" class="difflineplus">+        // flyAway allows us to cancel flying in the case the constraint is</span>
<a href="#l5.902"></a><span id="l5.902" class="difflineplus">+        //  being fully dropped and so the facet is just going to get rebuilt</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineplus">+        let flyAway = true;</span>
<a href="#l5.904"></a><span id="l5.904" class="difflineplus">+</span>
<a href="#l5.905"></a><span id="l5.905" class="difflineplus">+        function goAnimate() {</span>
<a href="#l5.906"></a><span id="l5.906" class="difflineplus">+          setTimeout(function () {</span>
<a href="#l5.907"></a><span id="l5.907" class="difflineplus">+            if (flyAway) {</span>
<a href="#l5.908"></a><span id="l5.908" class="difflineplus">+              dis.afterListVisible(aVariety, function() {</span>
<a href="#l5.909"></a><span id="l5.909" class="difflineplus">+                dis._flyBarAway(aBarNode, aVariety, function() {</span>
<a href="#l5.910"></a><span id="l5.910" class="difflineplus">+                  dis.updateHeaderStates();</span>
<a href="#l5.911"></a><span id="l5.911" class="difflineplus">+                });</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineplus">+              });</span>
<a href="#l5.913"></a><span id="l5.913" class="difflineplus">+            }</span>
<a href="#l5.914"></a><span id="l5.914" class="difflineplus">+          }, 0);</span>
<a href="#l5.915"></a><span id="l5.915" class="difflineplus">+        };</span>
<a href="#l5.916"></a><span id="l5.916" class="difflineplus">+</span>
<a href="#l5.917"></a><span id="l5.917" class="difflineplus">+        // Immediately apply the facet change, triggering the animation after</span>
<a href="#l5.918"></a><span id="l5.918" class="difflineplus">+        //  the faceting completes.</span>
<a href="#l5.919"></a><span id="l5.919" class="difflineplus">+        if (aVariety == &quot;remainder&quot;) {</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineplus">+          let currentVariety = aBarNode.getAttribute(&quot;variety&quot;);</span>
<a href="#l5.921"></a><span id="l5.921" class="difflineplus">+          let constraintGone = FacetContext.removeFacetConstraint(</span>
<a href="#l5.922"></a><span id="l5.922" class="difflineplus">+                                 this.faceter,</span>
<a href="#l5.923"></a><span id="l5.923" class="difflineplus">+                                 currentVariety == &quot;include&quot;,</span>
<a href="#l5.924"></a><span id="l5.924" class="difflineplus">+                                 [groupValue],</span>
<a href="#l5.925"></a><span id="l5.925" class="difflineplus">+                                 goAnimate);</span>
<a href="#l5.926"></a><span id="l5.926" class="difflineplus">+          // we will automatically rebuild if the constraint is gone, so</span>
<a href="#l5.927"></a><span id="l5.927" class="difflineplus">+          //  just make the animation a no-op.</span>
<a href="#l5.928"></a><span id="l5.928" class="difflineplus">+          if (constraintGone)</span>
<a href="#l5.929"></a><span id="l5.929" class="difflineplus">+            flyAway = false;</span>
<a href="#l5.930"></a><span id="l5.930" class="difflineplus">+        }</span>
<a href="#l5.931"></a><span id="l5.931" class="difflineplus">+        // include/exclude</span>
<a href="#l5.932"></a><span id="l5.932" class="difflineplus">+        else {</span>
<a href="#l5.933"></a><span id="l5.933" class="difflineplus">+          let revalidate = FacetContext.addFacetConstraint(</span>
<a href="#l5.934"></a><span id="l5.934" class="difflineplus">+                             this.faceter,</span>
<a href="#l5.935"></a><span id="l5.935" class="difflineplus">+                             aVariety == &quot;include&quot;,</span>
<a href="#l5.936"></a><span id="l5.936" class="difflineplus">+                             [groupValue],</span>
<a href="#l5.937"></a><span id="l5.937" class="difflineplus">+                             false, false, goAnimate);</span>
<a href="#l5.938"></a><span id="l5.938" class="difflineplus">+          // revalidate means we need to blow away the other dudes, in which</span>
<a href="#l5.939"></a><span id="l5.939" class="difflineplus">+          //  case it makes the most sense to just trigger a rebuild of ourself</span>
<a href="#l5.940"></a><span id="l5.940" class="difflineplus">+          if (revalidate) {</span>
<a href="#l5.941"></a><span id="l5.941" class="difflineplus">+            flyAway = false;</span>
<a href="#l5.942"></a><span id="l5.942" class="difflineplus">+            this.build(false);</span>
<a href="#l5.943"></a><span id="l5.943" class="difflineplus">+          }</span>
<a href="#l5.944"></a><span id="l5.944" class="difflineplus">+        }</span>
<a href="#l5.945"></a><span id="l5.945" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.946"></a><span id="l5.946" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.947"></a><span id="l5.947" class="difflineplus">+    &lt;method name=&quot;barHovered&quot;&gt;</span>
<a href="#l5.948"></a><span id="l5.948" class="difflineplus">+      &lt;parameter name=&quot;aBarNode&quot; /&gt;</span>
<a href="#l5.949"></a><span id="l5.949" class="difflineplus">+      &lt;parameter name=&quot;aInclude&quot; /&gt;</span>
<a href="#l5.950"></a><span id="l5.950" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.951"></a><span id="l5.951" class="difflineplus">+        let groupValue = aBarNode.groupValue;</span>
<a href="#l5.952"></a><span id="l5.952" class="difflineplus">+        let groupItems = aBarNode.groupItems;</span>
<a href="#l5.953"></a><span id="l5.953" class="difflineplus">+</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineplus">+        FacetContext.hoverFacet(this.faceter, this.attrDef, groupValue, groupItems);</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.956"></a><span id="l5.956" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineplus">+    &lt;!-- HoverGone! HoverGone!</span>
<a href="#l5.958"></a><span id="l5.958" class="difflineplus">+         We know it's gone, but where has it gone? --&gt;</span>
<a href="#l5.959"></a><span id="l5.959" class="difflineplus">+    &lt;method name=&quot;barHoverGone&quot;&gt;</span>
<a href="#l5.960"></a><span id="l5.960" class="difflineplus">+      &lt;parameter name=&quot;aBarNode&quot; /&gt;</span>
<a href="#l5.961"></a><span id="l5.961" class="difflineplus">+      &lt;parameter name=&quot;aInclude&quot; /&gt;</span>
<a href="#l5.962"></a><span id="l5.962" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.963"></a><span id="l5.963" class="difflineplus">+        let groupValue = aBarNode.groupValue;</span>
<a href="#l5.964"></a><span id="l5.964" class="difflineplus">+        let groupItems = aBarNode.groupItems;</span>
<a href="#l5.965"></a><span id="l5.965" class="difflineplus">+</span>
<a href="#l5.966"></a><span id="l5.966" class="difflineplus">+        FacetContext.unhoverFacet(this.faceter, this.attrDef, groupValue, groupItems);</span>
<a href="#l5.967"></a><span id="l5.967" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.968"></a><span id="l5.968" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.969"></a><span id="l5.969" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l5.970"></a><span id="l5.970" class="difflineplus">+  &lt;handlers&gt;</span>
<a href="#l5.971"></a><span id="l5.971" class="difflineplus">+    &lt;handler event=&quot;click&quot;&gt;&lt;![CDATA[</span>
<a href="#l5.972"></a><span id="l5.972" class="difflineplus">+      // we dispatch based on the class of the thing we clicked on.</span>
<a href="#l5.973"></a><span id="l5.973" class="difflineplus">+      // there are other ways we could accomplish this, but they all sorta suck.</span>
<a href="#l5.974"></a><span id="l5.974" class="difflineplus">+      let nodeClasses = event.originalTarget.getAttribute(&quot;class&quot;);</span>
<a href="#l5.975"></a><span id="l5.975" class="difflineplus">+      if (!nodeClasses)</span>
<a href="#l5.976"></a><span id="l5.976" class="difflineplus">+        return;</span>
<a href="#l5.977"></a><span id="l5.977" class="difflineplus">+</span>
<a href="#l5.978"></a><span id="l5.978" class="difflineplus">+      let nodeClass = nodeClasses.split(&quot; &quot;)[0];</span>
<a href="#l5.979"></a><span id="l5.979" class="difflineplus">+      if (nodeClass == &quot;bar-exclude&quot;)</span>
<a href="#l5.980"></a><span id="l5.980" class="difflineplus">+        this.barClicked(event.originalTarget.parentNode, &quot;exclude&quot;);</span>
<a href="#l5.981"></a><span id="l5.981" class="difflineplus">+      else if (nodeClass == &quot;bar-link&quot;) {</span>
<a href="#l5.982"></a><span id="l5.982" class="difflineplus">+        let barNode = event.originalTarget.parentNode;</span>
<a href="#l5.983"></a><span id="l5.983" class="difflineplus">+        this.barClicked(barNode,</span>
<a href="#l5.984"></a><span id="l5.984" class="difflineplus">+                        (barNode.getAttribute(&quot;variety&quot;) == &quot;remainder&quot;) ?</span>
<a href="#l5.985"></a><span id="l5.985" class="difflineplus">+                          &quot;include&quot; : &quot;remainder&quot;);</span>
<a href="#l5.986"></a><span id="l5.986" class="difflineplus">+      }</span>
<a href="#l5.987"></a><span id="l5.987" class="difflineplus">+      else if (nodeClass == &quot;facet-more&quot;) {</span>
<a href="#l5.988"></a><span id="l5.988" class="difflineplus">+        this.changeMode(&quot;all&quot;);</span>
<a href="#l5.989"></a><span id="l5.989" class="difflineplus">+      }</span>
<a href="#l5.990"></a><span id="l5.990" class="difflineplus">+    ]]&gt;&lt;/handler&gt;</span>
<a href="#l5.991"></a><span id="l5.991" class="difflineplus">+    &lt;handler event=&quot;mouseover&quot;&gt;&lt;![CDATA[</span>
<a href="#l5.992"></a><span id="l5.992" class="difflineplus">+      // we dispatch based on the class of the thing we clicked on.</span>
<a href="#l5.993"></a><span id="l5.993" class="difflineplus">+      // there are other ways we could accomplish this, but they all sorta suck.</span>
<a href="#l5.994"></a><span id="l5.994" class="difflineplus">+      let nodeClasses = event.originalTarget.getAttribute(&quot;class&quot;);</span>
<a href="#l5.995"></a><span id="l5.995" class="difflineplus">+      if (!nodeClasses)</span>
<a href="#l5.996"></a><span id="l5.996" class="difflineplus">+        return;</span>
<a href="#l5.997"></a><span id="l5.997" class="difflineplus">+</span>
<a href="#l5.998"></a><span id="l5.998" class="difflineplus">+      let nodeClass = nodeClasses.split(&quot; &quot;)[0];</span>
<a href="#l5.999"></a><span id="l5.999" class="difflineplus">+      if (nodeClass == &quot;bar-link&quot;)</span>
<a href="#l5.1000"></a><span id="l5.1000" class="difflineplus">+        this.barHovered(event.originalTarget.parentNode, true);</span>
<a href="#l5.1001"></a><span id="l5.1001" class="difflineplus">+    ]]&gt;&lt;/handler&gt;</span>
<a href="#l5.1002"></a><span id="l5.1002" class="difflineplus">+    &lt;handler event=&quot;mouseout&quot;&gt;&lt;![CDATA[</span>
<a href="#l5.1003"></a><span id="l5.1003" class="difflineplus">+      // we dispatch based on the class of the thing we clicked on.</span>
<a href="#l5.1004"></a><span id="l5.1004" class="difflineplus">+      // there are other ways we could accomplish this, but they all sorta suck.</span>
<a href="#l5.1005"></a><span id="l5.1005" class="difflineplus">+      let nodeClasses = event.originalTarget.getAttribute(&quot;class&quot;);</span>
<a href="#l5.1006"></a><span id="l5.1006" class="difflineplus">+      if (!nodeClasses)</span>
<a href="#l5.1007"></a><span id="l5.1007" class="difflineplus">+        return;</span>
<a href="#l5.1008"></a><span id="l5.1008" class="difflineplus">+</span>
<a href="#l5.1009"></a><span id="l5.1009" class="difflineplus">+      let nodeClass = nodeClasses.split(&quot; &quot;)[0];</span>
<a href="#l5.1010"></a><span id="l5.1010" class="difflineplus">+      if (nodeClass == &quot;bar-link&quot;)</span>
<a href="#l5.1011"></a><span id="l5.1011" class="difflineplus">+        this.barHoverGone(event.originalTarget.parentNode, true);</span>
<a href="#l5.1012"></a><span id="l5.1012" class="difflineplus">+    ]]&gt;&lt;/handler&gt;</span>
<a href="#l5.1013"></a><span id="l5.1013" class="difflineplus">+  &lt;/handlers&gt;</span>
<a href="#l5.1014"></a><span id="l5.1014" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l5.1015"></a><span id="l5.1015" class="difflineplus">+</span>
<a href="#l5.1016"></a><span id="l5.1016" class="difflineplus">+&lt;binding id=&quot;facet-date&quot;&gt;</span>
<a href="#l5.1017"></a><span id="l5.1017" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l5.1018"></a><span id="l5.1018" class="difflineplus">+    &lt;html:div class=&quot;facet&quot;&gt;</span>
<a href="#l5.1019"></a><span id="l5.1019" class="difflineplus">+      &lt;html:h2 anonid=&quot;name&quot;&gt;&lt;/html:h2&gt;</span>
<a href="#l5.1020"></a><span id="l5.1020" class="difflineplus">+      &lt;!-- we need to do this because of something protovis is doing where</span>
<a href="#l5.1021"></a><span id="l5.1021" class="difflineplus">+           it attempts to re-interpret the text and the html namespace no</span>
<a href="#l5.1022"></a><span id="l5.1022" class="difflineplus">+           longer exists in that context. --&gt;</span>
<a href="#l5.1023"></a><span id="l5.1023" class="difflineplus">+      &lt;html:div anonid=&quot;canvas&quot; class=&quot;date-vis-frame&quot;&gt;&lt;/html:div&gt;</span>
<a href="#l5.1024"></a><span id="l5.1024" class="difflineplus">+    &lt;/html:div&gt;</span>
<a href="#l5.1025"></a><span id="l5.1025" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l5.1026"></a><span id="l5.1026" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l5.1027"></a><span id="l5.1027" class="difflineplus">+    &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l5.1028"></a><span id="l5.1028" class="difflineplus">+      this.canvasNode = document.getAnonymousElementByAttribute(</span>
<a href="#l5.1029"></a><span id="l5.1029" class="difflineplus">+                                   this, &quot;anonid&quot;, &quot;canvas&quot;);</span>
<a href="#l5.1030"></a><span id="l5.1030" class="difflineplus">+      this.vis = null;</span>
<a href="#l5.1031"></a><span id="l5.1031" class="difflineplus">+      if (&quot;faceter&quot; in this)</span>
<a href="#l5.1032"></a><span id="l5.1032" class="difflineplus">+        this.build(true);</span>
<a href="#l5.1033"></a><span id="l5.1033" class="difflineplus">+    ]]&gt;&lt;/constructor&gt;</span>
<a href="#l5.1034"></a><span id="l5.1034" class="difflineplus">+    &lt;field name=&quot;canUpdate&quot; readonly=&quot;true&quot;&gt;true&lt;/field&gt;</span>
<a href="#l5.1035"></a><span id="l5.1035" class="difflineplus">+    &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l5.1036"></a><span id="l5.1036" class="difflineplus">+      &lt;parameter name=&quot;aDoSize&quot; /&gt;</span>
<a href="#l5.1037"></a><span id="l5.1037" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.1038"></a><span id="l5.1038" class="difflineplus">+        if (!this.vis) {</span>
<a href="#l5.1039"></a><span id="l5.1039" class="difflineplus">+          this.vis = new DateFacetVis(this, this.canvasNode);</span>
<a href="#l5.1040"></a><span id="l5.1040" class="difflineplus">+          this.vis.build();</span>
<a href="#l5.1041"></a><span id="l5.1041" class="difflineplus">+        }</span>
<a href="#l5.1042"></a><span id="l5.1042" class="difflineplus">+        else {</span>
<a href="#l5.1043"></a><span id="l5.1043" class="difflineplus">+          while (this.canvasNode.lastChild)</span>
<a href="#l5.1044"></a><span id="l5.1044" class="difflineplus">+            this.canvasNode.removeChild(this.canvasNode.lastChild);</span>
<a href="#l5.1045"></a><span id="l5.1045" class="difflineplus">+          if (aDoSize)</span>
<a href="#l5.1046"></a><span id="l5.1046" class="difflineplus">+            this.vis.build()</span>
<a href="#l5.1047"></a><span id="l5.1047" class="difflineplus">+          else</span>
<a href="#l5.1048"></a><span id="l5.1048" class="difflineplus">+            this.vis.rebuild();</span>
<a href="#l5.1049"></a><span id="l5.1049" class="difflineplus">+        }</span>
<a href="#l5.1050"></a><span id="l5.1050" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.1051"></a><span id="l5.1051" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.1052"></a><span id="l5.1052" class="difflineplus">+    &lt;method name=&quot;brushItems&quot;&gt;</span>
<a href="#l5.1053"></a><span id="l5.1053" class="difflineplus">+      &lt;parameter name=&quot;aItems&quot; /&gt;</span>
<a href="#l5.1054"></a><span id="l5.1054" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.1055"></a><span id="l5.1055" class="difflineplus">+        this.vis.hoverItems(aItems);</span>
<a href="#l5.1056"></a><span id="l5.1056" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.1057"></a><span id="l5.1057" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.1058"></a><span id="l5.1058" class="difflineplus">+    &lt;method name=&quot;clearBrushedItems&quot;&gt;</span>
<a href="#l5.1059"></a><span id="l5.1059" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.1060"></a><span id="l5.1060" class="difflineplus">+        this.vis.clearHover();</span>
<a href="#l5.1061"></a><span id="l5.1061" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.1062"></a><span id="l5.1062" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.1063"></a><span id="l5.1063" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l5.1064"></a><span id="l5.1064" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l5.1065"></a><span id="l5.1065" class="difflineplus">+</span>
<a href="#l5.1066"></a><span id="l5.1066" class="difflineplus">+&lt;!-- ===== Results ===== --&gt;</span>
<a href="#l5.1067"></a><span id="l5.1067" class="difflineplus">+</span>
<a href="#l5.1068"></a><span id="l5.1068" class="difflineplus">+&lt;binding id=&quot;results-message&quot;&gt;</span>
<a href="#l5.1069"></a><span id="l5.1069" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l5.1070"></a><span id="l5.1070" class="difflineplus">+    &lt;html:div class=&quot;results-message-header&quot;&gt;</span>
<a href="#l5.1071"></a><span id="l5.1071" class="difflineplus">+      &lt;html:h2 class=&quot;results-message-count&quot; anonid=&quot;count&quot;&gt;&lt;/html:h2&gt;</span>
<a href="#l5.1072"></a><span id="l5.1072" class="difflineplus">+      &lt;html:span class=&quot;results-message-showall&quot; anonid=&quot;showall&quot;</span>
<a href="#l5.1073"></a><span id="l5.1073" class="difflineplus">+            onclick=&quot;FacetContext.showActiveSetInTab()&quot;&gt;&lt;/html:span&gt;</span>
<a href="#l5.1074"></a><span id="l5.1074" class="difflineplus">+      &lt;html:div anonid=&quot;sort&quot; class=&quot;results-message-sort-bar&quot;&gt;</span>
<a href="#l5.1075"></a><span id="l5.1075" class="difflineplus">+        &lt;html:span anonid=&quot;sort-label&quot; class=&quot;results-message-sort-label&quot;/&gt;</span>
<a href="#l5.1076"></a><span id="l5.1076" class="difflineplus">+        &lt;html:span anonid=&quot;sort-relevance&quot; class=&quot;results-message-sort-value&quot;/&gt;</span>
<a href="#l5.1077"></a><span id="l5.1077" class="difflineplus">+        &lt;html:span anonid=&quot;sort-date&quot; class=&quot;results-message-sort-value&quot;/&gt;</span>
<a href="#l5.1078"></a><span id="l5.1078" class="difflineplus">+      &lt;/html:div&gt;</span>
<a href="#l5.1079"></a><span id="l5.1079" class="difflineplus">+    &lt;/html:div&gt;</span>
<a href="#l5.1080"></a><span id="l5.1080" class="difflineplus">+    &lt;html:div class=&quot;messages&quot; anonid=&quot;messages&quot;&gt;</span>
<a href="#l5.1081"></a><span id="l5.1081" class="difflineplus">+    &lt;/html:div&gt;</span>
<a href="#l5.1082"></a><span id="l5.1082" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l5.1083"></a><span id="l5.1083" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l5.1084"></a><span id="l5.1084" class="difflineplus">+    &lt;method name=&quot;setMessages&quot;&gt;</span>
<a href="#l5.1085"></a><span id="l5.1085" class="difflineplus">+      &lt;parameter name=&quot;aMessages&quot; /&gt;</span>
<a href="#l5.1086"></a><span id="l5.1086" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.1087"></a><span id="l5.1087" class="difflineplus">+        // -- Count</span>
<a href="#l5.1088"></a><span id="l5.1088" class="difflineplus">+        let countNode = document.getAnonymousElementByAttribute(</span>
<a href="#l5.1089"></a><span id="l5.1089" class="difflineplus">+                          this, &quot;anonid&quot;, &quot;count&quot;);</span>
<a href="#l5.1090"></a><span id="l5.1090" class="difflineplus">+        let messagesPlural = glodaFacetStrings.get(</span>
<a href="#l5.1091"></a><span id="l5.1091" class="difflineplus">+          &quot;glodaFacetView.results.message.countLabelMessagePlurals&quot;);</span>
<a href="#l5.1092"></a><span id="l5.1092" class="difflineplus">+        let countLabel = glodaFacetStrings.get(</span>
<a href="#l5.1093"></a><span id="l5.1093" class="difflineplus">+          &quot;glodaFacetView.results.message.countLabel&quot;);</span>
<a href="#l5.1094"></a><span id="l5.1094" class="difflineplus">+        // display set</span>
<a href="#l5.1095"></a><span id="l5.1095" class="difflineplus">+        countLabel = countLabel.replace(&quot;#1&quot;,</span>
<a href="#l5.1096"></a><span id="l5.1096" class="difflineplus">+          aMessages.length.toLocaleString());</span>
<a href="#l5.1097"></a><span id="l5.1097" class="difflineplus">+        countLabel = countLabel.replace(&quot;#2&quot;,</span>
<a href="#l5.1098"></a><span id="l5.1098" class="difflineplus">+          PluralForm.get(aMessages.length, messagesPlural));</span>
<a href="#l5.1099"></a><span id="l5.1099" class="difflineplus">+        // active set</span>
<a href="#l5.1100"></a><span id="l5.1100" class="difflineplus">+        countLabel = countLabel.replace(&quot;#3&quot;,</span>
<a href="#l5.1101"></a><span id="l5.1101" class="difflineplus">+          FacetContext.activeSet.length.toLocaleString());</span>
<a href="#l5.1102"></a><span id="l5.1102" class="difflineplus">+        countLabel = countLabel.replace(&quot;#4&quot;,</span>
<a href="#l5.1103"></a><span id="l5.1103" class="difflineplus">+          PluralForm.get(FacetContext.activeSet.length, messagesPlural));</span>
<a href="#l5.1104"></a><span id="l5.1104" class="difflineplus">+        countNode.textContent = countLabel;</span>
<a href="#l5.1105"></a><span id="l5.1105" class="difflineplus">+</span>
<a href="#l5.1106"></a><span id="l5.1106" class="difflineplus">+        // -- Show All</span>
<a href="#l5.1107"></a><span id="l5.1107" class="difflineplus">+        let showNode = document.getAnonymousElementByAttribute(</span>
<a href="#l5.1108"></a><span id="l5.1108" class="difflineplus">+                          this, &quot;anonid&quot;, &quot;showall&quot;);</span>
<a href="#l5.1109"></a><span id="l5.1109" class="difflineplus">+        showNode.textContent = glodaFacetStrings.get(</span>
<a href="#l5.1110"></a><span id="l5.1110" class="difflineplus">+          &quot;glodaFacetView.results.message.showAllInList.label&quot;);</span>
<a href="#l5.1111"></a><span id="l5.1111" class="difflineplus">+</span>
<a href="#l5.1112"></a><span id="l5.1112" class="difflineplus">+        let sortLabelNode = document.getAnonymousElementByAttribute(</span>
<a href="#l5.1113"></a><span id="l5.1113" class="difflineplus">+                          this, &quot;anonid&quot;, &quot;sort-label&quot;);</span>
<a href="#l5.1114"></a><span id="l5.1114" class="difflineplus">+        sortLabelNode.textContent = glodaFacetStrings.get(</span>
<a href="#l5.1115"></a><span id="l5.1115" class="difflineplus">+          &quot;glodaFacetView.results.message.sort.label&quot;);</span>
<a href="#l5.1116"></a><span id="l5.1116" class="difflineplus">+</span>
<a href="#l5.1117"></a><span id="l5.1117" class="difflineplus">+        let sortRelevanceNode = document.getAnonymousElementByAttribute(</span>
<a href="#l5.1118"></a><span id="l5.1118" class="difflineplus">+                          this, &quot;anonid&quot;, &quot;sort-relevance&quot;);</span>
<a href="#l5.1119"></a><span id="l5.1119" class="difflineplus">+        sortRelevanceNode.textContent = glodaFacetStrings.get(</span>
<a href="#l5.1120"></a><span id="l5.1120" class="difflineplus">+          &quot;glodaFacetView.results.message.sort.relevance&quot;);</span>
<a href="#l5.1121"></a><span id="l5.1121" class="difflineplus">+</span>
<a href="#l5.1122"></a><span id="l5.1122" class="difflineplus">+        let dis = this;</span>
<a href="#l5.1123"></a><span id="l5.1123" class="difflineplus">+        sortRelevanceNode.onclick = function() {</span>
<a href="#l5.1124"></a><span id="l5.1124" class="difflineplus">+          FacetContext.sortBy = '-dascore';</span>
<a href="#l5.1125"></a><span id="l5.1125" class="difflineplus">+          dis.updateSortLabels();</span>
<a href="#l5.1126"></a><span id="l5.1126" class="difflineplus">+        }</span>
<a href="#l5.1127"></a><span id="l5.1127" class="difflineplus">+</span>
<a href="#l5.1128"></a><span id="l5.1128" class="difflineplus">+        let sortDateNode = document.getAnonymousElementByAttribute(</span>
<a href="#l5.1129"></a><span id="l5.1129" class="difflineplus">+                          this, &quot;anonid&quot;, &quot;sort-date&quot;);</span>
<a href="#l5.1130"></a><span id="l5.1130" class="difflineplus">+        sortDateNode.textContent = glodaFacetStrings.get(</span>
<a href="#l5.1131"></a><span id="l5.1131" class="difflineplus">+          &quot;glodaFacetView.results.message.sort.date&quot;);</span>
<a href="#l5.1132"></a><span id="l5.1132" class="difflineplus">+        sortDateNode.onclick = function() {</span>
<a href="#l5.1133"></a><span id="l5.1133" class="difflineplus">+          FacetContext.sortBy = '-date';</span>
<a href="#l5.1134"></a><span id="l5.1134" class="difflineplus">+          dis.updateSortLabels();</span>
<a href="#l5.1135"></a><span id="l5.1135" class="difflineplus">+        }</span>
<a href="#l5.1136"></a><span id="l5.1136" class="difflineplus">+</span>
<a href="#l5.1137"></a><span id="l5.1137" class="difflineplus">+        this.updateSortLabels(FacetContext.sortBy);</span>
<a href="#l5.1138"></a><span id="l5.1138" class="difflineplus">+</span>
<a href="#l5.1139"></a><span id="l5.1139" class="difflineplus">+        let messagesNode = document.getAnonymousElementByAttribute(</span>
<a href="#l5.1140"></a><span id="l5.1140" class="difflineplus">+                             this, &quot;anonid&quot;, &quot;messages&quot;);</span>
<a href="#l5.1141"></a><span id="l5.1141" class="difflineplus">+        while (messagesNode.lastChild)</span>
<a href="#l5.1142"></a><span id="l5.1142" class="difflineplus">+          messagesNode.removeChild(messagesNode.lastChild);</span>
<a href="#l5.1143"></a><span id="l5.1143" class="difflineplus">+      try {</span>
<a href="#l5.1144"></a><span id="l5.1144" class="difflineplus">+        // -- Messages</span>
<a href="#l5.1145"></a><span id="l5.1145" class="difflineplus">+        for each (let [, message] in Iterator(aMessages)) {</span>
<a href="#l5.1146"></a><span id="l5.1146" class="difflineplus">+          let msgNode = document.createElement(&quot;message&quot;);</span>
<a href="#l5.1147"></a><span id="l5.1147" class="difflineplus">+          msgNode.message = message;</span>
<a href="#l5.1148"></a><span id="l5.1148" class="difflineplus">+          msgNode.setAttribute(&quot;class&quot;, &quot;message&quot;);</span>
<a href="#l5.1149"></a><span id="l5.1149" class="difflineplus">+          messagesNode.appendChild(msgNode);</span>
<a href="#l5.1150"></a><span id="l5.1150" class="difflineplus">+        }</span>
<a href="#l5.1151"></a><span id="l5.1151" class="difflineplus">+      } catch (e) {</span>
<a href="#l5.1152"></a><span id="l5.1152" class="difflineplus">+        logException(e);</span>
<a href="#l5.1153"></a><span id="l5.1153" class="difflineplus">+      }</span>
<a href="#l5.1154"></a><span id="l5.1154" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.1155"></a><span id="l5.1155" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.1156"></a><span id="l5.1156" class="difflineplus">+    &lt;method name=&quot;ensureNodeVisible&quot;&gt;</span>
<a href="#l5.1157"></a><span id="l5.1157" class="difflineplus">+      &lt;parameter name=&quot;messageIndex&quot;/&gt;</span>
<a href="#l5.1158"></a><span id="l5.1158" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.1159"></a><span id="l5.1159" class="difflineplus">+        let messagesNode = document.getAnonymousElementByAttribute(</span>
<a href="#l5.1160"></a><span id="l5.1160" class="difflineplus">+                             this, &quot;anonid&quot;, &quot;messages&quot;);</span>
<a href="#l5.1161"></a><span id="l5.1161" class="difflineplus">+        let message = messagesNode.childNodes[messageIndex];</span>
<a href="#l5.1162"></a><span id="l5.1162" class="difflineplus">+        window.scrollTo(0, $(message).position()['top']);</span>
<a href="#l5.1163"></a><span id="l5.1163" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.1164"></a><span id="l5.1164" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.1165"></a><span id="l5.1165" class="difflineplus">+      </span>
<a href="#l5.1166"></a><span id="l5.1166" class="difflineplus">+    &lt;method name=&quot;updateSortLabels&quot;&gt;</span>
<a href="#l5.1167"></a><span id="l5.1167" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.1168"></a><span id="l5.1168" class="difflineplus">+      try {</span>
<a href="#l5.1169"></a><span id="l5.1169" class="difflineplus">+        let sortBy = FacetContext.sortBy;</span>
<a href="#l5.1170"></a><span id="l5.1170" class="difflineplus">+        let sortRelevanceNode = document.getAnonymousElementByAttribute(</span>
<a href="#l5.1171"></a><span id="l5.1171" class="difflineplus">+                          this, &quot;anonid&quot;, &quot;sort-relevance&quot;);</span>
<a href="#l5.1172"></a><span id="l5.1172" class="difflineplus">+        let sortDateNode = document.getAnonymousElementByAttribute(</span>
<a href="#l5.1173"></a><span id="l5.1173" class="difflineplus">+                          this, &quot;anonid&quot;, &quot;sort-date&quot;);</span>
<a href="#l5.1174"></a><span id="l5.1174" class="difflineplus">+</span>
<a href="#l5.1175"></a><span id="l5.1175" class="difflineplus">+        if (sortBy == &quot;-dascore&quot;) {</span>
<a href="#l5.1176"></a><span id="l5.1176" class="difflineplus">+          sortRelevanceNode.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l5.1177"></a><span id="l5.1177" class="difflineplus">+          sortDateNode.removeAttribute(&quot;selected&quot;);</span>
<a href="#l5.1178"></a><span id="l5.1178" class="difflineplus">+        } else if (sortBy == &quot;-date&quot;) {</span>
<a href="#l5.1179"></a><span id="l5.1179" class="difflineplus">+          sortRelevanceNode.removeAttribute(&quot;selected&quot;);</span>
<a href="#l5.1180"></a><span id="l5.1180" class="difflineplus">+          sortDateNode.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l5.1181"></a><span id="l5.1181" class="difflineplus">+        }</span>
<a href="#l5.1182"></a><span id="l5.1182" class="difflineplus">+      } catch (e ) {</span>
<a href="#l5.1183"></a><span id="l5.1183" class="difflineplus">+        logException(e);</span>
<a href="#l5.1184"></a><span id="l5.1184" class="difflineplus">+      }</span>
<a href="#l5.1185"></a><span id="l5.1185" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.1186"></a><span id="l5.1186" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.1187"></a><span id="l5.1187" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l5.1188"></a><span id="l5.1188" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l5.1189"></a><span id="l5.1189" class="difflineplus">+</span>
<a href="#l5.1190"></a><span id="l5.1190" class="difflineplus">+&lt;binding id=&quot;result-message&quot;&gt;</span>
<a href="#l5.1191"></a><span id="l5.1191" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l5.1192"></a><span id="l5.1192" class="difflineplus">+    &lt;html:div class=&quot;message-header&quot;&gt;</span>
<a href="#l5.1193"></a><span id="l5.1193" class="difflineplus">+      &lt;html:div class=&quot;message-line&quot;&gt;</span>
<a href="#l5.1194"></a><span id="l5.1194" class="difflineplus">+        &lt;html:div class=&quot;message-meta&quot;&gt;</span>
<a href="#l5.1195"></a><span id="l5.1195" class="difflineplus">+          &lt;html:div anonid=&quot;addresses-group&quot; class=&quot;message-addresses-group&quot;&gt;</span>
<a href="#l5.1196"></a><span id="l5.1196" class="difflineplus">+            &lt;html:div anonid=&quot;author-group&quot; class=&quot;message-author-group&quot;&gt;</span>
<a href="#l5.1197"></a><span id="l5.1197" class="difflineplus">+              &lt;html:span anonid=&quot;from&quot; class=&quot;message-from-label&quot;&gt;&lt;/html:span&gt;</span>
<a href="#l5.1198"></a><span id="l5.1198" class="difflineplus">+              &lt;html:span anonid=&quot;author&quot; class=&quot;message-author&quot;&gt;&lt;/html:span&gt;</span>
<a href="#l5.1199"></a><span id="l5.1199" class="difflineplus">+            &lt;/html:div&gt;</span>
<a href="#l5.1200"></a><span id="l5.1200" class="difflineplus">+            &lt;html:div anonid=&quot;recipients-group&quot; class=&quot;message-recipients-group&quot;&gt;</span>
<a href="#l5.1201"></a><span id="l5.1201" class="difflineplus">+              &lt;html:span anonid=&quot;to&quot; class=&quot;message-to-label&quot;&gt;&lt;/html:span&gt;</span>
<a href="#l5.1202"></a><span id="l5.1202" class="difflineplus">+              &lt;html:div anonid=&quot;recipients&quot; class=&quot;message-recipients&quot;/&gt;</span>
<a href="#l5.1203"></a><span id="l5.1203" class="difflineplus">+              &lt;html:div anonid=&quot;date&quot; class=&quot;message-date&quot;&gt;&lt;/html:div&gt;</span>
<a href="#l5.1204"></a><span id="l5.1204" class="difflineplus">+              &lt;html:div anonid=&quot;attachments&quot; class=&quot;message-attachments&quot;&gt;&lt;/html:div&gt;</span>
<a href="#l5.1205"></a><span id="l5.1205" class="difflineplus">+            &lt;/html:div&gt;</span>
<a href="#l5.1206"></a><span id="l5.1206" class="difflineplus">+          &lt;/html:div&gt;</span>
<a href="#l5.1207"></a><span id="l5.1207" class="difflineplus">+        &lt;/html:div&gt;</span>
<a href="#l5.1208"></a><span id="l5.1208" class="difflineplus">+        &lt;html:div class=&quot;message-subject-group&quot;&gt;</span>
<a href="#l5.1209"></a><span id="l5.1209" class="difflineplus">+          &lt;html:span anonid=&quot;star&quot; class=&quot;message-star&quot;&gt;&lt;/html:span&gt;</span>
<a href="#l5.1210"></a><span id="l5.1210" class="difflineplus">+          &lt;html:span anonid=&quot;subject&quot; class=&quot;message-subject&quot;&gt;&lt;/html:span&gt;</span>
<a href="#l5.1211"></a><span id="l5.1211" class="difflineplus">+          &lt;html:span anonid=&quot;tags&quot; class=&quot;message-tags&quot;&gt;&lt;/html:span&gt;</span>
<a href="#l5.1212"></a><span id="l5.1212" class="difflineplus">+        &lt;/html:div&gt;</span>
<a href="#l5.1213"></a><span id="l5.1213" class="difflineplus">+      &lt;/html:div&gt;</span>
<a href="#l5.1214"></a><span id="l5.1214" class="difflineplus">+    &lt;/html:div&gt;</span>
<a href="#l5.1215"></a><span id="l5.1215" class="difflineplus">+    &lt;html:pre anonid=&quot;snippet&quot; class=&quot;message-body&quot;&gt;&lt;/html:pre&gt;</span>
<a href="#l5.1216"></a><span id="l5.1216" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l5.1217"></a><span id="l5.1217" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l5.1218"></a><span id="l5.1218" class="difflineplus">+    &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l5.1219"></a><span id="l5.1219" class="difflineplus">+      this.build();</span>
<a href="#l5.1220"></a><span id="l5.1220" class="difflineplus">+    ]]&gt;&lt;/constructor&gt;</span>
<a href="#l5.1221"></a><span id="l5.1221" class="difflineplus">+    &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l5.1222"></a><span id="l5.1222" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.1223"></a><span id="l5.1223" class="difflineplus">+        let message = this.message;</span>
<a href="#l5.1224"></a><span id="l5.1224" class="difflineplus">+        let dis = this;</span>
<a href="#l5.1225"></a><span id="l5.1225" class="difflineplus">+        function anonElem(aAnonId) {</span>
<a href="#l5.1226"></a><span id="l5.1226" class="difflineplus">+          return document.getAnonymousElementByAttribute(dis, &quot;anonid&quot;,</span>
<a href="#l5.1227"></a><span id="l5.1227" class="difflineplus">+                                                         aAnonId);</span>
<a href="#l5.1228"></a><span id="l5.1228" class="difflineplus">+        }</span>
<a href="#l5.1229"></a><span id="l5.1229" class="difflineplus">+</span>
<a href="#l5.1230"></a><span id="l5.1230" class="difflineplus">+        // -- eventify</span>
<a href="#l5.1231"></a><span id="l5.1231" class="difflineplus">+        this.onclick = function(aEvent) {</span>
<a href="#l5.1232"></a><span id="l5.1232" class="difflineplus">+          FacetContext.showConversationInTab(message,</span>
<a href="#l5.1233"></a><span id="l5.1233" class="difflineplus">+                                             aEvent.button == 1);</span>
<a href="#l5.1234"></a><span id="l5.1234" class="difflineplus">+        }</span>
<a href="#l5.1235"></a><span id="l5.1235" class="difflineplus">+</span>
<a href="#l5.1236"></a><span id="l5.1236" class="difflineplus">+        // -- Content Poking</span>
<a href="#l5.1237"></a><span id="l5.1237" class="difflineplus">+        anonElem(&quot;subject&quot;).textContent = message.subject;</span>
<a href="#l5.1238"></a><span id="l5.1238" class="difflineplus">+        let authorNode = anonElem(&quot;author&quot;);</span>
<a href="#l5.1239"></a><span id="l5.1239" class="difflineplus">+        authorNode.setAttribute(&quot;title&quot;, message.from.value);</span>
<a href="#l5.1240"></a><span id="l5.1240" class="difflineplus">+        authorNode.textContent = message.from.contact.name</span>
<a href="#l5.1241"></a><span id="l5.1241" class="difflineplus">+        let fromNode = anonElem(&quot;from&quot;);</span>
<a href="#l5.1242"></a><span id="l5.1242" class="difflineplus">+        fromNode.textContent = glodaFacetStrings.get(&quot;glodaFacetView.result.message.fromLabel&quot;);</span>
<a href="#l5.1243"></a><span id="l5.1243" class="difflineplus">+        let toNode = anonElem(&quot;to&quot;);</span>
<a href="#l5.1244"></a><span id="l5.1244" class="difflineplus">+        toNode.textContent = glodaFacetStrings.get(&quot;glodaFacetView.result.message.toLabel&quot;);</span>
<a href="#l5.1245"></a><span id="l5.1245" class="difflineplus">+</span>
<a href="#l5.1246"></a><span id="l5.1246" class="difflineplus">+        //anonElem(&quot;author&quot;).textContent = ;</span>
<a href="#l5.1247"></a><span id="l5.1247" class="difflineplus">+        anonElem(&quot;date&quot;).textContent = makeFriendlyDateAgo(message.date);</span>
<a href="#l5.1248"></a><span id="l5.1248" class="difflineplus">+</span>
<a href="#l5.1249"></a><span id="l5.1249" class="difflineplus">+        // - Recipients</span>
<a href="#l5.1250"></a><span id="l5.1250" class="difflineplus">+      try {</span>
<a href="#l5.1251"></a><span id="l5.1251" class="difflineplus">+        let recipientsNode = anonElem(&quot;recipients&quot;);</span>
<a href="#l5.1252"></a><span id="l5.1252" class="difflineplus">+        if (message.recipients) {</span>
<a href="#l5.1253"></a><span id="l5.1253" class="difflineplus">+          let recipientCount = 0;</span>
<a href="#l5.1254"></a><span id="l5.1254" class="difflineplus">+          const MAX_RECIPIENTS = 3;</span>
<a href="#l5.1255"></a><span id="l5.1255" class="difflineplus">+          let totalRecipientCount = message.recipients.length;</span>
<a href="#l5.1256"></a><span id="l5.1256" class="difflineplus">+          for each (let [, recip] in Iterator(message.recipients)) {</span>
<a href="#l5.1257"></a><span id="l5.1257" class="difflineplus">+            let recipNode = document.createElement(&quot;span&quot;);</span>
<a href="#l5.1258"></a><span id="l5.1258" class="difflineplus">+            recipNode.setAttribute(&quot;class&quot;, &quot;message-recipient&quot;);</span>
<a href="#l5.1259"></a><span id="l5.1259" class="difflineplus">+            recipNode.textContent = recip.contact.name;</span>
<a href="#l5.1260"></a><span id="l5.1260" class="difflineplus">+            recipNode.setAttribute(&quot;title&quot;, &quot;BARGH&quot;);</span>
<a href="#l5.1261"></a><span id="l5.1261" class="difflineplus">+            recipientsNode.appendChild(recipNode);</span>
<a href="#l5.1262"></a><span id="l5.1262" class="difflineplus">+            recipientCount++;</span>
<a href="#l5.1263"></a><span id="l5.1263" class="difflineplus">+            if (recipientCount == MAX_RECIPIENTS)</span>
<a href="#l5.1264"></a><span id="l5.1264" class="difflineplus">+              break;</span>
<a href="#l5.1265"></a><span id="l5.1265" class="difflineplus">+          }</span>
<a href="#l5.1266"></a><span id="l5.1266" class="difflineplus">+          if (totalRecipientCount &gt; MAX_RECIPIENTS) {</span>
<a href="#l5.1267"></a><span id="l5.1267" class="difflineplus">+            let nOthers = totalRecipientCount - recipientCount;</span>
<a href="#l5.1268"></a><span id="l5.1268" class="difflineplus">+            let andNOthers = document.createElement(&quot;span&quot;);</span>
<a href="#l5.1269"></a><span id="l5.1269" class="difflineplus">+            andNOthers.setAttribute(&quot;class&quot;, &quot;message-recipients-andothers&quot;);</span>
<a href="#l5.1270"></a><span id="l5.1270" class="difflineplus">+</span>
<a href="#l5.1271"></a><span id="l5.1271" class="difflineplus">+            let andOthersLabel= PluralForm.get(nOthers, glodaFacetStrings.get(</span>
<a href="#l5.1272"></a><span id="l5.1272" class="difflineplus">+                              &quot;glodaFacetView.results.message.andNOthers&quot;))</span>
<a href="#l5.1273"></a><span id="l5.1273" class="difflineplus">+                             .replace(&quot;#1&quot;, nOthers);</span>
<a href="#l5.1274"></a><span id="l5.1274" class="difflineplus">+</span>
<a href="#l5.1275"></a><span id="l5.1275" class="difflineplus">+            andNOthers.textContent = andOthersLabel;</span>
<a href="#l5.1276"></a><span id="l5.1276" class="difflineplus">+            recipientsNode.appendChild(andNOthers);</span>
<a href="#l5.1277"></a><span id="l5.1277" class="difflineplus">+          }</span>
<a href="#l5.1278"></a><span id="l5.1278" class="difflineplus">+        }</span>
<a href="#l5.1279"></a><span id="l5.1279" class="difflineplus">+      } catch (e) {</span>
<a href="#l5.1280"></a><span id="l5.1280" class="difflineplus">+        logException(e);</span>
<a href="#l5.1281"></a><span id="l5.1281" class="difflineplus">+      }</span>
<a href="#l5.1282"></a><span id="l5.1282" class="difflineplus">+</span>
<a href="#l5.1283"></a><span id="l5.1283" class="difflineplus">+        // - Starred</span>
<a href="#l5.1284"></a><span id="l5.1284" class="difflineplus">+        let starNode = anonElem(&quot;star&quot;);</span>
<a href="#l5.1285"></a><span id="l5.1285" class="difflineplus">+        if (message.starred) {</span>
<a href="#l5.1286"></a><span id="l5.1286" class="difflineplus">+          starNode.setAttribute(&quot;starred&quot;, &quot;true&quot;)</span>
<a href="#l5.1287"></a><span id="l5.1287" class="difflineplus">+        }</span>
<a href="#l5.1288"></a><span id="l5.1288" class="difflineplus">+</span>
<a href="#l5.1289"></a><span id="l5.1289" class="difflineplus">+        // - Attachments</span>
<a href="#l5.1290"></a><span id="l5.1290" class="difflineplus">+        if (message.attachmentNames) {</span>
<a href="#l5.1291"></a><span id="l5.1291" class="difflineplus">+          let attachmentsNode = anonElem(&quot;attachments&quot;);</span>
<a href="#l5.1292"></a><span id="l5.1292" class="difflineplus">+          let imgNode = document.createElement(&quot;div&quot;);</span>
<a href="#l5.1293"></a><span id="l5.1293" class="difflineplus">+          imgNode.setAttribute(&quot;class&quot;, &quot;message-attachment-icon&quot;);</span>
<a href="#l5.1294"></a><span id="l5.1294" class="difflineplus">+          attachmentsNode.appendChild(imgNode);</span>
<a href="#l5.1295"></a><span id="l5.1295" class="difflineplus">+          for each (let [, attach] in Iterator(message.attachmentNames)) {</span>
<a href="#l5.1296"></a><span id="l5.1296" class="difflineplus">+            let attachNode = document.createElement(&quot;div&quot;);</span>
<a href="#l5.1297"></a><span id="l5.1297" class="difflineplus">+            attachNode.setAttribute(&quot;class&quot;, &quot;message-attachment&quot;);</span>
<a href="#l5.1298"></a><span id="l5.1298" class="difflineplus">+            attachNode.textContent = attach;</span>
<a href="#l5.1299"></a><span id="l5.1299" class="difflineplus">+            attachmentsNode.appendChild(attachNode);</span>
<a href="#l5.1300"></a><span id="l5.1300" class="difflineplus">+          }</span>
<a href="#l5.1301"></a><span id="l5.1301" class="difflineplus">+        }</span>
<a href="#l5.1302"></a><span id="l5.1302" class="difflineplus">+</span>
<a href="#l5.1303"></a><span id="l5.1303" class="difflineplus">+        // - Tags</span>
<a href="#l5.1304"></a><span id="l5.1304" class="difflineplus">+        let tagsNode = anonElem(&quot;tags&quot;);</span>
<a href="#l5.1305"></a><span id="l5.1305" class="difflineplus">+        if (&quot;tags&quot; in message &amp;&amp; message.tags.length) {</span>
<a href="#l5.1306"></a><span id="l5.1306" class="difflineplus">+          let _msgTagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;].</span>
<a href="#l5.1307"></a><span id="l5.1307" class="difflineplus">+                                    getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l5.1308"></a><span id="l5.1308" class="difflineplus">+          for each (let [, tag] in Iterator(message.tags)) {</span>
<a href="#l5.1309"></a><span id="l5.1309" class="difflineplus">+            let tagNode = document.createElement(&quot;span&quot;);</span>
<a href="#l5.1310"></a><span id="l5.1310" class="difflineplus">+            let colorClass = &quot;blc-&quot; + _msgTagService.getColorForKey(tag.key).substr(1);</span>
<a href="#l5.1311"></a><span id="l5.1311" class="difflineplus">+            tagNode.setAttribute(&quot;class&quot;, &quot;message-tag tag &quot; + colorClass);</span>
<a href="#l5.1312"></a><span id="l5.1312" class="difflineplus">+            tagNode.textContent = tag.tag;</span>
<a href="#l5.1313"></a><span id="l5.1313" class="difflineplus">+            tagsNode.appendChild(tagNode);</span>
<a href="#l5.1314"></a><span id="l5.1314" class="difflineplus">+          }</span>
<a href="#l5.1315"></a><span id="l5.1315" class="difflineplus">+        }</span>
<a href="#l5.1316"></a><span id="l5.1316" class="difflineplus">+</span>
<a href="#l5.1317"></a><span id="l5.1317" class="difflineplus">+        // - Body</span>
<a href="#l5.1318"></a><span id="l5.1318" class="difflineplus">+        if (message.indexedBodyText) {</span>
<a href="#l5.1319"></a><span id="l5.1319" class="difflineplus">+          let bodyText = message.indexedBodyText;</span>
<a href="#l5.1320"></a><span id="l5.1320" class="difflineplus">+          // start assuming it's just one line that we want to show</span>
<a href="#l5.1321"></a><span id="l5.1321" class="difflineplus">+          let idxNewline = -1;</span>
<a href="#l5.1322"></a><span id="l5.1322" class="difflineplus">+          let ellipses = &quot;…&quot;;</span>
<a href="#l5.1323"></a><span id="l5.1323" class="difflineplus">+          for (let newlineCount = 0; newlineCount &lt; 5; newlineCount++) {</span>
<a href="#l5.1324"></a><span id="l5.1324" class="difflineplus">+            let idxNextNewline = bodyText.indexOf(&quot;\n&quot;, idxNewline+1);</span>
<a href="#l5.1325"></a><span id="l5.1325" class="difflineplus">+            if (idxNextNewline == -1) {</span>
<a href="#l5.1326"></a><span id="l5.1326" class="difflineplus">+              ellipses = '';</span>
<a href="#l5.1327"></a><span id="l5.1327" class="difflineplus">+              break;</span>
<a href="#l5.1328"></a><span id="l5.1328" class="difflineplus">+            }</span>
<a href="#l5.1329"></a><span id="l5.1329" class="difflineplus">+            idxNewline = idxNextNewline;</span>
<a href="#l5.1330"></a><span id="l5.1330" class="difflineplus">+          }</span>
<a href="#l5.1331"></a><span id="l5.1331" class="difflineplus">+          let snippet = &quot;&quot;;</span>
<a href="#l5.1332"></a><span id="l5.1332" class="difflineplus">+          if (idxNewline &gt; -1)</span>
<a href="#l5.1333"></a><span id="l5.1333" class="difflineplus">+            snippet = bodyText.substring(0, idxNewline);</span>
<a href="#l5.1334"></a><span id="l5.1334" class="difflineplus">+          else</span>
<a href="#l5.1335"></a><span id="l5.1335" class="difflineplus">+            snippet = bodyText;</span>
<a href="#l5.1336"></a><span id="l5.1336" class="difflineplus">+          if (ellipses)</span>
<a href="#l5.1337"></a><span id="l5.1337" class="difflineplus">+            snippet = snippet.replace(/\s+$/, '') + ellipses;</span>
<a href="#l5.1338"></a><span id="l5.1338" class="difflineplus">+          anonElem(&quot;snippet&quot;).textContent = snippet;</span>
<a href="#l5.1339"></a><span id="l5.1339" class="difflineplus">+        }</span>
<a href="#l5.1340"></a><span id="l5.1340" class="difflineplus">+</span>
<a href="#l5.1341"></a><span id="l5.1341" class="difflineplus">+        // - Misc attributes</span>
<a href="#l5.1342"></a><span id="l5.1342" class="difflineplus">+        if (!message.read)</span>
<a href="#l5.1343"></a><span id="l5.1343" class="difflineplus">+          this.setAttribute(&quot;unread&quot;, &quot;true&quot;);</span>
<a href="#l5.1344"></a><span id="l5.1344" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l5.1345"></a><span id="l5.1345" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l5.1346"></a><span id="l5.1346" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l5.1347"></a><span id="l5.1347" class="difflineplus">+  &lt;handlers&gt;</span>
<a href="#l5.1348"></a><span id="l5.1348" class="difflineplus">+    &lt;handler event=&quot;mouseover&quot;&gt;&lt;![CDATA[</span>
<a href="#l5.1349"></a><span id="l5.1349" class="difflineplus">+      FacetContext.hoverFacet(FacetContext.fakeResultFaceter,</span>
<a href="#l5.1350"></a><span id="l5.1350" class="difflineplus">+                              FacetContext.fakeResultAttr,</span>
<a href="#l5.1351"></a><span id="l5.1351" class="difflineplus">+                              this.message, [this.message]);</span>
<a href="#l5.1352"></a><span id="l5.1352" class="difflineplus">+    ]]&gt;&lt;/handler&gt;</span>
<a href="#l5.1353"></a><span id="l5.1353" class="difflineplus">+    &lt;handler event=&quot;mouseout&quot;&gt;&lt;![CDATA[</span>
<a href="#l5.1354"></a><span id="l5.1354" class="difflineplus">+      FacetContext.unhoverFacet(FacetContext.fakeResultFaceter,</span>
<a href="#l5.1355"></a><span id="l5.1355" class="difflineplus">+                                FacetContext.fakeResultAttr,</span>
<a href="#l5.1356"></a><span id="l5.1356" class="difflineplus">+                                this.message, [this.message]);</span>
<a href="#l5.1357"></a><span id="l5.1357" class="difflineplus">+    ]]&gt;&lt;/handler&gt;</span>
<a href="#l5.1358"></a><span id="l5.1358" class="difflineplus">+  &lt;/handlers&gt;</span>
<a href="#l5.1359"></a><span id="l5.1359" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l5.1360"></a><span id="l5.1360" class="difflineplus">+</span>
<a href="#l5.1361"></a><span id="l5.1361" class="difflineplus">+&lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mail/base/content/glodaFacetTab.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,70 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/gloda/facet.js&quot;);</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+// needed by search.xml to use us</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/gloda/msg_search.js&quot;);</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+var glodaFacetTabType = {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  name: &quot;glodaFacet&quot;,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  perTabPanel: &quot;iframe&quot;,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  strings:</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+    new StringBundle(&quot;chrome://messenger/locale/glodaFacetView.properties&quot;),</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+  modes: {</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+    glodaFacet: {</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+      // this is what get exposed on the tab for icon purposes</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+      type: &quot;glodaSearch&quot;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+    }</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  },</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  openTab: function glodaFacetTabType_openTab(aTab, aArgs) {</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+    // we have no browser until our XUL document loads</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+    aTab.browser = null;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+    if (&quot;query&quot; in aArgs) {</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+      aTab.query = aArgs.query;</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+      aTab.collection = aTab.query.getCollection();</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+      aTab.title = this.strings.get(&quot;glodaFacetView.tab.query.label&quot;);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+      aTab.searchString = null;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+    }</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+    else if (&quot;searcher&quot; in aArgs) {</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+      aTab.searcher = aArgs.searcher;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+      aTab.collection = aTab.searcher.getCollection();</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+      aTab.query = aTab.searcher.query;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+      let searchString = aTab.searcher.searchString;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+      aTab.title = aTab.searchInputValue = aTab.searchString =</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+        searchString;</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+    }</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+    else if (&quot;collection&quot; in aArgs) {</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+      aTab.collection = aArgs.collection;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+      aTab.title = this.strings.get(&quot;glodaFacetView.tab.query.label&quot;);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+      aTab.searchString = null;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+    }</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+    function xulLoadHandler() {</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+      aTab.panel.contentWindow.removeEventListener(&quot;load&quot;, xulLoadHandler,</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+                                                   false);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+      aTab.panel.contentWindow.tab = aTab;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+      aTab.browser = aTab.panel.contentDocument.getElementById(&quot;browser&quot;);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+      aTab.browser.setAttribute(&quot;src&quot;,</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+        &quot;chrome://messenger/content/glodaFacetView.xhtml&quot;);</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+    }</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+    aTab.panel.contentWindow.addEventListener(&quot;load&quot;, xulLoadHandler, false);</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+    aTab.panel.setAttribute(&quot;src&quot;,</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+      &quot;chrome://messenger/content/glodaFacetViewWrapper.xul&quot;);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+  },</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  closeTab: function glodaFacetTabType_closeTab(aTab) {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  },</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  saveTabState: function glodaFacetTabType_saveTabState(aTab) {</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+    // nothing to do; we are not multiplexed</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  },</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  showTab: function glodaFacetTabType_showTab(aTab) {</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+    // nothing to do; we are not multiplexed</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+  },</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  getBrowser: function(aTab) {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+    return aTab.browser;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  }</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+};</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mail/base/content/glodaFacetView.css</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,577 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * The Original Code is Thunderbird Global Database.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ *   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ *   Bryan Clark &lt;clarkbw@gnome.org&gt;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ *</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+ *</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+html {</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  background:white;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+}</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+body {</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+  padding: 0;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  margin: 0;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  font-family: sans-serif;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+  background: white;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+}</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+#table {</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+  display: table;</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  width: 100%;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  height: 100%;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  position: relative;</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  background: white;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+}</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+.facets-sidebar {</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  display: table-cell;</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  width: 20em;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  background-color: #eeeeee;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+  padding: 4px;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  height: 100%;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  padding-left: 1em;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  font-size: 90%;</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+}</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+#main-column {</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+  padding-left: 1em;</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  display: table-cell;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+}</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+/* ===== Query Explanation ===== */</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+#query-explanation {</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+  display: block;</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+  height: 40px;</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+  font-size: 140% !important;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+  margin-left: 1em;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+  padding: 2px;</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+  padding-left: 0;</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+  padding-top: 1em;</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+}</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+.explanation-fulltext-label {</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+  color: #3465a4;</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  margin: 0 0.1em;</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+}</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+.explanation-fulltext-term {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+  color: black;</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  margin: 0 0.1em;</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+}</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+.explanation-fulltext-criteria {</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+  color: #888;</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+  margin: 0 0.1em;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+}</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+.explanation-query-label {</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+  margin-top: 1ex;</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+}</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+.explanation-query-label,</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+.explanation-query-involves,</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+.explanation-query-tagged {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+  color: #3465a4;</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+  margin-right: 0.5ex;</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+}</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+/* ===== Facets ===== */</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+h1, h2, h3 {</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  color: #555753;</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+}</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+#filter-header-label {</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+  margin: 0;</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+  margin-top: 1em;</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+}</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+.explanation-change-label {</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  display: inline-block;</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+  color: black;</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+  font-size: 60%;</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+  padding: 3px;</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+  margin: 0 0.1em;</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+  margin-left: 1em;</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  border: 1px solid grey;</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+  -moz-border-radius: 4px;</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+}</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+.explanation-change-label:hover {</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+  cursor: pointer;</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+  background-color: #aed5ff;</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+}</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+.facetious[uninitialized] {</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+  display: none;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+}</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+.facetious {</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+  display: inline-block;</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+  padding: 2px;</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+}</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+h1 {</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+  font-size: x-large !important;</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+  padding-bottom: 0.5em;</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+}</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+h2 {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+  display: block;</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+  margin: 0;</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+  font-size: 120%;</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+  margin-top: 1em;</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+  margin-bottom: 0.5em;</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+}</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+h3 {</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+  font-weight: normal;</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+}</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+.facet &gt; h3,</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+.facet-content &gt; h3 {</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+  font-size: 105%;</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+  padding-left: 0em;</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+  margin-top: 0.5em;</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+  margin-bottom: 0.5em;</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+}</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+.facet-included-header[state=&quot;empty&quot;],</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+.facet-excluded-header[state=&quot;empty&quot;],</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+.facet-remaindered-header[needed=&quot;false&quot;] {</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+  display: none;</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+}</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+.facet-included-header[state=&quot;empty&quot;] + .facet-included,</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+.facet-excluded-header[state=&quot;empty&quot;] + .facet-excluded,</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+.facet-remaindered:empty {</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  display: none;</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+}</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+#facet-date {</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+  display: block;</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+  padding: 0px;</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+  padding-top: 0.5em;</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+  height: 80px;</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+  margin-right: 1em;</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+  padding-left: 2em;</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+  padding-bottom: 1em;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+}</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+/* === Boolean Facet === */</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+.facetious[type=&quot;boolean&quot;][disabled] {</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+  color: #888888;</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+}</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+.facet-checkbox-bubble {</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+  padding: 2px;</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+  padding-right: 6px;</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+  border: solid transparent 1px;</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+  cursor: pointer;</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+  color: #333;</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+  font-size: 90%;</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+}</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+.facetious[type=&quot;boolean&quot;][disabled] &gt; .facet-checkbox-bubble,</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+.facetious[type=&quot;boolean-filtered&quot;][disabled] &gt; .facet-checkbox-bubble {</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+  cursor: default;</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+  color: #777;</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+}</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+.facetious[type=&quot;boolean&quot;]:not([disabled]):hover &gt; .facet-checkbox-bubble,</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+.facetious[type=&quot;boolean-filtered&quot;]:not([disabled]):hover &gt; .facet-checkbox-bubble {</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+  background-color: #aed5ff;</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+  border: solid #3465a4 1px;</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+  -moz-border-radius: 4px;</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+}</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+.facet-checkbox-label {</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+}</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+.facet-checkbox-count {</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+}</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+.facet-checkbox-count:before {</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+  content: &quot; (&quot;;</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+}</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+.facet-checkbox-count:after {</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+  content: &quot;)&quot;;</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+}</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+/* === Boolean Filtered === */</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+.facetious[type=&quot;boolean-filtered&quot;]:not([checked]) &gt; .facet-filter-list {</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+  display: none</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+}</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+.facet-filter-list {</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+  display: block;</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+}</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+/* === Discrete Facet === */</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+.facet-content {</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+  max-height: 32em;</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+  overflow: auto;</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+}</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+.facet-more[needed=&quot;false&quot;] {</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+  display: none;</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+}</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+.facet-more[needed=&quot;true&quot;] {</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+}</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+.bar {</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+  display: block;</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+}</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+.bar-count {</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+  position: absolute;</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+  right: 3px;</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+  margin-right: 1.5em;</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+  line-height: 1.6em;</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+}</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+.barry {</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+  border-top: 1px solid #ccc;</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+  margin: 0;</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+  padding: 0; </span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+  /*padding: 4px;*/</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+}</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+.bar {</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+  display: block;</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+  position: relative;</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineplus">+  border-bottom: 1px solid #ccc;</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineplus">+  cursor: pointer;</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+  font-size: 80%;</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+}</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+.bar:hover {</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+  background: #e2e2e2;</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+}</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+.bar-link {</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+  display: inline-block;</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+  color: #2D7BB2;</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+  text-decoration: none;</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+  display: block;</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+  padding: 0.3em 2em 0.3em 0.5em;</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+  padding-right: 4em;</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+  position: relative;</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+  z-index: 2;</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+}</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+.bar:hover &gt; .bar-link {</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+  color: #333;</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+}</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+.bar-percent {</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+  display: block;</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+  position: absolute;</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+  top: 0;</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+  left: 0;</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+  height: 100%;</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+  background: #e9f2f5;</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+  text-indent: -9999px;</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+  overflow: hidden;</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+  line-height: 1.6em;</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+}</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+.bar:hover &gt; .bar-percent {</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+  background: #ceeaf5;</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+}</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+.bar-exclude {</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+  display: block;</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+  visibility: hidden;</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/icons/exclude.png&quot;);</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+  position: absolute;</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+  top: 0.3em;</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+  right: 2px;</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+  width: 12px;</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+  height: 12px;</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+  z-index: 3;</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+}</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+.bar[variety=&quot;remainder&quot;]:hover &gt; .bar-exclude {</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+  visibility: visible;</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+}</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+.bar-exclude:hover {</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/icons/exclude-selected.png&quot;);</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+}</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+/* ===== Results ===== */</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineplus">+.results {</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+  margin-left: 0.5em;</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+  margin-top: 2em;</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+  max-width: 40em;</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+}</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+.results-message-header {</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+  background-color: #dcddde;</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+  border-top: 2px solid #ccc;</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineplus">+  padding: 2px;</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineplus">+  margin-right: 0.5em;</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineplus">+  margin-bottom: 0.5em;</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+  position: relative;</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineplus">+}</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineplus">+</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineplus">+.results-message-count {</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineplus">+  display: inline;</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineplus">+  margin: 0;</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineplus">+  margin-left: 0.5em;</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineplus">+  font-size: medium;</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineplus">+}</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineplus">+.results-message-showall {</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineplus">+  margin-left: 1em;</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineplus">+  cursor: pointer;</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+  font-size: 80%;</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineplus">+  padding-right: 14em;</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineplus">+}</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineplus">+</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineplus">+.results-message-sort-bar {</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineplus">+  position: absolute;</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineplus">+  right: 1em;</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineplus">+  top: 0;</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+  line-height: 1.8em; /* not right approach */</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+  font-size: 80%;</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+  </span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+}</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineplus">+.results-message-sort-label {</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+  color: grey;</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+}</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+.results-message-sort-value:hover {</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+  text-decoration: underline;</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+  cursor: pointer;</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+}</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+.results-message-sort-value[selected=&quot;true&quot;] {</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+  font-weight: bold;</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+}</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+.results-message-showall:hover {</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+  text-decoration: underline;</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+}</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+/* ===== Messages ===== */</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+.message {</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+  display: block;</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+  font-family: sans-serif;</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+  font-size: 80%;</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+  padding-top: 3px;</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+  padding-bottom: 3px;</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+  margin-right: 1em;</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+  border: 1px solid transparent;</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+  -moz-border-radius: 3px;</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+  border-bottom: 1px solid #ddd;</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+  display: block;</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+  color: #555;</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineplus">+  background-color: #ffffff;</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineplus">+}</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineplus">+</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineplus">+.message:hover {</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineplus">+  border-color: #d8d8d8;</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineplus">+  background: #f8f8f8;</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineplus">+  cursor: pointer;</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+}</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineplus">+</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineplus">+.message:hover .message-subject {</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineplus">+  color:#0a0a5a;</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineplus">+  text-decoration: underline;</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineplus">+}</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineplus">+.message:focus {</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+  border: 1px dotted #111;</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+  padding: 1em 0px;</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+}</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+.message[unread=&quot;true&quot;]:focus {</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+  border: 1px dotted #111;</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineplus">+  padding: 1em 0px;</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineplus">+}</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+.message:focus:last-child {</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+  border: 1px dotted #111;</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+  padding: 1em 0px;</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+}</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineplus">+.message:focus:first-child {</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineplus">+  border: 1px dotted #111;</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineplus">+  padding: 1em 0px;</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineplus">+}</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineplus">+.message:last-child {</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineplus">+  border-bottom: 1px solid transparent;</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+}</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+.message:last-child:hover {</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineplus">+  border-bottom: 1px solid;</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineplus">+}</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineplus">+</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineplus">+</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineplus">+.message {</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+  display: block;</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+  padding: 0.2em 0em;</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+}</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+.message-header,</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+.message-body {</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+  font-size: 95%;</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineplus">+}</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineplus">+</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+.message-header {</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+  margin-bottom: 0.5em;</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineplus">+}</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineplus">+.message-meta {</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+  float: right;</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineplus">+  padding-left: 2em;</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineplus">+  text-align: right;</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineplus">+  max-width: 20em;</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineplus">+  max-height: 5em;</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineplus">+  overflow: hidden;</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+  color: #999;</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+  font-size: 90%;</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+}</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+.message-attachments {</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+}</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+.message-attachment {</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineplus">+  display: inline-block;</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineplus">+}</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineplus">+</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineplus">+.message-attachment-icon {</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineplus">+  display: inline-block;</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineplus">+  width: 18px;</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineplus">+  height: 18px;</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineplus">+  background: url(&quot;chrome://messenger/skin/icons/attachment.png&quot;) transparent no-repeat center right;</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineplus">+}</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineplus">+</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineplus">+.message-line {</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineplus">+  position: relative;</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineplus">+}</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineplus">+</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineplus">+.message-addresses-group {</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineplus">+  text-align: right;</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineplus">+}</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineplus">+</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineplus">+.message-date {</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineplus">+  color: #999;</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineplus">+}</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineplus">+</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineplus">+.message-star[starred=&quot;true&quot;] {</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineplus">+  display: inline-block;</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineplus">+  width: 12px !important;</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineplus">+  height: 12px;</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/icons/flag-col.png&quot;);</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineplus">+}</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineplus">+</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineplus">+.message-addresses-group {</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineplus">+  padding-left: 1em;</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineplus">+  padding-right: 0.5em;</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineplus">+}</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineplus">+</span>
<a href="#l7.521"></a><span id="l7.521" class="difflineplus">+.message-subject-group {</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineplus">+  padding-left: .5em;</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineplus">+}</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineplus">+</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineplus">+.message-author, .message-recipients {</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineplus">+  text-align: right;</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineplus">+  display: inline;</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineplus">+  color: #222;</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineplus">+}</span>
<a href="#l7.530"></a><span id="l7.530" class="difflineplus">+</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineplus">+.message-recipient:first-child:before {</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineplus">+  content: &quot;&quot;;</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineplus">+}</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineplus">+.message-recipient:after {</span>
<a href="#l7.535"></a><span id="l7.535" class="difflineplus">+  content: &quot;, &quot;;</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineplus">+}</span>
<a href="#l7.537"></a><span id="l7.537" class="difflineplus">+.message-recipient:last-child:after {</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineplus">+  content: &quot;&quot;;</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineplus">+}</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineplus">+</span>
<a href="#l7.541"></a><span id="l7.541" class="difflineplus">+.message-subject {</span>
<a href="#l7.542"></a><span id="l7.542" class="difflineplus">+  font-size: 115%;</span>
<a href="#l7.543"></a><span id="l7.543" class="difflineplus">+  font-weight: bold;</span>
<a href="#l7.544"></a><span id="l7.544" class="difflineplus">+  line-height: 1.2em;</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineplus">+  color: #555;</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineplus">+}</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineplus">+.message-body {</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineplus">+  color: black;</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineplus">+  padding-left: 1em;</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineplus">+  font-family: monospace;</span>
<a href="#l7.551"></a><span id="l7.551" class="difflineplus">+  font-size: 120%;</span>
<a href="#l7.552"></a><span id="l7.552" class="difflineplus">+  white-space: pre-wrap;</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineplus">+}</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineplus">+</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineplus">+.message-tag {</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineplus">+  display: inline-block; /* to avoid splitting 'To' and 'Do' e.g. */</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineplus">+  -moz-margin-start: 0px;</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/tagbg.png&quot;);</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineplus">+  color: black;</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineplus">+  -moz-border-radius: 2px;</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineplus">+  padding: 1px 3px;</span>
<a href="#l7.562"></a><span id="l7.562" class="difflineplus">+  margin-right: 3px;</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineplus">+}</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineplus">+.message-folder {</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineplus">+  background-color: #faf0b8;</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineplus">+  border: 1px solid #ede4af;</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineplus">+}</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineplus">+</span>
<a href="#l7.569"></a><span id="l7.569" class="difflineplus">+.show-more {</span>
<a href="#l7.570"></a><span id="l7.570" class="difflineplus">+  font-size: small;</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineplus">+  text-align: right;</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineplus">+  margin-right: 1em;</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineplus">+  margin-bottom: 2em;</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineplus">+  color: #3465a4;</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineplus">+  font-weight: bold;</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineplus">+}</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineplus">+</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineplus">+.show-more:hover {</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineplus">+  text-decoration: underline;</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineplus">+  cursor: pointer;</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineplus">+}</span>
<a href="#l7.582"></a><span id="l7.582">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mail/base/content/glodaFacetView.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,801 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ *</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ *</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ * License.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ *</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ * The Original Code is Thunderbird Global Database.</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ *</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ *</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+ *</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ *</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+/*</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+ * This file provides the global context for the faceting environment.  In the</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+ *  Model View Controller (paradigm), we are the view and the XBL widgets are</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+ *  the the view and controller.</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+ *</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+ * Because much of the work related to faceting is not UI-specific, we try and</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+ *  push as much of it into mailnews/db/gloda/facet.js.  In some cases we may</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+ *  get it wrong and it may eventually want to migrate.</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+ */</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+Cu.import(&quot;resource://app/modules/PluralForm.jsm&quot;);</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+Cu.import(&quot;resource://app/modules/errUtils.js&quot;);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+Cu.import(&quot;resource://app/modules/templateUtils.js&quot;);</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/public.js&quot;);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/facet.js&quot;);</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+const glodaFacetStrings =</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  new StringBundle(&quot;chrome://messenger/locale/glodaFacetView.properties&quot;);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+/**</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+ * Represents the active constraints on a singular facet.  Singular facets can</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+ *  only have an inclusive set or an exclusive set, but not both.  Non-singular</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+ *  facets can have both.  Because they are different worlds, non-singular gets</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+ *  its own class, |ActiveNonSingularConstraint|.</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+ */</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+function ActiveSingularConstraint(aFaceter, aAttrDef, aRanged) {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  this.faceter = aFaceter;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+  this.attrDef = aAttrDef;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+  this.ranged = Boolean(aRanged);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+  this.clear();</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+}</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+ActiveSingularConstraint.prototype = {</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  _makeQuery: function() {</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+    // have the faceter make the query and the invert decision for us if it</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+    //  implements the makeQuery method.</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+    if (&quot;makeQuery&quot; in this.faceter) {</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+      [this.query, this.invertQuery] = this.faceter.makeQuery(this.groupValues,</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+                                                              this.inclusive);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+      return;</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+    }</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+    let query = this.query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+    let constraintFunc;</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+    // If the facet definition references a queryHelper defined by the noun</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+    //  type, use that instead of the standard constraint function.</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+    if (&quot;queryHelper&quot; in this.attrDef.facet)</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+      constraintFunc = query[this.attrDef.boundName +</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+                             this.attrDef.facet.queryHelper];</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+    else</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+      constraintFunc = query[this.ranged ? (this.attrDef.boundName + &quot;Range&quot;)</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+                                         : this.attrDef.boundName];</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+    constraintFunc.apply(query, this.groupValues);</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+    this.invertQuery = !this.inclusive;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+  },</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+  /**</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+   * Adjust the constraint given the incoming faceting constraint desired.</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+   *  Mainly, if the inclusive flag is the same as what we already have, we</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+   *  just append the new values to the existing set of values.  If it is not</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+   *  the same, we replace them.</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+   *</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+   * @return true if the caller needs to revalidate their understanding of the</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+   *     constraint because we have flipped whether we are inclusive or</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+   *     exclusive and have thrown away some constraints as a result.</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+   */</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+  constrain: function(aInclusive, aGroupValues) {</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+    if (aInclusive == this.inclusive) {</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+      this.groupValues = this.groupValues.concat(aGroupValues);</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+      this._makeQuery();</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+      return false;</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+    }</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+    let needToRevalidate = (this.inclusive != null);</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+    this.inclusive = aInclusive;</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+    this.groupValues = aGroupValues;</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+    this._makeQuery();</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+    return needToRevalidate;</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+  },</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+  /**</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+   * Relax something we previously constrained.  Remove it, some might say.  It</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+   *  is possible after relaxing that we will no longer be an active constraint.</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+   *</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+   * @return true if we are no longer constrained at all.</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+   */</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+  relax: function(aInclusive, aGroupValues) {</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+    if (aInclusive != this.inclusive)</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+      throw new Error(&quot;You can't relax a constraint that isn't possible.&quot;);</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+    for each (let [, groupValue] in Iterator(aGroupValues)) {</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+      let index = this.groupValues.indexOf(groupValue);</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+      if (index == -1)</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+        throw new Error(&quot;Tried to relax a constraint that was not in force.&quot;);</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+      this.groupValues.splice(index, 1);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+    }</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+    if (this.groupValues.length == 0) {</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+      this.clear();</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+      return true;</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+    }</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+    this._makeQuery();</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+    return false;</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+  },</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+  /**</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+   * Indicate whether this constraint is actually doing anything anymore.</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+   */</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+  get isConstrained() {</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+    return this.inclusive != null;</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+  },</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+  /**</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+   * Clear the constraint so that the next call to adjust initializes it.</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+   */</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+  clear: function() {</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+    this.inclusive = null;</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+    this.groupValues = null;</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+    this.query = null;</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+    this.invertQuery = null;</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+  },</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+  /**</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+   * Filter the items against our constraint.</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+   */</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+  sieve: function(aItems) {</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+    let query = this.query;</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+    let expectedResult = !this.invertQuery;</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+    let outItems = [];</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+      if (query.test(item) == expectedResult)</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+        outItems.push(item);</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+    }</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+    return outItems;</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+  },</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+  isIncludedGroup: function(aGroupValue) {</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+    if (!this.inclusive)</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+      return false;</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+    return this.groupValues.indexOf(aGroupValue) &gt; -1;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+  },</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+  isExcludedGroup: function(aGroupValue) {</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+    if (this.inclusive)</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+      return false;</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+    return this.groupValues.indexOf(aGroupValue) &gt; -1;</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+  }</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+};</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+function ActiveNonSingularConstraint(aFaceter, aAttrDef, aRanged) {</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+  this.faceter = aFaceter;</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+  this.attrDef = aAttrDef;</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+  this.ranged = Boolean(aRanged);</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+  this.clear();</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+}</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+ActiveNonSingularConstraint.prototype = {</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+  _makeQuery: function(aInclusive, aGroupValues) {</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+    // have the faceter make the query and the invert decision for us if it</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+    //  implements the makeQuery method.</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+    if (&quot;makeQuery&quot; in this.faceter) {</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+      // returns [query, invertQuery] directly</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+      return this.faceter.makeQuery(aGroupValues, aInclusive);</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+    }</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+    let query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+    let constraintFunc;</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+    // If the facet definition references a queryHelper defined by the noun</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+    //  type, use that instead of the standard constraint function.</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+    if (&quot;queryHelper&quot; in this.attrDef.facet)</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+      constraintFunc = query[this.attrDef.boundName +</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+                             this.attrDef.facet.queryHelper];</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+    else</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+      constraintFunc = query[this.ranged ? (this.attrDef.boundName + &quot;Range&quot;)</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+                                         : this.attrDef.boundName];</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+    constraintFunc.apply(query, aGroupValues);</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+    return [query, false];</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+  },</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+  /**</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+   * Adjust the constraint given the incoming faceting constraint desired.</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+   *  Mainly, if the inclusive flag is the same as what we already have, we</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+   *  just append the new values to the existing set of values.  If it is not</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+   *  the same, we replace them.</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+   */</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+  constrain: function(aInclusive, aGroupValues) {</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+    let groupIdAttr = this.attrDef.objectNounDef.isPrimitive ? null</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+                        : this.attrDef.facet.groupIdAttr;</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+    let idMap = aInclusive ? this.includedGroupIds</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+                           : this.excludedGroupIds;</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+    let valList = aInclusive ? this.includedGroupValues</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+                             : this.excludedGroupValues;</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+    for each (let [, groupValue] in Iterator(aGroupValues)) {</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+      let valId = (groupIdAttr !== null) ? groupValue[groupIdAttr] : groupValue;</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+      idMap[valId] = true;</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+      valList.push(groupValue);</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+    }</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+    let [query, invertQuery] = this._makeQuery(aInclusive, valList);</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+    if (aInclusive &amp;&amp; !invertQuery)</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+      this.includeQuery = query;</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+    else</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+      this.excludeQuery = query;</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+    return false;</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+  },</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+  /**</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+   * Relax something we previously constrained.  Remove it, some might say.  It</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+   *  is possible after relaxing that we will no longer be an active constraint.</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+   *</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+   * @return true if we are no longer constrained at all.</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+   */</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+  relax: function(aInclusive, aGroupValues) {</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+    let groupIdAttr = this.attrDef.objectNounDef.isPrimitive ? null</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+                        : this.attrDef.facet.groupIdAttr;</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+    let idMap = aInclusive ? this.includedGroupIds</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+                           : this.excludedGroupIds;</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+    let valList = aInclusive ? this.includedGroupValues</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+                             : this.excludedGroupValues;</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+    for each (let [, groupValue] in Iterator(aGroupValues)) {</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+      let valId = (groupIdAttr !== null) ? groupValue[groupIdAttr] : groupValue;</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+      if (!(valId in idMap))</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+        throw new Error(&quot;Tried to relax a constraint that was not in force.&quot;);</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+      delete idMap[valId];</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+      let index = valList.indexOf(groupValue);</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+      valList.splice(index, 1);</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+    }</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+    if (valList.length == 0) {</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+      if (aInclusive)</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+        this.includeQuery = null;</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+      else</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+        this.excludeQuery = null;</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+    }</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+    else {</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+      let [query, invertQuery] = this._makeQuery(aInclusive, valList);</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+      if (aInclusive &amp;&amp; !invertQuery)</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+        this.includeQuery = query;</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+      else</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+        this.excludeQuery = query;</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+    }</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+    return this.includeQuery == null &amp;&amp; this.excludeQuery == null;</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+  },</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+  /**</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+   * Indicate whether this constraint is actually doing anything anymore.</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+   */</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+  get isConstrained() {</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+    return this.includeQuery == null &amp;&amp; this.excludeQuery == null;</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+  },</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+  /**</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+   * Clear the constraint so that the next call to adjust initializes it.</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+   */</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+  clear: function() {</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+    this.includeQuery = null;</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+    this.includedGroupIds = {};</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+    this.includedGroupValues = [];</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+    this.excludeQuery = null;</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+    this.excludedGroupIds = {};</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+    this.excludedGroupValues = [];</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+  },</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+  /**</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+   * Filter the items against our constraint.</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+   */</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+  sieve: function(aItems) {</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+    let includeQuery = this.includeQuery, excludeQuery = this.excludeQuery;</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+    let outItems = [];</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+      if ((!includeQuery || includeQuery.test(item)) &amp;&amp;</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+          (!excludeQuery || !excludeQuery.test(item)))</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+        outItems.push(item);</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+    }</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+    return outItems;</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+  },</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+  isIncludedGroup: function(aGroupValue) {</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+    let valId = aGroupValue[this.attrDef.facet.groupIdAttr];</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+    return (valId in this.includedGroupIds);</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+  },</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+  isExcludedGroup: function(aGroupValue) {</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+    let valId = aGroupValue[this.attrDef.facet.groupIdAttr];</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+    return (valId in this.excludedGroupIds);</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineplus">+  }</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineplus">+};</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineplus">+</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineplus">+var FacetContext = {</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+  facetDriver: new FacetDriver(Gloda.lookupNounDef(&quot;message&quot;),</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+                               window),</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+  /**</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+   * The root collection which our active set is a subset of.  We hold onto this</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+   *  for garbage collection reasons, although the tab that owns us should also</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineplus">+   *  be holding on.</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineplus">+   */</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineplus">+  _collection: null,</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineplus">+  set collection(aCollection) {</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineplus">+    this._collection = aCollection;</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineplus">+  },</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+  get collection() {</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+    return this._collection;</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+  },</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+  _sortBy: null,</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+  get sortBy() {</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+    return this._sortBy;</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+  },</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineplus">+  set sortBy(val) {</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+    try {</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+      if (val == this._sortBy)</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+        return;</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineplus">+      this._sortBy = val;</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+      this.build(this._sieveAll());</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineplus">+      logException(e);</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+    }</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+  },</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineplus">+  /**</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+   * List of the current working set</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+   */</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+  _activeSet: null,</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+  get activeSet() {</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+    return this._activeSet;</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+  },</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+  get fullSet() {</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+    if (this._sortBy == '-dascore')</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+      return this._relevantSortedItems;</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+    return this._dateSortedItems;</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+  },</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+  initialBuild: function() {</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineplus">+    let queryExplanation = document.getElementById(&quot;query-explanation&quot;);</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineplus">+    if (this.searcher)</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+      queryExplanation.setFulltext(this.searcher);</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+    else</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+      queryExplanation.setQuery(this.collection.query);</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+    // we like to sort them so should clone the list</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+    this.faceters = this.facetDriver.faceters.concat();</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+    this.everFaceted = false;</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+    this._activeConstraints = {};</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineplus">+    try {</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+      if (this.searcher) {</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+        this._sortBy = '-dascore';</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+        this._relevantSortedItems = this._collection.items.concat();</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+        this._dateSortedItems = this._relevantSortedItems.concat().sort(function(a,b) b.date-a.date);</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+        this._activeSet = this._relevantSortedItems;</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+      } else {</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+        this._sortBy = '-date';</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+        this._dateSortedItems = this.collection.items.concat();</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+        this._relevantSortedItems = Gloda.scoreNounItems(this._dateSortedItems);</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+        this._activeSet = this._dateSortedItems;</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+      }</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+      this.build(this.fullSet);</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+      logException(e);</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+    }</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+  },</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+  /**</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+   * Kick-off a new faceting pass.</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+   *</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+   * @param aNewSet the set of items to facet.</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+   * @param aCallback the callback to invoke when faceting is completed.</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+   */</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+  build: function(aNewSet, aCallback) {</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineplus">+    this._activeSet = aNewSet;</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+    this._callbackOnFacetComplete = aCallback;</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+    this.facetDriver.go(this._activeSet, this.facetingCompleted, this);</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+  },</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+  /**</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+   * Attempt to figure out a reasonable number of rows to limit each facet to</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+   *  display.  While the number will ordinarily be dominated by the maximum</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+   *  number of rows we believe the user can easily scan, this may also be</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+   *  impacted by layout concerns (since we want to avoid scrolling).</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineplus">+   */</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineplus">+  planLayout: function() {</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineplus">+    // XXX arbitrary!</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+    this.maxDisplayRows = 8;</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+    this.maxMessagesToShow = 10;</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+  },</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+  /**</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineplus">+   * Clean up the UI in preparation for a new query to come in.</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineplus">+   */</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+  _resetUI: function() {</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineplus">+    for each (let [, faceter] in Iterator(this.faceters)) {</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineplus">+      if (faceter.xblNode &amp;&amp; !faceter.xblNode.explicit)</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+        faceter.xblNode.parentNode.removeChild(faceter.xblNode);</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+      faceter.xblNode = null;</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineplus">+      faceter.constraint = null;</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineplus">+    }</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineplus">+  },</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineplus">+</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineplus">+  _groupCountComparator: function(a, b) {</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineplus">+    return b.groupCount - a.groupCount;</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+  },</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineplus">+  /**</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineplus">+   * Tells the UI about all the facets when notified by the |facetDriver| when</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineplus">+   *  it is done faceting everything.</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineplus">+   */</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineplus">+  facetingCompleted: function() {</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineplus">+    this.planLayout();</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineplus">+</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineplus">+    let uiFacets = document.getElementById(&quot;facets&quot;);</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+    if (!this.everFaceted) {</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+      this.everFaceted = true;</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+      this.faceters.sort(this._groupCountComparator);</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+      for each (let [, faceter] in Iterator(this.faceters)) {</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineplus">+        let attrName = faceter.attrDef.attributeName;</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+        let explicitBinding = document.getElementById(&quot;facet-&quot; + attrName);</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineplus">+</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineplus">+        if (explicitBinding) {</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+          explicitBinding.explicit = true;</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineplus">+          explicitBinding.faceter = faceter;</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineplus">+          explicitBinding.attrDef = faceter.attrDef;</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineplus">+          explicitBinding.nounDef = faceter.attrDef.objectNounDef;</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineplus">+          explicitBinding.orderedGroups = faceter.orderedGroups;</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+          // explicit booleans should always be displayed for consistency</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+          if (faceter.groupCount &gt;= 1 ||</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+              (explicitBinding.getAttribute(&quot;type&quot;).indexOf(&quot;boolean&quot;) != -1)) {</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineplus">+            explicitBinding.build(true);</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+            explicitBinding.removeAttribute(&quot;uninitialized&quot;);</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineplus">+          }</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineplus">+          faceter.xblNode = explicitBinding;</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+          continue;</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineplus">+        }</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineplus">+</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineplus">+        // ignore facets that do not vary!</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineplus">+        if (faceter.groupCount &lt;= 1) {</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineplus">+          faceter.xblNode = null;</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineplus">+          continue;</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineplus">+        }</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineplus">+</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineplus">+        faceter.xblNode = uiFacets.addFacet(faceter.type, faceter.attrDef, {</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineplus">+          faceter: faceter,</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+          orderedGroups: faceter.orderedGroups,</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineplus">+          maxDisplayRows: this.maxDisplayRows,</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineplus">+          explicit: false,</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineplus">+        });</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineplus">+      }</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+    }</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineplus">+    else {</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineplus">+      for each (let [, faceter] in Iterator(this.faceters)) {</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineplus">+        // Do not bother with un-displayed facets, or that are locked by a</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineplus">+        //  constraint.  But do bother if the widget can be updated without</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineplus">+        //  losing important data.</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineplus">+        if (!faceter.xblNode ||</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineplus">+            (faceter.constraint &amp;&amp; !faceter.xblNode.canUpdate))</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineplus">+          continue;</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineplus">+</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+        // hide things that have 0/1 groups now and are not constrained and not</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+        //  explicit</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineplus">+        if (faceter.groupCount &lt;= 1 &amp;&amp; !faceter.constraint &amp;&amp;</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+            (!faceter.xblNode.explicit || faceter.type == &quot;date&quot;))</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineplus">+          $(faceter.xblNode).hide();</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineplus">+        // otherwise, update</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineplus">+        else {</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineplus">+          faceter.xblNode.orderedGroups = faceter.orderedGroups;</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineplus">+          faceter.xblNode.build(false);</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineplus">+          $(faceter.xblNode).show();</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineplus">+        }</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineplus">+      }</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineplus">+    }</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineplus">+</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineplus">+    this._showResults();</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineplus">+</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineplus">+    if (this._callbackOnFacetComplete) {</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineplus">+      let callback = this._callbackOnFacetComplete;</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineplus">+      this._callbackOnFacetComplete = null;</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+      callback();</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineplus">+    }</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineplus">+  },</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineplus">+</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineplus">+  _showResults: function()</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineplus">+  {</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineplus">+    let results = document.getElementById(&quot;results&quot;);</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineplus">+    let numMessageToShow = Math.min(this.maxMessagesToShow * this._numPages,</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineplus">+                                    this._activeSet.length);</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineplus">+    results.setMessages(this._activeSet.slice(0, numMessageToShow));</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineplus">+</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineplus">+    let showMore = document.getElementById(&quot;showMore&quot;);</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineplus">+    if (this._activeSet.length &gt; numMessageToShow)</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineplus">+      $(showMore).show();</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineplus">+    else</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineplus">+      $(showMore).hide();</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineplus">+  },</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineplus">+</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+  showMore: function() {</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineplus">+    this._numPages += 1;</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineplus">+    this._showResults();</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineplus">+    let results = document.getElementById(&quot;results&quot;);</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineplus">+    let msgIndex = (this._numPages - 1) * this.maxMessagesToShow;</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineplus">+    results.ensureNodeVisible(msgIndex);</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineplus">+  },</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineplus">+</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineplus">+  /** For use in hovering specific results. */</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineplus">+  fakeResultFaceter: {},</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineplus">+  /** For use in hovering specific results. */</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineplus">+  fakeResultAttr: {},</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineplus">+</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineplus">+  _numPages: 1,</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineplus">+  _HOVER_STABILITY_DURATION_MS: 100,</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineplus">+  _brushedFacet: null,</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineplus">+  _brushedGroup: null,</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineplus">+  _brushedItems: null,</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineplus">+  _brushTimeout: null,</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+  hoverFacet: function(aFaceter, aAttrDef, aGroupValue, aGroupItems) {</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineplus">+    // bail if we are already brushing this item</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineplus">+    if (this._brushedFacet == aFaceter &amp;&amp; this._brushedGroup == aGroupValue)</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineplus">+      return;</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineplus">+</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineplus">+    this._brushedFacet = aFaceter;</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+    this._brushedGroup = aGroupValue;</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineplus">+    this._brushedItems = aGroupItems;</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineplus">+</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineplus">+    if (this._brushTimeout != null)</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineplus">+      clearTimeout(this._brushTimeout);</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineplus">+    this._brushTimeout = setTimeout(this._timeoutHoverWrapper,</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+                                    this._HOVER_STABILITY_DURATION_MS, this);</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+  },</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineplus">+  _timeoutHover: function() {</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineplus">+    this._brushTimeout = null;</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineplus">+    for each (let [, faceter] in Iterator(this.faceters)) {</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineplus">+      if (faceter == this._brushedFacet || !faceter.xblNode)</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineplus">+        continue;</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineplus">+</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineplus">+      if (this._brushedItems != null)</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineplus">+        faceter.xblNode.brushItems(this._brushedItems);</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineplus">+      else</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineplus">+        faceter.xblNode.clearBrushedItems();</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineplus">+    }</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineplus">+  },</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+  _timeoutHoverWrapper: function(aThis) {</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineplus">+    aThis._timeoutHover();</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineplus">+  },</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineplus">+  unhoverFacet: function(aFaceter, aAttrDef, aGroupValue, aGroupItems) {</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineplus">+    // have we already brushed from some other source already?  ignore then.</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineplus">+    if (this._brushedFacet != aFaceter || this._brushedGroup != aGroupValue)</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineplus">+      return;</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineplus">+</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineplus">+    // reuse hover facet to null everyone out</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineplus">+    this.hoverFacet(null, null, null, null);</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineplus">+  },</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineplus">+</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+  /**</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineplus">+   * Maps attribute names to their corresponding |ActiveConstraint|, if they</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineplus">+   *  have one.</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineplus">+   */</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineplus">+  _activeConstraints: null,</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineplus">+  /**</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineplus">+   * Called by facet bindings when the user does some clicking and wants to</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineplus">+   *  impose a new constraint.</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineplus">+   *</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineplus">+   * @param aFaceter</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineplus">+   * @param aAttrDef</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineplus">+   * @param {Boolean} aInclusive</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineplus">+   * @param aGroupValues</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineplus">+   * @param aRanged Is it a ranged constraint?  (Currently only for dates)</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineplus">+   * @param aNukeExisting Do we need to replace the existing constraint and</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineplus">+   *     re-sieve everything?  This currently only happens for dates, where</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineplus">+   *     our display allows a click to actually make our range more generic</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineplus">+   *     than it currently is.  (But this only matters if we already have</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+   *     a date constraint applied.)</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineplus">+   *</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+   * @return true if the caller needs to revalidate because the constraint has</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineplus">+   *     changed in a way other than explicitly requested.  This can occur if</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineplus">+   *     a singular constraint flips its inclusive state and throws away</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineplus">+   *     constraints.</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineplus">+   */</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineplus">+  addFacetConstraint: function(aFaceter, aInclusive, aGroupValues,</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineplus">+                               aRanged, aNukeExisting, aCallback) {</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineplus">+    let attrName = aFaceter.attrDef.attributeName;</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineplus">+</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineplus">+    let constraint;</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineplus">+    let needToSieveAll = false;</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineplus">+    if (attrName in this._activeConstraints) {</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineplus">+      constraint = this._activeConstraints[attrName];</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineplus">+</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineplus">+      needToSieveAll = true;</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+      if (aNukeExisting)</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+        constraint.clear();</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+    }</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+    else {</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+      let constraintClass = aFaceter.attrDef.singular ? ActiveSingularConstraint</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineplus">+                              : ActiveNonSingularConstraint;</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineplus">+      constraint = this._activeConstraints[attrName] =</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineplus">+        new constraintClass(aFaceter, aFaceter.attrDef, aRanged);</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineplus">+      aFaceter.constraint = constraint;</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineplus">+    }</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineplus">+    let needToRevalidate = constraint.constrain(aInclusive, aGroupValues);</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineplus">+</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineplus">+    // Given our current implementation, we can only be further constraining our</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineplus">+    //  active set, so we can just sieve the existing active set with the</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineplus">+    //  (potentially updated) constraint.  In some cases, it would be much</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineplus">+    //  cheaper to use the facet's knowledge about the items in the groups, but</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineplus">+    //  for now let's keep a single code-path for how we refine the active set.</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineplus">+    this.build(needToSieveAll ? this._sieveAll()</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineplus">+                              : constraint.sieve(this.activeSet),</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineplus">+               aCallback);</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineplus">+</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineplus">+    return needToRevalidate;</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineplus">+  },</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineplus">+</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineplus">+  /**</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineplus">+   * Remove a constraint previously imposed by addFacetConstraint.  The</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineplus">+   *  constraint must still be active, which means you need to pay attention</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineplus">+   *  when |addFacetConstraint| returns true indicating that you need to</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineplus">+   *  revalidate.</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineplus">+   *</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineplus">+   * @param aFaceter</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineplus">+   * @param aInclusive Whether the group values were previously included /</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineplus">+   *     excluded.  If you want to remove some values that were included and</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineplus">+   *     some that were excluded then you need to call us once for each case.</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+   * @param aGroupValues The list of group values to remove.</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+   * @param aCallback The callback to call once all facets have been updated.</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+   *</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+   * @return true if the constraint has been completely removed.  Under the</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+   *     current regime, this will likely cause the binding that is calling us</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineplus">+   *     to be rebuilt, so be aware if you are trying to do any cool animation</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineplus">+   *     that might no longer make sense.</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+   */</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineplus">+  removeFacetConstraint: function(aFaceter, aInclusive, aGroupValues,</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineplus">+                                  aCallback) {</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineplus">+    let attrName = aFaceter.attrDef.attributeName;</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+    let constraint = this._activeConstraints[attrName];</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineplus">+</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineplus">+    let constraintGone = false;</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineplus">+</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineplus">+    if (constraint.relax(aInclusive, aGroupValues)) {</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineplus">+      delete this._activeConstraints[attrName];</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineplus">+      aFaceter.constraint = null;</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineplus">+      constraintGone = true;</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineplus">+    }</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineplus">+</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineplus">+    // we definitely need to re-sieve everybody in this case...</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineplus">+    this.build(this._sieveAll(), aCallback);</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineplus">+</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineplus">+    return constraintGone;</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineplus">+  },</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineplus">+</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineplus">+  /**</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineplus">+   * Sieve the items from the underlying collection against all constraints,</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineplus">+   *  returning the value.</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineplus">+   */</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineplus">+  _sieveAll: function() {</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineplus">+    let items = this.fullSet;</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineplus">+    for each (let [, constraint] in Iterator(this._activeConstraints)) {</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineplus">+      items = constraint.sieve(items);</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineplus">+    }</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineplus">+</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineplus">+    return items;</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineplus">+  },</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineplus">+</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineplus">+  toggleFulltextCriteria: function() {</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineplus">+    this.tab.searcher.andTerms = !this.tab.searcher.andTerms;</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineplus">+    this._resetUI();</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineplus">+    this.collection = this.tab.searcher.getCollection(this);</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineplus">+  },</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineplus">+</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineplus">+  /**</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineplus">+   * Show the active message set in a glodaList tab, closing the current tab.</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineplus">+   */</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineplus">+  showActiveSetInTab: function() {</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineplus">+    let tabmail = this.rootWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineplus">+    tabmail.openTab(&quot;glodaList&quot;, {</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineplus">+      collection: Gloda.explicitCollection(Gloda.NOUN_MESSAGE, this.activeSet),</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineplus">+      title: this.tab.title</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineplus">+    });</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineplus">+    tabmail.closeTab(this.tab);</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+  },</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineplus">+</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+  /**</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineplus">+   * Show the conversation in a new glodaList tab.</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineplus">+   *</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineplus">+   * @param {GlodaConversation} aConversation The conversation to show.</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineplus">+   * @param {Boolean} [aBackground] Whether it should be in the background.</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineplus">+   */</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineplus">+  showConversationInTab: function(aMessage, aBackground) {</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineplus">+    let tabmail = this.rootWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineplus">+    tabmail.openTab(&quot;glodaList&quot;, {</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineplus">+      conversation: aMessage.conversation,</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineplus">+      message: aMessage,</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineplus">+      title: aMessage.conversation.subject,</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineplus">+      background: aBackground</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineplus">+    });</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineplus">+  },</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineplus">+</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineplus">+  /**</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineplus">+   * Show the message in a new tab.</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineplus">+   *</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineplus">+   * @param {GlodaMessage} aMessage The message to show.</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineplus">+   * @param {Boolean} [aBackground] Whether it should be in the background.</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineplus">+   */</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineplus">+  showMessageInTab: function(aMessage, aBackground) {</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineplus">+    let tabmail = this.rootWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineplus">+    let msgHdr = aMessage.folderMessage;</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineplus">+    if (!msgHdr)</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineplus">+      throw new Error(&quot;Unable to translate gloda message to message header.&quot;);</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineplus">+    tabmail.openTab(&quot;message&quot;, {</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineplus">+      msgHdr: msgHdr,</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineplus">+      background: aBackground</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineplus">+    });</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineplus">+  },</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineplus">+</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineplus">+  onItemsAdded: function(aItems, aCollection) {</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineplus">+  },</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineplus">+  onItemsModified: function(aItems, aCollection) {</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineplus">+  },</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineplus">+  onItemsRemoved: function(aItems, aCollection) {</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineplus">+  },</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineplus">+  onQueryCompleted: function(aCollection) {</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineplus">+    this.initialBuild();</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineplus">+  }</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineplus">+};</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineplus">+</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineplus">+/**</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineplus">+ * addEventListener betrayals compel us to establish our link with the</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineplus">+ *  outside world from inside.  NeilAway suggests the problem might have</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineplus">+ *  been the registration of the listener prior to initiating the load.  Which</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineplus">+ *  is odd considering it works for the XUL case, but I could see how that might</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineplus">+ *  differ.  Anywho, this works for now and is a delightful reference to boot.</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineplus">+ */</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineplus">+function reachOutAndTouchFrame() {</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineplus">+  let us = window.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineplus">+                 .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineplus">+                 .QueryInterface(Ci.nsIDocShellTreeItem);</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineplus">+</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineplus">+  FacetContext.rootWin = us.rootTreeItem</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineplus">+                    .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineplus">+                    .getInterface(Ci.nsIDOMWindow);</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineplus">+</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineplus">+  let parentWin = us.parent</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineplus">+                    .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineplus">+                    .getInterface(Ci.nsIDOMWindow);</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineplus">+  let aTab = FacetContext.tab = parentWin.tab;</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineplus">+  parentWin.tab = null;</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineplus">+  $(window).resize(function() {</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineplus">+    document.getElementById(&quot;facet-date&quot;).build(true);</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineplus">+  })</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineplus">+  // we need to hook the context up as a listener in all cases since</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineplus">+  //  removal notifications are required.</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineplus">+  if (&quot;searcher&quot; in aTab) {</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineplus">+    FacetContext.searcher = aTab.searcher;</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineplus">+    aTab.searcher.listener = FacetContext;</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineplus">+  }</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineplus">+  else {</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineplus">+    FacetContext.searcher = null;</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineplus">+    aTab.collection.listener = FacetContext;</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineplus">+  }</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineplus">+  FacetContext.collection = aTab.collection;</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineplus">+</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineplus">+  // if it has already completed, we need to prod things</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineplus">+  if (aTab.query.completed)</span>
<a href="#l8.804"></a><span id="l8.804" class="difflineplus">+    FacetContext.initialBuild();</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mail/base/content/glodaFacetView.xhtml</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,65 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.1//EN&quot;</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+  &quot;http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd&quot; [</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+&lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot; &gt;</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+%brandDTD;</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+&lt;!ENTITY % aboutDTD SYSTEM &quot;chrome://global/locale/about.dtd&quot; &gt;</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+%aboutDTD;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+&lt;!ENTITY % globalDTD SYSTEM &quot;chrome://global/locale/global.dtd&quot;&gt;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+%globalDTD;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+&lt;!ENTITY % facetViewDTD SYSTEM &quot;chrome://messenger/locale/glodaFacetView.dtd&quot;&gt;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+%facetViewDTD;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+]&gt;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+    xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+    xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+    version=&quot;-//W3C//DTD XHTML 1.1//EN&quot; xml:lang=&quot;en&quot;&gt;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+&lt;head&gt;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+  &lt;!-- XBL bindings CSS --&gt;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+      href=&quot;chrome://messenger/content/glodaFacetBindings.css&quot;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+      type=&quot;text/css&quot;&gt;&lt;/link&gt;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  &lt;link rel=&quot;stylesheet&quot; media=&quot;screen&quot; type=&quot;text/css&quot;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+        href=&quot;chrome://messenger/skin/tagColors.css&quot;/&gt;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+  &lt;!-- Themes --&gt;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+  &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+      href=&quot;chrome://messenger/skin/glodaFacetView.css&quot;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+      type=&quot;text/css&quot;&gt;&lt;/link&gt;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  &lt;!-- Global Context --&gt;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+  &lt;script type=&quot;application/javascript;version=1.8&quot;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+      src=&quot;chrome://messenger/content/glodaFacetView.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+  &lt;!-- Libs --&gt;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+  &lt;script type=&quot;application/javascript;version=1.8&quot;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+      src=&quot;chrome://messenger/content/jquery.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  &lt;script type=&quot;application/javascript;version=1.8&quot;</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+      src=&quot;chrome://messenger/content/protovis-r2.6-modded.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+  &lt;!-- Facet Binding Stuff that doesn't belong in XBL --&gt;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+  &lt;script type=&quot;application/javascript;version=1.8&quot;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+      src=&quot;chrome://messenger/content/glodaFacetVis.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+&lt;/head&gt;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+&lt;body id=&quot;body&quot; onload=&quot;reachOutAndTouchFrame()&quot;&gt;</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  &lt;div id=&quot;table&quot;&gt;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+    &lt;div class=&quot;facets facets-sidebar&quot; id=&quot;facets&quot;&gt;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+      &lt;h1 id=&quot;filter-header-label&quot;&gt;&amp;glodaFacetView.filters.label;&lt;/h1&gt;</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+      &lt;div&gt;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+        &lt;div id=&quot;facet-fromMe&quot; class=&quot;facetious&quot; type=&quot;boolean&quot; attr=&quot;fromMe&quot;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+             uninitialized=&quot;true&quot; /&gt;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+        &lt;div id=&quot;facet-toMe&quot; class=&quot;facetious&quot; type=&quot;boolean&quot; attr=&quot;toMe&quot;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+             uninitialized=&quot;true&quot; /&gt;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+        &lt;div id=&quot;facet-star&quot; class=&quot;facetious&quot; type=&quot;boolean&quot; attr=&quot;star&quot;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+             uninitialized=&quot;true&quot;/&gt;&lt;br /&gt;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+        &lt;div id=&quot;facet-attachmentTypes&quot; class=&quot;facetious&quot; type=&quot;boolean-filtered&quot;</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+             attr=&quot;attachmentTypes&quot;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+             groupDisplayProperty=&quot;categoryLabel&quot;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+             uninitialized=&quot;true&quot;/&gt;</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    &lt;div id=&quot;main-column&quot;&gt;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+      &lt;div id=&quot;query-explanation&quot;/&gt;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+      &lt;div id=&quot;facet-date&quot; class=&quot;facetious&quot; type=&quot;date&quot; /&gt;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+      &lt;div class=&quot;results&quot; id=&quot;results&quot; type=&quot;message&quot; /&gt;</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+      &lt;div class=&quot;show-more&quot; id=&quot;showMore&quot; onclick=&quot;FacetContext.showMore()&quot;&gt;&amp;glodaFacetView.showMore.label;&lt;/div&gt;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+  &lt;/div&gt;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+&lt;/body&gt;</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mail/base/content/glodaFacetViewWrapper.xul</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,29 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+&lt;window id=&quot;window&quot; xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+      src=&quot;chrome://global/content/viewZoomOverlay.js&quot;/&gt;</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+  &lt;script type=&quot;application/javascript;version=1.8&quot;&gt;&lt;![CDATA[</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+    function getBrowser() {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+        return document.getElementById('browser');</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    }</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  ]]&gt;&lt;/script&gt;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+  &lt;commandset id=&quot;selectEditMenuItems&quot;&gt;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+    &lt;command id=&quot;cmd_fullZoomReduce&quot; oncommand=&quot;ZoomManager.reduce();&quot;/&gt;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+    &lt;command id=&quot;cmd_fullZoomEnlarge&quot; oncommand=&quot;ZoomManager.enlarge();&quot;/&gt;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+    &lt;command id=&quot;cmd_fullZoomReset&quot; oncommand=&quot;ZoomManager.reset();&quot;/&gt;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+  &lt;/commandset&gt;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  &lt;keyset&gt;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+    &lt;!--move to locale--&gt;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+    &lt;key id=&quot;key_fullZoomEnlarge&quot; key=&quot;+&quot;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+         command=&quot;cmd_fullZoomEnlarge&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+    &lt;key id=&quot;key_fullZoomEnlarge2&quot; key=&quot;=&quot;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+         command=&quot;cmd_fullZoomEnlarge&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+    &lt;key id=&quot;key_fullZoomReduce&quot; key=&quot;-&quot;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+         command=&quot;cmd_fullZoomReduce&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+    &lt;key id=&quot;key_fullZoomReset&quot; key=&quot;0&quot;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+         command=&quot;cmd_fullZoomReset&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+  &lt;/keyset&gt;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  &lt;browser id=&quot;browser&quot;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+           flex=&quot;1&quot; /&gt;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mail/base/content/glodaFacetVis.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,407 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/****** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ *</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+ *</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+ * License.</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+ *</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+ * The Original Code is Thunderbird Global Database.</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+ *</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+ *</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+ *</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+ *</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+/*</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+ * Facet visualizations that would be awkward in XBL.  Allegedly because the</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+ *  interaciton idiom of a protovis-based visualization is entirely different</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+ *  from XBL, but also a lot because of the lack of good syntax highlighting.</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+ */</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+/**</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+ * A date facet visualization abstraction.</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+ */</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+function DateFacetVis(aBinding, aCanvasNode) {</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+  this.binding = aBinding;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  this.canvasNode = aCanvasNode;</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  this.faceter = aBinding.faceter;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+  this.attrDef = this.faceter.attrDef;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+}</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+DateFacetVis.prototype = {</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+  build: function() {</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+    this.allowedSpace = document.documentElement.clientWidth -</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+                        this.canvasNode.getBoundingClientRect().left;</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+    this.render();</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+  },</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  rebuild: function() {</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+    this.render();</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+  },</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+  _MIN_BAR_SIZE_PX: 9,</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+  _BAR_SPACING_PX: 1,</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+  _MAX_BAR_SIZE_PX: 44,</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  _AXIS_FONT: &quot;10px sans-serif&quot;,</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  _AXIS_HEIGHT_NO_LABEL_PX: 6,</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+  _AXIS_HEIGHT_WITH_LABEL_PX: 14,</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+  _AXIS_VERT_SPACING_PX: 1,</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+  _AXIS_HORIZ_MIN_SPACING_PX: 4,</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+  _MAX_DAY_COUNT_LABEL_DISPLAY: 10,</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+  /**</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+   * Figure out how to chunk things given the linear space in pixels.  In an</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+   *  ideal world we would not use pixels, avoiding tying ourselves to assumed</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+   *  pixel densities, but we do not live there.  Reality wants crisp graphics</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+   *  and does not have enough pixels that you can ignore the pixel coordinate</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+   *  space and have things still look sharp (and good).</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+   *</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+   * Because of our love of sharpness, we will potentially under-use the space</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+   *  allocated to us.</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+   *</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+   * @param aPixels The number of linear content pixels we have to work with.</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+   *     You are in charge of the borders and such, so you subtract that off</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+   *     before you pass it in.</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+   * @return An object with attributes:</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+   */</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  makeIdealScaleGivenSpace: function(aPixels) {</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+    let facet = this.faceter;</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+    // build a scale and have it grow the edges based on the span</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+    let scale = pv.Scales.dateTime(facet.oldest, facet.newest);</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+    const Span = pv.Scales.DateTimeScale.Span;</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+    const MS_MIN = 60*1000, MS_HOUR = 60*MS_MIN, MS_DAY = 24*MS_HOUR,</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+          MS_WEEK = 7*MS_DAY, MS_MONTHISH = 31*MS_DAY, MS_YEARISH = 366*MS_DAY;</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+    const roughMap = {};</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+    roughMap[Span.DAYS] = MS_DAY;</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+    roughMap[Span.WEEKS] = MS_WEEK;</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+    // we overestimate since we want to slightly underestimate pixel usage</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+    //  in enoughPix's rough estimate</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+    roughMap[Span.MONTHS] = MS_MONTHISH;</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+    roughMap[Span.YEARS] = MS_YEARISH;</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+    const minBarPix = this._MIN_BAR_SIZE_PX + this._BAR_SPACING_PX;</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+    let delta = facet.newest.valueOf() - facet.oldest.valueOf();</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+    let span, rules, barPixBudget;</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+    // evil side-effect land</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+    function enoughPix(aSpan) {</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+      span = aSpan;</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+      // do a rough guestimate before doing something potentially expensive...</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+      barPixBudget = Math.floor(aPixels / (delta / roughMap[span]));</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+      if (barPixBudget &lt; (minBarPix + 1))</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+        return false;</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+      rules = scale.ruleValues(span);</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+      // + 0 because we want to over-estimate slightly for niceness rounding</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+      //  reasons</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+      barPixBudget = Math.floor(aPixels / (rules.length + 0));</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+      delta = scale.max().valueOf() - scale.min().valueOf();</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+      return barPixBudget &gt; minBarPix;</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+    }</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+    // day is our smallest unit</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+    const ALLOWED_SPANS = [Span.DAYS, Span.WEEKS, Span.MONTHS, Span.YEARS];</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+    for each (let [, trySpan] in Iterator(ALLOWED_SPANS)) {</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+      if (enoughPix(trySpan)) {</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+        // do the equivalent of nice() for our chosen span</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+        scale.min(scale.round(scale.min(), trySpan, false));</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+        scale.max(scale.round(scale.max(), trySpan, true));</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+        // try again for paranoia, but mainly for the side-effect...</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+        if (enoughPix(trySpan))</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+          break;</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+      }</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+    }</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+    // - Figure out our labeling strategy</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+    // normalize the symbols into an explicit ordering</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+    let spandex = ALLOWED_SPANS.indexOf(span);</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+    // from least-specific to most-specific</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+    let labelTiers = [];</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+    // add year spans in all cases, although whether we draw bars depends on if</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+    //  we are in year mode or not</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+    labelTiers.push({</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+      rules: (span == Span.YEARS) ? rules : scale.ruleValues(Span.YEARS, true),</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+      label: [&quot;%Y&quot;, &quot;%y&quot;, null], // we should not hit the null case...</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+      boost: (span == Span.YEARS),</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+      noFringe: (span == Span.YEARS)</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+    });</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+    // add month spans if we are days or weeks...</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+    if (spandex &lt; 2) {</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+      labelTiers.push({</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+        rules: scale.ruleValues(Span.MONTHS, true),</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+        // try to use the full month, falling back to the short month</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+        label: [&quot;%B&quot;, &quot;%b&quot;, null],</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+        boost: false</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+      });</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+    }</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+    // add week spans if our granularity is days...</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+    if (span == Span.DAYS) {</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+      let numDays = delta / MS_DAY;</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+      // find out how many days we are talking about and add days if it's small</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+      //  enough, display both the date and the day of the week</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+      if (numDays &lt;= this._MAX_DAY_COUNT_LABEL_DISPLAY) {</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+        labelTiers.push({</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+          rules: rules,</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+          label: [&quot;%d&quot;, null],</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+          boost: true, noFringe: true</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+        });</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+        labelTiers.push({</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+          rules: rules,</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+          label: [&quot;%a&quot;, null],</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+          boost: true, noFringe: true</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+        });</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+      }</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+      // show the weeks since we're at greater than a day time-scale</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+      else {</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+        labelTiers.push({</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+          rules: scale.ruleValues(Span.WEEKS, true),</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+          // labeling weeks is nonsensical; no one understands ISO weeks</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+          //  numbers.</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+          label: [null],</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+          boost: false</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+        });</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+      }</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+    }</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+    return {</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+      scale: scale, span: span, rules: rules, barPixBudget: barPixBudget,</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+      labelTiers: labelTiers</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+    };</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+  },</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+  render: function() {</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+    let {scale: scale, span: span, rules: rules, barPixBudget: barPixBudget,</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+         labelTiers: labelTiers} =</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+      this.makeIdealScaleGivenSpace(this.allowedSpace);</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+    barPixBudget = Math.floor(barPixBudget);</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+    let minBarPix = this._MIN_BAR_SIZE_PX + this._BAR_SPACING_PX;</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+    let maxBarPix = this._MAX_BAR_SIZE_PX + this._BAR_SPACING_PX;</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+    let barPix = Math.max(minBarPix, Math.min(maxBarPix, barPixBudget));</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+    let width = barPix * (rules.length - 1);</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+    let totalAxisLabelHeight = 0;</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+    // we need to do some font-metric calculations, so create a canvas...</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+    let fontMetricCanvas = document.createElement(&quot;canvas&quot;);</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+    let ctx = fontMetricCanvas.getContext(&quot;2d&quot;);</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+    // do the labeling logic,</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+    for each (let [, labelTier] in Iterator(labelTiers)) {</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+      let labelRules = labelTier.rules;</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+      let perLabelBudget = width / (labelRules.length - 1);</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+      for each (let [, labelFormat] in Iterator(labelTier.label)) {</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+        let maxWidth = 0;</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+        let displayValues = [];</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+        for (let iRule = 0; iRule &lt; labelRules.length - 1; iRule++) {</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+          // is this at the either edge of the display?  in that case, it might</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+          //  be partial...</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+          let fringe = (labelRules.length &gt; 2) &amp;&amp;</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+                       ((iRule == 0) || (iRule == labelRules.length - 2));</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+          let labelStartDate = labelRules[iRule];</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+          let labelEndDate = labelRules[iRule + 1];</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+          let labelText = labelFormat ?</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+                            labelStartDate.toLocaleFormat(labelFormat) : null;</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+          let labelStartNorm = Math.max(0, scale.normalize(labelStartDate));</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+          let labelEndNorm = Math.min(1, scale.normalize(labelEndDate));</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+          let labelBudget = (labelEndNorm - labelStartNorm) * width;</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+          if (labelText) {</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+            let labelWidth = ctx.measureText(labelText).width;</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+            // discard labels at the fringe who don't fit in our budget</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+            if (fringe &amp;&amp; !labelTier.noFringe &amp;&amp; labelWidth &gt; labelBudget)</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+              labelText = null;</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+            else</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+              maxWidth = Math.max(labelWidth, maxWidth);</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+          }</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+          displayValues.push([labelStartNorm, labelEndNorm, labelText,</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+                              labelStartDate, labelEndDate]);</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+        }</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+        // there needs to be space between the labels.  (we may be over-padding</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+        //  here if there is only one label with the maximum width...)</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+        maxWidth += this._AXIS_HORIZ_MIN_SPACING_PX;</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+        if (labelTier.boost &amp;&amp; (maxWidth &gt; perLabelBudget)) {</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+          // we only boost labels that are the same span as the bins, so rules</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+          //  === labelRules at this point.  (and barPix === perLabelBudget)</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+          barPix = perLabelBudget = maxWidth;</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+          width = barPix * (labelRules.length - 1);</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+        }</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+        if (maxWidth &lt;= perLabelBudget) {</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+          labelTier.displayValues = displayValues;</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+          labelTier.displayLabel = labelFormat != null;</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+          labelTier.vertHeight = labelFormat ? this._AXIS_HEIGHT_WITH_LABEL_PX</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+                                             : this._AXIS_HEIGHT_NO_LABEL_PX;</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+          labelTier.vertOffset = totalAxisLabelHeight;</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+          totalAxisLabelHeight += labelTier.vertHeight +</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+                                  this._AXIS_VERT_SPACING_PX;</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+          break;</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+        }</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+      }</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+    }</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+    let barWidth = barPix - this._BAR_SPACING_PX;</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+    let barSpacing = this._BAR_SPACING_PX;</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineplus">+</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+    width = barPix * (rules.length - 1);</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+    // we ideally want this to be the same size as the max rows translates to...</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+    let height = 100;</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineplus">+    let ch = height - totalAxisLabelHeight;</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+    let [bins, maxBinSize] = this.binBySpan(scale, span, rules);</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+    // build empty bins for our hot bins</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+    this.emptyBins = [0 for each (bin in bins)];</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+    let binScale = maxBinSize ? (ch / maxBinSize) : 1;</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+    let vis = this.vis = new pv.Panel().canvas(this.canvasNode)</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+      // dimensions</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+      .width(width).height(ch)</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+      // margins</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+      .bottom(totalAxisLabelHeight);</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+    let faceter = this.faceter;</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+    // bin bars...</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+    vis.add(pv.Bar)</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+      .data(bins)</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+      .bottom(0)</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineplus">+      .height(function (d) Math.floor(d.items.length * binScale))</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineplus">+      .width(function() barWidth)</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineplus">+      .left(function() this.index * barPix)</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+      .fillStyle(&quot;#add2fb&quot;)</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineplus">+      .event(&quot;mouseover&quot;, function(d) this.fillStyle(&quot;#3465a4&quot;))</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineplus">+      .event(&quot;mouseout&quot;, function(d) this.fillStyle(&quot;#add2fb&quot;))</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineplus">+      .event(&quot;click&quot;, function(d)</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineplus">+        FacetContext.addFacetConstraint(faceter, true,</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineplus">+                                        [[d.startDate, d.endDate]],</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineplus">+                                        true, true));</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineplus">+    this.hotBars = vis.add(pv.Bar)</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+      .data(this.emptyBins)</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+      .bottom(0)</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+      .height(function (d) Math.floor(d * binScale))</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineplus">+      .width(function() barWidth)</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineplus">+      .left(function() this.index * barPix)</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineplus">+      .fillStyle(&quot;#3465a4&quot;);</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineplus">+</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+    for each (let [, labelTier] in Iterator(labelTiers)) {</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+      let labelBar = vis.add(pv.Bar)</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineplus">+        .data(labelTier.displayValues)</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineplus">+        .bottom(-totalAxisLabelHeight + labelTier.vertOffset)</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineplus">+        .height(labelTier.vertHeight)</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineplus">+        .left(function(d) Math.floor(width * d[0]))</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineplus">+        .width(function(d)</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineplus">+                 Math.floor(width * d[1]) - Math.floor(width * d[0]) - 1)</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineplus">+        .fillStyle(&quot;#dddddd&quot;)</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineplus">+        .event(&quot;mouseover&quot;, function(d) this.fillStyle(&quot;#3465a4&quot;))</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+        .event(&quot;mouseout&quot;, function(d) this.fillStyle(&quot;#dddddd&quot;))</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineplus">+        .event(&quot;click&quot;, function(d)</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineplus">+          FacetContext.addFacetConstraint(faceter, true,</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+                                          [[d[3], d[4]]], true, true));</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineplus">+</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineplus">+      if (labelTier.displayLabel) {</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineplus">+        labelBar.anchor(&quot;top&quot;).add(pv.Label)</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineplus">+          .font(this._AXIS_FONT)</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineplus">+          .textAlign(&quot;center&quot;)</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineplus">+          .textBaseline(&quot;top&quot;)</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineplus">+          .textStyle(&quot;black&quot;)</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+          .text(function(d) d[2]);</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineplus">+      }</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineplus">+    }</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineplus">+</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineplus">+    vis.render();</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineplus">+  },</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineplus">+</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineplus">+  hoverItems: function(aItems) {</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineplus">+    let itemToBin = this.itemToBin;</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineplus">+    let bins = this.emptyBins.concat();</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineplus">+      if (item.id in itemToBin)</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineplus">+        bins[itemToBin[item.id]]++;</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineplus">+    }</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineplus">+    this.hotBars.data(bins);</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineplus">+    this.vis.render();</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineplus">+  },</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineplus">+</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineplus">+  clearHover: function() {</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineplus">+    this.hotBars.data(this.emptyBins);</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineplus">+    this.vis.render();</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineplus">+  },</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineplus">+</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+  /**</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+   * Bin items at the given span granularity with the set of rules generated</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineplus">+   *  for the given span.  This could equally as well be done as a pre-built</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+   *  array of buckets with a linear scan of items and a calculation of what</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineplus">+   *  bucket they should be placed in.</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+   */</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineplus">+  binBySpan: function(aScale, aSpan, aRules, aItems) {</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+    let bins = [];</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+    let maxBinSize = 0;</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineplus">+    let binCount = aRules.length - 1;</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineplus">+    let itemToBin = this.itemToBin = {};</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineplus">+</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineplus">+    // We used to break this out by case, but that was a lot of code, and it was</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineplus">+    //  somewhat ridiculous.  So now we just do the simple, if somewhat more</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineplus">+    //  expensive thing.  Reviewer, feel free to thank me.</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+    // We do a pass through the rules, mapping each rounded rule to a bin.  We</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+    //  then do a pass through all of the items, rounding them down and using</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineplus">+    //  that to perform a lookup against the map.  We could special-case the</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineplus">+    //  rounding, but I doubt it's worth it.</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineplus">+    let binMap = {};</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineplus">+    for (let iRule = 0; iRule &lt; binCount; iRule++) {</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineplus">+      let binStartDate = aRules[iRule], binEndDate = aRules[iRule+1];</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineplus">+      binMap[binStartDate.valueOf().toString()] = iRule;</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineplus">+      bins.push({items: [],</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineplus">+                 startDate: binStartDate,</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineplus">+                 endDate: binEndDate});</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineplus">+    }</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+    for each (let [, item] in Iterator(this.faceter.validItems)) {</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineplus">+      let val = item[attrKey];</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineplus">+      // round it to the rule...</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineplus">+      val = aScale.round(val, aSpan, false);</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineplus">+      // which we can then map...</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineplus">+      let itemBin = binMap[val.valueOf().toString()];</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineplus">+      itemToBin[item.id] = itemBin;</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineplus">+      bins[itemBin].items.push(item);</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineplus">+    }</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineplus">+    for each (let [, bin] in Iterator(bins)) {</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineplus">+      maxBinSize = Math.max(bin.items.length, maxBinSize);</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineplus">+    }</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineplus">+</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineplus">+    return [bins, maxBinSize];</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineplus">+  }</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineplus">+</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1018,17 +1018,21 @@ function SelectedMessagesAreRead()</span>
<a href="#l12.4"></a><span id="l12.4"> function SelectedMessagesAreFlagged()</span>
<a href="#l12.5"></a><span id="l12.5"> {</span>
<a href="#l12.6"></a><span id="l12.6">   let firstSelectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l12.7"></a><span id="l12.7">   return firstSelectedMessage &amp;&amp; firstSelectedMessage.isFlagged;</span>
<a href="#l12.8"></a><span id="l12.8"> }</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> function GetFirstSelectedMsgFolder()</span>
<a href="#l12.11"></a><span id="l12.11"> {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  try {</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+    var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+  } catch (e) {</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+    logException(e);</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+  }</span>
<a href="#l12.18"></a><span id="l12.18">   return (selectedFolders.length &gt; 0) ? selectedFolders[0] : null;</span>
<a href="#l12.19"></a><span id="l12.19"> }</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21"> function GetInboxFolder(server)</span>
<a href="#l12.22"></a><span id="l12.22"> {</span>
<a href="#l12.23"></a><span id="l12.23">   try {</span>
<a href="#l12.24"></a><span id="l12.24">     var rootMsgFolder = server.rootMsgFolder;</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26" class="difflineat">@@ -1662,17 +1666,17 @@ function CreateToolbarTooltip(document, </span>
<a href="#l12.27"></a><span id="l12.27">   if (tn.hasAttribute(&quot;label&quot;)) {</span>
<a href="#l12.28"></a><span id="l12.28">     event.target.setAttribute(&quot;label&quot;, tn.getAttribute(&quot;label&quot;));</span>
<a href="#l12.29"></a><span id="l12.29">     return true;</span>
<a href="#l12.30"></a><span id="l12.30">   }</span>
<a href="#l12.31"></a><span id="l12.31">   return false;</span>
<a href="#l12.32"></a><span id="l12.32"> }</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34"> /**</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">- * Displays message &quot;folder&quot;s, mail &quot;message&quot;s, and &quot;glodaSearch&quot; results.  The</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ * Displays message &quot;folder&quot;s, mail &quot;message&quot;s, and &quot;glodaList&quot; results.  The</span>
<a href="#l12.37"></a><span id="l12.37">  *  commonality is that they all use the &quot;mailContent&quot; panel's folder tree,</span>
<a href="#l12.38"></a><span id="l12.38">  *  thread tree, and message pane objects.  This happens for historical reasons,</span>
<a href="#l12.39"></a><span id="l12.39">  *  likely involving the fact that prior to the introduction of this</span>
<a href="#l12.40"></a><span id="l12.40">  *  abstraction, everything was always stored in global objects.  For the 3.0</span>
<a href="#l12.41"></a><span id="l12.41">  *  release cycle we considered avoiding this 'multiplexed' style of operation</span>
<a href="#l12.42"></a><span id="l12.42">  *  but decided against moving to making each tab be indepdendent because of</span>
<a href="#l12.43"></a><span id="l12.43">  *  presumed complexity.</span>
<a href="#l12.44"></a><span id="l12.44">  *</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineat">@@ -1741,16 +1745,21 @@ let mailTabType = {</span>
<a href="#l12.46"></a><span id="l12.46">         // (We don't want to assume that our immediate predecessor was a</span>
<a href="#l12.47"></a><span id="l12.47">         //  &quot;folder&quot; tab.)</span>
<a href="#l12.48"></a><span id="l12.48">         let modelTab = document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l12.49"></a><span id="l12.49">                          .getTabInfoForCurrentOrFirstModeInstance(aTab.mode);</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51">         if (modelTab)</span>
<a href="#l12.52"></a><span id="l12.52">           aTab.folderPaneCollapsed = modelTab.folderPaneCollapsed;</span>
<a href="#l12.53"></a><span id="l12.53"> </span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+        if (&quot;searchMode&quot; in aArgs)</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+          aTab.searchState = {'mode': aArgs.searchMode, 'string': ''};</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+        else if (modelTab)</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+          aTab.searchState = {'mode': modelTab.searchMode, 'string': ''};</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+</span>
<a href="#l12.59"></a><span id="l12.59">         // - figure out whether to show the message pane</span>
<a href="#l12.60"></a><span id="l12.60">         let messagePaneShouldBeVisible;</span>
<a href="#l12.61"></a><span id="l12.61">         // explicitly told to us?</span>
<a href="#l12.62"></a><span id="l12.62">         if (&quot;messagePaneVisible&quot; in aArgs)</span>
<a href="#l12.63"></a><span id="l12.63">           messagePaneShouldBeVisible = aArgs.messagePaneVisible;</span>
<a href="#l12.64"></a><span id="l12.64">         // inherit from the previous tab (if we've got one)</span>
<a href="#l12.65"></a><span id="l12.65">         else if (modelTab)</span>
<a href="#l12.66"></a><span id="l12.66">           messagePaneShouldBeVisible = modelTab.messageDisplay.visible;</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineat">@@ -1791,20 +1800,22 @@ let mailTabType = {</span>
<a href="#l12.68"></a><span id="l12.68">         aTab.mode.onTitleChanged.call(this, aTab, aTab.tabNode);</span>
<a href="#l12.69"></a><span id="l12.69">       },</span>
<a href="#l12.70"></a><span id="l12.70">       persistTab: function(aTab) {</span>
<a href="#l12.71"></a><span id="l12.71">         if (!aTab.folderDisplay.displayedFolder)</span>
<a href="#l12.72"></a><span id="l12.72">           return null;</span>
<a href="#l12.73"></a><span id="l12.73">         return {</span>
<a href="#l12.74"></a><span id="l12.74">           folderURI: aTab.folderDisplay.displayedFolder.URI,</span>
<a href="#l12.75"></a><span id="l12.75">           messagePaneVisible: aTab.messageDisplay.visible,</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-          firstTab: aTab.firstTab</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+          firstTab: aTab.firstTab,</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+          searchMode: aTab.searchState['mode']</span>
<a href="#l12.79"></a><span id="l12.79">         };</span>
<a href="#l12.80"></a><span id="l12.80">       },</span>
<a href="#l12.81"></a><span id="l12.81">       restoreTab: function(aTabmail, aPersistedState) {</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+      try {</span>
<a href="#l12.83"></a><span id="l12.83">         let rdfService = Components.classes['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l12.84"></a><span id="l12.84">                            .getService(Components.interfaces.nsIRDFService);</span>
<a href="#l12.85"></a><span id="l12.85">         let folder = rdfService.GetResource(aPersistedState.folderURI)</span>
<a href="#l12.86"></a><span id="l12.86">                        .QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l12.87"></a><span id="l12.87">         // if the folder no longer exists, we can't restore the tab</span>
<a href="#l12.88"></a><span id="l12.88">         if (folder) {</span>
<a href="#l12.89"></a><span id="l12.89">           // If we are talking about the first tab, it already exists and we</span>
<a href="#l12.90"></a><span id="l12.90">           //  should poke it.  We are assuming it is the currently displayed</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineat">@@ -1815,24 +1826,29 @@ let mailTabType = {</span>
<a href="#l12.92"></a><span id="l12.92">               MsgToggleMessagePane();</span>
<a href="#l12.93"></a><span id="l12.93">               // For reasons that are not immediately obvious, sometimes the</span>
<a href="#l12.94"></a><span id="l12.94">               //  message display is not active at this time.  In that case, we</span>
<a href="#l12.95"></a><span id="l12.95">               //  need to explicitly set the _visible value because otherwise it</span>
<a href="#l12.96"></a><span id="l12.96">               //  misses out on the toggle event.</span>
<a href="#l12.97"></a><span id="l12.97">               if (!gMessageDisplay._active)</span>
<a href="#l12.98"></a><span id="l12.98">                 gMessageDisplay._visible = aPersistedState.messagePaneVisible;</span>
<a href="#l12.99"></a><span id="l12.99">             }</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+            document.getElementById('searchInput').searchMode = aPersistedState.searchMode;</span>
<a href="#l12.101"></a><span id="l12.101">             gFolderTreeView.selectFolder(folder);</span>
<a href="#l12.102"></a><span id="l12.102">           }</span>
<a href="#l12.103"></a><span id="l12.103">           else {</span>
<a href="#l12.104"></a><span id="l12.104">             aTabmail.openTab(&quot;folder&quot;, {folder: folder,</span>
<a href="#l12.105"></a><span id="l12.105">                 messagePaneVisible: aPersistedState.messagePaneVisible,</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+                searchMode: aPersistedState.searchMode,</span>
<a href="#l12.107"></a><span id="l12.107">                 background: true});</span>
<a href="#l12.108"></a><span id="l12.108">           }</span>
<a href="#l12.109"></a><span id="l12.109">         }</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+      } catch (e) {</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+        logException(e);</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+      }</span>
<a href="#l12.113"></a><span id="l12.113">       },</span>
<a href="#l12.114"></a><span id="l12.114">       onTitleChanged: function(aTab, aTabNode) {</span>
<a href="#l12.115"></a><span id="l12.115">         if (!aTab.folderDisplay || !aTab.folderDisplay.displayedFolder) {</span>
<a href="#l12.116"></a><span id="l12.116">           // Don't show &quot;undefined&quot; as title when there is no account.</span>
<a href="#l12.117"></a><span id="l12.117">           aTab.title = &quot; &quot;;</span>
<a href="#l12.118"></a><span id="l12.118">           return;</span>
<a href="#l12.119"></a><span id="l12.119">         }</span>
<a href="#l12.120"></a><span id="l12.120">         // The user may have changed folders, triggering our onTitleChanged</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineat">@@ -1937,75 +1953,87 @@ let mailTabType = {</span>
<a href="#l12.122"></a><span id="l12.122">           aTab.title += &quot; - &quot; + aMsgHdr.folder.server.prettyName;</span>
<a href="#l12.123"></a><span id="l12.123">       },</span>
<a href="#l12.124"></a><span id="l12.124">       getBrowser: function(aTab) {</span>
<a href="#l12.125"></a><span id="l12.125">         // Message tabs always use the messagepane browser.</span>
<a href="#l12.126"></a><span id="l12.126">         return document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l12.127"></a><span id="l12.127">       }</span>
<a href="#l12.128"></a><span id="l12.128">     },</span>
<a href="#l12.129"></a><span id="l12.129">     /**</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-     * The glodaSearch view displays a gloda-backed nsMsgDBView with only the</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+     * The glodaList view displays a gloda-backed nsMsgDBView with only the</span>
<a href="#l12.132"></a><span id="l12.132">      *  thread pane and (potentially) the message pane displayed; the folder</span>
<a href="#l12.133"></a><span id="l12.133">      *  pane is forced hidden.</span>
<a href="#l12.134"></a><span id="l12.134">      */</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-    glodaSearch: {</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+    glodaList: {</span>
<a href="#l12.137"></a><span id="l12.137">       type: &quot;glodaSearch&quot;,</span>
<a href="#l12.138"></a><span id="l12.138">       /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l12.139"></a><span id="l12.139">       legalPanes: {</span>
<a href="#l12.140"></a><span id="l12.140">         folder: false,</span>
<a href="#l12.141"></a><span id="l12.141">         thread: true,</span>
<a href="#l12.142"></a><span id="l12.142">         message: true,</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-        glodaFacets: false,</span>
<a href="#l12.144"></a><span id="l12.144">       },</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+      /**</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+       * The default set of columns to show.  This really should just be for</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+       *  boot-strapping and should be persisted after that...</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+       */</span>
<a href="#l12.149"></a><span id="l12.149">       desiredColumnStates: {</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+        threadCol: {</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+          visible: true,</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+        },</span>
<a href="#l12.153"></a><span id="l12.153">         flaggedCol: {</span>
<a href="#l12.154"></a><span id="l12.154">           visible: true,</span>
<a href="#l12.155"></a><span id="l12.155">         },</span>
<a href="#l12.156"></a><span id="l12.156">         subjectCol: {</span>
<a href="#l12.157"></a><span id="l12.157">           visible: true,</span>
<a href="#l12.158"></a><span id="l12.158">         },</span>
<a href="#l12.159"></a><span id="l12.159">         senderCol: {</span>
<a href="#l12.160"></a><span id="l12.160">           visible: true,</span>
<a href="#l12.161"></a><span id="l12.161">         },</span>
<a href="#l12.162"></a><span id="l12.162">         dateCol: {</span>
<a href="#l12.163"></a><span id="l12.163">           visible: true,</span>
<a href="#l12.164"></a><span id="l12.164">         },</span>
<a href="#l12.165"></a><span id="l12.165">       },</span>
<a href="#l12.166"></a><span id="l12.166">       /**</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-       * Open a new tab whose view is backed by a gloda search.</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+       * Open a new folder-display-style tab showing the contents of a gloda</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+       *  query/collection.  You must pass one of 'query'/'collection'/</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+       *  'conversation'</span>
<a href="#l12.171"></a><span id="l12.171">        *</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-       * @param searchString</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineminus">-       * @param facetString</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineminus">-       *     - everything:</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineminus">-       *     - subject:</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-       *     - involves:</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineminus">-       *     - to:</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineminus">-       *     - from:</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineminus">-       *     - body:</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineminus">-       * @param location Either a GlodaFolder or the string &quot;everywhere&quot;.</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+       * @param {GlodaQuery} [aArgs.query] An un-triggered gloda query to use.</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+       *     Alternatively, if you already have a collection, you can pass that</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+       *     instead as 'collection'.</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+       * @param {GlodaCollection} [aArgs.collection] A gloda collection to</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+       *     display.</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+       * @param {GlodaConversation} [aArgs.conversation] A conversation whose</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+       *     messages you want to display.</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+       * @param {GlodaMessage} [aArgs.message] The message to select in the</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+       *     conversation, if provided.</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+       * @param aArgs.title The title to give to the tab.  If this is not user</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+       *     content (a search string, a message subject, etc.), make sure you</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+       *     are using a localized string.</span>
<a href="#l12.193"></a><span id="l12.193">        *</span>
<a href="#l12.194"></a><span id="l12.194">        * XXX This needs to handle opening in the background</span>
<a href="#l12.195"></a><span id="l12.195">        */</span>
<a href="#l12.196"></a><span id="l12.196">       openTab: function(aTab, aArgs) {</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineminus">-        // make sure the search string bundle is loaded</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineminus">-        getDocumentElements();</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineminus">-        aTab.title = gSearchBundle.getFormattedString(&quot;glodaSearchTabTitle&quot;,</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-                                                      [aArgs.searchString]);</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineminus">-        aTab.glodaSearchInputValue = aArgs.searchString;</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineminus">-        aTab.searchString = aArgs.searchString;</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineminus">-        aTab.facetString = aArgs.facetString;</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineminus">-</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineminus">-        aTab.glodaSynView = new GlodaSyntheticSearchView(aArgs.searchString,</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-                                                         aArgs.facetString,</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineminus">-                                                         aArgs.location);</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+        aTab.glodaSynView = new GlodaSyntheticView(aArgs);</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+        aTab.title = aArgs.title;</span>
<a href="#l12.210"></a><span id="l12.210"> </span>
<a href="#l12.211"></a><span id="l12.211">         this.openTab(aTab, false, new MessagePaneDisplayWidget());</span>
<a href="#l12.212"></a><span id="l12.212">         aTab.folderDisplay.show(aTab.glodaSynView);</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+        // XXX persist column states in preferences or session store or other</span>
<a href="#l12.214"></a><span id="l12.214">         aTab.folderDisplay.setColumnStates(aTab.mode.desiredColumnStates);</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-        aTab.folderDisplay.makeActive();</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+        aTab.folderDisplay.view.showThreaded = true;</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+        let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+        if (!background)</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+          aTab.folderDisplay.makeActive();</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+        if (&quot;message&quot; in aArgs) {</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+          let hdr = aArgs.message.folderMessage;</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+          if (hdr)</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+            aTab.folderDisplay.selectMessage(hdr);</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+        }</span>
<a href="#l12.226"></a><span id="l12.226">       },</span>
<a href="#l12.227"></a><span id="l12.227">       getBrowser: function(aTab) {</span>
<a href="#l12.228"></a><span id="l12.228">         // If we are currently a thread summary, we want to select the multi</span>
<a href="#l12.229"></a><span id="l12.229">         // message browser rather than the message pane.</span>
<a href="#l12.230"></a><span id="l12.230">         return gMessageDisplay.singleMessageDisplay ?</span>
<a href="#l12.231"></a><span id="l12.231">                document.getElementById(&quot;messagepane&quot;) :</span>
<a href="#l12.232"></a><span id="l12.232">                document.getElementById(&quot;multimessage&quot;);</span>
<a href="#l12.233"></a><span id="l12.233">       }</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineat">@@ -2149,17 +2177,16 @@ let mailTabType = {</span>
<a href="#l12.235"></a><span id="l12.235">    *     the value is true, then the pane is legal.  Omitted pane keys imply</span>
<a href="#l12.236"></a><span id="l12.236">    *     that the pane is illegal.  Keys are:</span>
<a href="#l12.237"></a><span id="l12.237">    *     - folder: The folder (tree) pane.</span>
<a href="#l12.238"></a><span id="l12.238">    *     - thread: The thread pane.</span>
<a href="#l12.239"></a><span id="l12.239">    *     - accountCentral: While it's in a deck with the thread pane, this</span>
<a href="#l12.240"></a><span id="l12.240">    *        is distinct from the thread pane because some other things depend</span>
<a href="#l12.241"></a><span id="l12.241">    *        on whether it's actually the thread pane we are showing.</span>
<a href="#l12.242"></a><span id="l12.242">    *     - message: The message pane.  Required/assumed to be true for now.</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineminus">-   *     - glodaFacets: The gloda search facets pane.</span>
<a href="#l12.244"></a><span id="l12.244">    * @param aVisibleStates A dictionary where each value indicates whether the</span>
<a href="#l12.245"></a><span id="l12.245">    *     pane should be 'visible' (not collapsed).  Only panes that are governed</span>
<a href="#l12.246"></a><span id="l12.246">    *     by splitters are options here.  Keys are:</span>
<a href="#l12.247"></a><span id="l12.247">    *     - folder: The folder (tree) pane.</span>
<a href="#l12.248"></a><span id="l12.248">    *     - message: The message pane.</span>
<a href="#l12.249"></a><span id="l12.249">    */</span>
<a href="#l12.250"></a><span id="l12.250">   _setPaneStates: function mailTabType_setPaneStates(aLegalStates,</span>
<a href="#l12.251"></a><span id="l12.251">                                                      aVisibleStates) {</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineat">@@ -2236,20 +2263,16 @@ let mailTabType = {</span>
<a href="#l12.253"></a><span id="l12.253"> </span>
<a href="#l12.254"></a><span id="l12.254">     // we are responsible for updating the keybinding; view_init takes care of</span>
<a href="#l12.255"></a><span id="l12.255">     //  updating the menu item (on demand)</span>
<a href="#l12.256"></a><span id="l12.256">     let messagePaneToggleKey = document.getElementById(&quot;key_toggleMessagePane&quot;);</span>
<a href="#l12.257"></a><span id="l12.257">     if (aLegalStates.thread)</span>
<a href="#l12.258"></a><span id="l12.258">       messagePaneToggleKey.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l12.259"></a><span id="l12.259">     else</span>
<a href="#l12.260"></a><span id="l12.260">       messagePaneToggleKey.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineminus">-</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineminus">-    // -- gloda facets</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineminus">-    document.getElementById(&quot;glodaSearchFacets&quot;).hidden =</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineminus">-      !aLegalStates.glodaFacets;</span>
<a href="#l12.265"></a><span id="l12.265">   },</span>
<a href="#l12.266"></a><span id="l12.266"> </span>
<a href="#l12.267"></a><span id="l12.267">   showTab: function(aTab) {</span>
<a href="#l12.268"></a><span id="l12.268">     // Set the messagepane as the primary browser for content.</span>
<a href="#l12.269"></a><span id="l12.269">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;,</span>
<a href="#l12.270"></a><span id="l12.270">                                                         &quot;content-primary&quot;);</span>
<a href="#l12.271"></a><span id="l12.271"> </span>
<a href="#l12.272"></a><span id="l12.272">     aTab.folderDisplay.makeActive();</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineat">@@ -2277,52 +2300,16 @@ let mailTabType = {</span>
<a href="#l12.274"></a><span id="l12.274">   // We ignore the aTab parameter sent by tabmail when calling nsIController</span>
<a href="#l12.275"></a><span id="l12.275">   // stuff and just delegate the call to a default controller by using it as</span>
<a href="#l12.276"></a><span id="l12.276">   // our proto chain:</span>
<a href="#l12.277"></a><span id="l12.277">   // - &quot;DefaultController&quot; is the default controller of messenger.xul</span>
<a href="#l12.278"></a><span id="l12.278">   // - &quot;MessageWindowController&quot; is the default controller of messageWindow.xul</span>
<a href="#l12.279"></a><span id="l12.279">   __proto__: &quot;DefaultController&quot; in window &amp;&amp; window.DefaultController ||</span>
<a href="#l12.280"></a><span id="l12.280">              &quot;MessageWindowController&quot; in window &amp;&amp; window.MessageWindowController</span>
<a href="#l12.281"></a><span id="l12.281"> };</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineminus">-/**</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineminus">- * The glodaSearch tab mode has a UI widget outside of the mailTabType's</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineminus">- *  display panel, the #glodaSearchInput textbox.  This means we need to use a</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineminus">- *  tab monitor so that we can appropriately update the contents of the textbox.</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineminus">- * Every time a tab is changed, we save the state of the text box and restore</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineminus">- *  its previous value for the tab we are switching to, as well as whether this</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineminus">- *  value is a change to the currently-used value (if it is a glodaSearch) tab.</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineminus">- *  The behaviour rationale for this is that the glodaSearchInput is like the</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineminus">- *  URL bar.  When you are on a glodaSearch tab, we need to show you your</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineminus">- *  current value, including any &quot;uncommitted&quot; (you haven't hit enter yet)</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineminus">- *  changes.  It's not entirely clear that imitating this behaviour on</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineminus">- *  non-glodaSearch tabs makes a lot of sense, but it is consistent, so we do</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineminus">- *  so.  The counter-example to this choice is the search box in firefox, but</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineminus">- *  it never updates when you switch tabs, so it is arguably less of a fit.</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineminus">- */</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineminus">-var glodaSearchTabMonitor = {</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineminus">-  onTabTitleChanged: function() {},</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineminus">-  onTabSwitched: function glodaSearchTabMonitor_onTabSwitch(aTab, aOldTab) {</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineminus">-    let inputNode = document.getElementById(&quot;glodaSearchInput&quot;);</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineminus">-    if (!inputNode)</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineminus">-      return;</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineminus">-</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineminus">-    // save the current search field value</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineminus">-    if (aOldTab)</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineminus">-      aOldTab.glodaSearchInputValue = inputNode.value;</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineminus">-    // load (or clear if there is none) the persisted search field value</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineminus">-    inputNode.value = aTab.glodaSearchInputValue || &quot;&quot;;</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineminus">-</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineminus">-    // If the mode is glodaSearch and the search is unchanged, then we want to</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineminus">-    //  set the icon state of the input box to be the 'clear' icon.</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineminus">-    if (aTab.mode.name == &quot;glodaSearch&quot;) {</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineminus">-      if (aTab.searchString == aTab.glodaSearchInputValue)</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineminus">-        inputNode._searchIcons.selectedIndex = 1;</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineminus">-    }</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineminus">-  }</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineminus">-};</span>
<a href="#l12.318"></a><span id="l12.318"> </span>
<a href="#l12.319"></a><span id="l12.319"> </span>
<a href="#l12.320"></a><span id="l12.320"> function MsgOpenNewWindowForFolder(folderURI, msgKeyToSelect)</span>
<a href="#l12.321"></a><span id="l12.321"> {</span>
<a href="#l12.322"></a><span id="l12.322">   if (folderURI) {</span>
<a href="#l12.323"></a><span id="l12.323">     window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l12.324"></a><span id="l12.324">                       &quot;chrome,all,dialog=no&quot;, folderURI, msgKeyToSelect);</span>
<a href="#l12.325"></a><span id="l12.325">     return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1762,19 +1762,19 @@</span>
<a href="#l13.4"></a><span id="l13.4">   --&gt;</span>
<a href="#l13.5"></a><span id="l13.5">   &lt;toolbar id=&quot;mail-bar2&quot; class=&quot;toolbar-primary chromeclass-toolbar&quot;</span>
<a href="#l13.6"></a><span id="l13.6">            toolbarname=&quot;&amp;showMessengerToolbarCmd.label;&quot;</span>
<a href="#l13.7"></a><span id="l13.7">            accesskey=&quot;&amp;showMessengerToolbarCmd.accesskey;&quot;</span>
<a href="#l13.8"></a><span id="l13.8">            fullscreentoolbar=&quot;true&quot; mode=&quot;full&quot;</span>
<a href="#l13.9"></a><span id="l13.9">            customizable=&quot;true&quot;</span>
<a href="#l13.10"></a><span id="l13.10">            context=&quot;toolbar-context-menu&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #ifdef XP_MACOSX</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-           defaultset=&quot;button-getmsg,button-newmsg,button-address,spacer,button-reply,button-replyall,button-replylist,button-forward,spacer,button-tag,button-delete,button-junk,button-print,spacer,button-goback,button-goforward,spring,search-container,throbber-box&quot;&gt;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+           defaultset=&quot;button-getmsg,button-newmsg,button-address,spacer,button-reply,button-replyall,button-replylist,button-forward,spacer,button-tag,button-delete,button-junk,button-print,spacer,button-goback,button-goforward,spring,gloda-search,throbber-box&quot;&gt;</span>
<a href="#l13.14"></a><span id="l13.14"> #else</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-           defaultset=&quot;button-getmsg,button-newmsg,button-address,separator,button-reply,button-replyall,button-replylist,button-forward,separator,button-tag,button-delete,button-junk,button-print,separator,button-goback,button-goforward,spring,search-container&quot;&gt;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+           defaultset=&quot;button-getmsg,button-newmsg,button-address,separator,button-reply,button-replyall,button-replylist,button-forward,separator,button-tag,button-delete,button-junk,button-print,separator,button-goback,button-goforward,spring,gloda-search&quot;&gt;</span>
<a href="#l13.17"></a><span id="l13.17"> #endif</span>
<a href="#l13.18"></a><span id="l13.18">   &lt;/toolbar&gt;</span>
<a href="#l13.19"></a><span id="l13.19">   &lt;toolbarset id=&quot;customToolbars&quot; context=&quot;toolbar-context-menu&quot;/&gt;</span>
<a href="#l13.20"></a><span id="l13.20"> &lt;/toolbox&gt;</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22"> &lt;!-- The msgNotificationBar appears on top of the message and displays</span>
<a href="#l13.23"></a><span id="l13.23">      information like: junk, contains remote images, or is a suspected phishing</span>
<a href="#l13.24"></a><span id="l13.24">      URL.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/base/content/messenger.css</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/base/content/messenger.css</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -159,29 +159,21 @@ searchterm {</span>
<a href="#l14.4"></a><span id="l14.4"> .ruleactiontarget[type=&quot;replytomessage&quot;] {</span>
<a href="#l14.5"></a><span id="l14.5">   -moz-binding: url(&quot;chrome://messenger/content/searchWidgets.xml#ruleactiontarget-replyto&quot;);</span>
<a href="#l14.6"></a><span id="l14.6"> }</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> dummy.usesMailWidgets {</span>
<a href="#l14.9"></a><span id="l14.9">   -moz-binding: url(&quot;chrome://messenger/content/mailWidgets.xml#dummy&quot;);</span>
<a href="#l14.10"></a><span id="l14.10"> }</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#glodaSearchInput {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+#searchInput {</span>
<a href="#l14.14"></a><span id="l14.14">   -moz-binding: url(&quot;chrome://messenger/content/search.xml#glodaSearch&quot;);</span>
<a href="#l14.15"></a><span id="l14.15"> }</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-#glodaSearchFacets {</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-  -moz-binding: url(&quot;chrome://messenger/content/search.xml#glodaFacets&quot;);</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-}</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-#searchInput {</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-  -moz-binding: url(&quot;chrome://messenger/content/search.xml#searchbar&quot;);</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-}</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-#quick-search-button {</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+.quick-search-button {</span>
<a href="#l14.27"></a><span id="l14.27">   -moz-binding: url(&quot;chrome://messenger/content/search.xml#searchBarDropMarker&quot;);</span>
<a href="#l14.28"></a><span id="l14.28">   cursor: default;</span>
<a href="#l14.29"></a><span id="l14.29">   -moz-user-focus: none;</span>
<a href="#l14.30"></a><span id="l14.30"> }</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32"> .quick-search-clearbutton{</span>
<a href="#l14.33"></a><span id="l14.33">   cursor: default;</span>
<a href="#l14.34"></a><span id="l14.34">   -moz-user-focus: none;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/base/content/messenger.xul</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/base/content/messenger.xul</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -35,16 +35,18 @@</span>
<a href="#l15.4"></a><span id="l15.4"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.5"></a><span id="l15.5"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.6"></a><span id="l15.6"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.7"></a><span id="l15.7"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.8"></a><span id="l15.8"> #</span>
<a href="#l15.9"></a><span id="l15.9"> # ***** END LICENSE BLOCK *****</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> &lt;?xml-stylesheet href=&quot;chrome://messenger/skin/mailWindow1.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://gloda/content/glodacomplete.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15"> &lt;?xul-overlay href=&quot;chrome://communicator/content/utilityOverlay.xul&quot;?&gt;</span>
<a href="#l15.16"></a><span id="l15.16"> &lt;?xul-overlay href=&quot;chrome://messenger/content/msgHdrViewOverlay.xul&quot;?&gt;</span>
<a href="#l15.17"></a><span id="l15.17"> &lt;?xul-overlay href=&quot;chrome://messenger/content/mailWindowOverlay.xul&quot;?&gt;</span>
<a href="#l15.18"></a><span id="l15.18"> &lt;?xul-overlay href=&quot;chrome://messenger/content/extraCustomizeItems.xul&quot;?&gt;</span>
<a href="#l15.19"></a><span id="l15.19"> &lt;?xul-overlay href=&quot;chrome://messenger/content/mailOverlay.xul&quot;?&gt;</span>
<a href="#l15.20"></a><span id="l15.20"> &lt;?xul-overlay href=&quot;chrome://messenger/content/editContactOverlay.xul&quot;?&gt;</span>
<a href="#l15.21"></a><span id="l15.21"> &lt;?xul-overlay href=&quot;chrome://messenger/content/specialTabs.xul&quot;?&gt;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -85,22 +87,23 @@</span>
<a href="#l15.23"></a><span id="l15.23"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/widgetglue.js&quot;/&gt;</span>
<a href="#l15.24"></a><span id="l15.24"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/commandglue.js&quot;/&gt;</span>
<a href="#l15.25"></a><span id="l15.25"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/shareglue.js&quot;/&gt;</span>
<a href="#l15.26"></a><span id="l15.26"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/msgViewNavigation.js&quot;/&gt;</span>
<a href="#l15.27"></a><span id="l15.27"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailWindow.js&quot;/&gt;</span>
<a href="#l15.28"></a><span id="l15.28"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/selectionsummaries.js&quot;/&gt;</span>
<a href="#l15.29"></a><span id="l15.29"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/msgMail3PaneWindow.js&quot;/&gt;</span>
<a href="#l15.30"></a><span id="l15.30"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/specialTabs.js&quot;/&gt;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+&lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/glodaFacetTab.js&quot;/&gt;</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+&lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/searchBar.js&quot;/&gt;</span>
<a href="#l15.33"></a><span id="l15.33"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mail3PaneWindowCommands.js&quot;/&gt;</span>
<a href="#l15.34"></a><span id="l15.34"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/contentAreaUtils.js&quot;/&gt;</span>
<a href="#l15.35"></a><span id="l15.35"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://communicator/content/nsContextMenu.js&quot;/&gt;</span>
<a href="#l15.36"></a><span id="l15.36"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailContextMenus.js&quot;/&gt;</span>
<a href="#l15.37"></a><span id="l15.37"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/accountUtils.js&quot;/&gt;</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-&lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/searchBar.js&quot;/&gt;</span>
<a href="#l15.39"></a><span id="l15.39"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/folderPane.js&quot;/&gt;</span>
<a href="#l15.40"></a><span id="l15.40"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/phishingDetector.js&quot;/&gt;</span>
<a href="#l15.41"></a><span id="l15.41"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://communicator/content/contentAreaClick.js&quot;/&gt;</span>
<a href="#l15.42"></a><span id="l15.42"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/nsDragAndDrop.js&quot;/&gt;</span>
<a href="#l15.43"></a><span id="l15.43"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/editContactOverlay.js&quot;/&gt;</span>
<a href="#l15.44"></a><span id="l15.44"> </span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46"> &lt;!-- move needed functions into a single js file --&gt;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineat">@@ -339,26 +342,16 @@</span>
<a href="#l15.48"></a><span id="l15.48">                         &lt;treecol id=&quot;totalCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l15.49"></a><span id="l15.49">                                  label=&quot;&amp;totalColumn.label;&quot; tooltiptext=&quot;&amp;totalColumn.tooltip;&quot;/&gt;</span>
<a href="#l15.50"></a><span id="l15.50">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l15.51"></a><span id="l15.51">                         &lt;treecol id=&quot;locationCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l15.52"></a><span id="l15.52">                                  label=&quot;&amp;locationColumn.label;&quot; tooltiptext=&quot;&amp;locationColumn.tooltip;&quot;/&gt;</span>
<a href="#l15.53"></a><span id="l15.53">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l15.54"></a><span id="l15.54">                         &lt;treecol id=&quot;idCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l15.55"></a><span id="l15.55">                                  label=&quot;&amp;idColumn.label;&quot; tooltiptext=&quot;&amp;idColumn.tooltip;&quot;/&gt;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-                        &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-                        &lt;treecol id=&quot;glodaWhyCol&quot; persist=&quot;width&quot; flex=&quot;1&quot;</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-                                 hidden=&quot;true&quot; ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-                                 label=&quot;&amp;glodaWhyColumn.label;&quot;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-                                 tooltiptext=&quot;&amp;glodaWhyColumn.tooltip;&quot;/&gt;</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-                        &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-                        &lt;treecol id=&quot;glodaScoreCol&quot; persist=&quot;width&quot; flex=&quot;1&quot;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-                                 hidden=&quot;true&quot; ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-                                 label=&quot;&amp;glodaScoreColumn.label;&quot;</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-                                 tooltiptext=&quot;&amp;glodaScoreColumn.tooltip;&quot;/&gt;</span>
<a href="#l15.66"></a><span id="l15.66">                       &lt;/treecols&gt;</span>
<a href="#l15.67"></a><span id="l15.67">                     &lt;treechildren ondraggesture=&quot;ThreadPaneOnDragStart(event);&quot;</span>
<a href="#l15.68"></a><span id="l15.68">                                   ondragover=&quot;ThreadPaneOnDragOver(event);&quot;</span>
<a href="#l15.69"></a><span id="l15.69">                                   ondrop=&quot;ThreadPaneOnDrop(event);&quot;/&gt;</span>
<a href="#l15.70"></a><span id="l15.70">                   &lt;/tree&gt;</span>
<a href="#l15.71"></a><span id="l15.71">                  &lt;/vbox&gt;</span>
<a href="#l15.72"></a><span id="l15.72">                 &lt;/hbox&gt;</span>
<a href="#l15.73"></a><span id="l15.73">                 &lt;!-- extensions may overlay in additional panels; don't assume that there are only 2! --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -278,18 +278,20 @@ function OnLoadMessenger()</span>
<a href="#l16.4"></a><span id="l16.4">   // Do this before LoadPostAccountWizard since that code selects the first</span>
<a href="#l16.5"></a><span id="l16.5">   //  folder for display, and we want gFolderDisplay setup and ready to handle</span>
<a href="#l16.6"></a><span id="l16.6">   //  that event chain.</span>
<a href="#l16.7"></a><span id="l16.7">   // Also, we definitely need to register the tab type prior to the call to</span>
<a href="#l16.8"></a><span id="l16.8">   //  specialTabs.openSpecialTabsOnStartup below.</span>
<a href="#l16.9"></a><span id="l16.9">   let tabmail = document.getElementById('tabmail');</span>
<a href="#l16.10"></a><span id="l16.10">   if (tabmail)</span>
<a href="#l16.11"></a><span id="l16.11">   {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+    // mailTabType is defined in mailWindowOverlay.js</span>
<a href="#l16.13"></a><span id="l16.13">     tabmail.registerTabType(mailTabType);</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-    tabmail.registerTabMonitor(glodaSearchTabMonitor);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+    // glodaFacetTab* in glodaFacetTab.js</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+    tabmail.registerTabType(glodaFacetTabType);</span>
<a href="#l16.17"></a><span id="l16.17">     tabmail.registerTabMonitor(QuickSearchTabMonitor);</span>
<a href="#l16.18"></a><span id="l16.18">     tabmail.registerTabMonitor(statusMessageCountsMonitor);</span>
<a href="#l16.19"></a><span id="l16.19">     tabmail.openFirstTab();</span>
<a href="#l16.20"></a><span id="l16.20">   }</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22">   // verifyAccounts returns true if the callback won't be called</span>
<a href="#l16.23"></a><span id="l16.23">   // We also don't want the account wizard to open if any sort of account exists</span>
<a href="#l16.24"></a><span id="l16.24">   if (verifyAccounts(LoadPostAccountWizard, false, AutoConfigWizard))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/mail/base/content/protovis-r2.6-modded.js</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,5390 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+var pv = function () {</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+/**</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ * @namespace The Protovis namespace, &lt;tt&gt;pv&lt;/tt&gt;. All public methods and fields</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+ * should be registered on this object. Note that core Protovis source is</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+ * surrounded by an anonymous function, so any other declared globals will not</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+ * be visible outside of core methods. This also allows multiple versions of</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+ * Protovis to coexist, since each version will see their own &lt;tt&gt;pv&lt;/tt&gt;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+ * namespace.</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+ */</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+var pv = {};</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+/**</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+ * Returns a prototype object suitable for extending the given class</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+ * &lt;tt&gt;f&lt;/tt&gt;. Rather than constructing a new instance of &lt;tt&gt;f&lt;/tt&gt; to serve as</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+ * the prototype (which unnecessarily runs the constructor on the created</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+ * prototype object, potentially polluting it), an anonymous function is</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+ * generated internally that shares the same prototype:</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+ *</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+ * &lt;pre&gt;function g() {}</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+ * g.prototype = f.prototype;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+ * return new g();&lt;/pre&gt;</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+ *</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+ * For more details, see Douglas Crockford's essay on prototypal inheritance.</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+ *</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+ * @param {function} f a constructor.</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+ * @returns a suitable prototype object.</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+ * @see Douglas Crockford's essay on &lt;a</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+ * href=&quot;http://javascript.crockford.com/prototypal.html&quot;&gt;prototypal</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+ * inheritance&lt;/a&gt;.</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+ */</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+pv.extend = function(f) {</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+  function g() {}</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+  g.prototype = f.prototype;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+  return new g();</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+};</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+try {</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+  eval(&quot;pv.parse = function(x) x;&quot;); // native support</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+} catch (e) {</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+/**</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+ * Parses a Protovis specification, which may use JavaScript 1.8 function</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+ * expresses, replacing those function expressions with proper functions such</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+ * that the code can be run by a JavaScript 1.6 interpreter. This hack only</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+ * supports function expressions (using clumsy regular expressions, no less),</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+ * and not other JavaScript 1.8 features such as let expressions.</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+ *</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+ * @param {string} s a Protovis specification (i.e., a string of JavaScript 1.8</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+ * source code).</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+ * @returns {string} a conformant JavaScript 1.6 source code.</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+ */</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+  pv.parse = function(js) { // hacky regex support</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+    var re = new RegExp(&quot;function(\\s+\\w+)?\\([^)]*\\)\\s*&quot;, &quot;mg&quot;), m, i = 0;</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+    var s = &quot;&quot;;</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+    while (m = re.exec(js)) {</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+      var j = m.index + m[0].length;</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+      if (js[j--] != '{') {</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+        s += js.substring(i, j) + &quot;{return &quot;;</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+        i = j;</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+        for (var p = 0; p &gt;= 0 &amp;&amp; j &lt; js.length; j++) {</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+          switch (js[j]) {</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+            case '&quot;': case '\'': {</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+              var c = js[j];</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+              while (++j &lt; js.length &amp;&amp; (js[j] != c)) {</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+                if (js[j] == '\\') j++;</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+              }</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+              break;</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+            }</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+            case '[': case '(': p++; break;</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+            case ']': case ')': p--; break;</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+            case ';':</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+            case ',': if (p == 0) p--; break;</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+          }</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+        }</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+        s += pv.parse(js.substring(i, --j)) + &quot;;}&quot;;</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+        i = j;</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+      }</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+      re.lastIndex = j;</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+    }</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+    s += js.substring(i);</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+    return s;</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+  };</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+}</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+/**</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+ * Returns the passed-in argument, &lt;tt&gt;x&lt;/tt&gt;; the identity function. This method</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+ * is provided for convenience since it is used as the default behavior for a</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+ * number of property functions.</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+ *</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+ * @param x a value.</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+ * @returns the value &lt;tt&gt;x&lt;/tt&gt;.</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+ */</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+pv.identity = function(x) { return x; };</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+/**</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+ * Returns an array of numbers, starting at &lt;tt&gt;start&lt;/tt&gt;, incrementing by</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+ * &lt;tt&gt;step&lt;/tt&gt;, until &lt;tt&gt;stop&lt;/tt&gt; is reached. The stop value is exclusive. If</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+ * only a single argument is specified, this value is interpeted as the</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+ * &lt;i&gt;stop&lt;/i&gt; value, with the &lt;i&gt;start&lt;/i&gt; value as zero. If only two arguments</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+ * are specified, the step value is implied to be one.</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+ *</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+ * &lt;p&gt;The method is modeled after the built-in &lt;tt&gt;range&lt;/tt&gt; method from</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+ * Python. See the Python documentation for more details.</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+ *</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+ * @see &lt;a href=&quot;http://docs.python.org/library/functions.html#range&quot;&gt;Python range&lt;/a&gt;.</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+ * @param {number} [start] the start value.</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+ * @param {number} stop the stop value.</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+ * @param {number} [step] the step value.</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+ * @returns {number[]} an array of numbers.</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+ */</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+pv.range = function(start, stop, step) {</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+  if (arguments.length == 1) {</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+    stop = start;</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+    start = 0;</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+  }</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+  if (step == undefined) step = 1;</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+  else if (!step) throw new Error(&quot;step must be non-zero&quot;);</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+  var array = [], i = 0, j;</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+  if (step &lt; 0) {</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+    while ((j = start + step * i++) &gt; stop) {</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+      array.push(j);</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+    }</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+  } else {</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+    while ((j = start + step * i++) &lt; stop) {</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineplus">+      array.push(j);</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineplus">+    }</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+  }</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+  return array;</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+};</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+/**</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+ * Given two arrays &lt;tt&gt;a&lt;/tt&gt; and &lt;tt&gt;b&lt;/tt&gt;, returns an array of all possible</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+ * pairs of elements [a&lt;sub&gt;i&lt;/sub&gt;, b&lt;sub&gt;j&lt;/sub&gt;]. The outer loop is on array</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+ * &lt;i&gt;a&lt;/i&gt;, while the inner loop is on &lt;i&gt;b&lt;/i&gt;, such that the order of</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+ * returned elements is [a&lt;sub&gt;0&lt;/sub&gt;, b&lt;sub&gt;0&lt;/sub&gt;], [a&lt;sub&gt;0&lt;/sub&gt;,</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+ * b&lt;sub&gt;1&lt;/sub&gt;], ... [a&lt;sub&gt;0&lt;/sub&gt;, b&lt;sub&gt;m&lt;/sub&gt;], [a&lt;sub&gt;1&lt;/sub&gt;,</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+ * b&lt;sub&gt;0&lt;/sub&gt;], [a&lt;sub&gt;1&lt;/sub&gt;, b&lt;sub&gt;1&lt;/sub&gt;], ... [a&lt;sub&gt;1&lt;/sub&gt;,</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+ * b&lt;sub&gt;m&lt;/sub&gt;], ... [a&lt;sub&gt;n&lt;/sub&gt;, b&lt;sub&gt;m&lt;/sub&gt;]. If either array is empty,</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+ * an empty array is returned.</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+ *</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+ * @param {array} a an array.</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+ * @param {array} b an array.</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+ * @returns {array} an array of pairs of elements in &lt;tt&gt;a&lt;/tt&gt; and &lt;tt&gt;b&lt;/tt&gt;.</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+ */</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+pv.cross = function(a, b) {</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+  var array = [];</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+  for (var i = 0, n = a.length, m = b.length; i &lt; n; i++) {</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineplus">+    for (var j = 0, x = a[i]; j &lt; m; j++) {</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+      array.push([x, b[j]]);</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineplus">+    }</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+  }</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+  return array;</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+};</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+/**</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+ * Given the specified array of &lt;tt&gt;arrays&lt;/tt&gt;, concatenates the arrays into a</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+ * single array. If the individual arrays are explicitly known, an alternative</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+ * to blend is to use JavaScript's &lt;tt&gt;concat&lt;/tt&gt; method directly. These two</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+ * equivalent expressions:&lt;ul&gt;</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+ *</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineplus">+ * &lt;li&gt;&lt;tt&gt;pv.blend([[1, 2, 3], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]])&lt;/tt&gt;</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+ * &lt;li&gt;&lt;tt&gt;[1, 2, 3].concat([&quot;a&quot;, &quot;b&quot;, &quot;c&quot;])&lt;/tt&gt;</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineplus">+ *</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineplus">+ * &lt;/ul&gt;return [1, 2, 3, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;].</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+ *</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineplus">+ * @param {array[]} arrays an array of arrays.</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+ * @returns {array} an array containing all the elements of each array in</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineplus">+ * &lt;tt&gt;arrays&lt;/tt&gt;.</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineplus">+ */</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+pv.blend = function(arrays) {</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineplus">+  return Array.prototype.concat.apply([], arrays);</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineplus">+};</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineplus">+/**</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+ * Returns all of the property names (keys) of the specified object (a map). The</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineplus">+ * order of the returned array is not defined.</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+ *</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+ * @param map an object.</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+ * @returns {string[]} an array of strings corresponding to the keys.</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+ * @see #entries</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+ */</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+pv.keys = function(map) {</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+  var array = [];</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineplus">+  for (var key in map) {</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineplus">+    array.push(key);</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineplus">+  }</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+  return array;</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+};</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineplus">+</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineplus">+/**</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineplus">+ * Returns all of the entries (key-value pairs) of the specified object (a</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineplus">+ * map). The order of the returned array is not defined. Each key-value pair is</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineplus">+ * represented as an object with &lt;tt&gt;key&lt;/tt&gt; and &lt;tt&gt;value&lt;/tt&gt; attributes,</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineplus">+ * e.g., &lt;tt&gt;{key: &quot;foo&quot;, value: 42}&lt;/tt&gt;.</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineplus">+ *</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineplus">+ * @param map an object.</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineplus">+ * @returns {array} an array of key-value pairs corresponding to the keys.</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+ */</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineplus">+pv.entries = function(map) {</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineplus">+  var array = [];</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineplus">+  for (var key in map) {</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineplus">+    array.push({ key: key, value: map[key] });</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineplus">+  }</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineplus">+  return array;</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineplus">+};</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineplus">+</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineplus">+/**</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineplus">+ * Returns all of the values (attribute values) of the specified object (a</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineplus">+ * map). The order of the returned array is not defined.</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineplus">+ *</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineplus">+ * @param map an object.</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineplus">+ * @returns {array} an array of objects corresponding to the values.</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineplus">+ * @see #entries</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineplus">+ */</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineplus">+pv.values = function(map) {</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineplus">+  var array = [];</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineplus">+  for (var key in map) {</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineplus">+    array.push(map[key]);</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+  }</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+  return array;</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+};</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineplus">+</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineplus">+/**</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineplus">+ * Returns a normalized copy of the specified array, such that the sum of the</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineplus">+ * returned elements sum to one. If the specified array is not an array of</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineplus">+ * numbers, an optional accessor function &lt;tt&gt;f&lt;/tt&gt; can be specified to map the</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineplus">+ * elements to numbers. For example, if &lt;tt&gt;array&lt;/tt&gt; is an array of objects,</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineplus">+ * and each object has a numeric property &quot;foo&quot;, the expression</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineplus">+ *</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+ * &lt;pre&gt;pv.normalize(array, function(d) d.foo)&lt;/pre&gt;</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineplus">+ *</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineplus">+ * returns a normalized array on the &quot;foo&quot; property. If an accessor function is</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineplus">+ * not specified, the identity function is used.</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineplus">+ *</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineplus">+ * @param {array} array an array of objects, or numbers.</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineplus">+ * @param {function} [f] an optional accessor function.</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineplus">+ * @returns {number[]} an array of numbers that sums to one.</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineplus">+ */</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineplus">+pv.normalize = function(array, f) {</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineplus">+  if (!f) f = pv.identity;</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineplus">+  var sum = pv.sum(array, f);</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineplus">+  return array.map(function(d) { return f(d) / sum; });</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineplus">+};</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineplus">+/**</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineplus">+ * Returns the sum of the specified array. If the specified array is not an</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineplus">+ * array of numbers, an optional accessor function &lt;tt&gt;f&lt;/tt&gt; can be specified</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineplus">+ * to map the elements to numbers. See {@link #normalize} for an example.</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineplus">+ *</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineplus">+ * @param {array} array an array of objects, or numbers.</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineplus">+ * @param {function} [f] an optional accessor function.</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineplus">+ * @returns {number} the sum of the specified array.</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineplus">+ */</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineplus">+pv.sum = function(array, f) {</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineplus">+  if (!f) f = pv.identity;</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineplus">+  return pv.reduce(array, function(p, d) { return p + f(d); }, 0);</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+};</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineplus">+</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineplus">+/**</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineplus">+ * Returns the maximum value of the specified array. If the specified array is</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineplus">+ * not an array of numbers, an optional accessor function &lt;tt&gt;f&lt;/tt&gt; can be</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineplus">+ * specified to map the elements to numbers. See {@link #normalize} for an</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineplus">+ * example.</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineplus">+ *</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineplus">+ * @param {array} array an array of objects, or numbers.</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineplus">+ * @param {function} [f] an optional accessor function.</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineplus">+ * @returns {number} the maximum value of the specified array.</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineplus">+ */</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineplus">+pv.max = function(array, f) {</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineplus">+  if (!f) f = pv.identity;</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineplus">+  return pv.reduce(array, function(p, d) { return Math.max(p, f(d)); }, -Infinity);</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineplus">+};</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineplus">+</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineplus">+/**</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineplus">+ * Returns the index of the maximum value of the specified array. If the</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineplus">+ * specified array is not an array of numbers, an optional accessor function</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+ * &lt;tt&gt;f&lt;/tt&gt; can be specified to map the elements to numbers. See</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineplus">+ * {@link #normalize} for an example.</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineplus">+ *</span>
<a href="#l17.284"></a><span id="l17.284" class="difflineplus">+ * @param {array} array an array of objects, or numbers.</span>
<a href="#l17.285"></a><span id="l17.285" class="difflineplus">+ * @param {function} [f] an optional accessor function.</span>
<a href="#l17.286"></a><span id="l17.286" class="difflineplus">+ * @returns {number} the index of the maximum value of the specified array.</span>
<a href="#l17.287"></a><span id="l17.287" class="difflineplus">+ */</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineplus">+pv.max.index = function(array, f) {</span>
<a href="#l17.289"></a><span id="l17.289" class="difflineplus">+  if (!f) f = pv.identity;</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineplus">+  var maxi = -1, maxx = -Infinity;</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineplus">+  for (var i = 0; i &lt; array.length; i++) {</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineplus">+    var x = f(array[i]);</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineplus">+    if (x &gt; maxx) {</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineplus">+      maxx = x;</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineplus">+      maxi = i;</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineplus">+    }</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineplus">+  }</span>
<a href="#l17.298"></a><span id="l17.298" class="difflineplus">+  return maxi;</span>
<a href="#l17.299"></a><span id="l17.299" class="difflineplus">+}</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineplus">+</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineplus">+/**</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineplus">+ * Returns the minimum value of the specified array of numbers. If the specified</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineplus">+ * array is not an array of numbers, an optional accessor function &lt;tt&gt;f&lt;/tt&gt;</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineplus">+ * can be specified to map the elements to numbers. See {@link #normalize} for</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineplus">+ * an example.</span>
<a href="#l17.306"></a><span id="l17.306" class="difflineplus">+ *</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineplus">+ * @param {array} array an array of objects, or numbers.</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineplus">+ * @param {function} [f] an optional accessor function.</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineplus">+ * @returns {number} the minimum value of the specified array.</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineplus">+ */</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineplus">+pv.min = function(array, f) {</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineplus">+  if (!f) f = pv.identity;</span>
<a href="#l17.313"></a><span id="l17.313" class="difflineplus">+  return pv.reduce(array, function(p, d) { return Math.min(p, f(d)); }, Infinity);</span>
<a href="#l17.314"></a><span id="l17.314" class="difflineplus">+};</span>
<a href="#l17.315"></a><span id="l17.315" class="difflineplus">+</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineplus">+/**</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineplus">+ * Returns the index of the minimum value of the specified array. If the</span>
<a href="#l17.318"></a><span id="l17.318" class="difflineplus">+ * specified array is not an array of numbers, an optional accessor function</span>
<a href="#l17.319"></a><span id="l17.319" class="difflineplus">+ * &lt;tt&gt;f&lt;/tt&gt; can be specified to map the elements to numbers. See</span>
<a href="#l17.320"></a><span id="l17.320" class="difflineplus">+ * {@link #normalize} for an example.</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineplus">+ *</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineplus">+ * @param {array} array an array of objects, or numbers.</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineplus">+ * @param {function} [f] an optional accessor function.</span>
<a href="#l17.324"></a><span id="l17.324" class="difflineplus">+ * @returns {number} the index of the minimum value of the specified array.</span>
<a href="#l17.325"></a><span id="l17.325" class="difflineplus">+ */</span>
<a href="#l17.326"></a><span id="l17.326" class="difflineplus">+pv.min.index = function(array, f) {</span>
<a href="#l17.327"></a><span id="l17.327" class="difflineplus">+  if (!f) f = pv.identity;</span>
<a href="#l17.328"></a><span id="l17.328" class="difflineplus">+  var mini = -1, minx = Infinity;</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineplus">+  for (var i = 0; i &lt; array.length; i++) {</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineplus">+    var x = f(array[i]);</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineplus">+    if (x &lt; minx) {</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineplus">+      minx = x;</span>
<a href="#l17.333"></a><span id="l17.333" class="difflineplus">+      mini = i;</span>
<a href="#l17.334"></a><span id="l17.334" class="difflineplus">+    }</span>
<a href="#l17.335"></a><span id="l17.335" class="difflineplus">+  }</span>
<a href="#l17.336"></a><span id="l17.336" class="difflineplus">+  return mini;</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineplus">+}</span>
<a href="#l17.338"></a><span id="l17.338" class="difflineplus">+</span>
<a href="#l17.339"></a><span id="l17.339" class="difflineplus">+/**</span>
<a href="#l17.340"></a><span id="l17.340" class="difflineplus">+ * Returns the arithmetic mean, or average, of the specified array. If the</span>
<a href="#l17.341"></a><span id="l17.341" class="difflineplus">+ * specified array is not an array of numbers, an optional accessor function</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineplus">+ * &lt;tt&gt;f&lt;/tt&gt; can be specified to map the elements to numbers. See</span>
<a href="#l17.343"></a><span id="l17.343" class="difflineplus">+ * {@link #normalize} for an example.</span>
<a href="#l17.344"></a><span id="l17.344" class="difflineplus">+ *</span>
<a href="#l17.345"></a><span id="l17.345" class="difflineplus">+ * @param {array} array an array of objects, or numbers.</span>
<a href="#l17.346"></a><span id="l17.346" class="difflineplus">+ * @param {function} [f] an optional accessor function.</span>
<a href="#l17.347"></a><span id="l17.347" class="difflineplus">+ * @returns {number} the mean of the specified array.</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineplus">+ */</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineplus">+pv.mean = function(array, f) {</span>
<a href="#l17.350"></a><span id="l17.350" class="difflineplus">+  return pv.sum(array, f) / array.length;</span>
<a href="#l17.351"></a><span id="l17.351" class="difflineplus">+};</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineplus">+</span>
<a href="#l17.353"></a><span id="l17.353" class="difflineplus">+/**</span>
<a href="#l17.354"></a><span id="l17.354" class="difflineplus">+ * Returns the median of the specified array. If the specified array is not an</span>
<a href="#l17.355"></a><span id="l17.355" class="difflineplus">+ * array of numbers, an optional accessor function &lt;tt&gt;f&lt;/tt&gt; can be specified</span>
<a href="#l17.356"></a><span id="l17.356" class="difflineplus">+ * to map the elements to numbers. See {@link #normalize} for an example.</span>
<a href="#l17.357"></a><span id="l17.357" class="difflineplus">+ *</span>
<a href="#l17.358"></a><span id="l17.358" class="difflineplus">+ * @param {array} array an array of objects, or numbers.</span>
<a href="#l17.359"></a><span id="l17.359" class="difflineplus">+ * @param {function} [f] an optional accessor function.</span>
<a href="#l17.360"></a><span id="l17.360" class="difflineplus">+ * @returns {number} the median of the specified array.</span>
<a href="#l17.361"></a><span id="l17.361" class="difflineplus">+ */</span>
<a href="#l17.362"></a><span id="l17.362" class="difflineplus">+pv.median = function(array, f) {</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineplus">+  if (!f) f = pv.identity;</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineplus">+  array = array.map(f).sort(function(a, b) { return a - b; });</span>
<a href="#l17.365"></a><span id="l17.365" class="difflineplus">+  if (array.length % 2) return array[Math.floor(array.length / 2)];</span>
<a href="#l17.366"></a><span id="l17.366" class="difflineplus">+  var i = array.length / 2;</span>
<a href="#l17.367"></a><span id="l17.367" class="difflineplus">+  return (array[i - 1] + array[i]) / 2;</span>
<a href="#l17.368"></a><span id="l17.368" class="difflineplus">+};</span>
<a href="#l17.369"></a><span id="l17.369" class="difflineplus">+</span>
<a href="#l17.370"></a><span id="l17.370" class="difflineplus">+if (/\[native code\]/.test(Array.prototype.reduce)) {</span>
<a href="#l17.371"></a><span id="l17.371" class="difflineplus">+/**</span>
<a href="#l17.372"></a><span id="l17.372" class="difflineplus">+ * Applies the specified function &lt;tt&gt;f&lt;/tt&gt; against an accumulator and each</span>
<a href="#l17.373"></a><span id="l17.373" class="difflineplus">+ * value of the specified array (from left-ot-right) so as to reduce it to a</span>
<a href="#l17.374"></a><span id="l17.374" class="difflineplus">+ * single value.</span>
<a href="#l17.375"></a><span id="l17.375" class="difflineplus">+ *</span>
<a href="#l17.376"></a><span id="l17.376" class="difflineplus">+ * &lt;p&gt;Array reduce was added in JavaScript 1.8. This implementation uses the native</span>
<a href="#l17.377"></a><span id="l17.377" class="difflineplus">+ * method if provided; otherwise we use our own implementation derived from the</span>
<a href="#l17.378"></a><span id="l17.378" class="difflineplus">+ * JavaScript documentation. Note that we don't want to add it to the Array</span>
<a href="#l17.379"></a><span id="l17.379" class="difflineplus">+ * prototype directly because this breaks certain (bad) for loop idioms.</span>
<a href="#l17.380"></a><span id="l17.380" class="difflineplus">+ *</span>
<a href="#l17.381"></a><span id="l17.381" class="difflineplus">+ * @see &lt;a</span>
<a href="#l17.382"></a><span id="l17.382" class="difflineplus">+ * href=&quot;http://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/reduce&quot;&gt;Array.reduce&lt;/a&gt;.</span>
<a href="#l17.383"></a><span id="l17.383" class="difflineplus">+ * @param {array} array an array.</span>
<a href="#l17.384"></a><span id="l17.384" class="difflineplus">+ * @param {function} [f] a callback function to execute on each value in the array.</span>
<a href="#l17.385"></a><span id="l17.385" class="difflineplus">+ * @param [v] the object to use as the first argument to the first callback.</span>
<a href="#l17.386"></a><span id="l17.386" class="difflineplus">+ * @returns the reduced value.</span>
<a href="#l17.387"></a><span id="l17.387" class="difflineplus">+ */</span>
<a href="#l17.388"></a><span id="l17.388" class="difflineplus">+  pv.reduce = function(array, f, v) {</span>
<a href="#l17.389"></a><span id="l17.389" class="difflineplus">+    var p = Array.prototype;</span>
<a href="#l17.390"></a><span id="l17.390" class="difflineplus">+    return p.reduce.apply(array, p.slice.call(arguments, 1));</span>
<a href="#l17.391"></a><span id="l17.391" class="difflineplus">+  };</span>
<a href="#l17.392"></a><span id="l17.392" class="difflineplus">+} else {</span>
<a href="#l17.393"></a><span id="l17.393" class="difflineplus">+  pv.reduce = function(array, f, v) {</span>
<a href="#l17.394"></a><span id="l17.394" class="difflineplus">+    var len = array.length;</span>
<a href="#l17.395"></a><span id="l17.395" class="difflineplus">+    if (!len &amp;&amp; (arguments.length == 2)) {</span>
<a href="#l17.396"></a><span id="l17.396" class="difflineplus">+      throw new Error();</span>
<a href="#l17.397"></a><span id="l17.397" class="difflineplus">+    }</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineplus">+</span>
<a href="#l17.399"></a><span id="l17.399" class="difflineplus">+    var i = 0;</span>
<a href="#l17.400"></a><span id="l17.400" class="difflineplus">+    if (arguments.length &lt; 3) {</span>
<a href="#l17.401"></a><span id="l17.401" class="difflineplus">+      while (true) {</span>
<a href="#l17.402"></a><span id="l17.402" class="difflineplus">+        if (i in array) {</span>
<a href="#l17.403"></a><span id="l17.403" class="difflineplus">+          v = array[i++];</span>
<a href="#l17.404"></a><span id="l17.404" class="difflineplus">+          break;</span>
<a href="#l17.405"></a><span id="l17.405" class="difflineplus">+        }</span>
<a href="#l17.406"></a><span id="l17.406" class="difflineplus">+        if (++i &gt;= len) {</span>
<a href="#l17.407"></a><span id="l17.407" class="difflineplus">+          throw new Error();</span>
<a href="#l17.408"></a><span id="l17.408" class="difflineplus">+        }</span>
<a href="#l17.409"></a><span id="l17.409" class="difflineplus">+      }</span>
<a href="#l17.410"></a><span id="l17.410" class="difflineplus">+    }</span>
<a href="#l17.411"></a><span id="l17.411" class="difflineplus">+</span>
<a href="#l17.412"></a><span id="l17.412" class="difflineplus">+    for (; i &lt; len; i++) {</span>
<a href="#l17.413"></a><span id="l17.413" class="difflineplus">+      if (i in array) {</span>
<a href="#l17.414"></a><span id="l17.414" class="difflineplus">+        v = f.call(null, v, array[i], i, array);</span>
<a href="#l17.415"></a><span id="l17.415" class="difflineplus">+      }</span>
<a href="#l17.416"></a><span id="l17.416" class="difflineplus">+    }</span>
<a href="#l17.417"></a><span id="l17.417" class="difflineplus">+    return v;</span>
<a href="#l17.418"></a><span id="l17.418" class="difflineplus">+  };</span>
<a href="#l17.419"></a><span id="l17.419" class="difflineplus">+};</span>
<a href="#l17.420"></a><span id="l17.420" class="difflineplus">+</span>
<a href="#l17.421"></a><span id="l17.421" class="difflineplus">+/**</span>
<a href="#l17.422"></a><span id="l17.422" class="difflineplus">+ * Returns a map constructed from the specified &lt;tt&gt;keys&lt;/tt&gt;, using the function</span>
<a href="#l17.423"></a><span id="l17.423" class="difflineplus">+ * &lt;tt&gt;f&lt;/tt&gt; to compute the value for each key. The arguments to the value</span>
<a href="#l17.424"></a><span id="l17.424" class="difflineplus">+ * function are the same as those used in the built-in array &lt;tt&gt;map&lt;/tt&gt;</span>
<a href="#l17.425"></a><span id="l17.425" class="difflineplus">+ * function: the key, the index, and the array itself. The callback is invoked</span>
<a href="#l17.426"></a><span id="l17.426" class="difflineplus">+ * only for indexes of the array which have assigned values; it is not invoked</span>
<a href="#l17.427"></a><span id="l17.427" class="difflineplus">+ * for indexes which have been deleted or which have never been assigned values.</span>
<a href="#l17.428"></a><span id="l17.428" class="difflineplus">+ *</span>
<a href="#l17.429"></a><span id="l17.429" class="difflineplus">+ * &lt;p&gt;For example, this expression creates a map from strings to string length:</span>
<a href="#l17.430"></a><span id="l17.430" class="difflineplus">+ *</span>
<a href="#l17.431"></a><span id="l17.431" class="difflineplus">+ * &lt;pre&gt;pv.dict([&quot;one&quot;, &quot;three&quot;, &quot;seventeen&quot;], function(s) s.length)&lt;/pre&gt;</span>
<a href="#l17.432"></a><span id="l17.432" class="difflineplus">+ *</span>
<a href="#l17.433"></a><span id="l17.433" class="difflineplus">+ * The returned value is &lt;tt&gt;{one: 3, three: 5, seventeen: 9}&lt;/tt&gt;.</span>
<a href="#l17.434"></a><span id="l17.434" class="difflineplus">+ *</span>
<a href="#l17.435"></a><span id="l17.435" class="difflineplus">+ * @see &lt;a</span>
<a href="#l17.436"></a><span id="l17.436" class="difflineplus">+ * href=&quot;http://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Global_Objects/Array/map&quot;&gt;Array.map&lt;/a&gt;.</span>
<a href="#l17.437"></a><span id="l17.437" class="difflineplus">+ * @param {array} keys an array.</span>
<a href="#l17.438"></a><span id="l17.438" class="difflineplus">+ * @param {function} f a value function.</span>
<a href="#l17.439"></a><span id="l17.439" class="difflineplus">+ * @returns a map from keys to values.</span>
<a href="#l17.440"></a><span id="l17.440" class="difflineplus">+ */</span>
<a href="#l17.441"></a><span id="l17.441" class="difflineplus">+pv.dict = function(keys, f) {</span>
<a href="#l17.442"></a><span id="l17.442" class="difflineplus">+  var m = {};</span>
<a href="#l17.443"></a><span id="l17.443" class="difflineplus">+  for (var i = 0; i &lt; keys.length; i++) {</span>
<a href="#l17.444"></a><span id="l17.444" class="difflineplus">+    if (i in keys) {</span>
<a href="#l17.445"></a><span id="l17.445" class="difflineplus">+      var k = keys[i];</span>
<a href="#l17.446"></a><span id="l17.446" class="difflineplus">+      m[k] = f.call(null, k, i, keys);</span>
<a href="#l17.447"></a><span id="l17.447" class="difflineplus">+    }</span>
<a href="#l17.448"></a><span id="l17.448" class="difflineplus">+  }</span>
<a href="#l17.449"></a><span id="l17.449" class="difflineplus">+  return m;</span>
<a href="#l17.450"></a><span id="l17.450" class="difflineplus">+};</span>
<a href="#l17.451"></a><span id="l17.451" class="difflineplus">+</span>
<a href="#l17.452"></a><span id="l17.452" class="difflineplus">+/**</span>
<a href="#l17.453"></a><span id="l17.453" class="difflineplus">+ * Returns a permutation of the specified array, using the specified array of</span>
<a href="#l17.454"></a><span id="l17.454" class="difflineplus">+ * indexes. The returned array contains the corresponding element in</span>
<a href="#l17.455"></a><span id="l17.455" class="difflineplus">+ * &lt;tt&gt;array&lt;/tt&gt; for each index in &lt;tt&gt;indexes&lt;/tt&gt;, in order. For example,</span>
<a href="#l17.456"></a><span id="l17.456" class="difflineplus">+ *</span>
<a href="#l17.457"></a><span id="l17.457" class="difflineplus">+ * &lt;pre&gt;pv.permute([&quot;a&quot;, &quot;b&quot;, &quot;c&quot;], [1, 2, 0])&lt;/pre&gt;</span>
<a href="#l17.458"></a><span id="l17.458" class="difflineplus">+ *</span>
<a href="#l17.459"></a><span id="l17.459" class="difflineplus">+ * returns &lt;tt&gt;[&quot;b&quot;, &quot;c&quot;, &quot;a&quot;]&lt;/tt&gt;. It is acceptable for the array of indexes</span>
<a href="#l17.460"></a><span id="l17.460" class="difflineplus">+ * to be a different length from the array of elements, and for indexes to be</span>
<a href="#l17.461"></a><span id="l17.461" class="difflineplus">+ * duplicated or omitted. The optional accessor function &lt;tt&gt;f&lt;/tt&gt; can be used</span>
<a href="#l17.462"></a><span id="l17.462" class="difflineplus">+ * to perform a simultaneous mapping of the array elements.</span>
<a href="#l17.463"></a><span id="l17.463" class="difflineplus">+ *</span>
<a href="#l17.464"></a><span id="l17.464" class="difflineplus">+ * @param {array} array an array.</span>
<a href="#l17.465"></a><span id="l17.465" class="difflineplus">+ * @param {number[]} indexes an array of indexes into &lt;tt&gt;array&lt;/tt&gt;.</span>
<a href="#l17.466"></a><span id="l17.466" class="difflineplus">+ * @param {function} [f] an optional accessor function.</span>
<a href="#l17.467"></a><span id="l17.467" class="difflineplus">+ * @returns {array} an array of elements from &lt;tt&gt;array&lt;/tt&gt;; a permutation.</span>
<a href="#l17.468"></a><span id="l17.468" class="difflineplus">+ */</span>
<a href="#l17.469"></a><span id="l17.469" class="difflineplus">+pv.permute = function(array, indexes, f) {</span>
<a href="#l17.470"></a><span id="l17.470" class="difflineplus">+  if (!f) f = pv.identity;</span>
<a href="#l17.471"></a><span id="l17.471" class="difflineplus">+  var p = new Array(indexes.length);</span>
<a href="#l17.472"></a><span id="l17.472" class="difflineplus">+  indexes.forEach(function(j, i) { p[i] = f(array[j]); });</span>
<a href="#l17.473"></a><span id="l17.473" class="difflineplus">+  return p;</span>
<a href="#l17.474"></a><span id="l17.474" class="difflineplus">+};</span>
<a href="#l17.475"></a><span id="l17.475" class="difflineplus">+</span>
<a href="#l17.476"></a><span id="l17.476" class="difflineplus">+/**</span>
<a href="#l17.477"></a><span id="l17.477" class="difflineplus">+ * Returns a map from key to index for the specified &lt;tt&gt;keys&lt;/tt&gt; array. For</span>
<a href="#l17.478"></a><span id="l17.478" class="difflineplus">+ * example,</span>
<a href="#l17.479"></a><span id="l17.479" class="difflineplus">+ *</span>
<a href="#l17.480"></a><span id="l17.480" class="difflineplus">+ * &lt;pre&gt;pv.numerate([&quot;a&quot;, &quot;b&quot;, &quot;c&quot;])&lt;/pre&gt;</span>
<a href="#l17.481"></a><span id="l17.481" class="difflineplus">+ *</span>
<a href="#l17.482"></a><span id="l17.482" class="difflineplus">+ * returns &lt;tt&gt;{a: 0, b: 1, c: 2}&lt;/tt&gt;. Note that since JavaScript maps only</span>
<a href="#l17.483"></a><span id="l17.483" class="difflineplus">+ * support string keys, &lt;tt&gt;keys&lt;/tt&gt; must contain strings, or other values that</span>
<a href="#l17.484"></a><span id="l17.484" class="difflineplus">+ * naturally map to distinct string values. Alternatively, an optional accessor</span>
<a href="#l17.485"></a><span id="l17.485" class="difflineplus">+ * function &lt;tt&gt;f&lt;/tt&gt; can be specified to compute the string key for the given</span>
<a href="#l17.486"></a><span id="l17.486" class="difflineplus">+ * element.</span>
<a href="#l17.487"></a><span id="l17.487" class="difflineplus">+ *</span>
<a href="#l17.488"></a><span id="l17.488" class="difflineplus">+ * @param {array} keys an array, usually of string keys.</span>
<a href="#l17.489"></a><span id="l17.489" class="difflineplus">+ * @param {function} [f] an optional key function.</span>
<a href="#l17.490"></a><span id="l17.490" class="difflineplus">+ * @returns a map from key to index.</span>
<a href="#l17.491"></a><span id="l17.491" class="difflineplus">+ */</span>
<a href="#l17.492"></a><span id="l17.492" class="difflineplus">+pv.numerate = function(keys, f) {</span>
<a href="#l17.493"></a><span id="l17.493" class="difflineplus">+  if (!f) f = pv.identity;</span>
<a href="#l17.494"></a><span id="l17.494" class="difflineplus">+  var map = {};</span>
<a href="#l17.495"></a><span id="l17.495" class="difflineplus">+  keys.forEach(function(x, i) { map[f(x)] = i; });</span>
<a href="#l17.496"></a><span id="l17.496" class="difflineplus">+  return map;</span>
<a href="#l17.497"></a><span id="l17.497" class="difflineplus">+};</span>
<a href="#l17.498"></a><span id="l17.498" class="difflineplus">+</span>
<a href="#l17.499"></a><span id="l17.499" class="difflineplus">+/**</span>
<a href="#l17.500"></a><span id="l17.500" class="difflineplus">+ * The comparator function for natural order. This can be used in conjunction with</span>
<a href="#l17.501"></a><span id="l17.501" class="difflineplus">+ * the built-in array &lt;tt&gt;sort&lt;/tt&gt; method to sort elements by their natural</span>
<a href="#l17.502"></a><span id="l17.502" class="difflineplus">+ * order, ascending. Note that if no comparator function is specified to the</span>
<a href="#l17.503"></a><span id="l17.503" class="difflineplus">+ * built-in &lt;tt&gt;sort&lt;/tt&gt; method, the default order is lexicographic, &lt;i&gt;not&lt;/i&gt;</span>
<a href="#l17.504"></a><span id="l17.504" class="difflineplus">+ * natural!</span>
<a href="#l17.505"></a><span id="l17.505" class="difflineplus">+ *</span>
<a href="#l17.506"></a><span id="l17.506" class="difflineplus">+ * @see &lt;a</span>
<a href="#l17.507"></a><span id="l17.507" class="difflineplus">+ * href=&quot;http://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Global_Objects/Array/sort&quot;&gt;Array.sort&lt;/a&gt;.</span>
<a href="#l17.508"></a><span id="l17.508" class="difflineplus">+ * @param a an element to compare.</span>
<a href="#l17.509"></a><span id="l17.509" class="difflineplus">+ * @param b an element to compare.</span>
<a href="#l17.510"></a><span id="l17.510" class="difflineplus">+ * @returns {number} negative if a &amp;lt; b; positive if a &amp;gt; b; otherwise 0.</span>
<a href="#l17.511"></a><span id="l17.511" class="difflineplus">+ */</span>
<a href="#l17.512"></a><span id="l17.512" class="difflineplus">+pv.naturalOrder = function(a, b) {</span>
<a href="#l17.513"></a><span id="l17.513" class="difflineplus">+  return (a &lt; b) ? -1 : ((a &gt; b) ? 1 : 0);</span>
<a href="#l17.514"></a><span id="l17.514" class="difflineplus">+};</span>
<a href="#l17.515"></a><span id="l17.515" class="difflineplus">+</span>
<a href="#l17.516"></a><span id="l17.516" class="difflineplus">+/**</span>
<a href="#l17.517"></a><span id="l17.517" class="difflineplus">+ * The comparator function for reverse natural order. This can be used in</span>
<a href="#l17.518"></a><span id="l17.518" class="difflineplus">+ * conjunction with the built-in array &lt;tt&gt;sort&lt;/tt&gt; method to sort elements by</span>
<a href="#l17.519"></a><span id="l17.519" class="difflineplus">+ * their natural order, descending. Note that if no comparator function is</span>
<a href="#l17.520"></a><span id="l17.520" class="difflineplus">+ * specified to the built-in &lt;tt&gt;sort&lt;/tt&gt; method, the default order is</span>
<a href="#l17.521"></a><span id="l17.521" class="difflineplus">+ * lexicographic, &lt;i&gt;not&lt;/i&gt; natural!</span>
<a href="#l17.522"></a><span id="l17.522" class="difflineplus">+ *</span>
<a href="#l17.523"></a><span id="l17.523" class="difflineplus">+ * @see #naturalOrder</span>
<a href="#l17.524"></a><span id="l17.524" class="difflineplus">+ * @param a an element to compare.</span>
<a href="#l17.525"></a><span id="l17.525" class="difflineplus">+ * @param b an element to compare.</span>
<a href="#l17.526"></a><span id="l17.526" class="difflineplus">+ * @returns {number} negative if a &amp;lt; b; positive if a &amp;gt; b; otherwise 0.</span>
<a href="#l17.527"></a><span id="l17.527" class="difflineplus">+ */</span>
<a href="#l17.528"></a><span id="l17.528" class="difflineplus">+pv.reverseOrder = function(b, a) {</span>
<a href="#l17.529"></a><span id="l17.529" class="difflineplus">+  return (a &lt; b) ? -1 : ((a &gt; b) ? 1 : 0);</span>
<a href="#l17.530"></a><span id="l17.530" class="difflineplus">+};</span>
<a href="#l17.531"></a><span id="l17.531" class="difflineplus">+</span>
<a href="#l17.532"></a><span id="l17.532" class="difflineplus">+/** @namespace Namespace constants for SVG, XMLNS, and XLINK. */</span>
<a href="#l17.533"></a><span id="l17.533" class="difflineplus">+pv.ns = {</span>
<a href="#l17.534"></a><span id="l17.534" class="difflineplus">+ /**</span>
<a href="#l17.535"></a><span id="l17.535" class="difflineplus">+  * The SVG namespace, &quot;http://www.w3.org/2000/svg&quot;.</span>
<a href="#l17.536"></a><span id="l17.536" class="difflineplus">+  *</span>
<a href="#l17.537"></a><span id="l17.537" class="difflineplus">+  * @type string</span>
<a href="#l17.538"></a><span id="l17.538" class="difflineplus">+  */</span>
<a href="#l17.539"></a><span id="l17.539" class="difflineplus">+ svg: &quot;http://www.w3.org/2000/svg&quot;,</span>
<a href="#l17.540"></a><span id="l17.540" class="difflineplus">+</span>
<a href="#l17.541"></a><span id="l17.541" class="difflineplus">+ /**</span>
<a href="#l17.542"></a><span id="l17.542" class="difflineplus">+  * The XMLNS namespace, &quot;http://www.w3.org/2000/xmlns&quot;.</span>
<a href="#l17.543"></a><span id="l17.543" class="difflineplus">+  *</span>
<a href="#l17.544"></a><span id="l17.544" class="difflineplus">+  * @type string</span>
<a href="#l17.545"></a><span id="l17.545" class="difflineplus">+  */</span>
<a href="#l17.546"></a><span id="l17.546" class="difflineplus">+ xmlns: &quot;http://www.w3.org/2000/xmlns&quot;,</span>
<a href="#l17.547"></a><span id="l17.547" class="difflineplus">+</span>
<a href="#l17.548"></a><span id="l17.548" class="difflineplus">+ /**</span>
<a href="#l17.549"></a><span id="l17.549" class="difflineplus">+  * The XLINK namespace, &quot;http://www.w3.org/1999/xlink&quot;.</span>
<a href="#l17.550"></a><span id="l17.550" class="difflineplus">+  *</span>
<a href="#l17.551"></a><span id="l17.551" class="difflineplus">+  * @type string</span>
<a href="#l17.552"></a><span id="l17.552" class="difflineplus">+  */</span>
<a href="#l17.553"></a><span id="l17.553" class="difflineplus">+ xlink: &quot;http://www.w3.org/1999/xlink&quot;,</span>
<a href="#l17.554"></a><span id="l17.554" class="difflineplus">+};</span>
<a href="#l17.555"></a><span id="l17.555" class="difflineplus">+</span>
<a href="#l17.556"></a><span id="l17.556" class="difflineplus">+/** @namespace Protovis major and minor version numbers. */</span>
<a href="#l17.557"></a><span id="l17.557" class="difflineplus">+pv.version = {</span>
<a href="#l17.558"></a><span id="l17.558" class="difflineplus">+  /**</span>
<a href="#l17.559"></a><span id="l17.559" class="difflineplus">+   * The major version number.</span>
<a href="#l17.560"></a><span id="l17.560" class="difflineplus">+   *</span>
<a href="#l17.561"></a><span id="l17.561" class="difflineplus">+   * @type number</span>
<a href="#l17.562"></a><span id="l17.562" class="difflineplus">+   */</span>
<a href="#l17.563"></a><span id="l17.563" class="difflineplus">+  major: 2,</span>
<a href="#l17.564"></a><span id="l17.564" class="difflineplus">+</span>
<a href="#l17.565"></a><span id="l17.565" class="difflineplus">+  /**</span>
<a href="#l17.566"></a><span id="l17.566" class="difflineplus">+   * The minor version number.</span>
<a href="#l17.567"></a><span id="l17.567" class="difflineplus">+   *</span>
<a href="#l17.568"></a><span id="l17.568" class="difflineplus">+   * @type number</span>
<a href="#l17.569"></a><span id="l17.569" class="difflineplus">+   */</span>
<a href="#l17.570"></a><span id="l17.570" class="difflineplus">+  minor: 6</span>
<a href="#l17.571"></a><span id="l17.571" class="difflineplus">+};</span>
<a href="#l17.572"></a><span id="l17.572" class="difflineplus">+/**</span>
<a href="#l17.573"></a><span id="l17.573" class="difflineplus">+ * Returns the {@link pv.Color} for the specified color format string. Colors</span>
<a href="#l17.574"></a><span id="l17.574" class="difflineplus">+ * may have an associated opacity, or alpha channel. Color formats are specified</span>
<a href="#l17.575"></a><span id="l17.575" class="difflineplus">+ * by CSS Color Modular Level 3, using either in RGB or HSL color space. For</span>
<a href="#l17.576"></a><span id="l17.576" class="difflineplus">+ * example:&lt;ul&gt;</span>
<a href="#l17.577"></a><span id="l17.577" class="difflineplus">+ *</span>
<a href="#l17.578"></a><span id="l17.578" class="difflineplus">+ * &lt;li&gt;#f00 // #rgb</span>
<a href="#l17.579"></a><span id="l17.579" class="difflineplus">+ * &lt;li&gt;#ff0000 // #rrggbb</span>
<a href="#l17.580"></a><span id="l17.580" class="difflineplus">+ * &lt;li&gt;rgb(255, 0, 0)</span>
<a href="#l17.581"></a><span id="l17.581" class="difflineplus">+ * &lt;li&gt;rgb(100%, 0%, 0%)</span>
<a href="#l17.582"></a><span id="l17.582" class="difflineplus">+ * &lt;li&gt;hsl(0, 100%, 50%)</span>
<a href="#l17.583"></a><span id="l17.583" class="difflineplus">+ * &lt;li&gt;rgba(0, 0, 255, 0.5)</span>
<a href="#l17.584"></a><span id="l17.584" class="difflineplus">+ * &lt;li&gt;hsla(120, 100%, 50%, 1)</span>
<a href="#l17.585"></a><span id="l17.585" class="difflineplus">+ *</span>
<a href="#l17.586"></a><span id="l17.586" class="difflineplus">+ * &lt;/ul&gt;The SVG 1.0 color keywords names are also supported, such as &quot;aliceblue&quot;</span>
<a href="#l17.587"></a><span id="l17.587" class="difflineplus">+ * and yellowgreen&quot;. The &quot;transparent&quot; keyword is also supported for a</span>
<a href="#l17.588"></a><span id="l17.588" class="difflineplus">+ * fully-transparent color.</span>
<a href="#l17.589"></a><span id="l17.589" class="difflineplus">+ *</span>
<a href="#l17.590"></a><span id="l17.590" class="difflineplus">+ * &lt;p&gt;If the &lt;tt&gt;format&lt;/tt&gt; argument is already an instance of &lt;tt&gt;Color&lt;/tt&gt;,</span>
<a href="#l17.591"></a><span id="l17.591" class="difflineplus">+ * the argument is returned with no further processing.</span>
<a href="#l17.592"></a><span id="l17.592" class="difflineplus">+ *</span>
<a href="#l17.593"></a><span id="l17.593" class="difflineplus">+ * @param {string} format the color specification string, e.g., &quot;#f00&quot;.</span>
<a href="#l17.594"></a><span id="l17.594" class="difflineplus">+ * @returns {pv.Color} the corresponding &lt;tt&gt;Color&lt;/tt&gt;.</span>
<a href="#l17.595"></a><span id="l17.595" class="difflineplus">+ * @see &lt;a href=&quot;http://www.w3.org/TR/SVG/types.html#ColorKeywords&quot;&gt;SVG color keywords&lt;/a&gt;.</span>
<a href="#l17.596"></a><span id="l17.596" class="difflineplus">+ * @see &lt;a href=&quot;http://www.w3.org/TR/css3-color/&quot;&gt;CSS3 color module&lt;/a&gt;.</span>
<a href="#l17.597"></a><span id="l17.597" class="difflineplus">+ */</span>
<a href="#l17.598"></a><span id="l17.598" class="difflineplus">+pv.color = function(format) {</span>
<a href="#l17.599"></a><span id="l17.599" class="difflineplus">+  if (!format || (format == &quot;transparent&quot;)) {</span>
<a href="#l17.600"></a><span id="l17.600" class="difflineplus">+    return new pv.Color.Rgb(0, 0, 0, 0);</span>
<a href="#l17.601"></a><span id="l17.601" class="difflineplus">+  }</span>
<a href="#l17.602"></a><span id="l17.602" class="difflineplus">+  if (format instanceof pv.Color) {</span>
<a href="#l17.603"></a><span id="l17.603" class="difflineplus">+    return format;</span>
<a href="#l17.604"></a><span id="l17.604" class="difflineplus">+  }</span>
<a href="#l17.605"></a><span id="l17.605" class="difflineplus">+</span>
<a href="#l17.606"></a><span id="l17.606" class="difflineplus">+  /* Handle hsl, rgb. */</span>
<a href="#l17.607"></a><span id="l17.607" class="difflineplus">+  var m1 = /([a-z]+)\((.*)\)/i.exec(format);</span>
<a href="#l17.608"></a><span id="l17.608" class="difflineplus">+  if (m1) {</span>
<a href="#l17.609"></a><span id="l17.609" class="difflineplus">+    var m2 = m1[2].split(&quot;,&quot;), a = 1;</span>
<a href="#l17.610"></a><span id="l17.610" class="difflineplus">+    switch (m1[1]) {</span>
<a href="#l17.611"></a><span id="l17.611" class="difflineplus">+      case &quot;hsla&quot;:</span>
<a href="#l17.612"></a><span id="l17.612" class="difflineplus">+      case &quot;rgba&quot;: {</span>
<a href="#l17.613"></a><span id="l17.613" class="difflineplus">+        a = parseFloat(m2[3]);</span>
<a href="#l17.614"></a><span id="l17.614" class="difflineplus">+        break;</span>
<a href="#l17.615"></a><span id="l17.615" class="difflineplus">+      }</span>
<a href="#l17.616"></a><span id="l17.616" class="difflineplus">+    }</span>
<a href="#l17.617"></a><span id="l17.617" class="difflineplus">+    switch (m1[1]) {</span>
<a href="#l17.618"></a><span id="l17.618" class="difflineplus">+      case &quot;hsla&quot;:</span>
<a href="#l17.619"></a><span id="l17.619" class="difflineplus">+      case &quot;hsl&quot;: {</span>
<a href="#l17.620"></a><span id="l17.620" class="difflineplus">+        var h = parseFloat(m2[0]), // degrees</span>
<a href="#l17.621"></a><span id="l17.621" class="difflineplus">+            s = parseFloat(m2[1]) / 100, // percentage</span>
<a href="#l17.622"></a><span id="l17.622" class="difflineplus">+            l = parseFloat(m2[2]) / 100; // percentage</span>
<a href="#l17.623"></a><span id="l17.623" class="difflineplus">+        return (new pv.Color.Hsl(h, s, l, a)).rgb();</span>
<a href="#l17.624"></a><span id="l17.624" class="difflineplus">+      }</span>
<a href="#l17.625"></a><span id="l17.625" class="difflineplus">+      case &quot;rgba&quot;:</span>
<a href="#l17.626"></a><span id="l17.626" class="difflineplus">+      case &quot;rgb&quot;: {</span>
<a href="#l17.627"></a><span id="l17.627" class="difflineplus">+        function parse(c) { // either integer or percentage</span>
<a href="#l17.628"></a><span id="l17.628" class="difflineplus">+          var f = parseFloat(c);</span>
<a href="#l17.629"></a><span id="l17.629" class="difflineplus">+          return (c[c.length - 1] == '%') ? Math.round(f * 2.55) : f;</span>
<a href="#l17.630"></a><span id="l17.630" class="difflineplus">+        }</span>
<a href="#l17.631"></a><span id="l17.631" class="difflineplus">+        var r = parse(m2[0]), g = parse(m2[1]), b = parse(m2[2]);</span>
<a href="#l17.632"></a><span id="l17.632" class="difflineplus">+        return new pv.Color.Rgb(r, g, b, a);</span>
<a href="#l17.633"></a><span id="l17.633" class="difflineplus">+      }</span>
<a href="#l17.634"></a><span id="l17.634" class="difflineplus">+    }</span>
<a href="#l17.635"></a><span id="l17.635" class="difflineplus">+  }</span>
<a href="#l17.636"></a><span id="l17.636" class="difflineplus">+</span>
<a href="#l17.637"></a><span id="l17.637" class="difflineplus">+  /* Otherwise, assume named colors. TODO allow lazy conversion to RGB. */</span>
<a href="#l17.638"></a><span id="l17.638" class="difflineplus">+  return new pv.Color(format, 1);</span>
<a href="#l17.639"></a><span id="l17.639" class="difflineplus">+};</span>
<a href="#l17.640"></a><span id="l17.640" class="difflineplus">+</span>
<a href="#l17.641"></a><span id="l17.641" class="difflineplus">+/**</span>
<a href="#l17.642"></a><span id="l17.642" class="difflineplus">+ * Constructs a color with the specified color format string and opacity. This</span>
<a href="#l17.643"></a><span id="l17.643" class="difflineplus">+ * constructor should not be invoked directly; use {@link pv.color} instead.</span>
<a href="#l17.644"></a><span id="l17.644" class="difflineplus">+ *</span>
<a href="#l17.645"></a><span id="l17.645" class="difflineplus">+ * @class Represents an abstract (possibly translucent) color. The color is</span>
<a href="#l17.646"></a><span id="l17.646" class="difflineplus">+ * divided into two parts: the &lt;tt&gt;color&lt;/tt&gt; attribute, an opaque color format</span>
<a href="#l17.647"></a><span id="l17.647" class="difflineplus">+ * string, and the &lt;tt&gt;opacity&lt;/tt&gt; attribute, a float in [0, 1]. The color</span>
<a href="#l17.648"></a><span id="l17.648" class="difflineplus">+ * space is dependent on the implementing class; all colors support the</span>
<a href="#l17.649"></a><span id="l17.649" class="difflineplus">+ * {@link #rgb} method to convert to RGB color space for interpolation.</span>
<a href="#l17.650"></a><span id="l17.650" class="difflineplus">+ *</span>
<a href="#l17.651"></a><span id="l17.651" class="difflineplus">+ * &lt;p&gt;See also the &lt;a href=&quot;../../api/Color.html&quot;&gt;Color guide&lt;/a&gt;.</span>
<a href="#l17.652"></a><span id="l17.652" class="difflineplus">+ *</span>
<a href="#l17.653"></a><span id="l17.653" class="difflineplus">+ * @param {string} color an opaque color format string, such as &quot;#f00&quot;.</span>
<a href="#l17.654"></a><span id="l17.654" class="difflineplus">+ * @param {number} opacity the opacity, in [0,1].</span>
<a href="#l17.655"></a><span id="l17.655" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.656"></a><span id="l17.656" class="difflineplus">+ */</span>
<a href="#l17.657"></a><span id="l17.657" class="difflineplus">+pv.Color = function(color, opacity) {</span>
<a href="#l17.658"></a><span id="l17.658" class="difflineplus">+  /**</span>
<a href="#l17.659"></a><span id="l17.659" class="difflineplus">+   * An opaque color format string, such as &quot;#f00&quot;.</span>
<a href="#l17.660"></a><span id="l17.660" class="difflineplus">+   *</span>
<a href="#l17.661"></a><span id="l17.661" class="difflineplus">+   * @type string</span>
<a href="#l17.662"></a><span id="l17.662" class="difflineplus">+   * @see &lt;a href=&quot;http://www.w3.org/TR/SVG/types.html#ColorKeywords&quot;&gt;SVG color keywords&lt;/a&gt;.</span>
<a href="#l17.663"></a><span id="l17.663" class="difflineplus">+   * @see &lt;a href=&quot;http://www.w3.org/TR/css3-color/&quot;&gt;CSS3 color module&lt;/a&gt;.</span>
<a href="#l17.664"></a><span id="l17.664" class="difflineplus">+   */</span>
<a href="#l17.665"></a><span id="l17.665" class="difflineplus">+  this.color = color;</span>
<a href="#l17.666"></a><span id="l17.666" class="difflineplus">+</span>
<a href="#l17.667"></a><span id="l17.667" class="difflineplus">+  /**</span>
<a href="#l17.668"></a><span id="l17.668" class="difflineplus">+   * The opacity, a float in [0, 1].</span>
<a href="#l17.669"></a><span id="l17.669" class="difflineplus">+   *</span>
<a href="#l17.670"></a><span id="l17.670" class="difflineplus">+   * @type number</span>
<a href="#l17.671"></a><span id="l17.671" class="difflineplus">+   */</span>
<a href="#l17.672"></a><span id="l17.672" class="difflineplus">+  this.opacity = opacity;</span>
<a href="#l17.673"></a><span id="l17.673" class="difflineplus">+};</span>
<a href="#l17.674"></a><span id="l17.674" class="difflineplus">+</span>
<a href="#l17.675"></a><span id="l17.675" class="difflineplus">+/**</span>
<a href="#l17.676"></a><span id="l17.676" class="difflineplus">+ * Constructs a new RGB color with the specified channel values.</span>
<a href="#l17.677"></a><span id="l17.677" class="difflineplus">+ *</span>
<a href="#l17.678"></a><span id="l17.678" class="difflineplus">+ * @class Represents a color in RGB space.</span>
<a href="#l17.679"></a><span id="l17.679" class="difflineplus">+ *</span>
<a href="#l17.680"></a><span id="l17.680" class="difflineplus">+ * @param {number} r the red channel, an integer in [0,255].</span>
<a href="#l17.681"></a><span id="l17.681" class="difflineplus">+ * @param {number} g the green channel, an integer in [0,255].</span>
<a href="#l17.682"></a><span id="l17.682" class="difflineplus">+ * @param {number} b the blue channel, an integer in [0,255].</span>
<a href="#l17.683"></a><span id="l17.683" class="difflineplus">+ * @param {number} a the alpha channel, a float in [0,1].</span>
<a href="#l17.684"></a><span id="l17.684" class="difflineplus">+ * @extends pv.Color</span>
<a href="#l17.685"></a><span id="l17.685" class="difflineplus">+ */</span>
<a href="#l17.686"></a><span id="l17.686" class="difflineplus">+pv.Color.Rgb = function(r, g, b, a) {</span>
<a href="#l17.687"></a><span id="l17.687" class="difflineplus">+  pv.Color.call(this, a ? (&quot;rgb(&quot; + r + &quot;,&quot; + g + &quot;,&quot; + b + &quot;)&quot;) : &quot;none&quot;, a);</span>
<a href="#l17.688"></a><span id="l17.688" class="difflineplus">+</span>
<a href="#l17.689"></a><span id="l17.689" class="difflineplus">+  /**</span>
<a href="#l17.690"></a><span id="l17.690" class="difflineplus">+   * The red channel, an integer in [0, 255].</span>
<a href="#l17.691"></a><span id="l17.691" class="difflineplus">+   *</span>
<a href="#l17.692"></a><span id="l17.692" class="difflineplus">+   * @type number</span>
<a href="#l17.693"></a><span id="l17.693" class="difflineplus">+   */</span>
<a href="#l17.694"></a><span id="l17.694" class="difflineplus">+  this.r = r;</span>
<a href="#l17.695"></a><span id="l17.695" class="difflineplus">+</span>
<a href="#l17.696"></a><span id="l17.696" class="difflineplus">+  /**</span>
<a href="#l17.697"></a><span id="l17.697" class="difflineplus">+   * The green channel, an integer in [0, 255].</span>
<a href="#l17.698"></a><span id="l17.698" class="difflineplus">+   *</span>
<a href="#l17.699"></a><span id="l17.699" class="difflineplus">+   * @type number</span>
<a href="#l17.700"></a><span id="l17.700" class="difflineplus">+   */</span>
<a href="#l17.701"></a><span id="l17.701" class="difflineplus">+  this.g = g;</span>
<a href="#l17.702"></a><span id="l17.702" class="difflineplus">+</span>
<a href="#l17.703"></a><span id="l17.703" class="difflineplus">+  /**</span>
<a href="#l17.704"></a><span id="l17.704" class="difflineplus">+   * The blue channel, an integer in [0, 255].</span>
<a href="#l17.705"></a><span id="l17.705" class="difflineplus">+   *</span>
<a href="#l17.706"></a><span id="l17.706" class="difflineplus">+   * @type number</span>
<a href="#l17.707"></a><span id="l17.707" class="difflineplus">+   */</span>
<a href="#l17.708"></a><span id="l17.708" class="difflineplus">+  this.b = b;</span>
<a href="#l17.709"></a><span id="l17.709" class="difflineplus">+</span>
<a href="#l17.710"></a><span id="l17.710" class="difflineplus">+  /**</span>
<a href="#l17.711"></a><span id="l17.711" class="difflineplus">+   * The alpha channel, a float in [0, 1].</span>
<a href="#l17.712"></a><span id="l17.712" class="difflineplus">+   *</span>
<a href="#l17.713"></a><span id="l17.713" class="difflineplus">+   * @type number</span>
<a href="#l17.714"></a><span id="l17.714" class="difflineplus">+   */</span>
<a href="#l17.715"></a><span id="l17.715" class="difflineplus">+  this.a = a;</span>
<a href="#l17.716"></a><span id="l17.716" class="difflineplus">+};</span>
<a href="#l17.717"></a><span id="l17.717" class="difflineplus">+pv.Color.Rgb.prototype = pv.extend(pv.Color);</span>
<a href="#l17.718"></a><span id="l17.718" class="difflineplus">+</span>
<a href="#l17.719"></a><span id="l17.719" class="difflineplus">+/**</span>
<a href="#l17.720"></a><span id="l17.720" class="difflineplus">+ * Returns the RGB color equivalent to this color. This method is abstract and</span>
<a href="#l17.721"></a><span id="l17.721" class="difflineplus">+ * must be implemented by subclasses.</span>
<a href="#l17.722"></a><span id="l17.722" class="difflineplus">+ *</span>
<a href="#l17.723"></a><span id="l17.723" class="difflineplus">+ * @returns {pv.Color.Rgb} an RGB color.</span>
<a href="#l17.724"></a><span id="l17.724" class="difflineplus">+ * @function</span>
<a href="#l17.725"></a><span id="l17.725" class="difflineplus">+ * @name pv.Color.prototype.rgb</span>
<a href="#l17.726"></a><span id="l17.726" class="difflineplus">+ */</span>
<a href="#l17.727"></a><span id="l17.727" class="difflineplus">+</span>
<a href="#l17.728"></a><span id="l17.728" class="difflineplus">+/**</span>
<a href="#l17.729"></a><span id="l17.729" class="difflineplus">+ * Returns this.</span>
<a href="#l17.730"></a><span id="l17.730" class="difflineplus">+ *</span>
<a href="#l17.731"></a><span id="l17.731" class="difflineplus">+ * @returns {pv.Color.Rgb} this.</span>
<a href="#l17.732"></a><span id="l17.732" class="difflineplus">+ */</span>
<a href="#l17.733"></a><span id="l17.733" class="difflineplus">+pv.Color.Rgb.prototype.rgb = function() { return this; };</span>
<a href="#l17.734"></a><span id="l17.734" class="difflineplus">+</span>
<a href="#l17.735"></a><span id="l17.735" class="difflineplus">+/**</span>
<a href="#l17.736"></a><span id="l17.736" class="difflineplus">+ * Constructs a new HSL color with the specified values.</span>
<a href="#l17.737"></a><span id="l17.737" class="difflineplus">+ *</span>
<a href="#l17.738"></a><span id="l17.738" class="difflineplus">+ * @class Represents a color in HSL space.</span>
<a href="#l17.739"></a><span id="l17.739" class="difflineplus">+ *</span>
<a href="#l17.740"></a><span id="l17.740" class="difflineplus">+ * @param {number} h the hue, an integer in [0, 360].</span>
<a href="#l17.741"></a><span id="l17.741" class="difflineplus">+ * @param {number} s the saturation, a float in [0, 1].</span>
<a href="#l17.742"></a><span id="l17.742" class="difflineplus">+ * @param {number} l the lightness, a float in [0, 1].</span>
<a href="#l17.743"></a><span id="l17.743" class="difflineplus">+ * @param {number} a the opacity, a float in [0, 1].</span>
<a href="#l17.744"></a><span id="l17.744" class="difflineplus">+ * @extends pv.Color</span>
<a href="#l17.745"></a><span id="l17.745" class="difflineplus">+ */</span>
<a href="#l17.746"></a><span id="l17.746" class="difflineplus">+pv.Color.Hsl = function(h, s, l, a) {</span>
<a href="#l17.747"></a><span id="l17.747" class="difflineplus">+  pv.Color.call(this, &quot;hsl(&quot; + h + &quot;,&quot; + (s * 100) + &quot;%,&quot; + (l * 100) + &quot;%)&quot;, a);</span>
<a href="#l17.748"></a><span id="l17.748" class="difflineplus">+</span>
<a href="#l17.749"></a><span id="l17.749" class="difflineplus">+  /**</span>
<a href="#l17.750"></a><span id="l17.750" class="difflineplus">+   * The hue, an integer in [0, 360].</span>
<a href="#l17.751"></a><span id="l17.751" class="difflineplus">+   *</span>
<a href="#l17.752"></a><span id="l17.752" class="difflineplus">+   * @type number</span>
<a href="#l17.753"></a><span id="l17.753" class="difflineplus">+   */</span>
<a href="#l17.754"></a><span id="l17.754" class="difflineplus">+  this.h = h;</span>
<a href="#l17.755"></a><span id="l17.755" class="difflineplus">+</span>
<a href="#l17.756"></a><span id="l17.756" class="difflineplus">+  /**</span>
<a href="#l17.757"></a><span id="l17.757" class="difflineplus">+   * The saturation, a float in [0, 1].</span>
<a href="#l17.758"></a><span id="l17.758" class="difflineplus">+   *</span>
<a href="#l17.759"></a><span id="l17.759" class="difflineplus">+   * @type number</span>
<a href="#l17.760"></a><span id="l17.760" class="difflineplus">+   */</span>
<a href="#l17.761"></a><span id="l17.761" class="difflineplus">+  this.s = s;</span>
<a href="#l17.762"></a><span id="l17.762" class="difflineplus">+</span>
<a href="#l17.763"></a><span id="l17.763" class="difflineplus">+  /**</span>
<a href="#l17.764"></a><span id="l17.764" class="difflineplus">+   * The lightness, a float in [0, 1].</span>
<a href="#l17.765"></a><span id="l17.765" class="difflineplus">+   *</span>
<a href="#l17.766"></a><span id="l17.766" class="difflineplus">+   * @type number</span>
<a href="#l17.767"></a><span id="l17.767" class="difflineplus">+   */</span>
<a href="#l17.768"></a><span id="l17.768" class="difflineplus">+  this.l = l;</span>
<a href="#l17.769"></a><span id="l17.769" class="difflineplus">+</span>
<a href="#l17.770"></a><span id="l17.770" class="difflineplus">+  /**</span>
<a href="#l17.771"></a><span id="l17.771" class="difflineplus">+   * The opacity, a float in [0, 1].</span>
<a href="#l17.772"></a><span id="l17.772" class="difflineplus">+   *</span>
<a href="#l17.773"></a><span id="l17.773" class="difflineplus">+   * @type number</span>
<a href="#l17.774"></a><span id="l17.774" class="difflineplus">+   */</span>
<a href="#l17.775"></a><span id="l17.775" class="difflineplus">+  this.a = a;</span>
<a href="#l17.776"></a><span id="l17.776" class="difflineplus">+};</span>
<a href="#l17.777"></a><span id="l17.777" class="difflineplus">+pv.Color.Hsl.prototype = pv.extend(pv.Color);</span>
<a href="#l17.778"></a><span id="l17.778" class="difflineplus">+</span>
<a href="#l17.779"></a><span id="l17.779" class="difflineplus">+/**</span>
<a href="#l17.780"></a><span id="l17.780" class="difflineplus">+ * Returns the RGB color equivalent to this HSL color.</span>
<a href="#l17.781"></a><span id="l17.781" class="difflineplus">+ *</span>
<a href="#l17.782"></a><span id="l17.782" class="difflineplus">+ * @returns {pv.Color.Rgb} an RGB color.</span>
<a href="#l17.783"></a><span id="l17.783" class="difflineplus">+ */</span>
<a href="#l17.784"></a><span id="l17.784" class="difflineplus">+pv.Color.Hsl.prototype.rgb = function() {</span>
<a href="#l17.785"></a><span id="l17.785" class="difflineplus">+  var h = this.h, s = this.s, l = this.l;</span>
<a href="#l17.786"></a><span id="l17.786" class="difflineplus">+</span>
<a href="#l17.787"></a><span id="l17.787" class="difflineplus">+  /* Some simple corrections for h, s and l. */</span>
<a href="#l17.788"></a><span id="l17.788" class="difflineplus">+  h = h % 360; if (h &lt; 0) h += 360;</span>
<a href="#l17.789"></a><span id="l17.789" class="difflineplus">+  s = Math.max(0, Math.min(s, 1));</span>
<a href="#l17.790"></a><span id="l17.790" class="difflineplus">+  l = Math.max(0, Math.min(l, 1));</span>
<a href="#l17.791"></a><span id="l17.791" class="difflineplus">+</span>
<a href="#l17.792"></a><span id="l17.792" class="difflineplus">+  /* From FvD 13.37 */</span>
<a href="#l17.793"></a><span id="l17.793" class="difflineplus">+  var m2 = (l &lt; .5) ? (l * (l + s)) : (l + s - l * s);</span>
<a href="#l17.794"></a><span id="l17.794" class="difflineplus">+  var m1 = 2 * l - m2;</span>
<a href="#l17.795"></a><span id="l17.795" class="difflineplus">+  if (s == 0) {</span>
<a href="#l17.796"></a><span id="l17.796" class="difflineplus">+    return new rgb(l, l, l);</span>
<a href="#l17.797"></a><span id="l17.797" class="difflineplus">+  }</span>
<a href="#l17.798"></a><span id="l17.798" class="difflineplus">+  function v(h) {</span>
<a href="#l17.799"></a><span id="l17.799" class="difflineplus">+    if (h &gt; 360) h -= 360;</span>
<a href="#l17.800"></a><span id="l17.800" class="difflineplus">+    else if (h &lt; 0) h += 360;</span>
<a href="#l17.801"></a><span id="l17.801" class="difflineplus">+    if (h &lt; 60) return m1 + (m2 - m1) * h / 60;</span>
<a href="#l17.802"></a><span id="l17.802" class="difflineplus">+    else if (h &lt; 180) return m2;</span>
<a href="#l17.803"></a><span id="l17.803" class="difflineplus">+    else if (h &lt; 240) return m1 + (m2 - m1) * (240 - h) / 60;</span>
<a href="#l17.804"></a><span id="l17.804" class="difflineplus">+    return m1;</span>
<a href="#l17.805"></a><span id="l17.805" class="difflineplus">+  }</span>
<a href="#l17.806"></a><span id="l17.806" class="difflineplus">+  function vv(h) {</span>
<a href="#l17.807"></a><span id="l17.807" class="difflineplus">+    return Math.round(v(h) * 255);</span>
<a href="#l17.808"></a><span id="l17.808" class="difflineplus">+  }</span>
<a href="#l17.809"></a><span id="l17.809" class="difflineplus">+</span>
<a href="#l17.810"></a><span id="l17.810" class="difflineplus">+  return new pv.Color.Rgb(vv(h + 120), vv(h), vv(h - 120), this.a);</span>
<a href="#l17.811"></a><span id="l17.811" class="difflineplus">+};</span>
<a href="#l17.812"></a><span id="l17.812" class="difflineplus">+/**</span>
<a href="#l17.813"></a><span id="l17.813" class="difflineplus">+ * Returns a new categorical color encoding using the specified colors.  The</span>
<a href="#l17.814"></a><span id="l17.814" class="difflineplus">+ * arguments to this method are an array of colors; see {@link pv.color}. For</span>
<a href="#l17.815"></a><span id="l17.815" class="difflineplus">+ * example, to create a categorical color encoding using the &lt;tt&gt;species&lt;/tt&gt;</span>
<a href="#l17.816"></a><span id="l17.816" class="difflineplus">+ * attribute:</span>
<a href="#l17.817"></a><span id="l17.817" class="difflineplus">+ *</span>
<a href="#l17.818"></a><span id="l17.818" class="difflineplus">+ * &lt;pre&gt;pv.colors(&quot;red&quot;, &quot;green&quot;, &quot;blue&quot;).by(function(d) d.species)&lt;/pre&gt;</span>
<a href="#l17.819"></a><span id="l17.819" class="difflineplus">+ *</span>
<a href="#l17.820"></a><span id="l17.820" class="difflineplus">+ * The result of this expression can be used as a fill- or stroke-style</span>
<a href="#l17.821"></a><span id="l17.821" class="difflineplus">+ * property. This assumes that the data's &lt;tt&gt;species&lt;/tt&gt; attribute is a</span>
<a href="#l17.822"></a><span id="l17.822" class="difflineplus">+ * string.</span>
<a href="#l17.823"></a><span id="l17.823" class="difflineplus">+ *</span>
<a href="#l17.824"></a><span id="l17.824" class="difflineplus">+ * @returns {pv.Colors} a new categorical color encoding.</span>
<a href="#l17.825"></a><span id="l17.825" class="difflineplus">+ * @param {string} colors... categorical colors.</span>
<a href="#l17.826"></a><span id="l17.826" class="difflineplus">+ * @see pv.Colors</span>
<a href="#l17.827"></a><span id="l17.827" class="difflineplus">+ */</span>
<a href="#l17.828"></a><span id="l17.828" class="difflineplus">+pv.colors = function() {</span>
<a href="#l17.829"></a><span id="l17.829" class="difflineplus">+  return pv.Colors(arguments);</span>
<a href="#l17.830"></a><span id="l17.830" class="difflineplus">+};</span>
<a href="#l17.831"></a><span id="l17.831" class="difflineplus">+</span>
<a href="#l17.832"></a><span id="l17.832" class="difflineplus">+/**</span>
<a href="#l17.833"></a><span id="l17.833" class="difflineplus">+ * Returns a new categorical color encoding using the specified colors. This</span>
<a href="#l17.834"></a><span id="l17.834" class="difflineplus">+ * constructor is typically not used directly; use {@link pv.colors} instead.</span>
<a href="#l17.835"></a><span id="l17.835" class="difflineplus">+ *</span>
<a href="#l17.836"></a><span id="l17.836" class="difflineplus">+ * @class Represents a categorical color encoding using the specified colors.</span>
<a href="#l17.837"></a><span id="l17.837" class="difflineplus">+ * The returned object can be used as a property function; the appropriate</span>
<a href="#l17.838"></a><span id="l17.838" class="difflineplus">+ * categorical color will be returned by evaluating the current datum, or</span>
<a href="#l17.839"></a><span id="l17.839" class="difflineplus">+ * through whatever other means the encoding uses to determine uniqueness, per</span>
<a href="#l17.840"></a><span id="l17.840" class="difflineplus">+ * the {@link #by} method. The default implementation allocates a distinct color</span>
<a href="#l17.841"></a><span id="l17.841" class="difflineplus">+ * per {@link pv.Mark#childIndex}.</span>
<a href="#l17.842"></a><span id="l17.842" class="difflineplus">+ *</span>
<a href="#l17.843"></a><span id="l17.843" class="difflineplus">+ * @param {string[]} values an array of colors; see {@link pv.color}.</span>
<a href="#l17.844"></a><span id="l17.844" class="difflineplus">+ * @returns {pv.Colors} a new categorical color encoding.</span>
<a href="#l17.845"></a><span id="l17.845" class="difflineplus">+ * @see pv.colors</span>
<a href="#l17.846"></a><span id="l17.846" class="difflineplus">+ */</span>
<a href="#l17.847"></a><span id="l17.847" class="difflineplus">+pv.Colors = function(values) {</span>
<a href="#l17.848"></a><span id="l17.848" class="difflineplus">+</span>
<a href="#l17.849"></a><span id="l17.849" class="difflineplus">+  /**</span>
<a href="#l17.850"></a><span id="l17.850" class="difflineplus">+   * @ignore Each set of colors has an associated (numeric) ID that is used to</span>
<a href="#l17.851"></a><span id="l17.851" class="difflineplus">+   * store a cache of assigned colors on the root scene. As unique keys are</span>
<a href="#l17.852"></a><span id="l17.852" class="difflineplus">+   * discovered, a new color is allocated and assigned to the given key.</span>
<a href="#l17.853"></a><span id="l17.853" class="difflineplus">+   *</span>
<a href="#l17.854"></a><span id="l17.854" class="difflineplus">+   * The key function determines how uniqueness is determined. By default,</span>
<a href="#l17.855"></a><span id="l17.855" class="difflineplus">+   * colors are assigned using the mark's childIndex, such that each new mark</span>
<a href="#l17.856"></a><span id="l17.856" class="difflineplus">+   * added is given a new color. Note that derived marks will not inherit the</span>
<a href="#l17.857"></a><span id="l17.857" class="difflineplus">+   * exact color of the prototype, but instead inherit the set of colors.</span>
<a href="#l17.858"></a><span id="l17.858" class="difflineplus">+   */</span>
<a href="#l17.859"></a><span id="l17.859" class="difflineplus">+  function colors(keyf) {</span>
<a href="#l17.860"></a><span id="l17.860" class="difflineplus">+    var id = pv.Colors.count++;</span>
<a href="#l17.861"></a><span id="l17.861" class="difflineplus">+</span>
<a href="#l17.862"></a><span id="l17.862" class="difflineplus">+    function color() {</span>
<a href="#l17.863"></a><span id="l17.863" class="difflineplus">+      var key = keyf.apply(this, this.root.scene.data);</span>
<a href="#l17.864"></a><span id="l17.864" class="difflineplus">+      var state = this.root.scene.colors;</span>
<a href="#l17.865"></a><span id="l17.865" class="difflineplus">+      if (!state) this.root.scene.colors = state = {};</span>
<a href="#l17.866"></a><span id="l17.866" class="difflineplus">+      if (!state[id]) state[id] = { count: 0 };</span>
<a href="#l17.867"></a><span id="l17.867" class="difflineplus">+      var color = state[id][key];</span>
<a href="#l17.868"></a><span id="l17.868" class="difflineplus">+      if (color == undefined) {</span>
<a href="#l17.869"></a><span id="l17.869" class="difflineplus">+        color = state[id][key] = values[state[id].count++ % values.length];</span>
<a href="#l17.870"></a><span id="l17.870" class="difflineplus">+      }</span>
<a href="#l17.871"></a><span id="l17.871" class="difflineplus">+      return color;</span>
<a href="#l17.872"></a><span id="l17.872" class="difflineplus">+    }</span>
<a href="#l17.873"></a><span id="l17.873" class="difflineplus">+    return color;</span>
<a href="#l17.874"></a><span id="l17.874" class="difflineplus">+  }</span>
<a href="#l17.875"></a><span id="l17.875" class="difflineplus">+</span>
<a href="#l17.876"></a><span id="l17.876" class="difflineplus">+  var c = colors(function() { return this.childIndex; });</span>
<a href="#l17.877"></a><span id="l17.877" class="difflineplus">+</span>
<a href="#l17.878"></a><span id="l17.878" class="difflineplus">+  /**</span>
<a href="#l17.879"></a><span id="l17.879" class="difflineplus">+   * Allows a new set of colors to be derived from the current set using a</span>
<a href="#l17.880"></a><span id="l17.880" class="difflineplus">+   * different key function. For instance, to color marks using the value of the</span>
<a href="#l17.881"></a><span id="l17.881" class="difflineplus">+   * field &quot;foo&quot;, say:</span>
<a href="#l17.882"></a><span id="l17.882" class="difflineplus">+   *</span>
<a href="#l17.883"></a><span id="l17.883" class="difflineplus">+   * &lt;pre&gt;pv.Colors.category10.by(function(d) d.foo)&lt;/pre&gt;</span>
<a href="#l17.884"></a><span id="l17.884" class="difflineplus">+   *</span>
<a href="#l17.885"></a><span id="l17.885" class="difflineplus">+   * For convenience, &quot;index&quot; and &quot;parent.index&quot; keys are predefined.</span>
<a href="#l17.886"></a><span id="l17.886" class="difflineplus">+   *</span>
<a href="#l17.887"></a><span id="l17.887" class="difflineplus">+   * @param {function} v the new key function.</span>
<a href="#l17.888"></a><span id="l17.888" class="difflineplus">+   * @name pv.Colors.prototype.by</span>
<a href="#l17.889"></a><span id="l17.889" class="difflineplus">+   * @function</span>
<a href="#l17.890"></a><span id="l17.890" class="difflineplus">+   * @returns {pv.Colors} a new color scheme</span>
<a href="#l17.891"></a><span id="l17.891" class="difflineplus">+   */</span>
<a href="#l17.892"></a><span id="l17.892" class="difflineplus">+  c.by = colors;</span>
<a href="#l17.893"></a><span id="l17.893" class="difflineplus">+</span>
<a href="#l17.894"></a><span id="l17.894" class="difflineplus">+  /**</span>
<a href="#l17.895"></a><span id="l17.895" class="difflineplus">+   * A derivative color encoding using the same colors, but allocating unique</span>
<a href="#l17.896"></a><span id="l17.896" class="difflineplus">+   * colors based on the mark index.</span>
<a href="#l17.897"></a><span id="l17.897" class="difflineplus">+   *</span>
<a href="#l17.898"></a><span id="l17.898" class="difflineplus">+   * @name pv.Colors.prototype.unique</span>
<a href="#l17.899"></a><span id="l17.899" class="difflineplus">+   * @type pv.Colors</span>
<a href="#l17.900"></a><span id="l17.900" class="difflineplus">+   */</span>
<a href="#l17.901"></a><span id="l17.901" class="difflineplus">+  c.unique = c.by(function() { return this.index; });</span>
<a href="#l17.902"></a><span id="l17.902" class="difflineplus">+</span>
<a href="#l17.903"></a><span id="l17.903" class="difflineplus">+  /**</span>
<a href="#l17.904"></a><span id="l17.904" class="difflineplus">+   * A derivative color encoding using the same colors, but allocating unique</span>
<a href="#l17.905"></a><span id="l17.905" class="difflineplus">+   * colors based on the parent index.</span>
<a href="#l17.906"></a><span id="l17.906" class="difflineplus">+   *</span>
<a href="#l17.907"></a><span id="l17.907" class="difflineplus">+   * @name pv.Colors.prototype.parent</span>
<a href="#l17.908"></a><span id="l17.908" class="difflineplus">+   * @type pv.Colors</span>
<a href="#l17.909"></a><span id="l17.909" class="difflineplus">+   */</span>
<a href="#l17.910"></a><span id="l17.910" class="difflineplus">+  c.parent = c.by(function() { return this.parent.index; });</span>
<a href="#l17.911"></a><span id="l17.911" class="difflineplus">+</span>
<a href="#l17.912"></a><span id="l17.912" class="difflineplus">+  /**</span>
<a href="#l17.913"></a><span id="l17.913" class="difflineplus">+   * The underlying array of colors.</span>
<a href="#l17.914"></a><span id="l17.914" class="difflineplus">+   *</span>
<a href="#l17.915"></a><span id="l17.915" class="difflineplus">+   * @type string[]</span>
<a href="#l17.916"></a><span id="l17.916" class="difflineplus">+   * @name pv.Colors.prototype.values</span>
<a href="#l17.917"></a><span id="l17.917" class="difflineplus">+   */</span>
<a href="#l17.918"></a><span id="l17.918" class="difflineplus">+  c.values = values;</span>
<a href="#l17.919"></a><span id="l17.919" class="difflineplus">+</span>
<a href="#l17.920"></a><span id="l17.920" class="difflineplus">+  return c;</span>
<a href="#l17.921"></a><span id="l17.921" class="difflineplus">+};</span>
<a href="#l17.922"></a><span id="l17.922" class="difflineplus">+</span>
<a href="#l17.923"></a><span id="l17.923" class="difflineplus">+/** @private */</span>
<a href="#l17.924"></a><span id="l17.924" class="difflineplus">+pv.Colors.count = 0;</span>
<a href="#l17.925"></a><span id="l17.925" class="difflineplus">+</span>
<a href="#l17.926"></a><span id="l17.926" class="difflineplus">+/* From Flare. */</span>
<a href="#l17.927"></a><span id="l17.927" class="difflineplus">+</span>
<a href="#l17.928"></a><span id="l17.928" class="difflineplus">+/**</span>
<a href="#l17.929"></a><span id="l17.929" class="difflineplus">+ * A 10-color scheme.</span>
<a href="#l17.930"></a><span id="l17.930" class="difflineplus">+ *</span>
<a href="#l17.931"></a><span id="l17.931" class="difflineplus">+ * @type pv.Colors</span>
<a href="#l17.932"></a><span id="l17.932" class="difflineplus">+ */</span>
<a href="#l17.933"></a><span id="l17.933" class="difflineplus">+pv.Colors.category10 = pv.colors(</span>
<a href="#l17.934"></a><span id="l17.934" class="difflineplus">+  &quot;#1f77b4&quot;, &quot;#ff7f0e&quot;, &quot;#2ca02c&quot;, &quot;#d62728&quot;, &quot;#9467bd&quot;,</span>
<a href="#l17.935"></a><span id="l17.935" class="difflineplus">+  &quot;#8c564b&quot;, &quot;#e377c2&quot;, &quot;#7f7f7f&quot;, &quot;#bcbd22&quot;, &quot;#17becf&quot;</span>
<a href="#l17.936"></a><span id="l17.936" class="difflineplus">+);</span>
<a href="#l17.937"></a><span id="l17.937" class="difflineplus">+</span>
<a href="#l17.938"></a><span id="l17.938" class="difflineplus">+/**</span>
<a href="#l17.939"></a><span id="l17.939" class="difflineplus">+ * A 20-color scheme.</span>
<a href="#l17.940"></a><span id="l17.940" class="difflineplus">+ *</span>
<a href="#l17.941"></a><span id="l17.941" class="difflineplus">+ * @type pv.Colors</span>
<a href="#l17.942"></a><span id="l17.942" class="difflineplus">+ */</span>
<a href="#l17.943"></a><span id="l17.943" class="difflineplus">+pv.Colors.category20 = pv.colors(</span>
<a href="#l17.944"></a><span id="l17.944" class="difflineplus">+  &quot;#1f77b4&quot;, &quot;#aec7e8&quot;, &quot;#ff7f0e&quot;, &quot;#ffbb78&quot;, &quot;#2ca02c&quot;,</span>
<a href="#l17.945"></a><span id="l17.945" class="difflineplus">+  &quot;#98df8a&quot;, &quot;#d62728&quot;, &quot;#ff9896&quot;, &quot;#9467bd&quot;, &quot;#c5b0d5&quot;,</span>
<a href="#l17.946"></a><span id="l17.946" class="difflineplus">+  &quot;#8c564b&quot;, &quot;#c49c94&quot;, &quot;#e377c2&quot;, &quot;#f7b6d2&quot;, &quot;#7f7f7f&quot;,</span>
<a href="#l17.947"></a><span id="l17.947" class="difflineplus">+  &quot;#c7c7c7&quot;, &quot;#bcbd22&quot;, &quot;#dbdb8d&quot;, &quot;#17becf&quot;, &quot;#9edae5&quot;</span>
<a href="#l17.948"></a><span id="l17.948" class="difflineplus">+);</span>
<a href="#l17.949"></a><span id="l17.949" class="difflineplus">+</span>
<a href="#l17.950"></a><span id="l17.950" class="difflineplus">+/**</span>
<a href="#l17.951"></a><span id="l17.951" class="difflineplus">+ * An alternative 19-color scheme.</span>
<a href="#l17.952"></a><span id="l17.952" class="difflineplus">+ *</span>
<a href="#l17.953"></a><span id="l17.953" class="difflineplus">+ * @type pv.Colors</span>
<a href="#l17.954"></a><span id="l17.954" class="difflineplus">+ */</span>
<a href="#l17.955"></a><span id="l17.955" class="difflineplus">+pv.Colors.category19 = pv.colors(</span>
<a href="#l17.956"></a><span id="l17.956" class="difflineplus">+  &quot;#9c9ede&quot;, &quot;#7375b5&quot;, &quot;#4a5584&quot;, &quot;#cedb9c&quot;, &quot;#b5cf6b&quot;,</span>
<a href="#l17.957"></a><span id="l17.957" class="difflineplus">+  &quot;#8ca252&quot;, &quot;#637939&quot;, &quot;#e7cb94&quot;, &quot;#e7ba52&quot;, &quot;#bd9e39&quot;,</span>
<a href="#l17.958"></a><span id="l17.958" class="difflineplus">+  &quot;#8c6d31&quot;, &quot;#e7969c&quot;, &quot;#d6616b&quot;, &quot;#ad494a&quot;, &quot;#843c39&quot;,</span>
<a href="#l17.959"></a><span id="l17.959" class="difflineplus">+  &quot;#de9ed6&quot;, &quot;#ce6dbd&quot;, &quot;#a55194&quot;, &quot;#7b4173&quot;</span>
<a href="#l17.960"></a><span id="l17.960" class="difflineplus">+);</span>
<a href="#l17.961"></a><span id="l17.961" class="difflineplus">+// TODO support arbitrary color stops</span>
<a href="#l17.962"></a><span id="l17.962" class="difflineplus">+</span>
<a href="#l17.963"></a><span id="l17.963" class="difflineplus">+/**</span>
<a href="#l17.964"></a><span id="l17.964" class="difflineplus">+ * Returns a linear color ramp from the specified &lt;tt&gt;start&lt;/tt&gt; color to the</span>
<a href="#l17.965"></a><span id="l17.965" class="difflineplus">+ * specified &lt;tt&gt;end&lt;/tt&gt; color. The color arguments may be specified either as</span>
<a href="#l17.966"></a><span id="l17.966" class="difflineplus">+ * &lt;tt&gt;string&lt;/tt&gt;s or as {@link pv.Color}s.</span>
<a href="#l17.967"></a><span id="l17.967" class="difflineplus">+ *</span>
<a href="#l17.968"></a><span id="l17.968" class="difflineplus">+ * @param {string} start the start color; may be a &lt;tt&gt;pv.Color&lt;/tt&gt;.</span>
<a href="#l17.969"></a><span id="l17.969" class="difflineplus">+ * @param {string} end the end color; may be a &lt;tt&gt;pv.Color&lt;/tt&gt;.</span>
<a href="#l17.970"></a><span id="l17.970" class="difflineplus">+ * @returns {pv.Ramp} a color ramp from &lt;tt&gt;start&lt;/tt&gt; to &lt;tt&gt;end&lt;/tt&gt;.</span>
<a href="#l17.971"></a><span id="l17.971" class="difflineplus">+ */</span>
<a href="#l17.972"></a><span id="l17.972" class="difflineplus">+pv.ramp = function(start, end) {</span>
<a href="#l17.973"></a><span id="l17.973" class="difflineplus">+  return pv.Ramp(pv.color(start), pv.color(end));</span>
<a href="#l17.974"></a><span id="l17.974" class="difflineplus">+};</span>
<a href="#l17.975"></a><span id="l17.975" class="difflineplus">+</span>
<a href="#l17.976"></a><span id="l17.976" class="difflineplus">+/**</span>
<a href="#l17.977"></a><span id="l17.977" class="difflineplus">+ * Constructs a ramp from the specified start color to the specified end</span>
<a href="#l17.978"></a><span id="l17.978" class="difflineplus">+ * color. This constructor should not be invoked directly; use {@link pv.ramp}</span>
<a href="#l17.979"></a><span id="l17.979" class="difflineplus">+ * instead.</span>
<a href="#l17.980"></a><span id="l17.980" class="difflineplus">+ *</span>
<a href="#l17.981"></a><span id="l17.981" class="difflineplus">+ * @class Represents a linear color ramp from the specified &lt;tt&gt;start&lt;/tt&gt; color</span>
<a href="#l17.982"></a><span id="l17.982" class="difflineplus">+ * to the specified &lt;tt&gt;end&lt;/tt&gt; color. Ramps can be used as property functions;</span>
<a href="#l17.983"></a><span id="l17.983" class="difflineplus">+ * their behavior is equivalent to calling {@link #value}, passing in the</span>
<a href="#l17.984"></a><span id="l17.984" class="difflineplus">+ * current datum as the sample point. If the data is &lt;i&gt;not&lt;/i&gt; a float in [0,</span>
<a href="#l17.985"></a><span id="l17.985" class="difflineplus">+ * 1], the {@link #by} method can be used to map the datum to a suitable sample</span>
<a href="#l17.986"></a><span id="l17.986" class="difflineplus">+ * point.</span>
<a href="#l17.987"></a><span id="l17.987" class="difflineplus">+ *</span>
<a href="#l17.988"></a><span id="l17.988" class="difflineplus">+ * @extends Function</span>
<a href="#l17.989"></a><span id="l17.989" class="difflineplus">+ * @param {pv.Color} start the start color.</span>
<a href="#l17.990"></a><span id="l17.990" class="difflineplus">+ * @param {pv.Color} end the end color.</span>
<a href="#l17.991"></a><span id="l17.991" class="difflineplus">+ * @see pv.ramp</span>
<a href="#l17.992"></a><span id="l17.992" class="difflineplus">+ */</span>
<a href="#l17.993"></a><span id="l17.993" class="difflineplus">+pv.Ramp = function(start, end) {</span>
<a href="#l17.994"></a><span id="l17.994" class="difflineplus">+  var s = start.rgb(), e = end.rgb(), f = pv.identity;</span>
<a href="#l17.995"></a><span id="l17.995" class="difflineplus">+</span>
<a href="#l17.996"></a><span id="l17.996" class="difflineplus">+  /** @ignore Property function. */</span>
<a href="#l17.997"></a><span id="l17.997" class="difflineplus">+  function ramp() {</span>
<a href="#l17.998"></a><span id="l17.998" class="difflineplus">+    return value(f.apply(this, this.root.scene.data));</span>
<a href="#l17.999"></a><span id="l17.999" class="difflineplus">+  }</span>
<a href="#l17.1000"></a><span id="l17.1000" class="difflineplus">+</span>
<a href="#l17.1001"></a><span id="l17.1001" class="difflineplus">+  /** @ignore Interpolates between start and end at value t in [0,1]. */</span>
<a href="#l17.1002"></a><span id="l17.1002" class="difflineplus">+  function value(t) {</span>
<a href="#l17.1003"></a><span id="l17.1003" class="difflineplus">+    var t = Math.max(0, Math.min(1, t));</span>
<a href="#l17.1004"></a><span id="l17.1004" class="difflineplus">+    var a = s.a * (1 - t) + e.a * t;</span>
<a href="#l17.1005"></a><span id="l17.1005" class="difflineplus">+    if (a &lt; 1e-5) a = 0; // avoid scientific notation</span>
<a href="#l17.1006"></a><span id="l17.1006" class="difflineplus">+    return (s.a == 0) ? new pv.Color.Rgb(e.r, e.g, e.b, a)</span>
<a href="#l17.1007"></a><span id="l17.1007" class="difflineplus">+        : ((e.a == 0) ? new pv.Color.Rgb(s.r, s.g, s.b, a)</span>
<a href="#l17.1008"></a><span id="l17.1008" class="difflineplus">+        : new pv.Color.Rgb(</span>
<a href="#l17.1009"></a><span id="l17.1009" class="difflineplus">+            Math.round(s.r * (1 - t) + e.r * t),</span>
<a href="#l17.1010"></a><span id="l17.1010" class="difflineplus">+            Math.round(s.g * (1 - t) + e.g * t),</span>
<a href="#l17.1011"></a><span id="l17.1011" class="difflineplus">+            Math.round(s.b * (1 - t) + e.b * t), a));</span>
<a href="#l17.1012"></a><span id="l17.1012" class="difflineplus">+  }</span>
<a href="#l17.1013"></a><span id="l17.1013" class="difflineplus">+</span>
<a href="#l17.1014"></a><span id="l17.1014" class="difflineplus">+  /**</span>
<a href="#l17.1015"></a><span id="l17.1015" class="difflineplus">+   * Sets the sample function to be the specified function &lt;tt&gt;v&lt;/tt&gt;.</span>
<a href="#l17.1016"></a><span id="l17.1016" class="difflineplus">+   *</span>
<a href="#l17.1017"></a><span id="l17.1017" class="difflineplus">+   * @param {function} v the new sample function.</span>
<a href="#l17.1018"></a><span id="l17.1018" class="difflineplus">+   * @name pv.Ramp.prototype.by</span>
<a href="#l17.1019"></a><span id="l17.1019" class="difflineplus">+   * @function</span>
<a href="#l17.1020"></a><span id="l17.1020" class="difflineplus">+   * @returns {pv.Ramp} this.</span>
<a href="#l17.1021"></a><span id="l17.1021" class="difflineplus">+   */</span>
<a href="#l17.1022"></a><span id="l17.1022" class="difflineplus">+  ramp.by = function(v) { f = v; return this; };</span>
<a href="#l17.1023"></a><span id="l17.1023" class="difflineplus">+</span>
<a href="#l17.1024"></a><span id="l17.1024" class="difflineplus">+  /**</span>
<a href="#l17.1025"></a><span id="l17.1025" class="difflineplus">+   * Returns the interpolated color at the specified sample point.</span>
<a href="#l17.1026"></a><span id="l17.1026" class="difflineplus">+   *</span>
<a href="#l17.1027"></a><span id="l17.1027" class="difflineplus">+   * @param {number} t the sample point in [0, 1].</span>
<a href="#l17.1028"></a><span id="l17.1028" class="difflineplus">+   * @name pv.Ramp.prototype.value</span>
<a href="#l17.1029"></a><span id="l17.1029" class="difflineplus">+   * @function</span>
<a href="#l17.1030"></a><span id="l17.1030" class="difflineplus">+   * @returns {pv.Color.Rgb} the interpolated color.</span>
<a href="#l17.1031"></a><span id="l17.1031" class="difflineplus">+   */</span>
<a href="#l17.1032"></a><span id="l17.1032" class="difflineplus">+  ramp.value = value;</span>
<a href="#l17.1033"></a><span id="l17.1033" class="difflineplus">+</span>
<a href="#l17.1034"></a><span id="l17.1034" class="difflineplus">+  return ramp;</span>
<a href="#l17.1035"></a><span id="l17.1035" class="difflineplus">+};</span>
<a href="#l17.1036"></a><span id="l17.1036" class="difflineplus">+/**</span>
<a href="#l17.1037"></a><span id="l17.1037" class="difflineplus">+ * Constructs a new mark with default properties. Marks, with the exception of</span>
<a href="#l17.1038"></a><span id="l17.1038" class="difflineplus">+ * the root panel, are not typically constructed directly; instead, they are</span>
<a href="#l17.1039"></a><span id="l17.1039" class="difflineplus">+ * added to a panel or an existing mark via {@link pv.Mark#add}.</span>
<a href="#l17.1040"></a><span id="l17.1040" class="difflineplus">+ *</span>
<a href="#l17.1041"></a><span id="l17.1041" class="difflineplus">+ * @class Represents a data-driven graphical mark. The &lt;tt&gt;Mark&lt;/tt&gt; class is</span>
<a href="#l17.1042"></a><span id="l17.1042" class="difflineplus">+ * the base class for all graphical marks in Protovis; it does not provide any</span>
<a href="#l17.1043"></a><span id="l17.1043" class="difflineplus">+ * specific rendering functionality, but together with {@link Panel} establishes</span>
<a href="#l17.1044"></a><span id="l17.1044" class="difflineplus">+ * the core framework.</span>
<a href="#l17.1045"></a><span id="l17.1045" class="difflineplus">+ *</span>
<a href="#l17.1046"></a><span id="l17.1046" class="difflineplus">+ * &lt;p&gt;Concrete mark types include familiar visual elements such as bars, lines</span>
<a href="#l17.1047"></a><span id="l17.1047" class="difflineplus">+ * and labels. Although a bar mark may be used to construct a bar chart, marks</span>
<a href="#l17.1048"></a><span id="l17.1048" class="difflineplus">+ * know nothing about charts; it is only through their specification and</span>
<a href="#l17.1049"></a><span id="l17.1049" class="difflineplus">+ * composition that charts are produced. These building blocks permit many</span>
<a href="#l17.1050"></a><span id="l17.1050" class="difflineplus">+ * combinatorial possibilities.</span>
<a href="#l17.1051"></a><span id="l17.1051" class="difflineplus">+ *</span>
<a href="#l17.1052"></a><span id="l17.1052" class="difflineplus">+ * &lt;p&gt;Marks are associated with &lt;b&gt;data&lt;/b&gt;: a mark is generated once per</span>
<a href="#l17.1053"></a><span id="l17.1053" class="difflineplus">+ * associated datum, mapping the datum to visual &lt;b&gt;properties&lt;/b&gt; such as</span>
<a href="#l17.1054"></a><span id="l17.1054" class="difflineplus">+ * position and color. Thus, a single mark specification represents a set of</span>
<a href="#l17.1055"></a><span id="l17.1055" class="difflineplus">+ * visual elements that share the same data and visual encoding. The type of</span>
<a href="#l17.1056"></a><span id="l17.1056" class="difflineplus">+ * mark defines the names of properties and their meaning. A property may be</span>
<a href="#l17.1057"></a><span id="l17.1057" class="difflineplus">+ * static, ignoring the associated datum and returning a constant; or, it may be</span>
<a href="#l17.1058"></a><span id="l17.1058" class="difflineplus">+ * dynamic, derived from the associated datum or index. Such dynamic encodings</span>
<a href="#l17.1059"></a><span id="l17.1059" class="difflineplus">+ * can be specified succinctly using anonymous functions. Special properties</span>
<a href="#l17.1060"></a><span id="l17.1060" class="difflineplus">+ * called event handlers can be registered to add interactivity.</span>
<a href="#l17.1061"></a><span id="l17.1061" class="difflineplus">+ *</span>
<a href="#l17.1062"></a><span id="l17.1062" class="difflineplus">+ * &lt;p&gt;While most properties are &lt;i&gt;variable&lt;/i&gt;, some mark types, such as lines</span>
<a href="#l17.1063"></a><span id="l17.1063" class="difflineplus">+ * and areas, generate a single visual element rather than a distinct visual</span>
<a href="#l17.1064"></a><span id="l17.1064" class="difflineplus">+ * element per datum. With these marks, some properties may be &lt;b&gt;fixed&lt;/b&gt;.</span>
<a href="#l17.1065"></a><span id="l17.1065" class="difflineplus">+ * Fixed properties can vary per mark, but not &lt;i&gt;per datum&lt;/i&gt;! These</span>
<a href="#l17.1066"></a><span id="l17.1066" class="difflineplus">+ * properties are evaluated solely for the first (0-index) datum, and typically</span>
<a href="#l17.1067"></a><span id="l17.1067" class="difflineplus">+ * are specified as a constant. However, it is valid to use a function if the</span>
<a href="#l17.1068"></a><span id="l17.1068" class="difflineplus">+ * property varies between panels or is dynamically generated.</span>
<a href="#l17.1069"></a><span id="l17.1069" class="difflineplus">+ *</span>
<a href="#l17.1070"></a><span id="l17.1070" class="difflineplus">+ * &lt;p&gt;Protovis uses &lt;b&gt;inheritance&lt;/b&gt; to simplify the specification of related</span>
<a href="#l17.1071"></a><span id="l17.1071" class="difflineplus">+ * marks: a new mark can be derived from an existing mark, inheriting its</span>
<a href="#l17.1072"></a><span id="l17.1072" class="difflineplus">+ * properties. The new mark can then override properties to specify new</span>
<a href="#l17.1073"></a><span id="l17.1073" class="difflineplus">+ * behavior, potentially in terms of the old behavior. In this way, the old mark</span>
<a href="#l17.1074"></a><span id="l17.1074" class="difflineplus">+ * serves as the &lt;b&gt;prototype&lt;/b&gt; for the new mark. Most mark types share the</span>
<a href="#l17.1075"></a><span id="l17.1075" class="difflineplus">+ * same basic properties for consistency and to facilitate inheritance.</span>
<a href="#l17.1076"></a><span id="l17.1076" class="difflineplus">+ *</span>
<a href="#l17.1077"></a><span id="l17.1077" class="difflineplus">+ * &lt;p&gt;See also the &lt;a href=&quot;../../api/&quot;&gt;Protovis guide&lt;/a&gt;.</span>
<a href="#l17.1078"></a><span id="l17.1078" class="difflineplus">+ */</span>
<a href="#l17.1079"></a><span id="l17.1079" class="difflineplus">+pv.Mark = function() {};</span>
<a href="#l17.1080"></a><span id="l17.1080" class="difflineplus">+</span>
<a href="#l17.1081"></a><span id="l17.1081" class="difflineplus">+/**</span>
<a href="#l17.1082"></a><span id="l17.1082" class="difflineplus">+ * Returns the mark type name. Names should be lower case, with words separated</span>
<a href="#l17.1083"></a><span id="l17.1083" class="difflineplus">+ * by hyphens. For example, the mark class &lt;tt&gt;FooBar&lt;/tt&gt; should return</span>
<a href="#l17.1084"></a><span id="l17.1084" class="difflineplus">+ * &quot;foo-bar&quot;.</span>
<a href="#l17.1085"></a><span id="l17.1085" class="difflineplus">+ *</span>
<a href="#l17.1086"></a><span id="l17.1086" class="difflineplus">+ * &lt;p&gt;Note that this method is defined on the constructor, not on the prototype,</span>
<a href="#l17.1087"></a><span id="l17.1087" class="difflineplus">+ * and thus is a static method. The constructor is accessible through the</span>
<a href="#l17.1088"></a><span id="l17.1088" class="difflineplus">+ * {@link #type} field.</span>
<a href="#l17.1089"></a><span id="l17.1089" class="difflineplus">+ *</span>
<a href="#l17.1090"></a><span id="l17.1090" class="difflineplus">+ * @returns {string} the mark type name, such as &quot;mark&quot;.</span>
<a href="#l17.1091"></a><span id="l17.1091" class="difflineplus">+ */</span>
<a href="#l17.1092"></a><span id="l17.1092" class="difflineplus">+pv.Mark.toString = function() { return &quot;mark&quot;; };</span>
<a href="#l17.1093"></a><span id="l17.1093" class="difflineplus">+</span>
<a href="#l17.1094"></a><span id="l17.1094" class="difflineplus">+/**</span>
<a href="#l17.1095"></a><span id="l17.1095" class="difflineplus">+ * Defines and registers a property method for the property with the given name.</span>
<a href="#l17.1096"></a><span id="l17.1096" class="difflineplus">+ * This method should be called on a mark class prototype to define each exposed</span>
<a href="#l17.1097"></a><span id="l17.1097" class="difflineplus">+ * property. (Note this refers to the JavaScript &lt;tt&gt;prototype&lt;/tt&gt;, not the</span>
<a href="#l17.1098"></a><span id="l17.1098" class="difflineplus">+ * Protovis mark prototype, which is the {@link #proto} field.)</span>
<a href="#l17.1099"></a><span id="l17.1099" class="difflineplus">+ *</span>
<a href="#l17.1100"></a><span id="l17.1100" class="difflineplus">+ * &lt;p&gt;The created property method supports several modes of invocation: &lt;ol&gt;</span>
<a href="#l17.1101"></a><span id="l17.1101" class="difflineplus">+ *</span>
<a href="#l17.1102"></a><span id="l17.1102" class="difflineplus">+ * &lt;li&gt;If invoked with a &lt;tt&gt;Function&lt;/tt&gt; argument, this function is evaluated</span>
<a href="#l17.1103"></a><span id="l17.1103" class="difflineplus">+ * for each associated datum. The return value of the function is used as the</span>
<a href="#l17.1104"></a><span id="l17.1104" class="difflineplus">+ * computed property value. The context of the function (&lt;tt&gt;this&lt;/tt&gt;) is this</span>
<a href="#l17.1105"></a><span id="l17.1105" class="difflineplus">+ * mark. The arguments to the function are the associated data of this mark and</span>
<a href="#l17.1106"></a><span id="l17.1106" class="difflineplus">+ * any enclosing panels. For example, a linear encoding of numerical data to</span>
<a href="#l17.1107"></a><span id="l17.1107" class="difflineplus">+ * height is specified as</span>
<a href="#l17.1108"></a><span id="l17.1108" class="difflineplus">+ *</span>
<a href="#l17.1109"></a><span id="l17.1109" class="difflineplus">+ * &lt;pre&gt;m.height(function(d) d * 100);&lt;/pre&gt;</span>
<a href="#l17.1110"></a><span id="l17.1110" class="difflineplus">+ *</span>
<a href="#l17.1111"></a><span id="l17.1111" class="difflineplus">+ * The expression &lt;tt&gt;d * 100&lt;/tt&gt; will be evaluated for the height property of</span>
<a href="#l17.1112"></a><span id="l17.1112" class="difflineplus">+ * each mark instance. This function is stored in the &lt;tt&gt;$height&lt;/tt&gt; field. The</span>
<a href="#l17.1113"></a><span id="l17.1113" class="difflineplus">+ * return value of the property method (e.g., &lt;tt&gt;m.height&lt;/tt&gt;) is this mark</span>
<a href="#l17.1114"></a><span id="l17.1114" class="difflineplus">+ * (&lt;tt&gt;m&lt;/tt&gt;)).&lt;p&gt;</span>
<a href="#l17.1115"></a><span id="l17.1115" class="difflineplus">+ *</span>
<a href="#l17.1116"></a><span id="l17.1116" class="difflineplus">+ * &lt;li&gt;If invoked with a non-function argument, the property is treated as a</span>
<a href="#l17.1117"></a><span id="l17.1117" class="difflineplus">+ * constant, and wrapped with an accessor function. This wrapper function is</span>
<a href="#l17.1118"></a><span id="l17.1118" class="difflineplus">+ * stored in the equivalent internal (&lt;tt&gt;$&lt;/tt&gt;-prefixed) field. The return</span>
<a href="#l17.1119"></a><span id="l17.1119" class="difflineplus">+ * value of the property method (e.g., &lt;tt&gt;m.height&lt;/tt&gt;) is this mark.&lt;p&gt;</span>
<a href="#l17.1120"></a><span id="l17.1120" class="difflineplus">+ *</span>
<a href="#l17.1121"></a><span id="l17.1121" class="difflineplus">+ * &lt;li&gt;If invoked from an event handler, the property is set to the specified</span>
<a href="#l17.1122"></a><span id="l17.1122" class="difflineplus">+ * value on the current instance (i.e., the instance that triggered the event,</span>
<a href="#l17.1123"></a><span id="l17.1123" class="difflineplus">+ * such as a mouse click). In this case, the value should be a constant and not</span>
<a href="#l17.1124"></a><span id="l17.1124" class="difflineplus">+ * a function. The return value is this mark. For example, saying</span>
<a href="#l17.1125"></a><span id="l17.1125" class="difflineplus">+ *</span>
<a href="#l17.1126"></a><span id="l17.1126" class="difflineplus">+ * &lt;pre&gt;this.fillStyle(&quot;red&quot;).strokeStyle(&quot;black&quot;);&lt;/pre&gt;</span>
<a href="#l17.1127"></a><span id="l17.1127" class="difflineplus">+ *</span>
<a href="#l17.1128"></a><span id="l17.1128" class="difflineplus">+ * from a &quot;click&quot; event handler will set the fill color to red, and the stroke</span>
<a href="#l17.1129"></a><span id="l17.1129" class="difflineplus">+ * color to black, for any marks that are clicked.&lt;p&gt;</span>
<a href="#l17.1130"></a><span id="l17.1130" class="difflineplus">+ *</span>
<a href="#l17.1131"></a><span id="l17.1131" class="difflineplus">+ * &lt;li&gt;If invoked with no arguments, the computed property value for the current</span>
<a href="#l17.1132"></a><span id="l17.1132" class="difflineplus">+ * mark instance in the scene graph is returned. This facilitates &lt;i&gt;property</span>
<a href="#l17.1133"></a><span id="l17.1133" class="difflineplus">+ * chaining&lt;/i&gt;, where one mark's properties are defined in terms of another's.</span>
<a href="#l17.1134"></a><span id="l17.1134" class="difflineplus">+ * For example, to offset a mark's location from its prototype, you might say</span>
<a href="#l17.1135"></a><span id="l17.1135" class="difflineplus">+ *</span>
<a href="#l17.1136"></a><span id="l17.1136" class="difflineplus">+ * &lt;pre&gt;m.top(function() this.proto.top() + 10);&lt;/pre&gt;</span>
<a href="#l17.1137"></a><span id="l17.1137" class="difflineplus">+ *</span>
<a href="#l17.1138"></a><span id="l17.1138" class="difflineplus">+ * Note that the index of the mark being evaluated (in the above example,</span>
<a href="#l17.1139"></a><span id="l17.1139" class="difflineplus">+ * &lt;tt&gt;this.proto&lt;/tt&gt;) is inherited from the &lt;tt&gt;Mark&lt;/tt&gt; class and set by</span>
<a href="#l17.1140"></a><span id="l17.1140" class="difflineplus">+ * this mark. So, if the fifth element's top property is being evaluated, the</span>
<a href="#l17.1141"></a><span id="l17.1141" class="difflineplus">+ * fifth instance of &lt;tt&gt;this.proto&lt;/tt&gt; will similarly be queried for the value</span>
<a href="#l17.1142"></a><span id="l17.1142" class="difflineplus">+ * of its top property. If the mark being evaluated has a different number of</span>
<a href="#l17.1143"></a><span id="l17.1143" class="difflineplus">+ * instances, or its data is unrelated, the behavior of this method is</span>
<a href="#l17.1144"></a><span id="l17.1144" class="difflineplus">+ * undefined. In these cases it may be better to index the &lt;tt&gt;scene&lt;/tt&gt;</span>
<a href="#l17.1145"></a><span id="l17.1145" class="difflineplus">+ * explicitly to specify the exact instance.</span>
<a href="#l17.1146"></a><span id="l17.1146" class="difflineplus">+ *</span>
<a href="#l17.1147"></a><span id="l17.1147" class="difflineplus">+ * &lt;/ol&gt;&lt;p&gt;Property names should follow standard JavaScript method naming</span>
<a href="#l17.1148"></a><span id="l17.1148" class="difflineplus">+ * conventions, using lowerCamel-style capitalization.</span>
<a href="#l17.1149"></a><span id="l17.1149" class="difflineplus">+ *</span>
<a href="#l17.1150"></a><span id="l17.1150" class="difflineplus">+ * &lt;p&gt;In addition to creating the property method, every property is registered</span>
<a href="#l17.1151"></a><span id="l17.1151" class="difflineplus">+ * in the {@link #properties} array on the &lt;tt&gt;prototype&lt;/tt&gt;. Although this</span>
<a href="#l17.1152"></a><span id="l17.1152" class="difflineplus">+ * array is an instance field, it is considered immutable and shared by all</span>
<a href="#l17.1153"></a><span id="l17.1153" class="difflineplus">+ * instances of a given mark type. The &lt;tt&gt;properties&lt;/tt&gt; array can be queried</span>
<a href="#l17.1154"></a><span id="l17.1154" class="difflineplus">+ * to see if a mark type defines a particular property, such as width or height.</span>
<a href="#l17.1155"></a><span id="l17.1155" class="difflineplus">+ *</span>
<a href="#l17.1156"></a><span id="l17.1156" class="difflineplus">+ * @param {string} name the property name.</span>
<a href="#l17.1157"></a><span id="l17.1157" class="difflineplus">+ */</span>
<a href="#l17.1158"></a><span id="l17.1158" class="difflineplus">+pv.Mark.prototype.defineProperty = function(name) {</span>
<a href="#l17.1159"></a><span id="l17.1159" class="difflineplus">+  if (!this.hasOwnProperty(&quot;properties&quot;)) {</span>
<a href="#l17.1160"></a><span id="l17.1160" class="difflineplus">+    this.properties = (this.properties || []).concat();</span>
<a href="#l17.1161"></a><span id="l17.1161" class="difflineplus">+  }</span>
<a href="#l17.1162"></a><span id="l17.1162" class="difflineplus">+  this.properties.push(name);</span>
<a href="#l17.1163"></a><span id="l17.1163" class="difflineplus">+  this[name] = function(v) {</span>
<a href="#l17.1164"></a><span id="l17.1164" class="difflineplus">+      if (arguments.length) {</span>
<a href="#l17.1165"></a><span id="l17.1165" class="difflineplus">+        if (this.scene) {</span>
<a href="#l17.1166"></a><span id="l17.1166" class="difflineplus">+          this.scene[this.index][name] = v;</span>
<a href="#l17.1167"></a><span id="l17.1167" class="difflineplus">+        } else {</span>
<a href="#l17.1168"></a><span id="l17.1168" class="difflineplus">+          this[&quot;$&quot; + name] = (v instanceof Function) ? v : function() { return v; };</span>
<a href="#l17.1169"></a><span id="l17.1169" class="difflineplus">+        }</span>
<a href="#l17.1170"></a><span id="l17.1170" class="difflineplus">+        return this;</span>
<a href="#l17.1171"></a><span id="l17.1171" class="difflineplus">+      }</span>
<a href="#l17.1172"></a><span id="l17.1172" class="difflineplus">+      return this.scene[this.index][name];</span>
<a href="#l17.1173"></a><span id="l17.1173" class="difflineplus">+    };</span>
<a href="#l17.1174"></a><span id="l17.1174" class="difflineplus">+};</span>
<a href="#l17.1175"></a><span id="l17.1175" class="difflineplus">+</span>
<a href="#l17.1176"></a><span id="l17.1176" class="difflineplus">+/**</span>
<a href="#l17.1177"></a><span id="l17.1177" class="difflineplus">+ * The constructor; the mark type. This mark type may define default property</span>
<a href="#l17.1178"></a><span id="l17.1178" class="difflineplus">+ * functions (see {@link #defaults}) that are used if the property is not</span>
<a href="#l17.1179"></a><span id="l17.1179" class="difflineplus">+ * overriden by the mark or any of its prototypes.</span>
<a href="#l17.1180"></a><span id="l17.1180" class="difflineplus">+ *</span>
<a href="#l17.1181"></a><span id="l17.1181" class="difflineplus">+ * @type function</span>
<a href="#l17.1182"></a><span id="l17.1182" class="difflineplus">+ */</span>
<a href="#l17.1183"></a><span id="l17.1183" class="difflineplus">+pv.Mark.prototype.type = pv.Mark;</span>
<a href="#l17.1184"></a><span id="l17.1184" class="difflineplus">+</span>
<a href="#l17.1185"></a><span id="l17.1185" class="difflineplus">+/**</span>
<a href="#l17.1186"></a><span id="l17.1186" class="difflineplus">+ * The mark prototype, possibly null, from which to inherit property</span>
<a href="#l17.1187"></a><span id="l17.1187" class="difflineplus">+ * functions. The mark prototype is not necessarily of the same type as this</span>
<a href="#l17.1188"></a><span id="l17.1188" class="difflineplus">+ * mark. Any properties defined on this mark will override properties inherited</span>
<a href="#l17.1189"></a><span id="l17.1189" class="difflineplus">+ * either from the prototype or from the type-specific defaults.</span>
<a href="#l17.1190"></a><span id="l17.1190" class="difflineplus">+ *</span>
<a href="#l17.1191"></a><span id="l17.1191" class="difflineplus">+ * @type pv.Mark</span>
<a href="#l17.1192"></a><span id="l17.1192" class="difflineplus">+ */</span>
<a href="#l17.1193"></a><span id="l17.1193" class="difflineplus">+pv.Mark.prototype.proto = null;</span>
<a href="#l17.1194"></a><span id="l17.1194" class="difflineplus">+</span>
<a href="#l17.1195"></a><span id="l17.1195" class="difflineplus">+/**</span>
<a href="#l17.1196"></a><span id="l17.1196" class="difflineplus">+ * The enclosing parent panel. The parent panel is generally null only for the</span>
<a href="#l17.1197"></a><span id="l17.1197" class="difflineplus">+ * root panel; however, it is possible to create &quot;offscreen&quot; marks that are used</span>
<a href="#l17.1198"></a><span id="l17.1198" class="difflineplus">+ * only for inheritance purposes.</span>
<a href="#l17.1199"></a><span id="l17.1199" class="difflineplus">+ *</span>
<a href="#l17.1200"></a><span id="l17.1200" class="difflineplus">+ * @type pv.Panel</span>
<a href="#l17.1201"></a><span id="l17.1201" class="difflineplus">+ */</span>
<a href="#l17.1202"></a><span id="l17.1202" class="difflineplus">+pv.Mark.prototype.parent = null;</span>
<a href="#l17.1203"></a><span id="l17.1203" class="difflineplus">+</span>
<a href="#l17.1204"></a><span id="l17.1204" class="difflineplus">+/**</span>
<a href="#l17.1205"></a><span id="l17.1205" class="difflineplus">+ * The child index. -1 if the enclosing parent panel is null; otherwise, the</span>
<a href="#l17.1206"></a><span id="l17.1206" class="difflineplus">+ * zero-based index of this mark into the parent panel's &lt;tt&gt;children&lt;/tt&gt; array.</span>
<a href="#l17.1207"></a><span id="l17.1207" class="difflineplus">+ *</span>
<a href="#l17.1208"></a><span id="l17.1208" class="difflineplus">+ * @type number</span>
<a href="#l17.1209"></a><span id="l17.1209" class="difflineplus">+ */</span>
<a href="#l17.1210"></a><span id="l17.1210" class="difflineplus">+pv.Mark.prototype.childIndex = -1;</span>
<a href="#l17.1211"></a><span id="l17.1211" class="difflineplus">+</span>
<a href="#l17.1212"></a><span id="l17.1212" class="difflineplus">+/**</span>
<a href="#l17.1213"></a><span id="l17.1213" class="difflineplus">+ * The mark index. The value of this field depends on which instance (i.e.,</span>
<a href="#l17.1214"></a><span id="l17.1214" class="difflineplus">+ * which element of the data array) is currently being evaluated. During the</span>
<a href="#l17.1215"></a><span id="l17.1215" class="difflineplus">+ * build phase, the index is incremented over each datum; when handling events,</span>
<a href="#l17.1216"></a><span id="l17.1216" class="difflineplus">+ * the index is set to the instance that triggered the event.</span>
<a href="#l17.1217"></a><span id="l17.1217" class="difflineplus">+ *</span>
<a href="#l17.1218"></a><span id="l17.1218" class="difflineplus">+ * @type number</span>
<a href="#l17.1219"></a><span id="l17.1219" class="difflineplus">+ */</span>
<a href="#l17.1220"></a><span id="l17.1220" class="difflineplus">+pv.Mark.prototype.index = -1;</span>
<a href="#l17.1221"></a><span id="l17.1221" class="difflineplus">+</span>
<a href="#l17.1222"></a><span id="l17.1222" class="difflineplus">+/**</span>
<a href="#l17.1223"></a><span id="l17.1223" class="difflineplus">+ * The scene graph. The scene graph is an array of objects; each object (or</span>
<a href="#l17.1224"></a><span id="l17.1224" class="difflineplus">+ * &quot;node&quot;) corresponds to an instance of this mark and an element in the data</span>
<a href="#l17.1225"></a><span id="l17.1225" class="difflineplus">+ * array. The scene graph can be traversed to lookup previously-evaluated</span>
<a href="#l17.1226"></a><span id="l17.1226" class="difflineplus">+ * properties.</span>
<a href="#l17.1227"></a><span id="l17.1227" class="difflineplus">+ *</span>
<a href="#l17.1228"></a><span id="l17.1228" class="difflineplus">+ * &lt;p&gt;For instance, consider a stacked area chart. The bottom property of the</span>
<a href="#l17.1229"></a><span id="l17.1229" class="difflineplus">+ * area can be defined using the &lt;i&gt;cousin&lt;/i&gt; instance, which is the current</span>
<a href="#l17.1230"></a><span id="l17.1230" class="difflineplus">+ * area instance in the previous instantiation of the parent panel. In this</span>
<a href="#l17.1231"></a><span id="l17.1231" class="difflineplus">+ * sample code,</span>
<a href="#l17.1232"></a><span id="l17.1232" class="difflineplus">+ *</span>
<a href="#l17.1233"></a><span id="l17.1233" class="difflineplus">+ * &lt;pre&gt;new pv.Panel()</span>
<a href="#l17.1234"></a><span id="l17.1234" class="difflineplus">+ *     .width(150).height(150)</span>
<a href="#l17.1235"></a><span id="l17.1235" class="difflineplus">+ *   .add(pv.Panel)</span>
<a href="#l17.1236"></a><span id="l17.1236" class="difflineplus">+ *     .data([[1, 1.2, 1.7, 1.5, 1.7],</span>
<a href="#l17.1237"></a><span id="l17.1237" class="difflineplus">+ *            [.5, 1, .8, 1.1, 1.3],</span>
<a href="#l17.1238"></a><span id="l17.1238" class="difflineplus">+ *            [.2, .5, .8, .9, 1]])</span>
<a href="#l17.1239"></a><span id="l17.1239" class="difflineplus">+ *   .add(pv.Area)</span>
<a href="#l17.1240"></a><span id="l17.1240" class="difflineplus">+ *     .data(function(d) d)</span>
<a href="#l17.1241"></a><span id="l17.1241" class="difflineplus">+ *     .bottom(function() {</span>
<a href="#l17.1242"></a><span id="l17.1242" class="difflineplus">+ *         var c = this.cousin();</span>
<a href="#l17.1243"></a><span id="l17.1243" class="difflineplus">+ *         return c ? (c.bottom + c.height) : 0;</span>
<a href="#l17.1244"></a><span id="l17.1244" class="difflineplus">+ *       })</span>
<a href="#l17.1245"></a><span id="l17.1245" class="difflineplus">+ *     .height(function(d) d * 40)</span>
<a href="#l17.1246"></a><span id="l17.1246" class="difflineplus">+ *     .left(function() this.index * 35)</span>
<a href="#l17.1247"></a><span id="l17.1247" class="difflineplus">+ *   .root.render();&lt;/pre&gt;</span>
<a href="#l17.1248"></a><span id="l17.1248" class="difflineplus">+ *</span>
<a href="#l17.1249"></a><span id="l17.1249" class="difflineplus">+ * the bottom property is computed based on the upper edge of the corresponding</span>
<a href="#l17.1250"></a><span id="l17.1250" class="difflineplus">+ * datum in the previous series. The area's parent panel is instantiated once</span>
<a href="#l17.1251"></a><span id="l17.1251" class="difflineplus">+ * per series, so the cousin refers to the previous (below) area mark. (Note</span>
<a href="#l17.1252"></a><span id="l17.1252" class="difflineplus">+ * that the position of the upper edge is not the same as the top property,</span>
<a href="#l17.1253"></a><span id="l17.1253" class="difflineplus">+ * which refers to the top margin: the distance from the top edge of the panel</span>
<a href="#l17.1254"></a><span id="l17.1254" class="difflineplus">+ * to the top edge of the mark.)</span>
<a href="#l17.1255"></a><span id="l17.1255" class="difflineplus">+ *</span>
<a href="#l17.1256"></a><span id="l17.1256" class="difflineplus">+ * @see #first</span>
<a href="#l17.1257"></a><span id="l17.1257" class="difflineplus">+ * @see #last</span>
<a href="#l17.1258"></a><span id="l17.1258" class="difflineplus">+ * @see #sibling</span>
<a href="#l17.1259"></a><span id="l17.1259" class="difflineplus">+ * @see #cousin</span>
<a href="#l17.1260"></a><span id="l17.1260" class="difflineplus">+ */</span>
<a href="#l17.1261"></a><span id="l17.1261" class="difflineplus">+pv.Mark.prototype.scene = null;</span>
<a href="#l17.1262"></a><span id="l17.1262" class="difflineplus">+</span>
<a href="#l17.1263"></a><span id="l17.1263" class="difflineplus">+/**</span>
<a href="#l17.1264"></a><span id="l17.1264" class="difflineplus">+ * The root parent panel. This may be null for &quot;offscreen&quot; marks that are</span>
<a href="#l17.1265"></a><span id="l17.1265" class="difflineplus">+ * created for inheritance purposes only.</span>
<a href="#l17.1266"></a><span id="l17.1266" class="difflineplus">+ *</span>
<a href="#l17.1267"></a><span id="l17.1267" class="difflineplus">+ * @type pv.Panel</span>
<a href="#l17.1268"></a><span id="l17.1268" class="difflineplus">+ */</span>
<a href="#l17.1269"></a><span id="l17.1269" class="difflineplus">+pv.Mark.prototype.root = null;</span>
<a href="#l17.1270"></a><span id="l17.1270" class="difflineplus">+</span>
<a href="#l17.1271"></a><span id="l17.1271" class="difflineplus">+/**</span>
<a href="#l17.1272"></a><span id="l17.1272" class="difflineplus">+ * The data property; an array of objects. The size of the array determines the</span>
<a href="#l17.1273"></a><span id="l17.1273" class="difflineplus">+ * number of marks that will be instantiated; each element in the array will be</span>
<a href="#l17.1274"></a><span id="l17.1274" class="difflineplus">+ * passed to property functions to compute the property values. Typically, the</span>
<a href="#l17.1275"></a><span id="l17.1275" class="difflineplus">+ * data property is specified as a constant array, such as</span>
<a href="#l17.1276"></a><span id="l17.1276" class="difflineplus">+ *</span>
<a href="#l17.1277"></a><span id="l17.1277" class="difflineplus">+ * &lt;pre&gt;m.data([1, 2, 3, 4, 5]);&lt;/pre&gt;</span>
<a href="#l17.1278"></a><span id="l17.1278" class="difflineplus">+ *</span>
<a href="#l17.1279"></a><span id="l17.1279" class="difflineplus">+ * However, it is perfectly acceptable to define the data property as a</span>
<a href="#l17.1280"></a><span id="l17.1280" class="difflineplus">+ * function. This function might compute the data dynamically, allowing</span>
<a href="#l17.1281"></a><span id="l17.1281" class="difflineplus">+ * different data to be used per enclosing panel. For instance, in the stacked</span>
<a href="#l17.1282"></a><span id="l17.1282" class="difflineplus">+ * area graph example (see {@link #scene}), the data function on the area mark</span>
<a href="#l17.1283"></a><span id="l17.1283" class="difflineplus">+ * dereferences each series.</span>
<a href="#l17.1284"></a><span id="l17.1284" class="difflineplus">+ *</span>
<a href="#l17.1285"></a><span id="l17.1285" class="difflineplus">+ * @type array</span>
<a href="#l17.1286"></a><span id="l17.1286" class="difflineplus">+ * @name pv.Mark.prototype.data</span>
<a href="#l17.1287"></a><span id="l17.1287" class="difflineplus">+ */</span>
<a href="#l17.1288"></a><span id="l17.1288" class="difflineplus">+pv.Mark.prototype.defineProperty(&quot;data&quot;);</span>
<a href="#l17.1289"></a><span id="l17.1289" class="difflineplus">+</span>
<a href="#l17.1290"></a><span id="l17.1290" class="difflineplus">+/**</span>
<a href="#l17.1291"></a><span id="l17.1291" class="difflineplus">+ * The visible property; a boolean determining whether or not the mark instance</span>
<a href="#l17.1292"></a><span id="l17.1292" class="difflineplus">+ * is visible. If a mark instance is not visible, its other properties will not</span>
<a href="#l17.1293"></a><span id="l17.1293" class="difflineplus">+ * be evaluated. Similarly, for panels no child marks will be rendered.</span>
<a href="#l17.1294"></a><span id="l17.1294" class="difflineplus">+ *</span>
<a href="#l17.1295"></a><span id="l17.1295" class="difflineplus">+ * @type boolean</span>
<a href="#l17.1296"></a><span id="l17.1296" class="difflineplus">+ * @name pv.Mark.prototype.visible</span>
<a href="#l17.1297"></a><span id="l17.1297" class="difflineplus">+ */</span>
<a href="#l17.1298"></a><span id="l17.1298" class="difflineplus">+pv.Mark.prototype.defineProperty(&quot;visible&quot;);</span>
<a href="#l17.1299"></a><span id="l17.1299" class="difflineplus">+</span>
<a href="#l17.1300"></a><span id="l17.1300" class="difflineplus">+/**</span>
<a href="#l17.1301"></a><span id="l17.1301" class="difflineplus">+ * The left margin; the distance, in pixels, between the left edge of the</span>
<a href="#l17.1302"></a><span id="l17.1302" class="difflineplus">+ * enclosing panel and the left edge of this mark. Note that in some cases this</span>
<a href="#l17.1303"></a><span id="l17.1303" class="difflineplus">+ * property may be redundant with the right property, or with the conjunction of</span>
<a href="#l17.1304"></a><span id="l17.1304" class="difflineplus">+ * right and width.</span>
<a href="#l17.1305"></a><span id="l17.1305" class="difflineplus">+ *</span>
<a href="#l17.1306"></a><span id="l17.1306" class="difflineplus">+ * @type number</span>
<a href="#l17.1307"></a><span id="l17.1307" class="difflineplus">+ * @name pv.Mark.prototype.left</span>
<a href="#l17.1308"></a><span id="l17.1308" class="difflineplus">+ */</span>
<a href="#l17.1309"></a><span id="l17.1309" class="difflineplus">+pv.Mark.prototype.defineProperty(&quot;left&quot;);</span>
<a href="#l17.1310"></a><span id="l17.1310" class="difflineplus">+</span>
<a href="#l17.1311"></a><span id="l17.1311" class="difflineplus">+/**</span>
<a href="#l17.1312"></a><span id="l17.1312" class="difflineplus">+ * The right margin; the distance, in pixels, between the right edge of the</span>
<a href="#l17.1313"></a><span id="l17.1313" class="difflineplus">+ * enclosing panel and the right edge of this mark. Note that in some cases this</span>
<a href="#l17.1314"></a><span id="l17.1314" class="difflineplus">+ * property may be redundant with the left property, or with the conjunction of</span>
<a href="#l17.1315"></a><span id="l17.1315" class="difflineplus">+ * left and width.</span>
<a href="#l17.1316"></a><span id="l17.1316" class="difflineplus">+ *</span>
<a href="#l17.1317"></a><span id="l17.1317" class="difflineplus">+ * @type number</span>
<a href="#l17.1318"></a><span id="l17.1318" class="difflineplus">+ * @name pv.Mark.prototype.right</span>
<a href="#l17.1319"></a><span id="l17.1319" class="difflineplus">+ */</span>
<a href="#l17.1320"></a><span id="l17.1320" class="difflineplus">+pv.Mark.prototype.defineProperty(&quot;right&quot;);</span>
<a href="#l17.1321"></a><span id="l17.1321" class="difflineplus">+</span>
<a href="#l17.1322"></a><span id="l17.1322" class="difflineplus">+/**</span>
<a href="#l17.1323"></a><span id="l17.1323" class="difflineplus">+ * The top margin; the distance, in pixels, between the top edge of the</span>
<a href="#l17.1324"></a><span id="l17.1324" class="difflineplus">+ * enclosing panel and the top edge of this mark. Note that in some cases this</span>
<a href="#l17.1325"></a><span id="l17.1325" class="difflineplus">+ * property may be redundant with the bottom property, or with the conjunction</span>
<a href="#l17.1326"></a><span id="l17.1326" class="difflineplus">+ * of bottom and height.</span>
<a href="#l17.1327"></a><span id="l17.1327" class="difflineplus">+ *</span>
<a href="#l17.1328"></a><span id="l17.1328" class="difflineplus">+ * @type number</span>
<a href="#l17.1329"></a><span id="l17.1329" class="difflineplus">+ * @name pv.Mark.prototype.top</span>
<a href="#l17.1330"></a><span id="l17.1330" class="difflineplus">+ */</span>
<a href="#l17.1331"></a><span id="l17.1331" class="difflineplus">+pv.Mark.prototype.defineProperty(&quot;top&quot;);</span>
<a href="#l17.1332"></a><span id="l17.1332" class="difflineplus">+</span>
<a href="#l17.1333"></a><span id="l17.1333" class="difflineplus">+/**</span>
<a href="#l17.1334"></a><span id="l17.1334" class="difflineplus">+ * The bottom margin; the distance, in pixels, between the bottom edge of the</span>
<a href="#l17.1335"></a><span id="l17.1335" class="difflineplus">+ * enclosing panel and the bottom edge of this mark. Note that in some cases</span>
<a href="#l17.1336"></a><span id="l17.1336" class="difflineplus">+ * this property may be redundant with the top property, or with the conjunction</span>
<a href="#l17.1337"></a><span id="l17.1337" class="difflineplus">+ * of top and height.</span>
<a href="#l17.1338"></a><span id="l17.1338" class="difflineplus">+ *</span>
<a href="#l17.1339"></a><span id="l17.1339" class="difflineplus">+ * @type number</span>
<a href="#l17.1340"></a><span id="l17.1340" class="difflineplus">+ * @name pv.Mark.prototype.bottom</span>
<a href="#l17.1341"></a><span id="l17.1341" class="difflineplus">+ */</span>
<a href="#l17.1342"></a><span id="l17.1342" class="difflineplus">+pv.Mark.prototype.defineProperty(&quot;bottom&quot;);</span>
<a href="#l17.1343"></a><span id="l17.1343" class="difflineplus">+</span>
<a href="#l17.1344"></a><span id="l17.1344" class="difflineplus">+/**</span>
<a href="#l17.1345"></a><span id="l17.1345" class="difflineplus">+ * The cursor property; corresponds to the CSS cursor property. This is</span>
<a href="#l17.1346"></a><span id="l17.1346" class="difflineplus">+ * typically used in conjunction with event handlers to indicate interactivity.</span>
<a href="#l17.1347"></a><span id="l17.1347" class="difflineplus">+ *</span>
<a href="#l17.1348"></a><span id="l17.1348" class="difflineplus">+ * @type string</span>
<a href="#l17.1349"></a><span id="l17.1349" class="difflineplus">+ * @name pv.Mark.prototype.cursor</span>
<a href="#l17.1350"></a><span id="l17.1350" class="difflineplus">+ * @see &lt;a href=&quot;http://www.w3.org/TR/CSS2/ui.html#propdef-cursor&quot;&gt;CSS2 cursor&lt;/a&gt;.</span>
<a href="#l17.1351"></a><span id="l17.1351" class="difflineplus">+ */</span>
<a href="#l17.1352"></a><span id="l17.1352" class="difflineplus">+pv.Mark.prototype.defineProperty(&quot;cursor&quot;);</span>
<a href="#l17.1353"></a><span id="l17.1353" class="difflineplus">+</span>
<a href="#l17.1354"></a><span id="l17.1354" class="difflineplus">+/**</span>
<a href="#l17.1355"></a><span id="l17.1355" class="difflineplus">+ * The title property; corresponds to the HTML/SVG title property, allowing the</span>
<a href="#l17.1356"></a><span id="l17.1356" class="difflineplus">+ * general of simple plain text tooltips.</span>
<a href="#l17.1357"></a><span id="l17.1357" class="difflineplus">+ *</span>
<a href="#l17.1358"></a><span id="l17.1358" class="difflineplus">+ * @type string</span>
<a href="#l17.1359"></a><span id="l17.1359" class="difflineplus">+ * @name pv.Mark.prototype.title</span>
<a href="#l17.1360"></a><span id="l17.1360" class="difflineplus">+ */</span>
<a href="#l17.1361"></a><span id="l17.1361" class="difflineplus">+pv.Mark.prototype.defineProperty(&quot;title&quot;);</span>
<a href="#l17.1362"></a><span id="l17.1362" class="difflineplus">+</span>
<a href="#l17.1363"></a><span id="l17.1363" class="difflineplus">+/**</span>
<a href="#l17.1364"></a><span id="l17.1364" class="difflineplus">+ * Default properties for all mark types. By default, the data array is a single</span>
<a href="#l17.1365"></a><span id="l17.1365" class="difflineplus">+ * null element; if the data property is not specified, this causes each mark to</span>
<a href="#l17.1366"></a><span id="l17.1366" class="difflineplus">+ * be instantiated as a singleton. The visible property is true by default.</span>
<a href="#l17.1367"></a><span id="l17.1367" class="difflineplus">+ *</span>
<a href="#l17.1368"></a><span id="l17.1368" class="difflineplus">+ * @type pv.Mark</span>
<a href="#l17.1369"></a><span id="l17.1369" class="difflineplus">+ */</span>
<a href="#l17.1370"></a><span id="l17.1370" class="difflineplus">+pv.Mark.defaults = new pv.Mark()</span>
<a href="#l17.1371"></a><span id="l17.1371" class="difflineplus">+  .data([null])</span>
<a href="#l17.1372"></a><span id="l17.1372" class="difflineplus">+  .visible(true);</span>
<a href="#l17.1373"></a><span id="l17.1373" class="difflineplus">+</span>
<a href="#l17.1374"></a><span id="l17.1374" class="difflineplus">+/**</span>
<a href="#l17.1375"></a><span id="l17.1375" class="difflineplus">+ * Sets the prototype of this mark to the specified mark. Any properties not</span>
<a href="#l17.1376"></a><span id="l17.1376" class="difflineplus">+ * defined on this mark may be inherited from the specified prototype mark, or</span>
<a href="#l17.1377"></a><span id="l17.1377" class="difflineplus">+ * its prototype, and so on. The prototype mark need not be the same type of</span>
<a href="#l17.1378"></a><span id="l17.1378" class="difflineplus">+ * mark as this mark. (Note that for inheritance to be useful, properties with</span>
<a href="#l17.1379"></a><span id="l17.1379" class="difflineplus">+ * the same name on different mark types should have equivalent meaning.)</span>
<a href="#l17.1380"></a><span id="l17.1380" class="difflineplus">+ *</span>
<a href="#l17.1381"></a><span id="l17.1381" class="difflineplus">+ * @param {pv.Mark} proto the new prototype.</span>
<a href="#l17.1382"></a><span id="l17.1382" class="difflineplus">+ * @return {pv.Mark} this mark.</span>
<a href="#l17.1383"></a><span id="l17.1383" class="difflineplus">+ */</span>
<a href="#l17.1384"></a><span id="l17.1384" class="difflineplus">+pv.Mark.prototype.extend = function(proto) {</span>
<a href="#l17.1385"></a><span id="l17.1385" class="difflineplus">+  this.proto = proto;</span>
<a href="#l17.1386"></a><span id="l17.1386" class="difflineplus">+  return this;</span>
<a href="#l17.1387"></a><span id="l17.1387" class="difflineplus">+};</span>
<a href="#l17.1388"></a><span id="l17.1388" class="difflineplus">+</span>
<a href="#l17.1389"></a><span id="l17.1389" class="difflineplus">+/**</span>
<a href="#l17.1390"></a><span id="l17.1390" class="difflineplus">+ * Adds a new mark of the specified type to the enclosing parent panel, whilst</span>
<a href="#l17.1391"></a><span id="l17.1391" class="difflineplus">+ * simultaneously setting the prototype of the new mark to be this mark.</span>
<a href="#l17.1392"></a><span id="l17.1392" class="difflineplus">+ *</span>
<a href="#l17.1393"></a><span id="l17.1393" class="difflineplus">+ * @param {function} type the type of mark to add; a constructor, such as</span>
<a href="#l17.1394"></a><span id="l17.1394" class="difflineplus">+ * &lt;tt&gt;pv.Bar&lt;/tt&gt;.</span>
<a href="#l17.1395"></a><span id="l17.1395" class="difflineplus">+ * @return {pv.Mark} the new mark.</span>
<a href="#l17.1396"></a><span id="l17.1396" class="difflineplus">+ */</span>
<a href="#l17.1397"></a><span id="l17.1397" class="difflineplus">+pv.Mark.prototype.add = function(type) {</span>
<a href="#l17.1398"></a><span id="l17.1398" class="difflineplus">+  return this.parent.add(type).extend(this);</span>
<a href="#l17.1399"></a><span id="l17.1399" class="difflineplus">+};</span>
<a href="#l17.1400"></a><span id="l17.1400" class="difflineplus">+</span>
<a href="#l17.1401"></a><span id="l17.1401" class="difflineplus">+/**</span>
<a href="#l17.1402"></a><span id="l17.1402" class="difflineplus">+ * Constructs a new mark anchor with default properties.</span>
<a href="#l17.1403"></a><span id="l17.1403" class="difflineplus">+ *</span>
<a href="#l17.1404"></a><span id="l17.1404" class="difflineplus">+ * @class Represents an anchor on a given mark. An anchor is itself a mark, but</span>
<a href="#l17.1405"></a><span id="l17.1405" class="difflineplus">+ * without a visual representation. It serves only to provide useful default</span>
<a href="#l17.1406"></a><span id="l17.1406" class="difflineplus">+ * properties that can be inherited by other marks. Each type of mark can define</span>
<a href="#l17.1407"></a><span id="l17.1407" class="difflineplus">+ * any number of named anchors for convenience. If the concrete mark type does</span>
<a href="#l17.1408"></a><span id="l17.1408" class="difflineplus">+ * not define an anchor implementation specifically, one will be inherited from</span>
<a href="#l17.1409"></a><span id="l17.1409" class="difflineplus">+ * the mark's parent class.</span>
<a href="#l17.1410"></a><span id="l17.1410" class="difflineplus">+ *</span>
<a href="#l17.1411"></a><span id="l17.1411" class="difflineplus">+ * &lt;p&gt;For example, the bar mark provides anchors for its four sides: left,</span>
<a href="#l17.1412"></a><span id="l17.1412" class="difflineplus">+ * right, top and bottom. Adding a label to the top anchor of a bar,</span>
<a href="#l17.1413"></a><span id="l17.1413" class="difflineplus">+ *</span>
<a href="#l17.1414"></a><span id="l17.1414" class="difflineplus">+ * &lt;pre&gt;bar.anchor(&quot;top&quot;).add(pv.Label);&lt;/pre&gt;</span>
<a href="#l17.1415"></a><span id="l17.1415" class="difflineplus">+ *</span>
<a href="#l17.1416"></a><span id="l17.1416" class="difflineplus">+ * will render a text label on the top edge of the bar; the top anchor defines</span>
<a href="#l17.1417"></a><span id="l17.1417" class="difflineplus">+ * the appropriate position properties (top and left), as well as text-rendering</span>
<a href="#l17.1418"></a><span id="l17.1418" class="difflineplus">+ * properties for convenience (textAlign and textBaseline).</span>
<a href="#l17.1419"></a><span id="l17.1419" class="difflineplus">+ *</span>
<a href="#l17.1420"></a><span id="l17.1420" class="difflineplus">+ * @extends pv.Mark</span>
<a href="#l17.1421"></a><span id="l17.1421" class="difflineplus">+ */</span>
<a href="#l17.1422"></a><span id="l17.1422" class="difflineplus">+pv.Mark.Anchor = function() {</span>
<a href="#l17.1423"></a><span id="l17.1423" class="difflineplus">+  pv.Mark.call(this);</span>
<a href="#l17.1424"></a><span id="l17.1424" class="difflineplus">+};</span>
<a href="#l17.1425"></a><span id="l17.1425" class="difflineplus">+pv.Mark.Anchor.prototype = pv.extend(pv.Mark);</span>
<a href="#l17.1426"></a><span id="l17.1426" class="difflineplus">+</span>
<a href="#l17.1427"></a><span id="l17.1427" class="difflineplus">+/**</span>
<a href="#l17.1428"></a><span id="l17.1428" class="difflineplus">+ * The anchor name. The set of supported anchor names is dependent on the</span>
<a href="#l17.1429"></a><span id="l17.1429" class="difflineplus">+ * concrete mark type; see the mark type for details. For example, bars support</span>
<a href="#l17.1430"></a><span id="l17.1430" class="difflineplus">+ * left, right, top and bottom anchors.</span>
<a href="#l17.1431"></a><span id="l17.1431" class="difflineplus">+ *</span>
<a href="#l17.1432"></a><span id="l17.1432" class="difflineplus">+ * &lt;p&gt;While anchor names are typically constants, the anchor name is a true</span>
<a href="#l17.1433"></a><span id="l17.1433" class="difflineplus">+ * property, which means you can specify a function to compute the anchor name</span>
<a href="#l17.1434"></a><span id="l17.1434" class="difflineplus">+ * dynamically. For instance, if you wanted to alternate top and bottom anchors,</span>
<a href="#l17.1435"></a><span id="l17.1435" class="difflineplus">+ * saying</span>
<a href="#l17.1436"></a><span id="l17.1436" class="difflineplus">+ *</span>
<a href="#l17.1437"></a><span id="l17.1437" class="difflineplus">+ * &lt;pre&gt;m.anchor(function() (this.index % 2) ? &quot;top&quot; : &quot;bottom&quot;).add(pv.Dot);&lt;/pre&gt;</span>
<a href="#l17.1438"></a><span id="l17.1438" class="difflineplus">+ *</span>
<a href="#l17.1439"></a><span id="l17.1439" class="difflineplus">+ * would have the desired effect.</span>
<a href="#l17.1440"></a><span id="l17.1440" class="difflineplus">+ *</span>
<a href="#l17.1441"></a><span id="l17.1441" class="difflineplus">+ * @type string</span>
<a href="#l17.1442"></a><span id="l17.1442" class="difflineplus">+ * @name pv.Mark.Anchor.prototype.name</span>
<a href="#l17.1443"></a><span id="l17.1443" class="difflineplus">+ */</span>
<a href="#l17.1444"></a><span id="l17.1444" class="difflineplus">+pv.Mark.Anchor.prototype.defineProperty(&quot;name&quot;);</span>
<a href="#l17.1445"></a><span id="l17.1445" class="difflineplus">+</span>
<a href="#l17.1446"></a><span id="l17.1446" class="difflineplus">+/**</span>
<a href="#l17.1447"></a><span id="l17.1447" class="difflineplus">+ * Returns an anchor with the specified name. While anchor names are typically</span>
<a href="#l17.1448"></a><span id="l17.1448" class="difflineplus">+ * constants, the anchor name is a true property, which means you can specify a</span>
<a href="#l17.1449"></a><span id="l17.1449" class="difflineplus">+ * function to compute the anchor name dynamically. See the</span>
<a href="#l17.1450"></a><span id="l17.1450" class="difflineplus">+ * {@link pv.Mark.Anchor#name} property for details.</span>
<a href="#l17.1451"></a><span id="l17.1451" class="difflineplus">+ *</span>
<a href="#l17.1452"></a><span id="l17.1452" class="difflineplus">+ * @param {string} name the anchor name; either a string or a property function.</span>
<a href="#l17.1453"></a><span id="l17.1453" class="difflineplus">+ * @returns {pv.Mark.Anchor} the new anchor.</span>
<a href="#l17.1454"></a><span id="l17.1454" class="difflineplus">+ */</span>
<a href="#l17.1455"></a><span id="l17.1455" class="difflineplus">+pv.Mark.prototype.anchor = function(name) {</span>
<a href="#l17.1456"></a><span id="l17.1456" class="difflineplus">+  var anchorType = this.type;</span>
<a href="#l17.1457"></a><span id="l17.1457" class="difflineplus">+  while (!anchorType.Anchor) {</span>
<a href="#l17.1458"></a><span id="l17.1458" class="difflineplus">+    anchorType = anchorType.defaults.proto.type;</span>
<a href="#l17.1459"></a><span id="l17.1459" class="difflineplus">+  }</span>
<a href="#l17.1460"></a><span id="l17.1460" class="difflineplus">+  var anchor = new anchorType.Anchor().extend(this).name(name);</span>
<a href="#l17.1461"></a><span id="l17.1461" class="difflineplus">+  anchor.parent = this.parent;</span>
<a href="#l17.1462"></a><span id="l17.1462" class="difflineplus">+  anchor.type = this.type;</span>
<a href="#l17.1463"></a><span id="l17.1463" class="difflineplus">+  return anchor;</span>
<a href="#l17.1464"></a><span id="l17.1464" class="difflineplus">+};</span>
<a href="#l17.1465"></a><span id="l17.1465" class="difflineplus">+</span>
<a href="#l17.1466"></a><span id="l17.1466" class="difflineplus">+/**</span>
<a href="#l17.1467"></a><span id="l17.1467" class="difflineplus">+ * Returns the anchor target of this mark, if it is derived from an anchor;</span>
<a href="#l17.1468"></a><span id="l17.1468" class="difflineplus">+ * otherwise returns null. For example, if a label is derived from a bar anchor,</span>
<a href="#l17.1469"></a><span id="l17.1469" class="difflineplus">+ *</span>
<a href="#l17.1470"></a><span id="l17.1470" class="difflineplus">+ * &lt;pre&gt;bar.anchor(&quot;top&quot;).add(pv.Label);&lt;/pre&gt;</span>
<a href="#l17.1471"></a><span id="l17.1471" class="difflineplus">+ *</span>
<a href="#l17.1472"></a><span id="l17.1472" class="difflineplus">+ * then property functions on the label can refer to the bar via the</span>
<a href="#l17.1473"></a><span id="l17.1473" class="difflineplus">+ * &lt;tt&gt;anchorTarget&lt;/tt&gt; method. This method is also useful for mark types</span>
<a href="#l17.1474"></a><span id="l17.1474" class="difflineplus">+ * defining properties on custom anchors.</span>
<a href="#l17.1475"></a><span id="l17.1475" class="difflineplus">+ *</span>
<a href="#l17.1476"></a><span id="l17.1476" class="difflineplus">+ * @returns {pv.Mark} the anchor target of this mark; possibly null.</span>
<a href="#l17.1477"></a><span id="l17.1477" class="difflineplus">+ */</span>
<a href="#l17.1478"></a><span id="l17.1478" class="difflineplus">+pv.Mark.prototype.anchorTarget = function() {</span>
<a href="#l17.1479"></a><span id="l17.1479" class="difflineplus">+  var target = this;</span>
<a href="#l17.1480"></a><span id="l17.1480" class="difflineplus">+  while (!(target instanceof pv.Mark.Anchor)) {</span>
<a href="#l17.1481"></a><span id="l17.1481" class="difflineplus">+    target = target.proto;</span>
<a href="#l17.1482"></a><span id="l17.1482" class="difflineplus">+    if (!target) return null;</span>
<a href="#l17.1483"></a><span id="l17.1483" class="difflineplus">+  }</span>
<a href="#l17.1484"></a><span id="l17.1484" class="difflineplus">+  return target.proto;</span>
<a href="#l17.1485"></a><span id="l17.1485" class="difflineplus">+};</span>
<a href="#l17.1486"></a><span id="l17.1486" class="difflineplus">+</span>
<a href="#l17.1487"></a><span id="l17.1487" class="difflineplus">+/**</span>
<a href="#l17.1488"></a><span id="l17.1488" class="difflineplus">+ * Returns the first instance of this mark in the scene graph. This method can</span>
<a href="#l17.1489"></a><span id="l17.1489" class="difflineplus">+ * only be called when the mark is bound to the scene graph (for example, from</span>
<a href="#l17.1490"></a><span id="l17.1490" class="difflineplus">+ * an event handler, or within a property function).</span>
<a href="#l17.1491"></a><span id="l17.1491" class="difflineplus">+ *</span>
<a href="#l17.1492"></a><span id="l17.1492" class="difflineplus">+ * @returns a node in the scene graph.</span>
<a href="#l17.1493"></a><span id="l17.1493" class="difflineplus">+ */</span>
<a href="#l17.1494"></a><span id="l17.1494" class="difflineplus">+pv.Mark.prototype.first = function() {</span>
<a href="#l17.1495"></a><span id="l17.1495" class="difflineplus">+  return this.scene[0];</span>
<a href="#l17.1496"></a><span id="l17.1496" class="difflineplus">+};</span>
<a href="#l17.1497"></a><span id="l17.1497" class="difflineplus">+</span>
<a href="#l17.1498"></a><span id="l17.1498" class="difflineplus">+/**</span>
<a href="#l17.1499"></a><span id="l17.1499" class="difflineplus">+ * Returns the last instance of this mark in the scene graph. This method can</span>
<a href="#l17.1500"></a><span id="l17.1500" class="difflineplus">+ * only be called when the mark is bound to the scene graph (for example, from</span>
<a href="#l17.1501"></a><span id="l17.1501" class="difflineplus">+ * an event handler, or within a property function). In addition, note that mark</span>
<a href="#l17.1502"></a><span id="l17.1502" class="difflineplus">+ * instances are built sequentially, so the last instance of this mark may not</span>
<a href="#l17.1503"></a><span id="l17.1503" class="difflineplus">+ * yet be constructed.</span>
<a href="#l17.1504"></a><span id="l17.1504" class="difflineplus">+ *</span>
<a href="#l17.1505"></a><span id="l17.1505" class="difflineplus">+ * @returns a node in the scene graph.</span>
<a href="#l17.1506"></a><span id="l17.1506" class="difflineplus">+ */</span>
<a href="#l17.1507"></a><span id="l17.1507" class="difflineplus">+pv.Mark.prototype.last = function() {</span>
<a href="#l17.1508"></a><span id="l17.1508" class="difflineplus">+  return this.scene[this.scene.length - 1];</span>
<a href="#l17.1509"></a><span id="l17.1509" class="difflineplus">+};</span>
<a href="#l17.1510"></a><span id="l17.1510" class="difflineplus">+</span>
<a href="#l17.1511"></a><span id="l17.1511" class="difflineplus">+/**</span>
<a href="#l17.1512"></a><span id="l17.1512" class="difflineplus">+ * Returns the previous instance of this mark in the scene graph, or null if</span>
<a href="#l17.1513"></a><span id="l17.1513" class="difflineplus">+ * this is the first instance.</span>
<a href="#l17.1514"></a><span id="l17.1514" class="difflineplus">+ *</span>
<a href="#l17.1515"></a><span id="l17.1515" class="difflineplus">+ * @returns a node in the scene graph, or null.</span>
<a href="#l17.1516"></a><span id="l17.1516" class="difflineplus">+ */</span>
<a href="#l17.1517"></a><span id="l17.1517" class="difflineplus">+pv.Mark.prototype.sibling = function() {</span>
<a href="#l17.1518"></a><span id="l17.1518" class="difflineplus">+  return (this.index == 0) ? null : this.scene[this.index - 1];</span>
<a href="#l17.1519"></a><span id="l17.1519" class="difflineplus">+};</span>
<a href="#l17.1520"></a><span id="l17.1520" class="difflineplus">+</span>
<a href="#l17.1521"></a><span id="l17.1521" class="difflineplus">+/**</span>
<a href="#l17.1522"></a><span id="l17.1522" class="difflineplus">+ * Returns the current instance in the scene graph of this mark, in the previous</span>
<a href="#l17.1523"></a><span id="l17.1523" class="difflineplus">+ * instance of the enclsoing parent panel. May return null if this instance</span>
<a href="#l17.1524"></a><span id="l17.1524" class="difflineplus">+ * could not be found.</span>
<a href="#l17.1525"></a><span id="l17.1525" class="difflineplus">+ *</span>
<a href="#l17.1526"></a><span id="l17.1526" class="difflineplus">+ * @returns a node in the scene graph, or null.</span>
<a href="#l17.1527"></a><span id="l17.1527" class="difflineplus">+ */</span>
<a href="#l17.1528"></a><span id="l17.1528" class="difflineplus">+pv.Mark.prototype.cousin = function() {</span>
<a href="#l17.1529"></a><span id="l17.1529" class="difflineplus">+  var p = this.parent, s = p &amp;&amp; p.sibling();</span>
<a href="#l17.1530"></a><span id="l17.1530" class="difflineplus">+  return (s &amp;&amp; s.children) ? s.children[this.childIndex][this.index] : null;</span>
<a href="#l17.1531"></a><span id="l17.1531" class="difflineplus">+};</span>
<a href="#l17.1532"></a><span id="l17.1532" class="difflineplus">+</span>
<a href="#l17.1533"></a><span id="l17.1533" class="difflineplus">+/**</span>
<a href="#l17.1534"></a><span id="l17.1534" class="difflineplus">+ * Renders this mark, including recursively rendering all child marks if this is</span>
<a href="#l17.1535"></a><span id="l17.1535" class="difflineplus">+ * a panel. Rendering consists of two phases: &lt;b&gt;build&lt;/b&gt; and &lt;b&gt;update&lt;/b&gt;. In</span>
<a href="#l17.1536"></a><span id="l17.1536" class="difflineplus">+ * the future, the update phase could conceivably be decoupled to allow</span>
<a href="#l17.1537"></a><span id="l17.1537" class="difflineplus">+ * different rendering engines. Similarly, future work is needed to allow</span>
<a href="#l17.1538"></a><span id="l17.1538" class="difflineplus">+ * dynamic rebuilding based on interaction. (For example, dynamic expansion of a</span>
<a href="#l17.1539"></a><span id="l17.1539" class="difflineplus">+ * tree visualization.)</span>
<a href="#l17.1540"></a><span id="l17.1540" class="difflineplus">+ *</span>
<a href="#l17.1541"></a><span id="l17.1541" class="difflineplus">+ * &lt;p&gt;In the build phase (see {@link #build}), all properties are evaluated, and</span>
<a href="#l17.1542"></a><span id="l17.1542" class="difflineplus">+ * the scene graph is generated. However, nothing is rendered.</span>
<a href="#l17.1543"></a><span id="l17.1543" class="difflineplus">+ *</span>
<a href="#l17.1544"></a><span id="l17.1544" class="difflineplus">+ * &lt;p&gt;In the update phase (see {@link #update}), the mark is rendered by</span>
<a href="#l17.1545"></a><span id="l17.1545" class="difflineplus">+ * creating and updating elements and attributes in the SVG image. No properties</span>
<a href="#l17.1546"></a><span id="l17.1546" class="difflineplus">+ * are evaluated during the update phase; instead the values computed previously</span>
<a href="#l17.1547"></a><span id="l17.1547" class="difflineplus">+ * in the build phase are simply translated into SVG.</span>
<a href="#l17.1548"></a><span id="l17.1548" class="difflineplus">+ */</span>
<a href="#l17.1549"></a><span id="l17.1549" class="difflineplus">+pv.Mark.prototype.render = function() {</span>
<a href="#l17.1550"></a><span id="l17.1550" class="difflineplus">+  this.build();</span>
<a href="#l17.1551"></a><span id="l17.1551" class="difflineplus">+  this.update();</span>
<a href="#l17.1552"></a><span id="l17.1552" class="difflineplus">+};</span>
<a href="#l17.1553"></a><span id="l17.1553" class="difflineplus">+</span>
<a href="#l17.1554"></a><span id="l17.1554" class="difflineplus">+/**</span>
<a href="#l17.1555"></a><span id="l17.1555" class="difflineplus">+ * Evaluates properties and computes implied properties. Properties are stored</span>
<a href="#l17.1556"></a><span id="l17.1556" class="difflineplus">+ * in the {@link #scene} array for each instance of this mark.</span>
<a href="#l17.1557"></a><span id="l17.1557" class="difflineplus">+ *</span>
<a href="#l17.1558"></a><span id="l17.1558" class="difflineplus">+ * &lt;p&gt;As marks are built recursively, the {@link #index} property is updated to</span>
<a href="#l17.1559"></a><span id="l17.1559" class="difflineplus">+ * match the current index into the data array for each mark. Note that the</span>
<a href="#l17.1560"></a><span id="l17.1560" class="difflineplus">+ * index property is only set for the mark currently being built and its</span>
<a href="#l17.1561"></a><span id="l17.1561" class="difflineplus">+ * enclosing parent panels. The index property for other marks is unset, but is</span>
<a href="#l17.1562"></a><span id="l17.1562" class="difflineplus">+ * inherited from the global &lt;tt&gt;Mark&lt;/tt&gt; class prototype. This allows mark</span>
<a href="#l17.1563"></a><span id="l17.1563" class="difflineplus">+ * properties to refer to properties on other marks &lt;i&gt;in the same panel&lt;/i&gt;</span>
<a href="#l17.1564"></a><span id="l17.1564" class="difflineplus">+ * conveniently; however, in general it is better to reference mark instances</span>
<a href="#l17.1565"></a><span id="l17.1565" class="difflineplus">+ * specifically through the scene graph rather than depending on the magical</span>
<a href="#l17.1566"></a><span id="l17.1566" class="difflineplus">+ * behavior of {@link #index}.</span>
<a href="#l17.1567"></a><span id="l17.1567" class="difflineplus">+ *</span>
<a href="#l17.1568"></a><span id="l17.1568" class="difflineplus">+ * &lt;p&gt;The root scene array has a special property, &lt;tt&gt;data&lt;/tt&gt;, which stores</span>
<a href="#l17.1569"></a><span id="l17.1569" class="difflineplus">+ * the current data stack. The first element in this stack is the current datum,</span>
<a href="#l17.1570"></a><span id="l17.1570" class="difflineplus">+ * followed by the datum of the enclosing parent panel, and so on. The data</span>
<a href="#l17.1571"></a><span id="l17.1571" class="difflineplus">+ * stack should not be accessed directly; instead, property functions are passed</span>
<a href="#l17.1572"></a><span id="l17.1572" class="difflineplus">+ * the current data stack as arguments.</span>
<a href="#l17.1573"></a><span id="l17.1573" class="difflineplus">+ *</span>
<a href="#l17.1574"></a><span id="l17.1574" class="difflineplus">+ * &lt;p&gt;The evaluation of the &lt;tt&gt;data&lt;/tt&gt; and &lt;tt&gt;visible&lt;/tt&gt; properties is</span>
<a href="#l17.1575"></a><span id="l17.1575" class="difflineplus">+ * special. The &lt;tt&gt;data&lt;/tt&gt; property is evaluated first; unlike the other</span>
<a href="#l17.1576"></a><span id="l17.1576" class="difflineplus">+ * properties, the data stack is from the parent panel, rather than the current</span>
<a href="#l17.1577"></a><span id="l17.1577" class="difflineplus">+ * mark, since the data is not defined until the data property is evaluated.</span>
<a href="#l17.1578"></a><span id="l17.1578" class="difflineplus">+ * The &lt;tt&gt;visisble&lt;/tt&gt; property is subsequently evaluated for each instance;</span>
<a href="#l17.1579"></a><span id="l17.1579" class="difflineplus">+ * only if true will the {@link #buildInstance} method be called, evaluating</span>
<a href="#l17.1580"></a><span id="l17.1580" class="difflineplus">+ * other properties and recursively building the scene graph.</span>
<a href="#l17.1581"></a><span id="l17.1581" class="difflineplus">+ *</span>
<a href="#l17.1582"></a><span id="l17.1582" class="difflineplus">+ * &lt;p&gt;If this mark is being re-built, any old instances of this mark that no</span>
<a href="#l17.1583"></a><span id="l17.1583" class="difflineplus">+ * longer exist (because the new data array contains fewer elements) will be</span>
<a href="#l17.1584"></a><span id="l17.1584" class="difflineplus">+ * cleared using {@link #clearInstance}.</span>
<a href="#l17.1585"></a><span id="l17.1585" class="difflineplus">+ *</span>
<a href="#l17.1586"></a><span id="l17.1586" class="difflineplus">+ * @param parent the instance of the parent panel from the scene graph.</span>
<a href="#l17.1587"></a><span id="l17.1587" class="difflineplus">+ */</span>
<a href="#l17.1588"></a><span id="l17.1588" class="difflineplus">+pv.Mark.prototype.build = function(parent) {</span>
<a href="#l17.1589"></a><span id="l17.1589" class="difflineplus">+  if (!this.scene) {</span>
<a href="#l17.1590"></a><span id="l17.1590" class="difflineplus">+    this.scene = [];</span>
<a href="#l17.1591"></a><span id="l17.1591" class="difflineplus">+    if (!this.parent) {</span>
<a href="#l17.1592"></a><span id="l17.1592" class="difflineplus">+      this.scene.data = [];</span>
<a href="#l17.1593"></a><span id="l17.1593" class="difflineplus">+    }</span>
<a href="#l17.1594"></a><span id="l17.1594" class="difflineplus">+  }</span>
<a href="#l17.1595"></a><span id="l17.1595" class="difflineplus">+</span>
<a href="#l17.1596"></a><span id="l17.1596" class="difflineplus">+  var data = this.get(&quot;data&quot;);</span>
<a href="#l17.1597"></a><span id="l17.1597" class="difflineplus">+  var stack = this.root.scene.data;</span>
<a href="#l17.1598"></a><span id="l17.1598" class="difflineplus">+  stack.unshift(null);</span>
<a href="#l17.1599"></a><span id="l17.1599" class="difflineplus">+  this.index = -1;</span>
<a href="#l17.1600"></a><span id="l17.1600" class="difflineplus">+</span>
<a href="#l17.1601"></a><span id="l17.1601" class="difflineplus">+  this.$$data = data; // XXX</span>
<a href="#l17.1602"></a><span id="l17.1602" class="difflineplus">+</span>
<a href="#l17.1603"></a><span id="l17.1603" class="difflineplus">+  for (var i = 0, d; i &lt; data.length; i++) {</span>
<a href="#l17.1604"></a><span id="l17.1604" class="difflineplus">+    pv.Mark.prototype.index = ++this.index;</span>
<a href="#l17.1605"></a><span id="l17.1605" class="difflineplus">+    var s = {};</span>
<a href="#l17.1606"></a><span id="l17.1606" class="difflineplus">+</span>
<a href="#l17.1607"></a><span id="l17.1607" class="difflineplus">+    /*</span>
<a href="#l17.1608"></a><span id="l17.1608" class="difflineplus">+     * This is a bit confusing and could be cleaned up. This &quot;scene&quot; stores the</span>
<a href="#l17.1609"></a><span id="l17.1609" class="difflineplus">+     * previous scene graph; we want to reuse SVG elements that were created</span>
<a href="#l17.1610"></a><span id="l17.1610" class="difflineplus">+     * previously rather than recreating them, so we extract them. We also want</span>
<a href="#l17.1611"></a><span id="l17.1611" class="difflineplus">+     * to reuse SVG child elements as well.</span>
<a href="#l17.1612"></a><span id="l17.1612" class="difflineplus">+     */</span>
<a href="#l17.1613"></a><span id="l17.1613" class="difflineplus">+    if (this.scene[this.index]) {</span>
<a href="#l17.1614"></a><span id="l17.1614" class="difflineplus">+      s.svg = this.scene[this.index].svg;</span>
<a href="#l17.1615"></a><span id="l17.1615" class="difflineplus">+      s.children = this.scene[this.index].children;</span>
<a href="#l17.1616"></a><span id="l17.1616" class="difflineplus">+    }</span>
<a href="#l17.1617"></a><span id="l17.1617" class="difflineplus">+    this.scene[this.index] = s;</span>
<a href="#l17.1618"></a><span id="l17.1618" class="difflineplus">+</span>
<a href="#l17.1619"></a><span id="l17.1619" class="difflineplus">+    s.index = i;</span>
<a href="#l17.1620"></a><span id="l17.1620" class="difflineplus">+    s.data = stack[0] = data[i];</span>
<a href="#l17.1621"></a><span id="l17.1621" class="difflineplus">+    s.parent = parent;</span>
<a href="#l17.1622"></a><span id="l17.1622" class="difflineplus">+    s.visible = this.get(&quot;visible&quot;);</span>
<a href="#l17.1623"></a><span id="l17.1623" class="difflineplus">+    if (s.visible) {</span>
<a href="#l17.1624"></a><span id="l17.1624" class="difflineplus">+      this.buildInstance(s);</span>
<a href="#l17.1625"></a><span id="l17.1625" class="difflineplus">+    }</span>
<a href="#l17.1626"></a><span id="l17.1626" class="difflineplus">+  }</span>
<a href="#l17.1627"></a><span id="l17.1627" class="difflineplus">+  stack.shift();</span>
<a href="#l17.1628"></a><span id="l17.1628" class="difflineplus">+  delete this.index;</span>
<a href="#l17.1629"></a><span id="l17.1629" class="difflineplus">+  pv.Mark.prototype.index = -1;</span>
<a href="#l17.1630"></a><span id="l17.1630" class="difflineplus">+</span>
<a href="#l17.1631"></a><span id="l17.1631" class="difflineplus">+  /* Clear any old instances from the scene. */</span>
<a href="#l17.1632"></a><span id="l17.1632" class="difflineplus">+  for (var i = data.length; i &lt; this.scene.length; i++) {</span>
<a href="#l17.1633"></a><span id="l17.1633" class="difflineplus">+    this.clearInstance(this.scene[i]);</span>
<a href="#l17.1634"></a><span id="l17.1634" class="difflineplus">+  }</span>
<a href="#l17.1635"></a><span id="l17.1635" class="difflineplus">+  this.scene.length = data.length;</span>
<a href="#l17.1636"></a><span id="l17.1636" class="difflineplus">+</span>
<a href="#l17.1637"></a><span id="l17.1637" class="difflineplus">+  return this;</span>
<a href="#l17.1638"></a><span id="l17.1638" class="difflineplus">+};</span>
<a href="#l17.1639"></a><span id="l17.1639" class="difflineplus">+</span>
<a href="#l17.1640"></a><span id="l17.1640" class="difflineplus">+/**</span>
<a href="#l17.1641"></a><span id="l17.1641" class="difflineplus">+ * Removes the specified mark instance from the SVG image. This method depends</span>
<a href="#l17.1642"></a><span id="l17.1642" class="difflineplus">+ * on the &lt;tt&gt;svg&lt;/tt&gt; property of the scene graph node. If the specified mark</span>
<a href="#l17.1643"></a><span id="l17.1643" class="difflineplus">+ * instance was not present in the SVG image (for example, because it was not</span>
<a href="#l17.1644"></a><span id="l17.1644" class="difflineplus">+ * visible), this method has no effect.</span>
<a href="#l17.1645"></a><span id="l17.1645" class="difflineplus">+ *</span>
<a href="#l17.1646"></a><span id="l17.1646" class="difflineplus">+ * @param s a node in the scene graph; the instance of the mark to clear.</span>
<a href="#l17.1647"></a><span id="l17.1647" class="difflineplus">+ */</span>
<a href="#l17.1648"></a><span id="l17.1648" class="difflineplus">+pv.Mark.prototype.clearInstance = function(s) {</span>
<a href="#l17.1649"></a><span id="l17.1649" class="difflineplus">+  if (s.svg) {</span>
<a href="#l17.1650"></a><span id="l17.1650" class="difflineplus">+    s.parent.svg.removeChild(s.svg);</span>
<a href="#l17.1651"></a><span id="l17.1651" class="difflineplus">+  }</span>
<a href="#l17.1652"></a><span id="l17.1652" class="difflineplus">+};</span>
<a href="#l17.1653"></a><span id="l17.1653" class="difflineplus">+</span>
<a href="#l17.1654"></a><span id="l17.1654" class="difflineplus">+/**</span>
<a href="#l17.1655"></a><span id="l17.1655" class="difflineplus">+ * Evaluates all of the properties for this mark for the specified instance</span>
<a href="#l17.1656"></a><span id="l17.1656" class="difflineplus">+ * &lt;tt&gt;s&lt;/tt&gt; in the scene graph. The set of properties to evaluate is retrieved</span>
<a href="#l17.1657"></a><span id="l17.1657" class="difflineplus">+ * from the {@link #properties} array for this mark type (see {@link #type}).</span>
<a href="#l17.1658"></a><span id="l17.1658" class="difflineplus">+ * After these properties are evaluated, any &lt;b&gt;implied&lt;/b&gt; properties may be</span>
<a href="#l17.1659"></a><span id="l17.1659" class="difflineplus">+ * computed by the mark and set on the scene graph; see {@link #buildImplied}.</span>
<a href="#l17.1660"></a><span id="l17.1660" class="difflineplus">+ *</span>
<a href="#l17.1661"></a><span id="l17.1661" class="difflineplus">+ * &lt;p&gt;For panels, this method recursively builds the scene graph for all child</span>
<a href="#l17.1662"></a><span id="l17.1662" class="difflineplus">+ * marks as well. In general, this method should not need to be overridden by</span>
<a href="#l17.1663"></a><span id="l17.1663" class="difflineplus">+ * concrete mark types.</span>
<a href="#l17.1664"></a><span id="l17.1664" class="difflineplus">+ *</span>
<a href="#l17.1665"></a><span id="l17.1665" class="difflineplus">+ * @param s a node in the scene graph; the instance of the mark to build.</span>
<a href="#l17.1666"></a><span id="l17.1666" class="difflineplus">+ */</span>
<a href="#l17.1667"></a><span id="l17.1667" class="difflineplus">+pv.Mark.prototype.buildInstance = function(s) {</span>
<a href="#l17.1668"></a><span id="l17.1668" class="difflineplus">+  var p = this.type.prototype;</span>
<a href="#l17.1669"></a><span id="l17.1669" class="difflineplus">+  for (var i = 0; i &lt; p.properties.length; i++) {</span>
<a href="#l17.1670"></a><span id="l17.1670" class="difflineplus">+    var name = p.properties[i];</span>
<a href="#l17.1671"></a><span id="l17.1671" class="difflineplus">+    if (!(name in s)) {</span>
<a href="#l17.1672"></a><span id="l17.1672" class="difflineplus">+      s[name] = this.get(name);</span>
<a href="#l17.1673"></a><span id="l17.1673" class="difflineplus">+    }</span>
<a href="#l17.1674"></a><span id="l17.1674" class="difflineplus">+  }</span>
<a href="#l17.1675"></a><span id="l17.1675" class="difflineplus">+  this.buildImplied(s);</span>
<a href="#l17.1676"></a><span id="l17.1676" class="difflineplus">+};</span>
<a href="#l17.1677"></a><span id="l17.1677" class="difflineplus">+</span>
<a href="#l17.1678"></a><span id="l17.1678" class="difflineplus">+/**</span>
<a href="#l17.1679"></a><span id="l17.1679" class="difflineplus">+ * Computes the implied properties for this mark for the specified instance</span>
<a href="#l17.1680"></a><span id="l17.1680" class="difflineplus">+ * &lt;tt&gt;s&lt;/tt&gt; in the scene graph. Implied properties are those with dependencies</span>
<a href="#l17.1681"></a><span id="l17.1681" class="difflineplus">+ * on multiple other properties; for example, the width property may be implied</span>
<a href="#l17.1682"></a><span id="l17.1682" class="difflineplus">+ * if the left and right properties are set. This method can be overridden by</span>
<a href="#l17.1683"></a><span id="l17.1683" class="difflineplus">+ * concrete mark types to define new implied properties, if necessary.</span>
<a href="#l17.1684"></a><span id="l17.1684" class="difflineplus">+ *</span>
<a href="#l17.1685"></a><span id="l17.1685" class="difflineplus">+ * &lt;p&gt;The default implementation computes the implied CSS box model properties.</span>
<a href="#l17.1686"></a><span id="l17.1686" class="difflineplus">+ * The prioritization of redundant properties is as follows:&lt;ol&gt;</span>
<a href="#l17.1687"></a><span id="l17.1687" class="difflineplus">+ *</span>
<a href="#l17.1688"></a><span id="l17.1688" class="difflineplus">+ * &lt;li&gt;If the &lt;tt&gt;width&lt;/tt&gt; property is not specified (i.e., null), its value is</span>
<a href="#l17.1689"></a><span id="l17.1689" class="difflineplus">+ * the width of the parent panel, minus this mark's left and right margins; the</span>
<a href="#l17.1690"></a><span id="l17.1690" class="difflineplus">+ * left and right margins are zero if not specified.</span>
<a href="#l17.1691"></a><span id="l17.1691" class="difflineplus">+ *</span>
<a href="#l17.1692"></a><span id="l17.1692" class="difflineplus">+ * &lt;li&gt;Otherwise, if the &lt;tt&gt;right&lt;/tt&gt; margin is not specified, its value is the</span>
<a href="#l17.1693"></a><span id="l17.1693" class="difflineplus">+ * width of the parent panel, minus this mark's width and left margin; the left</span>
<a href="#l17.1694"></a><span id="l17.1694" class="difflineplus">+ * margin is zero if not specified.</span>
<a href="#l17.1695"></a><span id="l17.1695" class="difflineplus">+ *</span>
<a href="#l17.1696"></a><span id="l17.1696" class="difflineplus">+ * &lt;li&gt;Otherwise, if the &lt;tt&gt;left&lt;/tt&gt; property is not specified, its value is</span>
<a href="#l17.1697"></a><span id="l17.1697" class="difflineplus">+ * the width of the parent panel, minus this mark's width and the right margin.</span>
<a href="#l17.1698"></a><span id="l17.1698" class="difflineplus">+ *</span>
<a href="#l17.1699"></a><span id="l17.1699" class="difflineplus">+ * &lt;/ol&gt;This prioritization is then duplicated for the &lt;tt&gt;height&lt;/tt&gt;,</span>
<a href="#l17.1700"></a><span id="l17.1700" class="difflineplus">+ * &lt;tt&gt;bottom&lt;/tt&gt; and &lt;tt&gt;top&lt;/tt&gt; properties, respectively.</span>
<a href="#l17.1701"></a><span id="l17.1701" class="difflineplus">+ *</span>
<a href="#l17.1702"></a><span id="l17.1702" class="difflineplus">+ * @param s a node in the scene graph; the instance of the mark to build.</span>
<a href="#l17.1703"></a><span id="l17.1703" class="difflineplus">+ */</span>
<a href="#l17.1704"></a><span id="l17.1704" class="difflineplus">+pv.Mark.prototype.buildImplied = function(s) {</span>
<a href="#l17.1705"></a><span id="l17.1705" class="difflineplus">+  var l = s.left;</span>
<a href="#l17.1706"></a><span id="l17.1706" class="difflineplus">+  var r = s.right;</span>
<a href="#l17.1707"></a><span id="l17.1707" class="difflineplus">+  var t = s.top;</span>
<a href="#l17.1708"></a><span id="l17.1708" class="difflineplus">+  var b = s.bottom;</span>
<a href="#l17.1709"></a><span id="l17.1709" class="difflineplus">+</span>
<a href="#l17.1710"></a><span id="l17.1710" class="difflineplus">+  /* Assume width and height are zero if not supported by this mark type. */</span>
<a href="#l17.1711"></a><span id="l17.1711" class="difflineplus">+  var p = this.type.prototype;</span>
<a href="#l17.1712"></a><span id="l17.1712" class="difflineplus">+  var w = p.width ? s.width : 0;</span>
<a href="#l17.1713"></a><span id="l17.1713" class="difflineplus">+  var h = p.height ? s.height : 0;</span>
<a href="#l17.1714"></a><span id="l17.1714" class="difflineplus">+</span>
<a href="#l17.1715"></a><span id="l17.1715" class="difflineplus">+  /* Compute implied width, right and left. */</span>
<a href="#l17.1716"></a><span id="l17.1716" class="difflineplus">+  var width = s.parent ? s.parent.width : 0;</span>
<a href="#l17.1717"></a><span id="l17.1717" class="difflineplus">+  if (w == null) {</span>
<a href="#l17.1718"></a><span id="l17.1718" class="difflineplus">+    w = width - (r = r || 0) - (l = l || 0);</span>
<a href="#l17.1719"></a><span id="l17.1719" class="difflineplus">+  } else if (r == null) {</span>
<a href="#l17.1720"></a><span id="l17.1720" class="difflineplus">+    r = width - w - (l = l || 0);</span>
<a href="#l17.1721"></a><span id="l17.1721" class="difflineplus">+  } else if (l == null) {</span>
<a href="#l17.1722"></a><span id="l17.1722" class="difflineplus">+    l = width - w - (r = r || 0);</span>
<a href="#l17.1723"></a><span id="l17.1723" class="difflineplus">+  }</span>
<a href="#l17.1724"></a><span id="l17.1724" class="difflineplus">+</span>
<a href="#l17.1725"></a><span id="l17.1725" class="difflineplus">+  /* Compute implied height, bottom and top. */</span>
<a href="#l17.1726"></a><span id="l17.1726" class="difflineplus">+  var height = s.parent ? s.parent.height : 0;</span>
<a href="#l17.1727"></a><span id="l17.1727" class="difflineplus">+  if (h == null) {</span>
<a href="#l17.1728"></a><span id="l17.1728" class="difflineplus">+    h = height - (t = t || 0) - (b = b || 0);</span>
<a href="#l17.1729"></a><span id="l17.1729" class="difflineplus">+  } else if (b == null) {</span>
<a href="#l17.1730"></a><span id="l17.1730" class="difflineplus">+    b = height - h - (t = t || 0);</span>
<a href="#l17.1731"></a><span id="l17.1731" class="difflineplus">+  } else if (t == null) {</span>
<a href="#l17.1732"></a><span id="l17.1732" class="difflineplus">+    t = height - h - (b = b || 0);</span>
<a href="#l17.1733"></a><span id="l17.1733" class="difflineplus">+  }</span>
<a href="#l17.1734"></a><span id="l17.1734" class="difflineplus">+</span>
<a href="#l17.1735"></a><span id="l17.1735" class="difflineplus">+  s.left = l;</span>
<a href="#l17.1736"></a><span id="l17.1736" class="difflineplus">+  s.right = r;</span>
<a href="#l17.1737"></a><span id="l17.1737" class="difflineplus">+  s.top = t;</span>
<a href="#l17.1738"></a><span id="l17.1738" class="difflineplus">+  s.bottom = b;</span>
<a href="#l17.1739"></a><span id="l17.1739" class="difflineplus">+</span>
<a href="#l17.1740"></a><span id="l17.1740" class="difflineplus">+  /* Only set width and height if they are supported by this mark type. */</span>
<a href="#l17.1741"></a><span id="l17.1741" class="difflineplus">+  if (p.width) s.width = w;</span>
<a href="#l17.1742"></a><span id="l17.1742" class="difflineplus">+  if (p.height) s.height = h;</span>
<a href="#l17.1743"></a><span id="l17.1743" class="difflineplus">+};</span>
<a href="#l17.1744"></a><span id="l17.1744" class="difflineplus">+</span>
<a href="#l17.1745"></a><span id="l17.1745" class="difflineplus">+var property; // XXX</span>
<a href="#l17.1746"></a><span id="l17.1746" class="difflineplus">+</span>
<a href="#l17.1747"></a><span id="l17.1747" class="difflineplus">+/**</span>
<a href="#l17.1748"></a><span id="l17.1748" class="difflineplus">+ * Evaluates the property function with the specified name for the current data</span>
<a href="#l17.1749"></a><span id="l17.1749" class="difflineplus">+ * stack. The data stack, &lt;tt&gt;this.root.scene.data&lt;/tt&gt;, contains the current</span>
<a href="#l17.1750"></a><span id="l17.1750" class="difflineplus">+ * datum, followed by the datum for the enclosing panel, and so on.</span>
<a href="#l17.1751"></a><span id="l17.1751" class="difflineplus">+ *</span>
<a href="#l17.1752"></a><span id="l17.1752" class="difflineplus">+ * &lt;p&gt;This method first finds the implementing property function by querying the</span>
<a href="#l17.1753"></a><span id="l17.1753" class="difflineplus">+ * current mark. If the current mark does not define the property function, the</span>
<a href="#l17.1754"></a><span id="l17.1754" class="difflineplus">+ * prototype mark is queried, and so on. If none of the mark prototypes define a</span>
<a href="#l17.1755"></a><span id="l17.1755" class="difflineplus">+ * property function with the given name, the type default function is used. If</span>
<a href="#l17.1756"></a><span id="l17.1756" class="difflineplus">+ * no default function is provided, this method returns null.</span>
<a href="#l17.1757"></a><span id="l17.1757" class="difflineplus">+ *</span>
<a href="#l17.1758"></a><span id="l17.1758" class="difflineplus">+ * &lt;p&gt;The context of the property function is &lt;tt&gt;this&lt;/tt&gt; instance (i.e., the</span>
<a href="#l17.1759"></a><span id="l17.1759" class="difflineplus">+ * leaf-level mark), rather than whatever mark defined the property function.</span>
<a href="#l17.1760"></a><span id="l17.1760" class="difflineplus">+ * Because of this behavior, a property function may be called on an object of a</span>
<a href="#l17.1761"></a><span id="l17.1761" class="difflineplus">+ * different &quot;class&quot; (e.g., a Dot inheriting the fill style from a Line). Also</span>
<a href="#l17.1762"></a><span id="l17.1762" class="difflineplus">+ * note that properties are not inherited statically; inheritance happens at the</span>
<a href="#l17.1763"></a><span id="l17.1763" class="difflineplus">+ * property function / mark level, not per property value / mark instance. Thus,</span>
<a href="#l17.1764"></a><span id="l17.1764" class="difflineplus">+ * even if a Dot extends from a Line, if the Line's fill style is defined using</span>
<a href="#l17.1765"></a><span id="l17.1765" class="difflineplus">+ * a function that generates a random color, the Dot may get a different color.</span>
<a href="#l17.1766"></a><span id="l17.1766" class="difflineplus">+ *</span>
<a href="#l17.1767"></a><span id="l17.1767" class="difflineplus">+ * @param {string} name the property name.</span>
<a href="#l17.1768"></a><span id="l17.1768" class="difflineplus">+ * @returns the evaluated property value.</span>
<a href="#l17.1769"></a><span id="l17.1769" class="difflineplus">+ */</span>
<a href="#l17.1770"></a><span id="l17.1770" class="difflineplus">+pv.Mark.prototype.get = function(name) {</span>
<a href="#l17.1771"></a><span id="l17.1771" class="difflineplus">+  var mark = this;</span>
<a href="#l17.1772"></a><span id="l17.1772" class="difflineplus">+  while (!mark[&quot;$&quot; + name]) {</span>
<a href="#l17.1773"></a><span id="l17.1773" class="difflineplus">+    mark = mark.proto;</span>
<a href="#l17.1774"></a><span id="l17.1774" class="difflineplus">+    if (!mark) {</span>
<a href="#l17.1775"></a><span id="l17.1775" class="difflineplus">+      mark = this.type.defaults;</span>
<a href="#l17.1776"></a><span id="l17.1776" class="difflineplus">+      while (!mark[&quot;$&quot; + name]) {</span>
<a href="#l17.1777"></a><span id="l17.1777" class="difflineplus">+        mark = mark.proto;</span>
<a href="#l17.1778"></a><span id="l17.1778" class="difflineplus">+        if (!mark) {</span>
<a href="#l17.1779"></a><span id="l17.1779" class="difflineplus">+          return null;</span>
<a href="#l17.1780"></a><span id="l17.1780" class="difflineplus">+        }</span>
<a href="#l17.1781"></a><span id="l17.1781" class="difflineplus">+      }</span>
<a href="#l17.1782"></a><span id="l17.1782" class="difflineplus">+      break;</span>
<a href="#l17.1783"></a><span id="l17.1783" class="difflineplus">+    }</span>
<a href="#l17.1784"></a><span id="l17.1784" class="difflineplus">+  }</span>
<a href="#l17.1785"></a><span id="l17.1785" class="difflineplus">+  property = name; // XXX</span>
<a href="#l17.1786"></a><span id="l17.1786" class="difflineplus">+  return mark[&quot;$&quot; + name].apply(this, this.root.scene.data);</span>
<a href="#l17.1787"></a><span id="l17.1787" class="difflineplus">+};</span>
<a href="#l17.1788"></a><span id="l17.1788" class="difflineplus">+</span>
<a href="#l17.1789"></a><span id="l17.1789" class="difflineplus">+/**</span>
<a href="#l17.1790"></a><span id="l17.1790" class="difflineplus">+ * Updates the display, propagating property values computed in the build phase</span>
<a href="#l17.1791"></a><span id="l17.1791" class="difflineplus">+ * to the SVG image. This method is typically invoked by {@link #render}, but is</span>
<a href="#l17.1792"></a><span id="l17.1792" class="difflineplus">+ * also invoked after an event handler is triggered to update the display of a</span>
<a href="#l17.1793"></a><span id="l17.1793" class="difflineplus">+ * specific mark.</span>
<a href="#l17.1794"></a><span id="l17.1794" class="difflineplus">+ *</span>
<a href="#l17.1795"></a><span id="l17.1795" class="difflineplus">+ * @see #event</span>
<a href="#l17.1796"></a><span id="l17.1796" class="difflineplus">+ */</span>
<a href="#l17.1797"></a><span id="l17.1797" class="difflineplus">+pv.Mark.prototype.update = function() {</span>
<a href="#l17.1798"></a><span id="l17.1798" class="difflineplus">+  for (var i = 0; i &lt; this.scene.length; i++) {</span>
<a href="#l17.1799"></a><span id="l17.1799" class="difflineplus">+    this.updateInstance(this.scene[i]);</span>
<a href="#l17.1800"></a><span id="l17.1800" class="difflineplus">+  }</span>
<a href="#l17.1801"></a><span id="l17.1801" class="difflineplus">+};</span>
<a href="#l17.1802"></a><span id="l17.1802" class="difflineplus">+</span>
<a href="#l17.1803"></a><span id="l17.1803" class="difflineplus">+/**</span>
<a href="#l17.1804"></a><span id="l17.1804" class="difflineplus">+ * Updates the display for the specified mark instance &lt;tt&gt;s&lt;/tt&gt; in the scene</span>
<a href="#l17.1805"></a><span id="l17.1805" class="difflineplus">+ * graph. This implementation handles basic properties for all mark types, such</span>
<a href="#l17.1806"></a><span id="l17.1806" class="difflineplus">+ * as visibility, cursor and title tooltip. Concrete mark types should override</span>
<a href="#l17.1807"></a><span id="l17.1807" class="difflineplus">+ * this method to specify how marks are rendered.</span>
<a href="#l17.1808"></a><span id="l17.1808" class="difflineplus">+ *</span>
<a href="#l17.1809"></a><span id="l17.1809" class="difflineplus">+ * @param s a node in the scene graph; the instance of the mark to update.</span>
<a href="#l17.1810"></a><span id="l17.1810" class="difflineplus">+ */</span>
<a href="#l17.1811"></a><span id="l17.1811" class="difflineplus">+pv.Mark.prototype.updateInstance = function(s) {</span>
<a href="#l17.1812"></a><span id="l17.1812" class="difflineplus">+  var that = this, v = s.svg;</span>
<a href="#l17.1813"></a><span id="l17.1813" class="difflineplus">+</span>
<a href="#l17.1814"></a><span id="l17.1814" class="difflineplus">+  /* visible */</span>
<a href="#l17.1815"></a><span id="l17.1815" class="difflineplus">+  if (!s.visible) {</span>
<a href="#l17.1816"></a><span id="l17.1816" class="difflineplus">+    if (v) v.setAttribute(&quot;display&quot;, &quot;none&quot;);</span>
<a href="#l17.1817"></a><span id="l17.1817" class="difflineplus">+    return;</span>
<a href="#l17.1818"></a><span id="l17.1818" class="difflineplus">+  }</span>
<a href="#l17.1819"></a><span id="l17.1819" class="difflineplus">+  v.removeAttribute(&quot;display&quot;);</span>
<a href="#l17.1820"></a><span id="l17.1820" class="difflineplus">+</span>
<a href="#l17.1821"></a><span id="l17.1821" class="difflineplus">+  /* cursor */</span>
<a href="#l17.1822"></a><span id="l17.1822" class="difflineplus">+  if (s.cursor) v.style.cursor = s.cursor;</span>
<a href="#l17.1823"></a><span id="l17.1823" class="difflineplus">+</span>
<a href="#l17.1824"></a><span id="l17.1824" class="difflineplus">+  /* title (Safari only supports xlink:title on anchor elements) */</span>
<a href="#l17.1825"></a><span id="l17.1825" class="difflineplus">+  var p = v.parentNode;</span>
<a href="#l17.1826"></a><span id="l17.1826" class="difflineplus">+  if (s.title) {</span>
<a href="#l17.1827"></a><span id="l17.1827" class="difflineplus">+    if (!v.$title) {</span>
<a href="#l17.1828"></a><span id="l17.1828" class="difflineplus">+      v.$title = document.createElementNS(pv.ns.svg, &quot;a&quot;);</span>
<a href="#l17.1829"></a><span id="l17.1829" class="difflineplus">+      p.insertBefore(v.$title, v);</span>
<a href="#l17.1830"></a><span id="l17.1830" class="difflineplus">+      v.$title.appendChild(v);</span>
<a href="#l17.1831"></a><span id="l17.1831" class="difflineplus">+    }</span>
<a href="#l17.1832"></a><span id="l17.1832" class="difflineplus">+    v.$title.setAttributeNS(pv.ns.xlink, &quot;title&quot;, s.title);</span>
<a href="#l17.1833"></a><span id="l17.1833" class="difflineplus">+  } else if (v.$title) {</span>
<a href="#l17.1834"></a><span id="l17.1834" class="difflineplus">+    p.insertBefore(v, v.$title);</span>
<a href="#l17.1835"></a><span id="l17.1835" class="difflineplus">+    p.removeChild(v.$title);</span>
<a href="#l17.1836"></a><span id="l17.1836" class="difflineplus">+    delete v.$title;</span>
<a href="#l17.1837"></a><span id="l17.1837" class="difflineplus">+  }</span>
<a href="#l17.1838"></a><span id="l17.1838" class="difflineplus">+</span>
<a href="#l17.1839"></a><span id="l17.1839" class="difflineplus">+  /* event */</span>
<a href="#l17.1840"></a><span id="l17.1840" class="difflineplus">+  function dispatch(type) {</span>
<a href="#l17.1841"></a><span id="l17.1841" class="difflineplus">+    return function(e) {</span>
<a href="#l17.1842"></a><span id="l17.1842" class="difflineplus">+        /* TODO set full scene stack. */</span>
<a href="#l17.1843"></a><span id="l17.1843" class="difflineplus">+        var data = [s.data], p = s;</span>
<a href="#l17.1844"></a><span id="l17.1844" class="difflineplus">+        while (p = p.parent) {</span>
<a href="#l17.1845"></a><span id="l17.1845" class="difflineplus">+          data.push(p.data);</span>
<a href="#l17.1846"></a><span id="l17.1846" class="difflineplus">+        }</span>
<a href="#l17.1847"></a><span id="l17.1847" class="difflineplus">+        that.index = s.index;</span>
<a href="#l17.1848"></a><span id="l17.1848" class="difflineplus">+        that.scene = s.parent.children[that.childIndex];</span>
<a href="#l17.1849"></a><span id="l17.1849" class="difflineplus">+        that.events[type].apply(that, data);</span>
<a href="#l17.1850"></a><span id="l17.1850" class="difflineplus">+        that.updateInstance(s); // XXX updateInstance, bah!</span>
<a href="#l17.1851"></a><span id="l17.1851" class="difflineplus">+        delete that.index;</span>
<a href="#l17.1852"></a><span id="l17.1852" class="difflineplus">+        delete that.scene;</span>
<a href="#l17.1853"></a><span id="l17.1853" class="difflineplus">+        e.preventDefault();</span>
<a href="#l17.1854"></a><span id="l17.1854" class="difflineplus">+      };</span>
<a href="#l17.1855"></a><span id="l17.1855" class="difflineplus">+  };</span>
<a href="#l17.1856"></a><span id="l17.1856" class="difflineplus">+</span>
<a href="#l17.1857"></a><span id="l17.1857" class="difflineplus">+  /* TODO inherit event handlers. */</span>
<a href="#l17.1858"></a><span id="l17.1858" class="difflineplus">+  for (var type in this.events) {</span>
<a href="#l17.1859"></a><span id="l17.1859" class="difflineplus">+    v[&quot;on&quot; + type] = dispatch(type);</span>
<a href="#l17.1860"></a><span id="l17.1860" class="difflineplus">+  }</span>
<a href="#l17.1861"></a><span id="l17.1861" class="difflineplus">+};</span>
<a href="#l17.1862"></a><span id="l17.1862" class="difflineplus">+</span>
<a href="#l17.1863"></a><span id="l17.1863" class="difflineplus">+/**</span>
<a href="#l17.1864"></a><span id="l17.1864" class="difflineplus">+ * Registers an event handler for the specified event type with this mark. When</span>
<a href="#l17.1865"></a><span id="l17.1865" class="difflineplus">+ * an event of the specified type is triggered, the specified handler will be</span>
<a href="#l17.1866"></a><span id="l17.1866" class="difflineplus">+ * invoked. The handler is invoked in a similar method to property functions:</span>
<a href="#l17.1867"></a><span id="l17.1867" class="difflineplus">+ * the context is &lt;tt&gt;this&lt;/tt&gt; mark instance, and the arguments are the full</span>
<a href="#l17.1868"></a><span id="l17.1868" class="difflineplus">+ * data stack. Event handlers can use property methods to manipulate the display</span>
<a href="#l17.1869"></a><span id="l17.1869" class="difflineplus">+ * properties of the mark:</span>
<a href="#l17.1870"></a><span id="l17.1870" class="difflineplus">+ *</span>
<a href="#l17.1871"></a><span id="l17.1871" class="difflineplus">+ * &lt;pre&gt;m.event(&quot;click&quot;, function() this.fillStyle(&quot;red&quot;));&lt;/pre&gt;</span>
<a href="#l17.1872"></a><span id="l17.1872" class="difflineplus">+ *</span>
<a href="#l17.1873"></a><span id="l17.1873" class="difflineplus">+ * Alternatively, the external data can be manipulated and the visualization</span>
<a href="#l17.1874"></a><span id="l17.1874" class="difflineplus">+ * redrawn:</span>
<a href="#l17.1875"></a><span id="l17.1875" class="difflineplus">+ *</span>
<a href="#l17.1876"></a><span id="l17.1876" class="difflineplus">+ * &lt;pre&gt;m.event(&quot;click&quot;, function(d) {</span>
<a href="#l17.1877"></a><span id="l17.1877" class="difflineplus">+ *     data = all.filter(function(k) k.name == d);</span>
<a href="#l17.1878"></a><span id="l17.1878" class="difflineplus">+ *     vis.render();</span>
<a href="#l17.1879"></a><span id="l17.1879" class="difflineplus">+ *   });&lt;/pre&gt;</span>
<a href="#l17.1880"></a><span id="l17.1880" class="difflineplus">+ *</span>
<a href="#l17.1881"></a><span id="l17.1881" class="difflineplus">+ * TODO In the current event handler implementation, only the mark instance that</span>
<a href="#l17.1882"></a><span id="l17.1882" class="difflineplus">+ * triggered the event is updated, even if the event handler dirties the rest of</span>
<a href="#l17.1883"></a><span id="l17.1883" class="difflineplus">+ * the scene. While this can be ameliorated by explicitly re-rendering, it would</span>
<a href="#l17.1884"></a><span id="l17.1884" class="difflineplus">+ * be better and more efficient for the event dispatcher to handle dirtying and</span>
<a href="#l17.1885"></a><span id="l17.1885" class="difflineplus">+ * redraw automatically.</span>
<a href="#l17.1886"></a><span id="l17.1886" class="difflineplus">+ *</span>
<a href="#l17.1887"></a><span id="l17.1887" class="difflineplus">+ * &lt;p&gt;The complete set of event types is defined by SVG; see the reference</span>
<a href="#l17.1888"></a><span id="l17.1888" class="difflineplus">+ * below. The set of supported event types is:&lt;ul&gt;</span>
<a href="#l17.1889"></a><span id="l17.1889" class="difflineplus">+ *</span>
<a href="#l17.1890"></a><span id="l17.1890" class="difflineplus">+ * &lt;li&gt;click</span>
<a href="#l17.1891"></a><span id="l17.1891" class="difflineplus">+ * &lt;li&gt;mousedown</span>
<a href="#l17.1892"></a><span id="l17.1892" class="difflineplus">+ * &lt;li&gt;mouseup</span>
<a href="#l17.1893"></a><span id="l17.1893" class="difflineplus">+ * &lt;li&gt;mouseover</span>
<a href="#l17.1894"></a><span id="l17.1894" class="difflineplus">+ * &lt;li&gt;mousemove</span>
<a href="#l17.1895"></a><span id="l17.1895" class="difflineplus">+ * &lt;li&gt;mouseout</span>
<a href="#l17.1896"></a><span id="l17.1896" class="difflineplus">+ *</span>
<a href="#l17.1897"></a><span id="l17.1897" class="difflineplus">+ * &lt;/ul&gt;Since Protovis does not specify any concept of focus, it does not</span>
<a href="#l17.1898"></a><span id="l17.1898" class="difflineplus">+ * support key events; these should be handled outside the visualization using</span>
<a href="#l17.1899"></a><span id="l17.1899" class="difflineplus">+ * standard JavaScript. In the future, support for interaction may be extended</span>
<a href="#l17.1900"></a><span id="l17.1900" class="difflineplus">+ * to support additional event types, particularly those most relevant to</span>
<a href="#l17.1901"></a><span id="l17.1901" class="difflineplus">+ * interactive visualization, such as selection.</span>
<a href="#l17.1902"></a><span id="l17.1902" class="difflineplus">+ *</span>
<a href="#l17.1903"></a><span id="l17.1903" class="difflineplus">+ * &lt;p&gt;TODO In the current implementation, event handlers are not inherited from</span>
<a href="#l17.1904"></a><span id="l17.1904" class="difflineplus">+ * prototype marks. They must be defined explicitly on each interactive mark. In</span>
<a href="#l17.1905"></a><span id="l17.1905" class="difflineplus">+ * addition, only one event handler for a given event type can be defined; when</span>
<a href="#l17.1906"></a><span id="l17.1906" class="difflineplus">+ * specifying multiple event handlers for the same type, only the last one will</span>
<a href="#l17.1907"></a><span id="l17.1907" class="difflineplus">+ * be used.</span>
<a href="#l17.1908"></a><span id="l17.1908" class="difflineplus">+ *</span>
<a href="#l17.1909"></a><span id="l17.1909" class="difflineplus">+ * @see &lt;a href=&quot;http://www.w3.org/TR/SVGTiny12/interact.html#SVGEvents&quot;&gt;SVG events&lt;/a&gt;.</span>
<a href="#l17.1910"></a><span id="l17.1910" class="difflineplus">+ * @param {string} type the event type.</span>
<a href="#l17.1911"></a><span id="l17.1911" class="difflineplus">+ * @param {function} handler the event handler.</span>
<a href="#l17.1912"></a><span id="l17.1912" class="difflineplus">+ * @returns {pv.Mark} this.</span>
<a href="#l17.1913"></a><span id="l17.1913" class="difflineplus">+ */</span>
<a href="#l17.1914"></a><span id="l17.1914" class="difflineplus">+pv.Mark.prototype.event = function(type, handler) {</span>
<a href="#l17.1915"></a><span id="l17.1915" class="difflineplus">+  if (!this.events) this.events = {};</span>
<a href="#l17.1916"></a><span id="l17.1916" class="difflineplus">+  this.events[type] = handler;</span>
<a href="#l17.1917"></a><span id="l17.1917" class="difflineplus">+  return this;</span>
<a href="#l17.1918"></a><span id="l17.1918" class="difflineplus">+};</span>
<a href="#l17.1919"></a><span id="l17.1919" class="difflineplus">+/**</span>
<a href="#l17.1920"></a><span id="l17.1920" class="difflineplus">+ * Constructs a new area mark with default properties. Areas are not typically</span>
<a href="#l17.1921"></a><span id="l17.1921" class="difflineplus">+ * constructed directly, but by adding to a panel or an existing mark via</span>
<a href="#l17.1922"></a><span id="l17.1922" class="difflineplus">+ * {@link pv.Mark#add}.</span>
<a href="#l17.1923"></a><span id="l17.1923" class="difflineplus">+ *</span>
<a href="#l17.1924"></a><span id="l17.1924" class="difflineplus">+ * @class Represents an area mark: the solid area between two series of</span>
<a href="#l17.1925"></a><span id="l17.1925" class="difflineplus">+ * connected line segments. Unsurprisingly, areas are used most frequently for</span>
<a href="#l17.1926"></a><span id="l17.1926" class="difflineplus">+ * area charts.</span>
<a href="#l17.1927"></a><span id="l17.1927" class="difflineplus">+ *</span>
<a href="#l17.1928"></a><span id="l17.1928" class="difflineplus">+ * &lt;p&gt;Just as a line represents a polyline, the &lt;tt&gt;Area&lt;/tt&gt; mark type</span>
<a href="#l17.1929"></a><span id="l17.1929" class="difflineplus">+ * represents a &lt;i&gt;polygon&lt;/i&gt;. However, an area is not an arbitrary polygon;</span>
<a href="#l17.1930"></a><span id="l17.1930" class="difflineplus">+ * vertices are paired either horizontally or vertically into parallel</span>
<a href="#l17.1931"></a><span id="l17.1931" class="difflineplus">+ * &lt;i&gt;spans&lt;/i&gt;, and each span corresponds to an associated datum. Either the</span>
<a href="#l17.1932"></a><span id="l17.1932" class="difflineplus">+ * width or the height must be specified, but not both; this determines whether</span>
<a href="#l17.1933"></a><span id="l17.1933" class="difflineplus">+ * the area is horizontally-oriented or vertically-oriented.  Like lines, areas</span>
<a href="#l17.1934"></a><span id="l17.1934" class="difflineplus">+ * can be stroked and filled with arbitrary colors.</span>
<a href="#l17.1935"></a><span id="l17.1935" class="difflineplus">+ *</span>
<a href="#l17.1936"></a><span id="l17.1936" class="difflineplus">+ * &lt;p&gt;See also the &lt;a href=&quot;../../api/Area.html&quot;&gt;Area guide&lt;/a&gt;.</span>
<a href="#l17.1937"></a><span id="l17.1937" class="difflineplus">+ *</span>
<a href="#l17.1938"></a><span id="l17.1938" class="difflineplus">+ * @extends pv.Mark</span>
<a href="#l17.1939"></a><span id="l17.1939" class="difflineplus">+ */</span>
<a href="#l17.1940"></a><span id="l17.1940" class="difflineplus">+pv.Area = function() {</span>
<a href="#l17.1941"></a><span id="l17.1941" class="difflineplus">+  pv.Mark.call(this);</span>
<a href="#l17.1942"></a><span id="l17.1942" class="difflineplus">+};</span>
<a href="#l17.1943"></a><span id="l17.1943" class="difflineplus">+pv.Area.prototype = pv.extend(pv.Mark);</span>
<a href="#l17.1944"></a><span id="l17.1944" class="difflineplus">+pv.Area.prototype.type = pv.Area;</span>
<a href="#l17.1945"></a><span id="l17.1945" class="difflineplus">+</span>
<a href="#l17.1946"></a><span id="l17.1946" class="difflineplus">+/**</span>
<a href="#l17.1947"></a><span id="l17.1947" class="difflineplus">+ * Returns &quot;area&quot;.</span>
<a href="#l17.1948"></a><span id="l17.1948" class="difflineplus">+ *</span>
<a href="#l17.1949"></a><span id="l17.1949" class="difflineplus">+ * @returns {string} &quot;area&quot;.</span>
<a href="#l17.1950"></a><span id="l17.1950" class="difflineplus">+ */</span>
<a href="#l17.1951"></a><span id="l17.1951" class="difflineplus">+pv.Area.toString = function() { return &quot;area&quot;; };</span>
<a href="#l17.1952"></a><span id="l17.1952" class="difflineplus">+</span>
<a href="#l17.1953"></a><span id="l17.1953" class="difflineplus">+/**</span>
<a href="#l17.1954"></a><span id="l17.1954" class="difflineplus">+ * The width of a given span, in pixels; used for horizontal spans. If the width</span>
<a href="#l17.1955"></a><span id="l17.1955" class="difflineplus">+ * is specified, the height property should be 0 (the default). Either the top</span>
<a href="#l17.1956"></a><span id="l17.1956" class="difflineplus">+ * or bottom property should be used to space the spans vertically, typically as</span>
<a href="#l17.1957"></a><span id="l17.1957" class="difflineplus">+ * a multiple of the index.</span>
<a href="#l17.1958"></a><span id="l17.1958" class="difflineplus">+ *</span>
<a href="#l17.1959"></a><span id="l17.1959" class="difflineplus">+ * @type number</span>
<a href="#l17.1960"></a><span id="l17.1960" class="difflineplus">+ * @name pv.Area.prototype.width</span>
<a href="#l17.1961"></a><span id="l17.1961" class="difflineplus">+ */</span>
<a href="#l17.1962"></a><span id="l17.1962" class="difflineplus">+pv.Area.prototype.defineProperty(&quot;width&quot;);</span>
<a href="#l17.1963"></a><span id="l17.1963" class="difflineplus">+</span>
<a href="#l17.1964"></a><span id="l17.1964" class="difflineplus">+/**</span>
<a href="#l17.1965"></a><span id="l17.1965" class="difflineplus">+ * The height of a given span, in pixels; used for vertical spans. If the height</span>
<a href="#l17.1966"></a><span id="l17.1966" class="difflineplus">+ * is specified, the width property should be 0 (the default). Either the left</span>
<a href="#l17.1967"></a><span id="l17.1967" class="difflineplus">+ * or right property should be used to space the spans horizontally, typically</span>
<a href="#l17.1968"></a><span id="l17.1968" class="difflineplus">+ * as a multiple of the index.</span>
<a href="#l17.1969"></a><span id="l17.1969" class="difflineplus">+ *</span>
<a href="#l17.1970"></a><span id="l17.1970" class="difflineplus">+ * @type number</span>
<a href="#l17.1971"></a><span id="l17.1971" class="difflineplus">+ * @name pv.Area.prototype.height</span>
<a href="#l17.1972"></a><span id="l17.1972" class="difflineplus">+ */</span>
<a href="#l17.1973"></a><span id="l17.1973" class="difflineplus">+pv.Area.prototype.defineProperty(&quot;height&quot;);</span>
<a href="#l17.1974"></a><span id="l17.1974" class="difflineplus">+</span>
<a href="#l17.1975"></a><span id="l17.1975" class="difflineplus">+/**</span>
<a href="#l17.1976"></a><span id="l17.1976" class="difflineplus">+ * The width of stroked lines, in pixels; used in conjunction with</span>
<a href="#l17.1977"></a><span id="l17.1977" class="difflineplus">+ * &lt;tt&gt;strokeStyle&lt;/tt&gt; to stroke the perimeter of the area. Unlike the</span>
<a href="#l17.1978"></a><span id="l17.1978" class="difflineplus">+ * {@link Line} mark type, the entire perimeter is stroked, rather than just one</span>
<a href="#l17.1979"></a><span id="l17.1979" class="difflineplus">+ * edge. The default value of this property is 1.5, but since the default stroke</span>
<a href="#l17.1980"></a><span id="l17.1980" class="difflineplus">+ * style is null, area marks are not stroked by default.</span>
<a href="#l17.1981"></a><span id="l17.1981" class="difflineplus">+ *</span>
<a href="#l17.1982"></a><span id="l17.1982" class="difflineplus">+ * &lt;p&gt;This property is &lt;i&gt;fixed&lt;/i&gt;. See {@link pv.Mark}.</span>
<a href="#l17.1983"></a><span id="l17.1983" class="difflineplus">+ *</span>
<a href="#l17.1984"></a><span id="l17.1984" class="difflineplus">+ * @type number</span>
<a href="#l17.1985"></a><span id="l17.1985" class="difflineplus">+ * @name pv.Area.prototype.lineWidth</span>
<a href="#l17.1986"></a><span id="l17.1986" class="difflineplus">+ */</span>
<a href="#l17.1987"></a><span id="l17.1987" class="difflineplus">+pv.Area.prototype.defineProperty(&quot;lineWidth&quot;);</span>
<a href="#l17.1988"></a><span id="l17.1988" class="difflineplus">+</span>
<a href="#l17.1989"></a><span id="l17.1989" class="difflineplus">+/**</span>
<a href="#l17.1990"></a><span id="l17.1990" class="difflineplus">+ * The style of stroked lines; used in conjunction with &lt;tt&gt;lineWidth&lt;/tt&gt; to</span>
<a href="#l17.1991"></a><span id="l17.1991" class="difflineplus">+ * stroke the perimeter of the area. Unlike the {@link Line} mark type, the</span>
<a href="#l17.1992"></a><span id="l17.1992" class="difflineplus">+ * entire perimeter is stroked, rather than just one edge. The default value of</span>
<a href="#l17.1993"></a><span id="l17.1993" class="difflineplus">+ * this property is null, meaning areas are not stroked by default.</span>
<a href="#l17.1994"></a><span id="l17.1994" class="difflineplus">+ *</span>
<a href="#l17.1995"></a><span id="l17.1995" class="difflineplus">+ * &lt;p&gt;This property is &lt;i&gt;fixed&lt;/i&gt;. See {@link pv.Mark}.</span>
<a href="#l17.1996"></a><span id="l17.1996" class="difflineplus">+ *</span>
<a href="#l17.1997"></a><span id="l17.1997" class="difflineplus">+ * @type string</span>
<a href="#l17.1998"></a><span id="l17.1998" class="difflineplus">+ * @name pv.Area.prototype.strokeStyle</span>
<a href="#l17.1999"></a><span id="l17.1999" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.2000"></a><span id="l17.2000" class="difflineplus">+ */</span>
<a href="#l17.2001"></a><span id="l17.2001" class="difflineplus">+pv.Area.prototype.defineProperty(&quot;strokeStyle&quot;);</span>
<a href="#l17.2002"></a><span id="l17.2002" class="difflineplus">+</span>
<a href="#l17.2003"></a><span id="l17.2003" class="difflineplus">+/**</span>
<a href="#l17.2004"></a><span id="l17.2004" class="difflineplus">+ * The area fill style; if non-null, the interior of the polygon forming the</span>
<a href="#l17.2005"></a><span id="l17.2005" class="difflineplus">+ * area is filled with the specified color. The default value of this property</span>
<a href="#l17.2006"></a><span id="l17.2006" class="difflineplus">+ * is a categorical color.</span>
<a href="#l17.2007"></a><span id="l17.2007" class="difflineplus">+ *</span>
<a href="#l17.2008"></a><span id="l17.2008" class="difflineplus">+ * &lt;p&gt;This property is &lt;i&gt;fixed&lt;/i&gt;. See {@link pv.Mark}.</span>
<a href="#l17.2009"></a><span id="l17.2009" class="difflineplus">+ *</span>
<a href="#l17.2010"></a><span id="l17.2010" class="difflineplus">+ * @type string</span>
<a href="#l17.2011"></a><span id="l17.2011" class="difflineplus">+ * @name pv.Area.prototype.fillStyle</span>
<a href="#l17.2012"></a><span id="l17.2012" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.2013"></a><span id="l17.2013" class="difflineplus">+ */</span>
<a href="#l17.2014"></a><span id="l17.2014" class="difflineplus">+pv.Area.prototype.defineProperty(&quot;fillStyle&quot;);</span>
<a href="#l17.2015"></a><span id="l17.2015" class="difflineplus">+</span>
<a href="#l17.2016"></a><span id="l17.2016" class="difflineplus">+/**</span>
<a href="#l17.2017"></a><span id="l17.2017" class="difflineplus">+ * Default properties for areas. By default, there is no stroke and the fill</span>
<a href="#l17.2018"></a><span id="l17.2018" class="difflineplus">+ * style is a categorical color.</span>
<a href="#l17.2019"></a><span id="l17.2019" class="difflineplus">+ *</span>
<a href="#l17.2020"></a><span id="l17.2020" class="difflineplus">+ * @type pv.Area</span>
<a href="#l17.2021"></a><span id="l17.2021" class="difflineplus">+ */</span>
<a href="#l17.2022"></a><span id="l17.2022" class="difflineplus">+pv.Area.defaults = new pv.Area().extend(pv.Mark.defaults)</span>
<a href="#l17.2023"></a><span id="l17.2023" class="difflineplus">+    .lineWidth(1.5)</span>
<a href="#l17.2024"></a><span id="l17.2024" class="difflineplus">+    .fillStyle(pv.Colors.category20);</span>
<a href="#l17.2025"></a><span id="l17.2025" class="difflineplus">+</span>
<a href="#l17.2026"></a><span id="l17.2026" class="difflineplus">+/**</span>
<a href="#l17.2027"></a><span id="l17.2027" class="difflineplus">+ * Constructs a new area anchor with default properties.</span>
<a href="#l17.2028"></a><span id="l17.2028" class="difflineplus">+ *</span>
<a href="#l17.2029"></a><span id="l17.2029" class="difflineplus">+ * @class Represents an anchor for an area mark. Areas support five different</span>
<a href="#l17.2030"></a><span id="l17.2030" class="difflineplus">+ * anchors:&lt;ul&gt;</span>
<a href="#l17.2031"></a><span id="l17.2031" class="difflineplus">+ *</span>
<a href="#l17.2032"></a><span id="l17.2032" class="difflineplus">+ * &lt;li&gt;top</span>
<a href="#l17.2033"></a><span id="l17.2033" class="difflineplus">+ * &lt;li&gt;left</span>
<a href="#l17.2034"></a><span id="l17.2034" class="difflineplus">+ * &lt;li&gt;center</span>
<a href="#l17.2035"></a><span id="l17.2035" class="difflineplus">+ * &lt;li&gt;bottom</span>
<a href="#l17.2036"></a><span id="l17.2036" class="difflineplus">+ * &lt;li&gt;right</span>
<a href="#l17.2037"></a><span id="l17.2037" class="difflineplus">+ *</span>
<a href="#l17.2038"></a><span id="l17.2038" class="difflineplus">+ * &lt;/ul&gt;In addition to positioning properties (left, right, top bottom), the</span>
<a href="#l17.2039"></a><span id="l17.2039" class="difflineplus">+ * anchors support text rendering properties (text-align, text-baseline). Text is</span>
<a href="#l17.2040"></a><span id="l17.2040" class="difflineplus">+ * rendered to appear inside the area polygon.</span>
<a href="#l17.2041"></a><span id="l17.2041" class="difflineplus">+ *</span>
<a href="#l17.2042"></a><span id="l17.2042" class="difflineplus">+ * &lt;p&gt;To facilitate stacking of areas, the anchors are defined in terms of their</span>
<a href="#l17.2043"></a><span id="l17.2043" class="difflineplus">+ * opposite edge. For example, the top anchor defines the bottom property, such</span>
<a href="#l17.2044"></a><span id="l17.2044" class="difflineplus">+ * that the area grows upwards; the bottom anchor instead defines the top</span>
<a href="#l17.2045"></a><span id="l17.2045" class="difflineplus">+ * property, such that the area grows downwards. Of course, in general it is</span>
<a href="#l17.2046"></a><span id="l17.2046" class="difflineplus">+ * more robust to use panels and the cousin accessor to define stacked area</span>
<a href="#l17.2047"></a><span id="l17.2047" class="difflineplus">+ * marks; see {@link pv.Mark#scene} for an example.</span>
<a href="#l17.2048"></a><span id="l17.2048" class="difflineplus">+ *</span>
<a href="#l17.2049"></a><span id="l17.2049" class="difflineplus">+ * @extends pv.Mark.Anchor</span>
<a href="#l17.2050"></a><span id="l17.2050" class="difflineplus">+ */</span>
<a href="#l17.2051"></a><span id="l17.2051" class="difflineplus">+pv.Area.Anchor = function() {</span>
<a href="#l17.2052"></a><span id="l17.2052" class="difflineplus">+  pv.Mark.Anchor.call(this);</span>
<a href="#l17.2053"></a><span id="l17.2053" class="difflineplus">+};</span>
<a href="#l17.2054"></a><span id="l17.2054" class="difflineplus">+pv.Area.Anchor.prototype = pv.extend(pv.Mark.Anchor);</span>
<a href="#l17.2055"></a><span id="l17.2055" class="difflineplus">+pv.Area.Anchor.prototype.type = pv.Area;</span>
<a href="#l17.2056"></a><span id="l17.2056" class="difflineplus">+</span>
<a href="#l17.2057"></a><span id="l17.2057" class="difflineplus">+/**</span>
<a href="#l17.2058"></a><span id="l17.2058" class="difflineplus">+ * The left property; null for &quot;left&quot; anchors, non-null otherwise.</span>
<a href="#l17.2059"></a><span id="l17.2059" class="difflineplus">+ *</span>
<a href="#l17.2060"></a><span id="l17.2060" class="difflineplus">+ * @type number</span>
<a href="#l17.2061"></a><span id="l17.2061" class="difflineplus">+ * @name pv.Area.Anchor.prototype.left</span>
<a href="#l17.2062"></a><span id="l17.2062" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2063"></a><span id="l17.2063" class="difflineplus">+pv.Area.Anchor.prototype.$left = function() {</span>
<a href="#l17.2064"></a><span id="l17.2064" class="difflineplus">+  var area = this.anchorTarget();</span>
<a href="#l17.2065"></a><span id="l17.2065" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2066"></a><span id="l17.2066" class="difflineplus">+    case &quot;bottom&quot;:</span>
<a href="#l17.2067"></a><span id="l17.2067" class="difflineplus">+    case &quot;top&quot;:</span>
<a href="#l17.2068"></a><span id="l17.2068" class="difflineplus">+    case &quot;center&quot;: return area.left() + area.width() / 2;</span>
<a href="#l17.2069"></a><span id="l17.2069" class="difflineplus">+    case &quot;right&quot;: return area.left() + area.width();</span>
<a href="#l17.2070"></a><span id="l17.2070" class="difflineplus">+  }</span>
<a href="#l17.2071"></a><span id="l17.2071" class="difflineplus">+  return null;</span>
<a href="#l17.2072"></a><span id="l17.2072" class="difflineplus">+};</span>
<a href="#l17.2073"></a><span id="l17.2073" class="difflineplus">+</span>
<a href="#l17.2074"></a><span id="l17.2074" class="difflineplus">+/**</span>
<a href="#l17.2075"></a><span id="l17.2075" class="difflineplus">+ * The right property; null for &quot;right&quot; anchors, non-null otherwise.</span>
<a href="#l17.2076"></a><span id="l17.2076" class="difflineplus">+ *</span>
<a href="#l17.2077"></a><span id="l17.2077" class="difflineplus">+ * @type number</span>
<a href="#l17.2078"></a><span id="l17.2078" class="difflineplus">+ * @name pv.Area.Anchor.prototype.right</span>
<a href="#l17.2079"></a><span id="l17.2079" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2080"></a><span id="l17.2080" class="difflineplus">+pv.Area.Anchor.prototype.$right = function() {</span>
<a href="#l17.2081"></a><span id="l17.2081" class="difflineplus">+  var area = this.anchorTarget();</span>
<a href="#l17.2082"></a><span id="l17.2082" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2083"></a><span id="l17.2083" class="difflineplus">+    case &quot;bottom&quot;:</span>
<a href="#l17.2084"></a><span id="l17.2084" class="difflineplus">+    case &quot;top&quot;:</span>
<a href="#l17.2085"></a><span id="l17.2085" class="difflineplus">+    case &quot;center&quot;: return area.right() + area.width() / 2;</span>
<a href="#l17.2086"></a><span id="l17.2086" class="difflineplus">+    case &quot;left&quot;: return area.right() + area.width();</span>
<a href="#l17.2087"></a><span id="l17.2087" class="difflineplus">+  }</span>
<a href="#l17.2088"></a><span id="l17.2088" class="difflineplus">+  return null;</span>
<a href="#l17.2089"></a><span id="l17.2089" class="difflineplus">+};</span>
<a href="#l17.2090"></a><span id="l17.2090" class="difflineplus">+</span>
<a href="#l17.2091"></a><span id="l17.2091" class="difflineplus">+/**</span>
<a href="#l17.2092"></a><span id="l17.2092" class="difflineplus">+ * The top property; null for &quot;top&quot; anchors, non-null otherwise.</span>
<a href="#l17.2093"></a><span id="l17.2093" class="difflineplus">+ *</span>
<a href="#l17.2094"></a><span id="l17.2094" class="difflineplus">+ * @type number</span>
<a href="#l17.2095"></a><span id="l17.2095" class="difflineplus">+ * @name pv.Area.Anchor.prototype.top</span>
<a href="#l17.2096"></a><span id="l17.2096" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2097"></a><span id="l17.2097" class="difflineplus">+pv.Area.Anchor.prototype.$top = function() {</span>
<a href="#l17.2098"></a><span id="l17.2098" class="difflineplus">+  var area = this.anchorTarget();</span>
<a href="#l17.2099"></a><span id="l17.2099" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2100"></a><span id="l17.2100" class="difflineplus">+    case &quot;left&quot;:</span>
<a href="#l17.2101"></a><span id="l17.2101" class="difflineplus">+    case &quot;right&quot;:</span>
<a href="#l17.2102"></a><span id="l17.2102" class="difflineplus">+    case &quot;center&quot;: return area.top() + area.height() / 2;</span>
<a href="#l17.2103"></a><span id="l17.2103" class="difflineplus">+    case &quot;bottom&quot;: return area.top() + area.height();</span>
<a href="#l17.2104"></a><span id="l17.2104" class="difflineplus">+  }</span>
<a href="#l17.2105"></a><span id="l17.2105" class="difflineplus">+  return null;</span>
<a href="#l17.2106"></a><span id="l17.2106" class="difflineplus">+};</span>
<a href="#l17.2107"></a><span id="l17.2107" class="difflineplus">+</span>
<a href="#l17.2108"></a><span id="l17.2108" class="difflineplus">+/**</span>
<a href="#l17.2109"></a><span id="l17.2109" class="difflineplus">+ * The bottom property; null for &quot;bottom&quot; anchors, non-null otherwise.</span>
<a href="#l17.2110"></a><span id="l17.2110" class="difflineplus">+ *</span>
<a href="#l17.2111"></a><span id="l17.2111" class="difflineplus">+ * @type number</span>
<a href="#l17.2112"></a><span id="l17.2112" class="difflineplus">+ * @name pv.Area.Anchor.prototype.bottom</span>
<a href="#l17.2113"></a><span id="l17.2113" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2114"></a><span id="l17.2114" class="difflineplus">+pv.Area.Anchor.prototype.$bottom = function() {</span>
<a href="#l17.2115"></a><span id="l17.2115" class="difflineplus">+  var area = this.anchorTarget();</span>
<a href="#l17.2116"></a><span id="l17.2116" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2117"></a><span id="l17.2117" class="difflineplus">+    case &quot;left&quot;:</span>
<a href="#l17.2118"></a><span id="l17.2118" class="difflineplus">+    case &quot;right&quot;:</span>
<a href="#l17.2119"></a><span id="l17.2119" class="difflineplus">+    case &quot;center&quot;: return area.bottom() + area.height() / 2;</span>
<a href="#l17.2120"></a><span id="l17.2120" class="difflineplus">+    case &quot;top&quot;: return area.bottom() + area.height();</span>
<a href="#l17.2121"></a><span id="l17.2121" class="difflineplus">+  }</span>
<a href="#l17.2122"></a><span id="l17.2122" class="difflineplus">+  return null;</span>
<a href="#l17.2123"></a><span id="l17.2123" class="difflineplus">+};</span>
<a href="#l17.2124"></a><span id="l17.2124" class="difflineplus">+</span>
<a href="#l17.2125"></a><span id="l17.2125" class="difflineplus">+/**</span>
<a href="#l17.2126"></a><span id="l17.2126" class="difflineplus">+ * The text-align property, for horizontal alignment inside the area.</span>
<a href="#l17.2127"></a><span id="l17.2127" class="difflineplus">+ *</span>
<a href="#l17.2128"></a><span id="l17.2128" class="difflineplus">+ * @type string</span>
<a href="#l17.2129"></a><span id="l17.2129" class="difflineplus">+ * @name pv.Area.Anchor.prototype.textAlign</span>
<a href="#l17.2130"></a><span id="l17.2130" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2131"></a><span id="l17.2131" class="difflineplus">+pv.Area.Anchor.prototype.$textAlign = function() {</span>
<a href="#l17.2132"></a><span id="l17.2132" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2133"></a><span id="l17.2133" class="difflineplus">+    case &quot;left&quot;: return &quot;left&quot;;</span>
<a href="#l17.2134"></a><span id="l17.2134" class="difflineplus">+    case &quot;bottom&quot;:</span>
<a href="#l17.2135"></a><span id="l17.2135" class="difflineplus">+    case &quot;top&quot;:</span>
<a href="#l17.2136"></a><span id="l17.2136" class="difflineplus">+    case &quot;center&quot;: return &quot;center&quot;;</span>
<a href="#l17.2137"></a><span id="l17.2137" class="difflineplus">+    case &quot;right&quot;: return &quot;right&quot;;</span>
<a href="#l17.2138"></a><span id="l17.2138" class="difflineplus">+  }</span>
<a href="#l17.2139"></a><span id="l17.2139" class="difflineplus">+  return null;</span>
<a href="#l17.2140"></a><span id="l17.2140" class="difflineplus">+};</span>
<a href="#l17.2141"></a><span id="l17.2141" class="difflineplus">+</span>
<a href="#l17.2142"></a><span id="l17.2142" class="difflineplus">+/**</span>
<a href="#l17.2143"></a><span id="l17.2143" class="difflineplus">+ * The text-baseline property, for vertical alignment inside the area.</span>
<a href="#l17.2144"></a><span id="l17.2144" class="difflineplus">+ *</span>
<a href="#l17.2145"></a><span id="l17.2145" class="difflineplus">+ * @type string</span>
<a href="#l17.2146"></a><span id="l17.2146" class="difflineplus">+ * @name pv.Area.Anchor.prototype.textBasline</span>
<a href="#l17.2147"></a><span id="l17.2147" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2148"></a><span id="l17.2148" class="difflineplus">+pv.Area.Anchor.prototype.$textBaseline = function() {</span>
<a href="#l17.2149"></a><span id="l17.2149" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2150"></a><span id="l17.2150" class="difflineplus">+    case &quot;right&quot;:</span>
<a href="#l17.2151"></a><span id="l17.2151" class="difflineplus">+    case &quot;left&quot;:</span>
<a href="#l17.2152"></a><span id="l17.2152" class="difflineplus">+    case &quot;center&quot;: return &quot;middle&quot;;</span>
<a href="#l17.2153"></a><span id="l17.2153" class="difflineplus">+    case &quot;top&quot;: return &quot;top&quot;;</span>
<a href="#l17.2154"></a><span id="l17.2154" class="difflineplus">+    case &quot;bottom&quot;: return &quot;bottom&quot;;</span>
<a href="#l17.2155"></a><span id="l17.2155" class="difflineplus">+  }</span>
<a href="#l17.2156"></a><span id="l17.2156" class="difflineplus">+  return null;</span>
<a href="#l17.2157"></a><span id="l17.2157" class="difflineplus">+};</span>
<a href="#l17.2158"></a><span id="l17.2158" class="difflineplus">+</span>
<a href="#l17.2159"></a><span id="l17.2159" class="difflineplus">+/**</span>
<a href="#l17.2160"></a><span id="l17.2160" class="difflineplus">+ * Overrides the default behavior of {@link pv.Mark#buildImplied} such that the</span>
<a href="#l17.2161"></a><span id="l17.2161" class="difflineplus">+ * width and height are set to zero if null.</span>
<a href="#l17.2162"></a><span id="l17.2162" class="difflineplus">+ *</span>
<a href="#l17.2163"></a><span id="l17.2163" class="difflineplus">+ * @param s a node in the scene graph; the instance of the mark to build.</span>
<a href="#l17.2164"></a><span id="l17.2164" class="difflineplus">+ */</span>
<a href="#l17.2165"></a><span id="l17.2165" class="difflineplus">+pv.Area.prototype.buildImplied = function(s) {</span>
<a href="#l17.2166"></a><span id="l17.2166" class="difflineplus">+  if (s.height == null) s.height = 0;</span>
<a href="#l17.2167"></a><span id="l17.2167" class="difflineplus">+  if (s.width == null) s.width = 0;</span>
<a href="#l17.2168"></a><span id="l17.2168" class="difflineplus">+  pv.Mark.prototype.buildImplied.call(this, s);</span>
<a href="#l17.2169"></a><span id="l17.2169" class="difflineplus">+};</span>
<a href="#l17.2170"></a><span id="l17.2170" class="difflineplus">+</span>
<a href="#l17.2171"></a><span id="l17.2171" class="difflineplus">+/**</span>
<a href="#l17.2172"></a><span id="l17.2172" class="difflineplus">+ * Override the default update implementation, since the area mark generates a</span>
<a href="#l17.2173"></a><span id="l17.2173" class="difflineplus">+ * single graphical element rather than multiple distinct elements.</span>
<a href="#l17.2174"></a><span id="l17.2174" class="difflineplus">+ */</span>
<a href="#l17.2175"></a><span id="l17.2175" class="difflineplus">+pv.Area.prototype.update = function() {</span>
<a href="#l17.2176"></a><span id="l17.2176" class="difflineplus">+  if (!this.scene.length) return;</span>
<a href="#l17.2177"></a><span id="l17.2177" class="difflineplus">+</span>
<a href="#l17.2178"></a><span id="l17.2178" class="difflineplus">+  var s = this.scene[0], v = s.svg;</span>
<a href="#l17.2179"></a><span id="l17.2179" class="difflineplus">+  if (s.visible) {</span>
<a href="#l17.2180"></a><span id="l17.2180" class="difflineplus">+</span>
<a href="#l17.2181"></a><span id="l17.2181" class="difflineplus">+    /* Create the &lt;svg:polygon&gt; element, if necesary. */</span>
<a href="#l17.2182"></a><span id="l17.2182" class="difflineplus">+    if (!v) {</span>
<a href="#l17.2183"></a><span id="l17.2183" class="difflineplus">+      v = s.svg = document.createElementNS(pv.ns.svg, &quot;polygon&quot;);</span>
<a href="#l17.2184"></a><span id="l17.2184" class="difflineplus">+      s.parent.svg.appendChild(v);</span>
<a href="#l17.2185"></a><span id="l17.2185" class="difflineplus">+    }</span>
<a href="#l17.2186"></a><span id="l17.2186" class="difflineplus">+</span>
<a href="#l17.2187"></a><span id="l17.2187" class="difflineplus">+    /* points */</span>
<a href="#l17.2188"></a><span id="l17.2188" class="difflineplus">+    var p = &quot;&quot;;</span>
<a href="#l17.2189"></a><span id="l17.2189" class="difflineplus">+    for (var i = 0; i &lt; this.scene.length; i++) {</span>
<a href="#l17.2190"></a><span id="l17.2190" class="difflineplus">+      var si = this.scene[i];</span>
<a href="#l17.2191"></a><span id="l17.2191" class="difflineplus">+      p += si.left + &quot;,&quot; + si.top + &quot; &quot;;</span>
<a href="#l17.2192"></a><span id="l17.2192" class="difflineplus">+    }</span>
<a href="#l17.2193"></a><span id="l17.2193" class="difflineplus">+    for (var i = this.scene.length - 1; i &gt;= 0; i--) {</span>
<a href="#l17.2194"></a><span id="l17.2194" class="difflineplus">+      var si = this.scene[i];</span>
<a href="#l17.2195"></a><span id="l17.2195" class="difflineplus">+      p += (si.left + si.width) + &quot;,&quot; + (si.top + si.height) + &quot; &quot;;</span>
<a href="#l17.2196"></a><span id="l17.2196" class="difflineplus">+    }</span>
<a href="#l17.2197"></a><span id="l17.2197" class="difflineplus">+    v.setAttribute(&quot;points&quot;, p);</span>
<a href="#l17.2198"></a><span id="l17.2198" class="difflineplus">+  }</span>
<a href="#l17.2199"></a><span id="l17.2199" class="difflineplus">+</span>
<a href="#l17.2200"></a><span id="l17.2200" class="difflineplus">+  this.updateInstance(s);</span>
<a href="#l17.2201"></a><span id="l17.2201" class="difflineplus">+};</span>
<a href="#l17.2202"></a><span id="l17.2202" class="difflineplus">+</span>
<a href="#l17.2203"></a><span id="l17.2203" class="difflineplus">+/**</span>
<a href="#l17.2204"></a><span id="l17.2204" class="difflineplus">+ * Updates the display for the (singleton) area instance. The area mark</span>
<a href="#l17.2205"></a><span id="l17.2205" class="difflineplus">+ * generates a single graphical element rather than multiple distinct elements.</span>
<a href="#l17.2206"></a><span id="l17.2206" class="difflineplus">+ *</span>
<a href="#l17.2207"></a><span id="l17.2207" class="difflineplus">+ * &lt;p&gt;TODO Recompute points? For efficiency, the points (the span positions) are</span>
<a href="#l17.2208"></a><span id="l17.2208" class="difflineplus">+ * not recomputed, and therefore cannot be updated automatically from event</span>
<a href="#l17.2209"></a><span id="l17.2209" class="difflineplus">+ * handlers without an explicit call to rebuild the area.</span>
<a href="#l17.2210"></a><span id="l17.2210" class="difflineplus">+ *</span>
<a href="#l17.2211"></a><span id="l17.2211" class="difflineplus">+ * @param s a node in the scene graph; the area to update.</span>
<a href="#l17.2212"></a><span id="l17.2212" class="difflineplus">+ */</span>
<a href="#l17.2213"></a><span id="l17.2213" class="difflineplus">+pv.Area.prototype.updateInstance = function(s) {</span>
<a href="#l17.2214"></a><span id="l17.2214" class="difflineplus">+  var v = s.svg;</span>
<a href="#l17.2215"></a><span id="l17.2215" class="difflineplus">+</span>
<a href="#l17.2216"></a><span id="l17.2216" class="difflineplus">+  pv.Mark.prototype.updateInstance.call(this, s);</span>
<a href="#l17.2217"></a><span id="l17.2217" class="difflineplus">+  if (!s.visible) return;</span>
<a href="#l17.2218"></a><span id="l17.2218" class="difflineplus">+</span>
<a href="#l17.2219"></a><span id="l17.2219" class="difflineplus">+  /* fill, stroke TODO gradient, patterns */</span>
<a href="#l17.2220"></a><span id="l17.2220" class="difflineplus">+  var fill = pv.color(s.fillStyle);</span>
<a href="#l17.2221"></a><span id="l17.2221" class="difflineplus">+  v.setAttribute(&quot;fill&quot;, fill.color);</span>
<a href="#l17.2222"></a><span id="l17.2222" class="difflineplus">+  v.setAttribute(&quot;fill-opacity&quot;, fill.opacity);</span>
<a href="#l17.2223"></a><span id="l17.2223" class="difflineplus">+  var stroke = pv.color(s.strokeStyle);</span>
<a href="#l17.2224"></a><span id="l17.2224" class="difflineplus">+  v.setAttribute(&quot;stroke&quot;, stroke.color);</span>
<a href="#l17.2225"></a><span id="l17.2225" class="difflineplus">+  v.setAttribute(&quot;stroke-opacity&quot;, stroke.opacity);</span>
<a href="#l17.2226"></a><span id="l17.2226" class="difflineplus">+  v.setAttribute(&quot;stroke-width&quot;, s.lineWidth);</span>
<a href="#l17.2227"></a><span id="l17.2227" class="difflineplus">+};</span>
<a href="#l17.2228"></a><span id="l17.2228" class="difflineplus">+/**</span>
<a href="#l17.2229"></a><span id="l17.2229" class="difflineplus">+ * Constructs a new bar mark with default properties. Bars are not typically</span>
<a href="#l17.2230"></a><span id="l17.2230" class="difflineplus">+ * constructed directly, but by adding to a panel or an existing mark via</span>
<a href="#l17.2231"></a><span id="l17.2231" class="difflineplus">+ * {@link pv.Mark#add}.</span>
<a href="#l17.2232"></a><span id="l17.2232" class="difflineplus">+ *</span>
<a href="#l17.2233"></a><span id="l17.2233" class="difflineplus">+ * @class Represents a bar: an axis-aligned rectangle that can be stroked and</span>
<a href="#l17.2234"></a><span id="l17.2234" class="difflineplus">+ * filled. Bars are used for many chart types, including bar charts, histograms</span>
<a href="#l17.2235"></a><span id="l17.2235" class="difflineplus">+ * and Gantt charts. Bars can also be used as decorations, for example to draw a</span>
<a href="#l17.2236"></a><span id="l17.2236" class="difflineplus">+ * frame border around a panel; in fact, a panel is a special type (a subclass)</span>
<a href="#l17.2237"></a><span id="l17.2237" class="difflineplus">+ * of bar.</span>
<a href="#l17.2238"></a><span id="l17.2238" class="difflineplus">+ *</span>
<a href="#l17.2239"></a><span id="l17.2239" class="difflineplus">+ * &lt;p&gt;Bars can be positioned in several ways. Most commonly, one of the four</span>
<a href="#l17.2240"></a><span id="l17.2240" class="difflineplus">+ * corners is fixed using two margins, and then the width and height properties</span>
<a href="#l17.2241"></a><span id="l17.2241" class="difflineplus">+ * determine the extent of the bar relative to this fixed location. For example,</span>
<a href="#l17.2242"></a><span id="l17.2242" class="difflineplus">+ * using the bottom and left properties fixes the bottom-left corner; the width</span>
<a href="#l17.2243"></a><span id="l17.2243" class="difflineplus">+ * then extends to the right, while the height extends to the top. As an</span>
<a href="#l17.2244"></a><span id="l17.2244" class="difflineplus">+ * alternative to the four corners, a bar can be positioned exclusively using</span>
<a href="#l17.2245"></a><span id="l17.2245" class="difflineplus">+ * margins; this is convenient as an inset from the containing panel, for</span>
<a href="#l17.2246"></a><span id="l17.2246" class="difflineplus">+ * example. See {@link pv.Mark#buildImplied} for details on the prioritization</span>
<a href="#l17.2247"></a><span id="l17.2247" class="difflineplus">+ * of redundant positioning properties.</span>
<a href="#l17.2248"></a><span id="l17.2248" class="difflineplus">+ *</span>
<a href="#l17.2249"></a><span id="l17.2249" class="difflineplus">+ * &lt;p&gt;See also the &lt;a href=&quot;../../api/Bar.html&quot;&gt;Bar guide&lt;/a&gt;.</span>
<a href="#l17.2250"></a><span id="l17.2250" class="difflineplus">+ *</span>
<a href="#l17.2251"></a><span id="l17.2251" class="difflineplus">+ * @extends pv.Mark</span>
<a href="#l17.2252"></a><span id="l17.2252" class="difflineplus">+ */</span>
<a href="#l17.2253"></a><span id="l17.2253" class="difflineplus">+pv.Bar = function() {</span>
<a href="#l17.2254"></a><span id="l17.2254" class="difflineplus">+  pv.Mark.call(this);</span>
<a href="#l17.2255"></a><span id="l17.2255" class="difflineplus">+};</span>
<a href="#l17.2256"></a><span id="l17.2256" class="difflineplus">+pv.Bar.prototype = pv.extend(pv.Mark);</span>
<a href="#l17.2257"></a><span id="l17.2257" class="difflineplus">+pv.Bar.prototype.type = pv.Bar;</span>
<a href="#l17.2258"></a><span id="l17.2258" class="difflineplus">+</span>
<a href="#l17.2259"></a><span id="l17.2259" class="difflineplus">+/**</span>
<a href="#l17.2260"></a><span id="l17.2260" class="difflineplus">+ * Returns &quot;bar&quot;.</span>
<a href="#l17.2261"></a><span id="l17.2261" class="difflineplus">+ *</span>
<a href="#l17.2262"></a><span id="l17.2262" class="difflineplus">+ * @returns {string} &quot;bar&quot;.</span>
<a href="#l17.2263"></a><span id="l17.2263" class="difflineplus">+ */</span>
<a href="#l17.2264"></a><span id="l17.2264" class="difflineplus">+pv.Bar.toString = function() { return &quot;bar&quot;; };</span>
<a href="#l17.2265"></a><span id="l17.2265" class="difflineplus">+</span>
<a href="#l17.2266"></a><span id="l17.2266" class="difflineplus">+/**</span>
<a href="#l17.2267"></a><span id="l17.2267" class="difflineplus">+ * The width of the bar, in pixels. If the left position is specified, the bar</span>
<a href="#l17.2268"></a><span id="l17.2268" class="difflineplus">+ * extends rightward from the left edge; if the right position is specified, the</span>
<a href="#l17.2269"></a><span id="l17.2269" class="difflineplus">+ * bar extends leftward from the right edge.</span>
<a href="#l17.2270"></a><span id="l17.2270" class="difflineplus">+ *</span>
<a href="#l17.2271"></a><span id="l17.2271" class="difflineplus">+ * @type number</span>
<a href="#l17.2272"></a><span id="l17.2272" class="difflineplus">+ * @name pv.Bar.prototype.width</span>
<a href="#l17.2273"></a><span id="l17.2273" class="difflineplus">+ */</span>
<a href="#l17.2274"></a><span id="l17.2274" class="difflineplus">+pv.Bar.prototype.defineProperty(&quot;width&quot;);</span>
<a href="#l17.2275"></a><span id="l17.2275" class="difflineplus">+</span>
<a href="#l17.2276"></a><span id="l17.2276" class="difflineplus">+/**</span>
<a href="#l17.2277"></a><span id="l17.2277" class="difflineplus">+ * The height of the bar, in pixels. If the bottom position is specified, the</span>
<a href="#l17.2278"></a><span id="l17.2278" class="difflineplus">+ * bar extends upward from the bottom edge; if the top position is specified,</span>
<a href="#l17.2279"></a><span id="l17.2279" class="difflineplus">+ * the bar extends downward from the top edge.</span>
<a href="#l17.2280"></a><span id="l17.2280" class="difflineplus">+ *</span>
<a href="#l17.2281"></a><span id="l17.2281" class="difflineplus">+ * @type number</span>
<a href="#l17.2282"></a><span id="l17.2282" class="difflineplus">+ * @name pv.Bar.prototype.height</span>
<a href="#l17.2283"></a><span id="l17.2283" class="difflineplus">+ */</span>
<a href="#l17.2284"></a><span id="l17.2284" class="difflineplus">+pv.Bar.prototype.defineProperty(&quot;height&quot;);</span>
<a href="#l17.2285"></a><span id="l17.2285" class="difflineplus">+</span>
<a href="#l17.2286"></a><span id="l17.2286" class="difflineplus">+/**</span>
<a href="#l17.2287"></a><span id="l17.2287" class="difflineplus">+ * The width of stroked lines, in pixels; used in conjunction with</span>
<a href="#l17.2288"></a><span id="l17.2288" class="difflineplus">+ * &lt;tt&gt;strokeStyle&lt;/tt&gt; to stroke the bar's border.</span>
<a href="#l17.2289"></a><span id="l17.2289" class="difflineplus">+ *</span>
<a href="#l17.2290"></a><span id="l17.2290" class="difflineplus">+ * @type number</span>
<a href="#l17.2291"></a><span id="l17.2291" class="difflineplus">+ * @name pv.Bar.prototype.lineWidth</span>
<a href="#l17.2292"></a><span id="l17.2292" class="difflineplus">+ */</span>
<a href="#l17.2293"></a><span id="l17.2293" class="difflineplus">+pv.Bar.prototype.defineProperty(&quot;lineWidth&quot;);</span>
<a href="#l17.2294"></a><span id="l17.2294" class="difflineplus">+</span>
<a href="#l17.2295"></a><span id="l17.2295" class="difflineplus">+/**</span>
<a href="#l17.2296"></a><span id="l17.2296" class="difflineplus">+ * The style of stroked lines; used in conjunction with &lt;tt&gt;lineWidth&lt;/tt&gt; to</span>
<a href="#l17.2297"></a><span id="l17.2297" class="difflineplus">+ * stroke the bar's border. The default value of this property is null, meaning</span>
<a href="#l17.2298"></a><span id="l17.2298" class="difflineplus">+ * bars are not stroked by default.</span>
<a href="#l17.2299"></a><span id="l17.2299" class="difflineplus">+ *</span>
<a href="#l17.2300"></a><span id="l17.2300" class="difflineplus">+ * @type string</span>
<a href="#l17.2301"></a><span id="l17.2301" class="difflineplus">+ * @name pv.Bar.prototype.strokeStyle</span>
<a href="#l17.2302"></a><span id="l17.2302" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.2303"></a><span id="l17.2303" class="difflineplus">+ */</span>
<a href="#l17.2304"></a><span id="l17.2304" class="difflineplus">+pv.Bar.prototype.defineProperty(&quot;strokeStyle&quot;);</span>
<a href="#l17.2305"></a><span id="l17.2305" class="difflineplus">+</span>
<a href="#l17.2306"></a><span id="l17.2306" class="difflineplus">+/**</span>
<a href="#l17.2307"></a><span id="l17.2307" class="difflineplus">+ * The bar fill style; if non-null, the interior of the bar is filled with the</span>
<a href="#l17.2308"></a><span id="l17.2308" class="difflineplus">+ * specified color. The default value of this property is a categorical color.</span>
<a href="#l17.2309"></a><span id="l17.2309" class="difflineplus">+ *</span>
<a href="#l17.2310"></a><span id="l17.2310" class="difflineplus">+ * @type string</span>
<a href="#l17.2311"></a><span id="l17.2311" class="difflineplus">+ * @name pv.Bar.prototype.fillStyle</span>
<a href="#l17.2312"></a><span id="l17.2312" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.2313"></a><span id="l17.2313" class="difflineplus">+ */</span>
<a href="#l17.2314"></a><span id="l17.2314" class="difflineplus">+pv.Bar.prototype.defineProperty(&quot;fillStyle&quot;);</span>
<a href="#l17.2315"></a><span id="l17.2315" class="difflineplus">+</span>
<a href="#l17.2316"></a><span id="l17.2316" class="difflineplus">+/**</span>
<a href="#l17.2317"></a><span id="l17.2317" class="difflineplus">+ * Default properties for bars. By default, there is no stroke and the fill</span>
<a href="#l17.2318"></a><span id="l17.2318" class="difflineplus">+ * style is a categorical color.</span>
<a href="#l17.2319"></a><span id="l17.2319" class="difflineplus">+ *</span>
<a href="#l17.2320"></a><span id="l17.2320" class="difflineplus">+ * @type pv.Bar</span>
<a href="#l17.2321"></a><span id="l17.2321" class="difflineplus">+ */</span>
<a href="#l17.2322"></a><span id="l17.2322" class="difflineplus">+pv.Bar.defaults = new pv.Bar().extend(pv.Mark.defaults)</span>
<a href="#l17.2323"></a><span id="l17.2323" class="difflineplus">+    .lineWidth(1.5)</span>
<a href="#l17.2324"></a><span id="l17.2324" class="difflineplus">+    .fillStyle(pv.Colors.category20);</span>
<a href="#l17.2325"></a><span id="l17.2325" class="difflineplus">+</span>
<a href="#l17.2326"></a><span id="l17.2326" class="difflineplus">+/**</span>
<a href="#l17.2327"></a><span id="l17.2327" class="difflineplus">+ * Constructs a new bar anchor with default properties.</span>
<a href="#l17.2328"></a><span id="l17.2328" class="difflineplus">+ *</span>
<a href="#l17.2329"></a><span id="l17.2329" class="difflineplus">+ * @class Represents an anchor for a bar mark. Bars support five different</span>
<a href="#l17.2330"></a><span id="l17.2330" class="difflineplus">+ * anchors:&lt;ul&gt;</span>
<a href="#l17.2331"></a><span id="l17.2331" class="difflineplus">+ *</span>
<a href="#l17.2332"></a><span id="l17.2332" class="difflineplus">+ * &lt;li&gt;top</span>
<a href="#l17.2333"></a><span id="l17.2333" class="difflineplus">+ * &lt;li&gt;left</span>
<a href="#l17.2334"></a><span id="l17.2334" class="difflineplus">+ * &lt;li&gt;center</span>
<a href="#l17.2335"></a><span id="l17.2335" class="difflineplus">+ * &lt;li&gt;bottom</span>
<a href="#l17.2336"></a><span id="l17.2336" class="difflineplus">+ * &lt;li&gt;right</span>
<a href="#l17.2337"></a><span id="l17.2337" class="difflineplus">+ *</span>
<a href="#l17.2338"></a><span id="l17.2338" class="difflineplus">+ * &lt;/ul&gt;In addition to positioning properties (left, right, top bottom), the</span>
<a href="#l17.2339"></a><span id="l17.2339" class="difflineplus">+ * anchors support text rendering properties (text-align, text-baseline). Text</span>
<a href="#l17.2340"></a><span id="l17.2340" class="difflineplus">+ * is rendered to appear inside the bar.</span>
<a href="#l17.2341"></a><span id="l17.2341" class="difflineplus">+ *</span>
<a href="#l17.2342"></a><span id="l17.2342" class="difflineplus">+ * &lt;p&gt;To facilitate stacking of bars, the anchors are defined in terms of their</span>
<a href="#l17.2343"></a><span id="l17.2343" class="difflineplus">+ * opposite edge. For example, the top anchor defines the bottom property, such</span>
<a href="#l17.2344"></a><span id="l17.2344" class="difflineplus">+ * that the bar grows upwards; the bottom anchor instead defines the top</span>
<a href="#l17.2345"></a><span id="l17.2345" class="difflineplus">+ * property, such that the bar grows downwards. Of course, in general it is more</span>
<a href="#l17.2346"></a><span id="l17.2346" class="difflineplus">+ * robust to use panels and the cousin accessor to define stacked bars; see</span>
<a href="#l17.2347"></a><span id="l17.2347" class="difflineplus">+ * {@link pv.Mark#scene} for an example.</span>
<a href="#l17.2348"></a><span id="l17.2348" class="difflineplus">+ *</span>
<a href="#l17.2349"></a><span id="l17.2349" class="difflineplus">+ * &lt;p&gt;Bar anchors also &quot;smartly&quot; specify position properties based on whether</span>
<a href="#l17.2350"></a><span id="l17.2350" class="difflineplus">+ * the derived mark type supports the width and height properties. If the</span>
<a href="#l17.2351"></a><span id="l17.2351" class="difflineplus">+ * derived mark type does not support these properties (e.g., dots), the</span>
<a href="#l17.2352"></a><span id="l17.2352" class="difflineplus">+ * position will be centered on the corresponding edge. Otherwise (e.g., bars),</span>
<a href="#l17.2353"></a><span id="l17.2353" class="difflineplus">+ * the position will be in the opposite side.</span>
<a href="#l17.2354"></a><span id="l17.2354" class="difflineplus">+ *</span>
<a href="#l17.2355"></a><span id="l17.2355" class="difflineplus">+ * @extends pv.Mark.Anchor</span>
<a href="#l17.2356"></a><span id="l17.2356" class="difflineplus">+ */</span>
<a href="#l17.2357"></a><span id="l17.2357" class="difflineplus">+pv.Bar.Anchor = function() {</span>
<a href="#l17.2358"></a><span id="l17.2358" class="difflineplus">+  pv.Mark.Anchor.call(this);</span>
<a href="#l17.2359"></a><span id="l17.2359" class="difflineplus">+};</span>
<a href="#l17.2360"></a><span id="l17.2360" class="difflineplus">+pv.Bar.Anchor.prototype = pv.extend(pv.Mark.Anchor);</span>
<a href="#l17.2361"></a><span id="l17.2361" class="difflineplus">+pv.Bar.Anchor.prototype.type = pv.Bar;</span>
<a href="#l17.2362"></a><span id="l17.2362" class="difflineplus">+</span>
<a href="#l17.2363"></a><span id="l17.2363" class="difflineplus">+/**</span>
<a href="#l17.2364"></a><span id="l17.2364" class="difflineplus">+ * The left property; null for &quot;left&quot; anchors, non-null otherwise.</span>
<a href="#l17.2365"></a><span id="l17.2365" class="difflineplus">+ *</span>
<a href="#l17.2366"></a><span id="l17.2366" class="difflineplus">+ * @type number</span>
<a href="#l17.2367"></a><span id="l17.2367" class="difflineplus">+ * @name pv.Bar.Anchor.prototype.left</span>
<a href="#l17.2368"></a><span id="l17.2368" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2369"></a><span id="l17.2369" class="difflineplus">+pv.Bar.Anchor.prototype.$left = function() {</span>
<a href="#l17.2370"></a><span id="l17.2370" class="difflineplus">+  var bar = this.anchorTarget();</span>
<a href="#l17.2371"></a><span id="l17.2371" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2372"></a><span id="l17.2372" class="difflineplus">+    case &quot;bottom&quot;:</span>
<a href="#l17.2373"></a><span id="l17.2373" class="difflineplus">+    case &quot;top&quot;:</span>
<a href="#l17.2374"></a><span id="l17.2374" class="difflineplus">+    case &quot;center&quot;: return bar.left() + (this.type.prototype.width ? 0 : (bar.width() / 2));</span>
<a href="#l17.2375"></a><span id="l17.2375" class="difflineplus">+    case &quot;right&quot;: return bar.left() + bar.width();</span>
<a href="#l17.2376"></a><span id="l17.2376" class="difflineplus">+  }</span>
<a href="#l17.2377"></a><span id="l17.2377" class="difflineplus">+  return null;</span>
<a href="#l17.2378"></a><span id="l17.2378" class="difflineplus">+};</span>
<a href="#l17.2379"></a><span id="l17.2379" class="difflineplus">+</span>
<a href="#l17.2380"></a><span id="l17.2380" class="difflineplus">+/**</span>
<a href="#l17.2381"></a><span id="l17.2381" class="difflineplus">+ * The right property; null for &quot;right&quot; anchors, non-null otherwise.</span>
<a href="#l17.2382"></a><span id="l17.2382" class="difflineplus">+ *</span>
<a href="#l17.2383"></a><span id="l17.2383" class="difflineplus">+ * @type number</span>
<a href="#l17.2384"></a><span id="l17.2384" class="difflineplus">+ * @name pv.Bar.Anchor.prototype.right</span>
<a href="#l17.2385"></a><span id="l17.2385" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2386"></a><span id="l17.2386" class="difflineplus">+pv.Bar.Anchor.prototype.$right = function() {</span>
<a href="#l17.2387"></a><span id="l17.2387" class="difflineplus">+  var bar = this.anchorTarget();</span>
<a href="#l17.2388"></a><span id="l17.2388" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2389"></a><span id="l17.2389" class="difflineplus">+    case &quot;bottom&quot;:</span>
<a href="#l17.2390"></a><span id="l17.2390" class="difflineplus">+    case &quot;top&quot;:</span>
<a href="#l17.2391"></a><span id="l17.2391" class="difflineplus">+    case &quot;center&quot;: return bar.right() + (this.type.prototype.width ? 0 : (bar.width() / 2));</span>
<a href="#l17.2392"></a><span id="l17.2392" class="difflineplus">+    case &quot;left&quot;: return bar.right() + bar.width();</span>
<a href="#l17.2393"></a><span id="l17.2393" class="difflineplus">+  }</span>
<a href="#l17.2394"></a><span id="l17.2394" class="difflineplus">+  return null;</span>
<a href="#l17.2395"></a><span id="l17.2395" class="difflineplus">+};</span>
<a href="#l17.2396"></a><span id="l17.2396" class="difflineplus">+</span>
<a href="#l17.2397"></a><span id="l17.2397" class="difflineplus">+/**</span>
<a href="#l17.2398"></a><span id="l17.2398" class="difflineplus">+ * The top property; null for &quot;top&quot; anchors, non-null otherwise.</span>
<a href="#l17.2399"></a><span id="l17.2399" class="difflineplus">+ *</span>
<a href="#l17.2400"></a><span id="l17.2400" class="difflineplus">+ * @type number</span>
<a href="#l17.2401"></a><span id="l17.2401" class="difflineplus">+ * @name pv.Bar.Anchor.prototype.top</span>
<a href="#l17.2402"></a><span id="l17.2402" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2403"></a><span id="l17.2403" class="difflineplus">+pv.Bar.Anchor.prototype.$top = function() {</span>
<a href="#l17.2404"></a><span id="l17.2404" class="difflineplus">+  var bar = this.anchorTarget();</span>
<a href="#l17.2405"></a><span id="l17.2405" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2406"></a><span id="l17.2406" class="difflineplus">+    case &quot;left&quot;:</span>
<a href="#l17.2407"></a><span id="l17.2407" class="difflineplus">+    case &quot;right&quot;:</span>
<a href="#l17.2408"></a><span id="l17.2408" class="difflineplus">+    case &quot;center&quot;: return bar.top() + (this.type.prototype.height ? 0 : (bar.height() / 2));</span>
<a href="#l17.2409"></a><span id="l17.2409" class="difflineplus">+    case &quot;bottom&quot;: return bar.top() + bar.height();</span>
<a href="#l17.2410"></a><span id="l17.2410" class="difflineplus">+  }</span>
<a href="#l17.2411"></a><span id="l17.2411" class="difflineplus">+  return null;</span>
<a href="#l17.2412"></a><span id="l17.2412" class="difflineplus">+};</span>
<a href="#l17.2413"></a><span id="l17.2413" class="difflineplus">+</span>
<a href="#l17.2414"></a><span id="l17.2414" class="difflineplus">+/**</span>
<a href="#l17.2415"></a><span id="l17.2415" class="difflineplus">+ * The bottom property; null for &quot;bottom&quot; anchors, non-null otherwise.</span>
<a href="#l17.2416"></a><span id="l17.2416" class="difflineplus">+ *</span>
<a href="#l17.2417"></a><span id="l17.2417" class="difflineplus">+ * @type number</span>
<a href="#l17.2418"></a><span id="l17.2418" class="difflineplus">+ * @name pv.Bar.Anchor.prototype.bottom</span>
<a href="#l17.2419"></a><span id="l17.2419" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2420"></a><span id="l17.2420" class="difflineplus">+pv.Bar.Anchor.prototype.$bottom = function() {</span>
<a href="#l17.2421"></a><span id="l17.2421" class="difflineplus">+  var bar = this.anchorTarget();</span>
<a href="#l17.2422"></a><span id="l17.2422" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2423"></a><span id="l17.2423" class="difflineplus">+    case &quot;left&quot;:</span>
<a href="#l17.2424"></a><span id="l17.2424" class="difflineplus">+    case &quot;right&quot;:</span>
<a href="#l17.2425"></a><span id="l17.2425" class="difflineplus">+    case &quot;center&quot;: return bar.bottom() + (this.type.prototype.height ? 0 : (bar.height() / 2));</span>
<a href="#l17.2426"></a><span id="l17.2426" class="difflineplus">+    case &quot;top&quot;: return bar.bottom() + bar.height();</span>
<a href="#l17.2427"></a><span id="l17.2427" class="difflineplus">+  }</span>
<a href="#l17.2428"></a><span id="l17.2428" class="difflineplus">+  return null;</span>
<a href="#l17.2429"></a><span id="l17.2429" class="difflineplus">+};</span>
<a href="#l17.2430"></a><span id="l17.2430" class="difflineplus">+</span>
<a href="#l17.2431"></a><span id="l17.2431" class="difflineplus">+/**</span>
<a href="#l17.2432"></a><span id="l17.2432" class="difflineplus">+ * The text-align property, for horizontal alignment inside the bar.</span>
<a href="#l17.2433"></a><span id="l17.2433" class="difflineplus">+ *</span>
<a href="#l17.2434"></a><span id="l17.2434" class="difflineplus">+ * @type string</span>
<a href="#l17.2435"></a><span id="l17.2435" class="difflineplus">+ * @name pv.Bar.Anchor.prototype.textAlign</span>
<a href="#l17.2436"></a><span id="l17.2436" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2437"></a><span id="l17.2437" class="difflineplus">+pv.Bar.Anchor.prototype.$textAlign = function() {</span>
<a href="#l17.2438"></a><span id="l17.2438" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2439"></a><span id="l17.2439" class="difflineplus">+    case &quot;left&quot;: return &quot;left&quot;;</span>
<a href="#l17.2440"></a><span id="l17.2440" class="difflineplus">+    case &quot;bottom&quot;:</span>
<a href="#l17.2441"></a><span id="l17.2441" class="difflineplus">+    case &quot;top&quot;:</span>
<a href="#l17.2442"></a><span id="l17.2442" class="difflineplus">+    case &quot;center&quot;: return &quot;center&quot;;</span>
<a href="#l17.2443"></a><span id="l17.2443" class="difflineplus">+    case &quot;right&quot;: return &quot;right&quot;;</span>
<a href="#l17.2444"></a><span id="l17.2444" class="difflineplus">+  }</span>
<a href="#l17.2445"></a><span id="l17.2445" class="difflineplus">+  return null;</span>
<a href="#l17.2446"></a><span id="l17.2446" class="difflineplus">+};</span>
<a href="#l17.2447"></a><span id="l17.2447" class="difflineplus">+</span>
<a href="#l17.2448"></a><span id="l17.2448" class="difflineplus">+/**</span>
<a href="#l17.2449"></a><span id="l17.2449" class="difflineplus">+ * The text-baseline property, for vertical alignment inside the bar.</span>
<a href="#l17.2450"></a><span id="l17.2450" class="difflineplus">+ *</span>
<a href="#l17.2451"></a><span id="l17.2451" class="difflineplus">+ * @type string</span>
<a href="#l17.2452"></a><span id="l17.2452" class="difflineplus">+ * @name pv.Bar.Anchor.prototype.textBaseline</span>
<a href="#l17.2453"></a><span id="l17.2453" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2454"></a><span id="l17.2454" class="difflineplus">+pv.Bar.Anchor.prototype.$textBaseline = function() {</span>
<a href="#l17.2455"></a><span id="l17.2455" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2456"></a><span id="l17.2456" class="difflineplus">+    case &quot;right&quot;:</span>
<a href="#l17.2457"></a><span id="l17.2457" class="difflineplus">+    case &quot;left&quot;:</span>
<a href="#l17.2458"></a><span id="l17.2458" class="difflineplus">+    case &quot;center&quot;: return &quot;middle&quot;;</span>
<a href="#l17.2459"></a><span id="l17.2459" class="difflineplus">+    case &quot;top&quot;: return &quot;top&quot;;</span>
<a href="#l17.2460"></a><span id="l17.2460" class="difflineplus">+    case &quot;bottom&quot;: return &quot;bottom&quot;;</span>
<a href="#l17.2461"></a><span id="l17.2461" class="difflineplus">+  }</span>
<a href="#l17.2462"></a><span id="l17.2462" class="difflineplus">+  return null;</span>
<a href="#l17.2463"></a><span id="l17.2463" class="difflineplus">+};</span>
<a href="#l17.2464"></a><span id="l17.2464" class="difflineplus">+</span>
<a href="#l17.2465"></a><span id="l17.2465" class="difflineplus">+/**</span>
<a href="#l17.2466"></a><span id="l17.2466" class="difflineplus">+ * Updates the display for the specified bar instance &lt;tt&gt;s&lt;/tt&gt; in the scene</span>
<a href="#l17.2467"></a><span id="l17.2467" class="difflineplus">+ * graph. This implementation handles the fill and stroke style for the bar, as</span>
<a href="#l17.2468"></a><span id="l17.2468" class="difflineplus">+ * well as positional properties.</span>
<a href="#l17.2469"></a><span id="l17.2469" class="difflineplus">+ *</span>
<a href="#l17.2470"></a><span id="l17.2470" class="difflineplus">+ * @param s a node in the scene graph; the instance of the bar to update.</span>
<a href="#l17.2471"></a><span id="l17.2471" class="difflineplus">+ */</span>
<a href="#l17.2472"></a><span id="l17.2472" class="difflineplus">+pv.Bar.prototype.updateInstance = function(s) {</span>
<a href="#l17.2473"></a><span id="l17.2473" class="difflineplus">+  var v = s.svg;</span>
<a href="#l17.2474"></a><span id="l17.2474" class="difflineplus">+  if (s.visible &amp;&amp; !v) {</span>
<a href="#l17.2475"></a><span id="l17.2475" class="difflineplus">+    v = s.svg = document.createElementNS(pv.ns.svg, &quot;rect&quot;);</span>
<a href="#l17.2476"></a><span id="l17.2476" class="difflineplus">+    s.parent.svg.appendChild(v);</span>
<a href="#l17.2477"></a><span id="l17.2477" class="difflineplus">+  }</span>
<a href="#l17.2478"></a><span id="l17.2478" class="difflineplus">+</span>
<a href="#l17.2479"></a><span id="l17.2479" class="difflineplus">+  pv.Mark.prototype.updateInstance.call(this, s);</span>
<a href="#l17.2480"></a><span id="l17.2480" class="difflineplus">+  if (!s.visible) return;</span>
<a href="#l17.2481"></a><span id="l17.2481" class="difflineplus">+</span>
<a href="#l17.2482"></a><span id="l17.2482" class="difflineplus">+  /* left, top */</span>
<a href="#l17.2483"></a><span id="l17.2483" class="difflineplus">+  v.setAttribute(&quot;x&quot;, s.left);</span>
<a href="#l17.2484"></a><span id="l17.2484" class="difflineplus">+  v.setAttribute(&quot;y&quot;, s.top);</span>
<a href="#l17.2485"></a><span id="l17.2485" class="difflineplus">+</span>
<a href="#l17.2486"></a><span id="l17.2486" class="difflineplus">+  /* If width and height are exactly zero, the rect is not stroked! */</span>
<a href="#l17.2487"></a><span id="l17.2487" class="difflineplus">+  v.setAttribute(&quot;width&quot;, Math.max(1E-10, s.width));</span>
<a href="#l17.2488"></a><span id="l17.2488" class="difflineplus">+  v.setAttribute(&quot;height&quot;, Math.max(1E-10, s.height));</span>
<a href="#l17.2489"></a><span id="l17.2489" class="difflineplus">+</span>
<a href="#l17.2490"></a><span id="l17.2490" class="difflineplus">+  /* fill, stroke TODO gradient, patterns */</span>
<a href="#l17.2491"></a><span id="l17.2491" class="difflineplus">+  var fill = pv.color(s.fillStyle);</span>
<a href="#l17.2492"></a><span id="l17.2492" class="difflineplus">+  v.setAttribute(&quot;fill&quot;, fill.color);</span>
<a href="#l17.2493"></a><span id="l17.2493" class="difflineplus">+  v.setAttribute(&quot;fill-opacity&quot;, fill.opacity);</span>
<a href="#l17.2494"></a><span id="l17.2494" class="difflineplus">+  var stroke = pv.color(s.strokeStyle);</span>
<a href="#l17.2495"></a><span id="l17.2495" class="difflineplus">+  v.setAttribute(&quot;stroke&quot;, stroke.color);</span>
<a href="#l17.2496"></a><span id="l17.2496" class="difflineplus">+  v.setAttribute(&quot;stroke-opacity&quot;, stroke.opacity);</span>
<a href="#l17.2497"></a><span id="l17.2497" class="difflineplus">+  v.setAttribute(&quot;stroke-width&quot;, s.lineWidth);</span>
<a href="#l17.2498"></a><span id="l17.2498" class="difflineplus">+};</span>
<a href="#l17.2499"></a><span id="l17.2499" class="difflineplus">+/**</span>
<a href="#l17.2500"></a><span id="l17.2500" class="difflineplus">+ * Constructs a new dot mark with default properties. Dots are not typically</span>
<a href="#l17.2501"></a><span id="l17.2501" class="difflineplus">+ * constructed directly, but by adding to a panel or an existing mark via</span>
<a href="#l17.2502"></a><span id="l17.2502" class="difflineplus">+ * {@link pv.Mark#add}.</span>
<a href="#l17.2503"></a><span id="l17.2503" class="difflineplus">+ *</span>
<a href="#l17.2504"></a><span id="l17.2504" class="difflineplus">+ * @class Represents a dot; a dot is simply a sized glyph centered at a given</span>
<a href="#l17.2505"></a><span id="l17.2505" class="difflineplus">+ * point that can also be stroked and filled. The &lt;tt&gt;size&lt;/tt&gt; property is</span>
<a href="#l17.2506"></a><span id="l17.2506" class="difflineplus">+ * proportional to the area of the rendered glyph to encourage meaningful visual</span>
<a href="#l17.2507"></a><span id="l17.2507" class="difflineplus">+ * encodings. Dots can visually encode up to eight dimensions of data, though</span>
<a href="#l17.2508"></a><span id="l17.2508" class="difflineplus">+ * this may be unwise due to integrality. See {@link pv.Mark#buildImplied} for</span>
<a href="#l17.2509"></a><span id="l17.2509" class="difflineplus">+ * details on the prioritization of redundant positioning properties.</span>
<a href="#l17.2510"></a><span id="l17.2510" class="difflineplus">+ *</span>
<a href="#l17.2511"></a><span id="l17.2511" class="difflineplus">+ * &lt;p&gt;See also the &lt;a href=&quot;../../api/Dot.html&quot;&gt;Dot guide&lt;/a&gt;.</span>
<a href="#l17.2512"></a><span id="l17.2512" class="difflineplus">+ *</span>
<a href="#l17.2513"></a><span id="l17.2513" class="difflineplus">+ * @extends pv.Mark</span>
<a href="#l17.2514"></a><span id="l17.2514" class="difflineplus">+ */</span>
<a href="#l17.2515"></a><span id="l17.2515" class="difflineplus">+pv.Dot = function() {</span>
<a href="#l17.2516"></a><span id="l17.2516" class="difflineplus">+  pv.Mark.call(this);</span>
<a href="#l17.2517"></a><span id="l17.2517" class="difflineplus">+};</span>
<a href="#l17.2518"></a><span id="l17.2518" class="difflineplus">+pv.Dot.prototype = pv.extend(pv.Mark);</span>
<a href="#l17.2519"></a><span id="l17.2519" class="difflineplus">+pv.Dot.prototype.type = pv.Dot;</span>
<a href="#l17.2520"></a><span id="l17.2520" class="difflineplus">+</span>
<a href="#l17.2521"></a><span id="l17.2521" class="difflineplus">+/**</span>
<a href="#l17.2522"></a><span id="l17.2522" class="difflineplus">+ * Returns &quot;dot&quot;.</span>
<a href="#l17.2523"></a><span id="l17.2523" class="difflineplus">+ *</span>
<a href="#l17.2524"></a><span id="l17.2524" class="difflineplus">+ * @returns {string} &quot;dot&quot;.</span>
<a href="#l17.2525"></a><span id="l17.2525" class="difflineplus">+ */</span>
<a href="#l17.2526"></a><span id="l17.2526" class="difflineplus">+pv.Dot.toString = function() { return &quot;dot&quot;; };</span>
<a href="#l17.2527"></a><span id="l17.2527" class="difflineplus">+</span>
<a href="#l17.2528"></a><span id="l17.2528" class="difflineplus">+/**</span>
<a href="#l17.2529"></a><span id="l17.2529" class="difflineplus">+ * The size of the dot, in square pixels. Square pixels are used such that the</span>
<a href="#l17.2530"></a><span id="l17.2530" class="difflineplus">+ * area of the dot is linearly proportional to the value of the size property,</span>
<a href="#l17.2531"></a><span id="l17.2531" class="difflineplus">+ * facilitating representative encodings.</span>
<a href="#l17.2532"></a><span id="l17.2532" class="difflineplus">+ *</span>
<a href="#l17.2533"></a><span id="l17.2533" class="difflineplus">+ * @see #radius</span>
<a href="#l17.2534"></a><span id="l17.2534" class="difflineplus">+ * @type number</span>
<a href="#l17.2535"></a><span id="l17.2535" class="difflineplus">+ * @name pv.Dot.prototype.size</span>
<a href="#l17.2536"></a><span id="l17.2536" class="difflineplus">+ */</span>
<a href="#l17.2537"></a><span id="l17.2537" class="difflineplus">+pv.Dot.prototype.defineProperty(&quot;size&quot;);</span>
<a href="#l17.2538"></a><span id="l17.2538" class="difflineplus">+</span>
<a href="#l17.2539"></a><span id="l17.2539" class="difflineplus">+/**</span>
<a href="#l17.2540"></a><span id="l17.2540" class="difflineplus">+ * The shape name. Several shapes are supported:&lt;ul&gt;</span>
<a href="#l17.2541"></a><span id="l17.2541" class="difflineplus">+ *</span>
<a href="#l17.2542"></a><span id="l17.2542" class="difflineplus">+ * &lt;li&gt;cross</span>
<a href="#l17.2543"></a><span id="l17.2543" class="difflineplus">+ * &lt;li&gt;triangle</span>
<a href="#l17.2544"></a><span id="l17.2544" class="difflineplus">+ * &lt;li&gt;diamond</span>
<a href="#l17.2545"></a><span id="l17.2545" class="difflineplus">+ * &lt;li&gt;square</span>
<a href="#l17.2546"></a><span id="l17.2546" class="difflineplus">+ * &lt;li&gt;tick</span>
<a href="#l17.2547"></a><span id="l17.2547" class="difflineplus">+ * &lt;li&gt;circle</span>
<a href="#l17.2548"></a><span id="l17.2548" class="difflineplus">+ *</span>
<a href="#l17.2549"></a><span id="l17.2549" class="difflineplus">+ * &lt;/ul&gt;These shapes can be further changed using the {@link #angle} property;</span>
<a href="#l17.2550"></a><span id="l17.2550" class="difflineplus">+ * for instance, a cross can be turned into a plus by rotating. Similarly, the</span>
<a href="#l17.2551"></a><span id="l17.2551" class="difflineplus">+ * tick, which is vertical by default, can be rotated horizontally. Note that</span>
<a href="#l17.2552"></a><span id="l17.2552" class="difflineplus">+ * some shapes (cross and tick) do not have interior areas, and thus do not</span>
<a href="#l17.2553"></a><span id="l17.2553" class="difflineplus">+ * support fill style meaningfully.</span>
<a href="#l17.2554"></a><span id="l17.2554" class="difflineplus">+ *</span>
<a href="#l17.2555"></a><span id="l17.2555" class="difflineplus">+ * &lt;p&gt;TODO It's probably better to use the Rule mark type rather than a</span>
<a href="#l17.2556"></a><span id="l17.2556" class="difflineplus">+ * tick-shaped Dot. However, the Rule mark doesn't support the width and height</span>
<a href="#l17.2557"></a><span id="l17.2557" class="difflineplus">+ * properties, so it's a bit clumsy to use. It should be possible to add support</span>
<a href="#l17.2558"></a><span id="l17.2558" class="difflineplus">+ * for width and height to rule, and then remove the tick shape.</span>
<a href="#l17.2559"></a><span id="l17.2559" class="difflineplus">+ *</span>
<a href="#l17.2560"></a><span id="l17.2560" class="difflineplus">+ * @type string</span>
<a href="#l17.2561"></a><span id="l17.2561" class="difflineplus">+ * @name pv.Dot.prototype.shape</span>
<a href="#l17.2562"></a><span id="l17.2562" class="difflineplus">+ */</span>
<a href="#l17.2563"></a><span id="l17.2563" class="difflineplus">+pv.Dot.prototype.defineProperty(&quot;shape&quot;);</span>
<a href="#l17.2564"></a><span id="l17.2564" class="difflineplus">+</span>
<a href="#l17.2565"></a><span id="l17.2565" class="difflineplus">+/**</span>
<a href="#l17.2566"></a><span id="l17.2566" class="difflineplus">+ * The rotation angle, in radians. Used to rotate shapes, such as to turn a</span>
<a href="#l17.2567"></a><span id="l17.2567" class="difflineplus">+ * cross into a plus.</span>
<a href="#l17.2568"></a><span id="l17.2568" class="difflineplus">+ *</span>
<a href="#l17.2569"></a><span id="l17.2569" class="difflineplus">+ * @type number</span>
<a href="#l17.2570"></a><span id="l17.2570" class="difflineplus">+ * @name pv.Dot.prototype.angle</span>
<a href="#l17.2571"></a><span id="l17.2571" class="difflineplus">+ */</span>
<a href="#l17.2572"></a><span id="l17.2572" class="difflineplus">+pv.Dot.prototype.defineProperty(&quot;angle&quot;);</span>
<a href="#l17.2573"></a><span id="l17.2573" class="difflineplus">+</span>
<a href="#l17.2574"></a><span id="l17.2574" class="difflineplus">+/**</span>
<a href="#l17.2575"></a><span id="l17.2575" class="difflineplus">+ * The width of stroked lines, in pixels; used in conjunction with</span>
<a href="#l17.2576"></a><span id="l17.2576" class="difflineplus">+ * &lt;tt&gt;strokeStyle&lt;/tt&gt; to stroke the dot's shape.</span>
<a href="#l17.2577"></a><span id="l17.2577" class="difflineplus">+ *</span>
<a href="#l17.2578"></a><span id="l17.2578" class="difflineplus">+ * @type number</span>
<a href="#l17.2579"></a><span id="l17.2579" class="difflineplus">+ * @name pv.Dot.prototype.lineWidth</span>
<a href="#l17.2580"></a><span id="l17.2580" class="difflineplus">+ */</span>
<a href="#l17.2581"></a><span id="l17.2581" class="difflineplus">+pv.Dot.prototype.defineProperty(&quot;lineWidth&quot;);</span>
<a href="#l17.2582"></a><span id="l17.2582" class="difflineplus">+</span>
<a href="#l17.2583"></a><span id="l17.2583" class="difflineplus">+/**</span>
<a href="#l17.2584"></a><span id="l17.2584" class="difflineplus">+ * The style of stroked lines; used in conjunction with &lt;tt&gt;lineWidth&lt;/tt&gt; to</span>
<a href="#l17.2585"></a><span id="l17.2585" class="difflineplus">+ * stroke the dot's shape. The default value of this property is a categorical</span>
<a href="#l17.2586"></a><span id="l17.2586" class="difflineplus">+ * color.</span>
<a href="#l17.2587"></a><span id="l17.2587" class="difflineplus">+ *</span>
<a href="#l17.2588"></a><span id="l17.2588" class="difflineplus">+ * @type string</span>
<a href="#l17.2589"></a><span id="l17.2589" class="difflineplus">+ * @name pv.Dot.prototype.strokeStyle</span>
<a href="#l17.2590"></a><span id="l17.2590" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.2591"></a><span id="l17.2591" class="difflineplus">+ */</span>
<a href="#l17.2592"></a><span id="l17.2592" class="difflineplus">+pv.Dot.prototype.defineProperty(&quot;strokeStyle&quot;);</span>
<a href="#l17.2593"></a><span id="l17.2593" class="difflineplus">+</span>
<a href="#l17.2594"></a><span id="l17.2594" class="difflineplus">+/**</span>
<a href="#l17.2595"></a><span id="l17.2595" class="difflineplus">+ * The fill style; if non-null, the interior of the dot is filled with the</span>
<a href="#l17.2596"></a><span id="l17.2596" class="difflineplus">+ * specified color. The default value of this property is null, meaning dots are</span>
<a href="#l17.2597"></a><span id="l17.2597" class="difflineplus">+ * not filled by default.</span>
<a href="#l17.2598"></a><span id="l17.2598" class="difflineplus">+ *</span>
<a href="#l17.2599"></a><span id="l17.2599" class="difflineplus">+ * @type string</span>
<a href="#l17.2600"></a><span id="l17.2600" class="difflineplus">+ * @name pv.Dot.prototype.fillStyle</span>
<a href="#l17.2601"></a><span id="l17.2601" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.2602"></a><span id="l17.2602" class="difflineplus">+ */</span>
<a href="#l17.2603"></a><span id="l17.2603" class="difflineplus">+pv.Dot.prototype.defineProperty(&quot;fillStyle&quot;);</span>
<a href="#l17.2604"></a><span id="l17.2604" class="difflineplus">+</span>
<a href="#l17.2605"></a><span id="l17.2605" class="difflineplus">+/**</span>
<a href="#l17.2606"></a><span id="l17.2606" class="difflineplus">+ * Default properties for dots. By default, there is no fill and the stroke</span>
<a href="#l17.2607"></a><span id="l17.2607" class="difflineplus">+ * style is a categorical color. The default shape is &quot;circle&quot; with size 20.</span>
<a href="#l17.2608"></a><span id="l17.2608" class="difflineplus">+ *</span>
<a href="#l17.2609"></a><span id="l17.2609" class="difflineplus">+ * @type pv.Dot</span>
<a href="#l17.2610"></a><span id="l17.2610" class="difflineplus">+ */</span>
<a href="#l17.2611"></a><span id="l17.2611" class="difflineplus">+pv.Dot.defaults = new pv.Dot().extend(pv.Mark.defaults)</span>
<a href="#l17.2612"></a><span id="l17.2612" class="difflineplus">+    .size(20)</span>
<a href="#l17.2613"></a><span id="l17.2613" class="difflineplus">+    .shape(&quot;circle&quot;)</span>
<a href="#l17.2614"></a><span id="l17.2614" class="difflineplus">+    .lineWidth(1.5)</span>
<a href="#l17.2615"></a><span id="l17.2615" class="difflineplus">+    .strokeStyle(pv.Colors.category10);</span>
<a href="#l17.2616"></a><span id="l17.2616" class="difflineplus">+</span>
<a href="#l17.2617"></a><span id="l17.2617" class="difflineplus">+/**</span>
<a href="#l17.2618"></a><span id="l17.2618" class="difflineplus">+ * Constructs a new dot anchor with default properties.</span>
<a href="#l17.2619"></a><span id="l17.2619" class="difflineplus">+ *</span>
<a href="#l17.2620"></a><span id="l17.2620" class="difflineplus">+ * @class Represents an anchor for a dot mark. Dots support five different</span>
<a href="#l17.2621"></a><span id="l17.2621" class="difflineplus">+ * anchors:&lt;ul&gt;</span>
<a href="#l17.2622"></a><span id="l17.2622" class="difflineplus">+ *</span>
<a href="#l17.2623"></a><span id="l17.2623" class="difflineplus">+ * &lt;li&gt;top</span>
<a href="#l17.2624"></a><span id="l17.2624" class="difflineplus">+ * &lt;li&gt;left</span>
<a href="#l17.2625"></a><span id="l17.2625" class="difflineplus">+ * &lt;li&gt;center</span>
<a href="#l17.2626"></a><span id="l17.2626" class="difflineplus">+ * &lt;li&gt;bottom</span>
<a href="#l17.2627"></a><span id="l17.2627" class="difflineplus">+ * &lt;li&gt;right</span>
<a href="#l17.2628"></a><span id="l17.2628" class="difflineplus">+ *</span>
<a href="#l17.2629"></a><span id="l17.2629" class="difflineplus">+ * &lt;/ul&gt;In addition to positioning properties (left, right, top bottom), the</span>
<a href="#l17.2630"></a><span id="l17.2630" class="difflineplus">+ * anchors support text rendering properties (text-align, text-baseline). Text is</span>
<a href="#l17.2631"></a><span id="l17.2631" class="difflineplus">+ * rendered to appear outside the dot. Note that this behavior is different from</span>
<a href="#l17.2632"></a><span id="l17.2632" class="difflineplus">+ * other mark anchors, which default to rendering text &lt;i&gt;inside&lt;/i&gt; the mark.</span>
<a href="#l17.2633"></a><span id="l17.2633" class="difflineplus">+ *</span>
<a href="#l17.2634"></a><span id="l17.2634" class="difflineplus">+ * &lt;p&gt;For consistency with the other mark types, the anchor positions are</span>
<a href="#l17.2635"></a><span id="l17.2635" class="difflineplus">+ * defined in terms of their opposite edge. For example, the top anchor defines</span>
<a href="#l17.2636"></a><span id="l17.2636" class="difflineplus">+ * the bottom property, such that a bar added to the top anchor grows upward.</span>
<a href="#l17.2637"></a><span id="l17.2637" class="difflineplus">+ *</span>
<a href="#l17.2638"></a><span id="l17.2638" class="difflineplus">+ * @extends pv.Mark.Anchor</span>
<a href="#l17.2639"></a><span id="l17.2639" class="difflineplus">+ */</span>
<a href="#l17.2640"></a><span id="l17.2640" class="difflineplus">+pv.Dot.Anchor = function() {</span>
<a href="#l17.2641"></a><span id="l17.2641" class="difflineplus">+  pv.Mark.Anchor.call(this);</span>
<a href="#l17.2642"></a><span id="l17.2642" class="difflineplus">+};</span>
<a href="#l17.2643"></a><span id="l17.2643" class="difflineplus">+pv.Dot.Anchor.prototype = pv.extend(pv.Mark.Anchor);</span>
<a href="#l17.2644"></a><span id="l17.2644" class="difflineplus">+pv.Dot.Anchor.prototype.type = pv.Dot;</span>
<a href="#l17.2645"></a><span id="l17.2645" class="difflineplus">+</span>
<a href="#l17.2646"></a><span id="l17.2646" class="difflineplus">+/**</span>
<a href="#l17.2647"></a><span id="l17.2647" class="difflineplus">+ * The left property; null for &quot;left&quot; anchors, non-null otherwise.</span>
<a href="#l17.2648"></a><span id="l17.2648" class="difflineplus">+ *</span>
<a href="#l17.2649"></a><span id="l17.2649" class="difflineplus">+ * @type number</span>
<a href="#l17.2650"></a><span id="l17.2650" class="difflineplus">+ * @name pv.Dot.Anchor.prototype.left</span>
<a href="#l17.2651"></a><span id="l17.2651" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2652"></a><span id="l17.2652" class="difflineplus">+pv.Dot.Anchor.prototype.$left = function(d) {</span>
<a href="#l17.2653"></a><span id="l17.2653" class="difflineplus">+  var dot = this.anchorTarget();</span>
<a href="#l17.2654"></a><span id="l17.2654" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2655"></a><span id="l17.2655" class="difflineplus">+    case &quot;bottom&quot;:</span>
<a href="#l17.2656"></a><span id="l17.2656" class="difflineplus">+    case &quot;top&quot;:</span>
<a href="#l17.2657"></a><span id="l17.2657" class="difflineplus">+    case &quot;center&quot;: return dot.left();</span>
<a href="#l17.2658"></a><span id="l17.2658" class="difflineplus">+    case &quot;right&quot;: return dot.left() + dot.radius();</span>
<a href="#l17.2659"></a><span id="l17.2659" class="difflineplus">+  }</span>
<a href="#l17.2660"></a><span id="l17.2660" class="difflineplus">+  return null;</span>
<a href="#l17.2661"></a><span id="l17.2661" class="difflineplus">+};</span>
<a href="#l17.2662"></a><span id="l17.2662" class="difflineplus">+</span>
<a href="#l17.2663"></a><span id="l17.2663" class="difflineplus">+/**</span>
<a href="#l17.2664"></a><span id="l17.2664" class="difflineplus">+ * The right property; null for &quot;right&quot; anchors, non-null otherwise.</span>
<a href="#l17.2665"></a><span id="l17.2665" class="difflineplus">+ *</span>
<a href="#l17.2666"></a><span id="l17.2666" class="difflineplus">+ * @type number</span>
<a href="#l17.2667"></a><span id="l17.2667" class="difflineplus">+ * @name pv.Dot.Anchor.prototype.right</span>
<a href="#l17.2668"></a><span id="l17.2668" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2669"></a><span id="l17.2669" class="difflineplus">+pv.Dot.Anchor.prototype.$right = function(d) {</span>
<a href="#l17.2670"></a><span id="l17.2670" class="difflineplus">+  var dot = this.anchorTarget();</span>
<a href="#l17.2671"></a><span id="l17.2671" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2672"></a><span id="l17.2672" class="difflineplus">+    case &quot;bottom&quot;:</span>
<a href="#l17.2673"></a><span id="l17.2673" class="difflineplus">+    case &quot;top&quot;:</span>
<a href="#l17.2674"></a><span id="l17.2674" class="difflineplus">+    case &quot;center&quot;: return dot.right();</span>
<a href="#l17.2675"></a><span id="l17.2675" class="difflineplus">+    case &quot;left&quot;: return dot.right() + dot.radius();</span>
<a href="#l17.2676"></a><span id="l17.2676" class="difflineplus">+  }</span>
<a href="#l17.2677"></a><span id="l17.2677" class="difflineplus">+  return null;</span>
<a href="#l17.2678"></a><span id="l17.2678" class="difflineplus">+};</span>
<a href="#l17.2679"></a><span id="l17.2679" class="difflineplus">+</span>
<a href="#l17.2680"></a><span id="l17.2680" class="difflineplus">+/**</span>
<a href="#l17.2681"></a><span id="l17.2681" class="difflineplus">+ * The top property; null for &quot;top&quot; anchors, non-null otherwise.</span>
<a href="#l17.2682"></a><span id="l17.2682" class="difflineplus">+ *</span>
<a href="#l17.2683"></a><span id="l17.2683" class="difflineplus">+ * @type number</span>
<a href="#l17.2684"></a><span id="l17.2684" class="difflineplus">+ * @name pv.Dot.Anchor.prototype.top</span>
<a href="#l17.2685"></a><span id="l17.2685" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2686"></a><span id="l17.2686" class="difflineplus">+pv.Dot.Anchor.prototype.$top = function(d) {</span>
<a href="#l17.2687"></a><span id="l17.2687" class="difflineplus">+  var dot = this.anchorTarget();</span>
<a href="#l17.2688"></a><span id="l17.2688" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2689"></a><span id="l17.2689" class="difflineplus">+    case &quot;left&quot;:</span>
<a href="#l17.2690"></a><span id="l17.2690" class="difflineplus">+    case &quot;right&quot;:</span>
<a href="#l17.2691"></a><span id="l17.2691" class="difflineplus">+    case &quot;center&quot;: return dot.top();</span>
<a href="#l17.2692"></a><span id="l17.2692" class="difflineplus">+    case &quot;bottom&quot;: return dot.top() + dot.radius();</span>
<a href="#l17.2693"></a><span id="l17.2693" class="difflineplus">+  }</span>
<a href="#l17.2694"></a><span id="l17.2694" class="difflineplus">+  return null;</span>
<a href="#l17.2695"></a><span id="l17.2695" class="difflineplus">+};</span>
<a href="#l17.2696"></a><span id="l17.2696" class="difflineplus">+</span>
<a href="#l17.2697"></a><span id="l17.2697" class="difflineplus">+/**</span>
<a href="#l17.2698"></a><span id="l17.2698" class="difflineplus">+ * The bottom property; null for &quot;bottom&quot; anchors, non-null otherwise.</span>
<a href="#l17.2699"></a><span id="l17.2699" class="difflineplus">+ *</span>
<a href="#l17.2700"></a><span id="l17.2700" class="difflineplus">+ * @type number</span>
<a href="#l17.2701"></a><span id="l17.2701" class="difflineplus">+ * @name pv.Dot.Anchor.prototype.bottom</span>
<a href="#l17.2702"></a><span id="l17.2702" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2703"></a><span id="l17.2703" class="difflineplus">+pv.Dot.Anchor.prototype.$bottom = function(d) {</span>
<a href="#l17.2704"></a><span id="l17.2704" class="difflineplus">+  var dot = this.anchorTarget();</span>
<a href="#l17.2705"></a><span id="l17.2705" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2706"></a><span id="l17.2706" class="difflineplus">+    case &quot;left&quot;:</span>
<a href="#l17.2707"></a><span id="l17.2707" class="difflineplus">+    case &quot;right&quot;:</span>
<a href="#l17.2708"></a><span id="l17.2708" class="difflineplus">+    case &quot;center&quot;: return dot.bottom();</span>
<a href="#l17.2709"></a><span id="l17.2709" class="difflineplus">+    case &quot;top&quot;: return dot.bottom() + dot.radius();</span>
<a href="#l17.2710"></a><span id="l17.2710" class="difflineplus">+  }</span>
<a href="#l17.2711"></a><span id="l17.2711" class="difflineplus">+  return null;</span>
<a href="#l17.2712"></a><span id="l17.2712" class="difflineplus">+};</span>
<a href="#l17.2713"></a><span id="l17.2713" class="difflineplus">+</span>
<a href="#l17.2714"></a><span id="l17.2714" class="difflineplus">+/**</span>
<a href="#l17.2715"></a><span id="l17.2715" class="difflineplus">+ * The text-align property, for horizontal alignment outside the dot.</span>
<a href="#l17.2716"></a><span id="l17.2716" class="difflineplus">+ *</span>
<a href="#l17.2717"></a><span id="l17.2717" class="difflineplus">+ * @type string</span>
<a href="#l17.2718"></a><span id="l17.2718" class="difflineplus">+ * @name pv.Dot.Anchor.prototype.textAlign</span>
<a href="#l17.2719"></a><span id="l17.2719" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2720"></a><span id="l17.2720" class="difflineplus">+pv.Dot.Anchor.prototype.$textAlign = function(d) {</span>
<a href="#l17.2721"></a><span id="l17.2721" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2722"></a><span id="l17.2722" class="difflineplus">+    case &quot;left&quot;: return &quot;right&quot;;</span>
<a href="#l17.2723"></a><span id="l17.2723" class="difflineplus">+    case &quot;bottom&quot;:</span>
<a href="#l17.2724"></a><span id="l17.2724" class="difflineplus">+    case &quot;top&quot;:</span>
<a href="#l17.2725"></a><span id="l17.2725" class="difflineplus">+    case &quot;center&quot;: return &quot;center&quot;;</span>
<a href="#l17.2726"></a><span id="l17.2726" class="difflineplus">+    case &quot;right&quot;: return &quot;left&quot;;</span>
<a href="#l17.2727"></a><span id="l17.2727" class="difflineplus">+  }</span>
<a href="#l17.2728"></a><span id="l17.2728" class="difflineplus">+  return null;</span>
<a href="#l17.2729"></a><span id="l17.2729" class="difflineplus">+};</span>
<a href="#l17.2730"></a><span id="l17.2730" class="difflineplus">+</span>
<a href="#l17.2731"></a><span id="l17.2731" class="difflineplus">+/**</span>
<a href="#l17.2732"></a><span id="l17.2732" class="difflineplus">+ * The text-baseline property, for vertical alignment outside the dot.</span>
<a href="#l17.2733"></a><span id="l17.2733" class="difflineplus">+ *</span>
<a href="#l17.2734"></a><span id="l17.2734" class="difflineplus">+ * @type string</span>
<a href="#l17.2735"></a><span id="l17.2735" class="difflineplus">+ * @name pv.Dot.Anchor.prototype.textBasline</span>
<a href="#l17.2736"></a><span id="l17.2736" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.2737"></a><span id="l17.2737" class="difflineplus">+pv.Dot.Anchor.prototype.$textBaseline = function(d) {</span>
<a href="#l17.2738"></a><span id="l17.2738" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.2739"></a><span id="l17.2739" class="difflineplus">+    case &quot;right&quot;:</span>
<a href="#l17.2740"></a><span id="l17.2740" class="difflineplus">+    case &quot;left&quot;:</span>
<a href="#l17.2741"></a><span id="l17.2741" class="difflineplus">+    case &quot;center&quot;: return &quot;middle&quot;;</span>
<a href="#l17.2742"></a><span id="l17.2742" class="difflineplus">+    case &quot;top&quot;: return &quot;bottom&quot;;</span>
<a href="#l17.2743"></a><span id="l17.2743" class="difflineplus">+    case &quot;bottom&quot;: return &quot;top&quot;;</span>
<a href="#l17.2744"></a><span id="l17.2744" class="difflineplus">+  }</span>
<a href="#l17.2745"></a><span id="l17.2745" class="difflineplus">+  return null;</span>
<a href="#l17.2746"></a><span id="l17.2746" class="difflineplus">+};</span>
<a href="#l17.2747"></a><span id="l17.2747" class="difflineplus">+</span>
<a href="#l17.2748"></a><span id="l17.2748" class="difflineplus">+/**</span>
<a href="#l17.2749"></a><span id="l17.2749" class="difflineplus">+ * Returns the radius of the dot, which is defined to be the square root of the</span>
<a href="#l17.2750"></a><span id="l17.2750" class="difflineplus">+ * {@link #size} property.</span>
<a href="#l17.2751"></a><span id="l17.2751" class="difflineplus">+ *</span>
<a href="#l17.2752"></a><span id="l17.2752" class="difflineplus">+ * @returns {number} the radius.</span>
<a href="#l17.2753"></a><span id="l17.2753" class="difflineplus">+ */</span>
<a href="#l17.2754"></a><span id="l17.2754" class="difflineplus">+pv.Dot.prototype.radius = function() {</span>
<a href="#l17.2755"></a><span id="l17.2755" class="difflineplus">+  return Math.sqrt(this.size());</span>
<a href="#l17.2756"></a><span id="l17.2756" class="difflineplus">+};</span>
<a href="#l17.2757"></a><span id="l17.2757" class="difflineplus">+</span>
<a href="#l17.2758"></a><span id="l17.2758" class="difflineplus">+/**</span>
<a href="#l17.2759"></a><span id="l17.2759" class="difflineplus">+ * Updates the display for the specified dot instance &lt;tt&gt;s&lt;/tt&gt; in the scene</span>
<a href="#l17.2760"></a><span id="l17.2760" class="difflineplus">+ * graph. This implementation handles the fill and stroke style for the dot, as</span>
<a href="#l17.2761"></a><span id="l17.2761" class="difflineplus">+ * well as positional properties.</span>
<a href="#l17.2762"></a><span id="l17.2762" class="difflineplus">+ *</span>
<a href="#l17.2763"></a><span id="l17.2763" class="difflineplus">+ * @param s a node in the scene graph; the instance of the dot to update.</span>
<a href="#l17.2764"></a><span id="l17.2764" class="difflineplus">+ */</span>
<a href="#l17.2765"></a><span id="l17.2765" class="difflineplus">+pv.Dot.prototype.updateInstance = function(s) {</span>
<a href="#l17.2766"></a><span id="l17.2766" class="difflineplus">+  var v = s.svg;</span>
<a href="#l17.2767"></a><span id="l17.2767" class="difflineplus">+</span>
<a href="#l17.2768"></a><span id="l17.2768" class="difflineplus">+  /* Create the &lt;svg:path&gt; element, if necessary. */</span>
<a href="#l17.2769"></a><span id="l17.2769" class="difflineplus">+  if (s.visible &amp;&amp; !v) {</span>
<a href="#l17.2770"></a><span id="l17.2770" class="difflineplus">+    v = s.svg = document.createElementNS(pv.ns.svg, &quot;path&quot;);</span>
<a href="#l17.2771"></a><span id="l17.2771" class="difflineplus">+    s.parent.svg.appendChild(v);</span>
<a href="#l17.2772"></a><span id="l17.2772" class="difflineplus">+  }</span>
<a href="#l17.2773"></a><span id="l17.2773" class="difflineplus">+</span>
<a href="#l17.2774"></a><span id="l17.2774" class="difflineplus">+  /* visible, cursor, title, event, etc. */</span>
<a href="#l17.2775"></a><span id="l17.2775" class="difflineplus">+  pv.Mark.prototype.updateInstance.call(this, s);</span>
<a href="#l17.2776"></a><span id="l17.2776" class="difflineplus">+  if (!s.visible) return;</span>
<a href="#l17.2777"></a><span id="l17.2777" class="difflineplus">+</span>
<a href="#l17.2778"></a><span id="l17.2778" class="difflineplus">+  /* left, top */</span>
<a href="#l17.2779"></a><span id="l17.2779" class="difflineplus">+  v.setAttribute(&quot;transform&quot;, &quot;translate(&quot; + s.left + &quot;,&quot; + s.top +&quot;)&quot;</span>
<a href="#l17.2780"></a><span id="l17.2780" class="difflineplus">+      + (s.angle ? &quot; rotate(&quot; + 180 * s.angle / Math.PI + &quot;)&quot; : &quot;&quot;));</span>
<a href="#l17.2781"></a><span id="l17.2781" class="difflineplus">+</span>
<a href="#l17.2782"></a><span id="l17.2782" class="difflineplus">+  /* fill, stroke TODO gradient, patterns? */</span>
<a href="#l17.2783"></a><span id="l17.2783" class="difflineplus">+  var fill = pv.color(s.fillStyle);</span>
<a href="#l17.2784"></a><span id="l17.2784" class="difflineplus">+  v.setAttribute(&quot;fill&quot;, fill.color);</span>
<a href="#l17.2785"></a><span id="l17.2785" class="difflineplus">+  v.setAttribute(&quot;fill-opacity&quot;, fill.opacity);</span>
<a href="#l17.2786"></a><span id="l17.2786" class="difflineplus">+  var stroke = pv.color(s.strokeStyle);</span>
<a href="#l17.2787"></a><span id="l17.2787" class="difflineplus">+  v.setAttribute(&quot;stroke&quot;, stroke.color);</span>
<a href="#l17.2788"></a><span id="l17.2788" class="difflineplus">+  v.setAttribute(&quot;stroke-opacity&quot;, stroke.opacity);</span>
<a href="#l17.2789"></a><span id="l17.2789" class="difflineplus">+  v.setAttribute(&quot;stroke-width&quot;, s.lineWidth);</span>
<a href="#l17.2790"></a><span id="l17.2790" class="difflineplus">+</span>
<a href="#l17.2791"></a><span id="l17.2791" class="difflineplus">+  /* shape, size */</span>
<a href="#l17.2792"></a><span id="l17.2792" class="difflineplus">+  var radius = Math.sqrt(s.size);</span>
<a href="#l17.2793"></a><span id="l17.2793" class="difflineplus">+  var d;</span>
<a href="#l17.2794"></a><span id="l17.2794" class="difflineplus">+  switch (s.shape) {</span>
<a href="#l17.2795"></a><span id="l17.2795" class="difflineplus">+    case &quot;cross&quot;: {</span>
<a href="#l17.2796"></a><span id="l17.2796" class="difflineplus">+      d = &quot;M&quot; + -radius + &quot;,&quot; + -radius</span>
<a href="#l17.2797"></a><span id="l17.2797" class="difflineplus">+          + &quot;L&quot; + radius + &quot;,&quot; + radius</span>
<a href="#l17.2798"></a><span id="l17.2798" class="difflineplus">+          + &quot;M&quot; + radius + &quot;,&quot; + -radius</span>
<a href="#l17.2799"></a><span id="l17.2799" class="difflineplus">+          + &quot;L&quot; + -radius + &quot;,&quot; + radius;</span>
<a href="#l17.2800"></a><span id="l17.2800" class="difflineplus">+      break;</span>
<a href="#l17.2801"></a><span id="l17.2801" class="difflineplus">+    }</span>
<a href="#l17.2802"></a><span id="l17.2802" class="difflineplus">+    case &quot;triangle&quot;: {</span>
<a href="#l17.2803"></a><span id="l17.2803" class="difflineplus">+      var h = radius, w = radius * 2 / Math.sqrt(3);</span>
<a href="#l17.2804"></a><span id="l17.2804" class="difflineplus">+      d = &quot;M0,&quot; + h</span>
<a href="#l17.2805"></a><span id="l17.2805" class="difflineplus">+          + &quot;L&quot; + w +&quot;,&quot; + -h</span>
<a href="#l17.2806"></a><span id="l17.2806" class="difflineplus">+          + &quot; &quot; + -w + &quot;,&quot; + -h</span>
<a href="#l17.2807"></a><span id="l17.2807" class="difflineplus">+          + &quot;Z&quot;;</span>
<a href="#l17.2808"></a><span id="l17.2808" class="difflineplus">+      break;</span>
<a href="#l17.2809"></a><span id="l17.2809" class="difflineplus">+    }</span>
<a href="#l17.2810"></a><span id="l17.2810" class="difflineplus">+    case &quot;diamond&quot;: {</span>
<a href="#l17.2811"></a><span id="l17.2811" class="difflineplus">+      radius *= Math.sqrt(2);</span>
<a href="#l17.2812"></a><span id="l17.2812" class="difflineplus">+      d = &quot;M0,&quot; + -radius</span>
<a href="#l17.2813"></a><span id="l17.2813" class="difflineplus">+          + &quot;L&quot; + radius + &quot;,0&quot;</span>
<a href="#l17.2814"></a><span id="l17.2814" class="difflineplus">+          + &quot; 0,&quot; + radius</span>
<a href="#l17.2815"></a><span id="l17.2815" class="difflineplus">+          + &quot; &quot; + -radius + &quot;,0&quot;</span>
<a href="#l17.2816"></a><span id="l17.2816" class="difflineplus">+          + &quot;Z&quot;;</span>
<a href="#l17.2817"></a><span id="l17.2817" class="difflineplus">+      break;</span>
<a href="#l17.2818"></a><span id="l17.2818" class="difflineplus">+    }</span>
<a href="#l17.2819"></a><span id="l17.2819" class="difflineplus">+    case &quot;square&quot;: {</span>
<a href="#l17.2820"></a><span id="l17.2820" class="difflineplus">+      d = &quot;M&quot; + -radius + &quot;,&quot; + -radius</span>
<a href="#l17.2821"></a><span id="l17.2821" class="difflineplus">+          + &quot;L&quot; + radius + &quot;,&quot; + -radius</span>
<a href="#l17.2822"></a><span id="l17.2822" class="difflineplus">+          + &quot; &quot; + radius + &quot;,&quot; + radius</span>
<a href="#l17.2823"></a><span id="l17.2823" class="difflineplus">+          + &quot; &quot; + -radius + &quot;,&quot; + radius</span>
<a href="#l17.2824"></a><span id="l17.2824" class="difflineplus">+          + &quot;Z&quot;;</span>
<a href="#l17.2825"></a><span id="l17.2825" class="difflineplus">+      break;</span>
<a href="#l17.2826"></a><span id="l17.2826" class="difflineplus">+    }</span>
<a href="#l17.2827"></a><span id="l17.2827" class="difflineplus">+    case &quot;tick&quot;: {</span>
<a href="#l17.2828"></a><span id="l17.2828" class="difflineplus">+      d = &quot;M0,0L0,&quot; + -s.size;</span>
<a href="#l17.2829"></a><span id="l17.2829" class="difflineplus">+      break;</span>
<a href="#l17.2830"></a><span id="l17.2830" class="difflineplus">+    }</span>
<a href="#l17.2831"></a><span id="l17.2831" class="difflineplus">+    default: { // circle</span>
<a href="#l17.2832"></a><span id="l17.2832" class="difflineplus">+      d = &quot;M0,&quot; + radius</span>
<a href="#l17.2833"></a><span id="l17.2833" class="difflineplus">+          + &quot;A&quot; + radius + &quot;,&quot; + radius + &quot; 0 1,1 0,&quot; + (-radius)</span>
<a href="#l17.2834"></a><span id="l17.2834" class="difflineplus">+          + &quot;A&quot; + radius + &quot;,&quot; + radius + &quot; 0 1,1 0,&quot; + radius</span>
<a href="#l17.2835"></a><span id="l17.2835" class="difflineplus">+          + &quot;Z&quot;;</span>
<a href="#l17.2836"></a><span id="l17.2836" class="difflineplus">+      break;</span>
<a href="#l17.2837"></a><span id="l17.2837" class="difflineplus">+    }</span>
<a href="#l17.2838"></a><span id="l17.2838" class="difflineplus">+  }</span>
<a href="#l17.2839"></a><span id="l17.2839" class="difflineplus">+  v.setAttribute(&quot;d&quot;, d);</span>
<a href="#l17.2840"></a><span id="l17.2840" class="difflineplus">+};</span>
<a href="#l17.2841"></a><span id="l17.2841" class="difflineplus">+/**</span>
<a href="#l17.2842"></a><span id="l17.2842" class="difflineplus">+ * Constructs a new dot mark with default properties. Images are not typically</span>
<a href="#l17.2843"></a><span id="l17.2843" class="difflineplus">+ * constructed directly, but by adding to a panel or an existing mark via</span>
<a href="#l17.2844"></a><span id="l17.2844" class="difflineplus">+ * {@link pv.Mark#add}.</span>
<a href="#l17.2845"></a><span id="l17.2845" class="difflineplus">+ *</span>
<a href="#l17.2846"></a><span id="l17.2846" class="difflineplus">+ * @class Represents an image. Images share the same layout and style properties as</span>
<a href="#l17.2847"></a><span id="l17.2847" class="difflineplus">+ * bars, in conjunction with an external image such as PNG or JPEG. The image is</span>
<a href="#l17.2848"></a><span id="l17.2848" class="difflineplus">+ * specified via the {@link #url} property. The fill, if specified, appears</span>
<a href="#l17.2849"></a><span id="l17.2849" class="difflineplus">+ * beneath the image, while the optional stroke appears above the image.</span>
<a href="#l17.2850"></a><span id="l17.2850" class="difflineplus">+ *</span>
<a href="#l17.2851"></a><span id="l17.2851" class="difflineplus">+ * &lt;p&gt;TODO Restore support for dynamic images (such as heatmaps). These were</span>
<a href="#l17.2852"></a><span id="l17.2852" class="difflineplus">+ * supported in the canvas implementation using the pixel buffer API; although</span>
<a href="#l17.2853"></a><span id="l17.2853" class="difflineplus">+ * SVG does not support pixel manipulation, it is possible to embed a canvas</span>
<a href="#l17.2854"></a><span id="l17.2854" class="difflineplus">+ * element in SVG using foreign objects.</span>
<a href="#l17.2855"></a><span id="l17.2855" class="difflineplus">+ *</span>
<a href="#l17.2856"></a><span id="l17.2856" class="difflineplus">+ * &lt;p&gt;TODO Allow different modes of image placement: &quot;scale&quot; -- scale and</span>
<a href="#l17.2857"></a><span id="l17.2857" class="difflineplus">+ * preserve aspect ratio, &quot;tile&quot; -- repeat the image, &quot;center&quot; -- center the</span>
<a href="#l17.2858"></a><span id="l17.2858" class="difflineplus">+ * image, &quot;fill&quot; -- scale without preserving aspect ratio.</span>
<a href="#l17.2859"></a><span id="l17.2859" class="difflineplus">+ *</span>
<a href="#l17.2860"></a><span id="l17.2860" class="difflineplus">+ * &lt;p&gt;See {@link pv.Bar} for details on positioning properties.</span>
<a href="#l17.2861"></a><span id="l17.2861" class="difflineplus">+ *</span>
<a href="#l17.2862"></a><span id="l17.2862" class="difflineplus">+ * @extends pv.Bar</span>
<a href="#l17.2863"></a><span id="l17.2863" class="difflineplus">+ */</span>
<a href="#l17.2864"></a><span id="l17.2864" class="difflineplus">+pv.Image = function() {</span>
<a href="#l17.2865"></a><span id="l17.2865" class="difflineplus">+  pv.Bar.call(this);</span>
<a href="#l17.2866"></a><span id="l17.2866" class="difflineplus">+};</span>
<a href="#l17.2867"></a><span id="l17.2867" class="difflineplus">+pv.Image.prototype = pv.extend(pv.Bar);</span>
<a href="#l17.2868"></a><span id="l17.2868" class="difflineplus">+pv.Image.prototype.type = pv.Image;</span>
<a href="#l17.2869"></a><span id="l17.2869" class="difflineplus">+</span>
<a href="#l17.2870"></a><span id="l17.2870" class="difflineplus">+/**</span>
<a href="#l17.2871"></a><span id="l17.2871" class="difflineplus">+ * Returns &quot;image&quot;.</span>
<a href="#l17.2872"></a><span id="l17.2872" class="difflineplus">+ *</span>
<a href="#l17.2873"></a><span id="l17.2873" class="difflineplus">+ * @returns {string} &quot;image&quot;.</span>
<a href="#l17.2874"></a><span id="l17.2874" class="difflineplus">+ */</span>
<a href="#l17.2875"></a><span id="l17.2875" class="difflineplus">+pv.Image.toString = function() { return &quot;image&quot;; };</span>
<a href="#l17.2876"></a><span id="l17.2876" class="difflineplus">+</span>
<a href="#l17.2877"></a><span id="l17.2877" class="difflineplus">+/**</span>
<a href="#l17.2878"></a><span id="l17.2878" class="difflineplus">+ * The URL of the image to display. The set of supported image types is</span>
<a href="#l17.2879"></a><span id="l17.2879" class="difflineplus">+ * browser-dependent; PNG and JPEG are recommended.</span>
<a href="#l17.2880"></a><span id="l17.2880" class="difflineplus">+ *</span>
<a href="#l17.2881"></a><span id="l17.2881" class="difflineplus">+ * @type string</span>
<a href="#l17.2882"></a><span id="l17.2882" class="difflineplus">+ * @name pv.Image.prototype.url</span>
<a href="#l17.2883"></a><span id="l17.2883" class="difflineplus">+ */</span>
<a href="#l17.2884"></a><span id="l17.2884" class="difflineplus">+pv.Image.prototype.defineProperty(&quot;url&quot;);</span>
<a href="#l17.2885"></a><span id="l17.2885" class="difflineplus">+</span>
<a href="#l17.2886"></a><span id="l17.2886" class="difflineplus">+/**</span>
<a href="#l17.2887"></a><span id="l17.2887" class="difflineplus">+ * Default properties for images. By default, there is no stroke or fill style.</span>
<a href="#l17.2888"></a><span id="l17.2888" class="difflineplus">+ *</span>
<a href="#l17.2889"></a><span id="l17.2889" class="difflineplus">+ * @type pv.Image</span>
<a href="#l17.2890"></a><span id="l17.2890" class="difflineplus">+ */</span>
<a href="#l17.2891"></a><span id="l17.2891" class="difflineplus">+pv.Image.defaults = new pv.Image().extend(pv.Bar.defaults)</span>
<a href="#l17.2892"></a><span id="l17.2892" class="difflineplus">+    .fillStyle(null);</span>
<a href="#l17.2893"></a><span id="l17.2893" class="difflineplus">+</span>
<a href="#l17.2894"></a><span id="l17.2894" class="difflineplus">+/**</span>
<a href="#l17.2895"></a><span id="l17.2895" class="difflineplus">+ * Updates the display for the specified image instance &lt;tt&gt;s&lt;/tt&gt; in the scene</span>
<a href="#l17.2896"></a><span id="l17.2896" class="difflineplus">+ * graph. This implementation handles the fill and stroke style for the image,</span>
<a href="#l17.2897"></a><span id="l17.2897" class="difflineplus">+ * as well as positional properties.</span>
<a href="#l17.2898"></a><span id="l17.2898" class="difflineplus">+ *</span>
<a href="#l17.2899"></a><span id="l17.2899" class="difflineplus">+ * &lt;p&gt;Image rendering is a bit more complicated than most marks because it can</span>
<a href="#l17.2900"></a><span id="l17.2900" class="difflineplus">+ * entail up to four SVG elements: three for the fill, image and stroke, and the</span>
<a href="#l17.2901"></a><span id="l17.2901" class="difflineplus">+ * fourth an anchor element for the title tooltip. The anchor element is placed</span>
<a href="#l17.2902"></a><span id="l17.2902" class="difflineplus">+ * around the stroke rect element, if present, and otherwise the image element.</span>
<a href="#l17.2903"></a><span id="l17.2903" class="difflineplus">+ * Similarly the event handlers and cursor style is placed on the stroke</span>
<a href="#l17.2904"></a><span id="l17.2904" class="difflineplus">+ * element, if present, and otherwise the image element. Note that since the</span>
<a href="#l17.2905"></a><span id="l17.2905" class="difflineplus">+ * stroke element is transparent, the &lt;tt&gt;pointer-events&lt;/tt&gt; attribute is used</span>
<a href="#l17.2906"></a><span id="l17.2906" class="difflineplus">+ * to capture events.</span>
<a href="#l17.2907"></a><span id="l17.2907" class="difflineplus">+ *</span>
<a href="#l17.2908"></a><span id="l17.2908" class="difflineplus">+ * @param s a node in the scene graph; the instance of the image to update.</span>
<a href="#l17.2909"></a><span id="l17.2909" class="difflineplus">+ */</span>
<a href="#l17.2910"></a><span id="l17.2910" class="difflineplus">+pv.Image.prototype.updateInstance = function(s) {</span>
<a href="#l17.2911"></a><span id="l17.2911" class="difflineplus">+  var v = s.svg;</span>
<a href="#l17.2912"></a><span id="l17.2912" class="difflineplus">+</span>
<a href="#l17.2913"></a><span id="l17.2913" class="difflineplus">+  /* Create the svg:image element, if necessary. */</span>
<a href="#l17.2914"></a><span id="l17.2914" class="difflineplus">+  if (s.visible &amp;&amp; !v) {</span>
<a href="#l17.2915"></a><span id="l17.2915" class="difflineplus">+    v = s.svg = document.createElementNS(pv.ns.svg, &quot;image&quot;);</span>
<a href="#l17.2916"></a><span id="l17.2916" class="difflineplus">+    v.setAttribute(&quot;preserveAspectRatio&quot;, &quot;none&quot;);</span>
<a href="#l17.2917"></a><span id="l17.2917" class="difflineplus">+    s.parent.svg.appendChild(v);</span>
<a href="#l17.2918"></a><span id="l17.2918" class="difflineplus">+  }</span>
<a href="#l17.2919"></a><span id="l17.2919" class="difflineplus">+</span>
<a href="#l17.2920"></a><span id="l17.2920" class="difflineplus">+  /*</span>
<a href="#l17.2921"></a><span id="l17.2921" class="difflineplus">+   * If no stroke is specified, then the event handlers and title anchor element</span>
<a href="#l17.2922"></a><span id="l17.2922" class="difflineplus">+   * can be placed on the image element. However, if there was previously a</span>
<a href="#l17.2923"></a><span id="l17.2923" class="difflineplus">+   * title anchor element around the stroke element, we must be careful to</span>
<a href="#l17.2924"></a><span id="l17.2924" class="difflineplus">+   * remove it. This logic could likely be simplified.</span>
<a href="#l17.2925"></a><span id="l17.2925" class="difflineplus">+   */</span>
<a href="#l17.2926"></a><span id="l17.2926" class="difflineplus">+  if (!s.strokeStyle) {</span>
<a href="#l17.2927"></a><span id="l17.2927" class="difflineplus">+    if (v.$stroke) {</span>
<a href="#l17.2928"></a><span id="l17.2928" class="difflineplus">+      v.parentNode.removeChild(v.$stroke.$title || v.$stroke);</span>
<a href="#l17.2929"></a><span id="l17.2929" class="difflineplus">+      delete v.$stroke;</span>
<a href="#l17.2930"></a><span id="l17.2930" class="difflineplus">+    }</span>
<a href="#l17.2931"></a><span id="l17.2931" class="difflineplus">+</span>
<a href="#l17.2932"></a><span id="l17.2932" class="difflineplus">+    /* cursor, title, events, etc. */</span>
<a href="#l17.2933"></a><span id="l17.2933" class="difflineplus">+    pv.Mark.prototype.updateInstance.call(this, s);</span>
<a href="#l17.2934"></a><span id="l17.2934" class="difflineplus">+  }</span>
<a href="#l17.2935"></a><span id="l17.2935" class="difflineplus">+</span>
<a href="#l17.2936"></a><span id="l17.2936" class="difflineplus">+  /* visible */</span>
<a href="#l17.2937"></a><span id="l17.2937" class="difflineplus">+  function display(v) {</span>
<a href="#l17.2938"></a><span id="l17.2938" class="difflineplus">+    s.visible ? v.removeAttribute(&quot;display&quot;) : v.setAttribute(&quot;display&quot;, &quot;none&quot;);</span>
<a href="#l17.2939"></a><span id="l17.2939" class="difflineplus">+  }</span>
<a href="#l17.2940"></a><span id="l17.2940" class="difflineplus">+  if (v) {</span>
<a href="#l17.2941"></a><span id="l17.2941" class="difflineplus">+    display(v);</span>
<a href="#l17.2942"></a><span id="l17.2942" class="difflineplus">+    if (v.$stroke) display(v.$stroke);</span>
<a href="#l17.2943"></a><span id="l17.2943" class="difflineplus">+    if (v.$fill) display(v.$fill);</span>
<a href="#l17.2944"></a><span id="l17.2944" class="difflineplus">+  }</span>
<a href="#l17.2945"></a><span id="l17.2945" class="difflineplus">+  if (!s.visible) return;</span>
<a href="#l17.2946"></a><span id="l17.2946" class="difflineplus">+</span>
<a href="#l17.2947"></a><span id="l17.2947" class="difflineplus">+  /* left, top, width, height */</span>
<a href="#l17.2948"></a><span id="l17.2948" class="difflineplus">+  function position(v) {</span>
<a href="#l17.2949"></a><span id="l17.2949" class="difflineplus">+    v.setAttribute(&quot;x&quot;, s.left);</span>
<a href="#l17.2950"></a><span id="l17.2950" class="difflineplus">+    v.setAttribute(&quot;y&quot;, s.top);</span>
<a href="#l17.2951"></a><span id="l17.2951" class="difflineplus">+    v.setAttribute(&quot;width&quot;, s.width);</span>
<a href="#l17.2952"></a><span id="l17.2952" class="difflineplus">+    v.setAttribute(&quot;height&quot;, s.height);</span>
<a href="#l17.2953"></a><span id="l17.2953" class="difflineplus">+  }</span>
<a href="#l17.2954"></a><span id="l17.2954" class="difflineplus">+  position(v);</span>
<a href="#l17.2955"></a><span id="l17.2955" class="difflineplus">+</span>
<a href="#l17.2956"></a><span id="l17.2956" class="difflineplus">+  /* fill (via an underlaid svg:rect element) */</span>
<a href="#l17.2957"></a><span id="l17.2957" class="difflineplus">+  if (s.fillStyle) {</span>
<a href="#l17.2958"></a><span id="l17.2958" class="difflineplus">+    var f = v.$fill;</span>
<a href="#l17.2959"></a><span id="l17.2959" class="difflineplus">+    if (!f) {</span>
<a href="#l17.2960"></a><span id="l17.2960" class="difflineplus">+      f = v.$fill = document.createElementNS(pv.ns.svg, &quot;rect&quot;);</span>
<a href="#l17.2961"></a><span id="l17.2961" class="difflineplus">+      (v.$title || v).parentNode.insertBefore(f, (v.$title || v));</span>
<a href="#l17.2962"></a><span id="l17.2962" class="difflineplus">+    }</span>
<a href="#l17.2963"></a><span id="l17.2963" class="difflineplus">+    position(f);</span>
<a href="#l17.2964"></a><span id="l17.2964" class="difflineplus">+    var fill = pv.color(s.fillStyle);</span>
<a href="#l17.2965"></a><span id="l17.2965" class="difflineplus">+    f.setAttribute(&quot;fill&quot;, fill.color);</span>
<a href="#l17.2966"></a><span id="l17.2966" class="difflineplus">+    f.setAttribute(&quot;fill-opacity&quot;, fill.opacity);</span>
<a href="#l17.2967"></a><span id="l17.2967" class="difflineplus">+  } else if (v.$fill) {</span>
<a href="#l17.2968"></a><span id="l17.2968" class="difflineplus">+    v.$fill.parentNode.removeChild(v.$fill);</span>
<a href="#l17.2969"></a><span id="l17.2969" class="difflineplus">+    delete v.$fill;</span>
<a href="#l17.2970"></a><span id="l17.2970" class="difflineplus">+  }</span>
<a href="#l17.2971"></a><span id="l17.2971" class="difflineplus">+</span>
<a href="#l17.2972"></a><span id="l17.2972" class="difflineplus">+  /* stroke (via an overlaid svg:rect element) */</span>
<a href="#l17.2973"></a><span id="l17.2973" class="difflineplus">+  if (s.strokeStyle) {</span>
<a href="#l17.2974"></a><span id="l17.2974" class="difflineplus">+    var f = v.$stroke;</span>
<a href="#l17.2975"></a><span id="l17.2975" class="difflineplus">+</span>
<a href="#l17.2976"></a><span id="l17.2976" class="difflineplus">+    /*</span>
<a href="#l17.2977"></a><span id="l17.2977" class="difflineplus">+     * If the $title attribute is set, that means the title anchor element was</span>
<a href="#l17.2978"></a><span id="l17.2978" class="difflineplus">+     * previously on the image element; now that the stroke style is set, we</span>
<a href="#l17.2979"></a><span id="l17.2979" class="difflineplus">+     * must delete the old title element to make room for the new one.</span>
<a href="#l17.2980"></a><span id="l17.2980" class="difflineplus">+     */</span>
<a href="#l17.2981"></a><span id="l17.2981" class="difflineplus">+    if (v.$title) {</span>
<a href="#l17.2982"></a><span id="l17.2982" class="difflineplus">+      var p = v.$title.parentNode;</span>
<a href="#l17.2983"></a><span id="l17.2983" class="difflineplus">+      p.insertBefore(v, v.$title);</span>
<a href="#l17.2984"></a><span id="l17.2984" class="difflineplus">+      p.removeChild(v.$title);</span>
<a href="#l17.2985"></a><span id="l17.2985" class="difflineplus">+      delete v.$title;</span>
<a href="#l17.2986"></a><span id="l17.2986" class="difflineplus">+    }</span>
<a href="#l17.2987"></a><span id="l17.2987" class="difflineplus">+</span>
<a href="#l17.2988"></a><span id="l17.2988" class="difflineplus">+    /* Create the stroke svg:rect element, if necessary. */</span>
<a href="#l17.2989"></a><span id="l17.2989" class="difflineplus">+    if (!f) {</span>
<a href="#l17.2990"></a><span id="l17.2990" class="difflineplus">+      f = v.$stroke = document.createElementNS(pv.ns.svg, &quot;rect&quot;);</span>
<a href="#l17.2991"></a><span id="l17.2991" class="difflineplus">+      f.setAttribute(&quot;fill&quot;, &quot;none&quot;);</span>
<a href="#l17.2992"></a><span id="l17.2992" class="difflineplus">+      f.setAttribute(&quot;pointer-events&quot;, &quot;all&quot;);</span>
<a href="#l17.2993"></a><span id="l17.2993" class="difflineplus">+      v.parentNode.insertBefore(f, v.nextSibling);</span>
<a href="#l17.2994"></a><span id="l17.2994" class="difflineplus">+    }</span>
<a href="#l17.2995"></a><span id="l17.2995" class="difflineplus">+    position(f);</span>
<a href="#l17.2996"></a><span id="l17.2996" class="difflineplus">+    var stroke = pv.color(s.strokeStyle);</span>
<a href="#l17.2997"></a><span id="l17.2997" class="difflineplus">+    f.setAttribute(&quot;stroke&quot;, stroke.color);</span>
<a href="#l17.2998"></a><span id="l17.2998" class="difflineplus">+    f.setAttribute(&quot;stroke-opacity&quot;, stroke.opacity);</span>
<a href="#l17.2999"></a><span id="l17.2999" class="difflineplus">+    f.setAttribute(&quot;stroke-width&quot;, s.lineWidth);</span>
<a href="#l17.3000"></a><span id="l17.3000" class="difflineplus">+</span>
<a href="#l17.3001"></a><span id="l17.3001" class="difflineplus">+    /* cursor, title, events, etc. */</span>
<a href="#l17.3002"></a><span id="l17.3002" class="difflineplus">+    try {</span>
<a href="#l17.3003"></a><span id="l17.3003" class="difflineplus">+      s.svg = f;</span>
<a href="#l17.3004"></a><span id="l17.3004" class="difflineplus">+      pv.Mark.prototype.updateInstance.call(this, s);</span>
<a href="#l17.3005"></a><span id="l17.3005" class="difflineplus">+    } finally {</span>
<a href="#l17.3006"></a><span id="l17.3006" class="difflineplus">+      s.svg = v;</span>
<a href="#l17.3007"></a><span id="l17.3007" class="difflineplus">+    }</span>
<a href="#l17.3008"></a><span id="l17.3008" class="difflineplus">+  }</span>
<a href="#l17.3009"></a><span id="l17.3009" class="difflineplus">+</span>
<a href="#l17.3010"></a><span id="l17.3010" class="difflineplus">+  /* url */</span>
<a href="#l17.3011"></a><span id="l17.3011" class="difflineplus">+  v.setAttributeNS(pv.ns.xlink, &quot;href&quot;, s.url);</span>
<a href="#l17.3012"></a><span id="l17.3012" class="difflineplus">+};</span>
<a href="#l17.3013"></a><span id="l17.3013" class="difflineplus">+/**</span>
<a href="#l17.3014"></a><span id="l17.3014" class="difflineplus">+ * Constructs a new label mark with default properties. Labels are not typically</span>
<a href="#l17.3015"></a><span id="l17.3015" class="difflineplus">+ * constructed directly, but by adding to a panel or an existing mark via</span>
<a href="#l17.3016"></a><span id="l17.3016" class="difflineplus">+ * {@link pv.Mark#add}.</span>
<a href="#l17.3017"></a><span id="l17.3017" class="difflineplus">+ *</span>
<a href="#l17.3018"></a><span id="l17.3018" class="difflineplus">+ * @class Represents a text label, allowing textual annotation of other marks or</span>
<a href="#l17.3019"></a><span id="l17.3019" class="difflineplus">+ * arbitrary text within the visualization. The character data must be plain</span>
<a href="#l17.3020"></a><span id="l17.3020" class="difflineplus">+ * text (unicode), though the text can be styled using the {@link #font}</span>
<a href="#l17.3021"></a><span id="l17.3021" class="difflineplus">+ * property. If rich text is needed, external HTML elements can be overlaid on</span>
<a href="#l17.3022"></a><span id="l17.3022" class="difflineplus">+ * the canvas by hand.</span>
<a href="#l17.3023"></a><span id="l17.3023" class="difflineplus">+ *</span>
<a href="#l17.3024"></a><span id="l17.3024" class="difflineplus">+ * &lt;p&gt;Labels are positioned using the box model, similarly to {@link Dot}. Thus,</span>
<a href="#l17.3025"></a><span id="l17.3025" class="difflineplus">+ * a label has no width or height, but merely a text anchor location. The text</span>
<a href="#l17.3026"></a><span id="l17.3026" class="difflineplus">+ * is positioned relative to this anchor location based on the</span>
<a href="#l17.3027"></a><span id="l17.3027" class="difflineplus">+ * {@link #textAlign}, {@link #textBaseline} and {@link #textMargin} properties.</span>
<a href="#l17.3028"></a><span id="l17.3028" class="difflineplus">+ * Furthermore, the text may be rotated using {@link #textAngle}.</span>
<a href="#l17.3029"></a><span id="l17.3029" class="difflineplus">+ *</span>
<a href="#l17.3030"></a><span id="l17.3030" class="difflineplus">+ * &lt;p&gt;Labels ignore events, so as to not interfere with event handlers on</span>
<a href="#l17.3031"></a><span id="l17.3031" class="difflineplus">+ * underlying marks, such as bars. In the future, we may support event handlers</span>
<a href="#l17.3032"></a><span id="l17.3032" class="difflineplus">+ * on labels.</span>
<a href="#l17.3033"></a><span id="l17.3033" class="difflineplus">+ *</span>
<a href="#l17.3034"></a><span id="l17.3034" class="difflineplus">+ * &lt;p&gt;See also the &lt;a href=&quot;../../api/Label.html&quot;&gt;Label guide&lt;/a&gt;.</span>
<a href="#l17.3035"></a><span id="l17.3035" class="difflineplus">+ *</span>
<a href="#l17.3036"></a><span id="l17.3036" class="difflineplus">+ * @extends pv.Mark</span>
<a href="#l17.3037"></a><span id="l17.3037" class="difflineplus">+ */</span>
<a href="#l17.3038"></a><span id="l17.3038" class="difflineplus">+pv.Label = function() {</span>
<a href="#l17.3039"></a><span id="l17.3039" class="difflineplus">+  pv.Mark.call(this);</span>
<a href="#l17.3040"></a><span id="l17.3040" class="difflineplus">+};</span>
<a href="#l17.3041"></a><span id="l17.3041" class="difflineplus">+pv.Label.prototype = pv.extend(pv.Mark);</span>
<a href="#l17.3042"></a><span id="l17.3042" class="difflineplus">+pv.Label.prototype.type = pv.Label;</span>
<a href="#l17.3043"></a><span id="l17.3043" class="difflineplus">+</span>
<a href="#l17.3044"></a><span id="l17.3044" class="difflineplus">+/**</span>
<a href="#l17.3045"></a><span id="l17.3045" class="difflineplus">+ * Returns &quot;label&quot;.</span>
<a href="#l17.3046"></a><span id="l17.3046" class="difflineplus">+ *</span>
<a href="#l17.3047"></a><span id="l17.3047" class="difflineplus">+ * @returns {string} &quot;label&quot;.</span>
<a href="#l17.3048"></a><span id="l17.3048" class="difflineplus">+ */</span>
<a href="#l17.3049"></a><span id="l17.3049" class="difflineplus">+pv.Label.toString = function() { return &quot;label&quot;; };</span>
<a href="#l17.3050"></a><span id="l17.3050" class="difflineplus">+</span>
<a href="#l17.3051"></a><span id="l17.3051" class="difflineplus">+/**</span>
<a href="#l17.3052"></a><span id="l17.3052" class="difflineplus">+ * The character data to render; a string. The default value of the text</span>
<a href="#l17.3053"></a><span id="l17.3053" class="difflineplus">+ * property is the identity function, meaning the label's associated datum will</span>
<a href="#l17.3054"></a><span id="l17.3054" class="difflineplus">+ * be rendered using its &lt;tt&gt;toString&lt;/tt&gt;.</span>
<a href="#l17.3055"></a><span id="l17.3055" class="difflineplus">+ *</span>
<a href="#l17.3056"></a><span id="l17.3056" class="difflineplus">+ * @type string</span>
<a href="#l17.3057"></a><span id="l17.3057" class="difflineplus">+ * @name pv.Label.prototype.text</span>
<a href="#l17.3058"></a><span id="l17.3058" class="difflineplus">+ */</span>
<a href="#l17.3059"></a><span id="l17.3059" class="difflineplus">+pv.Label.prototype.defineProperty(&quot;text&quot;);</span>
<a href="#l17.3060"></a><span id="l17.3060" class="difflineplus">+</span>
<a href="#l17.3061"></a><span id="l17.3061" class="difflineplus">+/**</span>
<a href="#l17.3062"></a><span id="l17.3062" class="difflineplus">+ * The font format, per the CSS Level 2 specification. The default font is &quot;10px</span>
<a href="#l17.3063"></a><span id="l17.3063" class="difflineplus">+ * sans-serif&quot;, for consistency with the HTML 5 canvas element specification.</span>
<a href="#l17.3064"></a><span id="l17.3064" class="difflineplus">+ * Note that since text is not wrapped, any line-height property will be</span>
<a href="#l17.3065"></a><span id="l17.3065" class="difflineplus">+ * ignored. The other font-style, font-variant, font-weight, font-size and</span>
<a href="#l17.3066"></a><span id="l17.3066" class="difflineplus">+ * font-family properties are supported.</span>
<a href="#l17.3067"></a><span id="l17.3067" class="difflineplus">+ *</span>
<a href="#l17.3068"></a><span id="l17.3068" class="difflineplus">+ * @see &lt;a href=&quot;http://www.w3.org/TR/CSS2/fonts.html#font-shorthand&quot;&gt;CSS2 fonts&lt;/a&gt;.</span>
<a href="#l17.3069"></a><span id="l17.3069" class="difflineplus">+ * @type string</span>
<a href="#l17.3070"></a><span id="l17.3070" class="difflineplus">+ * @name pv.Label.prototype.font</span>
<a href="#l17.3071"></a><span id="l17.3071" class="difflineplus">+ */</span>
<a href="#l17.3072"></a><span id="l17.3072" class="difflineplus">+pv.Label.prototype.defineProperty(&quot;font&quot;);</span>
<a href="#l17.3073"></a><span id="l17.3073" class="difflineplus">+</span>
<a href="#l17.3074"></a><span id="l17.3074" class="difflineplus">+/**</span>
<a href="#l17.3075"></a><span id="l17.3075" class="difflineplus">+ * The rotation angle, in radians. Text is rotated clockwise relative to the</span>
<a href="#l17.3076"></a><span id="l17.3076" class="difflineplus">+ * anchor location. For example, with the default left alignment, an angle of</span>
<a href="#l17.3077"></a><span id="l17.3077" class="difflineplus">+ * Math.PI / 2 causes text to proceed downwards. The default angle is zero.</span>
<a href="#l17.3078"></a><span id="l17.3078" class="difflineplus">+ *</span>
<a href="#l17.3079"></a><span id="l17.3079" class="difflineplus">+ * @type number</span>
<a href="#l17.3080"></a><span id="l17.3080" class="difflineplus">+ * @name pv.Label.prototype.textAngle</span>
<a href="#l17.3081"></a><span id="l17.3081" class="difflineplus">+ */</span>
<a href="#l17.3082"></a><span id="l17.3082" class="difflineplus">+pv.Label.prototype.defineProperty(&quot;textAngle&quot;);</span>
<a href="#l17.3083"></a><span id="l17.3083" class="difflineplus">+</span>
<a href="#l17.3084"></a><span id="l17.3084" class="difflineplus">+/**</span>
<a href="#l17.3085"></a><span id="l17.3085" class="difflineplus">+ * The text color. The name &quot;textStyle&quot; is used for consistency with &quot;fillStyle&quot;</span>
<a href="#l17.3086"></a><span id="l17.3086" class="difflineplus">+ * and &quot;strokeStyle&quot;, although it might be better to rename this property (and</span>
<a href="#l17.3087"></a><span id="l17.3087" class="difflineplus">+ * perhaps use the same name as &quot;strokeStyle&quot;). The default color is black.</span>
<a href="#l17.3088"></a><span id="l17.3088" class="difflineplus">+ *</span>
<a href="#l17.3089"></a><span id="l17.3089" class="difflineplus">+ * @type string</span>
<a href="#l17.3090"></a><span id="l17.3090" class="difflineplus">+ * @name pv.Label.prototype.textStyle</span>
<a href="#l17.3091"></a><span id="l17.3091" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.3092"></a><span id="l17.3092" class="difflineplus">+ */</span>
<a href="#l17.3093"></a><span id="l17.3093" class="difflineplus">+pv.Label.prototype.defineProperty(&quot;textStyle&quot;);</span>
<a href="#l17.3094"></a><span id="l17.3094" class="difflineplus">+</span>
<a href="#l17.3095"></a><span id="l17.3095" class="difflineplus">+/**</span>
<a href="#l17.3096"></a><span id="l17.3096" class="difflineplus">+ * The horizontal text alignment. One of:&lt;ul&gt;</span>
<a href="#l17.3097"></a><span id="l17.3097" class="difflineplus">+ *</span>
<a href="#l17.3098"></a><span id="l17.3098" class="difflineplus">+ * &lt;li&gt;left</span>
<a href="#l17.3099"></a><span id="l17.3099" class="difflineplus">+ * &lt;li&gt;center</span>
<a href="#l17.3100"></a><span id="l17.3100" class="difflineplus">+ * &lt;li&gt;right</span>
<a href="#l17.3101"></a><span id="l17.3101" class="difflineplus">+ *</span>
<a href="#l17.3102"></a><span id="l17.3102" class="difflineplus">+ * &lt;/ul&gt;The default horizontal alignment is left.</span>
<a href="#l17.3103"></a><span id="l17.3103" class="difflineplus">+ *</span>
<a href="#l17.3104"></a><span id="l17.3104" class="difflineplus">+ * @type string</span>
<a href="#l17.3105"></a><span id="l17.3105" class="difflineplus">+ * @name pv.Label.prototype.textAlign</span>
<a href="#l17.3106"></a><span id="l17.3106" class="difflineplus">+ */</span>
<a href="#l17.3107"></a><span id="l17.3107" class="difflineplus">+pv.Label.prototype.defineProperty(&quot;textAlign&quot;);</span>
<a href="#l17.3108"></a><span id="l17.3108" class="difflineplus">+</span>
<a href="#l17.3109"></a><span id="l17.3109" class="difflineplus">+/**</span>
<a href="#l17.3110"></a><span id="l17.3110" class="difflineplus">+ * The vertical text alignment. One of:&lt;ul&gt;</span>
<a href="#l17.3111"></a><span id="l17.3111" class="difflineplus">+ *</span>
<a href="#l17.3112"></a><span id="l17.3112" class="difflineplus">+ * &lt;li&gt;top</span>
<a href="#l17.3113"></a><span id="l17.3113" class="difflineplus">+ * &lt;li&gt;middle</span>
<a href="#l17.3114"></a><span id="l17.3114" class="difflineplus">+ * &lt;li&gt;bottom</span>
<a href="#l17.3115"></a><span id="l17.3115" class="difflineplus">+ *</span>
<a href="#l17.3116"></a><span id="l17.3116" class="difflineplus">+ * &lt;/ul&gt;The default vertical alignment is bottom.</span>
<a href="#l17.3117"></a><span id="l17.3117" class="difflineplus">+ *</span>
<a href="#l17.3118"></a><span id="l17.3118" class="difflineplus">+ * @type string</span>
<a href="#l17.3119"></a><span id="l17.3119" class="difflineplus">+ * @name pv.Label.prototype.textBaseline</span>
<a href="#l17.3120"></a><span id="l17.3120" class="difflineplus">+ */</span>
<a href="#l17.3121"></a><span id="l17.3121" class="difflineplus">+pv.Label.prototype.defineProperty(&quot;textBaseline&quot;);</span>
<a href="#l17.3122"></a><span id="l17.3122" class="difflineplus">+</span>
<a href="#l17.3123"></a><span id="l17.3123" class="difflineplus">+/**</span>
<a href="#l17.3124"></a><span id="l17.3124" class="difflineplus">+ * The text margin; may be specified in pixels, or in font-dependent units</span>
<a href="#l17.3125"></a><span id="l17.3125" class="difflineplus">+ * (e.g., &quot;.1ex&quot;). The margin can be used to pad text away from its anchor</span>
<a href="#l17.3126"></a><span id="l17.3126" class="difflineplus">+ * location, in a direction dependent on the horizontal and vertical alignment</span>
<a href="#l17.3127"></a><span id="l17.3127" class="difflineplus">+ * properties. For example, if the text is left- and middle-aligned, the margin</span>
<a href="#l17.3128"></a><span id="l17.3128" class="difflineplus">+ * shifts the text to the right. The default margin is 3 pixels.</span>
<a href="#l17.3129"></a><span id="l17.3129" class="difflineplus">+ *</span>
<a href="#l17.3130"></a><span id="l17.3130" class="difflineplus">+ * @type number</span>
<a href="#l17.3131"></a><span id="l17.3131" class="difflineplus">+ * @name pv.Label.prototype.textMargin</span>
<a href="#l17.3132"></a><span id="l17.3132" class="difflineplus">+ */</span>
<a href="#l17.3133"></a><span id="l17.3133" class="difflineplus">+pv.Label.prototype.defineProperty(&quot;textMargin&quot;);</span>
<a href="#l17.3134"></a><span id="l17.3134" class="difflineplus">+</span>
<a href="#l17.3135"></a><span id="l17.3135" class="difflineplus">+/**</span>
<a href="#l17.3136"></a><span id="l17.3136" class="difflineplus">+ * A list of shadow effects to be applied to text, per the CSS Text Level 3</span>
<a href="#l17.3137"></a><span id="l17.3137" class="difflineplus">+ * text-shadow property. An example specification is &quot;0.1em 0.1em 0.1em</span>
<a href="#l17.3138"></a><span id="l17.3138" class="difflineplus">+ * rgba(0,0,0,.5)&quot;; the first length is the horizontal offset, the second the</span>
<a href="#l17.3139"></a><span id="l17.3139" class="difflineplus">+ * vertical offset, and the third the blur radius.</span>
<a href="#l17.3140"></a><span id="l17.3140" class="difflineplus">+ *</span>
<a href="#l17.3141"></a><span id="l17.3141" class="difflineplus">+ * @see &lt;a href=&quot;http://www.w3.org/TR/css3-text/#text-shadow&quot;&gt;CSS3 text&lt;/a&gt;.</span>
<a href="#l17.3142"></a><span id="l17.3142" class="difflineplus">+ * @type string</span>
<a href="#l17.3143"></a><span id="l17.3143" class="difflineplus">+ * @name pv.Label.prototype.textShadow</span>
<a href="#l17.3144"></a><span id="l17.3144" class="difflineplus">+ */</span>
<a href="#l17.3145"></a><span id="l17.3145" class="difflineplus">+pv.Label.prototype.defineProperty(&quot;textShadow&quot;);</span>
<a href="#l17.3146"></a><span id="l17.3146" class="difflineplus">+</span>
<a href="#l17.3147"></a><span id="l17.3147" class="difflineplus">+/**</span>
<a href="#l17.3148"></a><span id="l17.3148" class="difflineplus">+ * Default properties for labels. See the individual properties for the default</span>
<a href="#l17.3149"></a><span id="l17.3149" class="difflineplus">+ * values.</span>
<a href="#l17.3150"></a><span id="l17.3150" class="difflineplus">+ *</span>
<a href="#l17.3151"></a><span id="l17.3151" class="difflineplus">+ * @type pv.Label</span>
<a href="#l17.3152"></a><span id="l17.3152" class="difflineplus">+ */</span>
<a href="#l17.3153"></a><span id="l17.3153" class="difflineplus">+pv.Label.defaults = new pv.Label().extend(pv.Mark.defaults)</span>
<a href="#l17.3154"></a><span id="l17.3154" class="difflineplus">+    .text(pv.identity)</span>
<a href="#l17.3155"></a><span id="l17.3155" class="difflineplus">+    .font(&quot;10px sans-serif&quot;)</span>
<a href="#l17.3156"></a><span id="l17.3156" class="difflineplus">+    .textAngle(0)</span>
<a href="#l17.3157"></a><span id="l17.3157" class="difflineplus">+    .textStyle(&quot;black&quot;)</span>
<a href="#l17.3158"></a><span id="l17.3158" class="difflineplus">+    .textAlign(&quot;left&quot;)</span>
<a href="#l17.3159"></a><span id="l17.3159" class="difflineplus">+    .textBaseline(&quot;bottom&quot;)</span>
<a href="#l17.3160"></a><span id="l17.3160" class="difflineplus">+    .textMargin(3);</span>
<a href="#l17.3161"></a><span id="l17.3161" class="difflineplus">+</span>
<a href="#l17.3162"></a><span id="l17.3162" class="difflineplus">+/**</span>
<a href="#l17.3163"></a><span id="l17.3163" class="difflineplus">+ * Updates the display for the specified label instance &lt;tt&gt;s&lt;/tt&gt; in the scene</span>
<a href="#l17.3164"></a><span id="l17.3164" class="difflineplus">+ * graph. This implementation handles the text formatting for the label, as well</span>
<a href="#l17.3165"></a><span id="l17.3165" class="difflineplus">+ * as positional properties.</span>
<a href="#l17.3166"></a><span id="l17.3166" class="difflineplus">+ *</span>
<a href="#l17.3167"></a><span id="l17.3167" class="difflineplus">+ * @param s a node in the scene graph; the instance of the dot to update.</span>
<a href="#l17.3168"></a><span id="l17.3168" class="difflineplus">+ */</span>
<a href="#l17.3169"></a><span id="l17.3169" class="difflineplus">+pv.Label.prototype.updateInstance = function(s) {</span>
<a href="#l17.3170"></a><span id="l17.3170" class="difflineplus">+  var v = s.svg;</span>
<a href="#l17.3171"></a><span id="l17.3171" class="difflineplus">+</span>
<a href="#l17.3172"></a><span id="l17.3172" class="difflineplus">+  /* Create the svg:text element, if necessary. */</span>
<a href="#l17.3173"></a><span id="l17.3173" class="difflineplus">+  if (s.visible &amp;&amp; !v) {</span>
<a href="#l17.3174"></a><span id="l17.3174" class="difflineplus">+    v = s.svg = document.createElementNS(pv.ns.svg, &quot;text&quot;);</span>
<a href="#l17.3175"></a><span id="l17.3175" class="difflineplus">+    v.$text = document.createTextNode(&quot;&quot;);</span>
<a href="#l17.3176"></a><span id="l17.3176" class="difflineplus">+    v.appendChild(v.$text);</span>
<a href="#l17.3177"></a><span id="l17.3177" class="difflineplus">+    s.parent.svg.appendChild(v);</span>
<a href="#l17.3178"></a><span id="l17.3178" class="difflineplus">+  }</span>
<a href="#l17.3179"></a><span id="l17.3179" class="difflineplus">+</span>
<a href="#l17.3180"></a><span id="l17.3180" class="difflineplus">+  /* cursor, title, events, visible, etc. */</span>
<a href="#l17.3181"></a><span id="l17.3181" class="difflineplus">+  pv.Mark.prototype.updateInstance.call(this, s);</span>
<a href="#l17.3182"></a><span id="l17.3182" class="difflineplus">+  if (!s.visible) return;</span>
<a href="#l17.3183"></a><span id="l17.3183" class="difflineplus">+</span>
<a href="#l17.3184"></a><span id="l17.3184" class="difflineplus">+  /* left, top, angle */</span>
<a href="#l17.3185"></a><span id="l17.3185" class="difflineplus">+  v.setAttribute(&quot;transform&quot;, &quot;translate(&quot; + s.left + &quot;,&quot; + s.top + &quot;)&quot;</span>
<a href="#l17.3186"></a><span id="l17.3186" class="difflineplus">+      + (s.textAngle ? &quot; rotate(&quot; + 180 * s.textAngle / Math.PI + &quot;)&quot; : &quot;&quot;));</span>
<a href="#l17.3187"></a><span id="l17.3187" class="difflineplus">+</span>
<a href="#l17.3188"></a><span id="l17.3188" class="difflineplus">+  /* text-baseline */</span>
<a href="#l17.3189"></a><span id="l17.3189" class="difflineplus">+  switch (s.textBaseline) {</span>
<a href="#l17.3190"></a><span id="l17.3190" class="difflineplus">+    case &quot;middle&quot;: {</span>
<a href="#l17.3191"></a><span id="l17.3191" class="difflineplus">+      v.removeAttribute(&quot;y&quot;);</span>
<a href="#l17.3192"></a><span id="l17.3192" class="difflineplus">+      v.setAttribute(&quot;dy&quot;, &quot;.35em&quot;);</span>
<a href="#l17.3193"></a><span id="l17.3193" class="difflineplus">+      break;</span>
<a href="#l17.3194"></a><span id="l17.3194" class="difflineplus">+    }</span>
<a href="#l17.3195"></a><span id="l17.3195" class="difflineplus">+    case &quot;top&quot;: {</span>
<a href="#l17.3196"></a><span id="l17.3196" class="difflineplus">+      v.setAttribute(&quot;y&quot;, s.textMargin);</span>
<a href="#l17.3197"></a><span id="l17.3197" class="difflineplus">+      v.setAttribute(&quot;dy&quot;, &quot;.71em&quot;);</span>
<a href="#l17.3198"></a><span id="l17.3198" class="difflineplus">+      break;</span>
<a href="#l17.3199"></a><span id="l17.3199" class="difflineplus">+    }</span>
<a href="#l17.3200"></a><span id="l17.3200" class="difflineplus">+    case &quot;bottom&quot;: {</span>
<a href="#l17.3201"></a><span id="l17.3201" class="difflineplus">+      v.setAttribute(&quot;y&quot;, &quot;-&quot; + s.textMargin);</span>
<a href="#l17.3202"></a><span id="l17.3202" class="difflineplus">+      v.removeAttribute(&quot;dy&quot;);</span>
<a href="#l17.3203"></a><span id="l17.3203" class="difflineplus">+      break;</span>
<a href="#l17.3204"></a><span id="l17.3204" class="difflineplus">+    }</span>
<a href="#l17.3205"></a><span id="l17.3205" class="difflineplus">+  }</span>
<a href="#l17.3206"></a><span id="l17.3206" class="difflineplus">+</span>
<a href="#l17.3207"></a><span id="l17.3207" class="difflineplus">+  /* text-align */</span>
<a href="#l17.3208"></a><span id="l17.3208" class="difflineplus">+  switch (s.textAlign) {</span>
<a href="#l17.3209"></a><span id="l17.3209" class="difflineplus">+    case &quot;right&quot;: {</span>
<a href="#l17.3210"></a><span id="l17.3210" class="difflineplus">+      v.setAttribute(&quot;text-anchor&quot;, &quot;end&quot;);</span>
<a href="#l17.3211"></a><span id="l17.3211" class="difflineplus">+      v.setAttribute(&quot;x&quot;, &quot;-&quot; + s.textMargin);</span>
<a href="#l17.3212"></a><span id="l17.3212" class="difflineplus">+      break;</span>
<a href="#l17.3213"></a><span id="l17.3213" class="difflineplus">+    }</span>
<a href="#l17.3214"></a><span id="l17.3214" class="difflineplus">+    case &quot;center&quot;: {</span>
<a href="#l17.3215"></a><span id="l17.3215" class="difflineplus">+      v.setAttribute(&quot;text-anchor&quot;, &quot;middle&quot;);</span>
<a href="#l17.3216"></a><span id="l17.3216" class="difflineplus">+      v.removeAttribute(&quot;x&quot;);</span>
<a href="#l17.3217"></a><span id="l17.3217" class="difflineplus">+      break;</span>
<a href="#l17.3218"></a><span id="l17.3218" class="difflineplus">+    }</span>
<a href="#l17.3219"></a><span id="l17.3219" class="difflineplus">+    case &quot;left&quot;: {</span>
<a href="#l17.3220"></a><span id="l17.3220" class="difflineplus">+      v.setAttribute(&quot;text-anchor&quot;, &quot;start&quot;);</span>
<a href="#l17.3221"></a><span id="l17.3221" class="difflineplus">+      v.setAttribute(&quot;x&quot;, s.textMargin);</span>
<a href="#l17.3222"></a><span id="l17.3222" class="difflineplus">+      break;</span>
<a href="#l17.3223"></a><span id="l17.3223" class="difflineplus">+    }</span>
<a href="#l17.3224"></a><span id="l17.3224" class="difflineplus">+  }</span>
<a href="#l17.3225"></a><span id="l17.3225" class="difflineplus">+</span>
<a href="#l17.3226"></a><span id="l17.3226" class="difflineplus">+  /* font, text-shadow TODO centralize font definition? */</span>
<a href="#l17.3227"></a><span id="l17.3227" class="difflineplus">+  v.$text.nodeValue = s.text;</span>
<a href="#l17.3228"></a><span id="l17.3228" class="difflineplus">+  var style = &quot;font:&quot; + s.font + &quot;;&quot;;</span>
<a href="#l17.3229"></a><span id="l17.3229" class="difflineplus">+  if (s.textShadow) {</span>
<a href="#l17.3230"></a><span id="l17.3230" class="difflineplus">+    style += &quot;text-shadow:&quot; + s.textShadow +&quot;;&quot;;</span>
<a href="#l17.3231"></a><span id="l17.3231" class="difflineplus">+  }</span>
<a href="#l17.3232"></a><span id="l17.3232" class="difflineplus">+  v.setAttribute(&quot;style&quot;, style);</span>
<a href="#l17.3233"></a><span id="l17.3233" class="difflineplus">+</span>
<a href="#l17.3234"></a><span id="l17.3234" class="difflineplus">+  /* fill */</span>
<a href="#l17.3235"></a><span id="l17.3235" class="difflineplus">+  var fill = pv.color(s.textStyle);</span>
<a href="#l17.3236"></a><span id="l17.3236" class="difflineplus">+  v.setAttribute(&quot;fill&quot;, fill.color);</span>
<a href="#l17.3237"></a><span id="l17.3237" class="difflineplus">+  v.setAttribute(&quot;fill-opacity&quot;, fill.opacity);</span>
<a href="#l17.3238"></a><span id="l17.3238" class="difflineplus">+</span>
<a href="#l17.3239"></a><span id="l17.3239" class="difflineplus">+  /* TODO enable interaction on labels? centralize this definition? */</span>
<a href="#l17.3240"></a><span id="l17.3240" class="difflineplus">+  v.setAttribute(&quot;pointer-events&quot;, &quot;none&quot;);</span>
<a href="#l17.3241"></a><span id="l17.3241" class="difflineplus">+};</span>
<a href="#l17.3242"></a><span id="l17.3242" class="difflineplus">+/**</span>
<a href="#l17.3243"></a><span id="l17.3243" class="difflineplus">+ * Constructs a new line mark with default properties. Lines are not typically</span>
<a href="#l17.3244"></a><span id="l17.3244" class="difflineplus">+ * constructed directly, but by adding to a panel or an existing mark via</span>
<a href="#l17.3245"></a><span id="l17.3245" class="difflineplus">+ * {@link pv.Mark#add}.</span>
<a href="#l17.3246"></a><span id="l17.3246" class="difflineplus">+ *</span>
<a href="#l17.3247"></a><span id="l17.3247" class="difflineplus">+ * @class Represents a series of connected line segments, or &lt;i&gt;polyline&lt;/i&gt;,</span>
<a href="#l17.3248"></a><span id="l17.3248" class="difflineplus">+ * that can be stroked with a configurable color and thickness. Each</span>
<a href="#l17.3249"></a><span id="l17.3249" class="difflineplus">+ * articulation point in the line corresponds to a datum; for &lt;i&gt;n&lt;/i&gt; points,</span>
<a href="#l17.3250"></a><span id="l17.3250" class="difflineplus">+ * &lt;i&gt;n&lt;/i&gt;-1 connected line segments are drawn. The point is positioned using</span>
<a href="#l17.3251"></a><span id="l17.3251" class="difflineplus">+ * the box model. Arbitrary paths are also possible, allowing radar plots and</span>
<a href="#l17.3252"></a><span id="l17.3252" class="difflineplus">+ * other custom visualizations.</span>
<a href="#l17.3253"></a><span id="l17.3253" class="difflineplus">+ *</span>
<a href="#l17.3254"></a><span id="l17.3254" class="difflineplus">+ * &lt;p&gt;Like areas, lines can be stroked and filled with arbitrary colors. In most</span>
<a href="#l17.3255"></a><span id="l17.3255" class="difflineplus">+ * cases, lines are only stroked, but the fill style can be used to construct</span>
<a href="#l17.3256"></a><span id="l17.3256" class="difflineplus">+ * arbitrary polygons.</span>
<a href="#l17.3257"></a><span id="l17.3257" class="difflineplus">+ *</span>
<a href="#l17.3258"></a><span id="l17.3258" class="difflineplus">+ * &lt;p&gt;See also the &lt;a href=&quot;../../api/Line.html&quot;&gt;Line guide&lt;/a&gt;.</span>
<a href="#l17.3259"></a><span id="l17.3259" class="difflineplus">+ *</span>
<a href="#l17.3260"></a><span id="l17.3260" class="difflineplus">+ * @extends pv.Mark</span>
<a href="#l17.3261"></a><span id="l17.3261" class="difflineplus">+ */</span>
<a href="#l17.3262"></a><span id="l17.3262" class="difflineplus">+pv.Line = function() {</span>
<a href="#l17.3263"></a><span id="l17.3263" class="difflineplus">+  pv.Mark.call(this);</span>
<a href="#l17.3264"></a><span id="l17.3264" class="difflineplus">+};</span>
<a href="#l17.3265"></a><span id="l17.3265" class="difflineplus">+pv.Line.prototype = pv.extend(pv.Mark);</span>
<a href="#l17.3266"></a><span id="l17.3266" class="difflineplus">+pv.Line.prototype.type = pv.Line;</span>
<a href="#l17.3267"></a><span id="l17.3267" class="difflineplus">+</span>
<a href="#l17.3268"></a><span id="l17.3268" class="difflineplus">+/**</span>
<a href="#l17.3269"></a><span id="l17.3269" class="difflineplus">+ * Returns &quot;line&quot;.</span>
<a href="#l17.3270"></a><span id="l17.3270" class="difflineplus">+ *</span>
<a href="#l17.3271"></a><span id="l17.3271" class="difflineplus">+ * @returns {string} &quot;line&quot;.</span>
<a href="#l17.3272"></a><span id="l17.3272" class="difflineplus">+ */</span>
<a href="#l17.3273"></a><span id="l17.3273" class="difflineplus">+pv.Line.toString = function() { return &quot;line&quot;; };</span>
<a href="#l17.3274"></a><span id="l17.3274" class="difflineplus">+</span>
<a href="#l17.3275"></a><span id="l17.3275" class="difflineplus">+/**</span>
<a href="#l17.3276"></a><span id="l17.3276" class="difflineplus">+ * The width of stroked lines, in pixels; used in conjunction with</span>
<a href="#l17.3277"></a><span id="l17.3277" class="difflineplus">+ * &lt;tt&gt;strokeStyle&lt;/tt&gt; to stroke the line.</span>
<a href="#l17.3278"></a><span id="l17.3278" class="difflineplus">+ *</span>
<a href="#l17.3279"></a><span id="l17.3279" class="difflineplus">+ * @type number</span>
<a href="#l17.3280"></a><span id="l17.3280" class="difflineplus">+ * @name pv.Line.prototype.lineWidth</span>
<a href="#l17.3281"></a><span id="l17.3281" class="difflineplus">+ */</span>
<a href="#l17.3282"></a><span id="l17.3282" class="difflineplus">+pv.Line.prototype.defineProperty(&quot;lineWidth&quot;);</span>
<a href="#l17.3283"></a><span id="l17.3283" class="difflineplus">+</span>
<a href="#l17.3284"></a><span id="l17.3284" class="difflineplus">+/**</span>
<a href="#l17.3285"></a><span id="l17.3285" class="difflineplus">+ * The style of stroked lines; used in conjunction with &lt;tt&gt;lineWidth&lt;/tt&gt; to</span>
<a href="#l17.3286"></a><span id="l17.3286" class="difflineplus">+ * stroke the line. The default value of this property is a categorical color.</span>
<a href="#l17.3287"></a><span id="l17.3287" class="difflineplus">+ *</span>
<a href="#l17.3288"></a><span id="l17.3288" class="difflineplus">+ * @type string</span>
<a href="#l17.3289"></a><span id="l17.3289" class="difflineplus">+ * @name pv.Line.prototype.strokeStyle</span>
<a href="#l17.3290"></a><span id="l17.3290" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.3291"></a><span id="l17.3291" class="difflineplus">+ */</span>
<a href="#l17.3292"></a><span id="l17.3292" class="difflineplus">+pv.Line.prototype.defineProperty(&quot;strokeStyle&quot;);</span>
<a href="#l17.3293"></a><span id="l17.3293" class="difflineplus">+</span>
<a href="#l17.3294"></a><span id="l17.3294" class="difflineplus">+/**</span>
<a href="#l17.3295"></a><span id="l17.3295" class="difflineplus">+ * The line fill style; if non-null, the interior of the line is closed and</span>
<a href="#l17.3296"></a><span id="l17.3296" class="difflineplus">+ * filled with the specified color. The default value of this property is a</span>
<a href="#l17.3297"></a><span id="l17.3297" class="difflineplus">+ * null, meaning that lines are not filled by default.</span>
<a href="#l17.3298"></a><span id="l17.3298" class="difflineplus">+ *</span>
<a href="#l17.3299"></a><span id="l17.3299" class="difflineplus">+ * @type string</span>
<a href="#l17.3300"></a><span id="l17.3300" class="difflineplus">+ * @name pv.Line.prototype.fillStyle</span>
<a href="#l17.3301"></a><span id="l17.3301" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.3302"></a><span id="l17.3302" class="difflineplus">+ */</span>
<a href="#l17.3303"></a><span id="l17.3303" class="difflineplus">+pv.Line.prototype.defineProperty(&quot;fillStyle&quot;);</span>
<a href="#l17.3304"></a><span id="l17.3304" class="difflineplus">+</span>
<a href="#l17.3305"></a><span id="l17.3305" class="difflineplus">+/**</span>
<a href="#l17.3306"></a><span id="l17.3306" class="difflineplus">+ * Default properties for lines. By default, there is no fill and the stroke</span>
<a href="#l17.3307"></a><span id="l17.3307" class="difflineplus">+ * style is a categorical color.</span>
<a href="#l17.3308"></a><span id="l17.3308" class="difflineplus">+ *</span>
<a href="#l17.3309"></a><span id="l17.3309" class="difflineplus">+ * @type pv.Line</span>
<a href="#l17.3310"></a><span id="l17.3310" class="difflineplus">+ */</span>
<a href="#l17.3311"></a><span id="l17.3311" class="difflineplus">+pv.Line.defaults = new pv.Line().extend(pv.Mark.defaults)</span>
<a href="#l17.3312"></a><span id="l17.3312" class="difflineplus">+    .lineWidth(1.5)</span>
<a href="#l17.3313"></a><span id="l17.3313" class="difflineplus">+    .strokeStyle(pv.Colors.category10);</span>
<a href="#l17.3314"></a><span id="l17.3314" class="difflineplus">+</span>
<a href="#l17.3315"></a><span id="l17.3315" class="difflineplus">+/**</span>
<a href="#l17.3316"></a><span id="l17.3316" class="difflineplus">+ * Override the default update implementation, since the line mark generates a</span>
<a href="#l17.3317"></a><span id="l17.3317" class="difflineplus">+ * single graphical element rather than multiple distinct elements.</span>
<a href="#l17.3318"></a><span id="l17.3318" class="difflineplus">+ */</span>
<a href="#l17.3319"></a><span id="l17.3319" class="difflineplus">+pv.Line.prototype.update = function() {</span>
<a href="#l17.3320"></a><span id="l17.3320" class="difflineplus">+  if (!this.scene.length) return;</span>
<a href="#l17.3321"></a><span id="l17.3321" class="difflineplus">+</span>
<a href="#l17.3322"></a><span id="l17.3322" class="difflineplus">+  /* visible */</span>
<a href="#l17.3323"></a><span id="l17.3323" class="difflineplus">+  var s = this.scene[0], v = s.svg;</span>
<a href="#l17.3324"></a><span id="l17.3324" class="difflineplus">+  if (s.visible) {</span>
<a href="#l17.3325"></a><span id="l17.3325" class="difflineplus">+</span>
<a href="#l17.3326"></a><span id="l17.3326" class="difflineplus">+    /* Create the svg:polyline element, if necessary. */</span>
<a href="#l17.3327"></a><span id="l17.3327" class="difflineplus">+    if (!v) {</span>
<a href="#l17.3328"></a><span id="l17.3328" class="difflineplus">+      v = s.svg = document.createElementNS(pv.ns.svg, &quot;polyline&quot;);</span>
<a href="#l17.3329"></a><span id="l17.3329" class="difflineplus">+      s.parent.svg.appendChild(v);</span>
<a href="#l17.3330"></a><span id="l17.3330" class="difflineplus">+    }</span>
<a href="#l17.3331"></a><span id="l17.3331" class="difflineplus">+</span>
<a href="#l17.3332"></a><span id="l17.3332" class="difflineplus">+    /* left, top TODO allow points to be changed on events? */</span>
<a href="#l17.3333"></a><span id="l17.3333" class="difflineplus">+    var p = &quot;&quot;;</span>
<a href="#l17.3334"></a><span id="l17.3334" class="difflineplus">+    for (var i = 0; i &lt; this.scene.length; i++) {</span>
<a href="#l17.3335"></a><span id="l17.3335" class="difflineplus">+      var si = this.scene[i];</span>
<a href="#l17.3336"></a><span id="l17.3336" class="difflineplus">+      if (isNaN(si.left)) si.left = 0;</span>
<a href="#l17.3337"></a><span id="l17.3337" class="difflineplus">+      if (isNaN(si.top)) si.top = 0;</span>
<a href="#l17.3338"></a><span id="l17.3338" class="difflineplus">+      p += si.left + &quot;,&quot; + si.top + &quot; &quot;;</span>
<a href="#l17.3339"></a><span id="l17.3339" class="difflineplus">+    }</span>
<a href="#l17.3340"></a><span id="l17.3340" class="difflineplus">+    v.setAttribute(&quot;points&quot;, p);</span>
<a href="#l17.3341"></a><span id="l17.3341" class="difflineplus">+</span>
<a href="#l17.3342"></a><span id="l17.3342" class="difflineplus">+    /* cursor, title, events, etc. */</span>
<a href="#l17.3343"></a><span id="l17.3343" class="difflineplus">+    this.updateInstance(s);</span>
<a href="#l17.3344"></a><span id="l17.3344" class="difflineplus">+    v.removeAttribute(&quot;display&quot;);</span>
<a href="#l17.3345"></a><span id="l17.3345" class="difflineplus">+  } else if (v) {</span>
<a href="#l17.3346"></a><span id="l17.3346" class="difflineplus">+    v.setAttribute(&quot;display&quot;, &quot;none&quot;);</span>
<a href="#l17.3347"></a><span id="l17.3347" class="difflineplus">+  }</span>
<a href="#l17.3348"></a><span id="l17.3348" class="difflineplus">+};</span>
<a href="#l17.3349"></a><span id="l17.3349" class="difflineplus">+</span>
<a href="#l17.3350"></a><span id="l17.3350" class="difflineplus">+/**</span>
<a href="#l17.3351"></a><span id="l17.3351" class="difflineplus">+ * Updates the display for the (singleton) line instance. The line mark</span>
<a href="#l17.3352"></a><span id="l17.3352" class="difflineplus">+ * generates a single graphical element rather than multiple distinct elements.</span>
<a href="#l17.3353"></a><span id="l17.3353" class="difflineplus">+ *</span>
<a href="#l17.3354"></a><span id="l17.3354" class="difflineplus">+ * &lt;p&gt;TODO Recompute points? For efficiency, the points are not recomputed, and</span>
<a href="#l17.3355"></a><span id="l17.3355" class="difflineplus">+ * therefore cannot be updated automatically from event handlers without an</span>
<a href="#l17.3356"></a><span id="l17.3356" class="difflineplus">+ * explicit call to rebuild the line.</span>
<a href="#l17.3357"></a><span id="l17.3357" class="difflineplus">+ *</span>
<a href="#l17.3358"></a><span id="l17.3358" class="difflineplus">+ * @param s a node in the scene graph; the instance of the mark to update.</span>
<a href="#l17.3359"></a><span id="l17.3359" class="difflineplus">+ */</span>
<a href="#l17.3360"></a><span id="l17.3360" class="difflineplus">+pv.Line.prototype.updateInstance = function(s) {</span>
<a href="#l17.3361"></a><span id="l17.3361" class="difflineplus">+  var v = s.svg;</span>
<a href="#l17.3362"></a><span id="l17.3362" class="difflineplus">+</span>
<a href="#l17.3363"></a><span id="l17.3363" class="difflineplus">+  pv.Mark.prototype.updateInstance.call(this, s);</span>
<a href="#l17.3364"></a><span id="l17.3364" class="difflineplus">+  if (!s.visible) return;</span>
<a href="#l17.3365"></a><span id="l17.3365" class="difflineplus">+</span>
<a href="#l17.3366"></a><span id="l17.3366" class="difflineplus">+  /* fill, stroke TODO gradient, patterns */</span>
<a href="#l17.3367"></a><span id="l17.3367" class="difflineplus">+  var fill = pv.color(s.fillStyle);</span>
<a href="#l17.3368"></a><span id="l17.3368" class="difflineplus">+  v.setAttribute(&quot;fill&quot;, fill.color);</span>
<a href="#l17.3369"></a><span id="l17.3369" class="difflineplus">+  v.setAttribute(&quot;fill-opacity&quot;, fill.opacity);</span>
<a href="#l17.3370"></a><span id="l17.3370" class="difflineplus">+  var stroke = pv.color(s.strokeStyle);</span>
<a href="#l17.3371"></a><span id="l17.3371" class="difflineplus">+  v.setAttribute(&quot;stroke&quot;, stroke.color);</span>
<a href="#l17.3372"></a><span id="l17.3372" class="difflineplus">+  v.setAttribute(&quot;stroke-opacity&quot;, stroke.opacity);</span>
<a href="#l17.3373"></a><span id="l17.3373" class="difflineplus">+  v.setAttribute(&quot;stroke-width&quot;, s.lineWidth);</span>
<a href="#l17.3374"></a><span id="l17.3374" class="difflineplus">+};</span>
<a href="#l17.3375"></a><span id="l17.3375" class="difflineplus">+/**</span>
<a href="#l17.3376"></a><span id="l17.3376" class="difflineplus">+ * Constructs a new, empty panel with default properties. Panels, with the</span>
<a href="#l17.3377"></a><span id="l17.3377" class="difflineplus">+ * exception of the root panel, are not typically constructed directly; instead,</span>
<a href="#l17.3378"></a><span id="l17.3378" class="difflineplus">+ * they are added to an existing panel or mark via {@link pv.Mark#add}.</span>
<a href="#l17.3379"></a><span id="l17.3379" class="difflineplus">+ *</span>
<a href="#l17.3380"></a><span id="l17.3380" class="difflineplus">+ * @class Represents a container mark. Panels allow repeated or nested</span>
<a href="#l17.3381"></a><span id="l17.3381" class="difflineplus">+ * structures, commonly used in small multiple displays where a small</span>
<a href="#l17.3382"></a><span id="l17.3382" class="difflineplus">+ * visualization is tiled to facilitate comparison across one or more</span>
<a href="#l17.3383"></a><span id="l17.3383" class="difflineplus">+ * dimensions. Other types of visualizations may benefit from repeated and</span>
<a href="#l17.3384"></a><span id="l17.3384" class="difflineplus">+ * possibly overlapping structure as well, such as stacked area charts. Panels</span>
<a href="#l17.3385"></a><span id="l17.3385" class="difflineplus">+ * can also offset the position of marks to provide padding from surrounding</span>
<a href="#l17.3386"></a><span id="l17.3386" class="difflineplus">+ * content.</span>
<a href="#l17.3387"></a><span id="l17.3387" class="difflineplus">+ *</span>
<a href="#l17.3388"></a><span id="l17.3388" class="difflineplus">+ * &lt;p&gt;All Protovis displays have at least one panel; this is the root panel to</span>
<a href="#l17.3389"></a><span id="l17.3389" class="difflineplus">+ * which marks are rendered. The box model properties (four margins, width and</span>
<a href="#l17.3390"></a><span id="l17.3390" class="difflineplus">+ * height) are used to offset the positions of contained marks. The data</span>
<a href="#l17.3391"></a><span id="l17.3391" class="difflineplus">+ * property determines the panel count: a panel is generated once per associated</span>
<a href="#l17.3392"></a><span id="l17.3392" class="difflineplus">+ * datum. When nested panels are used, property functions can declare additional</span>
<a href="#l17.3393"></a><span id="l17.3393" class="difflineplus">+ * arguments to access the data associated with enclosing panels.</span>
<a href="#l17.3394"></a><span id="l17.3394" class="difflineplus">+ *</span>
<a href="#l17.3395"></a><span id="l17.3395" class="difflineplus">+ * &lt;p&gt;Panels can be rendered inline, facilitating the creation of sparklines.</span>
<a href="#l17.3396"></a><span id="l17.3396" class="difflineplus">+ * This allows designers to reuse browser layout features, such as text flow and</span>
<a href="#l17.3397"></a><span id="l17.3397" class="difflineplus">+ * tables; designers can also overlay HTML elements such as rich text and</span>
<a href="#l17.3398"></a><span id="l17.3398" class="difflineplus">+ * images.</span>
<a href="#l17.3399"></a><span id="l17.3399" class="difflineplus">+ *</span>
<a href="#l17.3400"></a><span id="l17.3400" class="difflineplus">+ * &lt;p&gt;All panels have a &lt;tt&gt;children&lt;/tt&gt; array (possibly empty) containing the</span>
<a href="#l17.3401"></a><span id="l17.3401" class="difflineplus">+ * child marks in the order they were added. Panels also have a &lt;tt&gt;root&lt;/tt&gt;</span>
<a href="#l17.3402"></a><span id="l17.3402" class="difflineplus">+ * field which points to the root (outermost) panel; the root panel's root field</span>
<a href="#l17.3403"></a><span id="l17.3403" class="difflineplus">+ * points to itself.</span>
<a href="#l17.3404"></a><span id="l17.3404" class="difflineplus">+ *</span>
<a href="#l17.3405"></a><span id="l17.3405" class="difflineplus">+ * &lt;p&gt;See also the &lt;a href=&quot;../../api/&quot;&gt;Protovis guide&lt;/a&gt;.</span>
<a href="#l17.3406"></a><span id="l17.3406" class="difflineplus">+ *</span>
<a href="#l17.3407"></a><span id="l17.3407" class="difflineplus">+ * @extends pv.Bar</span>
<a href="#l17.3408"></a><span id="l17.3408" class="difflineplus">+ */</span>
<a href="#l17.3409"></a><span id="l17.3409" class="difflineplus">+pv.Panel = function() {</span>
<a href="#l17.3410"></a><span id="l17.3410" class="difflineplus">+  pv.Bar.call(this);</span>
<a href="#l17.3411"></a><span id="l17.3411" class="difflineplus">+</span>
<a href="#l17.3412"></a><span id="l17.3412" class="difflineplus">+  /**</span>
<a href="#l17.3413"></a><span id="l17.3413" class="difflineplus">+   * The child marks; zero or more {@link pv.Mark}s in the order they were</span>
<a href="#l17.3414"></a><span id="l17.3414" class="difflineplus">+   * added.</span>
<a href="#l17.3415"></a><span id="l17.3415" class="difflineplus">+   *</span>
<a href="#l17.3416"></a><span id="l17.3416" class="difflineplus">+   * @see #add</span>
<a href="#l17.3417"></a><span id="l17.3417" class="difflineplus">+   * @type pv.Mark[]</span>
<a href="#l17.3418"></a><span id="l17.3418" class="difflineplus">+   */</span>
<a href="#l17.3419"></a><span id="l17.3419" class="difflineplus">+  this.children = [];</span>
<a href="#l17.3420"></a><span id="l17.3420" class="difflineplus">+  this.root = this;</span>
<a href="#l17.3421"></a><span id="l17.3421" class="difflineplus">+</span>
<a href="#l17.3422"></a><span id="l17.3422" class="difflineplus">+  /**</span>
<a href="#l17.3423"></a><span id="l17.3423" class="difflineplus">+   * The internal $dom field is set by the Protovis loader; see lang/init.js. It</span>
<a href="#l17.3424"></a><span id="l17.3424" class="difflineplus">+   * refers to the script element that contains the Protovis specification, so</span>
<a href="#l17.3425"></a><span id="l17.3425" class="difflineplus">+   * that the panel knows where in the DOM to insert the generated SVG element.</span>
<a href="#l17.3426"></a><span id="l17.3426" class="difflineplus">+   *</span>
<a href="#l17.3427"></a><span id="l17.3427" class="difflineplus">+   * @private</span>
<a href="#l17.3428"></a><span id="l17.3428" class="difflineplus">+   */</span>
<a href="#l17.3429"></a><span id="l17.3429" class="difflineplus">+  this.$dom = pv.Panel.$dom;</span>
<a href="#l17.3430"></a><span id="l17.3430" class="difflineplus">+};</span>
<a href="#l17.3431"></a><span id="l17.3431" class="difflineplus">+pv.Panel.prototype = pv.extend(pv.Bar);</span>
<a href="#l17.3432"></a><span id="l17.3432" class="difflineplus">+pv.Panel.prototype.type = pv.Panel;</span>
<a href="#l17.3433"></a><span id="l17.3433" class="difflineplus">+</span>
<a href="#l17.3434"></a><span id="l17.3434" class="difflineplus">+/**</span>
<a href="#l17.3435"></a><span id="l17.3435" class="difflineplus">+ * Returns &quot;panel&quot;.</span>
<a href="#l17.3436"></a><span id="l17.3436" class="difflineplus">+ *</span>
<a href="#l17.3437"></a><span id="l17.3437" class="difflineplus">+ * @returns {string} &quot;panel&quot;.</span>
<a href="#l17.3438"></a><span id="l17.3438" class="difflineplus">+ */</span>
<a href="#l17.3439"></a><span id="l17.3439" class="difflineplus">+pv.Panel.toString = function() { return &quot;panel&quot;; };</span>
<a href="#l17.3440"></a><span id="l17.3440" class="difflineplus">+</span>
<a href="#l17.3441"></a><span id="l17.3441" class="difflineplus">+/**</span>
<a href="#l17.3442"></a><span id="l17.3442" class="difflineplus">+ * The canvas element; either the string ID of the canvas element in the current</span>
<a href="#l17.3443"></a><span id="l17.3443" class="difflineplus">+ * document, or a reference to the canvas element itself. If null, a canvas</span>
<a href="#l17.3444"></a><span id="l17.3444" class="difflineplus">+ * element will be created and inserted into the document at the location of the</span>
<a href="#l17.3445"></a><span id="l17.3445" class="difflineplus">+ * script element containing the current Protovis specification. This property</span>
<a href="#l17.3446"></a><span id="l17.3446" class="difflineplus">+ * only applies to root panels and is ignored on nested panels.</span>
<a href="#l17.3447"></a><span id="l17.3447" class="difflineplus">+ *</span>
<a href="#l17.3448"></a><span id="l17.3448" class="difflineplus">+ * &lt;p&gt;Note: the &quot;canvas&quot; element here refers to a &lt;tt&gt;div&lt;/tt&gt; (or other suitable</span>
<a href="#l17.3449"></a><span id="l17.3449" class="difflineplus">+ * HTML container element), &lt;i&gt;not&lt;/i&gt; a &lt;tt&gt;canvas&lt;/tt&gt; element. The name of</span>
<a href="#l17.3450"></a><span id="l17.3450" class="difflineplus">+ * this property is a historical anachronism from the first implementation that</span>
<a href="#l17.3451"></a><span id="l17.3451" class="difflineplus">+ * used HTML 5 canvas, rather than SVG.</span>
<a href="#l17.3452"></a><span id="l17.3452" class="difflineplus">+ *</span>
<a href="#l17.3453"></a><span id="l17.3453" class="difflineplus">+ * @type string</span>
<a href="#l17.3454"></a><span id="l17.3454" class="difflineplus">+ * @name pv.Panel.prototype.canvas</span>
<a href="#l17.3455"></a><span id="l17.3455" class="difflineplus">+ */</span>
<a href="#l17.3456"></a><span id="l17.3456" class="difflineplus">+pv.Panel.prototype.defineProperty(&quot;canvas&quot;);</span>
<a href="#l17.3457"></a><span id="l17.3457" class="difflineplus">+</span>
<a href="#l17.3458"></a><span id="l17.3458" class="difflineplus">+/**</span>
<a href="#l17.3459"></a><span id="l17.3459" class="difflineplus">+ * The reverse property; a boolean determining whether child marks are ordered</span>
<a href="#l17.3460"></a><span id="l17.3460" class="difflineplus">+ * from front-to-back or back-to-front. SVG does not support explicit</span>
<a href="#l17.3461"></a><span id="l17.3461" class="difflineplus">+ * z-ordering; shapes are rendered in the order they appear. Thus, by default,</span>
<a href="#l17.3462"></a><span id="l17.3462" class="difflineplus">+ * child marks are rendered in the order they are added to the panel. Setting</span>
<a href="#l17.3463"></a><span id="l17.3463" class="difflineplus">+ * the reverse property to false reverses the order in which they are added to</span>
<a href="#l17.3464"></a><span id="l17.3464" class="difflineplus">+ * the SVG element; however, the properties are still evaluated (i.e., built) in</span>
<a href="#l17.3465"></a><span id="l17.3465" class="difflineplus">+ * forward order.</span>
<a href="#l17.3466"></a><span id="l17.3466" class="difflineplus">+ *</span>
<a href="#l17.3467"></a><span id="l17.3467" class="difflineplus">+ * @type boolean</span>
<a href="#l17.3468"></a><span id="l17.3468" class="difflineplus">+ * @name pv.Panel.prototype.reverse</span>
<a href="#l17.3469"></a><span id="l17.3469" class="difflineplus">+ */</span>
<a href="#l17.3470"></a><span id="l17.3470" class="difflineplus">+pv.Panel.prototype.defineProperty(&quot;reverse&quot;);</span>
<a href="#l17.3471"></a><span id="l17.3471" class="difflineplus">+</span>
<a href="#l17.3472"></a><span id="l17.3472" class="difflineplus">+/**</span>
<a href="#l17.3473"></a><span id="l17.3473" class="difflineplus">+ * Default properties for panels. By default, the margins are zero, the fill</span>
<a href="#l17.3474"></a><span id="l17.3474" class="difflineplus">+ * style is transparent, and the reverse property is false.</span>
<a href="#l17.3475"></a><span id="l17.3475" class="difflineplus">+ *</span>
<a href="#l17.3476"></a><span id="l17.3476" class="difflineplus">+ * @type pv.Panel</span>
<a href="#l17.3477"></a><span id="l17.3477" class="difflineplus">+ */</span>
<a href="#l17.3478"></a><span id="l17.3478" class="difflineplus">+pv.Panel.defaults = new pv.Panel().extend(pv.Bar.defaults)</span>
<a href="#l17.3479"></a><span id="l17.3479" class="difflineplus">+    .top(0).left(0).bottom(0).right(0)</span>
<a href="#l17.3480"></a><span id="l17.3480" class="difflineplus">+    .fillStyle(null)</span>
<a href="#l17.3481"></a><span id="l17.3481" class="difflineplus">+    .reverse(false);</span>
<a href="#l17.3482"></a><span id="l17.3482" class="difflineplus">+</span>
<a href="#l17.3483"></a><span id="l17.3483" class="difflineplus">+/**</span>
<a href="#l17.3484"></a><span id="l17.3484" class="difflineplus">+ * Adds a new mark of the specified type to this panel. Unlike the normal</span>
<a href="#l17.3485"></a><span id="l17.3485" class="difflineplus">+ * {@link Mark#add} behavior, adding a mark to a panel does not cause the mark</span>
<a href="#l17.3486"></a><span id="l17.3486" class="difflineplus">+ * to inherit from the panel. Since the contained marks are offset by the panel</span>
<a href="#l17.3487"></a><span id="l17.3487" class="difflineplus">+ * margins already, inheriting properties is generally undesirable; of course,</span>
<a href="#l17.3488"></a><span id="l17.3488" class="difflineplus">+ * it is always possible to change this behavior by calling {@link Mark#extend}</span>
<a href="#l17.3489"></a><span id="l17.3489" class="difflineplus">+ * explicitly.</span>
<a href="#l17.3490"></a><span id="l17.3490" class="difflineplus">+ *</span>
<a href="#l17.3491"></a><span id="l17.3491" class="difflineplus">+ * @param {function} type the type of the new mark to add.</span>
<a href="#l17.3492"></a><span id="l17.3492" class="difflineplus">+ * @returns {pv.Mark} the new mark.</span>
<a href="#l17.3493"></a><span id="l17.3493" class="difflineplus">+ */</span>
<a href="#l17.3494"></a><span id="l17.3494" class="difflineplus">+pv.Panel.prototype.add = function(type) {</span>
<a href="#l17.3495"></a><span id="l17.3495" class="difflineplus">+  var child = new type();</span>
<a href="#l17.3496"></a><span id="l17.3496" class="difflineplus">+  child.parent = this;</span>
<a href="#l17.3497"></a><span id="l17.3497" class="difflineplus">+  child.root = this.root;</span>
<a href="#l17.3498"></a><span id="l17.3498" class="difflineplus">+  child.childIndex = this.children.length;</span>
<a href="#l17.3499"></a><span id="l17.3499" class="difflineplus">+  this.children.push(child);</span>
<a href="#l17.3500"></a><span id="l17.3500" class="difflineplus">+  return child;</span>
<a href="#l17.3501"></a><span id="l17.3501" class="difflineplus">+};</span>
<a href="#l17.3502"></a><span id="l17.3502" class="difflineplus">+</span>
<a href="#l17.3503"></a><span id="l17.3503" class="difflineplus">+/**</span>
<a href="#l17.3504"></a><span id="l17.3504" class="difflineplus">+ * Creates a new canvas (SVG) element with the specified width and height, and</span>
<a href="#l17.3505"></a><span id="l17.3505" class="difflineplus">+ * inserts it into the current document. If the &lt;tt&gt;$dom&lt;/tt&gt; field is set, as</span>
<a href="#l17.3506"></a><span id="l17.3506" class="difflineplus">+ * for text/javascript+protovis scripts, the SVG element is inserted into the</span>
<a href="#l17.3507"></a><span id="l17.3507" class="difflineplus">+ * DOM before the script element. Otherwise, the SVG element is inserted into</span>
<a href="#l17.3508"></a><span id="l17.3508" class="difflineplus">+ * the last child element of the document, as for text/javascript scripts.</span>
<a href="#l17.3509"></a><span id="l17.3509" class="difflineplus">+ *</span>
<a href="#l17.3510"></a><span id="l17.3510" class="difflineplus">+ * @param w the width of the canvas to create, in pixels.</span>
<a href="#l17.3511"></a><span id="l17.3511" class="difflineplus">+ * @param h the height of the canvas to create, in pixels.</span>
<a href="#l17.3512"></a><span id="l17.3512" class="difflineplus">+ * @return the new canvas (SVG) element.</span>
<a href="#l17.3513"></a><span id="l17.3513" class="difflineplus">+ */</span>
<a href="#l17.3514"></a><span id="l17.3514" class="difflineplus">+pv.Panel.prototype.createCanvas = function(w, h) {</span>
<a href="#l17.3515"></a><span id="l17.3515" class="difflineplus">+</span>
<a href="#l17.3516"></a><span id="l17.3516" class="difflineplus">+  /**</span>
<a href="#l17.3517"></a><span id="l17.3517" class="difflineplus">+   * Returns the last element in the current document's body. The canvas element</span>
<a href="#l17.3518"></a><span id="l17.3518" class="difflineplus">+   * is appended to this last element if another DOM element has not already</span>
<a href="#l17.3519"></a><span id="l17.3519" class="difflineplus">+   * been specified via the &lt;tt&gt;$dom&lt;/tt&gt; field.</span>
<a href="#l17.3520"></a><span id="l17.3520" class="difflineplus">+   */</span>
<a href="#l17.3521"></a><span id="l17.3521" class="difflineplus">+  function lastElement() {</span>
<a href="#l17.3522"></a><span id="l17.3522" class="difflineplus">+    var node = document.body;</span>
<a href="#l17.3523"></a><span id="l17.3523" class="difflineplus">+    while (node.lastChild &amp;&amp; node.lastChild.tagName) {</span>
<a href="#l17.3524"></a><span id="l17.3524" class="difflineplus">+      node = node.lastChild;</span>
<a href="#l17.3525"></a><span id="l17.3525" class="difflineplus">+    }</span>
<a href="#l17.3526"></a><span id="l17.3526" class="difflineplus">+    return (node == document.body) ? node : node.parentNode;</span>
<a href="#l17.3527"></a><span id="l17.3527" class="difflineplus">+  }</span>
<a href="#l17.3528"></a><span id="l17.3528" class="difflineplus">+</span>
<a href="#l17.3529"></a><span id="l17.3529" class="difflineplus">+  /* Create the SVG element. */</span>
<a href="#l17.3530"></a><span id="l17.3530" class="difflineplus">+  var c = document.createElementNS(pv.ns.svg, &quot;svg&quot;);</span>
<a href="#l17.3531"></a><span id="l17.3531" class="difflineplus">+  c.setAttribute(&quot;width&quot;, w);</span>
<a href="#l17.3532"></a><span id="l17.3532" class="difflineplus">+  c.setAttribute(&quot;height&quot;, h);</span>
<a href="#l17.3533"></a><span id="l17.3533" class="difflineplus">+</span>
<a href="#l17.3534"></a><span id="l17.3534" class="difflineplus">+  /* Insert it into the DOM at the appropriate location. */</span>
<a href="#l17.3535"></a><span id="l17.3535" class="difflineplus">+  this.$dom // script element for text/javascript+protovis</span>
<a href="#l17.3536"></a><span id="l17.3536" class="difflineplus">+      ? this.$dom.parentNode.insertBefore(c, this.$dom)</span>
<a href="#l17.3537"></a><span id="l17.3537" class="difflineplus">+      : lastElement().appendChild(c);</span>
<a href="#l17.3538"></a><span id="l17.3538" class="difflineplus">+</span>
<a href="#l17.3539"></a><span id="l17.3539" class="difflineplus">+  return c;</span>
<a href="#l17.3540"></a><span id="l17.3540" class="difflineplus">+};</span>
<a href="#l17.3541"></a><span id="l17.3541" class="difflineplus">+</span>
<a href="#l17.3542"></a><span id="l17.3542" class="difflineplus">+/**</span>
<a href="#l17.3543"></a><span id="l17.3543" class="difflineplus">+ * Evaluates all of the properties for this panel for the specified instance</span>
<a href="#l17.3544"></a><span id="l17.3544" class="difflineplus">+ * &lt;tt&gt;s&lt;/tt&gt; in the scene graph, including recursively building the scene graph</span>
<a href="#l17.3545"></a><span id="l17.3545" class="difflineplus">+ * for child marks.</span>
<a href="#l17.3546"></a><span id="l17.3546" class="difflineplus">+ *</span>
<a href="#l17.3547"></a><span id="l17.3547" class="difflineplus">+ * @param s a node in the scene graph; the instance of the panel to build.</span>
<a href="#l17.3548"></a><span id="l17.3548" class="difflineplus">+ * @see Mark#scene</span>
<a href="#l17.3549"></a><span id="l17.3549" class="difflineplus">+ */</span>
<a href="#l17.3550"></a><span id="l17.3550" class="difflineplus">+pv.Panel.prototype.buildInstance = function(s) {</span>
<a href="#l17.3551"></a><span id="l17.3551" class="difflineplus">+  pv.Bar.prototype.buildInstance.call(this, s);</span>
<a href="#l17.3552"></a><span id="l17.3552" class="difflineplus">+</span>
<a href="#l17.3553"></a><span id="l17.3553" class="difflineplus">+  /*</span>
<a href="#l17.3554"></a><span id="l17.3554" class="difflineplus">+   * Build each child, passing in the parent (this panel) scene graph node. The</span>
<a href="#l17.3555"></a><span id="l17.3555" class="difflineplus">+   * child mark's scene is initialized from the corresponding entry in the</span>
<a href="#l17.3556"></a><span id="l17.3556" class="difflineplus">+   * existing scene graph, such that properties from the previous build can be</span>
<a href="#l17.3557"></a><span id="l17.3557" class="difflineplus">+   * reused; this is largely to facilitate the recycling of SVG elements.</span>
<a href="#l17.3558"></a><span id="l17.3558" class="difflineplus">+   */</span>
<a href="#l17.3559"></a><span id="l17.3559" class="difflineplus">+  for (var i = 0; i &lt; this.children.length; i++) {</span>
<a href="#l17.3560"></a><span id="l17.3560" class="difflineplus">+    this.children[i].scene = s.children[i] || [];</span>
<a href="#l17.3561"></a><span id="l17.3561" class="difflineplus">+    this.children[i].build(s);</span>
<a href="#l17.3562"></a><span id="l17.3562" class="difflineplus">+  }</span>
<a href="#l17.3563"></a><span id="l17.3563" class="difflineplus">+</span>
<a href="#l17.3564"></a><span id="l17.3564" class="difflineplus">+  /*</span>
<a href="#l17.3565"></a><span id="l17.3565" class="difflineplus">+   * Once the child marks have been built, the new scene graph nodes are removed</span>
<a href="#l17.3566"></a><span id="l17.3566" class="difflineplus">+   * from the child marks and placed into the scene graph. The nodes cannot</span>
<a href="#l17.3567"></a><span id="l17.3567" class="difflineplus">+   * remain on the child nodes because this panel (or a parent panel) may be</span>
<a href="#l17.3568"></a><span id="l17.3568" class="difflineplus">+   * instantiated multiple times!</span>
<a href="#l17.3569"></a><span id="l17.3569" class="difflineplus">+   */</span>
<a href="#l17.3570"></a><span id="l17.3570" class="difflineplus">+  for (var i = 0; i &lt; this.children.length; i++) {</span>
<a href="#l17.3571"></a><span id="l17.3571" class="difflineplus">+    s.children[i] = this.children[i].scene;</span>
<a href="#l17.3572"></a><span id="l17.3572" class="difflineplus">+    delete this.children[i].scene;</span>
<a href="#l17.3573"></a><span id="l17.3573" class="difflineplus">+  }</span>
<a href="#l17.3574"></a><span id="l17.3574" class="difflineplus">+</span>
<a href="#l17.3575"></a><span id="l17.3575" class="difflineplus">+  /* Delete any expired child scenes, should child marks have been removed. */</span>
<a href="#l17.3576"></a><span id="l17.3576" class="difflineplus">+  s.children.length = this.children.length;</span>
<a href="#l17.3577"></a><span id="l17.3577" class="difflineplus">+};</span>
<a href="#l17.3578"></a><span id="l17.3578" class="difflineplus">+</span>
<a href="#l17.3579"></a><span id="l17.3579" class="difflineplus">+/**</span>
<a href="#l17.3580"></a><span id="l17.3580" class="difflineplus">+ * Computes the implied properties for this panel for the specified instance</span>
<a href="#l17.3581"></a><span id="l17.3581" class="difflineplus">+ * &lt;tt&gt;s&lt;/tt&gt; in the scene graph. Panels have two implied properties:&lt;ul&gt;</span>
<a href="#l17.3582"></a><span id="l17.3582" class="difflineplus">+ *</span>
<a href="#l17.3583"></a><span id="l17.3583" class="difflineplus">+ * &lt;li&gt;The &lt;tt&gt;canvas&lt;/tt&gt; property references the DOM element, typically a DIV,</span>
<a href="#l17.3584"></a><span id="l17.3584" class="difflineplus">+ * that contains the SVG element that is used to display the visualization. This</span>
<a href="#l17.3585"></a><span id="l17.3585" class="difflineplus">+ * property may be specified as a string, referring to the unique ID of the</span>
<a href="#l17.3586"></a><span id="l17.3586" class="difflineplus">+ * element in the DOM. The string is converted to a reference to the DOM</span>
<a href="#l17.3587"></a><span id="l17.3587" class="difflineplus">+ * element. The width and height of the SVG element is inferred from this DOM</span>
<a href="#l17.3588"></a><span id="l17.3588" class="difflineplus">+ * element. If no canvas property is specified, a new SVG element is created and</span>
<a href="#l17.3589"></a><span id="l17.3589" class="difflineplus">+ * inserted into the document, using the panel dimensions; see</span>
<a href="#l17.3590"></a><span id="l17.3590" class="difflineplus">+ * {@link #createCanvas}.</span>
<a href="#l17.3591"></a><span id="l17.3591" class="difflineplus">+ *</span>
<a href="#l17.3592"></a><span id="l17.3592" class="difflineplus">+ * &lt;li&gt;The &lt;tt&gt;children&lt;/tt&gt; array, while not a property per se, contains the</span>
<a href="#l17.3593"></a><span id="l17.3593" class="difflineplus">+ * scene graph for each child mark. This array is initialized to be empty, and</span>
<a href="#l17.3594"></a><span id="l17.3594" class="difflineplus">+ * is populated above in {@link #buildInstance}.</span>
<a href="#l17.3595"></a><span id="l17.3595" class="difflineplus">+ *</span>
<a href="#l17.3596"></a><span id="l17.3596" class="difflineplus">+ * &lt;/ul&gt;The current implementation creates the SVG element, if necessary, during</span>
<a href="#l17.3597"></a><span id="l17.3597" class="difflineplus">+ * the build phase; in the future, it may be preferrable to move this to the</span>
<a href="#l17.3598"></a><span id="l17.3598" class="difflineplus">+ * update phase, although then the canvas property would be undefined. In</span>
<a href="#l17.3599"></a><span id="l17.3599" class="difflineplus">+ * addition, DOM inspection is necessary to define the implied width and height</span>
<a href="#l17.3600"></a><span id="l17.3600" class="difflineplus">+ * properties that may be inferred from the DOM.</span>
<a href="#l17.3601"></a><span id="l17.3601" class="difflineplus">+ *</span>
<a href="#l17.3602"></a><span id="l17.3602" class="difflineplus">+ * @param s a node in the scene graph; the instance of the panel to build.</span>
<a href="#l17.3603"></a><span id="l17.3603" class="difflineplus">+ */</span>
<a href="#l17.3604"></a><span id="l17.3604" class="difflineplus">+pv.Panel.prototype.buildImplied = function(s) {</span>
<a href="#l17.3605"></a><span id="l17.3605" class="difflineplus">+  if (!s.children) s.children = [];</span>
<a href="#l17.3606"></a><span id="l17.3606" class="difflineplus">+  if (!s.parent) {</span>
<a href="#l17.3607"></a><span id="l17.3607" class="difflineplus">+    var c = s.canvas;</span>
<a href="#l17.3608"></a><span id="l17.3608" class="difflineplus">+    if (c) {</span>
<a href="#l17.3609"></a><span id="l17.3609" class="difflineplus">+      var d = (typeof c == &quot;string&quot;) ? document.getElementById(c) : c;</span>
<a href="#l17.3610"></a><span id="l17.3610" class="difflineplus">+</span>
<a href="#l17.3611"></a><span id="l17.3611" class="difflineplus">+      /* Clear the container if it's not already associated with this panel. */</span>
<a href="#l17.3612"></a><span id="l17.3612" class="difflineplus">+      if (d.$panel != this) {</span>
<a href="#l17.3613"></a><span id="l17.3613" class="difflineplus">+        d.$panel = this;</span>
<a href="#l17.3614"></a><span id="l17.3614" class="difflineplus">+        delete d.$canvas;</span>
<a href="#l17.3615"></a><span id="l17.3615" class="difflineplus">+        while (d.lastChild)</span>
<a href="#l17.3616"></a><span id="l17.3616" class="difflineplus">+          d.removeChild(d.lastChild);</span>
<a href="#l17.3617"></a><span id="l17.3617" class="difflineplus">+      }</span>
<a href="#l17.3618"></a><span id="l17.3618" class="difflineplus">+</span>
<a href="#l17.3619"></a><span id="l17.3619" class="difflineplus">+      /* Construct the canvas if not already present. */</span>
<a href="#l17.3620"></a><span id="l17.3620" class="difflineplus">+      if (!(c = d.$canvas)) {</span>
<a href="#l17.3621"></a><span id="l17.3621" class="difflineplus">+        d.$canvas = c = document.createElementNS(pv.ns.svg, &quot;svg&quot;);</span>
<a href="#l17.3622"></a><span id="l17.3622" class="difflineplus">+        d.appendChild(c);</span>
<a href="#l17.3623"></a><span id="l17.3623" class="difflineplus">+      }</span>
<a href="#l17.3624"></a><span id="l17.3624" class="difflineplus">+</span>
<a href="#l17.3625"></a><span id="l17.3625" class="difflineplus">+      /** Returns the computed style for the given element and property. */</span>
<a href="#l17.3626"></a><span id="l17.3626" class="difflineplus">+      function css(e, p) {</span>
<a href="#l17.3627"></a><span id="l17.3627" class="difflineplus">+        return parseFloat(self.getComputedStyle(e, null).getPropertyValue(p));</span>
<a href="#l17.3628"></a><span id="l17.3628" class="difflineplus">+      }</span>
<a href="#l17.3629"></a><span id="l17.3629" class="difflineplus">+</span>
<a href="#l17.3630"></a><span id="l17.3630" class="difflineplus">+      /* If width and height weren't specified, inspect the container. */</span>
<a href="#l17.3631"></a><span id="l17.3631" class="difflineplus">+      var w, h;</span>
<a href="#l17.3632"></a><span id="l17.3632" class="difflineplus">+      if (s.width == null) {</span>
<a href="#l17.3633"></a><span id="l17.3633" class="difflineplus">+        w = css(d, &quot;width&quot;);</span>
<a href="#l17.3634"></a><span id="l17.3634" class="difflineplus">+        s.width = w - s.left - s.right;</span>
<a href="#l17.3635"></a><span id="l17.3635" class="difflineplus">+      } else {</span>
<a href="#l17.3636"></a><span id="l17.3636" class="difflineplus">+        w = s.width + s.left + s.right;</span>
<a href="#l17.3637"></a><span id="l17.3637" class="difflineplus">+      }</span>
<a href="#l17.3638"></a><span id="l17.3638" class="difflineplus">+      if (s.height == null) {</span>
<a href="#l17.3639"></a><span id="l17.3639" class="difflineplus">+        h = css(d, &quot;height&quot;);</span>
<a href="#l17.3640"></a><span id="l17.3640" class="difflineplus">+        s.height = h - s.top - s.bottom;</span>
<a href="#l17.3641"></a><span id="l17.3641" class="difflineplus">+      } else {</span>
<a href="#l17.3642"></a><span id="l17.3642" class="difflineplus">+        h = s.height + s.top + s.bottom;</span>
<a href="#l17.3643"></a><span id="l17.3643" class="difflineplus">+      }</span>
<a href="#l17.3644"></a><span id="l17.3644" class="difflineplus">+</span>
<a href="#l17.3645"></a><span id="l17.3645" class="difflineplus">+      c.setAttribute(&quot;width&quot;, w);</span>
<a href="#l17.3646"></a><span id="l17.3646" class="difflineplus">+      c.setAttribute(&quot;height&quot;, h);</span>
<a href="#l17.3647"></a><span id="l17.3647" class="difflineplus">+      s.canvas = c;</span>
<a href="#l17.3648"></a><span id="l17.3648" class="difflineplus">+    } else if (s.svg) {</span>
<a href="#l17.3649"></a><span id="l17.3649" class="difflineplus">+      s.canvas = s.svg.parentNode;</span>
<a href="#l17.3650"></a><span id="l17.3650" class="difflineplus">+    } else {</span>
<a href="#l17.3651"></a><span id="l17.3651" class="difflineplus">+      s.canvas = this.createCanvas(</span>
<a href="#l17.3652"></a><span id="l17.3652" class="difflineplus">+          s.width + s.left + s.right,</span>
<a href="#l17.3653"></a><span id="l17.3653" class="difflineplus">+          s.height + s.top + s.bottom);</span>
<a href="#l17.3654"></a><span id="l17.3654" class="difflineplus">+    }</span>
<a href="#l17.3655"></a><span id="l17.3655" class="difflineplus">+  }</span>
<a href="#l17.3656"></a><span id="l17.3656" class="difflineplus">+  pv.Bar.prototype.buildImplied.call(this, s);</span>
<a href="#l17.3657"></a><span id="l17.3657" class="difflineplus">+};</span>
<a href="#l17.3658"></a><span id="l17.3658" class="difflineplus">+</span>
<a href="#l17.3659"></a><span id="l17.3659" class="difflineplus">+/**</span>
<a href="#l17.3660"></a><span id="l17.3660" class="difflineplus">+ * Updates the display, propagating property values computed in the build phase</span>
<a href="#l17.3661"></a><span id="l17.3661" class="difflineplus">+ * to the SVG image. In addition to the SVG element that serves as the canvas,</span>
<a href="#l17.3662"></a><span id="l17.3662" class="difflineplus">+ * each panel instance has a corresponding &lt;tt&gt;g&lt;/tt&gt; (container) element. The</span>
<a href="#l17.3663"></a><span id="l17.3663" class="difflineplus">+ * &lt;tt&gt;g&lt;/tt&gt; element uses the &lt;tt&gt;transform&lt;/tt&gt; attribute to offset the location</span>
<a href="#l17.3664"></a><span id="l17.3664" class="difflineplus">+ * of contained graphical elements.</span>
<a href="#l17.3665"></a><span id="l17.3665" class="difflineplus">+ */</span>
<a href="#l17.3666"></a><span id="l17.3666" class="difflineplus">+pv.Panel.prototype.update = function() {</span>
<a href="#l17.3667"></a><span id="l17.3667" class="difflineplus">+  var appends = [];</span>
<a href="#l17.3668"></a><span id="l17.3668" class="difflineplus">+  for (var i = 0; i &lt; this.scene.length; i++) {</span>
<a href="#l17.3669"></a><span id="l17.3669" class="difflineplus">+    var s = this.scene[i];</span>
<a href="#l17.3670"></a><span id="l17.3670" class="difflineplus">+</span>
<a href="#l17.3671"></a><span id="l17.3671" class="difflineplus">+    /* Create the &lt;svg:g&gt; element, if necessary. */</span>
<a href="#l17.3672"></a><span id="l17.3672" class="difflineplus">+    var v = s.svg;</span>
<a href="#l17.3673"></a><span id="l17.3673" class="difflineplus">+    if (!v) {</span>
<a href="#l17.3674"></a><span id="l17.3674" class="difflineplus">+      v = s.svg = document.createElementNS(pv.ns.svg, &quot;g&quot;);</span>
<a href="#l17.3675"></a><span id="l17.3675" class="difflineplus">+      appends.push(s);</span>
<a href="#l17.3676"></a><span id="l17.3676" class="difflineplus">+    }</span>
<a href="#l17.3677"></a><span id="l17.3677" class="difflineplus">+</span>
<a href="#l17.3678"></a><span id="l17.3678" class="difflineplus">+    /* Update this instance, recursively including child marks. */</span>
<a href="#l17.3679"></a><span id="l17.3679" class="difflineplus">+    this.updateInstance(s);</span>
<a href="#l17.3680"></a><span id="l17.3680" class="difflineplus">+    if (s.children) { // check visibility</span>
<a href="#l17.3681"></a><span id="l17.3681" class="difflineplus">+      for (var j = 0; j &lt; this.children.length; j++) {</span>
<a href="#l17.3682"></a><span id="l17.3682" class="difflineplus">+        var c = this.children[j];</span>
<a href="#l17.3683"></a><span id="l17.3683" class="difflineplus">+        c.scene = s.children[j];</span>
<a href="#l17.3684"></a><span id="l17.3684" class="difflineplus">+        c.update();</span>
<a href="#l17.3685"></a><span id="l17.3685" class="difflineplus">+        delete c.scene;</span>
<a href="#l17.3686"></a><span id="l17.3686" class="difflineplus">+      }</span>
<a href="#l17.3687"></a><span id="l17.3687" class="difflineplus">+    }</span>
<a href="#l17.3688"></a><span id="l17.3688" class="difflineplus">+  }</span>
<a href="#l17.3689"></a><span id="l17.3689" class="difflineplus">+</span>
<a href="#l17.3690"></a><span id="l17.3690" class="difflineplus">+  /*</span>
<a href="#l17.3691"></a><span id="l17.3691" class="difflineplus">+   * WebKit appears has a bug where images are not rendered if the &lt;g&gt; element</span>
<a href="#l17.3692"></a><span id="l17.3692" class="difflineplus">+   * is appended before it contained any elements. Creating the child elements</span>
<a href="#l17.3693"></a><span id="l17.3693" class="difflineplus">+   * first and then appending them solves the problem and is likely more</span>
<a href="#l17.3694"></a><span id="l17.3694" class="difflineplus">+   * efficient. Also, it means we can reverse the order easily.</span>
<a href="#l17.3695"></a><span id="l17.3695" class="difflineplus">+   *</span>
<a href="#l17.3696"></a><span id="l17.3696" class="difflineplus">+   * TODO It would be nice to support arbitrary z-order here, at least within</span>
<a href="#l17.3697"></a><span id="l17.3697" class="difflineplus">+   * panel. Of course, the order of children may need to be updated not just on</span>
<a href="#l17.3698"></a><span id="l17.3698" class="difflineplus">+   * append.</span>
<a href="#l17.3699"></a><span id="l17.3699" class="difflineplus">+   */</span>
<a href="#l17.3700"></a><span id="l17.3700" class="difflineplus">+  if (appends.length) {</span>
<a href="#l17.3701"></a><span id="l17.3701" class="difflineplus">+    if (appends[0].reverse) appends.reverse();</span>
<a href="#l17.3702"></a><span id="l17.3702" class="difflineplus">+    for (var i = 0; i &lt; appends.length; i++) {</span>
<a href="#l17.3703"></a><span id="l17.3703" class="difflineplus">+      var s = appends[i];</span>
<a href="#l17.3704"></a><span id="l17.3704" class="difflineplus">+      (s.parent ? s.parent.svg : s.canvas).appendChild(s.svg);</span>
<a href="#l17.3705"></a><span id="l17.3705" class="difflineplus">+    }</span>
<a href="#l17.3706"></a><span id="l17.3706" class="difflineplus">+  }</span>
<a href="#l17.3707"></a><span id="l17.3707" class="difflineplus">+};</span>
<a href="#l17.3708"></a><span id="l17.3708" class="difflineplus">+</span>
<a href="#l17.3709"></a><span id="l17.3709" class="difflineplus">+/**</span>
<a href="#l17.3710"></a><span id="l17.3710" class="difflineplus">+ * Updates the display for the specified panel instance &lt;tt&gt;s&lt;/tt&gt; in the scene</span>
<a href="#l17.3711"></a><span id="l17.3711" class="difflineplus">+ * graph. This implementation handles the fill and stroke style for the panel,</span>
<a href="#l17.3712"></a><span id="l17.3712" class="difflineplus">+ * as well as any necessary transform to offset the location of contained marks.</span>
<a href="#l17.3713"></a><span id="l17.3713" class="difflineplus">+ *</span>
<a href="#l17.3714"></a><span id="l17.3714" class="difflineplus">+ * &lt;p&gt;TODO As a performance optimization, it may also be possible to assign</span>
<a href="#l17.3715"></a><span id="l17.3715" class="difflineplus">+ * constant property values (or even the most common value for each property) as</span>
<a href="#l17.3716"></a><span id="l17.3716" class="difflineplus">+ * attributes on the &lt;g&gt; element so they can be inherited.</span>
<a href="#l17.3717"></a><span id="l17.3717" class="difflineplus">+ *</span>
<a href="#l17.3718"></a><span id="l17.3718" class="difflineplus">+ * @param s a node in the scene graph; the instance of the panel to update.</span>
<a href="#l17.3719"></a><span id="l17.3719" class="difflineplus">+ */</span>
<a href="#l17.3720"></a><span id="l17.3720" class="difflineplus">+pv.Panel.prototype.updateInstance = function(s) {</span>
<a href="#l17.3721"></a><span id="l17.3721" class="difflineplus">+  var v = s.svg;</span>
<a href="#l17.3722"></a><span id="l17.3722" class="difflineplus">+</span>
<a href="#l17.3723"></a><span id="l17.3723" class="difflineplus">+  /* visible */</span>
<a href="#l17.3724"></a><span id="l17.3724" class="difflineplus">+  if (!s.visible) {</span>
<a href="#l17.3725"></a><span id="l17.3725" class="difflineplus">+    if (v) v.setAttribute(&quot;display&quot;, &quot;none&quot;);</span>
<a href="#l17.3726"></a><span id="l17.3726" class="difflineplus">+    return;</span>
<a href="#l17.3727"></a><span id="l17.3727" class="difflineplus">+  }</span>
<a href="#l17.3728"></a><span id="l17.3728" class="difflineplus">+  v.removeAttribute(&quot;display&quot;);</span>
<a href="#l17.3729"></a><span id="l17.3729" class="difflineplus">+</span>
<a href="#l17.3730"></a><span id="l17.3730" class="difflineplus">+  /* fillStyle, strokeStyle */</span>
<a href="#l17.3731"></a><span id="l17.3731" class="difflineplus">+  var r = v.$rect;</span>
<a href="#l17.3732"></a><span id="l17.3732" class="difflineplus">+  if (s.fillStyle || s.strokeStyle) {</span>
<a href="#l17.3733"></a><span id="l17.3733" class="difflineplus">+    if (!r) {</span>
<a href="#l17.3734"></a><span id="l17.3734" class="difflineplus">+      r = v.$rect = document.createElementNS(pv.ns.svg, &quot;rect&quot;);</span>
<a href="#l17.3735"></a><span id="l17.3735" class="difflineplus">+      v.insertBefore(r, v.firstChild);</span>
<a href="#l17.3736"></a><span id="l17.3736" class="difflineplus">+    }</span>
<a href="#l17.3737"></a><span id="l17.3737" class="difflineplus">+</span>
<a href="#l17.3738"></a><span id="l17.3738" class="difflineplus">+    /* If width and height are exactly zero, the rect is not stroked! */</span>
<a href="#l17.3739"></a><span id="l17.3739" class="difflineplus">+    r.setAttribute(&quot;width&quot;, Math.max(1E-10, s.width));</span>
<a href="#l17.3740"></a><span id="l17.3740" class="difflineplus">+    r.setAttribute(&quot;height&quot;, Math.max(1E-10, s.height));</span>
<a href="#l17.3741"></a><span id="l17.3741" class="difflineplus">+</span>
<a href="#l17.3742"></a><span id="l17.3742" class="difflineplus">+    /* fill, stroke TODO gradient, patterns */</span>
<a href="#l17.3743"></a><span id="l17.3743" class="difflineplus">+    var fill = pv.color(s.fillStyle);</span>
<a href="#l17.3744"></a><span id="l17.3744" class="difflineplus">+    r.setAttribute(&quot;fill&quot;, fill.color);</span>
<a href="#l17.3745"></a><span id="l17.3745" class="difflineplus">+    r.setAttribute(&quot;fill-opacity&quot;, fill.opacity);</span>
<a href="#l17.3746"></a><span id="l17.3746" class="difflineplus">+    var stroke = pv.color(s.strokeStyle);</span>
<a href="#l17.3747"></a><span id="l17.3747" class="difflineplus">+    r.setAttribute(&quot;stroke&quot;, stroke.color);</span>
<a href="#l17.3748"></a><span id="l17.3748" class="difflineplus">+    r.setAttribute(&quot;stroke-opacity&quot;, stroke.opacity);</span>
<a href="#l17.3749"></a><span id="l17.3749" class="difflineplus">+    r.setAttribute(&quot;stroke-width&quot;, s.lineWidth);</span>
<a href="#l17.3750"></a><span id="l17.3750" class="difflineplus">+  } else if (r) {</span>
<a href="#l17.3751"></a><span id="l17.3751" class="difflineplus">+    v.removeChild(r);</span>
<a href="#l17.3752"></a><span id="l17.3752" class="difflineplus">+    delete v.$rect;</span>
<a href="#l17.3753"></a><span id="l17.3753" class="difflineplus">+    r = null;</span>
<a href="#l17.3754"></a><span id="l17.3754" class="difflineplus">+  }</span>
<a href="#l17.3755"></a><span id="l17.3755" class="difflineplus">+</span>
<a href="#l17.3756"></a><span id="l17.3756" class="difflineplus">+  /* cursor, title, event, etc. */</span>
<a href="#l17.3757"></a><span id="l17.3757" class="difflineplus">+  if (r) {</span>
<a href="#l17.3758"></a><span id="l17.3758" class="difflineplus">+    try {</span>
<a href="#l17.3759"></a><span id="l17.3759" class="difflineplus">+      s.svg = r;</span>
<a href="#l17.3760"></a><span id="l17.3760" class="difflineplus">+      pv.Mark.prototype.updateInstance.call(this, s);</span>
<a href="#l17.3761"></a><span id="l17.3761" class="difflineplus">+    } finally {</span>
<a href="#l17.3762"></a><span id="l17.3762" class="difflineplus">+      s.svg = v;</span>
<a href="#l17.3763"></a><span id="l17.3763" class="difflineplus">+    }</span>
<a href="#l17.3764"></a><span id="l17.3764" class="difflineplus">+  }</span>
<a href="#l17.3765"></a><span id="l17.3765" class="difflineplus">+</span>
<a href="#l17.3766"></a><span id="l17.3766" class="difflineplus">+  /* left, top */</span>
<a href="#l17.3767"></a><span id="l17.3767" class="difflineplus">+  if (s.left || s.top) {</span>
<a href="#l17.3768"></a><span id="l17.3768" class="difflineplus">+    v.setAttribute(&quot;transform&quot;, &quot;translate(&quot; + s.left + &quot;,&quot; + s.top +&quot;)&quot;);</span>
<a href="#l17.3769"></a><span id="l17.3769" class="difflineplus">+  } else {</span>
<a href="#l17.3770"></a><span id="l17.3770" class="difflineplus">+    v.removeAttribute(&quot;transform&quot;);</span>
<a href="#l17.3771"></a><span id="l17.3771" class="difflineplus">+  }</span>
<a href="#l17.3772"></a><span id="l17.3772" class="difflineplus">+};</span>
<a href="#l17.3773"></a><span id="l17.3773" class="difflineplus">+/**</span>
<a href="#l17.3774"></a><span id="l17.3774" class="difflineplus">+ * Constructs a new rule with default properties. Rules are not typically</span>
<a href="#l17.3775"></a><span id="l17.3775" class="difflineplus">+ * constructed directly, but by adding to a panel or an existing mark via</span>
<a href="#l17.3776"></a><span id="l17.3776" class="difflineplus">+ * {@link pv.Mark#add}.</span>
<a href="#l17.3777"></a><span id="l17.3777" class="difflineplus">+ *</span>
<a href="#l17.3778"></a><span id="l17.3778" class="difflineplus">+ * @class Represents a horizontal or vertical rule. Rules are frequently used</span>
<a href="#l17.3779"></a><span id="l17.3779" class="difflineplus">+ * for axes and grid lines. For example, specifying only the bottom property</span>
<a href="#l17.3780"></a><span id="l17.3780" class="difflineplus">+ * draws horizontal rules, while specifying only the left draws vertical</span>
<a href="#l17.3781"></a><span id="l17.3781" class="difflineplus">+ * rules. Rules can also be used as thin bars. The visual style is controlled in</span>
<a href="#l17.3782"></a><span id="l17.3782" class="difflineplus">+ * the same manner as lines.</span>
<a href="#l17.3783"></a><span id="l17.3783" class="difflineplus">+ *</span>
<a href="#l17.3784"></a><span id="l17.3784" class="difflineplus">+ * &lt;p&gt;Rules are positioned exclusively using the four margins. The following</span>
<a href="#l17.3785"></a><span id="l17.3785" class="difflineplus">+ * combinations of properties are supported:&lt;ul&gt;</span>
<a href="#l17.3786"></a><span id="l17.3786" class="difflineplus">+ *</span>
<a href="#l17.3787"></a><span id="l17.3787" class="difflineplus">+ * &lt;li&gt;left (vertical)</span>
<a href="#l17.3788"></a><span id="l17.3788" class="difflineplus">+ * &lt;li&gt;right (vertical)</span>
<a href="#l17.3789"></a><span id="l17.3789" class="difflineplus">+ * &lt;li&gt;left, bottom, top (vertical)</span>
<a href="#l17.3790"></a><span id="l17.3790" class="difflineplus">+ * &lt;li&gt;right, bottom, top (vertical)</span>
<a href="#l17.3791"></a><span id="l17.3791" class="difflineplus">+ * &lt;li&gt;top (horizontal)</span>
<a href="#l17.3792"></a><span id="l17.3792" class="difflineplus">+ * &lt;li&gt;bottom (horizontal)</span>
<a href="#l17.3793"></a><span id="l17.3793" class="difflineplus">+ * &lt;li&gt;top, left, right (horizontal)</span>
<a href="#l17.3794"></a><span id="l17.3794" class="difflineplus">+ * &lt;li&gt;bottom, left, right (horizontal)</span>
<a href="#l17.3795"></a><span id="l17.3795" class="difflineplus">+ *</span>
<a href="#l17.3796"></a><span id="l17.3796" class="difflineplus">+ * &lt;/ul&gt;TODO If rules supported width (for horizontal) and height (for vertical)</span>
<a href="#l17.3797"></a><span id="l17.3797" class="difflineplus">+ * properties, it might be easier to place them. Small rules can be used as tick</span>
<a href="#l17.3798"></a><span id="l17.3798" class="difflineplus">+ * marks; alternatively, a {@link Dot} with the &quot;tick&quot; shape can be used.</span>
<a href="#l17.3799"></a><span id="l17.3799" class="difflineplus">+ *</span>
<a href="#l17.3800"></a><span id="l17.3800" class="difflineplus">+ * &lt;p&gt;See also the &lt;a href=&quot;../../api/Rule.html&quot;&gt;Rule guide&lt;/a&gt;.</span>
<a href="#l17.3801"></a><span id="l17.3801" class="difflineplus">+ *</span>
<a href="#l17.3802"></a><span id="l17.3802" class="difflineplus">+ * @see pv.Line</span>
<a href="#l17.3803"></a><span id="l17.3803" class="difflineplus">+ * @extends pv.Mark</span>
<a href="#l17.3804"></a><span id="l17.3804" class="difflineplus">+ */</span>
<a href="#l17.3805"></a><span id="l17.3805" class="difflineplus">+pv.Rule = function() {</span>
<a href="#l17.3806"></a><span id="l17.3806" class="difflineplus">+  pv.Mark.call(this);</span>
<a href="#l17.3807"></a><span id="l17.3807" class="difflineplus">+};</span>
<a href="#l17.3808"></a><span id="l17.3808" class="difflineplus">+pv.Rule.prototype = pv.extend(pv.Mark);</span>
<a href="#l17.3809"></a><span id="l17.3809" class="difflineplus">+pv.Rule.prototype.type = pv.Rule;</span>
<a href="#l17.3810"></a><span id="l17.3810" class="difflineplus">+</span>
<a href="#l17.3811"></a><span id="l17.3811" class="difflineplus">+/**</span>
<a href="#l17.3812"></a><span id="l17.3812" class="difflineplus">+ * Returns &quot;rule&quot;.</span>
<a href="#l17.3813"></a><span id="l17.3813" class="difflineplus">+ *</span>
<a href="#l17.3814"></a><span id="l17.3814" class="difflineplus">+ * @returns {string} &quot;rule&quot;.</span>
<a href="#l17.3815"></a><span id="l17.3815" class="difflineplus">+ */</span>
<a href="#l17.3816"></a><span id="l17.3816" class="difflineplus">+pv.Rule.toString = function() { return &quot;rule&quot;; };</span>
<a href="#l17.3817"></a><span id="l17.3817" class="difflineplus">+</span>
<a href="#l17.3818"></a><span id="l17.3818" class="difflineplus">+/**</span>
<a href="#l17.3819"></a><span id="l17.3819" class="difflineplus">+ * The width of stroked lines, in pixels; used in conjunction with</span>
<a href="#l17.3820"></a><span id="l17.3820" class="difflineplus">+ * &lt;tt&gt;strokeStyle&lt;/tt&gt; to stroke the rule. The default value is 1 pixel.</span>
<a href="#l17.3821"></a><span id="l17.3821" class="difflineplus">+ *</span>
<a href="#l17.3822"></a><span id="l17.3822" class="difflineplus">+ * @type number</span>
<a href="#l17.3823"></a><span id="l17.3823" class="difflineplus">+ * @name pv.Rule.prototype.lineWidth</span>
<a href="#l17.3824"></a><span id="l17.3824" class="difflineplus">+ */</span>
<a href="#l17.3825"></a><span id="l17.3825" class="difflineplus">+pv.Rule.prototype.defineProperty(&quot;lineWidth&quot;);</span>
<a href="#l17.3826"></a><span id="l17.3826" class="difflineplus">+</span>
<a href="#l17.3827"></a><span id="l17.3827" class="difflineplus">+/**</span>
<a href="#l17.3828"></a><span id="l17.3828" class="difflineplus">+ * The style of stroked lines; used in conjunction with &lt;tt&gt;lineWidth&lt;/tt&gt; to</span>
<a href="#l17.3829"></a><span id="l17.3829" class="difflineplus">+ * stroke the rule. The default value of this property is black.</span>
<a href="#l17.3830"></a><span id="l17.3830" class="difflineplus">+ *</span>
<a href="#l17.3831"></a><span id="l17.3831" class="difflineplus">+ * @type string</span>
<a href="#l17.3832"></a><span id="l17.3832" class="difflineplus">+ * @name pv.Rule.prototype.strokeStyle</span>
<a href="#l17.3833"></a><span id="l17.3833" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.3834"></a><span id="l17.3834" class="difflineplus">+ */</span>
<a href="#l17.3835"></a><span id="l17.3835" class="difflineplus">+pv.Rule.prototype.defineProperty(&quot;strokeStyle&quot;);</span>
<a href="#l17.3836"></a><span id="l17.3836" class="difflineplus">+</span>
<a href="#l17.3837"></a><span id="l17.3837" class="difflineplus">+/**</span>
<a href="#l17.3838"></a><span id="l17.3838" class="difflineplus">+ * Default properties for rules. By default, a single-pixel black line is</span>
<a href="#l17.3839"></a><span id="l17.3839" class="difflineplus">+ * stroked.</span>
<a href="#l17.3840"></a><span id="l17.3840" class="difflineplus">+ *</span>
<a href="#l17.3841"></a><span id="l17.3841" class="difflineplus">+ * @type pv.Rule</span>
<a href="#l17.3842"></a><span id="l17.3842" class="difflineplus">+ */</span>
<a href="#l17.3843"></a><span id="l17.3843" class="difflineplus">+pv.Rule.defaults = new pv.Rule().extend(pv.Mark.defaults)</span>
<a href="#l17.3844"></a><span id="l17.3844" class="difflineplus">+    .lineWidth(1)</span>
<a href="#l17.3845"></a><span id="l17.3845" class="difflineplus">+    .strokeStyle(&quot;black&quot;);</span>
<a href="#l17.3846"></a><span id="l17.3846" class="difflineplus">+</span>
<a href="#l17.3847"></a><span id="l17.3847" class="difflineplus">+/**</span>
<a href="#l17.3848"></a><span id="l17.3848" class="difflineplus">+ * Constructs a new rule anchor with default properties.</span>
<a href="#l17.3849"></a><span id="l17.3849" class="difflineplus">+ *</span>
<a href="#l17.3850"></a><span id="l17.3850" class="difflineplus">+ * @class Represents an anchor for a rule mark. Rules support five different</span>
<a href="#l17.3851"></a><span id="l17.3851" class="difflineplus">+ * anchors:&lt;ul&gt;</span>
<a href="#l17.3852"></a><span id="l17.3852" class="difflineplus">+ *</span>
<a href="#l17.3853"></a><span id="l17.3853" class="difflineplus">+ * &lt;li&gt;top</span>
<a href="#l17.3854"></a><span id="l17.3854" class="difflineplus">+ * &lt;li&gt;left</span>
<a href="#l17.3855"></a><span id="l17.3855" class="difflineplus">+ * &lt;li&gt;center</span>
<a href="#l17.3856"></a><span id="l17.3856" class="difflineplus">+ * &lt;li&gt;bottom</span>
<a href="#l17.3857"></a><span id="l17.3857" class="difflineplus">+ * &lt;li&gt;right</span>
<a href="#l17.3858"></a><span id="l17.3858" class="difflineplus">+ *</span>
<a href="#l17.3859"></a><span id="l17.3859" class="difflineplus">+ * &lt;/ul&gt;In addition to positioning properties (left, right, top bottom), the</span>
<a href="#l17.3860"></a><span id="l17.3860" class="difflineplus">+ * anchors support text rendering properties (text-align, text-baseline). Text is</span>
<a href="#l17.3861"></a><span id="l17.3861" class="difflineplus">+ * rendered to appear outside the rule. Note that this behavior is different</span>
<a href="#l17.3862"></a><span id="l17.3862" class="difflineplus">+ * from other mark anchors, which default to rendering text &lt;i&gt;inside&lt;/i&gt; the</span>
<a href="#l17.3863"></a><span id="l17.3863" class="difflineplus">+ * mark.</span>
<a href="#l17.3864"></a><span id="l17.3864" class="difflineplus">+ *</span>
<a href="#l17.3865"></a><span id="l17.3865" class="difflineplus">+ * &lt;p&gt;For consistency with the other mark types, the anchor positions are</span>
<a href="#l17.3866"></a><span id="l17.3866" class="difflineplus">+ * defined in terms of their opposite edge. For example, the top anchor defines</span>
<a href="#l17.3867"></a><span id="l17.3867" class="difflineplus">+ * the bottom property, such that a bar added to the top anchor grows upward.</span>
<a href="#l17.3868"></a><span id="l17.3868" class="difflineplus">+ *</span>
<a href="#l17.3869"></a><span id="l17.3869" class="difflineplus">+ * @extends pv.Bar.Anchor</span>
<a href="#l17.3870"></a><span id="l17.3870" class="difflineplus">+ */</span>
<a href="#l17.3871"></a><span id="l17.3871" class="difflineplus">+pv.Rule.Anchor = function() {</span>
<a href="#l17.3872"></a><span id="l17.3872" class="difflineplus">+  pv.Bar.Anchor.call(this);</span>
<a href="#l17.3873"></a><span id="l17.3873" class="difflineplus">+};</span>
<a href="#l17.3874"></a><span id="l17.3874" class="difflineplus">+pv.Rule.Anchor.prototype = pv.extend(pv.Bar.Anchor);</span>
<a href="#l17.3875"></a><span id="l17.3875" class="difflineplus">+pv.Rule.Anchor.prototype.type = pv.Rule;</span>
<a href="#l17.3876"></a><span id="l17.3876" class="difflineplus">+</span>
<a href="#l17.3877"></a><span id="l17.3877" class="difflineplus">+/**</span>
<a href="#l17.3878"></a><span id="l17.3878" class="difflineplus">+ * The text-align property, for horizontal alignment outside the rule.</span>
<a href="#l17.3879"></a><span id="l17.3879" class="difflineplus">+ *</span>
<a href="#l17.3880"></a><span id="l17.3880" class="difflineplus">+ * @type string</span>
<a href="#l17.3881"></a><span id="l17.3881" class="difflineplus">+ * @name pv.Rule.Anchor.prototype.textAlign</span>
<a href="#l17.3882"></a><span id="l17.3882" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.3883"></a><span id="l17.3883" class="difflineplus">+pv.Rule.Anchor.prototype.$textAlign = function(d) {</span>
<a href="#l17.3884"></a><span id="l17.3884" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.3885"></a><span id="l17.3885" class="difflineplus">+    case &quot;left&quot;: return &quot;right&quot;;</span>
<a href="#l17.3886"></a><span id="l17.3886" class="difflineplus">+    case &quot;bottom&quot;:</span>
<a href="#l17.3887"></a><span id="l17.3887" class="difflineplus">+    case &quot;top&quot;:</span>
<a href="#l17.3888"></a><span id="l17.3888" class="difflineplus">+    case &quot;center&quot;: return &quot;center&quot;;</span>
<a href="#l17.3889"></a><span id="l17.3889" class="difflineplus">+    case &quot;right&quot;: return &quot;left&quot;;</span>
<a href="#l17.3890"></a><span id="l17.3890" class="difflineplus">+  }</span>
<a href="#l17.3891"></a><span id="l17.3891" class="difflineplus">+  return null;</span>
<a href="#l17.3892"></a><span id="l17.3892" class="difflineplus">+};</span>
<a href="#l17.3893"></a><span id="l17.3893" class="difflineplus">+</span>
<a href="#l17.3894"></a><span id="l17.3894" class="difflineplus">+/**</span>
<a href="#l17.3895"></a><span id="l17.3895" class="difflineplus">+ * The text-baseline property, for vertical alignment outside the rule.</span>
<a href="#l17.3896"></a><span id="l17.3896" class="difflineplus">+ *</span>
<a href="#l17.3897"></a><span id="l17.3897" class="difflineplus">+ * @type string</span>
<a href="#l17.3898"></a><span id="l17.3898" class="difflineplus">+ * @name pv.Rule.Anchor.prototype.textBaseline</span>
<a href="#l17.3899"></a><span id="l17.3899" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.3900"></a><span id="l17.3900" class="difflineplus">+pv.Rule.Anchor.prototype.$textBaseline = function(d) {</span>
<a href="#l17.3901"></a><span id="l17.3901" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.3902"></a><span id="l17.3902" class="difflineplus">+    case &quot;right&quot;:</span>
<a href="#l17.3903"></a><span id="l17.3903" class="difflineplus">+    case &quot;left&quot;:</span>
<a href="#l17.3904"></a><span id="l17.3904" class="difflineplus">+    case &quot;center&quot;: return &quot;middle&quot;;</span>
<a href="#l17.3905"></a><span id="l17.3905" class="difflineplus">+    case &quot;top&quot;: return &quot;bottom&quot;;</span>
<a href="#l17.3906"></a><span id="l17.3906" class="difflineplus">+    case &quot;bottom&quot;: return &quot;top&quot;;</span>
<a href="#l17.3907"></a><span id="l17.3907" class="difflineplus">+  }</span>
<a href="#l17.3908"></a><span id="l17.3908" class="difflineplus">+  return null;</span>
<a href="#l17.3909"></a><span id="l17.3909" class="difflineplus">+};</span>
<a href="#l17.3910"></a><span id="l17.3910" class="difflineplus">+</span>
<a href="#l17.3911"></a><span id="l17.3911" class="difflineplus">+/**</span>
<a href="#l17.3912"></a><span id="l17.3912" class="difflineplus">+ * Returns the pseudo-width of the rule in pixels; read-only.</span>
<a href="#l17.3913"></a><span id="l17.3913" class="difflineplus">+ *</span>
<a href="#l17.3914"></a><span id="l17.3914" class="difflineplus">+ * @returns {number} the pseudo-width, in pixels.</span>
<a href="#l17.3915"></a><span id="l17.3915" class="difflineplus">+ */</span>
<a href="#l17.3916"></a><span id="l17.3916" class="difflineplus">+pv.Rule.prototype.width = function() {</span>
<a href="#l17.3917"></a><span id="l17.3917" class="difflineplus">+  return this.scene[this.index].width;</span>
<a href="#l17.3918"></a><span id="l17.3918" class="difflineplus">+};</span>
<a href="#l17.3919"></a><span id="l17.3919" class="difflineplus">+</span>
<a href="#l17.3920"></a><span id="l17.3920" class="difflineplus">+/**</span>
<a href="#l17.3921"></a><span id="l17.3921" class="difflineplus">+ * Returns the pseudo-height of the rule in pixels; read-only.</span>
<a href="#l17.3922"></a><span id="l17.3922" class="difflineplus">+ *</span>
<a href="#l17.3923"></a><span id="l17.3923" class="difflineplus">+ * @returns {number} the pseudo-height, in pixels.</span>
<a href="#l17.3924"></a><span id="l17.3924" class="difflineplus">+ */</span>
<a href="#l17.3925"></a><span id="l17.3925" class="difflineplus">+pv.Rule.prototype.height = function() {</span>
<a href="#l17.3926"></a><span id="l17.3926" class="difflineplus">+  return this.scene[this.index].height;</span>
<a href="#l17.3927"></a><span id="l17.3927" class="difflineplus">+};</span>
<a href="#l17.3928"></a><span id="l17.3928" class="difflineplus">+</span>
<a href="#l17.3929"></a><span id="l17.3929" class="difflineplus">+/**</span>
<a href="#l17.3930"></a><span id="l17.3930" class="difflineplus">+ * Overrides the default behavior of {@link Mark#buildImplied} to determine the</span>
<a href="#l17.3931"></a><span id="l17.3931" class="difflineplus">+ * orientation (vertical or horizontal) of the rule.</span>
<a href="#l17.3932"></a><span id="l17.3932" class="difflineplus">+ *</span>
<a href="#l17.3933"></a><span id="l17.3933" class="difflineplus">+ * @param s a node in the scene graph; the instance of the rule to build.</span>
<a href="#l17.3934"></a><span id="l17.3934" class="difflineplus">+ */</span>
<a href="#l17.3935"></a><span id="l17.3935" class="difflineplus">+pv.Rule.prototype.buildImplied = function(s) {</span>
<a href="#l17.3936"></a><span id="l17.3936" class="difflineplus">+  s.width = s.height = 0;</span>
<a href="#l17.3937"></a><span id="l17.3937" class="difflineplus">+</span>
<a href="#l17.3938"></a><span id="l17.3938" class="difflineplus">+  /* Determine horizontal or vertical orientation. */</span>
<a href="#l17.3939"></a><span id="l17.3939" class="difflineplus">+  var l = s.left, r = s.right, t = s.top, b = s.bottom;</span>
<a href="#l17.3940"></a><span id="l17.3940" class="difflineplus">+  if (((l == null) &amp;&amp; (r == null)) || ((r != null) &amp;&amp; (l != null))) {</span>
<a href="#l17.3941"></a><span id="l17.3941" class="difflineplus">+    s.width = s.parent.width - (l = l || 0) - (r = r || 0);</span>
<a href="#l17.3942"></a><span id="l17.3942" class="difflineplus">+  } else {</span>
<a href="#l17.3943"></a><span id="l17.3943" class="difflineplus">+    s.height = s.parent.height - (t = t || 0) - (b = b || 0);</span>
<a href="#l17.3944"></a><span id="l17.3944" class="difflineplus">+  }</span>
<a href="#l17.3945"></a><span id="l17.3945" class="difflineplus">+</span>
<a href="#l17.3946"></a><span id="l17.3946" class="difflineplus">+  s.left = l;</span>
<a href="#l17.3947"></a><span id="l17.3947" class="difflineplus">+  s.right = r;</span>
<a href="#l17.3948"></a><span id="l17.3948" class="difflineplus">+  s.top = t;</span>
<a href="#l17.3949"></a><span id="l17.3949" class="difflineplus">+  s.bottom = b;</span>
<a href="#l17.3950"></a><span id="l17.3950" class="difflineplus">+</span>
<a href="#l17.3951"></a><span id="l17.3951" class="difflineplus">+  pv.Mark.prototype.buildImplied.call(this, s);</span>
<a href="#l17.3952"></a><span id="l17.3952" class="difflineplus">+};</span>
<a href="#l17.3953"></a><span id="l17.3953" class="difflineplus">+</span>
<a href="#l17.3954"></a><span id="l17.3954" class="difflineplus">+/**</span>
<a href="#l17.3955"></a><span id="l17.3955" class="difflineplus">+ * Updates the display for the specified rule instance &lt;tt&gt;s&lt;/tt&gt; in the scene</span>
<a href="#l17.3956"></a><span id="l17.3956" class="difflineplus">+ * graph. This implementation handles the stroke style for the rule, as well as</span>
<a href="#l17.3957"></a><span id="l17.3957" class="difflineplus">+ * positional properties.</span>
<a href="#l17.3958"></a><span id="l17.3958" class="difflineplus">+ *</span>
<a href="#l17.3959"></a><span id="l17.3959" class="difflineplus">+ * @param s a node in the scene graph; the instance of the rule to update.</span>
<a href="#l17.3960"></a><span id="l17.3960" class="difflineplus">+ */</span>
<a href="#l17.3961"></a><span id="l17.3961" class="difflineplus">+pv.Rule.prototype.updateInstance = function(s) {</span>
<a href="#l17.3962"></a><span id="l17.3962" class="difflineplus">+  var v = s.svg;</span>
<a href="#l17.3963"></a><span id="l17.3963" class="difflineplus">+</span>
<a href="#l17.3964"></a><span id="l17.3964" class="difflineplus">+  /* Create the svg:line element, if necessary. */</span>
<a href="#l17.3965"></a><span id="l17.3965" class="difflineplus">+  if (s.visible &amp;&amp; !v) {</span>
<a href="#l17.3966"></a><span id="l17.3966" class="difflineplus">+    v = s.svg = document.createElementNS(pv.ns.svg, &quot;line&quot;);</span>
<a href="#l17.3967"></a><span id="l17.3967" class="difflineplus">+    s.parent.svg.appendChild(v);</span>
<a href="#l17.3968"></a><span id="l17.3968" class="difflineplus">+  }</span>
<a href="#l17.3969"></a><span id="l17.3969" class="difflineplus">+</span>
<a href="#l17.3970"></a><span id="l17.3970" class="difflineplus">+  /* visible, cursor, title, events, etc. */</span>
<a href="#l17.3971"></a><span id="l17.3971" class="difflineplus">+  pv.Mark.prototype.updateInstance.call(this, s);</span>
<a href="#l17.3972"></a><span id="l17.3972" class="difflineplus">+  if (!s.visible) return;</span>
<a href="#l17.3973"></a><span id="l17.3973" class="difflineplus">+</span>
<a href="#l17.3974"></a><span id="l17.3974" class="difflineplus">+  /* left, top */</span>
<a href="#l17.3975"></a><span id="l17.3975" class="difflineplus">+  v.setAttribute(&quot;x1&quot;, s.left);</span>
<a href="#l17.3976"></a><span id="l17.3976" class="difflineplus">+  v.setAttribute(&quot;y1&quot;, s.top);</span>
<a href="#l17.3977"></a><span id="l17.3977" class="difflineplus">+  v.setAttribute(&quot;x2&quot;, s.left + s.width);</span>
<a href="#l17.3978"></a><span id="l17.3978" class="difflineplus">+  v.setAttribute(&quot;y2&quot;, s.top + s.height);</span>
<a href="#l17.3979"></a><span id="l17.3979" class="difflineplus">+</span>
<a href="#l17.3980"></a><span id="l17.3980" class="difflineplus">+  /* stroke TODO gradient, patterns, dashes */</span>
<a href="#l17.3981"></a><span id="l17.3981" class="difflineplus">+  var stroke = pv.color(s.strokeStyle);</span>
<a href="#l17.3982"></a><span id="l17.3982" class="difflineplus">+  v.setAttribute(&quot;stroke&quot;, stroke.color);</span>
<a href="#l17.3983"></a><span id="l17.3983" class="difflineplus">+  v.setAttribute(&quot;stroke-opacity&quot;, stroke.opacity);</span>
<a href="#l17.3984"></a><span id="l17.3984" class="difflineplus">+  v.setAttribute(&quot;stroke-width&quot;, s.lineWidth);</span>
<a href="#l17.3985"></a><span id="l17.3985" class="difflineplus">+};</span>
<a href="#l17.3986"></a><span id="l17.3986" class="difflineplus">+/**</span>
<a href="#l17.3987"></a><span id="l17.3987" class="difflineplus">+ * Constructs a new wedge with default properties. Wedges are not typically</span>
<a href="#l17.3988"></a><span id="l17.3988" class="difflineplus">+ * constructed directly, but by adding to a panel or an existing mark via</span>
<a href="#l17.3989"></a><span id="l17.3989" class="difflineplus">+ * {@link pv.Mark#add}.</span>
<a href="#l17.3990"></a><span id="l17.3990" class="difflineplus">+ *</span>
<a href="#l17.3991"></a><span id="l17.3991" class="difflineplus">+ * @class Represents a wedge, or pie slice. Specified in terms of start and end</span>
<a href="#l17.3992"></a><span id="l17.3992" class="difflineplus">+ * angle, inner and outer radius, wedges can be used to construct donut charts</span>
<a href="#l17.3993"></a><span id="l17.3993" class="difflineplus">+ * and polar bar charts as well. If the {@link #angle} property is used, the end</span>
<a href="#l17.3994"></a><span id="l17.3994" class="difflineplus">+ * angle is implied by adding this value to start angle. By default, the start</span>
<a href="#l17.3995"></a><span id="l17.3995" class="difflineplus">+ * angle is the previously-generated wedge's end angle. This design allows</span>
<a href="#l17.3996"></a><span id="l17.3996" class="difflineplus">+ * explicit control over the wedge placement if desired, while offering</span>
<a href="#l17.3997"></a><span id="l17.3997" class="difflineplus">+ * convenient defaults for the construction of radial graphs.</span>
<a href="#l17.3998"></a><span id="l17.3998" class="difflineplus">+ *</span>
<a href="#l17.3999"></a><span id="l17.3999" class="difflineplus">+ * &lt;p&gt;The center point of the circle is positioned using the standard box model.</span>
<a href="#l17.4000"></a><span id="l17.4000" class="difflineplus">+ * The wedge can be stroked and filled, similar to {link Bar}.</span>
<a href="#l17.4001"></a><span id="l17.4001" class="difflineplus">+ *</span>
<a href="#l17.4002"></a><span id="l17.4002" class="difflineplus">+ * &lt;p&gt;See also the &lt;a href=&quot;../../api/Wedge.html&quot;&gt;Wedge guide&lt;/a&gt;.</span>
<a href="#l17.4003"></a><span id="l17.4003" class="difflineplus">+ *</span>
<a href="#l17.4004"></a><span id="l17.4004" class="difflineplus">+ * @extends pv.Mark</span>
<a href="#l17.4005"></a><span id="l17.4005" class="difflineplus">+ */</span>
<a href="#l17.4006"></a><span id="l17.4006" class="difflineplus">+pv.Wedge = function() {</span>
<a href="#l17.4007"></a><span id="l17.4007" class="difflineplus">+  pv.Mark.call(this);</span>
<a href="#l17.4008"></a><span id="l17.4008" class="difflineplus">+};</span>
<a href="#l17.4009"></a><span id="l17.4009" class="difflineplus">+pv.Wedge.prototype = pv.extend(pv.Mark);</span>
<a href="#l17.4010"></a><span id="l17.4010" class="difflineplus">+pv.Wedge.prototype.type = pv.Wedge;</span>
<a href="#l17.4011"></a><span id="l17.4011" class="difflineplus">+</span>
<a href="#l17.4012"></a><span id="l17.4012" class="difflineplus">+/**</span>
<a href="#l17.4013"></a><span id="l17.4013" class="difflineplus">+ * Returns &quot;wedge&quot;.</span>
<a href="#l17.4014"></a><span id="l17.4014" class="difflineplus">+ *</span>
<a href="#l17.4015"></a><span id="l17.4015" class="difflineplus">+ * @returns {string} &quot;wedge&quot;.</span>
<a href="#l17.4016"></a><span id="l17.4016" class="difflineplus">+ */</span>
<a href="#l17.4017"></a><span id="l17.4017" class="difflineplus">+pv.Wedge.toString = function() { return &quot;wedge&quot;; };</span>
<a href="#l17.4018"></a><span id="l17.4018" class="difflineplus">+</span>
<a href="#l17.4019"></a><span id="l17.4019" class="difflineplus">+/**</span>
<a href="#l17.4020"></a><span id="l17.4020" class="difflineplus">+ * The start angle of the wedge, in radians. The start angle is measured</span>
<a href="#l17.4021"></a><span id="l17.4021" class="difflineplus">+ * clockwise from the 3 o'clock position. The default value of this property is</span>
<a href="#l17.4022"></a><span id="l17.4022" class="difflineplus">+ * the end angle of the previous instance (the {@link Mark#sibling}), or -PI / 2</span>
<a href="#l17.4023"></a><span id="l17.4023" class="difflineplus">+ * for the first wedge; for pie and donut charts, typically only the</span>
<a href="#l17.4024"></a><span id="l17.4024" class="difflineplus">+ * {@link #angle} property needs to be specified.</span>
<a href="#l17.4025"></a><span id="l17.4025" class="difflineplus">+ *</span>
<a href="#l17.4026"></a><span id="l17.4026" class="difflineplus">+ * @type number</span>
<a href="#l17.4027"></a><span id="l17.4027" class="difflineplus">+ * @name pv.Wedge.prototype.startAngle</span>
<a href="#l17.4028"></a><span id="l17.4028" class="difflineplus">+ */</span>
<a href="#l17.4029"></a><span id="l17.4029" class="difflineplus">+pv.Wedge.prototype.defineProperty(&quot;startAngle&quot;);</span>
<a href="#l17.4030"></a><span id="l17.4030" class="difflineplus">+</span>
<a href="#l17.4031"></a><span id="l17.4031" class="difflineplus">+/**</span>
<a href="#l17.4032"></a><span id="l17.4032" class="difflineplus">+ * The end angle of the wedge, in radians. If not specified, the end angle is</span>
<a href="#l17.4033"></a><span id="l17.4033" class="difflineplus">+ * implied as the start angle plus the {@link #angle}.</span>
<a href="#l17.4034"></a><span id="l17.4034" class="difflineplus">+ *</span>
<a href="#l17.4035"></a><span id="l17.4035" class="difflineplus">+ * @type number</span>
<a href="#l17.4036"></a><span id="l17.4036" class="difflineplus">+ * @name pv.Wedge.prototype.endAngle</span>
<a href="#l17.4037"></a><span id="l17.4037" class="difflineplus">+ */</span>
<a href="#l17.4038"></a><span id="l17.4038" class="difflineplus">+pv.Wedge.prototype.defineProperty(&quot;endAngle&quot;);</span>
<a href="#l17.4039"></a><span id="l17.4039" class="difflineplus">+</span>
<a href="#l17.4040"></a><span id="l17.4040" class="difflineplus">+/**</span>
<a href="#l17.4041"></a><span id="l17.4041" class="difflineplus">+ * The angular span of the wedge, in radians. This property is used if end angle</span>
<a href="#l17.4042"></a><span id="l17.4042" class="difflineplus">+ * is not specified.</span>
<a href="#l17.4043"></a><span id="l17.4043" class="difflineplus">+ *</span>
<a href="#l17.4044"></a><span id="l17.4044" class="difflineplus">+ * @type number</span>
<a href="#l17.4045"></a><span id="l17.4045" class="difflineplus">+ * @name pv.Wedge.prototype.angle</span>
<a href="#l17.4046"></a><span id="l17.4046" class="difflineplus">+ */</span>
<a href="#l17.4047"></a><span id="l17.4047" class="difflineplus">+pv.Wedge.prototype.defineProperty(&quot;angle&quot;);</span>
<a href="#l17.4048"></a><span id="l17.4048" class="difflineplus">+</span>
<a href="#l17.4049"></a><span id="l17.4049" class="difflineplus">+/**</span>
<a href="#l17.4050"></a><span id="l17.4050" class="difflineplus">+ * The inner radius of the wedge, in pixels. The default value of this property</span>
<a href="#l17.4051"></a><span id="l17.4051" class="difflineplus">+ * is zero; a positive value will produce a donut slice rather than a pie slice.</span>
<a href="#l17.4052"></a><span id="l17.4052" class="difflineplus">+ * The inner radius can vary per-wedge.</span>
<a href="#l17.4053"></a><span id="l17.4053" class="difflineplus">+ *</span>
<a href="#l17.4054"></a><span id="l17.4054" class="difflineplus">+ * @type number</span>
<a href="#l17.4055"></a><span id="l17.4055" class="difflineplus">+ * @name pv.Wedge.prototype.innerRadius</span>
<a href="#l17.4056"></a><span id="l17.4056" class="difflineplus">+ */</span>
<a href="#l17.4057"></a><span id="l17.4057" class="difflineplus">+pv.Wedge.prototype.defineProperty(&quot;innerRadius&quot;);</span>
<a href="#l17.4058"></a><span id="l17.4058" class="difflineplus">+</span>
<a href="#l17.4059"></a><span id="l17.4059" class="difflineplus">+/**</span>
<a href="#l17.4060"></a><span id="l17.4060" class="difflineplus">+ * The outer radius of the wedge, in pixels. This property is required. For</span>
<a href="#l17.4061"></a><span id="l17.4061" class="difflineplus">+ * pies, only this radius is required; for donuts, the inner radius must be</span>
<a href="#l17.4062"></a><span id="l17.4062" class="difflineplus">+ * specified as well. The outer radius can vary per-wedge.</span>
<a href="#l17.4063"></a><span id="l17.4063" class="difflineplus">+ *</span>
<a href="#l17.4064"></a><span id="l17.4064" class="difflineplus">+ * @type number</span>
<a href="#l17.4065"></a><span id="l17.4065" class="difflineplus">+ * @name pv.Wedge.prototype.outerRadius</span>
<a href="#l17.4066"></a><span id="l17.4066" class="difflineplus">+ */</span>
<a href="#l17.4067"></a><span id="l17.4067" class="difflineplus">+pv.Wedge.prototype.defineProperty(&quot;outerRadius&quot;);</span>
<a href="#l17.4068"></a><span id="l17.4068" class="difflineplus">+</span>
<a href="#l17.4069"></a><span id="l17.4069" class="difflineplus">+/**</span>
<a href="#l17.4070"></a><span id="l17.4070" class="difflineplus">+ * The width of stroked lines, in pixels; used in conjunction with</span>
<a href="#l17.4071"></a><span id="l17.4071" class="difflineplus">+ * &lt;tt&gt;strokeStyle&lt;/tt&gt; to stroke the wedge's border.</span>
<a href="#l17.4072"></a><span id="l17.4072" class="difflineplus">+ *</span>
<a href="#l17.4073"></a><span id="l17.4073" class="difflineplus">+ * @type number</span>
<a href="#l17.4074"></a><span id="l17.4074" class="difflineplus">+ * @name pv.Wedge.prototype.lineWidth</span>
<a href="#l17.4075"></a><span id="l17.4075" class="difflineplus">+ */</span>
<a href="#l17.4076"></a><span id="l17.4076" class="difflineplus">+pv.Wedge.prototype.defineProperty(&quot;lineWidth&quot;);</span>
<a href="#l17.4077"></a><span id="l17.4077" class="difflineplus">+</span>
<a href="#l17.4078"></a><span id="l17.4078" class="difflineplus">+/**</span>
<a href="#l17.4079"></a><span id="l17.4079" class="difflineplus">+ * The style of stroked lines; used in conjunction with &lt;tt&gt;lineWidth&lt;/tt&gt; to</span>
<a href="#l17.4080"></a><span id="l17.4080" class="difflineplus">+ * stroke the wedge's border. The default value of this property is null,</span>
<a href="#l17.4081"></a><span id="l17.4081" class="difflineplus">+ * meaning wedges are not stroked by default.</span>
<a href="#l17.4082"></a><span id="l17.4082" class="difflineplus">+ *</span>
<a href="#l17.4083"></a><span id="l17.4083" class="difflineplus">+ * @type string</span>
<a href="#l17.4084"></a><span id="l17.4084" class="difflineplus">+ * @name pv.Wedge.prototype.strokeStyle</span>
<a href="#l17.4085"></a><span id="l17.4085" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.4086"></a><span id="l17.4086" class="difflineplus">+ */</span>
<a href="#l17.4087"></a><span id="l17.4087" class="difflineplus">+pv.Wedge.prototype.defineProperty(&quot;strokeStyle&quot;);</span>
<a href="#l17.4088"></a><span id="l17.4088" class="difflineplus">+</span>
<a href="#l17.4089"></a><span id="l17.4089" class="difflineplus">+/**</span>
<a href="#l17.4090"></a><span id="l17.4090" class="difflineplus">+ * The wedge fill style; if non-null, the interior of the wedge is filled with</span>
<a href="#l17.4091"></a><span id="l17.4091" class="difflineplus">+ * the specified color. The default value of this property is a categorical</span>
<a href="#l17.4092"></a><span id="l17.4092" class="difflineplus">+ * color.</span>
<a href="#l17.4093"></a><span id="l17.4093" class="difflineplus">+ *</span>
<a href="#l17.4094"></a><span id="l17.4094" class="difflineplus">+ * @type string</span>
<a href="#l17.4095"></a><span id="l17.4095" class="difflineplus">+ * @name pv.Wedge.prototype.fillStyle</span>
<a href="#l17.4096"></a><span id="l17.4096" class="difflineplus">+ * @see pv.color</span>
<a href="#l17.4097"></a><span id="l17.4097" class="difflineplus">+ */</span>
<a href="#l17.4098"></a><span id="l17.4098" class="difflineplus">+pv.Wedge.prototype.defineProperty(&quot;fillStyle&quot;);</span>
<a href="#l17.4099"></a><span id="l17.4099" class="difflineplus">+</span>
<a href="#l17.4100"></a><span id="l17.4100" class="difflineplus">+/**</span>
<a href="#l17.4101"></a><span id="l17.4101" class="difflineplus">+ * Default properties for wedges. By default, there is no stroke and the fill</span>
<a href="#l17.4102"></a><span id="l17.4102" class="difflineplus">+ * style is a categorical color.</span>
<a href="#l17.4103"></a><span id="l17.4103" class="difflineplus">+ *</span>
<a href="#l17.4104"></a><span id="l17.4104" class="difflineplus">+ * @type pv.Wedge</span>
<a href="#l17.4105"></a><span id="l17.4105" class="difflineplus">+ */</span>
<a href="#l17.4106"></a><span id="l17.4106" class="difflineplus">+pv.Wedge.defaults = new pv.Wedge().extend(pv.Mark.defaults)</span>
<a href="#l17.4107"></a><span id="l17.4107" class="difflineplus">+    .startAngle(function() {</span>
<a href="#l17.4108"></a><span id="l17.4108" class="difflineplus">+        var s = this.sibling();</span>
<a href="#l17.4109"></a><span id="l17.4109" class="difflineplus">+        return s ? s.endAngle : -Math.PI / 2;</span>
<a href="#l17.4110"></a><span id="l17.4110" class="difflineplus">+      })</span>
<a href="#l17.4111"></a><span id="l17.4111" class="difflineplus">+    .innerRadius(0)</span>
<a href="#l17.4112"></a><span id="l17.4112" class="difflineplus">+    .lineWidth(1.5)</span>
<a href="#l17.4113"></a><span id="l17.4113" class="difflineplus">+    .strokeStyle(null)</span>
<a href="#l17.4114"></a><span id="l17.4114" class="difflineplus">+    .fillStyle(pv.Colors.category20.unique);</span>
<a href="#l17.4115"></a><span id="l17.4115" class="difflineplus">+</span>
<a href="#l17.4116"></a><span id="l17.4116" class="difflineplus">+/**</span>
<a href="#l17.4117"></a><span id="l17.4117" class="difflineplus">+ * Returns the mid-radius of the wedge, which is defined as half-way between the</span>
<a href="#l17.4118"></a><span id="l17.4118" class="difflineplus">+ * inner and outer radii.</span>
<a href="#l17.4119"></a><span id="l17.4119" class="difflineplus">+ *</span>
<a href="#l17.4120"></a><span id="l17.4120" class="difflineplus">+ * @see #innerRadius</span>
<a href="#l17.4121"></a><span id="l17.4121" class="difflineplus">+ * @see #outerRadius</span>
<a href="#l17.4122"></a><span id="l17.4122" class="difflineplus">+ * @returns {number} the mid-radius, in pixels.</span>
<a href="#l17.4123"></a><span id="l17.4123" class="difflineplus">+ */</span>
<a href="#l17.4124"></a><span id="l17.4124" class="difflineplus">+pv.Wedge.prototype.midRadius = function() {</span>
<a href="#l17.4125"></a><span id="l17.4125" class="difflineplus">+  return (this.innerRadius() + this.outerRadius()) / 2;</span>
<a href="#l17.4126"></a><span id="l17.4126" class="difflineplus">+};</span>
<a href="#l17.4127"></a><span id="l17.4127" class="difflineplus">+</span>
<a href="#l17.4128"></a><span id="l17.4128" class="difflineplus">+/**</span>
<a href="#l17.4129"></a><span id="l17.4129" class="difflineplus">+ * Returns the mid-angle of the wedge, which is defined as half-way between the</span>
<a href="#l17.4130"></a><span id="l17.4130" class="difflineplus">+ * start and end angles.</span>
<a href="#l17.4131"></a><span id="l17.4131" class="difflineplus">+ *</span>
<a href="#l17.4132"></a><span id="l17.4132" class="difflineplus">+ * @see #startAngle</span>
<a href="#l17.4133"></a><span id="l17.4133" class="difflineplus">+ * @see #endAngle</span>
<a href="#l17.4134"></a><span id="l17.4134" class="difflineplus">+ * @returns {number} the mid-angle, in radians.</span>
<a href="#l17.4135"></a><span id="l17.4135" class="difflineplus">+ */</span>
<a href="#l17.4136"></a><span id="l17.4136" class="difflineplus">+pv.Wedge.prototype.midAngle = function() {</span>
<a href="#l17.4137"></a><span id="l17.4137" class="difflineplus">+  return (this.startAngle() + this.endAngle()) / 2;</span>
<a href="#l17.4138"></a><span id="l17.4138" class="difflineplus">+};</span>
<a href="#l17.4139"></a><span id="l17.4139" class="difflineplus">+</span>
<a href="#l17.4140"></a><span id="l17.4140" class="difflineplus">+/**</span>
<a href="#l17.4141"></a><span id="l17.4141" class="difflineplus">+ * Constructs a new wedge anchor with default properties.</span>
<a href="#l17.4142"></a><span id="l17.4142" class="difflineplus">+ *</span>
<a href="#l17.4143"></a><span id="l17.4143" class="difflineplus">+ * @class Represents an anchor for a wedge mark. Wedges support five different</span>
<a href="#l17.4144"></a><span id="l17.4144" class="difflineplus">+ * anchors:&lt;ul&gt;</span>
<a href="#l17.4145"></a><span id="l17.4145" class="difflineplus">+ *</span>
<a href="#l17.4146"></a><span id="l17.4146" class="difflineplus">+ * &lt;li&gt;outer</span>
<a href="#l17.4147"></a><span id="l17.4147" class="difflineplus">+ * &lt;li&gt;inner</span>
<a href="#l17.4148"></a><span id="l17.4148" class="difflineplus">+ * &lt;li&gt;center</span>
<a href="#l17.4149"></a><span id="l17.4149" class="difflineplus">+ * &lt;li&gt;start</span>
<a href="#l17.4150"></a><span id="l17.4150" class="difflineplus">+ * &lt;li&gt;end</span>
<a href="#l17.4151"></a><span id="l17.4151" class="difflineplus">+ *</span>
<a href="#l17.4152"></a><span id="l17.4152" class="difflineplus">+ * &lt;/ul&gt;In addition to positioning properties (left, right, top bottom), the</span>
<a href="#l17.4153"></a><span id="l17.4153" class="difflineplus">+ * anchors support text rendering properties (text-align, text-baseline,</span>
<a href="#l17.4154"></a><span id="l17.4154" class="difflineplus">+ * textAngle). Text is rendered to appear inside the wedge.</span>
<a href="#l17.4155"></a><span id="l17.4155" class="difflineplus">+ *</span>
<a href="#l17.4156"></a><span id="l17.4156" class="difflineplus">+ * @extends pv.Mark.Anchor</span>
<a href="#l17.4157"></a><span id="l17.4157" class="difflineplus">+ */</span>
<a href="#l17.4158"></a><span id="l17.4158" class="difflineplus">+pv.Wedge.Anchor = function() {</span>
<a href="#l17.4159"></a><span id="l17.4159" class="difflineplus">+  pv.Mark.Anchor.call(this);</span>
<a href="#l17.4160"></a><span id="l17.4160" class="difflineplus">+};</span>
<a href="#l17.4161"></a><span id="l17.4161" class="difflineplus">+pv.Wedge.Anchor.prototype = pv.extend(pv.Mark.Anchor);</span>
<a href="#l17.4162"></a><span id="l17.4162" class="difflineplus">+pv.Wedge.Anchor.prototype.type = pv.Wedge;</span>
<a href="#l17.4163"></a><span id="l17.4163" class="difflineplus">+</span>
<a href="#l17.4164"></a><span id="l17.4164" class="difflineplus">+/**</span>
<a href="#l17.4165"></a><span id="l17.4165" class="difflineplus">+ * The left property; non-null.</span>
<a href="#l17.4166"></a><span id="l17.4166" class="difflineplus">+ *</span>
<a href="#l17.4167"></a><span id="l17.4167" class="difflineplus">+ * @type number</span>
<a href="#l17.4168"></a><span id="l17.4168" class="difflineplus">+ * @name pv.Wedge.Anchor.prototype.left</span>
<a href="#l17.4169"></a><span id="l17.4169" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.4170"></a><span id="l17.4170" class="difflineplus">+pv.Wedge.Anchor.prototype.$left = function() {</span>
<a href="#l17.4171"></a><span id="l17.4171" class="difflineplus">+  var w = this.anchorTarget();</span>
<a href="#l17.4172"></a><span id="l17.4172" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.4173"></a><span id="l17.4173" class="difflineplus">+    case &quot;outer&quot;: return w.left() + w.outerRadius() * Math.cos(w.midAngle());</span>
<a href="#l17.4174"></a><span id="l17.4174" class="difflineplus">+    case &quot;inner&quot;: return w.left() + w.innerRadius() * Math.cos(w.midAngle());</span>
<a href="#l17.4175"></a><span id="l17.4175" class="difflineplus">+    case &quot;start&quot;: return w.left() + w.midRadius() * Math.cos(w.startAngle());</span>
<a href="#l17.4176"></a><span id="l17.4176" class="difflineplus">+    case &quot;center&quot;: return w.left() + w.midRadius() * Math.cos(w.midAngle());</span>
<a href="#l17.4177"></a><span id="l17.4177" class="difflineplus">+    case &quot;end&quot;: return w.left() + w.midRadius() * Math.cos(w.endAngle());</span>
<a href="#l17.4178"></a><span id="l17.4178" class="difflineplus">+  }</span>
<a href="#l17.4179"></a><span id="l17.4179" class="difflineplus">+  return null;</span>
<a href="#l17.4180"></a><span id="l17.4180" class="difflineplus">+};</span>
<a href="#l17.4181"></a><span id="l17.4181" class="difflineplus">+</span>
<a href="#l17.4182"></a><span id="l17.4182" class="difflineplus">+/**</span>
<a href="#l17.4183"></a><span id="l17.4183" class="difflineplus">+ * The right property; non-null.</span>
<a href="#l17.4184"></a><span id="l17.4184" class="difflineplus">+ *</span>
<a href="#l17.4185"></a><span id="l17.4185" class="difflineplus">+ * @type number</span>
<a href="#l17.4186"></a><span id="l17.4186" class="difflineplus">+ * @name pv.Wedge.Anchor.prototype.right</span>
<a href="#l17.4187"></a><span id="l17.4187" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.4188"></a><span id="l17.4188" class="difflineplus">+pv.Wedge.Anchor.prototype.$right = function() {</span>
<a href="#l17.4189"></a><span id="l17.4189" class="difflineplus">+  var w = this.anchorTarget();</span>
<a href="#l17.4190"></a><span id="l17.4190" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.4191"></a><span id="l17.4191" class="difflineplus">+    case &quot;outer&quot;: return w.right() + w.outerRadius() * Math.cos(w.midAngle());</span>
<a href="#l17.4192"></a><span id="l17.4192" class="difflineplus">+    case &quot;inner&quot;: return w.right() + w.innerRadius() * Math.cos(w.midAngle());</span>
<a href="#l17.4193"></a><span id="l17.4193" class="difflineplus">+    case &quot;start&quot;: return w.right() + w.midRadius() * Math.cos(w.startAngle());</span>
<a href="#l17.4194"></a><span id="l17.4194" class="difflineplus">+    case &quot;center&quot;: return w.right() + w.midRadius() * Math.cos(w.midAngle());</span>
<a href="#l17.4195"></a><span id="l17.4195" class="difflineplus">+    case &quot;end&quot;: return w.right() + w.midRadius() * Math.cos(w.endAngle());</span>
<a href="#l17.4196"></a><span id="l17.4196" class="difflineplus">+  }</span>
<a href="#l17.4197"></a><span id="l17.4197" class="difflineplus">+  return null;</span>
<a href="#l17.4198"></a><span id="l17.4198" class="difflineplus">+};</span>
<a href="#l17.4199"></a><span id="l17.4199" class="difflineplus">+</span>
<a href="#l17.4200"></a><span id="l17.4200" class="difflineplus">+/**</span>
<a href="#l17.4201"></a><span id="l17.4201" class="difflineplus">+ * The top property; non-null.</span>
<a href="#l17.4202"></a><span id="l17.4202" class="difflineplus">+ *</span>
<a href="#l17.4203"></a><span id="l17.4203" class="difflineplus">+ * @type number</span>
<a href="#l17.4204"></a><span id="l17.4204" class="difflineplus">+ * @name pv.Wedge.Anchor.prototype.top</span>
<a href="#l17.4205"></a><span id="l17.4205" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.4206"></a><span id="l17.4206" class="difflineplus">+pv.Wedge.Anchor.prototype.$top = function() {</span>
<a href="#l17.4207"></a><span id="l17.4207" class="difflineplus">+  var w = this.anchorTarget();</span>
<a href="#l17.4208"></a><span id="l17.4208" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.4209"></a><span id="l17.4209" class="difflineplus">+    case &quot;outer&quot;: return w.top() + w.outerRadius() * Math.sin(w.midAngle());</span>
<a href="#l17.4210"></a><span id="l17.4210" class="difflineplus">+    case &quot;inner&quot;: return w.top() + w.innerRadius() * Math.sin(w.midAngle());</span>
<a href="#l17.4211"></a><span id="l17.4211" class="difflineplus">+    case &quot;start&quot;: return w.top() + w.midRadius() * Math.sin(w.startAngle());</span>
<a href="#l17.4212"></a><span id="l17.4212" class="difflineplus">+    case &quot;center&quot;: return w.top() + w.midRadius() * Math.sin(w.midAngle());</span>
<a href="#l17.4213"></a><span id="l17.4213" class="difflineplus">+    case &quot;end&quot;: return w.top() + w.midRadius() * Math.sin(w.endAngle());</span>
<a href="#l17.4214"></a><span id="l17.4214" class="difflineplus">+  }</span>
<a href="#l17.4215"></a><span id="l17.4215" class="difflineplus">+  return null;</span>
<a href="#l17.4216"></a><span id="l17.4216" class="difflineplus">+};</span>
<a href="#l17.4217"></a><span id="l17.4217" class="difflineplus">+</span>
<a href="#l17.4218"></a><span id="l17.4218" class="difflineplus">+/**</span>
<a href="#l17.4219"></a><span id="l17.4219" class="difflineplus">+ * The bottom property; non-null.</span>
<a href="#l17.4220"></a><span id="l17.4220" class="difflineplus">+ *</span>
<a href="#l17.4221"></a><span id="l17.4221" class="difflineplus">+ * @type number</span>
<a href="#l17.4222"></a><span id="l17.4222" class="difflineplus">+ * @name pv.Wedge.Anchor.prototype.bottom</span>
<a href="#l17.4223"></a><span id="l17.4223" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.4224"></a><span id="l17.4224" class="difflineplus">+pv.Wedge.Anchor.prototype.$bottom = function() {</span>
<a href="#l17.4225"></a><span id="l17.4225" class="difflineplus">+  var w = this.anchorTarget();</span>
<a href="#l17.4226"></a><span id="l17.4226" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.4227"></a><span id="l17.4227" class="difflineplus">+    case &quot;outer&quot;: return w.bottom() + w.outerRadius() * Math.sin(w.midAngle());</span>
<a href="#l17.4228"></a><span id="l17.4228" class="difflineplus">+    case &quot;inner&quot;: return w.bottom() + w.innerRadius() * Math.sin(w.midAngle());</span>
<a href="#l17.4229"></a><span id="l17.4229" class="difflineplus">+    case &quot;start&quot;: return w.bottom() + w.midRadius() * Math.sin(w.startAngle());</span>
<a href="#l17.4230"></a><span id="l17.4230" class="difflineplus">+    case &quot;center&quot;: return w.bottom() + w.midRadius() * Math.sin(w.midAngle());</span>
<a href="#l17.4231"></a><span id="l17.4231" class="difflineplus">+    case &quot;end&quot;: return w.bottom() + w.midRadius() * Math.sin(w.endAngle());</span>
<a href="#l17.4232"></a><span id="l17.4232" class="difflineplus">+  }</span>
<a href="#l17.4233"></a><span id="l17.4233" class="difflineplus">+  return null;</span>
<a href="#l17.4234"></a><span id="l17.4234" class="difflineplus">+};</span>
<a href="#l17.4235"></a><span id="l17.4235" class="difflineplus">+</span>
<a href="#l17.4236"></a><span id="l17.4236" class="difflineplus">+/**</span>
<a href="#l17.4237"></a><span id="l17.4237" class="difflineplus">+ * The text-align property, for horizontal alignment inside the wedge.</span>
<a href="#l17.4238"></a><span id="l17.4238" class="difflineplus">+ *</span>
<a href="#l17.4239"></a><span id="l17.4239" class="difflineplus">+ * @type string</span>
<a href="#l17.4240"></a><span id="l17.4240" class="difflineplus">+ * @name pv.Wedge.Anchor.prototype.textAlign</span>
<a href="#l17.4241"></a><span id="l17.4241" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.4242"></a><span id="l17.4242" class="difflineplus">+pv.Wedge.Anchor.prototype.$textAlign = function() {</span>
<a href="#l17.4243"></a><span id="l17.4243" class="difflineplus">+  var w = this.anchorTarget();</span>
<a href="#l17.4244"></a><span id="l17.4244" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.4245"></a><span id="l17.4245" class="difflineplus">+    case &quot;outer&quot;: return pv.Wedge.upright(w.midAngle()) ? &quot;right&quot; : &quot;left&quot;;</span>
<a href="#l17.4246"></a><span id="l17.4246" class="difflineplus">+    case &quot;inner&quot;: return pv.Wedge.upright(w.midAngle()) ? &quot;left&quot; : &quot;right&quot;;</span>
<a href="#l17.4247"></a><span id="l17.4247" class="difflineplus">+    default: return &quot;center&quot;;</span>
<a href="#l17.4248"></a><span id="l17.4248" class="difflineplus">+  }</span>
<a href="#l17.4249"></a><span id="l17.4249" class="difflineplus">+};</span>
<a href="#l17.4250"></a><span id="l17.4250" class="difflineplus">+</span>
<a href="#l17.4251"></a><span id="l17.4251" class="difflineplus">+/**</span>
<a href="#l17.4252"></a><span id="l17.4252" class="difflineplus">+ * The text-baseline property, for vertical alignment inside the wedge.</span>
<a href="#l17.4253"></a><span id="l17.4253" class="difflineplus">+ *</span>
<a href="#l17.4254"></a><span id="l17.4254" class="difflineplus">+ * @type string</span>
<a href="#l17.4255"></a><span id="l17.4255" class="difflineplus">+ * @name pv.Wedge.Anchor.prototype.textBaseline</span>
<a href="#l17.4256"></a><span id="l17.4256" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.4257"></a><span id="l17.4257" class="difflineplus">+pv.Wedge.Anchor.prototype.$textBaseline = function() {</span>
<a href="#l17.4258"></a><span id="l17.4258" class="difflineplus">+  var w = this.anchorTarget();</span>
<a href="#l17.4259"></a><span id="l17.4259" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.4260"></a><span id="l17.4260" class="difflineplus">+    case &quot;start&quot;: return pv.Wedge.upright(w.startAngle()) ? &quot;top&quot; : &quot;bottom&quot;;</span>
<a href="#l17.4261"></a><span id="l17.4261" class="difflineplus">+    case &quot;end&quot;: return pv.Wedge.upright(w.endAngle()) ? &quot;bottom&quot; : &quot;top&quot;;</span>
<a href="#l17.4262"></a><span id="l17.4262" class="difflineplus">+    default: return &quot;middle&quot;;</span>
<a href="#l17.4263"></a><span id="l17.4263" class="difflineplus">+  }</span>
<a href="#l17.4264"></a><span id="l17.4264" class="difflineplus">+};</span>
<a href="#l17.4265"></a><span id="l17.4265" class="difflineplus">+</span>
<a href="#l17.4266"></a><span id="l17.4266" class="difflineplus">+/**</span>
<a href="#l17.4267"></a><span id="l17.4267" class="difflineplus">+ * The text-angle property, for text rotation inside the wedge.</span>
<a href="#l17.4268"></a><span id="l17.4268" class="difflineplus">+ *</span>
<a href="#l17.4269"></a><span id="l17.4269" class="difflineplus">+ * @type number</span>
<a href="#l17.4270"></a><span id="l17.4270" class="difflineplus">+ * @name pv.Wedge.Anchor.prototype.textAngle</span>
<a href="#l17.4271"></a><span id="l17.4271" class="difflineplus">+ */ /** @private */</span>
<a href="#l17.4272"></a><span id="l17.4272" class="difflineplus">+pv.Wedge.Anchor.prototype.$textAngle = function() {</span>
<a href="#l17.4273"></a><span id="l17.4273" class="difflineplus">+  var w = this.anchorTarget();</span>
<a href="#l17.4274"></a><span id="l17.4274" class="difflineplus">+  var a = 0;</span>
<a href="#l17.4275"></a><span id="l17.4275" class="difflineplus">+  switch (this.get(&quot;name&quot;)) {</span>
<a href="#l17.4276"></a><span id="l17.4276" class="difflineplus">+    case &quot;center&quot;:</span>
<a href="#l17.4277"></a><span id="l17.4277" class="difflineplus">+    case &quot;inner&quot;:</span>
<a href="#l17.4278"></a><span id="l17.4278" class="difflineplus">+    case &quot;outer&quot;: a = w.midAngle(); break;</span>
<a href="#l17.4279"></a><span id="l17.4279" class="difflineplus">+    case &quot;start&quot;: a = w.startAngle(); break;</span>
<a href="#l17.4280"></a><span id="l17.4280" class="difflineplus">+    case &quot;end&quot;: a = w.endAngle(); break;</span>
<a href="#l17.4281"></a><span id="l17.4281" class="difflineplus">+  }</span>
<a href="#l17.4282"></a><span id="l17.4282" class="difflineplus">+  return pv.Wedge.upright(a) ? a : (a + Math.PI);</span>
<a href="#l17.4283"></a><span id="l17.4283" class="difflineplus">+};</span>
<a href="#l17.4284"></a><span id="l17.4284" class="difflineplus">+</span>
<a href="#l17.4285"></a><span id="l17.4285" class="difflineplus">+/**</span>
<a href="#l17.4286"></a><span id="l17.4286" class="difflineplus">+ * Returns true if the specified angle is considered &quot;upright&quot;, as in, text</span>
<a href="#l17.4287"></a><span id="l17.4287" class="difflineplus">+ * rendered at that angle would appear upright. If the angle is not upright,</span>
<a href="#l17.4288"></a><span id="l17.4288" class="difflineplus">+ * text is rotated 180 degrees to be upright, and the text alignment properties</span>
<a href="#l17.4289"></a><span id="l17.4289" class="difflineplus">+ * are correspondingly changed.</span>
<a href="#l17.4290"></a><span id="l17.4290" class="difflineplus">+ *</span>
<a href="#l17.4291"></a><span id="l17.4291" class="difflineplus">+ * @param {number} angle an angle, in radius.</span>
<a href="#l17.4292"></a><span id="l17.4292" class="difflineplus">+ * @returns {boolean} true if the specified angle is upright.</span>
<a href="#l17.4293"></a><span id="l17.4293" class="difflineplus">+ */</span>
<a href="#l17.4294"></a><span id="l17.4294" class="difflineplus">+pv.Wedge.upright = function(angle) {</span>
<a href="#l17.4295"></a><span id="l17.4295" class="difflineplus">+  angle = angle % (2 * Math.PI);</span>
<a href="#l17.4296"></a><span id="l17.4296" class="difflineplus">+  angle = (angle &lt; 0) ? (2 * Math.PI + angle) : angle;</span>
<a href="#l17.4297"></a><span id="l17.4297" class="difflineplus">+  return (angle &lt; Math.PI / 2) || (angle &gt; 3 * Math.PI / 2);</span>
<a href="#l17.4298"></a><span id="l17.4298" class="difflineplus">+};</span>
<a href="#l17.4299"></a><span id="l17.4299" class="difflineplus">+</span>
<a href="#l17.4300"></a><span id="l17.4300" class="difflineplus">+/**</span>
<a href="#l17.4301"></a><span id="l17.4301" class="difflineplus">+ * Overrides the default behavior of {@link Mark#buildImplied} such that the end</span>
<a href="#l17.4302"></a><span id="l17.4302" class="difflineplus">+ * angle is computed from the start angle and angle (angular span) if not</span>
<a href="#l17.4303"></a><span id="l17.4303" class="difflineplus">+ * specified.</span>
<a href="#l17.4304"></a><span id="l17.4304" class="difflineplus">+ *</span>
<a href="#l17.4305"></a><span id="l17.4305" class="difflineplus">+ * @param s a node in the scene graph; the instance of the wedge to build.</span>
<a href="#l17.4306"></a><span id="l17.4306" class="difflineplus">+ */</span>
<a href="#l17.4307"></a><span id="l17.4307" class="difflineplus">+pv.Wedge.prototype.buildImplied = function(s) {</span>
<a href="#l17.4308"></a><span id="l17.4308" class="difflineplus">+  pv.Mark.prototype.buildImplied.call(this, s);</span>
<a href="#l17.4309"></a><span id="l17.4309" class="difflineplus">+  if (s.endAngle == null) {</span>
<a href="#l17.4310"></a><span id="l17.4310" class="difflineplus">+    s.endAngle = s.startAngle + s.angle;</span>
<a href="#l17.4311"></a><span id="l17.4311" class="difflineplus">+  }</span>
<a href="#l17.4312"></a><span id="l17.4312" class="difflineplus">+};</span>
<a href="#l17.4313"></a><span id="l17.4313" class="difflineplus">+</span>
<a href="#l17.4314"></a><span id="l17.4314" class="difflineplus">+/**</span>
<a href="#l17.4315"></a><span id="l17.4315" class="difflineplus">+ * Updates the display for the specified wedge instance &lt;tt&gt;s&lt;/tt&gt; in the scene</span>
<a href="#l17.4316"></a><span id="l17.4316" class="difflineplus">+ * graph. This implementation handles the fill and stroke style for the wedge,</span>
<a href="#l17.4317"></a><span id="l17.4317" class="difflineplus">+ * as well as positional properties.</span>
<a href="#l17.4318"></a><span id="l17.4318" class="difflineplus">+ *</span>
<a href="#l17.4319"></a><span id="l17.4319" class="difflineplus">+ * @param s a node in the scene graph; the instance of the bar to update.</span>
<a href="#l17.4320"></a><span id="l17.4320" class="difflineplus">+ */</span>
<a href="#l17.4321"></a><span id="l17.4321" class="difflineplus">+pv.Wedge.prototype.updateInstance = function(s) {</span>
<a href="#l17.4322"></a><span id="l17.4322" class="difflineplus">+  var v = s.svg;</span>
<a href="#l17.4323"></a><span id="l17.4323" class="difflineplus">+</span>
<a href="#l17.4324"></a><span id="l17.4324" class="difflineplus">+  /* Create the &lt;svg:path&gt; element, if necessary. */</span>
<a href="#l17.4325"></a><span id="l17.4325" class="difflineplus">+  if (s.visible &amp;&amp; !v) {</span>
<a href="#l17.4326"></a><span id="l17.4326" class="difflineplus">+    v = s.svg = document.createElementNS(pv.ns.svg, &quot;path&quot;);</span>
<a href="#l17.4327"></a><span id="l17.4327" class="difflineplus">+    v.setAttribute(&quot;fill-rule&quot;, &quot;evenodd&quot;);</span>
<a href="#l17.4328"></a><span id="l17.4328" class="difflineplus">+    s.parent.svg.appendChild(v);</span>
<a href="#l17.4329"></a><span id="l17.4329" class="difflineplus">+  }</span>
<a href="#l17.4330"></a><span id="l17.4330" class="difflineplus">+</span>
<a href="#l17.4331"></a><span id="l17.4331" class="difflineplus">+  /* visible, cursor, title, events, etc. */</span>
<a href="#l17.4332"></a><span id="l17.4332" class="difflineplus">+  pv.Mark.prototype.updateInstance.call(this, s);</span>
<a href="#l17.4333"></a><span id="l17.4333" class="difflineplus">+  if (!s.visible) return;</span>
<a href="#l17.4334"></a><span id="l17.4334" class="difflineplus">+</span>
<a href="#l17.4335"></a><span id="l17.4335" class="difflineplus">+  /* left, top */</span>
<a href="#l17.4336"></a><span id="l17.4336" class="difflineplus">+  v.setAttribute(&quot;transform&quot;, &quot;translate(&quot; + s.left + &quot;,&quot; + s.top +&quot;)&quot;);</span>
<a href="#l17.4337"></a><span id="l17.4337" class="difflineplus">+</span>
<a href="#l17.4338"></a><span id="l17.4338" class="difflineplus">+  /*</span>
<a href="#l17.4339"></a><span id="l17.4339" class="difflineplus">+   * TODO If the angle or endAngle is updated by an event handler, the implied</span>
<a href="#l17.4340"></a><span id="l17.4340" class="difflineplus">+   * properties won't recompute correctly, so this will lead to potentially</span>
<a href="#l17.4341"></a><span id="l17.4341" class="difflineplus">+   * buggy redraw. How to re-evaluate implied properties on update?</span>
<a href="#l17.4342"></a><span id="l17.4342" class="difflineplus">+   */</span>
<a href="#l17.4343"></a><span id="l17.4343" class="difflineplus">+</span>
<a href="#l17.4344"></a><span id="l17.4344" class="difflineplus">+  /* innerRadius, outerRadius, startAngle, endAngle */</span>
<a href="#l17.4345"></a><span id="l17.4345" class="difflineplus">+  var r1 = s.innerRadius, r2 = s.outerRadius;</span>
<a href="#l17.4346"></a><span id="l17.4346" class="difflineplus">+  if (s.angle &gt;= 2 * Math.PI) {</span>
<a href="#l17.4347"></a><span id="l17.4347" class="difflineplus">+    if (r1) {</span>
<a href="#l17.4348"></a><span id="l17.4348" class="difflineplus">+      v.setAttribute(&quot;d&quot;, &quot;M0,&quot; + r2</span>
<a href="#l17.4349"></a><span id="l17.4349" class="difflineplus">+          + &quot;A&quot; + r2 + &quot;,&quot; + r2 + &quot; 0 1,1 0,&quot; + (-r2)</span>
<a href="#l17.4350"></a><span id="l17.4350" class="difflineplus">+          + &quot;A&quot; + r2 + &quot;,&quot; + r2 + &quot; 0 1,1 0,&quot; + r2</span>
<a href="#l17.4351"></a><span id="l17.4351" class="difflineplus">+          + &quot;M0,&quot; + r1</span>
<a href="#l17.4352"></a><span id="l17.4352" class="difflineplus">+          + &quot;A&quot; + r1 + &quot;,&quot; + r1 + &quot; 0 1,1 0,&quot; + (-r1)</span>
<a href="#l17.4353"></a><span id="l17.4353" class="difflineplus">+          + &quot;A&quot; + r1 + &quot;,&quot; + r1 + &quot; 0 1,1 0,&quot; + r1</span>
<a href="#l17.4354"></a><span id="l17.4354" class="difflineplus">+          + &quot;Z&quot;);</span>
<a href="#l17.4355"></a><span id="l17.4355" class="difflineplus">+    } else {</span>
<a href="#l17.4356"></a><span id="l17.4356" class="difflineplus">+      v.setAttribute(&quot;d&quot;, &quot;M0,&quot; + r2</span>
<a href="#l17.4357"></a><span id="l17.4357" class="difflineplus">+          + &quot;A&quot; + r2 + &quot;,&quot; + r2 + &quot; 0 1,1 0,&quot; + (-r2)</span>
<a href="#l17.4358"></a><span id="l17.4358" class="difflineplus">+          + &quot;A&quot; + r2 + &quot;,&quot; + r2 + &quot; 0 1,1 0,&quot; + r2</span>
<a href="#l17.4359"></a><span id="l17.4359" class="difflineplus">+          + &quot;Z&quot;);</span>
<a href="#l17.4360"></a><span id="l17.4360" class="difflineplus">+    }</span>
<a href="#l17.4361"></a><span id="l17.4361" class="difflineplus">+  } else {</span>
<a href="#l17.4362"></a><span id="l17.4362" class="difflineplus">+    var c1 = Math.cos(s.startAngle), c2 = Math.cos(s.endAngle),</span>
<a href="#l17.4363"></a><span id="l17.4363" class="difflineplus">+        s1 = Math.sin(s.startAngle), s2 = Math.sin(s.endAngle);</span>
<a href="#l17.4364"></a><span id="l17.4364" class="difflineplus">+    if (r1) {</span>
<a href="#l17.4365"></a><span id="l17.4365" class="difflineplus">+      v.setAttribute(&quot;d&quot;, &quot;M&quot; + r2 * c1 + &quot;,&quot; + r2 * s1</span>
<a href="#l17.4366"></a><span id="l17.4366" class="difflineplus">+          + &quot;A&quot; + r2 + &quot;,&quot; + r2 + &quot; 0 &quot;</span>
<a href="#l17.4367"></a><span id="l17.4367" class="difflineplus">+          + ((s.angle &lt; Math.PI) ? &quot;0&quot; : &quot;1&quot;) + &quot;,1 &quot;</span>
<a href="#l17.4368"></a><span id="l17.4368" class="difflineplus">+          + r2 * c2 + &quot;,&quot; + r2 * s2</span>
<a href="#l17.4369"></a><span id="l17.4369" class="difflineplus">+          + &quot;L&quot; + r1 * c2 + &quot;,&quot; + r1 * s2</span>
<a href="#l17.4370"></a><span id="l17.4370" class="difflineplus">+          + &quot;A&quot; + r1 + &quot;,&quot; + r1 + &quot; 0 &quot;</span>
<a href="#l17.4371"></a><span id="l17.4371" class="difflineplus">+          + ((s.angle &lt; Math.PI) ? &quot;0&quot; : &quot;1&quot;) + &quot;,0 &quot;</span>
<a href="#l17.4372"></a><span id="l17.4372" class="difflineplus">+          + r1 * c1 + &quot;,&quot; + r1 * s1 + &quot;Z&quot;);</span>
<a href="#l17.4373"></a><span id="l17.4373" class="difflineplus">+    } else {</span>
<a href="#l17.4374"></a><span id="l17.4374" class="difflineplus">+      v.setAttribute(&quot;d&quot;, &quot;M&quot; + r2 * c1 + &quot;,&quot; + r2 * s1</span>
<a href="#l17.4375"></a><span id="l17.4375" class="difflineplus">+          + &quot;A&quot; + r2 + &quot;,&quot; + r2 + &quot; 0 &quot;</span>
<a href="#l17.4376"></a><span id="l17.4376" class="difflineplus">+          + ((s.angle &lt; Math.PI) ? &quot;0&quot; : &quot;1&quot;) + &quot;,1 &quot;</span>
<a href="#l17.4377"></a><span id="l17.4377" class="difflineplus">+          + r2 * c2 + &quot;,&quot; + r2 * s2 + &quot;L0,0Z&quot;);</span>
<a href="#l17.4378"></a><span id="l17.4378" class="difflineplus">+    }</span>
<a href="#l17.4379"></a><span id="l17.4379" class="difflineplus">+  }</span>
<a href="#l17.4380"></a><span id="l17.4380" class="difflineplus">+</span>
<a href="#l17.4381"></a><span id="l17.4381" class="difflineplus">+  /* fill, stroke TODO gradient, patterns */</span>
<a href="#l17.4382"></a><span id="l17.4382" class="difflineplus">+  var fill = pv.color(s.fillStyle);</span>
<a href="#l17.4383"></a><span id="l17.4383" class="difflineplus">+  v.setAttribute(&quot;fill&quot;, fill.color);</span>
<a href="#l17.4384"></a><span id="l17.4384" class="difflineplus">+  v.setAttribute(&quot;fill-opacity&quot;, fill.opacity);</span>
<a href="#l17.4385"></a><span id="l17.4385" class="difflineplus">+  var stroke = pv.color(s.strokeStyle);</span>
<a href="#l17.4386"></a><span id="l17.4386" class="difflineplus">+  v.setAttribute(&quot;stroke&quot;, stroke.color);</span>
<a href="#l17.4387"></a><span id="l17.4387" class="difflineplus">+  v.setAttribute(&quot;stroke-opacity&quot;, stroke.opacity);</span>
<a href="#l17.4388"></a><span id="l17.4388" class="difflineplus">+  v.setAttribute(&quot;stroke-width&quot;, s.lineWidth);</span>
<a href="#l17.4389"></a><span id="l17.4389" class="difflineplus">+};</span>
<a href="#l17.4390"></a><span id="l17.4390" class="difflineplus">+pv.Scales = {};</span>
<a href="#l17.4391"></a><span id="l17.4391" class="difflineplus">+pv.Scales.epsilon = 1e-30;</span>
<a href="#l17.4392"></a><span id="l17.4392" class="difflineplus">+pv.Scales.defaultBase = 10;</span>
<a href="#l17.4393"></a><span id="l17.4393" class="difflineplus">+</span>
<a href="#l17.4394"></a><span id="l17.4394" class="difflineplus">+/**</span>
<a href="#l17.4395"></a><span id="l17.4395" class="difflineplus">+ * Scale is a base class for scale objects. Scale objects are used to scale the</span>
<a href="#l17.4396"></a><span id="l17.4396" class="difflineplus">+ * data to a given range. The Scale object initially scales the value to the</span>
<a href="#l17.4397"></a><span id="l17.4397" class="difflineplus">+ * interval [0, 1]. The values are then mapped to a given range by the range()</span>
<a href="#l17.4398"></a><span id="l17.4398" class="difflineplus">+ * method.</span>
<a href="#l17.4399"></a><span id="l17.4399" class="difflineplus">+ */</span>
<a href="#l17.4400"></a><span id="l17.4400" class="difflineplus">+pv.Scales.Scale = function() {</span>
<a href="#l17.4401"></a><span id="l17.4401" class="difflineplus">+  // Pixel coordinate minimum</span>
<a href="#l17.4402"></a><span id="l17.4402" class="difflineplus">+  this._rMin = 0;</span>
<a href="#l17.4403"></a><span id="l17.4403" class="difflineplus">+  // Pixel coordinate maximum</span>
<a href="#l17.4404"></a><span id="l17.4404" class="difflineplus">+  this._rMax = 100;</span>
<a href="#l17.4405"></a><span id="l17.4405" class="difflineplus">+  // Round value?</span>
<a href="#l17.4406"></a><span id="l17.4406" class="difflineplus">+  this._round = true;</span>
<a href="#l17.4407"></a><span id="l17.4407" class="difflineplus">+};</span>
<a href="#l17.4408"></a><span id="l17.4408" class="difflineplus">+</span>
<a href="#l17.4409"></a><span id="l17.4409" class="difflineplus">+/**</span>
<a href="#l17.4410"></a><span id="l17.4410" class="difflineplus">+ * Sets the range to map the data to.</span>
<a href="#l17.4411"></a><span id="l17.4411" class="difflineplus">+ */</span>
<a href="#l17.4412"></a><span id="l17.4412" class="difflineplus">+pv.Scales.Scale.prototype.range = function(a, b) {</span>
<a href="#l17.4413"></a><span id="l17.4413" class="difflineplus">+  if (a == undefined) {</span>
<a href="#l17.4414"></a><span id="l17.4414" class="difflineplus">+    // use default values</span>
<a href="#l17.4415"></a><span id="l17.4415" class="difflineplus">+    // TODO: [0, 100] may not be the best default values.</span>
<a href="#l17.4416"></a><span id="l17.4416" class="difflineplus">+    // Find better default values, which may be different for each scale type.</span>
<a href="#l17.4417"></a><span id="l17.4417" class="difflineplus">+  } else if (b == undefined) {</span>
<a href="#l17.4418"></a><span id="l17.4418" class="difflineplus">+    this._rMin = 0;</span>
<a href="#l17.4419"></a><span id="l17.4419" class="difflineplus">+    this._rMax = a;</span>
<a href="#l17.4420"></a><span id="l17.4420" class="difflineplus">+  } else {</span>
<a href="#l17.4421"></a><span id="l17.4421" class="difflineplus">+    this._rMin = a;</span>
<a href="#l17.4422"></a><span id="l17.4422" class="difflineplus">+    this._rMax = b;</span>
<a href="#l17.4423"></a><span id="l17.4423" class="difflineplus">+  }</span>
<a href="#l17.4424"></a><span id="l17.4424" class="difflineplus">+</span>
<a href="#l17.4425"></a><span id="l17.4425" class="difflineplus">+  return this;</span>
<a href="#l17.4426"></a><span id="l17.4426" class="difflineplus">+};</span>
<a href="#l17.4427"></a><span id="l17.4427" class="difflineplus">+</span>
<a href="#l17.4428"></a><span id="l17.4428" class="difflineplus">+// Accessor method for range min</span>
<a href="#l17.4429"></a><span id="l17.4429" class="difflineplus">+pv.Scales.Scale.prototype.rangeMin = function(x) {</span>
<a href="#l17.4430"></a><span id="l17.4430" class="difflineplus">+  if (x == undefined) {</span>
<a href="#l17.4431"></a><span id="l17.4431" class="difflineplus">+    return this._rMin;</span>
<a href="#l17.4432"></a><span id="l17.4432" class="difflineplus">+  } else {</span>
<a href="#l17.4433"></a><span id="l17.4433" class="difflineplus">+    this._rMin = x;</span>
<a href="#l17.4434"></a><span id="l17.4434" class="difflineplus">+    return this;</span>
<a href="#l17.4435"></a><span id="l17.4435" class="difflineplus">+  }</span>
<a href="#l17.4436"></a><span id="l17.4436" class="difflineplus">+};</span>
<a href="#l17.4437"></a><span id="l17.4437" class="difflineplus">+</span>
<a href="#l17.4438"></a><span id="l17.4438" class="difflineplus">+// Accessor method for range max</span>
<a href="#l17.4439"></a><span id="l17.4439" class="difflineplus">+pv.Scales.Scale.prototype.rangeMax = function(x) {</span>
<a href="#l17.4440"></a><span id="l17.4440" class="difflineplus">+  if (x == undefined) {</span>
<a href="#l17.4441"></a><span id="l17.4441" class="difflineplus">+    return this._rMax;</span>
<a href="#l17.4442"></a><span id="l17.4442" class="difflineplus">+  } else {</span>
<a href="#l17.4443"></a><span id="l17.4443" class="difflineplus">+    this._rMax = x;</span>
<a href="#l17.4444"></a><span id="l17.4444" class="difflineplus">+    return this;</span>
<a href="#l17.4445"></a><span id="l17.4445" class="difflineplus">+  }</span>
<a href="#l17.4446"></a><span id="l17.4446" class="difflineplus">+};</span>
<a href="#l17.4447"></a><span id="l17.4447" class="difflineplus">+</span>
<a href="#l17.4448"></a><span id="l17.4448" class="difflineplus">+// Accessor method for round</span>
<a href="#l17.4449"></a><span id="l17.4449" class="difflineplus">+pv.Scales.Scale.prototype.round = function(x) {</span>
<a href="#l17.4450"></a><span id="l17.4450" class="difflineplus">+  if (x == undefined) {</span>
<a href="#l17.4451"></a><span id="l17.4451" class="difflineplus">+    return this._round;</span>
<a href="#l17.4452"></a><span id="l17.4452" class="difflineplus">+  } else {</span>
<a href="#l17.4453"></a><span id="l17.4453" class="difflineplus">+    this._round = x;</span>
<a href="#l17.4454"></a><span id="l17.4454" class="difflineplus">+    return this;</span>
<a href="#l17.4455"></a><span id="l17.4455" class="difflineplus">+  }</span>
<a href="#l17.4456"></a><span id="l17.4456" class="difflineplus">+};</span>
<a href="#l17.4457"></a><span id="l17.4457" class="difflineplus">+</span>
<a href="#l17.4458"></a><span id="l17.4458" class="difflineplus">+//Scales the input to the set range</span>
<a href="#l17.4459"></a><span id="l17.4459" class="difflineplus">+pv.Scales.Scale.prototype.scale = function(x) {</span>
<a href="#l17.4460"></a><span id="l17.4460" class="difflineplus">+  var v = this._rMin + (this._rMax-this._rMin) * this.normalize(x);</span>
<a href="#l17.4461"></a><span id="l17.4461" class="difflineplus">+  return this._round ? Math.round(v) : v;</span>
<a href="#l17.4462"></a><span id="l17.4462" class="difflineplus">+};</span>
<a href="#l17.4463"></a><span id="l17.4463" class="difflineplus">+</span>
<a href="#l17.4464"></a><span id="l17.4464" class="difflineplus">+// Returns the inverse scaled value.</span>
<a href="#l17.4465"></a><span id="l17.4465" class="difflineplus">+pv.Scales.Scale.prototype.invert = function(y) {</span>
<a href="#l17.4466"></a><span id="l17.4466" class="difflineplus">+  var n = (y - this._rMin) / (this._rMax - this._rMin);</span>
<a href="#l17.4467"></a><span id="l17.4467" class="difflineplus">+  return this.unnormalize(n);</span>
<a href="#l17.4468"></a><span id="l17.4468" class="difflineplus">+};</span>
<a href="#l17.4469"></a><span id="l17.4469" class="difflineplus">+pv.Scale = {};</span>
<a href="#l17.4470"></a><span id="l17.4470" class="difflineplus">+</span>
<a href="#l17.4471"></a><span id="l17.4471" class="difflineplus">+pv.Scale.linear = function() {</span>
<a href="#l17.4472"></a><span id="l17.4472" class="difflineplus">+  var min, max, nice = false, s, f = pv.identity;</span>
<a href="#l17.4473"></a><span id="l17.4473" class="difflineplus">+</span>
<a href="#l17.4474"></a><span id="l17.4474" class="difflineplus">+  /* Property function. */</span>
<a href="#l17.4475"></a><span id="l17.4475" class="difflineplus">+  function scale() {</span>
<a href="#l17.4476"></a><span id="l17.4476" class="difflineplus">+    if (s == undefined) {</span>
<a href="#l17.4477"></a><span id="l17.4477" class="difflineplus">+      if (min == undefined) min = pv.min(this.$$data, f);</span>
<a href="#l17.4478"></a><span id="l17.4478" class="difflineplus">+      if (max == undefined) max = pv.max(this.$$data, f);</span>
<a href="#l17.4479"></a><span id="l17.4479" class="difflineplus">+      if (nice) { // TODO Only &quot;nice&quot; bounds set automatically.</span>
<a href="#l17.4480"></a><span id="l17.4480" class="difflineplus">+        var step = Math.pow(10, Math.round(Math.log(max - min) / Math.log(10)) - 1);</span>
<a href="#l17.4481"></a><span id="l17.4481" class="difflineplus">+        min = Math.floor(min / step) * step;</span>
<a href="#l17.4482"></a><span id="l17.4482" class="difflineplus">+        max = Math.ceil(max / step) * step;</span>
<a href="#l17.4483"></a><span id="l17.4483" class="difflineplus">+      }</span>
<a href="#l17.4484"></a><span id="l17.4484" class="difflineplus">+      s = range.call(this) / (max - min);</span>
<a href="#l17.4485"></a><span id="l17.4485" class="difflineplus">+    }</span>
<a href="#l17.4486"></a><span id="l17.4486" class="difflineplus">+    return (f.apply(this, arguments) - min) * s;</span>
<a href="#l17.4487"></a><span id="l17.4487" class="difflineplus">+  }</span>
<a href="#l17.4488"></a><span id="l17.4488" class="difflineplus">+</span>
<a href="#l17.4489"></a><span id="l17.4489" class="difflineplus">+  function range() {</span>
<a href="#l17.4490"></a><span id="l17.4490" class="difflineplus">+    switch (property) {</span>
<a href="#l17.4491"></a><span id="l17.4491" class="difflineplus">+      case &quot;height&quot;:</span>
<a href="#l17.4492"></a><span id="l17.4492" class="difflineplus">+      case &quot;top&quot;:</span>
<a href="#l17.4493"></a><span id="l17.4493" class="difflineplus">+      case &quot;bottom&quot;: return this.parent.height();</span>
<a href="#l17.4494"></a><span id="l17.4494" class="difflineplus">+      case &quot;width&quot;:</span>
<a href="#l17.4495"></a><span id="l17.4495" class="difflineplus">+      case &quot;left&quot;:</span>
<a href="#l17.4496"></a><span id="l17.4496" class="difflineplus">+      case &quot;right&quot;: return this.parent.width();</span>
<a href="#l17.4497"></a><span id="l17.4497" class="difflineplus">+      default: return 1;</span>
<a href="#l17.4498"></a><span id="l17.4498" class="difflineplus">+    }</span>
<a href="#l17.4499"></a><span id="l17.4499" class="difflineplus">+  }</span>
<a href="#l17.4500"></a><span id="l17.4500" class="difflineplus">+</span>
<a href="#l17.4501"></a><span id="l17.4501" class="difflineplus">+  scale.by = function(v) { f = v; return this; };</span>
<a href="#l17.4502"></a><span id="l17.4502" class="difflineplus">+  scale.min = function(v) { min = v; return this; };</span>
<a href="#l17.4503"></a><span id="l17.4503" class="difflineplus">+  scale.max = function(v) { max = v; return this; };</span>
<a href="#l17.4504"></a><span id="l17.4504" class="difflineplus">+</span>
<a href="#l17.4505"></a><span id="l17.4505" class="difflineplus">+  scale.nice = function(v) {</span>
<a href="#l17.4506"></a><span id="l17.4506" class="difflineplus">+    nice = (arguments.length == 0) ? true : v;</span>
<a href="#l17.4507"></a><span id="l17.4507" class="difflineplus">+    return this;</span>
<a href="#l17.4508"></a><span id="l17.4508" class="difflineplus">+  };</span>
<a href="#l17.4509"></a><span id="l17.4509" class="difflineplus">+</span>
<a href="#l17.4510"></a><span id="l17.4510" class="difflineplus">+  scale.range = function() {</span>
<a href="#l17.4511"></a><span id="l17.4511" class="difflineplus">+    if (arguments.length == 1) {</span>
<a href="#l17.4512"></a><span id="l17.4512" class="difflineplus">+      o = 0;</span>
<a href="#l17.4513"></a><span id="l17.4513" class="difflineplus">+      s = arguments[0];</span>
<a href="#l17.4514"></a><span id="l17.4514" class="difflineplus">+    } else {</span>
<a href="#l17.4515"></a><span id="l17.4515" class="difflineplus">+      o = arguments[0];</span>
<a href="#l17.4516"></a><span id="l17.4516" class="difflineplus">+      s = arguments[1] - arguments[0];</span>
<a href="#l17.4517"></a><span id="l17.4517" class="difflineplus">+    }</span>
<a href="#l17.4518"></a><span id="l17.4518" class="difflineplus">+    return this;</span>
<a href="#l17.4519"></a><span id="l17.4519" class="difflineplus">+  };</span>
<a href="#l17.4520"></a><span id="l17.4520" class="difflineplus">+</span>
<a href="#l17.4521"></a><span id="l17.4521" class="difflineplus">+  return scale;</span>
<a href="#l17.4522"></a><span id="l17.4522" class="difflineplus">+};</span>
<a href="#l17.4523"></a><span id="l17.4523" class="difflineplus">+/**</span>
<a href="#l17.4524"></a><span id="l17.4524" class="difflineplus">+ * QuantitativeScale is a base class for representing quantitative numerical data</span>
<a href="#l17.4525"></a><span id="l17.4525" class="difflineplus">+ * scales.</span>
<a href="#l17.4526"></a><span id="l17.4526" class="difflineplus">+ */</span>
<a href="#l17.4527"></a><span id="l17.4527" class="difflineplus">+pv.Scales.QuantitativeScale = function(min, max, base) {</span>
<a href="#l17.4528"></a><span id="l17.4528" class="difflineplus">+  pv.Scales.Scale.call(this);</span>
<a href="#l17.4529"></a><span id="l17.4529" class="difflineplus">+</span>
<a href="#l17.4530"></a><span id="l17.4530" class="difflineplus">+  this._min = min;</span>
<a href="#l17.4531"></a><span id="l17.4531" class="difflineplus">+  this._max = max;</span>
<a href="#l17.4532"></a><span id="l17.4532" class="difflineplus">+  this._base = base==undefined ? pv.Scales.defaultBase : base;</span>
<a href="#l17.4533"></a><span id="l17.4533" class="difflineplus">+};</span>
<a href="#l17.4534"></a><span id="l17.4534" class="difflineplus">+</span>
<a href="#l17.4535"></a><span id="l17.4535" class="difflineplus">+pv.Scales.QuantitativeScale.prototype = pv.extend(pv.Scales.Scale);</span>
<a href="#l17.4536"></a><span id="l17.4536" class="difflineplus">+</span>
<a href="#l17.4537"></a><span id="l17.4537" class="difflineplus">+// Accessor method for min</span>
<a href="#l17.4538"></a><span id="l17.4538" class="difflineplus">+pv.Scales.QuantitativeScale.prototype.min = function(x) {</span>
<a href="#l17.4539"></a><span id="l17.4539" class="difflineplus">+  if (x == undefined) {</span>
<a href="#l17.4540"></a><span id="l17.4540" class="difflineplus">+    return this._min;</span>
<a href="#l17.4541"></a><span id="l17.4541" class="difflineplus">+  } else {</span>
<a href="#l17.4542"></a><span id="l17.4542" class="difflineplus">+    this._min = x;</span>
<a href="#l17.4543"></a><span id="l17.4543" class="difflineplus">+    return this;</span>
<a href="#l17.4544"></a><span id="l17.4544" class="difflineplus">+  }</span>
<a href="#l17.4545"></a><span id="l17.4545" class="difflineplus">+};</span>
<a href="#l17.4546"></a><span id="l17.4546" class="difflineplus">+</span>
<a href="#l17.4547"></a><span id="l17.4547" class="difflineplus">+// Accessor method for max</span>
<a href="#l17.4548"></a><span id="l17.4548" class="difflineplus">+pv.Scales.QuantitativeScale.prototype.max = function(x) {</span>
<a href="#l17.4549"></a><span id="l17.4549" class="difflineplus">+  if (x == undefined) {</span>
<a href="#l17.4550"></a><span id="l17.4550" class="difflineplus">+    return this._max;</span>
<a href="#l17.4551"></a><span id="l17.4551" class="difflineplus">+  } else {</span>
<a href="#l17.4552"></a><span id="l17.4552" class="difflineplus">+    this._max = x;</span>
<a href="#l17.4553"></a><span id="l17.4553" class="difflineplus">+    return this;</span>
<a href="#l17.4554"></a><span id="l17.4554" class="difflineplus">+  }</span>
<a href="#l17.4555"></a><span id="l17.4555" class="difflineplus">+};</span>
<a href="#l17.4556"></a><span id="l17.4556" class="difflineplus">+</span>
<a href="#l17.4557"></a><span id="l17.4557" class="difflineplus">+// Accessor method for base</span>
<a href="#l17.4558"></a><span id="l17.4558" class="difflineplus">+pv.Scales.QuantitativeScale.prototype.base = function(x) {</span>
<a href="#l17.4559"></a><span id="l17.4559" class="difflineplus">+  if (x == undefined) {</span>
<a href="#l17.4560"></a><span id="l17.4560" class="difflineplus">+    return this._base;</span>
<a href="#l17.4561"></a><span id="l17.4561" class="difflineplus">+  } else {</span>
<a href="#l17.4562"></a><span id="l17.4562" class="difflineplus">+    this._base = x;</span>
<a href="#l17.4563"></a><span id="l17.4563" class="difflineplus">+    return this;</span>
<a href="#l17.4564"></a><span id="l17.4564" class="difflineplus">+  }</span>
<a href="#l17.4565"></a><span id="l17.4565" class="difflineplus">+};</span>
<a href="#l17.4566"></a><span id="l17.4566" class="difflineplus">+</span>
<a href="#l17.4567"></a><span id="l17.4567" class="difflineplus">+// Checks if the mapped interval contains x</span>
<a href="#l17.4568"></a><span id="l17.4568" class="difflineplus">+pv.Scales.QuantitativeScale.prototype.contains = function(x) {</span>
<a href="#l17.4569"></a><span id="l17.4569" class="difflineplus">+  return (x &gt;= this._min &amp;&amp; x &lt;= this._max);</span>
<a href="#l17.4570"></a><span id="l17.4570" class="difflineplus">+};</span>
<a href="#l17.4571"></a><span id="l17.4571" class="difflineplus">+</span>
<a href="#l17.4572"></a><span id="l17.4572" class="difflineplus">+// Returns the step for the scale</span>
<a href="#l17.4573"></a><span id="l17.4573" class="difflineplus">+pv.Scales.QuantitativeScale.prototype.step = function(min, max, base) {</span>
<a href="#l17.4574"></a><span id="l17.4574" class="difflineplus">+  if (!base) base = pv.Scales.defaultBase;</span>
<a href="#l17.4575"></a><span id="l17.4575" class="difflineplus">+  var exp = Math.round(Math.log(max-min)/Math.log(base)) - 1;</span>
<a href="#l17.4576"></a><span id="l17.4576" class="difflineplus">+</span>
<a href="#l17.4577"></a><span id="l17.4577" class="difflineplus">+  return Math.pow(base, exp);</span>
<a href="#l17.4578"></a><span id="l17.4578" class="difflineplus">+};</span>
<a href="#l17.4579"></a><span id="l17.4579" class="difflineplus">+pv.Scales.dateTime = function(min, max) {</span>
<a href="#l17.4580"></a><span id="l17.4580" class="difflineplus">+  return new pv.Scales.DateTimeScale(min, max);</span>
<a href="#l17.4581"></a><span id="l17.4581" class="difflineplus">+}</span>
<a href="#l17.4582"></a><span id="l17.4582" class="difflineplus">+</span>
<a href="#l17.4583"></a><span id="l17.4583" class="difflineplus">+/**</span>
<a href="#l17.4584"></a><span id="l17.4584" class="difflineplus">+ * DateTimeScale DateTimeScale scales time data.</span>
<a href="#l17.4585"></a><span id="l17.4585" class="difflineplus">+ */</span>
<a href="#l17.4586"></a><span id="l17.4586" class="difflineplus">+pv.Scales.DateTimeScale = function(min, max) {</span>
<a href="#l17.4587"></a><span id="l17.4587" class="difflineplus">+  pv.Scales.Scale.call(this);</span>
<a href="#l17.4588"></a><span id="l17.4588" class="difflineplus">+</span>
<a href="#l17.4589"></a><span id="l17.4589" class="difflineplus">+  this._min = min;</span>
<a href="#l17.4590"></a><span id="l17.4590" class="difflineplus">+  this._max = max;</span>
<a href="#l17.4591"></a><span id="l17.4591" class="difflineplus">+};</span>
<a href="#l17.4592"></a><span id="l17.4592" class="difflineplus">+</span>
<a href="#l17.4593"></a><span id="l17.4593" class="difflineplus">+pv.Scales.DateTimeScale.prototype = pv.extend(pv.Scales.Scale);</span>
<a href="#l17.4594"></a><span id="l17.4594" class="difflineplus">+</span>
<a href="#l17.4595"></a><span id="l17.4595" class="difflineplus">+// Accessor method for min</span>
<a href="#l17.4596"></a><span id="l17.4596" class="difflineplus">+pv.Scales.DateTimeScale.prototype.min = function(x) {</span>
<a href="#l17.4597"></a><span id="l17.4597" class="difflineplus">+  if (x == undefined) {</span>
<a href="#l17.4598"></a><span id="l17.4598" class="difflineplus">+    return this._min;</span>
<a href="#l17.4599"></a><span id="l17.4599" class="difflineplus">+  } else {</span>
<a href="#l17.4600"></a><span id="l17.4600" class="difflineplus">+    this._min = x;</span>
<a href="#l17.4601"></a><span id="l17.4601" class="difflineplus">+    return this;</span>
<a href="#l17.4602"></a><span id="l17.4602" class="difflineplus">+  }</span>
<a href="#l17.4603"></a><span id="l17.4603" class="difflineplus">+};</span>
<a href="#l17.4604"></a><span id="l17.4604" class="difflineplus">+</span>
<a href="#l17.4605"></a><span id="l17.4605" class="difflineplus">+// Accessor method for max</span>
<a href="#l17.4606"></a><span id="l17.4606" class="difflineplus">+pv.Scales.DateTimeScale.prototype.max = function(x) {</span>
<a href="#l17.4607"></a><span id="l17.4607" class="difflineplus">+  if (x == undefined) {</span>
<a href="#l17.4608"></a><span id="l17.4608" class="difflineplus">+    return this._max;</span>
<a href="#l17.4609"></a><span id="l17.4609" class="difflineplus">+  } else {</span>
<a href="#l17.4610"></a><span id="l17.4610" class="difflineplus">+    this._max = x;</span>
<a href="#l17.4611"></a><span id="l17.4611" class="difflineplus">+    return this;</span>
<a href="#l17.4612"></a><span id="l17.4612" class="difflineplus">+  }</span>
<a href="#l17.4613"></a><span id="l17.4613" class="difflineplus">+};</span>
<a href="#l17.4614"></a><span id="l17.4614" class="difflineplus">+</span>
<a href="#l17.4615"></a><span id="l17.4615" class="difflineplus">+// Normalizes DateTimeScale value</span>
<a href="#l17.4616"></a><span id="l17.4616" class="difflineplus">+pv.Scales.DateTimeScale.prototype.normalize = function(x) {</span>
<a href="#l17.4617"></a><span id="l17.4617" class="difflineplus">+  var eps = pv.Scales.epsilon;</span>
<a href="#l17.4618"></a><span id="l17.4618" class="difflineplus">+  var range = this._max - this._min;</span>
<a href="#l17.4619"></a><span id="l17.4619" class="difflineplus">+</span>
<a href="#l17.4620"></a><span id="l17.4620" class="difflineplus">+  return (range &lt; eps &amp;&amp; range &gt; -eps) ? 0 : (x - this._min) / range;</span>
<a href="#l17.4621"></a><span id="l17.4621" class="difflineplus">+};</span>
<a href="#l17.4622"></a><span id="l17.4622" class="difflineplus">+</span>
<a href="#l17.4623"></a><span id="l17.4623" class="difflineplus">+// Un-normalizes the value</span>
<a href="#l17.4624"></a><span id="l17.4624" class="difflineplus">+pv.Scales.DateTimeScale.prototype.unnormalize = function(n) {</span>
<a href="#l17.4625"></a><span id="l17.4625" class="difflineplus">+  return n * (this._max - this._min) + this._min;</span>
<a href="#l17.4626"></a><span id="l17.4626" class="difflineplus">+};</span>
<a href="#l17.4627"></a><span id="l17.4627" class="difflineplus">+</span>
<a href="#l17.4628"></a><span id="l17.4628" class="difflineplus">+// Checks if the mapped interval contains x</span>
<a href="#l17.4629"></a><span id="l17.4629" class="difflineplus">+pv.Scales.DateTimeScale.prototype.contains = function(x) {</span>
<a href="#l17.4630"></a><span id="l17.4630" class="difflineplus">+  var t = x.valueOf();</span>
<a href="#l17.4631"></a><span id="l17.4631" class="difflineplus">+  return (t &gt;= this._min.valueOf() &amp;&amp; t &lt;= this._max.valueOf());</span>
<a href="#l17.4632"></a><span id="l17.4632" class="difflineplus">+};</span>
<a href="#l17.4633"></a><span id="l17.4633" class="difflineplus">+</span>
<a href="#l17.4634"></a><span id="l17.4634" class="difflineplus">+// Sets min/max values to &quot;nice&quot; values</span>
<a href="#l17.4635"></a><span id="l17.4635" class="difflineplus">+pv.Scales.DateTimeScale.prototype.nice = function() {</span>
<a href="#l17.4636"></a><span id="l17.4636" class="difflineplus">+  var span  = this.span(this._min, this._max);</span>
<a href="#l17.4637"></a><span id="l17.4637" class="difflineplus">+  this._min = this.round(this._min, span, false);</span>
<a href="#l17.4638"></a><span id="l17.4638" class="difflineplus">+  this._max = this.round(this._max, span, true);</span>
<a href="#l17.4639"></a><span id="l17.4639" class="difflineplus">+};</span>
<a href="#l17.4640"></a><span id="l17.4640" class="difflineplus">+</span>
<a href="#l17.4641"></a><span id="l17.4641" class="difflineplus">+/**</span>
<a href="#l17.4642"></a><span id="l17.4642" class="difflineplus">+ * Calculate a list of rule values covering the time range spaced at a</span>
<a href="#l17.4643"></a><span id="l17.4643" class="difflineplus">+ * configurable span.</span>
<a href="#l17.4644"></a><span id="l17.4644" class="difflineplus">+ *</span>
<a href="#l17.4645"></a><span id="l17.4645" class="difflineplus">+ * @param [forceSpan] If you want to force rule-generation from a span other</span>
<a href="#l17.4646"></a><span id="l17.4646" class="difflineplus">+ *     than the default calculated by span, pass the value here.</span>
<a href="#l17.4647"></a><span id="l17.4647" class="difflineplus">+ * @param [beNice] Round the min and max values based on the span in use. If</span>
<a href="#l17.4648"></a><span id="l17.4648" class="difflineplus">+ *     you are passing a value for forceSpan, you may also want to pass true</span>
<a href="#l17.4649"></a><span id="l17.4649" class="difflineplus">+ *     for this argument.</span>
<a href="#l17.4650"></a><span id="l17.4650" class="difflineplus">+ *</span>
<a href="#l17.4651"></a><span id="l17.4651" class="difflineplus">+ * @return a list of rule values</span>
<a href="#l17.4652"></a><span id="l17.4652" class="difflineplus">+ */</span>
<a href="#l17.4653"></a><span id="l17.4653" class="difflineplus">+pv.Scales.DateTimeScale.prototype.ruleValues = function(forceSpan, beNice) {</span>
<a href="#l17.4654"></a><span id="l17.4654" class="difflineplus">+  var min  = this._min.valueOf(), max = this._max.valueOf();</span>
<a href="#l17.4655"></a><span id="l17.4655" class="difflineplus">+  var span = (forceSpan == null) ? this.span(this._min, this._max) : forceSpan;</span>
<a href="#l17.4656"></a><span id="l17.4656" class="difflineplus">+  // We need to boost the step in order to avoid an infinite loop in the first</span>
<a href="#l17.4657"></a><span id="l17.4657" class="difflineplus">+  //  case where we round.  DST can cause a case where just one step is not</span>
<a href="#l17.4658"></a><span id="l17.4658" class="difflineplus">+  //  enough to push round far enough.</span>
<a href="#l17.4659"></a><span id="l17.4659" class="difflineplus">+  var step = Math.floor(this.step(this._min, this._max, span) * 1.5);</span>
<a href="#l17.4660"></a><span id="l17.4660" class="difflineplus">+  var list = [];</span>
<a href="#l17.4661"></a><span id="l17.4661" class="difflineplus">+</span>
<a href="#l17.4662"></a><span id="l17.4662" class="difflineplus">+  var d = this._min;</span>
<a href="#l17.4663"></a><span id="l17.4663" class="difflineplus">+  if (beNice) {</span>
<a href="#l17.4664"></a><span id="l17.4664" class="difflineplus">+    d = this.round(d, span, false);</span>
<a href="#l17.4665"></a><span id="l17.4665" class="difflineplus">+    max = this.round(this._max, span, true).valueOf();</span>
<a href="#l17.4666"></a><span id="l17.4666" class="difflineplus">+  }</span>
<a href="#l17.4667"></a><span id="l17.4667" class="difflineplus">+  if (span &lt; pv.Scales.DateTimeScale.Span.MONTHS) {</span>
<a href="#l17.4668"></a><span id="l17.4668" class="difflineplus">+    while (d.valueOf() &lt;= max) {</span>
<a href="#l17.4669"></a><span id="l17.4669" class="difflineplus">+      list.push(d);</span>
<a href="#l17.4670"></a><span id="l17.4670" class="difflineplus">+      // we need to round to compensate for daylight savings time...</span>
<a href="#l17.4671"></a><span id="l17.4671" class="difflineplus">+      d = this.round(new Date(d.valueOf()+step), span, false);</span>
<a href="#l17.4672"></a><span id="l17.4672" class="difflineplus">+    }</span>
<a href="#l17.4673"></a><span id="l17.4673" class="difflineplus">+  } else if (span == pv.Scales.DateTimeScale.Span.MONTHS) {</span>
<a href="#l17.4674"></a><span id="l17.4674" class="difflineplus">+    // TODO: Handle quarters</span>
<a href="#l17.4675"></a><span id="l17.4675" class="difflineplus">+    step = 1;</span>
<a href="#l17.4676"></a><span id="l17.4676" class="difflineplus">+    while (d.valueOf() &lt;= max) {</span>
<a href="#l17.4677"></a><span id="l17.4677" class="difflineplus">+      list.push(d);</span>
<a href="#l17.4678"></a><span id="l17.4678" class="difflineplus">+      d = new Date(d);</span>
<a href="#l17.4679"></a><span id="l17.4679" class="difflineplus">+      d.setMonth(d.getMonth() + step);</span>
<a href="#l17.4680"></a><span id="l17.4680" class="difflineplus">+    }</span>
<a href="#l17.4681"></a><span id="l17.4681" class="difflineplus">+  } else { // Span.YEARS</span>
<a href="#l17.4682"></a><span id="l17.4682" class="difflineplus">+    step = 1;</span>
<a href="#l17.4683"></a><span id="l17.4683" class="difflineplus">+    while (d.valueOf() &lt;= max) {</span>
<a href="#l17.4684"></a><span id="l17.4684" class="difflineplus">+      list.push(d);</span>
<a href="#l17.4685"></a><span id="l17.4685" class="difflineplus">+      d = new Date(d);</span>
<a href="#l17.4686"></a><span id="l17.4686" class="difflineplus">+      d.setFullYear(d.getFullYear() + step);</span>
<a href="#l17.4687"></a><span id="l17.4687" class="difflineplus">+    }</span>
<a href="#l17.4688"></a><span id="l17.4688" class="difflineplus">+  }</span>
<a href="#l17.4689"></a><span id="l17.4689" class="difflineplus">+</span>
<a href="#l17.4690"></a><span id="l17.4690" class="difflineplus">+  return list;</span>
<a href="#l17.4691"></a><span id="l17.4691" class="difflineplus">+};</span>
<a href="#l17.4692"></a><span id="l17.4692" class="difflineplus">+</span>
<a href="#l17.4693"></a><span id="l17.4693" class="difflineplus">+// Time Span Constants</span>
<a href="#l17.4694"></a><span id="l17.4694" class="difflineplus">+pv.Scales.DateTimeScale.Span = {};</span>
<a href="#l17.4695"></a><span id="l17.4695" class="difflineplus">+pv.Scales.DateTimeScale.Span.YEARS        =  0;</span>
<a href="#l17.4696"></a><span id="l17.4696" class="difflineplus">+pv.Scales.DateTimeScale.Span.MONTHS       = -1;</span>
<a href="#l17.4697"></a><span id="l17.4697" class="difflineplus">+pv.Scales.DateTimeScale.Span.DAYS         = -2;</span>
<a href="#l17.4698"></a><span id="l17.4698" class="difflineplus">+pv.Scales.DateTimeScale.Span.HOURS        = -3;</span>
<a href="#l17.4699"></a><span id="l17.4699" class="difflineplus">+pv.Scales.DateTimeScale.Span.MINUTES      = -4;</span>
<a href="#l17.4700"></a><span id="l17.4700" class="difflineplus">+pv.Scales.DateTimeScale.Span.SECONDS      = -5;</span>
<a href="#l17.4701"></a><span id="l17.4701" class="difflineplus">+pv.Scales.DateTimeScale.Span.MILLISECONDS = -6;</span>
<a href="#l17.4702"></a><span id="l17.4702" class="difflineplus">+pv.Scales.DateTimeScale.Span.WEEKS        = -10;</span>
<a href="#l17.4703"></a><span id="l17.4703" class="difflineplus">+pv.Scales.DateTimeScale.Span.QUARTERS     = -11;</span>
<a href="#l17.4704"></a><span id="l17.4704" class="difflineplus">+</span>
<a href="#l17.4705"></a><span id="l17.4705" class="difflineplus">+// Rounds the date</span>
<a href="#l17.4706"></a><span id="l17.4706" class="difflineplus">+pv.Scales.DateTimeScale.prototype.round = function(t, span, roundUp) {</span>
<a href="#l17.4707"></a><span id="l17.4707" class="difflineplus">+  var Span = pv.Scales.DateTimeScale.Span;</span>
<a href="#l17.4708"></a><span id="l17.4708" class="difflineplus">+  var d = t, bias = roundUp ? 1 : 0;</span>
<a href="#l17.4709"></a><span id="l17.4709" class="difflineplus">+</span>
<a href="#l17.4710"></a><span id="l17.4710" class="difflineplus">+  if (span &gt;= Span.YEARS) {</span>
<a href="#l17.4711"></a><span id="l17.4711" class="difflineplus">+    d = new Date(t.getFullYear() + bias, 0);</span>
<a href="#l17.4712"></a><span id="l17.4712" class="difflineplus">+  } else if (span == Span.MONTHS) {</span>
<a href="#l17.4713"></a><span id="l17.4713" class="difflineplus">+    d = new Date(t.getFullYear(), t.getMonth() + bias);</span>
<a href="#l17.4714"></a><span id="l17.4714" class="difflineplus">+  } else if (span == Span.DAYS) {</span>
<a href="#l17.4715"></a><span id="l17.4715" class="difflineplus">+    d = new Date(t.getFullYear(), t.getMonth(), t.getDate() + bias);</span>
<a href="#l17.4716"></a><span id="l17.4716" class="difflineplus">+  } else if (span == Span.HOURS) {</span>
<a href="#l17.4717"></a><span id="l17.4717" class="difflineplus">+    d = new Date(t.getFullYear(), t.getMonth(), t.getDate(), t.getHours() + bias);</span>
<a href="#l17.4718"></a><span id="l17.4718" class="difflineplus">+  } else if (span == Span.MINUTES) {</span>
<a href="#l17.4719"></a><span id="l17.4719" class="difflineplus">+    d = new Date(t.getFullYear(), t.getMonth(), t.getDate(), t.getHours(), t.getMinutes() + bias);</span>
<a href="#l17.4720"></a><span id="l17.4720" class="difflineplus">+  } else if (span == Span.SECONDS) {</span>
<a href="#l17.4721"></a><span id="l17.4721" class="difflineplus">+    d = new Date(t.getFullYear(), t.getMonth(), t.getDate(), t.getHours(), t.getMinutes(), t.getSeconds() + bias);</span>
<a href="#l17.4722"></a><span id="l17.4722" class="difflineplus">+  } else if (span == Span.MILLISECONDS) {</span>
<a href="#l17.4723"></a><span id="l17.4723" class="difflineplus">+    d = new Date(d.time + (roundUp ? 1 : -1));</span>
<a href="#l17.4724"></a><span id="l17.4724" class="difflineplus">+  } else if (span == Span.WEEKS) {</span>
<a href="#l17.4725"></a><span id="l17.4725" class="difflineplus">+    bias = roundUp ? 7 - d.getDay() : -d.getDay();</span>
<a href="#l17.4726"></a><span id="l17.4726" class="difflineplus">+    d = new Date(t.getFullYear(), t.getMonth(), t.getDate() + bias);</span>
<a href="#l17.4727"></a><span id="l17.4727" class="difflineplus">+  }</span>
<a href="#l17.4728"></a><span id="l17.4728" class="difflineplus">+  return d;</span>
<a href="#l17.4729"></a><span id="l17.4729" class="difflineplus">+};</span>
<a href="#l17.4730"></a><span id="l17.4730" class="difflineplus">+</span>
<a href="#l17.4731"></a><span id="l17.4731" class="difflineplus">+// Returns the span of the given min/max values</span>
<a href="#l17.4732"></a><span id="l17.4732" class="difflineplus">+pv.Scales.DateTimeScale.prototype.span = function(min, max) {</span>
<a href="#l17.4733"></a><span id="l17.4733" class="difflineplus">+  var MS_MIN = 60*1000, MS_HOUR = 60*MS_MIN, MS_DAY = 24*MS_HOUR, MS_WEEK = 7*MS_DAY;</span>
<a href="#l17.4734"></a><span id="l17.4734" class="difflineplus">+  var Span = pv.Scales.DateTimeScale.Span;</span>
<a href="#l17.4735"></a><span id="l17.4735" class="difflineplus">+  var span = max.valueOf() - min.valueOf();</span>
<a href="#l17.4736"></a><span id="l17.4736" class="difflineplus">+  var days = span / MS_DAY;</span>
<a href="#l17.4737"></a><span id="l17.4737" class="difflineplus">+</span>
<a href="#l17.4738"></a><span id="l17.4738" class="difflineplus">+  // TODO: handle Weeks/Quarters</span>
<a href="#l17.4739"></a><span id="l17.4739" class="difflineplus">+  if (days &gt;= 365*2) return (1 + max.getFullYear()-min.getFullYear());</span>
<a href="#l17.4740"></a><span id="l17.4740" class="difflineplus">+  else if (days &gt;= 60) return Span.MONTHS;</span>
<a href="#l17.4741"></a><span id="l17.4741" class="difflineplus">+  else if (span/MS_WEEK &gt; 1) return Span.WEEKS;</span>
<a href="#l17.4742"></a><span id="l17.4742" class="difflineplus">+  else if (span/MS_DAY &gt; 1) return Span.DAYS;</span>
<a href="#l17.4743"></a><span id="l17.4743" class="difflineplus">+  else if (span/MS_HOUR &gt; 1) return Span.HOURS;</span>
<a href="#l17.4744"></a><span id="l17.4744" class="difflineplus">+  else if (span/MS_MIN &gt; 1) return Span.MINUTES;</span>
<a href="#l17.4745"></a><span id="l17.4745" class="difflineplus">+  else if (span/1000.0 &gt; 1) return Span.SECONDS;</span>
<a href="#l17.4746"></a><span id="l17.4746" class="difflineplus">+  else return Span.MILLISECONDS;</span>
<a href="#l17.4747"></a><span id="l17.4747" class="difflineplus">+}</span>
<a href="#l17.4748"></a><span id="l17.4748" class="difflineplus">+</span>
<a href="#l17.4749"></a><span id="l17.4749" class="difflineplus">+// Returns the step for the scale</span>
<a href="#l17.4750"></a><span id="l17.4750" class="difflineplus">+pv.Scales.DateTimeScale.prototype.step = function(min, max, span) {</span>
<a href="#l17.4751"></a><span id="l17.4751" class="difflineplus">+  var Span = pv.Scales.DateTimeScale.Span;</span>
<a href="#l17.4752"></a><span id="l17.4752" class="difflineplus">+</span>
<a href="#l17.4753"></a><span id="l17.4753" class="difflineplus">+  if (span &gt; Span.YEARS) {</span>
<a href="#l17.4754"></a><span id="l17.4754" class="difflineplus">+    var exp = Math.round(Math.log(Math.max(1,span-1)/Math.log(10))) - 1;</span>
<a href="#l17.4755"></a><span id="l17.4755" class="difflineplus">+    return Math.pow(10, exp);</span>
<a href="#l17.4756"></a><span id="l17.4756" class="difflineplus">+  } else if (span == Span.MONTHS) {</span>
<a href="#l17.4757"></a><span id="l17.4757" class="difflineplus">+    return 0;</span>
<a href="#l17.4758"></a><span id="l17.4758" class="difflineplus">+  } else if (span == Span.WEEKS) {</span>
<a href="#l17.4759"></a><span id="l17.4759" class="difflineplus">+    return 7*24*60*60*1000;</span>
<a href="#l17.4760"></a><span id="l17.4760" class="difflineplus">+  } else if (span == Span.DAYS) {</span>
<a href="#l17.4761"></a><span id="l17.4761" class="difflineplus">+    return 24*60*60*1000;</span>
<a href="#l17.4762"></a><span id="l17.4762" class="difflineplus">+  } else if (span == Span.HOURS) {</span>
<a href="#l17.4763"></a><span id="l17.4763" class="difflineplus">+    return 60*60*1000;</span>
<a href="#l17.4764"></a><span id="l17.4764" class="difflineplus">+  } else if (span == Span.MINUTES) {</span>
<a href="#l17.4765"></a><span id="l17.4765" class="difflineplus">+    return 60*1000;</span>
<a href="#l17.4766"></a><span id="l17.4766" class="difflineplus">+  } else if (span == Span.SECONDS) {</span>
<a href="#l17.4767"></a><span id="l17.4767" class="difflineplus">+    return 1000;</span>
<a href="#l17.4768"></a><span id="l17.4768" class="difflineplus">+  } else {</span>
<a href="#l17.4769"></a><span id="l17.4769" class="difflineplus">+    return 1;</span>
<a href="#l17.4770"></a><span id="l17.4770" class="difflineplus">+  }</span>
<a href="#l17.4771"></a><span id="l17.4771" class="difflineplus">+};</span>
<a href="#l17.4772"></a><span id="l17.4772" class="difflineplus">+pv.Scales.linear = function(min, max, base) {</span>
<a href="#l17.4773"></a><span id="l17.4773" class="difflineplus">+  return new pv.Scales.LinearScale(min, max, base);</span>
<a href="#l17.4774"></a><span id="l17.4774" class="difflineplus">+};</span>
<a href="#l17.4775"></a><span id="l17.4775" class="difflineplus">+</span>
<a href="#l17.4776"></a><span id="l17.4776" class="difflineplus">+pv.Scales.linear.fromData = function(data, f, base) {</span>
<a href="#l17.4777"></a><span id="l17.4777" class="difflineplus">+  return new pv.Scales.LinearScale(pv.min(data, f), pv.max(data, f), base);</span>
<a href="#l17.4778"></a><span id="l17.4778" class="difflineplus">+}</span>
<a href="#l17.4779"></a><span id="l17.4779" class="difflineplus">+</span>
<a href="#l17.4780"></a><span id="l17.4780" class="difflineplus">+/**</span>
<a href="#l17.4781"></a><span id="l17.4781" class="difflineplus">+ * LinearScale is a QuantativeScale that spaces values linearly along the scale</span>
<a href="#l17.4782"></a><span id="l17.4782" class="difflineplus">+ * range. This is the default scale for numeric types.</span>
<a href="#l17.4783"></a><span id="l17.4783" class="difflineplus">+ */</span>
<a href="#l17.4784"></a><span id="l17.4784" class="difflineplus">+pv.Scales.LinearScale = function(min, max, base) {</span>
<a href="#l17.4785"></a><span id="l17.4785" class="difflineplus">+  pv.Scales.QuantitativeScale.call(this, min, max, base);</span>
<a href="#l17.4786"></a><span id="l17.4786" class="difflineplus">+};</span>
<a href="#l17.4787"></a><span id="l17.4787" class="difflineplus">+</span>
<a href="#l17.4788"></a><span id="l17.4788" class="difflineplus">+pv.Scales.LinearScale.prototype = pv.extend(pv.Scales.QuantitativeScale);</span>
<a href="#l17.4789"></a><span id="l17.4789" class="difflineplus">+</span>
<a href="#l17.4790"></a><span id="l17.4790" class="difflineplus">+// Normalizes the value</span>
<a href="#l17.4791"></a><span id="l17.4791" class="difflineplus">+pv.Scales.LinearScale.prototype.normalize = function(x) {</span>
<a href="#l17.4792"></a><span id="l17.4792" class="difflineplus">+  var eps = pv.Scales.epsilon;</span>
<a href="#l17.4793"></a><span id="l17.4793" class="difflineplus">+  var range = this._max - this._min;</span>
<a href="#l17.4794"></a><span id="l17.4794" class="difflineplus">+</span>
<a href="#l17.4795"></a><span id="l17.4795" class="difflineplus">+  return (range &lt; eps &amp;&amp; range &gt; -eps) ? 0 : (x - this._min) / range;</span>
<a href="#l17.4796"></a><span id="l17.4796" class="difflineplus">+};</span>
<a href="#l17.4797"></a><span id="l17.4797" class="difflineplus">+</span>
<a href="#l17.4798"></a><span id="l17.4798" class="difflineplus">+// Un-normalizes the value</span>
<a href="#l17.4799"></a><span id="l17.4799" class="difflineplus">+pv.Scales.LinearScale.prototype.unnormalize = function(n) {</span>
<a href="#l17.4800"></a><span id="l17.4800" class="difflineplus">+  return n * (this._max - this._min) + this._min;</span>
<a href="#l17.4801"></a><span id="l17.4801" class="difflineplus">+};</span>
<a href="#l17.4802"></a><span id="l17.4802" class="difflineplus">+</span>
<a href="#l17.4803"></a><span id="l17.4803" class="difflineplus">+// Sets min/max values to &quot;nice numbers&quot;</span>
<a href="#l17.4804"></a><span id="l17.4804" class="difflineplus">+pv.Scales.LinearScale.prototype.nice = function() {</span>
<a href="#l17.4805"></a><span id="l17.4805" class="difflineplus">+  var step = this.step(this._min, this._max, this._base);</span>
<a href="#l17.4806"></a><span id="l17.4806" class="difflineplus">+</span>
<a href="#l17.4807"></a><span id="l17.4807" class="difflineplus">+  this._min = Math.floor(this._min / step) * step;</span>
<a href="#l17.4808"></a><span id="l17.4808" class="difflineplus">+  this._max = Math.ceil(this._max / step) * step;</span>
<a href="#l17.4809"></a><span id="l17.4809" class="difflineplus">+</span>
<a href="#l17.4810"></a><span id="l17.4810" class="difflineplus">+  return this;</span>
<a href="#l17.4811"></a><span id="l17.4811" class="difflineplus">+};</span>
<a href="#l17.4812"></a><span id="l17.4812" class="difflineplus">+</span>
<a href="#l17.4813"></a><span id="l17.4813" class="difflineplus">+// Returns a list of rule values</span>
<a href="#l17.4814"></a><span id="l17.4814" class="difflineplus">+pv.Scales.LinearScale.prototype.ruleValues = function() {</span>
<a href="#l17.4815"></a><span id="l17.4815" class="difflineplus">+  var step = this.step(this._min, this._max, this._base);</span>
<a href="#l17.4816"></a><span id="l17.4816" class="difflineplus">+</span>
<a href="#l17.4817"></a><span id="l17.4817" class="difflineplus">+  var start = Math.floor(this._min / step) * step;</span>
<a href="#l17.4818"></a><span id="l17.4818" class="difflineplus">+  var end = Math.ceil(this._max / step) * step;</span>
<a href="#l17.4819"></a><span id="l17.4819" class="difflineplus">+</span>
<a href="#l17.4820"></a><span id="l17.4820" class="difflineplus">+  var list = pv.range(start, end+step, step);</span>
<a href="#l17.4821"></a><span id="l17.4821" class="difflineplus">+</span>
<a href="#l17.4822"></a><span id="l17.4822" class="difflineplus">+  // Remove precision problems</span>
<a href="#l17.4823"></a><span id="l17.4823" class="difflineplus">+  // TODO move to tick rendering, not scales</span>
<a href="#l17.4824"></a><span id="l17.4824" class="difflineplus">+  if (step &lt; 1) {</span>
<a href="#l17.4825"></a><span id="l17.4825" class="difflineplus">+    var exp = Math.round(Math.log(step)/Math.log(this._base));</span>
<a href="#l17.4826"></a><span id="l17.4826" class="difflineplus">+</span>
<a href="#l17.4827"></a><span id="l17.4827" class="difflineplus">+    for (var i = 0; i &lt; list.length; i++) {</span>
<a href="#l17.4828"></a><span id="l17.4828" class="difflineplus">+      list[i] = list[i].toFixed(-exp);</span>
<a href="#l17.4829"></a><span id="l17.4829" class="difflineplus">+    }</span>
<a href="#l17.4830"></a><span id="l17.4830" class="difflineplus">+  }</span>
<a href="#l17.4831"></a><span id="l17.4831" class="difflineplus">+</span>
<a href="#l17.4832"></a><span id="l17.4832" class="difflineplus">+  // check end points</span>
<a href="#l17.4833"></a><span id="l17.4833" class="difflineplus">+  if (list[0] &lt; this._min) list.splice(0, 1);</span>
<a href="#l17.4834"></a><span id="l17.4834" class="difflineplus">+  if (list[list.length-1] &gt; this._max) list.splice(list.length-1, 1);</span>
<a href="#l17.4835"></a><span id="l17.4835" class="difflineplus">+</span>
<a href="#l17.4836"></a><span id="l17.4836" class="difflineplus">+  return list;</span>
<a href="#l17.4837"></a><span id="l17.4837" class="difflineplus">+};</span>
<a href="#l17.4838"></a><span id="l17.4838" class="difflineplus">+pv.Scales.log = function(min, max, base) {</span>
<a href="#l17.4839"></a><span id="l17.4839" class="difflineplus">+  return new pv.Scales.LogScale(min, max, base);</span>
<a href="#l17.4840"></a><span id="l17.4840" class="difflineplus">+};</span>
<a href="#l17.4841"></a><span id="l17.4841" class="difflineplus">+</span>
<a href="#l17.4842"></a><span id="l17.4842" class="difflineplus">+pv.Scales.log.fromData = function(data, f, base) {</span>
<a href="#l17.4843"></a><span id="l17.4843" class="difflineplus">+  return new pv.Scales.LogScale(pv.min(data, f), pv.max(data, f), base);</span>
<a href="#l17.4844"></a><span id="l17.4844" class="difflineplus">+}</span>
<a href="#l17.4845"></a><span id="l17.4845" class="difflineplus">+</span>
<a href="#l17.4846"></a><span id="l17.4846" class="difflineplus">+/*</span>
<a href="#l17.4847"></a><span id="l17.4847" class="difflineplus">+ * LogScale is a QuantativeScale that performs a log transformation of the</span>
<a href="#l17.4848"></a><span id="l17.4848" class="difflineplus">+ * data. The base of the logarithm is determined by the base property.</span>
<a href="#l17.4849"></a><span id="l17.4849" class="difflineplus">+ */</span>
<a href="#l17.4850"></a><span id="l17.4850" class="difflineplus">+pv.Scales.LogScale = function(min, max, base) {</span>
<a href="#l17.4851"></a><span id="l17.4851" class="difflineplus">+  pv.Scales.QuantitativeScale.call(this, min, max, base);</span>
<a href="#l17.4852"></a><span id="l17.4852" class="difflineplus">+</span>
<a href="#l17.4853"></a><span id="l17.4853" class="difflineplus">+  this.update();</span>
<a href="#l17.4854"></a><span id="l17.4854" class="difflineplus">+};</span>
<a href="#l17.4855"></a><span id="l17.4855" class="difflineplus">+</span>
<a href="#l17.4856"></a><span id="l17.4856" class="difflineplus">+// Zero-symmetric log function</span>
<a href="#l17.4857"></a><span id="l17.4857" class="difflineplus">+pv.Scales.LogScale.log = function(x, b) {</span>
<a href="#l17.4858"></a><span id="l17.4858" class="difflineplus">+  return x==0 ? 0 : x&gt;0 ? Math.log(x)/Math.log(b) : -Math.log(-x)/Math.log(b);</span>
<a href="#l17.4859"></a><span id="l17.4859" class="difflineplus">+};</span>
<a href="#l17.4860"></a><span id="l17.4860" class="difflineplus">+</span>
<a href="#l17.4861"></a><span id="l17.4861" class="difflineplus">+// Adjusted zero-symmetric log function</span>
<a href="#l17.4862"></a><span id="l17.4862" class="difflineplus">+pv.Scales.LogScale.zlog = function(x, b) {</span>
<a href="#l17.4863"></a><span id="l17.4863" class="difflineplus">+  var s = (x &lt; 0) ? -1 : 1;</span>
<a href="#l17.4864"></a><span id="l17.4864" class="difflineplus">+  x = s*x;</span>
<a href="#l17.4865"></a><span id="l17.4865" class="difflineplus">+  if (x &lt; b) x += (b-x)/b;</span>
<a href="#l17.4866"></a><span id="l17.4866" class="difflineplus">+  return s * Math.log(x) / Math.log(b);</span>
<a href="#l17.4867"></a><span id="l17.4867" class="difflineplus">+};</span>
<a href="#l17.4868"></a><span id="l17.4868" class="difflineplus">+</span>
<a href="#l17.4869"></a><span id="l17.4869" class="difflineplus">+pv.Scales.LogScale.prototype = pv.extend(pv.Scales.QuantitativeScale);</span>
<a href="#l17.4870"></a><span id="l17.4870" class="difflineplus">+</span>
<a href="#l17.4871"></a><span id="l17.4871" class="difflineplus">+// Accessor method for min</span>
<a href="#l17.4872"></a><span id="l17.4872" class="difflineplus">+pv.Scales.LogScale.prototype.min = function(x) {</span>
<a href="#l17.4873"></a><span id="l17.4873" class="difflineplus">+  var value = pv.Scales.QuantitativeScale.prototype.min.call(this, x);</span>
<a href="#l17.4874"></a><span id="l17.4874" class="difflineplus">+</span>
<a href="#l17.4875"></a><span id="l17.4875" class="difflineplus">+  if (x != undefined) this.update();</span>
<a href="#l17.4876"></a><span id="l17.4876" class="difflineplus">+  return value;</span>
<a href="#l17.4877"></a><span id="l17.4877" class="difflineplus">+};</span>
<a href="#l17.4878"></a><span id="l17.4878" class="difflineplus">+</span>
<a href="#l17.4879"></a><span id="l17.4879" class="difflineplus">+// Accessor method for max</span>
<a href="#l17.4880"></a><span id="l17.4880" class="difflineplus">+pv.Scales.LogScale.prototype.max = function(x) {</span>
<a href="#l17.4881"></a><span id="l17.4881" class="difflineplus">+  var value = pv.Scales.QuantitativeScale.prototype.max.call(this, x);</span>
<a href="#l17.4882"></a><span id="l17.4882" class="difflineplus">+</span>
<a href="#l17.4883"></a><span id="l17.4883" class="difflineplus">+  if (x != undefined) this.update();</span>
<a href="#l17.4884"></a><span id="l17.4884" class="difflineplus">+  return value;</span>
<a href="#l17.4885"></a><span id="l17.4885" class="difflineplus">+};</span>
<a href="#l17.4886"></a><span id="l17.4886" class="difflineplus">+</span>
<a href="#l17.4887"></a><span id="l17.4887" class="difflineplus">+// Accessor method for base</span>
<a href="#l17.4888"></a><span id="l17.4888" class="difflineplus">+pv.Scales.LogScale.prototype.base = function(x) {</span>
<a href="#l17.4889"></a><span id="l17.4889" class="difflineplus">+  var value = pv.Scales.QuantitativeScale.prototype.base.call(this, x);</span>
<a href="#l17.4890"></a><span id="l17.4890" class="difflineplus">+</span>
<a href="#l17.4891"></a><span id="l17.4891" class="difflineplus">+  if (x != undefined) this.update();</span>
<a href="#l17.4892"></a><span id="l17.4892" class="difflineplus">+  return value;</span>
<a href="#l17.4893"></a><span id="l17.4893" class="difflineplus">+};</span>
<a href="#l17.4894"></a><span id="l17.4894" class="difflineplus">+</span>
<a href="#l17.4895"></a><span id="l17.4895" class="difflineplus">+// Normalizes the value</span>
<a href="#l17.4896"></a><span id="l17.4896" class="difflineplus">+pv.Scales.LogScale.prototype.normalize = function(x) {</span>
<a href="#l17.4897"></a><span id="l17.4897" class="difflineplus">+  var eps = pv.Scales.epsilon;</span>
<a href="#l17.4898"></a><span id="l17.4898" class="difflineplus">+  var range = this._lmax - this._lmin;</span>
<a href="#l17.4899"></a><span id="l17.4899" class="difflineplus">+</span>
<a href="#l17.4900"></a><span id="l17.4900" class="difflineplus">+  return (range &lt; eps &amp;&amp; range &gt; -eps) ? 0 : (this._log(x, this._base) - this._lmin) / range;</span>
<a href="#l17.4901"></a><span id="l17.4901" class="difflineplus">+};</span>
<a href="#l17.4902"></a><span id="l17.4902" class="difflineplus">+</span>
<a href="#l17.4903"></a><span id="l17.4903" class="difflineplus">+// Un-normalizes the value</span>
<a href="#l17.4904"></a><span id="l17.4904" class="difflineplus">+pv.Scales.LogScale.prototype.unnormalize = function(n) {</span>
<a href="#l17.4905"></a><span id="l17.4905" class="difflineplus">+  // TODO: handle case where _log = zlog</span>
<a href="#l17.4906"></a><span id="l17.4906" class="difflineplus">+  return Math.pow(this._base, n * (this._lmax - this._lmin) + this._lmin);</span>
<a href="#l17.4907"></a><span id="l17.4907" class="difflineplus">+};</span>
<a href="#l17.4908"></a><span id="l17.4908" class="difflineplus">+</span>
<a href="#l17.4909"></a><span id="l17.4909" class="difflineplus">+/**</span>
<a href="#l17.4910"></a><span id="l17.4910" class="difflineplus">+ * Sets min/max values to &quot;nice numbers&quot; For LogScale, we compute &quot;nice&quot; min/max</span>
<a href="#l17.4911"></a><span id="l17.4911" class="difflineplus">+ * values for the log scale(_lmin, _lmax) first, then calculate the data min/max</span>
<a href="#l17.4912"></a><span id="l17.4912" class="difflineplus">+ * values from the log min/max values.</span>
<a href="#l17.4913"></a><span id="l17.4913" class="difflineplus">+ */</span>
<a href="#l17.4914"></a><span id="l17.4914" class="difflineplus">+pv.Scales.LogScale.prototype.nice = function() {</span>
<a href="#l17.4915"></a><span id="l17.4915" class="difflineplus">+  var step = 1; //this.step(this._lmin, this._lmax);</span>
<a href="#l17.4916"></a><span id="l17.4916" class="difflineplus">+</span>
<a href="#l17.4917"></a><span id="l17.4917" class="difflineplus">+  this._lmin = Math.floor(this._lmin / step) * step;</span>
<a href="#l17.4918"></a><span id="l17.4918" class="difflineplus">+  this._lmax = Math.ceil(this._lmax / step) * step;</span>
<a href="#l17.4919"></a><span id="l17.4919" class="difflineplus">+</span>
<a href="#l17.4920"></a><span id="l17.4920" class="difflineplus">+  // TODO: handle case where _log = zlog</span>
<a href="#l17.4921"></a><span id="l17.4921" class="difflineplus">+  this._min = Math.pow(this._base, this._lmin);</span>
<a href="#l17.4922"></a><span id="l17.4922" class="difflineplus">+  this._max = Math.pow(this._base, this._lmax);</span>
<a href="#l17.4923"></a><span id="l17.4923" class="difflineplus">+</span>
<a href="#l17.4924"></a><span id="l17.4924" class="difflineplus">+  return this;</span>
<a href="#l17.4925"></a><span id="l17.4925" class="difflineplus">+};</span>
<a href="#l17.4926"></a><span id="l17.4926" class="difflineplus">+</span>
<a href="#l17.4927"></a><span id="l17.4927" class="difflineplus">+// Returns a list of rule values</span>
<a href="#l17.4928"></a><span id="l17.4928" class="difflineplus">+pv.Scales.LogScale.prototype.ruleValues = function() {</span>
<a href="#l17.4929"></a><span id="l17.4929" class="difflineplus">+  var step = this.step(this._lmin, this._lmax);</span>
<a href="#l17.4930"></a><span id="l17.4930" class="difflineplus">+  if (step &lt; 1) step = 1; // bound to 1</span>
<a href="#l17.4931"></a><span id="l17.4931" class="difflineplus">+</span>
<a href="#l17.4932"></a><span id="l17.4932" class="difflineplus">+  var start = Math.floor(this._lmin);</span>
<a href="#l17.4933"></a><span id="l17.4933" class="difflineplus">+  var end = Math.ceil(this._lmax);</span>
<a href="#l17.4934"></a><span id="l17.4934" class="difflineplus">+</span>
<a href="#l17.4935"></a><span id="l17.4935" class="difflineplus">+  var list =[];</span>
<a href="#l17.4936"></a><span id="l17.4936" class="difflineplus">+  var i, j, b;</span>
<a href="#l17.4937"></a><span id="l17.4937" class="difflineplus">+  for (i = start; i &lt; end; i++) { // for each step</span>
<a href="#l17.4938"></a><span id="l17.4938" class="difflineplus">+    // add each rule value</span>
<a href="#l17.4939"></a><span id="l17.4939" class="difflineplus">+    // TODO: handle case where _log = zlog</span>
<a href="#l17.4940"></a><span id="l17.4940" class="difflineplus">+    b = Math.pow(this._base, i);</span>
<a href="#l17.4941"></a><span id="l17.4941" class="difflineplus">+    for (j = 1; j &lt; this._base; j++) {</span>
<a href="#l17.4942"></a><span id="l17.4942" class="difflineplus">+      if (i &gt;= 0) list.push(b*j);</span>
<a href="#l17.4943"></a><span id="l17.4943" class="difflineplus">+      else list.push((b*j).toFixed(-i));</span>
<a href="#l17.4944"></a><span id="l17.4944" class="difflineplus">+    }</span>
<a href="#l17.4945"></a><span id="l17.4945" class="difflineplus">+  }</span>
<a href="#l17.4946"></a><span id="l17.4946" class="difflineplus">+  list.push(b*this._base); // add max value</span>
<a href="#l17.4947"></a><span id="l17.4947" class="difflineplus">+</span>
<a href="#l17.4948"></a><span id="l17.4948" class="difflineplus">+  // check end points</span>
<a href="#l17.4949"></a><span id="l17.4949" class="difflineplus">+  if (list[0] &lt; this._min) list.splice(0, 1);</span>
<a href="#l17.4950"></a><span id="l17.4950" class="difflineplus">+  if (list[list.length-1] &gt; this._max) list.splice(list.length-1, 1);</span>
<a href="#l17.4951"></a><span id="l17.4951" class="difflineplus">+</span>
<a href="#l17.4952"></a><span id="l17.4952" class="difflineplus">+  return list;</span>
<a href="#l17.4953"></a><span id="l17.4953" class="difflineplus">+};</span>
<a href="#l17.4954"></a><span id="l17.4954" class="difflineplus">+</span>
<a href="#l17.4955"></a><span id="l17.4955" class="difflineplus">+// Update log scale values</span>
<a href="#l17.4956"></a><span id="l17.4956" class="difflineplus">+pv.Scales.LogScale.prototype.update = function() {</span>
<a href="#l17.4957"></a><span id="l17.4957" class="difflineplus">+  this._log = (this._min &lt; 0 &amp;&amp; this._max &gt; 0) ? pv.Scales.LogScale.zlog : pv.Scales.LogScale.log;</span>
<a href="#l17.4958"></a><span id="l17.4958" class="difflineplus">+  this._lmin = this._log(this._min, this._base);</span>
<a href="#l17.4959"></a><span id="l17.4959" class="difflineplus">+  this._lmax = this._log(this._max, this._base);</span>
<a href="#l17.4960"></a><span id="l17.4960" class="difflineplus">+};</span>
<a href="#l17.4961"></a><span id="l17.4961" class="difflineplus">+/**</span>
<a href="#l17.4962"></a><span id="l17.4962" class="difflineplus">+ * Returns a {@link pv.Nest} operator for the specified array. This is a</span>
<a href="#l17.4963"></a><span id="l17.4963" class="difflineplus">+ * convenience factory method, equivalent to &lt;tt&gt;new pv.Nest(array)&lt;/tt&gt;.</span>
<a href="#l17.4964"></a><span id="l17.4964" class="difflineplus">+ *</span>
<a href="#l17.4965"></a><span id="l17.4965" class="difflineplus">+ * @see pv.Nest</span>
<a href="#l17.4966"></a><span id="l17.4966" class="difflineplus">+ * @param {array} array an array of elements to nest.</span>
<a href="#l17.4967"></a><span id="l17.4967" class="difflineplus">+ * @returns {pv.Nest} a nest operator for the specified array.</span>
<a href="#l17.4968"></a><span id="l17.4968" class="difflineplus">+ */</span>
<a href="#l17.4969"></a><span id="l17.4969" class="difflineplus">+pv.nest = function(array) {</span>
<a href="#l17.4970"></a><span id="l17.4970" class="difflineplus">+  return new pv.Nest(array);</span>
<a href="#l17.4971"></a><span id="l17.4971" class="difflineplus">+};</span>
<a href="#l17.4972"></a><span id="l17.4972" class="difflineplus">+</span>
<a href="#l17.4973"></a><span id="l17.4973" class="difflineplus">+/**</span>
<a href="#l17.4974"></a><span id="l17.4974" class="difflineplus">+ * Constructs a nest operator for the specified array.</span>
<a href="#l17.4975"></a><span id="l17.4975" class="difflineplus">+ *</span>
<a href="#l17.4976"></a><span id="l17.4976" class="difflineplus">+ * @class Represents a {@link Nest} operator for the specified array. Nesting</span>
<a href="#l17.4977"></a><span id="l17.4977" class="difflineplus">+ * allows elements in an array to be grouped into a hierarchical tree</span>
<a href="#l17.4978"></a><span id="l17.4978" class="difflineplus">+ * structure. The levels in the tree are specified by &lt;i&gt;key&lt;/i&gt; functions. The</span>
<a href="#l17.4979"></a><span id="l17.4979" class="difflineplus">+ * leaf nodes of the tree can be sorted by value, while the internal nodes can</span>
<a href="#l17.4980"></a><span id="l17.4980" class="difflineplus">+ * be sorted by key. Finally, the tree can be returned either has a</span>
<a href="#l17.4981"></a><span id="l17.4981" class="difflineplus">+ * multidimensional array via {@link #entries}, or as a hierarchical map via</span>
<a href="#l17.4982"></a><span id="l17.4982" class="difflineplus">+ * {@link #map}. The {@link #rollup} routine similarly returns a map, collapsing</span>
<a href="#l17.4983"></a><span id="l17.4983" class="difflineplus">+ * the elements in each leaf node using a summary function.</span>
<a href="#l17.4984"></a><span id="l17.4984" class="difflineplus">+ *</span>
<a href="#l17.4985"></a><span id="l17.4985" class="difflineplus">+ * &lt;p&gt;For example, consider the following tabular data structure of Barley</span>
<a href="#l17.4986"></a><span id="l17.4986" class="difflineplus">+ * yields, from various sites in Minnesota during 1931-2:</span>
<a href="#l17.4987"></a><span id="l17.4987" class="difflineplus">+ *</span>
<a href="#l17.4988"></a><span id="l17.4988" class="difflineplus">+ * &lt;pre&gt;{ yield: 27.00, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;University Farm&quot; },</span>
<a href="#l17.4989"></a><span id="l17.4989" class="difflineplus">+ * { yield: 48.87, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Waseca&quot; },</span>
<a href="#l17.4990"></a><span id="l17.4990" class="difflineplus">+ * { yield: 27.43, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Morris&quot; }, ...&lt;/pre&gt;</span>
<a href="#l17.4991"></a><span id="l17.4991" class="difflineplus">+ *</span>
<a href="#l17.4992"></a><span id="l17.4992" class="difflineplus">+ * To facilitate visualization, it may be useful to nest the elements first by</span>
<a href="#l17.4993"></a><span id="l17.4993" class="difflineplus">+ * year, and then by variety, as follows:</span>
<a href="#l17.4994"></a><span id="l17.4994" class="difflineplus">+ *</span>
<a href="#l17.4995"></a><span id="l17.4995" class="difflineplus">+ * &lt;pre&gt;var nest = pv.nest(yields)</span>
<a href="#l17.4996"></a><span id="l17.4996" class="difflineplus">+ *     .key(function(d) d.year)</span>
<a href="#l17.4997"></a><span id="l17.4997" class="difflineplus">+ *     .key(function(d) d.variety)</span>
<a href="#l17.4998"></a><span id="l17.4998" class="difflineplus">+ *     .entries();&lt;/pre&gt;</span>
<a href="#l17.4999"></a><span id="l17.4999" class="difflineplus">+ *</span>
<a href="#l17.5000"></a><span id="l17.5000" class="difflineplus">+ * This returns a nested array. Each element of the outer array is a key-values</span>
<a href="#l17.5001"></a><span id="l17.5001" class="difflineplus">+ * pair, listing the values for each distinct key:</span>
<a href="#l17.5002"></a><span id="l17.5002" class="difflineplus">+ *</span>
<a href="#l17.5003"></a><span id="l17.5003" class="difflineplus">+ * &lt;pre&gt;{ key: 1931, values: [</span>
<a href="#l17.5004"></a><span id="l17.5004" class="difflineplus">+ *   { key: &quot;Manchuria&quot;, values: [</span>
<a href="#l17.5005"></a><span id="l17.5005" class="difflineplus">+ *       { yield: 27.00, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;University Farm&quot; },</span>
<a href="#l17.5006"></a><span id="l17.5006" class="difflineplus">+ *       { yield: 48.87, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Waseca&quot; },</span>
<a href="#l17.5007"></a><span id="l17.5007" class="difflineplus">+ *       { yield: 27.43, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Morris&quot; },</span>
<a href="#l17.5008"></a><span id="l17.5008" class="difflineplus">+ *       ...</span>
<a href="#l17.5009"></a><span id="l17.5009" class="difflineplus">+ *     ]},</span>
<a href="#l17.5010"></a><span id="l17.5010" class="difflineplus">+ *   { key: &quot;Glabron&quot;, values: [</span>
<a href="#l17.5011"></a><span id="l17.5011" class="difflineplus">+ *       { yield: 43.07, variety: &quot;Glabron&quot;, year: 1931, site: &quot;University Farm&quot; },</span>
<a href="#l17.5012"></a><span id="l17.5012" class="difflineplus">+ *       { yield: 55.20, variety: &quot;Glabron&quot;, year: 1931, site: &quot;Waseca&quot; },</span>
<a href="#l17.5013"></a><span id="l17.5013" class="difflineplus">+ *       ...</span>
<a href="#l17.5014"></a><span id="l17.5014" class="difflineplus">+ *     ]},</span>
<a href="#l17.5015"></a><span id="l17.5015" class="difflineplus">+ *   ]},</span>
<a href="#l17.5016"></a><span id="l17.5016" class="difflineplus">+ * { key: 1932, values: ... }&lt;/pre&gt;</span>
<a href="#l17.5017"></a><span id="l17.5017" class="difflineplus">+ *</span>
<a href="#l17.5018"></a><span id="l17.5018" class="difflineplus">+ * Further details, including sorting and rollup, is provided below on the</span>
<a href="#l17.5019"></a><span id="l17.5019" class="difflineplus">+ * corresponding methods.</span>
<a href="#l17.5020"></a><span id="l17.5020" class="difflineplus">+ *</span>
<a href="#l17.5021"></a><span id="l17.5021" class="difflineplus">+ * @param {array} array an array of elements to nest.</span>
<a href="#l17.5022"></a><span id="l17.5022" class="difflineplus">+ */</span>
<a href="#l17.5023"></a><span id="l17.5023" class="difflineplus">+pv.Nest = function(array) {</span>
<a href="#l17.5024"></a><span id="l17.5024" class="difflineplus">+  this.array = array;</span>
<a href="#l17.5025"></a><span id="l17.5025" class="difflineplus">+  this.keys = [];</span>
<a href="#l17.5026"></a><span id="l17.5026" class="difflineplus">+};</span>
<a href="#l17.5027"></a><span id="l17.5027" class="difflineplus">+</span>
<a href="#l17.5028"></a><span id="l17.5028" class="difflineplus">+/**</span>
<a href="#l17.5029"></a><span id="l17.5029" class="difflineplus">+ * Nests using the specified key function. Multiple keys may be added to the</span>
<a href="#l17.5030"></a><span id="l17.5030" class="difflineplus">+ * nest; the array elements will be nested in the order keys are specified.</span>
<a href="#l17.5031"></a><span id="l17.5031" class="difflineplus">+ *</span>
<a href="#l17.5032"></a><span id="l17.5032" class="difflineplus">+ * @param {function} key a key function; must return a string or suitable map</span>
<a href="#l17.5033"></a><span id="l17.5033" class="difflineplus">+ * key.</span>
<a href="#l17.5034"></a><span id="l17.5034" class="difflineplus">+ * @return {pv.Nest} this.</span>
<a href="#l17.5035"></a><span id="l17.5035" class="difflineplus">+ */</span>
<a href="#l17.5036"></a><span id="l17.5036" class="difflineplus">+pv.Nest.prototype.key = function(key) {</span>
<a href="#l17.5037"></a><span id="l17.5037" class="difflineplus">+  this.keys.push(key);</span>
<a href="#l17.5038"></a><span id="l17.5038" class="difflineplus">+  return this;</span>
<a href="#l17.5039"></a><span id="l17.5039" class="difflineplus">+};</span>
<a href="#l17.5040"></a><span id="l17.5040" class="difflineplus">+</span>
<a href="#l17.5041"></a><span id="l17.5041" class="difflineplus">+/**</span>
<a href="#l17.5042"></a><span id="l17.5042" class="difflineplus">+ * Sorts the previously-added keys. The natural sort order is used by default</span>
<a href="#l17.5043"></a><span id="l17.5043" class="difflineplus">+ * (see {@link pv.naturalOrder}); if an alternative order is desired,</span>
<a href="#l17.5044"></a><span id="l17.5044" class="difflineplus">+ * &lt;tt&gt;order&lt;/tt&gt; should be a comparator function. If this method is not called</span>
<a href="#l17.5045"></a><span id="l17.5045" class="difflineplus">+ * (i.e., keys are &lt;i&gt;unsorted&lt;/i&gt;), keys will appear in the order they appear</span>
<a href="#l17.5046"></a><span id="l17.5046" class="difflineplus">+ * in the underlying elements array. For example,</span>
<a href="#l17.5047"></a><span id="l17.5047" class="difflineplus">+ *</span>
<a href="#l17.5048"></a><span id="l17.5048" class="difflineplus">+ * &lt;pre&gt;pv.nest(yields)</span>
<a href="#l17.5049"></a><span id="l17.5049" class="difflineplus">+ *     .key(function(d) d.year)</span>
<a href="#l17.5050"></a><span id="l17.5050" class="difflineplus">+ *     .key(function(d) d.variety)</span>
<a href="#l17.5051"></a><span id="l17.5051" class="difflineplus">+ *     .sortKeys()</span>
<a href="#l17.5052"></a><span id="l17.5052" class="difflineplus">+ *     .entries()&lt;/pre&gt;</span>
<a href="#l17.5053"></a><span id="l17.5053" class="difflineplus">+ *</span>
<a href="#l17.5054"></a><span id="l17.5054" class="difflineplus">+ * groups yield data by year, then variety, and sorts the variety groups</span>
<a href="#l17.5055"></a><span id="l17.5055" class="difflineplus">+ * lexicographically (since the variety attribute is a string).</span>
<a href="#l17.5056"></a><span id="l17.5056" class="difflineplus">+ *</span>
<a href="#l17.5057"></a><span id="l17.5057" class="difflineplus">+ * &lt;p&gt;Key sort order is only used in conjunction with {@link #entries}, which</span>
<a href="#l17.5058"></a><span id="l17.5058" class="difflineplus">+ * returns an array of key-values pairs. If the nest is used to construct a</span>
<a href="#l17.5059"></a><span id="l17.5059" class="difflineplus">+ * {@link #map} instead, keys are unsorted.</span>
<a href="#l17.5060"></a><span id="l17.5060" class="difflineplus">+ *</span>
<a href="#l17.5061"></a><span id="l17.5061" class="difflineplus">+ * @param {function} [order] an optional comparator function.</span>
<a href="#l17.5062"></a><span id="l17.5062" class="difflineplus">+ * @returns {pv.Nest} this.</span>
<a href="#l17.5063"></a><span id="l17.5063" class="difflineplus">+ */</span>
<a href="#l17.5064"></a><span id="l17.5064" class="difflineplus">+pv.Nest.prototype.sortKeys = function(order) {</span>
<a href="#l17.5065"></a><span id="l17.5065" class="difflineplus">+  this.keys[this.keys.length - 1].order = order || pv.naturalOrder;</span>
<a href="#l17.5066"></a><span id="l17.5066" class="difflineplus">+  return this;</span>
<a href="#l17.5067"></a><span id="l17.5067" class="difflineplus">+};</span>
<a href="#l17.5068"></a><span id="l17.5068" class="difflineplus">+</span>
<a href="#l17.5069"></a><span id="l17.5069" class="difflineplus">+/**</span>
<a href="#l17.5070"></a><span id="l17.5070" class="difflineplus">+ * Sorts the leaf values. The natural sort order is used by default (see</span>
<a href="#l17.5071"></a><span id="l17.5071" class="difflineplus">+ * {@link pv.naturalOrder}); if an alternative order is desired, &lt;tt&gt;order&lt;/tt&gt;</span>
<a href="#l17.5072"></a><span id="l17.5072" class="difflineplus">+ * should be a comparator function. If this method is not called (i.e., values</span>
<a href="#l17.5073"></a><span id="l17.5073" class="difflineplus">+ * are &lt;i&gt;unsorted&lt;/i&gt;), values will appear in the order they appear in the</span>
<a href="#l17.5074"></a><span id="l17.5074" class="difflineplus">+ * underlying elements array. For example,</span>
<a href="#l17.5075"></a><span id="l17.5075" class="difflineplus">+ *</span>
<a href="#l17.5076"></a><span id="l17.5076" class="difflineplus">+ * &lt;pre&gt;pv.nest(yields)</span>
<a href="#l17.5077"></a><span id="l17.5077" class="difflineplus">+ *     .key(function(d) d.year)</span>
<a href="#l17.5078"></a><span id="l17.5078" class="difflineplus">+ *     .key(function(d) d.variety)</span>
<a href="#l17.5079"></a><span id="l17.5079" class="difflineplus">+ *     .sortValues(function(a, b) a.yield - b.yield)</span>
<a href="#l17.5080"></a><span id="l17.5080" class="difflineplus">+ *     .entries()&lt;/pre&gt;</span>
<a href="#l17.5081"></a><span id="l17.5081" class="difflineplus">+ *</span>
<a href="#l17.5082"></a><span id="l17.5082" class="difflineplus">+ * groups yield data by year, then variety, and sorts the values for each</span>
<a href="#l17.5083"></a><span id="l17.5083" class="difflineplus">+ * variety group by yield.</span>
<a href="#l17.5084"></a><span id="l17.5084" class="difflineplus">+ *</span>
<a href="#l17.5085"></a><span id="l17.5085" class="difflineplus">+ * &lt;p&gt;Value sort order, unlike keys, applies to both {@link #entries} and</span>
<a href="#l17.5086"></a><span id="l17.5086" class="difflineplus">+ * {@link #map}. It has no effect on {@link #rollup}.</span>
<a href="#l17.5087"></a><span id="l17.5087" class="difflineplus">+ *</span>
<a href="#l17.5088"></a><span id="l17.5088" class="difflineplus">+ * @param {function} [order] an optional comparator function.</span>
<a href="#l17.5089"></a><span id="l17.5089" class="difflineplus">+ * @return {pv.Nest} this.</span>
<a href="#l17.5090"></a><span id="l17.5090" class="difflineplus">+ */</span>
<a href="#l17.5091"></a><span id="l17.5091" class="difflineplus">+pv.Nest.prototype.sortValues = function(order) {</span>
<a href="#l17.5092"></a><span id="l17.5092" class="difflineplus">+  this.order = order || pv.naturalOrder;</span>
<a href="#l17.5093"></a><span id="l17.5093" class="difflineplus">+  return this;</span>
<a href="#l17.5094"></a><span id="l17.5094" class="difflineplus">+};</span>
<a href="#l17.5095"></a><span id="l17.5095" class="difflineplus">+</span>
<a href="#l17.5096"></a><span id="l17.5096" class="difflineplus">+/**</span>
<a href="#l17.5097"></a><span id="l17.5097" class="difflineplus">+ * Returns a hierarchical map of values. Each key adds one level to the</span>
<a href="#l17.5098"></a><span id="l17.5098" class="difflineplus">+ * hierarchy. With only a single key, the returned map will have a key for each</span>
<a href="#l17.5099"></a><span id="l17.5099" class="difflineplus">+ * distinct value of the key function; the correspond value with be an array of</span>
<a href="#l17.5100"></a><span id="l17.5100" class="difflineplus">+ * elements with that key value. If a second key is added, this will be a nested</span>
<a href="#l17.5101"></a><span id="l17.5101" class="difflineplus">+ * map. For example:</span>
<a href="#l17.5102"></a><span id="l17.5102" class="difflineplus">+ *</span>
<a href="#l17.5103"></a><span id="l17.5103" class="difflineplus">+ * &lt;pre&gt;pv.nest(yields)</span>
<a href="#l17.5104"></a><span id="l17.5104" class="difflineplus">+ *     .key(function(d) d.variety)</span>
<a href="#l17.5105"></a><span id="l17.5105" class="difflineplus">+ *     .key(function(d) d.site)</span>
<a href="#l17.5106"></a><span id="l17.5106" class="difflineplus">+ *     .map()&lt;/pre&gt;</span>
<a href="#l17.5107"></a><span id="l17.5107" class="difflineplus">+ *</span>
<a href="#l17.5108"></a><span id="l17.5108" class="difflineplus">+ * returns a map &lt;tt&gt;m&lt;/tt&gt; such that &lt;tt&gt;m[variety][site]&lt;/tt&gt; is an array, a subset of</span>
<a href="#l17.5109"></a><span id="l17.5109" class="difflineplus">+ * &lt;tt&gt;yields&lt;/tt&gt;, with each element having the given variety and site.</span>
<a href="#l17.5110"></a><span id="l17.5110" class="difflineplus">+ *</span>
<a href="#l17.5111"></a><span id="l17.5111" class="difflineplus">+ * @returns a hierarchical map of values.</span>
<a href="#l17.5112"></a><span id="l17.5112" class="difflineplus">+ */</span>
<a href="#l17.5113"></a><span id="l17.5113" class="difflineplus">+pv.Nest.prototype.map = function() {</span>
<a href="#l17.5114"></a><span id="l17.5114" class="difflineplus">+  var map = {}, values = [];</span>
<a href="#l17.5115"></a><span id="l17.5115" class="difflineplus">+</span>
<a href="#l17.5116"></a><span id="l17.5116" class="difflineplus">+  /* Build the map. */</span>
<a href="#l17.5117"></a><span id="l17.5117" class="difflineplus">+  for (var i, j = 0; j &lt; this.array.length; j++) {</span>
<a href="#l17.5118"></a><span id="l17.5118" class="difflineplus">+    var x = this.array[j];</span>
<a href="#l17.5119"></a><span id="l17.5119" class="difflineplus">+    var m = map;</span>
<a href="#l17.5120"></a><span id="l17.5120" class="difflineplus">+    for (i = 0; i &lt; this.keys.length - 1; i++) {</span>
<a href="#l17.5121"></a><span id="l17.5121" class="difflineplus">+      var k = this.keys[i](x);</span>
<a href="#l17.5122"></a><span id="l17.5122" class="difflineplus">+      if (!m[k]) m[k] = {};</span>
<a href="#l17.5123"></a><span id="l17.5123" class="difflineplus">+      m = m[k];</span>
<a href="#l17.5124"></a><span id="l17.5124" class="difflineplus">+    }</span>
<a href="#l17.5125"></a><span id="l17.5125" class="difflineplus">+    k = this.keys[i](x);</span>
<a href="#l17.5126"></a><span id="l17.5126" class="difflineplus">+    if (!m[k]) {</span>
<a href="#l17.5127"></a><span id="l17.5127" class="difflineplus">+      var a = [];</span>
<a href="#l17.5128"></a><span id="l17.5128" class="difflineplus">+      values.push(a);</span>
<a href="#l17.5129"></a><span id="l17.5129" class="difflineplus">+      m[k] = a;</span>
<a href="#l17.5130"></a><span id="l17.5130" class="difflineplus">+    }</span>
<a href="#l17.5131"></a><span id="l17.5131" class="difflineplus">+    m[k].push(x);</span>
<a href="#l17.5132"></a><span id="l17.5132" class="difflineplus">+  }</span>
<a href="#l17.5133"></a><span id="l17.5133" class="difflineplus">+</span>
<a href="#l17.5134"></a><span id="l17.5134" class="difflineplus">+  /* Sort each leaf array. */</span>
<a href="#l17.5135"></a><span id="l17.5135" class="difflineplus">+  if (this.order) {</span>
<a href="#l17.5136"></a><span id="l17.5136" class="difflineplus">+    for (var i = 0; i &lt; values.length; i++) {</span>
<a href="#l17.5137"></a><span id="l17.5137" class="difflineplus">+      values[i].sort(this.order);</span>
<a href="#l17.5138"></a><span id="l17.5138" class="difflineplus">+    }</span>
<a href="#l17.5139"></a><span id="l17.5139" class="difflineplus">+  }</span>
<a href="#l17.5140"></a><span id="l17.5140" class="difflineplus">+</span>
<a href="#l17.5141"></a><span id="l17.5141" class="difflineplus">+  return map;</span>
<a href="#l17.5142"></a><span id="l17.5142" class="difflineplus">+};</span>
<a href="#l17.5143"></a><span id="l17.5143" class="difflineplus">+</span>
<a href="#l17.5144"></a><span id="l17.5144" class="difflineplus">+/**</span>
<a href="#l17.5145"></a><span id="l17.5145" class="difflineplus">+ * Returns a hierarchical nested array. This method is similar to</span>
<a href="#l17.5146"></a><span id="l17.5146" class="difflineplus">+ * {@link pv#entries}, but works recursively on the entire hierarchy. Rather</span>
<a href="#l17.5147"></a><span id="l17.5147" class="difflineplus">+ * than returning a map like {@link #map}, this method returns a nested</span>
<a href="#l17.5148"></a><span id="l17.5148" class="difflineplus">+ * array. Each element of the array has a &lt;tt&gt;key&lt;/tt&gt; and &lt;tt&gt;values&lt;/tt&gt;</span>
<a href="#l17.5149"></a><span id="l17.5149" class="difflineplus">+ * field. For leaf nodes, the &lt;tt&gt;values&lt;/tt&gt; array will be a subset of the</span>
<a href="#l17.5150"></a><span id="l17.5150" class="difflineplus">+ * underlying elements array; for non-leaf nodes, the &lt;tt&gt;values&lt;/tt&gt; array will</span>
<a href="#l17.5151"></a><span id="l17.5151" class="difflineplus">+ * contain more key-values pairs.</span>
<a href="#l17.5152"></a><span id="l17.5152" class="difflineplus">+ *</span>
<a href="#l17.5153"></a><span id="l17.5153" class="difflineplus">+ * &lt;p&gt;For an example usage, see the {@link Nest} constructor.</span>
<a href="#l17.5154"></a><span id="l17.5154" class="difflineplus">+ *</span>
<a href="#l17.5155"></a><span id="l17.5155" class="difflineplus">+ * @returns a hierarchical nested array.</span>
<a href="#l17.5156"></a><span id="l17.5156" class="difflineplus">+ */</span>
<a href="#l17.5157"></a><span id="l17.5157" class="difflineplus">+pv.Nest.prototype.entries = function() {</span>
<a href="#l17.5158"></a><span id="l17.5158" class="difflineplus">+</span>
<a href="#l17.5159"></a><span id="l17.5159" class="difflineplus">+  /** Recursively extracts the entries for the given map. */</span>
<a href="#l17.5160"></a><span id="l17.5160" class="difflineplus">+  function entries(map) {</span>
<a href="#l17.5161"></a><span id="l17.5161" class="difflineplus">+    var array = [];</span>
<a href="#l17.5162"></a><span id="l17.5162" class="difflineplus">+    for (var k in map) {</span>
<a href="#l17.5163"></a><span id="l17.5163" class="difflineplus">+      var v = map[k];</span>
<a href="#l17.5164"></a><span id="l17.5164" class="difflineplus">+      array.push({ key: k, values: (v instanceof Array) ? v : entries(v) });</span>
<a href="#l17.5165"></a><span id="l17.5165" class="difflineplus">+    };</span>
<a href="#l17.5166"></a><span id="l17.5166" class="difflineplus">+    return array;</span>
<a href="#l17.5167"></a><span id="l17.5167" class="difflineplus">+  }</span>
<a href="#l17.5168"></a><span id="l17.5168" class="difflineplus">+</span>
<a href="#l17.5169"></a><span id="l17.5169" class="difflineplus">+  /** Recursively sorts the values for the given key-values array. */</span>
<a href="#l17.5170"></a><span id="l17.5170" class="difflineplus">+  function sort(array, i) {</span>
<a href="#l17.5171"></a><span id="l17.5171" class="difflineplus">+    var o = this.keys[i].order;</span>
<a href="#l17.5172"></a><span id="l17.5172" class="difflineplus">+    if (o) array.sort(function(a, b) { return o(a.key, b.key); });</span>
<a href="#l17.5173"></a><span id="l17.5173" class="difflineplus">+    if (++i &lt; this.keys.length) {</span>
<a href="#l17.5174"></a><span id="l17.5174" class="difflineplus">+      for (var j = 0; j &lt; array.length; j++) {</span>
<a href="#l17.5175"></a><span id="l17.5175" class="difflineplus">+        sort.call(this, array[j].values, i);</span>
<a href="#l17.5176"></a><span id="l17.5176" class="difflineplus">+      }</span>
<a href="#l17.5177"></a><span id="l17.5177" class="difflineplus">+    }</span>
<a href="#l17.5178"></a><span id="l17.5178" class="difflineplus">+    return array;</span>
<a href="#l17.5179"></a><span id="l17.5179" class="difflineplus">+  }</span>
<a href="#l17.5180"></a><span id="l17.5180" class="difflineplus">+</span>
<a href="#l17.5181"></a><span id="l17.5181" class="difflineplus">+  return sort.call(this, entries(this.map()), 0);</span>
<a href="#l17.5182"></a><span id="l17.5182" class="difflineplus">+};</span>
<a href="#l17.5183"></a><span id="l17.5183" class="difflineplus">+</span>
<a href="#l17.5184"></a><span id="l17.5184" class="difflineplus">+/**</span>
<a href="#l17.5185"></a><span id="l17.5185" class="difflineplus">+ * Returns a rollup map. The behavior of this method is the same as</span>
<a href="#l17.5186"></a><span id="l17.5186" class="difflineplus">+ * {@link #map}, except that the leaf values are replaced with the return value</span>
<a href="#l17.5187"></a><span id="l17.5187" class="difflineplus">+ * of the specified rollup function &lt;tt&gt;f&lt;/tt&gt;. For example,</span>
<a href="#l17.5188"></a><span id="l17.5188" class="difflineplus">+ *</span>
<a href="#l17.5189"></a><span id="l17.5189" class="difflineplus">+ * &lt;pre&gt;pv.nest(yields)</span>
<a href="#l17.5190"></a><span id="l17.5190" class="difflineplus">+ *      .key(function(d) d.site)</span>
<a href="#l17.5191"></a><span id="l17.5191" class="difflineplus">+ *      .rollup(function(v) pv.median(v, function(d) d.yield))&lt;/pre&gt;</span>
<a href="#l17.5192"></a><span id="l17.5192" class="difflineplus">+ *</span>
<a href="#l17.5193"></a><span id="l17.5193" class="difflineplus">+ * first groups yield data by site, and then returns a map from site to median</span>
<a href="#l17.5194"></a><span id="l17.5194" class="difflineplus">+ * yield for the given site.</span>
<a href="#l17.5195"></a><span id="l17.5195" class="difflineplus">+ *</span>
<a href="#l17.5196"></a><span id="l17.5196" class="difflineplus">+ * @see #map</span>
<a href="#l17.5197"></a><span id="l17.5197" class="difflineplus">+ * @param {function} f a rollup function.</span>
<a href="#l17.5198"></a><span id="l17.5198" class="difflineplus">+ * @returns a hierarhical map, with the leaf values computed by &lt;tt&gt;f&lt;/tt&gt;.</span>
<a href="#l17.5199"></a><span id="l17.5199" class="difflineplus">+ */</span>
<a href="#l17.5200"></a><span id="l17.5200" class="difflineplus">+pv.Nest.prototype.rollup = function(f) {</span>
<a href="#l17.5201"></a><span id="l17.5201" class="difflineplus">+</span>
<a href="#l17.5202"></a><span id="l17.5202" class="difflineplus">+  /** Recursively descends to the leaf nodes (arrays) and does rollup. */</span>
<a href="#l17.5203"></a><span id="l17.5203" class="difflineplus">+  function rollup(map) {</span>
<a href="#l17.5204"></a><span id="l17.5204" class="difflineplus">+    for (var key in map) {</span>
<a href="#l17.5205"></a><span id="l17.5205" class="difflineplus">+      var value = map[key];</span>
<a href="#l17.5206"></a><span id="l17.5206" class="difflineplus">+      if (value instanceof Array) {</span>
<a href="#l17.5207"></a><span id="l17.5207" class="difflineplus">+        map[key] = f(value);</span>
<a href="#l17.5208"></a><span id="l17.5208" class="difflineplus">+      } else {</span>
<a href="#l17.5209"></a><span id="l17.5209" class="difflineplus">+        rollup(value);</span>
<a href="#l17.5210"></a><span id="l17.5210" class="difflineplus">+      }</span>
<a href="#l17.5211"></a><span id="l17.5211" class="difflineplus">+    }</span>
<a href="#l17.5212"></a><span id="l17.5212" class="difflineplus">+    return map;</span>
<a href="#l17.5213"></a><span id="l17.5213" class="difflineplus">+  }</span>
<a href="#l17.5214"></a><span id="l17.5214" class="difflineplus">+</span>
<a href="#l17.5215"></a><span id="l17.5215" class="difflineplus">+  return rollup(this.map());</span>
<a href="#l17.5216"></a><span id="l17.5216" class="difflineplus">+};</span>
<a href="#l17.5217"></a><span id="l17.5217" class="difflineplus">+pv.Scales.ordinal = function(ordinals) {</span>
<a href="#l17.5218"></a><span id="l17.5218" class="difflineplus">+  return new pv.Scales.OrdinalScale(ordinals);</span>
<a href="#l17.5219"></a><span id="l17.5219" class="difflineplus">+};</span>
<a href="#l17.5220"></a><span id="l17.5220" class="difflineplus">+</span>
<a href="#l17.5221"></a><span id="l17.5221" class="difflineplus">+/**</span>
<a href="#l17.5222"></a><span id="l17.5222" class="difflineplus">+ * OrdinalScale is a Scale for ordered sequential data.  This supports both</span>
<a href="#l17.5223"></a><span id="l17.5223" class="difflineplus">+ * numeric and non-numeric data, and simply places each element in sequence</span>
<a href="#l17.5224"></a><span id="l17.5224" class="difflineplus">+ * using the ordering found in the input data array.</span>
<a href="#l17.5225"></a><span id="l17.5225" class="difflineplus">+ */</span>
<a href="#l17.5226"></a><span id="l17.5226" class="difflineplus">+pv.Scales.OrdinalScale = function(ordinals) {</span>
<a href="#l17.5227"></a><span id="l17.5227" class="difflineplus">+  pv.Scales.Scale.call(this);</span>
<a href="#l17.5228"></a><span id="l17.5228" class="difflineplus">+</span>
<a href="#l17.5229"></a><span id="l17.5229" class="difflineplus">+  /* Filter the specified ordinals to their unique values. */</span>
<a href="#l17.5230"></a><span id="l17.5230" class="difflineplus">+  var seen = {};</span>
<a href="#l17.5231"></a><span id="l17.5231" class="difflineplus">+  this._ordinals = [];</span>
<a href="#l17.5232"></a><span id="l17.5232" class="difflineplus">+  for (var i = 0; i &lt; ordinals.length; i++) {</span>
<a href="#l17.5233"></a><span id="l17.5233" class="difflineplus">+    var o = ordinals[i];</span>
<a href="#l17.5234"></a><span id="l17.5234" class="difflineplus">+    if (seen[o] == undefined) {</span>
<a href="#l17.5235"></a><span id="l17.5235" class="difflineplus">+      seen[o] = true;</span>
<a href="#l17.5236"></a><span id="l17.5236" class="difflineplus">+      this._ordinals.push(o);</span>
<a href="#l17.5237"></a><span id="l17.5237" class="difflineplus">+    }</span>
<a href="#l17.5238"></a><span id="l17.5238" class="difflineplus">+  }</span>
<a href="#l17.5239"></a><span id="l17.5239" class="difflineplus">+</span>
<a href="#l17.5240"></a><span id="l17.5240" class="difflineplus">+  this._map = pv.numerate(this._ordinals);</span>
<a href="#l17.5241"></a><span id="l17.5241" class="difflineplus">+};</span>
<a href="#l17.5242"></a><span id="l17.5242" class="difflineplus">+</span>
<a href="#l17.5243"></a><span id="l17.5243" class="difflineplus">+pv.Scales.OrdinalScale.prototype = pv.extend(pv.Scales.Scale);</span>
<a href="#l17.5244"></a><span id="l17.5244" class="difflineplus">+</span>
<a href="#l17.5245"></a><span id="l17.5245" class="difflineplus">+// Accessor method for ordinals</span>
<a href="#l17.5246"></a><span id="l17.5246" class="difflineplus">+pv.Scales.OrdinalScale.prototype.ordinals = function(ordinals) {</span>
<a href="#l17.5247"></a><span id="l17.5247" class="difflineplus">+  if (ordinals == undefined) {</span>
<a href="#l17.5248"></a><span id="l17.5248" class="difflineplus">+    return this._ordinals;</span>
<a href="#l17.5249"></a><span id="l17.5249" class="difflineplus">+  } else {</span>
<a href="#l17.5250"></a><span id="l17.5250" class="difflineplus">+    this._ordinals = ordinals;</span>
<a href="#l17.5251"></a><span id="l17.5251" class="difflineplus">+    this._map = pv.numerate(ordinals);</span>
<a href="#l17.5252"></a><span id="l17.5252" class="difflineplus">+    return this;</span>
<a href="#l17.5253"></a><span id="l17.5253" class="difflineplus">+  }</span>
<a href="#l17.5254"></a><span id="l17.5254" class="difflineplus">+};</span>
<a href="#l17.5255"></a><span id="l17.5255" class="difflineplus">+</span>
<a href="#l17.5256"></a><span id="l17.5256" class="difflineplus">+// Normalizes the value</span>
<a href="#l17.5257"></a><span id="l17.5257" class="difflineplus">+pv.Scales.OrdinalScale.prototype.normalize = function(x) {</span>
<a href="#l17.5258"></a><span id="l17.5258" class="difflineplus">+  var i = this._map[x];</span>
<a href="#l17.5259"></a><span id="l17.5259" class="difflineplus">+</span>
<a href="#l17.5260"></a><span id="l17.5260" class="difflineplus">+  // if x not an ordinal value(assume x is an index value)</span>
<a href="#l17.5261"></a><span id="l17.5261" class="difflineplus">+  if (i == undefined) i = x;</span>
<a href="#l17.5262"></a><span id="l17.5262" class="difflineplus">+</span>
<a href="#l17.5263"></a><span id="l17.5263" class="difflineplus">+  // Not sure if the value should be shifted</span>
<a href="#l17.5264"></a><span id="l17.5264" class="difflineplus">+  return (i == undefined) ? -1 : (i + 0.5) / this._ordinals.length;</span>
<a href="#l17.5265"></a><span id="l17.5265" class="difflineplus">+};</span>
<a href="#l17.5266"></a><span id="l17.5266" class="difflineplus">+</span>
<a href="#l17.5267"></a><span id="l17.5267" class="difflineplus">+// Returns the ordinal values for i</span>
<a href="#l17.5268"></a><span id="l17.5268" class="difflineplus">+pv.Scales.OrdinalScale.prototype.unnormalize = function(n) {</span>
<a href="#l17.5269"></a><span id="l17.5269" class="difflineplus">+  var i = Math.floor(n * this._ordinals.length - 0.5);</span>
<a href="#l17.5270"></a><span id="l17.5270" class="difflineplus">+  return this._ordinals[i];</span>
<a href="#l17.5271"></a><span id="l17.5271" class="difflineplus">+};</span>
<a href="#l17.5272"></a><span id="l17.5272" class="difflineplus">+</span>
<a href="#l17.5273"></a><span id="l17.5273" class="difflineplus">+// Returns a list of rule values</span>
<a href="#l17.5274"></a><span id="l17.5274" class="difflineplus">+pv.Scales.OrdinalScale.prototype.ruleValues = function() {</span>
<a href="#l17.5275"></a><span id="l17.5275" class="difflineplus">+  return pv.range(0.5, this._ordinals.length-0.5);</span>
<a href="#l17.5276"></a><span id="l17.5276" class="difflineplus">+};</span>
<a href="#l17.5277"></a><span id="l17.5277" class="difflineplus">+</span>
<a href="#l17.5278"></a><span id="l17.5278" class="difflineplus">+// Returns the width between rules</span>
<a href="#l17.5279"></a><span id="l17.5279" class="difflineplus">+pv.Scales.OrdinalScale.prototype.ruleWidth = function() {</span>
<a href="#l17.5280"></a><span id="l17.5280" class="difflineplus">+  return this.scale(1/this._ordinals.length);</span>
<a href="#l17.5281"></a><span id="l17.5281" class="difflineplus">+};</span>
<a href="#l17.5282"></a><span id="l17.5282" class="difflineplus">+pv.Scales.root = function(min, max, base) {</span>
<a href="#l17.5283"></a><span id="l17.5283" class="difflineplus">+  return new pv.Scales.RootScale(min, max, base);</span>
<a href="#l17.5284"></a><span id="l17.5284" class="difflineplus">+};</span>
<a href="#l17.5285"></a><span id="l17.5285" class="difflineplus">+</span>
<a href="#l17.5286"></a><span id="l17.5286" class="difflineplus">+pv.Scales.root.fromData = function(data, f, base) {</span>
<a href="#l17.5287"></a><span id="l17.5287" class="difflineplus">+  return new pv.Scales.RootScale(pv.min(data, f), pv.max(data, f), base);</span>
<a href="#l17.5288"></a><span id="l17.5288" class="difflineplus">+}</span>
<a href="#l17.5289"></a><span id="l17.5289" class="difflineplus">+</span>
<a href="#l17.5290"></a><span id="l17.5290" class="difflineplus">+/**</span>
<a href="#l17.5291"></a><span id="l17.5291" class="difflineplus">+ * RootScale is a QuantativeScale that performs a root transformation of the</span>
<a href="#l17.5292"></a><span id="l17.5292" class="difflineplus">+ * data. This could be a square root or any arbitrary power. A root scale may</span>
<a href="#l17.5293"></a><span id="l17.5293" class="difflineplus">+ * be a many-to-one mapping where the reverse mapping will not be correct.</span>
<a href="#l17.5294"></a><span id="l17.5294" class="difflineplus">+ */</span>
<a href="#l17.5295"></a><span id="l17.5295" class="difflineplus">+pv.Scales.RootScale = function(min, max, base) {</span>
<a href="#l17.5296"></a><span id="l17.5296" class="difflineplus">+  if (min instanceof Array) {</span>
<a href="#l17.5297"></a><span id="l17.5297" class="difflineplus">+    if (max == undefined) max = 2; // default base for root is 2.</span>
<a href="#l17.5298"></a><span id="l17.5298" class="difflineplus">+  } else {</span>
<a href="#l17.5299"></a><span id="l17.5299" class="difflineplus">+    if (base == undefined) base = 2; // default base for root is 2.</span>
<a href="#l17.5300"></a><span id="l17.5300" class="difflineplus">+  }</span>
<a href="#l17.5301"></a><span id="l17.5301" class="difflineplus">+</span>
<a href="#l17.5302"></a><span id="l17.5302" class="difflineplus">+  pv.Scales.QuantitativeScale.call(this, min, max, base);</span>
<a href="#l17.5303"></a><span id="l17.5303" class="difflineplus">+</span>
<a href="#l17.5304"></a><span id="l17.5304" class="difflineplus">+  this.update();</span>
<a href="#l17.5305"></a><span id="l17.5305" class="difflineplus">+};</span>
<a href="#l17.5306"></a><span id="l17.5306" class="difflineplus">+</span>
<a href="#l17.5307"></a><span id="l17.5307" class="difflineplus">+// Returns the root value with base b</span>
<a href="#l17.5308"></a><span id="l17.5308" class="difflineplus">+pv.Scales.RootScale.root = function (x, b) {</span>
<a href="#l17.5309"></a><span id="l17.5309" class="difflineplus">+  var s = (x &lt; 0) ? -1 : 1;</span>
<a href="#l17.5310"></a><span id="l17.5310" class="difflineplus">+  return s * Math.pow(s * x, 1 / b);</span>
<a href="#l17.5311"></a><span id="l17.5311" class="difflineplus">+};</span>
<a href="#l17.5312"></a><span id="l17.5312" class="difflineplus">+</span>
<a href="#l17.5313"></a><span id="l17.5313" class="difflineplus">+pv.Scales.RootScale.prototype = pv.extend(pv.Scales.QuantitativeScale);</span>
<a href="#l17.5314"></a><span id="l17.5314" class="difflineplus">+</span>
<a href="#l17.5315"></a><span id="l17.5315" class="difflineplus">+// Accessor method for min</span>
<a href="#l17.5316"></a><span id="l17.5316" class="difflineplus">+pv.Scales.RootScale.prototype.min = function(x) {</span>
<a href="#l17.5317"></a><span id="l17.5317" class="difflineplus">+  var value = pv.Scales.QuantitativeScale.prototype.min.call(this, x);</span>
<a href="#l17.5318"></a><span id="l17.5318" class="difflineplus">+  if (x != undefined) this.update();</span>
<a href="#l17.5319"></a><span id="l17.5319" class="difflineplus">+  return value;</span>
<a href="#l17.5320"></a><span id="l17.5320" class="difflineplus">+};</span>
<a href="#l17.5321"></a><span id="l17.5321" class="difflineplus">+</span>
<a href="#l17.5322"></a><span id="l17.5322" class="difflineplus">+// Accessor method for max</span>
<a href="#l17.5323"></a><span id="l17.5323" class="difflineplus">+pv.Scales.RootScale.prototype.max = function(x) {</span>
<a href="#l17.5324"></a><span id="l17.5324" class="difflineplus">+  var value = pv.Scales.QuantitativeScale.prototype.max.call(this, x);</span>
<a href="#l17.5325"></a><span id="l17.5325" class="difflineplus">+  if (x != undefined) this.update();</span>
<a href="#l17.5326"></a><span id="l17.5326" class="difflineplus">+  return value;</span>
<a href="#l17.5327"></a><span id="l17.5327" class="difflineplus">+};</span>
<a href="#l17.5328"></a><span id="l17.5328" class="difflineplus">+</span>
<a href="#l17.5329"></a><span id="l17.5329" class="difflineplus">+// Accessor method for base</span>
<a href="#l17.5330"></a><span id="l17.5330" class="difflineplus">+pv.Scales.RootScale.prototype.base = function(x) {</span>
<a href="#l17.5331"></a><span id="l17.5331" class="difflineplus">+  var value = pv.Scales.QuantitativeScale.prototype.base.call(this, x);</span>
<a href="#l17.5332"></a><span id="l17.5332" class="difflineplus">+  if (x != undefined) this.update();</span>
<a href="#l17.5333"></a><span id="l17.5333" class="difflineplus">+  return value;</span>
<a href="#l17.5334"></a><span id="l17.5334" class="difflineplus">+};</span>
<a href="#l17.5335"></a><span id="l17.5335" class="difflineplus">+</span>
<a href="#l17.5336"></a><span id="l17.5336" class="difflineplus">+// Normalizes the value</span>
<a href="#l17.5337"></a><span id="l17.5337" class="difflineplus">+pv.Scales.RootScale.prototype.normalize = function(x) {</span>
<a href="#l17.5338"></a><span id="l17.5338" class="difflineplus">+  var eps = pv.Scales.epsilon;</span>
<a href="#l17.5339"></a><span id="l17.5339" class="difflineplus">+  var range = this._rmax - this._rmin;</span>
<a href="#l17.5340"></a><span id="l17.5340" class="difflineplus">+</span>
<a href="#l17.5341"></a><span id="l17.5341" class="difflineplus">+  return (range &lt; eps &amp;&amp; range &gt; -eps) ? 0</span>
<a href="#l17.5342"></a><span id="l17.5342" class="difflineplus">+    : (pv.Scales.RootScale.root(x, this._base) - this._rmin)</span>
<a href="#l17.5343"></a><span id="l17.5343" class="difflineplus">+      / (this._rmax - this._rmin);</span>
<a href="#l17.5344"></a><span id="l17.5344" class="difflineplus">+};</span>
<a href="#l17.5345"></a><span id="l17.5345" class="difflineplus">+</span>
<a href="#l17.5346"></a><span id="l17.5346" class="difflineplus">+// Un-normalizes the value</span>
<a href="#l17.5347"></a><span id="l17.5347" class="difflineplus">+pv.Scales.RootScale.prototype.unnormalize = function(n) {</span>
<a href="#l17.5348"></a><span id="l17.5348" class="difflineplus">+  return Math.pow(n * (this._rmax - this._rmin) + this._rmin, this._base);</span>
<a href="#l17.5349"></a><span id="l17.5349" class="difflineplus">+};</span>
<a href="#l17.5350"></a><span id="l17.5350" class="difflineplus">+</span>
<a href="#l17.5351"></a><span id="l17.5351" class="difflineplus">+// Sets min/max values to &quot;nice numbers&quot;</span>
<a href="#l17.5352"></a><span id="l17.5352" class="difflineplus">+pv.Scales.RootScale.prototype.nice = function() {</span>
<a href="#l17.5353"></a><span id="l17.5353" class="difflineplus">+  var step = this.step(this._rmin, this._rmax);</span>
<a href="#l17.5354"></a><span id="l17.5354" class="difflineplus">+</span>
<a href="#l17.5355"></a><span id="l17.5355" class="difflineplus">+  this._rmin = Math.floor(this._rmin / step) * step;</span>
<a href="#l17.5356"></a><span id="l17.5356" class="difflineplus">+  this._rmax = Math.ceil(this._rmax / step) * step;</span>
<a href="#l17.5357"></a><span id="l17.5357" class="difflineplus">+</span>
<a href="#l17.5358"></a><span id="l17.5358" class="difflineplus">+  this._min = Math.pow(this._rmin, this._base);</span>
<a href="#l17.5359"></a><span id="l17.5359" class="difflineplus">+  this._max = Math.pow(this._rmax, this._base);</span>
<a href="#l17.5360"></a><span id="l17.5360" class="difflineplus">+</span>
<a href="#l17.5361"></a><span id="l17.5361" class="difflineplus">+  return this;</span>
<a href="#l17.5362"></a><span id="l17.5362" class="difflineplus">+};</span>
<a href="#l17.5363"></a><span id="l17.5363" class="difflineplus">+</span>
<a href="#l17.5364"></a><span id="l17.5364" class="difflineplus">+// Returns a list of rule values</span>
<a href="#l17.5365"></a><span id="l17.5365" class="difflineplus">+// The rule values of a root scale should be the powers</span>
<a href="#l17.5366"></a><span id="l17.5366" class="difflineplus">+// of integers, e.g. 1, 4, 9, ... for base = 2</span>
<a href="#l17.5367"></a><span id="l17.5367" class="difflineplus">+// TODO: This function needs further testing</span>
<a href="#l17.5368"></a><span id="l17.5368" class="difflineplus">+pv.Scales.RootScale.prototype.ruleValues = function() {</span>
<a href="#l17.5369"></a><span id="l17.5369" class="difflineplus">+  var step = this.step(this._rmin, this._rmax);</span>
<a href="#l17.5370"></a><span id="l17.5370" class="difflineplus">+//  if (step &lt; 1) step = 1; // bound to 1</span>
<a href="#l17.5371"></a><span id="l17.5371" class="difflineplus">+  // TODO: handle decimal values</span>
<a href="#l17.5372"></a><span id="l17.5372" class="difflineplus">+</span>
<a href="#l17.5373"></a><span id="l17.5373" class="difflineplus">+  var s;</span>
<a href="#l17.5374"></a><span id="l17.5374" class="difflineplus">+  var list = pv.range(Math.floor(this._rmin), Math.ceil(this._rmax), step);</span>
<a href="#l17.5375"></a><span id="l17.5375" class="difflineplus">+  for (var i = 0; i &lt; list.length; i++) {</span>
<a href="#l17.5376"></a><span id="l17.5376" class="difflineplus">+    s = (list[i] &lt; 0) ? -1 : 1;</span>
<a href="#l17.5377"></a><span id="l17.5377" class="difflineplus">+    list[i] = s*Math.pow(list[i], this._base);</span>
<a href="#l17.5378"></a><span id="l17.5378" class="difflineplus">+  }</span>
<a href="#l17.5379"></a><span id="l17.5379" class="difflineplus">+</span>
<a href="#l17.5380"></a><span id="l17.5380" class="difflineplus">+  // check end points</span>
<a href="#l17.5381"></a><span id="l17.5381" class="difflineplus">+  if (list[0] &lt; this._min) list.splice(0, 1);</span>
<a href="#l17.5382"></a><span id="l17.5382" class="difflineplus">+  if (list[list.length-1] &gt; this._max) list.splice(list.length-1, 1);</span>
<a href="#l17.5383"></a><span id="l17.5383" class="difflineplus">+</span>
<a href="#l17.5384"></a><span id="l17.5384" class="difflineplus">+  return list;</span>
<a href="#l17.5385"></a><span id="l17.5385" class="difflineplus">+};</span>
<a href="#l17.5386"></a><span id="l17.5386" class="difflineplus">+</span>
<a href="#l17.5387"></a><span id="l17.5387" class="difflineplus">+// Update root scale values</span>
<a href="#l17.5388"></a><span id="l17.5388" class="difflineplus">+pv.Scales.RootScale.prototype.update = function() {</span>
<a href="#l17.5389"></a><span id="l17.5389" class="difflineplus">+  var rt = pv.Scales.RootScale.root;</span>
<a href="#l17.5390"></a><span id="l17.5390" class="difflineplus">+  this._rmin = rt(this._min, this._base);</span>
<a href="#l17.5391"></a><span id="l17.5391" class="difflineplus">+  this._rmax = rt(this._max, this._base);</span>
<a href="#l17.5392"></a><span id="l17.5392" class="difflineplus">+};</span>
<a href="#l17.5393"></a><span id="l17.5393" class="difflineplus">+  return pv;</span>
<a href="#l17.5394"></a><span id="l17.5394" class="difflineplus">+}();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/base/content/search.xml</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/base/content/search.xml</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -18,16 +18,18 @@</span>
<a href="#l18.4"></a><span id="l18.4">   -</span>
<a href="#l18.5"></a><span id="l18.5">   - The Initial Developer of the Original Code is</span>
<a href="#l18.6"></a><span id="l18.6">   - Netscape Communications Corporation.</span>
<a href="#l18.7"></a><span id="l18.7">   - Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l18.8"></a><span id="l18.8">   - the Initial Developer. All Rights Reserved.</span>
<a href="#l18.9"></a><span id="l18.9">   -</span>
<a href="#l18.10"></a><span id="l18.10">   - Contributor(s):</span>
<a href="#l18.11"></a><span id="l18.11">   -   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+  -   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  -   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l18.14"></a><span id="l18.14">   -</span>
<a href="#l18.15"></a><span id="l18.15">   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l18.16"></a><span id="l18.16">   - either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l18.17"></a><span id="l18.17">   - or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l18.18"></a><span id="l18.18">   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l18.19"></a><span id="l18.19">   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l18.20"></a><span id="l18.20">   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l18.21"></a><span id="l18.21">   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -47,354 +49,615 @@</span>
<a href="#l18.23"></a><span id="l18.23"> &lt;bindings id=&quot;SearchBindings&quot;</span>
<a href="#l18.24"></a><span id="l18.24">    xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l18.25"></a><span id="l18.25">    xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l18.26"></a><span id="l18.26">    xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l18.27"></a><span id="l18.27">    xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l18.28"></a><span id="l18.28"> </span>
<a href="#l18.29"></a><span id="l18.29">   &lt;!--</span>
<a href="#l18.30"></a><span id="l18.30">     - The glodaSearch binding implements a gloda-backed search mechanism.  The</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-    -  actual search logic comes from the glodaSearch tab mode in the</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-    -  mailTabType definition.  This binding serves as a means to display and </span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-    -  alter the current search query if a &quot;glodaSearch&quot; tab is displayed, or</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-    -  enter a search query and spawn a new &quot;glodaSearch&quot; tab if one is</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-    -  currently not displayed.  The &quot;glodaFacets&quot; binding also is used to</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-    -  display/modify the parameters of the search when on a &quot;glodaSearch&quot; tab.</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+    -  actual search logic comes from the glodaFacet tab mode in the</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+    -  glodaFacetTabType definition.  This binding serves as a means to display</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+    -  and alter the current search query if a &quot;glodaFacet&quot; tab is displayed,</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+    -  or enter a search query and spawn a new &quot;glodaFacet&quot; tab if one is</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+    -  currently not displayed.</span>
<a href="#l18.42"></a><span id="l18.42">     --&gt;</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-  &lt;binding id=&quot;glodaSearch&quot; extends=&quot;chrome://global/content/bindings/textbox.xml#search-textbox&quot;&gt;</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+  &lt;binding id=&quot;glodaSearch&quot; extends=&quot;chrome://global/content/bindings/autocomplete.xml#autocomplete&quot;&gt;</span>
<a href="#l18.45"></a><span id="l18.45">     &lt;resources&gt;</span>
<a href="#l18.46"></a><span id="l18.46">       &lt;stylesheet src=&quot;chrome://messenger/skin/searchBox.css&quot;/&gt;</span>
<a href="#l18.47"></a><span id="l18.47">     &lt;/resources&gt;</span>
<a href="#l18.48"></a><span id="l18.48"> </span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-    &lt;handlers&gt;</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-      &lt;handler event=&quot;command&quot;&gt;&lt;![CDATA[</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-        if (this.value) {</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-          let searchString = this.value;</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-          let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-          // If the current tab is a gloda search tab, reset the value</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-          //  to the initial search value.  Otherwise, clear it.  This</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-          //  is the value that is going to be saved with the current</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-          //  tab when we switch back to it next.</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-          if (tabmail.currentTabInfo.mode.name == &quot;glodaSearch&quot;)</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-            this.value = tabmail.currentTabInfo.searchString;</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-          else</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-            this.value = &quot;&quot;;</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-          // open a new tab with our dude</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-          tabmail.openTab(&quot;glodaSearch&quot;, {searchString: searchString,</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-              facetString: &quot;everything&quot;, locationString: &quot;everywhere&quot;});</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-        }</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-    &lt;/handlers&gt;</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+    &lt;content&gt;</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+      &lt;xul:button anonid=&quot;quick-search-button&quot; class=&quot;quick-search-button&quot; type=&quot;menu&quot; chromedir=&quot;&amp;locale.dir;&quot;&gt;</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+        &lt;xul:menupopup anonid=&quot;quick-search-menupopup&quot;</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+                   class=&quot;quick-search-menupopup&quot;</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+                   persist=&quot;value&quot;</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+                   onpopupshowing=&quot;this.parentNode.parentNode.updatePopup();&quot;</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+                   popupalign=&quot;topleft&quot;</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+                   popupanchor=&quot;bottomleft&quot;&gt;</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+          &lt;xul:menuitem anonid=&quot;searchGlobalMenu&quot;</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+                    class=&quot;quick-search-menu&quot;</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+                    value=&quot;global&quot;</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+                    glodaOnly=&quot;true&quot;</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+                    label=&quot;&amp;searchEverywhere.label;&quot;</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+                    type=&quot;radio&quot;</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+                    oncommand=&quot;this.parentNode.parentNode.parentNode.changeMode(this)&quot;/&gt;</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+          &lt;xul:menuseparator quicksearchOnly=&quot;true&quot;</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+                             glodaOnly=&quot;true&quot;/&gt;</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+        &lt;/xul:menupopup&gt;</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+      &lt;/xul:button&gt;</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+      &lt;xul:hbox class=&quot;quick-search-textbox textbox-input-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+        &lt;html:input class=&quot;textbox-input&quot; flex=&quot;1&quot; anonid=&quot;input&quot; allowevents=&quot;true&quot;</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+                    xbl:inherits=&quot;onfocus,onblur,oninput,value,type,maxlength,disabled,size,readonly,tabindex,accesskey&quot;/&gt;</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+      &lt;/xul:hbox&gt;</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+      &lt;xul:toolbarbutton anonid=&quot;quick-search-clearbutton&quot; xbl:inherits=&quot;&quot;</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+                         disabled=&quot;true&quot; class=&quot;quick-search-clearbutton&quot;</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+                         onclick=&quot;this.parentNode.value = ''; this.parentNode.doSearch(); this.parentNode.select(); return false;&quot;</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+                         chromedir=&quot;&amp;locale.dir;&quot;/&gt;</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+                         &lt;!--XXX update search if not global--&gt;</span>
<a href="#l18.97"></a><span id="l18.97"> </span>
<a href="#l18.98"></a><span id="l18.98" class="difflineminus">-  &lt;!--</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-    - The glodaFacets binding is used to display additional search constraints</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-    -  on a &quot;glodaSearch&quot; tab's gloda-backed search.  Because we live in the</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-    -  &quot;mailContent&quot; panel reused by the &quot;glodaSearch&quot; tab mode, we are always</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineminus">-    -  present, even when we should not be displayed (namely for &quot;folder&quot; and</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineminus">-    -  &quot;message&quot; tab modes).  We leave it up to the mailTabType and glodaSearch</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-    -  tab mode to ensure that we are shown/hidden at the right times.  (We</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-    -  could do this ourselves as a tabmail tab monitor, but it is more</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineminus">-    -  intuitive to have our behaviour/relationship made explicit.)</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineminus">-    --&gt;</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-  &lt;binding id=&quot;glodaFacets&quot;&gt;</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-    &lt;resources&gt;</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-      &lt;stylesheet src=&quot;chrome://messenger/skin/searchBox.css&quot;/&gt;</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-    &lt;/resources&gt;</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineminus">-    &lt;content orientation=&quot;horizontal&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineminus">-      &lt;xul:label control=&quot;glodaFacetType&quot; value=&quot;&amp;glodaSearchBar.facet.label;&quot;/&gt;</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-      &lt;xul:menulist id=&quot;glodaFacetType&quot;&gt;</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-        &lt;xul:menupopup&gt;</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.everything.label;&quot;</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-                        value=&quot;everything&quot;/&gt;</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.subject.label;&quot;</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-                        value=&quot;subject&quot;/&gt;</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.involves.label;&quot;</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-                        value=&quot;involves&quot;/&gt;</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.to.label;&quot;</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-                        value=&quot;to&quot;/&gt;</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.from.label;&quot;</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-                        value=&quot;from&quot;/&gt;</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.body.label;&quot;</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineminus">-                        value=&quot;body&quot;/&gt;</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineminus">-        &lt;/xul:menupopup&gt;</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineminus">-      &lt;/xul:menulist&gt;</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineminus">-      &lt;xul:label control=&quot;glodaFacetLocation&quot;</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineminus">-                 value=&quot;&amp;glodaSearchBar.location.label;&quot;/&gt;</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-      &lt;xul:menulist id=&quot;glodaFacetLocation&quot; anonid=&quot;glodaFacetLocation&quot;&gt;</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-        &lt;xul:menupopup&gt;</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.everywhere.label;&quot; value=&quot;everywhere&quot;/&gt;</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineminus">-          &lt;xul:menuitem anonid=&quot;currentFolder&quot; label=&quot;&quot; value=&quot;currentFolder&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineminus">-          &lt;xul:menu label=&quot;&amp;glodaSearchFacet.folder.label;&quot;&gt;</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-            &lt;xul:menupopup type=&quot;folder&quot;/&gt;</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-          &lt;/xul:menu&gt;</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineminus">-        &lt;/xul:menupopup&gt;</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineminus">-      &lt;/xul:menulist&gt;</span>
<a href="#l18.141"></a><span id="l18.141">     &lt;/content&gt;</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineminus">-</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineminus">-    &lt;implementation&gt;</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-      &lt;constructor&gt;</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+    &lt;handlers&gt;</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+      &lt;handler event=&quot;input&quot;&gt;</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+        try {</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+          if (this.searchMode != &quot;global&quot;) { // it's a quick search</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineplus">+            let dis = this;</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineplus">+            clearTimeout(this.timeoutHandler);</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineplus">+            this.timeoutHandler = setTimeout(this.onTimeout, this.timeout, dis);</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineplus">+          }</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineplus">+        } catch (e) {</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineplus">+          logException(e);</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineplus">+        }</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineplus">+        ]]&gt;</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineplus">+      &lt;/handler&gt;</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineplus">+      &lt;!-- For the next two, we need to get in on the bubbling phase, as</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineplus">+           otherwise we'll be doing searches when autocomplete results are</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineplus">+           being selected. --&gt;</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineplus">+      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_ENTER&quot;</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineplus">+        phase=&quot;bubbling&quot; action=&quot;return this.doSearch();&quot;/&gt;</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineplus">+      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_RETURN&quot;</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineplus">+        phase=&quot;bubbling&quot;&gt;</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineplus">+          try {</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+            this.doSearch();</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+          } catch (e) {</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineplus">+            logException(e);</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineplus">+          }</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineplus">+          return true;</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineplus">+        ]]&gt;</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineplus">+      &lt;/handler&gt;</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineplus">+      &lt;handler event=&quot;input&quot;&gt;</span>
<a href="#l18.176"></a><span id="l18.176">         &lt;![CDATA[</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineminus">-          this._facetTypeNode =</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineminus">-            document.getAnonymousElementByAttribute(this, &quot;id&quot;,</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineminus">-                                                    &quot;glodaFacetType&quot;);</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineminus">-          this._facetLocationNode =</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineminus">-            document.getAnonymousElementByAttribute(this, &quot;id&quot;,</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineminus">-                                                    &quot;glodaFacetLocation&quot;);</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineminus">-          this._currentFolderNode =</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineminus">-            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineminus">-                                                    &quot;currentFolder&quot;);</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineminus">-        ]]&gt;</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineminus">-      &lt;/constructor&gt;</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineminus">-      &lt;method name=&quot;updateStateFromCurrentTab&quot;&gt;</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineminus">-        /**</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineminus">-         * Update our display state to match the state of the current tab.</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineminus">-         */</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineminus">-          let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineminus">-          let tabInfo = tabMail.currentTabInfo;</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineplus">+          if (!this.value)</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineplus">+            this.clearButtonHidden = true;</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineplus">+          else</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineplus">+            this.clearButtonHidden = false;</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineplus">+        ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineplus">+      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_DOWN&quot; modifiers=&quot;alt&quot;</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineplus">+               phase=&quot;capturing&quot; action=&quot;return this.openmenupopup();&quot;/&gt;</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineplus">+      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_UP&quot;   modifiers=&quot;alt&quot;</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineplus">+               phase=&quot;capturing&quot; action=&quot;return this.openmenupopup();&quot;/&gt;</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineplus">+      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_F4&quot; phase=&quot;capturing&quot;&gt;&lt;![CDATA[</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineplus">+        if (window.navigator.oscpu.substring(0, 3).toLowerCase() != &quot;mac&quot;)</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineplus">+          return this.openmenupopup();</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineplus">+      ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.208"></a><span id="l18.208"> </span>
<a href="#l18.209"></a><span id="l18.209" class="difflineminus">-          this._facetTypeNode.value = tabInfo.facetString;</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineminus">-          if (typeof(tabInfo.location) == &quot;string&quot;)</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineminus">-            this._facetLocationNode.value = tabInfo.location;</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineminus">-      &lt;method name=&quot;setLocationFacetToFolder&quot;&gt;</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineminus">-        /**</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineminus">-         * Update our display state to match the state of the current tab.</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineminus">-         */</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineminus">-          let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineminus">-          let tabInfo = tabMail.currentTabInfo;</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineminus">-</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineminus">-          this._facetTypeNode.value = tabInfo.facetString;</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineminus">-          if (typeof(tabInfo.location) == &quot;string&quot;)</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineminus">-            this._facetLocationNode.value = tabInfo.location;</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineplus">+      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_UP&quot; modifiers=&quot;control&quot;</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineplus">+               phase=&quot;capturing&quot;&gt;</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineplus">+        try {</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineplus">+          var menuPopupValue = this.menupopup.getAttribute('value');</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineplus">+          var menuItem =</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineplus">+            this.menupopup.getElementsByAttribute('value', this.searchMode)[0];</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineplus">+          if (menuItem != this.menupopup.firstChild) {</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineplus">+            let previousMenuItem = menuItem.previousSibling;</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineplus">+            while (! previousMenuItem.hasAttribute(&quot;value&quot;) &amp;&amp;</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineplus">+                   previousMenuItem != this.menupopup.firstChild)</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineplus">+              previousMenuItem = previousMenuItem.previousSibling;</span>
<a href="#l18.238"></a><span id="l18.238"> </span>
<a href="#l18.239"></a><span id="l18.239" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineminus">-</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineminus">-    &lt;handlers&gt;</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineminus">-      &lt;handler event=&quot;command&quot; phase=&quot;bubble&quot;&gt;&lt;![CDATA[</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineminus">-        // Have widgetNode be our immediate child, with nodes being a list of</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineminus">-        //  the descendent nodes between eventNode and the actual target.</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineminus">-        // This allows us to know which of our widgets actually got clicked on,</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineminus">-        //  plus makes subsequent processing easier.  (Alternatively, we could</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineminus">-        //  register a command listener on each of our widgets, but that is</span>
<a href="#l18.249"></a><span id="l18.249" class="difflineminus">-        //  arguably just as ugly.) </span>
<a href="#l18.250"></a><span id="l18.250" class="difflineminus">-        let nodes = [];</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineminus">-        let widgetNode = event.originalTarget;</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineminus">-        while (widgetNode.parentNode != this) {</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineminus">-          nodes.unshift(widgetNode);</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineminus">-          widgetNode = widgetNode.parentNode;</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineplus">+            previousMenuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineplus">+            menuItem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineplus">+            this.searchMode = previousMenuItem.getAttribute('value');</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineplus">+            this.menupopup.setAttribute('value', this.searchMode);</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineplus">+          }</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineplus">+          return false;</span>
<a href="#l18.261"></a><span id="l18.261" class="difflineplus">+        } catch (e) {</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineplus">+          logException(e);</span>
<a href="#l18.263"></a><span id="l18.263">         }</span>
<a href="#l18.264"></a><span id="l18.264" class="difflineminus">-</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineminus">-        // -- Type Facet</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineminus">-        if (widgetNode == this._facetTypeNode) {</span>
<a href="#l18.267"></a><span id="l18.267" class="difflineplus">+        ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.268"></a><span id="l18.268"> </span>
<a href="#l18.269"></a><span id="l18.269" class="difflineplus">+      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_DOWN&quot; modifiers=&quot;control&quot;</span>
<a href="#l18.270"></a><span id="l18.270" class="difflineplus">+               phase=&quot;capturing&quot;&gt;</span>
<a href="#l18.271"></a><span id="l18.271" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l18.272"></a><span id="l18.272" class="difflineplus">+        try {</span>
<a href="#l18.273"></a><span id="l18.273" class="difflineplus">+          var menuPopupValue = this.menupopup.getAttribute('value');</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineplus">+          var menuItem =</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineplus">+            this.menupopup.getElementsByAttribute('value', this.searchMode)[0];</span>
<a href="#l18.276"></a><span id="l18.276" class="difflineplus">+          if (menuItem != this.menupopup.lastChild) {</span>
<a href="#l18.277"></a><span id="l18.277" class="difflineplus">+            let nextMenuItem = menuItem.nextSibling;</span>
<a href="#l18.278"></a><span id="l18.278" class="difflineplus">+            while (! nextMenuItem.hasAttribute(&quot;value&quot;) &amp;&amp;</span>
<a href="#l18.279"></a><span id="l18.279" class="difflineplus">+                   nextMenuItem != this.menupopup.lastChild)</span>
<a href="#l18.280"></a><span id="l18.280" class="difflineplus">+              nextMenuItem = nextMenuItem.nextSibling;</span>
<a href="#l18.281"></a><span id="l18.281" class="difflineplus">+            nextMenuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l18.282"></a><span id="l18.282" class="difflineplus">+            menuItem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l18.283"></a><span id="l18.283" class="difflineplus">+            this.searchMode = nextMenuItem.getAttribute('value');</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineplus">+            this.menupopup.setAttribute('value', this.searchMode);</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineplus">+          }</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineplus">+          return false;</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineplus">+        } catch (e) {</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineplus">+          logException(e);</span>
<a href="#l18.289"></a><span id="l18.289">         }</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineminus">-        // -- Location Facet</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineminus">-        else if (widgetNode == this._facetLocationNode) {</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineminus">-          if (event.originalTarget._folder) {</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineminus">-            let folder = event.originalTarget._folder;</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineminus">-            this._currentFolderNode.label =</span>
<a href="#l18.295"></a><span id="l18.295" class="difflineminus">-              [node._folder.prettiestName</span>
<a href="#l18.296"></a><span id="l18.296" class="difflineminus">-               for each ([, node] in Iterator(nodes))</span>
<a href="#l18.297"></a><span id="l18.297" class="difflineminus">-               if (node._folder)].join(&quot;/&quot;);</span>
<a href="#l18.298"></a><span id="l18.298" class="difflineminus">-            this._currentFolderNode.hidden = false;</span>
<a href="#l18.299"></a><span id="l18.299" class="difflineminus">-            this._facetLocationNode.selectedItem = this._currentFolderNode;</span>
<a href="#l18.300"></a><span id="l18.300" class="difflineminus">-          }</span>
<a href="#l18.301"></a><span id="l18.301" class="difflineminus">-        }</span>
<a href="#l18.302"></a><span id="l18.302" class="difflineplus">+        ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.303"></a><span id="l18.303" class="difflineplus">+</span>
<a href="#l18.304"></a><span id="l18.304"> </span>
<a href="#l18.305"></a><span id="l18.305" class="difflineminus">-        dump(&quot;Selected folder: &quot; + event.originalTarget._folder + &quot;\n&quot;);</span>
<a href="#l18.306"></a><span id="l18.306" class="difflineminus">-        dump(&quot;event: &quot; + event + &quot;\n&quot;);</span>
<a href="#l18.307"></a><span id="l18.307" class="difflineminus">-        dump(&quot;target: &quot; + event.originalTarget + &quot;\n&quot;);</span>
<a href="#l18.308"></a><span id="l18.308" class="difflineminus">-        dump(&quot;event target id: &quot; + event.originalTarget.id + &quot;\n&quot;);</span>
<a href="#l18.309"></a><span id="l18.309" class="difflineminus">-        dump(&quot;event tag: &quot; + event.originalTarget.tagName + &quot;\n&quot;);</span>
<a href="#l18.310"></a><span id="l18.310" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.311"></a><span id="l18.311" class="difflineplus">+      &lt;handler event=&quot;drop&quot; phase=&quot;capturing&quot;&gt;</span>
<a href="#l18.312"></a><span id="l18.312" class="difflineplus">+        nsDragAndDrop.drop(event, this.searchInputDNDObserver);</span>
<a href="#l18.313"></a><span id="l18.313" class="difflineplus">+      &lt;/handler&gt;</span>
<a href="#l18.314"></a><span id="l18.314">     &lt;/handlers&gt;</span>
<a href="#l18.315"></a><span id="l18.315"> </span>
<a href="#l18.316"></a><span id="l18.316" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l18.317"></a><span id="l18.317" class="difflineplus">+    &lt;implementation implements=&quot;nsIObserver&quot;&gt;</span>
<a href="#l18.318"></a><span id="l18.318" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l18.319"></a><span id="l18.319" class="difflineplus">+        const Cc = Components.classes;</span>
<a href="#l18.320"></a><span id="l18.320" class="difflineplus">+        const Ci = Components.interfaces;</span>
<a href="#l18.321"></a><span id="l18.321" class="difflineplus">+        const Cu = Components.utils;</span>
<a href="#l18.322"></a><span id="l18.322" class="difflineplus">+        Cu.import(&quot;resource://app/modules/errUtils.js&quot;);</span>
<a href="#l18.323"></a><span id="l18.323" class="difflineplus">+        try {</span>
<a href="#l18.324"></a><span id="l18.324" class="difflineplus">+          Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l18.325"></a><span id="l18.325" class="difflineplus">+          Cu.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l18.326"></a><span id="l18.326"> </span>
<a href="#l18.327"></a><span id="l18.327" class="difflineplus">+          var prefBranch =</span>
<a href="#l18.328"></a><span id="l18.328" class="difflineplus">+              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l18.329"></a><span id="l18.329" class="difflineplus">+              getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l18.330"></a><span id="l18.330" class="difflineplus">+          prefBranch.addObserver(&quot;mailnews.database.global.indexer.enabled&quot;,</span>
<a href="#l18.331"></a><span id="l18.331" class="difflineplus">+                                 this._prefObserver, false);</span>
<a href="#l18.332"></a><span id="l18.332" class="difflineplus">+</span>
<a href="#l18.333"></a><span id="l18.333" class="difflineplus">+          this.glodaCompleter =</span>
<a href="#l18.334"></a><span id="l18.334" class="difflineplus">+            Components.classes[&quot;@mozilla.org/autocomplete/search;1?name=gloda&quot;]</span>
<a href="#l18.335"></a><span id="l18.335" class="difflineplus">+                      .getService()</span>
<a href="#l18.336"></a><span id="l18.336" class="difflineplus">+                      .wrappedJSObject;</span>
<a href="#l18.337"></a><span id="l18.337" class="difflineplus">+</span>
<a href="#l18.338"></a><span id="l18.338" class="difflineplus">+          var observerSvc = Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l18.339"></a><span id="l18.339" class="difflineplus">+                            .getService(Ci.nsIObserverService);</span>
<a href="#l18.340"></a><span id="l18.340" class="difflineplus">+          observerSvc.addObserver(this, &quot;autocomplete-did-enter-text&quot;, false);</span>
<a href="#l18.341"></a><span id="l18.341" class="difflineplus">+</span>
<a href="#l18.342"></a><span id="l18.342" class="difflineplus">+          this.quickSearchStrings =</span>
<a href="#l18.343"></a><span id="l18.343" class="difflineplus">+            new StringBundle(</span>
<a href="#l18.344"></a><span id="l18.344" class="difflineplus">+              &quot;chrome://messenger/locale/quickSearch.properties&quot;);</span>
<a href="#l18.345"></a><span id="l18.345"> </span>
<a href="#l18.346"></a><span id="l18.346" class="difflineminus">-  &lt;binding id=&quot;searchbar&quot; extends=&quot;chrome://global/content/bindings/textbox.xml#timed-textbox&quot;&gt;</span>
<a href="#l18.347"></a><span id="l18.347" class="difflineminus">-    &lt;resources&gt;</span>
<a href="#l18.348"></a><span id="l18.348" class="difflineminus">-      &lt;stylesheet src=&quot;chrome://messenger/skin/searchBox.css&quot;/&gt;</span>
<a href="#l18.349"></a><span id="l18.349" class="difflineminus">-    &lt;/resources&gt;</span>
<a href="#l18.350"></a><span id="l18.350" class="difflineminus">-    &lt;content&gt; </span>
<a href="#l18.351"></a><span id="l18.351" class="difflineminus">-      &lt;children/&gt;</span>
<a href="#l18.352"></a><span id="l18.352" class="difflineminus">-      &lt;xul:hbox class=&quot;quick-search-textbox textbox-input-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l18.353"></a><span id="l18.353" class="difflineminus">-        &lt;html:input class=&quot;textbox-input&quot; flex=&quot;1&quot; anonid=&quot;input&quot; allowevents=&quot;true&quot;</span>
<a href="#l18.354"></a><span id="l18.354" class="difflineminus">-                    xbl:inherits=&quot;onfocus,onblur,value,type,maxlength,disabled,size,readonly,tabindex,accesskey&quot;/&gt;</span>
<a href="#l18.355"></a><span id="l18.355" class="difflineminus">-      &lt;/xul:hbox&gt;</span>
<a href="#l18.356"></a><span id="l18.356" class="difflineminus">-      &lt;xul:toolbarbutton id=&quot;quick-search-clearbutton&quot; xbl:inherits=&quot;&quot;</span>
<a href="#l18.357"></a><span id="l18.357" class="difflineminus">-                         disabled=&quot;true&quot; class=&quot;quick-search-clearbutton&quot;</span>
<a href="#l18.358"></a><span id="l18.358" class="difflineminus">-                         onclick=&quot;onClearSearch(); return false;&quot;</span>
<a href="#l18.359"></a><span id="l18.359" class="difflineminus">-                         chromedir=&quot;&amp;locale.dir;&quot;/&gt;</span>
<a href="#l18.360"></a><span id="l18.360" class="difflineminus">-    &lt;/content&gt;</span>
<a href="#l18.361"></a><span id="l18.361" class="difflineplus">+          let quickSearchModes = QuickSearchManager.getSearchModes();</span>
<a href="#l18.362"></a><span id="l18.362" class="difflineplus">+          for (let i = 0; i &lt; quickSearchModes.length; i++) {</span>
<a href="#l18.363"></a><span id="l18.363" class="difflineplus">+            let searchMode = quickSearchModes[i];</span>
<a href="#l18.364"></a><span id="l18.364" class="difflineplus">+            let value = searchMode[&quot;value&quot;];</span>
<a href="#l18.365"></a><span id="l18.365" class="difflineplus">+            let label = searchMode[&quot;label&quot;];</span>
<a href="#l18.366"></a><span id="l18.366" class="difflineplus">+            let menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l18.367"></a><span id="l18.367" class="difflineplus">+            menuitem.setAttribute(&quot;value&quot;, value.toString());</span>
<a href="#l18.368"></a><span id="l18.368" class="difflineplus">+            menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l18.369"></a><span id="l18.369" class="difflineplus">+            menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l18.370"></a><span id="l18.370" class="difflineplus">+            menuitem.setAttribute(&quot;quicksearchOnly&quot;, &quot;true&quot;);</span>
<a href="#l18.371"></a><span id="l18.371" class="difflineplus">+            menuitem.setAttribute(&quot;oncommand&quot;,</span>
<a href="#l18.372"></a><span id="l18.372" class="difflineplus">+              &quot;this.parentNode.parentNode.parentNode.changeMode(this)&quot;);</span>
<a href="#l18.373"></a><span id="l18.373" class="difflineplus">+            this.menupopup.appendChild(menuitem);</span>
<a href="#l18.374"></a><span id="l18.374" class="difflineplus">+          }</span>
<a href="#l18.375"></a><span id="l18.375" class="difflineplus">+</span>
<a href="#l18.376"></a><span id="l18.376" class="difflineplus">+          let separator = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l18.377"></a><span id="l18.377" class="difflineplus">+          separator.setAttribute(&quot;quicksearchOnly&quot;, &quot;true&quot;);</span>
<a href="#l18.378"></a><span id="l18.378" class="difflineplus">+          this.menupopup.appendChild(separator);</span>
<a href="#l18.379"></a><span id="l18.379"> </span>
<a href="#l18.380"></a><span id="l18.380" class="difflineminus">-    &lt;implementation&gt;</span>
<a href="#l18.381"></a><span id="l18.381" class="difflineminus">-      &lt;constructor&gt;</span>
<a href="#l18.382"></a><span id="l18.382" class="difflineplus">+          let saveAsVF = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l18.383"></a><span id="l18.383" class="difflineplus">+          saveAsVF.setAttribute(&quot;anonid&quot;,</span>
<a href="#l18.384"></a><span id="l18.384" class="difflineplus">+                                &quot;quick-search-save-as-virtual-folder&quot;);</span>
<a href="#l18.385"></a><span id="l18.385" class="difflineplus">+          saveAsVF.setAttribute(&quot;label&quot;,</span>
<a href="#l18.386"></a><span id="l18.386" class="difflineplus">+            this.quickSearchStrings.get(&quot;saveAsVirtualFolder.label&quot;));</span>
<a href="#l18.387"></a><span id="l18.387" class="difflineplus">+          saveAsVF.setAttribute(&quot;quicksearchOnly&quot;, &quot;true&quot;);</span>
<a href="#l18.388"></a><span id="l18.388" class="difflineplus">+          saveAsVF.setAttribute(&quot;oncommand&quot;,</span>
<a href="#l18.389"></a><span id="l18.389" class="difflineplus">+            &quot;gFolderTreeController.newVirtualFolder(\</span>
<a href="#l18.390"></a><span id="l18.390" class="difflineplus">+              this.parentNode.parentNode.parentNode.value,\</span>
<a href="#l18.391"></a><span id="l18.391" class="difflineplus">+              gFolderDisplay.view.search.session.searchTerms);&quot;);</span>
<a href="#l18.392"></a><span id="l18.392" class="difflineplus">+          this.menupopup.appendChild(saveAsVF);</span>
<a href="#l18.393"></a><span id="l18.393" class="difflineplus">+</span>
<a href="#l18.394"></a><span id="l18.394" class="difflineplus">+          this.updateSaveItem();</span>
<a href="#l18.395"></a><span id="l18.395" class="difflineplus">+          this.input = &quot;&quot;;</span>
<a href="#l18.396"></a><span id="l18.396" class="difflineplus">+          this.glodaEnabled =</span>
<a href="#l18.397"></a><span id="l18.397" class="difflineplus">+            prefBranch.getBoolPref(&quot;mailnews.database.global.indexer.enabled&quot;);</span>
<a href="#l18.398"></a><span id="l18.398" class="difflineplus">+          this.searchMode = this.glodaEnabled ? &quot;global&quot; :</span>
<a href="#l18.399"></a><span id="l18.399" class="difflineplus">+            quickSearchModes[QuickSearchConstants.kQuickSearchFromOrSubject]</span>
<a href="#l18.400"></a><span id="l18.400" class="difflineplus">+              .value.toString();</span>
<a href="#l18.401"></a><span id="l18.401" class="difflineplus">+        } catch (e) {</span>
<a href="#l18.402"></a><span id="l18.402" class="difflineplus">+          logException(e, true);</span>
<a href="#l18.403"></a><span id="l18.403" class="difflineplus">+        }</span>
<a href="#l18.404"></a><span id="l18.404" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l18.405"></a><span id="l18.405" class="difflineplus">+</span>
<a href="#l18.406"></a><span id="l18.406" class="difflineplus">+      &lt;destructor&gt;</span>
<a href="#l18.407"></a><span id="l18.407">         &lt;![CDATA[</span>
<a href="#l18.408"></a><span id="l18.408" class="difflineminus">-          let qsmenu = document.getElementById(&quot;quick-search-menupopup&quot;);</span>
<a href="#l18.409"></a><span id="l18.409" class="difflineminus">-          if (!qsmenu)</span>
<a href="#l18.410"></a><span id="l18.410" class="difflineminus">-            return; // no quick search item in scope</span>
<a href="#l18.411"></a><span id="l18.411" class="difflineplus">+          var prefBranch =</span>
<a href="#l18.412"></a><span id="l18.412" class="difflineplus">+              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l18.413"></a><span id="l18.413" class="difflineplus">+              getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l18.414"></a><span id="l18.414" class="difflineplus">+          prefBranch.removeObserver(&quot;mailnews.database.global.indexer.enabled&quot;,</span>
<a href="#l18.415"></a><span id="l18.415" class="difflineplus">+                                    this._prefObserver);</span>
<a href="#l18.416"></a><span id="l18.416" class="difflineplus">+        ]]&gt;</span>
<a href="#l18.417"></a><span id="l18.417" class="difflineplus">+      &lt;/destructor&gt;</span>
<a href="#l18.418"></a><span id="l18.418"> </span>
<a href="#l18.419"></a><span id="l18.419" class="difflineminus">-          // Initialize the quick search mode based on the checked menu item.</span>
<a href="#l18.420"></a><span id="l18.420" class="difflineminus">-          // (getAttribute returns a string so &quot;0&quot; is still true...)</span>
<a href="#l18.421"></a><span id="l18.421" class="difflineminus">-          this.mQuickSearchMode =</span>
<a href="#l18.422"></a><span id="l18.422" class="difflineminus">-            qsmenu.getAttribute('value') ||</span>
<a href="#l18.423"></a><span id="l18.423" class="difflineminus">-            QuickSearchConstants.kQuickSearchFromOrSubject.toString();</span>
<a href="#l18.424"></a><span id="l18.424" class="difflineminus">-</span>
<a href="#l18.425"></a><span id="l18.425" class="difflineminus">-          var selectedMenuItem =</span>
<a href="#l18.426"></a><span id="l18.426" class="difflineminus">-            qsmenu.getElementsByAttribute('value', this.mQuickSearchMode)[0];</span>
<a href="#l18.427"></a><span id="l18.427" class="difflineminus">-</span>
<a href="#l18.428"></a><span id="l18.428" class="difflineminus">-          if (!selectedMenuItem) {</span>
<a href="#l18.429"></a><span id="l18.429" class="difflineminus">-            // We didn't expect this, try and fix it.</span>
<a href="#l18.430"></a><span id="l18.430" class="difflineminus">-            // Error condition, something went wrong - try and recover from it.</span>
<a href="#l18.431"></a><span id="l18.431" class="difflineminus">-            this.mQuickSearchMode =</span>
<a href="#l18.432"></a><span id="l18.432" class="difflineminus">-              QuickSearchConstants.kQuickSearchFromOrSubject.toString();</span>
<a href="#l18.433"></a><span id="l18.433" class="difflineplus">+      &lt;field name=&quot;_prefObserver&quot;&gt;({</span>
<a href="#l18.434"></a><span id="l18.434" class="difflineplus">+        inputSearch: this,</span>
<a href="#l18.435"></a><span id="l18.435" class="difflineplus">+        observe: function(subject, topic, data)</span>
<a href="#l18.436"></a><span id="l18.436" class="difflineplus">+        {</span>
<a href="#l18.437"></a><span id="l18.437" class="difflineplus">+          if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l18.438"></a><span id="l18.438" class="difflineplus">+            subject.QueryInterface(Components.interfaces.nsIPrefBranch);</span>
<a href="#l18.439"></a><span id="l18.439" class="difflineplus">+            switch (data) {</span>
<a href="#l18.440"></a><span id="l18.440" class="difflineplus">+            case &quot;mailnews.database.global.indexer.enabled&quot;:</span>
<a href="#l18.441"></a><span id="l18.441" class="difflineplus">+              this.inputSearch.glodaEnabled =</span>
<a href="#l18.442"></a><span id="l18.442" class="difflineplus">+                gPrefBranch.getBoolPref(</span>
<a href="#l18.443"></a><span id="l18.443" class="difflineplus">+                  &quot;mailnews.database.global.indexer.enabled&quot;);</span>
<a href="#l18.444"></a><span id="l18.444" class="difflineplus">+              let quickSearchModes = QuickSearchManager.getSearchModes();</span>
<a href="#l18.445"></a><span id="l18.445" class="difflineplus">+              this.inputSearch.searchMode = this.inputSearch.glodaEnabled ?</span>
<a href="#l18.446"></a><span id="l18.446" class="difflineplus">+                &quot;global&quot; :</span>
<a href="#l18.447"></a><span id="l18.447" class="difflineplus">+                quickSearchModes[QuickSearchConstants.kQuickSearchFromOrSubject]</span>
<a href="#l18.448"></a><span id="l18.448" class="difflineplus">+                  .value.toString();</span>
<a href="#l18.449"></a><span id="l18.449" class="difflineplus">+              break;</span>
<a href="#l18.450"></a><span id="l18.450" class="difflineplus">+            }</span>
<a href="#l18.451"></a><span id="l18.451" class="difflineplus">+          }</span>
<a href="#l18.452"></a><span id="l18.452" class="difflineplus">+        },</span>
<a href="#l18.453"></a><span id="l18.453"> </span>
<a href="#l18.454"></a><span id="l18.454" class="difflineminus">-            selectedMenuItem =</span>
<a href="#l18.455"></a><span id="l18.455" class="difflineminus">-              qsmenu.getElementsByAttribute('value', this.searchMode)[0];</span>
<a href="#l18.456"></a><span id="l18.456" class="difflineplus">+        QueryInterface: function(aIID)</span>
<a href="#l18.457"></a><span id="l18.457" class="difflineplus">+        {</span>
<a href="#l18.458"></a><span id="l18.458" class="difflineplus">+          if (aIID.equals(Components.interfaces.nsIObserver) ||</span>
<a href="#l18.459"></a><span id="l18.459" class="difflineplus">+              aIID.equals(Components.interfaces.nsISupports))</span>
<a href="#l18.460"></a><span id="l18.460" class="difflineplus">+            return this;</span>
<a href="#l18.461"></a><span id="l18.461" class="difflineplus">+          throw Components.results.NS_NOINTERFACE;</span>
<a href="#l18.462"></a><span id="l18.462" class="difflineplus">+        }</span>
<a href="#l18.463"></a><span id="l18.463" class="difflineplus">+        });</span>
<a href="#l18.464"></a><span id="l18.464" class="difflineplus">+      &lt;/field&gt;</span>
<a href="#l18.465"></a><span id="l18.465" class="difflineplus">+      &lt;field name=&quot;timeout&quot;&gt;200&lt;/field&gt;</span>
<a href="#l18.466"></a><span id="l18.466" class="difflineplus">+      &lt;field name=&quot;glodaCompleter&quot;&gt;null&lt;/field&gt;</span>
<a href="#l18.467"></a><span id="l18.467" class="difflineplus">+      &lt;field name=&quot;ignoreClick&quot;&gt;false&lt;/field&gt;</span>
<a href="#l18.468"></a><span id="l18.468" class="difflineplus">+      &lt;field name=&quot;quickSearchStrings&quot;&gt;null&lt;/field&gt;</span>
<a href="#l18.469"></a><span id="l18.469" class="difflineplus">+      &lt;field name=&quot;mQuickSearchMode&quot;&gt;null&lt;/field&gt;</span>
<a href="#l18.470"></a><span id="l18.470" class="difflineplus">+      &lt;field name=&quot;timeoutHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l18.471"></a><span id="l18.471" class="difflineplus">+      &lt;property name=&quot;searchMode&quot;&gt;</span>
<a href="#l18.472"></a><span id="l18.472" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l18.473"></a><span id="l18.473" class="difflineplus">+          return this.mQuickSearchMode;</span>
<a href="#l18.474"></a><span id="l18.474" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l18.475"></a><span id="l18.475" class="difflineplus">+        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l18.476"></a><span id="l18.476" class="difflineplus">+          this.mQuickSearchMode = val;</span>
<a href="#l18.477"></a><span id="l18.477" class="difflineplus">+          this.menupopup.setAttribute('value', val);</span>
<a href="#l18.478"></a><span id="l18.478" class="difflineplus">+          let tabmail = document.getElementById('tabmail');</span>
<a href="#l18.479"></a><span id="l18.479" class="difflineplus">+          if (tabmail) { /* if not in the customize toolbar */</span>
<a href="#l18.480"></a><span id="l18.480" class="difflineplus">+            let currentTabInfo = tabmail.currentTabInfo;</span>
<a href="#l18.481"></a><span id="l18.481" class="difflineplus">+            this.menupopup.getElementsByAttribute('value', this.searchMode)[0]</span>
<a href="#l18.482"></a><span id="l18.482" class="difflineplus">+                          .setAttribute('checked', 'true');</span>
<a href="#l18.483"></a><span id="l18.483" class="difflineplus">+            if (currentTabInfo)</span>
<a href="#l18.484"></a><span id="l18.484" class="difflineplus">+               currentTabInfo.searchState = this.state;</span>
<a href="#l18.485"></a><span id="l18.485" class="difflineplus">+            this.updateEmptyText();</span>
<a href="#l18.486"></a><span id="l18.486">           }</span>
<a href="#l18.487"></a><span id="l18.487" class="difflineminus">-          selectedMenuItem.setAttribute('checked', 'true');</span>
<a href="#l18.488"></a><span id="l18.488" class="difflineplus">+        ]]&gt;&lt;/setter&gt;</span>
<a href="#l18.489"></a><span id="l18.489" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l18.490"></a><span id="l18.490" class="difflineplus">+      &lt;field name=&quot;_glodaEnabled&quot;/&gt;</span>
<a href="#l18.491"></a><span id="l18.491" class="difflineplus">+      &lt;property name=&quot;glodaEnabled&quot;&gt;</span>
<a href="#l18.492"></a><span id="l18.492" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l18.493"></a><span id="l18.493" class="difflineplus">+          return this._glodaEnabled</span>
<a href="#l18.494"></a><span id="l18.494" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l18.495"></a><span id="l18.495" class="difflineplus">+        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l18.496"></a><span id="l18.496" class="difflineplus">+          try {</span>
<a href="#l18.497"></a><span id="l18.497" class="difflineplus">+            this.showGlodaItems(val); this._glodaEnabled = val;</span>
<a href="#l18.498"></a><span id="l18.498" class="difflineplus">+          } catch(e) {</span>
<a href="#l18.499"></a><span id="l18.499" class="difflineplus">+            logException(e);</span>
<a href="#l18.500"></a><span id="l18.500" class="difflineplus">+          }</span>
<a href="#l18.501"></a><span id="l18.501" class="difflineplus">+        ]]&gt;&lt;/setter&gt;</span>
<a href="#l18.502"></a><span id="l18.502" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l18.503"></a><span id="l18.503" class="difflineplus">+      &lt;property name=&quot;autocompletePopup&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l18.504"></a><span id="l18.504" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l18.505"></a><span id="l18.505" class="difflineplus">+          return document.getElementById(</span>
<a href="#l18.506"></a><span id="l18.506" class="difflineplus">+                   this.getAttribute('autocompletepopup'));</span>
<a href="#l18.507"></a><span id="l18.507" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l18.508"></a><span id="l18.508" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l18.509"></a><span id="l18.509" class="difflineplus">+      &lt;property name=&quot;showingSearchCriteria&quot;&gt;</span>
<a href="#l18.510"></a><span id="l18.510" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l18.511"></a><span id="l18.511" class="difflineplus">+          return this.getAttribute('searchCriteria') == 'true';</span>
<a href="#l18.512"></a><span id="l18.512" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l18.513"></a><span id="l18.513" class="difflineplus">+        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l18.514"></a><span id="l18.514" class="difflineplus">+          this.setAttribute('searchCriteria', val); return val;</span>
<a href="#l18.515"></a><span id="l18.515" class="difflineplus">+        ]]&gt;&lt;/setter&gt;</span>
<a href="#l18.516"></a><span id="l18.516" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l18.517"></a><span id="l18.517" class="difflineplus">+      &lt;property name=&quot;menupopup&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l18.518"></a><span id="l18.518" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l18.519"></a><span id="l18.519" class="difflineplus">+          return document.getAnonymousElementByAttribute(</span>
<a href="#l18.520"></a><span id="l18.520" class="difflineplus">+                   this, 'anonid', 'quick-search-menupopup');</span>
<a href="#l18.521"></a><span id="l18.521" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l18.522"></a><span id="l18.522" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l18.523"></a><span id="l18.523" class="difflineplus">+      &lt;property name=&quot;saveAsVirtualFolder&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l18.524"></a><span id="l18.524" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l18.525"></a><span id="l18.525" class="difflineplus">+          return document.getAnonymousElementByAttribute(</span>
<a href="#l18.526"></a><span id="l18.526" class="difflineplus">+                   this, 'anonid', 'quick-search-save-as-virtual-folder');</span>
<a href="#l18.527"></a><span id="l18.527" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l18.528"></a><span id="l18.528" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l18.529"></a><span id="l18.529" class="difflineplus">+      &lt;property name=&quot;clearButtonHidden&quot;&gt;</span>
<a href="#l18.530"></a><span id="l18.530" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l18.531"></a><span id="l18.531" class="difflineplus">+          return document.getAnonymousElementByAttribute(</span>
<a href="#l18.532"></a><span id="l18.532" class="difflineplus">+                            this, 'anonid', 'quick-search-clearbutton')</span>
<a href="#l18.533"></a><span id="l18.533" class="difflineplus">+                         .getAttribute('clearButtonHidden') == 'true';</span>
<a href="#l18.534"></a><span id="l18.534" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l18.535"></a><span id="l18.535" class="difflineplus">+        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l18.536"></a><span id="l18.536" class="difflineplus">+          document.getAnonymousElementByAttribute(</span>
<a href="#l18.537"></a><span id="l18.537" class="difflineplus">+                     this, 'anonid', 'quick-search-clearbutton')</span>
<a href="#l18.538"></a><span id="l18.538" class="difflineplus">+                  .setAttribute('clearButtonHidden', val);</span>
<a href="#l18.539"></a><span id="l18.539" class="difflineplus">+          return val;</span>
<a href="#l18.540"></a><span id="l18.540" class="difflineplus">+        ]]&gt;&lt;/setter&gt;</span>
<a href="#l18.541"></a><span id="l18.541" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l18.542"></a><span id="l18.542"> </span>
<a href="#l18.543"></a><span id="l18.543" class="difflineminus">-          this.setSearchCriteriaText();</span>
<a href="#l18.544"></a><span id="l18.544" class="difflineminus">-        ]]&gt;</span>
<a href="#l18.545"></a><span id="l18.545" class="difflineminus">-      &lt;/constructor&gt;</span>
<a href="#l18.546"></a><span id="l18.546" class="difflineminus">-</span>
<a href="#l18.547"></a><span id="l18.547" class="difflineminus">-      &lt;property name=&quot;showingSearchCriteria&quot; onget=&quot;return this.getAttribute('searchCriteria') == 'true';&quot;</span>
<a href="#l18.548"></a><span id="l18.548" class="difflineminus">-                onset=&quot;this.setAttribute('searchCriteria', val); return val;&quot;/&gt;</span>
<a href="#l18.549"></a><span id="l18.549" class="difflineminus">-</span>
<a href="#l18.550"></a><span id="l18.550" class="difflineminus">-      &lt;property name=&quot;clearButtonHidden&quot; onget=&quot;return document.getElementById('quick-search-clearbutton').getAttribute('clearButtonHidden') == 'true';&quot;</span>
<a href="#l18.551"></a><span id="l18.551" class="difflineminus">-                onset=&quot;document.getElementById('quick-search-clearbutton').setAttribute('clearButtonHidden', val); return val;&quot;/&gt;</span>
<a href="#l18.552"></a><span id="l18.552" class="difflineminus">-</span>
<a href="#l18.553"></a><span id="l18.553" class="difflineminus">-      &lt;field name=&quot;mQuickSearchMode&quot;&gt;null&lt;/field&gt;</span>
<a href="#l18.554"></a><span id="l18.554" class="difflineplus">+      &lt;property name=&quot;state&quot;&gt;</span>
<a href="#l18.555"></a><span id="l18.555" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l18.556"></a><span id="l18.556" class="difflineplus">+          return {</span>
<a href="#l18.557"></a><span id="l18.557" class="difflineplus">+            'mode': this.searchMode,</span>
<a href="#l18.558"></a><span id="l18.558" class="difflineplus">+            'string': this.value</span>
<a href="#l18.559"></a><span id="l18.559" class="difflineplus">+          };</span>
<a href="#l18.560"></a><span id="l18.560" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l18.561"></a><span id="l18.561" class="difflineplus">+        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l18.562"></a><span id="l18.562" class="difflineplus">+          this.searchMode = val['mode'];</span>
<a href="#l18.563"></a><span id="l18.563" class="difflineplus">+          this.value = val['string'];</span>
<a href="#l18.564"></a><span id="l18.564" class="difflineplus">+        ]]&gt;&lt;/setter&gt;</span>
<a href="#l18.565"></a><span id="l18.565" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l18.566"></a><span id="l18.566"> </span>
<a href="#l18.567"></a><span id="l18.567">       // DND Observer</span>
<a href="#l18.568"></a><span id="l18.568">       &lt;field name=&quot;searchInputDNDObserver&quot; readonly=&quot;true&quot;&gt;&lt;![CDATA[</span>
<a href="#l18.569"></a><span id="l18.569">       ({</span>
<a href="#l18.570"></a><span id="l18.570">         inputSearch: this,</span>
<a href="#l18.571"></a><span id="l18.571"> </span>
<a href="#l18.572"></a><span id="l18.572" class="difflineminus">-        onDrop: function (aEvent, aXferData, aDragSession)</span>
<a href="#l18.573"></a><span id="l18.573" class="difflineminus">-        {</span>
<a href="#l18.574"></a><span id="l18.574" class="difflineminus">-          if (aXferData.data) {</span>
<a href="#l18.575"></a><span id="l18.575" class="difflineminus">-            this.inputSearch.focus();</span>
<a href="#l18.576"></a><span id="l18.576" class="difflineminus">-            this.inputSearch.value = aXferData.data;</span>
<a href="#l18.577"></a><span id="l18.577" class="difflineminus">-            this.inputSearch.clearButtonHidden = false;</span>
<a href="#l18.578"></a><span id="l18.578" class="difflineminus">-            onSearchInput(true);</span>
<a href="#l18.579"></a><span id="l18.579" class="difflineplus">+        onDrop: function (aEvent, aXferData, aDragSession) {</span>
<a href="#l18.580"></a><span id="l18.580" class="difflineplus">+          try {</span>
<a href="#l18.581"></a><span id="l18.581" class="difflineplus">+            if (aXferData.data) {</span>
<a href="#l18.582"></a><span id="l18.582" class="difflineplus">+              this.inputSearch.focus();</span>
<a href="#l18.583"></a><span id="l18.583" class="difflineplus">+              this.inputSearch.value = aXferData.data;</span>
<a href="#l18.584"></a><span id="l18.584" class="difflineplus">+              // XXX for some reason the input field is _cleared_ even though</span>
<a href="#l18.585"></a><span id="l18.585" class="difflineplus">+              // the search works.</span>
<a href="#l18.586"></a><span id="l18.586" class="difflineplus">+              this.inputSearch.doSearch();</span>
<a href="#l18.587"></a><span id="l18.587" class="difflineplus">+            }</span>
<a href="#l18.588"></a><span id="l18.588" class="difflineplus">+          } catch (e) {</span>
<a href="#l18.589"></a><span id="l18.589" class="difflineplus">+            logException(e);</span>
<a href="#l18.590"></a><span id="l18.590">           }</span>
<a href="#l18.591"></a><span id="l18.591">         },</span>
<a href="#l18.592"></a><span id="l18.592"> </span>
<a href="#l18.593"></a><span id="l18.593" class="difflineminus">-        getSupportedFlavours: function ()</span>
<a href="#l18.594"></a><span id="l18.594" class="difflineminus">-        {</span>
<a href="#l18.595"></a><span id="l18.595" class="difflineplus">+        getSupportedFlavours: function () {</span>
<a href="#l18.596"></a><span id="l18.596">           var flavourSet = new FlavourSet();</span>
<a href="#l18.597"></a><span id="l18.597">           flavourSet.appendFlavour(&quot;text/unicode&quot;);</span>
<a href="#l18.598"></a><span id="l18.598">           return flavourSet;</span>
<a href="#l18.599"></a><span id="l18.599">         }</span>
<a href="#l18.600"></a><span id="l18.600">       })</span>
<a href="#l18.601"></a><span id="l18.601">       ]]&gt;&lt;/field&gt;</span>
<a href="#l18.602"></a><span id="l18.602"> </span>
<a href="#l18.603"></a><span id="l18.603" class="difflineminus">-      &lt;property name=&quot;searchMode&quot; onget=&quot;return this.mQuickSearchMode;&quot;</span>
<a href="#l18.604"></a><span id="l18.604" class="difflineminus">-                onset=&quot;this.mQuickSearchMode = val; document.getElementById('quick-search-menupopup').setAttribute('value', val);&quot;/&gt;</span>
<a href="#l18.605"></a><span id="l18.605" class="difflineminus">-</span>
<a href="#l18.606"></a><span id="l18.606" class="difflineminus">-      &lt;method name=&quot;setSearchCriteriaText&quot;&gt;</span>
<a href="#l18.607"></a><span id="l18.607" class="difflineplus">+      &lt;method name=&quot;onTimeout&quot;&gt;</span>
<a href="#l18.608"></a><span id="l18.608" class="difflineplus">+        &lt;parameter name=&quot;dis&quot;/&gt;</span>
<a href="#l18.609"></a><span id="l18.609" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.610"></a><span id="l18.610" class="difflineplus">+        try {</span>
<a href="#l18.611"></a><span id="l18.611" class="difflineplus">+          dis.doSearch();</span>
<a href="#l18.612"></a><span id="l18.612" class="difflineplus">+        } catch (e) {</span>
<a href="#l18.613"></a><span id="l18.613" class="difflineplus">+          logException(e);</span>
<a href="#l18.614"></a><span id="l18.614" class="difflineplus">+        }</span>
<a href="#l18.615"></a><span id="l18.615" class="difflineplus">+        ]]&gt;</span>
<a href="#l18.616"></a><span id="l18.616" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l18.617"></a><span id="l18.617" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l18.618"></a><span id="l18.618" class="difflineplus">+      &lt;method name=&quot;updatePopup&quot;&gt;</span>
<a href="#l18.619"></a><span id="l18.619">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.620"></a><span id="l18.620" class="difflineminus">-          this.showingSearchCriteria = true;</span>
<a href="#l18.621"></a><span id="l18.621" class="difflineminus">-</span>
<a href="#l18.622"></a><span id="l18.622" class="difflineminus">-          let qsmenu = document.getElementById('quick-search-menupopup');</span>
<a href="#l18.623"></a><span id="l18.623" class="difflineplus">+        try {</span>
<a href="#l18.624"></a><span id="l18.624" class="difflineplus">+          // disable the create virtual folder menu item if the current radio</span>
<a href="#l18.625"></a><span id="l18.625" class="difflineplus">+          // value is set to Find in message since you can't really  create a VF from find</span>
<a href="#l18.626"></a><span id="l18.626" class="difflineplus">+          // in message</span>
<a href="#l18.627"></a><span id="l18.627" class="difflineplus">+          if (this.searchMode == &quot;global&quot; || this.value == &quot;&quot;)</span>
<a href="#l18.628"></a><span id="l18.628" class="difflineplus">+            this.saveAsVirtualFolder.setAttribute('disabled', 'true');</span>
<a href="#l18.629"></a><span id="l18.629" class="difflineplus">+          else</span>
<a href="#l18.630"></a><span id="l18.630" class="difflineplus">+            this.saveAsVirtualFolder.removeAttribute('disabled');</span>
<a href="#l18.631"></a><span id="l18.631"> </span>
<a href="#l18.632"></a><span id="l18.632" class="difflineminus">-          // extract the label value from the menu item</span>
<a href="#l18.633"></a><span id="l18.633" class="difflineminus">-          let menuItem = qsmenu.getElementsByAttribute('value',</span>
<a href="#l18.634"></a><span id="l18.634" class="difflineminus">-                                                       this.searchMode)[0];</span>
<a href="#l18.635"></a><span id="l18.635" class="difflineplus">+          //let hideQuickSearchModes = this.searchMode == &quot;global&quot; ? &quot;true&quot; : &quot;false&quot;;</span>
<a href="#l18.636"></a><span id="l18.636" class="difflineplus">+          //for each (let child in this.menupopup.childNodes) {</span>
<a href="#l18.637"></a><span id="l18.637" class="difflineplus">+          //  if (child.hasAttribute(&quot;quicksearch&quot;)) {</span>
<a href="#l18.638"></a><span id="l18.638" class="difflineplus">+          //    child.setAttribute(&quot;collapsed&quot;, hideQuickSearchModes)</span>
<a href="#l18.639"></a><span id="l18.639" class="difflineplus">+          //  }</span>
<a href="#l18.640"></a><span id="l18.640" class="difflineplus">+          //}</span>
<a href="#l18.641"></a><span id="l18.641" class="difflineplus">+        } catch (e) {</span>
<a href="#l18.642"></a><span id="l18.642" class="difflineplus">+          logException(e);</span>
<a href="#l18.643"></a><span id="l18.643" class="difflineplus">+        }</span>
<a href="#l18.644"></a><span id="l18.644" class="difflineplus">+        ]]&gt;</span>
<a href="#l18.645"></a><span id="l18.645" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l18.646"></a><span id="l18.646" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l18.647"></a><span id="l18.647" class="difflineplus">+      &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l18.648"></a><span id="l18.648" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.649"></a><span id="l18.649" class="difflineplus">+</span>
<a href="#l18.650"></a><span id="l18.650" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l18.651"></a><span id="l18.651" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l18.652"></a><span id="l18.652"> </span>
<a href="#l18.653"></a><span id="l18.653" class="difflineminus">-          if (typeof menuItem == &quot;undefined&quot;) {</span>
<a href="#l18.654"></a><span id="l18.654" class="difflineminus">-            // Error condition, something went wrong - try and recover from it.</span>
<a href="#l18.655"></a><span id="l18.655" class="difflineminus">-            this.mQuickSearchMode =</span>
<a href="#l18.656"></a><span id="l18.656" class="difflineminus">-              QuickSearchConstants.kQuickSearchFromOrSubject.toString();</span>
<a href="#l18.657"></a><span id="l18.657" class="difflineplus">+      &lt;method name=&quot;observe&quot;&gt;</span>
<a href="#l18.658"></a><span id="l18.658" class="difflineplus">+      &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l18.659"></a><span id="l18.659" class="difflineplus">+      &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l18.660"></a><span id="l18.660" class="difflineplus">+      &lt;parameter name=&quot;aData&quot;/&gt;</span>
<a href="#l18.661"></a><span id="l18.661" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.662"></a><span id="l18.662" class="difflineplus">+        try {</span>
<a href="#l18.663"></a><span id="l18.663" class="difflineplus">+          if (aTopic == &quot;autocomplete-did-enter-text&quot;) {</span>
<a href="#l18.664"></a><span id="l18.664" class="difflineplus">+            let selectedIndex = this.autocompletePopup.selectedIndex;</span>
<a href="#l18.665"></a><span id="l18.665" class="difflineplus">+            let curResult = this.glodaCompleter.curResult;</span>
<a href="#l18.666"></a><span id="l18.666" class="difflineplus">+            if (! curResult)</span>
<a href="#l18.667"></a><span id="l18.667" class="difflineplus">+              return; // autocomplete didn't even finish.</span>
<a href="#l18.668"></a><span id="l18.668" class="difflineplus">+            let row = curResult.getObjectAt(selectedIndex);</span>
<a href="#l18.669"></a><span id="l18.669" class="difflineplus">+            if (row == null)</span>
<a href="#l18.670"></a><span id="l18.670" class="difflineplus">+              return;</span>
<a href="#l18.671"></a><span id="l18.671" class="difflineplus">+            let theQuery = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l18.672"></a><span id="l18.672" class="difflineplus">+            let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l18.673"></a><span id="l18.673" class="difflineplus">+            if (row.fullText) {</span>
<a href="#l18.674"></a><span id="l18.674" class="difflineplus">+              tabmail.openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l18.675"></a><span id="l18.675" class="difflineplus">+                searcher: new GlodaMsgSearcher(null, row.item, row.andTerms)</span>
<a href="#l18.676"></a><span id="l18.676" class="difflineplus">+              });</span>
<a href="#l18.677"></a><span id="l18.677" class="difflineplus">+            } else {</span>
<a href="#l18.678"></a><span id="l18.678" class="difflineplus">+              if (row.nounDef.name == &quot;tag&quot;) {</span>
<a href="#l18.679"></a><span id="l18.679" class="difflineplus">+                theQuery = theQuery.tags(row.item);</span>
<a href="#l18.680"></a><span id="l18.680" class="difflineplus">+              } else if (row.nounDef.name == &quot;identity&quot;) {</span>
<a href="#l18.681"></a><span id="l18.681" class="difflineplus">+                theQuery = theQuery.involves(row.item);</span>
<a href="#l18.682"></a><span id="l18.682" class="difflineplus">+              }</span>
<a href="#l18.683"></a><span id="l18.683" class="difflineplus">+              theQuery.orderBy('-date');</span>
<a href="#l18.684"></a><span id="l18.684" class="difflineplus">+              tabmail.openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l18.685"></a><span id="l18.685" class="difflineplus">+                query: theQuery</span>
<a href="#l18.686"></a><span id="l18.686" class="difflineplus">+              });</span>
<a href="#l18.687"></a><span id="l18.687" class="difflineplus">+            }</span>
<a href="#l18.688"></a><span id="l18.688" class="difflineplus">+          }</span>
<a href="#l18.689"></a><span id="l18.689" class="difflineplus">+        } catch (e) {</span>
<a href="#l18.690"></a><span id="l18.690" class="difflineplus">+          logException(e);</span>
<a href="#l18.691"></a><span id="l18.691" class="difflineplus">+        }</span>
<a href="#l18.692"></a><span id="l18.692" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l18.693"></a><span id="l18.693" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l18.694"></a><span id="l18.694"> </span>
<a href="#l18.695"></a><span id="l18.695" class="difflineminus">-            let selectedMenuItem =</span>
<a href="#l18.696"></a><span id="l18.696" class="difflineminus">-              qsmenu.getElementsByAttribute('value', this.searchMode)[0];</span>
<a href="#l18.697"></a><span id="l18.697" class="difflineplus">+      &lt;method name=&quot;updateEmptyText&quot;&gt;</span>
<a href="#l18.698"></a><span id="l18.698" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.699"></a><span id="l18.699" class="difflineplus">+        try {</span>
<a href="#l18.700"></a><span id="l18.700" class="difflineplus">+          // extract the label value from the menu item</span>
<a href="#l18.701"></a><span id="l18.701" class="difflineplus">+          let menuItem = this.menupopup.getElementsByAttribute('value',</span>
<a href="#l18.702"></a><span id="l18.702" class="difflineplus">+                          this.searchMode)[0];</span>
<a href="#l18.703"></a><span id="l18.703" class="difflineplus">+          this.emptyText = menuItem.getAttribute('label');</span>
<a href="#l18.704"></a><span id="l18.704" class="difflineplus">+        } catch (e) {</span>
<a href="#l18.705"></a><span id="l18.705" class="difflineplus">+          logException(e);</span>
<a href="#l18.706"></a><span id="l18.706" class="difflineplus">+        }</span>
<a href="#l18.707"></a><span id="l18.707" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l18.708"></a><span id="l18.708" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l18.709"></a><span id="l18.709"> </span>
<a href="#l18.710"></a><span id="l18.710" class="difflineminus">-            selectedMenuItem.setAttribute('checked', 'true');</span>
<a href="#l18.711"></a><span id="l18.711" class="difflineplus">+      &lt;method name=&quot;updateSaveItem&quot;&gt;</span>
<a href="#l18.712"></a><span id="l18.712" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.713"></a><span id="l18.713" class="difflineplus">+          let disabled = true;</span>
<a href="#l18.714"></a><span id="l18.714" class="difflineplus">+          this.saveAsVirtualFolder.setAttribute(&quot;disabled&quot;, disabled)</span>
<a href="#l18.715"></a><span id="l18.715" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l18.716"></a><span id="l18.716" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l18.717"></a><span id="l18.717" class="difflineplus">+</span>
<a href="#l18.718"></a><span id="l18.718" class="difflineplus">+</span>
<a href="#l18.719"></a><span id="l18.719" class="difflineplus">+      &lt;method name=&quot;doSearch&quot;&gt;</span>
<a href="#l18.720"></a><span id="l18.720" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.721"></a><span id="l18.721" class="difflineplus">+          try {</span>
<a href="#l18.722"></a><span id="l18.722" class="difflineplus">+            if (this.searchMode == 'global') // faceted search</span>
<a href="#l18.723"></a><span id="l18.723" class="difflineplus">+            {</span>
<a href="#l18.724"></a><span id="l18.724" class="difflineplus">+              if (this.value) {</span>
<a href="#l18.725"></a><span id="l18.725" class="difflineplus">+                let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l18.726"></a><span id="l18.726" class="difflineplus">+                // If the current tab is a gloda search tab, reset the value</span>
<a href="#l18.727"></a><span id="l18.727" class="difflineplus">+                //  to the initial search value.  Otherwise, clear it.  This</span>
<a href="#l18.728"></a><span id="l18.728" class="difflineplus">+                //  is the value that 3is going to be saved with the current</span>
<a href="#l18.729"></a><span id="l18.729" class="difflineplus">+                //  tab when we switch back to it next.</span>
<a href="#l18.730"></a><span id="l18.730" class="difflineplus">+                let searchString = this.value;</span>
<a href="#l18.731"></a><span id="l18.731"> </span>
<a href="#l18.732"></a><span id="l18.732" class="difflineminus">-            this.inputField.value = selectedMenuItem.getAttribute('label');</span>
<a href="#l18.733"></a><span id="l18.733" class="difflineplus">+                if (tabmail.currentTabInfo.mode.name == &quot;glodaFacet&quot;) {</span>
<a href="#l18.734"></a><span id="l18.734" class="difflineplus">+                  // we'd rather reuse the existing tab (and somehow do something</span>
<a href="#l18.735"></a><span id="l18.735" class="difflineplus">+                  // smart with any preexisting facet choices, but that's a</span>
<a href="#l18.736"></a><span id="l18.736" class="difflineplus">+                  // bit hard right now, so doing the cheap thing and closing</span>
<a href="#l18.737"></a><span id="l18.737" class="difflineplus">+                  // this tab and starting over</span>
<a href="#l18.738"></a><span id="l18.738" class="difflineplus">+                  tabmail.closeTab();</span>
<a href="#l18.739"></a><span id="l18.739" class="difflineplus">+                }</span>
<a href="#l18.740"></a><span id="l18.740" class="difflineplus">+                this.value = ''; // clear our value, to avoid persistence</span>
<a href="#l18.741"></a><span id="l18.741" class="difflineplus">+                tabmail.openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l18.742"></a><span id="l18.742" class="difflineplus">+                  searcher: new GlodaMsgSearcher(null, searchString)</span>
<a href="#l18.743"></a><span id="l18.743" class="difflineplus">+                });</span>
<a href="#l18.744"></a><span id="l18.744" class="difflineplus">+              }</span>
<a href="#l18.745"></a><span id="l18.745" class="difflineplus">+            } else { // quick search</span>
<a href="#l18.746"></a><span id="l18.746" class="difflineplus">+              if (!gFolderDisplay.view)</span>
<a href="#l18.747"></a><span id="l18.747" class="difflineplus">+                return;</span>
<a href="#l18.748"></a><span id="l18.748" class="difflineplus">+              if (! this.value)</span>
<a href="#l18.749"></a><span id="l18.749" class="difflineplus">+                gFolderDisplay.view.search.userTerms = null</span>
<a href="#l18.750"></a><span id="l18.750" class="difflineplus">+              else</span>
<a href="#l18.751"></a><span id="l18.751" class="difflineplus">+                gFolderDisplay.view.search.quickSearch(Number(this.searchMode), this.value);</span>
<a href="#l18.752"></a><span id="l18.752" class="difflineplus">+            }</span>
<a href="#l18.753"></a><span id="l18.753" class="difflineplus">+          } catch (e) {</span>
<a href="#l18.754"></a><span id="l18.754" class="difflineplus">+            logException(e);</span>
<a href="#l18.755"></a><span id="l18.755">           }</span>
<a href="#l18.756"></a><span id="l18.756" class="difflineminus">-          else</span>
<a href="#l18.757"></a><span id="l18.757" class="difflineminus">-            this.inputField.value = menuItem.getAttribute('label');</span>
<a href="#l18.758"></a><span id="l18.758" class="difflineplus">+        ]]&gt;</span>
<a href="#l18.759"></a><span id="l18.759" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l18.760"></a><span id="l18.760" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l18.761"></a><span id="l18.761"> </span>
<a href="#l18.762"></a><span id="l18.762" class="difflineminus">-         this.clearButtonHidden = true;</span>
<a href="#l18.763"></a><span id="l18.763" class="difflineplus">+      &lt;method name=&quot;changeMode&quot;&gt;</span>
<a href="#l18.764"></a><span id="l18.764" class="difflineplus">+      &lt;parameter name=&quot;aMenuItem&quot; /&gt;</span>
<a href="#l18.765"></a><span id="l18.765" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.766"></a><span id="l18.766" class="difflineplus">+          var oldSearchMode = this.searchMode;</span>
<a href="#l18.767"></a><span id="l18.767" class="difflineplus">+          this.searchMode = aMenuItem.value;</span>
<a href="#l18.768"></a><span id="l18.768" class="difflineplus">+          if (oldSearchMode != this.searchMode) // the search mode just changed so we need to redo the quick search</span>
<a href="#l18.769"></a><span id="l18.769" class="difflineplus">+            this.doSearch();</span>
<a href="#l18.770"></a><span id="l18.770">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.771"></a><span id="l18.771">       &lt;/method&gt;</span>
<a href="#l18.772"></a><span id="l18.772"> </span>
<a href="#l18.773"></a><span id="l18.773">       &lt;method name=&quot;openmenupopup&quot;&gt;</span>
<a href="#l18.774"></a><span id="l18.774">         &lt;body&gt;</span>
<a href="#l18.775"></a><span id="l18.775">           &lt;![CDATA[</span>
<a href="#l18.776"></a><span id="l18.776" class="difflineminus">-            document.getElementById('quick-search-menupopup').click();</span>
<a href="#l18.777"></a><span id="l18.777" class="difflineminus">-            return false;</span>
<a href="#l18.778"></a><span id="l18.778" class="difflineplus">+          try {</span>
<a href="#l18.779"></a><span id="l18.779" class="difflineplus">+            this.menupopup.click();</span>
<a href="#l18.780"></a><span id="l18.780" class="difflineplus">+          } catch (e) {</span>
<a href="#l18.781"></a><span id="l18.781" class="difflineplus">+            logException(e);</span>
<a href="#l18.782"></a><span id="l18.782" class="difflineplus">+          }</span>
<a href="#l18.783"></a><span id="l18.783" class="difflineplus">+          return false;</span>
<a href="#l18.784"></a><span id="l18.784" class="difflineplus">+          ]]&gt;</span>
<a href="#l18.785"></a><span id="l18.785" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l18.786"></a><span id="l18.786" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l18.787"></a><span id="l18.787" class="difflineplus">+</span>
<a href="#l18.788"></a><span id="l18.788" class="difflineplus">+</span>
<a href="#l18.789"></a><span id="l18.789" class="difflineplus">+      &lt;!--If switching from an &quot;incoming&quot; (Inbox, etc.) type of mail folder,--&gt;</span>
<a href="#l18.790"></a><span id="l18.790" class="difflineplus">+      &lt;!--to an &quot;outbound&quot; (Sent, Drafts etc.)  type, and the current search--&gt;</span>
<a href="#l18.791"></a><span id="l18.791" class="difflineplus">+      &lt;!--type contains 'Sender', then switch it to the equivalent--&gt;</span>
<a href="#l18.792"></a><span id="l18.792" class="difflineplus">+      &lt;!--'Recipient' search type by default. Vice versa when switching from--&gt;</span>
<a href="#l18.793"></a><span id="l18.793" class="difflineplus">+      &lt;!--outbound to incoming folder type.--&gt;</span>
<a href="#l18.794"></a><span id="l18.794" class="difflineplus">+      &lt;!--@param isOutboundFolder  Bool--&gt;</span>
<a href="#l18.795"></a><span id="l18.795" class="difflineplus">+      &lt;!--       true:  switch from an incoming to an outgoing folder--&gt;</span>
<a href="#l18.796"></a><span id="l18.796" class="difflineplus">+      &lt;!--       false: switch from an outgoing to an incoming folder--&gt;</span>
<a href="#l18.797"></a><span id="l18.797" class="difflineplus">+      &lt;method name=&quot;folderChanged&quot;&gt;</span>
<a href="#l18.798"></a><span id="l18.798" class="difflineplus">+        &lt;parameter name=&quot;isOutboundFolder&quot; /&gt;</span>
<a href="#l18.799"></a><span id="l18.799" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l18.800"></a><span id="l18.800" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l18.801"></a><span id="l18.801" class="difflineplus">+            let newSearchMode = null;</span>
<a href="#l18.802"></a><span id="l18.802" class="difflineplus">+            if (isOutboundFolder) {</span>
<a href="#l18.803"></a><span id="l18.803" class="difflineplus">+              if (this.searchMode == QuickSearchConstants.kQuickSearchFromOrSubject)</span>
<a href="#l18.804"></a><span id="l18.804" class="difflineplus">+                this.searchMode = QuickSearchConstants.kQuickSearchRecipientOrSubject;</span>
<a href="#l18.805"></a><span id="l18.805" class="difflineplus">+              else if (this.searchMode == QuickSearchConstants.kQuickSearchFrom)</span>
<a href="#l18.806"></a><span id="l18.806" class="difflineplus">+                this.searchMode = QuickSearchConstants.kQuickSearchRecipient;</span>
<a href="#l18.807"></a><span id="l18.807" class="difflineplus">+            } else {</span>
<a href="#l18.808"></a><span id="l18.808" class="difflineplus">+              if (this.searchMode == QuickSearchConstants.kQuickSearchRecipientOrSubject)</span>
<a href="#l18.809"></a><span id="l18.809" class="difflineplus">+                this.searchMode = QuickSearchConstants.kQuickSearchFromOrSubject;</span>
<a href="#l18.810"></a><span id="l18.810" class="difflineplus">+              else if (this.searchMode == QuickSearchConstants.kQuickSearchRecipient)</span>
<a href="#l18.811"></a><span id="l18.811" class="difflineplus">+                this.searchMode = QuickSearchConstants.kQuickSearchFrom;</span>
<a href="#l18.812"></a><span id="l18.812" class="difflineplus">+            }</span>
<a href="#l18.813"></a><span id="l18.813">           ]]&gt;</span>
<a href="#l18.814"></a><span id="l18.814">         &lt;/body&gt;</span>
<a href="#l18.815"></a><span id="l18.815">       &lt;/method&gt;</span>
<a href="#l18.816"></a><span id="l18.816" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l18.817"></a><span id="l18.817" class="difflineminus">-</span>
<a href="#l18.818"></a><span id="l18.818" class="difflineminus">-    &lt;handlers&gt;</span>
<a href="#l18.819"></a><span id="l18.819" class="difflineminus">-      &lt;handler event=&quot;input&quot;&gt;</span>
<a href="#l18.820"></a><span id="l18.820" class="difflineminus">-        &lt;![CDATA[ </span>
<a href="#l18.821"></a><span id="l18.821" class="difflineminus">-          if (!this.value) </span>
<a href="#l18.822"></a><span id="l18.822" class="difflineminus">-            this.clearButtonHidden = true;</span>
<a href="#l18.823"></a><span id="l18.823" class="difflineminus">-          else </span>
<a href="#l18.824"></a><span id="l18.824" class="difflineminus">-            this.clearButtonHidden = false;</span>
<a href="#l18.825"></a><span id="l18.825" class="difflineminus">-        ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.826"></a><span id="l18.826" class="difflineminus">-</span>
<a href="#l18.827"></a><span id="l18.827" class="difflineminus">-      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_UP&quot; modifiers=&quot;control&quot; phase=&quot;capturing&quot;&gt;</span>
<a href="#l18.828"></a><span id="l18.828" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l18.829"></a><span id="l18.829" class="difflineminus">-          var  menuPopup = document.getElementById('quick-search-menupopup');</span>
<a href="#l18.830"></a><span id="l18.830" class="difflineminus">-          var menuPopupValue = menuPopup.getAttribute('value');</span>
<a href="#l18.831"></a><span id="l18.831" class="difflineminus">-          var menuPopupOrdinal = menuPopup.getElementsByAttribute('value', menuPopupValue)[0].getAttribute('ordinal');</span>
<a href="#l18.832"></a><span id="l18.832" class="difflineminus">-          if (menuPopupOrdinal &gt; 0)</span>
<a href="#l18.833"></a><span id="l18.833" class="difflineminus">-          {</span>
<a href="#l18.834"></a><span id="l18.834" class="difflineminus">-            var nextMenuItem = menuPopup.getElementsByAttribute('ordinal', --menuPopupOrdinal)[0];</span>
<a href="#l18.835"></a><span id="l18.835" class="difflineminus">-            menuPopup.getElementsByAttribute('value', this.searchMode)[0].removeAttribute('checked');</span>
<a href="#l18.836"></a><span id="l18.836" class="difflineminus">-            this.searchMode = nextMenuItem.getAttribute('value');</span>
<a href="#l18.837"></a><span id="l18.837" class="difflineminus">-            nextMenuItem.setAttribute('checked', 'true');</span>
<a href="#l18.838"></a><span id="l18.838" class="difflineminus">-            menuPopup.setAttribute('value', this.searchMode);</span>
<a href="#l18.839"></a><span id="l18.839" class="difflineminus">-          }</span>
<a href="#l18.840"></a><span id="l18.840" class="difflineminus">-        ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.841"></a><span id="l18.841" class="difflineplus">+      &lt;!--</span>
<a href="#l18.842"></a><span id="l18.842" class="difflineplus">+        Called by the TabMonitor to make the quick search menu only show options that are relevant for a particular tab.</span>
<a href="#l18.843"></a><span id="l18.843" class="difflineplus">+        In particular, in faceted search results, no real mode choices are available.</span>
<a href="#l18.844"></a><span id="l18.844"> </span>
<a href="#l18.845"></a><span id="l18.845" class="difflineminus">-      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_DOWN&quot; modifiers=&quot;control&quot; phase=&quot;capturing&quot;&gt;</span>
<a href="#l18.846"></a><span id="l18.846" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l18.847"></a><span id="l18.847" class="difflineminus">-          var menuItemAfterOptions = document.getElementById('quickSearchAfterLastOptionSeparator');</span>
<a href="#l18.848"></a><span id="l18.848" class="difflineminus">-          var lastOrdinal = menuItemAfterOptions.getAttribute('ordinal') - 1;</span>
<a href="#l18.849"></a><span id="l18.849" class="difflineminus">-          var  menuPopup = document.getElementById('quick-search-menupopup');</span>
<a href="#l18.850"></a><span id="l18.850" class="difflineminus">-          var menuPopupValue = menuPopup.getAttribute('value');</span>
<a href="#l18.851"></a><span id="l18.851" class="difflineminus">-          var menuPopupOrdinal = menuPopup.getElementsByAttribute('value', menuPopupValue)[0].getAttribute('ordinal');</span>
<a href="#l18.852"></a><span id="l18.852" class="difflineminus">-          if (menuPopupOrdinal &lt; lastOrdinal)</span>
<a href="#l18.853"></a><span id="l18.853" class="difflineminus">-          {</span>
<a href="#l18.854"></a><span id="l18.854" class="difflineminus">-            var nextMenuItem = menuPopup.getElementsByAttribute('ordinal', ++menuPopupOrdinal)[0];</span>
<a href="#l18.855"></a><span id="l18.855" class="difflineminus">-            menuPopup.getElementsByAttribute('value', this.searchMode)[0].removeAttribute('checked');</span>
<a href="#l18.856"></a><span id="l18.856" class="difflineminus">-            this.searchMode = nextMenuItem.getAttribute('value');</span>
<a href="#l18.857"></a><span id="l18.857" class="difflineminus">-            nextMenuItem.setAttribute('checked', 'true');</span>
<a href="#l18.858"></a><span id="l18.858" class="difflineminus">-            menuPopup.setAttribute('value', this.searchMode);</span>
<a href="#l18.859"></a><span id="l18.859" class="difflineplus">+         @param showQSItems  Bool</span>
<a href="#l18.860"></a><span id="l18.860" class="difflineplus">+            true:  show quick search-relevant menu items</span>
<a href="#l18.861"></a><span id="l18.861" class="difflineplus">+            false: don't show quick search-relevant menu items</span>
<a href="#l18.862"></a><span id="l18.862" class="difflineplus">+      --&gt;</span>
<a href="#l18.863"></a><span id="l18.863" class="difflineplus">+      &lt;method name=&quot;showQuickSearchItems&quot;&gt;</span>
<a href="#l18.864"></a><span id="l18.864" class="difflineplus">+        &lt;parameter name=&quot;showQSItems&quot; /&gt;</span>
<a href="#l18.865"></a><span id="l18.865" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l18.866"></a><span id="l18.866" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l18.867"></a><span id="l18.867" class="difflineplus">+            for (let i = 0; i &lt; this.menupopup.childNodes.length; i++) {</span>
<a href="#l18.868"></a><span id="l18.868" class="difflineplus">+              let menuitem = this.menupopup.childNodes[i];</span>
<a href="#l18.869"></a><span id="l18.869" class="difflineplus">+              if (menuitem.getAttribute('quicksearchOnly') == 'true')</span>
<a href="#l18.870"></a><span id="l18.870" class="difflineplus">+                menuitem.collapsed = ! showQSItems;</span>
<a href="#l18.871"></a><span id="l18.871" class="difflineplus">+            }</span>
<a href="#l18.872"></a><span id="l18.872" class="difflineplus">+          ]]&gt;</span>
<a href="#l18.873"></a><span id="l18.873" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l18.874"></a><span id="l18.874" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l18.875"></a><span id="l18.875" class="difflineplus">+</span>
<a href="#l18.876"></a><span id="l18.876" class="difflineplus">+      &lt;method name=&quot;showGlodaItems&quot;&gt;</span>
<a href="#l18.877"></a><span id="l18.877" class="difflineplus">+        &lt;parameter name=&quot;aEnable&quot;/&gt;</span>
<a href="#l18.878"></a><span id="l18.878" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.879"></a><span id="l18.879" class="difflineplus">+        try {</span>
<a href="#l18.880"></a><span id="l18.880" class="difflineplus">+          for (let i = 0; i &lt; this.menupopup.childNodes.length; i++) {</span>
<a href="#l18.881"></a><span id="l18.881" class="difflineplus">+            let menuitem = this.menupopup.childNodes[i];</span>
<a href="#l18.882"></a><span id="l18.882" class="difflineplus">+            if (menuitem.getAttribute('glodaOnly') == 'true') {</span>
<a href="#l18.883"></a><span id="l18.883" class="difflineplus">+              menuitem.collapsed = ! aEnable;</span>
<a href="#l18.884"></a><span id="l18.884" class="difflineplus">+              menuitem.hidden = ! aEnable;</span>
<a href="#l18.885"></a><span id="l18.885" class="difflineplus">+            }</span>
<a href="#l18.886"></a><span id="l18.886">           }</span>
<a href="#l18.887"></a><span id="l18.887" class="difflineminus">-        ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.888"></a><span id="l18.888" class="difflineminus">-</span>
<a href="#l18.889"></a><span id="l18.889" class="difflineminus">-        &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_DOWN&quot; modifiers=&quot;alt&quot; phase=&quot;capturing&quot; action=&quot;return this.openmenupopup();&quot;/&gt;</span>
<a href="#l18.890"></a><span id="l18.890" class="difflineminus">-        &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_UP&quot;   modifiers=&quot;alt&quot; phase=&quot;capturing&quot; action=&quot;return this.openmenupopup();&quot;/&gt;</span>
<a href="#l18.891"></a><span id="l18.891" class="difflineplus">+        } catch (e) {</span>
<a href="#l18.892"></a><span id="l18.892" class="difflineplus">+          logException(e);</span>
<a href="#l18.893"></a><span id="l18.893" class="difflineplus">+        }</span>
<a href="#l18.894"></a><span id="l18.894" class="difflineplus">+        ]]&gt;</span>
<a href="#l18.895"></a><span id="l18.895" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l18.896"></a><span id="l18.896" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l18.897"></a><span id="l18.897"> </span>
<a href="#l18.898"></a><span id="l18.898" class="difflineminus">-      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_F4&quot; phase=&quot;capturing&quot;&gt;&lt;![CDATA[</span>
<a href="#l18.899"></a><span id="l18.899" class="difflineminus">-        if (window.navigator.oscpu.substring(0, 3).toLowerCase() != &quot;mac&quot;)</span>
<a href="#l18.900"></a><span id="l18.900" class="difflineminus">-          return this.openmenupopup();</span>
<a href="#l18.901"></a><span id="l18.901" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.902"></a><span id="l18.902" class="difflineminus">-</span>
<a href="#l18.903"></a><span id="l18.903" class="difflineminus">-      &lt;handler event=&quot;dragdrop&quot; phase=&quot;capturing&quot;&gt;</span>
<a href="#l18.904"></a><span id="l18.904" class="difflineminus">-        nsDragAndDrop.drop(event, this.searchInputDNDObserver);</span>
<a href="#l18.905"></a><span id="l18.905" class="difflineminus">-      &lt;/handler&gt;</span>
<a href="#l18.906"></a><span id="l18.906" class="difflineminus">-    &lt;/handlers&gt;</span>
<a href="#l18.907"></a><span id="l18.907" class="difflineplus">+    &lt;/implementation&gt;</span>
<a href="#l18.908"></a><span id="l18.908">   &lt;/binding&gt;</span>
<a href="#l18.909"></a><span id="l18.909"> </span>
<a href="#l18.910"></a><span id="l18.910">   &lt;binding id=&quot;searchBarDropMarker&quot;&gt;</span>
<a href="#l18.911"></a><span id="l18.911">     &lt;resources&gt;</span>
<a href="#l18.912"></a><span id="l18.912">       &lt;stylesheet src=&quot;chrome://messenger/skin/searchBox.css&quot;/&gt;</span>
<a href="#l18.913"></a><span id="l18.913">     &lt;/resources&gt;</span>
<a href="#l18.914"></a><span id="l18.914">     &lt;content popup=&quot;_child&quot;&gt;</span>
<a href="#l18.915"></a><span id="l18.915">       &lt;children/&gt;</span>
<a href="#l18.916"></a><span id="l18.916" class="difflineat">@@ -402,12 +665,12 @@</span>
<a href="#l18.917"></a><span id="l18.917">         &lt;xul:hbox align=&quot;center&quot;&gt;</span>
<a href="#l18.918"></a><span id="l18.918">           &lt;xul:image class=&quot;quick-search-button-image&quot; xbl:inherits=&quot;src&quot;</span>
<a href="#l18.919"></a><span id="l18.919">                      chromedir=&quot;&amp;locale.dir;&quot;/&gt;</span>
<a href="#l18.920"></a><span id="l18.920">         &lt;/xul:hbox&gt;</span>
<a href="#l18.921"></a><span id="l18.921">         &lt;xul:hbox align=&quot;center&quot;&gt;</span>
<a href="#l18.922"></a><span id="l18.922">           &lt;xul:image class=&quot;quick-search-button-dropmarker&quot;/&gt;</span>
<a href="#l18.923"></a><span id="l18.923">         &lt;/xul:hbox&gt;</span>
<a href="#l18.924"></a><span id="l18.924">       &lt;/xul:stack&gt;</span>
<a href="#l18.925"></a><span id="l18.925" class="difflineminus">-    &lt;/content&gt;  </span>
<a href="#l18.926"></a><span id="l18.926" class="difflineplus">+    &lt;/content&gt;</span>
<a href="#l18.927"></a><span id="l18.927">   &lt;/binding&gt;</span>
<a href="#l18.928"></a><span id="l18.928"> </span>
<a href="#l18.929"></a><span id="l18.929"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/base/content/searchBar.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/base/content/searchBar.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -18,284 +18,76 @@</span>
<a href="#l19.4"></a><span id="l19.4">  * Netscape Communications Corporation.</span>
<a href="#l19.5"></a><span id="l19.5">  * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l19.6"></a><span id="l19.6">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l19.7"></a><span id="l19.7">  *</span>
<a href="#l19.8"></a><span id="l19.8">  * Contributor(s):</span>
<a href="#l19.9"></a><span id="l19.9">  *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l19.10"></a><span id="l19.10">  *   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l19.11"></a><span id="l19.11">  *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+ *   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l19.14"></a><span id="l19.14">  *</span>
<a href="#l19.15"></a><span id="l19.15">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l19.16"></a><span id="l19.16">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l19.17"></a><span id="l19.17">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l19.18"></a><span id="l19.18">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l19.19"></a><span id="l19.19">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l19.20"></a><span id="l19.20">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l19.21"></a><span id="l19.21">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.22"></a><span id="l19.22">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l19.23"></a><span id="l19.23">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.24"></a><span id="l19.24">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.25"></a><span id="l19.25">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.26"></a><span id="l19.26">  *</span>
<a href="#l19.27"></a><span id="l19.27">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29"> Components.utils.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+</span>
<a href="#l19.32"></a><span id="l19.32"> </span>
<a href="#l19.33"></a><span id="l19.33"> var gSearchBundle;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-var gStatusBar = null;</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-var gIgnoreFocus = false;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-var gIgnoreClick = false;</span>
<a href="#l19.37"></a><span id="l19.37"> </span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-// change/add constants in QuickSearchConstants in quickSearchManager.js first</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-// ideally these should go away in favor of everyone using QuickSearchConstants</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-const kQuickSearchSubject = QuickSearchConstants.kQuickSearchSubject;</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-const kQuickSearchFrom = QuickSearchConstants.kQuickSearchFrom;</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-const kQuickSearchFromOrSubject =</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-  QuickSearchConstants.kQuickSearchFromOrSubject;</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-const kQuickSearchBody = QuickSearchConstants.kQuickSearchBody;</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-const kQuickSearchRecipient = QuickSearchConstants.kQuickSearchRecipient;</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-const kQuickSearchRecipientOrSubject =</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-  QuickSearchConstants.kQuickSearchRecipientOrSubject;</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+var gStatusBar = document.getElementById('statusbar-icon');</span>
<a href="#l19.49"></a><span id="l19.49"> </span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+var gGlodaCompleteStrings = new StringBundle(&quot;chrome://messenger/locale/glodaComplete.properties&quot;);</span>
<a href="#l19.51"></a><span id="l19.51"> </span>
<a href="#l19.52"></a><span id="l19.52"> /**</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">- * We are exclusively concerned with disabling the quick-search box when a</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">- *  tab is being displayed that lacks quick search abilities.</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+ * The quicksearch widget is a UI widget (the #searchInput textbox) which is</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+ * outside of the mailTabType's display panel, but acts as though it were within</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+ * it..  This means we need to use a tab monitor so that we can appropriately</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+ * update the contents of the textbox.</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+ * </span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+ * Every time a tab is changed, we save the state of the text box and restore</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+ *  its previous value for the tab we are switching to, as well as whether this</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+ *  value is a change to the currently-used value (if it is a faceted search) tab.</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+ *  The behaviour rationale for this is that the searchInput is like the</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+ *  URL bar.  When you are on a glodaSearch tab, we need to show you your</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+ *  current value, including any &quot;uncommitted&quot; (you haven't hit enter yet)</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+ *  changes.</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+ *</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+ *  In addition, we want to disable the quick-search modes when a tab is</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+ *  being displayed that lacks quick search abilities (but we'll leave the</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+ *  faceted search as it's always available).</span>
<a href="#l19.71"></a><span id="l19.71">  */</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+</span>
<a href="#l19.73"></a><span id="l19.73"> var QuickSearchTabMonitor = {</span>
<a href="#l19.74"></a><span id="l19.74">   onTabTitleChanged: function() {</span>
<a href="#l19.75"></a><span id="l19.75">   },</span>
<a href="#l19.76"></a><span id="l19.76"> </span>
<a href="#l19.77"></a><span id="l19.77">   onTabSwitched: function (aTab, aOldTab) {</span>
<a href="#l19.78"></a><span id="l19.78">     let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+    if (!searchInput) // customized out of the way</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+      return;</span>
<a href="#l19.81"></a><span id="l19.81"> </span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-    if (searchInput) {</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-      let newTabEligible = aTab.mode.tabType == mailTabType;</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-      searchInput.disabled = !newTabEligible;</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-      if (!newTabEligible)</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-        searchInput.value = &quot;&quot;;</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+    searchInput.showQuickSearchItems(aTab.mode.tabType != glodaFacetTabType)</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+    // save the current search field value</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+    if (aOldTab) {</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+      aOldTab.searchInputValue = searchInput.value;</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+      aOldTab.searchMode = searchInput.searchMode;</span>
<a href="#l19.92"></a><span id="l19.92">     }</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-  },</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+    // load (or clear if there is none) the persisted search field value</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+    searchInput.value = aTab.searchInputValue || &quot;&quot;;</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+    if (aTab.searchMode)</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+      searchInput.searchMode = aTab.searchMode;</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+  }</span>
<a href="#l19.99"></a><span id="l19.99"> };</span>
<a href="#l19.100"></a><span id="l19.100"> </span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineminus">-function SetQSStatusText(aNumHits)</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-{</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-  var statusMsg;</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-  // if there are no hits, it means no matches were found in the search.</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-  if (aNumHits == 0)</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-    statusMsg = gSearchBundle.getString(&quot;searchFailureMessage&quot;);</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-  else</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-  {</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineminus">-    if (aNumHits == 1)</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineminus">-      statusMsg = gSearchBundle.getString(&quot;searchSuccessMessage&quot;);</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineminus">-    else</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineminus">-      statusMsg = gSearchBundle.getFormattedString(&quot;searchSuccessMessages&quot;, [aNumHits]);</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineminus">-  }</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-  statusFeedback.showStatusString(statusMsg);</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-}</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineminus">-function getDocumentElements()</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-{</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-  gSearchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-  gStatusBar = document.getElementById('statusbar-icon');</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-  GetSearchInput();</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineminus">-}</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineminus">-</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-function onEnterInSearchBar()</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineminus">-{</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-  if (!gSearchInput)</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-    return;</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineminus">-  // nothing changes while showing the criteria</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">-  if (gSearchInput.showingSearchCriteria)</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineminus">-    return;</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineminus">-</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineminus">-  if (!gSearchInput || gSearchInput.value == &quot;&quot;)</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineminus">-     gFolderDisplay.view.search.userTerms = null;</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineminus">-  else</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-     gFolderDisplay.view.search.quickSearch(gSearchInput.searchMode,</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineminus">-                                            gSearchInput.value);</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineminus">-}</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineminus">-</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineminus">-</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineminus">-function onSearchKeyPress()</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineminus">-{</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineminus">-  if (gSearchInput.showingSearchCriteria)</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineminus">-    gSearchInput.showingSearchCriteria = false;</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineminus">-}</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineminus">-</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineminus">-function onSearchInputFocus(event)</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineminus">-{</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineminus">-  GetSearchInput();</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineminus">-  // search bar has focus, ...clear the showing search criteria flag</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineminus">-  if (gSearchInput.showingSearchCriteria)</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineminus">-  {</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineminus">-    gSearchInput.value = &quot;&quot;;</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineminus">-    gSearchInput.showingSearchCriteria = false;</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineminus">-  }</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-  if (gIgnoreFocus) // got focus via mouse click, don't need to anything else</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-    gIgnoreFocus = false;</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-  else</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-    gSearchInput.select();</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-}</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-function onSearchInputMousedown(event)</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineminus">-{</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineminus">-  GetSearchInput();</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineminus">-  if (gSearchInput.hasAttribute(&quot;focused&quot;))</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineminus">-    // If the search input is focused already, ignore the click so that</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-    // onSearchInputBlur does nothing.</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineminus">-    gIgnoreClick = true;</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineminus">-  else</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineminus">-  {</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineminus">-    gIgnoreFocus = true;</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineminus">-    gIgnoreClick = false;</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineminus">-  }</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineminus">-}</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineminus">-function onSearchInputClick(event)</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineminus">-{</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-  if (!gIgnoreClick)</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineminus">-    // Triggers onSearchInputBlur(), but focus returns to field.</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineminus">-    gSearchInput.select();</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineminus">-}</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineminus">-</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineminus">-function onSearchInputBlur(event)</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineminus">-{</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineminus">-  // If we're doing something else, don't process the blur.</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineminus">-  if (gIgnoreClick)</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineminus">-    return;</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineminus">-</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineminus">-  if (!gSearchInput.value)</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineminus">-    gSearchInput.showingSearchCriteria = true;</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineminus">-</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineminus">-  if (gSearchInput.showingSearchCriteria)</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineminus">-    gSearchInput.setSearchCriteriaText();</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineminus">-}</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineminus">-</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineminus">-function onClearSearch()</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineminus">-{</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineminus">-  // If we're not showing search criteria, then we need to clear up.</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineminus">-  if (!gSearchInput.showingSearchCriteria)</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineminus">-  {</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineminus">-    Search(&quot;&quot;);</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineminus">-    // Hide the clear button</span>
<a href="#l19.206"></a><span id="l19.206" class="difflineminus">-    gSearchInput.clearButtonHidden = true;</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineminus">-    gIgnoreClick = true;</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineminus">-    gSearchInput.select();</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineminus">-    gIgnoreClick = false;</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineminus">-  }</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineminus">-}</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineminus">-</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineminus">-// called from commandglue.js in cases where the view is being changed and QS</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineminus">-// needs to be cleared.</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineminus">-function ClearQSIfNecessary()</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineminus">-{</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineminus">-  if (!gSearchInput || gSearchInput.showingSearchCriteria)</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineminus">-    return;</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineminus">-  gSearchInput.setSearchCriteriaText();</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineminus">-}</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineminus">-</span>
<a href="#l19.222"></a><span id="l19.222" class="difflineminus">-function Search(str)</span>
<a href="#l19.223"></a><span id="l19.223" class="difflineminus">-{</span>
<a href="#l19.224"></a><span id="l19.224" class="difflineminus">-  if (gSearchInput.showingSearchCriteria &amp;&amp; str != &quot;&quot;)</span>
<a href="#l19.225"></a><span id="l19.225" class="difflineminus">-    return;</span>
<a href="#l19.226"></a><span id="l19.226" class="difflineminus">-</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineminus">-  gSearchInput.value = str;  //on input does not get fired for some reason</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineminus">-  onEnterInSearchBar();</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineminus">-}</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineminus">-</span>
<a href="#l19.231"></a><span id="l19.231" class="difflineminus">-// helper methods for the quick search drop down menu</span>
<a href="#l19.232"></a><span id="l19.232" class="difflineminus">-function changeQuickSearchMode(aMenuItem)</span>
<a href="#l19.233"></a><span id="l19.233" class="difflineminus">-{</span>
<a href="#l19.234"></a><span id="l19.234" class="difflineminus">-  // extract the label and set the search input to match it</span>
<a href="#l19.235"></a><span id="l19.235" class="difflineminus">-  var oldSearchMode = gSearchInput.searchMode;</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineminus">-  gSearchInput.searchMode = aMenuItem.value;</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineminus">-</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineminus">-  if (gSearchInput.value == &quot;&quot; || gSearchInput.showingSearchCriteria)</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineminus">-  {</span>
<a href="#l19.240"></a><span id="l19.240" class="difflineminus">-    gSearchInput.showingSearchCriteria = true;</span>
<a href="#l19.241"></a><span id="l19.241" class="difflineminus">-    if (gSearchInput.value) //</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineminus">-      gSearchInput.setSearchCriteriaText();</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineminus">-  }</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineminus">-</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineminus">-  // if the search box is empty, set showing search criteria to true so it shows up when focus moves out of the box</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineminus">-  if (!gSearchInput.value)</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineminus">-    gSearchInput.showingSearchCriteria = true;</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineminus">-  else if (gSearchInput.showingSearchCriteria) // if we are showing criteria text and the box isn't empty, change the criteria text</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineminus">-    gSearchInput.setSearchCriteriaText();</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineminus">-  else if (oldSearchMode != gSearchInput.searchMode) // the search mode just changed so we need to redo the quick search</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineminus">-    onEnterInSearchBar();</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineminus">-}</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineminus">-</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineminus">-function saveViewAsVirtualFolder()</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineminus">-{</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineminus">-  gFolderTreeController.newVirtualFolder(gSearchInput.value,</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineminus">-                                         gFolderDisplay.view.search.session.searchTerms);</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineminus">-}</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineminus">-</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineminus">-function InitQuickSearchPopup()</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineminus">-{</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineminus">-  // disable the create virtual folder menu item if the current radio</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineminus">-  // value is set to Find in message since you can't really  create a VF from find</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineminus">-  // in message</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineminus">-</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineminus">-  GetSearchInput();</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineminus">-  if (!gSearchInput ||gSearchInput.value == &quot;&quot; || gSearchInput.showingSearchCriteria)</span>
<a href="#l19.268"></a><span id="l19.268" class="difflineminus">-    document.getElementById('quickSearchSaveAsVirtualFolder').setAttribute('disabled', 'true');</span>
<a href="#l19.269"></a><span id="l19.269" class="difflineminus">-  else</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineminus">-    document.getElementById('quickSearchSaveAsVirtualFolder').removeAttribute('disabled');</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineminus">-}</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineminus">-</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineminus">-/**</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineminus">- * If switching from an &quot;incoming&quot; (Inbox, etc.) type of mail folder,</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineminus">- * to an &quot;outbound&quot; (Sent, Drafts etc.)  type, and the current search</span>
<a href="#l19.276"></a><span id="l19.276" class="difflineminus">- * type contains 'Sender', then switch it to the equivalent</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineminus">- * 'Recipient' search type by default. Vice versa when switching from</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineminus">- * outbound to incoming folder type.</span>
<a href="#l19.279"></a><span id="l19.279" class="difflineminus">- * @param isOutboundFolder  Bool</span>
<a href="#l19.280"></a><span id="l19.280" class="difflineminus">- *        true:  switch from an incoming to an outgoing folder</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineminus">- *        false: switch from an outgoing to an incoming folder</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineminus">- */</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineminus">-function onSearchFolderTypeChanged(isOutboundFolder)</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineminus">-{</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineminus">-  var quickSearchMenu = document.getElementById('quick-search-menupopup');</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineminus">-  var newSearchType;</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineminus">-  var oldSearchMode;</span>
<a href="#l19.288"></a><span id="l19.288" class="difflineminus">-</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineminus">-  GetSearchInput();</span>
<a href="#l19.290"></a><span id="l19.290" class="difflineminus">-</span>
<a href="#l19.291"></a><span id="l19.291" class="difflineminus">-  if (!gSearchInput)</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineminus">-    return;</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineminus">-</span>
<a href="#l19.294"></a><span id="l19.294" class="difflineminus">-  if (isOutboundFolder)</span>
<a href="#l19.295"></a><span id="l19.295" class="difflineminus">-  {</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineminus">-    if (gSearchInput.searchMode == kQuickSearchFromOrSubject)</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineminus">-      newSearchType = kQuickSearchRecipientOrSubject;</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineminus">-    else if (gSearchInput.searchMode == kQuickSearchFrom)</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineminus">-      newSearchType = kQuickSearchRecipient;</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineminus">-    else</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineminus">-      return;</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineminus">-  }</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineminus">-  else</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineminus">-  {</span>
<a href="#l19.305"></a><span id="l19.305" class="difflineminus">-    if (gSearchInput.searchMode == kQuickSearchRecipientOrSubject)</span>
<a href="#l19.306"></a><span id="l19.306" class="difflineminus">-      newSearchType = kQuickSearchFromOrSubject;</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineminus">-    else if (gSearchInput.searchMode == kQuickSearchRecipient)</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineminus">-      newSearchType = kQuickSearchFrom;</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineminus">-    else</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineminus">-      return;</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineminus">-  }</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineminus">-  var newMenuItem = quickSearchMenu.getElementsByAttribute('value', newSearchType).item(0);</span>
<a href="#l19.313"></a><span id="l19.313" class="difflineminus">-  if (newMenuItem)</span>
<a href="#l19.314"></a><span id="l19.314" class="difflineminus">-  {</span>
<a href="#l19.315"></a><span id="l19.315" class="difflineminus">-    // If a menu item is already checked, need to uncheck it first:</span>
<a href="#l19.316"></a><span id="l19.316" class="difflineminus">-    var checked = quickSearchMenu.getElementsByAttribute('checked', 'true').item(0);</span>
<a href="#l19.317"></a><span id="l19.317" class="difflineminus">-    if (checked)</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineminus">-      checked.setAttribute('checked', 'false');</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineminus">-    changeQuickSearchMode(newMenuItem);</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineminus">-    newMenuItem.setAttribute('checked', 'true');</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineminus">-  }</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/base/content/selectionsummaries.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/base/content/selectionsummaries.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -32,27 +32,27 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l20.5"></a><span id="l20.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l20.6"></a><span id="l20.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l20.7"></a><span id="l20.7">  *</span>
<a href="#l20.8"></a><span id="l20.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11"> Components.utils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/templateUtils.js&quot;);</span>
<a href="#l20.13"></a><span id="l20.13"> Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l20.14"></a><span id="l20.14"> Components.utils.import(&quot;resource://app/modules/gloda/mimemsg.js&quot;);</span>
<a href="#l20.15"></a><span id="l20.15"> Components.utils.import(&quot;resource://app/modules/gloda/connotent.js&quot;);</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17"> let gSelectionSummaryStrings = {</span>
<a href="#l20.18"></a><span id="l20.18">   NConversations: &quot;NConversations&quot;,</span>
<a href="#l20.19"></a><span id="l20.19">   numMsgs: &quot;numMsgs&quot;,</span>
<a href="#l20.20"></a><span id="l20.20">   countUnread: &quot;countUnread&quot;,</span>
<a href="#l20.21"></a><span id="l20.21">   Nmessages: &quot;Nmessages&quot;,</span>
<a href="#l20.22"></a><span id="l20.22">   messagesSize: &quot;messagesSize&quot;,</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-  yesterday: &quot;yesterday&quot;,</span>
<a href="#l20.24"></a><span id="l20.24">   noticeText: &quot;noticeText&quot;,</span>
<a href="#l20.25"></a><span id="l20.25">   noSubject: &quot;noSubject&quot;,</span>
<a href="#l20.26"></a><span id="l20.26"> }</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28"> /**</span>
<a href="#l20.29"></a><span id="l20.29">  * loadSelectionSummaryStrings does the routine localization of non-pluralized</span>
<a href="#l20.30"></a><span id="l20.30">  * strings, populating the gSelectionSummaryStrings array based on the current</span>
<a href="#l20.31"></a><span id="l20.31">  * locale.</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineat">@@ -622,16 +622,17 @@ function summarizeThread(aSelectedMessag</span>
<a href="#l20.33"></a><span id="l20.33">   if (aSelectedMessages.length == 0)</span>
<a href="#l20.34"></a><span id="l20.34">     return;</span>
<a href="#l20.35"></a><span id="l20.35"> </span>
<a href="#l20.36"></a><span id="l20.36">   try {</span>
<a href="#l20.37"></a><span id="l20.37">     gSummary = new ThreadSummary(aSelectedMessages);</span>
<a href="#l20.38"></a><span id="l20.38">     gSummary.init();</span>
<a href="#l20.39"></a><span id="l20.39">   } catch (e) {</span>
<a href="#l20.40"></a><span id="l20.40">     dump(&quot;Exception in summarizeThread&quot; + e + &quot;\n&quot;);</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+    logException(e);</span>
<a href="#l20.42"></a><span id="l20.42">     Components.utils.reportError(e);</span>
<a href="#l20.43"></a><span id="l20.43">     throw(e);</span>
<a href="#l20.44"></a><span id="l20.44">   }</span>
<a href="#l20.45"></a><span id="l20.45"> }</span>
<a href="#l20.46"></a><span id="l20.46"> </span>
<a href="#l20.47"></a><span id="l20.47"> /**</span>
<a href="#l20.48"></a><span id="l20.48">  * Given an array of message URIs, cause the message pane</span>
<a href="#l20.49"></a><span id="l20.49">  * to display a summary of them.</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineat">@@ -648,93 +649,16 @@ function summarizeMultipleSelection(aSel</span>
<a href="#l20.51"></a><span id="l20.51">     gSummary.init();</span>
<a href="#l20.52"></a><span id="l20.52">   } catch (e) {</span>
<a href="#l20.53"></a><span id="l20.53">     dump(&quot;Exception in summarizeMultipleSelection&quot; + e + &quot;\n&quot;);</span>
<a href="#l20.54"></a><span id="l20.54">     Components.utils.reportError(e);</span>
<a href="#l20.55"></a><span id="l20.55">     throw(e);</span>
<a href="#l20.56"></a><span id="l20.56">   }</span>
<a href="#l20.57"></a><span id="l20.57"> }</span>
<a href="#l20.58"></a><span id="l20.58"> </span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-/**</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">- * Helper function to generate a localized &quot;friendly&quot; representation of</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">- * time relative to the present.  If the time input is &quot;today&quot;, it returns</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">- * a string corresponding to just the time.  If it's yesterday, it returns</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">- * &quot;yesterday&quot; (localized).  If it's in the last week, it returns the day</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">- * of the week. If it's before that, it returns the date.</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">- *</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineminus">- * @param time</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">- *        the time (better be in the past!)</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineminus">- * @return The string with a &quot;human-friendly&quot; representation of that time</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">- *        relative to now.</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">- */</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-function makeFriendlyDateAgo(time)</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-{</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-  let dts = Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;]</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-                      .getService(Components.interfaces.nsIScriptableDateFormat);</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-  // Figure out when today begins</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-  let now = new Date();</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-  let today = new Date(now.getFullYear(), now.getMonth(),</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-                       now.getDate());</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-  // Get the end time to display</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-  let end = time;</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-  // Figure out if the end time is from today, yesterday,</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-  // this week, etc.</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-  let dateTime;</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-  let kDayInMsecs = 24 * 60 * 60 * 1000;</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-  let k6DaysInMsecs = 6 * kDayInMsecs;</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-  if (end &gt;= today) {</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-    // activity finished after today started, show the time</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-    dateTime = dts.FormatTime(&quot;&quot;, dts.timeFormatNoSeconds,</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-                                  end.getHours(), end.getMinutes(),0);</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-  } else if (today - end &lt; kDayInMsecs) {</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-    // activity finished after yesterday started, show yesterday</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-    dateTime = gSelectionSummaryStrings.yesterday;</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-  } else if (today - end &lt; k6DaysInMsecs) {</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-    // activity finished after last week started, show day of week</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-    dateTime = end.toLocaleFormat(&quot;%A&quot;);</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-  } else if (now.getFullYear() == end.getFullYear()) {</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-    // activity must have been from some time ago.. show month/day</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-    let month = end.toLocaleFormat(&quot;%B&quot;);</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-    // Remove leading 0 by converting the date string to a number</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-    let date = Number(end.toLocaleFormat(&quot;%d&quot;));</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-    //dateTime = replaceInsert(this.text.monthDate, 1, month);</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-    dateTime = replaceInsert(&quot;#1 #2&quot;, 1, month);</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-    dateTime = replaceInsert(dateTime, 2, date);</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-  } else {</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineminus">-    // not this year, so show year as wel</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineminus">-    let month = end.toLocaleFormat(&quot;%B&quot;);</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineminus">-    let year = end.toLocaleFormat(&quot;%Y&quot;);</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineminus">-    // Remove leading 0 by converting the date string to a number</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineminus">-    let date = Number(end.toLocaleFormat(&quot;%d&quot;));</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineminus">-    //dateTime = replaceInsert(this.text.monthDate, 1, month);</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineminus">-    dateTime = replaceInsert(&quot;#1 #2 #3&quot;, 1, month);</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">-    dateTime = replaceInsert(dateTime, 2, date);</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-    dateTime = replaceInsert(dateTime, 3, year);</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineminus">-  }</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineminus">-  return dateTime;</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-}</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-/**</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">- * Helper function to replace a placeholder string with a real string</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineminus">- *</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineminus">- * @param aText</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">- *        Source text containing placeholder (e.g., #1)</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">- * @param aIndex</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">- *        Index number of placeholder to replace</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineminus">- * @param aValue</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">- *        New string to put in place of placeholder</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">- * @return The string with placeholder replaced with the new string</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">- */</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-function replaceInsert(aText, aIndex, aValue)</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineminus">-{</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-  return aText.replace(&quot;#&quot; + aIndex, aValue);</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineminus">-}</span>
<a href="#l20.136"></a><span id="l20.136"> </span>
<a href="#l20.137"></a><span id="l20.137"> /**</span>
<a href="#l20.138"></a><span id="l20.138">  * Helper function to escape some XML chars, so they display properly in</span>
<a href="#l20.139"></a><span id="l20.139">  * innerHTML.</span>
<a href="#l20.140"></a><span id="l20.140">  *</span>
<a href="#l20.141"></a><span id="l20.141">  * @param s</span>
<a href="#l20.142"></a><span id="l20.142">  *        input text</span>
<a href="#l20.143"></a><span id="l20.143">  * @return The string with &lt;, &gt;, and &amp; replaced by the corresponding entities.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -391,17 +391,18 @@</span>
<a href="#l21.4"></a><span id="l21.4">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l21.5"></a><span id="l21.5">           // From the moment of creation, our XBL binding already has a visible</span>
<a href="#l21.6"></a><span id="l21.6">           //  tab.  We need to create a tab information structure for this tab.</span>
<a href="#l21.7"></a><span id="l21.7">           //  In the process we also generate a synthetic tab title changed</span>
<a href="#l21.8"></a><span id="l21.8">           //  event to ensure we have an accurate title.  We assume the tab</span>
<a href="#l21.9"></a><span id="l21.9">           //  contents will set themselves up correctly.</span>
<a href="#l21.10"></a><span id="l21.10">           if (this.tabInfo.length == 0) {</span>
<a href="#l21.11"></a><span id="l21.11">             let firstTab = {mode: this.defaultTabMode, busy: false,</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-                            canClose: false};</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+                            canClose: false,</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+                            searchMode: 'global'};</span>
<a href="#l21.15"></a><span id="l21.15">             firstTab.mode.tabs.push(firstTab);</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17">             this.tabInfo[0] = this.currentTabInfo = firstTab;</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19">             let tabOpenFirstFunc = firstTab.mode.openFirstTab ||</span>
<a href="#l21.20"></a><span id="l21.20">                                    firstTab.mode.tabType.openFirstTab;</span>
<a href="#l21.21"></a><span id="l21.21">             tabOpenFirstFunc.call(firstTab.mode.tabType, firstTab);</span>
<a href="#l21.22"></a><span id="l21.22">             this.setTabTitle(null);</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineat">@@ -413,16 +414,19 @@</span>
<a href="#l21.24"></a><span id="l21.24">           }</span>
<a href="#l21.25"></a><span id="l21.25">         ]]&gt;&lt;/body&gt;</span>
<a href="#l21.26"></a><span id="l21.26">       &lt;/method&gt;</span>
<a href="#l21.27"></a><span id="l21.27">       &lt;method name=&quot;openTab&quot;&gt;</span>
<a href="#l21.28"></a><span id="l21.28">         &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l21.29"></a><span id="l21.29">         &lt;parameter name=&quot;aArgs&quot;/&gt;</span>
<a href="#l21.30"></a><span id="l21.30">         &lt;body&gt;</span>
<a href="#l21.31"></a><span id="l21.31">             &lt;![CDATA[</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+        try {</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+          if (!(aTabModeName in this.tabModes))</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+            throw new Error(&quot;No such tab mode: &quot; + aTabModeName);</span>
<a href="#l21.35"></a><span id="l21.35">           let tabMode = this.tabModes[aTabModeName];</span>
<a href="#l21.36"></a><span id="l21.36">           // if we are already at our limit for this mode, show an existing one</span>
<a href="#l21.37"></a><span id="l21.37">           if (tabMode.tabs.length == tabMode.maxTabs) {</span>
<a href="#l21.38"></a><span id="l21.38">             let desiredTab = tabMode.tabs[0];</span>
<a href="#l21.39"></a><span id="l21.39">             this.tabContainer.selectedIndex = this.tabInfo.indexOf(desiredTab);</span>
<a href="#l21.40"></a><span id="l21.40">             return;</span>
<a href="#l21.41"></a><span id="l21.41">           }</span>
<a href="#l21.42"></a><span id="l21.42"> </span>
<a href="#l21.43"></a><span id="l21.43" class="difflineat">@@ -519,16 +523,17 @@</span>
<a href="#l21.44"></a><span id="l21.44">           t.setAttribute('type', tab.mode.type);</span>
<a href="#l21.45"></a><span id="l21.45"> </span>
<a href="#l21.46"></a><span id="l21.46">           if (!background)</span>
<a href="#l21.47"></a><span id="l21.47">             // Update the toolbar status - we don't need to do menus as they</span>
<a href="#l21.48"></a><span id="l21.48">             // do themselves when we open them.</span>
<a href="#l21.49"></a><span id="l21.49">             UpdateMailToolbar(&quot;tabmail&quot;);</span>
<a href="#l21.50"></a><span id="l21.50"> </span>
<a href="#l21.51"></a><span id="l21.51">           return tab;</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+          } catch (e) { logException(e);}</span>
<a href="#l21.53"></a><span id="l21.53">         ]]&gt;&lt;/body&gt;</span>
<a href="#l21.54"></a><span id="l21.54">       &lt;/method&gt;</span>
<a href="#l21.55"></a><span id="l21.55">       &lt;method name=&quot;selectTabByMode&quot;&gt;</span>
<a href="#l21.56"></a><span id="l21.56">         &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l21.57"></a><span id="l21.57">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l21.58"></a><span id="l21.58">           let tabMode = this.tabModes[aTabModeName];</span>
<a href="#l21.59"></a><span id="l21.59">           if (tabMode.tabs.length) {</span>
<a href="#l21.60"></a><span id="l21.60">             let desiredTab = tabMode.tabs[0];</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineat">@@ -671,17 +676,17 @@</span>
<a href="#l21.62"></a><span id="l21.62">             // If there is a non-null tab-state, then persisting succeeded and</span>
<a href="#l21.63"></a><span id="l21.63">             //  we should store it.  We store the tab's persisted state in its</span>
<a href="#l21.64"></a><span id="l21.64">             //  own distinct object rather than mixing things up in a dictionary</span>
<a href="#l21.65"></a><span id="l21.65">             //  to avoid bugs and because we may eventually let extensions store</span>
<a href="#l21.66"></a><span id="l21.66">             //  per-tab information in the persisted state.</span>
<a href="#l21.67"></a><span id="l21.67">             if (tabState != null) {</span>
<a href="#l21.68"></a><span id="l21.68">               tabs.push({</span>
<a href="#l21.69"></a><span id="l21.69">                 mode: tab.mode.name,</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-                state: tabState</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+                state: tabState,</span>
<a href="#l21.72"></a><span id="l21.72">               });</span>
<a href="#l21.73"></a><span id="l21.73">               // Mark this persisted tab as selected</span>
<a href="#l21.74"></a><span id="l21.74">               if (iTab == this.tabContainer.selectedIndex)</span>
<a href="#l21.75"></a><span id="l21.75">                 state.selectedIndex = tabs.length - 1;</span>
<a href="#l21.76"></a><span id="l21.76">             }</span>
<a href="#l21.77"></a><span id="l21.77">           }</span>
<a href="#l21.78"></a><span id="l21.78"> </span>
<a href="#l21.79"></a><span id="l21.79">           return state;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/base/jar.mn</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/base/jar.mn</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -55,34 +55,43 @@ messenger.jar:</span>
<a href="#l22.4"></a><span id="l22.4"> *   content/messenger/msgPrintEngine.xul            (content/msgPrintEngine.xul)</span>
<a href="#l22.5"></a><span id="l22.5">     content/messenger/searchBar.js                  (content/searchBar.js)</span>
<a href="#l22.6"></a><span id="l22.6">     content/messenger/phishingDetector.js           (content/phishingDetector.js)</span>
<a href="#l22.7"></a><span id="l22.7"> *   content/messenger/mail-offline.js               (content/mail-offline.js)</span>
<a href="#l22.8"></a><span id="l22.8">     content/messenger/about-footer.png              (content/about-footer.png)</span>
<a href="#l22.9"></a><span id="l22.9">     content/messenger/aboutDialog.css               (content/aboutDialog.css)</span>
<a href="#l22.10"></a><span id="l22.10"> *   content/messenger/credits.xhtml                 (content/credits.xhtml)</span>
<a href="#l22.11"></a><span id="l22.11">     content/messenger/messenger.css                 (content/messenger.css)</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-*   content/messenger/search.xml                    (content/search.xml)</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+    content/messenger/search.xml                    (content/search.xml)</span>
<a href="#l22.14"></a><span id="l22.14">     content/messenger/tabmail.xml                   (content/tabmail.xml)</span>
<a href="#l22.15"></a><span id="l22.15">     content/messenger/tabmail.css                   (content/tabmail.css)</span>
<a href="#l22.16"></a><span id="l22.16"> *   content/messenger/newmailalert.xul              (content/newmailalert.xul)</span>
<a href="#l22.17"></a><span id="l22.17">     content/messenger/newmailalert.js               (content/newmailalert.js)</span>
<a href="#l22.18"></a><span id="l22.18">     content/messenger/newTagDialog.xul              (content/newTagDialog.xul)</span>
<a href="#l22.19"></a><span id="l22.19">     content/messenger/newTagDialog.js               (content/newTagDialog.js)</span>
<a href="#l22.20"></a><span id="l22.20"> *   content/messenger/viewSourceOverlay.xul         (content/viewSourceOverlay.xul)</span>
<a href="#l22.21"></a><span id="l22.21"> *   content/messenger/configEditorOverlay.xul       (content/configEditorOverlay.xul)</span>
<a href="#l22.22"></a><span id="l22.22">     content/messenger/composerOverlay.css           (content/composerOverlay.css)</span>
<a href="#l22.23"></a><span id="l22.23">     content/messenger/threadPane.js                 (content/threadPane.js)</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+    content/messenger/protovis-r2.6-modded.js       (content/protovis-r2.6-modded.js)</span>
<a href="#l22.25"></a><span id="l22.25"> #ifdef XP_MACOSX</span>
<a href="#l22.26"></a><span id="l22.26">     content/messenger/macMenuOverlay.xul            (content/macMenuOverlay.xul)</span>
<a href="#l22.27"></a><span id="l22.27"> #endif</span>
<a href="#l22.28"></a><span id="l22.28"> *   content/messenger/baseMenuOverlay.xul           (content/baseMenuOverlay.xul)</span>
<a href="#l22.29"></a><span id="l22.29">     content/messenger/selectionsummaries.js         (content/selectionsummaries.js)</span>
<a href="#l22.30"></a><span id="l22.30">     content/messenger/multimessageview.css          (content/multimessageview.css)</span>
<a href="#l22.31"></a><span id="l22.31">     content/messenger/sharedsummary.css             (content/sharedsummary.css)</span>
<a href="#l22.32"></a><span id="l22.32">     content/messenger/multimessageview.xhtml        (content/multimessageview.xhtml)</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+    content/messenger/glodaFacetTab.js              (content/glodaFacetTab.js)</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+    content/messenger/glodaFacetViewWrapper.xul     (content/glodaFacetViewWrapper.xul)</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+    content/messenger/glodaFacetView.xhtml          (content/glodaFacetView.xhtml)</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+    content/messenger/glodaFacetView.js             (content/glodaFacetView.js)</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+    content/messenger/glodaFacetView.css            (content/glodaFacetView.css)</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+    content/messenger/glodaFacetBindings.css        (content/glodaFacetBindings.css)</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+    content/messenger/glodaFacetBindings.xml        (content/glodaFacetBindings.xml)</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+    content/messenger/glodaFacetVis.js              (content/glodaFacetVis.js)</span>
<a href="#l22.41"></a><span id="l22.41"> </span>
<a href="#l22.42"></a><span id="l22.42"> comm.jar:</span>
<a href="#l22.43"></a><span id="l22.43"> % content communicator %content/communicator/ xpcnativewrappers=yes</span>
<a href="#l22.44"></a><span id="l22.44"> *  content/communicator/contentAreaClick.js         (content/contentAreaClick.js)</span>
<a href="#l22.45"></a><span id="l22.45"> *  content/communicator/utilityOverlay.xul          (content/utilityOverlay.xul)</span>
<a href="#l22.46"></a><span id="l22.46"> *  content/communicator/utilityOverlay.js           (content/utilityOverlay.js)</span>
<a href="#l22.47"></a><span id="l22.47"> *  content/communicator/nsContextMenu.js            (content/nsContextMenu.js)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/build.mk</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/build.mk</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -117,15 +117,15 @@ else</span>
<a href="#l23.4"></a><span id="l23.4"> PROGRAM_LOCATION = ../../../$(DIST)/bin/</span>
<a href="#l23.5"></a><span id="l23.5"> PROGRAM = $(PROGRAM_LOCATION)thunderbird$(BIN_SUFFIX)</span>
<a href="#l23.6"></a><span id="l23.6"> endif</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> mozmill::</span>
<a href="#l23.9"></a><span id="l23.9"> 	cd $(MOZMILLDIR) &amp;&amp; MACOSX_DEPLOYMENT_TARGET= $(PYTHON) \</span>
<a href="#l23.10"></a><span id="l23.10"> 	runtestlist.py --list=mozmilltests.list --binary=$(PROGRAM) \</span>
<a href="#l23.11"></a><span id="l23.11"> 	--dir=$(topsrcdir)/mail/test/mozmill \</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-	--default-profile=$(PROGRAM_LOCATION)/defaults/profile</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+	--default-profile=$(PROGRAM_LOCATION)/defaults/profile $(MOZMILL_EXTRA)</span>
<a href="#l23.14"></a><span id="l23.14"> </span>
<a href="#l23.15"></a><span id="l23.15"> mozmill-one::</span>
<a href="#l23.16"></a><span id="l23.16"> 	cd $(MOZMILLDIR) &amp;&amp; MACOSX_DEPLOYMENT_TARGET= $(PYTHON) runtest.py \</span>
<a href="#l23.17"></a><span id="l23.17"> 	--test=$(topsrcdir)/mail/test/mozmill/$(SOLO_TEST) --binary=$(PROGRAM) \</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-	--default-profile=$(PROGRAM_LOCATION)/defaults/profile</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+	--default-profile=$(PROGRAM_LOCATION)/defaults/profile $(MOZMILL_EXTRA)</span>
<a href="#l23.20"></a><span id="l23.20"> endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">new file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- /dev/null</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ b/mail/jquery/Makefile.in</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -0,0 +1,65 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineplus">+#</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+#</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+#</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+# License.</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+#</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+# The Original Code is mozilla.org code.</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+#</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+# Netscape Communications Corporation.</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+#</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+# Contributor(s):</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+#</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+#</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+DEPTH		= ../..</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+topsrcdir	= @top_srcdir@</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+srcdir		= @srcdir@</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+VPATH		= @srcdir@</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+DIRS =</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+PRE_RELEASE_SUFFIX := $(shell $(PYTHON) $(topsrcdir)/mozilla/config/printprereleasesuffix.py \</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+                      $(shell cat $(MOZ_APP_VERSION_TXT) ))</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+DEFINES += -DMOZ_APP_VERSION=$(MOZ_APP_VERSION) \</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+           -DPRE_RELEASE_SUFFIX=&quot;$(PRE_RELEASE_SUFFIX)&quot;</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+ifneq (,$(BUILD_OFFICIAL)$(MOZILLA_OFFICIAL))</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+DEFINES += -DOFFICIAL_BUILD=1</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+endif</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineplus">+ifneq (,$(filter windows gtk2 mac cocoa, $(MOZ_WIDGET_TOOLKIT)))</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+DEFINES += -DHAVE_SHELL_SERVICE=1</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+endif</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineplus">+ifdef MOZ_UPDATER</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+DEFINES += -DMOZ_UPDATER=1</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+endif</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">new file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- /dev/null</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ b/mail/jquery/jar.mn</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -0,0 +1,2 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineplus">+messenger.jar:</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineplus">+    content/messenger/jquery.js                       (jquery-1.3.2.min.js)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/mail/jquery/jquery-1.3.2.min.js</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,19 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+/*</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+ * jQuery JavaScript Library v1.3.2</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+ * http://jquery.com/</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+ *</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+ * Copyright (c) 2009 John Resig</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+ * Dual licensed under the MIT and GPL licenses.</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+ * http://docs.jquery.com/License</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+ *</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+ * Date: 2009-02-19 17:34:21 -0500 (Thu, 19 Feb 2009)</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+ * Revision: 6246</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+ */</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+(function(){var l=this,g,y=l.jQuery,p=l.$,o=l.jQuery=l.$=function(E,F){return new o.fn.init(E,F)},D=/^[^&lt;]*(&lt;(.|\s)+&gt;)[^&gt;]*$|^#([\w-]+)$/,f=/^.[^:#\[\.,]*$/;o.fn=o.prototype={init:function(E,H){E=E||document;if(E.nodeType){this[0]=E;this.length=1;this.context=E;return this}if(typeof E===&quot;string&quot;){var G=D.exec(E);if(G&amp;&amp;(G[1]||!H)){if(G[1]){E=o.clean([G[1]],H)}else{var I=document.getElementById(G[3]);if(I&amp;&amp;I.id!=G[3]){return o().find(E)}var F=o(I||[]);F.context=document;F.selector=E;return F}}else{return o(H).find(E)}}else{if(o.isFunction(E)){return o(document).ready(E)}}if(E.selector&amp;&amp;E.context){this.selector=E.selector;this.context=E.context}return this.setArray(o.isArray(E)?E:o.makeArray(E))},selector:&quot;&quot;,jquery:&quot;1.3.2&quot;,size:function(){return this.length},get:function(E){return E===g?Array.prototype.slice.call(this):this[E]},pushStack:function(F,H,E){var G=o(F);G.prevObject=this;G.context=this.context;if(H===&quot;find&quot;){G.selector=this.selector+(this.selector?&quot; &quot;:&quot;&quot;)+E}else{if(H){G.selector=this.selector+&quot;.&quot;+H+&quot;(&quot;+E+&quot;)&quot;}}return G},setArray:function(E){this.length=0;Array.prototype.push.apply(this,E);return this},each:function(F,E){return o.each(this,F,E)},index:function(E){return o.inArray(E&amp;&amp;E.jquery?E[0]:E,this)},attr:function(F,H,G){var E=F;if(typeof F===&quot;string&quot;){if(H===g){return this[0]&amp;&amp;o[G||&quot;attr&quot;](this[0],F)}else{E={};E[F]=H}}return this.each(function(I){for(F in E){o.attr(G?this.style:this,F,o.prop(this,E[F],G,I,F))}})},css:function(E,F){if((E==&quot;width&quot;||E==&quot;height&quot;)&amp;&amp;parseFloat(F)&lt;0){F=g}return this.attr(E,F,&quot;curCSS&quot;)},text:function(F){if(typeof F!==&quot;object&quot;&amp;&amp;F!=null){return this.empty().append((this[0]&amp;&amp;this[0].ownerDocument||document).createTextNode(F))}var E=&quot;&quot;;o.each(F||this,function(){o.each(this.childNodes,function(){if(this.nodeType!=8){E+=this.nodeType!=1?this.nodeValue:o.fn.text([this])}})});return E},wrapAll:function(E){if(this[0]){var F=o(E,this[0].ownerDocument).clone();if(this[0].parentNode){F.insertBefore(this[0])}F.map(function(){var G=this;while(G.firstChild){G=G.firstChild}return G}).append(this)}return this},wrapInner:function(E){return this.each(function(){o(this).contents().wrapAll(E)})},wrap:function(E){return this.each(function(){o(this).wrapAll(E)})},append:function(){return this.domManip(arguments,true,function(E){if(this.nodeType==1){this.appendChild(E)}})},prepend:function(){return this.domManip(arguments,true,function(E){if(this.nodeType==1){this.insertBefore(E,this.firstChild)}})},before:function(){return this.domManip(arguments,false,function(E){this.parentNode.insertBefore(E,this)})},after:function(){return this.domManip(arguments,false,function(E){this.parentNode.insertBefore(E,this.nextSibling)})},end:function(){return this.prevObject||o([])},push:[].push,sort:[].sort,splice:[].splice,find:function(E){if(this.length===1){var F=this.pushStack([],&quot;find&quot;,E);F.length=0;o.find(E,this[0],F);return F}else{return this.pushStack(o.unique(o.map(this,function(G){return o.find(E,G)})),&quot;find&quot;,E)}},clone:function(G){var E=this.map(function(){if(!o.support.noCloneEvent&amp;&amp;!o.isXMLDoc(this)){var I=this.outerHTML;if(!I){var J=this.ownerDocument.createElement(&quot;div&quot;);J.appendChild(this.cloneNode(true));I=J.innerHTML}return o.clean([I.replace(/ jQuery\d+=&quot;(?:\d+|null)&quot;/g,&quot;&quot;).replace(/^\s*/,&quot;&quot;)])[0]}else{return this.cloneNode(true)}});if(G===true){var H=this.find(&quot;*&quot;).andSelf(),F=0;E.find(&quot;*&quot;).andSelf().each(function(){if(this.nodeName!==H[F].nodeName){return}var I=o.data(H[F],&quot;events&quot;);for(var K in I){for(var J in I[K]){o.event.add(this,K,I[K][J],I[K][J].data)}}F++})}return E},filter:function(E){return this.pushStack(o.isFunction(E)&amp;&amp;o.grep(this,function(G,F){return E.call(G,F)})||o.multiFilter(E,o.grep(this,function(F){return F.nodeType===1})),&quot;filter&quot;,E)},closest:function(E){var G=o.expr.match.POS.test(E)?o(E):null,F=0;return this.map(function(){var H=this;while(H&amp;&amp;H.ownerDocument){if(G?G.index(H)&gt;-1:o(H).is(E)){o.data(H,&quot;closest&quot;,F);return H}H=H.parentNode;F++}})},not:function(E){if(typeof E===&quot;string&quot;){if(f.test(E)){return this.pushStack(o.multiFilter(E,this,true),&quot;not&quot;,E)}else{E=o.multiFilter(E,this)}}var F=E.length&amp;&amp;E[E.length-1]!==g&amp;&amp;!E.nodeType;return this.filter(function(){return F?o.inArray(this,E)&lt;0:this!=E})},add:function(E){return this.pushStack(o.unique(o.merge(this.get(),typeof E===&quot;string&quot;?o(E):o.makeArray(E))))},is:function(E){return !!E&amp;&amp;o.multiFilter(E,this).length&gt;0},hasClass:function(E){return !!E&amp;&amp;this.is(&quot;.&quot;+E)},val:function(K){if(K===g){var E=this[0];if(E){if(o.nodeName(E,&quot;option&quot;)){return(E.attributes.value||{}).specified?E.value:E.text}if(o.nodeName(E,&quot;select&quot;)){var I=E.selectedIndex,L=[],M=E.options,H=E.type==&quot;select-one&quot;;if(I&lt;0){return null}for(var F=H?I:0,J=H?I+1:M.length;F&lt;J;F++){var G=M[F];if(G.selected){K=o(G).val();if(H){return K}L.push(K)}}return L}return(E.value||&quot;&quot;).replace(/\r/g,&quot;&quot;)}return g}if(typeof K===&quot;number&quot;){K+=&quot;&quot;}return this.each(function(){if(this.nodeType!=1){return}if(o.isArray(K)&amp;&amp;/radio|checkbox/.test(this.type)){this.checked=(o.inArray(this.value,K)&gt;=0||o.inArray(this.name,K)&gt;=0)}else{if(o.nodeName(this,&quot;select&quot;)){var N=o.makeArray(K);o(&quot;option&quot;,this).each(function(){this.selected=(o.inArray(this.value,N)&gt;=0||o.inArray(this.text,N)&gt;=0)});if(!N.length){this.selectedIndex=-1}}else{this.value=K}}})},html:function(E){return E===g?(this[0]?this[0].innerHTML.replace(/ jQuery\d+=&quot;(?:\d+|null)&quot;/g,&quot;&quot;):null):this.empty().append(E)},replaceWith:function(E){return this.after(E).remove()},eq:function(E){return this.slice(E,+E+1)},slice:function(){return this.pushStack(Array.prototype.slice.apply(this,arguments),&quot;slice&quot;,Array.prototype.slice.call(arguments).join(&quot;,&quot;))},map:function(E){return this.pushStack(o.map(this,function(G,F){return E.call(G,F,G)}))},andSelf:function(){return this.add(this.prevObject)},domManip:function(J,M,L){if(this[0]){var I=(this[0].ownerDocument||this[0]).createDocumentFragment(),F=o.clean(J,(this[0].ownerDocument||this[0]),I),H=I.firstChild;if(H){for(var G=0,E=this.length;G&lt;E;G++){L.call(K(this[G],H),this.length&gt;1||G&gt;0?I.cloneNode(true):I)}}if(F){o.each(F,z)}}return this;function K(N,O){return M&amp;&amp;o.nodeName(N,&quot;table&quot;)&amp;&amp;o.nodeName(O,&quot;tr&quot;)?(N.getElementsByTagName(&quot;tbody&quot;)[0]||N.appendChild(N.ownerDocument.createElement(&quot;tbody&quot;))):N}}};o.fn.init.prototype=o.fn;function z(E,F){if(F.src){o.ajax({url:F.src,async:false,dataType:&quot;script&quot;})}else{o.globalEval(F.text||F.textContent||F.innerHTML||&quot;&quot;)}if(F.parentNode){F.parentNode.removeChild(F)}}function e(){return +new Date}o.extend=o.fn.extend=function(){var J=arguments[0]||{},H=1,I=arguments.length,E=false,G;if(typeof J===&quot;boolean&quot;){E=J;J=arguments[1]||{};H=2}if(typeof J!==&quot;object&quot;&amp;&amp;!o.isFunction(J)){J={}}if(I==H){J=this;--H}for(;H&lt;I;H++){if((G=arguments[H])!=null){for(var F in G){var K=J[F],L=G[F];if(J===L){continue}if(E&amp;&amp;L&amp;&amp;typeof L===&quot;object&quot;&amp;&amp;!L.nodeType){J[F]=o.extend(E,K||(L.length!=null?[]:{}),L)}else{if(L!==g){J[F]=L}}}}}return J};var b=/z-?index|font-?weight|opacity|zoom|line-?height/i,q=document.defaultView||{},s=Object.prototype.toString;o.extend({noConflict:function(E){l.$=p;if(E){l.jQuery=y}return o},isFunction:function(E){return s.call(E)===&quot;[object Function]&quot;},isArray:function(E){return s.call(E)===&quot;[object Array]&quot;},isXMLDoc:function(E){return E.nodeType===9&amp;&amp;E.documentElement.nodeName!==&quot;HTML&quot;||!!E.ownerDocument&amp;&amp;o.isXMLDoc(E.ownerDocument)},globalEval:function(G){if(G&amp;&amp;/\S/.test(G)){var F=document.getElementsByTagName(&quot;head&quot;)[0]||document.documentElement,E=document.createElement(&quot;script&quot;);E.type=&quot;text/javascript&quot;;if(o.support.scriptEval){E.appendChild(document.createTextNode(G))}else{E.text=G}F.insertBefore(E,F.firstChild);F.removeChild(E)}},nodeName:function(F,E){return F.nodeName&amp;&amp;F.nodeName.toUpperCase()==E.toUpperCase()},each:function(G,K,F){var E,H=0,I=G.length;if(F){if(I===g){for(E in G){if(K.apply(G[E],F)===false){break}}}else{for(;H&lt;I;){if(K.apply(G[H++],F)===false){break}}}}else{if(I===g){for(E in G){if(K.call(G[E],E,G[E])===false){break}}}else{for(var J=G[0];H&lt;I&amp;&amp;K.call(J,H,J)!==false;J=G[++H]){}}}return G},prop:function(H,I,G,F,E){if(o.isFunction(I)){I=I.call(H,F)}return typeof I===&quot;number&quot;&amp;&amp;G==&quot;curCSS&quot;&amp;&amp;!b.test(E)?I+&quot;px&quot;:I},className:{add:function(E,F){o.each((F||&quot;&quot;).split(/\s+/),function(G,H){if(E.nodeType==1&amp;&amp;!o.className.has(E.className,H)){E.className+=(E.className?&quot; &quot;:&quot;&quot;)+H}})},remove:function(E,F){if(E.nodeType==1){E.className=F!==g?o.grep(E.className.split(/\s+/),function(G){return !o.className.has(F,G)}).join(&quot; &quot;):&quot;&quot;}},has:function(F,E){return F&amp;&amp;o.inArray(E,(F.className||F).toString().split(/\s+/))&gt;-1}},swap:function(H,G,I){var E={};for(var F in G){E[F]=H.style[F];H.style[F]=G[F]}I.call(H);for(var F in G){H.style[F]=E[F]}},css:function(H,F,J,E){if(F==&quot;width&quot;||F==&quot;height&quot;){var L,G={position:&quot;absolute&quot;,visibility:&quot;hidden&quot;,display:&quot;block&quot;},K=F==&quot;width&quot;?[&quot;Left&quot;,&quot;Right&quot;]:[&quot;Top&quot;,&quot;Bottom&quot;];function I(){L=F==&quot;width&quot;?H.offsetWidth:H.offsetHeight;if(E===&quot;border&quot;){return}o.each(K,function(){if(!E){L-=parseFloat(o.curCSS(H,&quot;padding&quot;+this,true))||0}if(E===&quot;margin&quot;){L+=parseFloat(o.curCSS(H,&quot;margin&quot;+this,true))||0}else{L-=parseFloat(o.curCSS(H,&quot;border&quot;+this+&quot;Width&quot;,true))||0}})}if(H.offsetWidth!==0){I()}else{o.swap(H,G,I)}return Math.max(0,Math.round(L))}return o.curCSS(H,F,J)},curCSS:function(I,F,G){var L,E=I.style;if(F==&quot;opacity&quot;&amp;&amp;!o.support.opacity){L=o.attr(E,&quot;opacity&quot;);return L==&quot;&quot;?&quot;1&quot;:L}if(F.match(/float/i)){F=w}if(!G&amp;&amp;E&amp;&amp;E[F]){L=E[F]}else{if(q.getComputedStyle){if(F.match(/float/i)){F=&quot;float&quot;}F=F.replace(/([A-Z])/g,&quot;-$1&quot;).toLowerCase();var M=q.getComputedStyle(I,null);if(M){L=M.getPropertyValue(F)}if(F==&quot;opacity&quot;&amp;&amp;L==&quot;&quot;){L=&quot;1&quot;}}else{if(I.currentStyle){var J=F.replace(/\-(\w)/g,function(N,O){return O.toUpperCase()});L=I.currentStyle[F]||I.currentStyle[J];if(!/^\d+(px)?$/i.test(L)&amp;&amp;/^\d/.test(L)){var H=E.left,K=I.runtimeStyle.left;I.runtimeStyle.left=I.currentStyle.left;E.left=L||0;L=E.pixelLeft+&quot;px&quot;;E.left=H;I.runtimeStyle.left=K}}}}return L},clean:function(F,K,I){K=K||document;if(typeof K.createElement===&quot;undefined&quot;){K=K.ownerDocument||K[0]&amp;&amp;K[0].ownerDocument||document}if(!I&amp;&amp;F.length===1&amp;&amp;typeof F[0]===&quot;string&quot;){var H=/^&lt;(\w+)\s*\/?&gt;$/.exec(F[0]);if(H){return[K.createElement(H[1])]}}var G=[],E=[],L=K.createElement(&quot;div&quot;);o.each(F,function(P,S){if(typeof S===&quot;number&quot;){S+=&quot;&quot;}if(!S){return}if(typeof S===&quot;string&quot;){S=S.replace(/(&lt;(\w+)[^&gt;]*?)\/&gt;/g,function(U,V,T){return T.match(/^(abbr|br|col|img|input|link|meta|param|hr|area|embed)$/i)?U:V+&quot;&gt;&lt;/&quot;+T+&quot;&gt;&quot;});var O=S.replace(/^\s+/,&quot;&quot;).substring(0,10).toLowerCase();var Q=!O.indexOf(&quot;&lt;opt&quot;)&amp;&amp;[1,&quot;&lt;select multiple='multiple'&gt;&quot;,&quot;&lt;/select&gt;&quot;]||!O.indexOf(&quot;&lt;leg&quot;)&amp;&amp;[1,&quot;&lt;fieldset&gt;&quot;,&quot;&lt;/fieldset&gt;&quot;]||O.match(/^&lt;(thead|tbody|tfoot|colg|cap)/)&amp;&amp;[1,&quot;&lt;table&gt;&quot;,&quot;&lt;/table&gt;&quot;]||!O.indexOf(&quot;&lt;tr&quot;)&amp;&amp;[2,&quot;&lt;table&gt;&lt;tbody&gt;&quot;,&quot;&lt;/tbody&gt;&lt;/table&gt;&quot;]||(!O.indexOf(&quot;&lt;td&quot;)||!O.indexOf(&quot;&lt;th&quot;))&amp;&amp;[3,&quot;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&quot;,&quot;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&quot;]||!O.indexOf(&quot;&lt;col&quot;)&amp;&amp;[2,&quot;&lt;table&gt;&lt;tbody&gt;&lt;/tbody&gt;&lt;colgroup&gt;&quot;,&quot;&lt;/colgroup&gt;&lt;/table&gt;&quot;]||!o.support.htmlSerialize&amp;&amp;[1,&quot;div&lt;div&gt;&quot;,&quot;&lt;/div&gt;&quot;]||[0,&quot;&quot;,&quot;&quot;];L.innerHTML=Q[1]+S+Q[2];while(Q[0]--){L=L.lastChild}if(!o.support.tbody){var R=/&lt;tbody/i.test(S),N=!O.indexOf(&quot;&lt;table&quot;)&amp;&amp;!R?L.firstChild&amp;&amp;L.firstChild.childNodes:Q[1]==&quot;&lt;table&gt;&quot;&amp;&amp;!R?L.childNodes:[];for(var M=N.length-1;M&gt;=0;--M){if(o.nodeName(N[M],&quot;tbody&quot;)&amp;&amp;!N[M].childNodes.length){N[M].parentNode.removeChild(N[M])}}}if(!o.support.leadingWhitespace&amp;&amp;/^\s/.test(S)){L.insertBefore(K.createTextNode(S.match(/^\s*/)[0]),L.firstChild)}S=o.makeArray(L.childNodes)}if(S.nodeType){G.push(S)}else{G=o.merge(G,S)}});if(I){for(var J=0;G[J];J++){if(o.nodeName(G[J],&quot;script&quot;)&amp;&amp;(!G[J].type||G[J].type.toLowerCase()===&quot;text/javascript&quot;)){E.push(G[J].parentNode?G[J].parentNode.removeChild(G[J]):G[J])}else{if(G[J].nodeType===1){G.splice.apply(G,[J+1,0].concat(o.makeArray(G[J].getElementsByTagName(&quot;script&quot;))))}I.appendChild(G[J])}}return E}return G},attr:function(J,G,K){if(!J||J.nodeType==3||J.nodeType==8){return g}var H=!o.isXMLDoc(J),L=K!==g;G=H&amp;&amp;o.props[G]||G;if(J.tagName){var F=/href|src|style/.test(G);if(G==&quot;selected&quot;&amp;&amp;J.parentNode){J.parentNode.selectedIndex}if(G in J&amp;&amp;H&amp;&amp;!F){if(L){if(G==&quot;type&quot;&amp;&amp;o.nodeName(J,&quot;input&quot;)&amp;&amp;J.parentNode){throw&quot;type property can't be changed&quot;}J[G]=K}if(o.nodeName(J,&quot;form&quot;)&amp;&amp;J.getAttributeNode(G)){return J.getAttributeNode(G).nodeValue}if(G==&quot;tabIndex&quot;){var I=J.getAttributeNode(&quot;tabIndex&quot;);return I&amp;&amp;I.specified?I.value:J.nodeName.match(/(button|input|object|select|textarea)/i)?0:J.nodeName.match(/^(a|area)$/i)&amp;&amp;J.href?0:g}return J[G]}if(!o.support.style&amp;&amp;H&amp;&amp;G==&quot;style&quot;){return o.attr(J.style,&quot;cssText&quot;,K)}if(L){J.setAttribute(G,&quot;&quot;+K)}var E=!o.support.hrefNormalized&amp;&amp;H&amp;&amp;F?J.getAttribute(G,2):J.getAttribute(G);return E===null?g:E}if(!o.support.opacity&amp;&amp;G==&quot;opacity&quot;){if(L){J.zoom=1;J.filter=(J.filter||&quot;&quot;).replace(/alpha\([^)]*\)/,&quot;&quot;)+(parseInt(K)+&quot;&quot;==&quot;NaN&quot;?&quot;&quot;:&quot;alpha(opacity=&quot;+K*100+&quot;)&quot;)}return J.filter&amp;&amp;J.filter.indexOf(&quot;opacity=&quot;)&gt;=0?(parseFloat(J.filter.match(/opacity=([^)]*)/)[1])/100)+&quot;&quot;:&quot;&quot;}G=G.replace(/-([a-z])/ig,function(M,N){return N.toUpperCase()});if(L){J[G]=K}return J[G]},trim:function(E){return(E||&quot;&quot;).replace(/^\s+|\s+$/g,&quot;&quot;)},makeArray:function(G){var E=[];if(G!=null){var F=G.length;if(F==null||typeof G===&quot;string&quot;||o.isFunction(G)||G.setInterval){E[0]=G}else{while(F){E[--F]=G[F]}}}return E},inArray:function(G,H){for(var E=0,F=H.length;E&lt;F;E++){if(H[E]===G){return E}}return -1},merge:function(H,E){var F=0,G,I=H.length;if(!o.support.getAll){while((G=E[F++])!=null){if(G.nodeType!=8){H[I++]=G}}}else{while((G=E[F++])!=null){H[I++]=G}}return H},unique:function(K){var F=[],E={};try{for(var G=0,H=K.length;G&lt;H;G++){var J=o.data(K[G]);if(!E[J]){E[J]=true;F.push(K[G])}}}catch(I){F=K}return F},grep:function(F,J,E){var G=[];for(var H=0,I=F.length;H&lt;I;H++){if(!E!=!J(F[H],H)){G.push(F[H])}}return G},map:function(E,J){var F=[];for(var G=0,H=E.length;G&lt;H;G++){var I=J(E[G],G);if(I!=null){F[F.length]=I}}return F.concat.apply([],F)}});var C=navigator.userAgent.toLowerCase();o.browser={version:(C.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[0,&quot;0&quot;])[1],safari:/webkit/.test(C),opera:/opera/.test(C),msie:/msie/.test(C)&amp;&amp;!/opera/.test(C),mozilla:/mozilla/.test(C)&amp;&amp;!/(compatible|webkit)/.test(C)};o.each({parent:function(E){return E.parentNode},parents:function(E){return o.dir(E,&quot;parentNode&quot;)},next:function(E){return o.nth(E,2,&quot;nextSibling&quot;)},prev:function(E){return o.nth(E,2,&quot;previousSibling&quot;)},nextAll:function(E){return o.dir(E,&quot;nextSibling&quot;)},prevAll:function(E){return o.dir(E,&quot;previousSibling&quot;)},siblings:function(E){return o.sibling(E.parentNode.firstChild,E)},children:function(E){return o.sibling(E.firstChild)},contents:function(E){return o.nodeName(E,&quot;iframe&quot;)?E.contentDocument||E.contentWindow.document:o.makeArray(E.childNodes)}},function(E,F){o.fn[E]=function(G){var H=o.map(this,F);if(G&amp;&amp;typeof G==&quot;string&quot;){H=o.multiFilter(G,H)}return this.pushStack(o.unique(H),E,G)}});o.each({appendTo:&quot;append&quot;,prependTo:&quot;prepend&quot;,insertBefore:&quot;before&quot;,insertAfter:&quot;after&quot;,replaceAll:&quot;replaceWith&quot;},function(E,F){o.fn[E]=function(G){var J=[],L=o(G);for(var K=0,H=L.length;K&lt;H;K++){var I=(K&gt;0?this.clone(true):this).get();o.fn[F].apply(o(L[K]),I);J=J.concat(I)}return this.pushStack(J,E,G)}});o.each({removeAttr:function(E){o.attr(this,E,&quot;&quot;);if(this.nodeType==1){this.removeAttribute(E)}},addClass:function(E){o.className.add(this,E)},removeClass:function(E){o.className.remove(this,E)},toggleClass:function(F,E){if(typeof E!==&quot;boolean&quot;){E=!o.className.has(this,F)}o.className[E?&quot;add&quot;:&quot;remove&quot;](this,F)},remove:function(E){if(!E||o.filter(E,[this]).length){o(&quot;*&quot;,this).add([this]).each(function(){o.event.remove(this);o.removeData(this)});if(this.parentNode){this.parentNode.removeChild(this)}}},empty:function(){o(this).children().remove();while(this.firstChild){this.removeChild(this.firstChild)}}},function(E,F){o.fn[E]=function(){return this.each(F,arguments)}});function j(E,F){return E[0]&amp;&amp;parseInt(o.curCSS(E[0],F,true),10)||0}var h=&quot;jQuery&quot;+e(),v=0,A={};o.extend({cache:{},data:function(F,E,G){F=F==l?A:F;var H=F[h];if(!H){H=F[h]=++v}if(E&amp;&amp;!o.cache[H]){o.cache[H]={}}if(G!==g){o.cache[H][E]=G}return E?(E in o.cache[H] ? o.cache[H][E] : undefined) :H},removeData:function(F,E){F=F==l?A:F;var H=F[h];if(E){if(o.cache[H]){delete o.cache[H][E];E=&quot;&quot;;for(E in o.cache[H]){break}if(!E){o.removeData(F)}}}else{try{delete F[h]}catch(G){if(F.removeAttribute){F.removeAttribute(h)}}delete o.cache[H]}},queue:function(F,E,H){if(F){E=(E||&quot;fx&quot;)+&quot;queue&quot;;var G=o.data(F,E);if(!G||o.isArray(H)){G=o.data(F,E,o.makeArray(H))}else{if(H){G.push(H)}}}return G},dequeue:function(H,G){var E=o.queue(H,G),F=E.shift();if(!G||G===&quot;fx&quot;){F=E[0]}if(F!==g){F.call(H)}}});o.fn.extend({data:function(E,G){var H=E.split(&quot;.&quot;);H[1]=H[1]?&quot;.&quot;+H[1]:&quot;&quot;;if(G===g){var F=this.triggerHandler(&quot;getData&quot;+H[1]+&quot;!&quot;,[H[0]]);if(F===g&amp;&amp;this.length){F=o.data(this[0],E)}return F===g&amp;&amp;H[1]?this.data(H[0]):F}else{return this.trigger(&quot;setData&quot;+H[1]+&quot;!&quot;,[H[0],G]).each(function(){o.data(this,E,G)})}},removeData:function(E){return this.each(function(){o.removeData(this,E)})},queue:function(E,F){if(typeof E!==&quot;string&quot;){F=E;E=&quot;fx&quot;}if(F===g){return o.queue(this[0],E)}return this.each(function(){var G=o.queue(this,E,F);if(E==&quot;fx&quot;&amp;&amp;G.length==1){G[0].call(this)}})},dequeue:function(E){return this.each(function(){o.dequeue(this,E)})}});</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+/*</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+ * Sizzle CSS Selector Engine - v0.9.3</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+ *  Copyright 2009, The Dojo Foundation</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+ *  Released under the MIT, BSD, and GPL Licenses.</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+ *  More information: http://sizzlejs.com/</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+ */</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+(function(){var R=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^[\]]*\]|['&quot;][^'&quot;]*['&quot;]|[^[\]'&quot;]+)+\]|\\.|[^ &gt;+~,(\[\\]+)+|[&gt;+~])(\s*,\s*)?/g,L=0,H=Object.prototype.toString;var F=function(Y,U,ab,ac){ab=ab||[];U=U||document;if(U.nodeType!==1&amp;&amp;U.nodeType!==9){return[]}if(!Y||typeof Y!==&quot;string&quot;){return ab}var Z=[],W,af,ai,T,ad,V,X=true;R.lastIndex=0;while((W=R.exec(Y))!==null){Z.push(W[1]);if(W[2]){V=RegExp.rightContext;break}}if(Z.length&gt;1&amp;&amp;M.exec(Y)){if(Z.length===2&amp;&amp;I.relative[Z[0]]){af=J(Z[0]+Z[1],U)}else{af=I.relative[Z[0]]?[U]:F(Z.shift(),U);while(Z.length){Y=Z.shift();if(I.relative[Y]){Y+=Z.shift()}af=J(Y,af)}}}else{var ae=ac?{expr:Z.pop(),set:E(ac)}:F.find(Z.pop(),Z.length===1&amp;&amp;U.parentNode?U.parentNode:U,Q(U));af=F.filter(ae.expr,ae.set);if(Z.length&gt;0){ai=E(af)}else{X=false}while(Z.length){var ah=Z.pop(),ag=ah;if(!I.relative[ah]){ah=&quot;&quot;}else{ag=Z.pop()}if(ag==null){ag=U}I.relative[ah](ai,ag,Q(U))}}if(!ai){ai=af}if(!ai){throw&quot;Syntax error, unrecognized expression: &quot;+(ah||Y)}if(H.call(ai)===&quot;[object Array]&quot;){if(!X){ab.push.apply(ab,ai)}else{if(U.nodeType===1){for(var aa=0;ai[aa]!=null;aa++){if(ai[aa]&amp;&amp;(ai[aa]===true||ai[aa].nodeType===1&amp;&amp;K(U,ai[aa]))){ab.push(af[aa])}}}else{for(var aa=0;ai[aa]!=null;aa++){if(ai[aa]&amp;&amp;ai[aa].nodeType===1){ab.push(af[aa])}}}}}else{E(ai,ab)}if(V){F(V,U,ab,ac);if(G){hasDuplicate=false;ab.sort(G);if(hasDuplicate){for(var aa=1;aa&lt;ab.length;aa++){if(ab[aa]===ab[aa-1]){ab.splice(aa--,1)}}}}}return ab};F.matches=function(T,U){return F(T,null,null,U)};F.find=function(aa,T,ab){var Z,X;if(!aa){return[]}for(var W=0,V=I.order.length;W&lt;V;W++){var Y=I.order[W],X;if((X=I.match[Y].exec(aa))){var U=RegExp.leftContext;if(U.substr(U.length-1)!==&quot;\\&quot;){X[1]=(X[1]||&quot;&quot;).replace(/\\/g,&quot;&quot;);Z=I.find[Y](X,T,ab);if(Z!=null){aa=aa.replace(I.match[Y],&quot;&quot;);break}}}}if(!Z){Z=T.getElementsByTagName(&quot;*&quot;)}return{set:Z,expr:aa}};F.filter=function(ad,ac,ag,W){var V=ad,ai=[],aa=ac,Y,T,Z=ac&amp;&amp;ac[0]&amp;&amp;Q(ac[0]);while(ad&amp;&amp;ac.length){for(var ab in I.filter){if((Y=I.match[ab].exec(ad))!=null){var U=I.filter[ab],ah,af;T=false;if(aa==ai){ai=[]}if(I.preFilter[ab]){Y=I.preFilter[ab](Y,aa,ag,ai,W,Z);if(!Y){T=ah=true}else{if(Y===true){continue}}}if(Y){for(var X=0;(af=aa[X])!=null;X++){if(af){ah=U(af,Y,X,aa);var ae=W^!!ah;if(ag&amp;&amp;ah!=null){if(ae){T=true}else{aa[X]=false}}else{if(ae){ai.push(af);T=true}}}}}if(ah!==g){if(!ag){aa=ai}ad=ad.replace(I.match[ab],&quot;&quot;);if(!T){return[]}break}}}if(ad==V){if(T==null){throw&quot;Syntax error, unrecognized expression: &quot;+ad}else{break}}V=ad}return aa};var I=F.selectors={order:[&quot;ID&quot;,&quot;NAME&quot;,&quot;TAG&quot;],match:{ID:/#((?:[\w\u00c0-\uFFFF_-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF_-]|\\.)+)/,NAME:/\[name=['&quot;]*((?:[\w\u00c0-\uFFFF_-]|\\.)+)['&quot;]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF_-]|\\.)+)\s*(?:(\S?=)\s*(['&quot;]*)(.*?)\3|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*_-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\((even|odd|[\dn+-]*)\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF_-]|\\.)+)(?:\((['&quot;]*)((?:\([^\)]+\)|[^\2\(\)]*)+)\2\))?/},attrMap:{&quot;class&quot;:&quot;className&quot;,&quot;for&quot;:&quot;htmlFor&quot;},attrHandle:{href:function(T){return T.getAttribute(&quot;href&quot;)}},relative:{&quot;+&quot;:function(aa,T,Z){var X=typeof T===&quot;string&quot;,ab=X&amp;&amp;!/\W/.test(T),Y=X&amp;&amp;!ab;if(ab&amp;&amp;!Z){T=T.toUpperCase()}for(var W=0,V=aa.length,U;W&lt;V;W++){if((U=aa[W])){while((U=U.previousSibling)&amp;&amp;U.nodeType!==1){}aa[W]=Y||U&amp;&amp;U.nodeName===T?U||false:U===T}}if(Y){F.filter(T,aa,true)}},&quot;&gt;&quot;:function(Z,U,aa){var X=typeof U===&quot;string&quot;;if(X&amp;&amp;!/\W/.test(U)){U=aa?U:U.toUpperCase();for(var V=0,T=Z.length;V&lt;T;V++){var Y=Z[V];if(Y){var W=Y.parentNode;Z[V]=W.nodeName===U?W:false}}}else{for(var V=0,T=Z.length;V&lt;T;V++){var Y=Z[V];if(Y){Z[V]=X?Y.parentNode:Y.parentNode===U}}if(X){F.filter(U,Z,true)}}},&quot;&quot;:function(W,U,Y){var V=L++,T=S;if(!U.match(/\W/)){var X=U=Y?U:U.toUpperCase();T=P}T(&quot;parentNode&quot;,U,V,W,X,Y)},&quot;~&quot;:function(W,U,Y){var V=L++,T=S;if(typeof U===&quot;string&quot;&amp;&amp;!U.match(/\W/)){var X=U=Y?U:U.toUpperCase();T=P}T(&quot;previousSibling&quot;,U,V,W,X,Y)}},find:{ID:function(U,V,W){if(typeof V.getElementById!==&quot;undefined&quot;&amp;&amp;!W){var T=V.getElementById(U[1]);return T?[T]:[]}},NAME:function(V,Y,Z){if(typeof Y.getElementsByName!==&quot;undefined&quot;){var U=[],X=Y.getElementsByName(V[1]);for(var W=0,T=X.length;W&lt;T;W++){if(X[W].getAttribute(&quot;name&quot;)===V[1]){U.push(X[W])}}return U.length===0?null:U}},TAG:function(T,U){return U.getElementsByTagName(T[1])}},preFilter:{CLASS:function(W,U,V,T,Z,aa){W=&quot; &quot;+W[1].replace(/\\/g,&quot;&quot;)+&quot; &quot;;if(aa){return W}for(var X=0,Y;(Y=U[X])!=null;X++){if(Y){if(Z^(Y.className&amp;&amp;(&quot; &quot;+Y.className+&quot; &quot;).indexOf(W)&gt;=0)){if(!V){T.push(Y)}}else{if(V){U[X]=false}}}}return false},ID:function(T){return T[1].replace(/\\/g,&quot;&quot;)},TAG:function(U,T){for(var V=0;T[V]===false;V++){}return T[V]&amp;&amp;Q(T[V])?U[1]:U[1].toUpperCase()},CHILD:function(T){if(T[1]==&quot;nth&quot;){var U=/(-?)(\d*)n((?:\+|-)?\d*)/.exec(T[2]==&quot;even&quot;&amp;&amp;&quot;2n&quot;||T[2]==&quot;odd&quot;&amp;&amp;&quot;2n+1&quot;||!/\D/.test(T[2])&amp;&amp;&quot;0n+&quot;+T[2]||T[2]);T[2]=(U[1]+(U[2]||1))-0;T[3]=U[3]-0}T[0]=L++;return T},ATTR:function(X,U,V,T,Y,Z){var W=X[1].replace(/\\/g,&quot;&quot;);if(!Z&amp;&amp;I.attrMap[W]){X[1]=I.attrMap[W]}if(X[2]===&quot;~=&quot;){X[4]=&quot; &quot;+X[4]+&quot; &quot;}return X},PSEUDO:function(X,U,V,T,Y){if(X[1]===&quot;not&quot;){if(X[3].match(R).length&gt;1||/^\w/.test(X[3])){X[3]=F(X[3],null,null,U)}else{var W=F.filter(X[3],U,V,true^Y);if(!V){T.push.apply(T,W)}return false}}else{if(I.match.POS.test(X[0])||I.match.CHILD.test(X[0])){return true}}return X},POS:function(T){T.unshift(true);return T}},filters:{enabled:function(T){return T.disabled===false&amp;&amp;T.type!==&quot;hidden&quot;},disabled:function(T){return T.disabled===true},checked:function(T){return T.checked===true},selected:function(T){T.parentNode.selectedIndex;return T.selected===true},parent:function(T){return !!T.firstChild},empty:function(T){return !T.firstChild},has:function(V,U,T){return !!F(T[3],V).length},header:function(T){return/h\d/i.test(T.nodeName)},text:function(T){return&quot;text&quot;===T.type},radio:function(T){return&quot;radio&quot;===T.type},checkbox:function(T){return&quot;checkbox&quot;===T.type},file:function(T){return&quot;file&quot;===T.type},password:function(T){return&quot;password&quot;===T.type},submit:function(T){return&quot;submit&quot;===T.type},image:function(T){return&quot;image&quot;===T.type},reset:function(T){return&quot;reset&quot;===T.type},button:function(T){return&quot;button&quot;===T.type||T.nodeName.toUpperCase()===&quot;BUTTON&quot;},input:function(T){return/input|select|textarea|button/i.test(T.nodeName)}},setFilters:{first:function(U,T){return T===0},last:function(V,U,T,W){return U===W.length-1},even:function(U,T){return T%2===0},odd:function(U,T){return T%2===1},lt:function(V,U,T){return U&lt;T[3]-0},gt:function(V,U,T){return U&gt;T[3]-0},nth:function(V,U,T){return T[3]-0==U},eq:function(V,U,T){return T[3]-0==U}},filter:{PSEUDO:function(Z,V,W,aa){var U=V[1],X=I.filters[U];if(X){return X(Z,W,V,aa)}else{if(U===&quot;contains&quot;){return(Z.textContent||Z.innerText||&quot;&quot;).indexOf(V[3])&gt;=0}else{if(U===&quot;not&quot;){var Y=V[3];for(var W=0,T=Y.length;W&lt;T;W++){if(Y[W]===Z){return false}}return true}}}},CHILD:function(T,W){var Z=W[1],U=T;switch(Z){case&quot;only&quot;:case&quot;first&quot;:while(U=U.previousSibling){if(U.nodeType===1){return false}}if(Z==&quot;first&quot;){return true}U=T;case&quot;last&quot;:while(U=U.nextSibling){if(U.nodeType===1){return false}}return true;case&quot;nth&quot;:var V=W[2],ac=W[3];if(V==1&amp;&amp;ac==0){return true}var Y=W[0],ab=T.parentNode;if(ab&amp;&amp;(ab.sizcache!==Y||!T.nodeIndex)){var X=0;for(U=ab.firstChild;U;U=U.nextSibling){if(U.nodeType===1){U.nodeIndex=++X}}ab.sizcache=Y}var aa=T.nodeIndex-ac;if(V==0){return aa==0}else{return(aa%V==0&amp;&amp;aa/V&gt;=0)}}},ID:function(U,T){return U.nodeType===1&amp;&amp;U.getAttribute(&quot;id&quot;)===T},TAG:function(U,T){return(T===&quot;*&quot;&amp;&amp;U.nodeType===1)||U.nodeName===T},CLASS:function(U,T){return(&quot; &quot;+(U.className||U.getAttribute(&quot;class&quot;))+&quot; &quot;).indexOf(T)&gt;-1},ATTR:function(Y,W){var V=W[1],T=I.attrHandle[V]?I.attrHandle[V](Y):Y[V]!=null?Y[V]:Y.getAttribute(V),Z=T+&quot;&quot;,X=W[2],U=W[4];return T==null?X===&quot;!=&quot;:X===&quot;=&quot;?Z===U:X===&quot;*=&quot;?Z.indexOf(U)&gt;=0:X===&quot;~=&quot;?(&quot; &quot;+Z+&quot; &quot;).indexOf(U)&gt;=0:!U?Z&amp;&amp;T!==false:X===&quot;!=&quot;?Z!=U:X===&quot;^=&quot;?Z.indexOf(U)===0:X===&quot;$=&quot;?Z.substr(Z.length-U.length)===U:X===&quot;|=&quot;?Z===U||Z.substr(0,U.length+1)===U+&quot;-&quot;:false},POS:function(X,U,V,Y){var T=U[2],W=I.setFilters[T];if(W){return W(X,V,U,Y)}}}};var M=I.match.POS;for(var O in I.match){I.match[O]=RegExp(I.match[O].source+/(?![^\[]*\])(?![^\(]*\))/.source)}var E=function(U,T){U=Array.prototype.slice.call(U);if(T){T.push.apply(T,U);return T}return U};try{Array.prototype.slice.call(document.documentElement.childNodes)}catch(N){E=function(X,W){var U=W||[];if(H.call(X)===&quot;[object Array]&quot;){Array.prototype.push.apply(U,X)}else{if(typeof X.length===&quot;number&quot;){for(var V=0,T=X.length;V&lt;T;V++){U.push(X[V])}}else{for(var V=0;X[V];V++){U.push(X[V])}}}return U}}var G;if(document.documentElement.compareDocumentPosition){G=function(U,T){var V=U.compareDocumentPosition(T)&amp;4?-1:U===T?0:1;if(V===0){hasDuplicate=true}return V}}else{if(&quot;sourceIndex&quot; in document.documentElement){G=function(U,T){var V=U.sourceIndex-T.sourceIndex;if(V===0){hasDuplicate=true}return V}}else{if(document.createRange){G=function(W,U){var V=W.ownerDocument.createRange(),T=U.ownerDocument.createRange();V.selectNode(W);V.collapse(true);T.selectNode(U);T.collapse(true);var X=V.compareBoundaryPoints(Range.START_TO_END,T);if(X===0){hasDuplicate=true}return X}}}}(function(){var U=document.createElement(&quot;form&quot;),V=&quot;script&quot;+(new Date).getTime();U.innerHTML=&quot;&lt;input name='&quot;+V+&quot;'/&gt;&quot;;var T=document.documentElement;T.insertBefore(U,T.firstChild);if(!!document.getElementById(V)){I.find.ID=function(X,Y,Z){if(typeof Y.getElementById!==&quot;undefined&quot;&amp;&amp;!Z){var W=Y.getElementById(X[1]);return W?W.id===X[1]||typeof W.getAttributeNode!==&quot;undefined&quot;&amp;&amp;W.getAttributeNode(&quot;id&quot;).nodeValue===X[1]?[W]:g:[]}};I.filter.ID=function(Y,W){var X=typeof Y.getAttributeNode!==&quot;undefined&quot;&amp;&amp;Y.getAttributeNode(&quot;id&quot;);return Y.nodeType===1&amp;&amp;X&amp;&amp;X.nodeValue===W}}T.removeChild(U)})();(function(){var T=document.createElement(&quot;div&quot;);T.appendChild(document.createComment(&quot;&quot;));if(T.getElementsByTagName(&quot;*&quot;).length&gt;0){I.find.TAG=function(U,Y){var X=Y.getElementsByTagName(U[1]);if(U[1]===&quot;*&quot;){var W=[];for(var V=0;X[V];V++){if(X[V].nodeType===1){W.push(X[V])}}X=W}return X}}T.innerHTML=&quot;&lt;a href='#'&gt;&lt;/a&gt;&quot;;if(T.firstChild&amp;&amp;typeof T.firstChild.getAttribute!==&quot;undefined&quot;&amp;&amp;T.firstChild.getAttribute(&quot;href&quot;)!==&quot;#&quot;){I.attrHandle.href=function(U){return U.getAttribute(&quot;href&quot;,2)}}})();if(document.querySelectorAll){(function(){var T=F,U=document.createElement(&quot;div&quot;);U.innerHTML=&quot;&lt;p class='TEST'&gt;&lt;/p&gt;&quot;;if(U.querySelectorAll&amp;&amp;U.querySelectorAll(&quot;.TEST&quot;).length===0){return}F=function(Y,X,V,W){X=X||document;if(!W&amp;&amp;X.nodeType===9&amp;&amp;!Q(X)){try{return E(X.querySelectorAll(Y),V)}catch(Z){}}return T(Y,X,V,W)};F.find=T.find;F.filter=T.filter;F.selectors=T.selectors;F.matches=T.matches})()}if(document.getElementsByClassName&amp;&amp;document.documentElement.getElementsByClassName){(function(){var T=document.createElement(&quot;div&quot;);T.innerHTML=&quot;&lt;div class='test e'&gt;&lt;/div&gt;&lt;div class='test'&gt;&lt;/div&gt;&quot;;if(T.getElementsByClassName(&quot;e&quot;).length===0){return}T.lastChild.className=&quot;e&quot;;if(T.getElementsByClassName(&quot;e&quot;).length===1){return}I.order.splice(1,0,&quot;CLASS&quot;);I.find.CLASS=function(U,V,W){if(typeof V.getElementsByClassName!==&quot;undefined&quot;&amp;&amp;!W){return V.getElementsByClassName(U[1])}}})()}function P(U,Z,Y,ad,aa,ac){var ab=U==&quot;previousSibling&quot;&amp;&amp;!ac;for(var W=0,V=ad.length;W&lt;V;W++){var T=ad[W];if(T){if(ab&amp;&amp;T.nodeType===1){T.sizcache=Y;T.sizset=W}T=T[U];var X=false;while(T){if(T.sizcache===Y){X=ad[T.sizset];break}if(T.nodeType===1&amp;&amp;!ac){T.sizcache=Y;T.sizset=W}if(T.nodeName===Z){X=T;break}T=T[U]}ad[W]=X}}}function S(U,Z,Y,ad,aa,ac){var ab=U==&quot;previousSibling&quot;&amp;&amp;!ac;for(var W=0,V=ad.length;W&lt;V;W++){var T=ad[W];if(T){if(ab&amp;&amp;T.nodeType===1){T.sizcache=Y;T.sizset=W}T=T[U];var X=false;while(T){if(T.sizcache===Y){X=ad[T.sizset];break}if(T.nodeType===1){if(!ac){T.sizcache=Y;T.sizset=W}if(typeof Z!==&quot;string&quot;){if(T===Z){X=true;break}}else{if(F.filter(Z,[T]).length&gt;0){X=T;break}}}T=T[U]}ad[W]=X}}}var K=document.compareDocumentPosition?function(U,T){return U.compareDocumentPosition(T)&amp;16}:function(U,T){return U!==T&amp;&amp;(U.contains?U.contains(T):true)};var Q=function(T){return T.nodeType===9&amp;&amp;T.documentElement.nodeName!==&quot;HTML&quot;||!!T.ownerDocument&amp;&amp;Q(T.ownerDocument)};var J=function(T,aa){var W=[],X=&quot;&quot;,Y,V=aa.nodeType?[aa]:aa;while((Y=I.match.PSEUDO.exec(T))){X+=Y[0];T=T.replace(I.match.PSEUDO,&quot;&quot;)}T=I.relative[T]?T+&quot;*&quot;:T;for(var Z=0,U=V.length;Z&lt;U;Z++){F(T,V[Z],W)}return F.filter(X,W)};o.find=F;o.filter=F.filter;o.expr=F.selectors;o.expr[&quot;:&quot;]=o.expr.filters;F.selectors.filters.hidden=function(T){return T.offsetWidth===0||T.offsetHeight===0};F.selectors.filters.visible=function(T){return T.offsetWidth&gt;0||T.offsetHeight&gt;0};F.selectors.filters.animated=function(T){return o.grep(o.timers,function(U){return T===U.elem}).length};o.multiFilter=function(V,T,U){if(U){V=&quot;:not(&quot;+V+&quot;)&quot;}return F.matches(V,T)};o.dir=function(V,U){var T=[],W=V[U];while(W&amp;&amp;W!=document){if(W.nodeType==1){T.push(W)}W=W[U]}return T};o.nth=function(X,T,V,W){T=T||1;var U=0;for(;X;X=X[V]){if(X.nodeType==1&amp;&amp;++U==T){break}}return X};o.sibling=function(V,U){var T=[];for(;V;V=V.nextSibling){if(V.nodeType==1&amp;&amp;V!=U){T.push(V)}}return T};return;l.Sizzle=F})();o.event={add:function(I,F,H,K){if(I.nodeType==3||I.nodeType==8){return}if(I.setInterval&amp;&amp;I!=l){I=l}if(!H.guid){H.guid=this.guid++}if(K!==g){var G=H;H=this.proxy(G);H.data=K}var E=o.data(I,&quot;events&quot;)||o.data(I,&quot;events&quot;,{}),J=o.data(I,&quot;handle&quot;)||o.data(I,&quot;handle&quot;,function(){return typeof o!==&quot;undefined&quot;&amp;&amp;!o.event.triggered?o.event.handle.apply(arguments.callee.elem,arguments):g});J.elem=I;o.each(F.split(/\s+/),function(M,N){var O=N.split(&quot;.&quot;);N=O.shift();H.type=O.slice().sort().join(&quot;.&quot;);var L=E[N];if(o.event.specialAll[N]){o.event.specialAll[N].setup.call(I,K,O)}if(!L){L=E[N]={};if(!o.event.special[N]||o.event.special[N].setup.call(I,K,O)===false){if(I.addEventListener){I.addEventListener(N,J,false)}else{if(I.attachEvent){I.attachEvent(&quot;on&quot;+N,J)}}}}L[H.guid]=H;o.event.global[N]=true});I=null},guid:1,global:{},remove:function(K,H,J){if(K.nodeType==3||K.nodeType==8){return}var G=o.data(K,&quot;events&quot;),F,E;if(G){if(H===g||(typeof H===&quot;string&quot;&amp;&amp;H.charAt(0)==&quot;.&quot;)){for(var I in G){this.remove(K,I+(H||&quot;&quot;))}}else{if(H.type){J=H.handler;H=H.type}o.each(H.split(/\s+/),function(M,O){var Q=O.split(&quot;.&quot;);O=Q.shift();var N=RegExp(&quot;(^|\\.)&quot;+Q.slice().sort().join(&quot;.*\\.&quot;)+&quot;(\\.|$)&quot;);if(G[O]){if(J){delete G[O][J.guid]}else{for(var P in G[O]){if(N.test(G[O][P].type)){delete G[O][P]}}}if(o.event.specialAll[O]){o.event.specialAll[O].teardown.call(K,Q)}for(F in G[O]){break}if(!F){if(!o.event.special[O]||o.event.special[O].teardown.call(K,Q)===false){if(K.removeEventListener){K.removeEventListener(O,o.data(K,&quot;handle&quot;),false)}else{if(K.detachEvent){K.detachEvent(&quot;on&quot;+O,o.data(K,&quot;handle&quot;))}}}F=null;delete G[O]}}})}for(F in G){break}if(!F){var L=o.data(K,&quot;handle&quot;);if(L){L.elem=null}o.removeData(K,&quot;events&quot;);o.removeData(K,&quot;handle&quot;)}}},trigger:function(I,K,H,E){var G=I.type||I;if(!E){I=typeof I===&quot;object&quot;?I[h]?I:o.extend(o.Event(G),I):o.Event(G);if(G.indexOf(&quot;!&quot;)&gt;=0){I.type=G=G.slice(0,-1);I.exclusive=true}if(!H){I.stopPropagation();if(this.global[G]){o.each(o.cache,function(){if(this.events&amp;&amp;this.events[G]){o.event.trigger(I,K,this.handle.elem)}})}}if(!H||H.nodeType==3||H.nodeType==8){return g}I.result=g;I.target=H;K=o.makeArray(K);K.unshift(I)}I.currentTarget=H;var J=o.data(H,&quot;handle&quot;);if(J){J.apply(H,K)}if((!H[G]||(o.nodeName(H,&quot;a&quot;)&amp;&amp;G==&quot;click&quot;))&amp;&amp;H[&quot;on&quot;+G]&amp;&amp;H[&quot;on&quot;+G].apply(H,K)===false){I.result=false}if(!E&amp;&amp;H[G]&amp;&amp;!I.isDefaultPrevented()&amp;&amp;!(o.nodeName(H,&quot;a&quot;)&amp;&amp;G==&quot;click&quot;)){this.triggered=true;try{H[G]()}catch(L){}}this.triggered=false;if(!I.isPropagationStopped()){var F=H.parentNode||H.ownerDocument;if(F){o.event.trigger(I,K,F,true)}}},handle:function(K){var J,E;K=arguments[0]=o.event.fix(K||l.event);K.currentTarget=this;var L=K.type.split(&quot;.&quot;);K.type=L.shift();J=!L.length&amp;&amp;!K.exclusive;var I=RegExp(&quot;(^|\\.)&quot;+L.slice().sort().join(&quot;.*\\.&quot;)+&quot;(\\.|$)&quot;);E=(o.data(this,&quot;events&quot;)||{})[K.type];for(var G in E){var H=E[G];if(J||I.test(H.type)){K.handler=H;K.data=H.data;var F=H.apply(this,arguments);if(F!==g){K.result=F;if(F===false){K.preventDefault();K.stopPropagation()}}if(K.isImmediatePropagationStopped()){break}}}},props:&quot;altKey attrChange attrName bubbles button cancelable charCode clientX clientY ctrlKey currentTarget data detail eventPhase fromElement handler keyCode metaKey newValue originalTarget pageX pageY prevValue relatedNode relatedTarget screenX screenY shiftKey srcElement target toElement view wheelDelta which&quot;.split(&quot; &quot;),fix:function(H){if(H[h]){return H}var F=H;H=o.Event(F);for(var G=this.props.length,J;G;){J=this.props[--G];H[J]=F[J]}if(!H.target){H.target=H.srcElement||document}if(H.target.nodeType==3){H.target=H.target.parentNode}if(!H.relatedTarget&amp;&amp;H.fromElement){H.relatedTarget=H.fromElement==H.target?H.toElement:H.fromElement}if(H.pageX==null&amp;&amp;H.clientX!=null){var I=document.documentElement,E=document.body;H.pageX=H.clientX+(I&amp;&amp;I.scrollLeft||E&amp;&amp;E.scrollLeft||0)-(I.clientLeft||0);H.pageY=H.clientY+(I&amp;&amp;I.scrollTop||E&amp;&amp;E.scrollTop||0)-(I.clientTop||0)}if(!H.which&amp;&amp;((H.charCode||H.charCode===0)?H.charCode:H.keyCode)){H.which=H.charCode||H.keyCode}if(!H.metaKey&amp;&amp;H.ctrlKey){H.metaKey=H.ctrlKey}if(!H.which&amp;&amp;H.button){H.which=(H.button&amp;1?1:(H.button&amp;2?3:(H.button&amp;4?2:0)))}return H},proxy:function(F,E){E=E||function(){return F.apply(this,arguments)};E.guid=F.guid=F.guid||E.guid||this.guid++;return E},special:{ready:{setup:B,teardown:function(){}}},specialAll:{live:{setup:function(E,F){o.event.add(this,F[0],c)},teardown:function(G){if(G.length){var E=0,F=RegExp(&quot;(^|\\.)&quot;+G[0]+&quot;(\\.|$)&quot;);o.each((o.data(this,&quot;events&quot;).live||{}),function(){if(F.test(this.type)){E++}});if(E&lt;1){o.event.remove(this,G[0],c)}}}}}};o.Event=function(E){if(!this.preventDefault){return new o.Event(E)}if(E&amp;&amp;E.type){this.originalEvent=E;this.type=E.type}else{this.type=E}this.timeStamp=e();this[h]=true};function k(){return false}function u(){return true}o.Event.prototype={preventDefault:function(){this.isDefaultPrevented=u;var E=this.originalEvent;if(!E){return}if(E.preventDefault){E.preventDefault()}E.returnValue=false},stopPropagation:function(){this.isPropagationStopped=u;var E=this.originalEvent;if(!E){return}if(E.stopPropagation){E.stopPropagation()}E.cancelBubble=true},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=u;this.stopPropagation()},isDefaultPrevented:k,isPropagationStopped:k,isImmediatePropagationStopped:k};var a=function(F){var E=F.relatedTarget;while(E&amp;&amp;E!=this){try{E=E.parentNode}catch(G){E=this}}if(E!=this){F.type=F.data;o.event.handle.apply(this,arguments)}};o.each({mouseover:&quot;mouseenter&quot;,mouseout:&quot;mouseleave&quot;},function(F,E){o.event.special[E]={setup:function(){o.event.add(this,F,a,E)},teardown:function(){o.event.remove(this,F,a)}}});o.fn.extend({bind:function(F,G,E){return F==&quot;unload&quot;?this.one(F,G,E):this.each(function(){o.event.add(this,F,E||G,E&amp;&amp;G)})},one:function(G,H,F){var E=o.event.proxy(F||H,function(I){o(this).unbind(I,E);return(F||H).apply(this,arguments)});return this.each(function(){o.event.add(this,G,E,F&amp;&amp;H)})},unbind:function(F,E){return this.each(function(){o.event.remove(this,F,E)})},trigger:function(E,F){return this.each(function(){o.event.trigger(E,F,this)})},triggerHandler:function(E,G){if(this[0]){var F=o.Event(E);F.preventDefault();F.stopPropagation();o.event.trigger(F,G,this[0]);return F.result}},toggle:function(G){var E=arguments,F=1;while(F&lt;E.length){o.event.proxy(G,E[F++])}return this.click(o.event.proxy(G,function(H){this.lastToggle=(this.lastToggle||0)%F;H.preventDefault();return E[this.lastToggle++].apply(this,arguments)||false}))},hover:function(E,F){return this.mouseenter(E).mouseleave(F)},ready:function(E){B();if(o.isReady){E.call(document,o)}else{o.readyList.push(E)}return this},live:function(G,F){var E=o.event.proxy(F);E.guid+=this.selector+G;o(document).bind(i(G,this.selector),this.selector,E);return this},die:function(F,E){o(document).unbind(i(F,this.selector),E?{guid:E.guid+this.selector+F}:null);return this}});function c(H){var E=RegExp(&quot;(^|\\.)&quot;+H.type+&quot;(\\.|$)&quot;),G=true,F=[];o.each(o.data(this,&quot;events&quot;).live||[],function(I,J){if(E.test(J.type)){var K=o(H.target).closest(J.data)[0];if(K){F.push({elem:K,fn:J})}}});F.sort(function(J,I){return o.data(J.elem,&quot;closest&quot;)-o.data(I.elem,&quot;closest&quot;)});o.each(F,function(){if(this.fn.call(this.elem,H,this.fn.data)===false){return(G=false)}});return G}function i(F,E){return[&quot;live&quot;,F,E.replace(/\./g,&quot;`&quot;).replace(/ /g,&quot;|&quot;)].join(&quot;.&quot;)}o.extend({isReady:false,readyList:[],ready:function(){if(!o.isReady){o.isReady=true;if(o.readyList){o.each(o.readyList,function(){this.call(document,o)});o.readyList=null}o(document).triggerHandler(&quot;ready&quot;)}}});var x=false;function B(){if(x){return}x=true;if(document.addEventListener){document.addEventListener(&quot;DOMContentLoaded&quot;,function(){document.removeEventListener(&quot;DOMContentLoaded&quot;,arguments.callee,false);o.ready()},false)}else{if(document.attachEvent){document.attachEvent(&quot;onreadystatechange&quot;,function(){if(document.readyState===&quot;complete&quot;){document.detachEvent(&quot;onreadystatechange&quot;,arguments.callee);o.ready()}});if(document.documentElement.doScroll&amp;&amp;l==l.top){(function(){if(o.isReady){return}try{document.documentElement.doScroll(&quot;left&quot;)}catch(E){setTimeout(arguments.callee,0);return}o.ready()})()}}}o.event.add(l,&quot;load&quot;,o.ready)}o.each((&quot;blur,focus,load,resize,scroll,unload,click,dblclick,mousedown,mouseup,mousemove,mouseover,mouseout,mouseenter,mouseleave,change,select,submit,keydown,keypress,keyup,error&quot;).split(&quot;,&quot;),function(F,E){o.fn[E]=function(G){return G?this.bind(E,G):this.trigger(E)}});o(l).bind(&quot;unload&quot;,function(){for(var E in o.cache){if(E!=1&amp;&amp;o.cache[E].handle){o.event.remove(o.cache[E].handle.elem)}}});(function(){o.support={};var F=document.documentElement,G=document.createElement(&quot;script&quot;),K=document.createElement(&quot;div&quot;),J=&quot;script&quot;+(new Date).getTime();K.style.display=&quot;none&quot;;K.innerHTML='   &lt;link/&gt;&lt;table&gt;&lt;/table&gt;&lt;a href=&quot;/a&quot; style=&quot;color:red;float:left;opacity:.5;&quot;&gt;a&lt;/a&gt;&lt;select&gt;&lt;option&gt;text&lt;/option&gt;&lt;/select&gt;&lt;object&gt;&lt;param/&gt;&lt;/object&gt;';var H=K.getElementsByTagName(&quot;*&quot;),E=K.getElementsByTagName(&quot;a&quot;)[0];if(!H||!H.length||!E){return}o.support={leadingWhitespace:K.firstChild.nodeType==3,tbody:!K.getElementsByTagName(&quot;tbody&quot;).length,objectAll:!!K.getElementsByTagName(&quot;object&quot;)[0].getElementsByTagName(&quot;*&quot;).length,htmlSerialize:!!K.getElementsByTagName(&quot;link&quot;).length,style:/red/.test(E.getAttribute(&quot;style&quot;)),hrefNormalized:E.getAttribute(&quot;href&quot;)===&quot;/a&quot;,opacity:E.style.opacity===&quot;0.5&quot;,cssFloat:!!E.style.cssFloat,scriptEval:false,noCloneEvent:true,boxModel:null};G.type=&quot;text/javascript&quot;;try{G.appendChild(document.createTextNode(&quot;window.&quot;+J+&quot;=1;&quot;))}catch(I){}F.insertBefore(G,F.firstChild);if(l[J]){o.support.scriptEval=true;delete l[J]}F.removeChild(G);if(K.attachEvent&amp;&amp;K.fireEvent){K.attachEvent(&quot;onclick&quot;,function(){o.support.noCloneEvent=false;K.detachEvent(&quot;onclick&quot;,arguments.callee)});K.cloneNode(true).fireEvent(&quot;onclick&quot;)}o(function(){var L=document.createElement(&quot;div&quot;);L.style.width=L.style.paddingLeft=&quot;1px&quot;;document.body.appendChild(L);o.boxModel=o.support.boxModel=L.offsetWidth===2;document.body.removeChild(L).style.display=&quot;none&quot;})})();var w=o.support.cssFloat?&quot;cssFloat&quot;:&quot;styleFloat&quot;;o.props={&quot;for&quot;:&quot;htmlFor&quot;,&quot;class&quot;:&quot;className&quot;,&quot;float&quot;:w,cssFloat:w,styleFloat:w,readonly:&quot;readOnly&quot;,maxlength:&quot;maxLength&quot;,cellspacing:&quot;cellSpacing&quot;,rowspan:&quot;rowSpan&quot;,tabindex:&quot;tabIndex&quot;};o.fn.extend({_load:o.fn.load,load:function(G,J,K){if(typeof G!==&quot;string&quot;){return this._load(G)}var I=G.indexOf(&quot; &quot;);if(I&gt;=0){var E=G.slice(I,G.length);G=G.slice(0,I)}var H=&quot;GET&quot;;if(J){if(o.isFunction(J)){K=J;J=null}else{if(typeof J===&quot;object&quot;){J=o.param(J);H=&quot;POST&quot;}}}var F=this;o.ajax({url:G,type:H,dataType:&quot;html&quot;,data:J,complete:function(M,L){if(L==&quot;success&quot;||L==&quot;notmodified&quot;){F.html(E?o(&quot;&lt;div/&gt;&quot;).append(M.responseText.replace(/&lt;script(.|\s)*?\/script&gt;/g,&quot;&quot;)).find(E):M.responseText)}if(K){F.each(K,[M.responseText,L,M])}}});return this},serialize:function(){return o.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?o.makeArray(this.elements):this}).filter(function(){return this.name&amp;&amp;!this.disabled&amp;&amp;(this.checked||/select|textarea/i.test(this.nodeName)||/text|hidden|password|search/i.test(this.type))}).map(function(E,F){var G=o(this).val();return G==null?null:o.isArray(G)?o.map(G,function(I,H){return{name:F.name,value:I}}):{name:F.name,value:G}}).get()}});o.each(&quot;ajaxStart,ajaxStop,ajaxComplete,ajaxError,ajaxSuccess,ajaxSend&quot;.split(&quot;,&quot;),function(E,F){o.fn[F]=function(G){return this.bind(F,G)}});var r=e();o.extend({get:function(E,G,H,F){if(o.isFunction(G)){H=G;G=null}return o.ajax({type:&quot;GET&quot;,url:E,data:G,success:H,dataType:F})},getScript:function(E,F){return o.get(E,null,F,&quot;script&quot;)},getJSON:function(E,F,G){return o.get(E,F,G,&quot;json&quot;)},post:function(E,G,H,F){if(o.isFunction(G)){H=G;G={}}return o.ajax({type:&quot;POST&quot;,url:E,data:G,success:H,dataType:F})},ajaxSetup:function(E){o.extend(o.ajaxSettings,E)},ajaxSettings:{url:location.href,global:true,type:&quot;GET&quot;,contentType:&quot;application/x-www-form-urlencoded&quot;,processData:true,async:true,xhr:function(){return l.ActiveXObject?new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;):new XMLHttpRequest()},accepts:{xml:&quot;application/xml, text/xml&quot;,html:&quot;text/html&quot;,script:&quot;text/javascript, application/javascript&quot;,json:&quot;application/json, text/javascript&quot;,text:&quot;text/plain&quot;,_default:&quot;*/*&quot;}},lastModified:{},ajax:function(M){M=o.extend(true,M,o.extend(true,{},o.ajaxSettings,M));var W,F=/=\?(&amp;|$)/g,R,V,G=M.type.toUpperCase();if(M.data&amp;&amp;M.processData&amp;&amp;typeof M.data!==&quot;string&quot;){M.data=o.param(M.data)}if(M.dataType==&quot;jsonp&quot;){if(G==&quot;GET&quot;){if(!M.url.match(F)){M.url+=(M.url.match(/\?/)?&quot;&amp;&quot;:&quot;?&quot;)+(M.jsonp||&quot;callback&quot;)+&quot;=?&quot;}}else{if(!M.data||!M.data.match(F)){M.data=(M.data?M.data+&quot;&amp;&quot;:&quot;&quot;)+(M.jsonp||&quot;callback&quot;)+&quot;=?&quot;}}M.dataType=&quot;json&quot;}if(M.dataType==&quot;json&quot;&amp;&amp;(M.data&amp;&amp;M.data.match(F)||M.url.match(F))){W=&quot;jsonp&quot;+r++;if(M.data){M.data=(M.data+&quot;&quot;).replace(F,&quot;=&quot;+W+&quot;$1&quot;)}M.url=M.url.replace(F,&quot;=&quot;+W+&quot;$1&quot;);M.dataType=&quot;script&quot;;l[W]=function(X){V=X;I();L();l[W]=g;try{delete l[W]}catch(Y){}if(H){H.removeChild(T)}}}if(M.dataType==&quot;script&quot;&amp;&amp;M.cache==null){M.cache=false}if(M.cache===false&amp;&amp;G==&quot;GET&quot;){var E=e();var U=M.url.replace(/(\?|&amp;)_=.*?(&amp;|$)/,&quot;$1_=&quot;+E+&quot;$2&quot;);M.url=U+((U==M.url)?(M.url.match(/\?/)?&quot;&amp;&quot;:&quot;?&quot;)+&quot;_=&quot;+E:&quot;&quot;)}if(M.data&amp;&amp;G==&quot;GET&quot;){M.url+=(M.url.match(/\?/)?&quot;&amp;&quot;:&quot;?&quot;)+M.data;M.data=null}if(M.global&amp;&amp;!o.active++){o.event.trigger(&quot;ajaxStart&quot;)}var Q=/^(\w+:)?\/\/([^\/?#]+)/.exec(M.url);if(M.dataType==&quot;script&quot;&amp;&amp;G==&quot;GET&quot;&amp;&amp;Q&amp;&amp;(Q[1]&amp;&amp;Q[1]!=location.protocol||Q[2]!=location.host)){var H=document.getElementsByTagName(&quot;head&quot;)[0];var T=document.createElement(&quot;script&quot;);T.src=M.url;if(M.scriptCharset){T.charset=M.scriptCharset}if(!W){var O=false;T.onload=T.onreadystatechange=function(){if(!O&amp;&amp;(!this.readyState||this.readyState==&quot;loaded&quot;||this.readyState==&quot;complete&quot;)){O=true;I();L();T.onload=T.onreadystatechange=null;H.removeChild(T)}}}H.appendChild(T);return g}var K=false;var J=M.xhr();if(M.username){J.open(G,M.url,M.async,M.username,M.password)}else{J.open(G,M.url,M.async)}try{if(M.data){J.setRequestHeader(&quot;Content-Type&quot;,M.contentType)}if(M.ifModified){J.setRequestHeader(&quot;If-Modified-Since&quot;,o.lastModified[M.url]||&quot;Thu, 01 Jan 1970 00:00:00 GMT&quot;)}J.setRequestHeader(&quot;X-Requested-With&quot;,&quot;XMLHttpRequest&quot;);J.setRequestHeader(&quot;Accept&quot;,M.dataType&amp;&amp;M.accepts[M.dataType]?M.accepts[M.dataType]+&quot;, */*&quot;:M.accepts._default)}catch(S){}if(M.beforeSend&amp;&amp;M.beforeSend(J,M)===false){if(M.global&amp;&amp;!--o.active){o.event.trigger(&quot;ajaxStop&quot;)}J.abort();return false}if(M.global){o.event.trigger(&quot;ajaxSend&quot;,[J,M])}var N=function(X){if(J.readyState==0){if(P){clearInterval(P);P=null;if(M.global&amp;&amp;!--o.active){o.event.trigger(&quot;ajaxStop&quot;)}}}else{if(!K&amp;&amp;J&amp;&amp;(J.readyState==4||X==&quot;timeout&quot;)){K=true;if(P){clearInterval(P);P=null}R=X==&quot;timeout&quot;?&quot;timeout&quot;:!o.httpSuccess(J)?&quot;error&quot;:M.ifModified&amp;&amp;o.httpNotModified(J,M.url)?&quot;notmodified&quot;:&quot;success&quot;;if(R==&quot;success&quot;){try{V=o.httpData(J,M.dataType,M)}catch(Z){R=&quot;parsererror&quot;}}if(R==&quot;success&quot;){var Y;try{Y=J.getResponseHeader(&quot;Last-Modified&quot;)}catch(Z){}if(M.ifModified&amp;&amp;Y){o.lastModified[M.url]=Y}if(!W){I()}}else{o.handleError(M,J,R)}L();if(X){J.abort()}if(M.async){J=null}}}};if(M.async){var P=setInterval(N,13);if(M.timeout&gt;0){setTimeout(function(){if(J&amp;&amp;!K){N(&quot;timeout&quot;)}},M.timeout)}}try{J.send(M.data)}catch(S){o.handleError(M,J,null,S)}if(!M.async){N()}function I(){if(M.success){M.success(V,R)}if(M.global){o.event.trigger(&quot;ajaxSuccess&quot;,[J,M])}}function L(){if(M.complete){M.complete(J,R)}if(M.global){o.event.trigger(&quot;ajaxComplete&quot;,[J,M])}if(M.global&amp;&amp;!--o.active){o.event.trigger(&quot;ajaxStop&quot;)}}return J},handleError:function(F,H,E,G){if(F.error){F.error(H,E,G)}if(F.global){o.event.trigger(&quot;ajaxError&quot;,[H,F,G])}},active:0,httpSuccess:function(F){try{return !F.status&amp;&amp;location.protocol==&quot;file:&quot;||(F.status&gt;=200&amp;&amp;F.status&lt;300)||F.status==304||F.status==1223}catch(E){}return false},httpNotModified:function(G,E){try{var H=G.getResponseHeader(&quot;Last-Modified&quot;);return G.status==304||H==o.lastModified[E]}catch(F){}return false},httpData:function(J,H,G){var F=J.getResponseHeader(&quot;content-type&quot;),E=H==&quot;xml&quot;||!H&amp;&amp;F&amp;&amp;F.indexOf(&quot;xml&quot;)&gt;=0,I=E?J.responseXML:J.responseText;if(E&amp;&amp;I.documentElement.tagName==&quot;parsererror&quot;){throw&quot;parsererror&quot;}if(G&amp;&amp;G.dataFilter){I=G.dataFilter(I,H)}if(typeof I===&quot;string&quot;){if(H==&quot;script&quot;){o.globalEval(I)}if(H==&quot;json&quot;){I=l[&quot;eval&quot;](&quot;(&quot;+I+&quot;)&quot;)}}return I},param:function(E){var G=[];function H(I,J){G[G.length]=encodeURIComponent(I)+&quot;=&quot;+encodeURIComponent(J)}if(o.isArray(E)||E.jquery){o.each(E,function(){H(this.name,this.value)})}else{for(var F in E){if(o.isArray(E[F])){o.each(E[F],function(){H(F,this)})}else{H(F,o.isFunction(E[F])?E[F]():E[F])}}}return G.join(&quot;&amp;&quot;).replace(/%20/g,&quot;+&quot;)}});var m={},n,d=[[&quot;height&quot;,&quot;marginTop&quot;,&quot;marginBottom&quot;,&quot;paddingTop&quot;,&quot;paddingBottom&quot;],[&quot;width&quot;,&quot;marginLeft&quot;,&quot;marginRight&quot;,&quot;paddingLeft&quot;,&quot;paddingRight&quot;],[&quot;opacity&quot;]];function t(F,E){var G={};o.each(d.concat.apply([],d.slice(0,E)),function(){G[this]=F});return G}o.fn.extend({show:function(J,L){if(J){return this.animate(t(&quot;show&quot;,3),J,L)}else{for(var H=0,F=this.length;H&lt;F;H++){var E=o.data(this[H],&quot;olddisplay&quot;);this[H].style.display=E||&quot;&quot;;if(o.css(this[H],&quot;display&quot;)===&quot;none&quot;){var G=this[H].tagName,K;if(m[G]){K=m[G]}else{var I=o(&quot;&lt;&quot;+G+&quot; /&gt;&quot;).appendTo(&quot;body&quot;);K=I.css(&quot;display&quot;);if(K===&quot;none&quot;){K=&quot;block&quot;}I.remove();m[G]=K}o.data(this[H],&quot;olddisplay&quot;,K)}}for(var H=0,F=this.length;H&lt;F;H++){this[H].style.display=o.data(this[H],&quot;olddisplay&quot;)||&quot;&quot;}return this}},hide:function(H,I){if(H){return this.animate(t(&quot;hide&quot;,3),H,I)}else{for(var G=0,F=this.length;G&lt;F;G++){var E=o.data(this[G],&quot;olddisplay&quot;);if(!E&amp;&amp;E!==&quot;none&quot;){o.data(this[G],&quot;olddisplay&quot;,o.css(this[G],&quot;display&quot;))}}for(var G=0,F=this.length;G&lt;F;G++){this[G].style.display=&quot;none&quot;}return this}},_toggle:o.fn.toggle,toggle:function(G,F){var E=typeof G===&quot;boolean&quot;;return o.isFunction(G)&amp;&amp;o.isFunction(F)?this._toggle.apply(this,arguments):G==null||E?this.each(function(){var H=E?G:o(this).is(&quot;:hidden&quot;);o(this)[H?&quot;show&quot;:&quot;hide&quot;]()}):this.animate(t(&quot;toggle&quot;,3),G,F)},fadeTo:function(E,G,F){return this.animate({opacity:G},E,F)},animate:function(I,F,H,G){var E=o.speed(F,H,G);return this[E.queue===false?&quot;each&quot;:&quot;queue&quot;](function(){var K=o.extend({},E),M,L=this.nodeType==1&amp;&amp;o(this).is(&quot;:hidden&quot;),J=this;for(M in I){if(I[M]==&quot;hide&quot;&amp;&amp;L||I[M]==&quot;show&quot;&amp;&amp;!L){return K.complete.call(this)}if((M==&quot;height&quot;||M==&quot;width&quot;)&amp;&amp;this.style){K.display=o.css(this,&quot;display&quot;);K.overflow=this.style.overflow}}if(K.overflow!=null){this.style.overflow=&quot;hidden&quot;}K.curAnim=o.extend({},I);o.each(I,function(O,S){var R=new o.fx(J,K,O);if(/toggle|show|hide/.test(S)){R[S==&quot;toggle&quot;?L?&quot;show&quot;:&quot;hide&quot;:S](I)}else{var Q=S.toString().match(/^([+-]=)?([\d+-.]+)(.*)$/),T=R.cur(true)||0;if(Q){var N=parseFloat(Q[2]),P=Q[3]||&quot;px&quot;;if(P!=&quot;px&quot;){J.style[O]=(N||1)+P;T=((N||1)/R.cur(true))*T;J.style[O]=T+P}if(Q[1]){N=((Q[1]==&quot;-=&quot;?-1:1)*N)+T}R.custom(T,N,P)}else{R.custom(T,S,&quot;&quot;)}}});return true})},stop:function(F,E){var G=o.timers;if(F){this.queue([])}this.each(function(){for(var H=G.length-1;H&gt;=0;H--){if(G[H].elem==this){if(E){G[H](true)}G.splice(H,1)}}});if(!E){this.dequeue()}return this}});o.each({slideDown:t(&quot;show&quot;,1),slideUp:t(&quot;hide&quot;,1),slideToggle:t(&quot;toggle&quot;,1),fadeIn:{opacity:&quot;show&quot;},fadeOut:{opacity:&quot;hide&quot;}},function(E,F){o.fn[E]=function(G,H){return this.animate(F,G,H)}});o.extend({speed:function(G,H,F){var E=typeof G===&quot;object&quot;?G:{complete:F||!F&amp;&amp;H||o.isFunction(G)&amp;&amp;G,duration:G,easing:F&amp;&amp;H||H&amp;&amp;!o.isFunction(H)&amp;&amp;H};E.duration=o.fx.off?0:typeof E.duration===&quot;number&quot;?E.duration:o.fx.speeds[E.duration]||o.fx.speeds._default;E.old=E.complete;E.complete=function(){if(E.queue!==false){o(this).dequeue()}if(o.isFunction(E.old)){E.old.call(this)}};return E},easing:{linear:function(G,H,E,F){return E+F*G},swing:function(G,H,E,F){return((-Math.cos(G*Math.PI)/2)+0.5)*F+E}},timers:[],fx:function(F,E,G){this.options=E;this.elem=F;this.prop=G;if(!E.orig){E.orig={}}}});o.fx.prototype={update:function(){if(this.options.step){this.options.step.call(this.elem,this.now,this)}(o.fx.step[this.prop]||o.fx.step._default)(this);if((this.prop==&quot;height&quot;||this.prop==&quot;width&quot;)&amp;&amp;this.elem.style){this.elem.style.display=&quot;block&quot;}},cur:function(F){if(this.elem[this.prop]!=null&amp;&amp;(!this.elem.style||this.elem.style[this.prop]==null)){return this.elem[this.prop]}var E=parseFloat(o.css(this.elem,this.prop,F));return E&amp;&amp;E&gt;-10000?E:parseFloat(o.curCSS(this.elem,this.prop))||0},custom:function(I,H,G){this.startTime=e();this.start=I;this.end=H;this.unit=G||this.unit||&quot;px&quot;;this.now=this.start;this.pos=this.state=0;var E=this;function F(J){return E.step(J)}F.elem=this.elem;if(F()&amp;&amp;o.timers.push(F)&amp;&amp;!n){n=setInterval(function(){var K=o.timers;for(var J=0;J&lt;K.length;J++){if(!K[J]()){K.splice(J--,1)}}if(!K.length){clearInterval(n);n=g}},13)}},show:function(){this.options.orig[this.prop]=o.attr(this.elem.style,this.prop);this.options.show=true;this.custom(this.prop==&quot;width&quot;||this.prop==&quot;height&quot;?1:0,this.cur());o(this.elem).show()},hide:function(){this.options.orig[this.prop]=o.attr(this.elem.style,this.prop);this.options.hide=true;this.custom(this.cur(),0)},step:function(H){var G=e();if(H||G&gt;=this.options.duration+this.startTime){this.now=this.end;this.pos=this.state=1;this.update();this.options.curAnim[this.prop]=true;var E=true;for(var F in this.options.curAnim){if(this.options.curAnim[F]!==true){E=false}}if(E){if(this.options.display!=null){this.elem.style.overflow=this.options.overflow;this.elem.style.display=this.options.display;if(o.css(this.elem,&quot;display&quot;)==&quot;none&quot;){this.elem.style.display=&quot;block&quot;}}if(this.options.hide){o(this.elem).hide()}if(this.options.hide||this.options.show){for(var I in this.options.curAnim){o.attr(this.elem.style,I,this.options.orig[I])}}this.options.complete.call(this.elem)}return false}else{var J=G-this.startTime;this.state=J/this.options.duration;this.pos=o.easing[this.options.easing||(o.easing.swing?&quot;swing&quot;:&quot;linear&quot;)](this.state,J,0,1,this.options.duration);this.now=this.start+((this.end-this.start)*this.pos);this.update()}return true}};o.extend(o.fx,{speeds:{slow:600,fast:200,_default:400},step:{opacity:function(E){o.attr(E.elem.style,&quot;opacity&quot;,E.now)},_default:function(E){if(E.elem.style&amp;&amp;E.elem.style[E.prop]!=null){E.elem.style[E.prop]=E.now+E.unit}else{E.elem[E.prop]=E.now}}}});if(document.documentElement.getBoundingClientRect){o.fn.offset=function(){if(!this[0]){return{top:0,left:0}}if(this[0]===this[0].ownerDocument.body){return o.offset.bodyOffset(this[0])}var G=this[0].getBoundingClientRect(),J=this[0].ownerDocument,F=J.body,E=J.documentElement,L=E.clientTop||F.clientTop||0,K=E.clientLeft||F.clientLeft||0,I=G.top+(self.pageYOffset||o.boxModel&amp;&amp;E.scrollTop||F.scrollTop)-L,H=G.left+(self.pageXOffset||o.boxModel&amp;&amp;E.scrollLeft||F.scrollLeft)-K;return{top:I,left:H}}}else{o.fn.offset=function(){if(!this[0]){return{top:0,left:0}}if(this[0]===this[0].ownerDocument.body){return o.offset.bodyOffset(this[0])}o.offset.initialized||o.offset.initialize();var J=this[0],G=J.offsetParent,F=J,O=J.ownerDocument,M,H=O.documentElement,K=O.body,L=O.defaultView,E=L.getComputedStyle(J,null),N=J.offsetTop,I=J.offsetLeft;while((J=J.parentNode)&amp;&amp;J!==K&amp;&amp;J!==H){M=L.getComputedStyle(J,null);N-=J.scrollTop,I-=J.scrollLeft;if(J===G){N+=J.offsetTop,I+=J.offsetLeft;if(o.offset.doesNotAddBorder&amp;&amp;!(o.offset.doesAddBorderForTableAndCells&amp;&amp;/^t(able|d|h)$/i.test(J.tagName))){N+=parseInt(M.borderTopWidth,10)||0,I+=parseInt(M.borderLeftWidth,10)||0}F=G,G=J.offsetParent}if(o.offset.subtractsBorderForOverflowNotVisible&amp;&amp;M.overflow!==&quot;visible&quot;){N+=parseInt(M.borderTopWidth,10)||0,I+=parseInt(M.borderLeftWidth,10)||0}E=M}if(E.position===&quot;relative&quot;||E.position===&quot;static&quot;){N+=K.offsetTop,I+=K.offsetLeft}if(E.position===&quot;fixed&quot;){N+=Math.max(H.scrollTop,K.scrollTop),I+=Math.max(H.scrollLeft,K.scrollLeft)}return{top:N,left:I}}}o.offset={initialize:function(){if(this.initialized){return}var L=document.body,F=document.createElement(&quot;div&quot;),H,G,N,I,M,E,J=L.style.marginTop,K='&lt;div style=&quot;position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;&quot;&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;table style=&quot;position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;';M={position:&quot;absolute&quot;,top:0,left:0,margin:0,border:0,width:&quot;1px&quot;,height:&quot;1px&quot;,visibility:&quot;hidden&quot;};for(E in M){F.style[E]=M[E]}F.innerHTML=K;L.insertBefore(F,L.firstChild);H=F.firstChild,G=H.firstChild,I=H.nextSibling.firstChild.firstChild;this.doesNotAddBorder=(G.offsetTop!==5);this.doesAddBorderForTableAndCells=(I.offsetTop===5);H.style.overflow=&quot;hidden&quot;,H.style.position=&quot;relative&quot;;this.subtractsBorderForOverflowNotVisible=(G.offsetTop===-5);L.style.marginTop=&quot;1px&quot;;this.doesNotIncludeMarginInBodyOffset=(L.offsetTop===0);L.style.marginTop=J;L.removeChild(F);this.initialized=true},bodyOffset:function(E){o.offset.initialized||o.offset.initialize();var G=E.offsetTop,F=E.offsetLeft;if(o.offset.doesNotIncludeMarginInBodyOffset){G+=parseInt(o.curCSS(E,&quot;marginTop&quot;,true),10)||0,F+=parseInt(o.curCSS(E,&quot;marginLeft&quot;,true),10)||0}return{top:G,left:F}}};o.fn.extend({position:function(){var I=0,H=0,F;if(this[0]){var G=this.offsetParent(),J=this.offset(),E=/^body|html$/i.test(G[0].tagName)?{top:0,left:0}:G.offset();J.top-=j(this,&quot;marginTop&quot;);J.left-=j(this,&quot;marginLeft&quot;);E.top+=j(G,&quot;borderTopWidth&quot;);E.left+=j(G,&quot;borderLeftWidth&quot;);F={top:J.top-E.top,left:J.left-E.left}}return F},offsetParent:function(){var E=this[0].offsetParent||document.body;while(E&amp;&amp;(!/^body|html$/i.test(E.tagName)&amp;&amp;o.css(E,&quot;position&quot;)==&quot;static&quot;)){E=E.offsetParent}return o(E)}});o.each([&quot;Left&quot;,&quot;Top&quot;],function(F,E){var G=&quot;scroll&quot;+E;o.fn[G]=function(H){if(!this[0]){return null}return H!==g?this.each(function(){this==l||this==document?l.scrollTo(!F?H:o(l).scrollLeft(),F?H:o(l).scrollTop()):this[G]=H}):this[0]==l||this[0]==document?self[F?&quot;pageYOffset&quot;:&quot;pageXOffset&quot;]||o.boxModel&amp;&amp;document.documentElement[G]||document.body[G]:this[0][G]}});o.each([&quot;Height&quot;,&quot;Width&quot;],function(I,G){var E=I?&quot;Left&quot;:&quot;Top&quot;,H=I?&quot;Right&quot;:&quot;Bottom&quot;,F=G.toLowerCase();o.fn[&quot;inner&quot;+G]=function(){return this[0]?o.css(this[0],F,false,&quot;padding&quot;):null};o.fn[&quot;outer&quot;+G]=function(K){return this[0]?o.css(this[0],F,false,K?&quot;margin&quot;:&quot;border&quot;):null};var J=G.toLowerCase();o.fn[J]=function(K){return this[0]==l?document.compatMode==&quot;CSS1Compat&quot;&amp;&amp;document.documentElement[&quot;client&quot;+G]||document.body[&quot;client&quot;+G]:this[0]==document?Math.max(document.documentElement[&quot;client&quot;+G],document.body[&quot;scroll&quot;+G],document.documentElement[&quot;scroll&quot;+G],document.body[&quot;offset&quot;+G],document.documentElement[&quot;offset&quot;+G]):K===g?(this.length?o.css(this[0],J):null):this.css(J,typeof K===&quot;string&quot;?K:K+&quot;px&quot;)}})})();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">new file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- /dev/null</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/gloda.properties</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -0,0 +1,138 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineplus">+#</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+#</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+# License.</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+#</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+# The Original Code is Thunderbird Global Database</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+#</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+# Mozilla Messaging, Inc.</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+#</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+#   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+#</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+#</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineplus">+# LOCALIZATION NOTE (*.facetLabel): These are the labels used to label the facet</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+#  displays in the global search facet display mechanism.</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+# LOCALIZATION NOTE (*.includeLabel): The label to use for the included group</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineplus">+#  in the facet display.  If not provided, we will fall back to</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+#  &quot;glodaFacetView.facets.included.fallbackLabel&quot;.</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineplus">+</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineplus">+# LOCALIZATION NOTE (*.excludeLabel): The label to use for the excluded group</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+#  in the facet display.  If not provided, we will fall back to</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+#  &quot;glodaFacetView.facets.excluded.fallbackLabel&quot;.</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+# LOCALIZATION NOTE (*.remainderLabel): The label to use for the remaining items</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+#  that are neither part of the included group or the excluded group in the</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineplus">+#  facet display.  If not provided, we will fall back to</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineplus">+#  &quot;glodaFacetView.facets.remainder.fallbackLabel&quot;.</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineplus">+</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.folder.*): Stores the message folder in</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineplus">+#  which the message is stored.</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineplus">+gloda.message.attr.folder.facetLabel=Mail Folder</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.fromMe.*): Stores everyone involved</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+#  with the message.  This means from/to/cc/bcc.</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineplus">+gloda.message.attr.fromMe.facetLabel=From Me</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineplus">+</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.toMe.*): Stores everyone involved</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+#  with the message.  This means from/to/cc/bcc.</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineplus">+gloda.message.attr.toMe.facetLabel=To Me</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineplus">+</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineplus">+</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.involves.*): Stores everyone involved</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineplus">+#  with the message.  This means from/to/cc/bcc.</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineplus">+gloda.message.attr.involves.facetLabel=People</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineplus">+gloda.message.attr.involves.includeLabel=involving any of:</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+gloda.message.attr.involves.excludeLabel=not involving:</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineplus">+gloda.message.attr.involves.remainderLabel=other participants:</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineplus">+</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.date.*): Stores the date of the message.</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineplus">+#  Thunderbird normally stores the date the message claims it was composed</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineplus">+#  according to the &quot;Date&quot; header.  This is not the same as when the message</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineplus">+#  was sent or when it was eventually received by the user.  In the future we</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineplus">+#  may change this to be one of the other dates, but not anytime soon.</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineplus">+gloda.message.attr.date.facetLabel=Date</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.attachmentTypes.*): Stores the list of</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+#  MIME types (ex: image/png, text/plain) of real attachments (not just part of</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineplus">+#  the message content but explicitly named attachments) on the message.</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineplus">+#  Although we hope to be able to provide localized human-readable explanations</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineplus">+#  of the MIME type (ex: &quot;PowerPoint document&quot;), I don't know if that is going</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineplus">+#  to happen.</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineplus">+gloda.message.attr.attachmentTypes.facetLabel=Attachments</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineplus">+</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.mailing-list.*): Stores the mailing</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineplus">+#  lists detected in the message.  This will normally be the e-mail address of</span>
<a href="#l27.95"></a><span id="l27.95" class="difflineplus">+#  the mailing list and only be detected in messages received from the mailing</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineplus">+#  list.  Extensions may contribute additional detected mailing-list-like</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineplus">+#  things.</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineplus">+gloda.message.attr.mailing-list.facetLabel=Mail List Involved</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineplus">+</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.tag.*): Stores the tags applied to the</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineplus">+#  message.  Notably, gmail's labels are not currently exposed via IMAP and we</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineplus">+#  do not do anything clever with gmail, so this is indepdendent of gmail</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineplus">+#  labels.  This may change in the future, but it's a safe bet it's not</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineplus">+#  happening on Thunderbird's side prior to 3.0.</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineplus">+gloda.message.attr.tag.facetLabel=Tags</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineplus">+</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.tag.*): Stores whether the message is</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineplus">+#  starred or not, as indicated by a pretty star icon.  In the past, the icon</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineplus">+#  used to be a flag.  The IMAP terminology continues to be &quot;flagged&quot;.</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineplus">+gloda.message.attr.star.facetLabel=Starred</span>
<a href="#l27.111"></a><span id="l27.111" class="difflineplus">+</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.read.*): Stores whether the user has</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineplus">+#  read the message or not.</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineplus">+gloda.message.attr.read.facetLabel=Read</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineplus">+</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.repliedTo.*): Stores whether we believe</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineplus">+#  the user has ever replied to the message.  We normally show a little icon in</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineplus">+#  the thread pane when this is the case.</span>
<a href="#l27.119"></a><span id="l27.119" class="difflineplus">+gloda.message.attr.repliedTo.facetLabel=Replied To</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineplus">+</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.forwarded.*): Stores whether we believe</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineplus">+#  the user has ever forwarded the message.  We normally show a little icon in</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineplus">+#  the thread pane when this is the case.</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineplus">+gloda.message.attr.forwarded.facetLabel=Forwarded</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineplus">+</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineplus">+# LOCALIZATION NOTE (gloda.mimetype.category.*.label): Map categories of MIME</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineplus">+#  types defined in mimeTypeCategories.js to labels.</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineplus">+# LOCALIZATION NOTE (gloda.mimetype.category.archives.label): Archive is</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineplus">+#  referring to things like zip files, tar files, tar.gz files, etc.</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineplus">+gloda.mimetype.category.archives.label=Archives</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineplus">+gloda.mimetype.category.documents.label=Documents</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineplus">+gloda.mimetype.category.images.label=Images</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineplus">+# LOCALIZATION NOTE (gloda.mimetype.category.media.label): Media is meant to</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineplus">+#  encompass both audio and video.  This is because video and audio streams are</span>
<a href="#l27.135"></a><span id="l27.135" class="difflineplus">+#  frequently stored in the same type of container and we cannot rely on the</span>
<a href="#l27.136"></a><span id="l27.136" class="difflineplus">+#  sending e-mail client to have been clever enough to figure out what was</span>
<a href="#l27.137"></a><span id="l27.137" class="difflineplus">+#  really in the file.  So we group them together.</span>
<a href="#l27.138"></a><span id="l27.138" class="difflineplus">+gloda.mimetype.category.media.label=Media (Audio, Video)</span>
<a href="#l27.139"></a><span id="l27.139" class="difflineplus">+gloda.mimetype.category.pdf.label=PDF Files</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineplus">+# LOCALIZATION NOTE (gloda.mimetype.category.other.label): Other is the category</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineplus">+#  for MIME types that we don't really know what it is.</span>
<a href="#l27.142"></a><span id="l27.142" class="difflineplus">+gloda.mimetype.category.other.label=Other</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">new file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- /dev/null</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/glodaComplete.properties</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -0,0 +1,57 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineplus">+#</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+#</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+# License.</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+#</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+# The Original Code is Thunderbird Global Database</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+#</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+# Mozilla Messaging, Inc.</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+#</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+#   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+#</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+#</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+# LOCALIZATION NOTE (glodaComplete.messagesTagged.label): The label used</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+#  in the autocomplete widget to refer to a query for all messages tagged</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+#  by a particular tag (replacing #1).</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+glodaComplete.messagesTagged.label=Messages tagged: #1</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+# LOCALIZATION NOTE (glodaComplete.messagesMentioning.label): The label used</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+#  in the autocomplete widget to refer to a search for all messages mentioning</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+#  a particular word (replacing #1).</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+glodaComplete.messagesMentioning.label=Messages mentioning: #1</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+# LOCALIZATION NOTE (glodaComplete.messagesWithAny.label): The label used</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+#  in the autocomplete widget to refer to a search for all messages mentioning</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+#  any one of a set of words</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+glodaComplete.messagesWithAny.label=messages with ANY of:</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+# LOCALIZATION NOTE (glodaComplete.messagesWithAll.label): The label used</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+#  in the autocomplete widget to refer to a search for all messages mentioning</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+#  all of a set of words</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+glodaComplete.messagesWithAll.label=messages with ALL of:</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">new file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- /dev/null</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/glodaFacetView.dtd</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -0,0 +1,8 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (glodaFacetView.filters.label): Label at the top of the</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineplus">+     faceting sidebar.  Serves as a header both for the checkboxes under it as</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineplus">+     well for labeled facets with multiple options. --&gt;</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineplus">+&lt;!ENTITY glodaFacetView.filters.label &quot;Filter by:&quot;&gt;</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineplus">+</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (glodaFacetView.showMore.label): Label at the bottom</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+     of the results list to show more hits. --&gt;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+&lt;!ENTITY glodaFacetView.showMore.label &quot;Show more hits&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">new file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- /dev/null</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/glodaFacetView.properties</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -0,0 +1,150 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineplus">+#</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+#</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+# License.</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+#</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+# The Original Code is Thunderbird Global Database</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+#</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+# Mozilla Messaging, Inc.</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+#</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+#   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+#</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+#</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.tab.query.label): The title to display for</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+#  tabs that are based on a gloda (global database) query or collection rather</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+#  than a user search.  In the case of a user search, we just display the</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+#  search string they entered.  At some point we might try and explain what</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+#  the query/collection is an automatic fashion, but not today.</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+glodaFacetView.tab.query.label=Search</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.constraints.query.fulltext.label):</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+#  The label to display to describe when our base query was a fulltext search</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+#  across messages.  The value is displayed following the label.</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+glodaFacetView.constraints.query.fulltext.label=Searching for #1</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+glodaFacetView.constraints.query.fulltext.andJoinWord=and</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+glodaFacetView.constraints.query.fulltext.orJoinWord=or</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+glodaFacetView.constraints.query.fulltext.changeToAndLabel=require all terms instead</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+glodaFacetView.constraints.query.fulltext.changeToOrLabel=require any of the terms instead</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.constraints.query.initial):</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+#  The label to display to describe when our base query is not a full-text</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+#  search.  Additional labels are appended describing each constraint.</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+glodaFacetView.constraints.query.initial=Searching for messages</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.constraints.query.involves.label):</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineplus">+#  The label to display to describe when our base query was on messages</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineplus">+#  involving a given contact from the address book.  The value is displayed</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineplus">+#  where the #1 is.</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+glodaFacetView.constraints.query.involves.label=involving #1</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.constraints.query.contact.label):</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineplus">+#  The label to display to describe when our base query was on messages</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineplus">+#  tagged with a specific tag.  The tag is displayed following the label.</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineplus">+glodaFacetView.constraints.query.tagged.label=tagged:</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineplus">+</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineplus">+</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.facets.mode.top.moreLabel): The label to</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineplus">+#  use when we are only displaying the top entries for a facet.  When the</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineplus">+#  label is clicked on, it results in us displaying all of the values for that</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+#  facet.  The value &quot;#1&quot; (if present) is replaced with the total number of</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineplus">+#  values that will be displayed (rather than the number currently hidden).</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineplus">+glodaFacetView.facets.mode.top.moreLabel=List all #1</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineplus">+</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.facets.included.fallbackLabel): The label to</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+#  use for groups in a facet that have been explicitly included by the user if</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineplus">+#  there is no explicit attribute &quot;includeLabel&quot; defined.  (The explicit label</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineplus">+#  would be named &quot;gloda.message.attr.ATTRIBUTE.includeLabel&quot;.)</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineplus">+glodaFacetView.facets.included.fallbackLabel=including any of:</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.facets.excluded.fallbackLabel): The label to</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineplus">+#  use for groups in a facet that have been explicitly excluded by the user if</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineplus">+#  there is no explicit attribute &quot;excludeLabel&quot; defined.  (The explicit label</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineplus">+#  would be named &quot;gloda.message.attr.ATTRIBUTE.excludeLabel&quot;.)</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineplus">+glodaFacetView.facets.excluded.fallbackLabel=excluding:</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.facets.remainder.fallbackLabel): The label</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+#  to use for groups in a facet that are neither part of the included group or</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+#  the excluded group if there is no explicit attribute &quot;remainderLabel&quot;</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineplus">+#  defined.  (The explicit label would be named</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+#  &quot;gloda.message.attr.ATTRIBUTE.remainderLabel&quot;.)</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineplus">+glodaFacetView.facets.remainder.fallbackLabel=other:</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineplus">+</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.facets.noneLabel): The text to display when</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineplus">+#  a facet needs to indicate that an attribute omitted a value or was otherwise</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineplus">+#  empty.</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineplus">+glodaFacetView.facets.noneLabel=None</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineplus">+</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.facets.filter.attachmentTypes.allLabel):</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineplus">+#  The label to use when all types of attachments are being displayed.</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineplus">+glodaFacetView.facets.filter.attachmentTypes.allLabel=Any Kind</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineplus">+</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.result.message.fromLabel): Used in the</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineplus">+#  faceted search message display to indicate the author of a message.</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineplus">+# An example usage is  &quot;from: Bob&quot;.</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineplus">+glodaFacetView.result.message.fromLabel=from:</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineplus">+</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.result.message.toLabel): Used in the</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineplus">+#  faceted search message display to indicate the recipients of a message.</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineplus">+# An example usage is  &quot;to: Bob, Chuck, Don&quot;.</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineplus">+glodaFacetView.result.message.toLabel=to:</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineplus">+</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.countLabel): Displays the</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineplus">+#  number of messages displayed in the result area out of the number of</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineplus">+#  messages in the active set (the set of messages remaining after the</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineplus">+#  application of the facet constraints.)  It takes the following arguments,</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineplus">+#  you do not have to use all of them.</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineplus">+# #1: The number of messages displayed in the result area.</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineplus">+# #2: The pluralized form of &quot;messages&quot; (or whatever you provide in</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineplus">+#      glodaFacetView.results.message.countLabelMessagePlurals) as it</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+#      applies to #1 (the number of messages in the result area.)</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineplus">+# #3: The number of messages in the active set.</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineplus">+# #4: The pluralized form of &quot;messages&quot; as it applies to #3.</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+glodaFacetView.results.message.countLabel=Top #1 #2 out of #3</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.countLabelMessagePlurals):</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+#  The plural forms of &quot;messages&quot; or whatever you choose.  See</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineplus">+#  https://developer.mozilla.org/en/Localization_and_Plurals for details on</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineplus">+#  how this stuff works.</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineplus">+glodaFacetView.results.message.countLabelMessagePlurals=message;messages</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.showAllInList.label): The</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineplus">+#  label for the button/link that causes us to display all of the messages in</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+#  the active set in a new thread pane display tab, closing the current faceting</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+#  tab.</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineplus">+glodaFacetView.results.message.showAllInList.label=Show all as list</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.showAllInList.tooltip): The</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineplus">+#  tooltip to display when hovering over the showAllInList label.</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineplus">+glodaFacetView.results.message.showAllInList.tooltip=Show all of the messages in the active set in a new tab, closing this tab.</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineplus">+</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.sort.label): The</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineplus">+#  label next to the choice of sort order</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+glodaFacetView.results.message.sort.label=sort by:</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.sort.relevance):</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineplus">+# a clickable label causing the sort to be done by most relevant messages first.</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+glodaFacetView.results.message.sort.relevance=relevance</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.sort.date):</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineplus">+# a clickable label causing the sort to be done by most recent messages first.</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineplus">+glodaFacetView.results.message.sort.date=date</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineplus">+</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineplus">+glodaFacetView.results.message.andNOthers=and #1 other;and #1 others</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.dtd</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.dtd</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -563,38 +563,16 @@ you can use these alternative items. Oth</span>
<a href="#l31.4"></a><span id="l31.4"> &lt;!ENTITY folderContextSettings.accesskey &quot;e&quot;&gt;</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6"> &lt;!-- Search Bar --&gt;</span>
<a href="#l31.7"></a><span id="l31.7"> &lt;!ENTITY SearchNameOrEmail.label &quot;Name or Email contains:&quot;&gt;</span>
<a href="#l31.8"></a><span id="l31.8"> &lt;!ENTITY SearchNameOrEmail.accesskey &quot;N&quot;&gt;</span>
<a href="#l31.9"></a><span id="l31.9"> </span>
<a href="#l31.10"></a><span id="l31.10"> &lt;!-- Gloda Search Bar --&gt;</span>
<a href="#l31.11"></a><span id="l31.11"> &lt;!ENTITY glodaSearchBar.emptyText &quot;Search messages…&quot;&gt;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-&lt;!ENTITY glodaSearchBar.facet.label &quot;Search:&quot;&gt;</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-&lt;!-- LOCALIZATION NOTE (glodaSearchFacet.*) labels specify search constraints.</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-       &quot;everything&quot; searches over subject, involves, body, and attachments.</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-       &quot;subject&quot; searches only messages subjects.</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-       &quot;involves&quot; searches only message to/from/cc/bcc.</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-       &quot;to&quot; searches only message to/cc.</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-       &quot;from&quot; searches only message using &quot;from&quot; (the message author).</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-       &quot;body&quot; searches only message bodies, which does not include message</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineminus">-           attachment names or the content of the attachments.  Message body</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineminus">-           basically means a message part with a content-type of text/*.</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineminus">-    --&gt;</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.everything.label &quot;Everything&quot;&gt;</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.subject.label &quot;Subject&quot;&gt;</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.involves.label &quot;Involves (from,to,cc,bcc)&quot;&gt;</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.to.label &quot;To, CC&quot;&gt;</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.from.label &quot;From&quot;&gt;</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.body.label &quot;Message Text&quot;&gt;</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.attachmentNames.label &quot;Attachment Names&quot;&gt;</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-&lt;!ENTITY glodaSearchBar.location.label &quot;Location:&quot;&gt;</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.everywhere.label &quot;All Folders&quot;&gt;</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.folder.label &quot;In a specific folder…&quot;&gt;</span>
<a href="#l31.34"></a><span id="l31.34"> </span>
<a href="#l31.35"></a><span id="l31.35"> &lt;!-- Quick Search Menu Bar --&gt;</span>
<a href="#l31.36"></a><span id="l31.36"> &lt;!ENTITY searchSubjectMenu.label &quot;Subject&quot;&gt;</span>
<a href="#l31.37"></a><span id="l31.37"> &lt;!ENTITY searchFromMenu.label &quot;From&quot;&gt;</span>
<a href="#l31.38"></a><span id="l31.38"> &lt;!ENTITY searchSubjectOrFromMenu.label &quot;Subject or From&quot;&gt;</span>
<a href="#l31.39"></a><span id="l31.39"> &lt;!ENTITY searchRecipient.label &quot;To or Cc&quot;&gt;</span>
<a href="#l31.40"></a><span id="l31.40"> &lt;!ENTITY searchSubjectOrRecipientMenu.label &quot;Subject, To or Cc&quot;&gt;</span>
<a href="#l31.41"></a><span id="l31.41"> &lt;!ENTITY searchMessageBody.label &quot;Entire Message&quot;&gt;</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineat">@@ -615,25 +593,16 @@ you can use these alternative items. Oth</span>
<a href="#l31.43"></a><span id="l31.43"> &lt;!ENTITY unreadColumn.label &quot;Unread&quot;&gt;</span>
<a href="#l31.44"></a><span id="l31.44"> &lt;!ENTITY totalColumn.label &quot;Total&quot;&gt;</span>
<a href="#l31.45"></a><span id="l31.45"> &lt;!ENTITY readColumn.label &quot;Read&quot;&gt;</span>
<a href="#l31.46"></a><span id="l31.46"> &lt;!ENTITY receivedColumn.label &quot;Received&quot;&gt;</span>
<a href="#l31.47"></a><span id="l31.47"> &lt;!ENTITY starredColumn.label &quot;Starred&quot;&gt;</span>
<a href="#l31.48"></a><span id="l31.48"> &lt;!ENTITY locationColumn.label &quot;Location&quot;&gt;</span>
<a href="#l31.49"></a><span id="l31.49"> &lt;!ENTITY idColumn.label &quot;Order Received&quot;&gt;</span>
<a href="#l31.50"></a><span id="l31.50"> &lt;!ENTITY attachmentColumn.label &quot;Attachments&quot;&gt;</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineminus">-&lt;!-- LOCALIZATION NOTE (glodaWhyColumn.label): explains why a message is</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineminus">-     present in the gloda search results.  The values can be found in</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineminus">-     messenger.properties with a prefix of &quot;glodaSearch_results_why_&quot;. --&gt;</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-&lt;!ENTITY glodaWhyColumn.label &quot;Why&quot;&gt;</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-&lt;!-- LOCALIZATION NOTE (glodaScoreColumn.label): provides the numerical</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-     score assigned to the message as a result of the search.  The column</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineminus">-     primarily exists to be sorted by, and its contents will probably have</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineminus">-     little meaning for most users. --&gt;</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineminus">-&lt;!ENTITY glodaScoreColumn.label &quot;Score&quot;&gt;</span>
<a href="#l31.60"></a><span id="l31.60"> </span>
<a href="#l31.61"></a><span id="l31.61"> &lt;!-- Thread Pane Tooltips --&gt;</span>
<a href="#l31.62"></a><span id="l31.62"> &lt;!ENTITY columnChooser.tooltip &quot;Click to select columns to display&quot;&gt;</span>
<a href="#l31.63"></a><span id="l31.63"> &lt;!ENTITY threadColumn.tooltip &quot;Click to display message threads&quot;&gt;</span>
<a href="#l31.64"></a><span id="l31.64"> &lt;!ENTITY fromColumn.tooltip &quot;Click to sort by from&quot;&gt;</span>
<a href="#l31.65"></a><span id="l31.65"> &lt;!ENTITY recipientColumn.tooltip &quot;Click to sort by recipient&quot;&gt;</span>
<a href="#l31.66"></a><span id="l31.66"> &lt;!ENTITY subjectColumn.tooltip &quot;Click to sort by subject&quot;&gt;</span>
<a href="#l31.67"></a><span id="l31.67"> &lt;!ENTITY dateColumn.tooltip &quot;Click to sort by date&quot;&gt;</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineat">@@ -646,18 +615,16 @@ you can use these alternative items. Oth</span>
<a href="#l31.69"></a><span id="l31.69"> &lt;!ENTITY unreadColumn.tooltip &quot;Number of unread messages in thread&quot;&gt;</span>
<a href="#l31.70"></a><span id="l31.70"> &lt;!ENTITY totalColumn.tooltip &quot;Total number of messages in thread&quot;&gt;</span>
<a href="#l31.71"></a><span id="l31.71"> &lt;!ENTITY readColumn.tooltip &quot;Click to sort by read&quot;&gt;</span>
<a href="#l31.72"></a><span id="l31.72"> &lt;!ENTITY receivedColumn.tooltip &quot;Click to sort by date received&quot;&gt;</span>
<a href="#l31.73"></a><span id="l31.73"> &lt;!ENTITY starredColumn.tooltip &quot;Click to sort by star&quot;&gt;</span>
<a href="#l31.74"></a><span id="l31.74"> &lt;!ENTITY locationColumn.tooltip &quot;Click to sort by location&quot;&gt;</span>
<a href="#l31.75"></a><span id="l31.75"> &lt;!ENTITY idColumn.tooltip &quot;Click to sort by order received&quot;&gt;</span>
<a href="#l31.76"></a><span id="l31.76"> &lt;!ENTITY attachmentColumn.tooltip &quot;Click to sort by attachments&quot;&gt;</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineminus">-&lt;!ENTITY glodaWhyColumn.tooltip &quot;Click to sort by why the message is in your search results&quot;&gt;</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineminus">-&lt;!ENTITY glodaScoreColumn.tooltip &quot;Click to sort by the search score&quot;&gt;</span>
<a href="#l31.79"></a><span id="l31.79"> </span>
<a href="#l31.80"></a><span id="l31.80"> &lt;!-- Thread Pane Context Menu --&gt;</span>
<a href="#l31.81"></a><span id="l31.81"> &lt;!ENTITY contextOpenNewWindow.label &quot;Open Message in New Window&quot;&gt;</span>
<a href="#l31.82"></a><span id="l31.82"> &lt;!ENTITY contextOpenNewWindow.accesskey &quot;W&quot;&gt;</span>
<a href="#l31.83"></a><span id="l31.83"> &lt;!ENTITY contextOpenNewTab.label &quot;Open Message in New Tab&quot;&gt;</span>
<a href="#l31.84"></a><span id="l31.84"> &lt;!ENTITY contextOpenNewTab.accesskey &quot;T&quot;&gt;</span>
<a href="#l31.85"></a><span id="l31.85"> &lt;!ENTITY contextEditAsNew.label &quot;Edit As New…&quot;&gt;</span>
<a href="#l31.86"></a><span id="l31.86"> &lt;!ENTITY contextEditAsNew.accesskey &quot;E&quot;&gt;</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineat">@@ -710,16 +677,17 @@ you can use these alternative items. Oth</span>
<a href="#l31.88"></a><span id="l31.88"> &lt;!ENTITY removePhishingBarButton1.label &quot;Ignore Warning&quot;&gt;</span>
<a href="#l31.89"></a><span id="l31.89"> &lt;!ENTITY reportPhishingError1.label &quot;This message doesn't appear to be a scam.&quot;&gt;</span>
<a href="#l31.90"></a><span id="l31.90"> </span>
<a href="#l31.91"></a><span id="l31.91"> &lt;!-- Message Header Button Box (to show hidden email addresses) --&gt;</span>
<a href="#l31.92"></a><span id="l31.92"> &lt;!ENTITY more.label &quot;more&quot;&gt;</span>
<a href="#l31.93"></a><span id="l31.93"> </span>
<a href="#l31.94"></a><span id="l31.94"> &lt;!-- Quick Search Bar --&gt;</span>
<a href="#l31.95"></a><span id="l31.95"> &lt;!ENTITY quickSearchCmd.key &quot;k&quot;&gt;</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineplus">+&lt;!ENTITY searchEverywhere.label &quot;Search everywhere&quot;&gt;</span>
<a href="#l31.97"></a><span id="l31.97"> </span>
<a href="#l31.98"></a><span id="l31.98"> &lt;!-- Message Header Context Menu --&gt;</span>
<a href="#l31.99"></a><span id="l31.99"> &lt;!ENTITY AddToAddressBook.label &quot;Add to Address Book…&quot;&gt;</span>
<a href="#l31.100"></a><span id="l31.100"> &lt;!ENTITY AddToAddressBook.accesskey &quot;B&quot;&gt;</span>
<a href="#l31.101"></a><span id="l31.101"> &lt;!ENTITY AddDirectlyToAddressBook.label &quot;Add to Address Book&quot;&gt;</span>
<a href="#l31.102"></a><span id="l31.102"> &lt;!ENTITY AddDirectlyToAddressBook.accesskey &quot;B&quot;&gt;</span>
<a href="#l31.103"></a><span id="l31.103"> &lt;!ENTITY EditContact.label &quot;Edit Contact…&quot;&gt;</span>
<a href="#l31.104"></a><span id="l31.104"> &lt;!ENTITY EditContact.accesskey &quot;E&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -511,28 +511,16 @@ headerbccFieldYou=You</span>
<a href="#l32.4"></a><span id="l32.4"> # Shown when content tabs are being loaded.</span>
<a href="#l32.5"></a><span id="l32.5"> loadingTab=Loading…</span>
<a href="#l32.6"></a><span id="l32.6"> </span>
<a href="#l32.7"></a><span id="l32.7"> applyToCollapsedMsgsTitle=Confirm Delete of Messages in Collapsed Thread(s)</span>
<a href="#l32.8"></a><span id="l32.8"> applyToCollapsedMsgs=Warning - this will delete messages in collapsed thread(s)</span>
<a href="#l32.9"></a><span id="l32.9"> applyToCollapsedAlwaysAskCheckbox=Always ask me before deleting messages in collapsed threads</span>
<a href="#l32.10"></a><span id="l32.10"> applyNowButton=Apply</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-#LOCALIZATION NOTE (glodaSearch_results_why_*):  These strings populate the</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-# glodaWhyColumn when performing a gloda-backed search, explaining why a</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-# specific result is present in the search.  Because of how the message grouping</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">-# mechanism works, this value is both the value in the &quot;Why&quot; column as well as</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-# the header for the group (when sorting/grouping on the why column.)  Short</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-# strings are preferable so the why column can be understood without taking up</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-# too much space.</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-glodaSearch_results_why_contact=Contact</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-glodaSearch_results_why_subject=Subject</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-glodaSearch_results_why_body=Body</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-glodaSearch_results_why_attachment=Attachment</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">-</span>
<a href="#l32.24"></a><span id="l32.24"> mailServerLoginFailedTitle=Login Failed</span>
<a href="#l32.25"></a><span id="l32.25"> # LOCALIZATION NOTE (mailServerLoginFailedTitle): Insert &quot;%S&quot; in your</span>
<a href="#l32.26"></a><span id="l32.26"> # translation where you wish to display the hostname of the server to which</span>
<a href="#l32.27"></a><span id="l32.27"> # login failed.</span>
<a href="#l32.28"></a><span id="l32.28"> mailServerLoginFailed=Login to server %S failed.</span>
<a href="#l32.29"></a><span id="l32.29"> mailServerLoginFailedRetryButton=&amp;Retry</span>
<a href="#l32.30"></a><span id="l32.30"> mailServerLoginFailedEnterNewPasswordButton=&amp;Enter New Password</span>
<a href="#l32.31"></a><span id="l32.31"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/multimessageview.properties</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/multimessageview.properties</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -7,10 +7,9 @@ NConversations=#1 conversation; #1 conve</span>
<a href="#l33.4"></a><span id="l33.4"> numMsgs=#1 message;#1 messages</span>
<a href="#l33.5"></a><span id="l33.5"> countUnread=, #1 unread;, #1 unread</span>
<a href="#l33.6"></a><span id="l33.6"> Nmessages=(#1 message);(#1 messages)</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8"> noSubject=(no subject)</span>
<a href="#l33.9"></a><span id="l33.9"> </span>
<a href="#l33.10"></a><span id="l33.10"> # thread and multiple message selection summaries</span>
<a href="#l33.11"></a><span id="l33.11"> messagesSize=These messages take up: #1 #2.</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-yesterday=yesterday</span>
<a href="#l33.13"></a><span id="l33.13"> noticeText= (Note: #1 messages are selected, the first #2 are shown)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">new file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- /dev/null</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/quickSearch.properties</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -0,0 +1,8 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineplus">+searchEverywhere.label=Search everywhere</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineplus">+searchSubject.label=Subject filter</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineplus">+searchFrom.label=From filter</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineplus">+searchFromOrSubject.label=Subject or From filter</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+searchRecipient.label=To or Cc filter</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineplus">+searchRecipientOrSubject.label=Subject, To, or Cc filter</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+searchBody.label=Entire message filter</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+saveAsVirtualFolder.label=Save search as virtual folder</span>
<a href="#l34.13"></a><span id="l34.13">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/search.properties</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/search.properties</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -16,12 +16,8 @@ searchSuccessMessages=%S matches found</span>
<a href="#l35.4"></a><span id="l35.4"> searchFailureMessage=No matches found</span>
<a href="#l35.5"></a><span id="l35.5"> labelForStopButton=Stop</span>
<a href="#l35.6"></a><span id="l35.6"> labelForSearchButton=Search</span>
<a href="#l35.7"></a><span id="l35.7"> labelForStopButton.accesskey=S</span>
<a href="#l35.8"></a><span id="l35.8"> labelForSearchButton.accesskey=S</span>
<a href="#l35.9"></a><span id="l35.9"> </span>
<a href="#l35.10"></a><span id="l35.10"> moreButtonTooltipText=Add a new rule</span>
<a href="#l35.11"></a><span id="l35.11"> lessButtonTooltipText=Remove this rule</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-# LOCALIZATION NOTE (glodaSearchTabTitle): The title to use for global database</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-#  search tabs.  Include &quot;%S&quot; where you want the search string to be inserted.</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineminus">-glodaSearchTabTitle=Search: %S</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">new file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- /dev/null</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/templateUtils.properties</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineplus">+# LOCALIZATION NOTE yesterday: used in various places where we compute</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineplus">+# a &quot;friendly&quot; date, e.g. displaying that a message was from yesterday.</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineplus">+</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineplus">+yesterday=yesterday</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -90,16 +90,22 @@</span>
<a href="#l37.4"></a><span id="l37.4">   locale/@AB_CD@/messenger/textImportMsgs.properties                    (%chrome/messenger/textImportMsgs.properties)</span>
<a href="#l37.5"></a><span id="l37.5">   locale/@AB_CD@/messenger/appleMailImportMsgs.properties               (%chrome/messenger/appleMailImportMsgs.properties)</span>
<a href="#l37.6"></a><span id="l37.6">   locale/@AB_CD@/messenger/comm4xMailImportMsgs.properties              (%chrome/messenger/comm4xMailImportMsgs.properties)</span>
<a href="#l37.7"></a><span id="l37.7">   locale/@AB_CD@/messenger/eudoraImportMsgs.properties                  (%chrome/messenger/eudoraImportMsgs.properties)</span>
<a href="#l37.8"></a><span id="l37.8">   locale/@AB_CD@/messenger/oeImportMsgs.properties                      (%chrome/messenger/oeImportMsgs.properties)</span>
<a href="#l37.9"></a><span id="l37.9">   locale/@AB_CD@/messenger/outlookImportMsgs.properties                 (%chrome/messenger/outlookImportMsgs.properties)</span>
<a href="#l37.10"></a><span id="l37.10">   locale/@AB_CD@/messenger/shutdownWindow.properties                    (%chrome/messenger/shutdownWindow.properties)</span>
<a href="#l37.11"></a><span id="l37.11">   locale/@AB_CD@/messenger/configEditorOverlay.dtd                      (%chrome/messenger/configEditorOverlay.dtd)</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+  locale/@AB_CD@/messenger/quickSearch.properties                       (%chrome/messenger/quickSearch.properties)</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+  locale/@AB_CD@/messenger/gloda.properties                             (%chrome/messenger/gloda.properties)</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+  locale/@AB_CD@/messenger/glodaComplete.properties                     (%chrome/messenger/glodaComplete.properties)</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+  locale/@AB_CD@/messenger/templateUtils.properties                     (%chrome/messenger/templateUtils.properties)</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+  locale/@AB_CD@/messenger/glodaFacetView.properties                    (%chrome/messenger/glodaFacetView.properties)</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+  locale/@AB_CD@/messenger/glodaFacetView.dtd                           (%chrome/messenger/glodaFacetView.dtd)</span>
<a href="#l37.18"></a><span id="l37.18">   locale/@AB_CD@/messenger/addressbook/abMainWindow.dtd                 (%chrome/messenger/addressbook/abMainWindow.dtd)</span>
<a href="#l37.19"></a><span id="l37.19">   locale/@AB_CD@/messenger/addressbook/abNewCardDialog.dtd              (%chrome/messenger/addressbook/abNewCardDialog.dtd)</span>
<a href="#l37.20"></a><span id="l37.20">   locale/@AB_CD@/messenger/addressbook/abContactsPanel.dtd              (%chrome/messenger/addressbook/abContactsPanel.dtd)</span>
<a href="#l37.21"></a><span id="l37.21">   locale/@AB_CD@/messenger/addressbook/abAddressBookNameDialog.dtd      (%chrome/messenger/addressbook/abAddressBookNameDialog.dtd)</span>
<a href="#l37.22"></a><span id="l37.22">   locale/@AB_CD@/messenger/addressbook/abCardOverlay.dtd                (%chrome/messenger/addressbook/abCardOverlay.dtd)</span>
<a href="#l37.23"></a><span id="l37.23">   locale/@AB_CD@/messenger/addressbook/abCardViewOverlay.dtd            (%chrome/messenger/addressbook/abCardViewOverlay.dtd)</span>
<a href="#l37.24"></a><span id="l37.24">   locale/@AB_CD@/messenger/addressbook/abDirTreeOverlay.dtd             (%chrome/messenger/addressbook/abDirTreeOverlay.dtd)</span>
<a href="#l37.25"></a><span id="l37.25">   locale/@AB_CD@/messenger/addressbook/abResultsPaneOverlay.dtd         (%chrome/messenger/addressbook/abResultsPaneOverlay.dtd)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-quick-search.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-quick-search.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -35,16 +35,18 @@</span>
<a href="#l38.4"></a><span id="l38.4">  *</span>
<a href="#l38.5"></a><span id="l38.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l38.6"></a><span id="l38.6"> </span>
<a href="#l38.7"></a><span id="l38.7"> var MODULE_NAME = 'test-quick-search';</span>
<a href="#l38.8"></a><span id="l38.8"> </span>
<a href="#l38.9"></a><span id="l38.9"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l38.10"></a><span id="l38.10"> var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+Cu.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+</span>
<a href="#l38.14"></a><span id="l38.14"> var folder;</span>
<a href="#l38.15"></a><span id="l38.15"> var setFoo, setBar;</span>
<a href="#l38.16"></a><span id="l38.16"> </span>
<a href="#l38.17"></a><span id="l38.17"> function setupModule(module) {</span>
<a href="#l38.18"></a><span id="l38.18">   let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l38.19"></a><span id="l38.19">   fdh.installInto(module);</span>
<a href="#l38.20"></a><span id="l38.20">   let wh = collector.getModule('window-helpers');</span>
<a href="#l38.21"></a><span id="l38.21">   wh.installInto(module);</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineat">@@ -56,28 +58,33 @@ function setupModule(module) {</span>
<a href="#l38.23"></a><span id="l38.23"> }</span>
<a href="#l38.24"></a><span id="l38.24"> </span>
<a href="#l38.25"></a><span id="l38.25"> /**</span>
<a href="#l38.26"></a><span id="l38.26">  *</span>
<a href="#l38.27"></a><span id="l38.27">  */</span>
<a href="#l38.28"></a><span id="l38.28"> function test_save_quick_search() {</span>
<a href="#l38.29"></a><span id="l38.29">   be_in_folder(folder);</span>
<a href="#l38.30"></a><span id="l38.30"> </span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+  // - We want to do a from or subject search</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+  mc.e(&quot;searchInput&quot;).searchMode =</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+    QuickSearchConstants.kQuickSearchFromOrSubject.toString();</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+</span>
<a href="#l38.35"></a><span id="l38.35">   // - Type something in the quick search box.</span>
<a href="#l38.36"></a><span id="l38.36">   mc.type(mc.eid(&quot;searchInput&quot;), &quot;foo&quot;);</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+</span>
<a href="#l38.38"></a><span id="l38.38">   mc.keypress(mc.eid(&quot;searchInput&quot;), &quot;VK_RETURN&quot;, {});</span>
<a href="#l38.39"></a><span id="l38.39">   wait_for_all_messages_to_load();</span>
<a href="#l38.40"></a><span id="l38.40"> </span>
<a href="#l38.41"></a><span id="l38.41">   // - Click the &quot;Save Search as a Folder&quot; button</span>
<a href="#l38.42"></a><span id="l38.42">   // This will create a virtual folder properties dialog...</span>
<a href="#l38.43"></a><span id="l38.43">   // (label: &quot;New Saved Search Folder&quot;, source: virtualFolderProperties.xul</span>
<a href="#l38.44"></a><span id="l38.44">   //  no windowtype, id: &quot;virtualFolderPropertiesDialog&quot;)</span>
<a href="#l38.45"></a><span id="l38.45">   plan_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;,</span>
<a href="#l38.46"></a><span id="l38.46">                         subtest_save_search);</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineminus">-  mc.click(mc.eid(&quot;quickSearchSaveAsVirtualFolder&quot;));</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+  mc.e(&quot;searchInput&quot;).saveAsVirtualFolder.doCommand();</span>
<a href="#l38.49"></a><span id="l38.49">   wait_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;);</span>
<a href="#l38.50"></a><span id="l38.50"> }</span>
<a href="#l38.51"></a><span id="l38.51"> </span>
<a href="#l38.52"></a><span id="l38.52"> /**</span>
<a href="#l38.53"></a><span id="l38.53">  * Save the search, making sure that the &quot;subject OR from&quot; constraints are</span>
<a href="#l38.54"></a><span id="l38.54">  *  there.</span>
<a href="#l38.55"></a><span id="l38.55">  */</span>
<a href="#l38.56"></a><span id="l38.56"> function subtest_save_search(savc) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mail/themes/gnomestripe/jar.mn</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mail/themes/gnomestripe/jar.mn</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -20,16 +20,19 @@ classic.jar:</span>
<a href="#l39.4"></a><span id="l39.4">   skin/classic/messenger/folderMenus.css                      (mail/folderMenus.css)</span>
<a href="#l39.5"></a><span id="l39.5">   skin/classic/messenger/folderPane.css                       (mail/folderPane.css)</span>
<a href="#l39.6"></a><span id="l39.6">   skin/classic/messenger/subscribe.css                        (mail/subscribe.css)</span>
<a href="#l39.7"></a><span id="l39.7">   skin/classic/messenger/virtualFolderListDialog.css          (mail/virtualFolderListDialog.css)</span>
<a href="#l39.8"></a><span id="l39.8">   skin/classic/messenger/searchDialog.css                     (mail/searchDialog.css)</span>
<a href="#l39.9"></a><span id="l39.9">   skin/classic/messenger/msgSelectOffline.css                 (mail/msgSelectOffline.css)</span>
<a href="#l39.10"></a><span id="l39.10">   skin/classic/messenger/filterDialog.css                     (mail/filterDialog.css)</span>
<a href="#l39.11"></a><span id="l39.11">   skin/classic/messenger/multimessageview.css                 (mail/multimessageview.css)</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+  skin/classic/messenger/glodaFacetView.css                   (mail/glodaFacetView.css)</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+  skin/classic/messenger/icons/exclude.png                    (mail/icons/exclude.png)</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+  skin/classic/messenger/icons/exclude-selected.png           (mail/icons/exclude-selected.png)</span>
<a href="#l39.15"></a><span id="l39.15">   skin/classic/messenger/dialogs.css                          (mail/dialogs.css)</span>
<a href="#l39.16"></a><span id="l39.16">   skin/classic/messenger/newmailalert.css                     (mail/newmailalert.css)</span>
<a href="#l39.17"></a><span id="l39.17">   skin/classic/messenger/tabmail.css                          (mail/tabmail.css)</span>
<a href="#l39.18"></a><span id="l39.18">   skin/classic/messenger/editContactOverlay.css               (mail/editContactOverlay.css)</span>
<a href="#l39.19"></a><span id="l39.19">   skin/classic/messenger/starred48.png                        (mail/starred48.png)</span>
<a href="#l39.20"></a><span id="l39.20">   skin/classic/messenger/contactStarred.png                   (mail/contactStarred.png)</span>
<a href="#l39.21"></a><span id="l39.21">   skin/classic/messenger/starContact.png                      (mail/starContact.png)</span>
<a href="#l39.22"></a><span id="l39.22">   skin/classic/messenger/activity/activity.css                (mail/activity/activity.css)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">new file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineminus">--- /dev/null</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/glodaFacetView.css</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineplus">+@import url(&quot;chrome://messenger/content/glodaFacetView.css&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">new file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..7f017c0f1b2de983f61d1905973bbdfb379a58b6</span>
<a href="#l41.3"></a><span id="l41.3">GIT binary patch
literal 864
zc$@)X1E2hfP)&lt;h;3K|Lk000e1NJLTq000dD000dL1^@s6a_i)L00004XF*Lt007wQ
z^&amp;Awc0004~X+uL$Nkc;*P;zf(X&gt;4Tx0C)kdl08cUK@f)DJ4EpVEsO|?c!GsRln@&amp;w
zA|xq-C=x=zk3zWIok=8Kj&gt;{z~_ya^N)GlJ7c0v#ltZcMZf=E&gt;G7ic9S7z&gt;qi_7;ht
zVB^B&gt;KKt&amp;&gt;?9R&gt;t;;C#HDG|WDZkdr#K$@JImTK-$3no&amp;Nm5kvJhsXHpx3PQ+f$61Q
z7Hj`&lt;xiB{zy;1i*d}8;}%x@mwv&lt;8z71Oyjpt~lo&amp;#xc%Aj2A4!BAYN{B_XTC)ZsRx
zks$FpabukG4&amp;xZ-L&amp;iBJ&amp;U{aaJ-V9IiJyoER4t&lt;bB0I}c43licZQ^d0Kh4zUqJVD)
zs47&gt;qbOTVh20Hx}ts@Jxo&amp;yK&gt;747-Lc@sg;XJ-4oPB@{x8K}Rt?T1~UX%l!qv+dUx
z+kU$Ns*iz&lt;H6?5299z1iPz3&amp;3^W1oJUISuQ3#T4Gndk4=dw~2ZFmVNpZviWhKvw{0
zsRKeKVDtn+QTXcotsK9$pqxs^Oxe;@iG7z~I+ZpvhOB7L_Wuo*wn#Mrf@x#POvV$I
z&lt;fq@Ixup?Z&gt;2ph7k7p2{_g#BNu*`2c00009a7bBm000XU000XU0RWnu7ytkPPDw;T
zR45glQL#z`K@fd=IW7bgNxXoNN&gt;EO;5w)@sY*Jm}H&amp;}_^U}2LV5bJ&lt;npdh3XtZXzQ
zi2gx9Q0@@K&lt;c{2}Z}zeXvXuk7J3DXQykQ1#*bwa%IS$B#lm%XZAV&gt;QIm&gt;x5&gt;FpGZz
z{#k(c(+wcExrX$&gt;Bp&lt;CC4ZTfZq@f0qprE^aItpqyMY6vGun6E)SJ)E*D_o3`u5KYY
ztRp$nz_Z|jc?f&amp;riy5Uyw7yyOEkL&gt;^ZAhybnwJE-Bo6pSR9~7PS=&lt;H2Mu~(*33cTn
zOpqQ3COLJ4&gt;!M^x;)wlK5Q0&gt;$(BIn^m(rBfF&lt;XjkOO{YgRmYN(;p0{EXG&amp;h5{&lt;4dZ
zp&gt;-}8Q~Oqxd4P=EL-UrOO@2pwuS?Vlg(Bv^!(lv?NcZf&gt;4M~W1KqKICYt?e+Bu4ux
qxZIq}wJKHEao=M;lH-8&gt;ANm0?s(TyzcK&gt;Gp0000&lt;MNUMnLSTaUB6tG;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">new file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..47295b6dc66ca6562922cfb22a3a224cab578ae8</span>
<a href="#l42.3"></a><span id="l42.3">GIT binary patch
literal 851
zc$@)K1FZasP)&lt;h;3K|Lk000e1NJLTq000dD000dL1^@s6a_i)L00004XF*Lt007wQ
z^&amp;Awc0004~X+uL$Nkc;*P;zf(X&gt;4Tx0C)kdl08cUK@f)DJ4EpVEsO|?c!GsRln@&amp;w
zA|xq-C=x=zk3zWIok=8Kj&gt;{z~_ya^N)GlJ7c0v#ltZcMZf=E&gt;G7ic9S7z&gt;qi_7;ht
zVB^B&gt;KKt&amp;&gt;?9R&gt;t;;C#HDG|WDZkdr#K$@JImTK-$3no&amp;Nm5kvJhsXHpx3PQ+f$61Q
z7Hj`&lt;xiB{zy;1i*d}8;}%x@mwv&lt;8z71Oyjpt~lo&amp;#xc%Aj2A4!BAYN{B_XTC)ZsRx
zks$FpabukG4&amp;xZ-L&amp;iBJ&amp;U{aaJ-V9IiJyoER4t&lt;bB0I}c43licZQ^d0Kh4zUqJVD)
zs47&gt;qbOTVh20Hx}ts@Jxo&amp;yK&gt;747-Lc@sg;XJ-4oPB@{x8K}Rt?T1~UX%l!qv+dUx
z+kU$Ns*iz&lt;H6?5299z1iPz3&amp;3^W1oJUISuQ3#T4Gndk4=dw~2ZFmVNpZviWhKvw{0
zsRKeKVDtn+QTXcotsK9$pqxs^Oxe;@iG7z~I+ZpvhOB7L_Wuo*wn#Mrf@x#POvV$I
z&lt;fq@Ixup?Z&gt;2ph7k7p2{_g#BNu*`2c00009a7bBm000XU000XU0RWnu7ytkPK}keG
zR45glQ9EkGKoHd@NEiY}wbcY13&gt;JvMULcUhm5ZFfg{$B*xNwsT7}tiJAb~)dKrSE%
z3QFrnZY2T%BMG6rxAw{qZ{&gt;lvGdu6i&amp;g`yXXe&lt;bVKB1vx%2WhIj&amp;0j&gt;&gt;}O5WbeT6z
z^9OEO*YzSvl9D-^ED}O=%d&amp;jOUI1H&amp;-$&lt;f(1lI#1$8qkWDB&gt;Z8#igpMM&gt;qlTQ=aG7
zaU4%^`U7%b&lt;YD5VksDcrXaZ~?oTh2I&lt;EWNpJtN0X?79IazVCP7_nk0C2YBJ!{|nIh
zo*Xrv=MCE;1~gp(JMY=!dchEPAu)y@z{`=?L5+$$xm}iJ-_)x+tr1@VCk6P1)qz{9
zuI-Z-Me%{tZXnnKuZU~hV~n^5|LMB!t$OnIbNMp3sQg?AF9F&amp;wu*9ef)kS7?OBjX&amp;
dLdTt*`vW)2lp+i~m5=}c002ovPDHLkV1i!NbT|M2</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">new file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..25db669da4759032c8bb2a105dea69683384d18b</span>
<a href="#l43.3"></a><span id="l43.3">GIT binary patch
literal 4071
zc$@*}4;b)?P)&lt;h;3K|Lk000e1NJLTq00BGz000CC1^@s66I+9F000k1X+uL$Nkc;*
zP;zf(X&gt;4Tx0C)kdSa~&gt;&lt;UH?D#%$UiNB@9`|5)mcY*DNDt-y_+^*bU9tLzYtZC0b&lt;3
zR!EVQM1&gt;?NYg!~xNh;J6*|NN6sOPzU@9%oA_n-G%*WCB#e9m{f&amp;-dK-Io|&lt;*L%=mK
z&amp;&lt;_Ow@TUY(E%)gX4%#~qaD#vmAb&lt;z#0b;HsTA+@(xiJ*^4{h!Rl!fh?EZx@Nha7ST
zw(6#6+*3+q|Md8OQ2Il&amp;QlUct5E)2td2ZmnbnLc)t?4*4C@=`hc+oM*%hes?NQh;q
z)|Pq@mqX0zxq)xfvD*gjpyLpdCtddy0N5=QcW(*+xJih$+{rW&amp;9H#qqcc+p3A&lt;h5*
zrRDD*0PVB)LVi0bkP3C#7a$g=&amp;kMZ6&lt;^p}IvH-x)^bZ$61)#&lt;m0D;7RIEe`W@YRqX
z`G=daT%Rih-$V1*BfoAAVbO)Q-mb09NWj&gt;#09eUfTl-bKwzg6N0QwC8&amp;3&gt;d{YRI}Q
zd=R7yfdAItc;??4XqX&amp;&amp;f`x!Lc#SwC%cx%T5CZ}GY|}Gl4OR?$A*V1mg{Nq1A%B#h
zw$LbnCbA|LDgH|$SaMv-M!Ho-N;YHXqMY0AXL}44T9lNP3shFrY}GGmeAiOc4%u6;
zv!th~A5UyESTGdbZ*;)N=!9{eNsVcn*`WD%OJ*x6YfGC*+bX*udnO0PL-vle!!b@L
zoMT*Qu32tPq_1Q_4{Og;Uaj6szPtR~{L?9w0jC2!kLXi((D;Hlf;mEXLWRS&amp;hwq9|
zII0n;7qu_i;FxZVO00Aoe&gt;_Y4^6}{t?-O2}e0-`Q@lsMoa(Iess!^Is`t}U|O!h2&gt;
ztl85e*&amp;R7mXVTC5pEEkYBbO!j`-PWz_wox0LJEy83SFEoYAjADu`CrXoi1y&gt;lyy0%
z{7?n4a`zR%DqPj{)xK+2sv~QN*Ez3$t9^5$yRPNtom&lt;uQWw&amp;!1lJ6XCbZ^qW%W${h
z9__xu{pIE-EhVin4_w-G9*VZ3+dn*N?&lt;jd3*=g}a?8%R(O&lt;f7yrakzcx4mV3p8b;j
zpPrQrI6dck{`^JuOY2uWuZ9OpUXzAIhTgu(88&amp;%~dD}P=G%7dx?OpAA+6Va$-^MO|
zbQotDzw^m!0zc9AIrxj@m*KB@lh#w{sod#p(?#ESza@NI{GRuh+YjOl%S`$#$85?^
zrk^=;(sM87D;BOTt}eT*t-&lt;{B0CR8|*@{%5ywUcUXoewNB4ZTuZB~Bv0#1Hzf1aeR
z$N2RG28GmxGYKC=HN?(~FH6`&lt;Hc3fHr|y`Mb=cV=w{7=v`B4Qe#Z09SDhjG$YK`i%
znlf64w3Fc~c&amp;mreClL1&lt;*zWT&amp;jM$%WAl&gt;MkaiK}6X}MX2`4x*=%ZFCO)&lt;0~qcDx6-
z+wXDEI&lt;(Kx?69qqlQYSM;u_)&gt;OUiIBBv*Sp@a*&lt;_&lt;Xz`e=$q&amp;l&lt;nKl?56}vfJt9P9
zr=e-{LDRwGAtRx$!(N5Ij2JlD71&lt;b-A02VbAx1M+ERH#DHh$#z(-RE|Whc{5MI?GA
znI$Wy2&amp;Al~j;1xI7i1)5QnGAMt7i-6fSi#tch8&lt;XcjUZbu2AmGg@&lt;`L`5py|g{Z=w
zi-ko;ifu|XOShG=md#xnzWkuPydtGC@QQVn%2ocW%h%pk-&gt;)gY9#`vrgIFh4w{-K#
zt@HJMx3wEM8$RD@Y0PhmxNCn;?Y&gt;Ymy7_ZUSL^Ku1#PDu(%Ky!sdlh+e0W^ndHPAf
zQ&lt;E;4?#&lt;oPJ-xlveX0GP&amp;$I@%42(Umei8ao{pIqj*1@Z&lt;bB9j8IWlbbR(*tTWOlUY
zT?t$X+GC7k{U6Va+kX=HG(3_2+3}0Wm)Wn6C$pyPrun8{e#`!D_80E2wjZ%GI&lt;uJB
z{-2d|&gt;GKH-Ig5{fnXdS+=bshG0TQ?j77-Hi26Y1Mgb8El!=*C%F{`mmvnH``=J4Cn
z$hpETg*WE$&lt;vqGJjxT{fRp5+ZvCviF2Eqf8C!#%Ked3+lnj|VEbGAoHxk?jvNXu}@
z{F42&amp;b70p!xx(Gy@)mnU_e?9)D;`raP-a#hP$^WUs1emgG*B8JH9NE_wNLJK(UH@c
z*S)QGRNs=QY#_96)4mzQk^N5(+%~#soM7T&lt;s&amp;D$)EY*CE`8$g&lt;mgZJmRzudMHWXWB
zJ7D+pV6MG~gPg&lt;Mp*xO84{IJ?b!u@w;bQE{={o3^PjYe&gt;a33U}@v!vV;yK`T*88vz
z!Dqxb&amp;(F@E&amp;A*)z9iSZWBe3Sk5vme(fp#k&gt;FjzeJWk^D(eCTl4sc?nx_Yqk~iILdI
zo~R4aKF8E!m}3TGOX57@MdDu`Pds6tAa`=}$;ngQiPw{|lfzQ%QWewK(q5&amp;fW{79p
z&amp;2-AbW!0Vb$rjIkmvixq^I74uW9O&gt;Q({hz_7cVsAh2|^f&amp;lc1b247UYxLWkEIJv~4
z6kj@2R&amp;&gt;exvQjy={B=cbW!e&gt;=D*dZMSLd%itFEcZxE==AmtCFNO~YGS^}BBq8kics
z-x+AU)s%NP=AP$$%VwPxl~#oZ3T;XcRom4bsdUIcmgwZ_TzWFvCEH!mYuL{^u=xdP
z5dX$&amp;^wh`p$xri9^!#t^ee^v6s|3K=&amp;j1`U2f+FQ0BN=WNR|S??E--LX2_`ml;d`Q
z64?h3q7eAAfA9enU&lt;vn-V;~chfI83yo`Lt^J6J_n5Pn1k(LhWQ7bFNdg%lul$Wvq-
zg+d9Vv{25dI8-^R2ep6}MVp}`(O1wzn9Ud+ObDh5GsYmqV9$`v(1&amp;HinqZT$oj69^
z0bB~MZ`0OIq)pYERvFD0OBffKESRn^Gcda{-(%rtiC`JtY_PeOmB4zMjgc*mZH+yO
zeT5@&gt;3)m9NiRO&amp;uLbzhM0e2jp0iVLd%TvLt%lm$75}zjDbAE6BWq~w75y2ZmhC)Na
zfdm|(NJLX)STsh=R9s~n-?mwaM{s33Nl8deOV{r&gt;A!8#eE&lt;3lgYgdI_^6nscw&gt;?%0
z28!xRJC(&amp;%_*Hq;_|!!;WHr^b_G?@3b&lt;*+FrRYWJ=Mb+Oyf6g&amp;cOM|b?_a0Ml9`k_
z*`nGCSUcD&gt;*-0GCuwOdl;@IxQ?d;@I&lt;~m7Iaz9BP@ig-4@Nx7V@Rxz&gt;wD*Vrl|pL{
z#)kxjz6d8q3`I6XC&amp;v(Dr{fb&amp;;1h~Z$t5-?Tc&gt;&lt;Xi_h4RIdZx%$M3AxdG6frc|8R!
z7wd}~OCMb7Detd*R@Hf}t!AKh&gt;LyRUUPDOZ#k(!{2U`}}B-_0@nx2StrSvTII}hA&gt;
zF*oS^Ms1||!&gt;w_j3G***Q;+|m&amp;fc7NT%`TtSaw~JU0GO7TEnizuYW&amp;8fi5@&lt;LO?3a
zem&amp;&gt;}!(bW#2nQmHC?G_{4)I1Jk#wXKX+V0B&amp;nPs^y(Y&gt;D=Dq^;5{*TxpncH==za_i
zqk##6ng94Z^Zi(MtQj@~+mFNJ9C0PMubY%M#c%3k6k!Zz&gt;|_#Uie?&amp;O)?hARL9zI-
z3~b&amp;D^Df4k%f`u;!OqT}&amp;B4b}yk#f+YMF43as_i^xHIs=`0G4Go*~}gt(;qH`E2-&gt;
z_=^Pg3;Yx;6fzN76245Z5n&amp;LyAxaVx75gFHzO6taRMKp_loVF#gLLzbLYZh;r=6O+
zgm$gTjqJWJU%cm(LbzhIQi}3fm15NjwHxY98V@wPv|ej}-Mga8swb^aBzhTS&gt;}xXo
zc7WYT)7aDGoN1Rilf{0^OsioVIokxgF?&amp;OYYmR(}Q=L{^yj^dS7~HMNmpzufY`yDz
zx&amp;1=@hXeEjuTzC-nZf9gh|urhz7aE#&gt;Cy7Xx?}y~8IPAFsGfY9=#(^-5|M^WKc6X*
zRhO-s(|y+KykPEdUSWa7MTVmK5}z`@OI_s&amp;mBcFct7Fxz*K2QFy?MXBy@A&gt;&amp;(KK`~
zznRpk+_v@M&gt;Z94mi%*%m#d}Trj}Fwlm&gt;QHBQX3|YguJUAV;Fawc=%O(D*9Xh56mpj
z9MgQ?V!+bKGJXZSGQ66&lt;X1bn#Rp1Y@;d|c;zQDZW;Tx}qI3l6QY2-T6kNiXlpbStn
zR0--8njL)rorvzjaATY&gt;6_}q4dJLx-K4R6dS=cF@5v~Tl+b1_IG6pbyW+F4aXLey8
zVR2#kv^k8Gm9&gt;h^f^CKUDu?S9?k%01;an12ecaJ_S^RsR0$%b~RXzc}PyCk!JOw2M
zCxosD2M|&lt;6a3XI+Z;O4}#x0&gt;BX}H}&amp;&gt;Y%jK4j-8?*|?pVyDrPM@1EMjt3XtwDHSMp
zsRA`E^&gt;~eLEkSLsy|wV%YN&amp;t7fN5W-;lu$4qemukrrG9*MVu9zb)~J&lt;L6m*%A*aJ=
zr#R;&amp;SBl#^_e112o-}V^pO1dN{-XgFf%m8~wA^5(koYhpJmsiIRN1lS*n9D%C!$VT
zBuXYNrQA&lt;T&amp;T!4r$(BBYKL^f#xzLkeQ&lt;zf}RpM7&gt;e_6MJP&amp;r@Kb}gmGx&gt;o$g{LPN~
zvkk6|f=#{m!kYzJS|0&gt;HlxUymsOwC6&gt;fWu^%hmVk*{$c{FL%8feVzVBefaZ8;k!d0
z#K#uL-%pHu(fb-XSv1u!-TLkR_wv7zf7s0M&amp;UDX){1pCKJ*PU?HoteidO&gt;(0ZDD5d
zz+&amp;;@;*$AN&gt;C)IQ@n7U$WxvLkC6+ywGnel!PpojRXs`IJ&lt;gB!;Os?{-8m=B&amp;y|p^I
zCbs6VmbunJ&amp;;LffMBhIElU{&amp;d0F_{@r@!9)-(CFuf?-Xz-nPIi3&amp;qXU4BqK@A~49D
zUJK&amp;kZ;2LSMTB&gt;DSPrp!cpL2hjS23q`bH27Kwd7wOV1QySf?Sz9#jKMh@l&lt;ippWYT
zxbFd0h&lt;(Tu8&gt;`=ZSfJl}jZ2qF3JlVv%kx5&lt;N2U?~$kau6S=;^AZKnoX+CVH0Wd?i$
zjOg-oUkmPJ{ok&gt;nFcd#iW5~mpQC!|Z`|0s&gt;K`adnfGeN^Pe2B;z!&gt;NO{ohvt&lt;O#4J
z07uDy2Ia=q&lt;^D+7uJ^tFO-mMdtlJA&amp;*YO48P{-fdJB|u%ZCHN{PkvM=L;1tVU6K1N
zxBREK?$K}E&gt;mLmx*!#cChNX?@Hb%UGJCypvlm2MXJ^R;sgq#ZqSF`oPNMPhKiWpst
zCPoXR3J4fHh7ZVM6fi3A44{oshhwVUll7B-$FeauZht?c5sZTjg4bt+@;Cecyuy&lt;S
z*r?s%ECVcD8+r8q3qUIeO!dFDAaWS2&gt;jBUU2n?rsdwK;Cbl^W1WEsMK3TdYdL0(Qy
z75odGopoo?8)?@7000SaNLh0L01FcU01FcV0GgZ_0000+Nkl&lt;ZSPAXaK@9*g3&lt;I#+
zF(`kIrLX}AgUEg67gx&amp;J-TOHL1PGJ~%uF=;BM}fFK%i8&gt;;FUgBEdm5mz~H5cgaCn3
Zfd?jx1O&amp;#g3O)b;002ovPDHLkV1f*Z^49&lt;W</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mail/themes/gnomestripe/mail/searchBox.css</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/searchBox.css</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -34,31 +34,25 @@</span>
<a href="#l44.4"></a><span id="l44.4"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l44.5"></a><span id="l44.5"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l44.6"></a><span id="l44.6"> #</span>
<a href="#l44.7"></a><span id="l44.7"> # ***** END LICENSE BLOCK *****</span>
<a href="#l44.8"></a><span id="l44.8"> */</span>
<a href="#l44.9"></a><span id="l44.9"> </span>
<a href="#l44.10"></a><span id="l44.10"> /* ..... tree adjustments ..... */</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-.quick-search-textbox</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-{</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+.quick-search-textbox {</span>
<a href="#l44.15"></a><span id="l44.15">   padding-top: 1px;</span>
<a href="#l44.16"></a><span id="l44.16"> }</span>
<a href="#l44.17"></a><span id="l44.17"> </span>
<a href="#l44.18"></a><span id="l44.18" class="difflineminus">-#searchInput[searchCriteria=&quot;true&quot;]  {</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineminus">-  color: grey;</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineminus">-}</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineminus">-</span>
<a href="#l44.22"></a><span id="l44.22"> #quick-search-button  {</span>
<a href="#l44.23"></a><span id="l44.23">   margin-top: 0px;</span>
<a href="#l44.24"></a><span id="l44.24">   margin-bottom: 0px;</span>
<a href="#l44.25"></a><span id="l44.25">   -moz-margin-start: 0px;</span>
<a href="#l44.26"></a><span id="l44.26">   -moz-margin-end: 2px;</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineminus">-</span>
<a href="#l44.28"></a><span id="l44.28"> }</span>
<a href="#l44.29"></a><span id="l44.29"> </span>
<a href="#l44.30"></a><span id="l44.30"> .quick-search-button-image {</span>
<a href="#l44.31"></a><span id="l44.31">   margin: 0px;</span>
<a href="#l44.32"></a><span id="l44.32">   list-style-image: url(&quot;chrome://global/skin/icons/Search-glass.png&quot;);</span>
<a href="#l44.33"></a><span id="l44.33"> }</span>
<a href="#l44.34"></a><span id="l44.34"> </span>
<a href="#l44.35"></a><span id="l44.35"> .quick-search-button-image[chromedir=&quot;rtl&quot;] {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mail/themes/pinstripe/jar.mn</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mail/themes/pinstripe/jar.mn</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -1,10 +1,11 @@</span>
<a href="#l45.4"></a><span id="l45.4"> classic.jar:</span>
<a href="#l45.5"></a><span id="l45.5"> % skin messenger classic/1.0 %skin/classic/messenger/</span>
<a href="#l45.6"></a><span id="l45.6" class="difflineplus">+  skin/classic/messenger/glodaFacetView.css                      (mail/glodaFacetView.css)</span>
<a href="#l45.7"></a><span id="l45.7">   skin/classic/messenger/multimessageview.css                    (mail/multimessageview.css)</span>
<a href="#l45.8"></a><span id="l45.8">   skin/classic/messenger/dialogs.css                             (mail/dialogs.css)</span>
<a href="#l45.9"></a><span id="l45.9">   skin/classic/messenger/messenger.css                           (mail/messenger.css)</span>
<a href="#l45.10"></a><span id="l45.10">   skin/classic/messenger/primaryToolbar.css                      (mail/primaryToolbar.css)</span>
<a href="#l45.11"></a><span id="l45.11">   skin/classic/messenger/accountCentral.css                      (mail/accountCentral.css)</span>
<a href="#l45.12"></a><span id="l45.12">   skin/classic/messenger/accountCreation.css                     (mail/accountCreation.css)</span>
<a href="#l45.13"></a><span id="l45.13">   skin/classic/messenger/accountManage.css                       (mail/accountManage.css)</span>
<a href="#l45.14"></a><span id="l45.14">   skin/classic/messenger/accountWizard.css                       (mail/accountWizard.css)</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineat">@@ -127,17 +128,20 @@ classic.jar:</span>
<a href="#l45.16"></a><span id="l45.16">   skin/classic/messenger/icons/attachment-deleted.png            (mail/icons/attachment-deleted.png)</span>
<a href="#l45.17"></a><span id="l45.17">   skin/classic/messenger/icons/attachment-deleted-large.png      (mail/icons/attachment-deleted-large.png)</span>
<a href="#l45.18"></a><span id="l45.18">   skin/classic/messenger/icons/attachment-col.png                (mail/icons/attachment-col.png)</span>
<a href="#l45.19"></a><span id="l45.19">   skin/classic/messenger/icons/attachment-selected.png           (mail/icons/attachment-selected.png)</span>
<a href="#l45.20"></a><span id="l45.20">   skin/classic/messenger/icons/attachment.png                    (mail/icons/attachment.png)</span>
<a href="#l45.21"></a><span id="l45.21">   skin/classic/messenger/icons/check.png                         (mail/icons/check.png)</span>
<a href="#l45.22"></a><span id="l45.22">   skin/classic/messenger/icons/dot.png                           (mail/icons/dot.png)</span>
<a href="#l45.23"></a><span id="l45.23">   skin/classic/messenger/icons/flagcol.png                       (mail/icons/flagcol.png)</span>
<a href="#l45.24"></a><span id="l45.24" class="difflineplus">+  skin/classic/messenger/icons/flag-col.png                      (mail/icons/flag-col.png)</span>
<a href="#l45.25"></a><span id="l45.25">   skin/classic/messenger/icons/flaggedmail.png                   (mail/icons/flaggedmail.png)</span>
<a href="#l45.26"></a><span id="l45.26" class="difflineplus">+  skin/classic/messenger/icons/exclude.png                       (mail/icons/exclude.png)</span>
<a href="#l45.27"></a><span id="l45.27" class="difflineplus">+  skin/classic/messenger/icons/exclude-selected.png              (mail/icons/exclude-selected.png)</span>
<a href="#l45.28"></a><span id="l45.28">   skin/classic/messenger/icons/folder-archive.png                (mail/icons/folder-archive.png)</span>
<a href="#l45.29"></a><span id="l45.29">   skin/classic/messenger/icons/folder-closed.png                 (mail/icons/folder-closed.png)</span>
<a href="#l45.30"></a><span id="l45.30">   skin/classic/messenger/icons/folder-draft.png                  (mail/icons/folder-draft.png)</span>
<a href="#l45.31"></a><span id="l45.31">   skin/classic/messenger/icons/folder-inbox.png                  (mail/icons/folder-inbox.png)</span>
<a href="#l45.32"></a><span id="l45.32">   skin/classic/messenger/icons/folder-junk.png                   (mail/icons/folder-junk.png)</span>
<a href="#l45.33"></a><span id="l45.33">   skin/classic/messenger/icons/folder-newsgroup.png              (mail/icons/folder-newsgroup.png)</span>
<a href="#l45.34"></a><span id="l45.34">   skin/classic/messenger/icons/folder-open.png                   (mail/icons/folder-open.png)</span>
<a href="#l45.35"></a><span id="l45.35">   skin/classic/messenger/icons/folder-outbox.png                 (mail/icons/folder-outbox.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1">new file mode 100644</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineminus">--- /dev/null</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineplus">+++ b/mail/themes/pinstripe/mail/glodaFacetView.css</span>
<a href="#l46.4"></a><span id="l46.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l46.5"></a><span id="l46.5" class="difflineplus">+@import url(&quot;chrome://messenger/content/glodaFacetView.css&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1">new file mode 100644</span>
<a href="#l47.2"></a><span id="l47.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..7f017c0f1b2de983f61d1905973bbdfb379a58b6</span>
<a href="#l47.3"></a><span id="l47.3">GIT binary patch
literal 864
zc$@)X1E2hfP)&lt;h;3K|Lk000e1NJLTq000dD000dL1^@s6a_i)L00004XF*Lt007wQ
z^&amp;Awc0004~X+uL$Nkc;*P;zf(X&gt;4Tx0C)kdl08cUK@f)DJ4EpVEsO|?c!GsRln@&amp;w
zA|xq-C=x=zk3zWIok=8Kj&gt;{z~_ya^N)GlJ7c0v#ltZcMZf=E&gt;G7ic9S7z&gt;qi_7;ht
zVB^B&gt;KKt&amp;&gt;?9R&gt;t;;C#HDG|WDZkdr#K$@JImTK-$3no&amp;Nm5kvJhsXHpx3PQ+f$61Q
z7Hj`&lt;xiB{zy;1i*d}8;}%x@mwv&lt;8z71Oyjpt~lo&amp;#xc%Aj2A4!BAYN{B_XTC)ZsRx
zks$FpabukG4&amp;xZ-L&amp;iBJ&amp;U{aaJ-V9IiJyoER4t&lt;bB0I}c43licZQ^d0Kh4zUqJVD)
zs47&gt;qbOTVh20Hx}ts@Jxo&amp;yK&gt;747-Lc@sg;XJ-4oPB@{x8K}Rt?T1~UX%l!qv+dUx
z+kU$Ns*iz&lt;H6?5299z1iPz3&amp;3^W1oJUISuQ3#T4Gndk4=dw~2ZFmVNpZviWhKvw{0
zsRKeKVDtn+QTXcotsK9$pqxs^Oxe;@iG7z~I+ZpvhOB7L_Wuo*wn#Mrf@x#POvV$I
z&lt;fq@Ixup?Z&gt;2ph7k7p2{_g#BNu*`2c00009a7bBm000XU000XU0RWnu7ytkPPDw;T
zR45glQL#z`K@fd=IW7bgNxXoNN&gt;EO;5w)@sY*Jm}H&amp;}_^U}2LV5bJ&lt;npdh3XtZXzQ
zi2gx9Q0@@K&lt;c{2}Z}zeXvXuk7J3DXQykQ1#*bwa%IS$B#lm%XZAV&gt;QIm&gt;x5&gt;FpGZz
z{#k(c(+wcExrX$&gt;Bp&lt;CC4ZTfZq@f0qprE^aItpqyMY6vGun6E)SJ)E*D_o3`u5KYY
ztRp$nz_Z|jc?f&amp;riy5Uyw7yyOEkL&gt;^ZAhybnwJE-Bo6pSR9~7PS=&lt;H2Mu~(*33cTn
zOpqQ3COLJ4&gt;!M^x;)wlK5Q0&gt;$(BIn^m(rBfF&lt;XjkOO{YgRmYN(;p0{EXG&amp;h5{&lt;4dZ
zp&gt;-}8Q~Oqxd4P=EL-UrOO@2pwuS?Vlg(Bv^!(lv?NcZf&gt;4M~W1KqKICYt?e+Bu4ux
qxZIq}wJKHEao=M;lH-8&gt;ANm0?s(TyzcK&gt;Gp0000&lt;MNUMnLSTaUB6tG;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1">new file mode 100644</span>
<a href="#l48.2"></a><span id="l48.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..47295b6dc66ca6562922cfb22a3a224cab578ae8</span>
<a href="#l48.3"></a><span id="l48.3">GIT binary patch
literal 851
zc$@)K1FZasP)&lt;h;3K|Lk000e1NJLTq000dD000dL1^@s6a_i)L00004XF*Lt007wQ
z^&amp;Awc0004~X+uL$Nkc;*P;zf(X&gt;4Tx0C)kdl08cUK@f)DJ4EpVEsO|?c!GsRln@&amp;w
zA|xq-C=x=zk3zWIok=8Kj&gt;{z~_ya^N)GlJ7c0v#ltZcMZf=E&gt;G7ic9S7z&gt;qi_7;ht
zVB^B&gt;KKt&amp;&gt;?9R&gt;t;;C#HDG|WDZkdr#K$@JImTK-$3no&amp;Nm5kvJhsXHpx3PQ+f$61Q
z7Hj`&lt;xiB{zy;1i*d}8;}%x@mwv&lt;8z71Oyjpt~lo&amp;#xc%Aj2A4!BAYN{B_XTC)ZsRx
zks$FpabukG4&amp;xZ-L&amp;iBJ&amp;U{aaJ-V9IiJyoER4t&lt;bB0I}c43licZQ^d0Kh4zUqJVD)
zs47&gt;qbOTVh20Hx}ts@Jxo&amp;yK&gt;747-Lc@sg;XJ-4oPB@{x8K}Rt?T1~UX%l!qv+dUx
z+kU$Ns*iz&lt;H6?5299z1iPz3&amp;3^W1oJUISuQ3#T4Gndk4=dw~2ZFmVNpZviWhKvw{0
zsRKeKVDtn+QTXcotsK9$pqxs^Oxe;@iG7z~I+ZpvhOB7L_Wuo*wn#Mrf@x#POvV$I
z&lt;fq@Ixup?Z&gt;2ph7k7p2{_g#BNu*`2c00009a7bBm000XU000XU0RWnu7ytkPK}keG
zR45glQ9EkGKoHd@NEiY}wbcY13&gt;JvMULcUhm5ZFfg{$B*xNwsT7}tiJAb~)dKrSE%
z3QFrnZY2T%BMG6rxAw{qZ{&gt;lvGdu6i&amp;g`yXXe&lt;bVKB1vx%2WhIj&amp;0j&gt;&gt;}O5WbeT6z
z^9OEO*YzSvl9D-^ED}O=%d&amp;jOUI1H&amp;-$&lt;f(1lI#1$8qkWDB&gt;Z8#igpMM&gt;qlTQ=aG7
zaU4%^`U7%b&lt;YD5VksDcrXaZ~?oTh2I&lt;EWNpJtN0X?79IazVCP7_nk0C2YBJ!{|nIh
zo*Xrv=MCE;1~gp(JMY=!dchEPAu)y@z{`=?L5+$$xm}iJ-_)x+tr1@VCk6P1)qz{9
zuI-Z-Me%{tZXnnKuZU~hV~n^5|LMB!t$OnIbNMp3sQg?AF9F&amp;wu*9ef)kS7?OBjX&amp;
dLdTt*`vW)2lp+i~m5=}c002ovPDHLkV1i!NbT|M2</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1">new file mode 100644</span>
<a href="#l49.2"></a><span id="l49.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..25db669da4759032c8bb2a105dea69683384d18b</span>
<a href="#l49.3"></a><span id="l49.3">GIT binary patch
literal 4071
zc$@*}4;b)?P)&lt;h;3K|Lk000e1NJLTq00BGz000CC1^@s66I+9F000k1X+uL$Nkc;*
zP;zf(X&gt;4Tx0C)kdSa~&gt;&lt;UH?D#%$UiNB@9`|5)mcY*DNDt-y_+^*bU9tLzYtZC0b&lt;3
zR!EVQM1&gt;?NYg!~xNh;J6*|NN6sOPzU@9%oA_n-G%*WCB#e9m{f&amp;-dK-Io|&lt;*L%=mK
z&amp;&lt;_Ow@TUY(E%)gX4%#~qaD#vmAb&lt;z#0b;HsTA+@(xiJ*^4{h!Rl!fh?EZx@Nha7ST
zw(6#6+*3+q|Md8OQ2Il&amp;QlUct5E)2td2ZmnbnLc)t?4*4C@=`hc+oM*%hes?NQh;q
z)|Pq@mqX0zxq)xfvD*gjpyLpdCtddy0N5=QcW(*+xJih$+{rW&amp;9H#qqcc+p3A&lt;h5*
zrRDD*0PVB)LVi0bkP3C#7a$g=&amp;kMZ6&lt;^p}IvH-x)^bZ$61)#&lt;m0D;7RIEe`W@YRqX
z`G=daT%Rih-$V1*BfoAAVbO)Q-mb09NWj&gt;#09eUfTl-bKwzg6N0QwC8&amp;3&gt;d{YRI}Q
zd=R7yfdAItc;??4XqX&amp;&amp;f`x!Lc#SwC%cx%T5CZ}GY|}Gl4OR?$A*V1mg{Nq1A%B#h
zw$LbnCbA|LDgH|$SaMv-M!Ho-N;YHXqMY0AXL}44T9lNP3shFrY}GGmeAiOc4%u6;
zv!th~A5UyESTGdbZ*;)N=!9{eNsVcn*`WD%OJ*x6YfGC*+bX*udnO0PL-vle!!b@L
zoMT*Qu32tPq_1Q_4{Og;Uaj6szPtR~{L?9w0jC2!kLXi((D;Hlf;mEXLWRS&amp;hwq9|
zII0n;7qu_i;FxZVO00Aoe&gt;_Y4^6}{t?-O2}e0-`Q@lsMoa(Iess!^Is`t}U|O!h2&gt;
ztl85e*&amp;R7mXVTC5pEEkYBbO!j`-PWz_wox0LJEy83SFEoYAjADu`CrXoi1y&gt;lyy0%
z{7?n4a`zR%DqPj{)xK+2sv~QN*Ez3$t9^5$yRPNtom&lt;uQWw&amp;!1lJ6XCbZ^qW%W${h
z9__xu{pIE-EhVin4_w-G9*VZ3+dn*N?&lt;jd3*=g}a?8%R(O&lt;f7yrakzcx4mV3p8b;j
zpPrQrI6dck{`^JuOY2uWuZ9OpUXzAIhTgu(88&amp;%~dD}P=G%7dx?OpAA+6Va$-^MO|
zbQotDzw^m!0zc9AIrxj@m*KB@lh#w{sod#p(?#ESza@NI{GRuh+YjOl%S`$#$85?^
zrk^=;(sM87D;BOTt}eT*t-&lt;{B0CR8|*@{%5ywUcUXoewNB4ZTuZB~Bv0#1Hzf1aeR
z$N2RG28GmxGYKC=HN?(~FH6`&lt;Hc3fHr|y`Mb=cV=w{7=v`B4Qe#Z09SDhjG$YK`i%
znlf64w3Fc~c&amp;mreClL1&lt;*zWT&amp;jM$%WAl&gt;MkaiK}6X}MX2`4x*=%ZFCO)&lt;0~qcDx6-
z+wXDEI&lt;(Kx?69qqlQYSM;u_)&gt;OUiIBBv*Sp@a*&lt;_&lt;Xz`e=$q&amp;l&lt;nKl?56}vfJt9P9
zr=e-{LDRwGAtRx$!(N5Ij2JlD71&lt;b-A02VbAx1M+ERH#DHh$#z(-RE|Whc{5MI?GA
znI$Wy2&amp;Al~j;1xI7i1)5QnGAMt7i-6fSi#tch8&lt;XcjUZbu2AmGg@&lt;`L`5py|g{Z=w
zi-ko;ifu|XOShG=md#xnzWkuPydtGC@QQVn%2ocW%h%pk-&gt;)gY9#`vrgIFh4w{-K#
zt@HJMx3wEM8$RD@Y0PhmxNCn;?Y&gt;Ymy7_ZUSL^Ku1#PDu(%Ky!sdlh+e0W^ndHPAf
zQ&lt;E;4?#&lt;oPJ-xlveX0GP&amp;$I@%42(Umei8ao{pIqj*1@Z&lt;bB9j8IWlbbR(*tTWOlUY
zT?t$X+GC7k{U6Va+kX=HG(3_2+3}0Wm)Wn6C$pyPrun8{e#`!D_80E2wjZ%GI&lt;uJB
z{-2d|&gt;GKH-Ig5{fnXdS+=bshG0TQ?j77-Hi26Y1Mgb8El!=*C%F{`mmvnH``=J4Cn
z$hpETg*WE$&lt;vqGJjxT{fRp5+ZvCviF2Eqf8C!#%Ked3+lnj|VEbGAoHxk?jvNXu}@
z{F42&amp;b70p!xx(Gy@)mnU_e?9)D;`raP-a#hP$^WUs1emgG*B8JH9NE_wNLJK(UH@c
z*S)QGRNs=QY#_96)4mzQk^N5(+%~#soM7T&lt;s&amp;D$)EY*CE`8$g&lt;mgZJmRzudMHWXWB
zJ7D+pV6MG~gPg&lt;Mp*xO84{IJ?b!u@w;bQE{={o3^PjYe&gt;a33U}@v!vV;yK`T*88vz
z!Dqxb&amp;(F@E&amp;A*)z9iSZWBe3Sk5vme(fp#k&gt;FjzeJWk^D(eCTl4sc?nx_Yqk~iILdI
zo~R4aKF8E!m}3TGOX57@MdDu`Pds6tAa`=}$;ngQiPw{|lfzQ%QWewK(q5&amp;fW{79p
z&amp;2-AbW!0Vb$rjIkmvixq^I74uW9O&gt;Q({hz_7cVsAh2|^f&amp;lc1b247UYxLWkEIJv~4
z6kj@2R&amp;&gt;exvQjy={B=cbW!e&gt;=D*dZMSLd%itFEcZxE==AmtCFNO~YGS^}BBq8kics
z-x+AU)s%NP=AP$$%VwPxl~#oZ3T;XcRom4bsdUIcmgwZ_TzWFvCEH!mYuL{^u=xdP
z5dX$&amp;^wh`p$xri9^!#t^ee^v6s|3K=&amp;j1`U2f+FQ0BN=WNR|S??E--LX2_`ml;d`Q
z64?h3q7eAAfA9enU&lt;vn-V;~chfI83yo`Lt^J6J_n5Pn1k(LhWQ7bFNdg%lul$Wvq-
zg+d9Vv{25dI8-^R2ep6}MVp}`(O1wzn9Ud+ObDh5GsYmqV9$`v(1&amp;HinqZT$oj69^
z0bB~MZ`0OIq)pYERvFD0OBffKESRn^Gcda{-(%rtiC`JtY_PeOmB4zMjgc*mZH+yO
zeT5@&gt;3)m9NiRO&amp;uLbzhM0e2jp0iVLd%TvLt%lm$75}zjDbAE6BWq~w75y2ZmhC)Na
zfdm|(NJLX)STsh=R9s~n-?mwaM{s33Nl8deOV{r&gt;A!8#eE&lt;3lgYgdI_^6nscw&gt;?%0
z28!xRJC(&amp;%_*Hq;_|!!;WHr^b_G?@3b&lt;*+FrRYWJ=Mb+Oyf6g&amp;cOM|b?_a0Ml9`k_
z*`nGCSUcD&gt;*-0GCuwOdl;@IxQ?d;@I&lt;~m7Iaz9BP@ig-4@Nx7V@Rxz&gt;wD*Vrl|pL{
z#)kxjz6d8q3`I6XC&amp;v(Dr{fb&amp;;1h~Z$t5-?Tc&gt;&lt;Xi_h4RIdZx%$M3AxdG6frc|8R!
z7wd}~OCMb7Detd*R@Hf}t!AKh&gt;LyRUUPDOZ#k(!{2U`}}B-_0@nx2StrSvTII}hA&gt;
zF*oS^Ms1||!&gt;w_j3G***Q;+|m&amp;fc7NT%`TtSaw~JU0GO7TEnizuYW&amp;8fi5@&lt;LO?3a
zem&amp;&gt;}!(bW#2nQmHC?G_{4)I1Jk#wXKX+V0B&amp;nPs^y(Y&gt;D=Dq^;5{*TxpncH==za_i
zqk##6ng94Z^Zi(MtQj@~+mFNJ9C0PMubY%M#c%3k6k!Zz&gt;|_#Uie?&amp;O)?hARL9zI-
z3~b&amp;D^Df4k%f`u;!OqT}&amp;B4b}yk#f+YMF43as_i^xHIs=`0G4Go*~}gt(;qH`E2-&gt;
z_=^Pg3;Yx;6fzN76245Z5n&amp;LyAxaVx75gFHzO6taRMKp_loVF#gLLzbLYZh;r=6O+
zgm$gTjqJWJU%cm(LbzhIQi}3fm15NjwHxY98V@wPv|ej}-Mga8swb^aBzhTS&gt;}xXo
zc7WYT)7aDGoN1Rilf{0^OsioVIokxgF?&amp;OYYmR(}Q=L{^yj^dS7~HMNmpzufY`yDz
zx&amp;1=@hXeEjuTzC-nZf9gh|urhz7aE#&gt;Cy7Xx?}y~8IPAFsGfY9=#(^-5|M^WKc6X*
zRhO-s(|y+KykPEdUSWa7MTVmK5}z`@OI_s&amp;mBcFct7Fxz*K2QFy?MXBy@A&gt;&amp;(KK`~
zznRpk+_v@M&gt;Z94mi%*%m#d}Trj}Fwlm&gt;QHBQX3|YguJUAV;Fawc=%O(D*9Xh56mpj
z9MgQ?V!+bKGJXZSGQ66&lt;X1bn#Rp1Y@;d|c;zQDZW;Tx}qI3l6QY2-T6kNiXlpbStn
zR0--8njL)rorvzjaATY&gt;6_}q4dJLx-K4R6dS=cF@5v~Tl+b1_IG6pbyW+F4aXLey8
zVR2#kv^k8Gm9&gt;h^f^CKUDu?S9?k%01;an12ecaJ_S^RsR0$%b~RXzc}PyCk!JOw2M
zCxosD2M|&lt;6a3XI+Z;O4}#x0&gt;BX}H}&amp;&gt;Y%jK4j-8?*|?pVyDrPM@1EMjt3XtwDHSMp
zsRA`E^&gt;~eLEkSLsy|wV%YN&amp;t7fN5W-;lu$4qemukrrG9*MVu9zb)~J&lt;L6m*%A*aJ=
zr#R;&amp;SBl#^_e112o-}V^pO1dN{-XgFf%m8~wA^5(koYhpJmsiIRN1lS*n9D%C!$VT
zBuXYNrQA&lt;T&amp;T!4r$(BBYKL^f#xzLkeQ&lt;zf}RpM7&gt;e_6MJP&amp;r@Kb}gmGx&gt;o$g{LPN~
zvkk6|f=#{m!kYzJS|0&gt;HlxUymsOwC6&gt;fWu^%hmVk*{$c{FL%8feVzVBefaZ8;k!d0
z#K#uL-%pHu(fb-XSv1u!-TLkR_wv7zf7s0M&amp;UDX){1pCKJ*PU?HoteidO&gt;(0ZDD5d
zz+&amp;;@;*$AN&gt;C)IQ@n7U$WxvLkC6+ywGnel!PpojRXs`IJ&lt;gB!;Os?{-8m=B&amp;y|p^I
zCbs6VmbunJ&amp;;LffMBhIElU{&amp;d0F_{@r@!9)-(CFuf?-Xz-nPIi3&amp;qXU4BqK@A~49D
zUJK&amp;kZ;2LSMTB&gt;DSPrp!cpL2hjS23q`bH27Kwd7wOV1QySf?Sz9#jKMh@l&lt;ippWYT
zxbFd0h&lt;(Tu8&gt;`=ZSfJl}jZ2qF3JlVv%kx5&lt;N2U?~$kau6S=;^AZKnoX+CVH0Wd?i$
zjOg-oUkmPJ{ok&gt;nFcd#iW5~mpQC!|Z`|0s&gt;K`adnfGeN^Pe2B;z!&gt;NO{ohvt&lt;O#4J
z07uDy2Ia=q&lt;^D+7uJ^tFO-mMdtlJA&amp;*YO48P{-fdJB|u%ZCHN{PkvM=L;1tVU6K1N
zxBREK?$K}E&gt;mLmx*!#cChNX?@Hb%UGJCypvlm2MXJ^R;sgq#ZqSF`oPNMPhKiWpst
zCPoXR3J4fHh7ZVM6fi3A44{oshhwVUll7B-$FeauZht?c5sZTjg4bt+@;Cecyuy&lt;S
z*r?s%ECVcD8+r8q3qUIeO!dFDAaWS2&gt;jBUU2n?rsdwK;Cbl^W1WEsMK3TdYdL0(Qy
z75odGopoo?8)?@7000SaNLh0L01FcU01FcV0GgZ_0000+Nkl&lt;ZSPAXaK@9*g3&lt;I#+
zF(`kIrLX}AgUEg67gx&amp;J-TOHL1PGJ~%uF=;BM}fFK%i8&gt;;FUgBEdm5mz~H5cgaCn3
Zfd?jx1O&amp;#g3O)b;002ovPDHLkV1f*Z^49&lt;W</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1">new file mode 100644</span>
<a href="#l50.2"></a><span id="l50.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..3ad5bd1d2116b30f78b425217087be705c8e7c63</span>
<a href="#l50.3"></a><span id="l50.3">GIT binary patch
literal 930
zc$@*E16}-yP)&lt;h;3K|Lk000e1NJLTq000aC000aK1^@s6R&amp;`wG00004XF*Lt007q5
z)K6G40004!X+uL$Nkc;*P;zf(X&gt;4Tx0C)kdl0QqsKp4iKRHP`?#rg+9$RM&gt;tmC`O2
zL})Xp)FGBawOg9RwoucMoK-)7d%;Z{`~yxRPU6@P(4`21AcEgOD7Z+8@8ysV7F|5J
z%kQ3h?tOFj9uR10wp|MV*t3|ETg%AXJ4HG8j1h2=nx?yUT2(j2Y|!}e1c~d9i#*mK
z$1hsQp@e`GCQrC5ILf&amp;sc!l!;vl)3*&amp;U!^Nh^Zsy&lt;Z}vflX$!=_?&amp;Y|@EzxdUgmpS
z#Bs~0TEy?f%ZBOdK!E3By6uoBa7H}O&amp;re@!EDNm80YmM+R&amp;;@zYhXIk*P=7PWC3_c
z_O&lt;Soe&lt;#vZ+ucnj{BTkz0}Q`&lt;UN-^+Pk&gt;(2^FA*&lt;uXjZ`UVxUR?&gt;i0OOFt=ffWPMA
zY$Cd-0Wq(IUyq+G&amp;hPu&lt;z{NUH7zMJ&amp;!08*Xa0^V_1L_!%PeJOi?=J4j-#4phwQ9-H
zm}$uTxhVBo-EnPAH~r=R8&lt;=@WH35{medJWj6(*&lt;Yb(t}F!_t&gt;xav~m2;R_esa2*L?
zp_Bjs010qNS#tmY3ljhU3ljkVnw%H_00E{+L_t(26=Pt)0#=1GFk=x03o)Tf%q-;A
zeJ{h?f=d&amp;+21X7Z_Bc@~o{CRO0@mn;f%tH%)6y7NqqJG&lt;)J$djEnGEOAKrMOpeOll
z&gt;wzl_-;gyj&amp;MW8j|Mc;zES~_ku8gXvo0+q!0-p#E!&lt;~!I|6VwH_t48H9}hA8|NE4m
zlVy8M*Y_tZU%vbnR!|k5&gt;=&gt;lYz|PIdz{&lt;|d@cYMS200~mW)VS2#}7}~9d~Sfc9o5p
zc&gt;~x&lt;+fV;FZ&gt;#?Ap`a+6i-_odw%;G$F#P%amf_#`4-CJ*ePcL#;@!2kZ+-+P_y2kX
z_rtbRe=Zt`yf&gt;5-XVl{0015wRU}RuoICJ#v|7#aM#T3n9I0X^~0az&amp;g|NHm&lt;9~M?7
zhX4N=82&lt;kH$G`*(jz53?F+P3B@C&gt;39LbAX(zkV_ZeEsl~;q1xx&amp;z?X0en-cM*NW-?
ze-&lt;GL263R8t1xw74U0+`xPSg*{&lt;(Y0iv|X!e`{Y}Vz}}3&gt;rY2s9+o_58CE3*hTr&gt;8
zG;lm*`0+=DEj6|8*K3#r!vTifQycyq=lZ|^cLhie0CG^Bv{7~%asU7T07*qoM6N&lt;$
Ef;gwL*Z=?k</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mail/themes/pinstripe/mail/searchBox.css</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mail/themes/pinstripe/mail/searchBox.css</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -32,21 +32,17 @@</span>
<a href="#l51.4"></a><span id="l51.4"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l51.5"></a><span id="l51.5"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l51.6"></a><span id="l51.6"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l51.7"></a><span id="l51.7"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l51.8"></a><span id="l51.8"> #</span>
<a href="#l51.9"></a><span id="l51.9"> # ***** END LICENSE BLOCK *****</span>
<a href="#l51.10"></a><span id="l51.10"> */</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-#searchInput[searchCriteria=&quot;true&quot;]  {</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineminus">-  color: grey;</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineminus">-}</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineminus">-</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineminus">-#quick-search-button {</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineplus">+.quick-search-button {</span>
<a href="#l51.18"></a><span id="l51.18">   -moz-margin-start: -10px;</span>
<a href="#l51.19"></a><span id="l51.19">   -moz-margin-end: 4px;</span>
<a href="#l51.20"></a><span id="l51.20">   margin-bottom: 0;</span>
<a href="#l51.21"></a><span id="l51.21">   margin-top: 0;</span>
<a href="#l51.22"></a><span id="l51.22"> }</span>
<a href="#l51.23"></a><span id="l51.23"> </span>
<a href="#l51.24"></a><span id="l51.24"> .quick-search-button-image {</span>
<a href="#l51.25"></a><span id="l51.25">   padding: 0px;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mail/themes/qute/jar.mn</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mail/themes/qute/jar.mn</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -60,16 +60,19 @@ classic.jar:</span>
<a href="#l52.4"></a><span id="l52.4">   skin/classic/messenger/folderPane.css                       (mail/folderPane.css)</span>
<a href="#l52.5"></a><span id="l52.5">   skin/classic/messenger/subscribe.css                        (mail/subscribe.css)</span>
<a href="#l52.6"></a><span id="l52.6">   skin/classic/messenger/virtualFolderListDialog.css          (mail/virtualFolderListDialog.css)</span>
<a href="#l52.7"></a><span id="l52.7">   skin/classic/messenger/searchDialog.css                     (mail/searchDialog.css)</span>
<a href="#l52.8"></a><span id="l52.8">   skin/classic/messenger/msgSelectOffline.css                 (mail/msgSelectOffline.css)</span>
<a href="#l52.9"></a><span id="l52.9">   skin/classic/messenger/filterDialog.css                     (mail/filterDialog.css)</span>
<a href="#l52.10"></a><span id="l52.10">   skin/classic/messenger/dialogs.css                          (mail/dialogs.css)</span>
<a href="#l52.11"></a><span id="l52.11">   skin/classic/messenger/multimessageview.css                 (mail/multimessageview.css)</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineplus">+  skin/classic/messenger/glodaFacetView.css                   (mail/glodaFacetView.css)</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+  skin/classic/messenger/icons/exclude.png                    (mail/icons/exclude.png)</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+  skin/classic/messenger/icons/exclude-selected.png           (mail/icons/exclude-selected.png)</span>
<a href="#l52.15"></a><span id="l52.15">   skin/classic/messenger/newmailalert.css                     (mail/newmailalert.css)</span>
<a href="#l52.16"></a><span id="l52.16">   skin/classic/messenger/tabmail.css                          (mail/tabmail.css)</span>
<a href="#l52.17"></a><span id="l52.17">   skin/classic/messenger/editContactOverlay.css               (mail/editContactOverlay.css)</span>
<a href="#l52.18"></a><span id="l52.18">   skin/classic/messenger/starred48.png                        (mail/starred48.png)</span>
<a href="#l52.19"></a><span id="l52.19">   skin/classic/messenger/contactStarred.png                   (mail/contactStarred.png)</span>
<a href="#l52.20"></a><span id="l52.20">   skin/classic/messenger/starContact.png                      (mail/starContact.png)</span>
<a href="#l52.21"></a><span id="l52.21">   skin/classic/messenger/activity/activity.css                   (mail/activity/activity.css)</span>
<a href="#l52.22"></a><span id="l52.22">   skin/classic/messenger/activity/buttons.png                    (mail/activity/buttons.png)</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineat">@@ -250,16 +253,19 @@ classic.jar:</span>
<a href="#l52.24"></a><span id="l52.24">   skin/classic/aero/messenger/folderPane.css                       (mail/folderPane.css)</span>
<a href="#l52.25"></a><span id="l52.25">   skin/classic/aero/messenger/subscribe.css                        (mail/subscribe.css)</span>
<a href="#l52.26"></a><span id="l52.26">   skin/classic/aero/messenger/virtualFolderListDialog.css          (mail/virtualFolderListDialog.css)</span>
<a href="#l52.27"></a><span id="l52.27">   skin/classic/aero/messenger/searchDialog.css                     (mail/searchDialog.css)</span>
<a href="#l52.28"></a><span id="l52.28">   skin/classic/aero/messenger/msgSelectOffline.css                 (mail/msgSelectOffline.css)</span>
<a href="#l52.29"></a><span id="l52.29">   skin/classic/aero/messenger/filterDialog.css                     (mail/filterDialog.css)</span>
<a href="#l52.30"></a><span id="l52.30">   skin/classic/aero/messenger/dialogs.css                          (mail/dialogs.css)</span>
<a href="#l52.31"></a><span id="l52.31">   skin/classic/aero/messenger/multimessageview.css                 (mail/multimessageview.css)</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineplus">+  skin/classic/aero/messenger/glodaFacetView.css                   (mail/glodaFacetView.css)</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineplus">+  skin/classic/aero/messenger/icons/exclude.png                    (mail/icons/exclude.png)</span>
<a href="#l52.34"></a><span id="l52.34" class="difflineplus">+  skin/classic/aero/messenger/icons/exclude-selected.png           (mail/icons/exclude-selected.png)</span>
<a href="#l52.35"></a><span id="l52.35">   skin/classic/aero/messenger/newmailalert.css                     (mail/newmailalert.css)</span>
<a href="#l52.36"></a><span id="l52.36">   skin/classic/aero/messenger/tabmail.css                          (mail/tabmail.css)</span>
<a href="#l52.37"></a><span id="l52.37">   skin/classic/aero/messenger/editContactOverlay.css               (mail/editContactOverlay.css)</span>
<a href="#l52.38"></a><span id="l52.38">   skin/classic/aero/messenger/starred48.png                        (mail/starred48.png)</span>
<a href="#l52.39"></a><span id="l52.39">   skin/classic/aero/messenger/contactStarred.png                   (mail/contactStarred.png)</span>
<a href="#l52.40"></a><span id="l52.40">   skin/classic/aero/messenger/starContact.png                      (mail/starContact.png)</span>
<a href="#l52.41"></a><span id="l52.41">   skin/classic/aero/messenger/activity/activity.css                   (mail/activity/activity.css)</span>
<a href="#l52.42"></a><span id="l52.42">   skin/classic/aero/messenger/activity/buttons.png                    (mail/activity/buttons.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1">new file mode 100644</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineminus">--- /dev/null</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineplus">+++ b/mail/themes/qute/mail/glodaFacetView.css</span>
<a href="#l53.4"></a><span id="l53.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l53.5"></a><span id="l53.5" class="difflineplus">+@import url(&quot;chrome://messenger/content/glodaFacetView.css&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1">new file mode 100644</span>
<a href="#l54.2"></a><span id="l54.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..7f017c0f1b2de983f61d1905973bbdfb379a58b6</span>
<a href="#l54.3"></a><span id="l54.3">GIT binary patch
literal 864
zc$@)X1E2hfP)&lt;h;3K|Lk000e1NJLTq000dD000dL1^@s6a_i)L00004XF*Lt007wQ
z^&amp;Awc0004~X+uL$Nkc;*P;zf(X&gt;4Tx0C)kdl08cUK@f)DJ4EpVEsO|?c!GsRln@&amp;w
zA|xq-C=x=zk3zWIok=8Kj&gt;{z~_ya^N)GlJ7c0v#ltZcMZf=E&gt;G7ic9S7z&gt;qi_7;ht
zVB^B&gt;KKt&amp;&gt;?9R&gt;t;;C#HDG|WDZkdr#K$@JImTK-$3no&amp;Nm5kvJhsXHpx3PQ+f$61Q
z7Hj`&lt;xiB{zy;1i*d}8;}%x@mwv&lt;8z71Oyjpt~lo&amp;#xc%Aj2A4!BAYN{B_XTC)ZsRx
zks$FpabukG4&amp;xZ-L&amp;iBJ&amp;U{aaJ-V9IiJyoER4t&lt;bB0I}c43licZQ^d0Kh4zUqJVD)
zs47&gt;qbOTVh20Hx}ts@Jxo&amp;yK&gt;747-Lc@sg;XJ-4oPB@{x8K}Rt?T1~UX%l!qv+dUx
z+kU$Ns*iz&lt;H6?5299z1iPz3&amp;3^W1oJUISuQ3#T4Gndk4=dw~2ZFmVNpZviWhKvw{0
zsRKeKVDtn+QTXcotsK9$pqxs^Oxe;@iG7z~I+ZpvhOB7L_Wuo*wn#Mrf@x#POvV$I
z&lt;fq@Ixup?Z&gt;2ph7k7p2{_g#BNu*`2c00009a7bBm000XU000XU0RWnu7ytkPPDw;T
zR45glQL#z`K@fd=IW7bgNxXoNN&gt;EO;5w)@sY*Jm}H&amp;}_^U}2LV5bJ&lt;npdh3XtZXzQ
zi2gx9Q0@@K&lt;c{2}Z}zeXvXuk7J3DXQykQ1#*bwa%IS$B#lm%XZAV&gt;QIm&gt;x5&gt;FpGZz
z{#k(c(+wcExrX$&gt;Bp&lt;CC4ZTfZq@f0qprE^aItpqyMY6vGun6E)SJ)E*D_o3`u5KYY
ztRp$nz_Z|jc?f&amp;riy5Uyw7yyOEkL&gt;^ZAhybnwJE-Bo6pSR9~7PS=&lt;H2Mu~(*33cTn
zOpqQ3COLJ4&gt;!M^x;)wlK5Q0&gt;$(BIn^m(rBfF&lt;XjkOO{YgRmYN(;p0{EXG&amp;h5{&lt;4dZ
zp&gt;-}8Q~Oqxd4P=EL-UrOO@2pwuS?Vlg(Bv^!(lv?NcZf&gt;4M~W1KqKICYt?e+Bu4ux
qxZIq}wJKHEao=M;lH-8&gt;ANm0?s(TyzcK&gt;Gp0000&lt;MNUMnLSTaUB6tG;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1">new file mode 100644</span>
<a href="#l55.2"></a><span id="l55.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..47295b6dc66ca6562922cfb22a3a224cab578ae8</span>
<a href="#l55.3"></a><span id="l55.3">GIT binary patch
literal 851
zc$@)K1FZasP)&lt;h;3K|Lk000e1NJLTq000dD000dL1^@s6a_i)L00004XF*Lt007wQ
z^&amp;Awc0004~X+uL$Nkc;*P;zf(X&gt;4Tx0C)kdl08cUK@f)DJ4EpVEsO|?c!GsRln@&amp;w
zA|xq-C=x=zk3zWIok=8Kj&gt;{z~_ya^N)GlJ7c0v#ltZcMZf=E&gt;G7ic9S7z&gt;qi_7;ht
zVB^B&gt;KKt&amp;&gt;?9R&gt;t;;C#HDG|WDZkdr#K$@JImTK-$3no&amp;Nm5kvJhsXHpx3PQ+f$61Q
z7Hj`&lt;xiB{zy;1i*d}8;}%x@mwv&lt;8z71Oyjpt~lo&amp;#xc%Aj2A4!BAYN{B_XTC)ZsRx
zks$FpabukG4&amp;xZ-L&amp;iBJ&amp;U{aaJ-V9IiJyoER4t&lt;bB0I}c43licZQ^d0Kh4zUqJVD)
zs47&gt;qbOTVh20Hx}ts@Jxo&amp;yK&gt;747-Lc@sg;XJ-4oPB@{x8K}Rt?T1~UX%l!qv+dUx
z+kU$Ns*iz&lt;H6?5299z1iPz3&amp;3^W1oJUISuQ3#T4Gndk4=dw~2ZFmVNpZviWhKvw{0
zsRKeKVDtn+QTXcotsK9$pqxs^Oxe;@iG7z~I+ZpvhOB7L_Wuo*wn#Mrf@x#POvV$I
z&lt;fq@Ixup?Z&gt;2ph7k7p2{_g#BNu*`2c00009a7bBm000XU000XU0RWnu7ytkPK}keG
zR45glQ9EkGKoHd@NEiY}wbcY13&gt;JvMULcUhm5ZFfg{$B*xNwsT7}tiJAb~)dKrSE%
z3QFrnZY2T%BMG6rxAw{qZ{&gt;lvGdu6i&amp;g`yXXe&lt;bVKB1vx%2WhIj&amp;0j&gt;&gt;}O5WbeT6z
z^9OEO*YzSvl9D-^ED}O=%d&amp;jOUI1H&amp;-$&lt;f(1lI#1$8qkWDB&gt;Z8#igpMM&gt;qlTQ=aG7
zaU4%^`U7%b&lt;YD5VksDcrXaZ~?oTh2I&lt;EWNpJtN0X?79IazVCP7_nk0C2YBJ!{|nIh
zo*Xrv=MCE;1~gp(JMY=!dchEPAu)y@z{`=?L5+$$xm}iJ-_)x+tr1@VCk6P1)qz{9
zuI-Z-Me%{tZXnnKuZU~hV~n^5|LMB!t$OnIbNMp3sQg?AF9F&amp;wu*9ef)kS7?OBjX&amp;
dLdTt*`vW)2lp+i~m5=}c002ovPDHLkV1i!NbT|M2</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1">new file mode 100644</span>
<a href="#l56.2"></a><span id="l56.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..25db669da4759032c8bb2a105dea69683384d18b</span>
<a href="#l56.3"></a><span id="l56.3">GIT binary patch
literal 4071
zc$@*}4;b)?P)&lt;h;3K|Lk000e1NJLTq00BGz000CC1^@s66I+9F000k1X+uL$Nkc;*
zP;zf(X&gt;4Tx0C)kdSa~&gt;&lt;UH?D#%$UiNB@9`|5)mcY*DNDt-y_+^*bU9tLzYtZC0b&lt;3
zR!EVQM1&gt;?NYg!~xNh;J6*|NN6sOPzU@9%oA_n-G%*WCB#e9m{f&amp;-dK-Io|&lt;*L%=mK
z&amp;&lt;_Ow@TUY(E%)gX4%#~qaD#vmAb&lt;z#0b;HsTA+@(xiJ*^4{h!Rl!fh?EZx@Nha7ST
zw(6#6+*3+q|Md8OQ2Il&amp;QlUct5E)2td2ZmnbnLc)t?4*4C@=`hc+oM*%hes?NQh;q
z)|Pq@mqX0zxq)xfvD*gjpyLpdCtddy0N5=QcW(*+xJih$+{rW&amp;9H#qqcc+p3A&lt;h5*
zrRDD*0PVB)LVi0bkP3C#7a$g=&amp;kMZ6&lt;^p}IvH-x)^bZ$61)#&lt;m0D;7RIEe`W@YRqX
z`G=daT%Rih-$V1*BfoAAVbO)Q-mb09NWj&gt;#09eUfTl-bKwzg6N0QwC8&amp;3&gt;d{YRI}Q
zd=R7yfdAItc;??4XqX&amp;&amp;f`x!Lc#SwC%cx%T5CZ}GY|}Gl4OR?$A*V1mg{Nq1A%B#h
zw$LbnCbA|LDgH|$SaMv-M!Ho-N;YHXqMY0AXL}44T9lNP3shFrY}GGmeAiOc4%u6;
zv!th~A5UyESTGdbZ*;)N=!9{eNsVcn*`WD%OJ*x6YfGC*+bX*udnO0PL-vle!!b@L
zoMT*Qu32tPq_1Q_4{Og;Uaj6szPtR~{L?9w0jC2!kLXi((D;Hlf;mEXLWRS&amp;hwq9|
zII0n;7qu_i;FxZVO00Aoe&gt;_Y4^6}{t?-O2}e0-`Q@lsMoa(Iess!^Is`t}U|O!h2&gt;
ztl85e*&amp;R7mXVTC5pEEkYBbO!j`-PWz_wox0LJEy83SFEoYAjADu`CrXoi1y&gt;lyy0%
z{7?n4a`zR%DqPj{)xK+2sv~QN*Ez3$t9^5$yRPNtom&lt;uQWw&amp;!1lJ6XCbZ^qW%W${h
z9__xu{pIE-EhVin4_w-G9*VZ3+dn*N?&lt;jd3*=g}a?8%R(O&lt;f7yrakzcx4mV3p8b;j
zpPrQrI6dck{`^JuOY2uWuZ9OpUXzAIhTgu(88&amp;%~dD}P=G%7dx?OpAA+6Va$-^MO|
zbQotDzw^m!0zc9AIrxj@m*KB@lh#w{sod#p(?#ESza@NI{GRuh+YjOl%S`$#$85?^
zrk^=;(sM87D;BOTt}eT*t-&lt;{B0CR8|*@{%5ywUcUXoewNB4ZTuZB~Bv0#1Hzf1aeR
z$N2RG28GmxGYKC=HN?(~FH6`&lt;Hc3fHr|y`Mb=cV=w{7=v`B4Qe#Z09SDhjG$YK`i%
znlf64w3Fc~c&amp;mreClL1&lt;*zWT&amp;jM$%WAl&gt;MkaiK}6X}MX2`4x*=%ZFCO)&lt;0~qcDx6-
z+wXDEI&lt;(Kx?69qqlQYSM;u_)&gt;OUiIBBv*Sp@a*&lt;_&lt;Xz`e=$q&amp;l&lt;nKl?56}vfJt9P9
zr=e-{LDRwGAtRx$!(N5Ij2JlD71&lt;b-A02VbAx1M+ERH#DHh$#z(-RE|Whc{5MI?GA
znI$Wy2&amp;Al~j;1xI7i1)5QnGAMt7i-6fSi#tch8&lt;XcjUZbu2AmGg@&lt;`L`5py|g{Z=w
zi-ko;ifu|XOShG=md#xnzWkuPydtGC@QQVn%2ocW%h%pk-&gt;)gY9#`vrgIFh4w{-K#
zt@HJMx3wEM8$RD@Y0PhmxNCn;?Y&gt;Ymy7_ZUSL^Ku1#PDu(%Ky!sdlh+e0W^ndHPAf
zQ&lt;E;4?#&lt;oPJ-xlveX0GP&amp;$I@%42(Umei8ao{pIqj*1@Z&lt;bB9j8IWlbbR(*tTWOlUY
zT?t$X+GC7k{U6Va+kX=HG(3_2+3}0Wm)Wn6C$pyPrun8{e#`!D_80E2wjZ%GI&lt;uJB
z{-2d|&gt;GKH-Ig5{fnXdS+=bshG0TQ?j77-Hi26Y1Mgb8El!=*C%F{`mmvnH``=J4Cn
z$hpETg*WE$&lt;vqGJjxT{fRp5+ZvCviF2Eqf8C!#%Ked3+lnj|VEbGAoHxk?jvNXu}@
z{F42&amp;b70p!xx(Gy@)mnU_e?9)D;`raP-a#hP$^WUs1emgG*B8JH9NE_wNLJK(UH@c
z*S)QGRNs=QY#_96)4mzQk^N5(+%~#soM7T&lt;s&amp;D$)EY*CE`8$g&lt;mgZJmRzudMHWXWB
zJ7D+pV6MG~gPg&lt;Mp*xO84{IJ?b!u@w;bQE{={o3^PjYe&gt;a33U}@v!vV;yK`T*88vz
z!Dqxb&amp;(F@E&amp;A*)z9iSZWBe3Sk5vme(fp#k&gt;FjzeJWk^D(eCTl4sc?nx_Yqk~iILdI
zo~R4aKF8E!m}3TGOX57@MdDu`Pds6tAa`=}$;ngQiPw{|lfzQ%QWewK(q5&amp;fW{79p
z&amp;2-AbW!0Vb$rjIkmvixq^I74uW9O&gt;Q({hz_7cVsAh2|^f&amp;lc1b247UYxLWkEIJv~4
z6kj@2R&amp;&gt;exvQjy={B=cbW!e&gt;=D*dZMSLd%itFEcZxE==AmtCFNO~YGS^}BBq8kics
z-x+AU)s%NP=AP$$%VwPxl~#oZ3T;XcRom4bsdUIcmgwZ_TzWFvCEH!mYuL{^u=xdP
z5dX$&amp;^wh`p$xri9^!#t^ee^v6s|3K=&amp;j1`U2f+FQ0BN=WNR|S??E--LX2_`ml;d`Q
z64?h3q7eAAfA9enU&lt;vn-V;~chfI83yo`Lt^J6J_n5Pn1k(LhWQ7bFNdg%lul$Wvq-
zg+d9Vv{25dI8-^R2ep6}MVp}`(O1wzn9Ud+ObDh5GsYmqV9$`v(1&amp;HinqZT$oj69^
z0bB~MZ`0OIq)pYERvFD0OBffKESRn^Gcda{-(%rtiC`JtY_PeOmB4zMjgc*mZH+yO
zeT5@&gt;3)m9NiRO&amp;uLbzhM0e2jp0iVLd%TvLt%lm$75}zjDbAE6BWq~w75y2ZmhC)Na
zfdm|(NJLX)STsh=R9s~n-?mwaM{s33Nl8deOV{r&gt;A!8#eE&lt;3lgYgdI_^6nscw&gt;?%0
z28!xRJC(&amp;%_*Hq;_|!!;WHr^b_G?@3b&lt;*+FrRYWJ=Mb+Oyf6g&amp;cOM|b?_a0Ml9`k_
z*`nGCSUcD&gt;*-0GCuwOdl;@IxQ?d;@I&lt;~m7Iaz9BP@ig-4@Nx7V@Rxz&gt;wD*Vrl|pL{
z#)kxjz6d8q3`I6XC&amp;v(Dr{fb&amp;;1h~Z$t5-?Tc&gt;&lt;Xi_h4RIdZx%$M3AxdG6frc|8R!
z7wd}~OCMb7Detd*R@Hf}t!AKh&gt;LyRUUPDOZ#k(!{2U`}}B-_0@nx2StrSvTII}hA&gt;
zF*oS^Ms1||!&gt;w_j3G***Q;+|m&amp;fc7NT%`TtSaw~JU0GO7TEnizuYW&amp;8fi5@&lt;LO?3a
zem&amp;&gt;}!(bW#2nQmHC?G_{4)I1Jk#wXKX+V0B&amp;nPs^y(Y&gt;D=Dq^;5{*TxpncH==za_i
zqk##6ng94Z^Zi(MtQj@~+mFNJ9C0PMubY%M#c%3k6k!Zz&gt;|_#Uie?&amp;O)?hARL9zI-
z3~b&amp;D^Df4k%f`u;!OqT}&amp;B4b}yk#f+YMF43as_i^xHIs=`0G4Go*~}gt(;qH`E2-&gt;
z_=^Pg3;Yx;6fzN76245Z5n&amp;LyAxaVx75gFHzO6taRMKp_loVF#gLLzbLYZh;r=6O+
zgm$gTjqJWJU%cm(LbzhIQi}3fm15NjwHxY98V@wPv|ej}-Mga8swb^aBzhTS&gt;}xXo
zc7WYT)7aDGoN1Rilf{0^OsioVIokxgF?&amp;OYYmR(}Q=L{^yj^dS7~HMNmpzufY`yDz
zx&amp;1=@hXeEjuTzC-nZf9gh|urhz7aE#&gt;Cy7Xx?}y~8IPAFsGfY9=#(^-5|M^WKc6X*
zRhO-s(|y+KykPEdUSWa7MTVmK5}z`@OI_s&amp;mBcFct7Fxz*K2QFy?MXBy@A&gt;&amp;(KK`~
zznRpk+_v@M&gt;Z94mi%*%m#d}Trj}Fwlm&gt;QHBQX3|YguJUAV;Fawc=%O(D*9Xh56mpj
z9MgQ?V!+bKGJXZSGQ66&lt;X1bn#Rp1Y@;d|c;zQDZW;Tx}qI3l6QY2-T6kNiXlpbStn
zR0--8njL)rorvzjaATY&gt;6_}q4dJLx-K4R6dS=cF@5v~Tl+b1_IG6pbyW+F4aXLey8
zVR2#kv^k8Gm9&gt;h^f^CKUDu?S9?k%01;an12ecaJ_S^RsR0$%b~RXzc}PyCk!JOw2M
zCxosD2M|&lt;6a3XI+Z;O4}#x0&gt;BX}H}&amp;&gt;Y%jK4j-8?*|?pVyDrPM@1EMjt3XtwDHSMp
zsRA`E^&gt;~eLEkSLsy|wV%YN&amp;t7fN5W-;lu$4qemukrrG9*MVu9zb)~J&lt;L6m*%A*aJ=
zr#R;&amp;SBl#^_e112o-}V^pO1dN{-XgFf%m8~wA^5(koYhpJmsiIRN1lS*n9D%C!$VT
zBuXYNrQA&lt;T&amp;T!4r$(BBYKL^f#xzLkeQ&lt;zf}RpM7&gt;e_6MJP&amp;r@Kb}gmGx&gt;o$g{LPN~
zvkk6|f=#{m!kYzJS|0&gt;HlxUymsOwC6&gt;fWu^%hmVk*{$c{FL%8feVzVBefaZ8;k!d0
z#K#uL-%pHu(fb-XSv1u!-TLkR_wv7zf7s0M&amp;UDX){1pCKJ*PU?HoteidO&gt;(0ZDD5d
zz+&amp;;@;*$AN&gt;C)IQ@n7U$WxvLkC6+ywGnel!PpojRXs`IJ&lt;gB!;Os?{-8m=B&amp;y|p^I
zCbs6VmbunJ&amp;;LffMBhIElU{&amp;d0F_{@r@!9)-(CFuf?-Xz-nPIi3&amp;qXU4BqK@A~49D
zUJK&amp;kZ;2LSMTB&gt;DSPrp!cpL2hjS23q`bH27Kwd7wOV1QySf?Sz9#jKMh@l&lt;ippWYT
zxbFd0h&lt;(Tu8&gt;`=ZSfJl}jZ2qF3JlVv%kx5&lt;N2U?~$kau6S=;^AZKnoX+CVH0Wd?i$
zjOg-oUkmPJ{ok&gt;nFcd#iW5~mpQC!|Z`|0s&gt;K`adnfGeN^Pe2B;z!&gt;NO{ohvt&lt;O#4J
z07uDy2Ia=q&lt;^D+7uJ^tFO-mMdtlJA&amp;*YO48P{-fdJB|u%ZCHN{PkvM=L;1tVU6K1N
zxBREK?$K}E&gt;mLmx*!#cChNX?@Hb%UGJCypvlm2MXJ^R;sgq#ZqSF`oPNMPhKiWpst
zCPoXR3J4fHh7ZVM6fi3A44{oshhwVUll7B-$FeauZht?c5sZTjg4bt+@;Cecyuy&lt;S
z*r?s%ECVcD8+r8q3qUIeO!dFDAaWS2&gt;jBUU2n?rsdwK;Cbl^W1WEsMK3TdYdL0(Qy
z75odGopoo?8)?@7000SaNLh0L01FcU01FcV0GgZ_0000+Nkl&lt;ZSPAXaK@9*g3&lt;I#+
zF(`kIrLX}AgUEg67gx&amp;J-TOHL1PGJ~%uF=;BM}fFK%i8&gt;;FUgBEdm5mz~H5cgaCn3
Zfd?jx1O&amp;#g3O)b;002ovPDHLkV1f*Z^49&lt;W</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mail/themes/qute/mail/searchBox.css</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mail/themes/qute/mail/searchBox.css</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -34,25 +34,20 @@</span>
<a href="#l57.4"></a><span id="l57.4"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l57.5"></a><span id="l57.5"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l57.6"></a><span id="l57.6"> #</span>
<a href="#l57.7"></a><span id="l57.7"> # ***** END LICENSE BLOCK *****</span>
<a href="#l57.8"></a><span id="l57.8"> */</span>
<a href="#l57.9"></a><span id="l57.9"> </span>
<a href="#l57.10"></a><span id="l57.10"> /* ..... tree adjustments ..... */</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-.quick-search-textbox</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineminus">-{</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineplus">+.quick-search-textbox {</span>
<a href="#l57.15"></a><span id="l57.15">   padding-top: 1px;</span>
<a href="#l57.16"></a><span id="l57.16"> }</span>
<a href="#l57.17"></a><span id="l57.17"> </span>
<a href="#l57.18"></a><span id="l57.18" class="difflineminus">-#searchInput[searchCriteria=&quot;true&quot;]  {</span>
<a href="#l57.19"></a><span id="l57.19" class="difflineminus">-  color: grey;</span>
<a href="#l57.20"></a><span id="l57.20" class="difflineminus">-}</span>
<a href="#l57.21"></a><span id="l57.21" class="difflineminus">-</span>
<a href="#l57.22"></a><span id="l57.22"> #quick-search-button  {</span>
<a href="#l57.23"></a><span id="l57.23">   margin-top: 0px;</span>
<a href="#l57.24"></a><span id="l57.24">   margin-bottom: 0px;</span>
<a href="#l57.25"></a><span id="l57.25">   -moz-margin-start: 0px;</span>
<a href="#l57.26"></a><span id="l57.26">   -moz-margin-end: 2px;</span>
<a href="#l57.27"></a><span id="l57.27"> }</span>
<a href="#l57.28"></a><span id="l57.28"> </span>
<a href="#l57.29"></a><span id="l57.29"> .quick-search-button-image {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -894,16 +894,19 @@ DBViewWrapper.prototype = {</span>
<a href="#l58.4"></a><span id="l58.4">   get searching() {</span>
<a href="#l58.5"></a><span id="l58.5">     return this._searching;</span>
<a href="#l58.6"></a><span id="l58.6">   },</span>
<a href="#l58.7"></a><span id="l58.7">   set searching(aSearching) {</span>
<a href="#l58.8"></a><span id="l58.8">     if (aSearching == this._searching)</span>
<a href="#l58.9"></a><span id="l58.9">       return;</span>
<a href="#l58.10"></a><span id="l58.10">     this._searching = aSearching;</span>
<a href="#l58.11"></a><span id="l58.11">     this.listener.onSearching(aSearching);</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineplus">+    // notify that all messages are loaded if searching has concluded</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+    if (!aSearching)</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineplus">+      this.listener.onAllMessagesLoaded();</span>
<a href="#l58.15"></a><span id="l58.15">   },</span>
<a href="#l58.16"></a><span id="l58.16"> </span>
<a href="#l58.17"></a><span id="l58.17">    /**</span>
<a href="#l58.18"></a><span id="l58.18">    * Do we want to show the messages immediately, or should we wait for</span>
<a href="#l58.19"></a><span id="l58.19">    *  updateFolder to complete?  The historical heuristic is:</span>
<a href="#l58.20"></a><span id="l58.20">    * - Virtual folders get shown immediately (and updateFolder has no</span>
<a href="#l58.21"></a><span id="l58.21">    *   meaning for them anyways.)</span>
<a href="#l58.22"></a><span id="l58.22">    * - A folder for which &quot;manyHeadersToDownload&quot; is true waits on</span>
<a href="#l58.23"></a><span id="l58.23" class="difflineat">@@ -1815,17 +1818,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l58.24"></a><span id="l58.24">     this._mailViewData = aData;</span>
<a href="#l58.25"></a><span id="l58.25"> </span>
<a href="#l58.26"></a><span id="l58.26">     // - update the search terms</span>
<a href="#l58.27"></a><span id="l58.27">     // (this triggers a view update if we are not in a batch)</span>
<a href="#l58.28"></a><span id="l58.28">     this.search.viewTerms = mailViewDef.makeTerms(this.search.session,</span>
<a href="#l58.29"></a><span id="l58.29">                                                   aData);</span>
<a href="#l58.30"></a><span id="l58.30"> </span>
<a href="#l58.31"></a><span id="l58.31">     // - persist the view to the folder.</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineminus">-    if (!aDoNotPersist) {</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineplus">+    if (!aDoNotPersist &amp;&amp; this.displayedFolder) {</span>
<a href="#l58.34"></a><span id="l58.34">       let msgDatabase = this.displayedFolder.msgDatabase;</span>
<a href="#l58.35"></a><span id="l58.35">       if (msgDatabase) {</span>
<a href="#l58.36"></a><span id="l58.36">         let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l58.37"></a><span id="l58.37">         dbFolderInfo.setUint32Property(MailViewConstants.kViewCurrent,</span>
<a href="#l58.38"></a><span id="l58.38">                                        this._mailViewIndex);</span>
<a href="#l58.39"></a><span id="l58.39">         // _mailViewData attempts to be sane and be the tag name, as opposed to</span>
<a href="#l58.40"></a><span id="l58.40">         //  magic-value &quot;:&quot;-prefixed value historically stored on disk.  Because</span>
<a href="#l58.41"></a><span id="l58.41">         //  we want to be forwards and backwards compatible, we put this back on</span>
<a href="#l58.42"></a><span id="l58.42" class="difflineat">@@ -1896,16 +1899,18 @@ DBViewWrapper.prototype = {</span>
<a href="#l58.43"></a><span id="l58.43">    * @param aMessageId The message-id of the message you want.</span>
<a href="#l58.44"></a><span id="l58.44">    * @return The first nsIMsgDBHdr found in any of the underlying folders with</span>
<a href="#l58.45"></a><span id="l58.45">    *     the given message header, null if none are found.  The fact that we</span>
<a href="#l58.46"></a><span id="l58.46">    *     return something does not guarantee that it is actually visible in the</span>
<a href="#l58.47"></a><span id="l58.47">    *     view.  (The search may be filtering it out.)</span>
<a href="#l58.48"></a><span id="l58.48">    */</span>
<a href="#l58.49"></a><span id="l58.49">   getMsgHdrForMessageID: function DBViewWrapper_getMsgHdrForMessageID(</span>
<a href="#l58.50"></a><span id="l58.50">       aMessageId) {</span>
<a href="#l58.51"></a><span id="l58.51" class="difflineplus">+    if (this._syntheticView)</span>
<a href="#l58.52"></a><span id="l58.52" class="difflineplus">+      return this._syntheticView.getMsgHdrForMessageID(aMessageId);</span>
<a href="#l58.53"></a><span id="l58.53">     if (!this._underlyingFolders)</span>
<a href="#l58.54"></a><span id="l58.54">       return null;</span>
<a href="#l58.55"></a><span id="l58.55">     for (let [, folder] in Iterator(this._underlyingFolders)) {</span>
<a href="#l58.56"></a><span id="l58.56">       let msgHdr = folder.msgDatabase.getMsgHdrForMessageID(aMessageId);</span>
<a href="#l58.57"></a><span id="l58.57">       if (msgHdr)</span>
<a href="#l58.58"></a><span id="l58.58">         return msgHdr;</span>
<a href="#l58.59"></a><span id="l58.59">     }</span>
<a href="#l58.60"></a><span id="l58.60">     return null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/base/src/quickSearchManager.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/base/src/quickSearchManager.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -48,45 +48,92 @@</span>
<a href="#l59.4"></a><span id="l59.4"> </span>
<a href="#l59.5"></a><span id="l59.5"> EXPORTED_SYMBOLS = ['QuickSearchManager', 'QuickSearchConstants'];</span>
<a href="#l59.6"></a><span id="l59.6"> </span>
<a href="#l59.7"></a><span id="l59.7"> const Cc = Components.classes;</span>
<a href="#l59.8"></a><span id="l59.8"> const Ci = Components.interfaces;</span>
<a href="#l59.9"></a><span id="l59.9"> const Cr = Components.results;</span>
<a href="#l59.10"></a><span id="l59.10"> const Cu = Components.utils;</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineplus">+Cu.import(&quot;resource://app/modules/errUtils.js&quot;);</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+try {</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineplus">+  Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineplus">+} catch (e) {</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineplus">+  logException(e);</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineplus">+}</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineplus">+</span>
<a href="#l59.20"></a><span id="l59.20"> const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l59.21"></a><span id="l59.21"> const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l59.22"></a><span id="l59.22"> const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l59.23"></a><span id="l59.23"> </span>
<a href="#l59.24"></a><span id="l59.24"> /**</span>
<a href="#l59.25"></a><span id="l59.25">  * Constants originally found in searchBar.js bundled together into a single</span>
<a href="#l59.26"></a><span id="l59.26">  *  name-space contribution.</span>
<a href="#l59.27"></a><span id="l59.27">  *</span>
<a href="#l59.28"></a><span id="l59.28">  * These constants are used by quick-search-menupopup.  The state of</span>
<a href="#l59.29"></a><span id="l59.29">  *  quick-search-menupopup is persisted to localstore.rdf, so new values need</span>
<a href="#l59.30"></a><span id="l59.30">  *  new constants.</span>
<a href="#l59.31"></a><span id="l59.31">  */</span>
<a href="#l59.32"></a><span id="l59.32"> var QuickSearchConstants = {</span>
<a href="#l59.33"></a><span id="l59.33">   kQuickSearchSubject: 0,</span>
<a href="#l59.34"></a><span id="l59.34">   kQuickSearchFrom: 1,</span>
<a href="#l59.35"></a><span id="l59.35">   kQuickSearchFromOrSubject: 2,</span>
<a href="#l59.36"></a><span id="l59.36" class="difflineminus">-  kQuickSearchBody: 3,</span>
<a href="#l59.37"></a><span id="l59.37" class="difflineminus">-  // there used to be a kQuickSearchHighlight = 4, apparently removed</span>
<a href="#l59.38"></a><span id="l59.38" class="difflineminus">-  kQuickSearchRecipient: 5,</span>
<a href="#l59.39"></a><span id="l59.39" class="difflineminus">-  kQuickSearchRecipientOrSubject: 6,</span>
<a href="#l59.40"></a><span id="l59.40" class="difflineplus">+  kQuickSearchRecipient: 3,</span>
<a href="#l59.41"></a><span id="l59.41" class="difflineplus">+  kQuickSearchRecipientOrSubject: 4,</span>
<a href="#l59.42"></a><span id="l59.42" class="difflineplus">+  kQuickSearchBody: 5</span>
<a href="#l59.43"></a><span id="l59.43"> };</span>
<a href="#l59.44"></a><span id="l59.44" class="difflineplus">+const kQuickSearchCount = 6;</span>
<a href="#l59.45"></a><span id="l59.45" class="difflineplus">+</span>
<a href="#l59.46"></a><span id="l59.46" class="difflineplus">+var QuickSearchLabels = null; // populated dynamically from properties files</span>
<a href="#l59.47"></a><span id="l59.47"> </span>
<a href="#l59.48"></a><span id="l59.48"> /**</span>
<a href="#l59.49"></a><span id="l59.49">  * All quick search logic that takes us from a search string (and search mode)</span>
<a href="#l59.50"></a><span id="l59.50">  *  to a set of search terms goes in here.  Check out FolderDisplayWidget for</span>
<a href="#l59.51"></a><span id="l59.51">  *  display concerns involving views, or DBViewWrapper and SearchSpec for the</span>
<a href="#l59.52"></a><span id="l59.52">  *  actual nsIMsgDBView-related logic.</span>
<a href="#l59.53"></a><span id="l59.53">  */</span>
<a href="#l59.54"></a><span id="l59.54"> var QuickSearchManager = {</span>
<a href="#l59.55"></a><span id="l59.55" class="difflineplus">+</span>
<a href="#l59.56"></a><span id="l59.56" class="difflineplus">+  _modeLabels: {},</span>
<a href="#l59.57"></a><span id="l59.57" class="difflineplus">+</span>
<a href="#l59.58"></a><span id="l59.58" class="difflineplus">+  /**</span>
<a href="#l59.59"></a><span id="l59.59" class="difflineplus">+   * Populate an associative array containing the labels from a properties file</span>
<a href="#l59.60"></a><span id="l59.60" class="difflineplus">+   */</span>
<a href="#l59.61"></a><span id="l59.61" class="difflineplus">+  loadLabels: function QuickSearchManager_loadLabels() {</span>
<a href="#l59.62"></a><span id="l59.62" class="difflineplus">+    const quickSearchStrings =</span>
<a href="#l59.63"></a><span id="l59.63" class="difflineplus">+      new StringBundle(&quot;chrome://messenger/locale/quickSearch.properties&quot;);</span>
<a href="#l59.64"></a><span id="l59.64" class="difflineplus">+    this._modeLabels[QuickSearchConstants.kQuickSearchSubject] =</span>
<a href="#l59.65"></a><span id="l59.65" class="difflineplus">+      quickSearchStrings.get(&quot;searchSubject.label&quot;);</span>
<a href="#l59.66"></a><span id="l59.66" class="difflineplus">+    this._modeLabels[QuickSearchConstants.kQuickSearchFrom] =</span>
<a href="#l59.67"></a><span id="l59.67" class="difflineplus">+      quickSearchStrings.get(&quot;searchFrom.label&quot;);</span>
<a href="#l59.68"></a><span id="l59.68" class="difflineplus">+    this._modeLabels[QuickSearchConstants.kQuickSearchFromOrSubject] =</span>
<a href="#l59.69"></a><span id="l59.69" class="difflineplus">+      quickSearchStrings.get(&quot;searchFromOrSubject.label&quot;);</span>
<a href="#l59.70"></a><span id="l59.70" class="difflineplus">+    this._modeLabels[QuickSearchConstants.kQuickSearchRecipient] =</span>
<a href="#l59.71"></a><span id="l59.71" class="difflineplus">+      quickSearchStrings.get(&quot;searchRecipient.label&quot;);</span>
<a href="#l59.72"></a><span id="l59.72" class="difflineplus">+    this._modeLabels[QuickSearchConstants.kQuickSearchRecipientOrSubject] =</span>
<a href="#l59.73"></a><span id="l59.73" class="difflineplus">+      quickSearchStrings.get(&quot;searchRecipientOrSubject.label&quot;);</span>
<a href="#l59.74"></a><span id="l59.74" class="difflineplus">+    this._modeLabels[QuickSearchConstants.kQuickSearchBody] =</span>
<a href="#l59.75"></a><span id="l59.75" class="difflineplus">+      quickSearchStrings.get(&quot;searchBody.label&quot;);</span>
<a href="#l59.76"></a><span id="l59.76" class="difflineplus">+  },</span>
<a href="#l59.77"></a><span id="l59.77" class="difflineplus">+</span>
<a href="#l59.78"></a><span id="l59.78" class="difflineplus">+  /**</span>
<a href="#l59.79"></a><span id="l59.79" class="difflineplus">+   * Create the structure that the UI needs to fully describe a quick search</span>
<a href="#l59.80"></a><span id="l59.80" class="difflineplus">+   * mode.</span>
<a href="#l59.81"></a><span id="l59.81" class="difflineplus">+   *</span>
<a href="#l59.82"></a><span id="l59.82" class="difflineplus">+   * @return a list of array objects mapping 'value' to the constant specified</span>
<a href="#l59.83"></a><span id="l59.83" class="difflineplus">+   * in QuickSearchConstants, and 'label' to a localized string.</span>
<a href="#l59.84"></a><span id="l59.84" class="difflineplus">+   */</span>
<a href="#l59.85"></a><span id="l59.85" class="difflineplus">+  getSearchModes: function QuickSearchManager_getSearchModes() {</span>
<a href="#l59.86"></a><span id="l59.86" class="difflineplus">+    let modes = [];</span>
<a href="#l59.87"></a><span id="l59.87" class="difflineplus">+    for (let i = 0; i &lt; kQuickSearchCount; i++)</span>
<a href="#l59.88"></a><span id="l59.88" class="difflineplus">+      modes.push({'value': i, 'label': this._modeLabels[i]});</span>
<a href="#l59.89"></a><span id="l59.89" class="difflineplus">+    return modes;</span>
<a href="#l59.90"></a><span id="l59.90" class="difflineplus">+  },</span>
<a href="#l59.91"></a><span id="l59.91" class="difflineplus">+</span>
<a href="#l59.92"></a><span id="l59.92">   /**</span>
<a href="#l59.93"></a><span id="l59.93">    * Create the search terms for the given quick-search configuration.  This is</span>
<a href="#l59.94"></a><span id="l59.94">    *  intended to basically be directly used in the service of the UI without</span>
<a href="#l59.95"></a><span id="l59.95">    *  pre-processing.  If you want to add extra logic, probably add it in here</span>
<a href="#l59.96"></a><span id="l59.96">    *  (with appropriate refactoring.)</span>
<a href="#l59.97"></a><span id="l59.97">    * Callers should strongly consider using DBViewWrapper's search attribute</span>
<a href="#l59.98"></a><span id="l59.98">    *  (which is a SearchSpec)'s quickSearch method which in turn calls us.  The</span>
<a href="#l59.99"></a><span id="l59.99">    *  DBViewWrapper may in turn be embedded in a FolderDisplayWidget.  So an</span>
<a href="#l59.100"></a><span id="l59.100" class="difflineat">@@ -178,9 +225,11 @@ var QuickSearchManager = {</span>
<a href="#l59.101"></a><span id="l59.101">         term.op = nsMsgSearchOp.Contains;</span>
<a href="#l59.102"></a><span id="l59.102">         term.booleanAnd = false;</span>
<a href="#l59.103"></a><span id="l59.103">         searchTerms.push(term);</span>
<a href="#l59.104"></a><span id="l59.104">       }</span>
<a href="#l59.105"></a><span id="l59.105">     }</span>
<a href="#l59.106"></a><span id="l59.106"> </span>
<a href="#l59.107"></a><span id="l59.107">     return searchTerms.length ? searchTerms : null;</span>
<a href="#l59.108"></a><span id="l59.108">   }</span>
<a href="#l59.109"></a><span id="l59.109" class="difflineminus">-};</span>
<a href="#l59.110"></a><span id="l59.110">\ No newline at end of file</span>
<a href="#l59.111"></a><span id="l59.111" class="difflineplus">+};</span>
<a href="#l59.112"></a><span id="l59.112" class="difflineplus">+</span>
<a href="#l59.113"></a><span id="l59.113" class="difflineplus">+QuickSearchManager.loadLabels();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/base/util/Makefile.in</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/base/util/Makefile.in</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -130,16 +130,17 @@ EXPORTS		= \</span>
<a href="#l60.4"></a><span id="l60.4"> EXTRA_JS_MODULES = \</span>
<a href="#l60.5"></a><span id="l60.5"> 		folderUtils.jsm \</span>
<a href="#l60.6"></a><span id="l60.6"> 		errUtils.js \</span>
<a href="#l60.7"></a><span id="l60.7"> 		iteratorUtils.jsm \</span>
<a href="#l60.8"></a><span id="l60.8"> 		jsTreeSelection.js \</span>
<a href="#l60.9"></a><span id="l60.9"> 		traceHelper.js \</span>
<a href="#l60.10"></a><span id="l60.10"> 		autoconfigUtils.jsm \</span>
<a href="#l60.11"></a><span id="l60.11"> 		StringBundle.js \</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+		templateUtils.js \</span>
<a href="#l60.13"></a><span id="l60.13"> 		$(NULL)</span>
<a href="#l60.14"></a><span id="l60.14"> </span>
<a href="#l60.15"></a><span id="l60.15"> ifndef MOZ_STATIC_MAIL_BUILD</span>
<a href="#l60.16"></a><span id="l60.16"> </span>
<a href="#l60.17"></a><span id="l60.17"> ifdef MOZILLA_INTERNAL_API</span>
<a href="#l60.18"></a><span id="l60.18"> EXTRA_DSO_LDOPTS = \</span>
<a href="#l60.19"></a><span id="l60.19"> 	$(LIBS_DIR) \</span>
<a href="#l60.20"></a><span id="l60.20"> 	$(MOZDEPTH)/rdf/util/src/internal/$(LIB_PREFIX)rdfutil_s.$(LIB_SUFFIX) \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/base/util/errUtils.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/base/util/errUtils.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -86,16 +86,17 @@ function Stringifier() {};</span>
<a href="#l61.4"></a><span id="l61.4"> Stringifier.prototype = {</span>
<a href="#l61.5"></a><span id="l61.5">   dumpObj: function (o, name) {</span>
<a href="#l61.6"></a><span id="l61.6">     this._reset();</span>
<a href="#l61.7"></a><span id="l61.7">     this._append(this.objectTreeAsString(o, true, true, 0));</span>
<a href="#l61.8"></a><span id="l61.8">     dump(this._asString());</span>
<a href="#l61.9"></a><span id="l61.9">   },</span>
<a href="#l61.10"></a><span id="l61.10"> </span>
<a href="#l61.11"></a><span id="l61.11">   dumpDOM: function(node, level, recursive) {</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineplus">+    this._reset();</span>
<a href="#l61.13"></a><span id="l61.13">     let s = this.DOMNodeAsString(node, level, recursive);</span>
<a href="#l61.14"></a><span id="l61.14">     dump(s);</span>
<a href="#l61.15"></a><span id="l61.15">   },</span>
<a href="#l61.16"></a><span id="l61.16"> </span>
<a href="#l61.17"></a><span id="l61.17">   dumpEvent: function(event) {</span>
<a href="#l61.18"></a><span id="l61.18">     dump(this.eventAsString(event));</span>
<a href="#l61.19"></a><span id="l61.19">   },</span>
<a href="#l61.20"></a><span id="l61.20"> </span>
<a href="#l61.21"></a><span id="l61.21" class="difflineat">@@ -196,17 +197,17 @@ Stringifier.prototype = {</span>
<a href="#l61.22"></a><span id="l61.22">                 s += pfx + tee + i + &quot; (&quot; + t + &quot;) &quot; + o[i].length + &quot; chars\n&quot;;</span>
<a href="#l61.23"></a><span id="l61.23">               else</span>
<a href="#l61.24"></a><span id="l61.24">                 s += pfx + tee + i + &quot; (&quot; + t + &quot;) '&quot; + o[i] + &quot;'\n&quot;;</span>
<a href="#l61.25"></a><span id="l61.25">               break;</span>
<a href="#l61.26"></a><span id="l61.26">             default:</span>
<a href="#l61.27"></a><span id="l61.27">               s += pfx + tee + i + &quot; (&quot; + t + &quot;) &quot; + o[i] + &quot;\n&quot;;</span>
<a href="#l61.28"></a><span id="l61.28">           }</span>
<a href="#l61.29"></a><span id="l61.29">         } catch (ex) {</span>
<a href="#l61.30"></a><span id="l61.30" class="difflineminus">-          s += pfx + tee + i + &quot; (exception) &quot; + ex + &quot;\n&quot;;</span>
<a href="#l61.31"></a><span id="l61.31" class="difflineplus">+          s += pfx + tee + &quot; (exception) &quot; + ex + &quot;\n&quot;;</span>
<a href="#l61.32"></a><span id="l61.32">         }</span>
<a href="#l61.33"></a><span id="l61.33">         if (!compress)</span>
<a href="#l61.34"></a><span id="l61.34">           s += pfx + &quot;|\n&quot;;</span>
<a href="#l61.35"></a><span id="l61.35">       }</span>
<a href="#l61.36"></a><span id="l61.36">     }</span>
<a href="#l61.37"></a><span id="l61.37">     s += pfx + &quot;*\n&quot;;</span>
<a href="#l61.38"></a><span id="l61.38">     return s;</span>
<a href="#l61.39"></a><span id="l61.39">   },</span>
<a href="#l61.40"></a><span id="l61.40" class="difflineat">@@ -214,22 +215,20 @@ Stringifier.prototype = {</span>
<a href="#l61.41"></a><span id="l61.41">   _repeatStr: function (str, aCount) {</span>
<a href="#l61.42"></a><span id="l61.42">     let res = &quot;&quot;;</span>
<a href="#l61.43"></a><span id="l61.43">     while (--aCount &gt;= 0)</span>
<a href="#l61.44"></a><span id="l61.44">       res += str;</span>
<a href="#l61.45"></a><span id="l61.45">     return res;</span>
<a href="#l61.46"></a><span id="l61.46">   },</span>
<a href="#l61.47"></a><span id="l61.47"> </span>
<a href="#l61.48"></a><span id="l61.48">   DOMNodeAsString: function(node, level, recursive) {</span>
<a href="#l61.49"></a><span id="l61.49" class="difflineminus">-    this._reset();</span>
<a href="#l61.50"></a><span id="l61.50">     if (level === undefined)</span>
<a href="#l61.51"></a><span id="l61.51">       level = 0</span>
<a href="#l61.52"></a><span id="l61.52">     if (recursive === undefined)</span>
<a href="#l61.53"></a><span id="l61.53">       recursive = true;</span>
<a href="#l61.54"></a><span id="l61.54" class="difflineminus">-</span>
<a href="#l61.55"></a><span id="l61.55">     this._append(this._repeatStr(&quot; &quot;, 2*level) + &quot;&lt;&quot; + node.nodeName + &quot;\n&quot;);</span>
<a href="#l61.56"></a><span id="l61.56"> </span>
<a href="#l61.57"></a><span id="l61.57">     if (node.nodeType == 3) {</span>
<a href="#l61.58"></a><span id="l61.58">         this._append(this._repeatStr(&quot; &quot;, (2*level) + 4) + node.nodeValue + &quot;'\n&quot;);</span>
<a href="#l61.59"></a><span id="l61.59">     }</span>
<a href="#l61.60"></a><span id="l61.60">     else {</span>
<a href="#l61.61"></a><span id="l61.61">       if (node.attributes) {</span>
<a href="#l61.62"></a><span id="l61.62">         for (let i = 0; i &lt; node.attributes.length; i++) {</span>
<a href="#l61.63"></a><span id="l61.63" class="difflineat">@@ -239,17 +238,17 @@ Stringifier.prototype = {</span>
<a href="#l61.64"></a><span id="l61.64">         }</span>
<a href="#l61.65"></a><span id="l61.65">       }</span>
<a href="#l61.66"></a><span id="l61.66">       if (node.childNodes.length == 0) {</span>
<a href="#l61.67"></a><span id="l61.67">         this._append(this._repeatStr(&quot; &quot;, (2*level)) + &quot;/&gt;\n&quot;);</span>
<a href="#l61.68"></a><span id="l61.68">       }</span>
<a href="#l61.69"></a><span id="l61.69">       else if (recursive) {</span>
<a href="#l61.70"></a><span id="l61.70">         this._append(this._repeatStr(&quot; &quot;, (2*level)) + &quot;&gt;\n&quot;);</span>
<a href="#l61.71"></a><span id="l61.71">         for (let i = 0; i &lt; node.childNodes.length; i++) {</span>
<a href="#l61.72"></a><span id="l61.72" class="difflineminus">-          this.dumpDOM(node.childNodes[i], level + 1);</span>
<a href="#l61.73"></a><span id="l61.73" class="difflineplus">+          this._append(this.DOMNodeAsString(node.childNodes[i], level + 1));</span>
<a href="#l61.74"></a><span id="l61.74">         }</span>
<a href="#l61.75"></a><span id="l61.75">         this._append(this._repeatStr(&quot; &quot;, 2*level) + &quot;&lt;/&quot; + node.nodeName + &quot;&gt;\n&quot;);</span>
<a href="#l61.76"></a><span id="l61.76">       }</span>
<a href="#l61.77"></a><span id="l61.77">     }</span>
<a href="#l61.78"></a><span id="l61.78">     return this._asString();</span>
<a href="#l61.79"></a><span id="l61.79">   },</span>
<a href="#l61.80"></a><span id="l61.80"> </span>
<a href="#l61.81"></a><span id="l61.81">   eventAsString: function (event) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1">new file mode 100644</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineminus">--- /dev/null</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineplus">+++ b/mailnews/base/util/templateUtils.js</span>
<a href="#l62.4"></a><span id="l62.4" class="difflineat">@@ -0,0 +1,125 @@</span>
<a href="#l62.5"></a><span id="l62.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l62.6"></a><span id="l62.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l62.7"></a><span id="l62.7" class="difflineplus">+ *</span>
<a href="#l62.8"></a><span id="l62.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l62.9"></a><span id="l62.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l62.10"></a><span id="l62.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l62.11"></a><span id="l62.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineplus">+ *</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l62.15"></a><span id="l62.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l62.16"></a><span id="l62.16" class="difflineplus">+ * License.</span>
<a href="#l62.17"></a><span id="l62.17" class="difflineplus">+ *</span>
<a href="#l62.18"></a><span id="l62.18" class="difflineplus">+ * The Original Code is templateUtils.</span>
<a href="#l62.19"></a><span id="l62.19" class="difflineplus">+ *</span>
<a href="#l62.20"></a><span id="l62.20" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla.</span>
<a href="#l62.21"></a><span id="l62.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l62.23"></a><span id="l62.23" class="difflineplus">+ *</span>
<a href="#l62.24"></a><span id="l62.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l62.25"></a><span id="l62.25" class="difflineplus">+ *   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l62.26"></a><span id="l62.26" class="difflineplus">+ *</span>
<a href="#l62.27"></a><span id="l62.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l62.28"></a><span id="l62.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l62.29"></a><span id="l62.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l62.30"></a><span id="l62.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l62.35"></a><span id="l62.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l62.36"></a><span id="l62.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l62.37"></a><span id="l62.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l62.38"></a><span id="l62.38" class="difflineplus">+ *</span>
<a href="#l62.39"></a><span id="l62.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l62.40"></a><span id="l62.40" class="difflineplus">+</span>
<a href="#l62.41"></a><span id="l62.41" class="difflineplus">+let EXPORTED_SYMBOLS = [&quot;makeFriendlyDateAgo&quot;, &quot;replaceInsert&quot;];</span>
<a href="#l62.42"></a><span id="l62.42" class="difflineplus">+</span>
<a href="#l62.43"></a><span id="l62.43" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l62.44"></a><span id="l62.44" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l62.45"></a><span id="l62.45" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l62.46"></a><span id="l62.46" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l62.47"></a><span id="l62.47" class="difflineplus">+</span>
<a href="#l62.48"></a><span id="l62.48" class="difflineplus">+Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l62.49"></a><span id="l62.49" class="difflineplus">+</span>
<a href="#l62.50"></a><span id="l62.50" class="difflineplus">+const gTemplateUtilsStrings =</span>
<a href="#l62.51"></a><span id="l62.51" class="difflineplus">+  new StringBundle(&quot;chrome://messenger/locale/templateUtils.properties&quot;);</span>
<a href="#l62.52"></a><span id="l62.52" class="difflineplus">+</span>
<a href="#l62.53"></a><span id="l62.53" class="difflineplus">+/**</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineplus">+ * Helper function to generate a localized &quot;friendly&quot; representation of</span>
<a href="#l62.55"></a><span id="l62.55" class="difflineplus">+ * time relative to the present.  If the time input is &quot;today&quot;, it returns</span>
<a href="#l62.56"></a><span id="l62.56" class="difflineplus">+ * a string corresponding to just the time.  If it's yesterday, it returns</span>
<a href="#l62.57"></a><span id="l62.57" class="difflineplus">+ * &quot;yesterday&quot; (localized).  If it's in the last week, it returns the day</span>
<a href="#l62.58"></a><span id="l62.58" class="difflineplus">+ * of the week. If it's before that, it returns the date.</span>
<a href="#l62.59"></a><span id="l62.59" class="difflineplus">+ *</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineplus">+ * @param time</span>
<a href="#l62.61"></a><span id="l62.61" class="difflineplus">+ *        the time (better be in the past!)</span>
<a href="#l62.62"></a><span id="l62.62" class="difflineplus">+ * @return The string with a &quot;human-friendly&quot; representation of that time</span>
<a href="#l62.63"></a><span id="l62.63" class="difflineplus">+ *        relative to now.</span>
<a href="#l62.64"></a><span id="l62.64" class="difflineplus">+ */</span>
<a href="#l62.65"></a><span id="l62.65" class="difflineplus">+function makeFriendlyDateAgo(time)</span>
<a href="#l62.66"></a><span id="l62.66" class="difflineplus">+{</span>
<a href="#l62.67"></a><span id="l62.67" class="difflineplus">+  let dts = Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;]</span>
<a href="#l62.68"></a><span id="l62.68" class="difflineplus">+                      .getService(Components.interfaces.nsIScriptableDateFormat);</span>
<a href="#l62.69"></a><span id="l62.69" class="difflineplus">+</span>
<a href="#l62.70"></a><span id="l62.70" class="difflineplus">+  // Figure out when today begins</span>
<a href="#l62.71"></a><span id="l62.71" class="difflineplus">+  let now = new Date();</span>
<a href="#l62.72"></a><span id="l62.72" class="difflineplus">+  let today = new Date(now.getFullYear(), now.getMonth(),</span>
<a href="#l62.73"></a><span id="l62.73" class="difflineplus">+                       now.getDate());</span>
<a href="#l62.74"></a><span id="l62.74" class="difflineplus">+</span>
<a href="#l62.75"></a><span id="l62.75" class="difflineplus">+  // Get the end time to display</span>
<a href="#l62.76"></a><span id="l62.76" class="difflineplus">+  let end = time;</span>
<a href="#l62.77"></a><span id="l62.77" class="difflineplus">+</span>
<a href="#l62.78"></a><span id="l62.78" class="difflineplus">+  // Figure out if the end time is from today, yesterday,</span>
<a href="#l62.79"></a><span id="l62.79" class="difflineplus">+  // this week, etc.</span>
<a href="#l62.80"></a><span id="l62.80" class="difflineplus">+  let dateTime;</span>
<a href="#l62.81"></a><span id="l62.81" class="difflineplus">+  let kDayInMsecs = 24 * 60 * 60 * 1000;</span>
<a href="#l62.82"></a><span id="l62.82" class="difflineplus">+  let k6DaysInMsecs = 6 * kDayInMsecs;</span>
<a href="#l62.83"></a><span id="l62.83" class="difflineplus">+  if (end &gt;= today) {</span>
<a href="#l62.84"></a><span id="l62.84" class="difflineplus">+    // activity finished after today started, show the time</span>
<a href="#l62.85"></a><span id="l62.85" class="difflineplus">+    dateTime = dts.FormatTime(&quot;&quot;, dts.timeFormatNoSeconds,</span>
<a href="#l62.86"></a><span id="l62.86" class="difflineplus">+                                  end.getHours(), end.getMinutes(),0);</span>
<a href="#l62.87"></a><span id="l62.87" class="difflineplus">+  } else if (today - end &lt; kDayInMsecs) {</span>
<a href="#l62.88"></a><span id="l62.88" class="difflineplus">+    // activity finished after yesterday started, show yesterday</span>
<a href="#l62.89"></a><span id="l62.89" class="difflineplus">+    dateTime = gTemplateUtilsStrings.get('yesterday');</span>
<a href="#l62.90"></a><span id="l62.90" class="difflineplus">+  } else if (today - end &lt; k6DaysInMsecs) {</span>
<a href="#l62.91"></a><span id="l62.91" class="difflineplus">+    // activity finished after last week started, show day of week</span>
<a href="#l62.92"></a><span id="l62.92" class="difflineplus">+    dateTime = end.toLocaleFormat(&quot;%A&quot;);</span>
<a href="#l62.93"></a><span id="l62.93" class="difflineplus">+  } else if (now.getFullYear() == end.getFullYear()) {</span>
<a href="#l62.94"></a><span id="l62.94" class="difflineplus">+    // activity must have been from some time ago.. show month/day</span>
<a href="#l62.95"></a><span id="l62.95" class="difflineplus">+    let month = end.toLocaleFormat(&quot;%B&quot;);</span>
<a href="#l62.96"></a><span id="l62.96" class="difflineplus">+    // Remove leading 0 by converting the date string to a number</span>
<a href="#l62.97"></a><span id="l62.97" class="difflineplus">+    let date = Number(end.toLocaleFormat(&quot;%d&quot;));</span>
<a href="#l62.98"></a><span id="l62.98" class="difflineplus">+    //dateTime = replaceInsert(this.text.monthDate, 1, month);</span>
<a href="#l62.99"></a><span id="l62.99" class="difflineplus">+    dateTime = replaceInsert(&quot;#1 #2&quot;, 1, month);</span>
<a href="#l62.100"></a><span id="l62.100" class="difflineplus">+    dateTime = replaceInsert(dateTime, 2, date);</span>
<a href="#l62.101"></a><span id="l62.101" class="difflineplus">+  } else {</span>
<a href="#l62.102"></a><span id="l62.102" class="difflineplus">+    // not this year, so show year as wel</span>
<a href="#l62.103"></a><span id="l62.103" class="difflineplus">+    let month = end.toLocaleFormat(&quot;%B&quot;);</span>
<a href="#l62.104"></a><span id="l62.104" class="difflineplus">+    let year = end.toLocaleFormat(&quot;%Y&quot;);</span>
<a href="#l62.105"></a><span id="l62.105" class="difflineplus">+    // Remove leading 0 by converting the date string to a number</span>
<a href="#l62.106"></a><span id="l62.106" class="difflineplus">+    let date = Number(end.toLocaleFormat(&quot;%d&quot;));</span>
<a href="#l62.107"></a><span id="l62.107" class="difflineplus">+    //dateTime = replaceInsert(this.text.monthDate, 1, month);</span>
<a href="#l62.108"></a><span id="l62.108" class="difflineplus">+    dateTime = replaceInsert(&quot;#1 #2 #3&quot;, 1, month);</span>
<a href="#l62.109"></a><span id="l62.109" class="difflineplus">+    dateTime = replaceInsert(dateTime, 2, date);</span>
<a href="#l62.110"></a><span id="l62.110" class="difflineplus">+    dateTime = replaceInsert(dateTime, 3, year);</span>
<a href="#l62.111"></a><span id="l62.111" class="difflineplus">+  }</span>
<a href="#l62.112"></a><span id="l62.112" class="difflineplus">+  return dateTime;</span>
<a href="#l62.113"></a><span id="l62.113" class="difflineplus">+}</span>
<a href="#l62.114"></a><span id="l62.114" class="difflineplus">+</span>
<a href="#l62.115"></a><span id="l62.115" class="difflineplus">+/**</span>
<a href="#l62.116"></a><span id="l62.116" class="difflineplus">+ * Helper function to replace a placeholder string with a real string</span>
<a href="#l62.117"></a><span id="l62.117" class="difflineplus">+ *</span>
<a href="#l62.118"></a><span id="l62.118" class="difflineplus">+ * @param aText</span>
<a href="#l62.119"></a><span id="l62.119" class="difflineplus">+ *        Source text containing placeholder (e.g., #1)</span>
<a href="#l62.120"></a><span id="l62.120" class="difflineplus">+ * @param aIndex</span>
<a href="#l62.121"></a><span id="l62.121" class="difflineplus">+ *        Index number of placeholder to replace</span>
<a href="#l62.122"></a><span id="l62.122" class="difflineplus">+ * @param aValue</span>
<a href="#l62.123"></a><span id="l62.123" class="difflineplus">+ *        New string to put in place of placeholder</span>
<a href="#l62.124"></a><span id="l62.124" class="difflineplus">+ * @return The string with placeholder replaced with the new string</span>
<a href="#l62.125"></a><span id="l62.125" class="difflineplus">+ */</span>
<a href="#l62.126"></a><span id="l62.126" class="difflineplus">+function replaceInsert(aText, aIndex, aValue)</span>
<a href="#l62.127"></a><span id="l62.127" class="difflineplus">+{</span>
<a href="#l62.128"></a><span id="l62.128" class="difflineplus">+  return aText.replace(&quot;#&quot; + aIndex, aValue);</span>
<a href="#l62.129"></a><span id="l62.129" class="difflineplus">+}</span>
<a href="#l62.130"></a><span id="l62.130">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/db/gloda/components/glautocomp.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/db/gloda/components/glautocomp.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -37,53 +37,64 @@</span>
<a href="#l63.4"></a><span id="l63.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l63.5"></a><span id="l63.5"> </span>
<a href="#l63.6"></a><span id="l63.6"> const Cc = Components.classes;</span>
<a href="#l63.7"></a><span id="l63.7"> const Ci = Components.interfaces;</span>
<a href="#l63.8"></a><span id="l63.8"> const Cr = Components.results;</span>
<a href="#l63.9"></a><span id="l63.9"> const Cu = Components.utils;</span>
<a href="#l63.10"></a><span id="l63.10"> </span>
<a href="#l63.11"></a><span id="l63.11"> Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineminus">-var LOG = null;</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineplus">+Cu.import(&quot;resource://gre/modules/errUtils.js&quot;);</span>
<a href="#l63.15"></a><span id="l63.15"> </span>
<a href="#l63.16"></a><span id="l63.16"> var Gloda = null;</span>
<a href="#l63.17"></a><span id="l63.17"> var GlodaUtils = null;</span>
<a href="#l63.18"></a><span id="l63.18"> var MultiSuffixTree = null;</span>
<a href="#l63.19"></a><span id="l63.19"> var TagNoun = null;</span>
<a href="#l63.20"></a><span id="l63.20"> var FreeTagNoun = null;</span>
<a href="#l63.21"></a><span id="l63.21"> </span>
<a href="#l63.22"></a><span id="l63.22" class="difflineplus">+function ResultRowFullText(aItem, words, typeForStyle, andTerms) {</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineplus">+  this.item = aItem;</span>
<a href="#l63.24"></a><span id="l63.24" class="difflineplus">+  this.words = words;</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineplus">+  this.andTerms = andTerms;</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineplus">+  this.typeForStyle = &quot;gloda-fulltext-&quot; + typeForStyle;</span>
<a href="#l63.27"></a><span id="l63.27" class="difflineplus">+}</span>
<a href="#l63.28"></a><span id="l63.28" class="difflineplus">+ResultRowFullText.prototype = {</span>
<a href="#l63.29"></a><span id="l63.29" class="difflineplus">+  multi: false,</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineplus">+  fullText: true</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineplus">+};</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineplus">+</span>
<a href="#l63.33"></a><span id="l63.33"> function ResultRowSingle(aItem, aCriteriaType, aCriteria, aExplicitNounID) {</span>
<a href="#l63.34"></a><span id="l63.34">   this.nounID = aExplicitNounID || aItem.NOUN_ID;</span>
<a href="#l63.35"></a><span id="l63.35">   this.nounDef = Gloda._nounIDToDef[this.nounID];</span>
<a href="#l63.36"></a><span id="l63.36">   this.criteriaType = aCriteriaType;</span>
<a href="#l63.37"></a><span id="l63.37">   this.criteria = aCriteria;</span>
<a href="#l63.38"></a><span id="l63.38">   this.item = aItem;</span>
<a href="#l63.39"></a><span id="l63.39" class="difflineplus">+  this.typeForStyle = &quot;gloda-single-&quot; + this.nounDef.name;</span>
<a href="#l63.40"></a><span id="l63.40"> }</span>
<a href="#l63.41"></a><span id="l63.41"> ResultRowSingle.prototype = {</span>
<a href="#l63.42"></a><span id="l63.42" class="difflineminus">-  multi: false</span>
<a href="#l63.43"></a><span id="l63.43" class="difflineplus">+  multi: false,</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineplus">+  fullText: false</span>
<a href="#l63.45"></a><span id="l63.45"> };</span>
<a href="#l63.46"></a><span id="l63.46"> </span>
<a href="#l63.47"></a><span id="l63.47"> function ResultRowMulti(aNounID, aCriteriaType, aCriteria, aQuery) {</span>
<a href="#l63.48"></a><span id="l63.48">   this.nounID = aNounID;</span>
<a href="#l63.49"></a><span id="l63.49">   this.nounDef = Gloda._nounIDToDef[aNounID];</span>
<a href="#l63.50"></a><span id="l63.50">   this.criteriaType = aCriteriaType;</span>
<a href="#l63.51"></a><span id="l63.51">   this.criteria = aCriteria;</span>
<a href="#l63.52"></a><span id="l63.52">   this.collection = aQuery.getCollection(this);</span>
<a href="#l63.53"></a><span id="l63.53">   this.collection.becomeExplicit();</span>
<a href="#l63.54"></a><span id="l63.54">   this.renderer = null;</span>
<a href="#l63.55"></a><span id="l63.55"> }</span>
<a href="#l63.56"></a><span id="l63.56"> ResultRowMulti.prototype = {</span>
<a href="#l63.57"></a><span id="l63.57">   multi: true,</span>
<a href="#l63.58"></a><span id="l63.58" class="difflineplus">+  typeForStyle: &quot;gloda-multi&quot;,</span>
<a href="#l63.59"></a><span id="l63.59" class="difflineplus">+  fullText: false,</span>
<a href="#l63.60"></a><span id="l63.60">   onItemsAdded: function(aItems) {</span>
<a href="#l63.61"></a><span id="l63.61" class="difflineminus">-    LOG.debug(&quot;RRM onItemsAdded: &quot; + aItems.length + &quot;: &quot; + aItems);</span>
<a href="#l63.62"></a><span id="l63.62">     if (this.renderer) {</span>
<a href="#l63.63"></a><span id="l63.63" class="difflineminus">-      LOG.debug(&quot;RRM rendering...&quot;);</span>
<a href="#l63.64"></a><span id="l63.64">       for each (let [iItem, item] in Iterator(aItems)) {</span>
<a href="#l63.65"></a><span id="l63.65" class="difflineminus">-        LOG.debug(&quot;RRM ...&quot; + item);</span>
<a href="#l63.66"></a><span id="l63.66">         this.renderer.renderItem(item);</span>
<a href="#l63.67"></a><span id="l63.67">       }</span>
<a href="#l63.68"></a><span id="l63.68">     }</span>
<a href="#l63.69"></a><span id="l63.69">   },</span>
<a href="#l63.70"></a><span id="l63.70">   onItemsModified: function(aItems) {</span>
<a href="#l63.71"></a><span id="l63.71">   },</span>
<a href="#l63.72"></a><span id="l63.72">   onItemsRemoved: function(aItems) {</span>
<a href="#l63.73"></a><span id="l63.73">   },</span>
<a href="#l63.74"></a><span id="l63.74" class="difflineat">@@ -93,38 +104,35 @@ ResultRowMulti.prototype = {</span>
<a href="#l63.75"></a><span id="l63.75"> </span>
<a href="#l63.76"></a><span id="l63.76"> function nsAutoCompleteGlodaResult(aListener, aCompleter, aString) {</span>
<a href="#l63.77"></a><span id="l63.77">   this.listener = aListener;</span>
<a href="#l63.78"></a><span id="l63.78">   this.completer = aCompleter;</span>
<a href="#l63.79"></a><span id="l63.79">   this.searchString = aString;</span>
<a href="#l63.80"></a><span id="l63.80">   this._results = [];</span>
<a href="#l63.81"></a><span id="l63.81">   this._pendingCount = 0;</span>
<a href="#l63.82"></a><span id="l63.82">   this._problem = false;</span>
<a href="#l63.83"></a><span id="l63.83" class="difflineminus">-  </span>
<a href="#l63.84"></a><span id="l63.84" class="difflineplus">+</span>
<a href="#l63.85"></a><span id="l63.85">   this.wrappedJSObject = this;</span>
<a href="#l63.86"></a><span id="l63.86"> }</span>
<a href="#l63.87"></a><span id="l63.87"> nsAutoCompleteGlodaResult.prototype = {</span>
<a href="#l63.88"></a><span id="l63.88">   getObjectAt: function(aIndex) {</span>
<a href="#l63.89"></a><span id="l63.89">     return this._results[aIndex];</span>
<a href="#l63.90"></a><span id="l63.90">   },</span>
<a href="#l63.91"></a><span id="l63.91">   markPending: function ACGR_markPending(aCompleter) {</span>
<a href="#l63.92"></a><span id="l63.92">     this._pendingCount++;</span>
<a href="#l63.93"></a><span id="l63.93">   },</span>
<a href="#l63.94"></a><span id="l63.94">   markCompleted: function ACGR_markCompleted(aCompleter) {</span>
<a href="#l63.95"></a><span id="l63.95">     if (--this._pendingCount == 0) {</span>
<a href="#l63.96"></a><span id="l63.96" class="difflineminus">-      LOG.debug(&quot;Notifying completion.&quot;);</span>
<a href="#l63.97"></a><span id="l63.97">       this.listener.onSearchResult(this.completer, this);</span>
<a href="#l63.98"></a><span id="l63.98">     }</span>
<a href="#l63.99"></a><span id="l63.99">   },</span>
<a href="#l63.100"></a><span id="l63.100">   addRows: function ACGR_addRows(aRows) {</span>
<a href="#l63.101"></a><span id="l63.101">     if (!aRows.length)</span>
<a href="#l63.102"></a><span id="l63.102">       return;</span>
<a href="#l63.103"></a><span id="l63.103" class="difflineminus">-    LOG.debug(&quot;Adding &quot; + aRows.length + &quot; rows (&quot; + this._pendingCount +</span>
<a href="#l63.104"></a><span id="l63.104" class="difflineminus">-              &quot; jobs still pending)&quot;);</span>
<a href="#l63.105"></a><span id="l63.105" class="difflineminus">-    this._results.push.apply(this._results, aRows); </span>
<a href="#l63.106"></a><span id="l63.106" class="difflineplus">+    this._results.push.apply(this._results, aRows);</span>
<a href="#l63.107"></a><span id="l63.107">     this.listener.onSearchResult(this.completer, this);</span>
<a href="#l63.108"></a><span id="l63.108">   },</span>
<a href="#l63.109"></a><span id="l63.109">   // ==== nsIAutoCompleteResult</span>
<a href="#l63.110"></a><span id="l63.110">   searchString: null,</span>
<a href="#l63.111"></a><span id="l63.111">   get searchResult() {</span>
<a href="#l63.112"></a><span id="l63.112">     if (this._problem)</span>
<a href="#l63.113"></a><span id="l63.113">       return Ci.nsIAutoCompleteResult.RESULT_FAILURE;</span>
<a href="#l63.114"></a><span id="l63.114">     if (this._results.length)</span>
<a href="#l63.115"></a><span id="l63.115" class="difflineat">@@ -152,36 +160,35 @@ nsAutoCompleteGlodaResult.prototype = {</span>
<a href="#l63.116"></a><span id="l63.116">     if (thing.value) // identity</span>
<a href="#l63.117"></a><span id="l63.117">       return thing.contact.name;</span>
<a href="#l63.118"></a><span id="l63.118">     else</span>
<a href="#l63.119"></a><span id="l63.119">       return thing.name || thing.subject;</span>
<a href="#l63.120"></a><span id="l63.120">   },</span>
<a href="#l63.121"></a><span id="l63.121">   // rich uses this to be the &quot;type&quot;</span>
<a href="#l63.122"></a><span id="l63.122">   getStyleAt: function(aIndex) {</span>
<a href="#l63.123"></a><span id="l63.123">     let row = this._results[aIndex];</span>
<a href="#l63.124"></a><span id="l63.124" class="difflineminus">-    if (row.multi)</span>
<a href="#l63.125"></a><span id="l63.125" class="difflineminus">-      return &quot;gloda-multi&quot;;</span>
<a href="#l63.126"></a><span id="l63.126" class="difflineminus">-    else</span>
<a href="#l63.127"></a><span id="l63.127" class="difflineminus">-      return &quot;gloda-single-&quot; + row.nounDef.name;</span>
<a href="#l63.128"></a><span id="l63.128" class="difflineplus">+    return row.typeForStyle;</span>
<a href="#l63.129"></a><span id="l63.129">   },</span>
<a href="#l63.130"></a><span id="l63.130">   // rich uses this to be the icon</span>
<a href="#l63.131"></a><span id="l63.131">   getImageAt: function(aIndex) {</span>
<a href="#l63.132"></a><span id="l63.132">     let thing = this._results[aIndex];</span>
<a href="#l63.133"></a><span id="l63.133">     if (!thing.value)</span>
<a href="#l63.134"></a><span id="l63.134">       return null;</span>
<a href="#l63.135"></a><span id="l63.135"> </span>
<a href="#l63.136"></a><span id="l63.136" class="difflineplus">+    return &quot;&quot;; // we don't want to use gravatars as is.</span>
<a href="#l63.137"></a><span id="l63.137" class="difflineplus">+</span>
<a href="#l63.138"></a><span id="l63.138">     let md5hash = GlodaUtils.md5HashString(thing.value);</span>
<a href="#l63.139"></a><span id="l63.139">     let gravURL = &quot;http://www.gravatar.com/avatar/&quot; + md5hash +</span>
<a href="#l63.140"></a><span id="l63.140">                                 &quot;?d=identicon&amp;s=32&amp;r=g&quot;;</span>
<a href="#l63.141"></a><span id="l63.141">     return gravURL;</span>
<a href="#l63.142"></a><span id="l63.142">   },</span>
<a href="#l63.143"></a><span id="l63.143">   removeValueAt: function() {},</span>
<a href="#l63.144"></a><span id="l63.144"> </span>
<a href="#l63.145"></a><span id="l63.145">   _stop: function() {</span>
<a href="#l63.146"></a><span id="l63.146" class="difflineminus">-  },</span>
<a href="#l63.147"></a><span id="l63.147" class="difflineplus">+  }</span>
<a href="#l63.148"></a><span id="l63.148"> };</span>
<a href="#l63.149"></a><span id="l63.149"> </span>
<a href="#l63.150"></a><span id="l63.150"> const MAX_POPULAR_CONTACTS = 200;</span>
<a href="#l63.151"></a><span id="l63.151"> </span>
<a href="#l63.152"></a><span id="l63.152"> /**</span>
<a href="#l63.153"></a><span id="l63.153">  * Complete contacts/identities based on name/email.  Instant phase is based on</span>
<a href="#l63.154"></a><span id="l63.154">  *  a suffix-tree built of popular contacts/identities.  Delayed phase relies</span>
<a href="#l63.155"></a><span id="l63.155">  *  on a LIKE search of all known contacts.</span>
<a href="#l63.156"></a><span id="l63.156" class="difflineat">@@ -197,17 +204,16 @@ ContactIdentityCompleter.prototype = {</span>
<a href="#l63.157"></a><span id="l63.157">   _popularitySorter: function(a, b){ return b.popularity - a.popularity; },</span>
<a href="#l63.158"></a><span id="l63.158">   complete: function ContactIdentityCompleter_complete(aResult, aString) {</span>
<a href="#l63.159"></a><span id="l63.159">     if (aString.length &lt; 3)</span>
<a href="#l63.160"></a><span id="l63.160">       return false;</span>
<a href="#l63.161"></a><span id="l63.161"> </span>
<a href="#l63.162"></a><span id="l63.162">     let matches;</span>
<a href="#l63.163"></a><span id="l63.163">     if (this.suffixTree) {</span>
<a href="#l63.164"></a><span id="l63.164">       matches = this.suffixTree.findMatches(aString.toLowerCase());</span>
<a href="#l63.165"></a><span id="l63.165" class="difflineminus">-      LOG.debug(&quot;CIC: Suffix Tree found &quot; + matches.length + &quot; matches.&quot;)</span>
<a href="#l63.166"></a><span id="l63.166">     }</span>
<a href="#l63.167"></a><span id="l63.167">     else</span>
<a href="#l63.168"></a><span id="l63.168">       matches = [];</span>
<a href="#l63.169"></a><span id="l63.169"> </span>
<a href="#l63.170"></a><span id="l63.170">     // let's filter out duplicates due to identity/contact double-hits by</span>
<a href="#l63.171"></a><span id="l63.171">     //  establishing a map based on the contact id for these guys.</span>
<a href="#l63.172"></a><span id="l63.172">     // let's also favor identities as we do it, because that gets us the</span>
<a href="#l63.173"></a><span id="l63.173">     //  most accurate gravat, potentially</span>
<a href="#l63.174"></a><span id="l63.174" class="difflineat">@@ -225,48 +231,45 @@ ContactIdentityCompleter.prototype = {</span>
<a href="#l63.175"></a><span id="l63.175">                for each ([iVal, val] in Iterator(contactToThing))];</span>
<a href="#l63.176"></a><span id="l63.176"> </span>
<a href="#l63.177"></a><span id="l63.177">     let rows = [new ResultRowSingle(match, &quot;text&quot;, aResult.searchString)</span>
<a href="#l63.178"></a><span id="l63.178">                 for each ([iMatch, match] in Iterator(matches))];</span>
<a href="#l63.179"></a><span id="l63.179">     aResult.addRows(rows);</span>
<a href="#l63.180"></a><span id="l63.180"> </span>
<a href="#l63.181"></a><span id="l63.181">     // - match against database contacts / identities</span>
<a href="#l63.182"></a><span id="l63.182">     let pending = {contactToThing: contactToThing, pendingCount: 2};</span>
<a href="#l63.183"></a><span id="l63.183" class="difflineminus">-    </span>
<a href="#l63.184"></a><span id="l63.184" class="difflineminus">-    LOG.debug(&quot;CIC: issuing contact LIKE query&quot;);</span>
<a href="#l63.185"></a><span id="l63.185" class="difflineplus">+</span>
<a href="#l63.186"></a><span id="l63.186">     let contactQuery = Gloda.newQuery(Gloda.NOUN_CONTACT);</span>
<a href="#l63.187"></a><span id="l63.187">     contactQuery.nameLike(contactQuery.WILD, aString, contactQuery.WILD);</span>
<a href="#l63.188"></a><span id="l63.188">     pending.contactColl = contactQuery.getCollection(this, aResult);</span>
<a href="#l63.189"></a><span id="l63.189">     pending.contactColl.becomeExplicit();</span>
<a href="#l63.190"></a><span id="l63.190"> </span>
<a href="#l63.191"></a><span id="l63.191" class="difflineminus">-    LOG.debug(&quot;CIC: issuing identity LIKE query&quot;);</span>
<a href="#l63.192"></a><span id="l63.192">     let identityQuery = Gloda.newQuery(Gloda.NOUN_IDENTITY);</span>
<a href="#l63.193"></a><span id="l63.193">     identityQuery.kind(&quot;email&quot;).valueLike(identityQuery.WILD, aString,</span>
<a href="#l63.194"></a><span id="l63.194">         identityQuery.WILD);</span>
<a href="#l63.195"></a><span id="l63.195">     pending.identityColl = identityQuery.getCollection(this, aResult);</span>
<a href="#l63.196"></a><span id="l63.196">     pending.identityColl.becomeExplicit();</span>
<a href="#l63.197"></a><span id="l63.197" class="difflineminus">-    </span>
<a href="#l63.198"></a><span id="l63.198" class="difflineplus">+</span>
<a href="#l63.199"></a><span id="l63.199">     aResult._contactCompleterPending = pending;</span>
<a href="#l63.200"></a><span id="l63.200"> </span>
<a href="#l63.201"></a><span id="l63.201">     return true;</span>
<a href="#l63.202"></a><span id="l63.202">   },</span>
<a href="#l63.203"></a><span id="l63.203">   onItemsAdded: function(aItems, aCollection) {</span>
<a href="#l63.204"></a><span id="l63.204">   },</span>
<a href="#l63.205"></a><span id="l63.205">   onItemsModified: function(aItems, aCollection) {</span>
<a href="#l63.206"></a><span id="l63.206">   },</span>
<a href="#l63.207"></a><span id="l63.207">   onItemsRemoved: function(aItems, aCollection) {</span>
<a href="#l63.208"></a><span id="l63.208">   },</span>
<a href="#l63.209"></a><span id="l63.209">   onQueryCompleted: function(aCollection) {</span>
<a href="#l63.210"></a><span id="l63.210">     // handle the initial setup case...</span>
<a href="#l63.211"></a><span id="l63.211">     if (aCollection.data == null) {</span>
<a href="#l63.212"></a><span id="l63.212" class="difflineminus">-      LOG.debug(&quot;CIC: Initial query found &quot; + aCollection.items.length);</span>
<a href="#l63.213"></a><span id="l63.213">       // cheat and explicitly add our own contact...</span>
<a href="#l63.214"></a><span id="l63.214">       if (!(Gloda.myContact.id in this.contactCollection._idMap))</span>
<a href="#l63.215"></a><span id="l63.215">         this.contactCollection._onItemsAdded([Gloda.myContact]);</span>
<a href="#l63.216"></a><span id="l63.216" class="difflineminus">-        </span>
<a href="#l63.217"></a><span id="l63.217" class="difflineplus">+</span>
<a href="#l63.218"></a><span id="l63.218">       // the set of identities owned by the contacts is automatically loaded as part</span>
<a href="#l63.219"></a><span id="l63.219">       //  of the contact loading...</span>
<a href="#l63.220"></a><span id="l63.220">       // (but only if we actually have any contacts)</span>
<a href="#l63.221"></a><span id="l63.221">       this.identityCollection =</span>
<a href="#l63.222"></a><span id="l63.222">         this.contactCollection.subCollections[Gloda.NOUN_IDENTITY];</span>
<a href="#l63.223"></a><span id="l63.223"> </span>
<a href="#l63.224"></a><span id="l63.224">       let contactNames = [(c.name.replace(&quot; &quot;, &quot;&quot;).toLowerCase() || &quot;x&quot;) for each</span>
<a href="#l63.225"></a><span id="l63.225">                           ([, c] in Iterator(this.contactCollection.items))];</span>
<a href="#l63.226"></a><span id="l63.226" class="difflineat">@@ -281,33 +284,31 @@ ContactIdentityCompleter.prototype = {</span>
<a href="#l63.227"></a><span id="l63.227">       // In the degenerate case where identityCollection does not exist, it will</span>
<a href="#l63.228"></a><span id="l63.228">       //  be undefined.  Calling concat with an argument of undefined simply</span>
<a href="#l63.229"></a><span id="l63.229">       //  duplicates the list we called concat on, and is thus harmless.  Our</span>
<a href="#l63.230"></a><span id="l63.230">       //  use of &amp;&amp; on identityCollection allows its undefined value to be</span>
<a href="#l63.231"></a><span id="l63.231">       //  passed through to concat.  identityMails will likewise be undefined.</span>
<a href="#l63.232"></a><span id="l63.232">       this.suffixTree = new MultiSuffixTree(contactNames.concat(identityMails),</span>
<a href="#l63.233"></a><span id="l63.233">         this.contactCollection.items.concat(this.identityCollection &amp;&amp;</span>
<a href="#l63.234"></a><span id="l63.234">           this.identityCollection.items));</span>
<a href="#l63.235"></a><span id="l63.235" class="difflineminus">-      </span>
<a href="#l63.236"></a><span id="l63.236" class="difflineplus">+</span>
<a href="#l63.237"></a><span id="l63.237">       return;</span>
<a href="#l63.238"></a><span id="l63.238">     }</span>
<a href="#l63.239"></a><span id="l63.239" class="difflineminus">-    </span>
<a href="#l63.240"></a><span id="l63.240" class="difflineminus">-    LOG.debug(&quot;CIC: LIKE query found &quot; + aCollection.items.length);</span>
<a href="#l63.241"></a><span id="l63.241" class="difflineminus">-    </span>
<a href="#l63.242"></a><span id="l63.242" class="difflineplus">+</span>
<a href="#l63.243"></a><span id="l63.243">     // handle the completion case</span>
<a href="#l63.244"></a><span id="l63.244">     let result = aCollection.data;</span>
<a href="#l63.245"></a><span id="l63.245">     let pending = result._contactCompleterPending;</span>
<a href="#l63.246"></a><span id="l63.246" class="difflineminus">-    </span>
<a href="#l63.247"></a><span id="l63.247" class="difflineplus">+</span>
<a href="#l63.248"></a><span id="l63.248">     if (--pending.pendingCount == 0) {</span>
<a href="#l63.249"></a><span id="l63.249">       let possibleDudes = [];</span>
<a href="#l63.250"></a><span id="l63.250" class="difflineminus">-      </span>
<a href="#l63.251"></a><span id="l63.251" class="difflineplus">+</span>
<a href="#l63.252"></a><span id="l63.252">       let contactToThing = pending.contactToThing;</span>
<a href="#l63.253"></a><span id="l63.253" class="difflineminus">-      </span>
<a href="#l63.254"></a><span id="l63.254" class="difflineplus">+</span>
<a href="#l63.255"></a><span id="l63.255">       let items;</span>
<a href="#l63.256"></a><span id="l63.256" class="difflineminus">-      </span>
<a href="#l63.257"></a><span id="l63.257" class="difflineplus">+</span>
<a href="#l63.258"></a><span id="l63.258">       // check identities first because they are better than contacts in terms</span>
<a href="#l63.259"></a><span id="l63.259">       //  of display</span>
<a href="#l63.260"></a><span id="l63.260">       items = pending.identityColl.items;</span>
<a href="#l63.261"></a><span id="l63.261">       for (let iIdentity = 0; iIdentity &lt; items.length; iIdentity++){</span>
<a href="#l63.262"></a><span id="l63.262">         let identity = items[iIdentity];</span>
<a href="#l63.263"></a><span id="l63.263">         if (!(identity.contactID in contactToThing)) {</span>
<a href="#l63.264"></a><span id="l63.264">           contactToThing[identity.contactID] = identity;</span>
<a href="#l63.265"></a><span id="l63.265">           possibleDudes.push(identity);</span>
<a href="#l63.266"></a><span id="l63.266" class="difflineat">@@ -318,33 +319,30 @@ ContactIdentityCompleter.prototype = {</span>
<a href="#l63.267"></a><span id="l63.267">       items = pending.contactColl.items;</span>
<a href="#l63.268"></a><span id="l63.268">       for (let iContact = 0; iContact &lt; items.length; iContact++) {</span>
<a href="#l63.269"></a><span id="l63.269">         let contact = items[iContact];</span>
<a href="#l63.270"></a><span id="l63.270">         if (!(contact.id in contactToThing)) {</span>
<a href="#l63.271"></a><span id="l63.271">           contactToThing[contact.id] = contact;</span>
<a href="#l63.272"></a><span id="l63.272">           possibleDudes.push(contact.identities[0]);</span>
<a href="#l63.273"></a><span id="l63.273">         }</span>
<a href="#l63.274"></a><span id="l63.274">       }</span>
<a href="#l63.275"></a><span id="l63.275" class="difflineminus">-      </span>
<a href="#l63.276"></a><span id="l63.276" class="difflineplus">+</span>
<a href="#l63.277"></a><span id="l63.277">       // sort in order of descending popularity</span>
<a href="#l63.278"></a><span id="l63.278">       possibleDudes.sort(this._popularitySorter);</span>
<a href="#l63.279"></a><span id="l63.279">       let rows = [new ResultRowSingle(dude, &quot;text&quot;, result.searchString)</span>
<a href="#l63.280"></a><span id="l63.280">                   for each ([iDude, dude] in Iterator(possibleDudes))];</span>
<a href="#l63.281"></a><span id="l63.281">       result.addRows(rows);</span>
<a href="#l63.282"></a><span id="l63.282">       result.markCompleted(this);</span>
<a href="#l63.283"></a><span id="l63.283" class="difflineminus">-      </span>
<a href="#l63.284"></a><span id="l63.284" class="difflineplus">+</span>
<a href="#l63.285"></a><span id="l63.285">       // the collections no longer care about the result, make it clear.</span>
<a href="#l63.286"></a><span id="l63.286">       delete pending.identityColl.data;</span>
<a href="#l63.287"></a><span id="l63.287">       delete pending.contactColl.data;</span>
<a href="#l63.288"></a><span id="l63.288">       // the result object no longer needs us or our data</span>
<a href="#l63.289"></a><span id="l63.289">       delete result._contactCompleterPending;</span>
<a href="#l63.290"></a><span id="l63.290">     }</span>
<a href="#l63.291"></a><span id="l63.291" class="difflineminus">-    else {</span>
<a href="#l63.292"></a><span id="l63.292" class="difflineminus">-      LOG.debug(&quot;ignoring... pending is still: &quot; + pending.pendingCount);</span>
<a href="#l63.293"></a><span id="l63.293" class="difflineminus">-    }</span>
<a href="#l63.294"></a><span id="l63.294">   }</span>
<a href="#l63.295"></a><span id="l63.295"> };</span>
<a href="#l63.296"></a><span id="l63.296"> </span>
<a href="#l63.297"></a><span id="l63.297"> /**</span>
<a href="#l63.298"></a><span id="l63.298">  * Complete tags that are used on contacts.</span>
<a href="#l63.299"></a><span id="l63.299">  */</span>
<a href="#l63.300"></a><span id="l63.300"> function ContactTagCompleter() {</span>
<a href="#l63.301"></a><span id="l63.301">   FreeTagNoun.populateKnownFreeTags();</span>
<a href="#l63.302"></a><span id="l63.302" class="difflineat">@@ -352,46 +350,42 @@ function ContactTagCompleter() {</span>
<a href="#l63.303"></a><span id="l63.303">   FreeTagNoun.addListener(this);</span>
<a href="#l63.304"></a><span id="l63.304"> }</span>
<a href="#l63.305"></a><span id="l63.305"> ContactTagCompleter.prototype = {</span>
<a href="#l63.306"></a><span id="l63.306">   _buildSuffixTree: function() {</span>
<a href="#l63.307"></a><span id="l63.307">     let tagNames = [], tags = [];</span>
<a href="#l63.308"></a><span id="l63.308">     for (let [tagName, tag] in Iterator(FreeTagNoun.knownFreeTags)) {</span>
<a href="#l63.309"></a><span id="l63.309">       tagNames.push(tagName.toLowerCase());</span>
<a href="#l63.310"></a><span id="l63.310">       tags.push(tag);</span>
<a href="#l63.311"></a><span id="l63.311" class="difflineminus">-      LOG.debug(&quot;contact tag: &quot; + tagName);</span>
<a href="#l63.312"></a><span id="l63.312">     }</span>
<a href="#l63.313"></a><span id="l63.313">     this._suffixTree = new MultiSuffixTree(tagNames, tags);</span>
<a href="#l63.314"></a><span id="l63.314">     this._suffixTreeDirty = false;</span>
<a href="#l63.315"></a><span id="l63.315">   },</span>
<a href="#l63.316"></a><span id="l63.316">   onFreeTagAdded: function(aTag) {</span>
<a href="#l63.317"></a><span id="l63.317">     this._suffixTreeDirty = true;</span>
<a href="#l63.318"></a><span id="l63.318">   },</span>
<a href="#l63.319"></a><span id="l63.319">   complete: function ContactTagCompleter_complete(aResult, aString) {</span>
<a href="#l63.320"></a><span id="l63.320">     // now is not the best time to do this; have onFreeTagAdded use a timer.</span>
<a href="#l63.321"></a><span id="l63.321">     if (this._suffixTreeDirty)</span>
<a href="#l63.322"></a><span id="l63.322">       this._buildSuffixTree();</span>
<a href="#l63.323"></a><span id="l63.323" class="difflineminus">-    </span>
<a href="#l63.324"></a><span id="l63.324" class="difflineplus">+</span>
<a href="#l63.325"></a><span id="l63.325">     if (aString.length &lt; 2)</span>
<a href="#l63.326"></a><span id="l63.326">       return false; // no async mechanism that will add new rows</span>
<a href="#l63.327"></a><span id="l63.327" class="difflineminus">-    </span>
<a href="#l63.328"></a><span id="l63.328" class="difflineminus">-    LOG.debug(&quot;Completing on contact tags...&quot;);</span>
<a href="#l63.329"></a><span id="l63.329" class="difflineminus">-    </span>
<a href="#l63.330"></a><span id="l63.330" class="difflineplus">+</span>
<a href="#l63.331"></a><span id="l63.331">     tags = this._suffixTree.findMatches(aString.toLowerCase());</span>
<a href="#l63.332"></a><span id="l63.332">     let rows = [];</span>
<a href="#l63.333"></a><span id="l63.333">     for each (let [iTag, tag] in Iterator(tags)) {</span>
<a href="#l63.334"></a><span id="l63.334">       let query = Gloda.newQuery(Gloda.NOUN_CONTACT);</span>
<a href="#l63.335"></a><span id="l63.335" class="difflineminus">-      LOG.debug(&quot;  checking for contact tag: &quot; + tag.name);</span>
<a href="#l63.336"></a><span id="l63.336">       query.freeTags(tag);</span>
<a href="#l63.337"></a><span id="l63.337">       let resRow = new ResultRowMulti(Gloda.NOUN_CONTACT, &quot;tag&quot;, tag.name,</span>
<a href="#l63.338"></a><span id="l63.338">                                       query);</span>
<a href="#l63.339"></a><span id="l63.339">       rows.push(resRow);</span>
<a href="#l63.340"></a><span id="l63.340">     }</span>
<a href="#l63.341"></a><span id="l63.341">     aResult.addRows(rows);</span>
<a href="#l63.342"></a><span id="l63.342" class="difflineminus">-    </span>
<a href="#l63.343"></a><span id="l63.343" class="difflineplus">+</span>
<a href="#l63.344"></a><span id="l63.344">     return false; // no async mechanism that will add new rows</span>
<a href="#l63.345"></a><span id="l63.345">   }</span>
<a href="#l63.346"></a><span id="l63.346"> };</span>
<a href="#l63.347"></a><span id="l63.347"> </span>
<a href="#l63.348"></a><span id="l63.348"> /**</span>
<a href="#l63.349"></a><span id="l63.349">  * Complete tags that are used on messages</span>
<a href="#l63.350"></a><span id="l63.350">  */</span>
<a href="#l63.351"></a><span id="l63.351"> function MessageTagCompleter() {</span>
<a href="#l63.352"></a><span id="l63.352" class="difflineat">@@ -400,107 +394,123 @@ function MessageTagCompleter() {</span>
<a href="#l63.353"></a><span id="l63.353"> MessageTagCompleter.prototype = {</span>
<a href="#l63.354"></a><span id="l63.354">   _buildSuffixTree: function MessageTagCompleter__buildSufficeTree() {</span>
<a href="#l63.355"></a><span id="l63.355">     let tagNames = [], tags = [];</span>
<a href="#l63.356"></a><span id="l63.356">     let tagArray = TagNoun.getAllTags();</span>
<a href="#l63.357"></a><span id="l63.357">     for (let iTag = 0; iTag &lt; tagArray.length; iTag++) {</span>
<a href="#l63.358"></a><span id="l63.358">       let tag = tagArray[iTag];</span>
<a href="#l63.359"></a><span id="l63.359">       tagNames.push(tag.tag.toLowerCase());</span>
<a href="#l63.360"></a><span id="l63.360">       tags.push(tag);</span>
<a href="#l63.361"></a><span id="l63.361" class="difflineminus">-      LOG.debug(&quot;message tag: &quot; + tag.tag);</span>
<a href="#l63.362"></a><span id="l63.362">     }</span>
<a href="#l63.363"></a><span id="l63.363">     this._suffixTree = new MultiSuffixTree(tagNames, tags);</span>
<a href="#l63.364"></a><span id="l63.364">     this._suffixTreeDirty = false;</span>
<a href="#l63.365"></a><span id="l63.365">   },</span>
<a href="#l63.366"></a><span id="l63.366">   complete: function MessageTagCompleter_complete(aResult, aString) {</span>
<a href="#l63.367"></a><span id="l63.367">     if (aString.length &lt; 2)</span>
<a href="#l63.368"></a><span id="l63.368">       return false;</span>
<a href="#l63.369"></a><span id="l63.369" class="difflineminus">-    </span>
<a href="#l63.370"></a><span id="l63.370" class="difflineminus">-    LOG.debug(&quot;Completing on message tags...&quot;);</span>
<a href="#l63.371"></a><span id="l63.371" class="difflineminus">-    </span>
<a href="#l63.372"></a><span id="l63.372" class="difflineplus">+</span>
<a href="#l63.373"></a><span id="l63.373">     tags = this._suffixTree.findMatches(aString.toLowerCase());</span>
<a href="#l63.374"></a><span id="l63.374">     let rows = [];</span>
<a href="#l63.375"></a><span id="l63.375">     for each (let [, tag] in Iterator(tags)) {</span>
<a href="#l63.376"></a><span id="l63.376" class="difflineminus">-      LOG.debug(&quot; found message tag: &quot; + tag.tag);</span>
<a href="#l63.377"></a><span id="l63.377">       let resRow = new ResultRowSingle(tag, &quot;tag&quot;, tag.tag, TagNoun.id);</span>
<a href="#l63.378"></a><span id="l63.378">       rows.push(resRow);</span>
<a href="#l63.379"></a><span id="l63.379">     }</span>
<a href="#l63.380"></a><span id="l63.380">     aResult.addRows(rows);</span>
<a href="#l63.381"></a><span id="l63.381" class="difflineminus">-    </span>
<a href="#l63.382"></a><span id="l63.382" class="difflineplus">+</span>
<a href="#l63.383"></a><span id="l63.383">     return false; // no async mechanism that will add new rows</span>
<a href="#l63.384"></a><span id="l63.384">   }</span>
<a href="#l63.385"></a><span id="l63.385"> };</span>
<a href="#l63.386"></a><span id="l63.386"> </span>
<a href="#l63.387"></a><span id="l63.387" class="difflineplus">+/**</span>
<a href="#l63.388"></a><span id="l63.388" class="difflineplus">+ * Complete with helpful hints about full-text search</span>
<a href="#l63.389"></a><span id="l63.389" class="difflineplus">+ */</span>
<a href="#l63.390"></a><span id="l63.390" class="difflineplus">+function FullTextCompleter() {</span>
<a href="#l63.391"></a><span id="l63.391" class="difflineplus">+}</span>
<a href="#l63.392"></a><span id="l63.392" class="difflineplus">+FullTextCompleter.prototype = {</span>
<a href="#l63.393"></a><span id="l63.393" class="difflineplus">+  complete: function FullTextCompleter_complete(aResult, aString) {</span>
<a href="#l63.394"></a><span id="l63.394" class="difflineplus">+    if (aString.length &lt; 2)</span>
<a href="#l63.395"></a><span id="l63.395" class="difflineplus">+      return false;</span>
<a href="#l63.396"></a><span id="l63.396" class="difflineplus">+    let rows = [];</span>
<a href="#l63.397"></a><span id="l63.397" class="difflineplus">+    let words = aString.trim().replace(/\s+/g, ' ').split(' ');</span>
<a href="#l63.398"></a><span id="l63.398" class="difflineplus">+    let numWords = words.length;</span>
<a href="#l63.399"></a><span id="l63.399" class="difflineplus">+    if (numWords == 1) {</span>
<a href="#l63.400"></a><span id="l63.400" class="difflineplus">+      let resRow = new ResultRowFullText(aString, words, &quot;single&quot;, false);</span>
<a href="#l63.401"></a><span id="l63.401" class="difflineplus">+      rows.push(resRow);</span>
<a href="#l63.402"></a><span id="l63.402" class="difflineplus">+    } else {</span>
<a href="#l63.403"></a><span id="l63.403" class="difflineplus">+      let resRow = new ResultRowFullText(aString, words, &quot;all&quot;, true);</span>
<a href="#l63.404"></a><span id="l63.404" class="difflineplus">+      rows.push(resRow);</span>
<a href="#l63.405"></a><span id="l63.405" class="difflineplus">+      resRow = new ResultRowFullText(aString, words, &quot;any&quot;, false);</span>
<a href="#l63.406"></a><span id="l63.406" class="difflineplus">+      rows.push(resRow);</span>
<a href="#l63.407"></a><span id="l63.407" class="difflineplus">+    }</span>
<a href="#l63.408"></a><span id="l63.408" class="difflineplus">+    aResult.addRows(rows);</span>
<a href="#l63.409"></a><span id="l63.409" class="difflineplus">+    return false; // no async mechanism that will add new rows</span>
<a href="#l63.410"></a><span id="l63.410" class="difflineplus">+  }</span>
<a href="#l63.411"></a><span id="l63.411" class="difflineplus">+};</span>
<a href="#l63.412"></a><span id="l63.412" class="difflineplus">+</span>
<a href="#l63.413"></a><span id="l63.413" class="difflineplus">+var LOG;</span>
<a href="#l63.414"></a><span id="l63.414" class="difflineplus">+</span>
<a href="#l63.415"></a><span id="l63.415"> function nsAutoCompleteGloda() {</span>
<a href="#l63.416"></a><span id="l63.416">   this.wrappedJSObject = this;</span>
<a href="#l63.417"></a><span id="l63.417" class="difflineminus">-</span>
<a href="#l63.418"></a><span id="l63.418" class="difflineminus">-  // set up our awesome globals!</span>
<a href="#l63.419"></a><span id="l63.419" class="difflineminus">-  if (Gloda === null) {</span>
<a href="#l63.420"></a><span id="l63.420" class="difflineminus">-    let loadNS = {};</span>
<a href="#l63.421"></a><span id="l63.421" class="difflineminus">-</span>
<a href="#l63.422"></a><span id="l63.422" class="difflineminus">-    Cu.import(&quot;resource://app/modules/gloda/public.js&quot;, loadNS);</span>
<a href="#l63.423"></a><span id="l63.423" class="difflineminus">-    Gloda = loadNS.Gloda;</span>
<a href="#l63.424"></a><span id="l63.424" class="difflineminus">-</span>
<a href="#l63.425"></a><span id="l63.425" class="difflineminus">-    Cu.import(&quot;resource://app/modules/gloda/utils.js&quot;, loadNS);</span>
<a href="#l63.426"></a><span id="l63.426" class="difflineminus">-    GlodaUtils = loadNS.GlodaUtils;</span>
<a href="#l63.427"></a><span id="l63.427" class="difflineminus">-    Cu.import(&quot;resource://app/modules/gloda/suffixtree.js&quot;, loadNS);</span>
<a href="#l63.428"></a><span id="l63.428" class="difflineminus">-    MultiSuffixTree = loadNS.MultiSuffixTree;</span>
<a href="#l63.429"></a><span id="l63.429" class="difflineminus">-    Cu.import(&quot;resource://app/modules/gloda/noun_tag.js&quot;, loadNS);</span>
<a href="#l63.430"></a><span id="l63.430" class="difflineminus">-    TagNoun = loadNS.TagNoun;</span>
<a href="#l63.431"></a><span id="l63.431" class="difflineminus">-    Cu.import(&quot;resource://app/modules/gloda/noun_freetag.js&quot;, loadNS);</span>
<a href="#l63.432"></a><span id="l63.432" class="difflineminus">-    FreeTagNoun = loadNS.FreeTagNoun;</span>
<a href="#l63.433"></a><span id="l63.433" class="difflineminus">-</span>
<a href="#l63.434"></a><span id="l63.434" class="difflineminus">-    Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;, loadNS);</span>
<a href="#l63.435"></a><span id="l63.435" class="difflineminus">-    LOG = loadNS[&quot;Log4Moz&quot;].repository.getLogger(&quot;gloda.autocomp&quot;);</span>
<a href="#l63.436"></a><span id="l63.436" class="difflineminus">-  }</span>
<a href="#l63.437"></a><span id="l63.437" class="difflineplus">+  try {</span>
<a href="#l63.438"></a><span id="l63.438" class="difflineplus">+    // set up our awesome globals!</span>
<a href="#l63.439"></a><span id="l63.439" class="difflineplus">+    if (Gloda === null) {</span>
<a href="#l63.440"></a><span id="l63.440" class="difflineplus">+      let loadNS = {};</span>
<a href="#l63.441"></a><span id="l63.441" class="difflineplus">+      Cu.import(&quot;resource://app/modules/gloda/public.js&quot;, loadNS);</span>
<a href="#l63.442"></a><span id="l63.442" class="difflineplus">+      Gloda = loadNS.Gloda;</span>
<a href="#l63.443"></a><span id="l63.443"> </span>
<a href="#l63.444"></a><span id="l63.444" class="difflineminus">-  LOG.debug(&quot;initializing completers&quot;);</span>
<a href="#l63.445"></a><span id="l63.445" class="difflineminus">-</span>
<a href="#l63.446"></a><span id="l63.446" class="difflineminus">-  this.completers = [];</span>
<a href="#l63.447"></a><span id="l63.447" class="difflineminus">-  </span>
<a href="#l63.448"></a><span id="l63.448" class="difflineminus">-  this.curResult = null;</span>
<a href="#l63.449"></a><span id="l63.449" class="difflineplus">+      Cu.import(&quot;resource://app/modules/gloda/utils.js&quot;, loadNS);</span>
<a href="#l63.450"></a><span id="l63.450" class="difflineplus">+      GlodaUtils = loadNS.GlodaUtils;</span>
<a href="#l63.451"></a><span id="l63.451" class="difflineplus">+      Cu.import(&quot;resource://app/modules/gloda/suffixtree.js&quot;, loadNS);</span>
<a href="#l63.452"></a><span id="l63.452" class="difflineplus">+      MultiSuffixTree = loadNS.MultiSuffixTree;</span>
<a href="#l63.453"></a><span id="l63.453" class="difflineplus">+      Cu.import(&quot;resource://app/modules/gloda/noun_tag.js&quot;, loadNS);</span>
<a href="#l63.454"></a><span id="l63.454" class="difflineplus">+      TagNoun = loadNS.TagNoun;</span>
<a href="#l63.455"></a><span id="l63.455" class="difflineplus">+      Cu.import(&quot;resource://app/modules/gloda/noun_freetag.js&quot;, loadNS);</span>
<a href="#l63.456"></a><span id="l63.456" class="difflineplus">+      FreeTagNoun = loadNS.FreeTagNoun;</span>
<a href="#l63.457"></a><span id="l63.457"> </span>
<a href="#l63.458"></a><span id="l63.458" class="difflineminus">-dump(&quot;init CIC\n&quot;);</span>
<a href="#l63.459"></a><span id="l63.459" class="difflineminus">-  LOG.debug(&quot;initializing ContactIdentityCompleter&quot;);</span>
<a href="#l63.460"></a><span id="l63.460" class="difflineminus">-  try {</span>
<a href="#l63.461"></a><span id="l63.461" class="difflineminus">-  this.completers.push(new ContactIdentityCompleter());</span>
<a href="#l63.462"></a><span id="l63.462" class="difflineminus">-  } catch (ex) {dump(&quot;CICEX: &quot; + ex.fileName + &quot;:&quot; + ex.lineNumber + &quot;: &quot; + ex);}</span>
<a href="#l63.463"></a><span id="l63.463" class="difflineminus">-dump(&quot;init CTC\n&quot;);</span>
<a href="#l63.464"></a><span id="l63.464" class="difflineminus">-  LOG.debug(&quot;initializing ContactTagCompleter&quot;);</span>
<a href="#l63.465"></a><span id="l63.465" class="difflineminus">-  this.completers.push(new ContactTagCompleter());</span>
<a href="#l63.466"></a><span id="l63.466" class="difflineminus">-dump(&quot;init MTC\n&quot;);</span>
<a href="#l63.467"></a><span id="l63.467" class="difflineminus">-  LOG.debug(&quot;initializing MessageTagCompleter&quot;);</span>
<a href="#l63.468"></a><span id="l63.468" class="difflineminus">-  try {</span>
<a href="#l63.469"></a><span id="l63.469" class="difflineminus">-  this.completers.push(new MessageTagCompleter());</span>
<a href="#l63.470"></a><span id="l63.470" class="difflineminus">-  } catch (ex) {dump(&quot;MTCEX: &quot; + ex.fileName + &quot;:&quot; + ex.lineNumber + &quot;: &quot; + ex);}</span>
<a href="#l63.471"></a><span id="l63.471" class="difflineminus">-  </span>
<a href="#l63.472"></a><span id="l63.472" class="difflineminus">-  LOG.debug(&quot;initialized completers&quot;);</span>
<a href="#l63.473"></a><span id="l63.473" class="difflineplus">+      Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;, loadNS);</span>
<a href="#l63.474"></a><span id="l63.474" class="difflineplus">+      LOG = loadNS[&quot;Log4Moz&quot;].repository.getLogger(&quot;gloda.autocomp&quot;);</span>
<a href="#l63.475"></a><span id="l63.475" class="difflineplus">+    }</span>
<a href="#l63.476"></a><span id="l63.476" class="difflineplus">+</span>
<a href="#l63.477"></a><span id="l63.477" class="difflineplus">+    this.completers = [];</span>
<a href="#l63.478"></a><span id="l63.478" class="difflineplus">+    this.curResult = null;</span>
<a href="#l63.479"></a><span id="l63.479" class="difflineplus">+</span>
<a href="#l63.480"></a><span id="l63.480" class="difflineplus">+    this.completers.push(new FullTextCompleter());</span>
<a href="#l63.481"></a><span id="l63.481" class="difflineplus">+    this.completers.push(new ContactIdentityCompleter());</span>
<a href="#l63.482"></a><span id="l63.482" class="difflineplus">+    this.completers.push(new ContactTagCompleter());</span>
<a href="#l63.483"></a><span id="l63.483" class="difflineplus">+    this.completers.push(new MessageTagCompleter());</span>
<a href="#l63.484"></a><span id="l63.484" class="difflineplus">+  } catch (e) {</span>
<a href="#l63.485"></a><span id="l63.485" class="difflineplus">+    logException(e);</span>
<a href="#l63.486"></a><span id="l63.486" class="difflineplus">+  }</span>
<a href="#l63.487"></a><span id="l63.487"> }</span>
<a href="#l63.488"></a><span id="l63.488"> </span>
<a href="#l63.489"></a><span id="l63.489"> nsAutoCompleteGloda.prototype = {</span>
<a href="#l63.490"></a><span id="l63.490">   classDescription: &quot;AutoCompleteGloda&quot;,</span>
<a href="#l63.491"></a><span id="l63.491">   contractID: &quot;@mozilla.org/autocomplete/search;1?name=gloda&quot;,</span>
<a href="#l63.492"></a><span id="l63.492" class="difflineminus">-  classID: Components.ID(&quot;{3bbe4d77-3f70-4252-9500-bc00c26f476c}&quot;),</span>
<a href="#l63.493"></a><span id="l63.493" class="difflineplus">+  classID: Components.ID(&quot;{3bbe4d77-3f70-4252-9500-bc00c26f476d}&quot;),</span>
<a href="#l63.494"></a><span id="l63.494">   QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l63.495"></a><span id="l63.495">       Components.interfaces.nsIAutoCompleteSearch]),</span>
<a href="#l63.496"></a><span id="l63.496"> </span>
<a href="#l63.497"></a><span id="l63.497">   startSearch: function(aString, aParam, aResult, aListener) {</span>
<a href="#l63.498"></a><span id="l63.498" class="difflineminus">-    let result = new nsAutoCompleteGlodaResult(aListener, this, aString);</span>
<a href="#l63.499"></a><span id="l63.499" class="difflineminus">-    // save this for hacky access to the search.  I somewhat suspect we simply</span>
<a href="#l63.500"></a><span id="l63.500" class="difflineminus">-    //  should not be using the formal autocomplete mechanism at all.</span>
<a href="#l63.501"></a><span id="l63.501" class="difflineminus">-    this.curResult = result;</span>
<a href="#l63.502"></a><span id="l63.502" class="difflineminus">-    </span>
<a href="#l63.503"></a><span id="l63.503" class="difflineminus">-    for each (let [iCompleter, completer] in Iterator(this.completers)) {</span>
<a href="#l63.504"></a><span id="l63.504" class="difflineminus">-      // they will return true if they have something pending.</span>
<a href="#l63.505"></a><span id="l63.505" class="difflineminus">-      if (completer.complete(result, aString))</span>
<a href="#l63.506"></a><span id="l63.506" class="difflineminus">-        result.markPending(completer);</span>
<a href="#l63.507"></a><span id="l63.507" class="difflineplus">+    try {</span>
<a href="#l63.508"></a><span id="l63.508" class="difflineplus">+      let result = new nsAutoCompleteGlodaResult(aListener, this, aString);</span>
<a href="#l63.509"></a><span id="l63.509" class="difflineplus">+      // save this for hacky access to the search.  I somewhat suspect we simply</span>
<a href="#l63.510"></a><span id="l63.510" class="difflineplus">+      //  should not be using the formal autocomplete mechanism at all.</span>
<a href="#l63.511"></a><span id="l63.511" class="difflineplus">+      this.curResult = result;</span>
<a href="#l63.512"></a><span id="l63.512" class="difflineplus">+</span>
<a href="#l63.513"></a><span id="l63.513" class="difflineplus">+      for each (let [iCompleter, completer] in Iterator(this.completers)) {</span>
<a href="#l63.514"></a><span id="l63.514" class="difflineplus">+        // they will return true if they have something pending.</span>
<a href="#l63.515"></a><span id="l63.515" class="difflineplus">+        if (completer.complete(result, aString))</span>
<a href="#l63.516"></a><span id="l63.516" class="difflineplus">+          result.markPending(completer);</span>
<a href="#l63.517"></a><span id="l63.517" class="difflineplus">+      }</span>
<a href="#l63.518"></a><span id="l63.518" class="difflineplus">+</span>
<a href="#l63.519"></a><span id="l63.519" class="difflineplus">+      aListener.onSearchResult(this, result);</span>
<a href="#l63.520"></a><span id="l63.520" class="difflineplus">+    } catch (e) {</span>
<a href="#l63.521"></a><span id="l63.521" class="difflineplus">+      logException(e);</span>
<a href="#l63.522"></a><span id="l63.522">     }</span>
<a href="#l63.523"></a><span id="l63.523" class="difflineminus">-    </span>
<a href="#l63.524"></a><span id="l63.524" class="difflineminus">-    aListener.onSearchResult(this, result);</span>
<a href="#l63.525"></a><span id="l63.525">   },</span>
<a href="#l63.526"></a><span id="l63.526"> </span>
<a href="#l63.527"></a><span id="l63.527">   stopSearch: function() {</span>
<a href="#l63.528"></a><span id="l63.528" class="difflineminus">-  },</span>
<a href="#l63.529"></a><span id="l63.529" class="difflineplus">+  }</span>
<a href="#l63.530"></a><span id="l63.530"> };</span>
<a href="#l63.531"></a><span id="l63.531"> </span>
<a href="#l63.532"></a><span id="l63.532"> function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l63.533"></a><span id="l63.533">   return XPCOMUtils.generateModule([nsAutoCompleteGloda]);</span>
<a href="#l63.534"></a><span id="l63.534"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/db/gloda/content/glodacomplete.css</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/db/gloda/content/glodacomplete.css</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -11,27 +11,74 @@ panel[type=&quot;glodacomplete-richlistbox&quot;] </span>
<a href="#l64.4"></a><span id="l64.4">   -moz-user-focus: ignore;</span>
<a href="#l64.5"></a><span id="l64.5">   -moz-appearance: none;</span>
<a href="#l64.6"></a><span id="l64.6"> }</span>
<a href="#l64.7"></a><span id="l64.7"> </span>
<a href="#l64.8"></a><span id="l64.8"> .autocomplete-richlistbox &gt; scrollbox {</span>
<a href="#l64.9"></a><span id="l64.9">   overflow-x: hidden !important;</span>
<a href="#l64.10"></a><span id="l64.10"> }</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12" class="difflineplus">+.explanation, .gloda-single-identity {</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+  margin-left: 1em;</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+  margin-top: 2px;</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+  margin-bottom: 2px;</span>
<a href="#l64.16"></a><span id="l64.16" class="difflineplus">+}</span>
<a href="#l64.17"></a><span id="l64.17" class="difflineplus">+</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineplus">+.ac-comment {</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineplus">+  font-size: 1.1em;</span>
<a href="#l64.20"></a><span id="l64.20" class="difflineplus">+}</span>
<a href="#l64.21"></a><span id="l64.21" class="difflineplus">+</span>
<a href="#l64.22"></a><span id="l64.22" class="difflineplus">+.ac-url-text {</span>
<a href="#l64.23"></a><span id="l64.23" class="difflineplus">+  color: -moz-nativehyperlinktext;</span>
<a href="#l64.24"></a><span id="l64.24" class="difflineplus">+  font-size: 0.95em;</span>
<a href="#l64.25"></a><span id="l64.25" class="difflineplus">+}</span>
<a href="#l64.26"></a><span id="l64.26" class="difflineplus">+</span>
<a href="#l64.27"></a><span id="l64.27" class="difflineplus">+.ac-url-text[selected=&quot;true&quot;] {</span>
<a href="#l64.28"></a><span id="l64.28" class="difflineplus">+  color: inherit !important;</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineplus">+}</span>
<a href="#l64.30"></a><span id="l64.30" class="difflineplus">+</span>
<a href="#l64.31"></a><span id="l64.31" class="difflineplus">+.gloda-single-identity[selected=&quot;true&quot;] .ac-url{</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineplus">+  color: white;</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineplus">+}</span>
<a href="#l64.34"></a><span id="l64.34" class="difflineplus">+</span>
<a href="#l64.35"></a><span id="l64.35" class="difflineplus">+.parameters {</span>
<a href="#l64.36"></a><span id="l64.36" class="difflineplus">+  font-style: italic;</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineplus">+  margin-left: 1em;</span>
<a href="#l64.38"></a><span id="l64.38" class="difflineplus">+}</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineplus">+</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineplus">+.picture {</span>
<a href="#l64.41"></a><span id="l64.41" class="difflineplus">+  /*margin-right: 1em;*/</span>
<a href="#l64.42"></a><span id="l64.42" class="difflineplus">+}</span>
<a href="#l64.43"></a><span id="l64.43" class="difflineplus">+</span>
<a href="#l64.44"></a><span id="l64.44"> .autocomplete-richlistitem[type=&quot;gloda-single-tag&quot;] {</span>
<a href="#l64.45"></a><span id="l64.45">   -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-single-tag-item&quot;);</span>
<a href="#l64.46"></a><span id="l64.46">   overflow: -moz-hidden-unscrollable;</span>
<a href="#l64.47"></a><span id="l64.47"> }</span>
<a href="#l64.48"></a><span id="l64.48"> </span>
<a href="#l64.49"></a><span id="l64.49"> .autocomplete-richlistitem[type=&quot;gloda-single-identity&quot;] {</span>
<a href="#l64.50"></a><span id="l64.50">   -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-single-identity-item&quot;);</span>
<a href="#l64.51"></a><span id="l64.51">   -moz-box-orient: vertical;</span>
<a href="#l64.52"></a><span id="l64.52">   overflow: -moz-hidden-unscrollable;</span>
<a href="#l64.53"></a><span id="l64.53"> }</span>
<a href="#l64.54"></a><span id="l64.54"> </span>
<a href="#l64.55"></a><span id="l64.55" class="difflineplus">+.autocomplete-richlistitem[type=&quot;gloda-fulltext-single&quot;] {</span>
<a href="#l64.56"></a><span id="l64.56" class="difflineplus">+  -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-fulltext-single-item&quot;);</span>
<a href="#l64.57"></a><span id="l64.57" class="difflineplus">+  overflow: -moz-hidden-unscrollable;</span>
<a href="#l64.58"></a><span id="l64.58" class="difflineplus">+}</span>
<a href="#l64.59"></a><span id="l64.59" class="difflineplus">+</span>
<a href="#l64.60"></a><span id="l64.60" class="difflineplus">+.autocomplete-richlistitem[type=&quot;gloda-fulltext-any&quot;] {</span>
<a href="#l64.61"></a><span id="l64.61" class="difflineplus">+  -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-fulltext-any-item&quot;);</span>
<a href="#l64.62"></a><span id="l64.62" class="difflineplus">+  overflow: -moz-hidden-unscrollable;</span>
<a href="#l64.63"></a><span id="l64.63" class="difflineplus">+}</span>
<a href="#l64.64"></a><span id="l64.64" class="difflineplus">+</span>
<a href="#l64.65"></a><span id="l64.65" class="difflineplus">+.autocomplete-richlistitem[type=&quot;gloda-fulltext-all&quot;] {</span>
<a href="#l64.66"></a><span id="l64.66" class="difflineplus">+  -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-fulltext-all-item&quot;);</span>
<a href="#l64.67"></a><span id="l64.67" class="difflineplus">+  overflow: -moz-hidden-unscrollable;</span>
<a href="#l64.68"></a><span id="l64.68" class="difflineplus">+}</span>
<a href="#l64.69"></a><span id="l64.69" class="difflineplus">+</span>
<a href="#l64.70"></a><span id="l64.70"> richlistitem[type=&quot;gloda-contact-chunk&quot;] {</span>
<a href="#l64.71"></a><span id="l64.71">   -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-contact-chunk&quot;);</span>
<a href="#l64.72"></a><span id="l64.72">   -moz-box-orient: vertical;</span>
<a href="#l64.73"></a><span id="l64.73">   overflow: -moz-hidden-unscrollable;</span>
<a href="#l64.74"></a><span id="l64.74"> }</span>
<a href="#l64.75"></a><span id="l64.75"> </span>
<a href="#l64.76"></a><span id="l64.76"> .autocomplete-richlistitem[type=&quot;gloda-multi&quot;] {</span>
<a href="#l64.77"></a><span id="l64.77">   -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-multi-item&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/db/gloda/content/glodacomplete.xml</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/db/gloda/content/glodacomplete.xml</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -333,17 +333,17 @@</span>
<a href="#l65.4"></a><span id="l65.4">         &lt;/body&gt;</span>
<a href="#l65.5"></a><span id="l65.5">       &lt;/method&gt;</span>
<a href="#l65.6"></a><span id="l65.6"> </span>
<a href="#l65.7"></a><span id="l65.7">     &lt;/implementation&gt;</span>
<a href="#l65.8"></a><span id="l65.8">   &lt;/binding&gt;</span>
<a href="#l65.9"></a><span id="l65.9"> </span>
<a href="#l65.10"></a><span id="l65.10">   &lt;binding id=&quot;gloda-single-tag-item&quot; extends=&quot;chrome://gloda/content/glodacomplete.xml#glodacomplete-base-richlistitem&quot;&gt;</span>
<a href="#l65.11"></a><span id="l65.11">     &lt;content orient=&quot;vertical&quot;&gt;</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-      &lt;xul:description anonid=&quot;explanation&quot;/&gt;</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+      &lt;xul:description anonid=&quot;explanation&quot; class=&quot;explanation gloda-single&quot;/&gt;</span>
<a href="#l65.14"></a><span id="l65.14">     &lt;/content&gt;</span>
<a href="#l65.15"></a><span id="l65.15">     &lt;implementation implements=&quot;nsIDOMXULSelectControlItemElement&quot;&gt;</span>
<a href="#l65.16"></a><span id="l65.16">       &lt;constructor&gt;</span>
<a href="#l65.17"></a><span id="l65.17">         &lt;![CDATA[</span>
<a href="#l65.18"></a><span id="l65.18">             this._explanation = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;explanation&quot;);</span>
<a href="#l65.19"></a><span id="l65.19"> </span>
<a href="#l65.20"></a><span id="l65.20">             this._adjustAcItem();</span>
<a href="#l65.21"></a><span id="l65.21">           ]]&gt;</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineat">@@ -355,49 +355,154 @@</span>
<a href="#l65.23"></a><span id="l65.23">             return &quot;tag &quot; + this.row.item.tag;</span>
<a href="#l65.24"></a><span id="l65.24">           ]]&gt;</span>
<a href="#l65.25"></a><span id="l65.25">         &lt;/getter&gt;</span>
<a href="#l65.26"></a><span id="l65.26">       &lt;/property&gt;</span>
<a href="#l65.27"></a><span id="l65.27">       </span>
<a href="#l65.28"></a><span id="l65.28">       &lt;method name=&quot;_adjustAcItem&quot;&gt;</span>
<a href="#l65.29"></a><span id="l65.29">         &lt;body&gt;</span>
<a href="#l65.30"></a><span id="l65.30">           &lt;![CDATA[</span>
<a href="#l65.31"></a><span id="l65.31" class="difflineminus">-          this._explanation.value = &quot;messages tagged &quot; + this.row.item.tag;</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineplus">+            let label = gGlodaCompleteStrings.get(&quot;glodaComplete.messagesTagged.label&quot;);</span>
<a href="#l65.33"></a><span id="l65.33" class="difflineplus">+            this._explanation.value = label.replace(&quot;#1&quot;, this.row.item.tag);</span>
<a href="#l65.34"></a><span id="l65.34" class="difflineplus">+          ]]&gt;</span>
<a href="#l65.35"></a><span id="l65.35" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l65.36"></a><span id="l65.36" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l65.37"></a><span id="l65.37" class="difflineplus">+    &lt;/implementation&gt;</span>
<a href="#l65.38"></a><span id="l65.38" class="difflineplus">+  &lt;/binding&gt;</span>
<a href="#l65.39"></a><span id="l65.39" class="difflineplus">+</span>
<a href="#l65.40"></a><span id="l65.40" class="difflineplus">+</span>
<a href="#l65.41"></a><span id="l65.41" class="difflineplus">+  &lt;binding id=&quot;gloda-fulltext-single-item&quot; extends=&quot;chrome://gloda/content/glodacomplete.xml#glodacomplete-base-richlistitem&quot;&gt;</span>
<a href="#l65.42"></a><span id="l65.42" class="difflineplus">+    &lt;content orient=&quot;vertical&quot;&gt;</span>
<a href="#l65.43"></a><span id="l65.43" class="difflineplus">+      &lt;xul:description anonid=&quot;explanation&quot; class=&quot;explanation gloda-fulltext-single&quot;/&gt;</span>
<a href="#l65.44"></a><span id="l65.44" class="difflineplus">+      &lt;xul:description anonid=&quot;parameters&quot;/&gt;</span>
<a href="#l65.45"></a><span id="l65.45" class="difflineplus">+    &lt;/content&gt;</span>
<a href="#l65.46"></a><span id="l65.46" class="difflineplus">+    &lt;implementation implements=&quot;nsIDOMXULSelectControlItemElement&quot;&gt;</span>
<a href="#l65.47"></a><span id="l65.47" class="difflineplus">+      &lt;constructor&gt;</span>
<a href="#l65.48"></a><span id="l65.48" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l65.49"></a><span id="l65.49" class="difflineplus">+            this._explanation = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;explanation&quot;);</span>
<a href="#l65.50"></a><span id="l65.50" class="difflineplus">+</span>
<a href="#l65.51"></a><span id="l65.51" class="difflineplus">+            this._adjustAcItem();</span>
<a href="#l65.52"></a><span id="l65.52" class="difflineplus">+          ]]&gt;</span>
<a href="#l65.53"></a><span id="l65.53" class="difflineplus">+      &lt;/constructor&gt;</span>
<a href="#l65.54"></a><span id="l65.54" class="difflineplus">+      </span>
<a href="#l65.55"></a><span id="l65.55" class="difflineplus">+      &lt;property name=&quot;label&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l65.56"></a><span id="l65.56" class="difflineplus">+        &lt;getter&gt;</span>
<a href="#l65.57"></a><span id="l65.57" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l65.58"></a><span id="l65.58" class="difflineplus">+            return &quot;full text search: &quot; + this.row.item;</span>
<a href="#l65.59"></a><span id="l65.59" class="difflineplus">+          ]]&gt;</span>
<a href="#l65.60"></a><span id="l65.60" class="difflineplus">+        &lt;/getter&gt;</span>
<a href="#l65.61"></a><span id="l65.61" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l65.62"></a><span id="l65.62" class="difflineplus">+      </span>
<a href="#l65.63"></a><span id="l65.63" class="difflineplus">+      &lt;method name=&quot;_adjustAcItem&quot;&gt;</span>
<a href="#l65.64"></a><span id="l65.64" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l65.65"></a><span id="l65.65" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l65.66"></a><span id="l65.66" class="difflineplus">+            let label = gGlodaCompleteStrings.get(&quot;glodaComplete.messagesMentioning.label&quot;);</span>
<a href="#l65.67"></a><span id="l65.67" class="difflineplus">+            this._explanation.value = label.replace(&quot;#1&quot;, this.row.item);</span>
<a href="#l65.68"></a><span id="l65.68" class="difflineplus">+          ]]&gt;</span>
<a href="#l65.69"></a><span id="l65.69" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l65.70"></a><span id="l65.70" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l65.71"></a><span id="l65.71" class="difflineplus">+    &lt;/implementation&gt;</span>
<a href="#l65.72"></a><span id="l65.72" class="difflineplus">+  &lt;/binding&gt;</span>
<a href="#l65.73"></a><span id="l65.73" class="difflineplus">+</span>
<a href="#l65.74"></a><span id="l65.74" class="difflineplus">+</span>
<a href="#l65.75"></a><span id="l65.75" class="difflineplus">+</span>
<a href="#l65.76"></a><span id="l65.76" class="difflineplus">+  &lt;binding id=&quot;gloda-fulltext-any-item&quot; extends=&quot;chrome://gloda/content/glodacomplete.xml#glodacomplete-base-richlistitem&quot;&gt;</span>
<a href="#l65.77"></a><span id="l65.77" class="difflineplus">+    &lt;content orient=&quot;vertical&quot;&gt;</span>
<a href="#l65.78"></a><span id="l65.78" class="difflineplus">+      &lt;xul:description anonid=&quot;explanation&quot; class=&quot;explanation&quot;/&gt;</span>
<a href="#l65.79"></a><span id="l65.79" class="difflineplus">+      &lt;xul:description anonid=&quot;parameters&quot; class=&quot;parameters&quot;/&gt;</span>
<a href="#l65.80"></a><span id="l65.80" class="difflineplus">+    &lt;/content&gt;</span>
<a href="#l65.81"></a><span id="l65.81" class="difflineplus">+    &lt;implementation implements=&quot;nsIDOMXULSelectControlItemElement&quot;&gt;</span>
<a href="#l65.82"></a><span id="l65.82" class="difflineplus">+      &lt;constructor&gt;</span>
<a href="#l65.83"></a><span id="l65.83" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l65.84"></a><span id="l65.84" class="difflineplus">+            this._explanation = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;explanation&quot;);</span>
<a href="#l65.85"></a><span id="l65.85" class="difflineplus">+            this._parameters = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;parameters&quot;);</span>
<a href="#l65.86"></a><span id="l65.86" class="difflineplus">+</span>
<a href="#l65.87"></a><span id="l65.87" class="difflineplus">+            this._adjustAcItem();</span>
<a href="#l65.88"></a><span id="l65.88" class="difflineplus">+          ]]&gt;</span>
<a href="#l65.89"></a><span id="l65.89" class="difflineplus">+      &lt;/constructor&gt;</span>
<a href="#l65.90"></a><span id="l65.90" class="difflineplus">+      </span>
<a href="#l65.91"></a><span id="l65.91" class="difflineplus">+      &lt;property name=&quot;label&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l65.92"></a><span id="l65.92" class="difflineplus">+        &lt;getter&gt;</span>
<a href="#l65.93"></a><span id="l65.93" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l65.94"></a><span id="l65.94" class="difflineplus">+            return &quot;full text search: &quot; + this.row.item;</span>
<a href="#l65.95"></a><span id="l65.95" class="difflineplus">+          ]]&gt;</span>
<a href="#l65.96"></a><span id="l65.96" class="difflineplus">+        &lt;/getter&gt;</span>
<a href="#l65.97"></a><span id="l65.97" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l65.98"></a><span id="l65.98" class="difflineplus">+      </span>
<a href="#l65.99"></a><span id="l65.99" class="difflineplus">+      &lt;method name=&quot;_adjustAcItem&quot;&gt;</span>
<a href="#l65.100"></a><span id="l65.100" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l65.101"></a><span id="l65.101" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l65.102"></a><span id="l65.102" class="difflineplus">+          this._explanation.value = gGlodaCompleteStrings.get(&quot;glodaComplete.messagesWithAny.label&quot;);</span>
<a href="#l65.103"></a><span id="l65.103" class="difflineplus">+          this._parameters.value = this.row.words.join(&quot;, &quot;);</span>
<a href="#l65.104"></a><span id="l65.104" class="difflineplus">+          ]]&gt;</span>
<a href="#l65.105"></a><span id="l65.105" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l65.106"></a><span id="l65.106" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l65.107"></a><span id="l65.107" class="difflineplus">+    &lt;/implementation&gt;</span>
<a href="#l65.108"></a><span id="l65.108" class="difflineplus">+  &lt;/binding&gt;</span>
<a href="#l65.109"></a><span id="l65.109" class="difflineplus">+</span>
<a href="#l65.110"></a><span id="l65.110" class="difflineplus">+  &lt;binding id=&quot;gloda-fulltext-all-item&quot; extends=&quot;chrome://gloda/content/glodacomplete.xml#glodacomplete-base-richlistitem&quot;&gt;</span>
<a href="#l65.111"></a><span id="l65.111" class="difflineplus">+    &lt;content orient=&quot;vertical&quot;&gt;</span>
<a href="#l65.112"></a><span id="l65.112" class="difflineplus">+      &lt;xul:description anonid=&quot;explanation&quot; class=&quot;explanation&quot;/&gt;</span>
<a href="#l65.113"></a><span id="l65.113" class="difflineplus">+      &lt;xul:description anonid=&quot;parameters&quot; class=&quot;parameters&quot;/&gt;</span>
<a href="#l65.114"></a><span id="l65.114" class="difflineplus">+    &lt;/content&gt;</span>
<a href="#l65.115"></a><span id="l65.115" class="difflineplus">+    &lt;implementation implements=&quot;nsIDOMXULSelectControlItemElement&quot;&gt;</span>
<a href="#l65.116"></a><span id="l65.116" class="difflineplus">+      &lt;constructor&gt;</span>
<a href="#l65.117"></a><span id="l65.117" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l65.118"></a><span id="l65.118" class="difflineplus">+            this._explanation = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;explanation&quot;);</span>
<a href="#l65.119"></a><span id="l65.119" class="difflineplus">+            this._parameters = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;parameters&quot;);</span>
<a href="#l65.120"></a><span id="l65.120" class="difflineplus">+</span>
<a href="#l65.121"></a><span id="l65.121" class="difflineplus">+            this._adjustAcItem();</span>
<a href="#l65.122"></a><span id="l65.122" class="difflineplus">+          ]]&gt;</span>
<a href="#l65.123"></a><span id="l65.123" class="difflineplus">+      &lt;/constructor&gt;</span>
<a href="#l65.124"></a><span id="l65.124" class="difflineplus">+      </span>
<a href="#l65.125"></a><span id="l65.125" class="difflineplus">+      &lt;property name=&quot;label&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l65.126"></a><span id="l65.126" class="difflineplus">+        &lt;getter&gt;</span>
<a href="#l65.127"></a><span id="l65.127" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l65.128"></a><span id="l65.128" class="difflineplus">+            return &quot;full text search: &quot; + this.row.item; // what is this for? l10n?</span>
<a href="#l65.129"></a><span id="l65.129" class="difflineplus">+          ]]&gt;</span>
<a href="#l65.130"></a><span id="l65.130" class="difflineplus">+        &lt;/getter&gt;</span>
<a href="#l65.131"></a><span id="l65.131" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l65.132"></a><span id="l65.132" class="difflineplus">+      </span>
<a href="#l65.133"></a><span id="l65.133" class="difflineplus">+      &lt;method name=&quot;_adjustAcItem&quot;&gt;</span>
<a href="#l65.134"></a><span id="l65.134" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l65.135"></a><span id="l65.135" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l65.136"></a><span id="l65.136" class="difflineplus">+          this._explanation.value = gGlodaCompleteStrings.get(&quot;glodaComplete.messagesWithAll.label&quot;);</span>
<a href="#l65.137"></a><span id="l65.137" class="difflineplus">+          this._parameters.value = this.row.words.join(&quot;, &quot;);</span>
<a href="#l65.138"></a><span id="l65.138">           ]]&gt;</span>
<a href="#l65.139"></a><span id="l65.139">         &lt;/body&gt;</span>
<a href="#l65.140"></a><span id="l65.140">       &lt;/method&gt;</span>
<a href="#l65.141"></a><span id="l65.141">     &lt;/implementation&gt;</span>
<a href="#l65.142"></a><span id="l65.142">   &lt;/binding&gt;</span>
<a href="#l65.143"></a><span id="l65.143"> </span>
<a href="#l65.144"></a><span id="l65.144">   &lt;binding id=&quot;gloda-single-identity-item&quot; extends=&quot;chrome://gloda/content/glodacomplete.xml#glodacomplete-base-richlistitem&quot;&gt;</span>
<a href="#l65.145"></a><span id="l65.145">     &lt;content&gt;</span>
<a href="#l65.146"></a><span id="l65.146" class="difflineminus">-      &lt;xul:hbox&gt;</span>
<a href="#l65.147"></a><span id="l65.147" class="difflineminus">-	    &lt;xul:image anonid=&quot;picture&quot;/&gt;</span>
<a href="#l65.148"></a><span id="l65.148" class="difflineminus">-	    &lt;xul:vbox&gt;</span>
<a href="#l65.149"></a><span id="l65.149" class="difflineminus">-	      &lt;xul:hbox&gt;</span>
<a href="#l65.150"></a><span id="l65.150" class="difflineminus">-	        &lt;xul:hbox anonid=&quot;name-box&quot; class=&quot;ac-title&quot; flex=&quot;1&quot;</span>
<a href="#l65.151"></a><span id="l65.151" class="difflineminus">-	                  onunderflow=&quot;_doUnderflow('_name');&quot;&gt;</span>
<a href="#l65.152"></a><span id="l65.152" class="difflineminus">-	          &lt;xul:description anonid=&quot;name&quot; class=&quot;ac-normal-text ac-comment&quot;</span>
<a href="#l65.153"></a><span id="l65.153" class="difflineminus">-	                           xbl:inherits=&quot;selected&quot;/&gt;</span>
<a href="#l65.154"></a><span id="l65.154" class="difflineminus">-	        &lt;/xul:hbox&gt;</span>
<a href="#l65.155"></a><span id="l65.155" class="difflineminus">-	        &lt;xul:label anonid=&quot;name-overflow-ellipsis&quot; xbl:inherits=&quot;selected&quot;</span>
<a href="#l65.156"></a><span id="l65.156" class="difflineminus">-	                   class=&quot;ac-ellipsis-after ac-comment&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l65.157"></a><span id="l65.157" class="difflineminus">-	      &lt;/xul:hbox&gt;</span>
<a href="#l65.158"></a><span id="l65.158" class="difflineminus">-	      &lt;xul:hbox&gt;</span>
<a href="#l65.159"></a><span id="l65.159" class="difflineminus">-	        &lt;xul:hbox anonid=&quot;identity-box&quot; class=&quot;ac-url&quot; flex=&quot;1&quot;</span>
<a href="#l65.160"></a><span id="l65.160" class="difflineminus">-	                  onunderflow=&quot;_doUnderflow('_identity');&quot;&gt;</span>
<a href="#l65.161"></a><span id="l65.161" class="difflineminus">-	          &lt;xul:description anonid=&quot;identity&quot; class=&quot;ac-normal-text ac-url-text&quot;</span>
<a href="#l65.162"></a><span id="l65.162" class="difflineminus">-	                           xbl:inherits=&quot;selected&quot;/&gt;</span>
<a href="#l65.163"></a><span id="l65.163" class="difflineminus">-	        &lt;/xul:hbox&gt;</span>
<a href="#l65.164"></a><span id="l65.164" class="difflineminus">-	        &lt;xul:label anonid=&quot;identity-overflow-ellipsis&quot; xbl:inherits=&quot;selected&quot;</span>
<a href="#l65.165"></a><span id="l65.165" class="difflineminus">-	                   class=&quot;ac-ellipsis-after ac-url-text&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l65.166"></a><span id="l65.166" class="difflineminus">-	        &lt;xul:image anonid=&quot;type-image&quot; class=&quot;ac-type-icon&quot;/&gt;</span>
<a href="#l65.167"></a><span id="l65.167" class="difflineminus">-	      &lt;/xul:hbox&gt;</span>
<a href="#l65.168"></a><span id="l65.168" class="difflineminus">-	    &lt;/xul:vbox&gt;</span>
<a href="#l65.169"></a><span id="l65.169" class="difflineminus">-	  &lt;/xul:hbox&gt;</span>
<a href="#l65.170"></a><span id="l65.170" class="difflineplus">+      &lt;xul:hbox class=&quot;gloda-single-identity&quot;&gt;</span>
<a href="#l65.171"></a><span id="l65.171" class="difflineplus">+        &lt;xul:image anonid=&quot;picture&quot; class=&quot;picture&quot;/&gt;</span>
<a href="#l65.172"></a><span id="l65.172" class="difflineplus">+        &lt;xul:vbox&gt;</span>
<a href="#l65.173"></a><span id="l65.173" class="difflineplus">+          &lt;xul:hbox&gt;</span>
<a href="#l65.174"></a><span id="l65.174" class="difflineplus">+            &lt;xul:hbox anonid=&quot;name-box&quot; class=&quot;ac-title&quot; flex=&quot;1&quot;</span>
<a href="#l65.175"></a><span id="l65.175" class="difflineplus">+                      onunderflow=&quot;_doUnderflow('_name');&quot;&gt;</span>
<a href="#l65.176"></a><span id="l65.176" class="difflineplus">+              &lt;xul:description anonid=&quot;name&quot; class=&quot;ac-normal-text ac-comment&quot;</span>
<a href="#l65.177"></a><span id="l65.177" class="difflineplus">+                               xbl:inherits=&quot;selected&quot;/&gt;</span>
<a href="#l65.178"></a><span id="l65.178" class="difflineplus">+            &lt;/xul:hbox&gt;</span>
<a href="#l65.179"></a><span id="l65.179" class="difflineplus">+            &lt;xul:label anonid=&quot;name-overflow-ellipsis&quot; xbl:inherits=&quot;selected&quot;</span>
<a href="#l65.180"></a><span id="l65.180" class="difflineplus">+                       class=&quot;ac-ellipsis-after ac-comment&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l65.181"></a><span id="l65.181" class="difflineplus">+          &lt;/xul:hbox&gt;</span>
<a href="#l65.182"></a><span id="l65.182" class="difflineplus">+          &lt;xul:hbox&gt;</span>
<a href="#l65.183"></a><span id="l65.183" class="difflineplus">+            &lt;xul:hbox anonid=&quot;identity-box&quot; class=&quot;ac-url&quot; flex=&quot;1&quot;</span>
<a href="#l65.184"></a><span id="l65.184" class="difflineplus">+                      onunderflow=&quot;_doUnderflow('_identity');&quot;&gt;</span>
<a href="#l65.185"></a><span id="l65.185" class="difflineplus">+              &lt;xul:description anonid=&quot;identity&quot; class=&quot;ac-normal-text ac-url-text&quot;</span>
<a href="#l65.186"></a><span id="l65.186" class="difflineplus">+                               xbl:inherits=&quot;selected&quot;/&gt;</span>
<a href="#l65.187"></a><span id="l65.187" class="difflineplus">+            &lt;/xul:hbox&gt;</span>
<a href="#l65.188"></a><span id="l65.188" class="difflineplus">+            &lt;xul:label anonid=&quot;identity-overflow-ellipsis&quot; xbl:inherits=&quot;selected&quot;</span>
<a href="#l65.189"></a><span id="l65.189" class="difflineplus">+                       class=&quot;ac-ellipsis-after ac-url-text&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l65.190"></a><span id="l65.190" class="difflineplus">+            &lt;xul:image anonid=&quot;type-image&quot; class=&quot;ac-type-icon&quot;/&gt;</span>
<a href="#l65.191"></a><span id="l65.191" class="difflineplus">+          &lt;/xul:hbox&gt;</span>
<a href="#l65.192"></a><span id="l65.192" class="difflineplus">+        &lt;/xul:vbox&gt;</span>
<a href="#l65.193"></a><span id="l65.193" class="difflineplus">+      &lt;/xul:hbox&gt;</span>
<a href="#l65.194"></a><span id="l65.194">     &lt;/content&gt;</span>
<a href="#l65.195"></a><span id="l65.195">     &lt;implementation implements=&quot;nsIDOMXULSelectControlItemElement&quot;&gt;</span>
<a href="#l65.196"></a><span id="l65.196">       &lt;constructor&gt;</span>
<a href="#l65.197"></a><span id="l65.197">         &lt;![CDATA[</span>
<a href="#l65.198"></a><span id="l65.198">             let ellipsis = &quot;\u2026&quot;;</span>
<a href="#l65.199"></a><span id="l65.199">             try {</span>
<a href="#l65.200"></a><span id="l65.200">               ellipsis = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l65.201"></a><span id="l65.201">                 getService(Components.interfaces.nsIPrefBranch).</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/db/gloda/modules/collection.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/collection.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -592,16 +592,17 @@ GlodaCollection.prototype = {</span>
<a href="#l66.4"></a><span id="l66.4">       catch (ex) {</span>
<a href="#l66.5"></a><span id="l66.5">         LOG.error(&quot;caught exception from listener in onItemsRemoved: &quot; +</span>
<a href="#l66.6"></a><span id="l66.6">             ex.fileName + &quot;:&quot; + ex.lineNumber + &quot;: &quot; + ex);</span>
<a href="#l66.7"></a><span id="l66.7">       }</span>
<a href="#l66.8"></a><span id="l66.8">     }</span>
<a href="#l66.9"></a><span id="l66.9">   },</span>
<a href="#l66.10"></a><span id="l66.10"> </span>
<a href="#l66.11"></a><span id="l66.11">   _onQueryCompleted: function gloda_coll_onQueryCompleted() {</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineplus">+    this.query.completed = true;</span>
<a href="#l66.13"></a><span id="l66.13">     if (this._listener &amp;&amp; this._listener.onQueryCompleted)</span>
<a href="#l66.14"></a><span id="l66.14">       this._listener.onQueryCompleted(this);</span>
<a href="#l66.15"></a><span id="l66.15">   }</span>
<a href="#l66.16"></a><span id="l66.16"> };</span>
<a href="#l66.17"></a><span id="l66.17"> </span>
<a href="#l66.18"></a><span id="l66.18"> /**</span>
<a href="#l66.19"></a><span id="l66.19">  * Create an LRU cache collection for the given noun with the given size.</span>
<a href="#l66.20"></a><span id="l66.20">  * @constructor</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -201,16 +201,20 @@ GlodaConversation.prototype = {</span>
<a href="#l67.4"></a><span id="l67.4">     let query = new GlodaMessage.prototype.NOUN_DEF.queryClass();</span>
<a href="#l67.5"></a><span id="l67.5">     query.conversation(this._id).orderBy(&quot;date&quot;);</span>
<a href="#l67.6"></a><span id="l67.6">     return query.getCollection(aListener, aData);</span>
<a href="#l67.7"></a><span id="l67.7">   },</span>
<a href="#l67.8"></a><span id="l67.8"> </span>
<a href="#l67.9"></a><span id="l67.9">   toString: function gloda_conversation_toString() {</span>
<a href="#l67.10"></a><span id="l67.10">     return &quot;Conversation:&quot; + this._id;</span>
<a href="#l67.11"></a><span id="l67.11">   },</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineplus">+</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+  toLocaleString: function gloda_conversation_toLocaleString() {</span>
<a href="#l67.14"></a><span id="l67.14" class="difflineplus">+    return this._subject;</span>
<a href="#l67.15"></a><span id="l67.15" class="difflineplus">+  }</span>
<a href="#l67.16"></a><span id="l67.16"> };</span>
<a href="#l67.17"></a><span id="l67.17"> </span>
<a href="#l67.18"></a><span id="l67.18"> function GlodaFolder(aDatastore, aID, aURI, aDirtyStatus, aPrettyName,</span>
<a href="#l67.19"></a><span id="l67.19">                      aIndexingPriority) {</span>
<a href="#l67.20"></a><span id="l67.20">   this._datastore = aDatastore;</span>
<a href="#l67.21"></a><span id="l67.21">   this._id = aID;</span>
<a href="#l67.22"></a><span id="l67.22">   this._uri = aURI;</span>
<a href="#l67.23"></a><span id="l67.23">   this._dirtyStatus = aDirtyStatus;</span>
<a href="#l67.24"></a><span id="l67.24" class="difflineat">@@ -260,24 +264,35 @@ GlodaFolder.prototype = {</span>
<a href="#l67.25"></a><span id="l67.25">       this._datastore.updateFolderDirtyStatus(this);</span>
<a href="#l67.26"></a><span id="l67.26">     }</span>
<a href="#l67.27"></a><span id="l67.27">   },</span>
<a href="#l67.28"></a><span id="l67.28">   get name() { return this._prettyName; },</span>
<a href="#l67.29"></a><span id="l67.29">   toString: function gloda_folder_toString() {</span>
<a href="#l67.30"></a><span id="l67.30">     return &quot;Folder:&quot; + this._id;</span>
<a href="#l67.31"></a><span id="l67.31">   },</span>
<a href="#l67.32"></a><span id="l67.32"> </span>
<a href="#l67.33"></a><span id="l67.33" class="difflineplus">+  toLocaleString: function gloda_folder_toLocaleString() {</span>
<a href="#l67.34"></a><span id="l67.34" class="difflineplus">+    let xpcomFolder = this.getXPCOMFolder(this.kActivityFolderOnlyNoData);</span>
<a href="#l67.35"></a><span id="l67.35" class="difflineplus">+    if (!xpcomFolder)</span>
<a href="#l67.36"></a><span id="l67.36" class="difflineplus">+      return this._prettyName;</span>
<a href="#l67.37"></a><span id="l67.37" class="difflineplus">+    return xpcomFolder.prettiestName +</span>
<a href="#l67.38"></a><span id="l67.38" class="difflineplus">+      &quot; (&quot; + xpcomFolder.rootFolder.prettiestName + &quot;)&quot;;</span>
<a href="#l67.39"></a><span id="l67.39" class="difflineplus">+  },</span>
<a href="#l67.40"></a><span id="l67.40" class="difflineplus">+</span>
<a href="#l67.41"></a><span id="l67.41">   get indexingPriority() {</span>
<a href="#l67.42"></a><span id="l67.42">     return this._indexingPriority;</span>
<a href="#l67.43"></a><span id="l67.43">   },</span>
<a href="#l67.44"></a><span id="l67.44"> </span>
<a href="#l67.45"></a><span id="l67.45">   /** We are going to index this folder. */</span>
<a href="#l67.46"></a><span id="l67.46">   kActivityIndexing: 0,</span>
<a href="#l67.47"></a><span id="l67.47">   /** Asking for the folder to perform header retrievals. */</span>
<a href="#l67.48"></a><span id="l67.48">   kActivityHeaderRetrieval: 1,</span>
<a href="#l67.49"></a><span id="l67.49" class="difflineplus">+  /** We only want the folder for its metadata but are not going to open it. */</span>
<a href="#l67.50"></a><span id="l67.50" class="difflineplus">+  kActivityFolderOnlyNoData: 2,</span>
<a href="#l67.51"></a><span id="l67.51" class="difflineplus">+</span>
<a href="#l67.52"></a><span id="l67.52"> </span>
<a href="#l67.53"></a><span id="l67.53">   /** Is this folder known to be actively used for indexing? */</span>
<a href="#l67.54"></a><span id="l67.54">   _activeIndexing: false,</span>
<a href="#l67.55"></a><span id="l67.55">   /** Get our indexing status. */</span>
<a href="#l67.56"></a><span id="l67.56">   get indexing() {</span>
<a href="#l67.57"></a><span id="l67.57">     return this._activeIndexing;</span>
<a href="#l67.58"></a><span id="l67.58">   },</span>
<a href="#l67.59"></a><span id="l67.59">   /**</span>
<a href="#l67.60"></a><span id="l67.60" class="difflineat">@@ -319,16 +334,19 @@ GlodaFolder.prototype = {</span>
<a href="#l67.61"></a><span id="l67.61">         //  that independently and only for header retrieval.</span>
<a href="#l67.62"></a><span id="l67.62">         this.indexing = true;</span>
<a href="#l67.63"></a><span id="l67.63">         break;</span>
<a href="#l67.64"></a><span id="l67.64">       case this.kActivityHeaderRetrieval:</span>
<a href="#l67.65"></a><span id="l67.65">         if (this._activeHeaderRetrievalLastStamp === 0)</span>
<a href="#l67.66"></a><span id="l67.66">           this._datastore.markFolderLive(this);</span>
<a href="#l67.67"></a><span id="l67.67">         this._activeHeaderRetrievalLastStamp = Date.now();</span>
<a href="#l67.68"></a><span id="l67.68">         break;</span>
<a href="#l67.69"></a><span id="l67.69" class="difflineplus">+      case this.kActivityFolderOnlyNoData:</span>
<a href="#l67.70"></a><span id="l67.70" class="difflineplus">+        // we don't have to do anything here.</span>
<a href="#l67.71"></a><span id="l67.71" class="difflineplus">+        break;</span>
<a href="#l67.72"></a><span id="l67.72">     }</span>
<a href="#l67.73"></a><span id="l67.73"> </span>
<a href="#l67.74"></a><span id="l67.74">     return this._xpcomFolder;</span>
<a href="#l67.75"></a><span id="l67.75">   },</span>
<a href="#l67.76"></a><span id="l67.76"> </span>
<a href="#l67.77"></a><span id="l67.77">   /**</span>
<a href="#l67.78"></a><span id="l67.78">    * How many milliseconds must a folder have not had any header retrieval</span>
<a href="#l67.79"></a><span id="l67.79">    *  activity before it's okay to lose the database reference?</span>
<a href="#l67.80"></a><span id="l67.80" class="difflineat">@@ -624,16 +642,22 @@ GlodaIdentity.prototype = {</span>
<a href="#l67.81"></a><span id="l67.81">   get uniqueValue() {</span>
<a href="#l67.82"></a><span id="l67.82">     return this._kind + &quot;@&quot; + this._value;</span>
<a href="#l67.83"></a><span id="l67.83">   },</span>
<a href="#l67.84"></a><span id="l67.84"> </span>
<a href="#l67.85"></a><span id="l67.85">   toString: function gloda_identity_toString() {</span>
<a href="#l67.86"></a><span id="l67.86">     return &quot;Identity:&quot; + this._kind + &quot;:&quot; + this._value;</span>
<a href="#l67.87"></a><span id="l67.87">   },</span>
<a href="#l67.88"></a><span id="l67.88"> </span>
<a href="#l67.89"></a><span id="l67.89" class="difflineplus">+  toLocaleString: function gloda_identity_toLocaleString() {</span>
<a href="#l67.90"></a><span id="l67.90" class="difflineplus">+    if (this.contact.name == this.value)</span>
<a href="#l67.91"></a><span id="l67.91" class="difflineplus">+      return this.value;</span>
<a href="#l67.92"></a><span id="l67.92" class="difflineplus">+    return this.contact.name + &quot; : &quot; + this.value;</span>
<a href="#l67.93"></a><span id="l67.93" class="difflineplus">+  },</span>
<a href="#l67.94"></a><span id="l67.94" class="difflineplus">+</span>
<a href="#l67.95"></a><span id="l67.95">   get abCard() {</span>
<a href="#l67.96"></a><span id="l67.96">     // for our purposes, the address book only speaks email</span>
<a href="#l67.97"></a><span id="l67.97">     if (this._kind != &quot;email&quot;)</span>
<a href="#l67.98"></a><span id="l67.98">       return false;</span>
<a href="#l67.99"></a><span id="l67.99">     let card = GlodaUtils.getCardForEmail(this._value);</span>
<a href="#l67.100"></a><span id="l67.100">     if (card)</span>
<a href="#l67.101"></a><span id="l67.101">       this._hasAddressBookCard = true;</span>
<a href="#l67.102"></a><span id="l67.102">     return card;</span>
<a href="#l67.103"></a><span id="l67.103" class="difflineat">@@ -648,14 +672,14 @@ GlodaIdentity.prototype = {</span>
<a href="#l67.104"></a><span id="l67.104">    */</span>
<a href="#l67.105"></a><span id="l67.105">   get inAddressBook() {</span>
<a href="#l67.106"></a><span id="l67.106">     if (this._hasAddressBookCard)</span>
<a href="#l67.107"></a><span id="l67.107">       return true;</span>
<a href="#l67.108"></a><span id="l67.108">     return this.abCard &amp;&amp; true;</span>
<a href="#l67.109"></a><span id="l67.109">   },</span>
<a href="#l67.110"></a><span id="l67.110"> </span>
<a href="#l67.111"></a><span id="l67.111">   pictureURL: function(aSize) {</span>
<a href="#l67.112"></a><span id="l67.112" class="difflineminus">-    let md5hash = GlodaUtils.md5HashString(this._value);</span>
<a href="#l67.113"></a><span id="l67.113" class="difflineminus">-    let gravURL = &quot;http://www.gravatar.com/avatar/&quot; + md5hash +</span>
<a href="#l67.114"></a><span id="l67.114" class="difflineminus">-                                &quot;?d=identicon&amp;s=&quot; + aSize + &quot;&amp;r=g&quot;;</span>
<a href="#l67.115"></a><span id="l67.115" class="difflineminus">-    return gravURL;</span>
<a href="#l67.116"></a><span id="l67.116" class="difflineplus">+    if (this.inAddressBook) {</span>
<a href="#l67.117"></a><span id="l67.117" class="difflineplus">+      // XXX should get the photo if we have it.</span>
<a href="#l67.118"></a><span id="l67.118" class="difflineplus">+    }</span>
<a href="#l67.119"></a><span id="l67.119" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l67.120"></a><span id="l67.120">   }</span>
<a href="#l67.121"></a><span id="l67.121"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -503,17 +503,17 @@ var GlodaDatastore = {</span>
<a href="#l68.4"></a><span id="l68.4">   kConstraintIn: 1,</span>
<a href="#l68.5"></a><span id="l68.5">   kConstraintRanges: 2,</span>
<a href="#l68.6"></a><span id="l68.6">   kConstraintEquals: 3,</span>
<a href="#l68.7"></a><span id="l68.7">   kConstraintStringLike: 4,</span>
<a href="#l68.8"></a><span id="l68.8">   kConstraintFulltext: 5,</span>
<a href="#l68.9"></a><span id="l68.9"> </span>
<a href="#l68.10"></a><span id="l68.10">   /* ******************* SCHEMA ******************* */</span>
<a href="#l68.11"></a><span id="l68.11"> </span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-  _schemaVersion: 12,</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+  _schemaVersion: 13,</span>
<a href="#l68.14"></a><span id="l68.14">   _schema: {</span>
<a href="#l68.15"></a><span id="l68.15">     tables: {</span>
<a href="#l68.16"></a><span id="l68.16"> </span>
<a href="#l68.17"></a><span id="l68.17">       // ----- Messages</span>
<a href="#l68.18"></a><span id="l68.18">       folderLocations: {</span>
<a href="#l68.19"></a><span id="l68.19">         columns: [</span>
<a href="#l68.20"></a><span id="l68.20">           [&quot;id&quot;, &quot;INTEGER PRIMARY KEY&quot;],</span>
<a href="#l68.21"></a><span id="l68.21">           [&quot;folderURI&quot;, &quot;TEXT NOT NULL&quot;],</span>
<a href="#l68.22"></a><span id="l68.22" class="difflineat">@@ -938,16 +938,19 @@ var GlodaDatastore = {</span>
<a href="#l68.23"></a><span id="l68.23"> </span>
<a href="#l68.24"></a><span id="l68.24">     aDBConnection.schemaVersion = this._schemaVersion;</span>
<a href="#l68.25"></a><span id="l68.25">   },</span>
<a href="#l68.26"></a><span id="l68.26"> </span>
<a href="#l68.27"></a><span id="l68.27">   /**</span>
<a href="#l68.28"></a><span id="l68.28">    * Create a table for a noun, replete with data binding.</span>
<a href="#l68.29"></a><span id="l68.29">    */</span>
<a href="#l68.30"></a><span id="l68.30">   createNounTable: function gloda_ds_createTableIfNotExists(aNounDef) {</span>
<a href="#l68.31"></a><span id="l68.31" class="difflineplus">+    // give it a _jsonText attribute if appropriate...</span>
<a href="#l68.32"></a><span id="l68.32" class="difflineplus">+    if (aNounDef.allowsArbitraryAttrs)</span>
<a href="#l68.33"></a><span id="l68.33" class="difflineplus">+      aNounDef.schema.columns.push(['jsonAttributes', 'STRING', '_jsonText']);</span>
<a href="#l68.34"></a><span id="l68.34">     // check if the table exists</span>
<a href="#l68.35"></a><span id="l68.35">     if (!this.asyncConnection.tableExists(aNounDef.tableName)) {</span>
<a href="#l68.36"></a><span id="l68.36">       // it doesn't! create it (and its potentially many variants)</span>
<a href="#l68.37"></a><span id="l68.37">       try {</span>
<a href="#l68.38"></a><span id="l68.38">         this._createTableSchema(this.asyncConnection, aNounDef.tableName,</span>
<a href="#l68.39"></a><span id="l68.39">                                 aNounDef.schema);</span>
<a href="#l68.40"></a><span id="l68.40">       }</span>
<a href="#l68.41"></a><span id="l68.41">       catch (ex) {</span>
<a href="#l68.42"></a><span id="l68.42" class="difflineat">@@ -978,17 +981,25 @@ var GlodaDatastore = {</span>
<a href="#l68.43"></a><span id="l68.43">    */</span>
<a href="#l68.44"></a><span id="l68.44">   _migrate: function gloda_ds_migrate(aDBService, aDBFile, aDBConnection,</span>
<a href="#l68.45"></a><span id="l68.45">                                       aCurVersion, aNewVersion) {</span>
<a href="#l68.46"></a><span id="l68.46"> </span>
<a href="#l68.47"></a><span id="l68.47">     // version 12:</span>
<a href="#l68.48"></a><span id="l68.48">     // - notability column added</span>
<a href="#l68.49"></a><span id="l68.49">     // version 13:</span>
<a href="#l68.50"></a><span id="l68.50">     // - we are adding a new fulltext index column. blow away!</span>
<a href="#l68.51"></a><span id="l68.51" class="difflineminus">-    if (aCurVersion &lt; 13) {</span>
<a href="#l68.52"></a><span id="l68.52" class="difflineplus">+    // - note that I screwed up and failed to mark the schema change; apparently</span>
<a href="#l68.53"></a><span id="l68.53" class="difflineplus">+    //   no database will claim to be version 13...</span>
<a href="#l68.54"></a><span id="l68.54" class="difflineplus">+    // version 14:</span>
<a href="#l68.55"></a><span id="l68.55" class="difflineplus">+    // - new attributes: forwarded, repliedTo, bcc, recipients</span>
<a href="#l68.56"></a><span id="l68.56" class="difflineplus">+    // - altered fromMeTo and fromMeCc to fromMe</span>
<a href="#l68.57"></a><span id="l68.57" class="difflineplus">+    // - altered toMe and ccMe to just be toMe</span>
<a href="#l68.58"></a><span id="l68.58" class="difflineplus">+    // - exposes bcc to cc-related attributes</span>
<a href="#l68.59"></a><span id="l68.59" class="difflineplus">+    // - MIME type DB schema overhaul</span>
<a href="#l68.60"></a><span id="l68.60" class="difflineplus">+    if (aCurVersion &lt; 14) {</span>
<a href="#l68.61"></a><span id="l68.61">       aDBConnection.close();</span>
<a href="#l68.62"></a><span id="l68.62">       aDBFile.remove(false);</span>
<a href="#l68.63"></a><span id="l68.63">       this._log.warn(&quot;Global database has been purged due to schema change.&quot;);</span>
<a href="#l68.64"></a><span id="l68.64">       return this._createDB(aDBService, aDBFile);</span>
<a href="#l68.65"></a><span id="l68.65">     }</span>
<a href="#l68.66"></a><span id="l68.66"> </span>
<a href="#l68.67"></a><span id="l68.67">     aDBConnection.schemaVersion = aNewVersion;</span>
<a href="#l68.68"></a><span id="l68.68"> </span>
<a href="#l68.69"></a><span id="l68.69" class="difflineat">@@ -2100,17 +2111,17 @@ var GlodaDatastore = {</span>
<a href="#l68.70"></a><span id="l68.70">       date = null;</span>
<a href="#l68.71"></a><span id="l68.71">     else</span>
<a href="#l68.72"></a><span id="l68.72">       date = new Date(aRow.getInt64(4) / 1000);</span>
<a href="#l68.73"></a><span id="l68.73">     if (aRow.getTypeOfIndex(7) == Ci.mozIStorageValueArray.VALUE_TYPE_NULL)</span>
<a href="#l68.74"></a><span id="l68.74">       jsonText = undefined;</span>
<a href="#l68.75"></a><span id="l68.75">     else</span>
<a href="#l68.76"></a><span id="l68.76">       jsonText = aRow.getString(7);</span>
<a href="#l68.77"></a><span id="l68.77">     // only queryFromQuery queries will have these columns</span>
<a href="#l68.78"></a><span id="l68.78" class="difflineminus">-    if (aRow.numEntries == 14) {</span>
<a href="#l68.79"></a><span id="l68.79" class="difflineplus">+    if (aRow.numEntries &gt;= 14) {</span>
<a href="#l68.80"></a><span id="l68.80">       if (aRow.getTypeOfIndex(9) == Ci.mozIStorageValueArray.VALUE_TYPE_NULL)</span>
<a href="#l68.81"></a><span id="l68.81">         subject = undefined;</span>
<a href="#l68.82"></a><span id="l68.82">       else</span>
<a href="#l68.83"></a><span id="l68.83">         subject = aRow.getString(9);</span>
<a href="#l68.84"></a><span id="l68.84">       if (aRow.getTypeOfIndex(10) == Ci.mozIStorageValueArray.VALUE_TYPE_NULL)</span>
<a href="#l68.85"></a><span id="l68.85">         indexedBodyText = undefined;</span>
<a href="#l68.86"></a><span id="l68.86">       else</span>
<a href="#l68.87"></a><span id="l68.87">         indexedBodyText = aRow.getString(10);</span>
<a href="#l68.88"></a><span id="l68.88" class="difflineat">@@ -2948,17 +2959,17 @@ var GlodaDatastore = {</span>
<a href="#l68.89"></a><span id="l68.89">       // we don't want to overwrite the existing listener or its data, but this</span>
<a href="#l68.90"></a><span id="l68.90">       //  does raise the question about what should happen if we get passed in</span>
<a href="#l68.91"></a><span id="l68.91">       //  a different listener and/or data.</span>
<a href="#l68.92"></a><span id="l68.92">       if (aListenerData !== undefined)</span>
<a href="#l68.93"></a><span id="l68.93">         collection.data = aListenerData;</span>
<a href="#l68.94"></a><span id="l68.94">     }</span>
<a href="#l68.95"></a><span id="l68.95">     if (aListenerData) {</span>
<a href="#l68.96"></a><span id="l68.96">       if (collection.dataStack)</span>
<a href="#l68.97"></a><span id="l68.97" class="difflineminus">-        collection.dataStack.push(aListenerData)</span>
<a href="#l68.98"></a><span id="l68.98" class="difflineplus">+        collection.dataStack.push(aListenerData);</span>
<a href="#l68.99"></a><span id="l68.99">       else</span>
<a href="#l68.100"></a><span id="l68.100">         collection.dataStack = [aListenerData];</span>
<a href="#l68.101"></a><span id="l68.101">     }</span>
<a href="#l68.102"></a><span id="l68.102"> </span>
<a href="#l68.103"></a><span id="l68.103">     statement.executeAsync(new QueryFromQueryCallback(statement, aNounDef,</span>
<a href="#l68.104"></a><span id="l68.104">       collection));</span>
<a href="#l68.105"></a><span id="l68.105">     statement.finalize();</span>
<a href="#l68.106"></a><span id="l68.106">     return collection;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/db/gloda/modules/dbview.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/dbview.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -35,158 +35,122 @@</span>
<a href="#l69.4"></a><span id="l69.4">  *</span>
<a href="#l69.5"></a><span id="l69.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l69.6"></a><span id="l69.6"> </span>
<a href="#l69.7"></a><span id="l69.7"> /*</span>
<a href="#l69.8"></a><span id="l69.8">  * This file is charged with providing you a way to have a pretty gloda-backed</span>
<a href="#l69.9"></a><span id="l69.9">  *  nsIMsgDBView.</span>
<a href="#l69.10"></a><span id="l69.10">  */</span>
<a href="#l69.11"></a><span id="l69.11"> </span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;GlodaSyntheticSearchView&quot;, &quot;GlodaViewFactory&quot;];</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+EXPORTED_SYMBOLS = [&quot;GlodaSyntheticView&quot;];</span>
<a href="#l69.14"></a><span id="l69.14"> </span>
<a href="#l69.15"></a><span id="l69.15"> const Cc = Components.classes;</span>
<a href="#l69.16"></a><span id="l69.16"> const Ci = Components.interfaces;</span>
<a href="#l69.17"></a><span id="l69.17"> const Cr = Components.results;</span>
<a href="#l69.18"></a><span id="l69.18"> const Cu = Components.utils;</span>
<a href="#l69.19"></a><span id="l69.19"> </span>
<a href="#l69.20"></a><span id="l69.20"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l69.21"></a><span id="l69.21"> </span>
<a href="#l69.22"></a><span id="l69.22"> Cu.import(&quot;resource://app/modules/gloda/public.js&quot;);</span>
<a href="#l69.23"></a><span id="l69.23"> Cu.import(&quot;resource://app/modules/gloda/msg_search.js&quot;);</span>
<a href="#l69.24"></a><span id="l69.24"> </span>
<a href="#l69.25"></a><span id="l69.25" class="difflineminus">-function GlodaScoreColumn(aSearcher) {</span>
<a href="#l69.26"></a><span id="l69.26" class="difflineminus">-  this.searcher = aSearcher;</span>
<a href="#l69.27"></a><span id="l69.27" class="difflineminus">-}</span>
<a href="#l69.28"></a><span id="l69.28" class="difflineminus">-GlodaScoreColumn.prototype = {</span>
<a href="#l69.29"></a><span id="l69.29" class="difflineminus">-  id: &quot;glodaScoreCol&quot;,</span>
<a href="#l69.30"></a><span id="l69.30" class="difflineminus">-  bindToView: function (aDBView) {</span>
<a href="#l69.31"></a><span id="l69.31" class="difflineminus">-    this.dbView = aDBView;</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineminus">-  },</span>
<a href="#l69.33"></a><span id="l69.33" class="difflineplus">+/**</span>
<a href="#l69.34"></a><span id="l69.34" class="difflineplus">+ * Create a synthetic view suitable for passing to |FolderDisplayWidget.show|.</span>
<a href="#l69.35"></a><span id="l69.35" class="difflineplus">+ * You must pass a query, collection, or conversation in.</span>
<a href="#l69.36"></a><span id="l69.36" class="difflineplus">+ *</span>
<a href="#l69.37"></a><span id="l69.37" class="difflineplus">+ * @param {GlodaQuery} [aArgs.query] A gloda query to run.</span>
<a href="#l69.38"></a><span id="l69.38" class="difflineplus">+ * @param {GlodaCollection} [aArgs.collection] An already-populated collection</span>
<a href="#l69.39"></a><span id="l69.39" class="difflineplus">+ *     to display.  Do not call getCollection on a query and hand us that.  We</span>
<a href="#l69.40"></a><span id="l69.40" class="difflineplus">+ *     will not register ourselves as a listener and things will not work.</span>
<a href="#l69.41"></a><span id="l69.41" class="difflineplus">+ * @param {GlodaConversation} [aArgs.conversation] A conversation whose messages</span>
<a href="#l69.42"></a><span id="l69.42" class="difflineplus">+ *     you want to display.</span>
<a href="#l69.43"></a><span id="l69.43" class="difflineplus">+ */</span>
<a href="#l69.44"></a><span id="l69.44" class="difflineplus">+function GlodaSyntheticView(aArgs) {</span>
<a href="#l69.45"></a><span id="l69.45" class="difflineplus">+  if (&quot;query&quot; in aArgs) {</span>
<a href="#l69.46"></a><span id="l69.46" class="difflineplus">+    this.query = aArgs.query;</span>
<a href="#l69.47"></a><span id="l69.47" class="difflineplus">+    this.collection = this.query.getCollection(this);</span>
<a href="#l69.48"></a><span id="l69.48" class="difflineplus">+    this.completed = false;</span>
<a href="#l69.49"></a><span id="l69.49" class="difflineplus">+  }</span>
<a href="#l69.50"></a><span id="l69.50" class="difflineplus">+  else if (&quot;collection&quot; in aArgs) {</span>
<a href="#l69.51"></a><span id="l69.51" class="difflineplus">+    this.query = null;</span>
<a href="#l69.52"></a><span id="l69.52" class="difflineplus">+    this.collection = aArgs.collection;</span>
<a href="#l69.53"></a><span id="l69.53" class="difflineplus">+    this.completed = true;</span>
<a href="#l69.54"></a><span id="l69.54" class="difflineplus">+  }</span>
<a href="#l69.55"></a><span id="l69.55" class="difflineplus">+  else if (&quot;conversation&quot; in aArgs) {</span>
<a href="#l69.56"></a><span id="l69.56" class="difflineplus">+    this.collection = aArgs.conversation.getMessagesCollection(this);</span>
<a href="#l69.57"></a><span id="l69.57" class="difflineplus">+    this.query = this.collection.query;</span>
<a href="#l69.58"></a><span id="l69.58" class="difflineplus">+    this.completed = false;</span>
<a href="#l69.59"></a><span id="l69.59" class="difflineplus">+  }</span>
<a href="#l69.60"></a><span id="l69.60" class="difflineplus">+  else {</span>
<a href="#l69.61"></a><span id="l69.61" class="difflineplus">+    throw new Error(&quot;You need to pass a query or collection&quot;);</span>
<a href="#l69.62"></a><span id="l69.62" class="difflineplus">+  }</span>
<a href="#l69.63"></a><span id="l69.63"> </span>
<a href="#l69.64"></a><span id="l69.64" class="difflineminus">-  getCellText: function(row, col) {</span>
<a href="#l69.65"></a><span id="l69.65" class="difflineminus">-    let folder = this.dbView.getFolderForViewIndex(row);</span>
<a href="#l69.66"></a><span id="l69.66" class="difflineminus">-    let key = this.dbView.getKeyAt(row);</span>
<a href="#l69.67"></a><span id="l69.67" class="difflineminus">-    return &quot;&quot; + this.searcher.scoresByUriAndKey[folder.URI + &quot;-&quot; + key];</span>
<a href="#l69.68"></a><span id="l69.68" class="difflineminus">-  },</span>
<a href="#l69.69"></a><span id="l69.69" class="difflineminus">-  getSortLongForRow:   function(hdr) {</span>
<a href="#l69.70"></a><span id="l69.70" class="difflineminus">-    return this.searcher.scoresByUriAndKey[</span>
<a href="#l69.71"></a><span id="l69.71" class="difflineminus">-      hdr.folder.URI + &quot;-&quot; + hdr.messageKey] || 0;</span>
<a href="#l69.72"></a><span id="l69.72" class="difflineminus">-  },</span>
<a href="#l69.73"></a><span id="l69.73" class="difflineminus">-  isString: function() {</span>
<a href="#l69.74"></a><span id="l69.74" class="difflineminus">-    return false;</span>
<a href="#l69.75"></a><span id="l69.75" class="difflineminus">-  },</span>
<a href="#l69.76"></a><span id="l69.76" class="difflineminus">-</span>
<a href="#l69.77"></a><span id="l69.77" class="difflineminus">-  getCellProperties:   function(row, col, props){},</span>
<a href="#l69.78"></a><span id="l69.78" class="difflineminus">-  getRowProperties:    function(row, props){},</span>
<a href="#l69.79"></a><span id="l69.79" class="difflineminus">-  getImageSrc:         function(row, col) {return null;},</span>
<a href="#l69.80"></a><span id="l69.80" class="difflineminus">-  getSortStringForRow: function(hdr) {</span>
<a href="#l69.81"></a><span id="l69.81" class="difflineminus">-    return null;</span>
<a href="#l69.82"></a><span id="l69.82" class="difflineminus">-  },</span>
<a href="#l69.83"></a><span id="l69.83" class="difflineminus">-};</span>
<a href="#l69.84"></a><span id="l69.84" class="difflineminus">-</span>
<a href="#l69.85"></a><span id="l69.85" class="difflineminus">-function GlodaWhyColumn(aSearcher) {</span>
<a href="#l69.86"></a><span id="l69.86" class="difflineminus">-  this.searcher = aSearcher;</span>
<a href="#l69.87"></a><span id="l69.87" class="difflineplus">+  this.customColumns = [];</span>
<a href="#l69.88"></a><span id="l69.88"> }</span>
<a href="#l69.89"></a><span id="l69.89" class="difflineminus">-GlodaWhyColumn.prototype = {</span>
<a href="#l69.90"></a><span id="l69.90" class="difflineminus">-  id: &quot;glodaWhyCol&quot;,</span>
<a href="#l69.91"></a><span id="l69.91" class="difflineminus">-  bindToView: function (aDBView) {</span>
<a href="#l69.92"></a><span id="l69.92" class="difflineminus">-    this.dbView = aDBView;</span>
<a href="#l69.93"></a><span id="l69.93" class="difflineminus">-  },</span>
<a href="#l69.94"></a><span id="l69.94" class="difflineminus">-</span>
<a href="#l69.95"></a><span id="l69.95" class="difflineminus">-  getCellText: function(row, col) {</span>
<a href="#l69.96"></a><span id="l69.96" class="difflineminus">-    let folder = this.dbView.getFolderForViewIndex(row);</span>
<a href="#l69.97"></a><span id="l69.97" class="difflineminus">-    let key = this.dbView.getKeyAt(row);</span>
<a href="#l69.98"></a><span id="l69.98" class="difflineminus">-    return this.searcher.whysByUriAndKey[folder.URI + &quot;-&quot; + key] || &quot;&quot;;</span>
<a href="#l69.99"></a><span id="l69.99" class="difflineminus">-  },</span>
<a href="#l69.100"></a><span id="l69.100" class="difflineminus">-  getSortStringForRow: function(hdr) {</span>
<a href="#l69.101"></a><span id="l69.101" class="difflineminus">-    return this.searcher.whysByUriAndKey[hdr.folder.URI + &quot;-&quot; + hdr.messageKey]</span>
<a href="#l69.102"></a><span id="l69.102" class="difflineminus">-      || &quot;&quot;;</span>
<a href="#l69.103"></a><span id="l69.103" class="difflineminus">-  },</span>
<a href="#l69.104"></a><span id="l69.104" class="difflineminus">-  isString: function() {</span>
<a href="#l69.105"></a><span id="l69.105" class="difflineminus">-    return true;</span>
<a href="#l69.106"></a><span id="l69.106" class="difflineminus">-  },</span>
<a href="#l69.107"></a><span id="l69.107" class="difflineminus">-</span>
<a href="#l69.108"></a><span id="l69.108" class="difflineminus">-  getCellProperties:   function(row, col, props){},</span>
<a href="#l69.109"></a><span id="l69.109" class="difflineminus">-  getRowProperties:    function(row, props){},</span>
<a href="#l69.110"></a><span id="l69.110" class="difflineminus">-  getImageSrc:         function(row, col) {return null;},</span>
<a href="#l69.111"></a><span id="l69.111" class="difflineminus">-  getSortLongForRow:   function(hdr) {return 0;}</span>
<a href="#l69.112"></a><span id="l69.112" class="difflineminus">-};</span>
<a href="#l69.113"></a><span id="l69.113" class="difflineminus">-</span>
<a href="#l69.114"></a><span id="l69.114" class="difflineminus">-function GlodaSyntheticSearchView(aSearchString, aFacetString, aLocation) {</span>
<a href="#l69.115"></a><span id="l69.115" class="difflineminus">-  this.searcher = new GlodaMsgSearcher(this, aSearchString.split(&quot; &quot;));</span>
<a href="#l69.116"></a><span id="l69.116" class="difflineminus">-</span>
<a href="#l69.117"></a><span id="l69.117" class="difflineminus">-  this._whyColumn = new GlodaWhyColumn(this.searcher);</span>
<a href="#l69.118"></a><span id="l69.118" class="difflineminus">-  this._scoreColumn = new GlodaScoreColumn(this.searcher);</span>
<a href="#l69.119"></a><span id="l69.119" class="difflineminus">-</span>
<a href="#l69.120"></a><span id="l69.120" class="difflineminus">-  this.customColumns = [this._whyColumn, this._scoreColumn];</span>
<a href="#l69.121"></a><span id="l69.121" class="difflineminus">-</span>
<a href="#l69.122"></a><span id="l69.122" class="difflineminus">-  this.collection = null;</span>
<a href="#l69.123"></a><span id="l69.123" class="difflineminus">-  this._whyMap = {};</span>
<a href="#l69.124"></a><span id="l69.124" class="difflineminus">-  this._scoreMap = {};</span>
<a href="#l69.125"></a><span id="l69.125" class="difflineminus">-</span>
<a href="#l69.126"></a><span id="l69.126" class="difflineminus">-  this.searchString = aSearchString;</span>
<a href="#l69.127"></a><span id="l69.127" class="difflineminus">-  this.facetString = aFacetString;</span>
<a href="#l69.128"></a><span id="l69.128" class="difflineminus">-  this.location = aLocation;</span>
<a href="#l69.129"></a><span id="l69.129" class="difflineminus">-}</span>
<a href="#l69.130"></a><span id="l69.130" class="difflineminus">-GlodaSyntheticSearchView.prototype = {</span>
<a href="#l69.131"></a><span id="l69.131" class="difflineminus">-  defaultSort: [[&quot;glodaScoreCol&quot;, Ci.nsMsgViewSortOrder.descending]],</span>
<a href="#l69.132"></a><span id="l69.132" class="difflineplus">+GlodaSyntheticView.prototype = {</span>
<a href="#l69.133"></a><span id="l69.133" class="difflineplus">+  defaultSort: [[Ci.nsMsgViewSortType.byDate, Ci.nsMsgViewSortOrder.descending]],</span>
<a href="#l69.134"></a><span id="l69.134"> </span>
<a href="#l69.135"></a><span id="l69.135">   /**</span>
<a href="#l69.136"></a><span id="l69.136">    * Request the search be performed and notification provided to</span>
<a href="#l69.137"></a><span id="l69.137">    *  aSearchListener.  If results are already available, they should</span>
<a href="#l69.138"></a><span id="l69.138">    *  be provided to aSearchListener without re-performing the search.</span>
<a href="#l69.139"></a><span id="l69.139">    */</span>
<a href="#l69.140"></a><span id="l69.140">   search: function(aSearchListener, aCompletionCallback) {</span>
<a href="#l69.141"></a><span id="l69.141">     this.searchListener = aSearchListener;</span>
<a href="#l69.142"></a><span id="l69.142">     this.completionCallback = aCompletionCallback;</span>
<a href="#l69.143"></a><span id="l69.143"> </span>
<a href="#l69.144"></a><span id="l69.144">     this.searchListener.onNewSearch();</span>
<a href="#l69.145"></a><span id="l69.145" class="difflineminus">-    if (this.collection) {</span>
<a href="#l69.146"></a><span id="l69.146" class="difflineplus">+    if (this.completed) {</span>
<a href="#l69.147"></a><span id="l69.147">       this.reportResults(this.collection.items);</span>
<a href="#l69.148"></a><span id="l69.148">       // we're not really aborting, but it closes things out nicely</span>
<a href="#l69.149"></a><span id="l69.149">       this.abortSearch();</span>
<a href="#l69.150"></a><span id="l69.150">       return;</span>
<a href="#l69.151"></a><span id="l69.151">     }</span>
<a href="#l69.152"></a><span id="l69.152" class="difflineminus">-</span>
<a href="#l69.153"></a><span id="l69.153" class="difflineminus">-    this.collection = this.searcher.go();</span>
<a href="#l69.154"></a><span id="l69.154">   },</span>
<a href="#l69.155"></a><span id="l69.155"> </span>
<a href="#l69.156"></a><span id="l69.156">   abortSearch: function() {</span>
<a href="#l69.157"></a><span id="l69.157">     if (this.searchListener)</span>
<a href="#l69.158"></a><span id="l69.158">       this.searchListener.onSearchDone(Cr.NS_OK);</span>
<a href="#l69.159"></a><span id="l69.159">     if (this.completionCallback)</span>
<a href="#l69.160"></a><span id="l69.160">       this.completionCallback();</span>
<a href="#l69.161"></a><span id="l69.161">     this.searchListener = null;</span>
<a href="#l69.162"></a><span id="l69.162">     this.completionCallback = null;</span>
<a href="#l69.163"></a><span id="l69.163">   },</span>
<a href="#l69.164"></a><span id="l69.164"> </span>
<a href="#l69.165"></a><span id="l69.165">   reportResults: function(aItems) {</span>
<a href="#l69.166"></a><span id="l69.166">     for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l69.167"></a><span id="l69.167">       let hdr = item.folderMessage;</span>
<a href="#l69.168"></a><span id="l69.168" class="difflineminus">-      this.searchListener.onSearchHit(hdr, hdr.folder);</span>
<a href="#l69.169"></a><span id="l69.169" class="difflineplus">+      if (hdr)</span>
<a href="#l69.170"></a><span id="l69.170" class="difflineplus">+        this.searchListener.onSearchHit(hdr, hdr.folder);</span>
<a href="#l69.171"></a><span id="l69.171">     }</span>
<a href="#l69.172"></a><span id="l69.172">   },</span>
<a href="#l69.173"></a><span id="l69.173"> </span>
<a href="#l69.174"></a><span id="l69.174" class="difflineplus">+  /**</span>
<a href="#l69.175"></a><span id="l69.175" class="difflineplus">+   * Helper function used by |DBViewWrapper.getMsgHdrForMessageID| since there</span>
<a href="#l69.176"></a><span id="l69.176" class="difflineplus">+   *  are no actual backing folders for it to check.</span>
<a href="#l69.177"></a><span id="l69.177" class="difflineplus">+   */</span>
<a href="#l69.178"></a><span id="l69.178" class="difflineplus">+  getMsgHdrForMessageID: function(aMessageId) {</span>
<a href="#l69.179"></a><span id="l69.179" class="difflineplus">+    for each (let [, item] in Iterator(this.collection.items)) {</span>
<a href="#l69.180"></a><span id="l69.180" class="difflineplus">+      if (item.headerMessageID == aMessageId) {</span>
<a href="#l69.181"></a><span id="l69.181" class="difflineplus">+        let hdr = item.folderMessage;</span>
<a href="#l69.182"></a><span id="l69.182" class="difflineplus">+        if (hdr)</span>
<a href="#l69.183"></a><span id="l69.183" class="difflineplus">+          return hdr;</span>
<a href="#l69.184"></a><span id="l69.184" class="difflineplus">+      }</span>
<a href="#l69.185"></a><span id="l69.185" class="difflineplus">+    }</span>
<a href="#l69.186"></a><span id="l69.186" class="difflineplus">+    return null;</span>
<a href="#l69.187"></a><span id="l69.187" class="difflineplus">+  },</span>
<a href="#l69.188"></a><span id="l69.188" class="difflineplus">+</span>
<a href="#l69.189"></a><span id="l69.189">   // --- collection listener</span>
<a href="#l69.190"></a><span id="l69.190">   onItemsAdded: function(aItems, aCollection) {</span>
<a href="#l69.191"></a><span id="l69.191">     if (this.searchListener)</span>
<a href="#l69.192"></a><span id="l69.192">       this.reportResults(aItems);</span>
<a href="#l69.193"></a><span id="l69.193">   },</span>
<a href="#l69.194"></a><span id="l69.194">   onItemsModified: function(aItems, aCollection) {</span>
<a href="#l69.195"></a><span id="l69.195">   },</span>
<a href="#l69.196"></a><span id="l69.196">   onItemsRemoved: function(aItems, aCollection) {</span>
<a href="#l69.197"></a><span id="l69.197">   },</span>
<a href="#l69.198"></a><span id="l69.198">   onQueryCompleted: function(aCollection) {</span>
<a href="#l69.199"></a><span id="l69.199" class="difflineplus">+    this.completed = true;</span>
<a href="#l69.200"></a><span id="l69.200">     this.searchListener.onSearchDone(Cr.NS_OK);</span>
<a href="#l69.201"></a><span id="l69.201">     if (this.completionCallback)</span>
<a href="#l69.202"></a><span id="l69.202">       this.completionCallback();</span>
<a href="#l69.203"></a><span id="l69.203">   },</span>
<a href="#l69.204"></a><span id="l69.204"> };</span>
<a href="#l69.205"></a><span id="l69.205" class="difflineminus">-</span>
<a href="#l69.206"></a><span id="l69.206" class="difflineminus">-var GlodaViewFactory = {</span>
<a href="#l69.207"></a><span id="l69.207" class="difflineminus">-  kFacetEverything: &quot;everything&quot;,</span>
<a href="#l69.208"></a><span id="l69.208" class="difflineminus">-  kFacetSubject: &quot;subject&quot;,</span>
<a href="#l69.209"></a><span id="l69.209" class="difflineminus">-  kFacetBody: &quot;body&quot;,</span>
<a href="#l69.210"></a><span id="l69.210" class="difflineminus">-  kFacetAttachments: &quot;attachments&quot;,</span>
<a href="#l69.211"></a><span id="l69.211" class="difflineminus">-  kFacetInvolves: &quot;involves&quot;,</span>
<a href="#l69.212"></a><span id="l69.212" class="difflineminus">-  kFacetTo: &quot;to&quot;,</span>
<a href="#l69.213"></a><span id="l69.213" class="difflineminus">-  kFacetFrom: &quot;from&quot;,</span>
<a href="#l69.214"></a><span id="l69.214" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mailnews/db/gloda/modules/explattr.js</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/explattr.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -45,34 +45,36 @@</span>
<a href="#l70.4"></a><span id="l70.4"> EXPORTED_SYMBOLS = ['GlodaExplicitAttr'];</span>
<a href="#l70.5"></a><span id="l70.5"> </span>
<a href="#l70.6"></a><span id="l70.6"> const Cc = Components.classes;</span>
<a href="#l70.7"></a><span id="l70.7"> const Ci = Components.interfaces;</span>
<a href="#l70.8"></a><span id="l70.8"> const Cr = Components.results;</span>
<a href="#l70.9"></a><span id="l70.9"> const Cu = Components.utils;</span>
<a href="#l70.10"></a><span id="l70.10"> </span>
<a href="#l70.11"></a><span id="l70.11"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineplus">+Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l70.13"></a><span id="l70.13"> </span>
<a href="#l70.14"></a><span id="l70.14"> Cu.import(&quot;resource://app/modules/gloda/utils.js&quot;);</span>
<a href="#l70.15"></a><span id="l70.15"> Cu.import(&quot;resource://app/modules/gloda/gloda.js&quot;);</span>
<a href="#l70.16"></a><span id="l70.16"> Cu.import(&quot;resource://app/modules/gloda/noun_tag.js&quot;);</span>
<a href="#l70.17"></a><span id="l70.17"> </span>
<a href="#l70.18"></a><span id="l70.18"> </span>
<a href="#l70.19"></a><span id="l70.19" class="difflineplus">+const nsMsgMessageFlags_Replied = Ci.nsMsgMessageFlags.Replied;</span>
<a href="#l70.20"></a><span id="l70.20" class="difflineplus">+const nsMsgMessageFlags_Forwarded = Ci.nsMsgMessageFlags.Forwarded;</span>
<a href="#l70.21"></a><span id="l70.21" class="difflineplus">+</span>
<a href="#l70.22"></a><span id="l70.22"> const EXT_BUILTIN = &quot;built-in&quot;;</span>
<a href="#l70.23"></a><span id="l70.23" class="difflineminus">-const FA_TAG = &quot;TAG&quot;;</span>
<a href="#l70.24"></a><span id="l70.24" class="difflineminus">-const FA_STAR = &quot;STAR&quot;;</span>
<a href="#l70.25"></a><span id="l70.25" class="difflineminus">-const FA_READ = &quot;READ&quot;;</span>
<a href="#l70.26"></a><span id="l70.26"> </span>
<a href="#l70.27"></a><span id="l70.27"> /**</span>
<a href="#l70.28"></a><span id="l70.28">  * @namespace Explicit attribute provider.  Indexes/defines attributes that are</span>
<a href="#l70.29"></a><span id="l70.29">  *  explicitly a result of user action.  This dubiously includes marking a</span>
<a href="#l70.30"></a><span id="l70.30">  *  message as read.</span>
<a href="#l70.31"></a><span id="l70.31">  */</span>
<a href="#l70.32"></a><span id="l70.32"> var GlodaExplicitAttr = {</span>
<a href="#l70.33"></a><span id="l70.33">   providerName: &quot;gloda.explattr&quot;,</span>
<a href="#l70.34"></a><span id="l70.34" class="difflineplus">+  strings: new StringBundle(&quot;chrome://messenger/locale/gloda.properties&quot;),</span>
<a href="#l70.35"></a><span id="l70.35">   _log: null,</span>
<a href="#l70.36"></a><span id="l70.36">   _msgTagService: null,</span>
<a href="#l70.37"></a><span id="l70.37"> </span>
<a href="#l70.38"></a><span id="l70.38">   init: function gloda_explattr_init() {</span>
<a href="#l70.39"></a><span id="l70.39">     this._log =  Log4Moz.repository.getLogger(&quot;gloda.explattr&quot;);</span>
<a href="#l70.40"></a><span id="l70.40"> </span>
<a href="#l70.41"></a><span id="l70.41">     this._msgTagService = Cc[&quot;@mozilla.org/messenger/tagservice;1&quot;].</span>
<a href="#l70.42"></a><span id="l70.42">                           getService(Ci.nsIMsgTagService);</span>
<a href="#l70.43"></a><span id="l70.43" class="difflineat">@@ -88,72 +90,101 @@ var GlodaExplicitAttr = {</span>
<a href="#l70.44"></a><span id="l70.44"> </span>
<a href="#l70.45"></a><span id="l70.45">   /** Boost for starred messages. */</span>
<a href="#l70.46"></a><span id="l70.46">   NOTABILITY_STARRED: 16,</span>
<a href="#l70.47"></a><span id="l70.47">   /** Boost for tagged messages, first tag. */</span>
<a href="#l70.48"></a><span id="l70.48">   NOTABILITY_TAGGED_FIRST: 8,</span>
<a href="#l70.49"></a><span id="l70.49">   /** Boost for tagged messages, each additional tag. */</span>
<a href="#l70.50"></a><span id="l70.50">   NOTABILITY_TAGGED_ADDL: 1,</span>
<a href="#l70.51"></a><span id="l70.51"> </span>
<a href="#l70.52"></a><span id="l70.52" class="difflineminus">-  _attrTag: null,</span>
<a href="#l70.53"></a><span id="l70.53" class="difflineminus">-  _attrStar: null,</span>
<a href="#l70.54"></a><span id="l70.54" class="difflineminus">-  _attrRead: null,</span>
<a href="#l70.55"></a><span id="l70.55" class="difflineminus">-</span>
<a href="#l70.56"></a><span id="l70.56">   defineAttributes: function() {</span>
<a href="#l70.57"></a><span id="l70.57">     // Tag</span>
<a href="#l70.58"></a><span id="l70.58">     this._attrTag = Gloda.defineAttribute({</span>
<a href="#l70.59"></a><span id="l70.59">                         provider: this,</span>
<a href="#l70.60"></a><span id="l70.60">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l70.61"></a><span id="l70.61">                         attributeType: Gloda.kAttrExplicit,</span>
<a href="#l70.62"></a><span id="l70.62">                         attributeName: &quot;tag&quot;,</span>
<a href="#l70.63"></a><span id="l70.63">                         bindName: &quot;tags&quot;,</span>
<a href="#l70.64"></a><span id="l70.64">                         singular: false,</span>
<a href="#l70.65"></a><span id="l70.65" class="difflineplus">+                        facet: true,</span>
<a href="#l70.66"></a><span id="l70.66">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l70.67"></a><span id="l70.67">                         objectNoun: Gloda.NOUN_TAG,</span>
<a href="#l70.68"></a><span id="l70.68">                         parameterNoun: null,</span>
<a href="#l70.69"></a><span id="l70.69">                         // Property change notifications that we care about:</span>
<a href="#l70.70"></a><span id="l70.70">                         propertyChanges: [&quot;keywords&quot;],</span>
<a href="#l70.71"></a><span id="l70.71">                         }); // not-tested</span>
<a href="#l70.72"></a><span id="l70.72"> </span>
<a href="#l70.73"></a><span id="l70.73">     // Star</span>
<a href="#l70.74"></a><span id="l70.74">     this._attrStar = Gloda.defineAttribute({</span>
<a href="#l70.75"></a><span id="l70.75">                         provider: this,</span>
<a href="#l70.76"></a><span id="l70.76">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l70.77"></a><span id="l70.77">                         attributeType: Gloda.kAttrExplicit,</span>
<a href="#l70.78"></a><span id="l70.78">                         attributeName: &quot;star&quot;,</span>
<a href="#l70.79"></a><span id="l70.79">                         bindName: &quot;starred&quot;,</span>
<a href="#l70.80"></a><span id="l70.80">                         singular: true,</span>
<a href="#l70.81"></a><span id="l70.81" class="difflineplus">+                        facet: true,</span>
<a href="#l70.82"></a><span id="l70.82">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l70.83"></a><span id="l70.83">                         objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l70.84"></a><span id="l70.84">                         parameterNoun: null,</span>
<a href="#l70.85"></a><span id="l70.85">                         }); // tested-by: test_attributes_explicit</span>
<a href="#l70.86"></a><span id="l70.86">     // Read/Unread</span>
<a href="#l70.87"></a><span id="l70.87">     this._attrRead = Gloda.defineAttribute({</span>
<a href="#l70.88"></a><span id="l70.88">                         provider: this,</span>
<a href="#l70.89"></a><span id="l70.89">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l70.90"></a><span id="l70.90">                         attributeType: Gloda.kAttrExplicit,</span>
<a href="#l70.91"></a><span id="l70.91">                         attributeName: &quot;read&quot;,</span>
<a href="#l70.92"></a><span id="l70.92">                         singular: true,</span>
<a href="#l70.93"></a><span id="l70.93">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l70.94"></a><span id="l70.94">                         objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l70.95"></a><span id="l70.95">                         parameterNoun: null,</span>
<a href="#l70.96"></a><span id="l70.96">                         }); // tested-by: test_attributes_explicit</span>
<a href="#l70.97"></a><span id="l70.97"> </span>
<a href="#l70.98"></a><span id="l70.98" class="difflineplus">+    /**</span>
<a href="#l70.99"></a><span id="l70.99" class="difflineplus">+     * Has this message been replied to by the user.</span>
<a href="#l70.100"></a><span id="l70.100" class="difflineplus">+     */</span>
<a href="#l70.101"></a><span id="l70.101" class="difflineplus">+    this._attrRepliedTo = Gloda.defineAttribute({</span>
<a href="#l70.102"></a><span id="l70.102" class="difflineplus">+      provider: this,</span>
<a href="#l70.103"></a><span id="l70.103" class="difflineplus">+      extensionName: Gloda.BUILT_IN,</span>
<a href="#l70.104"></a><span id="l70.104" class="difflineplus">+      attributeType: Gloda.kAttrExplicit,</span>
<a href="#l70.105"></a><span id="l70.105" class="difflineplus">+      attributeName: &quot;repliedTo&quot;,</span>
<a href="#l70.106"></a><span id="l70.106" class="difflineplus">+      singular: true,</span>
<a href="#l70.107"></a><span id="l70.107" class="difflineplus">+      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l70.108"></a><span id="l70.108" class="difflineplus">+      objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l70.109"></a><span id="l70.109" class="difflineplus">+      parameterNoun: null,</span>
<a href="#l70.110"></a><span id="l70.110" class="difflineplus">+    }); // tested-by: test_attributes_explicit</span>
<a href="#l70.111"></a><span id="l70.111" class="difflineplus">+</span>
<a href="#l70.112"></a><span id="l70.112" class="difflineplus">+    /**</span>
<a href="#l70.113"></a><span id="l70.113" class="difflineplus">+     * Has this user forwarded this message to someone.</span>
<a href="#l70.114"></a><span id="l70.114" class="difflineplus">+     */</span>
<a href="#l70.115"></a><span id="l70.115" class="difflineplus">+    this._attrForwarded = Gloda.defineAttribute({</span>
<a href="#l70.116"></a><span id="l70.116" class="difflineplus">+      provider: this,</span>
<a href="#l70.117"></a><span id="l70.117" class="difflineplus">+      extensionName: Gloda.BUILT_IN,</span>
<a href="#l70.118"></a><span id="l70.118" class="difflineplus">+      attributeType: Gloda.kAttrExplicit,</span>
<a href="#l70.119"></a><span id="l70.119" class="difflineplus">+      attributeName: &quot;forwarded&quot;,</span>
<a href="#l70.120"></a><span id="l70.120" class="difflineplus">+      singular: true,</span>
<a href="#l70.121"></a><span id="l70.121" class="difflineplus">+      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l70.122"></a><span id="l70.122" class="difflineplus">+      objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l70.123"></a><span id="l70.123" class="difflineplus">+      parameterNoun: null,</span>
<a href="#l70.124"></a><span id="l70.124" class="difflineplus">+    }); // tested-by: test_attributes_explicit</span>
<a href="#l70.125"></a><span id="l70.125">   },</span>
<a href="#l70.126"></a><span id="l70.126"> </span>
<a href="#l70.127"></a><span id="l70.127">   process: function Gloda_explattr_process(aGlodaMessage, aRawReps, aIsNew,</span>
<a href="#l70.128"></a><span id="l70.128">                                            aCallbackHandle) {</span>
<a href="#l70.129"></a><span id="l70.129">     let aMsgHdr = aRawReps.header;</span>
<a href="#l70.130"></a><span id="l70.130"> </span>
<a href="#l70.131"></a><span id="l70.131">     aGlodaMessage.starred = aMsgHdr.isFlagged;</span>
<a href="#l70.132"></a><span id="l70.132">     if (aGlodaMessage.starred)</span>
<a href="#l70.133"></a><span id="l70.133">       aGlodaMessage.notability += this.NOTABILITY_STARRED;</span>
<a href="#l70.134"></a><span id="l70.134"> </span>
<a href="#l70.135"></a><span id="l70.135">     aGlodaMessage.read = aMsgHdr.isRead;</span>
<a href="#l70.136"></a><span id="l70.136"> </span>
<a href="#l70.137"></a><span id="l70.137" class="difflineplus">+    let flags = aMsgHdr.flags;</span>
<a href="#l70.138"></a><span id="l70.138" class="difflineplus">+    aGlodaMessage.repliedTo = Boolean(flags &amp; nsMsgMessageFlags_Replied);</span>
<a href="#l70.139"></a><span id="l70.139" class="difflineplus">+    aGlodaMessage.forwarded = Boolean(flags &amp; nsMsgMessageFlags_Forwarded);</span>
<a href="#l70.140"></a><span id="l70.140" class="difflineplus">+</span>
<a href="#l70.141"></a><span id="l70.141">     let tags = aGlodaMessage.tags = [];</span>
<a href="#l70.142"></a><span id="l70.142"> </span>
<a href="#l70.143"></a><span id="l70.143">     // -- Tag</span>
<a href="#l70.144"></a><span id="l70.144">     // build a map of the keywords</span>
<a href="#l70.145"></a><span id="l70.145">     let keywords = aMsgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l70.146"></a><span id="l70.146">     let keywordList = keywords.split(' ');</span>
<a href="#l70.147"></a><span id="l70.147">     let keywordMap = {};</span>
<a href="#l70.148"></a><span id="l70.148">     for (let iKeyword = 0; iKeyword &lt; keywordList.length; iKeyword++) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1">new file mode 100644</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineminus">--- /dev/null</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineplus">+++ b/mailnews/db/gloda/modules/facet.js</span>
<a href="#l71.4"></a><span id="l71.4" class="difflineat">@@ -0,0 +1,575 @@</span>
<a href="#l71.5"></a><span id="l71.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l71.6"></a><span id="l71.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l71.7"></a><span id="l71.7" class="difflineplus">+ *</span>
<a href="#l71.8"></a><span id="l71.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l71.9"></a><span id="l71.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l71.10"></a><span id="l71.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l71.11"></a><span id="l71.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineplus">+ *</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l71.14"></a><span id="l71.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l71.15"></a><span id="l71.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l71.16"></a><span id="l71.16" class="difflineplus">+ * License.</span>
<a href="#l71.17"></a><span id="l71.17" class="difflineplus">+ *</span>
<a href="#l71.18"></a><span id="l71.18" class="difflineplus">+ * The Original Code is Thunderbird Global Database.</span>
<a href="#l71.19"></a><span id="l71.19" class="difflineplus">+ *</span>
<a href="#l71.20"></a><span id="l71.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l71.21"></a><span id="l71.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l71.22"></a><span id="l71.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l71.23"></a><span id="l71.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l71.24"></a><span id="l71.24" class="difflineplus">+ *</span>
<a href="#l71.25"></a><span id="l71.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l71.26"></a><span id="l71.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l71.27"></a><span id="l71.27" class="difflineplus">+ *</span>
<a href="#l71.28"></a><span id="l71.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l71.29"></a><span id="l71.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l71.30"></a><span id="l71.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l71.31"></a><span id="l71.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l71.32"></a><span id="l71.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l71.33"></a><span id="l71.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l71.34"></a><span id="l71.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l71.35"></a><span id="l71.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l71.36"></a><span id="l71.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l71.37"></a><span id="l71.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l71.38"></a><span id="l71.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l71.39"></a><span id="l71.39" class="difflineplus">+ *</span>
<a href="#l71.40"></a><span id="l71.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l71.41"></a><span id="l71.41" class="difflineplus">+</span>
<a href="#l71.42"></a><span id="l71.42" class="difflineplus">+/*</span>
<a href="#l71.43"></a><span id="l71.43" class="difflineplus">+ * This file provides faceting logic.</span>
<a href="#l71.44"></a><span id="l71.44" class="difflineplus">+ */</span>
<a href="#l71.45"></a><span id="l71.45" class="difflineplus">+</span>
<a href="#l71.46"></a><span id="l71.46" class="difflineplus">+let EXPORTED_SYMBOLS = [&quot;FacetDriver&quot;, &quot;FacetUtils&quot;];</span>
<a href="#l71.47"></a><span id="l71.47" class="difflineplus">+</span>
<a href="#l71.48"></a><span id="l71.48" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l71.49"></a><span id="l71.49" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l71.50"></a><span id="l71.50" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l71.51"></a><span id="l71.51" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l71.52"></a><span id="l71.52" class="difflineplus">+</span>
<a href="#l71.53"></a><span id="l71.53" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/public.js&quot;);</span>
<a href="#l71.54"></a><span id="l71.54" class="difflineplus">+</span>
<a href="#l71.55"></a><span id="l71.55" class="difflineplus">+/**</span>
<a href="#l71.56"></a><span id="l71.56" class="difflineplus">+ * Decides the appropriate faceters for the noun type and drives the faceting</span>
<a href="#l71.57"></a><span id="l71.57" class="difflineplus">+ *  process.  This class and the faceters are intended to be reusable so that</span>
<a href="#l71.58"></a><span id="l71.58" class="difflineplus">+ *  you only need one instance per faceting session.  (Although each faceting</span>
<a href="#l71.59"></a><span id="l71.59" class="difflineplus">+ *  pass is accordingly destructive to previous results.)</span>
<a href="#l71.60"></a><span id="l71.60" class="difflineplus">+ *</span>
<a href="#l71.61"></a><span id="l71.61" class="difflineplus">+ * Our strategy for faceting is to process one attribute at a time across all</span>
<a href="#l71.62"></a><span id="l71.62" class="difflineplus">+ *  the items in the provided set.  The alternative would be to iterate over</span>
<a href="#l71.63"></a><span id="l71.63" class="difflineplus">+ *  the items and then iterate over the attributes on each item.  While both</span>
<a href="#l71.64"></a><span id="l71.64" class="difflineplus">+ *  approaches have caching downsides</span>
<a href="#l71.65"></a><span id="l71.65" class="difflineplus">+ */</span>
<a href="#l71.66"></a><span id="l71.66" class="difflineplus">+function FacetDriver(aNounDef, aWindow) {</span>
<a href="#l71.67"></a><span id="l71.67" class="difflineplus">+  this.nounDef = aNounDef;</span>
<a href="#l71.68"></a><span id="l71.68" class="difflineplus">+  this._window = aWindow;</span>
<a href="#l71.69"></a><span id="l71.69" class="difflineplus">+</span>
<a href="#l71.70"></a><span id="l71.70" class="difflineplus">+  this._makeFaceters();</span>
<a href="#l71.71"></a><span id="l71.71" class="difflineplus">+}</span>
<a href="#l71.72"></a><span id="l71.72" class="difflineplus">+FacetDriver.prototype = {</span>
<a href="#l71.73"></a><span id="l71.73" class="difflineplus">+  /**</span>
<a href="#l71.74"></a><span id="l71.74" class="difflineplus">+   * Populate |this.faceters| with a set of faceters appropriate to the noun</span>
<a href="#l71.75"></a><span id="l71.75" class="difflineplus">+   *  definition associated with this instance.</span>
<a href="#l71.76"></a><span id="l71.76" class="difflineplus">+   */</span>
<a href="#l71.77"></a><span id="l71.77" class="difflineplus">+  _makeFaceters: function() {</span>
<a href="#l71.78"></a><span id="l71.78" class="difflineplus">+    let faceters = this.faceters = [];</span>
<a href="#l71.79"></a><span id="l71.79" class="difflineplus">+    for each (let [, attrDef] in Iterator(this.nounDef.attribsByBoundName)) {</span>
<a href="#l71.80"></a><span id="l71.80" class="difflineplus">+      // ignore attributes that do not want to be faceted</span>
<a href="#l71.81"></a><span id="l71.81" class="difflineplus">+      if (!attrDef.facet)</span>
<a href="#l71.82"></a><span id="l71.82" class="difflineplus">+        continue;</span>
<a href="#l71.83"></a><span id="l71.83" class="difflineplus">+</span>
<a href="#l71.84"></a><span id="l71.84" class="difflineplus">+      let facetType = attrDef.facet.type;</span>
<a href="#l71.85"></a><span id="l71.85" class="difflineplus">+</span>
<a href="#l71.86"></a><span id="l71.86" class="difflineplus">+      if (attrDef.singular) {</span>
<a href="#l71.87"></a><span id="l71.87" class="difflineplus">+        if (facetType == &quot;date&quot;)</span>
<a href="#l71.88"></a><span id="l71.88" class="difflineplus">+          faceters.push(new DateFaceter(attrDef));</span>
<a href="#l71.89"></a><span id="l71.89" class="difflineplus">+        else</span>
<a href="#l71.90"></a><span id="l71.90" class="difflineplus">+          faceters.push(new DiscreteFaceter(attrDef));</span>
<a href="#l71.91"></a><span id="l71.91" class="difflineplus">+      }</span>
<a href="#l71.92"></a><span id="l71.92" class="difflineplus">+      else {</span>
<a href="#l71.93"></a><span id="l71.93" class="difflineplus">+        if (facetType == &quot;nonempty?&quot;)</span>
<a href="#l71.94"></a><span id="l71.94" class="difflineplus">+          faceters.push(new NonEmptySetFaceter(attrDef));</span>
<a href="#l71.95"></a><span id="l71.95" class="difflineplus">+        else</span>
<a href="#l71.96"></a><span id="l71.96" class="difflineplus">+          faceters.push(new DiscreteSetFaceter(attrDef));</span>
<a href="#l71.97"></a><span id="l71.97" class="difflineplus">+      }</span>
<a href="#l71.98"></a><span id="l71.98" class="difflineplus">+    }</span>
<a href="#l71.99"></a><span id="l71.99" class="difflineplus">+  },</span>
<a href="#l71.100"></a><span id="l71.100" class="difflineplus">+  /**</span>
<a href="#l71.101"></a><span id="l71.101" class="difflineplus">+   * Asynchronously facet the provided items, calling the provided callback when</span>
<a href="#l71.102"></a><span id="l71.102" class="difflineplus">+   *  completed.</span>
<a href="#l71.103"></a><span id="l71.103" class="difflineplus">+   */</span>
<a href="#l71.104"></a><span id="l71.104" class="difflineplus">+  go: function FacetDriver_go(aItems, aCallback, aCallbackThis) {</span>
<a href="#l71.105"></a><span id="l71.105" class="difflineplus">+    this.items = aItems;</span>
<a href="#l71.106"></a><span id="l71.106" class="difflineplus">+    this.callback = aCallback;</span>
<a href="#l71.107"></a><span id="l71.107" class="difflineplus">+    this.callbackThis = aCallbackThis;</span>
<a href="#l71.108"></a><span id="l71.108" class="difflineplus">+</span>
<a href="#l71.109"></a><span id="l71.109" class="difflineplus">+    this._nextFaceter = 0;</span>
<a href="#l71.110"></a><span id="l71.110" class="difflineplus">+    this._drive();</span>
<a href="#l71.111"></a><span id="l71.111" class="difflineplus">+  },</span>
<a href="#l71.112"></a><span id="l71.112" class="difflineplus">+</span>
<a href="#l71.113"></a><span id="l71.113" class="difflineplus">+  _MAX_FACETING_TIMESLICE_MS: 100,</span>
<a href="#l71.114"></a><span id="l71.114" class="difflineplus">+  _FACETING_YIELD_DURATION_MS: 0,</span>
<a href="#l71.115"></a><span id="l71.115" class="difflineplus">+  _driveWrapper: function(aThis) {</span>
<a href="#l71.116"></a><span id="l71.116" class="difflineplus">+    aThis._drive();</span>
<a href="#l71.117"></a><span id="l71.117" class="difflineplus">+  },</span>
<a href="#l71.118"></a><span id="l71.118" class="difflineplus">+  _drive: function() {</span>
<a href="#l71.119"></a><span id="l71.119" class="difflineplus">+    let start = Date.now();</span>
<a href="#l71.120"></a><span id="l71.120" class="difflineplus">+</span>
<a href="#l71.121"></a><span id="l71.121" class="difflineplus">+    while (this._nextFaceter &lt; this.faceters.length) {</span>
<a href="#l71.122"></a><span id="l71.122" class="difflineplus">+      let faceter = this.faceters[this._nextFaceter++];</span>
<a href="#l71.123"></a><span id="l71.123" class="difflineplus">+      // for now we facet in one go, but the long-term plan allows for them to</span>
<a href="#l71.124"></a><span id="l71.124" class="difflineplus">+      //  be generators.</span>
<a href="#l71.125"></a><span id="l71.125" class="difflineplus">+      faceter.facetItems(this.items);</span>
<a href="#l71.126"></a><span id="l71.126" class="difflineplus">+</span>
<a href="#l71.127"></a><span id="l71.127" class="difflineplus">+      let delta = Date.now() - start;</span>
<a href="#l71.128"></a><span id="l71.128" class="difflineplus">+      if (delta &gt; this._MAX_FACETING_TIMESLICE_MS) {</span>
<a href="#l71.129"></a><span id="l71.129" class="difflineplus">+        this._window.setTimeout(this._driveWrapper,</span>
<a href="#l71.130"></a><span id="l71.130" class="difflineplus">+                                this._FACETING_YIELD_DURATION_MS,</span>
<a href="#l71.131"></a><span id="l71.131" class="difflineplus">+                                this);</span>
<a href="#l71.132"></a><span id="l71.132" class="difflineplus">+        return;</span>
<a href="#l71.133"></a><span id="l71.133" class="difflineplus">+      }</span>
<a href="#l71.134"></a><span id="l71.134" class="difflineplus">+    }</span>
<a href="#l71.135"></a><span id="l71.135" class="difflineplus">+</span>
<a href="#l71.136"></a><span id="l71.136" class="difflineplus">+    // we only get here once we are done with the faceters</span>
<a href="#l71.137"></a><span id="l71.137" class="difflineplus">+    this.callback.call(this.callbackThis);</span>
<a href="#l71.138"></a><span id="l71.138" class="difflineplus">+  }</span>
<a href="#l71.139"></a><span id="l71.139" class="difflineplus">+};</span>
<a href="#l71.140"></a><span id="l71.140" class="difflineplus">+</span>
<a href="#l71.141"></a><span id="l71.141" class="difflineplus">+var FacetUtils = {</span>
<a href="#l71.142"></a><span id="l71.142" class="difflineplus">+  _groupSizeComparator: function(a, b) {</span>
<a href="#l71.143"></a><span id="l71.143" class="difflineplus">+    return b[1].length - a[1].length;</span>
<a href="#l71.144"></a><span id="l71.144" class="difflineplus">+  },</span>
<a href="#l71.145"></a><span id="l71.145" class="difflineplus">+</span>
<a href="#l71.146"></a><span id="l71.146" class="difflineplus">+  /**</span>
<a href="#l71.147"></a><span id="l71.147" class="difflineplus">+   * Given a list where each entry is a tuple of [group object, list of items</span>
<a href="#l71.148"></a><span id="l71.148" class="difflineplus">+   *  belonging to that group], produce a new list of the top grouped items.  We</span>
<a href="#l71.149"></a><span id="l71.149" class="difflineplus">+   *  used to also produce an &quot;other&quot; aggregation, but that turned out to be</span>
<a href="#l71.150"></a><span id="l71.150" class="difflineplus">+   *  conceptually difficult to deal with, so that's gone, leaving this method</span>
<a href="#l71.151"></a><span id="l71.151" class="difflineplus">+   *  with much less to do.</span>
<a href="#l71.152"></a><span id="l71.152" class="difflineplus">+   *</span>
<a href="#l71.153"></a><span id="l71.153" class="difflineplus">+   * @param aAttrDef The attribute for the facet we are working with.</span>
<a href="#l71.154"></a><span id="l71.154" class="difflineplus">+   * @param aGroups The list of groups built for the facet.</span>
<a href="#l71.155"></a><span id="l71.155" class="difflineplus">+   * @param aMaxCount The number of result rows you want back.</span>
<a href="#l71.156"></a><span id="l71.156" class="difflineplus">+   */</span>
<a href="#l71.157"></a><span id="l71.157" class="difflineplus">+  makeTopGroups: function FacetUtils_makeTopGroups(aAttrDef, aGroups,</span>
<a href="#l71.158"></a><span id="l71.158" class="difflineplus">+                                                   aMaxCount) {</span>
<a href="#l71.159"></a><span id="l71.159" class="difflineplus">+    let nounDef = aAttrDef.objectNounDef;</span>
<a href="#l71.160"></a><span id="l71.160" class="difflineplus">+    let realGroupsToUse = aMaxCount;</span>
<a href="#l71.161"></a><span id="l71.161" class="difflineplus">+</span>
<a href="#l71.162"></a><span id="l71.162" class="difflineplus">+    let orderedBySize = aGroups.concat();</span>
<a href="#l71.163"></a><span id="l71.163" class="difflineplus">+    orderedBySize.sort(this._groupSizeComparator);</span>
<a href="#l71.164"></a><span id="l71.164" class="difflineplus">+</span>
<a href="#l71.165"></a><span id="l71.165" class="difflineplus">+    // - get the real groups to use and order them by the attribute comparator</span>
<a href="#l71.166"></a><span id="l71.166" class="difflineplus">+    let outGroups = orderedBySize.slice(0, realGroupsToUse);</span>
<a href="#l71.167"></a><span id="l71.167" class="difflineplus">+    let comparator = nounDef.comparator;</span>
<a href="#l71.168"></a><span id="l71.168" class="difflineplus">+    function comparatorHelper(a, b) {</span>
<a href="#l71.169"></a><span id="l71.169" class="difflineplus">+      return comparator(a[0], b[0]);</span>
<a href="#l71.170"></a><span id="l71.170" class="difflineplus">+    }</span>
<a href="#l71.171"></a><span id="l71.171" class="difflineplus">+    outGroups.sort(comparatorHelper);</span>
<a href="#l71.172"></a><span id="l71.172" class="difflineplus">+</span>
<a href="#l71.173"></a><span id="l71.173" class="difflineplus">+    return outGroups;</span>
<a href="#l71.174"></a><span id="l71.174" class="difflineplus">+  }</span>
<a href="#l71.175"></a><span id="l71.175" class="difflineplus">+};</span>
<a href="#l71.176"></a><span id="l71.176" class="difflineplus">+</span>
<a href="#l71.177"></a><span id="l71.177" class="difflineplus">+/**</span>
<a href="#l71.178"></a><span id="l71.178" class="difflineplus">+ * Facet discrete things like message authors, boolean values, etc.  Only</span>
<a href="#l71.179"></a><span id="l71.179" class="difflineplus">+ *  appropriate for use on singular values.  Use |DiscreteSetFaceter| for</span>
<a href="#l71.180"></a><span id="l71.180" class="difflineplus">+ *  non-singular values.</span>
<a href="#l71.181"></a><span id="l71.181" class="difflineplus">+ */</span>
<a href="#l71.182"></a><span id="l71.182" class="difflineplus">+function DiscreteFaceter(aAttrDef) {</span>
<a href="#l71.183"></a><span id="l71.183" class="difflineplus">+  this.attrDef = aAttrDef;</span>
<a href="#l71.184"></a><span id="l71.184" class="difflineplus">+}</span>
<a href="#l71.185"></a><span id="l71.185" class="difflineplus">+DiscreteFaceter.prototype = {</span>
<a href="#l71.186"></a><span id="l71.186" class="difflineplus">+  type: &quot;discrete&quot;,</span>
<a href="#l71.187"></a><span id="l71.187" class="difflineplus">+  /**</span>
<a href="#l71.188"></a><span id="l71.188" class="difflineplus">+   * Facet the given set of items, deferring to the appropriate helper method</span>
<a href="#l71.189"></a><span id="l71.189" class="difflineplus">+   */</span>
<a href="#l71.190"></a><span id="l71.190" class="difflineplus">+  facetItems: function(aItems) {</span>
<a href="#l71.191"></a><span id="l71.191" class="difflineplus">+    if (this.attrDef.objectNounDef.isPrimitive)</span>
<a href="#l71.192"></a><span id="l71.192" class="difflineplus">+      return this.facetPrimitiveItems(aItems);</span>
<a href="#l71.193"></a><span id="l71.193" class="difflineplus">+    else</span>
<a href="#l71.194"></a><span id="l71.194" class="difflineplus">+      return this.facetComplexItems(aItems);</span>
<a href="#l71.195"></a><span id="l71.195" class="difflineplus">+  },</span>
<a href="#l71.196"></a><span id="l71.196" class="difflineplus">+  /**</span>
<a href="#l71.197"></a><span id="l71.197" class="difflineplus">+   * Facet an attribute whose value is primitive, meaning that it is a raw</span>
<a href="#l71.198"></a><span id="l71.198" class="difflineplus">+   *  numeric value or string, rather than a complex object.</span>
<a href="#l71.199"></a><span id="l71.199" class="difflineplus">+   */</span>
<a href="#l71.200"></a><span id="l71.200" class="difflineplus">+  facetPrimitiveItems: function(aItems) {</span>
<a href="#l71.201"></a><span id="l71.201" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l71.202"></a><span id="l71.202" class="difflineplus">+    let nounDef = this.attrDef.objectNounDef;</span>
<a href="#l71.203"></a><span id="l71.203" class="difflineplus">+    let filter = this.attrDef.facet.filter;</span>
<a href="#l71.204"></a><span id="l71.204" class="difflineplus">+</span>
<a href="#l71.205"></a><span id="l71.205" class="difflineplus">+    let valStrToVal = {};</span>
<a href="#l71.206"></a><span id="l71.206" class="difflineplus">+    let groups = this.groups = {};</span>
<a href="#l71.207"></a><span id="l71.207" class="difflineplus">+    this.groupCount = 0;</span>
<a href="#l71.208"></a><span id="l71.208" class="difflineplus">+</span>
<a href="#l71.209"></a><span id="l71.209" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l71.210"></a><span id="l71.210" class="difflineplus">+      let val = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l71.211"></a><span id="l71.211" class="difflineplus">+</span>
<a href="#l71.212"></a><span id="l71.212" class="difflineplus">+      // skip items the filter tells us to ignore</span>
<a href="#l71.213"></a><span id="l71.213" class="difflineplus">+      if (filter &amp;&amp; !filter(val))</span>
<a href="#l71.214"></a><span id="l71.214" class="difflineplus">+        continue;</span>
<a href="#l71.215"></a><span id="l71.215" class="difflineplus">+</span>
<a href="#l71.216"></a><span id="l71.216" class="difflineplus">+      if (val in groups)</span>
<a href="#l71.217"></a><span id="l71.217" class="difflineplus">+        groups[val].push(item);</span>
<a href="#l71.218"></a><span id="l71.218" class="difflineplus">+      else {</span>
<a href="#l71.219"></a><span id="l71.219" class="difflineplus">+        groups[val] = [item];</span>
<a href="#l71.220"></a><span id="l71.220" class="difflineplus">+        valStrToVal[val] = val;</span>
<a href="#l71.221"></a><span id="l71.221" class="difflineplus">+        this.groupCount++;</span>
<a href="#l71.222"></a><span id="l71.222" class="difflineplus">+      }</span>
<a href="#l71.223"></a><span id="l71.223" class="difflineplus">+    }</span>
<a href="#l71.224"></a><span id="l71.224" class="difflineplus">+</span>
<a href="#l71.225"></a><span id="l71.225" class="difflineplus">+    let orderedGroups = [[valStrToVal[key], items] for each</span>
<a href="#l71.226"></a><span id="l71.226" class="difflineplus">+                         ([key, items] in Iterator(groups))];</span>
<a href="#l71.227"></a><span id="l71.227" class="difflineplus">+    let comparator = nounDef.comparator;</span>
<a href="#l71.228"></a><span id="l71.228" class="difflineplus">+    function comparatorHelper(a, b) {</span>
<a href="#l71.229"></a><span id="l71.229" class="difflineplus">+      return comparator(a[0], b[0]);</span>
<a href="#l71.230"></a><span id="l71.230" class="difflineplus">+    }</span>
<a href="#l71.231"></a><span id="l71.231" class="difflineplus">+    orderedGroups.sort(comparatorHelper);</span>
<a href="#l71.232"></a><span id="l71.232" class="difflineplus">+    this.orderedGroups = orderedGroups;</span>
<a href="#l71.233"></a><span id="l71.233" class="difflineplus">+  },</span>
<a href="#l71.234"></a><span id="l71.234" class="difflineplus">+  /**</span>
<a href="#l71.235"></a><span id="l71.235" class="difflineplus">+   * Facet an attribute whose value is a complex object that can be identified</span>
<a href="#l71.236"></a><span id="l71.236" class="difflineplus">+   *  by its 'id' attribute.  This is the case where the value is itself a noun</span>
<a href="#l71.237"></a><span id="l71.237" class="difflineplus">+   *  instance.</span>
<a href="#l71.238"></a><span id="l71.238" class="difflineplus">+   */</span>
<a href="#l71.239"></a><span id="l71.239" class="difflineplus">+  facetComplexItems: function(aItems) {</span>
<a href="#l71.240"></a><span id="l71.240" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l71.241"></a><span id="l71.241" class="difflineplus">+    let nounDef = this.attrDef.objectNounDef;</span>
<a href="#l71.242"></a><span id="l71.242" class="difflineplus">+    let filter = this.attrDef.facet.filter;</span>
<a href="#l71.243"></a><span id="l71.243" class="difflineplus">+    let idAttr = this.attrDef.facet.groupIdAttr;</span>
<a href="#l71.244"></a><span id="l71.244" class="difflineplus">+</span>
<a href="#l71.245"></a><span id="l71.245" class="difflineplus">+    let groups = this.groups = {};</span>
<a href="#l71.246"></a><span id="l71.246" class="difflineplus">+    let groupMap = this.groupMap = {};</span>
<a href="#l71.247"></a><span id="l71.247" class="difflineplus">+    this.groupCount = 0;</span>
<a href="#l71.248"></a><span id="l71.248" class="difflineplus">+</span>
<a href="#l71.249"></a><span id="l71.249" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l71.250"></a><span id="l71.250" class="difflineplus">+      let val = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l71.251"></a><span id="l71.251" class="difflineplus">+</span>
<a href="#l71.252"></a><span id="l71.252" class="difflineplus">+      // skip items the filter tells us to ignore</span>
<a href="#l71.253"></a><span id="l71.253" class="difflineplus">+      if (filter &amp;&amp; !filter(val))</span>
<a href="#l71.254"></a><span id="l71.254" class="difflineplus">+        continue;</span>
<a href="#l71.255"></a><span id="l71.255" class="difflineplus">+</span>
<a href="#l71.256"></a><span id="l71.256" class="difflineplus">+      let valId = (val == null) ? null : val[idAttr];</span>
<a href="#l71.257"></a><span id="l71.257" class="difflineplus">+      if (valId in groupMap) {</span>
<a href="#l71.258"></a><span id="l71.258" class="difflineplus">+        groups[valId].push(item);</span>
<a href="#l71.259"></a><span id="l71.259" class="difflineplus">+      }</span>
<a href="#l71.260"></a><span id="l71.260" class="difflineplus">+      else {</span>
<a href="#l71.261"></a><span id="l71.261" class="difflineplus">+        groupMap[valId] = val;</span>
<a href="#l71.262"></a><span id="l71.262" class="difflineplus">+        groups[valId] = [item];</span>
<a href="#l71.263"></a><span id="l71.263" class="difflineplus">+        this.groupCount++;</span>
<a href="#l71.264"></a><span id="l71.264" class="difflineplus">+      }</span>
<a href="#l71.265"></a><span id="l71.265" class="difflineplus">+    }</span>
<a href="#l71.266"></a><span id="l71.266" class="difflineplus">+</span>
<a href="#l71.267"></a><span id="l71.267" class="difflineplus">+    let orderedGroups = [[groupMap[key], items] for each</span>
<a href="#l71.268"></a><span id="l71.268" class="difflineplus">+                         ([key, items] in Iterator(groups))];</span>
<a href="#l71.269"></a><span id="l71.269" class="difflineplus">+    let comparator = nounDef.comparator;</span>
<a href="#l71.270"></a><span id="l71.270" class="difflineplus">+    function comparatorHelper(a, b) {</span>
<a href="#l71.271"></a><span id="l71.271" class="difflineplus">+      return comparator(a[0], b[0]);</span>
<a href="#l71.272"></a><span id="l71.272" class="difflineplus">+    }</span>
<a href="#l71.273"></a><span id="l71.273" class="difflineplus">+    orderedGroups.sort(comparatorHelper);</span>
<a href="#l71.274"></a><span id="l71.274" class="difflineplus">+    this.orderedGroups = orderedGroups;</span>
<a href="#l71.275"></a><span id="l71.275" class="difflineplus">+  },</span>
<a href="#l71.276"></a><span id="l71.276" class="difflineplus">+};</span>
<a href="#l71.277"></a><span id="l71.277" class="difflineplus">+</span>
<a href="#l71.278"></a><span id="l71.278" class="difflineplus">+/**</span>
<a href="#l71.279"></a><span id="l71.279" class="difflineplus">+ * Facet sets of discrete items.  For example, tags applied to messages.</span>
<a href="#l71.280"></a><span id="l71.280" class="difflineplus">+ *</span>
<a href="#l71.281"></a><span id="l71.281" class="difflineplus">+ * The main differences between us and |DiscreteFaceter| are:</span>
<a href="#l71.282"></a><span id="l71.282" class="difflineplus">+ * - The empty set is notable.</span>
<a href="#l71.283"></a><span id="l71.283" class="difflineplus">+ * - Specific set configurations could be interesting, but are not low-hanging</span>
<a href="#l71.284"></a><span id="l71.284" class="difflineplus">+ *    fruit.</span>
<a href="#l71.285"></a><span id="l71.285" class="difflineplus">+ */</span>
<a href="#l71.286"></a><span id="l71.286" class="difflineplus">+function DiscreteSetFaceter(aAttrDef) {</span>
<a href="#l71.287"></a><span id="l71.287" class="difflineplus">+  this.attrDef = aAttrDef;</span>
<a href="#l71.288"></a><span id="l71.288" class="difflineplus">+}</span>
<a href="#l71.289"></a><span id="l71.289" class="difflineplus">+DiscreteSetFaceter.prototype = {</span>
<a href="#l71.290"></a><span id="l71.290" class="difflineplus">+  type: &quot;discrete&quot;,</span>
<a href="#l71.291"></a><span id="l71.291" class="difflineplus">+  /**</span>
<a href="#l71.292"></a><span id="l71.292" class="difflineplus">+   * Facet the given set of items, deferring to the appropriate helper method</span>
<a href="#l71.293"></a><span id="l71.293" class="difflineplus">+   */</span>
<a href="#l71.294"></a><span id="l71.294" class="difflineplus">+  facetItems: function(aItems) {</span>
<a href="#l71.295"></a><span id="l71.295" class="difflineplus">+    if (this.attrDef.objectNounDef.isPrimitive)</span>
<a href="#l71.296"></a><span id="l71.296" class="difflineplus">+      return this.facetPrimitiveItems(aItems);</span>
<a href="#l71.297"></a><span id="l71.297" class="difflineplus">+    else</span>
<a href="#l71.298"></a><span id="l71.298" class="difflineplus">+      return this.facetComplexItems(aItems);</span>
<a href="#l71.299"></a><span id="l71.299" class="difflineplus">+  },</span>
<a href="#l71.300"></a><span id="l71.300" class="difflineplus">+  /**</span>
<a href="#l71.301"></a><span id="l71.301" class="difflineplus">+   * Facet an attribute whose value is primitive, meaning that it is a raw</span>
<a href="#l71.302"></a><span id="l71.302" class="difflineplus">+   *  numeric value or string, rather than a complex object.</span>
<a href="#l71.303"></a><span id="l71.303" class="difflineplus">+   */</span>
<a href="#l71.304"></a><span id="l71.304" class="difflineplus">+  facetPrimitiveItems: function(aItems) {</span>
<a href="#l71.305"></a><span id="l71.305" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l71.306"></a><span id="l71.306" class="difflineplus">+    let nounDef = this.attrDef.objectNounDef;</span>
<a href="#l71.307"></a><span id="l71.307" class="difflineplus">+    let filter = this.attrDef.facet.filter;</span>
<a href="#l71.308"></a><span id="l71.308" class="difflineplus">+</span>
<a href="#l71.309"></a><span id="l71.309" class="difflineplus">+    let groups = this.groups = {};</span>
<a href="#l71.310"></a><span id="l71.310" class="difflineplus">+    let valStrToVal = {};</span>
<a href="#l71.311"></a><span id="l71.311" class="difflineplus">+    this.groupCount = 0;</span>
<a href="#l71.312"></a><span id="l71.312" class="difflineplus">+</span>
<a href="#l71.313"></a><span id="l71.313" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l71.314"></a><span id="l71.314" class="difflineplus">+      let vals = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l71.315"></a><span id="l71.315" class="difflineplus">+      if (vals == null || vals.length == 0) {</span>
<a href="#l71.316"></a><span id="l71.316" class="difflineplus">+        vals = [null];</span>
<a href="#l71.317"></a><span id="l71.317" class="difflineplus">+      }</span>
<a href="#l71.318"></a><span id="l71.318" class="difflineplus">+      for each (let [, val] in Iterator(vals)) {</span>
<a href="#l71.319"></a><span id="l71.319" class="difflineplus">+        // skip items the filter tells us to ignore</span>
<a href="#l71.320"></a><span id="l71.320" class="difflineplus">+        if (filter &amp;&amp; !filter(val))</span>
<a href="#l71.321"></a><span id="l71.321" class="difflineplus">+          continue;</span>
<a href="#l71.322"></a><span id="l71.322" class="difflineplus">+</span>
<a href="#l71.323"></a><span id="l71.323" class="difflineplus">+        if (val in groups)</span>
<a href="#l71.324"></a><span id="l71.324" class="difflineplus">+          groups[val].push(item);</span>
<a href="#l71.325"></a><span id="l71.325" class="difflineplus">+        else {</span>
<a href="#l71.326"></a><span id="l71.326" class="difflineplus">+          groups[val] = [item];</span>
<a href="#l71.327"></a><span id="l71.327" class="difflineplus">+          valStrToVal[val] = val;</span>
<a href="#l71.328"></a><span id="l71.328" class="difflineplus">+          this.groupCount++;</span>
<a href="#l71.329"></a><span id="l71.329" class="difflineplus">+        }</span>
<a href="#l71.330"></a><span id="l71.330" class="difflineplus">+      }</span>
<a href="#l71.331"></a><span id="l71.331" class="difflineplus">+    }</span>
<a href="#l71.332"></a><span id="l71.332" class="difflineplus">+</span>
<a href="#l71.333"></a><span id="l71.333" class="difflineplus">+    let orderedGroups = [[valStrToVal[key], items] for each</span>
<a href="#l71.334"></a><span id="l71.334" class="difflineplus">+                         ([key, items] in Iterator(groups))];</span>
<a href="#l71.335"></a><span id="l71.335" class="difflineplus">+    let comparator = nounDef.comparator;</span>
<a href="#l71.336"></a><span id="l71.336" class="difflineplus">+    function comparatorHelper(a, b) {</span>
<a href="#l71.337"></a><span id="l71.337" class="difflineplus">+      return comparator(a[0], b[0]);</span>
<a href="#l71.338"></a><span id="l71.338" class="difflineplus">+    }</span>
<a href="#l71.339"></a><span id="l71.339" class="difflineplus">+    orderedGroups.sort(comparatorHelper);</span>
<a href="#l71.340"></a><span id="l71.340" class="difflineplus">+    this.orderedGroups = orderedGroups;</span>
<a href="#l71.341"></a><span id="l71.341" class="difflineplus">+  },</span>
<a href="#l71.342"></a><span id="l71.342" class="difflineplus">+  /**</span>
<a href="#l71.343"></a><span id="l71.343" class="difflineplus">+   * Facet an attribute whose value is a complex object that can be identified</span>
<a href="#l71.344"></a><span id="l71.344" class="difflineplus">+   *  by its 'id' attribute.  This is the case where the value is itself a noun</span>
<a href="#l71.345"></a><span id="l71.345" class="difflineplus">+   *  instance.</span>
<a href="#l71.346"></a><span id="l71.346" class="difflineplus">+   */</span>
<a href="#l71.347"></a><span id="l71.347" class="difflineplus">+  facetComplexItems: function(aItems) {</span>
<a href="#l71.348"></a><span id="l71.348" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l71.349"></a><span id="l71.349" class="difflineplus">+    let nounDef = this.attrDef.objectNounDef;</span>
<a href="#l71.350"></a><span id="l71.350" class="difflineplus">+    let filter = this.attrDef.facet.filter;</span>
<a href="#l71.351"></a><span id="l71.351" class="difflineplus">+    let idAttr = this.attrDef.facet.groupIdAttr;</span>
<a href="#l71.352"></a><span id="l71.352" class="difflineplus">+</span>
<a href="#l71.353"></a><span id="l71.353" class="difflineplus">+    let groups = this.groups = {};</span>
<a href="#l71.354"></a><span id="l71.354" class="difflineplus">+    let groupMap = this.groupMap = {};</span>
<a href="#l71.355"></a><span id="l71.355" class="difflineplus">+    this.groupCount = 0;</span>
<a href="#l71.356"></a><span id="l71.356" class="difflineplus">+</span>
<a href="#l71.357"></a><span id="l71.357" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l71.358"></a><span id="l71.358" class="difflineplus">+      let vals = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l71.359"></a><span id="l71.359" class="difflineplus">+      if (vals == null || vals.length == 0) {</span>
<a href="#l71.360"></a><span id="l71.360" class="difflineplus">+        vals = [null];</span>
<a href="#l71.361"></a><span id="l71.361" class="difflineplus">+      }</span>
<a href="#l71.362"></a><span id="l71.362" class="difflineplus">+      for each (let [, val] in Iterator(vals)) {</span>
<a href="#l71.363"></a><span id="l71.363" class="difflineplus">+        // skip items the filter tells us to ignore</span>
<a href="#l71.364"></a><span id="l71.364" class="difflineplus">+        if (filter &amp;&amp; !filter(val))</span>
<a href="#l71.365"></a><span id="l71.365" class="difflineplus">+          continue;</span>
<a href="#l71.366"></a><span id="l71.366" class="difflineplus">+</span>
<a href="#l71.367"></a><span id="l71.367" class="difflineplus">+        let valId = (val == null) ? null : val[idAttr];</span>
<a href="#l71.368"></a><span id="l71.368" class="difflineplus">+        if (valId in groupMap) {</span>
<a href="#l71.369"></a><span id="l71.369" class="difflineplus">+          groups[valId].push(item);</span>
<a href="#l71.370"></a><span id="l71.370" class="difflineplus">+        }</span>
<a href="#l71.371"></a><span id="l71.371" class="difflineplus">+        else {</span>
<a href="#l71.372"></a><span id="l71.372" class="difflineplus">+          groupMap[valId] = val;</span>
<a href="#l71.373"></a><span id="l71.373" class="difflineplus">+          groups[valId] = [item];</span>
<a href="#l71.374"></a><span id="l71.374" class="difflineplus">+          this.groupCount++;</span>
<a href="#l71.375"></a><span id="l71.375" class="difflineplus">+        }</span>
<a href="#l71.376"></a><span id="l71.376" class="difflineplus">+      }</span>
<a href="#l71.377"></a><span id="l71.377" class="difflineplus">+    }</span>
<a href="#l71.378"></a><span id="l71.378" class="difflineplus">+</span>
<a href="#l71.379"></a><span id="l71.379" class="difflineplus">+    let orderedGroups = [[groupMap[key], items] for each</span>
<a href="#l71.380"></a><span id="l71.380" class="difflineplus">+                         ([key, items] in Iterator(groups))];</span>
<a href="#l71.381"></a><span id="l71.381" class="difflineplus">+    let comparator = nounDef.comparator;</span>
<a href="#l71.382"></a><span id="l71.382" class="difflineplus">+    function comparatorHelper(a, b) {</span>
<a href="#l71.383"></a><span id="l71.383" class="difflineplus">+      return comparator(a[0], b[0]);</span>
<a href="#l71.384"></a><span id="l71.384" class="difflineplus">+    }</span>
<a href="#l71.385"></a><span id="l71.385" class="difflineplus">+    orderedGroups.sort(comparatorHelper);</span>
<a href="#l71.386"></a><span id="l71.386" class="difflineplus">+    this.orderedGroups = orderedGroups;</span>
<a href="#l71.387"></a><span id="l71.387" class="difflineplus">+  },</span>
<a href="#l71.388"></a><span id="l71.388" class="difflineplus">+};</span>
<a href="#l71.389"></a><span id="l71.389" class="difflineplus">+</span>
<a href="#l71.390"></a><span id="l71.390" class="difflineplus">+/**</span>
<a href="#l71.391"></a><span id="l71.391" class="difflineplus">+ * Given a non-singular attribute, facet it as if it were a boolean based on</span>
<a href="#l71.392"></a><span id="l71.392" class="difflineplus">+ *  whether there is anything in the list (set).</span>
<a href="#l71.393"></a><span id="l71.393" class="difflineplus">+ */</span>
<a href="#l71.394"></a><span id="l71.394" class="difflineplus">+function NonEmptySetFaceter(aAttrDef) {</span>
<a href="#l71.395"></a><span id="l71.395" class="difflineplus">+  this.attrDef = aAttrDef;</span>
<a href="#l71.396"></a><span id="l71.396" class="difflineplus">+}</span>
<a href="#l71.397"></a><span id="l71.397" class="difflineplus">+NonEmptySetFaceter.prototype = {</span>
<a href="#l71.398"></a><span id="l71.398" class="difflineplus">+  type: &quot;boolean&quot;,</span>
<a href="#l71.399"></a><span id="l71.399" class="difflineplus">+  /**</span>
<a href="#l71.400"></a><span id="l71.400" class="difflineplus">+   * Facet the given set of items, deferring to the appropriate helper method</span>
<a href="#l71.401"></a><span id="l71.401" class="difflineplus">+   */</span>
<a href="#l71.402"></a><span id="l71.402" class="difflineplus">+  facetItems: function(aItems) {</span>
<a href="#l71.403"></a><span id="l71.403" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l71.404"></a><span id="l71.404" class="difflineplus">+    let nounDef = this.attrDef.objectNounDef;</span>
<a href="#l71.405"></a><span id="l71.405" class="difflineplus">+</span>
<a href="#l71.406"></a><span id="l71.406" class="difflineplus">+    let trueValues = [];</span>
<a href="#l71.407"></a><span id="l71.407" class="difflineplus">+    let falseValues = [];</span>
<a href="#l71.408"></a><span id="l71.408" class="difflineplus">+</span>
<a href="#l71.409"></a><span id="l71.409" class="difflineplus">+    let groups = this.groups = {};</span>
<a href="#l71.410"></a><span id="l71.410" class="difflineplus">+    this.groupCount = 0;</span>
<a href="#l71.411"></a><span id="l71.411" class="difflineplus">+</span>
<a href="#l71.412"></a><span id="l71.412" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l71.413"></a><span id="l71.413" class="difflineplus">+      let vals = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l71.414"></a><span id="l71.414" class="difflineplus">+      if (vals == null || vals.length == 0)</span>
<a href="#l71.415"></a><span id="l71.415" class="difflineplus">+        falseValues.push(item);</span>
<a href="#l71.416"></a><span id="l71.416" class="difflineplus">+      else</span>
<a href="#l71.417"></a><span id="l71.417" class="difflineplus">+        trueValues.push(item);</span>
<a href="#l71.418"></a><span id="l71.418" class="difflineplus">+    }</span>
<a href="#l71.419"></a><span id="l71.419" class="difflineplus">+</span>
<a href="#l71.420"></a><span id="l71.420" class="difflineplus">+    this.orderedGroups = [];</span>
<a href="#l71.421"></a><span id="l71.421" class="difflineplus">+    if (trueValues.length)</span>
<a href="#l71.422"></a><span id="l71.422" class="difflineplus">+      this.orderedGroups.push([true, trueValues]);</span>
<a href="#l71.423"></a><span id="l71.423" class="difflineplus">+    if (falseValues.length)</span>
<a href="#l71.424"></a><span id="l71.424" class="difflineplus">+      this.orderedGroups.push([false, falseValues]);</span>
<a href="#l71.425"></a><span id="l71.425" class="difflineplus">+    this.groupCount = this.orderedGroups.length;</span>
<a href="#l71.426"></a><span id="l71.426" class="difflineplus">+  },</span>
<a href="#l71.427"></a><span id="l71.427" class="difflineplus">+  makeQuery: function(aGroupValues, aInclusive) {</span>
<a href="#l71.428"></a><span id="l71.428" class="difflineplus">+    let query = this.query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l71.429"></a><span id="l71.429" class="difflineplus">+</span>
<a href="#l71.430"></a><span id="l71.430" class="difflineplus">+    let constraintFunc = query[this.attrDef.boundName];</span>
<a href="#l71.431"></a><span id="l71.431" class="difflineplus">+    constraintFunc.call(query);</span>
<a href="#l71.432"></a><span id="l71.432" class="difflineplus">+</span>
<a href="#l71.433"></a><span id="l71.433" class="difflineplus">+    // Our query is always for non-empty lists (at this time), so we want to</span>
<a href="#l71.434"></a><span id="l71.434" class="difflineplus">+    //  invert if they're excluding 'true' or including 'false', which means !=.</span>
<a href="#l71.435"></a><span id="l71.435" class="difflineplus">+    let invert = aGroupValues[0] != aInclusive;</span>
<a href="#l71.436"></a><span id="l71.436" class="difflineplus">+</span>
<a href="#l71.437"></a><span id="l71.437" class="difflineplus">+    return [query, invert];</span>
<a href="#l71.438"></a><span id="l71.438" class="difflineplus">+  }</span>
<a href="#l71.439"></a><span id="l71.439" class="difflineplus">+};</span>
<a href="#l71.440"></a><span id="l71.440" class="difflineplus">+</span>
<a href="#l71.441"></a><span id="l71.441" class="difflineplus">+</span>
<a href="#l71.442"></a><span id="l71.442" class="difflineplus">+/**</span>
<a href="#l71.443"></a><span id="l71.443" class="difflineplus">+ * Facet dates.  We build a hierarchical nested structure of year, month, and</span>
<a href="#l71.444"></a><span id="l71.444" class="difflineplus">+ *  day nesting levels.  This decision was made speculatively in the hopes that</span>
<a href="#l71.445"></a><span id="l71.445" class="difflineplus">+ *  it would allow us to do clustered analysis and that there might be a benefit</span>
<a href="#l71.446"></a><span id="l71.446" class="difflineplus">+ *  for that.  For example, if you search for &quot;Christmas&quot;, we might notice</span>
<a href="#l71.447"></a><span id="l71.447" class="difflineplus">+ *  clusters of messages around December of each year.  We could then present</span>
<a href="#l71.448"></a><span id="l71.448" class="difflineplus">+ *  these in a list as likely candidates, rather than a graphical timeline.</span>
<a href="#l71.449"></a><span id="l71.449" class="difflineplus">+ *  Alternately, it could be used to inform a non-linear visualization.  As it</span>
<a href="#l71.450"></a><span id="l71.450" class="difflineplus">+ *  stands (as of this writing), it's just a complicating factor.</span>
<a href="#l71.451"></a><span id="l71.451" class="difflineplus">+ */</span>
<a href="#l71.452"></a><span id="l71.452" class="difflineplus">+function DateFaceter(aAttrDef) {</span>
<a href="#l71.453"></a><span id="l71.453" class="difflineplus">+  this.attrDef = aAttrDef;</span>
<a href="#l71.454"></a><span id="l71.454" class="difflineplus">+}</span>
<a href="#l71.455"></a><span id="l71.455" class="difflineplus">+DateFaceter.prototype = {</span>
<a href="#l71.456"></a><span id="l71.456" class="difflineplus">+  type: &quot;date&quot;,</span>
<a href="#l71.457"></a><span id="l71.457" class="difflineplus">+  /**</span>
<a href="#l71.458"></a><span id="l71.458" class="difflineplus">+   *</span>
<a href="#l71.459"></a><span id="l71.459" class="difflineplus">+   */</span>
<a href="#l71.460"></a><span id="l71.460" class="difflineplus">+  facetItems: function(aItems) {</span>
<a href="#l71.461"></a><span id="l71.461" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l71.462"></a><span id="l71.462" class="difflineplus">+    let nounDef = this.attrDef.objectNounDef;</span>
<a href="#l71.463"></a><span id="l71.463" class="difflineplus">+</span>
<a href="#l71.464"></a><span id="l71.464" class="difflineplus">+    let years = this.years = {_subCount: 0};</span>
<a href="#l71.465"></a><span id="l71.465" class="difflineplus">+    // generally track the time range</span>
<a href="#l71.466"></a><span id="l71.466" class="difflineplus">+    let oldest = null, newest = null;</span>
<a href="#l71.467"></a><span id="l71.467" class="difflineplus">+</span>
<a href="#l71.468"></a><span id="l71.468" class="difflineplus">+    let validItems = this.validItems = [];</span>
<a href="#l71.469"></a><span id="l71.469" class="difflineplus">+</span>
<a href="#l71.470"></a><span id="l71.470" class="difflineplus">+    // just cheat and put us at the front...</span>
<a href="#l71.471"></a><span id="l71.471" class="difflineplus">+    this.groupCount = aItems.length ? 1000 : 0;</span>
<a href="#l71.472"></a><span id="l71.472" class="difflineplus">+    this.orderedGroups = null;</span>
<a href="#l71.473"></a><span id="l71.473" class="difflineplus">+</span>
<a href="#l71.474"></a><span id="l71.474" class="difflineplus">+    /** The number of items with a null/missing attribute. */</span>
<a href="#l71.475"></a><span id="l71.475" class="difflineplus">+    this.missing = 0;</span>
<a href="#l71.476"></a><span id="l71.476" class="difflineplus">+</span>
<a href="#l71.477"></a><span id="l71.477" class="difflineplus">+    /**</span>
<a href="#l71.478"></a><span id="l71.478" class="difflineplus">+     * The number of items with a date that is unreasonably far in the past or</span>
<a href="#l71.479"></a><span id="l71.479" class="difflineplus">+     *  in the future.  Old-wise, we are concerned about incorrectly formatted</span>
<a href="#l71.480"></a><span id="l71.480" class="difflineplus">+     *  messages (spam) that end up placed around the UNIX epoch.  New-wise,</span>
<a href="#l71.481"></a><span id="l71.481" class="difflineplus">+     *  we are concerned about messages that can't be explained by users who</span>
<a href="#l71.482"></a><span id="l71.482" class="difflineplus">+     *  don't know how to set their clocks (both the current user and people</span>
<a href="#l71.483"></a><span id="l71.483" class="difflineplus">+     *  sending them mail), mainly meaning spam.</span>
<a href="#l71.484"></a><span id="l71.484" class="difflineplus">+     * We want to avoid having our clever time-scale logic being made useless by</span>
<a href="#l71.485"></a><span id="l71.485" class="difflineplus">+     *  these unreasonable messages.</span>
<a href="#l71.486"></a><span id="l71.486" class="difflineplus">+     */</span>
<a href="#l71.487"></a><span id="l71.487" class="difflineplus">+    this.unreasonable = 0;</span>
<a href="#l71.488"></a><span id="l71.488" class="difflineplus">+    // feb 1, 1970</span>
<a href="#l71.489"></a><span id="l71.489" class="difflineplus">+    let tooOld = new Date(1970, 1, 1);</span>
<a href="#l71.490"></a><span id="l71.490" class="difflineplus">+    // 3 days from now</span>
<a href="#l71.491"></a><span id="l71.491" class="difflineplus">+    let tooNew = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000);</span>
<a href="#l71.492"></a><span id="l71.492" class="difflineplus">+</span>
<a href="#l71.493"></a><span id="l71.493" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l71.494"></a><span id="l71.494" class="difflineplus">+      let val = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l71.495"></a><span id="l71.495" class="difflineplus">+      // -- missing</span>
<a href="#l71.496"></a><span id="l71.496" class="difflineplus">+      if (val == null) {</span>
<a href="#l71.497"></a><span id="l71.497" class="difflineplus">+        this.missing++;</span>
<a href="#l71.498"></a><span id="l71.498" class="difflineplus">+        continue;</span>
<a href="#l71.499"></a><span id="l71.499" class="difflineplus">+      }</span>
<a href="#l71.500"></a><span id="l71.500" class="difflineplus">+</span>
<a href="#l71.501"></a><span id="l71.501" class="difflineplus">+      // -- unreasonable</span>
<a href="#l71.502"></a><span id="l71.502" class="difflineplus">+      if (val &lt; tooOld || val &gt; tooNew) {</span>
<a href="#l71.503"></a><span id="l71.503" class="difflineplus">+        this.unreasonable++;</span>
<a href="#l71.504"></a><span id="l71.504" class="difflineplus">+        continue;</span>
<a href="#l71.505"></a><span id="l71.505" class="difflineplus">+      }</span>
<a href="#l71.506"></a><span id="l71.506" class="difflineplus">+</span>
<a href="#l71.507"></a><span id="l71.507" class="difflineplus">+      this.validItems.push(item);</span>
<a href="#l71.508"></a><span id="l71.508" class="difflineplus">+</span>
<a href="#l71.509"></a><span id="l71.509" class="difflineplus">+      // -- time range</span>
<a href="#l71.510"></a><span id="l71.510" class="difflineplus">+      if (oldest == null)</span>
<a href="#l71.511"></a><span id="l71.511" class="difflineplus">+        oldest = newest = val;</span>
<a href="#l71.512"></a><span id="l71.512" class="difflineplus">+      else if (val &lt; oldest)</span>
<a href="#l71.513"></a><span id="l71.513" class="difflineplus">+        oldest = val;</span>
<a href="#l71.514"></a><span id="l71.514" class="difflineplus">+      else if (val &gt; newest)</span>
<a href="#l71.515"></a><span id="l71.515" class="difflineplus">+        newest = val;</span>
<a href="#l71.516"></a><span id="l71.516" class="difflineplus">+</span>
<a href="#l71.517"></a><span id="l71.517" class="difflineplus">+      // -- bucket</span>
<a href="#l71.518"></a><span id="l71.518" class="difflineplus">+      // - year</span>
<a href="#l71.519"></a><span id="l71.519" class="difflineplus">+      let year, valYear = val.getYear();</span>
<a href="#l71.520"></a><span id="l71.520" class="difflineplus">+      if (valYear in years) {</span>
<a href="#l71.521"></a><span id="l71.521" class="difflineplus">+        year = years[valYear];</span>
<a href="#l71.522"></a><span id="l71.522" class="difflineplus">+        year._dateCount++;</span>
<a href="#l71.523"></a><span id="l71.523" class="difflineplus">+      }</span>
<a href="#l71.524"></a><span id="l71.524" class="difflineplus">+      else {</span>
<a href="#l71.525"></a><span id="l71.525" class="difflineplus">+        year = years[valYear] = {</span>
<a href="#l71.526"></a><span id="l71.526" class="difflineplus">+          _dateCount: 1,</span>
<a href="#l71.527"></a><span id="l71.527" class="difflineplus">+          _subCount: 0</span>
<a href="#l71.528"></a><span id="l71.528" class="difflineplus">+        };</span>
<a href="#l71.529"></a><span id="l71.529" class="difflineplus">+        years._subCount++;</span>
<a href="#l71.530"></a><span id="l71.530" class="difflineplus">+      }</span>
<a href="#l71.531"></a><span id="l71.531" class="difflineplus">+</span>
<a href="#l71.532"></a><span id="l71.532" class="difflineplus">+      // - month</span>
<a href="#l71.533"></a><span id="l71.533" class="difflineplus">+      let month, valMonth = val.getMonth();</span>
<a href="#l71.534"></a><span id="l71.534" class="difflineplus">+      if (valMonth in year) {</span>
<a href="#l71.535"></a><span id="l71.535" class="difflineplus">+        month = year[valMonth];</span>
<a href="#l71.536"></a><span id="l71.536" class="difflineplus">+        month._dateCount++;</span>
<a href="#l71.537"></a><span id="l71.537" class="difflineplus">+      }</span>
<a href="#l71.538"></a><span id="l71.538" class="difflineplus">+      else {</span>
<a href="#l71.539"></a><span id="l71.539" class="difflineplus">+        month = year[valMonth] = {</span>
<a href="#l71.540"></a><span id="l71.540" class="difflineplus">+          _dateCount: 1,</span>
<a href="#l71.541"></a><span id="l71.541" class="difflineplus">+          _subCount: 0</span>
<a href="#l71.542"></a><span id="l71.542" class="difflineplus">+        };</span>
<a href="#l71.543"></a><span id="l71.543" class="difflineplus">+        year._subCount++;</span>
<a href="#l71.544"></a><span id="l71.544" class="difflineplus">+      }</span>
<a href="#l71.545"></a><span id="l71.545" class="difflineplus">+</span>
<a href="#l71.546"></a><span id="l71.546" class="difflineplus">+      // - day</span>
<a href="#l71.547"></a><span id="l71.547" class="difflineplus">+      let valDate = val.getDate();</span>
<a href="#l71.548"></a><span id="l71.548" class="difflineplus">+      if (valDate in month) {</span>
<a href="#l71.549"></a><span id="l71.549" class="difflineplus">+        month[valDate].push(item);</span>
<a href="#l71.550"></a><span id="l71.550" class="difflineplus">+      }</span>
<a href="#l71.551"></a><span id="l71.551" class="difflineplus">+      else {</span>
<a href="#l71.552"></a><span id="l71.552" class="difflineplus">+        month[valDate] = [item];</span>
<a href="#l71.553"></a><span id="l71.553" class="difflineplus">+      }</span>
<a href="#l71.554"></a><span id="l71.554" class="difflineplus">+    }</span>
<a href="#l71.555"></a><span id="l71.555" class="difflineplus">+</span>
<a href="#l71.556"></a><span id="l71.556" class="difflineplus">+    this.oldest = oldest;</span>
<a href="#l71.557"></a><span id="l71.557" class="difflineplus">+    this.newest = newest;</span>
<a href="#l71.558"></a><span id="l71.558" class="difflineplus">+  },</span>
<a href="#l71.559"></a><span id="l71.559" class="difflineplus">+</span>
<a href="#l71.560"></a><span id="l71.560" class="difflineplus">+  _unionMonth: function(aMonthObj) {</span>
<a href="#l71.561"></a><span id="l71.561" class="difflineplus">+    let dayItemLists = [];</span>
<a href="#l71.562"></a><span id="l71.562" class="difflineplus">+    for each (let [key, dayItemList] in Iterator(aMonthObj)) {</span>
<a href="#l71.563"></a><span id="l71.563" class="difflineplus">+      if (typeof(key) == &quot;string&quot; &amp;&amp; key[0] == '_')</span>
<a href="#l71.564"></a><span id="l71.564" class="difflineplus">+        continue;</span>
<a href="#l71.565"></a><span id="l71.565" class="difflineplus">+      dayItemLists.push(dayItemList);</span>
<a href="#l71.566"></a><span id="l71.566" class="difflineplus">+    }</span>
<a href="#l71.567"></a><span id="l71.567" class="difflineplus">+    return Array.concat.apply([], dayItemLists);</span>
<a href="#l71.568"></a><span id="l71.568" class="difflineplus">+  },</span>
<a href="#l71.569"></a><span id="l71.569" class="difflineplus">+</span>
<a href="#l71.570"></a><span id="l71.570" class="difflineplus">+  _unionYear: function(aYearObj) {</span>
<a href="#l71.571"></a><span id="l71.571" class="difflineplus">+    let monthItemLists = [];</span>
<a href="#l71.572"></a><span id="l71.572" class="difflineplus">+    for each (let [key, monthObj] in Iterator(aYearObj)) {</span>
<a href="#l71.573"></a><span id="l71.573" class="difflineplus">+      if (typeof(key) == &quot;string&quot; &amp;&amp; key[0] == '_')</span>
<a href="#l71.574"></a><span id="l71.574" class="difflineplus">+        continue;</span>
<a href="#l71.575"></a><span id="l71.575" class="difflineplus">+      monthItemLists.push(this._unionMonth(monthObj));</span>
<a href="#l71.576"></a><span id="l71.576" class="difflineplus">+    }</span>
<a href="#l71.577"></a><span id="l71.577" class="difflineplus">+    return Array.concat.apply([], monthItemLists);</span>
<a href="#l71.578"></a><span id="l71.578" class="difflineplus">+  }</span>
<a href="#l71.579"></a><span id="l71.579" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -38,16 +38,17 @@</span>
<a href="#l72.4"></a><span id="l72.4"> EXPORTED_SYMBOLS = ['GlodaFundAttr'];</span>
<a href="#l72.5"></a><span id="l72.5"> </span>
<a href="#l72.6"></a><span id="l72.6"> const Cc = Components.classes;</span>
<a href="#l72.7"></a><span id="l72.7"> const Ci = Components.interfaces;</span>
<a href="#l72.8"></a><span id="l72.8"> const Cr = Components.results;</span>
<a href="#l72.9"></a><span id="l72.9"> const Cu = Components.utils;</span>
<a href="#l72.10"></a><span id="l72.10"> </span>
<a href="#l72.11"></a><span id="l72.11"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l72.12"></a><span id="l72.12" class="difflineplus">+Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l72.13"></a><span id="l72.13"> </span>
<a href="#l72.14"></a><span id="l72.14"> Cu.import(&quot;resource://app/modules/gloda/utils.js&quot;);</span>
<a href="#l72.15"></a><span id="l72.15"> Cu.import(&quot;resource://app/modules/gloda/gloda.js&quot;);</span>
<a href="#l72.16"></a><span id="l72.16"> Cu.import(&quot;resource://app/modules/gloda/datastore.js&quot;);</span>
<a href="#l72.17"></a><span id="l72.17"> </span>
<a href="#l72.18"></a><span id="l72.18"> Cu.import(&quot;resource://app/modules/gloda/noun_mimetype.js&quot;);</span>
<a href="#l72.19"></a><span id="l72.19"> Cu.import(&quot;resource://app/modules/gloda/connotent.js&quot;);</span>
<a href="#l72.20"></a><span id="l72.20"> </span>
<a href="#l72.21"></a><span id="l72.21" class="difflineat">@@ -55,59 +56,50 @@ Cu.import(&quot;resource://app/modules/gloda/</span>
<a href="#l72.22"></a><span id="l72.22">  * @namespace The Gloda Fundamental Attribute provider is a special attribute</span>
<a href="#l72.23"></a><span id="l72.23">  *  provider; it provides attributes that the rest of the providers should be</span>
<a href="#l72.24"></a><span id="l72.24">  *  able to assume exist.  Also, it may end up accessing things at a lower level</span>
<a href="#l72.25"></a><span id="l72.25">  *  than most extension providers should do.  In summary, don't mimic this code</span>
<a href="#l72.26"></a><span id="l72.26">  *  unless you won't complain when your code breaks.</span>
<a href="#l72.27"></a><span id="l72.27">  */</span>
<a href="#l72.28"></a><span id="l72.28"> var GlodaFundAttr = {</span>
<a href="#l72.29"></a><span id="l72.29">   providerName: &quot;gloda.fundattr&quot;,</span>
<a href="#l72.30"></a><span id="l72.30" class="difflineplus">+  strings: new StringBundle(&quot;chrome://messenger/locale/gloda.properties&quot;),</span>
<a href="#l72.31"></a><span id="l72.31">   _log: null,</span>
<a href="#l72.32"></a><span id="l72.32"> </span>
<a href="#l72.33"></a><span id="l72.33">   init: function gloda_explattr_init() {</span>
<a href="#l72.34"></a><span id="l72.34">     this._log =  Log4Moz.repository.getLogger(&quot;gloda.fundattr&quot;);</span>
<a href="#l72.35"></a><span id="l72.35"> </span>
<a href="#l72.36"></a><span id="l72.36">     try {</span>
<a href="#l72.37"></a><span id="l72.37">       this.defineAttributes();</span>
<a href="#l72.38"></a><span id="l72.38">     }</span>
<a href="#l72.39"></a><span id="l72.39">     catch (ex) {</span>
<a href="#l72.40"></a><span id="l72.40">       this._log.error(&quot;Error in init: &quot; + ex);</span>
<a href="#l72.41"></a><span id="l72.41">       throw ex;</span>
<a href="#l72.42"></a><span id="l72.42">     }</span>
<a href="#l72.43"></a><span id="l72.43">   },</span>
<a href="#l72.44"></a><span id="l72.44"> </span>
<a href="#l72.45"></a><span id="l72.45">   POPULARITY_FROM_ME_TO: 10,</span>
<a href="#l72.46"></a><span id="l72.46">   POPULARITY_FROM_ME_CC: 4,</span>
<a href="#l72.47"></a><span id="l72.47" class="difflineplus">+  POPULARITY_FROM_ME_BCC: 3,</span>
<a href="#l72.48"></a><span id="l72.48">   POPULARITY_TO_ME: 5,</span>
<a href="#l72.49"></a><span id="l72.49">   POPULARITY_CC_ME: 1,</span>
<a href="#l72.50"></a><span id="l72.50" class="difflineplus">+  POPULARITY_BCC_ME: 1,</span>
<a href="#l72.51"></a><span id="l72.51"> </span>
<a href="#l72.52"></a><span id="l72.52">   /** Boost for messages 'I' sent */</span>
<a href="#l72.53"></a><span id="l72.53">   NOTABILITY_FROM_ME: 10,</span>
<a href="#l72.54"></a><span id="l72.54">   /** Boost for messages involving 'me'. */</span>
<a href="#l72.55"></a><span id="l72.55">   NOTABILITY_INVOLVING_ME: 1,</span>
<a href="#l72.56"></a><span id="l72.56">   /** Boost for message from someone in 'my' address book. */</span>
<a href="#l72.57"></a><span id="l72.57">   NOTABILITY_FROM_IN_ADDR_BOOK: 10,</span>
<a href="#l72.58"></a><span id="l72.58">   /** Boost for the first person involved in my address book. */</span>
<a href="#l72.59"></a><span id="l72.59">   NOTABILITY_INVOLVING_ADDR_BOOK_FIRST: 8,</span>
<a href="#l72.60"></a><span id="l72.60">   /** Boost for each additional person involved in my address book. */</span>
<a href="#l72.61"></a><span id="l72.61">   NOTABILITY_INVOLVING_ADDR_BOOK_ADDL: 2,</span>
<a href="#l72.62"></a><span id="l72.62"> </span>
<a href="#l72.63"></a><span id="l72.63" class="difflineminus">-  _attrConvSubject: null,</span>
<a href="#l72.64"></a><span id="l72.64" class="difflineminus">-  _attrFolder: null,</span>
<a href="#l72.65"></a><span id="l72.65" class="difflineminus">-  _attrBody: null,</span>
<a href="#l72.66"></a><span id="l72.66" class="difflineminus">-  _attrFrom: null,</span>
<a href="#l72.67"></a><span id="l72.67" class="difflineminus">-  _attrFromMe: null,</span>
<a href="#l72.68"></a><span id="l72.68" class="difflineminus">-  _attrTo: null,</span>
<a href="#l72.69"></a><span id="l72.69" class="difflineminus">-  _attrToMe: null,</span>
<a href="#l72.70"></a><span id="l72.70" class="difflineminus">-  _attrCc: null,</span>
<a href="#l72.71"></a><span id="l72.71" class="difflineminus">-  _attrCcMe: null,</span>
<a href="#l72.72"></a><span id="l72.72" class="difflineminus">-  _attrDate: null,</span>
<a href="#l72.73"></a><span id="l72.73" class="difflineminus">-  _attrHeaderMessageID: null,</span>
<a href="#l72.74"></a><span id="l72.74" class="difflineminus">-</span>
<a href="#l72.75"></a><span id="l72.75" class="difflineminus">-  defineAttributes: function() {</span>
<a href="#l72.76"></a><span id="l72.76" class="difflineplus">+  defineAttributes: function gloda_fundattr_defineAttributes() {</span>
<a href="#l72.77"></a><span id="l72.77">     /* ***** Conversations ***** */</span>
<a href="#l72.78"></a><span id="l72.78">     // conversation: subjectMatches</span>
<a href="#l72.79"></a><span id="l72.79">     this._attrConvSubject = Gloda.defineAttribute({</span>
<a href="#l72.80"></a><span id="l72.80">       provider: this,</span>
<a href="#l72.81"></a><span id="l72.81">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.82"></a><span id="l72.82">       attributeType: Gloda.kAttrDerived,</span>
<a href="#l72.83"></a><span id="l72.83">       attributeName: &quot;subjectMatches&quot;,</span>
<a href="#l72.84"></a><span id="l72.84">       singular: true,</span>
<a href="#l72.85"></a><span id="l72.85" class="difflineat">@@ -120,16 +112,17 @@ var GlodaFundAttr = {</span>
<a href="#l72.86"></a><span id="l72.86">     /* ***** Messages ***** */</span>
<a href="#l72.87"></a><span id="l72.87">     // folder</span>
<a href="#l72.88"></a><span id="l72.88">     this._attrFolder = Gloda.defineAttribute({</span>
<a href="#l72.89"></a><span id="l72.89">       provider: this,</span>
<a href="#l72.90"></a><span id="l72.90">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.91"></a><span id="l72.91">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l72.92"></a><span id="l72.92">       attributeName: &quot;folder&quot;,</span>
<a href="#l72.93"></a><span id="l72.93">       singular: true,</span>
<a href="#l72.94"></a><span id="l72.94" class="difflineplus">+      facet: true,</span>
<a href="#l72.95"></a><span id="l72.95">       special: Gloda.kSpecialColumn,</span>
<a href="#l72.96"></a><span id="l72.96">       specialColumnName: &quot;folderID&quot;,</span>
<a href="#l72.97"></a><span id="l72.97">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l72.98"></a><span id="l72.98">       objectNoun: Gloda.NOUN_FOLDER,</span>
<a href="#l72.99"></a><span id="l72.99">       }); // tested-by: test_attributes_fundamental</span>
<a href="#l72.100"></a><span id="l72.100">     this._attrFolder = Gloda.defineAttribute({</span>
<a href="#l72.101"></a><span id="l72.101">       provider: this,</span>
<a href="#l72.102"></a><span id="l72.102">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.103"></a><span id="l72.103" class="difflineat">@@ -268,24 +261,39 @@ var GlodaFundAttr = {</span>
<a href="#l72.104"></a><span id="l72.104">                         provider: this,</span>
<a href="#l72.105"></a><span id="l72.105">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.106"></a><span id="l72.106">                         attributeType: Gloda.kAttrFundamental,</span>
<a href="#l72.107"></a><span id="l72.107">                         attributeName: &quot;cc&quot;,</span>
<a href="#l72.108"></a><span id="l72.108">                         singular: false,</span>
<a href="#l72.109"></a><span id="l72.109">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l72.110"></a><span id="l72.110">                         objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l72.111"></a><span id="l72.111">                         }); // not-tested</span>
<a href="#l72.112"></a><span id="l72.112" class="difflineplus">+    /**</span>
<a href="#l72.113"></a><span id="l72.113" class="difflineplus">+     * Bcc'ed recipients; only makes sense for sent messages.</span>
<a href="#l72.114"></a><span id="l72.114" class="difflineplus">+     */</span>
<a href="#l72.115"></a><span id="l72.115" class="difflineplus">+    this._attrBcc = Gloda.defineAttribute({</span>
<a href="#l72.116"></a><span id="l72.116" class="difflineplus">+      provider: this,</span>
<a href="#l72.117"></a><span id="l72.117" class="difflineplus">+      extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.118"></a><span id="l72.118" class="difflineplus">+      attributeType: Gloda.kAttrFundamental,</span>
<a href="#l72.119"></a><span id="l72.119" class="difflineplus">+      attributeName: &quot;bcc&quot;,</span>
<a href="#l72.120"></a><span id="l72.120" class="difflineplus">+      singular: false,</span>
<a href="#l72.121"></a><span id="l72.121" class="difflineplus">+      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l72.122"></a><span id="l72.122" class="difflineplus">+      objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l72.123"></a><span id="l72.123" class="difflineplus">+    }); // not-tested</span>
<a href="#l72.124"></a><span id="l72.124"> </span>
<a href="#l72.125"></a><span id="l72.125">     // Date.  now lives on the row.</span>
<a href="#l72.126"></a><span id="l72.126">     this._attrDate = Gloda.defineAttribute({</span>
<a href="#l72.127"></a><span id="l72.127">                         provider: this,</span>
<a href="#l72.128"></a><span id="l72.128">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.129"></a><span id="l72.129">                         attributeType: Gloda.kAttrFundamental,</span>
<a href="#l72.130"></a><span id="l72.130">                         attributeName: &quot;date&quot;,</span>
<a href="#l72.131"></a><span id="l72.131">                         singular: true,</span>
<a href="#l72.132"></a><span id="l72.132" class="difflineplus">+                        facet: {</span>
<a href="#l72.133"></a><span id="l72.133" class="difflineplus">+                          type: &quot;date&quot;,</span>
<a href="#l72.134"></a><span id="l72.134" class="difflineplus">+                        },</span>
<a href="#l72.135"></a><span id="l72.135">                         special: Gloda.kSpecialColumn,</span>
<a href="#l72.136"></a><span id="l72.136">                         specialColumnName: &quot;date&quot;,</span>
<a href="#l72.137"></a><span id="l72.137">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l72.138"></a><span id="l72.138">                         objectNoun: Gloda.NOUN_DATE,</span>
<a href="#l72.139"></a><span id="l72.139">                         }); // tested-by: test_attributes_fundamental</span>
<a href="#l72.140"></a><span id="l72.140"> </span>
<a href="#l72.141"></a><span id="l72.141">     // Header message ID.</span>
<a href="#l72.142"></a><span id="l72.142">     this._attrHeaderMessageID = Gloda.defineAttribute({</span>
<a href="#l72.143"></a><span id="l72.143" class="difflineat">@@ -302,71 +310,93 @@ var GlodaFundAttr = {</span>
<a href="#l72.144"></a><span id="l72.144"> </span>
<a href="#l72.145"></a><span id="l72.145">     // Attachment MIME Types</span>
<a href="#l72.146"></a><span id="l72.146">     this._attrAttachmentTypes = Gloda.defineAttribute({</span>
<a href="#l72.147"></a><span id="l72.147">       provider: this,</span>
<a href="#l72.148"></a><span id="l72.148">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.149"></a><span id="l72.149">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l72.150"></a><span id="l72.150">       attributeName: &quot;attachmentTypes&quot;,</span>
<a href="#l72.151"></a><span id="l72.151">       singular: false,</span>
<a href="#l72.152"></a><span id="l72.152" class="difflineplus">+      facet: {</span>
<a href="#l72.153"></a><span id="l72.153" class="difflineplus">+        type: &quot;default&quot;,</span>
<a href="#l72.154"></a><span id="l72.154" class="difflineplus">+        // This will group the MIME types by their category.</span>
<a href="#l72.155"></a><span id="l72.155" class="difflineplus">+        groupIdAttr: &quot;category&quot;,</span>
<a href="#l72.156"></a><span id="l72.156" class="difflineplus">+        queryHelper: &quot;Category&quot;,</span>
<a href="#l72.157"></a><span id="l72.157" class="difflineplus">+      },</span>
<a href="#l72.158"></a><span id="l72.158">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l72.159"></a><span id="l72.159">       objectNoun: Gloda.NOUN_MIME_TYPE,</span>
<a href="#l72.160"></a><span id="l72.160">       });</span>
<a href="#l72.161"></a><span id="l72.161"> </span>
<a href="#l72.162"></a><span id="l72.162">     // --- Optimization</span>
<a href="#l72.163"></a><span id="l72.163" class="difflineminus">-    // Involves.  Means any of from/to/cc.  The queries get ugly enough without</span>
<a href="#l72.164"></a><span id="l72.164" class="difflineminus">-    //   this that it seems to justify the cost, especially given the frequent</span>
<a href="#l72.165"></a><span id="l72.165" class="difflineminus">-    //   use case.  (In fact, post-filtering for the specific from/to/cc is</span>
<a href="#l72.166"></a><span id="l72.166" class="difflineminus">-    //   probably justifiable rather than losing this attribute...)</span>
<a href="#l72.167"></a><span id="l72.167" class="difflineplus">+    /**</span>
<a href="#l72.168"></a><span id="l72.168" class="difflineplus">+     * Involves means any of from/to/cc/bcc.  The queries get ugly enough</span>
<a href="#l72.169"></a><span id="l72.169" class="difflineplus">+     *  without this that it seems to justify the cost, especially given the</span>
<a href="#l72.170"></a><span id="l72.170" class="difflineplus">+     *  frequent use case.  (In fact, post-filtering for the specific from/to/cc</span>
<a href="#l72.171"></a><span id="l72.171" class="difflineplus">+     *  is probably justifiable rather than losing this attribute...)</span>
<a href="#l72.172"></a><span id="l72.172" class="difflineplus">+     */</span>
<a href="#l72.173"></a><span id="l72.173">     this._attrInvolves = Gloda.defineAttribute({</span>
<a href="#l72.174"></a><span id="l72.174">       provider: this,</span>
<a href="#l72.175"></a><span id="l72.175">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.176"></a><span id="l72.176">       attributeType: Gloda.kAttrOptimization,</span>
<a href="#l72.177"></a><span id="l72.177">       attributeName: &quot;involves&quot;,</span>
<a href="#l72.178"></a><span id="l72.178">       singular: false,</span>
<a href="#l72.179"></a><span id="l72.179" class="difflineplus">+      facet: {</span>
<a href="#l72.180"></a><span id="l72.180" class="difflineplus">+        type: &quot;default&quot;,</span>
<a href="#l72.181"></a><span id="l72.181" class="difflineplus">+        /**</span>
<a href="#l72.182"></a><span id="l72.182" class="difflineplus">+         * Filter out 'me', as we have other facets that deal with that, and the</span>
<a href="#l72.183"></a><span id="l72.183" class="difflineplus">+         *  'me' identities are so likely that they distort things.</span>
<a href="#l72.184"></a><span id="l72.184" class="difflineplus">+         *</span>
<a href="#l72.185"></a><span id="l72.185" class="difflineplus">+         * @return true if the identity is not one of my identities, false if it</span>
<a href="#l72.186"></a><span id="l72.186" class="difflineplus">+         *   is.</span>
<a href="#l72.187"></a><span id="l72.187" class="difflineplus">+         */</span>
<a href="#l72.188"></a><span id="l72.188" class="difflineplus">+        filter: function gloda_explattr_involves_filter(aItem) {</span>
<a href="#l72.189"></a><span id="l72.189" class="difflineplus">+          return (!(aItem.id in Gloda.myIdentities));</span>
<a href="#l72.190"></a><span id="l72.190" class="difflineplus">+        }</span>
<a href="#l72.191"></a><span id="l72.191" class="difflineplus">+      },</span>
<a href="#l72.192"></a><span id="l72.192">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l72.193"></a><span id="l72.193">       objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l72.194"></a><span id="l72.194">       }); // not-tested</span>
<a href="#l72.195"></a><span id="l72.195"> </span>
<a href="#l72.196"></a><span id="l72.196" class="difflineminus">-    // From Me To</span>
<a href="#l72.197"></a><span id="l72.197" class="difflineminus">-    this._attrFromMeTo = Gloda.defineAttribute({</span>
<a href="#l72.198"></a><span id="l72.198" class="difflineplus">+    /**</span>
<a href="#l72.199"></a><span id="l72.199" class="difflineplus">+     * Any of to/cc/bcc.</span>
<a href="#l72.200"></a><span id="l72.200" class="difflineplus">+     */</span>
<a href="#l72.201"></a><span id="l72.201" class="difflineplus">+    this._attrRecipients = Gloda.defineAttribute({</span>
<a href="#l72.202"></a><span id="l72.202">       provider: this,</span>
<a href="#l72.203"></a><span id="l72.203">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.204"></a><span id="l72.204">       attributeType: Gloda.kAttrOptimization,</span>
<a href="#l72.205"></a><span id="l72.205" class="difflineminus">-      attributeName: &quot;fromMeTo&quot;,</span>
<a href="#l72.206"></a><span id="l72.206" class="difflineplus">+      attributeName: &quot;recipients&quot;,</span>
<a href="#l72.207"></a><span id="l72.207">       singular: false,</span>
<a href="#l72.208"></a><span id="l72.208">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l72.209"></a><span id="l72.209" class="difflineplus">+      objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l72.210"></a><span id="l72.210" class="difflineplus">+      }); // not-tested</span>
<a href="#l72.211"></a><span id="l72.211" class="difflineplus">+</span>
<a href="#l72.212"></a><span id="l72.212" class="difflineplus">+    // From Me (To/Cc/Bcc)</span>
<a href="#l72.213"></a><span id="l72.213" class="difflineplus">+    this._attrFromMe = Gloda.defineAttribute({</span>
<a href="#l72.214"></a><span id="l72.214" class="difflineplus">+      provider: this,</span>
<a href="#l72.215"></a><span id="l72.215" class="difflineplus">+      extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.216"></a><span id="l72.216" class="difflineplus">+      attributeType: Gloda.kAttrOptimization,</span>
<a href="#l72.217"></a><span id="l72.217" class="difflineplus">+      attributeName: &quot;fromMe&quot;,</span>
<a href="#l72.218"></a><span id="l72.218" class="difflineplus">+      singular: false,</span>
<a href="#l72.219"></a><span id="l72.219" class="difflineplus">+      // The interesting thing to a facet is whether the message is from me.</span>
<a href="#l72.220"></a><span id="l72.220" class="difflineplus">+      facet: {</span>
<a href="#l72.221"></a><span id="l72.221" class="difflineplus">+        type: &quot;nonempty?&quot;</span>
<a href="#l72.222"></a><span id="l72.222" class="difflineplus">+      },</span>
<a href="#l72.223"></a><span id="l72.223" class="difflineplus">+      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l72.224"></a><span id="l72.224">       objectNoun: Gloda.NOUN_PARAM_IDENTITY,</span>
<a href="#l72.225"></a><span id="l72.225">       }); // not-tested</span>
<a href="#l72.226"></a><span id="l72.226" class="difflineminus">-    // From Me Cc</span>
<a href="#l72.227"></a><span id="l72.227" class="difflineminus">-    this._attrFromMeCc = Gloda.defineAttribute({</span>
<a href="#l72.228"></a><span id="l72.228" class="difflineminus">-      provider: this,</span>
<a href="#l72.229"></a><span id="l72.229" class="difflineminus">-      extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.230"></a><span id="l72.230" class="difflineminus">-      attributeType: Gloda.kAttrOptimization,</span>
<a href="#l72.231"></a><span id="l72.231" class="difflineminus">-      attributeName: &quot;fromMeCc&quot;,</span>
<a href="#l72.232"></a><span id="l72.232" class="difflineminus">-      singular: false,</span>
<a href="#l72.233"></a><span id="l72.233" class="difflineminus">-      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l72.234"></a><span id="l72.234" class="difflineminus">-      objectNoun: Gloda.NOUN_PARAM_IDENTITY,</span>
<a href="#l72.235"></a><span id="l72.235" class="difflineminus">-      }); // not-tested</span>
<a href="#l72.236"></a><span id="l72.236" class="difflineminus">-    // To Me</span>
<a href="#l72.237"></a><span id="l72.237" class="difflineplus">+    // To/Cc/Bcc Me</span>
<a href="#l72.238"></a><span id="l72.238">     this._attrToMe = Gloda.defineAttribute({</span>
<a href="#l72.239"></a><span id="l72.239">       provider: this,</span>
<a href="#l72.240"></a><span id="l72.240">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.241"></a><span id="l72.241">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l72.242"></a><span id="l72.242">       attributeName: &quot;toMe&quot;,</span>
<a href="#l72.243"></a><span id="l72.243" class="difflineminus">-      singular: false,</span>
<a href="#l72.244"></a><span id="l72.244" class="difflineminus">-      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l72.245"></a><span id="l72.245" class="difflineminus">-      objectNoun: Gloda.NOUN_PARAM_IDENTITY,</span>
<a href="#l72.246"></a><span id="l72.246" class="difflineminus">-      }); // not-tested</span>
<a href="#l72.247"></a><span id="l72.247" class="difflineminus">-    // Cc Me</span>
<a href="#l72.248"></a><span id="l72.248" class="difflineminus">-    this._attrCcMe = Gloda.defineAttribute({</span>
<a href="#l72.249"></a><span id="l72.249" class="difflineminus">-      provider: this,</span>
<a href="#l72.250"></a><span id="l72.250" class="difflineminus">-      extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.251"></a><span id="l72.251" class="difflineminus">-      attributeType: Gloda.kAttrFundamental,</span>
<a href="#l72.252"></a><span id="l72.252" class="difflineminus">-      attributeName: &quot;ccMe&quot;,</span>
<a href="#l72.253"></a><span id="l72.253" class="difflineplus">+      // The interesting thing to a facet is whether the message is to me.</span>
<a href="#l72.254"></a><span id="l72.254" class="difflineplus">+      facet: {</span>
<a href="#l72.255"></a><span id="l72.255" class="difflineplus">+        type: &quot;nonempty?&quot;</span>
<a href="#l72.256"></a><span id="l72.256" class="difflineplus">+      },</span>
<a href="#l72.257"></a><span id="l72.257">       singular: false,</span>
<a href="#l72.258"></a><span id="l72.258">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l72.259"></a><span id="l72.259">       objectNoun: Gloda.NOUN_PARAM_IDENTITY,</span>
<a href="#l72.260"></a><span id="l72.260">       }); // not-tested</span>
<a href="#l72.261"></a><span id="l72.261"> </span>
<a href="#l72.262"></a><span id="l72.262"> </span>
<a href="#l72.263"></a><span id="l72.263">     // -- Mailing List</span>
<a href="#l72.264"></a><span id="l72.264">     // Non-singular, but a hard call.  Namely, it is obvious that a message can</span>
<a href="#l72.265"></a><span id="l72.265" class="difflineat">@@ -386,21 +416,24 @@ var GlodaFundAttr = {</span>
<a href="#l72.266"></a><span id="l72.266">     //  by the user.</span>
<a href="#l72.267"></a><span id="l72.267">     this._attrList = Gloda.defineAttribute({</span>
<a href="#l72.268"></a><span id="l72.268">                         provider: this,</span>
<a href="#l72.269"></a><span id="l72.269">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l72.270"></a><span id="l72.270">                         attributeType: Gloda.kAttrFundamental,</span>
<a href="#l72.271"></a><span id="l72.271">                         attributeName: &quot;mailing-list&quot;,</span>
<a href="#l72.272"></a><span id="l72.272">                         bindName: &quot;mailingLists&quot;,</span>
<a href="#l72.273"></a><span id="l72.273">                         singular: false,</span>
<a href="#l72.274"></a><span id="l72.274" class="difflineplus">+                        facet: true,</span>
<a href="#l72.275"></a><span id="l72.275">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l72.276"></a><span id="l72.276">                         objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l72.277"></a><span id="l72.277">                         }); // not-tested, not-implemented</span>
<a href="#l72.278"></a><span id="l72.278">   },</span>
<a href="#l72.279"></a><span id="l72.279"> </span>
<a href="#l72.280"></a><span id="l72.280" class="difflineplus">+  RE_LIST_POST: /&lt;mailto:([^&gt;]+)&gt;/,</span>
<a href="#l72.281"></a><span id="l72.281" class="difflineplus">+</span>
<a href="#l72.282"></a><span id="l72.282">   /**</span>
<a href="#l72.283"></a><span id="l72.283">    *</span>
<a href="#l72.284"></a><span id="l72.284">    * Specializations:</span>
<a href="#l72.285"></a><span id="l72.285">    * - Mailing Lists.  Replies to a message on a mailing list frequently only</span>
<a href="#l72.286"></a><span id="l72.286">    *   have the list-serve as the 'to', so we try to generate a synthetic 'to'</span>
<a href="#l72.287"></a><span id="l72.287">    *   based on the author of the parent message when possible.  (The 'possible'</span>
<a href="#l72.288"></a><span id="l72.288">    *   part is that we may not have a copy of the parent message at the time of</span>
<a href="#l72.289"></a><span id="l72.289">    *   processing.)</span>
<a href="#l72.290"></a><span id="l72.290" class="difflineat">@@ -422,33 +455,47 @@ var GlodaFundAttr = {</span>
<a href="#l72.291"></a><span id="l72.291">       author = aMsgHdr.getStringProperty(&quot;replyTo&quot;);</span>
<a href="#l72.292"></a><span id="l72.292">     }</span>
<a href="#l72.293"></a><span id="l72.293">     catch (ex) {</span>
<a href="#l72.294"></a><span id="l72.294">     }</span>
<a href="#l72.295"></a><span id="l72.295">     */</span>
<a href="#l72.296"></a><span id="l72.296">     if (author == null || author == &quot;&quot;)</span>
<a href="#l72.297"></a><span id="l72.297">       author = aMsgHdr.mime2DecodedAuthor;</span>
<a href="#l72.298"></a><span id="l72.298"> </span>
<a href="#l72.299"></a><span id="l72.299" class="difflineminus">-    let [authorIdentities, toIdentities, ccIdentities] =</span>
<a href="#l72.300"></a><span id="l72.300" class="difflineplus">+    let normalizedListPost = &quot;&quot;;</span>
<a href="#l72.301"></a><span id="l72.301" class="difflineplus">+    if (aMimeMsg &amp;&amp; aMimeMsg.has(&quot;list-post&quot;)) {</span>
<a href="#l72.302"></a><span id="l72.302" class="difflineplus">+      let match = this.RE_LIST_POST.exec(aMimeMsg.get(&quot;list-post&quot;));</span>
<a href="#l72.303"></a><span id="l72.303" class="difflineplus">+      if (match)</span>
<a href="#l72.304"></a><span id="l72.304" class="difflineplus">+        normalizedListPost = &quot;&lt;&quot; + match[1] + &quot;&gt;&quot;;</span>
<a href="#l72.305"></a><span id="l72.305" class="difflineplus">+    }</span>
<a href="#l72.306"></a><span id="l72.306" class="difflineplus">+</span>
<a href="#l72.307"></a><span id="l72.307" class="difflineplus">+    let [authorIdentities, toIdentities, ccIdentities, bccIdentities,</span>
<a href="#l72.308"></a><span id="l72.308" class="difflineplus">+         listIdentities] =</span>
<a href="#l72.309"></a><span id="l72.309">       yield aCallbackHandle.pushAndGo(</span>
<a href="#l72.310"></a><span id="l72.310">         Gloda.getOrCreateMailIdentities(aCallbackHandle,</span>
<a href="#l72.311"></a><span id="l72.311">                                         author, aMsgHdr.mime2DecodedRecipients,</span>
<a href="#l72.312"></a><span id="l72.312" class="difflineminus">-                                        aMsgHdr.ccList));</span>
<a href="#l72.313"></a><span id="l72.313" class="difflineplus">+                                        aMsgHdr.ccList, aMsgHdr.bccList,</span>
<a href="#l72.314"></a><span id="l72.314" class="difflineplus">+                                        normalizedListPost));</span>
<a href="#l72.315"></a><span id="l72.315"> </span>
<a href="#l72.316"></a><span id="l72.316">     if (authorIdentities.length == 0) {</span>
<a href="#l72.317"></a><span id="l72.317">       this._log.error(&quot;Message with subject '&quot; + aMsgHdr.mime2DecodedSubject +</span>
<a href="#l72.318"></a><span id="l72.318">                       &quot;' somehow lacks a valid author.  Bailing.&quot;);</span>
<a href="#l72.319"></a><span id="l72.319">       return; // being a generator, this generates an exception; we like.</span>
<a href="#l72.320"></a><span id="l72.320">     }</span>
<a href="#l72.321"></a><span id="l72.321">     let authorIdentity = authorIdentities[0];</span>
<a href="#l72.322"></a><span id="l72.322">     aGlodaMessage.from = authorIdentity;</span>
<a href="#l72.323"></a><span id="l72.323"> </span>
<a href="#l72.324"></a><span id="l72.324" class="difflineminus">-    // -- To, Cc</span>
<a href="#l72.325"></a><span id="l72.325" class="difflineplus">+    // -- To, Cc, Bcc</span>
<a href="#l72.326"></a><span id="l72.326">     aGlodaMessage.to = toIdentities;</span>
<a href="#l72.327"></a><span id="l72.327">     aGlodaMessage.cc = ccIdentities;</span>
<a href="#l72.328"></a><span id="l72.328" class="difflineplus">+    aGlodaMessage.bcc = bccIdentities;</span>
<a href="#l72.329"></a><span id="l72.329" class="difflineplus">+</span>
<a href="#l72.330"></a><span id="l72.330" class="difflineplus">+    // -- Mailing List</span>
<a href="#l72.331"></a><span id="l72.331" class="difflineplus">+    if (listIdentities.length)</span>
<a href="#l72.332"></a><span id="l72.332" class="difflineplus">+      aGlodaMessage.mailingLists = listIdentities;</span>
<a href="#l72.333"></a><span id="l72.333"> </span>
<a href="#l72.334"></a><span id="l72.334">     // -- Attachments</span>
<a href="#l72.335"></a><span id="l72.335">     if (aMimeMsg) {</span>
<a href="#l72.336"></a><span id="l72.336">       let attachmentTypes = [];</span>
<a href="#l72.337"></a><span id="l72.337">       for each (let [, attachment] in Iterator(aMimeMsg.allAttachments)) {</span>
<a href="#l72.338"></a><span id="l72.338">         // We don't care about would-be attachments that are not user-intended</span>
<a href="#l72.339"></a><span id="l72.339">         //  attachments but rather artifacts of the message content.</span>
<a href="#l72.340"></a><span id="l72.340">         // We also want to avoid dealing with obviously bogus mime types.</span>
<a href="#l72.341"></a><span id="l72.341" class="difflineat">@@ -471,24 +518,24 @@ var GlodaFundAttr = {</span>
<a href="#l72.342"></a><span id="l72.342">     yield Gloda.kWorkDone;</span>
<a href="#l72.343"></a><span id="l72.343">   },</span>
<a href="#l72.344"></a><span id="l72.344"> </span>
<a href="#l72.345"></a><span id="l72.345">   optimize: function gloda_fundattr_optimize(aGlodaMessage, aRawReps,</span>
<a href="#l72.346"></a><span id="l72.346">       aIsNew, aCallbackHandle) {</span>
<a href="#l72.347"></a><span id="l72.347"> </span>
<a href="#l72.348"></a><span id="l72.348">     let aMsgHdr = aRawReps.header;</span>
<a href="#l72.349"></a><span id="l72.349"> </span>
<a href="#l72.350"></a><span id="l72.350" class="difflineplus">+    // for simplicity this is used for both involves and recipients</span>
<a href="#l72.351"></a><span id="l72.351">     let involvesIdentities = {};</span>
<a href="#l72.352"></a><span id="l72.352">     let involves = aGlodaMessage.involves || [];</span>
<a href="#l72.353"></a><span id="l72.353" class="difflineplus">+    let recipients = aGlodaMessage.recipients || [];</span>
<a href="#l72.354"></a><span id="l72.354"> </span>
<a href="#l72.355"></a><span id="l72.355" class="difflineminus">-    // me specialization optimizations</span>
<a href="#l72.356"></a><span id="l72.356" class="difflineplus">+    // 'me' specialization optimizations</span>
<a href="#l72.357"></a><span id="l72.357">     let toMe = aGlodaMessage.toMe || [];</span>
<a href="#l72.358"></a><span id="l72.358" class="difflineminus">-    let fromMeTo = aGlodaMessage.fromMeTo || [];</span>
<a href="#l72.359"></a><span id="l72.359" class="difflineminus">-    let ccMe = aGlodaMessage.ccMe || [];</span>
<a href="#l72.360"></a><span id="l72.360" class="difflineminus">-    let fromMeCc = aGlodaMessage.fromMeCc || [];</span>
<a href="#l72.361"></a><span id="l72.361" class="difflineplus">+    let fromMe = aGlodaMessage.fromMe || [];</span>
<a href="#l72.362"></a><span id="l72.362"> </span>
<a href="#l72.363"></a><span id="l72.363">     let myIdentities = Gloda.myIdentities; // needless optimization?</span>
<a href="#l72.364"></a><span id="l72.364">     let authorIdentity = aGlodaMessage.from;</span>
<a href="#l72.365"></a><span id="l72.365">     let isFromMe = authorIdentity.id in myIdentities;</span>
<a href="#l72.366"></a><span id="l72.366"> </span>
<a href="#l72.367"></a><span id="l72.367">     // The fulltext search column for the author.  We want to have in here:</span>
<a href="#l72.368"></a><span id="l72.368">     // - The e-mail address and display name as enclosed on the message.</span>
<a href="#l72.369"></a><span id="l72.369">     // - The name per the address book card for this e-mail address, if we have</span>
<a href="#l72.370"></a><span id="l72.370" class="difflineat">@@ -511,16 +558,17 @@ var GlodaFundAttr = {</span>
<a href="#l72.371"></a><span id="l72.371">     involves.push(authorIdentity);</span>
<a href="#l72.372"></a><span id="l72.372">     involvesIdentities[authorIdentity.id] = true;</span>
<a href="#l72.373"></a><span id="l72.373"> </span>
<a href="#l72.374"></a><span id="l72.374">     let involvedAddrBookCount = 0;</span>
<a href="#l72.375"></a><span id="l72.375"> </span>
<a href="#l72.376"></a><span id="l72.376">     for each (let [,toIdentity] in Iterator(aGlodaMessage.to)) {</span>
<a href="#l72.377"></a><span id="l72.377">       if (!(toIdentity.id in involvesIdentities)) {</span>
<a href="#l72.378"></a><span id="l72.378">         involves.push(toIdentity);</span>
<a href="#l72.379"></a><span id="l72.379" class="difflineplus">+        recipients.push(toIdentity);</span>
<a href="#l72.380"></a><span id="l72.380">         involvesIdentities[toIdentity.id] = true;</span>
<a href="#l72.381"></a><span id="l72.381">         let toCard = toIdentity.abCard;</span>
<a href="#l72.382"></a><span id="l72.382">         if (toCard) {</span>
<a href="#l72.383"></a><span id="l72.383">           involvedAddrBookCount++;</span>
<a href="#l72.384"></a><span id="l72.384">           // @testpoint gloda.noun.message.attr.recipientsMatch</span>
<a href="#l72.385"></a><span id="l72.385">           aGlodaMessage._indexRecipients += ' ' + toCard.displayName;</span>
<a href="#l72.386"></a><span id="l72.386">         }</span>
<a href="#l72.387"></a><span id="l72.387">       }</span>
<a href="#l72.388"></a><span id="l72.388" class="difflineat">@@ -528,71 +576,100 @@ var GlodaFundAttr = {</span>
<a href="#l72.389"></a><span id="l72.389">       // optimization attribute to-me ('I' am the parameter)</span>
<a href="#l72.390"></a><span id="l72.390">       if (toIdentity.id in myIdentities) {</span>
<a href="#l72.391"></a><span id="l72.391">         toMe.push([toIdentity, authorIdentity]);</span>
<a href="#l72.392"></a><span id="l72.392">         if (aIsNew)</span>
<a href="#l72.393"></a><span id="l72.393">           authorIdentity.contact.popularity += this.POPULARITY_TO_ME;</span>
<a href="#l72.394"></a><span id="l72.394">       }</span>
<a href="#l72.395"></a><span id="l72.395">       // optimization attribute from-me-to ('I' am the parameter)</span>
<a href="#l72.396"></a><span id="l72.396">       if (isFromMe) {</span>
<a href="#l72.397"></a><span id="l72.397" class="difflineminus">-        fromMeTo.push([authorIdentity, toIdentity]);</span>
<a href="#l72.398"></a><span id="l72.398" class="difflineplus">+        fromMe.push([authorIdentity, toIdentity]);</span>
<a href="#l72.399"></a><span id="l72.399">         // also, popularity</span>
<a href="#l72.400"></a><span id="l72.400">         if (aIsNew)</span>
<a href="#l72.401"></a><span id="l72.401">           toIdentity.contact.popularity += this.POPULARITY_FROM_ME_TO;</span>
<a href="#l72.402"></a><span id="l72.402">       }</span>
<a href="#l72.403"></a><span id="l72.403">     }</span>
<a href="#l72.404"></a><span id="l72.404">     for each (let [,ccIdentity] in Iterator(aGlodaMessage.cc)) {</span>
<a href="#l72.405"></a><span id="l72.405">       if (!(ccIdentity.id in involvesIdentities)) {</span>
<a href="#l72.406"></a><span id="l72.406">         involves.push(ccIdentity);</span>
<a href="#l72.407"></a><span id="l72.407" class="difflineplus">+        recipients.push(ccIdentity);</span>
<a href="#l72.408"></a><span id="l72.408">         involvesIdentities[ccIdentity.id] = true;</span>
<a href="#l72.409"></a><span id="l72.409">         let ccCard = ccIdentity.abCard;</span>
<a href="#l72.410"></a><span id="l72.410">         if (ccCard) {</span>
<a href="#l72.411"></a><span id="l72.411">           involvedAddrBookCount++;</span>
<a href="#l72.412"></a><span id="l72.412">           // @testpoint gloda.noun.message.attr.recipientsMatch</span>
<a href="#l72.413"></a><span id="l72.413">           aGlodaMessage._indexRecipients += ' ' + ccCard.displayName;</span>
<a href="#l72.414"></a><span id="l72.414">         }</span>
<a href="#l72.415"></a><span id="l72.415">       }</span>
<a href="#l72.416"></a><span id="l72.416">       // optimization attribute cc-me ('I' am the parameter)</span>
<a href="#l72.417"></a><span id="l72.417">       if (ccIdentity.id in myIdentities) {</span>
<a href="#l72.418"></a><span id="l72.418" class="difflineminus">-        ccMe.push([ccIdentity, authorIdentity]);</span>
<a href="#l72.419"></a><span id="l72.419" class="difflineplus">+        toMe.push([ccIdentity, authorIdentity]);</span>
<a href="#l72.420"></a><span id="l72.420">         if (aIsNew)</span>
<a href="#l72.421"></a><span id="l72.421">           authorIdentity.contact.popularity += this.POPULARITY_CC_ME;</span>
<a href="#l72.422"></a><span id="l72.422">       }</span>
<a href="#l72.423"></a><span id="l72.423">       // optimization attribute from-me-to ('I' am the parameter)</span>
<a href="#l72.424"></a><span id="l72.424">       if (isFromMe) {</span>
<a href="#l72.425"></a><span id="l72.425" class="difflineminus">-        fromMeCc.push([authorIdentity, ccIdentity]);</span>
<a href="#l72.426"></a><span id="l72.426" class="difflineplus">+        fromMe.push([authorIdentity, ccIdentity]);</span>
<a href="#l72.427"></a><span id="l72.427">         // also, popularity</span>
<a href="#l72.428"></a><span id="l72.428">         if (aIsNew)</span>
<a href="#l72.429"></a><span id="l72.429">           ccIdentity.contact.popularity += this.POPULARITY_FROM_ME_CC;</span>
<a href="#l72.430"></a><span id="l72.430">       }</span>
<a href="#l72.431"></a><span id="l72.431">     }</span>
<a href="#l72.432"></a><span id="l72.432" class="difflineplus">+    // just treat bcc like cc; the intent is the same although the exact</span>
<a href="#l72.433"></a><span id="l72.433" class="difflineplus">+    //  semantics differ.</span>
<a href="#l72.434"></a><span id="l72.434" class="difflineplus">+    for each (let [,bccIdentity] in Iterator(aGlodaMessage.bcc)) {</span>
<a href="#l72.435"></a><span id="l72.435" class="difflineplus">+      if (!(bccIdentity.id in involvesIdentities)) {</span>
<a href="#l72.436"></a><span id="l72.436" class="difflineplus">+        involves.push(bccIdentity);</span>
<a href="#l72.437"></a><span id="l72.437" class="difflineplus">+        recipients.push(bccIdentity);</span>
<a href="#l72.438"></a><span id="l72.438" class="difflineplus">+        involvesIdentities[bccIdentity.id] = true;</span>
<a href="#l72.439"></a><span id="l72.439" class="difflineplus">+        let bccCard = bccIdentity.abCard;</span>
<a href="#l72.440"></a><span id="l72.440" class="difflineplus">+        if (bccCard) {</span>
<a href="#l72.441"></a><span id="l72.441" class="difflineplus">+          involvedAddrBookCount++;</span>
<a href="#l72.442"></a><span id="l72.442" class="difflineplus">+          // @testpoint gloda.noun.message.attr.recipientsMatch</span>
<a href="#l72.443"></a><span id="l72.443" class="difflineplus">+          aGlodaMessage._indexRecipients += ' ' + bccCard.displayName;</span>
<a href="#l72.444"></a><span id="l72.444" class="difflineplus">+        }</span>
<a href="#l72.445"></a><span id="l72.445" class="difflineplus">+      }</span>
<a href="#l72.446"></a><span id="l72.446" class="difflineplus">+      // optimization attribute cc-me ('I' am the parameter)</span>
<a href="#l72.447"></a><span id="l72.447" class="difflineplus">+      if (bccIdentity.id in myIdentities) {</span>
<a href="#l72.448"></a><span id="l72.448" class="difflineplus">+        toMe.push([bccIdentity, authorIdentity]);</span>
<a href="#l72.449"></a><span id="l72.449" class="difflineplus">+        if (aIsNew)</span>
<a href="#l72.450"></a><span id="l72.450" class="difflineplus">+          authorIdentity.contact.popularity += this.POPULARITY_BCC_ME;</span>
<a href="#l72.451"></a><span id="l72.451" class="difflineplus">+      }</span>
<a href="#l72.452"></a><span id="l72.452" class="difflineplus">+      // optimization attribute from-me-to ('I' am the parameter)</span>
<a href="#l72.453"></a><span id="l72.453" class="difflineplus">+      if (isFromMe) {</span>
<a href="#l72.454"></a><span id="l72.454" class="difflineplus">+        fromMe.push([authorIdentity, bccIdentity]);</span>
<a href="#l72.455"></a><span id="l72.455" class="difflineplus">+        // also, popularity</span>
<a href="#l72.456"></a><span id="l72.456" class="difflineplus">+        if (aIsNew)</span>
<a href="#l72.457"></a><span id="l72.457" class="difflineplus">+          bccIdentity.contact.popularity += this.POPULARITY_FROM_ME_BCC;</span>
<a href="#l72.458"></a><span id="l72.458" class="difflineplus">+      }</span>
<a href="#l72.459"></a><span id="l72.459" class="difflineplus">+    }</span>
<a href="#l72.460"></a><span id="l72.460"> </span>
<a href="#l72.461"></a><span id="l72.461">     if (involvedAddrBookCount)</span>
<a href="#l72.462"></a><span id="l72.462">       aGlodaMessage.notability += this.NOTABILITY_INVOLVING_ADDR_BOOK_FIRST +</span>
<a href="#l72.463"></a><span id="l72.463">         (involvedAddrBookCount - 1) * this.NOTABILITY_INVOLVING_ADDR_BOOK_ADDL;</span>
<a href="#l72.464"></a><span id="l72.464"> </span>
<a href="#l72.465"></a><span id="l72.465">     aGlodaMessage.involves = involves;</span>
<a href="#l72.466"></a><span id="l72.466" class="difflineplus">+    aGlodaMessage.recipients = recipients;</span>
<a href="#l72.467"></a><span id="l72.467">     if (toMe.length) {</span>
<a href="#l72.468"></a><span id="l72.468">       aGlodaMessage.toMe = toMe;</span>
<a href="#l72.469"></a><span id="l72.469">       aGlodaMessage.notability += this.NOTABILITY_INVOLVING_ME;</span>
<a href="#l72.470"></a><span id="l72.470">     }</span>
<a href="#l72.471"></a><span id="l72.471" class="difflineminus">-    if (fromMeTo.length)</span>
<a href="#l72.472"></a><span id="l72.472" class="difflineminus">-      aGlodaMessage.fromMeTo = fromMeTo;</span>
<a href="#l72.473"></a><span id="l72.473" class="difflineminus">-    if (ccMe.length)</span>
<a href="#l72.474"></a><span id="l72.474" class="difflineminus">-      aGlodaMessage.ccMe = ccMe;</span>
<a href="#l72.475"></a><span id="l72.475" class="difflineminus">-    if (fromMeCc.length)</span>
<a href="#l72.476"></a><span id="l72.476" class="difflineminus">-      aGlodaMessage.fromMeCc = fromMeCc;</span>
<a href="#l72.477"></a><span id="l72.477" class="difflineplus">+    if (fromMe.length)</span>
<a href="#l72.478"></a><span id="l72.478" class="difflineplus">+      aGlodaMessage.fromMe = fromMe;</span>
<a href="#l72.479"></a><span id="l72.479"> </span>
<a href="#l72.480"></a><span id="l72.480">     // Content</span>
<a href="#l72.481"></a><span id="l72.481">     if (aRawReps.bodyLines) {</span>
<a href="#l72.482"></a><span id="l72.482" class="difflineminus">-      aGlodaMessage._content = new GlodaContent();</span>
<a href="#l72.483"></a><span id="l72.483" class="difflineplus">+      aGlodaMessage._content = aRawReps.content = new GlodaContent();</span>
<a href="#l72.484"></a><span id="l72.484">       if (this.contentWhittle({}, aRawReps.bodyLines, aGlodaMessage._content)) {</span>
<a href="#l72.485"></a><span id="l72.485">         // we were going to do something here?</span>
<a href="#l72.486"></a><span id="l72.486">       }</span>
<a href="#l72.487"></a><span id="l72.487">     }</span>
<a href="#l72.488"></a><span id="l72.488" class="difflineplus">+    else {</span>
<a href="#l72.489"></a><span id="l72.489" class="difflineplus">+      aRawReps.content = null;</span>
<a href="#l72.490"></a><span id="l72.490" class="difflineplus">+    }</span>
<a href="#l72.491"></a><span id="l72.491"> </span>
<a href="#l72.492"></a><span id="l72.492">     yield Gloda.kWorkDone;</span>
<a href="#l72.493"></a><span id="l72.493">   },</span>
<a href="#l72.494"></a><span id="l72.494"> </span>
<a href="#l72.495"></a><span id="l72.495">   /**</span>
<a href="#l72.496"></a><span id="l72.496">    * Duplicates the notability logic from optimize().  Arguably optimize should</span>
<a href="#l72.497"></a><span id="l72.497">    *  be factored to call us, grokNounItem should be factored to call us, or we</span>
<a href="#l72.498"></a><span id="l72.498">    *  should get sufficiently fancy that our code wildly diverges.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -428,20 +428,26 @@ var Gloda = {</span>
<a href="#l73.4"></a><span id="l73.4">    * If the identities need to be created, they will also result in the</span>
<a href="#l73.5"></a><span id="l73.5">    *  creation of a gloda contact.  If a display name was provided with the</span>
<a href="#l73.6"></a><span id="l73.6">    *  e-mail address, it will become the name of the gloda contact.  If a</span>
<a href="#l73.7"></a><span id="l73.7">    *  display name was not provided, the e-mail address will also serve as the</span>
<a href="#l73.8"></a><span id="l73.8">    *  contact name.</span>
<a href="#l73.9"></a><span id="l73.9">    * This method uses the indexer's callback handle mechanism, and does not</span>
<a href="#l73.10"></a><span id="l73.10">    *  obey traditional return semantics.</span>
<a href="#l73.11"></a><span id="l73.11">    *</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineplus">+   * We normalize all e-mail addresses to be lowercase as a normative measure.</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+   *</span>
<a href="#l73.14"></a><span id="l73.14" class="difflineplus">+   * @param aCallbackHandle The GlodaIndexer callback handle (or equivalent)</span>
<a href="#l73.15"></a><span id="l73.15" class="difflineplus">+   *   that you are operating under.</span>
<a href="#l73.16"></a><span id="l73.16">    * @param ... One or more strings.  Each string can contain zero or more</span>
<a href="#l73.17"></a><span id="l73.17">    *   e-mail addresses with display name.  If more than one address is given,</span>
<a href="#l73.18"></a><span id="l73.18">    *   they should be comma-delimited.  For example</span>
<a href="#l73.19"></a><span id="l73.19" class="difflineminus">-   *   '&quot;Bob Smith&quot; &lt;bob@smith.com&gt;' is an address with display name.</span>
<a href="#l73.20"></a><span id="l73.20" class="difflineplus">+   *   '&quot;Bob Smith&quot; &lt;bob@smith.com&gt;' is an address with display name.  Mime</span>
<a href="#l73.21"></a><span id="l73.21" class="difflineplus">+   *   header decoding is performed, but is ignorant of any folder-level</span>
<a href="#l73.22"></a><span id="l73.22" class="difflineplus">+   *   character set overrides.</span>
<a href="#l73.23"></a><span id="l73.23">    * @returns via the callback handle mechanism, a list containing one sub-list</span>
<a href="#l73.24"></a><span id="l73.24">    *   for each string argument passed.  Each sub-list containts zero or more</span>
<a href="#l73.25"></a><span id="l73.25">    *   GlodaIdentity instances corresponding to the addresses provided.</span>
<a href="#l73.26"></a><span id="l73.26">    */</span>
<a href="#l73.27"></a><span id="l73.27">   getOrCreateMailIdentities:</span>
<a href="#l73.28"></a><span id="l73.28">       function gloda_ns_getOrCreateMailIdentities(aCallbackHandle) {</span>
<a href="#l73.29"></a><span id="l73.29">     let addresses = {};</span>
<a href="#l73.30"></a><span id="l73.30">     let resultLists = [];</span>
<a href="#l73.31"></a><span id="l73.31" class="difflineat">@@ -451,17 +457,17 @@ var Gloda = {</span>
<a href="#l73.32"></a><span id="l73.32">       let aMailAddresses = arguments[iArg];</span>
<a href="#l73.33"></a><span id="l73.33">       let parsed = GlodaUtils.parseMailAddresses(aMailAddresses);</span>
<a href="#l73.34"></a><span id="l73.34"> </span>
<a href="#l73.35"></a><span id="l73.35">       let resultList = [];</span>
<a href="#l73.36"></a><span id="l73.36">       resultLists.push(resultList);</span>
<a href="#l73.37"></a><span id="l73.37"> </span>
<a href="#l73.38"></a><span id="l73.38">       let identities = [];</span>
<a href="#l73.39"></a><span id="l73.39">       for (let iAddress = 0; iAddress &lt; parsed.count; iAddress++) {</span>
<a href="#l73.40"></a><span id="l73.40" class="difflineminus">-        let address = parsed.addresses[iAddress];</span>
<a href="#l73.41"></a><span id="l73.41" class="difflineplus">+        let address = parsed.addresses[iAddress].toLowerCase();</span>
<a href="#l73.42"></a><span id="l73.42">         if (address in addresses)</span>
<a href="#l73.43"></a><span id="l73.43">           addresses[address].push(resultList);</span>
<a href="#l73.44"></a><span id="l73.44">         else</span>
<a href="#l73.45"></a><span id="l73.45">           addresses[address] = [parsed.names[iAddress], resultList];</span>
<a href="#l73.46"></a><span id="l73.46">       }</span>
<a href="#l73.47"></a><span id="l73.47">     }</span>
<a href="#l73.48"></a><span id="l73.48"> </span>
<a href="#l73.49"></a><span id="l73.49">     let addressList = [address for (address in addresses)];</span>
<a href="#l73.50"></a><span id="l73.50" class="difflineat">@@ -590,29 +596,29 @@ var Gloda = {</span>
<a href="#l73.51"></a><span id="l73.51">       if (!fallbackName)</span>
<a href="#l73.52"></a><span id="l73.52">         fallbackName = msgIdentity.email;</span>
<a href="#l73.53"></a><span id="l73.53"> </span>
<a href="#l73.54"></a><span id="l73.54">       let emailAddress = msgIdentity.email;</span>
<a href="#l73.55"></a><span id="l73.55">       let replyTo = msgIdentity.replyTo;</span>
<a href="#l73.56"></a><span id="l73.56"> </span>
<a href="#l73.57"></a><span id="l73.57">       // find the identities if they exist, flag to create them if they don't</span>
<a href="#l73.58"></a><span id="l73.58">       if (emailAddress) {</span>
<a href="#l73.59"></a><span id="l73.59" class="difflineminus">-        parsed = GlodaUtils.parseMailAddresses(emailAddress);</span>
<a href="#l73.60"></a><span id="l73.60" class="difflineplus">+        let parsed = GlodaUtils.parseMailAddresses(emailAddress);</span>
<a href="#l73.61"></a><span id="l73.61">         if (!(parsed.addresses[0] in myEmailAddresses)) {</span>
<a href="#l73.62"></a><span id="l73.62">           let identity = GlodaDatastore.getIdentity(&quot;email&quot;,</span>
<a href="#l73.63"></a><span id="l73.63">                                                     parsed.addresses[0]);</span>
<a href="#l73.64"></a><span id="l73.64">           if (identity)</span>
<a href="#l73.65"></a><span id="l73.65">             existingIdentities.push(identity);</span>
<a href="#l73.66"></a><span id="l73.66">           else</span>
<a href="#l73.67"></a><span id="l73.67">             identitiesToCreate.push(parsed.addresses[0]);</span>
<a href="#l73.68"></a><span id="l73.68">           myEmailAddresses[parsed.addresses[0]] = true;</span>
<a href="#l73.69"></a><span id="l73.69">         }</span>
<a href="#l73.70"></a><span id="l73.70">       }</span>
<a href="#l73.71"></a><span id="l73.71">       if (replyTo) {</span>
<a href="#l73.72"></a><span id="l73.72" class="difflineminus">-        parsed = GlodaUtils.parseMailAddresses(replyTo);</span>
<a href="#l73.73"></a><span id="l73.73" class="difflineplus">+        let parsed = GlodaUtils.parseMailAddresses(replyTo);</span>
<a href="#l73.74"></a><span id="l73.74">         if (!(parsed.addresses[0] in myEmailAddresses)) {</span>
<a href="#l73.75"></a><span id="l73.75">           let identity = GlodaDatastore.getIdentity(&quot;email&quot;,</span>
<a href="#l73.76"></a><span id="l73.76">                                                     parsed.addresses[0]);</span>
<a href="#l73.77"></a><span id="l73.77">           if (identity)</span>
<a href="#l73.78"></a><span id="l73.78">             existingIdentities.push(identity);</span>
<a href="#l73.79"></a><span id="l73.79">           else</span>
<a href="#l73.80"></a><span id="l73.80">             identitiesToCreate.push(parsed.addresses[0]);</span>
<a href="#l73.81"></a><span id="l73.81">           myEmailAddresses[parsed.addresses[0]] = true;</span>
<a href="#l73.82"></a><span id="l73.82" class="difflineat">@@ -857,50 +863,58 @@ var Gloda = {</span>
<a href="#l73.83"></a><span id="l73.83"> </span>
<a href="#l73.84"></a><span id="l73.84">   _managedToJSON: function gloda_ns_managedToJSON(aItem) {</span>
<a href="#l73.85"></a><span id="l73.85">     return aItem.id;</span>
<a href="#l73.86"></a><span id="l73.86">   },</span>
<a href="#l73.87"></a><span id="l73.87"> </span>
<a href="#l73.88"></a><span id="l73.88">   /**</span>
<a href="#l73.89"></a><span id="l73.89">    * Define a noun.  Takes a dictionary with the following keys/values:</span>
<a href="#l73.90"></a><span id="l73.90">    *</span>
<a href="#l73.91"></a><span id="l73.91" class="difflineminus">-   * @param name The name of the noun.  This is not a display name (anything</span>
<a href="#l73.92"></a><span id="l73.92" class="difflineminus">-   *     being displayed needs to be localized, after all), but simply the</span>
<a href="#l73.93"></a><span id="l73.93" class="difflineminus">-   *     canonical name for debugging purposes and for people to pass to</span>
<a href="#l73.94"></a><span id="l73.94" class="difflineplus">+   * @param aNounDef.name The name of the noun.  This is not a display name</span>
<a href="#l73.95"></a><span id="l73.95" class="difflineplus">+   *     (anything being displayed needs to be localized, after all), but simply</span>
<a href="#l73.96"></a><span id="l73.96" class="difflineplus">+   *     the canonical name for debugging purposes and for people to pass to</span>
<a href="#l73.97"></a><span id="l73.97">    *     lookupNoun.  The suggested convention is lower-case-dash-delimited,</span>
<a href="#l73.98"></a><span id="l73.98">    *     with names being singular (since it's a single noun we are referring</span>
<a href="#l73.99"></a><span id="l73.99">    *     to.)</span>
<a href="#l73.100"></a><span id="l73.100" class="difflineminus">-   * @param class The 'class' to which an instance of the noun will belong (aka</span>
<a href="#l73.101"></a><span id="l73.101" class="difflineminus">-   *     will pass an instanceof test).</span>
<a href="#l73.102"></a><span id="l73.102" class="difflineminus">-   * @param allowsArbitraryAttrs Is this a 'first class noun'/can it be a subject, AKA can</span>
<a href="#l73.103"></a><span id="l73.103" class="difflineminus">-   *     this noun have attributes stored on it that relate it to other things?</span>
<a href="#l73.104"></a><span id="l73.104" class="difflineminus">-   *     For example, a message is first-class; we store attributes of</span>
<a href="#l73.105"></a><span id="l73.105" class="difflineminus">-   *     messages.  A date is not first-class now, nor is it likely to be; we</span>
<a href="#l73.106"></a><span id="l73.106" class="difflineminus">-   *     will not store attributes about a date, although dates will be the</span>
<a href="#l73.107"></a><span id="l73.107" class="difflineminus">-   *     objects of other subjects.  (For example: we might associate a date</span>
<a href="#l73.108"></a><span id="l73.108" class="difflineminus">-   *     with a calendar event, but the date is an attribute of the calendar</span>
<a href="#l73.109"></a><span id="l73.109" class="difflineminus">-   *     event and not vice versa.)</span>
<a href="#l73.110"></a><span id="l73.110" class="difflineminus">-   * @param usesParameter A boolean indicating whether this noun requires use</span>
<a href="#l73.111"></a><span id="l73.111" class="difflineminus">-   *     of the 'parameter' BLOB storage field on the attribute bindings in the</span>
<a href="#l73.112"></a><span id="l73.112" class="difflineminus">-   *     database to persist itself.  Use of parameters should be limited</span>
<a href="#l73.113"></a><span id="l73.113" class="difflineminus">-   *     to a reasonable number of values (16-32 is okay, more than that is</span>
<a href="#l73.114"></a><span id="l73.114" class="difflineminus">-   *     pushing it and 256 should be considered an absolute upper bound)</span>
<a href="#l73.115"></a><span id="l73.115" class="difflineminus">-   *     because of the database organization.  When false, your toParamAndValue</span>
<a href="#l73.116"></a><span id="l73.116" class="difflineminus">-   *     function is expected to return null for the parameter and likewise your</span>
<a href="#l73.117"></a><span id="l73.117" class="difflineminus">-   *     fromParamAndValue should expect ignore and generally ignore the</span>
<a href="#l73.118"></a><span id="l73.118" class="difflineminus">-   *     argument.</span>
<a href="#l73.119"></a><span id="l73.119" class="difflineminus">-   * @param toParamAndValue A function that takes an instantiated noun</span>
<a href="#l73.120"></a><span id="l73.120" class="difflineplus">+   * @param aNounDef.class The 'class' to which an instance of the noun will</span>
<a href="#l73.121"></a><span id="l73.121" class="difflineplus">+   *     belong (aka will pass an instanceof test).  You may also provide this</span>
<a href="#l73.122"></a><span id="l73.122" class="difflineplus">+   *     as 'clazz' if the keyword makes your IDE angry.</span>
<a href="#l73.123"></a><span id="l73.123" class="difflineplus">+   * @param aNounDef.allowsArbitraryAttrs Is this a 'first class noun'/can it be</span>
<a href="#l73.124"></a><span id="l73.124" class="difflineplus">+   *     a subject, AKA can this noun have attributes stored on it that relate</span>
<a href="#l73.125"></a><span id="l73.125" class="difflineplus">+   *     it to other things?  For example, a message is first-class; we store</span>
<a href="#l73.126"></a><span id="l73.126" class="difflineplus">+   *     attributes of messages.  A date is not first-class now, nor is it</span>
<a href="#l73.127"></a><span id="l73.127" class="difflineplus">+   *     likely to be; we will not store attributes about a date, although dates</span>
<a href="#l73.128"></a><span id="l73.128" class="difflineplus">+   *     will be the objects of other subjects.  (For example: we might</span>
<a href="#l73.129"></a><span id="l73.129" class="difflineplus">+   *     associate a date with a calendar event, but the date is an attribute of</span>
<a href="#l73.130"></a><span id="l73.130" class="difflineplus">+   *     the calendar event and not vice versa.)</span>
<a href="#l73.131"></a><span id="l73.131" class="difflineplus">+   * @param aNounDef.usesParameter A boolean indicating whether this noun</span>
<a href="#l73.132"></a><span id="l73.132" class="difflineplus">+   *     requires use of the 'parameter' BLOB storage field on the attribute</span>
<a href="#l73.133"></a><span id="l73.133" class="difflineplus">+   *     bindings in the database to persist itself.  Use of parameters should</span>
<a href="#l73.134"></a><span id="l73.134" class="difflineplus">+   *     be limited to a reasonable number of values (16-32 is okay, more than</span>
<a href="#l73.135"></a><span id="l73.135" class="difflineplus">+   *     that is pushing it and 256 should be considered an absolute upper</span>
<a href="#l73.136"></a><span id="l73.136" class="difflineplus">+   *     bound) because of the database organization.  When false, your</span>
<a href="#l73.137"></a><span id="l73.137" class="difflineplus">+   *     toParamAndValue function is expected to return null for the parameter</span>
<a href="#l73.138"></a><span id="l73.138" class="difflineplus">+   *     and likewise your fromParamAndValue should expect ignore and generally</span>
<a href="#l73.139"></a><span id="l73.139" class="difflineplus">+   *     ignore the argument.</span>
<a href="#l73.140"></a><span id="l73.140" class="difflineplus">+   * @param aNounDef.toParamAndValue A function that takes an instantiated noun</span>
<a href="#l73.141"></a><span id="l73.141">    *     instance and returns a 2-element list of [parameter, value] where</span>
<a href="#l73.142"></a><span id="l73.142">    *     parameter may only be non-null if you passed a usesParameter of true.</span>
<a href="#l73.143"></a><span id="l73.143">    *     Parameter may be of any type (BLOB), and value must be numeric (pass</span>
<a href="#l73.144"></a><span id="l73.144">    *     0 if you don't need the value).</span>
<a href="#l73.145"></a><span id="l73.145">    *</span>
<a href="#l73.146"></a><span id="l73.146" class="difflineminus">-   * @param schema Unsupported mechanism by which you can define a table that</span>
<a href="#l73.147"></a><span id="l73.147" class="difflineminus">-   *     corresponds to this noun.  The table will be created if it does not</span>
<a href="#l73.148"></a><span id="l73.148" class="difflineminus">-   *     exist.</span>
<a href="#l73.149"></a><span id="l73.149" class="difflineplus">+   * @param aNounDef.isPrimitive True when the noun instance is a raw numeric</span>
<a href="#l73.150"></a><span id="l73.150" class="difflineplus">+   *     value/string/boolean.  False when the instance is an object.  When</span>
<a href="#l73.151"></a><span id="l73.151" class="difflineplus">+   *     false, it is assumed the attribute that serves as a unique identifier</span>
<a href="#l73.152"></a><span id="l73.152" class="difflineplus">+   *     for the value is &quot;id&quot; unless 'idAttr' is provided.</span>
<a href="#l73.153"></a><span id="l73.153" class="difflineplus">+   * @param [aNounDef.idAttr=&quot;id&quot;] For non-primitive nouns, this is the</span>
<a href="#l73.154"></a><span id="l73.154" class="difflineplus">+   *     attribute on the object that uniquely identifies it.</span>
<a href="#l73.155"></a><span id="l73.155" class="difflineplus">+   *</span>
<a href="#l73.156"></a><span id="l73.156" class="difflineplus">+   * @param aNounDef.schema Unsupported mechanism by which you can define a</span>
<a href="#l73.157"></a><span id="l73.157" class="difflineplus">+   *     table that corresponds to this noun.  The table will be created if it</span>
<a href="#l73.158"></a><span id="l73.158" class="difflineplus">+   *     does not exist.</span>
<a href="#l73.159"></a><span id="l73.159">    *     - name The table name; don't conflict with other things!</span>
<a href="#l73.160"></a><span id="l73.160">    *     - columns A list of [column name, sqlite type] tuples.  You should</span>
<a href="#l73.161"></a><span id="l73.161">    *       always include a definition like [&quot;id&quot;, &quot;INTEGER PRIMARY KEY&quot;] for</span>
<a href="#l73.162"></a><span id="l73.162">    *       now (and it should be the first column name too.)  If you care about</span>
<a href="#l73.163"></a><span id="l73.163">    *       how the attributes are poked into your object (for example, you want</span>
<a href="#l73.164"></a><span id="l73.164">    *       underscores used for some of them because the attributes should be</span>
<a href="#l73.165"></a><span id="l73.165">    *       immutable), then you can include a third string that is the name of</span>
<a href="#l73.166"></a><span id="l73.166">    *       the attribute to use.</span>
<a href="#l73.167"></a><span id="l73.167" class="difflineat">@@ -914,16 +928,25 @@ var Gloda = {</span>
<a href="#l73.168"></a><span id="l73.168">       aNounID = this._nextNounID++;</span>
<a href="#l73.169"></a><span id="l73.169">     aNounDef.id = aNounID;</span>
<a href="#l73.170"></a><span id="l73.170"> </span>
<a href="#l73.171"></a><span id="l73.171">     // Let people whose editors get angry about illegal attribute names use</span>
<a href="#l73.172"></a><span id="l73.172">     //  clazz instead of class.</span>
<a href="#l73.173"></a><span id="l73.173">     if (aNounDef.clazz)</span>
<a href="#l73.174"></a><span id="l73.174">       aNounDef.class = aNounDef.clazz;</span>
<a href="#l73.175"></a><span id="l73.175"> </span>
<a href="#l73.176"></a><span id="l73.176" class="difflineplus">+    if (!(&quot;idAttr&quot; in aNounDef))</span>
<a href="#l73.177"></a><span id="l73.177" class="difflineplus">+      aNounDef.idAttr = &quot;id&quot;;</span>
<a href="#l73.178"></a><span id="l73.178" class="difflineplus">+    if (!(&quot;comparator&quot; in aNounDef)) {</span>
<a href="#l73.179"></a><span id="l73.179" class="difflineplus">+      aNounDef.comparator = function() {</span>
<a href="#l73.180"></a><span id="l73.180" class="difflineplus">+        throw new Error(&quot;Noun type '&quot; + aNounDef.name +</span>
<a href="#l73.181"></a><span id="l73.181" class="difflineplus">+                        &quot;' lacks a real comparator.&quot;);</span>
<a href="#l73.182"></a><span id="l73.182" class="difflineplus">+      };</span>
<a href="#l73.183"></a><span id="l73.183" class="difflineplus">+    }</span>
<a href="#l73.184"></a><span id="l73.184" class="difflineplus">+</span>
<a href="#l73.185"></a><span id="l73.185">     // We allow nouns to have data tables associated with them where we do all</span>
<a href="#l73.186"></a><span id="l73.186">     //  the legwork.  The schema attribute is the gateway to this magical world</span>
<a href="#l73.187"></a><span id="l73.187">     //  of functionality.  Said door is officially unsupported.</span>
<a href="#l73.188"></a><span id="l73.188">     if (aNounDef.schema) {</span>
<a href="#l73.189"></a><span id="l73.189">       if (aNounDef.schema.name)</span>
<a href="#l73.190"></a><span id="l73.190">         aNounDef.tableName = &quot;ext_&quot; + aNounDef.schema.name;</span>
<a href="#l73.191"></a><span id="l73.191">       else</span>
<a href="#l73.192"></a><span id="l73.192">         aNounDef.tableName = &quot;ext_&quot; + aNounDef.name;</span>
<a href="#l73.193"></a><span id="l73.193" class="difflineat">@@ -1084,75 +1107,159 @@ var Gloda = {</span>
<a href="#l73.194"></a><span id="l73.194">    *  own noun_*.js files.  There are some trade-offs to be made, and I think</span>
<a href="#l73.195"></a><span id="l73.195">    *  we can deal with those once we start to integrate lightning/calendar and</span>
<a href="#l73.196"></a><span id="l73.196">    *  our noun space gets large and more heterogeneous.</span>
<a href="#l73.197"></a><span id="l73.197">    */</span>
<a href="#l73.198"></a><span id="l73.198">   _initAttributes: function gloda_ns_initAttributes() {</span>
<a href="#l73.199"></a><span id="l73.199">     this.defineNoun({</span>
<a href="#l73.200"></a><span id="l73.200">       name: &quot;bool&quot;,</span>
<a href="#l73.201"></a><span id="l73.201">       clazz: Boolean, allowsArbitraryAttrs: false,</span>
<a href="#l73.202"></a><span id="l73.202" class="difflineplus">+      isPrimitive: true,</span>
<a href="#l73.203"></a><span id="l73.203" class="difflineplus">+      // favor true before false</span>
<a href="#l73.204"></a><span id="l73.204" class="difflineplus">+      comparator: function gloda_bool_comparator(a, b) {</span>
<a href="#l73.205"></a><span id="l73.205" class="difflineplus">+        if (a == null) {</span>
<a href="#l73.206"></a><span id="l73.206" class="difflineplus">+          if (b == null)</span>
<a href="#l73.207"></a><span id="l73.207" class="difflineplus">+            return 0;</span>
<a href="#l73.208"></a><span id="l73.208" class="difflineplus">+          else</span>
<a href="#l73.209"></a><span id="l73.209" class="difflineplus">+            return 1;</span>
<a href="#l73.210"></a><span id="l73.210" class="difflineplus">+        }</span>
<a href="#l73.211"></a><span id="l73.211" class="difflineplus">+        else if (b == null) {</span>
<a href="#l73.212"></a><span id="l73.212" class="difflineplus">+          return -1;</span>
<a href="#l73.213"></a><span id="l73.213" class="difflineplus">+        }</span>
<a href="#l73.214"></a><span id="l73.214" class="difflineplus">+        return b - a;</span>
<a href="#l73.215"></a><span id="l73.215" class="difflineplus">+      },</span>
<a href="#l73.216"></a><span id="l73.216">       toParamAndValue: function(aBool) {</span>
<a href="#l73.217"></a><span id="l73.217">         return [null, aBool ? 1 : 0];</span>
<a href="#l73.218"></a><span id="l73.218">       }}, this.NOUN_BOOLEAN);</span>
<a href="#l73.219"></a><span id="l73.219">     this.defineNoun({</span>
<a href="#l73.220"></a><span id="l73.220">       name: &quot;number&quot;,</span>
<a href="#l73.221"></a><span id="l73.221">       clazz: Number, allowsArbitraryAttrs: false, continuous: true,</span>
<a href="#l73.222"></a><span id="l73.222" class="difflineplus">+      isPrimitive: true,</span>
<a href="#l73.223"></a><span id="l73.223" class="difflineplus">+      comparator: function gloda_number_comparator(a, b) {</span>
<a href="#l73.224"></a><span id="l73.224" class="difflineplus">+        if (a == null) {</span>
<a href="#l73.225"></a><span id="l73.225" class="difflineplus">+          if (b == null)</span>
<a href="#l73.226"></a><span id="l73.226" class="difflineplus">+            return 0;</span>
<a href="#l73.227"></a><span id="l73.227" class="difflineplus">+          else</span>
<a href="#l73.228"></a><span id="l73.228" class="difflineplus">+            return 1;</span>
<a href="#l73.229"></a><span id="l73.229" class="difflineplus">+        }</span>
<a href="#l73.230"></a><span id="l73.230" class="difflineplus">+        else if (b == null) {</span>
<a href="#l73.231"></a><span id="l73.231" class="difflineplus">+          return -1;</span>
<a href="#l73.232"></a><span id="l73.232" class="difflineplus">+        }</span>
<a href="#l73.233"></a><span id="l73.233" class="difflineplus">+        return a - b;</span>
<a href="#l73.234"></a><span id="l73.234" class="difflineplus">+      },</span>
<a href="#l73.235"></a><span id="l73.235">       toParamAndValue: function(aNum) {</span>
<a href="#l73.236"></a><span id="l73.236">         return [null, aNum];</span>
<a href="#l73.237"></a><span id="l73.237">       }}, this.NOUN_NUMBER);</span>
<a href="#l73.238"></a><span id="l73.238">     this.defineNoun({</span>
<a href="#l73.239"></a><span id="l73.239">       name: &quot;string&quot;,</span>
<a href="#l73.240"></a><span id="l73.240">       clazz: String, allowsArbitraryAttrs: false,</span>
<a href="#l73.241"></a><span id="l73.241" class="difflineplus">+      isPrimitive: true,</span>
<a href="#l73.242"></a><span id="l73.242" class="difflineplus">+      comparator: function gloda_string_comparator(a, b) {</span>
<a href="#l73.243"></a><span id="l73.243" class="difflineplus">+        if (a == null) {</span>
<a href="#l73.244"></a><span id="l73.244" class="difflineplus">+          if (b == null)</span>
<a href="#l73.245"></a><span id="l73.245" class="difflineplus">+            return 0;</span>
<a href="#l73.246"></a><span id="l73.246" class="difflineplus">+          else</span>
<a href="#l73.247"></a><span id="l73.247" class="difflineplus">+            return 1;</span>
<a href="#l73.248"></a><span id="l73.248" class="difflineplus">+        }</span>
<a href="#l73.249"></a><span id="l73.249" class="difflineplus">+        else if (b == null) {</span>
<a href="#l73.250"></a><span id="l73.250" class="difflineplus">+          return -1;</span>
<a href="#l73.251"></a><span id="l73.251" class="difflineplus">+        }</span>
<a href="#l73.252"></a><span id="l73.252" class="difflineplus">+        return a.localeCompare(b);</span>
<a href="#l73.253"></a><span id="l73.253" class="difflineplus">+      },</span>
<a href="#l73.254"></a><span id="l73.254">       toParamAndValue: function(aString) {</span>
<a href="#l73.255"></a><span id="l73.255">         return [null, aString];</span>
<a href="#l73.256"></a><span id="l73.256">       }}, this.NOUN_STRING);</span>
<a href="#l73.257"></a><span id="l73.257">     this.defineNoun({</span>
<a href="#l73.258"></a><span id="l73.258">       name: &quot;date&quot;,</span>
<a href="#l73.259"></a><span id="l73.259">       clazz: Date, allowsArbitraryAttrs: false, continuous: true,</span>
<a href="#l73.260"></a><span id="l73.260" class="difflineplus">+      isPrimitive: true,</span>
<a href="#l73.261"></a><span id="l73.261" class="difflineplus">+      comparator: function gloda_data_comparator(a, b) {</span>
<a href="#l73.262"></a><span id="l73.262" class="difflineplus">+        if (a == null) {</span>
<a href="#l73.263"></a><span id="l73.263" class="difflineplus">+          if (b == null)</span>
<a href="#l73.264"></a><span id="l73.264" class="difflineplus">+            return 0;</span>
<a href="#l73.265"></a><span id="l73.265" class="difflineplus">+          else</span>
<a href="#l73.266"></a><span id="l73.266" class="difflineplus">+            return 1;</span>
<a href="#l73.267"></a><span id="l73.267" class="difflineplus">+        }</span>
<a href="#l73.268"></a><span id="l73.268" class="difflineplus">+        else if (b == null) {</span>
<a href="#l73.269"></a><span id="l73.269" class="difflineplus">+          return -1;</span>
<a href="#l73.270"></a><span id="l73.270" class="difflineplus">+        }</span>
<a href="#l73.271"></a><span id="l73.271" class="difflineplus">+        return a - b;</span>
<a href="#l73.272"></a><span id="l73.272" class="difflineplus">+      },</span>
<a href="#l73.273"></a><span id="l73.273">       toParamAndValue: function(aDate) {</span>
<a href="#l73.274"></a><span id="l73.274">         return [null, aDate.valueOf() * 1000];</span>
<a href="#l73.275"></a><span id="l73.275">       }}, this.NOUN_DATE);</span>
<a href="#l73.276"></a><span id="l73.276">     this.defineNoun({</span>
<a href="#l73.277"></a><span id="l73.277">       name: &quot;fulltext&quot;,</span>
<a href="#l73.278"></a><span id="l73.278">       clazz: String, allowsArbitraryAttrs: false, continuous: false,</span>
<a href="#l73.279"></a><span id="l73.279" class="difflineplus">+      isPrimitive: true,</span>
<a href="#l73.280"></a><span id="l73.280" class="difflineplus">+      comparator: function gloda_fulltext_comparator(a, b) {</span>
<a href="#l73.281"></a><span id="l73.281" class="difflineplus">+        throw new Error(&quot;Fulltext nouns are not comparable!&quot;);</span>
<a href="#l73.282"></a><span id="l73.282" class="difflineplus">+      },</span>
<a href="#l73.283"></a><span id="l73.283">       // as noted on NOUN_FULLTEXT, we just pass the string around.  it never</span>
<a href="#l73.284"></a><span id="l73.284">       //  hits the database, so it's okay.</span>
<a href="#l73.285"></a><span id="l73.285">       toParamAndValue: function(aString) {</span>
<a href="#l73.286"></a><span id="l73.286">         return [null, aString];</span>
<a href="#l73.287"></a><span id="l73.287">       }}, this.NOUN_FULLTEXT);</span>
<a href="#l73.288"></a><span id="l73.288"> </span>
<a href="#l73.289"></a><span id="l73.289">     this.defineNoun({</span>
<a href="#l73.290"></a><span id="l73.290">       name: &quot;folder&quot;,</span>
<a href="#l73.291"></a><span id="l73.291">       clazz: GlodaFolder,</span>
<a href="#l73.292"></a><span id="l73.292">       allowsArbitraryAttrs: false,</span>
<a href="#l73.293"></a><span id="l73.293" class="difflineplus">+      isPrimitive: false,</span>
<a href="#l73.294"></a><span id="l73.294" class="difflineplus">+      comparator: function gloda_folder_comparator(a, b) {</span>
<a href="#l73.295"></a><span id="l73.295" class="difflineplus">+        if (a == null) {</span>
<a href="#l73.296"></a><span id="l73.296" class="difflineplus">+          if (b == null)</span>
<a href="#l73.297"></a><span id="l73.297" class="difflineplus">+            return 0;</span>
<a href="#l73.298"></a><span id="l73.298" class="difflineplus">+          else</span>
<a href="#l73.299"></a><span id="l73.299" class="difflineplus">+            return 1;</span>
<a href="#l73.300"></a><span id="l73.300" class="difflineplus">+        }</span>
<a href="#l73.301"></a><span id="l73.301" class="difflineplus">+        else if (b == null) {</span>
<a href="#l73.302"></a><span id="l73.302" class="difflineplus">+          return -1;</span>
<a href="#l73.303"></a><span id="l73.303" class="difflineplus">+        }</span>
<a href="#l73.304"></a><span id="l73.304" class="difflineplus">+        return a.name.localeCompare(b.name);</span>
<a href="#l73.305"></a><span id="l73.305" class="difflineplus">+      },</span>
<a href="#l73.306"></a><span id="l73.306">       toParamAndValue: function(aFolderOrGlodaFolder) {</span>
<a href="#l73.307"></a><span id="l73.307">         if (aFolderOrGlodaFolder instanceof GlodaFolder)</span>
<a href="#l73.308"></a><span id="l73.308">           return [null, aFolderOrGlodaFolder.id];</span>
<a href="#l73.309"></a><span id="l73.309">         else</span>
<a href="#l73.310"></a><span id="l73.310">           return [null, GlodaDatastore._mapFolder(aFolderOrGlodaFolder).id];</span>
<a href="#l73.311"></a><span id="l73.311">       }}, this.NOUN_FOLDER);</span>
<a href="#l73.312"></a><span id="l73.312">     this.defineNoun({</span>
<a href="#l73.313"></a><span id="l73.313">       name: &quot;conversation&quot;,</span>
<a href="#l73.314"></a><span id="l73.314">       clazz: GlodaConversation,</span>
<a href="#l73.315"></a><span id="l73.315">       allowsArbitraryAttrs: false,</span>
<a href="#l73.316"></a><span id="l73.316" class="difflineplus">+      isPrimitive: false,</span>
<a href="#l73.317"></a><span id="l73.317">       cache: true, cacheCost: 512,</span>
<a href="#l73.318"></a><span id="l73.318">       tableName: &quot;conversations&quot;,</span>
<a href="#l73.319"></a><span id="l73.319">       attrTableName: &quot;messageAttributes&quot;, attrIDColumnName: &quot;conversationID&quot;,</span>
<a href="#l73.320"></a><span id="l73.320">       datastore: GlodaDatastore,</span>
<a href="#l73.321"></a><span id="l73.321">       objFromRow: GlodaDatastore._conversationFromRow,</span>
<a href="#l73.322"></a><span id="l73.322" class="difflineplus">+      comparator: function gloda_conversation_comparator(a, b) {</span>
<a href="#l73.323"></a><span id="l73.323" class="difflineplus">+        if (a == null) {</span>
<a href="#l73.324"></a><span id="l73.324" class="difflineplus">+          if (b == null)</span>
<a href="#l73.325"></a><span id="l73.325" class="difflineplus">+            return 0;</span>
<a href="#l73.326"></a><span id="l73.326" class="difflineplus">+          else</span>
<a href="#l73.327"></a><span id="l73.327" class="difflineplus">+            return 1;</span>
<a href="#l73.328"></a><span id="l73.328" class="difflineplus">+        }</span>
<a href="#l73.329"></a><span id="l73.329" class="difflineplus">+        else if (b == null) {</span>
<a href="#l73.330"></a><span id="l73.330" class="difflineplus">+          return -1;</span>
<a href="#l73.331"></a><span id="l73.331" class="difflineplus">+        }</span>
<a href="#l73.332"></a><span id="l73.332" class="difflineplus">+        return a.subject.localeCompare(b.subject);</span>
<a href="#l73.333"></a><span id="l73.333" class="difflineplus">+      },</span>
<a href="#l73.334"></a><span id="l73.334">       toParamAndValue: function(aConversation) {</span>
<a href="#l73.335"></a><span id="l73.335">         if (aConversation instanceof GlodaConversation)</span>
<a href="#l73.336"></a><span id="l73.336">           return [null, aConversation.id];</span>
<a href="#l73.337"></a><span id="l73.337">         else // assume they're just passing the id directly</span>
<a href="#l73.338"></a><span id="l73.338">           return [null, aConversation];</span>
<a href="#l73.339"></a><span id="l73.339">       }}, this.NOUN_CONVERSATION);</span>
<a href="#l73.340"></a><span id="l73.340">     this.defineNoun({</span>
<a href="#l73.341"></a><span id="l73.341">       name: &quot;message&quot;,</span>
<a href="#l73.342"></a><span id="l73.342">       clazz: GlodaMessage,</span>
<a href="#l73.343"></a><span id="l73.343">       allowsArbitraryAttrs: true,</span>
<a href="#l73.344"></a><span id="l73.344" class="difflineplus">+      isPrimitive: false,</span>
<a href="#l73.345"></a><span id="l73.345">       cache: true, cacheCost: 2048,</span>
<a href="#l73.346"></a><span id="l73.346">       tableName: &quot;messages&quot;,</span>
<a href="#l73.347"></a><span id="l73.347">       // we will always have a fulltext row, even for messages where we don't</span>
<a href="#l73.348"></a><span id="l73.348">       //  have the body available.  this is because we want the subject indexed.</span>
<a href="#l73.349"></a><span id="l73.349">       dbQueryJoinMagic:</span>
<a href="#l73.350"></a><span id="l73.350">         &quot; INNER JOIN messagesText ON messages.id = messagesText.rowid&quot;,</span>
<a href="#l73.351"></a><span id="l73.351">       attrTableName: &quot;messageAttributes&quot;, attrIDColumnName: &quot;messageID&quot;,</span>
<a href="#l73.352"></a><span id="l73.352">       datastore: GlodaDatastore, objFromRow: GlodaDatastore._messageFromRow,</span>
<a href="#l73.353"></a><span id="l73.353" class="difflineat">@@ -1170,52 +1277,109 @@ var Gloda = {</span>
<a href="#l73.354"></a><span id="l73.354">           return [null, aMessage.id];</span>
<a href="#l73.355"></a><span id="l73.355">         else // assume they're just passing the id directly</span>
<a href="#l73.356"></a><span id="l73.356">           return [null, aMessage];</span>
<a href="#l73.357"></a><span id="l73.357">       }}, this.NOUN_MESSAGE);</span>
<a href="#l73.358"></a><span id="l73.358">     this.defineNoun({</span>
<a href="#l73.359"></a><span id="l73.359">       name: &quot;contact&quot;,</span>
<a href="#l73.360"></a><span id="l73.360">       clazz: GlodaContact,</span>
<a href="#l73.361"></a><span id="l73.361">       allowsArbitraryAttrs: true,</span>
<a href="#l73.362"></a><span id="l73.362" class="difflineplus">+      isPrimitive: false,</span>
<a href="#l73.363"></a><span id="l73.363">       cache: true, cacheCost: 128,</span>
<a href="#l73.364"></a><span id="l73.364">       tableName: &quot;contacts&quot;,</span>
<a href="#l73.365"></a><span id="l73.365">       attrTableName: &quot;contactAttributes&quot;, attrIDColumnName: &quot;contactID&quot;,</span>
<a href="#l73.366"></a><span id="l73.366">       datastore: GlodaDatastore, objFromRow: GlodaDatastore._contactFromRow,</span>
<a href="#l73.367"></a><span id="l73.367">       dbAttribAdjuster: GlodaDatastore.adjustAttributes,</span>
<a href="#l73.368"></a><span id="l73.368">       objInsert: GlodaDatastore.insertContact,</span>
<a href="#l73.369"></a><span id="l73.369">       objUpdate: GlodaDatastore.updateContact,</span>
<a href="#l73.370"></a><span id="l73.370" class="difflineplus">+      comparator: function gloda_contact_comparator(a, b) {</span>
<a href="#l73.371"></a><span id="l73.371" class="difflineplus">+        if (a == null) {</span>
<a href="#l73.372"></a><span id="l73.372" class="difflineplus">+          if (b == null)</span>
<a href="#l73.373"></a><span id="l73.373" class="difflineplus">+            return 0;</span>
<a href="#l73.374"></a><span id="l73.374" class="difflineplus">+          else</span>
<a href="#l73.375"></a><span id="l73.375" class="difflineplus">+            return 1;</span>
<a href="#l73.376"></a><span id="l73.376" class="difflineplus">+        }</span>
<a href="#l73.377"></a><span id="l73.377" class="difflineplus">+        else if (b == null) {</span>
<a href="#l73.378"></a><span id="l73.378" class="difflineplus">+          return -1;</span>
<a href="#l73.379"></a><span id="l73.379" class="difflineplus">+        }</span>
<a href="#l73.380"></a><span id="l73.380" class="difflineplus">+        return a.name.localeCompare(b.name);</span>
<a href="#l73.381"></a><span id="l73.381" class="difflineplus">+      },</span>
<a href="#l73.382"></a><span id="l73.382">       toParamAndValue: function(aContact) {</span>
<a href="#l73.383"></a><span id="l73.383">         if (aContact instanceof GlodaContact)</span>
<a href="#l73.384"></a><span id="l73.384">           return [null, aContact.id];</span>
<a href="#l73.385"></a><span id="l73.385">         else // assume they're just passing the id directly</span>
<a href="#l73.386"></a><span id="l73.386">           return [null, aContact];</span>
<a href="#l73.387"></a><span id="l73.387">       }}, this.NOUN_CONTACT);</span>
<a href="#l73.388"></a><span id="l73.388">     this.defineNoun({</span>
<a href="#l73.389"></a><span id="l73.389">       name: &quot;identity&quot;,</span>
<a href="#l73.390"></a><span id="l73.390">       clazz: GlodaIdentity,</span>
<a href="#l73.391"></a><span id="l73.391">       allowsArbitraryAttrs: false,</span>
<a href="#l73.392"></a><span id="l73.392" class="difflineplus">+      isPrimitive: false,</span>
<a href="#l73.393"></a><span id="l73.393">       cache: true, cacheCost: 128,</span>
<a href="#l73.394"></a><span id="l73.394">       usesUniqueValue: true,</span>
<a href="#l73.395"></a><span id="l73.395">       tableName: &quot;identities&quot;,</span>
<a href="#l73.396"></a><span id="l73.396">       datastore: GlodaDatastore, objFromRow: GlodaDatastore._identityFromRow,</span>
<a href="#l73.397"></a><span id="l73.397" class="difflineplus">+      /**</span>
<a href="#l73.398"></a><span id="l73.398" class="difflineplus">+       * Short string is the contact name, long string includes the identity</span>
<a href="#l73.399"></a><span id="l73.399" class="difflineplus">+       *  value too, delimited by a colon.  Not tremendously localizable.</span>
<a href="#l73.400"></a><span id="l73.400" class="difflineplus">+       */</span>
<a href="#l73.401"></a><span id="l73.401" class="difflineplus">+      userVisibleString: function(aIdentity, aLong) {</span>
<a href="#l73.402"></a><span id="l73.402" class="difflineplus">+        if (!aLong)</span>
<a href="#l73.403"></a><span id="l73.403" class="difflineplus">+          return aIdentity.contact.name;</span>
<a href="#l73.404"></a><span id="l73.404" class="difflineplus">+        if (aIdentity.contact.name == aIdentity.value)</span>
<a href="#l73.405"></a><span id="l73.405" class="difflineplus">+          return aIdentity.value;</span>
<a href="#l73.406"></a><span id="l73.406" class="difflineplus">+        return aIdentity.contact.name + &quot; (&quot; + aIdentity.value + &quot;)&quot;;</span>
<a href="#l73.407"></a><span id="l73.407" class="difflineplus">+      },</span>
<a href="#l73.408"></a><span id="l73.408" class="difflineplus">+      comparator: function gloda_identity_comparator(a, b) {</span>
<a href="#l73.409"></a><span id="l73.409" class="difflineplus">+        if (a == null) {</span>
<a href="#l73.410"></a><span id="l73.410" class="difflineplus">+          if (b == null)</span>
<a href="#l73.411"></a><span id="l73.411" class="difflineplus">+            return 0;</span>
<a href="#l73.412"></a><span id="l73.412" class="difflineplus">+          else</span>
<a href="#l73.413"></a><span id="l73.413" class="difflineplus">+            return 1;</span>
<a href="#l73.414"></a><span id="l73.414" class="difflineplus">+        }</span>
<a href="#l73.415"></a><span id="l73.415" class="difflineplus">+        else if (b == null) {</span>
<a href="#l73.416"></a><span id="l73.416" class="difflineplus">+          return -1;</span>
<a href="#l73.417"></a><span id="l73.417" class="difflineplus">+        }</span>
<a href="#l73.418"></a><span id="l73.418" class="difflineplus">+        return a.contact.name.localeCompare(b.contact.name);</span>
<a href="#l73.419"></a><span id="l73.419" class="difflineplus">+      },</span>
<a href="#l73.420"></a><span id="l73.420">       toParamAndValue: function(aIdentity) {</span>
<a href="#l73.421"></a><span id="l73.421">         if (aIdentity instanceof GlodaIdentity)</span>
<a href="#l73.422"></a><span id="l73.422">           return [null, aIdentity.id];</span>
<a href="#l73.423"></a><span id="l73.423">         else // assume they're just passing the id directly</span>
<a href="#l73.424"></a><span id="l73.424">           return [null, aIdentity];</span>
<a href="#l73.425"></a><span id="l73.425">       }}, this.NOUN_IDENTITY);</span>
<a href="#l73.426"></a><span id="l73.426"> </span>
<a href="#l73.427"></a><span id="l73.427">     // parameterized identity is just two identities; we store the first one</span>
<a href="#l73.428"></a><span id="l73.428">     //  (whose value set must be very constrainted, like the 'me' identities)</span>
<a href="#l73.429"></a><span id="l73.429">     //  as the parameter, the second (which does not need to be constrained)</span>
<a href="#l73.430"></a><span id="l73.430">     //  as the value.</span>
<a href="#l73.431"></a><span id="l73.431">     this.defineNoun({</span>
<a href="#l73.432"></a><span id="l73.432">       name: &quot;parameterized-identity&quot;,</span>
<a href="#l73.433"></a><span id="l73.433">       clazz: null,</span>
<a href="#l73.434"></a><span id="l73.434">       allowsArbitraryAttrs: false,</span>
<a href="#l73.435"></a><span id="l73.435" class="difflineplus">+      comparator: function gloda_fulltext_comparator(a, b) {</span>
<a href="#l73.436"></a><span id="l73.436" class="difflineplus">+        if (a == null) {</span>
<a href="#l73.437"></a><span id="l73.437" class="difflineplus">+          if (b == null)</span>
<a href="#l73.438"></a><span id="l73.438" class="difflineplus">+            return 0;</span>
<a href="#l73.439"></a><span id="l73.439" class="difflineplus">+          else</span>
<a href="#l73.440"></a><span id="l73.440" class="difflineplus">+            return 1;</span>
<a href="#l73.441"></a><span id="l73.441" class="difflineplus">+        }</span>
<a href="#l73.442"></a><span id="l73.442" class="difflineplus">+        else if (b == null) {</span>
<a href="#l73.443"></a><span id="l73.443" class="difflineplus">+          return -1;</span>
<a href="#l73.444"></a><span id="l73.444" class="difflineplus">+        }</span>
<a href="#l73.445"></a><span id="l73.445" class="difflineplus">+        // First sort by the first identity in the tuple</span>
<a href="#l73.446"></a><span id="l73.446" class="difflineplus">+        // Since our general use-case is for the first guy to be &quot;me&quot;, we only</span>
<a href="#l73.447"></a><span id="l73.447" class="difflineplus">+        //  compare the identity value, not the name.</span>
<a href="#l73.448"></a><span id="l73.448" class="difflineplus">+        let fic = a[0].value.localeCompare(b[0].value);</span>
<a href="#l73.449"></a><span id="l73.449" class="difflineplus">+        if (fic)</span>
<a href="#l73.450"></a><span id="l73.450" class="difflineplus">+          return fic;</span>
<a href="#l73.451"></a><span id="l73.451" class="difflineplus">+        // Next compare the second identity in the tuple, but use the contact</span>
<a href="#l73.452"></a><span id="l73.452" class="difflineplus">+        //  this time to be consistent with our identity comparator.</span>
<a href="#l73.453"></a><span id="l73.453" class="difflineplus">+        return a[1].contact.name.localeCompare(b[1].contact.name);</span>
<a href="#l73.454"></a><span id="l73.454" class="difflineplus">+      },</span>
<a href="#l73.455"></a><span id="l73.455">       computeDelta: function(aCurValues, aOldValues) {</span>
<a href="#l73.456"></a><span id="l73.456">         let oldMap = {};</span>
<a href="#l73.457"></a><span id="l73.457">         for each (let [, tupe] in Iterator(aOldValues)) {</span>
<a href="#l73.458"></a><span id="l73.458">           let [originIdentity, targetIdentity] = tupe;</span>
<a href="#l73.459"></a><span id="l73.459">           let targets = oldMap[originIdentity];</span>
<a href="#l73.460"></a><span id="l73.460">           if (targets === undefined)</span>
<a href="#l73.461"></a><span id="l73.461">             targets = oldMap[originIdentity] = {};</span>
<a href="#l73.462"></a><span id="l73.462">           targets[targetIdentity] = true;</span>
<a href="#l73.463"></a><span id="l73.463" class="difflineat">@@ -1350,53 +1514,82 @@ var Gloda = {</span>
<a href="#l73.464"></a><span id="l73.464">           }</span>
<a href="#l73.465"></a><span id="l73.465">           this._constraints.push(constraint);</span>
<a href="#l73.466"></a><span id="l73.466">           return this;</span>
<a href="#l73.467"></a><span id="l73.467">         };</span>
<a href="#l73.468"></a><span id="l73.468"> </span>
<a href="#l73.469"></a><span id="l73.469">         aSubjectNounDef.queryClass.prototype[aAttrDef.boundName + &quot;Like&quot;] =</span>
<a href="#l73.470"></a><span id="l73.470">           likeConstrainer;</span>
<a href="#l73.471"></a><span id="l73.471">       }</span>
<a href="#l73.472"></a><span id="l73.472" class="difflineplus">+</span>
<a href="#l73.473"></a><span id="l73.473" class="difflineplus">+      // - Custom helpers provided by the noun type...</span>
<a href="#l73.474"></a><span id="l73.474" class="difflineplus">+      if (&quot;queryHelpers&quot; in objectNounDef) {</span>
<a href="#l73.475"></a><span id="l73.475" class="difflineplus">+        for each (let [name, helper] in Iterator(objectNounDef.queryHelpers)) {</span>
<a href="#l73.476"></a><span id="l73.476" class="difflineplus">+          // we need a new closure...</span>
<a href="#l73.477"></a><span id="l73.477" class="difflineplus">+          let helperFunc = helper;</span>
<a href="#l73.478"></a><span id="l73.478" class="difflineplus">+          aSubjectNounDef.queryClass.prototype[aAttrDef.boundName + name] =</span>
<a href="#l73.479"></a><span id="l73.479" class="difflineplus">+            function() {</span>
<a href="#l73.480"></a><span id="l73.480" class="difflineplus">+              return helperFunc.call(this, aAttrDef, arguments);</span>
<a href="#l73.481"></a><span id="l73.481" class="difflineplus">+            };</span>
<a href="#l73.482"></a><span id="l73.482" class="difflineplus">+        }</span>
<a href="#l73.483"></a><span id="l73.483" class="difflineplus">+      }</span>
<a href="#l73.484"></a><span id="l73.484">     }</span>
<a href="#l73.485"></a><span id="l73.485">   },</span>
<a href="#l73.486"></a><span id="l73.486"> </span>
<a href="#l73.487"></a><span id="l73.487">   /**</span>
<a href="#l73.488"></a><span id="l73.488" class="difflineplus">+   * Names of attribute-specific localized strings and the JS attribute they are</span>
<a href="#l73.489"></a><span id="l73.489" class="difflineplus">+   *  exposed as in the attribute's &quot;strings&quot; attribute (if the provider has a</span>
<a href="#l73.490"></a><span id="l73.490" class="difflineplus">+   *  string bundle exposed on its &quot;strings&quot; attribute).  They are rooted at</span>
<a href="#l73.491"></a><span id="l73.491" class="difflineplus">+   *  &quot;gloda.SUBJECT-NOUN-NAME.attr.ATTR-NAME.*&quot;.</span>
<a href="#l73.492"></a><span id="l73.492" class="difflineplus">+   *</span>
<a href="#l73.493"></a><span id="l73.493" class="difflineplus">+   * Please consult the localization notes in gloda.properties to understand</span>
<a href="#l73.494"></a><span id="l73.494" class="difflineplus">+   *  what these are used for.</span>
<a href="#l73.495"></a><span id="l73.495" class="difflineplus">+   */</span>
<a href="#l73.496"></a><span id="l73.496" class="difflineplus">+  _ATTR_LOCALIZED_STRINGS: {</span>
<a href="#l73.497"></a><span id="l73.497" class="difflineplus">+    /* - Faceting */</span>
<a href="#l73.498"></a><span id="l73.498" class="difflineplus">+    facetLabel: &quot;facetLabel&quot;,</span>
<a href="#l73.499"></a><span id="l73.499" class="difflineplus">+    includeLabel: &quot;includeLabel&quot;,</span>
<a href="#l73.500"></a><span id="l73.500" class="difflineplus">+    excludeLabel: &quot;excludeLabel&quot;,</span>
<a href="#l73.501"></a><span id="l73.501" class="difflineplus">+    remainderLabel: &quot;remainderLabel&quot;,</span>
<a href="#l73.502"></a><span id="l73.502" class="difflineplus">+  },</span>
<a href="#l73.503"></a><span id="l73.503" class="difflineplus">+  /**</span>
<a href="#l73.504"></a><span id="l73.504">    * Define an attribute and all its meta-data.  Takes a single dictionary as</span>
<a href="#l73.505"></a><span id="l73.505">    *  its argument, with the following required properties:</span>
<a href="#l73.506"></a><span id="l73.506">    *</span>
<a href="#l73.507"></a><span id="l73.507" class="difflineminus">-   * @param provider The object instance providing a 'process' method.</span>
<a href="#l73.508"></a><span id="l73.508" class="difflineminus">-   * @param extensionName The name of the extension providing these attributes.</span>
<a href="#l73.509"></a><span id="l73.509" class="difflineminus">-   * @param attributeType The type of attribute, one of the values from the</span>
<a href="#l73.510"></a><span id="l73.510" class="difflineminus">-   *     kAttr* enumeration.</span>
<a href="#l73.511"></a><span id="l73.511" class="difflineminus">-   * @param attributeName The name of the attribute, which also doubles as the</span>
<a href="#l73.512"></a><span id="l73.512" class="difflineminus">-   *     bound property name if you pass 'bind' a value of true.  You are</span>
<a href="#l73.513"></a><span id="l73.513" class="difflineplus">+   * @param aAttrDef.provider The object instance providing a 'process' method.</span>
<a href="#l73.514"></a><span id="l73.514" class="difflineplus">+   * @param aAttrDef.extensionName The name of the extension providing these</span>
<a href="#l73.515"></a><span id="l73.515" class="difflineplus">+   *     attributes.</span>
<a href="#l73.516"></a><span id="l73.516" class="difflineplus">+   * @param aAttrDef.attributeType The type of attribute, one of the values from</span>
<a href="#l73.517"></a><span id="l73.517" class="difflineplus">+   *     the kAttr* enumeration.</span>
<a href="#l73.518"></a><span id="l73.518" class="difflineplus">+   * @param aAttrDef.attributeName The name of the attribute, which also doubles</span>
<a href="#l73.519"></a><span id="l73.519" class="difflineplus">+   *     as the bound property name if you pass 'bind' a value of true.  You are</span>
<a href="#l73.520"></a><span id="l73.520">    *     responsible for avoiding collisions, which presumably will mean</span>
<a href="#l73.521"></a><span id="l73.521">    *     checking/updating a wiki page in the future, or just prefixing your</span>
<a href="#l73.522"></a><span id="l73.522">    *     attribute name with your extension name or something like that.</span>
<a href="#l73.523"></a><span id="l73.523" class="difflineminus">-   * @param bind Should this attribute be 'bound' as a convenience attribute</span>
<a href="#l73.524"></a><span id="l73.524" class="difflineminus">-   *     on the subject's object (true/false)?  For example, with an</span>
<a href="#l73.525"></a><span id="l73.525" class="difflineplus">+   * @param aAttrDef.bind Should this attribute be 'bound' as a convenience</span>
<a href="#l73.526"></a><span id="l73.526" class="difflineplus">+   *     attribute on the subject's object (true/false)?  For example, with an</span>
<a href="#l73.527"></a><span id="l73.527">    *     attributeName of &quot;foo&quot; and passing true for 'bind' with a subject noun</span>
<a href="#l73.528"></a><span id="l73.528" class="difflineminus">-   *     of NOUN_MESSAGE, GlodaMessage instances will expose a &quot;foo&quot; getter</span>
<a href="#l73.529"></a><span id="l73.529" class="difflineminus">-   *     that returns the value of the attribute.  If 'singular' is true, this</span>
<a href="#l73.530"></a><span id="l73.530" class="difflineminus">-   *     means an instance of the object class corresponding to the noun type or</span>
<a href="#l73.531"></a><span id="l73.531" class="difflineminus">-   *     null if the attribute does not exist.  If 'singular' is false, this</span>
<a href="#l73.532"></a><span id="l73.532" class="difflineminus">-   *     means a list of instances of the object class corresponding to the noun</span>
<a href="#l73.533"></a><span id="l73.533" class="difflineminus">-   *     type, where the list may be empty if no instances of the attribute are</span>
<a href="#l73.534"></a><span id="l73.534" class="difflineplus">+   *     of NOUN_MESSAGE, GlodaMessage instances will expose a &quot;foo&quot; getter that</span>
<a href="#l73.535"></a><span id="l73.535" class="difflineplus">+   *     returns the value of the attribute.  If 'singular' is true, this means</span>
<a href="#l73.536"></a><span id="l73.536" class="difflineplus">+   *     an instance of the object class corresponding to the noun type or null</span>
<a href="#l73.537"></a><span id="l73.537" class="difflineplus">+   *     if the attribute does not exist.  If 'singular' is false, this means a</span>
<a href="#l73.538"></a><span id="l73.538" class="difflineplus">+   *     list of instances of the object class corresponding to the noun type,</span>
<a href="#l73.539"></a><span id="l73.539" class="difflineplus">+   *     where the list may be empty if no instances of the attribute are</span>
<a href="#l73.540"></a><span id="l73.540">    *     present.</span>
<a href="#l73.541"></a><span id="l73.541" class="difflineminus">-   * @param bindName Optional override of attributeName for purposes of the</span>
<a href="#l73.542"></a><span id="l73.542" class="difflineminus">-   *     binding property's name.</span>
<a href="#l73.543"></a><span id="l73.543" class="difflineminus">-   * @param singular Is the attribute going to happen at most once (true),</span>
<a href="#l73.544"></a><span id="l73.544" class="difflineminus">-   *     or potentially multiple times (false).  This affects whether</span>
<a href="#l73.545"></a><span id="l73.545" class="difflineminus">-   *     the binding  returns a list or just a single item (which is null when</span>
<a href="#l73.546"></a><span id="l73.546" class="difflineplus">+   * @param aAttrDef.bindName Optional override of attributeName for purposes of</span>
<a href="#l73.547"></a><span id="l73.547" class="difflineplus">+   *     the binding property's name.</span>
<a href="#l73.548"></a><span id="l73.548" class="difflineplus">+   * @param aAttrDef.singular Is the attribute going to happen at most once</span>
<a href="#l73.549"></a><span id="l73.549" class="difflineplus">+   *     (true), or potentially multiple times (false).  This affects whether</span>
<a href="#l73.550"></a><span id="l73.550" class="difflineplus">+   *     the binding returns a list or just a single item (which is null when</span>
<a href="#l73.551"></a><span id="l73.551">    *     the attribute is not present).</span>
<a href="#l73.552"></a><span id="l73.552" class="difflineminus">-   * @param subjectNouns A list of object types (NOUNs) that this attribute can</span>
<a href="#l73.553"></a><span id="l73.553" class="difflineminus">-   *     be set on.  Each element in the list should be one of the NOUN_*</span>
<a href="#l73.554"></a><span id="l73.554" class="difflineminus">-   *     constants or a dynamically registered noun type.</span>
<a href="#l73.555"></a><span id="l73.555" class="difflineminus">-   * @param objectNoun The object type (one of the NOUN_* constants or a</span>
<a href="#l73.556"></a><span id="l73.556" class="difflineminus">-   *     dynamically registered noun types) that is the 'object' in the</span>
<a href="#l73.557"></a><span id="l73.557" class="difflineplus">+   * @param aAttrDef.subjectNouns A list of object types (NOUNs) that this</span>
<a href="#l73.558"></a><span id="l73.558" class="difflineplus">+   *     attribute can be set on.  Each element in the list should be one of the</span>
<a href="#l73.559"></a><span id="l73.559" class="difflineplus">+   *     NOUN_* constants or a dynamically registered noun type.</span>
<a href="#l73.560"></a><span id="l73.560" class="difflineplus">+   * @param aAttrDef.objectNoun The object type (one of the NOUN_* constants or</span>
<a href="#l73.561"></a><span id="l73.561" class="difflineplus">+   *     a dynamically registered noun types) that is the 'object' in the</span>
<a href="#l73.562"></a><span id="l73.562">    *     traditional RDF triple.  More pragmatically, in the database row used</span>
<a href="#l73.563"></a><span id="l73.563">    *     to represent an attribute, we store the subject (ex: message ID),</span>
<a href="#l73.564"></a><span id="l73.564">    *     attribute ID, and an integer which is the integer representation of the</span>
<a href="#l73.565"></a><span id="l73.565">    *     'object' whose type you are defining right here.</span>
<a href="#l73.566"></a><span id="l73.566">    */</span>
<a href="#l73.567"></a><span id="l73.567">   defineAttribute: function gloda_ns_defineAttribute(aAttrDef) {</span>
<a href="#l73.568"></a><span id="l73.568">     // ensure required properties exist on aAttrDef</span>
<a href="#l73.569"></a><span id="l73.569">     if (!(&quot;provider&quot; in aAttrDef) ||</span>
<a href="#l73.570"></a><span id="l73.570" class="difflineat">@@ -1419,16 +1612,17 @@ var Gloda = {</span>
<a href="#l73.571"></a><span id="l73.571">     // - first time we've seen a provider init logic</span>
<a href="#l73.572"></a><span id="l73.572">     if (!(aAttrDef.provider.providerName in this._attrProviders)) {</span>
<a href="#l73.573"></a><span id="l73.573">       this._attrProviders[aAttrDef.provider.providerName] = [];</span>
<a href="#l73.574"></a><span id="l73.574">       if (aAttrDef.provider.contentWhittle)</span>
<a href="#l73.575"></a><span id="l73.575">         whittlerRegistry.registerWhittler(aAttrDef.provider);</span>
<a href="#l73.576"></a><span id="l73.576">     }</span>
<a href="#l73.577"></a><span id="l73.577"> </span>
<a href="#l73.578"></a><span id="l73.578">     let compoundName = aAttrDef.extensionName + &quot;:&quot; + aAttrDef.attributeName;</span>
<a href="#l73.579"></a><span id="l73.579" class="difflineplus">+    // -- Database Definition</span>
<a href="#l73.580"></a><span id="l73.580">     let attrDBDef;</span>
<a href="#l73.581"></a><span id="l73.581">     if (compoundName in GlodaDatastore._attributeDBDefs) {</span>
<a href="#l73.582"></a><span id="l73.582">       // the existence of the GlodaAttributeDBDef means that either it has</span>
<a href="#l73.583"></a><span id="l73.583">       //  already been fully defined, or has been loaded from the database but</span>
<a href="#l73.584"></a><span id="l73.584">       //  not yet 'bound' to a provider (and had important meta-info that</span>
<a href="#l73.585"></a><span id="l73.585">       //  doesn't go in the db copied over)</span>
<a href="#l73.586"></a><span id="l73.586">       attrDBDef = GlodaDatastore._attributeDBDefs[compoundName];</span>
<a href="#l73.587"></a><span id="l73.587">     }</span>
<a href="#l73.588"></a><span id="l73.588" class="difflineat">@@ -1454,16 +1648,65 @@ var Gloda = {</span>
<a href="#l73.589"></a><span id="l73.589">     if (&quot;bindName&quot; in aAttrDef)</span>
<a href="#l73.590"></a><span id="l73.590">       aAttrDef.boundName = aAttrDef.bindName;</span>
<a href="#l73.591"></a><span id="l73.591">     else</span>
<a href="#l73.592"></a><span id="l73.592">       aAttrDef.boundName = aAttrDef.attributeName;</span>
<a href="#l73.593"></a><span id="l73.593"> </span>
<a href="#l73.594"></a><span id="l73.594">     aAttrDef.objectNounDef = this._nounIDToDef[aAttrDef.objectNoun];</span>
<a href="#l73.595"></a><span id="l73.595">     aAttrDef.objectNounDef.objectNounOfAttributes.push(aAttrDef);</span>
<a href="#l73.596"></a><span id="l73.596"> </span>
<a href="#l73.597"></a><span id="l73.597" class="difflineplus">+    // No facet attribute means no facet desired; set an explicit null so that</span>
<a href="#l73.598"></a><span id="l73.598" class="difflineplus">+    //  code can check without doing an &quot;in&quot; check.</span>
<a href="#l73.599"></a><span id="l73.599" class="difflineplus">+    if (!(&quot;facet&quot; in aAttrDef))</span>
<a href="#l73.600"></a><span id="l73.600" class="difflineplus">+      aAttrDef.facet = null;</span>
<a href="#l73.601"></a><span id="l73.601" class="difflineplus">+    // Promote &quot;true&quot; facet values to the defaults.  Where attributes have</span>
<a href="#l73.602"></a><span id="l73.602" class="difflineplus">+    //  specified values, make sure we fill in any missing defaults.</span>
<a href="#l73.603"></a><span id="l73.603" class="difflineplus">+    else {</span>
<a href="#l73.604"></a><span id="l73.604" class="difflineplus">+      if (aAttrDef.facet == true) {</span>
<a href="#l73.605"></a><span id="l73.605" class="difflineplus">+        aAttrDef.facet = {</span>
<a href="#l73.606"></a><span id="l73.606" class="difflineplus">+          type: &quot;default&quot;,</span>
<a href="#l73.607"></a><span id="l73.607" class="difflineplus">+          groupIdAttr: aAttrDef.objectNounDef.idAttr,</span>
<a href="#l73.608"></a><span id="l73.608" class="difflineplus">+          filter: null,</span>
<a href="#l73.609"></a><span id="l73.609" class="difflineplus">+        };</span>
<a href="#l73.610"></a><span id="l73.610" class="difflineplus">+      }</span>
<a href="#l73.611"></a><span id="l73.611" class="difflineplus">+      else {</span>
<a href="#l73.612"></a><span id="l73.612" class="difflineplus">+        if (!(&quot;groupIdAttr&quot; in aAttrDef.facet))</span>
<a href="#l73.613"></a><span id="l73.613" class="difflineplus">+          aAttrDef.facet.groupIdAttr = aAttrDef.objectNounDef.idAttr;</span>
<a href="#l73.614"></a><span id="l73.614" class="difflineplus">+        if (!(&quot;filter&quot; in aAttrDef.facet))</span>
<a href="#l73.615"></a><span id="l73.615" class="difflineplus">+          aAttrDef.facet.filter = null;</span>
<a href="#l73.616"></a><span id="l73.616" class="difflineplus">+      }</span>
<a href="#l73.617"></a><span id="l73.617" class="difflineplus">+    }</span>
<a href="#l73.618"></a><span id="l73.618" class="difflineplus">+</span>
<a href="#l73.619"></a><span id="l73.619" class="difflineplus">+    // -- L10n.</span>
<a href="#l73.620"></a><span id="l73.620" class="difflineplus">+    // If the provider has a string bundle, populate a &quot;strings&quot; attribute with</span>
<a href="#l73.621"></a><span id="l73.621" class="difflineplus">+    //  our standard attribute strings that can be UI exposed.</span>
<a href="#l73.622"></a><span id="l73.622" class="difflineplus">+    if (&quot;strings&quot; in aAttrDef.provider) {</span>
<a href="#l73.623"></a><span id="l73.623" class="difflineplus">+      let bundle = aAttrDef.provider.strings;</span>
<a href="#l73.624"></a><span id="l73.624" class="difflineplus">+      let attrStrings = aAttrDef.strings = {};</span>
<a href="#l73.625"></a><span id="l73.625" class="difflineplus">+      // we use the first subject the attribute applies to as the basis of</span>
<a href="#l73.626"></a><span id="l73.626" class="difflineplus">+      //  where to get the string from.  Mainly because we currently don't have</span>
<a href="#l73.627"></a><span id="l73.627" class="difflineplus">+      //  any attributes with multiple subjects nor a use-case where we expose</span>
<a href="#l73.628"></a><span id="l73.628" class="difflineplus">+      //  multiple noun types via the UI.  (Just messages right now.)</span>
<a href="#l73.629"></a><span id="l73.629" class="difflineplus">+      let canonicalSubject = this._nounIDToDef[aAttrDef.subjectNouns[0]];</span>
<a href="#l73.630"></a><span id="l73.630" class="difflineplus">+      let propRoot = &quot;gloda.&quot; + canonicalSubject.name + &quot;.attr.&quot; +</span>
<a href="#l73.631"></a><span id="l73.631" class="difflineplus">+                       aAttrDef.attributeName + &quot;.&quot;;</span>
<a href="#l73.632"></a><span id="l73.632" class="difflineplus">+      for each (let [propName, attrName] in</span>
<a href="#l73.633"></a><span id="l73.633" class="difflineplus">+                Iterator(this._ATTR_LOCALIZED_STRINGS)) {</span>
<a href="#l73.634"></a><span id="l73.634" class="difflineplus">+        try {</span>
<a href="#l73.635"></a><span id="l73.635" class="difflineplus">+          attrStrings[attrName] = bundle.get(propRoot + propName);</span>
<a href="#l73.636"></a><span id="l73.636" class="difflineplus">+        }</span>
<a href="#l73.637"></a><span id="l73.637" class="difflineplus">+        catch (ex) {</span>
<a href="#l73.638"></a><span id="l73.638" class="difflineplus">+          // do nothing.  nsIStringBundle throws exceptions because it is a</span>
<a href="#l73.639"></a><span id="l73.639" class="difflineplus">+          //  standard nsresult type of API and our helper buddy does nothing</span>
<a href="#l73.640"></a><span id="l73.640" class="difflineplus">+          //  to help us.  (StringBundle.js, that is.)</span>
<a href="#l73.641"></a><span id="l73.641" class="difflineplus">+        }</span>
<a href="#l73.642"></a><span id="l73.642" class="difflineplus">+      }</span>
<a href="#l73.643"></a><span id="l73.643" class="difflineplus">+    }</span>
<a href="#l73.644"></a><span id="l73.644" class="difflineplus">+</span>
<a href="#l73.645"></a><span id="l73.645" class="difflineplus">+    // -- Subject Noun Binding</span>
<a href="#l73.646"></a><span id="l73.646">     for (let iSubject = 0; iSubject &lt; aAttrDef.subjectNouns.length;</span>
<a href="#l73.647"></a><span id="l73.647">            iSubject++) {</span>
<a href="#l73.648"></a><span id="l73.648">       let subjectType = aAttrDef.subjectNouns[iSubject];</span>
<a href="#l73.649"></a><span id="l73.649">       let subjectNounDef = this._nounIDToDef[subjectType];</span>
<a href="#l73.650"></a><span id="l73.650">       this._bindAttribute(aAttrDef, subjectNounDef);</span>
<a href="#l73.651"></a><span id="l73.651"> </span>
<a href="#l73.652"></a><span id="l73.652">       // update the provider maps...</span>
<a href="#l73.653"></a><span id="l73.653">       if (this._attrProviderOrderByNoun[subjectType]</span>
<a href="#l73.654"></a><span id="l73.654" class="difflineat">@@ -1837,18 +2080,22 @@ var Gloda = {</span>
<a href="#l73.655"></a><span id="l73.655">    *</span>
<a href="#l73.656"></a><span id="l73.656">    * @param aItems The non-empty list of items to score.</span>
<a href="#l73.657"></a><span id="l73.657">    * @param aContext A noun-specific dictionary that we just pass to the funcs.</span>
<a href="#l73.658"></a><span id="l73.658">    * @param aExtraScoreFuncs A list of extra scoring functions to apply.</span>
<a href="#l73.659"></a><span id="l73.659">    * @returns A list of integer scores equal in length to aItems.</span>
<a href="#l73.660"></a><span id="l73.660">    */</span>
<a href="#l73.661"></a><span id="l73.661">   scoreNounItems: function gloda_ns_grokNounItem(aItems, aContext,</span>
<a href="#l73.662"></a><span id="l73.662">                                                  aExtraScoreFuncs) {</span>
<a href="#l73.663"></a><span id="l73.663" class="difflineplus">+    let scores = [];</span>
<a href="#l73.664"></a><span id="l73.664" class="difflineplus">+    // bail if there is nothing to score</span>
<a href="#l73.665"></a><span id="l73.665" class="difflineplus">+    if (!aItems.length)</span>
<a href="#l73.666"></a><span id="l73.666" class="difflineplus">+      return scores;</span>
<a href="#l73.667"></a><span id="l73.667" class="difflineplus">+</span>
<a href="#l73.668"></a><span id="l73.668">     let itemNounDef = aItems[0].NOUN_DEF;</span>
<a href="#l73.669"></a><span id="l73.669" class="difflineminus">-    let scores = [];</span>
<a href="#l73.670"></a><span id="l73.670">     if (aExtraScoreFuncs == null)</span>
<a href="#l73.671"></a><span id="l73.671">       aExtraScoreFuncs = [];</span>
<a href="#l73.672"></a><span id="l73.672"> </span>
<a href="#l73.673"></a><span id="l73.673">     for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l73.674"></a><span id="l73.674">       let score = 0;</span>
<a href="#l73.675"></a><span id="l73.675">       let attrProviders = this._attrProviderOrderByNoun[itemNounDef.id];</span>
<a href="#l73.676"></a><span id="l73.676">       for (let iProvider = 0; iProvider &lt; attrProviders.length; iProvider++) {</span>
<a href="#l73.677"></a><span id="l73.677">         let provider = attrProviders[iProvider];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/mailnews/db/gloda/modules/index_ab.js</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/index_ab.js</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l74.4"></a><span id="l74.4"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l74.5"></a><span id="l74.5">  *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l74.6"></a><span id="l74.6">  *</span>
<a href="#l74.7"></a><span id="l74.7">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l74.8"></a><span id="l74.8">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l74.9"></a><span id="l74.9">  * the License. You may obtain a copy of the License at</span>
<a href="#l74.10"></a><span id="l74.10">  * http://www.mozilla.org/MPL/</span>
<a href="#l74.11"></a><span id="l74.11" class="difflineminus">- * </span>
<a href="#l74.12"></a><span id="l74.12" class="difflineplus">+ *</span>
<a href="#l74.13"></a><span id="l74.13">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l74.14"></a><span id="l74.14">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l74.15"></a><span id="l74.15">  * for the specific language governing rights and limitations under the</span>
<a href="#l74.16"></a><span id="l74.16">  * License.</span>
<a href="#l74.17"></a><span id="l74.17">  *</span>
<a href="#l74.18"></a><span id="l74.18">  * The Original Code is Thunderbird Global Database.</span>
<a href="#l74.19"></a><span id="l74.19">  *</span>
<a href="#l74.20"></a><span id="l74.20">  * The Initial Developer of the Original Code is</span>
<a href="#l74.21"></a><span id="l74.21" class="difflineat">@@ -27,17 +27,17 @@</span>
<a href="#l74.22"></a><span id="l74.22">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l74.23"></a><span id="l74.23">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l74.24"></a><span id="l74.24">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l74.25"></a><span id="l74.25">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l74.26"></a><span id="l74.26">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l74.27"></a><span id="l74.27">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l74.28"></a><span id="l74.28">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l74.29"></a><span id="l74.29">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l74.30"></a><span id="l74.30" class="difflineminus">- * </span>
<a href="#l74.31"></a><span id="l74.31" class="difflineplus">+ *</span>
<a href="#l74.32"></a><span id="l74.32">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l74.33"></a><span id="l74.33"> </span>
<a href="#l74.34"></a><span id="l74.34"> EXPORTED_SYMBOLS = ['GlodaABIndexer', 'GlodaABAttrs'];</span>
<a href="#l74.35"></a><span id="l74.35"> </span>
<a href="#l74.36"></a><span id="l74.36"> const Cc = Components.classes;</span>
<a href="#l74.37"></a><span id="l74.37"> const Ci = Components.interfaces;</span>
<a href="#l74.38"></a><span id="l74.38"> const Cr = Components.results;</span>
<a href="#l74.39"></a><span id="l74.39"> const Cu = Components.utils;</span>
<a href="#l74.40"></a><span id="l74.40" class="difflineat">@@ -56,58 +56,59 @@ Cu.import(&quot;resource://app/modules/gloda/</span>
<a href="#l74.41"></a><span id="l74.41"> </span>
<a href="#l74.42"></a><span id="l74.42"> var GlodaABIndexer = {</span>
<a href="#l74.43"></a><span id="l74.43">   _log: null,</span>
<a href="#l74.44"></a><span id="l74.44"> </span>
<a href="#l74.45"></a><span id="l74.45">   name: &quot;ab_indexer&quot;,</span>
<a href="#l74.46"></a><span id="l74.46">   enable: function() {</span>
<a href="#l74.47"></a><span id="l74.47">     if (this._log == null)</span>
<a href="#l74.48"></a><span id="l74.48">       this._log =  Log4Moz.repository.getLogger(&quot;gloda.ab_indexer&quot;);</span>
<a href="#l74.49"></a><span id="l74.49" class="difflineminus">-  </span>
<a href="#l74.50"></a><span id="l74.50" class="difflineplus">+</span>
<a href="#l74.51"></a><span id="l74.51">     let abManager = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l74.52"></a><span id="l74.52">     abManager.addAddressBookListener(this, Ci.nsIAbListener.itemChanged);</span>
<a href="#l74.53"></a><span id="l74.53">   },</span>
<a href="#l74.54"></a><span id="l74.54" class="difflineminus">-  </span>
<a href="#l74.55"></a><span id="l74.55" class="difflineplus">+</span>
<a href="#l74.56"></a><span id="l74.56">   disable: function() {</span>
<a href="#l74.57"></a><span id="l74.57">     let abManager = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l74.58"></a><span id="l74.58">     abManager.removeAddressBookListener(this);</span>
<a href="#l74.59"></a><span id="l74.59">   },</span>
<a href="#l74.60"></a><span id="l74.60"> </span>
<a href="#l74.61"></a><span id="l74.61">   get workers() {</span>
<a href="#l74.62"></a><span id="l74.62">     return [[&quot;ab-card&quot;, this._worker_index_card]];</span>
<a href="#l74.63"></a><span id="l74.63">   },</span>
<a href="#l74.64"></a><span id="l74.64" class="difflineminus">-  </span>
<a href="#l74.65"></a><span id="l74.65" class="difflineplus">+</span>
<a href="#l74.66"></a><span id="l74.66">   _worker_index_card: function(aJob, aCallbackHandle) {</span>
<a href="#l74.67"></a><span id="l74.67">     let card = aJob.id;</span>
<a href="#l74.68"></a><span id="l74.68" class="difflineminus">-    </span>
<a href="#l74.69"></a><span id="l74.69" class="difflineplus">+</span>
<a href="#l74.70"></a><span id="l74.70">     if (card.primaryEmail) {</span>
<a href="#l74.71"></a><span id="l74.71">       // load the identity</span>
<a href="#l74.72"></a><span id="l74.72">       let query = Gloda.newQuery(Gloda.NOUN_IDENTITY);</span>
<a href="#l74.73"></a><span id="l74.73">       query.kind(&quot;email&quot;);</span>
<a href="#l74.74"></a><span id="l74.74" class="difflineminus">-      query.value(card.primaryEmail);</span>
<a href="#l74.75"></a><span id="l74.75" class="difflineplus">+      // we currently normalize all e-mail addresses to be lowercase</span>
<a href="#l74.76"></a><span id="l74.76" class="difflineplus">+      query.value(card.primaryEmail.toLowerCase());</span>
<a href="#l74.77"></a><span id="l74.77">       let identityCollection = query.getCollection(aCallbackHandle);</span>
<a href="#l74.78"></a><span id="l74.78">       yield Gloda.kWorkAsync;</span>
<a href="#l74.79"></a><span id="l74.79" class="difflineminus">-      </span>
<a href="#l74.80"></a><span id="l74.80" class="difflineplus">+</span>
<a href="#l74.81"></a><span id="l74.81">       if (identityCollection.items.length) {</span>
<a href="#l74.82"></a><span id="l74.82">         let identity = identityCollection.items[0];</span>
<a href="#l74.83"></a><span id="l74.83" class="difflineminus">-  </span>
<a href="#l74.84"></a><span id="l74.84" class="difflineplus">+</span>
<a href="#l74.85"></a><span id="l74.85">         this._log.debug(&quot;Found identity, processing card.&quot;);</span>
<a href="#l74.86"></a><span id="l74.86">         yield aCallbackHandle.pushAndGo(</span>
<a href="#l74.87"></a><span id="l74.87">             Gloda.grokNounItem(identity.contact, card, false, false,</span>
<a href="#l74.88"></a><span id="l74.88">                                aCallbackHandle));</span>
<a href="#l74.89"></a><span id="l74.89">         this._log.debug(&quot;Done processing card.&quot;);</span>
<a href="#l74.90"></a><span id="l74.90">       }</span>
<a href="#l74.91"></a><span id="l74.91">     }</span>
<a href="#l74.92"></a><span id="l74.92" class="difflineminus">-    </span>
<a href="#l74.93"></a><span id="l74.93" class="difflineplus">+</span>
<a href="#l74.94"></a><span id="l74.94">     yield GlodaIndexer.kWorkDone;</span>
<a href="#l74.95"></a><span id="l74.95">   },</span>
<a href="#l74.96"></a><span id="l74.96" class="difflineminus">-  </span>
<a href="#l74.97"></a><span id="l74.97" class="difflineplus">+</span>
<a href="#l74.98"></a><span id="l74.98">   initialSweep: function() {</span>
<a href="#l74.99"></a><span id="l74.99">   },</span>
<a href="#l74.100"></a><span id="l74.100" class="difflineminus">-  </span>
<a href="#l74.101"></a><span id="l74.101" class="difflineplus">+</span>
<a href="#l74.102"></a><span id="l74.102">   /* ------ nsIAbListener ------ */</span>
<a href="#l74.103"></a><span id="l74.103">   onItemAdded: function ab_indexer_onItemAdded(aParentDir, aItem) {</span>
<a href="#l74.104"></a><span id="l74.104">   },</span>
<a href="#l74.105"></a><span id="l74.105">   onItemRemoved: function ab_indexer_onItemRemoved(aParentDir, aItem) {</span>
<a href="#l74.106"></a><span id="l74.106">   },</span>
<a href="#l74.107"></a><span id="l74.107">   onItemPropertyChanged: function ab_indexer_onItemPropertyChanged(aItem,</span>
<a href="#l74.108"></a><span id="l74.108">       aProperty, aOldValue, aNewValue) {</span>
<a href="#l74.109"></a><span id="l74.109">     if (aProperty == null &amp;&amp; aItem instanceof Ci.nsIAbCard) {</span>
<a href="#l74.110"></a><span id="l74.110" class="difflineat">@@ -122,26 +123,26 @@ var GlodaABIndexer = {</span>
<a href="#l74.111"></a><span id="l74.111"> GlodaIndexer.registerIndexer(GlodaABIndexer);</span>
<a href="#l74.112"></a><span id="l74.112"> </span>
<a href="#l74.113"></a><span id="l74.113"> var GlodaABAttrs = {</span>
<a href="#l74.114"></a><span id="l74.114">   providerName: &quot;gloda.ab_attr&quot;,</span>
<a href="#l74.115"></a><span id="l74.115">   _log: null,</span>
<a href="#l74.116"></a><span id="l74.116"> </span>
<a href="#l74.117"></a><span id="l74.117">   init: function() {</span>
<a href="#l74.118"></a><span id="l74.118">     this._log =  Log4Moz.repository.getLogger(&quot;gloda.abattrs&quot;);</span>
<a href="#l74.119"></a><span id="l74.119" class="difflineminus">-    </span>
<a href="#l74.120"></a><span id="l74.120" class="difflineplus">+</span>
<a href="#l74.121"></a><span id="l74.121">     try {</span>
<a href="#l74.122"></a><span id="l74.122">       this.defineAttributes();</span>
<a href="#l74.123"></a><span id="l74.123">     }</span>
<a href="#l74.124"></a><span id="l74.124">     catch (ex) {</span>
<a href="#l74.125"></a><span id="l74.125">       this._log.error(&quot;Error in init: &quot; + ex);</span>
<a href="#l74.126"></a><span id="l74.126">       throw ex;</span>
<a href="#l74.127"></a><span id="l74.127">     }</span>
<a href="#l74.128"></a><span id="l74.128">   },</span>
<a href="#l74.129"></a><span id="l74.129" class="difflineminus">-  </span>
<a href="#l74.130"></a><span id="l74.130" class="difflineplus">+</span>
<a href="#l74.131"></a><span id="l74.131">   defineAttributes: function() {</span>
<a href="#l74.132"></a><span id="l74.132">     /* ***** Contacts ***** */</span>
<a href="#l74.133"></a><span id="l74.133">     this._attrIdentityContact = Gloda.defineAttribute({</span>
<a href="#l74.134"></a><span id="l74.134">       provider: this,</span>
<a href="#l74.135"></a><span id="l74.135">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l74.136"></a><span id="l74.136">       attributeType: Gloda.kAttrDerived,</span>
<a href="#l74.137"></a><span id="l74.137">       attributeName: &quot;identities&quot;,</span>
<a href="#l74.138"></a><span id="l74.138">       singular: false,</span>
<a href="#l74.139"></a><span id="l74.139" class="difflineat">@@ -190,17 +191,17 @@ var GlodaABAttrs = {</span>
<a href="#l74.140"></a><span id="l74.140">       provider: this,</span>
<a href="#l74.141"></a><span id="l74.141">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l74.142"></a><span id="l74.142">       attributeType: Gloda.kAttrDerived,</span>
<a href="#l74.143"></a><span id="l74.143">       attributeName: &quot;contact&quot;,</span>
<a href="#l74.144"></a><span id="l74.144">       singular: true,</span>
<a href="#l74.145"></a><span id="l74.145">       special: Gloda.kSpecialColumnParent,</span>
<a href="#l74.146"></a><span id="l74.146">       specialColumnName: &quot;contactID&quot;, // the column in the db</span>
<a href="#l74.147"></a><span id="l74.147">       idStorageAttributeName: &quot;_contactID&quot;,</span>
<a href="#l74.148"></a><span id="l74.148" class="difflineminus">-      valueStorageAttributeName: &quot;_contact&quot;, </span>
<a href="#l74.149"></a><span id="l74.149" class="difflineplus">+      valueStorageAttributeName: &quot;_contact&quot;,</span>
<a href="#l74.150"></a><span id="l74.150">       subjectNouns: [Gloda.NOUN_IDENTITY],</span>
<a href="#l74.151"></a><span id="l74.151">       objectNoun: Gloda.NOUN_CONTACT,</span>
<a href="#l74.152"></a><span id="l74.152">       }); // tested-by: test_attributes_fundamental</span>
<a href="#l74.153"></a><span id="l74.153">     this._attrIdentityKind = Gloda.defineAttribute({</span>
<a href="#l74.154"></a><span id="l74.154">       provider: this,</span>
<a href="#l74.155"></a><span id="l74.155">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l74.156"></a><span id="l74.156">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l74.157"></a><span id="l74.157">       attributeName: &quot;kind&quot;,</span>
<a href="#l74.158"></a><span id="l74.158" class="difflineat">@@ -240,39 +241,39 @@ var GlodaABAttrs = {</span>
<a href="#l74.159"></a><span id="l74.159">                         }); // not-tested</span>
<a href="#l74.160"></a><span id="l74.160">     // we need to find any existing bound freetag attributes, and use them to</span>
<a href="#l74.161"></a><span id="l74.161">     //  populate to FreeTagNoun's understanding</span>
<a href="#l74.162"></a><span id="l74.162">     for (let freeTagName in this._attrFreeTag.parameterBindings) {</span>
<a href="#l74.163"></a><span id="l74.163">       this._log.debug(&quot;Telling FreeTagNoun about: &quot; + freeTagName);</span>
<a href="#l74.164"></a><span id="l74.164">       FreeTagNoun.getFreeTag(freeTagName);</span>
<a href="#l74.165"></a><span id="l74.165">     }</span>
<a href="#l74.166"></a><span id="l74.166">   },</span>
<a href="#l74.167"></a><span id="l74.167" class="difflineminus">-  </span>
<a href="#l74.168"></a><span id="l74.168" class="difflineplus">+</span>
<a href="#l74.169"></a><span id="l74.169">   process: function(aContact, aCard, aIsNew, aCallbackHandle) {</span>
<a href="#l74.170"></a><span id="l74.170">     if (aContact.NOUN_ID != Gloda.NOUN_CONTACT) {</span>
<a href="#l74.171"></a><span id="l74.171">       this._log.warning(&quot;Somehow got a non-contact: &quot; + aContact);</span>
<a href="#l74.172"></a><span id="l74.172">       return; // this will produce an exception; we like.</span>
<a href="#l74.173"></a><span id="l74.173">     }</span>
<a href="#l74.174"></a><span id="l74.174" class="difflineminus">-    </span>
<a href="#l74.175"></a><span id="l74.175" class="difflineplus">+</span>
<a href="#l74.176"></a><span id="l74.176">     // update the name</span>
<a href="#l74.177"></a><span id="l74.177">     if (aCard.displayName &amp;&amp; aCard.displayName != aContact.name)</span>
<a href="#l74.178"></a><span id="l74.178">       aContact.name = aCard.displayName;</span>
<a href="#l74.179"></a><span id="l74.179" class="difflineminus">-  </span>
<a href="#l74.180"></a><span id="l74.180" class="difflineplus">+</span>
<a href="#l74.181"></a><span id="l74.181">     aContact.freeTags = [];</span>
<a href="#l74.182"></a><span id="l74.182" class="difflineminus">-    </span>
<a href="#l74.183"></a><span id="l74.183" class="difflineplus">+</span>
<a href="#l74.184"></a><span id="l74.184">     let tags = null;</span>
<a href="#l74.185"></a><span id="l74.185">     try {</span>
<a href="#l74.186"></a><span id="l74.186">       tags = aCard.getProperty(&quot;Categories&quot;, null);</span>
<a href="#l74.187"></a><span id="l74.187">     } catch (ex) {</span>
<a href="#l74.188"></a><span id="l74.188">       this._log.error(&quot;Problem accessing property: &quot; + ex);</span>
<a href="#l74.189"></a><span id="l74.189">     }</span>
<a href="#l74.190"></a><span id="l74.190">     if (tags) {</span>
<a href="#l74.191"></a><span id="l74.191">       for each (let [iTagName, tagName] in Iterator(tags.split(&quot;,&quot;))) {</span>
<a href="#l74.192"></a><span id="l74.192">         tagName = tagName.trim();</span>
<a href="#l74.193"></a><span id="l74.193">         if (tagName) {</span>
<a href="#l74.194"></a><span id="l74.194">           aContact.freeTags.push(FreeTagNoun.getFreeTag(tagName));</span>
<a href="#l74.195"></a><span id="l74.195">         }</span>
<a href="#l74.196"></a><span id="l74.196">       }</span>
<a href="#l74.197"></a><span id="l74.197">     }</span>
<a href="#l74.198"></a><span id="l74.198" class="difflineminus">-    </span>
<a href="#l74.199"></a><span id="l74.199" class="difflineplus">+</span>
<a href="#l74.200"></a><span id="l74.200">     yield Gloda.kWorkDone;</span>
<a href="#l74.201"></a><span id="l74.201">   }</span>
<a href="#l74.202"></a><span id="l74.202"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1">new file mode 100644</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineminus">--- /dev/null</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineplus">+++ b/mailnews/db/gloda/modules/mimeTypeCategories.js</span>
<a href="#l76.4"></a><span id="l76.4" class="difflineat">@@ -0,0 +1,200 @@</span>
<a href="#l76.5"></a><span id="l76.5" class="difflineplus">+/*</span>
<a href="#l76.6"></a><span id="l76.6" class="difflineplus">+ * This file wants to be a data file of some sort.  It might do better as a real</span>
<a href="#l76.7"></a><span id="l76.7" class="difflineplus">+ *  raw JSON file.  It is trying to be one right now, but it obviously is not.</span>
<a href="#l76.8"></a><span id="l76.8" class="difflineplus">+ */</span>
<a href="#l76.9"></a><span id="l76.9" class="difflineplus">+</span>
<a href="#l76.10"></a><span id="l76.10" class="difflineplus">+let EXPORTED_SYMBOLS = ['MimeCategoryMapping'];</span>
<a href="#l76.11"></a><span id="l76.11" class="difflineplus">+</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineplus">+/**</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+ * Input data structure to allow us to build a fast mapping from mime type to</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineplus">+ *  category name.  The keys in MimeCategoryMapping are the top-level</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineplus">+ *  categories.  Each value can either be a list of MIME types or a nested</span>
<a href="#l76.16"></a><span id="l76.16" class="difflineplus">+ *  object which recursively defines sub-categories.  We currently do not use</span>
<a href="#l76.17"></a><span id="l76.17" class="difflineplus">+ *  the sub-categories.  They are just there to try and organize the MIME types</span>
<a href="#l76.18"></a><span id="l76.18" class="difflineplus">+ *  a little and open the door to future enhancements.</span>
<a href="#l76.19"></a><span id="l76.19" class="difflineplus">+ *</span>
<a href="#l76.20"></a><span id="l76.20" class="difflineplus">+ * Do _not_ add additional top-level categories unless you have added</span>
<a href="#l76.21"></a><span id="l76.21" class="difflineplus">+ *  corresponding entries to gloda.properties under the</span>
<a href="#l76.22"></a><span id="l76.22" class="difflineplus">+ *  &quot;gloda.mimetype.category&quot; branch and are making sure localizers are aware</span>
<a href="#l76.23"></a><span id="l76.23" class="difflineplus">+ *  of the change and have time to localize it.</span>
<a href="#l76.24"></a><span id="l76.24" class="difflineplus">+ *</span>
<a href="#l76.25"></a><span id="l76.25" class="difflineplus">+ * Entries with wildcards in them are part of a fallback strategy by the</span>
<a href="#l76.26"></a><span id="l76.26" class="difflineplus">+ *  |mimeTypeNoun| and do not actually use regular expressions or anything like</span>
<a href="#l76.27"></a><span id="l76.27" class="difflineplus">+ *  that.  Everything is a straight string lookup.  Given &quot;foo/bar&quot; we look for</span>
<a href="#l76.28"></a><span id="l76.28" class="difflineplus">+ *  &quot;foo/bar&quot;, then &quot;foo/*&quot;, and finally &quot;*&quot;.</span>
<a href="#l76.29"></a><span id="l76.29" class="difflineplus">+ */</span>
<a href="#l76.30"></a><span id="l76.30" class="difflineplus">+let MimeCategoryMapping = {</span>
<a href="#l76.31"></a><span id="l76.31" class="difflineplus">+  archives: [</span>
<a href="#l76.32"></a><span id="l76.32" class="difflineplus">+    &quot;application/java-archive&quot;,</span>
<a href="#l76.33"></a><span id="l76.33" class="difflineplus">+    &quot;application/x-java-archive&quot;,</span>
<a href="#l76.34"></a><span id="l76.34" class="difflineplus">+    &quot;application/x-jar&quot;,</span>
<a href="#l76.35"></a><span id="l76.35" class="difflineplus">+    &quot;application/x-java-jnlp-file&quot;,</span>
<a href="#l76.36"></a><span id="l76.36" class="difflineplus">+</span>
<a href="#l76.37"></a><span id="l76.37" class="difflineplus">+    &quot;application/mac-binhex40&quot;,</span>
<a href="#l76.38"></a><span id="l76.38" class="difflineplus">+    &quot;application/vnd.ms-cab-compressed&quot;,</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineplus">+</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineplus">+    &quot;application/x-arc&quot;,</span>
<a href="#l76.41"></a><span id="l76.41" class="difflineplus">+    &quot;application/x-arj&quot;,</span>
<a href="#l76.42"></a><span id="l76.42" class="difflineplus">+    &quot;application/x-compress&quot;,</span>
<a href="#l76.43"></a><span id="l76.43" class="difflineplus">+    &quot;application/x-compressed-tar&quot;,</span>
<a href="#l76.44"></a><span id="l76.44" class="difflineplus">+    &quot;application/x-cpio&quot;,</span>
<a href="#l76.45"></a><span id="l76.45" class="difflineplus">+    &quot;application/x-cpio-compressed&quot;,</span>
<a href="#l76.46"></a><span id="l76.46" class="difflineplus">+    &quot;application/x-deb&quot;,</span>
<a href="#l76.47"></a><span id="l76.47" class="difflineplus">+</span>
<a href="#l76.48"></a><span id="l76.48" class="difflineplus">+    &quot;application/x-bittorrent&quot;,</span>
<a href="#l76.49"></a><span id="l76.49" class="difflineplus">+</span>
<a href="#l76.50"></a><span id="l76.50" class="difflineplus">+    &quot;application/x-rar&quot;,</span>
<a href="#l76.51"></a><span id="l76.51" class="difflineplus">+    &quot;application/x-rar-compressed&quot;,</span>
<a href="#l76.52"></a><span id="l76.52" class="difflineplus">+    &quot;application/x-7z-compressed&quot;,</span>
<a href="#l76.53"></a><span id="l76.53" class="difflineplus">+    &quot;application/zip&quot;,</span>
<a href="#l76.54"></a><span id="l76.54" class="difflineplus">+    &quot;application/x-zip-compressed&quot;,</span>
<a href="#l76.55"></a><span id="l76.55" class="difflineplus">+    &quot;application/x-zip&quot;,</span>
<a href="#l76.56"></a><span id="l76.56" class="difflineplus">+</span>
<a href="#l76.57"></a><span id="l76.57" class="difflineplus">+    &quot;application/x-bzip&quot;,</span>
<a href="#l76.58"></a><span id="l76.58" class="difflineplus">+    &quot;application/x-bzip-compressed-tar&quot;,</span>
<a href="#l76.59"></a><span id="l76.59" class="difflineplus">+    &quot;application/x-bzip2&quot;,</span>
<a href="#l76.60"></a><span id="l76.60" class="difflineplus">+    &quot;application/x-gzip&quot;,</span>
<a href="#l76.61"></a><span id="l76.61" class="difflineplus">+    &quot;application/x-tar&quot;,</span>
<a href="#l76.62"></a><span id="l76.62" class="difflineplus">+    &quot;application/x-tar-gz&quot;,</span>
<a href="#l76.63"></a><span id="l76.63" class="difflineplus">+    &quot;application/x-tarz&quot;,</span>
<a href="#l76.64"></a><span id="l76.64" class="difflineplus">+  ],</span>
<a href="#l76.65"></a><span id="l76.65" class="difflineplus">+  documents: {</span>
<a href="#l76.66"></a><span id="l76.66" class="difflineplus">+    database: [</span>
<a href="#l76.67"></a><span id="l76.67" class="difflineplus">+      &quot;application/vnd.ms-access&quot;,</span>
<a href="#l76.68"></a><span id="l76.68" class="difflineplus">+      &quot;application/x-msaccess&quot;,</span>
<a href="#l76.69"></a><span id="l76.69" class="difflineplus">+      &quot;application/msaccess&quot;,</span>
<a href="#l76.70"></a><span id="l76.70" class="difflineplus">+      &quot;application/vnd.msaccess&quot;,</span>
<a href="#l76.71"></a><span id="l76.71" class="difflineplus">+      &quot;application/x-msaccess&quot;,</span>
<a href="#l76.72"></a><span id="l76.72" class="difflineplus">+      &quot;application/mdb&quot;,</span>
<a href="#l76.73"></a><span id="l76.73" class="difflineplus">+      &quot;application/x-mdb&quot;,</span>
<a href="#l76.74"></a><span id="l76.74" class="difflineplus">+</span>
<a href="#l76.75"></a><span id="l76.75" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.database&quot;,</span>
<a href="#l76.76"></a><span id="l76.76" class="difflineplus">+</span>
<a href="#l76.77"></a><span id="l76.77" class="difflineplus">+    ],</span>
<a href="#l76.78"></a><span id="l76.78" class="difflineplus">+    graphics: [</span>
<a href="#l76.79"></a><span id="l76.79" class="difflineplus">+      &quot;application/postscript&quot;,</span>
<a href="#l76.80"></a><span id="l76.80" class="difflineplus">+      &quot;application/x-bzpostscript&quot;,</span>
<a href="#l76.81"></a><span id="l76.81" class="difflineplus">+      &quot;application/x-dvi&quot;,</span>
<a href="#l76.82"></a><span id="l76.82" class="difflineplus">+      &quot;application/x-gzdvi&quot;,</span>
<a href="#l76.83"></a><span id="l76.83" class="difflineplus">+</span>
<a href="#l76.84"></a><span id="l76.84" class="difflineplus">+      &quot;application/illustrator&quot;,</span>
<a href="#l76.85"></a><span id="l76.85" class="difflineplus">+</span>
<a href="#l76.86"></a><span id="l76.86" class="difflineplus">+      &quot;application/vnd.corel-draw&quot;,</span>
<a href="#l76.87"></a><span id="l76.87" class="difflineplus">+      &quot;application/cdr&quot;,</span>
<a href="#l76.88"></a><span id="l76.88" class="difflineplus">+      &quot;application/coreldraw&quot;,</span>
<a href="#l76.89"></a><span id="l76.89" class="difflineplus">+      &quot;application/x-cdr&quot;,</span>
<a href="#l76.90"></a><span id="l76.90" class="difflineplus">+      &quot;application/x-coreldraw&quot;,</span>
<a href="#l76.91"></a><span id="l76.91" class="difflineplus">+      &quot;image/cdr&quot;,</span>
<a href="#l76.92"></a><span id="l76.92" class="difflineplus">+      &quot;image/x-cdr&quot;,</span>
<a href="#l76.93"></a><span id="l76.93" class="difflineplus">+      &quot;zz-application/zz-winassoc-cdr&quot;,</span>
<a href="#l76.94"></a><span id="l76.94" class="difflineplus">+</span>
<a href="#l76.95"></a><span id="l76.95" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.graphics&quot;,</span>
<a href="#l76.96"></a><span id="l76.96" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.graphics-template&quot;,</span>
<a href="#l76.97"></a><span id="l76.97" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.image&quot;,</span>
<a href="#l76.98"></a><span id="l76.98" class="difflineplus">+</span>
<a href="#l76.99"></a><span id="l76.99" class="difflineplus">+      &quot;application/x-dia-diagram&quot;,</span>
<a href="#l76.100"></a><span id="l76.100" class="difflineplus">+    ],</span>
<a href="#l76.101"></a><span id="l76.101" class="difflineplus">+    presentation: [</span>
<a href="#l76.102"></a><span id="l76.102" class="difflineplus">+      &quot;application/vnd.ms-powerpoint.presentation.macroenabled.12&quot;,</span>
<a href="#l76.103"></a><span id="l76.103" class="difflineplus">+      &quot;application/vnd.ms-powerpoint.template.macroenabled.12&quot;,</span>
<a href="#l76.104"></a><span id="l76.104" class="difflineplus">+      &quot;application/vnd.ms-powerpoint&quot;,</span>
<a href="#l76.105"></a><span id="l76.105" class="difflineplus">+      &quot;application/powerpoint&quot;,</span>
<a href="#l76.106"></a><span id="l76.106" class="difflineplus">+      &quot;application/mspowerpoint&quot;,</span>
<a href="#l76.107"></a><span id="l76.107" class="difflineplus">+      &quot;application/x-mspowerpoint&quot;,</span>
<a href="#l76.108"></a><span id="l76.108" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.presentationml.presentation&quot;,</span>
<a href="#l76.109"></a><span id="l76.109" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.presentationml.template&quot;,</span>
<a href="#l76.110"></a><span id="l76.110" class="difflineplus">+</span>
<a href="#l76.111"></a><span id="l76.111" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.presentation&quot;,</span>
<a href="#l76.112"></a><span id="l76.112" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.presentation-template&quot;</span>
<a href="#l76.113"></a><span id="l76.113" class="difflineplus">+    ],</span>
<a href="#l76.114"></a><span id="l76.114" class="difflineplus">+    spreadsheet: [</span>
<a href="#l76.115"></a><span id="l76.115" class="difflineplus">+      &quot;application/vnd.lotus-1-2-3&quot;,</span>
<a href="#l76.116"></a><span id="l76.116" class="difflineplus">+      &quot;application/x-lotus123&quot;,</span>
<a href="#l76.117"></a><span id="l76.117" class="difflineplus">+      &quot;application/x-123&quot;,</span>
<a href="#l76.118"></a><span id="l76.118" class="difflineplus">+      &quot;application/lotus123&quot;,</span>
<a href="#l76.119"></a><span id="l76.119" class="difflineplus">+      &quot;application/wk1&quot;,</span>
<a href="#l76.120"></a><span id="l76.120" class="difflineplus">+</span>
<a href="#l76.121"></a><span id="l76.121" class="difflineplus">+      &quot;application/x-quattropro&quot;,</span>
<a href="#l76.122"></a><span id="l76.122" class="difflineplus">+</span>
<a href="#l76.123"></a><span id="l76.123" class="difflineplus">+      &quot;application/vnd.ms-excel.sheet.binary.macroenabled.12&quot;,</span>
<a href="#l76.124"></a><span id="l76.124" class="difflineplus">+      &quot;application/vnd.ms-excel.sheet.macroenabled.12&quot;,</span>
<a href="#l76.125"></a><span id="l76.125" class="difflineplus">+      &quot;application/vnd.ms-excel.template.macroenabled.12&quot;,</span>
<a href="#l76.126"></a><span id="l76.126" class="difflineplus">+      &quot;application/vnd.ms-excel&quot;,</span>
<a href="#l76.127"></a><span id="l76.127" class="difflineplus">+      &quot;application/msexcel&quot;,</span>
<a href="#l76.128"></a><span id="l76.128" class="difflineplus">+      &quot;application/x-msexcel&quot;,</span>
<a href="#l76.129"></a><span id="l76.129" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;,</span>
<a href="#l76.130"></a><span id="l76.130" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.spreadsheetml.template&quot;,</span>
<a href="#l76.131"></a><span id="l76.131" class="difflineplus">+</span>
<a href="#l76.132"></a><span id="l76.132" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.formula&quot;,</span>
<a href="#l76.133"></a><span id="l76.133" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.formula-template&quot;,</span>
<a href="#l76.134"></a><span id="l76.134" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.chart&quot;,</span>
<a href="#l76.135"></a><span id="l76.135" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.chart-template&quot;,</span>
<a href="#l76.136"></a><span id="l76.136" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.spreadsheet&quot;,</span>
<a href="#l76.137"></a><span id="l76.137" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.spreadsheet-template&quot;,</span>
<a href="#l76.138"></a><span id="l76.138" class="difflineplus">+</span>
<a href="#l76.139"></a><span id="l76.139" class="difflineplus">+      &quot;application/x-gnumeric&quot;,</span>
<a href="#l76.140"></a><span id="l76.140" class="difflineplus">+    ],</span>
<a href="#l76.141"></a><span id="l76.141" class="difflineplus">+    wordProcessor: [</span>
<a href="#l76.142"></a><span id="l76.142" class="difflineplus">+      &quot;application/msword&quot;,</span>
<a href="#l76.143"></a><span id="l76.143" class="difflineplus">+      &quot;application/vnd.ms-word&quot;,</span>
<a href="#l76.144"></a><span id="l76.144" class="difflineplus">+      &quot;application/x-msword&quot;,</span>
<a href="#l76.145"></a><span id="l76.145" class="difflineplus">+      &quot;application/msword-template&quot;,</span>
<a href="#l76.146"></a><span id="l76.146" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;,</span>
<a href="#l76.147"></a><span id="l76.147" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.wordprocessingml.template&quot;,</span>
<a href="#l76.148"></a><span id="l76.148" class="difflineplus">+      &quot;application/vnd.ms-word.document.macroenabled.12&quot;,</span>
<a href="#l76.149"></a><span id="l76.149" class="difflineplus">+      &quot;application/vnd.ms-word.template.macroenabled.12&quot;,</span>
<a href="#l76.150"></a><span id="l76.150" class="difflineplus">+      &quot;application/x-mswrite&quot;,</span>
<a href="#l76.151"></a><span id="l76.151" class="difflineplus">+      &quot;application/x-pocket-word&quot;,</span>
<a href="#l76.152"></a><span id="l76.152" class="difflineplus">+</span>
<a href="#l76.153"></a><span id="l76.153" class="difflineplus">+      &quot;application/rtf&quot;,</span>
<a href="#l76.154"></a><span id="l76.154" class="difflineplus">+      &quot;text/rtf&quot;,</span>
<a href="#l76.155"></a><span id="l76.155" class="difflineplus">+</span>
<a href="#l76.156"></a><span id="l76.156" class="difflineplus">+</span>
<a href="#l76.157"></a><span id="l76.157" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.text&quot;,</span>
<a href="#l76.158"></a><span id="l76.158" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.text-master&quot;,</span>
<a href="#l76.159"></a><span id="l76.159" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.text-template&quot;,</span>
<a href="#l76.160"></a><span id="l76.160" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.text-web&quot;,</span>
<a href="#l76.161"></a><span id="l76.161" class="difflineplus">+</span>
<a href="#l76.162"></a><span id="l76.162" class="difflineplus">+      &quot;application/vnd.wordperfect&quot;,</span>
<a href="#l76.163"></a><span id="l76.163" class="difflineplus">+</span>
<a href="#l76.164"></a><span id="l76.164" class="difflineplus">+      &quot;application/x-abiword&quot;,</span>
<a href="#l76.165"></a><span id="l76.165" class="difflineplus">+      &quot;application/x-amipro&quot;,</span>
<a href="#l76.166"></a><span id="l76.166" class="difflineplus">+    ],</span>
<a href="#l76.167"></a><span id="l76.167" class="difflineplus">+    suite: [</span>
<a href="#l76.168"></a><span id="l76.168" class="difflineplus">+      &quot;application/vnd.ms-works&quot;</span>
<a href="#l76.169"></a><span id="l76.169" class="difflineplus">+    ],</span>
<a href="#l76.170"></a><span id="l76.170" class="difflineplus">+  },</span>
<a href="#l76.171"></a><span id="l76.171" class="difflineplus">+  images: [</span>
<a href="#l76.172"></a><span id="l76.172" class="difflineplus">+    &quot;image/*&quot;</span>
<a href="#l76.173"></a><span id="l76.173" class="difflineplus">+  ],</span>
<a href="#l76.174"></a><span id="l76.174" class="difflineplus">+  media: {</span>
<a href="#l76.175"></a><span id="l76.175" class="difflineplus">+    audio: [</span>
<a href="#l76.176"></a><span id="l76.176" class="difflineplus">+      &quot;audio/*&quot;,</span>
<a href="#l76.177"></a><span id="l76.177" class="difflineplus">+    ],</span>
<a href="#l76.178"></a><span id="l76.178" class="difflineplus">+    video: [</span>
<a href="#l76.179"></a><span id="l76.179" class="difflineplus">+      &quot;video/*&quot;,</span>
<a href="#l76.180"></a><span id="l76.180" class="difflineplus">+    ],</span>
<a href="#l76.181"></a><span id="l76.181" class="difflineplus">+    container: [</span>
<a href="#l76.182"></a><span id="l76.182" class="difflineplus">+      &quot;application/ogg&quot;,</span>
<a href="#l76.183"></a><span id="l76.183" class="difflineplus">+</span>
<a href="#l76.184"></a><span id="l76.184" class="difflineplus">+      &quot;application/smil&quot;,</span>
<a href="#l76.185"></a><span id="l76.185" class="difflineplus">+      &quot;application/vnd.ms-asf&quot;,</span>
<a href="#l76.186"></a><span id="l76.186" class="difflineplus">+      &quot;application/vnd.rn-realmedia&quot;,</span>
<a href="#l76.187"></a><span id="l76.187" class="difflineplus">+      &quot;application/x-matroska&quot;,</span>
<a href="#l76.188"></a><span id="l76.188" class="difflineplus">+      &quot;application/x-quicktime-media-link&quot;,</span>
<a href="#l76.189"></a><span id="l76.189" class="difflineplus">+      &quot;application/x-quicktimeplayer&quot;,</span>
<a href="#l76.190"></a><span id="l76.190" class="difflineplus">+    ]</span>
<a href="#l76.191"></a><span id="l76.191" class="difflineplus">+  },</span>
<a href="#l76.192"></a><span id="l76.192" class="difflineplus">+  other: [</span>
<a href="#l76.193"></a><span id="l76.193" class="difflineplus">+    &quot;*&quot;</span>
<a href="#l76.194"></a><span id="l76.194" class="difflineplus">+  ],</span>
<a href="#l76.195"></a><span id="l76.195" class="difflineplus">+  pdf: [</span>
<a href="#l76.196"></a><span id="l76.196" class="difflineplus">+    &quot;application/pdf&quot;,</span>
<a href="#l76.197"></a><span id="l76.197" class="difflineplus">+    &quot;application/x-pdf&quot;,</span>
<a href="#l76.198"></a><span id="l76.198" class="difflineplus">+    &quot;image/pdf&quot;,</span>
<a href="#l76.199"></a><span id="l76.199" class="difflineplus">+    &quot;file/pdf&quot;,</span>
<a href="#l76.200"></a><span id="l76.200" class="difflineplus">+</span>
<a href="#l76.201"></a><span id="l76.201" class="difflineplus">+    &quot;application/x-bzpdf&quot;,</span>
<a href="#l76.202"></a><span id="l76.202" class="difflineplus">+    &quot;application/x-gzpdf&quot;,</span>
<a href="#l76.203"></a><span id="l76.203" class="difflineplus">+  ],</span>
<a href="#l76.204"></a><span id="l76.204" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/mailnews/db/gloda/modules/msg_search.js</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/msg_search.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -83,17 +83,17 @@ const OFFSET_FUZZSCORE_SQL_SNIPPET =</span>
<a href="#l77.4"></a><span id="l77.4"> const FUZZSCORE_SQL_SNIPPET =</span>
<a href="#l77.5"></a><span id="l77.5">   &quot;(&quot; + OFFSET_FUZZSCORE_SQL_SNIPPET + &quot; + notability)&quot;;</span>
<a href="#l77.6"></a><span id="l77.6"> </span>
<a href="#l77.7"></a><span id="l77.7"> const DASCORE_SQL_SNIPPET =</span>
<a href="#l77.8"></a><span id="l77.8">   &quot;((&quot; + FUZZSCORE_SQL_SNIPPET + &quot; * &quot; + FUZZSCORE_TIMESTAMP_FACTOR +</span>
<a href="#l77.9"></a><span id="l77.9">     &quot;) + date)&quot;;</span>
<a href="#l77.10"></a><span id="l77.10"> </span>
<a href="#l77.11"></a><span id="l77.11"> const FULLTEXT_QUERY_EXPLICIT_SQL =</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-  &quot;SELECT messages.*, offsets(messagesText) AS osets &quot; +</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+  &quot;SELECT messages.*, messagesText.*, offsets(messagesText) AS osets &quot; +</span>
<a href="#l77.14"></a><span id="l77.14">     &quot;FROM messages, messagesText WHERE messagesText MATCH ?&quot; +</span>
<a href="#l77.15"></a><span id="l77.15">     &quot; AND messages.id == messagesText.docid&quot;;</span>
<a href="#l77.16"></a><span id="l77.16"> </span>
<a href="#l77.17"></a><span id="l77.17"> </span>
<a href="#l77.18"></a><span id="l77.18"> function identityFunc(x) {</span>
<a href="#l77.19"></a><span id="l77.19">   return x;</span>
<a href="#l77.20"></a><span id="l77.20"> }</span>
<a href="#l77.21"></a><span id="l77.21"> </span>
<a href="#l77.22"></a><span id="l77.22" class="difflineat">@@ -178,79 +178,139 @@ function scoreOffsets(aMessage, aContext</span>
<a href="#l77.23"></a><span id="l77.23">     score += Math.min(termIncidence.map(oneLessMaxZero).reduce(reduceSum, 0),</span>
<a href="#l77.24"></a><span id="l77.24">                       COLUMN_MULTIPLE_MATCH_LIMIT[iColumn]) *</span>
<a href="#l77.25"></a><span id="l77.25">              COLUMN_MULTIPLE_MATCH_SCORES[iColumn];</span>
<a href="#l77.26"></a><span id="l77.26">   }</span>
<a href="#l77.27"></a><span id="l77.27"> </span>
<a href="#l77.28"></a><span id="l77.28">   return score;</span>
<a href="#l77.29"></a><span id="l77.29"> }</span>
<a href="#l77.30"></a><span id="l77.30"> </span>
<a href="#l77.31"></a><span id="l77.31" class="difflineplus">+/**</span>
<a href="#l77.32"></a><span id="l77.32" class="difflineplus">+ * The searcher basically looks like a query, but is specialized for fulltext</span>
<a href="#l77.33"></a><span id="l77.33" class="difflineplus">+ *  search against messages.  Most of the explicit specialization involves</span>
<a href="#l77.34"></a><span id="l77.34" class="difflineplus">+ *  crafting a SQL query that attempts to order the matches by likelihood that</span>
<a href="#l77.35"></a><span id="l77.35" class="difflineplus">+ *  the user was looking for it.  This is based on full-text matches combined</span>
<a href="#l77.36"></a><span id="l77.36" class="difflineplus">+ *  with an explicit (generic) interest score value placed on the message at</span>
<a href="#l77.37"></a><span id="l77.37" class="difflineplus">+ *  indexing time.  This is followed by using the more generic gloda scoring</span>
<a href="#l77.38"></a><span id="l77.38" class="difflineplus">+ *  mechanism to explicitly score the messages given the search context in</span>
<a href="#l77.39"></a><span id="l77.39" class="difflineplus">+ *  addition to the more generic score adjusting rules.</span>
<a href="#l77.40"></a><span id="l77.40" class="difflineplus">+ */</span>
<a href="#l77.41"></a><span id="l77.41" class="difflineplus">+function GlodaMsgSearcher(aListener, aSearchString, aAndTerms) {</span>
<a href="#l77.42"></a><span id="l77.42" class="difflineplus">+  this.listener = aListener;</span>
<a href="#l77.43"></a><span id="l77.43"> </span>
<a href="#l77.44"></a><span id="l77.44" class="difflineminus">-function GlodaMsgSearcher(aViewWrapper, aFulltextTerms) {</span>
<a href="#l77.45"></a><span id="l77.45" class="difflineminus">-  this.viewWrapper = aViewWrapper;</span>
<a href="#l77.46"></a><span id="l77.46" class="difflineminus">-</span>
<a href="#l77.47"></a><span id="l77.47" class="difflineminus">-  this.fulltextTerms = aFulltextTerms;</span>
<a href="#l77.48"></a><span id="l77.48" class="difflineplus">+  this.searchString = aSearchString;</span>
<a href="#l77.49"></a><span id="l77.49" class="difflineplus">+  this.fulltextTerms = this.parseSearchString(aSearchString);</span>
<a href="#l77.50"></a><span id="l77.50" class="difflineplus">+  this.andTerms = (aAndTerms != null) ? aAndTerms : true;</span>
<a href="#l77.51"></a><span id="l77.51"> </span>
<a href="#l77.52"></a><span id="l77.52">   this.query = null;</span>
<a href="#l77.53"></a><span id="l77.53">   this.collection = null;</span>
<a href="#l77.54"></a><span id="l77.54"> </span>
<a href="#l77.55"></a><span id="l77.55" class="difflineminus">-  this.scoresByUriAndKey = {};</span>
<a href="#l77.56"></a><span id="l77.56" class="difflineminus">-  this.whysByUriAndKey = {};</span>
<a href="#l77.57"></a><span id="l77.57" class="difflineplus">+  this.scoresById = {};</span>
<a href="#l77.58"></a><span id="l77.58"> }</span>
<a href="#l77.59"></a><span id="l77.59"> GlodaMsgSearcher.prototype = {</span>
<a href="#l77.60"></a><span id="l77.60">   /**</span>
<a href="#l77.61"></a><span id="l77.61">    * Number of messages to retrieve initially.</span>
<a href="#l77.62"></a><span id="l77.62">    */</span>
<a href="#l77.63"></a><span id="l77.63" class="difflineminus">-  retrievalLimit: 100,</span>
<a href="#l77.64"></a><span id="l77.64" class="difflineplus">+  retrievalLimit: 400,</span>
<a href="#l77.65"></a><span id="l77.65" class="difflineplus">+</span>
<a href="#l77.66"></a><span id="l77.66" class="difflineplus">+  parseSearchString: function GlodaMsgSearcher_parseSearchString(aSearchString) {</span>
<a href="#l77.67"></a><span id="l77.67" class="difflineplus">+    aSearchString = aSearchString.trim();</span>
<a href="#l77.68"></a><span id="l77.68" class="difflineplus">+    let terms = [];</span>
<a href="#l77.69"></a><span id="l77.69" class="difflineplus">+    while (aSearchString) {</span>
<a href="#l77.70"></a><span id="l77.70" class="difflineplus">+      if (aSearchString[0] == '&quot;') {</span>
<a href="#l77.71"></a><span id="l77.71" class="difflineplus">+        let endIndex = aSearchString.indexOf(aSearchString[0], 1);</span>
<a href="#l77.72"></a><span id="l77.72" class="difflineplus">+        // eat the quote if it has no friend</span>
<a href="#l77.73"></a><span id="l77.73" class="difflineplus">+        if (endIndex == -1) {</span>
<a href="#l77.74"></a><span id="l77.74" class="difflineplus">+          aSearchString = aSearchString.substring(1);</span>
<a href="#l77.75"></a><span id="l77.75" class="difflineplus">+          continue;</span>
<a href="#l77.76"></a><span id="l77.76" class="difflineplus">+        }</span>
<a href="#l77.77"></a><span id="l77.77" class="difflineplus">+</span>
<a href="#l77.78"></a><span id="l77.78" class="difflineplus">+        terms.push(aSearchString.substring(1, endIndex).trim());</span>
<a href="#l77.79"></a><span id="l77.79" class="difflineplus">+        aSearchString = aSearchString.substring(endIndex + 1);</span>
<a href="#l77.80"></a><span id="l77.80" class="difflineplus">+        continue;</span>
<a href="#l77.81"></a><span id="l77.81" class="difflineplus">+      }</span>
<a href="#l77.82"></a><span id="l77.82" class="difflineplus">+</span>
<a href="#l77.83"></a><span id="l77.83" class="difflineplus">+      let spaceIndex = aSearchString.indexOf(&quot; &quot;);</span>
<a href="#l77.84"></a><span id="l77.84" class="difflineplus">+      if (spaceIndex == -1) {</span>
<a href="#l77.85"></a><span id="l77.85" class="difflineplus">+        terms.push(aSearchString);</span>
<a href="#l77.86"></a><span id="l77.86" class="difflineplus">+        break;</span>
<a href="#l77.87"></a><span id="l77.87" class="difflineplus">+      }</span>
<a href="#l77.88"></a><span id="l77.88" class="difflineplus">+</span>
<a href="#l77.89"></a><span id="l77.89" class="difflineplus">+      terms.push(aSearchString.substring(0, spaceIndex));</span>
<a href="#l77.90"></a><span id="l77.90" class="difflineplus">+      aSearchString = aSearchString.substring(spaceIndex+1);</span>
<a href="#l77.91"></a><span id="l77.91" class="difflineplus">+    }</span>
<a href="#l77.92"></a><span id="l77.92" class="difflineplus">+</span>
<a href="#l77.93"></a><span id="l77.93" class="difflineplus">+    return terms;</span>
<a href="#l77.94"></a><span id="l77.94" class="difflineplus">+  },</span>
<a href="#l77.95"></a><span id="l77.95"> </span>
<a href="#l77.96"></a><span id="l77.96">   buildFulltextQuery: function GlodaMsgSearcher_buildFulltextQuery() {</span>
<a href="#l77.97"></a><span id="l77.97">     let query = Gloda.newQuery(Gloda.NOUN_MESSAGE, {</span>
<a href="#l77.98"></a><span id="l77.98">       noMagic: true,</span>
<a href="#l77.99"></a><span id="l77.99">       explicitSQL: FULLTEXT_QUERY_EXPLICIT_SQL,</span>
<a href="#l77.100"></a><span id="l77.100" class="difflineminus">-      // osets is 0-based column number 9 (volatile to column changes)</span>
<a href="#l77.101"></a><span id="l77.101" class="difflineminus">-      // dascore becomes 0-based column number 10</span>
<a href="#l77.102"></a><span id="l77.102" class="difflineplus">+      // osets is 0-based column number 14 (volatile to column changes)</span>
<a href="#l77.103"></a><span id="l77.103" class="difflineplus">+      // dascore becomes 0-based column number 15</span>
<a href="#l77.104"></a><span id="l77.104">       outerWrapColumns: [DASCORE_SQL_SNIPPET + &quot; AS dascore&quot;],</span>
<a href="#l77.105"></a><span id="l77.105">       // save the offset column for extra analysis</span>
<a href="#l77.106"></a><span id="l77.106" class="difflineminus">-      stashColumns: [9]</span>
<a href="#l77.107"></a><span id="l77.107" class="difflineplus">+      stashColumns: [14]</span>
<a href="#l77.108"></a><span id="l77.108">     });</span>
<a href="#l77.109"></a><span id="l77.109"> </span>
<a href="#l77.110"></a><span id="l77.110" class="difflineminus">-    query.fulltextMatches(this.fulltextTerms.join(&quot; &quot;));</span>
<a href="#l77.111"></a><span id="l77.111" class="difflineminus">-    query.orderBy('-dascore');</span>
<a href="#l77.112"></a><span id="l77.112" class="difflineplus">+    let fulltextQueryString;</span>
<a href="#l77.113"></a><span id="l77.113" class="difflineplus">+    if (this.andTerms)</span>
<a href="#l77.114"></a><span id="l77.114" class="difflineplus">+      fulltextQueryString = '&quot;' + this.fulltextTerms.join('&quot; &quot;') + '&quot;';</span>
<a href="#l77.115"></a><span id="l77.115" class="difflineplus">+    else</span>
<a href="#l77.116"></a><span id="l77.116" class="difflineplus">+      fulltextQueryString = '&quot;' + this.fulltextTerms.join('&quot; OR &quot;') + '&quot;';</span>
<a href="#l77.117"></a><span id="l77.117" class="difflineplus">+</span>
<a href="#l77.118"></a><span id="l77.118" class="difflineplus">+    query.fulltextMatches(fulltextQueryString);</span>
<a href="#l77.119"></a><span id="l77.119" class="difflineplus">+    query.orderBy(this.sortBy);</span>
<a href="#l77.120"></a><span id="l77.120">     query.limit(this.retrievalLimit);</span>
<a href="#l77.121"></a><span id="l77.121"> </span>
<a href="#l77.122"></a><span id="l77.122">     return query;</span>
<a href="#l77.123"></a><span id="l77.123">   },</span>
<a href="#l77.124"></a><span id="l77.124"> </span>
<a href="#l77.125"></a><span id="l77.125" class="difflineminus">-  go: function GlodaMsgSearcher_go() {</span>
<a href="#l77.126"></a><span id="l77.126" class="difflineplus">+  getCollection: function GlodaMsgSearcher_getCollection(</span>
<a href="#l77.127"></a><span id="l77.127" class="difflineplus">+      aListenerOverride, aData) {</span>
<a href="#l77.128"></a><span id="l77.128" class="difflineplus">+    if (aListenerOverride)</span>
<a href="#l77.129"></a><span id="l77.129" class="difflineplus">+      this.listener = aListenerOverride;</span>
<a href="#l77.130"></a><span id="l77.130" class="difflineplus">+</span>
<a href="#l77.131"></a><span id="l77.131">     this.query = this.buildFulltextQuery();</span>
<a href="#l77.132"></a><span id="l77.132" class="difflineminus">-    this.collection = this.query.getCollection(this);</span>
<a href="#l77.133"></a><span id="l77.133" class="difflineplus">+    this.collection = this.query.getCollection(this, aData);</span>
<a href="#l77.134"></a><span id="l77.134" class="difflineplus">+    this.completed = false;</span>
<a href="#l77.135"></a><span id="l77.135"> </span>
<a href="#l77.136"></a><span id="l77.136">     return this.collection;</span>
<a href="#l77.137"></a><span id="l77.137">   },</span>
<a href="#l77.138"></a><span id="l77.138" class="difflineplus">+  </span>
<a href="#l77.139"></a><span id="l77.139" class="difflineplus">+  sortBy: '-dascore', </span>
<a href="#l77.140"></a><span id="l77.140"> </span>
<a href="#l77.141"></a><span id="l77.141">   onItemsAdded: function GlodaMsgSearcher_onItemsAdded(aItems, aCollection) {</span>
<a href="#l77.142"></a><span id="l77.142">     let scores = Gloda.scoreNounItems(</span>
<a href="#l77.143"></a><span id="l77.143">       aItems,</span>
<a href="#l77.144"></a><span id="l77.144">       {</span>
<a href="#l77.145"></a><span id="l77.145">         terms: this.fulltextTerms,</span>
<a href="#l77.146"></a><span id="l77.146">         stashedColumns: aCollection.stashedColumns</span>
<a href="#l77.147"></a><span id="l77.147">       },</span>
<a href="#l77.148"></a><span id="l77.148">       [scoreOffsets]);</span>
<a href="#l77.149"></a><span id="l77.149">     let actualItems = [];</span>
<a href="#l77.150"></a><span id="l77.150">     for (let i = 0; i &lt; aItems.length; i++) {</span>
<a href="#l77.151"></a><span id="l77.151">       let item = aItems[i];</span>
<a href="#l77.152"></a><span id="l77.152">       let score = scores[i];</span>
<a href="#l77.153"></a><span id="l77.153"> </span>
<a href="#l77.154"></a><span id="l77.154" class="difflineminus">-      let hdr = item.folderMessage;</span>
<a href="#l77.155"></a><span id="l77.155" class="difflineminus">-      if (hdr) {</span>
<a href="#l77.156"></a><span id="l77.156" class="difflineminus">-        this.scoresByUriAndKey[hdr.folder.URI + &quot;-&quot; + hdr.messageKey] = score;</span>
<a href="#l77.157"></a><span id="l77.157" class="difflineminus">-        actualItems.push(item);</span>
<a href="#l77.158"></a><span id="l77.158" class="difflineminus">-      }</span>
<a href="#l77.159"></a><span id="l77.159" class="difflineplus">+      this.scoresById[item.id] = score;</span>
<a href="#l77.160"></a><span id="l77.160">     }</span>
<a href="#l77.161"></a><span id="l77.161"> </span>
<a href="#l77.162"></a><span id="l77.162" class="difflineminus">-    this.viewWrapper.onItemsAdded(actualItems, aCollection);</span>
<a href="#l77.163"></a><span id="l77.163" class="difflineplus">+    if (this.listener)</span>
<a href="#l77.164"></a><span id="l77.164" class="difflineplus">+      this.listener.onItemsAdded(actualItems, aCollection);</span>
<a href="#l77.165"></a><span id="l77.165" class="difflineplus">+  },</span>
<a href="#l77.166"></a><span id="l77.166" class="difflineplus">+  onItemsModified: function GlodaMsgSearcher_onItemsModified(aItems,</span>
<a href="#l77.167"></a><span id="l77.167" class="difflineplus">+                                                             aCollection) {</span>
<a href="#l77.168"></a><span id="l77.168" class="difflineplus">+    if (this.listener)</span>
<a href="#l77.169"></a><span id="l77.169" class="difflineplus">+      this.listener.onItemsModified(aItems, aCollection);</span>
<a href="#l77.170"></a><span id="l77.170">   },</span>
<a href="#l77.171"></a><span id="l77.171" class="difflineminus">-  onItemsModified: function GlodaMsgSearcher_onItemsModified() {},</span>
<a href="#l77.172"></a><span id="l77.172" class="difflineminus">-  onItemsRemoved: function GlodaMsgSearcher_onItemsRemoved() {},</span>
<a href="#l77.173"></a><span id="l77.173" class="difflineplus">+  onItemsRemoved: function GlodaMsgSearcher_onItemsRemoved(aItems,</span>
<a href="#l77.174"></a><span id="l77.174" class="difflineplus">+                                                           aCollection) {</span>
<a href="#l77.175"></a><span id="l77.175" class="difflineplus">+    if (this.listener)</span>
<a href="#l77.176"></a><span id="l77.176" class="difflineplus">+      this.listener.onItemsRemoved(aItems, aCollection);</span>
<a href="#l77.177"></a><span id="l77.177" class="difflineplus">+  },</span>
<a href="#l77.178"></a><span id="l77.178">   onQueryCompleted: function GlodaMsgSearcher_onQueryCompleted(aCollection) {</span>
<a href="#l77.179"></a><span id="l77.179" class="difflineminus">-    this.viewWrapper.onQueryCompleted(aCollection);</span>
<a href="#l77.180"></a><span id="l77.180" class="difflineplus">+    this.completed = true;</span>
<a href="#l77.181"></a><span id="l77.181" class="difflineplus">+    if (this.listener)</span>
<a href="#l77.182"></a><span id="l77.182" class="difflineplus">+      this.listener.onQueryCompleted(aCollection);</span>
<a href="#l77.183"></a><span id="l77.183">   },</span>
<a href="#l77.184"></a><span id="l77.184" class="difflineminus">-};</span>
<a href="#l77.185"></a><span id="l77.185">\ No newline at end of file</span>
<a href="#l77.186"></a><span id="l77.186" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/mailnews/db/gloda/modules/noun_freetag.js</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/noun_freetag.js</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l78.4"></a><span id="l78.4"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l78.5"></a><span id="l78.5">  *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l78.6"></a><span id="l78.6">  *</span>
<a href="#l78.7"></a><span id="l78.7">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l78.8"></a><span id="l78.8">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l78.9"></a><span id="l78.9">  * the License. You may obtain a copy of the License at</span>
<a href="#l78.10"></a><span id="l78.10">  * http://www.mozilla.org/MPL/</span>
<a href="#l78.11"></a><span id="l78.11" class="difflineminus">- * </span>
<a href="#l78.12"></a><span id="l78.12" class="difflineplus">+ *</span>
<a href="#l78.13"></a><span id="l78.13">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l78.14"></a><span id="l78.14">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l78.15"></a><span id="l78.15">  * for the specific language governing rights and limitations under the</span>
<a href="#l78.16"></a><span id="l78.16">  * License.</span>
<a href="#l78.17"></a><span id="l78.17">  *</span>
<a href="#l78.18"></a><span id="l78.18">  * The Original Code is Thunderbird Global Database.</span>
<a href="#l78.19"></a><span id="l78.19">  *</span>
<a href="#l78.20"></a><span id="l78.20">  * The Initial Developer of the Original Code is</span>
<a href="#l78.21"></a><span id="l78.21" class="difflineat">@@ -27,17 +27,17 @@</span>
<a href="#l78.22"></a><span id="l78.22">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l78.23"></a><span id="l78.23">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l78.24"></a><span id="l78.24">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l78.25"></a><span id="l78.25">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l78.26"></a><span id="l78.26">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l78.27"></a><span id="l78.27">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l78.28"></a><span id="l78.28">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l78.29"></a><span id="l78.29">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l78.30"></a><span id="l78.30" class="difflineminus">- * </span>
<a href="#l78.31"></a><span id="l78.31" class="difflineplus">+ *</span>
<a href="#l78.32"></a><span id="l78.32">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l78.33"></a><span id="l78.33"> </span>
<a href="#l78.34"></a><span id="l78.34"> EXPORTED_SYMBOLS = ['FreeTag', 'FreeTagNoun'];</span>
<a href="#l78.35"></a><span id="l78.35"> </span>
<a href="#l78.36"></a><span id="l78.36"> const Cc = Components.classes;</span>
<a href="#l78.37"></a><span id="l78.37"> const Ci = Components.interfaces;</span>
<a href="#l78.38"></a><span id="l78.38"> const Cr = Components.results;</span>
<a href="#l78.39"></a><span id="l78.39"> const Cu = Components.utils;</span>
<a href="#l78.40"></a><span id="l78.40" class="difflineat">@@ -59,54 +59,67 @@ FreeTag.prototype = {</span>
<a href="#l78.41"></a><span id="l78.41"> /**</span>
<a href="#l78.42"></a><span id="l78.42">  * @namespace Tag noun provider.  Since the tag unique value is stored as a</span>
<a href="#l78.43"></a><span id="l78.43">  *  parameter, we are an odd case and semantically confused.</span>
<a href="#l78.44"></a><span id="l78.44">  */</span>
<a href="#l78.45"></a><span id="l78.45"> var FreeTagNoun = {</span>
<a href="#l78.46"></a><span id="l78.46">   _log: Log4Moz.repository.getLogger(&quot;gloda.noun.freetag&quot;),</span>
<a href="#l78.47"></a><span id="l78.47"> </span>
<a href="#l78.48"></a><span id="l78.48">   name: &quot;freetag&quot;,</span>
<a href="#l78.49"></a><span id="l78.49" class="difflineminus">-  class: FreeTag,</span>
<a href="#l78.50"></a><span id="l78.50" class="difflineplus">+  clazz: FreeTag,</span>
<a href="#l78.51"></a><span id="l78.51">   allowsArbitraryAttrs: false,</span>
<a href="#l78.52"></a><span id="l78.52">   usesParameter: true,</span>
<a href="#l78.53"></a><span id="l78.53" class="difflineminus">-  </span>
<a href="#l78.54"></a><span id="l78.54" class="difflineplus">+</span>
<a href="#l78.55"></a><span id="l78.55">   _listeners: [],</span>
<a href="#l78.56"></a><span id="l78.56">   addListener: function(aListener) {</span>
<a href="#l78.57"></a><span id="l78.57">     this._listeners.push(aListener);</span>
<a href="#l78.58"></a><span id="l78.58">   },</span>
<a href="#l78.59"></a><span id="l78.59">   removeListener: function(aListener) {</span>
<a href="#l78.60"></a><span id="l78.60">     let index = this._listeners.indexOf(aListener);</span>
<a href="#l78.61"></a><span id="l78.61">     if (index &gt;=0)</span>
<a href="#l78.62"></a><span id="l78.62">       this._listeners.splice(index, 1);</span>
<a href="#l78.63"></a><span id="l78.63">   },</span>
<a href="#l78.64"></a><span id="l78.64" class="difflineminus">-  </span>
<a href="#l78.65"></a><span id="l78.65" class="difflineplus">+</span>
<a href="#l78.66"></a><span id="l78.66">   populateKnownFreeTags: function() {</span>
<a href="#l78.67"></a><span id="l78.67">     for each (let [,attr] in Iterator(this.objectNounOfAttributes)) {</span>
<a href="#l78.68"></a><span id="l78.68">       let attrDB = attr.dbDef;</span>
<a href="#l78.69"></a><span id="l78.69">       for (let param in attrDB.parameterBindings) {</span>
<a href="#l78.70"></a><span id="l78.70">         this.getFreeTag(param);</span>
<a href="#l78.71"></a><span id="l78.71">       }</span>
<a href="#l78.72"></a><span id="l78.72">     }</span>
<a href="#l78.73"></a><span id="l78.73">   },</span>
<a href="#l78.74"></a><span id="l78.74" class="difflineminus">-  </span>
<a href="#l78.75"></a><span id="l78.75" class="difflineplus">+</span>
<a href="#l78.76"></a><span id="l78.76">   knownFreeTags: {},</span>
<a href="#l78.77"></a><span id="l78.77">   getFreeTag: function(aTagName) {</span>
<a href="#l78.78"></a><span id="l78.78">     let tag = this.knownFreeTags[aTagName];</span>
<a href="#l78.79"></a><span id="l78.79">     if (!tag) {</span>
<a href="#l78.80"></a><span id="l78.80">       tag = this.knownFreeTags[aTagName] = new FreeTag(aTagName);</span>
<a href="#l78.81"></a><span id="l78.81">       for each (let [iListener, listener] in Iterator(this._listeners))</span>
<a href="#l78.82"></a><span id="l78.82">         listener.onFreeTagAdded(tag);</span>
<a href="#l78.83"></a><span id="l78.83">     }</span>
<a href="#l78.84"></a><span id="l78.84">     return tag;</span>
<a href="#l78.85"></a><span id="l78.85">   },</span>
<a href="#l78.86"></a><span id="l78.86"> </span>
<a href="#l78.87"></a><span id="l78.87" class="difflineplus">+  comparator: function gloda_noun_freetag_comparator(a, b) {</span>
<a href="#l78.88"></a><span id="l78.88" class="difflineplus">+    if (a == null) {</span>
<a href="#l78.89"></a><span id="l78.89" class="difflineplus">+      if (b == null)</span>
<a href="#l78.90"></a><span id="l78.90" class="difflineplus">+        return 0;</span>
<a href="#l78.91"></a><span id="l78.91" class="difflineplus">+      else</span>
<a href="#l78.92"></a><span id="l78.92" class="difflineplus">+        return 1;</span>
<a href="#l78.93"></a><span id="l78.93" class="difflineplus">+    }</span>
<a href="#l78.94"></a><span id="l78.94" class="difflineplus">+    else if (b == null) {</span>
<a href="#l78.95"></a><span id="l78.95" class="difflineplus">+      return -1;</span>
<a href="#l78.96"></a><span id="l78.96" class="difflineplus">+    }</span>
<a href="#l78.97"></a><span id="l78.97" class="difflineplus">+    return a.name.localeCompare(b.name);</span>
<a href="#l78.98"></a><span id="l78.98" class="difflineplus">+  },</span>
<a href="#l78.99"></a><span id="l78.99" class="difflineplus">+</span>
<a href="#l78.100"></a><span id="l78.100">   toParamAndValue: function gloda_noun_freetag_toParamAndValue(aTag) {</span>
<a href="#l78.101"></a><span id="l78.101">     return [aTag.name, null];</span>
<a href="#l78.102"></a><span id="l78.102">   },</span>
<a href="#l78.103"></a><span id="l78.103" class="difflineminus">-  </span>
<a href="#l78.104"></a><span id="l78.104" class="difflineplus">+</span>
<a href="#l78.105"></a><span id="l78.105">   toJSON: function gloda_noun_freetag_toJSON(aTag) {</span>
<a href="#l78.106"></a><span id="l78.106">     return aTag.name;</span>
<a href="#l78.107"></a><span id="l78.107">   },</span>
<a href="#l78.108"></a><span id="l78.108">   fromJSON: function gloda_noun_freetag_fromJSON(aTagName) {</span>
<a href="#l78.109"></a><span id="l78.109">     return this.getFreeTag(aTagName);</span>
<a href="#l78.110"></a><span id="l78.110">   },</span>
<a href="#l78.111"></a><span id="l78.111"> };</span>
<a href="#l78.112"></a><span id="l78.112"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/mailnews/db/gloda/modules/noun_mimetype.js</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/noun_mimetype.js</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -38,33 +38,37 @@</span>
<a href="#l79.4"></a><span id="l79.4"> EXPORTED_SYMBOLS = ['MimeType', 'MimeTypeNoun'];</span>
<a href="#l79.5"></a><span id="l79.5"> </span>
<a href="#l79.6"></a><span id="l79.6"> const Cc = Components.classes;</span>
<a href="#l79.7"></a><span id="l79.7"> const Ci = Components.interfaces;</span>
<a href="#l79.8"></a><span id="l79.8"> const Cr = Components.results;</span>
<a href="#l79.9"></a><span id="l79.9"> const Cu = Components.utils;</span>
<a href="#l79.10"></a><span id="l79.10"> </span>
<a href="#l79.11"></a><span id="l79.11"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineplus">+Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l79.13"></a><span id="l79.13"> </span>
<a href="#l79.14"></a><span id="l79.14"> const LOG = Log4Moz.repository.getLogger(&quot;gloda.noun.mimetype&quot;);</span>
<a href="#l79.15"></a><span id="l79.15"> </span>
<a href="#l79.16"></a><span id="l79.16"> Cu.import(&quot;resource://app/modules/gloda/gloda.js&quot;);</span>
<a href="#l79.17"></a><span id="l79.17"> </span>
<a href="#l79.18"></a><span id="l79.18" class="difflineplus">+let CategoryStringMap = {};</span>
<a href="#l79.19"></a><span id="l79.19" class="difflineplus">+</span>
<a href="#l79.20"></a><span id="l79.20"> /**</span>
<a href="#l79.21"></a><span id="l79.21">  * Mime type abstraction that exists primarily so we can map mime types to</span>
<a href="#l79.22"></a><span id="l79.22">  *  integer id's.</span>
<a href="#l79.23"></a><span id="l79.23">  *</span>
<a href="#l79.24"></a><span id="l79.24">  * Instances of this class should only be retrieved via |MimeTypeNoun|; no one</span>
<a href="#l79.25"></a><span id="l79.25">  *  should ever create an instance directly.</span>
<a href="#l79.26"></a><span id="l79.26">  */</span>
<a href="#l79.27"></a><span id="l79.27" class="difflineminus">-function MimeType(aID, aType, aSubType, aFullType) {</span>
<a href="#l79.28"></a><span id="l79.28" class="difflineplus">+function MimeType(aID, aType, aSubType, aFullType, aCategory) {</span>
<a href="#l79.29"></a><span id="l79.29">   this._id = aID;</span>
<a href="#l79.30"></a><span id="l79.30">   this._type = aType;</span>
<a href="#l79.31"></a><span id="l79.31">   this._subType = aSubType;</span>
<a href="#l79.32"></a><span id="l79.32">   this._fullType = aFullType;</span>
<a href="#l79.33"></a><span id="l79.33" class="difflineplus">+  this._category = aCategory;</span>
<a href="#l79.34"></a><span id="l79.34"> }</span>
<a href="#l79.35"></a><span id="l79.35"> </span>
<a href="#l79.36"></a><span id="l79.36"> MimeType.prototype = {</span>
<a href="#l79.37"></a><span id="l79.37">   /**</span>
<a href="#l79.38"></a><span id="l79.38">    * The integer id we have associated with the mime type.  This is stable for</span>
<a href="#l79.39"></a><span id="l79.39">    *  the lifetime of the database, which means that anything in the Gloda</span>
<a href="#l79.40"></a><span id="l79.40">    *  database can use this without fear.  Things not persisted in the database</span>
<a href="#l79.41"></a><span id="l79.41">    *  should use the actual string mime type, retrieval via |fullType|.</span>
<a href="#l79.42"></a><span id="l79.42" class="difflineat">@@ -73,142 +77,315 @@ MimeType.prototype = {</span>
<a href="#l79.43"></a><span id="l79.43">   /**</span>
<a href="#l79.44"></a><span id="l79.44">    * The first part of the MIME type; &quot;text/plain&quot; gets you &quot;text&quot;.</span>
<a href="#l79.45"></a><span id="l79.45">    */</span>
<a href="#l79.46"></a><span id="l79.46">   get type() { return this._type; },</span>
<a href="#l79.47"></a><span id="l79.47">   set fullType(aFullType) {</span>
<a href="#l79.48"></a><span id="l79.48">     if (!this._fullType) {</span>
<a href="#l79.49"></a><span id="l79.49">       this._fullType = aFullType;</span>
<a href="#l79.50"></a><span id="l79.50">       [this._type, this._subType] = this._fullType.split(&quot;/&quot;);</span>
<a href="#l79.51"></a><span id="l79.51" class="difflineplus">+      this._category =</span>
<a href="#l79.52"></a><span id="l79.52" class="difflineplus">+        MimeTypeNoun._getCategoryForMimeType(aFullType, this._type);</span>
<a href="#l79.53"></a><span id="l79.53">     }</span>
<a href="#l79.54"></a><span id="l79.54">   },</span>
<a href="#l79.55"></a><span id="l79.55">   /**</span>
<a href="#l79.56"></a><span id="l79.56">    * If the |fullType| is &quot;text/plain&quot;, subType is &quot;plain&quot;.</span>
<a href="#l79.57"></a><span id="l79.57">    */</span>
<a href="#l79.58"></a><span id="l79.58">   get subType() { return this._subType; },</span>
<a href="#l79.59"></a><span id="l79.59">   /**</span>
<a href="#l79.60"></a><span id="l79.60">    * The full MIME type; &quot;text/plain&quot; returns &quot;text/plain&quot;.</span>
<a href="#l79.61"></a><span id="l79.61">    */</span>
<a href="#l79.62"></a><span id="l79.62">   get fullType() { return this._fullType; },</span>
<a href="#l79.63"></a><span id="l79.63">   toString: function () {</span>
<a href="#l79.64"></a><span id="l79.64">     return this.fullType;</span>
<a href="#l79.65"></a><span id="l79.65" class="difflineplus">+  },</span>
<a href="#l79.66"></a><span id="l79.66" class="difflineplus">+</span>
<a href="#l79.67"></a><span id="l79.67" class="difflineplus">+  /**</span>
<a href="#l79.68"></a><span id="l79.68" class="difflineplus">+   * @return the category we believe this mime type belongs to.  This category</span>
<a href="#l79.69"></a><span id="l79.69" class="difflineplus">+   *     name should never be shown directly to the user.  Instead, use</span>
<a href="#l79.70"></a><span id="l79.70" class="difflineplus">+   *     |categoryLabel| to get the localized name for the category.  The</span>
<a href="#l79.71"></a><span id="l79.71" class="difflineplus">+   *     category mapping comes from mimeTypesCategories.js.</span>
<a href="#l79.72"></a><span id="l79.72" class="difflineplus">+   */</span>
<a href="#l79.73"></a><span id="l79.73" class="difflineplus">+  get category() {</span>
<a href="#l79.74"></a><span id="l79.74" class="difflineplus">+    return this._category;</span>
<a href="#l79.75"></a><span id="l79.75" class="difflineplus">+  },</span>
<a href="#l79.76"></a><span id="l79.76" class="difflineplus">+  /**</span>
<a href="#l79.77"></a><span id="l79.77" class="difflineplus">+   * @return The localized label for the category from gloda.properties in the</span>
<a href="#l79.78"></a><span id="l79.78" class="difflineplus">+   *     &quot;gloda.mimetype.category.CATEGORY.label&quot; definition using the value</span>
<a href="#l79.79"></a><span id="l79.79" class="difflineplus">+   *     from |category|.</span>
<a href="#l79.80"></a><span id="l79.80" class="difflineplus">+   */</span>
<a href="#l79.81"></a><span id="l79.81" class="difflineplus">+  get categoryLabel() {</span>
<a href="#l79.82"></a><span id="l79.82" class="difflineplus">+    return CategoryStringMap[this._category];</span>
<a href="#l79.83"></a><span id="l79.83">   }</span>
<a href="#l79.84"></a><span id="l79.84"> };</span>
<a href="#l79.85"></a><span id="l79.85"> </span>
<a href="#l79.86"></a><span id="l79.86"> /**</span>
<a href="#l79.87"></a><span id="l79.87" class="difflineminus">- * @namespace Mime type noun provider.</span>
<a href="#l79.88"></a><span id="l79.88" class="difflineplus">+ * Mime type noun provider.</span>
<a href="#l79.89"></a><span id="l79.89">  *</span>
<a href="#l79.90"></a><span id="l79.90">  * The set of MIME Types is sufficiently limited that we can keep them all in</span>
<a href="#l79.91"></a><span id="l79.91">  *  memory.  In theory it is also sufficiently limited that we could use the</span>
<a href="#l79.92"></a><span id="l79.92">  *  parameter mechanism in the database.  However, it is more efficient, for</span>
<a href="#l79.93"></a><span id="l79.93">  *  both space and performance reasons, to store the specific mime type as a</span>
<a href="#l79.94"></a><span id="l79.94">  *  value.  For future-proofing reasons, we opt to use a database table to</span>
<a href="#l79.95"></a><span id="l79.95">  *  persist the mapping rather than a hard-coded list.  A preferences file or</span>
<a href="#l79.96"></a><span id="l79.96">  *  other text file would arguably suffice, but for consistency reasons, the</span>
<a href="#l79.97"></a><span id="l79.97">  *  database is not a bad thing.</span>
<a href="#l79.98"></a><span id="l79.98">  */</span>
<a href="#l79.99"></a><span id="l79.99"> var MimeTypeNoun = {</span>
<a href="#l79.100"></a><span id="l79.100">   name: &quot;mime-type&quot;,</span>
<a href="#l79.101"></a><span id="l79.101">   clazz: MimeType, // gloda supports clazz as well as class</span>
<a href="#l79.102"></a><span id="l79.102">   allowsArbitraryAttrs: false,</span>
<a href="#l79.103"></a><span id="l79.103"> </span>
<a href="#l79.104"></a><span id="l79.104" class="difflineplus">+  _strings: new StringBundle(&quot;chrome://messenger/locale/gloda.properties&quot;),</span>
<a href="#l79.105"></a><span id="l79.105" class="difflineplus">+</span>
<a href="#l79.106"></a><span id="l79.106">   // note! update test_noun_mimetype if you change our internals!</span>
<a href="#l79.107"></a><span id="l79.107">   _mimeTypes: {},</span>
<a href="#l79.108"></a><span id="l79.108">   _mimeTypesByID: {},</span>
<a href="#l79.109"></a><span id="l79.109" class="difflineminus">-  TYPE_BLOCK_SIZE: 8096, // bet you were expecting a power of 2!</span>
<a href="#l79.110"></a><span id="l79.110" class="difflineminus">-    // (we can fix this next time we bump the database schema version and have</span>
<a href="#l79.111"></a><span id="l79.111" class="difflineminus">-    //  to resort to blowing the database away.)</span>
<a href="#l79.112"></a><span id="l79.112" class="difflineplus">+  TYPE_BLOCK_SIZE: 16384,</span>
<a href="#l79.113"></a><span id="l79.113">   _mimeTypeHighID: {},</span>
<a href="#l79.114"></a><span id="l79.114" class="difflineplus">+  _mimeTypeRangeDummyObjects: {},</span>
<a href="#l79.115"></a><span id="l79.115">   _highID: 0,</span>
<a href="#l79.116"></a><span id="l79.116"> </span>
<a href="#l79.117"></a><span id="l79.117">   // we now use the exciting 'schema' mechanism of defineNoun to get our table</span>
<a href="#l79.118"></a><span id="l79.118">   //  created for us, plus some helper methods that we simply don't use.</span>
<a href="#l79.119"></a><span id="l79.119">   schema: {</span>
<a href="#l79.120"></a><span id="l79.120">     name: 'mimeTypes',</span>
<a href="#l79.121"></a><span id="l79.121">     columns: [['id', 'INTEGER PRIMARY KEY', '_id'],</span>
<a href="#l79.122"></a><span id="l79.122">               ['mimeType', 'TEXT', 'fullType']],</span>
<a href="#l79.123"></a><span id="l79.123">   },</span>
<a href="#l79.124"></a><span id="l79.124"> </span>
<a href="#l79.125"></a><span id="l79.125">   _init: function() {</span>
<a href="#l79.126"></a><span id="l79.126">     LOG.debug(&quot;loading MIME types&quot;);</span>
<a href="#l79.127"></a><span id="l79.127" class="difflineplus">+    this._loadCategoryMapping();</span>
<a href="#l79.128"></a><span id="l79.128">     this._loadMimeTypes();</span>
<a href="#l79.129"></a><span id="l79.129">   },</span>
<a href="#l79.130"></a><span id="l79.130"> </span>
<a href="#l79.131"></a><span id="l79.131" class="difflineminus">-  _loadMimeTypes: function() {</span>
<a href="#l79.132"></a><span id="l79.132" class="difflineplus">+  /**</span>
<a href="#l79.133"></a><span id="l79.133" class="difflineplus">+   * A map from MIME type to category name.</span>
<a href="#l79.134"></a><span id="l79.134" class="difflineplus">+   */</span>
<a href="#l79.135"></a><span id="l79.135" class="difflineplus">+  _mimeTypeToCategory: {},</span>
<a href="#l79.136"></a><span id="l79.136" class="difflineplus">+  /**</span>
<a href="#l79.137"></a><span id="l79.137" class="difflineplus">+   * Load the contents of mimeTypeCategories.js and populate</span>
<a href="#l79.138"></a><span id="l79.138" class="difflineplus">+   */</span>
<a href="#l79.139"></a><span id="l79.139" class="difflineplus">+  _loadCategoryMapping: function MimeTypeNoun__loadCategoryMapping() {</span>
<a href="#l79.140"></a><span id="l79.140" class="difflineplus">+    let mimecatNS = {};</span>
<a href="#l79.141"></a><span id="l79.141" class="difflineplus">+    Cu.import(&quot;resource://app/modules/gloda/mimeTypeCategories.js&quot;,</span>
<a href="#l79.142"></a><span id="l79.142" class="difflineplus">+              mimecatNS);</span>
<a href="#l79.143"></a><span id="l79.143" class="difflineplus">+    let mcm = mimecatNS.MimeCategoryMapping;</span>
<a href="#l79.144"></a><span id="l79.144" class="difflineplus">+</span>
<a href="#l79.145"></a><span id="l79.145" class="difflineplus">+    let mimeTypeToCategory = this._mimeTypeToCategory;</span>
<a href="#l79.146"></a><span id="l79.146" class="difflineplus">+</span>
<a href="#l79.147"></a><span id="l79.147" class="difflineplus">+    function procMapObj(aSubTree, aCategories) {</span>
<a href="#l79.148"></a><span id="l79.148" class="difflineplus">+      for each (let [key, value] in Iterator(aSubTree)) {</span>
<a href="#l79.149"></a><span id="l79.149" class="difflineplus">+        // Add this category to our nested categories list.  Use concat since</span>
<a href="#l79.150"></a><span id="l79.150" class="difflineplus">+        //  the list will be long-lived and each list needs to be distinct.</span>
<a href="#l79.151"></a><span id="l79.151" class="difflineplus">+        let categories = aCategories.concat();</span>
<a href="#l79.152"></a><span id="l79.152" class="difflineplus">+        categories.push(key);</span>
<a href="#l79.153"></a><span id="l79.153" class="difflineplus">+</span>
<a href="#l79.154"></a><span id="l79.154" class="difflineplus">+        if (categories.length == 1) {</span>
<a href="#l79.155"></a><span id="l79.155" class="difflineplus">+          CategoryStringMap[key] =</span>
<a href="#l79.156"></a><span id="l79.156" class="difflineplus">+            MimeTypeNoun._strings.get(</span>
<a href="#l79.157"></a><span id="l79.157" class="difflineplus">+              &quot;gloda.mimetype.category.&quot; + key + &quot;.label&quot;);</span>
<a href="#l79.158"></a><span id="l79.158" class="difflineplus">+        }</span>
<a href="#l79.159"></a><span id="l79.159" class="difflineplus">+</span>
<a href="#l79.160"></a><span id="l79.160" class="difflineplus">+        // Is it an array?  (We do not have isArray in 1.9.1 and since it comes</span>
<a href="#l79.161"></a><span id="l79.161" class="difflineplus">+        //  from another JS module, it has its own Array global, so instanceof</span>
<a href="#l79.162"></a><span id="l79.162" class="difflineplus">+        //  fails us.)  If it is, just process this depth</span>
<a href="#l79.163"></a><span id="l79.163" class="difflineplus">+        if (&quot;length&quot; in value) {</span>
<a href="#l79.164"></a><span id="l79.164" class="difflineplus">+          for each (let [, mimeTypeStr] in Iterator(value)) {</span>
<a href="#l79.165"></a><span id="l79.165" class="difflineplus">+            mimeTypeToCategory[mimeTypeStr] = categories;</span>
<a href="#l79.166"></a><span id="l79.166" class="difflineplus">+          }</span>
<a href="#l79.167"></a><span id="l79.167" class="difflineplus">+        }</span>
<a href="#l79.168"></a><span id="l79.168" class="difflineplus">+        // it's yet another sub-tree branch</span>
<a href="#l79.169"></a><span id="l79.169" class="difflineplus">+        else {</span>
<a href="#l79.170"></a><span id="l79.170" class="difflineplus">+          procMapObj(value, categories);</span>
<a href="#l79.171"></a><span id="l79.171" class="difflineplus">+        }</span>
<a href="#l79.172"></a><span id="l79.172" class="difflineplus">+      }</span>
<a href="#l79.173"></a><span id="l79.173" class="difflineplus">+    }</span>
<a href="#l79.174"></a><span id="l79.174" class="difflineplus">+</span>
<a href="#l79.175"></a><span id="l79.175" class="difflineplus">+    procMapObj(mimecatNS.MimeCategoryMapping, []);</span>
<a href="#l79.176"></a><span id="l79.176" class="difflineplus">+  },</span>
<a href="#l79.177"></a><span id="l79.177" class="difflineplus">+</span>
<a href="#l79.178"></a><span id="l79.178" class="difflineplus">+  /**</span>
<a href="#l79.179"></a><span id="l79.179" class="difflineplus">+   * Lookup the category associated with a MIME type given its full type and</span>
<a href="#l79.180"></a><span id="l79.180" class="difflineplus">+   *  type.  (So, &quot;foo/bar&quot; and &quot;foo&quot; for &quot;foo/bar&quot;.)</span>
<a href="#l79.181"></a><span id="l79.181" class="difflineplus">+   */</span>
<a href="#l79.182"></a><span id="l79.182" class="difflineplus">+  _getCategoryForMimeType:</span>
<a href="#l79.183"></a><span id="l79.183" class="difflineplus">+      function MimeTypeNoun__getCategoryForMimeType(aFullType, aType) {</span>
<a href="#l79.184"></a><span id="l79.184" class="difflineplus">+    if (aFullType in this._mimeTypeToCategory)</span>
<a href="#l79.185"></a><span id="l79.185" class="difflineplus">+      return this._mimeTypeToCategory[aFullType][0];</span>
<a href="#l79.186"></a><span id="l79.186" class="difflineplus">+    let wildType = aType + &quot;/*&quot;;</span>
<a href="#l79.187"></a><span id="l79.187" class="difflineplus">+    if (wildType in this._mimeTypeToCategory)</span>
<a href="#l79.188"></a><span id="l79.188" class="difflineplus">+      return this._mimeTypeToCategory[wildType][0];</span>
<a href="#l79.189"></a><span id="l79.189" class="difflineplus">+    return this._mimeTypeToCategory[&quot;*&quot;][0];</span>
<a href="#l79.190"></a><span id="l79.190" class="difflineplus">+  },</span>
<a href="#l79.191"></a><span id="l79.191" class="difflineplus">+</span>
<a href="#l79.192"></a><span id="l79.192" class="difflineplus">+  /**</span>
<a href="#l79.193"></a><span id="l79.193" class="difflineplus">+   * In order to allow the gloda query mechanism to avoid hitting the database,</span>
<a href="#l79.194"></a><span id="l79.194" class="difflineplus">+   *  we need to either define the noun type as cachable and have a super-large</span>
<a href="#l79.195"></a><span id="l79.195" class="difflineplus">+   *  cache or simply have a collection with every MIME type in it that stays</span>
<a href="#l79.196"></a><span id="l79.196" class="difflineplus">+   *  alive forever.</span>
<a href="#l79.197"></a><span id="l79.197" class="difflineplus">+   * This is that collection.  It is initialized by |_loadMimeTypes|.  As new</span>
<a href="#l79.198"></a><span id="l79.198" class="difflineplus">+   *  MIME types are created, we add them to the collection.</span>
<a href="#l79.199"></a><span id="l79.199" class="difflineplus">+   */</span>
<a href="#l79.200"></a><span id="l79.200" class="difflineplus">+  _universalCollection: null,</span>
<a href="#l79.201"></a><span id="l79.201" class="difflineplus">+</span>
<a href="#l79.202"></a><span id="l79.202" class="difflineplus">+  /**</span>
<a href="#l79.203"></a><span id="l79.203" class="difflineplus">+   * Kick off a query of all the mime types in our database, leaving</span>
<a href="#l79.204"></a><span id="l79.204" class="difflineplus">+   *  |_processMimeTypes| to actually do the legwork.</span>
<a href="#l79.205"></a><span id="l79.205" class="difflineplus">+   */</span>
<a href="#l79.206"></a><span id="l79.206" class="difflineplus">+  _loadMimeTypes: function MimeTypeNoun__loadMimeTypes() {</span>
<a href="#l79.207"></a><span id="l79.207">     // get all the existing mime types!</span>
<a href="#l79.208"></a><span id="l79.208">     let query = Gloda.newQuery(this.id);</span>
<a href="#l79.209"></a><span id="l79.209">     let nullFunc = function() {};</span>
<a href="#l79.210"></a><span id="l79.210" class="difflineminus">-    query.getCollection({</span>
<a href="#l79.211"></a><span id="l79.211" class="difflineminus">-      onItemsAdded: nullFunc, onItemsModified: nullFunc, onItemsRemoved: null,</span>
<a href="#l79.212"></a><span id="l79.212" class="difflineplus">+    this._universalCollection = query.getCollection({</span>
<a href="#l79.213"></a><span id="l79.213" class="difflineplus">+      onItemsAdded: nullFunc, onItemsModified: nullFunc,</span>
<a href="#l79.214"></a><span id="l79.214" class="difflineplus">+      onItemsRemoved: nullFunc,</span>
<a href="#l79.215"></a><span id="l79.215">       onQueryCompleted: function (aCollection) {</span>
<a href="#l79.216"></a><span id="l79.216">         MimeTypeNoun._processMimeTypes(aCollection.items);</span>
<a href="#l79.217"></a><span id="l79.217">       }</span>
<a href="#l79.218"></a><span id="l79.218" class="difflineminus">-    }, null).becomeExplicit();</span>
<a href="#l79.219"></a><span id="l79.219" class="difflineplus">+    }, null);</span>
<a href="#l79.220"></a><span id="l79.220">   },</span>
<a href="#l79.221"></a><span id="l79.221"> </span>
<a href="#l79.222"></a><span id="l79.222" class="difflineminus">-  _processMimeTypes: function(aMimeTypes) {</span>
<a href="#l79.223"></a><span id="l79.223" class="difflineplus">+  /**</span>
<a href="#l79.224"></a><span id="l79.224" class="difflineplus">+   * For the benefit of our Category queryHelper, we need dummy ranged objects</span>
<a href="#l79.225"></a><span id="l79.225" class="difflineplus">+   *  that cover the numerical address space allocated to the category.  We</span>
<a href="#l79.226"></a><span id="l79.226" class="difflineplus">+   *  can't use a real object for the upper-bound because the upper-bound is</span>
<a href="#l79.227"></a><span id="l79.227" class="difflineplus">+   *  constantly growing and there is the chance the query might get persisted,</span>
<a href="#l79.228"></a><span id="l79.228" class="difflineplus">+   *  which means these values need to be long-lived.  Unfortunately, our</span>
<a href="#l79.229"></a><span id="l79.229" class="difflineplus">+   *  solution to this problem (dummy objects) complicates the second case,</span>
<a href="#l79.230"></a><span id="l79.230" class="difflineplus">+   *  should it ever occur.  (Because the dummy objects cannot be persisted</span>
<a href="#l79.231"></a><span id="l79.231" class="difflineplus">+   *  on their own... but there are other issues that will come up that we will</span>
<a href="#l79.232"></a><span id="l79.232" class="difflineplus">+   *  just have to deal with then.)</span>
<a href="#l79.233"></a><span id="l79.233" class="difflineplus">+   */</span>
<a href="#l79.234"></a><span id="l79.234" class="difflineplus">+  _createCategoryDummies: function (aId, aCategory) {</span>
<a href="#l79.235"></a><span id="l79.235" class="difflineplus">+    let blockBottom = aId - (aId % this.TYPE_BLOCK_SIZE);</span>
<a href="#l79.236"></a><span id="l79.236" class="difflineplus">+    let blockTop = blockBottom + this.TYPE_BLOCK_SIZE - 1;</span>
<a href="#l79.237"></a><span id="l79.237" class="difflineplus">+    this._mimeTypeRangeDummyObjects[aCategory] = [</span>
<a href="#l79.238"></a><span id="l79.238" class="difflineplus">+      new MimeType(blockBottom, &quot;!category-dummy!&quot;, aCategory,</span>
<a href="#l79.239"></a><span id="l79.239" class="difflineplus">+                   &quot;!category-dummy!/&quot; + aCategory, aCategory),</span>
<a href="#l79.240"></a><span id="l79.240" class="difflineplus">+      new MimeType(blockTop, &quot;!category-dummy!&quot;, aCategory,</span>
<a href="#l79.241"></a><span id="l79.241" class="difflineplus">+                   &quot;!category-dummy!/&quot; + aCategory, aCategory)</span>
<a href="#l79.242"></a><span id="l79.242" class="difflineplus">+    ];</span>
<a href="#l79.243"></a><span id="l79.243" class="difflineplus">+  },</span>
<a href="#l79.244"></a><span id="l79.244" class="difflineplus">+</span>
<a href="#l79.245"></a><span id="l79.245" class="difflineplus">+  _processMimeTypes: function MimeTypeNoun__processMimeTypes(aMimeTypes) {</span>
<a href="#l79.246"></a><span id="l79.246">     for each (let [, mimeType] in Iterator(aMimeTypes)) {</span>
<a href="#l79.247"></a><span id="l79.247">       if (mimeType.id &gt; this._highID)</span>
<a href="#l79.248"></a><span id="l79.248">         this._highID = mimeType.id;</span>
<a href="#l79.249"></a><span id="l79.249">       this._mimeTypes[mimeType] = mimeType;</span>
<a href="#l79.250"></a><span id="l79.250">       this._mimeTypesByID[mimeType.id] = mimeType;</span>
<a href="#l79.251"></a><span id="l79.251"> </span>
<a href="#l79.252"></a><span id="l79.252">       let typeBlock = mimeType.id - (mimeType.id % this.TYPE_BLOCK_SIZE);</span>
<a href="#l79.253"></a><span id="l79.253" class="difflineminus">-      let blockHighID = this._mimeTypeHighID[mimeType.type];</span>
<a href="#l79.254"></a><span id="l79.254" class="difflineplus">+      let blockHighID = (mimeType.category in this._mimeTypeHighID) ?</span>
<a href="#l79.255"></a><span id="l79.255" class="difflineplus">+                          this._mimeTypeHighID[mimeType.category] : undefined;</span>
<a href="#l79.256"></a><span id="l79.256" class="difflineplus">+      // create the dummy range objects</span>
<a href="#l79.257"></a><span id="l79.257" class="difflineplus">+      if (blockHighID === undefined)</span>
<a href="#l79.258"></a><span id="l79.258" class="difflineplus">+        this._createCategoryDummies(mimeType.id, mimeType.category);</span>
<a href="#l79.259"></a><span id="l79.259">       if ((blockHighID === undefined) || mimeType.id &gt; blockHighID)</span>
<a href="#l79.260"></a><span id="l79.260" class="difflineminus">-        this._mimeTypeHighID[mimeType.type] = mimeType.id;</span>
<a href="#l79.261"></a><span id="l79.261" class="difflineplus">+        this._mimeTypeHighID[mimeType.category] = mimeType.id;</span>
<a href="#l79.262"></a><span id="l79.262">     }</span>
<a href="#l79.263"></a><span id="l79.263">   },</span>
<a href="#l79.264"></a><span id="l79.264"> </span>
<a href="#l79.265"></a><span id="l79.265" class="difflineminus">-  _addNewMimeType: function(aMimeTypeName) {</span>
<a href="#l79.266"></a><span id="l79.266" class="difflineplus">+  _addNewMimeType: function MimeTypeNoun__addNewMimeType(aMimeTypeName) {</span>
<a href="#l79.267"></a><span id="l79.267">     let [typeName, subTypeName] = aMimeTypeName.split(&quot;/&quot;);</span>
<a href="#l79.268"></a><span id="l79.268" class="difflineplus">+    let category = this._getCategoryForMimeType(aMimeTypeName, typeName);</span>
<a href="#l79.269"></a><span id="l79.269"> </span>
<a href="#l79.270"></a><span id="l79.270" class="difflineminus">-    if (!(typeName in this._mimeTypeHighID)) {</span>
<a href="#l79.271"></a><span id="l79.271" class="difflineplus">+    if (!(category in this._mimeTypeHighID)) {</span>
<a href="#l79.272"></a><span id="l79.272">       let nextID = this._highID - (this._highID % this.TYPE_BLOCK_SIZE) +</span>
<a href="#l79.273"></a><span id="l79.273">         this.TYPE_BLOCK_SIZE;</span>
<a href="#l79.274"></a><span id="l79.274" class="difflineminus">-      this._mimeTypeHighID[typeName] = nextID;</span>
<a href="#l79.275"></a><span id="l79.275" class="difflineplus">+      this._mimeTypeHighID[category] = nextID;</span>
<a href="#l79.276"></a><span id="l79.276" class="difflineplus">+      this._createCategoryDummies(nextID, category);</span>
<a href="#l79.277"></a><span id="l79.277">     }</span>
<a href="#l79.278"></a><span id="l79.278"> </span>
<a href="#l79.279"></a><span id="l79.279" class="difflineminus">-    let nextID = ++this._mimeTypeHighID[typeName];</span>
<a href="#l79.280"></a><span id="l79.280" class="difflineplus">+    let nextID = ++this._mimeTypeHighID[category];</span>
<a href="#l79.281"></a><span id="l79.281"> </span>
<a href="#l79.282"></a><span id="l79.282" class="difflineminus">-    let mimeType = new MimeType(nextID, typeName, subTypeName, aMimeTypeName);</span>
<a href="#l79.283"></a><span id="l79.283" class="difflineplus">+    let mimeType = new MimeType(nextID, typeName, subTypeName, aMimeTypeName,</span>
<a href="#l79.284"></a><span id="l79.284" class="difflineplus">+                                category);</span>
<a href="#l79.285"></a><span id="l79.285">     if (mimeType.id &gt; this._highID)</span>
<a href="#l79.286"></a><span id="l79.286">       this._highID = mimeType.id;</span>
<a href="#l79.287"></a><span id="l79.287"> </span>
<a href="#l79.288"></a><span id="l79.288">     this._mimeTypes[aMimeTypeName] = mimeType;</span>
<a href="#l79.289"></a><span id="l79.289">     this._mimeTypesByID[nextID] = mimeType;</span>
<a href="#l79.290"></a><span id="l79.290"> </span>
<a href="#l79.291"></a><span id="l79.291" class="difflineminus">-    // as great as the gloda extension mechanisms are, we don't think it makes</span>
<a href="#l79.292"></a><span id="l79.292" class="difflineplus">+    // As great as the gloda extension mechanisms are, we don't think it makes</span>
<a href="#l79.293"></a><span id="l79.293">     //  a lot of sense to use them in this case.  So we directly trigger object</span>
<a href="#l79.294"></a><span id="l79.294">     //  insertion without any of the grokNounItem stuff.</span>
<a href="#l79.295"></a><span id="l79.295">     this.objInsert.call(this.datastore, mimeType);</span>
<a href="#l79.296"></a><span id="l79.296" class="difflineplus">+    // Since we bypass grokNounItem and its fun, we need to explicitly add the</span>
<a href="#l79.297"></a><span id="l79.297" class="difflineplus">+    //  new MIME-type to _universalCollection ourselves.  Don't try this at</span>
<a href="#l79.298"></a><span id="l79.298" class="difflineplus">+    //  home, kids.</span>
<a href="#l79.299"></a><span id="l79.299" class="difflineplus">+    this._universalCollection._onItemsAdded([mimeType]);</span>
<a href="#l79.300"></a><span id="l79.300"> </span>
<a href="#l79.301"></a><span id="l79.301">     return mimeType;</span>
<a href="#l79.302"></a><span id="l79.302">   },</span>
<a href="#l79.303"></a><span id="l79.303"> </span>
<a href="#l79.304"></a><span id="l79.304">   /**</span>
<a href="#l79.305"></a><span id="l79.305">    * Map a mime type to a |MimeType| instance, creating it if necessary.</span>
<a href="#l79.306"></a><span id="l79.306">    *</span>
<a href="#l79.307"></a><span id="l79.307">    * @param aMimeTypeName The mime type.  It may optionally include parameters</span>
<a href="#l79.308"></a><span id="l79.308">    *     (which will be ignored).  A mime type is of the form &quot;type/subtype&quot;.</span>
<a href="#l79.309"></a><span id="l79.309">    *     A type with parameters would look like 'type/subtype; param=&quot;value&quot;'.</span>
<a href="#l79.310"></a><span id="l79.310">    */</span>
<a href="#l79.311"></a><span id="l79.311" class="difflineminus">-  getMimeType: function(aMimeTypeName) {</span>
<a href="#l79.312"></a><span id="l79.312" class="difflineplus">+  getMimeType: function MimeTypeNoun_getMimeType(aMimeTypeName) {</span>
<a href="#l79.313"></a><span id="l79.313">     // first, lose any parameters</span>
<a href="#l79.314"></a><span id="l79.314">     let semiIndex = aMimeTypeName.indexOf(&quot;;&quot;);</span>
<a href="#l79.315"></a><span id="l79.315">     if (semiIndex &gt;= 0)</span>
<a href="#l79.316"></a><span id="l79.316">       aMimeTypeName = aMimeTypeName.substring(0, semiIndex);</span>
<a href="#l79.317"></a><span id="l79.317">     aMimeTypeName = aMimeTypeName.trim().toLowerCase();</span>
<a href="#l79.318"></a><span id="l79.318"> </span>
<a href="#l79.319"></a><span id="l79.319">     if (aMimeTypeName in this._mimeTypes)</span>
<a href="#l79.320"></a><span id="l79.320">       return this._mimeTypes[aMimeTypeName];</span>
<a href="#l79.321"></a><span id="l79.321">     else</span>
<a href="#l79.322"></a><span id="l79.322">       return this._addNewMimeType(aMimeTypeName);</span>
<a href="#l79.323"></a><span id="l79.323">   },</span>
<a href="#l79.324"></a><span id="l79.324"> </span>
<a href="#l79.325"></a><span id="l79.325" class="difflineplus">+  /**</span>
<a href="#l79.326"></a><span id="l79.326" class="difflineplus">+   * Query helpers contribute additional functions to the query object for the</span>
<a href="#l79.327"></a><span id="l79.327" class="difflineplus">+   *  attributes that use the noun type.  For example, we define Category, so</span>
<a href="#l79.328"></a><span id="l79.328" class="difflineplus">+   *  for the &quot;attachmentTypes&quot; attribute, &quot;attachmentTypesCategory&quot; would be</span>
<a href="#l79.329"></a><span id="l79.329" class="difflineplus">+   *  exposed.</span>
<a href="#l79.330"></a><span id="l79.330" class="difflineplus">+   */</span>
<a href="#l79.331"></a><span id="l79.331" class="difflineplus">+  queryHelpers: {</span>
<a href="#l79.332"></a><span id="l79.332" class="difflineplus">+    /**</span>
<a href="#l79.333"></a><span id="l79.333" class="difflineplus">+     * Query for MIME type categories based on one or more MIME type objects</span>
<a href="#l79.334"></a><span id="l79.334" class="difflineplus">+     *  passed in.  We want the range to span the entire block allocated to the</span>
<a href="#l79.335"></a><span id="l79.335" class="difflineplus">+     *  category.</span>
<a href="#l79.336"></a><span id="l79.336" class="difflineplus">+     *</span>
<a href="#l79.337"></a><span id="l79.337" class="difflineplus">+     * @param aAttrDef The attribute that is using us.</span>
<a href="#l79.338"></a><span id="l79.338" class="difflineplus">+     * @param aArguments The actual arguments object that</span>
<a href="#l79.339"></a><span id="l79.339" class="difflineplus">+     */</span>
<a href="#l79.340"></a><span id="l79.340" class="difflineplus">+    Category: function(aAttrDef, aArguments) {</span>
<a href="#l79.341"></a><span id="l79.341" class="difflineplus">+      let rangePairs = [];</span>
<a href="#l79.342"></a><span id="l79.342" class="difflineplus">+      // If there are no arguments then we want to fall back to the 'in'</span>
<a href="#l79.343"></a><span id="l79.343" class="difflineplus">+      //  constraint which matches on any attachment.</span>
<a href="#l79.344"></a><span id="l79.344" class="difflineplus">+      if (aArguments.length == 0)</span>
<a href="#l79.345"></a><span id="l79.345" class="difflineplus">+        return this._inConstraintHelper(aAttrDef, []);</span>
<a href="#l79.346"></a><span id="l79.346" class="difflineplus">+</span>
<a href="#l79.347"></a><span id="l79.347" class="difflineplus">+      for (let iArg = 0; iArg &lt; aArguments.length; iArg++) {</span>
<a href="#l79.348"></a><span id="l79.348" class="difflineplus">+        let arg = aArguments[iArg];</span>
<a href="#l79.349"></a><span id="l79.349" class="difflineplus">+        rangePairs.push(MimeTypeNoun._mimeTypeRangeDummyObjects[arg.category]);</span>
<a href="#l79.350"></a><span id="l79.350" class="difflineplus">+      }</span>
<a href="#l79.351"></a><span id="l79.351" class="difflineplus">+      return this._rangedConstraintHelper(aAttrDef, rangePairs);</span>
<a href="#l79.352"></a><span id="l79.352" class="difflineplus">+    }</span>
<a href="#l79.353"></a><span id="l79.353" class="difflineplus">+  },</span>
<a href="#l79.354"></a><span id="l79.354" class="difflineplus">+</span>
<a href="#l79.355"></a><span id="l79.355" class="difflineplus">+  comparator: function gloda_noun_mimeType_comparator(a, b) {</span>
<a href="#l79.356"></a><span id="l79.356" class="difflineplus">+    if (a == null) {</span>
<a href="#l79.357"></a><span id="l79.357" class="difflineplus">+      if (b == null)</span>
<a href="#l79.358"></a><span id="l79.358" class="difflineplus">+        return 0;</span>
<a href="#l79.359"></a><span id="l79.359" class="difflineplus">+      else</span>
<a href="#l79.360"></a><span id="l79.360" class="difflineplus">+        return 1;</span>
<a href="#l79.361"></a><span id="l79.361" class="difflineplus">+    }</span>
<a href="#l79.362"></a><span id="l79.362" class="difflineplus">+    else if (b == null) {</span>
<a href="#l79.363"></a><span id="l79.363" class="difflineplus">+      return -1;</span>
<a href="#l79.364"></a><span id="l79.364" class="difflineplus">+    }</span>
<a href="#l79.365"></a><span id="l79.365" class="difflineplus">+    return a.fullType.localeCompare(b.fullType);</span>
<a href="#l79.366"></a><span id="l79.366" class="difflineplus">+  },</span>
<a href="#l79.367"></a><span id="l79.367" class="difflineplus">+</span>
<a href="#l79.368"></a><span id="l79.368">   toParamAndValue: function gloda_noun_mimeType_toParamAndValue(aMimeType) {</span>
<a href="#l79.369"></a><span id="l79.369">     return [null, aMimeType.id];</span>
<a href="#l79.370"></a><span id="l79.370">   },</span>
<a href="#l79.371"></a><span id="l79.371">   toJSON: function gloda_noun_mimeType_toJSON(aMimeType) {</span>
<a href="#l79.372"></a><span id="l79.372">     return aMimeType.id;</span>
<a href="#l79.373"></a><span id="l79.373">   },</span>
<a href="#l79.374"></a><span id="l79.374">   fromJSON: function gloda_noun_mimeType_fromJSON(aMimeTypeID) {</span>
<a href="#l79.375"></a><span id="l79.375">     return this._mimeTypesByID[aMimeTypeID];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/mailnews/db/gloda/modules/noun_tag.js</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/noun_tag.js</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l80.4"></a><span id="l80.4"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l80.5"></a><span id="l80.5">  *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l80.6"></a><span id="l80.6">  *</span>
<a href="#l80.7"></a><span id="l80.7">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l80.8"></a><span id="l80.8">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l80.9"></a><span id="l80.9">  * the License. You may obtain a copy of the License at</span>
<a href="#l80.10"></a><span id="l80.10">  * http://www.mozilla.org/MPL/</span>
<a href="#l80.11"></a><span id="l80.11" class="difflineminus">- * </span>
<a href="#l80.12"></a><span id="l80.12" class="difflineplus">+ *</span>
<a href="#l80.13"></a><span id="l80.13">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l80.14"></a><span id="l80.14">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l80.15"></a><span id="l80.15">  * for the specific language governing rights and limitations under the</span>
<a href="#l80.16"></a><span id="l80.16">  * License.</span>
<a href="#l80.17"></a><span id="l80.17">  *</span>
<a href="#l80.18"></a><span id="l80.18">  * The Original Code is Thunderbird Global Database.</span>
<a href="#l80.19"></a><span id="l80.19">  *</span>
<a href="#l80.20"></a><span id="l80.20">  * The Initial Developer of the Original Code is</span>
<a href="#l80.21"></a><span id="l80.21" class="difflineat">@@ -27,60 +27,77 @@</span>
<a href="#l80.22"></a><span id="l80.22">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l80.23"></a><span id="l80.23">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l80.24"></a><span id="l80.24">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l80.25"></a><span id="l80.25">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l80.26"></a><span id="l80.26">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l80.27"></a><span id="l80.27">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l80.28"></a><span id="l80.28">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l80.29"></a><span id="l80.29">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l80.30"></a><span id="l80.30" class="difflineminus">- * </span>
<a href="#l80.31"></a><span id="l80.31" class="difflineplus">+ *</span>
<a href="#l80.32"></a><span id="l80.32">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l80.33"></a><span id="l80.33"> </span>
<a href="#l80.34"></a><span id="l80.34"> EXPORTED_SYMBOLS = ['TagNoun'];</span>
<a href="#l80.35"></a><span id="l80.35"> </span>
<a href="#l80.36"></a><span id="l80.36"> const Cc = Components.classes;</span>
<a href="#l80.37"></a><span id="l80.37"> const Ci = Components.interfaces;</span>
<a href="#l80.38"></a><span id="l80.38"> const Cr = Components.results;</span>
<a href="#l80.39"></a><span id="l80.39"> const Cu = Components.utils;</span>
<a href="#l80.40"></a><span id="l80.40"> </span>
<a href="#l80.41"></a><span id="l80.41"> Cu.import(&quot;resource://app/modules/gloda/gloda.js&quot;);</span>
<a href="#l80.42"></a><span id="l80.42"> </span>
<a href="#l80.43"></a><span id="l80.43"> /**</span>
<a href="#l80.44"></a><span id="l80.44">  * @namespace Tag noun provider.</span>
<a href="#l80.45"></a><span id="l80.45">  */</span>
<a href="#l80.46"></a><span id="l80.46"> var TagNoun = {</span>
<a href="#l80.47"></a><span id="l80.47">   name: &quot;tag&quot;,</span>
<a href="#l80.48"></a><span id="l80.48" class="difflineminus">-  class: Ci.nsIMsgTag,</span>
<a href="#l80.49"></a><span id="l80.49" class="difflineplus">+  clazz: Ci.nsIMsgTag,</span>
<a href="#l80.50"></a><span id="l80.50">   usesParameter: true,</span>
<a href="#l80.51"></a><span id="l80.51">   allowsArbitraryAttrs: false,</span>
<a href="#l80.52"></a><span id="l80.52" class="difflineplus">+  idAttr: &quot;key&quot;,</span>
<a href="#l80.53"></a><span id="l80.53">   _msgTagService: null,</span>
<a href="#l80.54"></a><span id="l80.54">   _tagMap: null,</span>
<a href="#l80.55"></a><span id="l80.55" class="difflineminus">-  </span>
<a href="#l80.56"></a><span id="l80.56" class="difflineplus">+</span>
<a href="#l80.57"></a><span id="l80.57">   _init: function () {</span>
<a href="#l80.58"></a><span id="l80.58">     this._msgTagService = Cc[&quot;@mozilla.org/messenger/tagservice;1&quot;].</span>
<a href="#l80.59"></a><span id="l80.59">                           getService(Ci.nsIMsgTagService);</span>
<a href="#l80.60"></a><span id="l80.60">     this._updateTagMap();</span>
<a href="#l80.61"></a><span id="l80.61">   },</span>
<a href="#l80.62"></a><span id="l80.62" class="difflineminus">-  </span>
<a href="#l80.63"></a><span id="l80.63" class="difflineplus">+</span>
<a href="#l80.64"></a><span id="l80.64">   getAllTags: function gloda_noun_tag_getAllTags() {</span>
<a href="#l80.65"></a><span id="l80.65">     return this._msgTagService.getAllTags({});</span>
<a href="#l80.66"></a><span id="l80.66">   },</span>
<a href="#l80.67"></a><span id="l80.67" class="difflineminus">-  </span>
<a href="#l80.68"></a><span id="l80.68" class="difflineplus">+</span>
<a href="#l80.69"></a><span id="l80.69">   _updateTagMap: function gloda_noun_tag_updateTagMap() {</span>
<a href="#l80.70"></a><span id="l80.70">     this._tagMap = {};</span>
<a href="#l80.71"></a><span id="l80.71">     let tagArray = this._msgTagService.getAllTags({});</span>
<a href="#l80.72"></a><span id="l80.72">     for (let iTag = 0; iTag &lt; tagArray.length; iTag++) {</span>
<a href="#l80.73"></a><span id="l80.73">       let tag = tagArray[iTag];</span>
<a href="#l80.74"></a><span id="l80.74">       this._tagMap[tag.key] = tag;</span>
<a href="#l80.75"></a><span id="l80.75">     }</span>
<a href="#l80.76"></a><span id="l80.76">   },</span>
<a href="#l80.77"></a><span id="l80.77" class="difflineminus">-  </span>
<a href="#l80.78"></a><span id="l80.78" class="difflineplus">+</span>
<a href="#l80.79"></a><span id="l80.79" class="difflineplus">+  comparator: function gloda_noun_tag_comparator(a, b) {</span>
<a href="#l80.80"></a><span id="l80.80" class="difflineplus">+    if (a == null) {</span>
<a href="#l80.81"></a><span id="l80.81" class="difflineplus">+      if (b == null)</span>
<a href="#l80.82"></a><span id="l80.82" class="difflineplus">+        return 0;</span>
<a href="#l80.83"></a><span id="l80.83" class="difflineplus">+      else</span>
<a href="#l80.84"></a><span id="l80.84" class="difflineplus">+        return 1;</span>
<a href="#l80.85"></a><span id="l80.85" class="difflineplus">+    }</span>
<a href="#l80.86"></a><span id="l80.86" class="difflineplus">+    else if (b == null) {</span>
<a href="#l80.87"></a><span id="l80.87" class="difflineplus">+      return -1;</span>
<a href="#l80.88"></a><span id="l80.88" class="difflineplus">+    }</span>
<a href="#l80.89"></a><span id="l80.89" class="difflineplus">+    return a.tag.localeCompare(b.tag);</span>
<a href="#l80.90"></a><span id="l80.90" class="difflineplus">+  },</span>
<a href="#l80.91"></a><span id="l80.91" class="difflineplus">+  userVisibleString: function gloda_noun_tag_userVisibleString(aTag) {</span>
<a href="#l80.92"></a><span id="l80.92" class="difflineplus">+    return aTag.tag;</span>
<a href="#l80.93"></a><span id="l80.93" class="difflineplus">+  },</span>
<a href="#l80.94"></a><span id="l80.94" class="difflineplus">+</span>
<a href="#l80.95"></a><span id="l80.95">   // we cannot be an attribute value</span>
<a href="#l80.96"></a><span id="l80.96" class="difflineminus">-  </span>
<a href="#l80.97"></a><span id="l80.97" class="difflineplus">+</span>
<a href="#l80.98"></a><span id="l80.98">   toParamAndValue: function gloda_noun_tag_toParamAndValue(aTag) {</span>
<a href="#l80.99"></a><span id="l80.99">     return [aTag.key, null];</span>
<a href="#l80.100"></a><span id="l80.100">   },</span>
<a href="#l80.101"></a><span id="l80.101">   toJSON: function gloda_noun_tag_toJSON(aTag) {</span>
<a href="#l80.102"></a><span id="l80.102">     return aTag.key;</span>
<a href="#l80.103"></a><span id="l80.103">   },</span>
<a href="#l80.104"></a><span id="l80.104">   fromJSON: function gloda_noun_tag_fromJSON(aTagKey, aIgnored) {</span>
<a href="#l80.105"></a><span id="l80.105">     let tag = this._tagMap[aTagKey];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/mailnews/db/gloda/modules/query.js</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/query.js</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -133,16 +133,17 @@ GlodaQueryClass.prototype = {</span>
<a href="#l81.4"></a><span id="l81.4">    * Return a collection asynchronously populated by this collection.  You must</span>
<a href="#l81.5"></a><span id="l81.5">    *  provide a listener to receive notifications from the collection as it</span>
<a href="#l81.6"></a><span id="l81.6">    *  receives updates.  The listener object should implement onItemsAdded,</span>
<a href="#l81.7"></a><span id="l81.7">    *  onItemsModified, and onItemsRemoved methods, all of which take a single</span>
<a href="#l81.8"></a><span id="l81.8">    *  argument which is the list of items which have been added, modified, or</span>
<a href="#l81.9"></a><span id="l81.9">    *  removed respectively.</span>
<a href="#l81.10"></a><span id="l81.10">    */</span>
<a href="#l81.11"></a><span id="l81.11">   getCollection: function gloda_query_getCollection(aListener, aData) {</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineplus">+    this.completed = false;</span>
<a href="#l81.13"></a><span id="l81.13">     return this._nounDef.datastore.queryFromQuery(this, aListener, aData);</span>
<a href="#l81.14"></a><span id="l81.14">   },</span>
<a href="#l81.15"></a><span id="l81.15"> </span>
<a href="#l81.16"></a><span id="l81.16">   /**</span>
<a href="#l81.17"></a><span id="l81.17">    * Test whether the given first-class noun instance satisfies this query.</span>
<a href="#l81.18"></a><span id="l81.18">    *</span>
<a href="#l81.19"></a><span id="l81.19">    * @testpoint gloda.query.test</span>
<a href="#l81.20"></a><span id="l81.20">    */</span>
<a href="#l81.21"></a><span id="l81.21" class="difflineat">@@ -155,16 +156,17 @@ GlodaQueryClass.prototype = {</span>
<a href="#l81.22"></a><span id="l81.22">       let curQuery = unionQueries[iUnion];</span>
<a href="#l81.23"></a><span id="l81.23"> </span>
<a href="#l81.24"></a><span id="l81.24">       // assume success until a specific (or) constraint proves us wrong</span>
<a href="#l81.25"></a><span id="l81.25">       let querySatisfied = true;</span>
<a href="#l81.26"></a><span id="l81.26">       for (let iConstraint = 0; iConstraint &lt; curQuery._constraints.length;</span>
<a href="#l81.27"></a><span id="l81.27">            iConstraint++) {</span>
<a href="#l81.28"></a><span id="l81.28">         let constraint = curQuery._constraints[iConstraint];</span>
<a href="#l81.29"></a><span id="l81.29">         let [constraintType, attrDef] = constraint;</span>
<a href="#l81.30"></a><span id="l81.30" class="difflineplus">+        let boundName = attrDef ? attrDef.boundName : &quot;id&quot;;</span>
<a href="#l81.31"></a><span id="l81.31">         let constraintValues = constraint.slice(2);</span>
<a href="#l81.32"></a><span id="l81.32"> </span>
<a href="#l81.33"></a><span id="l81.33">         if (constraintType === GlodaDatastore.kConstraintIdIn) {</span>
<a href="#l81.34"></a><span id="l81.34">           if (constraintValues.indexOf(aObj.id) == -1) {</span>
<a href="#l81.35"></a><span id="l81.35">             querySatisfied = false;</span>
<a href="#l81.36"></a><span id="l81.36">             break;</span>
<a href="#l81.37"></a><span id="l81.37">           }</span>
<a href="#l81.38"></a><span id="l81.38">         }</span>
<a href="#l81.39"></a><span id="l81.39" class="difflineat">@@ -174,20 +176,28 @@ GlodaQueryClass.prototype = {</span>
<a href="#l81.40"></a><span id="l81.40">           let objectNounDef = attrDef.objectNounDef;</span>
<a href="#l81.41"></a><span id="l81.41"> </span>
<a href="#l81.42"></a><span id="l81.42">           // if they provide an equals comparator, use that.</span>
<a href="#l81.43"></a><span id="l81.43">           // (note: the next case has better optimization possibilities than</span>
<a href="#l81.44"></a><span id="l81.44">           //  this mechanism, but of course has higher initialization costs or</span>
<a href="#l81.45"></a><span id="l81.45">           //  code complexity costs...)</span>
<a href="#l81.46"></a><span id="l81.46">           if (objectNounDef.equals) {</span>
<a href="#l81.47"></a><span id="l81.47">             let testValues;</span>
<a href="#l81.48"></a><span id="l81.48" class="difflineminus">-            if (attrDef.singular)</span>
<a href="#l81.49"></a><span id="l81.49" class="difflineminus">-              testValues = [aObj[attrDef.boundName]];</span>
<a href="#l81.50"></a><span id="l81.50" class="difflineplus">+            if (!(boundName in aObj))</span>
<a href="#l81.51"></a><span id="l81.51" class="difflineplus">+              testValues = [];</span>
<a href="#l81.52"></a><span id="l81.52" class="difflineplus">+            else if (attrDef.singular)</span>
<a href="#l81.53"></a><span id="l81.53" class="difflineplus">+              testValues = [aObj[boundName]];</span>
<a href="#l81.54"></a><span id="l81.54">             else</span>
<a href="#l81.55"></a><span id="l81.55" class="difflineminus">-              testValues = aObj[attrDef.boundName];</span>
<a href="#l81.56"></a><span id="l81.56" class="difflineplus">+              testValues = aObj[boundName];</span>
<a href="#l81.57"></a><span id="l81.57" class="difflineplus">+</span>
<a href="#l81.58"></a><span id="l81.58" class="difflineplus">+            // If there are no constraints, then we are just testing for there</span>
<a href="#l81.59"></a><span id="l81.59" class="difflineplus">+            //  being a value.  Succeed (continue) in that case.</span>
<a href="#l81.60"></a><span id="l81.60" class="difflineplus">+            if (constraintValues.length == 0 &amp;&amp; testValues.length &amp;&amp;</span>
<a href="#l81.61"></a><span id="l81.61" class="difflineplus">+                testValues[0] != null)</span>
<a href="#l81.62"></a><span id="l81.62" class="difflineplus">+              continue;</span>
<a href="#l81.63"></a><span id="l81.63"> </span>
<a href="#l81.64"></a><span id="l81.64">             let foundMatch = false;</span>
<a href="#l81.65"></a><span id="l81.65">             for each (let [,testValue] in Iterator(testValues)) {</span>
<a href="#l81.66"></a><span id="l81.66">               for each (let [,value] in Iterator(constraintValues)) {</span>
<a href="#l81.67"></a><span id="l81.67">                 if (objectNounDef.equals(testValue, value)) {</span>
<a href="#l81.68"></a><span id="l81.68">                   foundMatch = true;</span>
<a href="#l81.69"></a><span id="l81.69">                   break;</span>
<a href="#l81.70"></a><span id="l81.70">                 }</span>
<a href="#l81.71"></a><span id="l81.71" class="difflineat">@@ -202,20 +212,28 @@ GlodaQueryClass.prototype = {</span>
<a href="#l81.72"></a><span id="l81.72">           }</span>
<a href="#l81.73"></a><span id="l81.73">           // otherwise, we need to convert everyone to their param/value form</span>
<a href="#l81.74"></a><span id="l81.74">           //  in order to test for equality</span>
<a href="#l81.75"></a><span id="l81.75">           else {</span>
<a href="#l81.76"></a><span id="l81.76">             // let's just do the simple, obvious thing for now.  which is</span>
<a href="#l81.77"></a><span id="l81.77">             //  what we did in the prior case but exploding values using</span>
<a href="#l81.78"></a><span id="l81.78">             //  toParamAndValue, and then comparing.</span>
<a href="#l81.79"></a><span id="l81.79">             let testValues;</span>
<a href="#l81.80"></a><span id="l81.80" class="difflineminus">-            if (attrDef.singular)</span>
<a href="#l81.81"></a><span id="l81.81" class="difflineminus">-              testValues = [aObj[attrDef.boundName]];</span>
<a href="#l81.82"></a><span id="l81.82" class="difflineplus">+            if (!(boundName in aObj))</span>
<a href="#l81.83"></a><span id="l81.83" class="difflineplus">+              testValues = [];</span>
<a href="#l81.84"></a><span id="l81.84" class="difflineplus">+            else if (attrDef.singular)</span>
<a href="#l81.85"></a><span id="l81.85" class="difflineplus">+              testValues = [aObj[boundName]];</span>
<a href="#l81.86"></a><span id="l81.86">             else</span>
<a href="#l81.87"></a><span id="l81.87" class="difflineminus">-              testValues = aObj[attrDef.boundName];</span>
<a href="#l81.88"></a><span id="l81.88" class="difflineplus">+              testValues = aObj[boundName];</span>
<a href="#l81.89"></a><span id="l81.89" class="difflineplus">+</span>
<a href="#l81.90"></a><span id="l81.90" class="difflineplus">+            // If there are no constraints, then we are just testing for there</span>
<a href="#l81.91"></a><span id="l81.91" class="difflineplus">+            //  being a value.  Succeed (continue) in that case.</span>
<a href="#l81.92"></a><span id="l81.92" class="difflineplus">+            if (constraintValues.length == 0 &amp;&amp; testValues.length &amp;&amp;</span>
<a href="#l81.93"></a><span id="l81.93" class="difflineplus">+                testValues[0] != null)</span>
<a href="#l81.94"></a><span id="l81.94" class="difflineplus">+              continue;</span>
<a href="#l81.95"></a><span id="l81.95"> </span>
<a href="#l81.96"></a><span id="l81.96">             let foundMatch = false;</span>
<a href="#l81.97"></a><span id="l81.97">             for each (let [,testValue] in Iterator(testValues)) {</span>
<a href="#l81.98"></a><span id="l81.98">               let [aParam, aValue] = objectNounDef.toParamAndValue(testValue);</span>
<a href="#l81.99"></a><span id="l81.99">               for each (let [,value] in Iterator(constraintValues)) {</span>
<a href="#l81.100"></a><span id="l81.100">                 let [bParam, bValue] = objectNounDef.toParamAndValue(value);</span>
<a href="#l81.101"></a><span id="l81.101">                 if (aParam == bParam &amp;&amp; aValue == bValue) {</span>
<a href="#l81.102"></a><span id="l81.102">                   foundMatch = true;</span>
<a href="#l81.103"></a><span id="l81.103" class="difflineat">@@ -231,20 +249,22 @@ GlodaQueryClass.prototype = {</span>
<a href="#l81.104"></a><span id="l81.104">             }</span>
<a href="#l81.105"></a><span id="l81.105">           }</span>
<a href="#l81.106"></a><span id="l81.106">         }</span>
<a href="#l81.107"></a><span id="l81.107">         // @testpoint gloda.query.test.kConstraintRanges</span>
<a href="#l81.108"></a><span id="l81.108">         else if (constraintType === GlodaDatastore.kConstraintRanges) {</span>
<a href="#l81.109"></a><span id="l81.109">           let objectNounDef = attrDef.objectNounDef;</span>
<a href="#l81.110"></a><span id="l81.110"> </span>
<a href="#l81.111"></a><span id="l81.111">           let testValues;</span>
<a href="#l81.112"></a><span id="l81.112" class="difflineminus">-          if (attrDef.singular)</span>
<a href="#l81.113"></a><span id="l81.113" class="difflineminus">-            testValues = [aObj[attrDef.boundName]];</span>
<a href="#l81.114"></a><span id="l81.114" class="difflineplus">+          if (!(boundName in aObj))</span>
<a href="#l81.115"></a><span id="l81.115" class="difflineplus">+              testValues = [];</span>
<a href="#l81.116"></a><span id="l81.116" class="difflineplus">+          else if (attrDef.singular)</span>
<a href="#l81.117"></a><span id="l81.117" class="difflineplus">+            testValues = [aObj[boundName]];</span>
<a href="#l81.118"></a><span id="l81.118">           else</span>
<a href="#l81.119"></a><span id="l81.119" class="difflineminus">-            testValues = aObj[attrDef.boundName];</span>
<a href="#l81.120"></a><span id="l81.120" class="difflineplus">+            testValues = aObj[boundName];</span>
<a href="#l81.121"></a><span id="l81.121"> </span>
<a href="#l81.122"></a><span id="l81.122">           let foundMatch = false;</span>
<a href="#l81.123"></a><span id="l81.123">           for each (let [,testValue] in Iterator(testValues)) {</span>
<a href="#l81.124"></a><span id="l81.124">             let [tParam, tValue] = objectNounDef.toParamAndValue(testValue);</span>
<a href="#l81.125"></a><span id="l81.125">             for each (let [,rangeTuple] in Iterator(constraintValues)) {</span>
<a href="#l81.126"></a><span id="l81.126">               let [lowerRValue, upperRValue] = rangeTuple;</span>
<a href="#l81.127"></a><span id="l81.127">               if (lowerRValue == null) {</span>
<a href="#l81.128"></a><span id="l81.128">                 let [upperParam, upperValue] =</span>
<a href="#l81.129"></a><span id="l81.129" class="difflineat">@@ -280,17 +300,17 @@ GlodaQueryClass.prototype = {</span>
<a href="#l81.130"></a><span id="l81.130">           if (!foundMatch) {</span>
<a href="#l81.131"></a><span id="l81.131">             querySatisfied = false;</span>
<a href="#l81.132"></a><span id="l81.132">             break;</span>
<a href="#l81.133"></a><span id="l81.133">           }</span>
<a href="#l81.134"></a><span id="l81.134">         }</span>
<a href="#l81.135"></a><span id="l81.135">         // @testpoint gloda.query.test.kConstraintStringLike</span>
<a href="#l81.136"></a><span id="l81.136">         else if (constraintType === GlodaDatastore.kConstraintStringLike) {</span>
<a href="#l81.137"></a><span id="l81.137">           let curIndex = 0;</span>
<a href="#l81.138"></a><span id="l81.138" class="difflineminus">-          let value = aObj[attrDef.boundName];</span>
<a href="#l81.139"></a><span id="l81.139" class="difflineplus">+          let value = (boundName in aObj) ? aObj[boundName] : &quot;&quot;;</span>
<a href="#l81.140"></a><span id="l81.140">           // the attribute must be singular, we don't support arrays of strings.</span>
<a href="#l81.141"></a><span id="l81.141">           for each (let [iValuePart, valuePart] in Iterator(constraintValues)) {</span>
<a href="#l81.142"></a><span id="l81.142">             if (typeof valuePart == &quot;string&quot;) {</span>
<a href="#l81.143"></a><span id="l81.143">               let index = value.indexOf(valuePart);</span>
<a href="#l81.144"></a><span id="l81.144">               // if curIndex is null, we just need any match</span>
<a href="#l81.145"></a><span id="l81.145">               // if it's not null, it must match the offset of our found match</span>
<a href="#l81.146"></a><span id="l81.146">               if (curIndex === null) {</span>
<a href="#l81.147"></a><span id="l81.147">                 if (index == -1)</span>
<a href="#l81.148"></a><span id="l81.148" class="difflineat">@@ -330,16 +350,47 @@ GlodaQueryClass.prototype = {</span>
<a href="#l81.149"></a><span id="l81.149">           break;</span>
<a href="#l81.150"></a><span id="l81.150">       }</span>
<a href="#l81.151"></a><span id="l81.151"> </span>
<a href="#l81.152"></a><span id="l81.152">       if (querySatisfied)</span>
<a href="#l81.153"></a><span id="l81.153">         return true;</span>
<a href="#l81.154"></a><span id="l81.154">     }</span>
<a href="#l81.155"></a><span id="l81.155">     return false;</span>
<a href="#l81.156"></a><span id="l81.156">   },</span>
<a href="#l81.157"></a><span id="l81.157" class="difflineplus">+</span>
<a href="#l81.158"></a><span id="l81.158" class="difflineplus">+  /**</span>
<a href="#l81.159"></a><span id="l81.159" class="difflineplus">+   * Helper code for noun definitions of queryHelpers that want to build a</span>
<a href="#l81.160"></a><span id="l81.160" class="difflineplus">+   *  traditional in/equals constraint.  The goal is to let them build a range</span>
<a href="#l81.161"></a><span id="l81.161" class="difflineplus">+   *  without having to know how we structure |_constraints|.</span>
<a href="#l81.162"></a><span id="l81.162" class="difflineplus">+   *</span>
<a href="#l81.163"></a><span id="l81.163" class="difflineplus">+   * @protected</span>
<a href="#l81.164"></a><span id="l81.164" class="difflineplus">+   */</span>
<a href="#l81.165"></a><span id="l81.165" class="difflineplus">+  _inConstraintHelper:</span>
<a href="#l81.166"></a><span id="l81.166" class="difflineplus">+      function gloda_query__discreteConstraintHelper(aAttrDef, aValues) {</span>
<a href="#l81.167"></a><span id="l81.167" class="difflineplus">+    let constraint =</span>
<a href="#l81.168"></a><span id="l81.168" class="difflineplus">+      [GlodaDatastore.kConstraintIn, aAttrDef].concat(aValues);</span>
<a href="#l81.169"></a><span id="l81.169" class="difflineplus">+    this._constraints.push(constraint);</span>
<a href="#l81.170"></a><span id="l81.170" class="difflineplus">+    return this;</span>
<a href="#l81.171"></a><span id="l81.171" class="difflineplus">+  },</span>
<a href="#l81.172"></a><span id="l81.172" class="difflineplus">+</span>
<a href="#l81.173"></a><span id="l81.173" class="difflineplus">+  /**</span>
<a href="#l81.174"></a><span id="l81.174" class="difflineplus">+   * Helper code for noun definitions of queryHelpers that want to build a</span>
<a href="#l81.175"></a><span id="l81.175" class="difflineplus">+   *  range.  The goal is to let them build a range without having to know how</span>
<a href="#l81.176"></a><span id="l81.176" class="difflineplus">+   *  we structure |_constraints| or requiring them to mark themselves as</span>
<a href="#l81.177"></a><span id="l81.177" class="difflineplus">+   *  continuous to get a &quot;Range&quot;.</span>
<a href="#l81.178"></a><span id="l81.178" class="difflineplus">+   *</span>
<a href="#l81.179"></a><span id="l81.179" class="difflineplus">+   * @protected</span>
<a href="#l81.180"></a><span id="l81.180" class="difflineplus">+   */</span>
<a href="#l81.181"></a><span id="l81.181" class="difflineplus">+  _rangedConstraintHelper:</span>
<a href="#l81.182"></a><span id="l81.182" class="difflineplus">+      function gloda_query__rangedConstraintHelper(aAttrDef, aRanges) {</span>
<a href="#l81.183"></a><span id="l81.183" class="difflineplus">+    let constraint =</span>
<a href="#l81.184"></a><span id="l81.184" class="difflineplus">+      [GlodaDatastore.kConstraintRanges, aAttrDef].concat(aRanges);</span>
<a href="#l81.185"></a><span id="l81.185" class="difflineplus">+    this._constraints.push(constraint);</span>
<a href="#l81.186"></a><span id="l81.186" class="difflineplus">+    return this;</span>
<a href="#l81.187"></a><span id="l81.187" class="difflineplus">+  }</span>
<a href="#l81.188"></a><span id="l81.188"> };</span>
<a href="#l81.189"></a><span id="l81.189"> </span>
<a href="#l81.190"></a><span id="l81.190"> /**</span>
<a href="#l81.191"></a><span id="l81.191">  * @class A query that never matches anything.</span>
<a href="#l81.192"></a><span id="l81.192">  *</span>
<a href="#l81.193"></a><span id="l81.193">  * Collections corresponding to this query are intentionally frozen in time and</span>
<a href="#l81.194"></a><span id="l81.194">  *  do not want to be notified of any updates.  We need the collection to be</span>
<a href="#l81.195"></a><span id="l81.195">  *  registered with the collection manager so that the noun instances in the</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/mailnews/db/gloda/modules/utils.js</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/utils.js</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -59,16 +59,19 @@ var GlodaUtils = {</span>
<a href="#l82.4"></a><span id="l82.4"> </span>
<a href="#l82.5"></a><span id="l82.5">   _headerParser: null,</span>
<a href="#l82.6"></a><span id="l82.6"> </span>
<a href="#l82.7"></a><span id="l82.7">   /**</span>
<a href="#l82.8"></a><span id="l82.8">    * Parses an RFC 2822 list of e-mail addresses and returns an object with</span>
<a href="#l82.9"></a><span id="l82.9">    *  4 attributes, as described below.  We will use the example of the user</span>
<a href="#l82.10"></a><span id="l82.10">    *  passing an argument of '&quot;Bob Smith&quot; &lt;bob@company.com&gt;'.</span>
<a href="#l82.11"></a><span id="l82.11">    *</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineplus">+   * This method (by way of nsIMsgHeaderParser) takes care of decoding mime</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+   *  headers, but is not aware of folder-level character set overrides.</span>
<a href="#l82.14"></a><span id="l82.14" class="difflineplus">+   *</span>
<a href="#l82.15"></a><span id="l82.15">    * count: the number of addresses parsed. (ex: 1)</span>
<a href="#l82.16"></a><span id="l82.16">    * addresses: a list of e-mail addresses (ex: [&quot;bob@company.com&quot;])</span>
<a href="#l82.17"></a><span id="l82.17">    * names: a list of names (ex: [&quot;Bob Smith&quot;])</span>
<a href="#l82.18"></a><span id="l82.18">    * fullAddresses: aka the list of name and e-mail together (ex: ['&quot;Bob Smith&quot;</span>
<a href="#l82.19"></a><span id="l82.19">    *  &lt;bob@company.com&gt;']).</span>
<a href="#l82.20"></a><span id="l82.20">    *</span>
<a href="#l82.21"></a><span id="l82.21">    * This method is a convenience wrapper around nsIMsgHeaderParser.</span>
<a href="#l82.22"></a><span id="l82.22">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -35,16 +35,18 @@</span>
<a href="#l83.4"></a><span id="l83.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l83.5"></a><span id="l83.5">  *</span>
<a href="#l83.6"></a><span id="l83.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l83.7"></a><span id="l83.7"> </span>
<a href="#l83.8"></a><span id="l83.8"> // Import the main scripts that mailnews tests need to set up and tear down</span>
<a href="#l83.9"></a><span id="l83.9"> load(&quot;../../mailnews/resources/mailDirService.js&quot;);</span>
<a href="#l83.10"></a><span id="l83.10"> load(&quot;../../mailnews/resources/mailTestUtils.js&quot;);</span>
<a href="#l83.11"></a><span id="l83.11"> </span>
<a href="#l83.12"></a><span id="l83.12" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/errUtils.js&quot;);</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+</span>
<a href="#l83.14"></a><span id="l83.14"> /**</span>
<a href="#l83.15"></a><span id="l83.15">  * Create a 'me' identity of &quot;me@localhost&quot; for the benefit of Gloda.  At the</span>
<a href="#l83.16"></a><span id="l83.16">  *  time of this writing, Gloda only initializes Gloda.myIdentities and</span>
<a href="#l83.17"></a><span id="l83.17">  *  Gloda.myContact at startup with no event-driven updates.  As such, this</span>
<a href="#l83.18"></a><span id="l83.18">  *  function needs to be called prior to gloda startup.</span>
<a href="#l83.19"></a><span id="l83.19">  */</span>
<a href="#l83.20"></a><span id="l83.20"> function createMeIdentity() {</span>
<a href="#l83.21"></a><span id="l83.21">   var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l83.22"></a><span id="l83.22" class="difflineat">@@ -984,19 +986,21 @@ QueryExpectationListener.prototype = {</span>
<a href="#l83.23"></a><span id="l83.23">                   &quot;&quot;) + &quot;\n&quot;);</span>
<a href="#l83.24"></a><span id="l83.24">           }</span>
<a href="#l83.25"></a><span id="l83.25">           throw ex;</span>
<a href="#l83.26"></a><span id="l83.26">         }</span>
<a href="#l83.27"></a><span id="l83.27">       }</span>
<a href="#l83.28"></a><span id="l83.28">       this.nextIndex++;</span>
<a href="#l83.29"></a><span id="l83.29"> </span>
<a href="#l83.30"></a><span id="l83.30">       // make sure the query's test method agrees with the database about this</span>
<a href="#l83.31"></a><span id="l83.31" class="difflineminus">-      if (!aCollection.query.test(item))</span>
<a href="#l83.32"></a><span id="l83.32" class="difflineplus">+      if (!aCollection.query.test(item)) {</span>
<a href="#l83.33"></a><span id="l83.33" class="difflineplus">+        logObject(item);</span>
<a href="#l83.34"></a><span id="l83.34">         do_throw(&quot;Query test returned false when it should have been true on &quot; +</span>
<a href="#l83.35"></a><span id="l83.35">                  &quot;extracted: &quot; + glodaStringRep + &quot; item: &quot; + item);</span>
<a href="#l83.36"></a><span id="l83.36" class="difflineplus">+      }</span>
<a href="#l83.37"></a><span id="l83.37">     }</span>
<a href="#l83.38"></a><span id="l83.38">   },</span>
<a href="#l83.39"></a><span id="l83.39">   onItemsModified: function query_expectation_onItemsModified(aItems,</span>
<a href="#l83.40"></a><span id="l83.40">       aCollection) {</span>
<a href="#l83.41"></a><span id="l83.41">   },</span>
<a href="#l83.42"></a><span id="l83.42">   onItemsRemoved: function query_expectation_onItemsRemoved(aItems,</span>
<a href="#l83.43"></a><span id="l83.43">       aCollection) {</span>
<a href="#l83.44"></a><span id="l83.44">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_query_core.js</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_core.js</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -54,17 +54,18 @@ var WidgetProvider = {</span>
<a href="#l84.4"></a><span id="l84.4"> };</span>
<a href="#l84.5"></a><span id="l84.5"> </span>
<a href="#l84.6"></a><span id="l84.6"> var WidgetNoun;</span>
<a href="#l84.7"></a><span id="l84.7"> function setup_test_noun_and_attributes() {</span>
<a href="#l84.8"></a><span id="l84.8">   // --- noun</span>
<a href="#l84.9"></a><span id="l84.9">   WidgetNoun = Gloda.defineNoun({</span>
<a href="#l84.10"></a><span id="l84.10">     name: &quot;widget&quot;,</span>
<a href="#l84.11"></a><span id="l84.11">     clazz: Widget,</span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-    allowArbitraryAttrs: true,</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+    allowsArbitraryAttrs: true,</span>
<a href="#l84.14"></a><span id="l84.14" class="difflineplus">+    //cache: true, cacheCost: 32,</span>
<a href="#l84.15"></a><span id="l84.15">     schema: {</span>
<a href="#l84.16"></a><span id="l84.16">       columns: [['id', 'INTEGER PRIMARY KEY'],</span>
<a href="#l84.17"></a><span id="l84.17">                 ['intCol', 'NUMBER', 'inum'],</span>
<a href="#l84.18"></a><span id="l84.18">                 ['dateCol', 'NUMBER', 'date'],</span>
<a href="#l84.19"></a><span id="l84.19">                 ['strCol', 'STRING', 'str'],</span>
<a href="#l84.20"></a><span id="l84.20">                 ['notabilityCol', 'NUMBER', 'notability'],</span>
<a href="#l84.21"></a><span id="l84.21">                 ['textOne', 'STRING', 'text1'],</span>
<a href="#l84.22"></a><span id="l84.22">                 ['textTwo', 'STRING', 'text2']],</span>
<a href="#l84.23"></a><span id="l84.23" class="difflineat">@@ -77,60 +78,60 @@ function setup_test_noun_and_attributes(</span>
<a href="#l84.24"></a><span id="l84.24">   });</span>
<a href="#l84.25"></a><span id="l84.25"> </span>
<a href="#l84.26"></a><span id="l84.26">   EXT_NAME = &quot;test&quot;;</span>
<a href="#l84.27"></a><span id="l84.27"> </span>
<a href="#l84.28"></a><span id="l84.28">   // --- special (on-row) attributes</span>
<a href="#l84.29"></a><span id="l84.29">   Gloda.defineAttribute({</span>
<a href="#l84.30"></a><span id="l84.30">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l84.31"></a><span id="l84.31">     attributeType: Gloda.kAttrFundamental,</span>
<a href="#l84.32"></a><span id="l84.32" class="difflineminus">-    attributeName: &quot;intCol&quot;,</span>
<a href="#l84.33"></a><span id="l84.33" class="difflineplus">+    attributeName: &quot;inum&quot;,</span>
<a href="#l84.34"></a><span id="l84.34">     singular: true,</span>
<a href="#l84.35"></a><span id="l84.35">     special: Gloda.kSpecialColumn,</span>
<a href="#l84.36"></a><span id="l84.36">     specialColumnName: &quot;intCol&quot;,</span>
<a href="#l84.37"></a><span id="l84.37">     subjectNouns: [WidgetNoun.id],</span>
<a href="#l84.38"></a><span id="l84.38">     objectNoun: Gloda.NOUN_NUMBER</span>
<a href="#l84.39"></a><span id="l84.39">   });</span>
<a href="#l84.40"></a><span id="l84.40">   Gloda.defineAttribute({</span>
<a href="#l84.41"></a><span id="l84.41">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l84.42"></a><span id="l84.42">     attributeType: Gloda.kAttrFundamental,</span>
<a href="#l84.43"></a><span id="l84.43" class="difflineminus">-    attributeName: &quot;dateCol&quot;,</span>
<a href="#l84.44"></a><span id="l84.44" class="difflineplus">+    attributeName: &quot;date&quot;,</span>
<a href="#l84.45"></a><span id="l84.45">     singular: true,</span>
<a href="#l84.46"></a><span id="l84.46">     special: Gloda.kSpecialColumn,</span>
<a href="#l84.47"></a><span id="l84.47">     specialColumnName: &quot;dateCol&quot;,</span>
<a href="#l84.48"></a><span id="l84.48">     subjectNouns: [WidgetNoun.id],</span>
<a href="#l84.49"></a><span id="l84.49">     objectNoun: Gloda.NOUN_DATE</span>
<a href="#l84.50"></a><span id="l84.50">   });</span>
<a href="#l84.51"></a><span id="l84.51">   Gloda.defineAttribute({</span>
<a href="#l84.52"></a><span id="l84.52">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l84.53"></a><span id="l84.53">     attributeType: Gloda.kAttrFundamental,</span>
<a href="#l84.54"></a><span id="l84.54" class="difflineminus">-    attributeName: &quot;strCol&quot;,</span>
<a href="#l84.55"></a><span id="l84.55" class="difflineplus">+    attributeName: &quot;str&quot;,</span>
<a href="#l84.56"></a><span id="l84.56">     singular: true,</span>
<a href="#l84.57"></a><span id="l84.57">     special: Gloda.kSpecialString,</span>
<a href="#l84.58"></a><span id="l84.58">     specialColumnName: &quot;strCol&quot;,</span>
<a href="#l84.59"></a><span id="l84.59">     subjectNouns: [WidgetNoun.id],</span>
<a href="#l84.60"></a><span id="l84.60">     objectNoun: Gloda.NOUN_STRING</span>
<a href="#l84.61"></a><span id="l84.61">   });</span>
<a href="#l84.62"></a><span id="l84.62"> </span>
<a href="#l84.63"></a><span id="l84.63"> </span>
<a href="#l84.64"></a><span id="l84.64">   // --- fulltext attributes</span>
<a href="#l84.65"></a><span id="l84.65">   Gloda.defineAttribute({</span>
<a href="#l84.66"></a><span id="l84.66">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l84.67"></a><span id="l84.67">     attributeType: Gloda.kAttrFundamental,</span>
<a href="#l84.68"></a><span id="l84.68" class="difflineminus">-    attributeName: &quot;fulltextOne&quot;,</span>
<a href="#l84.69"></a><span id="l84.69" class="difflineplus">+    attributeName: &quot;text1&quot;,</span>
<a href="#l84.70"></a><span id="l84.70">     singular: true,</span>
<a href="#l84.71"></a><span id="l84.71">     special: Gloda.kSpecialFulltext,</span>
<a href="#l84.72"></a><span id="l84.72">     specialColumnName: &quot;fulltextOne&quot;,</span>
<a href="#l84.73"></a><span id="l84.73">     subjectNouns: [WidgetNoun.id],</span>
<a href="#l84.74"></a><span id="l84.74">     objectNoun: Gloda.NOUN_FULLTEXT</span>
<a href="#l84.75"></a><span id="l84.75">   });</span>
<a href="#l84.76"></a><span id="l84.76">   Gloda.defineAttribute({</span>
<a href="#l84.77"></a><span id="l84.77">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l84.78"></a><span id="l84.78">     attributeType: Gloda.kAttrFundamental,</span>
<a href="#l84.79"></a><span id="l84.79" class="difflineminus">-    attributeName: &quot;fulltextTwo&quot;,</span>
<a href="#l84.80"></a><span id="l84.80" class="difflineplus">+    attributeName: &quot;text2&quot;,</span>
<a href="#l84.81"></a><span id="l84.81">     singular: true,</span>
<a href="#l84.82"></a><span id="l84.82">     special: Gloda.kSpecialFulltext,</span>
<a href="#l84.83"></a><span id="l84.83">     specialColumnName: &quot;fulltextTwo&quot;,</span>
<a href="#l84.84"></a><span id="l84.84">     subjectNouns: [WidgetNoun.id],</span>
<a href="#l84.85"></a><span id="l84.85">     objectNoun: Gloda.NOUN_FULLTEXT</span>
<a href="#l84.86"></a><span id="l84.86">   });</span>
<a href="#l84.87"></a><span id="l84.87">   Gloda.defineAttribute({</span>
<a href="#l84.88"></a><span id="l84.88">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l84.89"></a><span id="l84.89" class="difflineat">@@ -148,16 +149,25 @@ function setup_test_noun_and_attributes(</span>
<a href="#l84.90"></a><span id="l84.90">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l84.91"></a><span id="l84.91">     attributeType: Gloda.kAttrFundamental,</span>
<a href="#l84.92"></a><span id="l84.92">     attributeName: &quot;singleIntAttr&quot;,</span>
<a href="#l84.93"></a><span id="l84.93">     singular: true,</span>
<a href="#l84.94"></a><span id="l84.94">     subjectNouns: [WidgetNoun.id],</span>
<a href="#l84.95"></a><span id="l84.95">     objectNoun: Gloda.NOUN_NUMBER</span>
<a href="#l84.96"></a><span id="l84.96">   });</span>
<a href="#l84.97"></a><span id="l84.97"> </span>
<a href="#l84.98"></a><span id="l84.98" class="difflineplus">+  Gloda.defineAttribute({</span>
<a href="#l84.99"></a><span id="l84.99" class="difflineplus">+    provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l84.100"></a><span id="l84.100" class="difflineplus">+    attributeType: Gloda.kAttrFundamental,</span>
<a href="#l84.101"></a><span id="l84.101" class="difflineplus">+    attributeName: &quot;multiIntAttr&quot;,</span>
<a href="#l84.102"></a><span id="l84.102" class="difflineplus">+    singular: false,</span>
<a href="#l84.103"></a><span id="l84.103" class="difflineplus">+    subjectNouns: [WidgetNoun.id],</span>
<a href="#l84.104"></a><span id="l84.104" class="difflineplus">+    objectNoun: Gloda.NOUN_NUMBER</span>
<a href="#l84.105"></a><span id="l84.105" class="difflineplus">+  });</span>
<a href="#l84.106"></a><span id="l84.106" class="difflineplus">+</span>
<a href="#l84.107"></a><span id="l84.107">   next_test();</span>
<a href="#l84.108"></a><span id="l84.108"> }</span>
<a href="#l84.109"></a><span id="l84.109"> </span>
<a href="#l84.110"></a><span id="l84.110"> /* ===== Tests ===== */</span>
<a href="#l84.111"></a><span id="l84.111"> </span>
<a href="#l84.112"></a><span id="l84.112"> ALPHABET = &quot;abcdefghijklmnopqrstuvwxyz&quot;;</span>
<a href="#l84.113"></a><span id="l84.113"> function test_lots_of_string_constraints() {</span>
<a href="#l84.114"></a><span id="l84.114">   let stringConstraints = [];</span>
<a href="#l84.115"></a><span id="l84.115" class="difflineat">@@ -169,21 +179,67 @@ function test_lots_of_string_constraints</span>
<a href="#l84.116"></a><span id="l84.116">                            ALPHABET[i % ALPHABET.length] +</span>
<a href="#l84.117"></a><span id="l84.117">                            // throw in something that will explode if not quoted</span>
<a href="#l84.118"></a><span id="l84.118">                            // (and use an uneven number of things so if we fail</span>
<a href="#l84.119"></a><span id="l84.119">                            // to quote it won't get quietly eaten.)</span>
<a href="#l84.120"></a><span id="l84.120">                            &quot;'&quot; + '&quot;');</span>
<a href="#l84.121"></a><span id="l84.121">   }</span>
<a href="#l84.122"></a><span id="l84.122"> </span>
<a href="#l84.123"></a><span id="l84.123">   let query = Gloda.newQuery(WidgetNoun.id);</span>
<a href="#l84.124"></a><span id="l84.124" class="difflineminus">-  query.strCol.apply(query, stringConstraints);</span>
<a href="#l84.125"></a><span id="l84.125" class="difflineplus">+  query.str.apply(query, stringConstraints);</span>
<a href="#l84.126"></a><span id="l84.126"> </span>
<a href="#l84.127"></a><span id="l84.127">   queryExpect(query, []);</span>
<a href="#l84.128"></a><span id="l84.128"> }</span>
<a href="#l84.129"></a><span id="l84.129"> </span>
<a href="#l84.130"></a><span id="l84.130" class="difflineplus">+/* === Query === */</span>
<a href="#l84.131"></a><span id="l84.131" class="difflineplus">+</span>
<a href="#l84.132"></a><span id="l84.132" class="difflineplus">+/**</span>
<a href="#l84.133"></a><span id="l84.133" class="difflineplus">+ * Use a counter so that each test can have its own unique value for intCol so</span>
<a href="#l84.134"></a><span id="l84.134" class="difflineplus">+ *  that it can use that as a constraint.  Otherwise we would need to purge</span>
<a href="#l84.135"></a><span id="l84.135" class="difflineplus">+ *  between every test.  That's not an unreasonable alternative, but this works.</span>
<a href="#l84.136"></a><span id="l84.136" class="difflineplus">+ * Every test should increment this before using it.</span>
<a href="#l84.137"></a><span id="l84.137" class="difflineplus">+ */</span>
<a href="#l84.138"></a><span id="l84.138" class="difflineplus">+var testUnique = 100;</span>
<a href="#l84.139"></a><span id="l84.139" class="difflineplus">+</span>
<a href="#l84.140"></a><span id="l84.140" class="difflineplus">+/**</span>
<a href="#l84.141"></a><span id="l84.141" class="difflineplus">+ * Widgets with multiIntAttr populated with one or more values.</span>
<a href="#l84.142"></a><span id="l84.142" class="difflineplus">+ */</span>
<a href="#l84.143"></a><span id="l84.143" class="difflineplus">+var nonSingularWidgets;</span>
<a href="#l84.144"></a><span id="l84.144" class="difflineplus">+/**</span>
<a href="#l84.145"></a><span id="l84.145" class="difflineplus">+ * Widgets with multiIntAttr unpopulated.</span>
<a href="#l84.146"></a><span id="l84.146" class="difflineplus">+ */</span>
<a href="#l84.147"></a><span id="l84.147" class="difflineplus">+var singularWidgets;</span>
<a href="#l84.148"></a><span id="l84.148" class="difflineplus">+</span>
<a href="#l84.149"></a><span id="l84.149" class="difflineplus">+function setup_non_singular_values() {</span>
<a href="#l84.150"></a><span id="l84.150" class="difflineplus">+  testUnique++;</span>
<a href="#l84.151"></a><span id="l84.151" class="difflineplus">+  let origin = new Date(&quot;2007/01/01&quot;);</span>
<a href="#l84.152"></a><span id="l84.152" class="difflineplus">+  nonSingularWidgets = [</span>
<a href="#l84.153"></a><span id="l84.153" class="difflineplus">+    new Widget(testUnique, origin, &quot;ns1&quot;, 0, &quot;&quot;, &quot;&quot;),</span>
<a href="#l84.154"></a><span id="l84.154" class="difflineplus">+    new Widget(testUnique, origin, &quot;ns2&quot;, 0, &quot;&quot;, &quot;&quot;),</span>
<a href="#l84.155"></a><span id="l84.155" class="difflineplus">+  ];</span>
<a href="#l84.156"></a><span id="l84.156" class="difflineplus">+  singularWidgets = [</span>
<a href="#l84.157"></a><span id="l84.157" class="difflineplus">+    new Widget(testUnique, origin, &quot;s1&quot;, 0, &quot;&quot;, &quot;&quot;),</span>
<a href="#l84.158"></a><span id="l84.158" class="difflineplus">+    new Widget(testUnique, origin, &quot;s2&quot;, 0, &quot;&quot;, &quot;&quot;),</span>
<a href="#l84.159"></a><span id="l84.159" class="difflineplus">+  ];</span>
<a href="#l84.160"></a><span id="l84.160" class="difflineplus">+  nonSingularWidgets[0].multiIntAttr = [1, 2];</span>
<a href="#l84.161"></a><span id="l84.161" class="difflineplus">+  nonSingularWidgets[1].multiIntAttr = [3];</span>
<a href="#l84.162"></a><span id="l84.162" class="difflineplus">+  singularWidgets[0].multiIntAttr = [];</span>
<a href="#l84.163"></a><span id="l84.163" class="difflineplus">+  // and don't bother setting it on singularWidgets[1]</span>
<a href="#l84.164"></a><span id="l84.164" class="difflineplus">+</span>
<a href="#l84.165"></a><span id="l84.165" class="difflineplus">+  runOnIndexingComplete(next_test);</span>
<a href="#l84.166"></a><span id="l84.166" class="difflineplus">+  GenericIndexer.indexNewObjects(nonSingularWidgets.concat(singularWidgets));</span>
<a href="#l84.167"></a><span id="l84.167" class="difflineplus">+}</span>
<a href="#l84.168"></a><span id="l84.168" class="difflineplus">+</span>
<a href="#l84.169"></a><span id="l84.169" class="difflineplus">+function test_query_has_value_for_non_singular() {</span>
<a href="#l84.170"></a><span id="l84.170" class="difflineplus">+  let query = Gloda.newQuery(WidgetNoun.id);</span>
<a href="#l84.171"></a><span id="l84.171" class="difflineplus">+  query.inum(testUnique);</span>
<a href="#l84.172"></a><span id="l84.172" class="difflineplus">+  query.multiIntAttr();</span>
<a href="#l84.173"></a><span id="l84.173" class="difflineplus">+  queryExpect(query, nonSingularWidgets);</span>
<a href="#l84.174"></a><span id="l84.174" class="difflineplus">+}</span>
<a href="#l84.175"></a><span id="l84.175" class="difflineplus">+</span>
<a href="#l84.176"></a><span id="l84.176"> /* === Search === */</span>
<a href="#l84.177"></a><span id="l84.177"> /*</span>
<a href="#l84.178"></a><span id="l84.178">  * The conceit of our search is that more recent messages are better than older</span>
<a href="#l84.179"></a><span id="l84.179">  *  messages.  But at the same time, we care about some messages more than</span>
<a href="#l84.180"></a><span id="l84.180">  *  others (in general), and we care about messages that match search terms</span>
<a href="#l84.181"></a><span id="l84.181">  *  more strongly too.  So we introduce a general 'score' heuristic which we</span>
<a href="#l84.182"></a><span id="l84.182">  *  then apply to message timestamps to make them appear more recent.  We</span>
<a href="#l84.183"></a><span id="l84.183">  *  then order by this 'date score' hybrid, which we dub &quot;dascore&quot;.  Such a</span>
<a href="#l84.184"></a><span id="l84.184" class="difflineat">@@ -321,16 +377,18 @@ function test_search_ranking_idiom_score</span>
<a href="#l84.185"></a><span id="l84.185"> }</span>
<a href="#l84.186"></a><span id="l84.186"> </span>
<a href="#l84.187"></a><span id="l84.187"> </span>
<a href="#l84.188"></a><span id="l84.188"> /* ===== Driver ===== */</span>
<a href="#l84.189"></a><span id="l84.189"> </span>
<a href="#l84.190"></a><span id="l84.190"> var tests = [</span>
<a href="#l84.191"></a><span id="l84.191">   setup_test_noun_and_attributes,</span>
<a href="#l84.192"></a><span id="l84.192">   test_lots_of_string_constraints,</span>
<a href="#l84.193"></a><span id="l84.193" class="difflineplus">+  setup_non_singular_values,</span>
<a href="#l84.194"></a><span id="l84.194" class="difflineplus">+  test_query_has_value_for_non_singular,</span>
<a href="#l84.195"></a><span id="l84.195">   setup_search_ranking_idiom,</span>
<a href="#l84.196"></a><span id="l84.196">   test_search_ranking_idiom_offsets,</span>
<a href="#l84.197"></a><span id="l84.197">   test_search_ranking_idiom_score,</span>
<a href="#l84.198"></a><span id="l84.198"> ];</span>
<a href="#l84.199"></a><span id="l84.199"> </span>
<a href="#l84.200"></a><span id="l84.200"> function run_test() {</span>
<a href="#l84.201"></a><span id="l84.201">   // Don't initialize the index message state</span>
<a href="#l84.202"></a><span id="l84.202">   glodaHelperRunTests(tests, null, true);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

